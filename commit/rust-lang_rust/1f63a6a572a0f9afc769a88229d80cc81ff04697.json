{"sha": "1f63a6a572a0f9afc769a88229d80cc81ff04697", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFmNjNhNmE1NzJhMGY5YWZjNzY5YTg4MjI5ZDgwY2M4MWZmMDQ2OTc=", "commit": {"author": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2020-08-04T07:16:01Z"}, "committer": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2020-08-04T07:16:01Z"}, "message": "Hash parent ExpnData", "tree": {"sha": "ed01ba46d8e4a5479278686f7f5e778425561503", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ed01ba46d8e4a5479278686f7f5e778425561503"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1f63a6a572a0f9afc769a88229d80cc81ff04697", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE7J9Gc3TfBwj2K399tAh+UQ6YsWQFAl8pCzsACgkQtAh+UQ6Y\nsWTuWQ/+JKuwXlQNTFG8OoZ/UyYk4R1AlSAOe5PEBJ2BjP4rGD1xlChtcshCJexa\nqszejP5lfdWJJKjq7litIqVkrtg7gLG64pT+HD22u/LPx7zjXiFvScP0ER+t5E44\nw3/p2mn1nNwTBeDxj8EcMDIOuXzrXZ7wO0sf/ycP+4LQ2t7XtmQo/BZN0EGfbG/H\n66rOK/r0fKZNJ8/SE46OYeCa2Wu/FiX4JSxRJn6cdhl+oJByvsiO2eWcaeSUDaBW\nDSuiyBh28VZKdIsfRLSrufGfuI8NQo5zypzLfpi/jjgIFRGejSg2oV34gOvXGtA+\nT8k3PnU1s30Q0e1uoLUu7LzRlPpNzDXoTWcbU9h0Yte2NHWtd6lG/YUyuktco89K\n/JBxuZBgPN7fJq0kFbrs3widm/KVrwr7vFl/wvb0+f6JIKlXM4ucIYNRfP93NIwN\n1m+RMiuUFnoevGkmALnmqyEzurzGpFEHdZP6/RWva7HBLmq2w+lhP3TyvZ/LYFth\nBngZQFIdQaxxg+u1MK+at8TjkCjzLlXeiDncyCX2pVNrkPSj92CvZOhauL6UfBcc\no71rq2izMiqKRmgknzdUq6IoWrjEwBNjwqnoqNqrvVR5OKlNCzzFn1I+/wrgIPl7\n9MPqGSgsv0V/WLynQIUcI2Q8PCSoacs4muLgA8Tgy8mJ9ErTkz0=\n=7AcM\n-----END PGP SIGNATURE-----", "payload": "tree ed01ba46d8e4a5479278686f7f5e778425561503\nparent 80f84eb9c6eef2ee0b21988b03a09d0930575a60\nauthor Aaron Hill <aa1ronham@gmail.com> 1596525361 -0400\ncommitter Aaron Hill <aa1ronham@gmail.com> 1596525361 -0400\n\nHash parent ExpnData\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1f63a6a572a0f9afc769a88229d80cc81ff04697", "html_url": "https://github.com/rust-lang/rust/commit/1f63a6a572a0f9afc769a88229d80cc81ff04697", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1f63a6a572a0f9afc769a88229d80cc81ff04697/comments", "author": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "80f84eb9c6eef2ee0b21988b03a09d0930575a60", "url": "https://api.github.com/repos/rust-lang/rust/commits/80f84eb9c6eef2ee0b21988b03a09d0930575a60", "html_url": "https://github.com/rust-lang/rust/commit/80f84eb9c6eef2ee0b21988b03a09d0930575a60"}], "stats": {"total": 72, "additions": 39, "deletions": 33}, "files": [{"sha": "b5ae48b058c6e9f03ccb42489d9a30ceb4bf7345", "filename": "src/librustc_span/hygiene.rs", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/1f63a6a572a0f9afc769a88229d80cc81ff04697/src%2Flibrustc_span%2Fhygiene.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1f63a6a572a0f9afc769a88229d80cc81ff04697/src%2Flibrustc_span%2Fhygiene.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_span%2Fhygiene.rs?ref=1f63a6a572a0f9afc769a88229d80cc81ff04697", "patch": "@@ -80,8 +80,6 @@ pub enum Transparency {\n     Opaque,\n }\n \n-pub(crate) const NUM_TRANSPARENCIES: usize = 3;\n-\n impl ExpnId {\n     pub fn fresh(expn_data: Option<ExpnData>) -> Self {\n         HygieneData::with(|data| data.fresh_expn(expn_data))\n@@ -618,6 +616,11 @@ impl SyntaxContext {\n         HygieneData::with(|data| data.expn_data(data.outer_expn(self)).clone())\n     }\n \n+    #[inline]\n+    pub fn outer_mark(self) -> (ExpnId, Transparency) {\n+        HygieneData::with(|data| data.outer_mark(self))\n+    }\n+\n     #[inline]\n     pub fn outer_mark_with_data(self) -> (ExpnId, Transparency, ExpnData) {\n         HygieneData::with(|data| {\n@@ -667,7 +670,6 @@ pub struct ExpnData {\n     /// The kind of this expansion - macro or compiler desugaring.\n     pub kind: ExpnKind,\n     /// The expansion that produced this expansion.\n-    #[stable_hasher(ignore)]\n     pub parent: ExpnId,\n     /// The location of the actual macro invocation or syntax sugar , e.g.\n     /// `let x = foo!();` or `if let Some(y) = x {}`"}, {"sha": "ec5cf387b430497a330ea491fdcdfb229bd4c16a", "filename": "src/librustc_span/lib.rs", "status": "modified", "additions": 34, "deletions": 30, "changes": 64, "blob_url": "https://github.com/rust-lang/rust/blob/1f63a6a572a0f9afc769a88229d80cc81ff04697/src%2Flibrustc_span%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1f63a6a572a0f9afc769a88229d80cc81ff04697/src%2Flibrustc_span%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_span%2Flib.rs?ref=1f63a6a572a0f9afc769a88229d80cc81ff04697", "patch": "@@ -32,8 +32,8 @@ pub mod edition;\n use edition::Edition;\n pub mod hygiene;\n pub use hygiene::SyntaxContext;\n+use hygiene::Transparency;\n pub use hygiene::{DesugaringKind, ExpnData, ExpnId, ExpnKind, ForLoopLoc, MacroKind};\n-use hygiene::{Transparency, NUM_TRANSPARENCIES};\n pub mod def_id;\n use def_id::{CrateNum, DefId, LOCAL_CRATE};\n mod span_encoding;\n@@ -1814,47 +1814,51 @@ impl<CTX: HashStableContext> HashStable<CTX> for SyntaxContext {\n             TAG_NO_EXPANSION.hash_stable(ctx, hasher);\n         } else {\n             TAG_EXPANSION.hash_stable(ctx, hasher);\n+            let (expn_id, transparency) = self.outer_mark();\n+            expn_id.hash_stable(ctx, hasher);\n+            transparency.hash_stable(ctx, hasher);\n+        }\n+    }\n+}\n \n-            // Since the same expansion context is usually referenced many\n-            // times, we cache a stable hash of it and hash that instead of\n-            // recursing every time.\n-            thread_local! {\n-                static CACHE: RefCell<Vec<Option<[Option<u64>; NUM_TRANSPARENCIES]>>> = Default::default();\n-            }\n+impl<CTX: HashStableContext> HashStable<CTX> for ExpnId {\n+    fn hash_stable(&self, ctx: &mut CTX, hasher: &mut StableHasher) {\n+        // Since the same expansion context is usually referenced many\n+        // times, we cache a stable hash of it and hash that instead of\n+        // recursing every time.\n+        thread_local! {\n+            static CACHE: RefCell<Vec<Option<Fingerprint>>> = Default::default();\n+        }\n \n-            let sub_hash: u64 = CACHE.with(|cache| {\n-                let (expn_id, transparency, _) = self.outer_mark_with_data();\n-                let index = expn_id.as_u32() as usize;\n+        const TAG_ROOT: u8 = 0;\n+        const TAG_NOT_ROOT: u8 = 1;\n \n-                if let Some(sub_hash_cache) = cache.borrow().get(index).copied().flatten() {\n-                    if let Some(sub_hash) = sub_hash_cache[transparency as usize] {\n-                        return sub_hash;\n-                    }\n-                }\n+        if *self == ExpnId::root() {\n+            TAG_ROOT.hash_stable(ctx, hasher);\n+            return;\n+        }\n \n-                let new_len = index + 1;\n+        TAG_NOT_ROOT.hash_stable(ctx, hasher);\n+        let index = self.as_u32() as usize;\n \n-                let mut hasher = StableHasher::new();\n-                expn_id.expn_data().hash_stable(ctx, &mut hasher);\n-                transparency.hash_stable(ctx, &mut hasher);\n+        let res = CACHE.with(|cache| cache.borrow().get(index).copied().flatten());\n+\n+        if let Some(res) = res {\n+            res.hash_stable(ctx, hasher);\n+        } else {\n+            let new_len = index + 1;\n \n-                let sub_hash: Fingerprint = hasher.finish();\n-                let sub_hash = sub_hash.to_smaller_hash();\n+            let mut sub_hasher = StableHasher::new();\n+            self.expn_data().hash_stable(ctx, &mut sub_hasher);\n+            let sub_hash: Fingerprint = sub_hasher.finish();\n \n+            CACHE.with(|cache| {\n                 let mut cache = cache.borrow_mut();\n                 if cache.len() < new_len {\n                     cache.resize(new_len, None);\n                 }\n-                if let Some(mut sub_hash_cache) = cache[index] {\n-                    sub_hash_cache[transparency as usize] = Some(sub_hash);\n-                } else {\n-                    let mut sub_hash_cache = [None; NUM_TRANSPARENCIES];\n-                    sub_hash_cache[transparency as usize] = Some(sub_hash);\n-                    cache[index] = Some(sub_hash_cache);\n-                }\n-                sub_hash\n+                cache[index].replace(sub_hash).expect_none(\"Cache slot was filled\");\n             });\n-\n             sub_hash.hash_stable(ctx, hasher);\n         }\n     }"}]}