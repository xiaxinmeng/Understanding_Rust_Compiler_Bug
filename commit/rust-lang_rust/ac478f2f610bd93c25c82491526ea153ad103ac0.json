{"sha": "ac478f2f610bd93c25c82491526ea153ad103ac0", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFjNDc4ZjJmNjEwYmQ5M2MyNWM4MjQ5MTUyNmVhMTUzYWQxMDNhYzA=", "commit": {"author": {"name": "Nikhil Benesch", "email": "nikhil.benesch@gmail.com", "date": "2020-03-06T20:11:24Z"}, "committer": {"name": "Nikhil Benesch", "email": "nikhil.benesch@gmail.com", "date": "2020-03-30T15:10:21Z"}, "message": "Optimize strip_prefix and strip_suffix with str patterns\n\nConstructing a Searcher in strip_prefix and strip_suffix is\nunnecessarily slow when the pattern is a fixed-length string. Add\nstrip_prefix and strip_suffix methods to the Pattern trait, and add\noptimized implementations of these methods in the str implementation.\nThe old implementation is retained as the default for these methods.", "tree": {"sha": "bc7425330cc13fef5f5be8176edfc5f677177284", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bc7425330cc13fef5f5be8176edfc5f677177284"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ac478f2f610bd93c25c82491526ea153ad103ac0", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQJNBAABCAA3FiEET63yI2TwIu/pGwvO/PmFQgg8WmkFAl6CC+MZHG5pa2hpbC5i\nZW5lc2NoQGdtYWlsLmNvbQAKCRD8+YVCCDxaaaodD/oDCrwvWTJYLK638X7NxB99\nswcI3DQRXhhWnsG9qiWZeDqoiSx5I30/anKx7NLyBtpkEw6UBO9fOM/WQ+PVXgjh\nP60R9cyH/g80GgkI9RI2WW1Hl8rf5NJyP7pZz99OUKZaTMsy44rqu4XhmR6nZMMl\ncObix8Wmm34WKJ03Io8J2QWkhzsjE9gtLKRJR4a2P1kxoAD3dB++qqlSCqk+ci8O\nTb7d5QH3Xs3UbjellKagvB6t8L0JHbsi8Wj9LV0VlXHTjCfWDXGsuVRiNJvfYsVV\nNvw2/w2m0Ssyb+nsYLhfRcAiaSDR02KVN2iIxWKsW/AaH+VZRof70XKzYGfFpswz\nq4Dh8Jv1Ae/Vzx/k8m25l/0va4RazvDfm8Qq0cx+1TMbQsH9nsptNPKrW3A0w6zQ\nk41y7uRfsDBfHngWKW3si042xobnnRTEdoKIzc04cerACn1N4ulV5HSujE40JrtD\nHQ1IwpwIDW3i3pJEnR6L9NuCdJ44ishUTpH1ONQ2v0o824UkMXtuu105yu+N7YcH\nGWNg9FxkPQL/zWtNY8gBY86OIT1AHjdJ4ffmSx0xnMHv/r/NFGyVgI/c8g33ljaV\nSji0xpo7EWwYahE+AJc7lIVgzVlmIAr63etIfFwIwcDsWJfIq4oCae836hJ8cET5\nLhvl6tMiCDq8alWPFn5h7w==\n=5+Xn\n-----END PGP SIGNATURE-----", "payload": "tree bc7425330cc13fef5f5be8176edfc5f677177284\nparent e768d6f0bc6db7a46c9ef08254a944ba100bc5dd\nauthor Nikhil Benesch <nikhil.benesch@gmail.com> 1583525484 -0500\ncommitter Nikhil Benesch <nikhil.benesch@gmail.com> 1585581021 -0400\n\nOptimize strip_prefix and strip_suffix with str patterns\n\nConstructing a Searcher in strip_prefix and strip_suffix is\nunnecessarily slow when the pattern is a fixed-length string. Add\nstrip_prefix and strip_suffix methods to the Pattern trait, and add\noptimized implementations of these methods in the str implementation.\nThe old implementation is retained as the default for these methods.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ac478f2f610bd93c25c82491526ea153ad103ac0", "html_url": "https://github.com/rust-lang/rust/commit/ac478f2f610bd93c25c82491526ea153ad103ac0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ac478f2f610bd93c25c82491526ea153ad103ac0/comments", "author": {"login": "benesch", "id": 882976, "node_id": "MDQ6VXNlcjg4Mjk3Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/882976?v=4", "gravatar_id": "", "url": "https://api.github.com/users/benesch", "html_url": "https://github.com/benesch", "followers_url": "https://api.github.com/users/benesch/followers", "following_url": "https://api.github.com/users/benesch/following{/other_user}", "gists_url": "https://api.github.com/users/benesch/gists{/gist_id}", "starred_url": "https://api.github.com/users/benesch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/benesch/subscriptions", "organizations_url": "https://api.github.com/users/benesch/orgs", "repos_url": "https://api.github.com/users/benesch/repos", "events_url": "https://api.github.com/users/benesch/events{/privacy}", "received_events_url": "https://api.github.com/users/benesch/received_events", "type": "User", "site_admin": false}, "committer": {"login": "benesch", "id": 882976, "node_id": "MDQ6VXNlcjg4Mjk3Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/882976?v=4", "gravatar_id": "", "url": "https://api.github.com/users/benesch", "html_url": "https://github.com/benesch", "followers_url": "https://api.github.com/users/benesch/followers", "following_url": "https://api.github.com/users/benesch/following{/other_user}", "gists_url": "https://api.github.com/users/benesch/gists{/gist_id}", "starred_url": "https://api.github.com/users/benesch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/benesch/subscriptions", "organizations_url": "https://api.github.com/users/benesch/orgs", "repos_url": "https://api.github.com/users/benesch/repos", "events_url": "https://api.github.com/users/benesch/events{/privacy}", "received_events_url": "https://api.github.com/users/benesch/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e768d6f0bc6db7a46c9ef08254a944ba100bc5dd", "url": "https://api.github.com/repos/rust-lang/rust/commits/e768d6f0bc6db7a46c9ef08254a944ba100bc5dd", "html_url": "https://github.com/rust-lang/rust/commit/e768d6f0bc6db7a46c9ef08254a944ba100bc5dd"}], "stats": {"total": 137, "additions": 107, "deletions": 30}, "files": [{"sha": "1e5fe125c550d3c5724471b229ae5697163fc705", "filename": "src/liballoc/string.rs", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/ac478f2f610bd93c25c82491526ea153ad103ac0/src%2Fliballoc%2Fstring.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ac478f2f610bd93c25c82491526ea153ad103ac0/src%2Fliballoc%2Fstring.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fliballoc%2Fstring.rs?ref=ac478f2f610bd93c25c82491526ea153ad103ac0", "patch": "@@ -1849,6 +1849,21 @@ impl<'a, 'b> Pattern<'a> for &'b String {\n     fn is_prefix_of(self, haystack: &'a str) -> bool {\n         self[..].is_prefix_of(haystack)\n     }\n+\n+    #[inline]\n+    fn strip_prefix_of(self, haystack: &'a str) -> Option<&'a str> {\n+        self[..].strip_prefix_of(haystack)\n+    }\n+\n+    #[inline]\n+    fn is_suffix_of(self, haystack: &'a str) -> bool {\n+        self[..].is_suffix_of(haystack)\n+    }\n+\n+    #[inline]\n+    fn strip_suffix_of(self, haystack: &'a str) -> Option<&'a str> {\n+        self[..].strip_suffix_of(haystack)\n+    }\n }\n \n #[stable(feature = \"rust1\", since = \"1.0.0\")]"}, {"sha": "681dfda4ad5174bc49ba187466e1ec2ce20f99ca", "filename": "src/libcore/str/mod.rs", "status": "modified", "additions": 7, "deletions": 30, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/ac478f2f610bd93c25c82491526ea153ad103ac0/src%2Flibcore%2Fstr%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ac478f2f610bd93c25c82491526ea153ad103ac0/src%2Flibcore%2Fstr%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fstr%2Fmod.rs?ref=ac478f2f610bd93c25c82491526ea153ad103ac0", "patch": "@@ -9,7 +9,7 @@\n #![stable(feature = \"rust1\", since = \"1.0.0\")]\n \n use self::pattern::Pattern;\n-use self::pattern::{DoubleEndedSearcher, ReverseSearcher, SearchStep, Searcher};\n+use self::pattern::{DoubleEndedSearcher, ReverseSearcher, Searcher};\n \n use crate::char;\n use crate::fmt::{self, Write};\n@@ -3986,26 +3986,15 @@ impl str {\n     /// ```\n     /// #![feature(str_strip)]\n     ///\n-    /// assert_eq!(\"foobar\".strip_prefix(\"foo\"), Some(\"bar\"));\n-    /// assert_eq!(\"foobar\".strip_prefix(\"bar\"), None);\n+    /// assert_eq!(\"foo:bar\".strip_prefix(\"foo:\"), Some(\"bar\"));\n+    /// assert_eq!(\"foo:bar\".strip_prefix(\"bar\"), None);\n     /// assert_eq!(\"foofoo\".strip_prefix(\"foo\"), Some(\"foo\"));\n     /// ```\n     #[must_use = \"this returns the remaining substring as a new slice, \\\n                   without modifying the original\"]\n     #[unstable(feature = \"str_strip\", reason = \"newly added\", issue = \"67302\")]\n     pub fn strip_prefix<'a, P: Pattern<'a>>(&'a self, prefix: P) -> Option<&'a str> {\n-        let mut matcher = prefix.into_searcher(self);\n-        if let SearchStep::Match(start, len) = matcher.next() {\n-            debug_assert_eq!(\n-                start, 0,\n-                \"The first search step from Searcher \\\n-                 must include the first character\"\n-            );\n-            // SAFETY: `Searcher` is known to return valid indices.\n-            unsafe { Some(self.get_unchecked(len..)) }\n-        } else {\n-            None\n-        }\n+        prefix.strip_prefix_of(self)\n     }\n \n     /// Returns a string slice with the suffix removed.\n@@ -4020,8 +4009,8 @@ impl str {\n     ///\n     /// ```\n     /// #![feature(str_strip)]\n-    /// assert_eq!(\"barfoo\".strip_suffix(\"foo\"), Some(\"bar\"));\n-    /// assert_eq!(\"barfoo\".strip_suffix(\"bar\"), None);\n+    /// assert_eq!(\"bar:foo\".strip_suffix(\":foo\"), Some(\"bar\"));\n+    /// assert_eq!(\"bar:foo\".strip_suffix(\"bar\"), None);\n     /// assert_eq!(\"foofoo\".strip_suffix(\"foo\"), Some(\"foo\"));\n     /// ```\n     #[must_use = \"this returns the remaining substring as a new slice, \\\n@@ -4032,19 +4021,7 @@ impl str {\n         P: Pattern<'a>,\n         <P as Pattern<'a>>::Searcher: ReverseSearcher<'a>,\n     {\n-        let mut matcher = suffix.into_searcher(self);\n-        if let SearchStep::Match(start, end) = matcher.next_back() {\n-            debug_assert_eq!(\n-                end,\n-                self.len(),\n-                \"The first search step from ReverseSearcher \\\n-                 must include the last character\"\n-            );\n-            // SAFETY: `Searcher` is known to return valid indices.\n-            unsafe { Some(self.get_unchecked(..start)) }\n-        } else {\n-            None\n-        }\n+        suffix.strip_suffix_of(self)\n     }\n \n     /// Returns a string slice with all suffixes that match a pattern"}, {"sha": "30fd55f7b7f646f35fcb31aba5d0e4f5035f7f80", "filename": "src/libcore/str/pattern.rs", "status": "modified", "additions": 85, "deletions": 0, "changes": 85, "blob_url": "https://github.com/rust-lang/rust/blob/ac478f2f610bd93c25c82491526ea153ad103ac0/src%2Flibcore%2Fstr%2Fpattern.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ac478f2f610bd93c25c82491526ea153ad103ac0/src%2Flibcore%2Fstr%2Fpattern.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fstr%2Fpattern.rs?ref=ac478f2f610bd93c25c82491526ea153ad103ac0", "patch": "@@ -47,6 +47,22 @@ pub trait Pattern<'a>: Sized {\n         matches!(self.into_searcher(haystack).next(), SearchStep::Match(0, _))\n     }\n \n+    /// Removes the pattern from the front of haystack, if it matches.\n+    #[inline]\n+    fn strip_prefix_of(self, haystack: &'a str) -> Option<&'a str> {\n+        if let SearchStep::Match(start, len) = self.into_searcher(haystack).next() {\n+            debug_assert_eq!(\n+                start, 0,\n+                \"The first search step from Searcher \\\n+                 must include the first character\"\n+            );\n+            // SAFETY: `Searcher` is known to return valid indices.\n+            unsafe { Some(haystack.get_unchecked(len..)) }\n+        } else {\n+            None\n+        }\n+    }\n+\n     /// Checks whether the pattern matches at the back of the haystack\n     #[inline]\n     fn is_suffix_of(self, haystack: &'a str) -> bool\n@@ -55,6 +71,26 @@ pub trait Pattern<'a>: Sized {\n     {\n         matches!(self.into_searcher(haystack).next_back(), SearchStep::Match(_, j) if haystack.len() == j)\n     }\n+\n+    /// Removes the pattern from the back of haystack, if it matches.\n+    #[inline]\n+    fn strip_suffix_of(self, haystack: &'a str) -> Option<&'a str>\n+    where\n+        Self::Searcher: ReverseSearcher<'a>,\n+    {\n+        if let SearchStep::Match(start, end) = self.into_searcher(haystack).next_back() {\n+            debug_assert_eq!(\n+                end,\n+                haystack.len(),\n+                \"The first search step from ReverseSearcher \\\n+                 must include the last character\"\n+            );\n+            // SAFETY: `Searcher` is known to return valid indices.\n+            unsafe { Some(haystack.get_unchecked(..start)) }\n+        } else {\n+            None\n+        }\n+    }\n }\n \n // Searcher\n@@ -448,13 +484,26 @@ impl<'a> Pattern<'a> for char {\n         self.encode_utf8(&mut [0u8; 4]).is_prefix_of(haystack)\n     }\n \n+    #[inline]\n+    fn strip_prefix_of(self, haystack: &'a str) -> Option<&'a str> {\n+        self.encode_utf8(&mut [0u8; 4]).strip_prefix_of(haystack)\n+    }\n+\n     #[inline]\n     fn is_suffix_of(self, haystack: &'a str) -> bool\n     where\n         Self::Searcher: ReverseSearcher<'a>,\n     {\n         self.encode_utf8(&mut [0u8; 4]).is_suffix_of(haystack)\n     }\n+\n+    #[inline]\n+    fn strip_suffix_of(self, haystack: &'a str) -> Option<&'a str>\n+    where\n+        Self::Searcher: ReverseSearcher<'a>,\n+    {\n+        self.encode_utf8(&mut [0u8; 4]).strip_suffix_of(haystack)\n+    }\n }\n \n /////////////////////////////////////////////////////////////////////////////\n@@ -569,13 +618,26 @@ macro_rules! pattern_methods {\n             ($pmap)(self).is_prefix_of(haystack)\n         }\n \n+        #[inline]\n+        fn strip_prefix_of(self, haystack: &'a str) -> Option<&'a str> {\n+            ($pmap)(self).strip_prefix_of(haystack)\n+        }\n+\n         #[inline]\n         fn is_suffix_of(self, haystack: &'a str) -> bool\n         where\n             $t: ReverseSearcher<'a>,\n         {\n             ($pmap)(self).is_suffix_of(haystack)\n         }\n+\n+        #[inline]\n+        fn strip_suffix_of(self, haystack: &'a str) -> Option<&'a str>\n+        where\n+            $t: ReverseSearcher<'a>,\n+        {\n+            ($pmap)(self).strip_suffix_of(haystack)\n+        }\n     };\n }\n \n@@ -715,11 +777,34 @@ impl<'a, 'b> Pattern<'a> for &'b str {\n         haystack.as_bytes().starts_with(self.as_bytes())\n     }\n \n+    /// Removes the pattern from the front of haystack, if it matches.\n+    #[inline]\n+    fn strip_prefix_of(self, haystack: &'a str) -> Option<&'a str> {\n+        if self.is_prefix_of(haystack) {\n+            // SAFETY: prefix was just verified to exist.\n+            unsafe { Some(haystack.get_unchecked(self.as_bytes().len()..)) }\n+        } else {\n+            None\n+        }\n+    }\n+\n     /// Checks whether the pattern matches at the back of the haystack\n     #[inline]\n     fn is_suffix_of(self, haystack: &'a str) -> bool {\n         haystack.as_bytes().ends_with(self.as_bytes())\n     }\n+\n+    /// Removes the pattern from the back of haystack, if it matches.\n+    #[inline]\n+    fn strip_suffix_of(self, haystack: &'a str) -> Option<&'a str> {\n+        if self.is_suffix_of(haystack) {\n+            let i = haystack.len() - self.as_bytes().len();\n+            // SAFETY: suffix was just verified to exist.\n+            unsafe { Some(haystack.get_unchecked(..i)) }\n+        } else {\n+            None\n+        }\n+    }\n }\n \n /////////////////////////////////////////////////////////////////////////////"}]}