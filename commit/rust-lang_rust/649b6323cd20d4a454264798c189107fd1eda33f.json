{"sha": "649b6323cd20d4a454264798c189107fd1eda33f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjY0OWI2MzIzY2QyMGQ0YTQ1NDI2NDc5OGMxODkxMDdmZDFlZGEzM2Y=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-05-04T14:14:55Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-05-04T14:14:55Z"}, "message": "Auto merge of #71754 - alexcrichton:no-bitcode-in-cache, r=nnethercote\n\nDon't copy bytecode files into the incr. comp. cache.\n\nIt's no longer necessary now that bitcode is embedded into object files.\n\nThis change meant that `WorkProductFileKind::Bytecode` is no longer\nnecessary, which means that type is no longer necessary, which allowed\nseveral places in the code to become simpler.\n\nThis commit was written by @nnethercote in https://github.com/rust-lang/rust/pull/70458 but that didn't land. In the meantime though we managed to land it in https://github.com/rust-lang/rust/pull/71528 and that doesn't seem to be causing too many fires, so I'm re-sending this patch!", "tree": {"sha": "5567355bb2caabb71a958afec8bf7ff00a320bac", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5567355bb2caabb71a958afec8bf7ff00a320bac"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/649b6323cd20d4a454264798c189107fd1eda33f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/649b6323cd20d4a454264798c189107fd1eda33f", "html_url": "https://github.com/rust-lang/rust/commit/649b6323cd20d4a454264798c189107fd1eda33f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/649b6323cd20d4a454264798c189107fd1eda33f/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6318d24ad8440fa30428b405be1174478e9536e3", "url": "https://api.github.com/repos/rust-lang/rust/commits/6318d24ad8440fa30428b405be1174478e9536e3", "html_url": "https://github.com/rust-lang/rust/commit/6318d24ad8440fa30428b405be1174478e9536e3"}, {"sha": "d4e5e1bcffe7feb150d061985eb03c6e09ebb9f7", "url": "https://api.github.com/repos/rust-lang/rust/commits/d4e5e1bcffe7feb150d061985eb03c6e09ebb9f7", "html_url": "https://github.com/rust-lang/rust/commit/d4e5e1bcffe7feb150d061985eb03c6e09ebb9f7"}], "stats": {"total": 64, "additions": 19, "deletions": 45}, "files": [{"sha": "5c3444eff0a1185f71ea28cf5873a62fdaf42b8e", "filename": "src/librustc_codegen_ssa/back/write.rs", "status": "modified", "additions": 6, "deletions": 21, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/649b6323cd20d4a454264798c189107fd1eda33f/src%2Flibrustc_codegen_ssa%2Fback%2Fwrite.rs", "raw_url": "https://github.com/rust-lang/rust/raw/649b6323cd20d4a454264798c189107fd1eda33f/src%2Flibrustc_codegen_ssa%2Fback%2Fwrite.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fback%2Fwrite.rs?ref=649b6323cd20d4a454264798c189107fd1eda33f", "patch": "@@ -23,7 +23,7 @@ use rustc_hir::def_id::{CrateNum, LOCAL_CRATE};\n use rustc_incremental::{\n     copy_cgu_workproducts_to_incr_comp_cache_dir, in_incr_comp_dir, in_incr_comp_dir_sess,\n };\n-use rustc_middle::dep_graph::{WorkProduct, WorkProductFileKind, WorkProductId};\n+use rustc_middle::dep_graph::{WorkProduct, WorkProductId};\n use rustc_middle::middle::cstore::EncodedMetadata;\n use rustc_middle::middle::exported_symbols::SymbolExportLevel;\n use rustc_middle::ty::TyCtxt;\n@@ -477,10 +477,7 @@ fn copy_all_cgu_workproducts_to_incr_comp_cache_dir(\n         let mut files = vec![];\n \n         if let Some(ref path) = module.object {\n-            files.push((WorkProductFileKind::Object, path.clone()));\n-        }\n-        if let Some(ref path) = module.bytecode {\n-            files.push((WorkProductFileKind::Bytecode, path.clone()));\n+            files.push(path.clone());\n         }\n \n         if let Some((id, product)) =\n@@ -817,20 +814,9 @@ fn execute_copy_from_cache_work_item<B: ExtraBackendMethods>(\n ) -> Result<WorkItemResult<B>, FatalError> {\n     let incr_comp_session_dir = cgcx.incr_comp_session_dir.as_ref().unwrap();\n     let mut object = None;\n-    let mut bytecode = None;\n-    for (kind, saved_file) in &module.source.saved_files {\n-        let obj_out = match kind {\n-            WorkProductFileKind::Object => {\n-                let path = cgcx.output_filenames.temp_path(OutputType::Object, Some(&module.name));\n-                object = Some(path.clone());\n-                path\n-            }\n-            WorkProductFileKind::Bytecode => {\n-                let path = cgcx.output_filenames.temp_path(OutputType::Bitcode, Some(&module.name));\n-                bytecode = Some(path.clone());\n-                path\n-            }\n-        };\n+    for saved_file in &module.source.saved_files {\n+        let obj_out = cgcx.output_filenames.temp_path(OutputType::Object, Some(&module.name));\n+        object = Some(obj_out.clone());\n         let source_file = in_incr_comp_dir(&incr_comp_session_dir, &saved_file);\n         debug!(\n             \"copying pre-existing module `{}` from {:?} to {}\",\n@@ -850,13 +836,12 @@ fn execute_copy_from_cache_work_item<B: ExtraBackendMethods>(\n     }\n \n     assert_eq!(object.is_some(), module_config.emit_obj != EmitObj::None);\n-    assert_eq!(bytecode.is_some(), module_config.emit_bc);\n \n     Ok(WorkItemResult::Compiled(CompiledModule {\n         name: module.name,\n         kind: ModuleKind::Regular,\n         object,\n-        bytecode,\n+        bytecode: None,\n     }))\n }\n "}, {"sha": "99c799950c06347c725426e84336ffd7086614f7", "filename": "src/librustc_incremental/persist/load.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/649b6323cd20d4a454264798c189107fd1eda33f/src%2Flibrustc_incremental%2Fpersist%2Fload.rs", "raw_url": "https://github.com/rust-lang/rust/raw/649b6323cd20d4a454264798c189107fd1eda33f/src%2Flibrustc_incremental%2Fpersist%2Fload.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_incremental%2Fpersist%2Fload.rs?ref=649b6323cd20d4a454264798c189107fd1eda33f", "patch": "@@ -134,7 +134,7 @@ pub fn load_dep_graph(sess: &Session) -> DepGraphFuture {\n \n             for swp in work_products {\n                 let mut all_files_exist = true;\n-                for &(_, ref file_name) in swp.work_product.saved_files.iter() {\n+                for file_name in swp.work_product.saved_files.iter() {\n                     let path = in_incr_comp_dir_sess(sess, file_name);\n                     if !path.exists() {\n                         all_files_exist = false;"}, {"sha": "4db6297712c59f569e4b3b7fe6487b836801e878", "filename": "src/librustc_incremental/persist/save.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/649b6323cd20d4a454264798c189107fd1eda33f/src%2Flibrustc_incremental%2Fpersist%2Fsave.rs", "raw_url": "https://github.com/rust-lang/rust/raw/649b6323cd20d4a454264798c189107fd1eda33f/src%2Flibrustc_incremental%2Fpersist%2Fsave.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_incremental%2Fpersist%2Fsave.rs?ref=649b6323cd20d4a454264798c189107fd1eda33f", "patch": "@@ -74,9 +74,9 @@ pub fn save_work_product_index(\n         if !new_work_products.contains_key(id) {\n             work_product::delete_workproduct_files(sess, wp);\n             debug_assert!(\n-                wp.saved_files.iter().all(|&(_, ref file_name)| {\n-                    !in_incr_comp_dir_sess(sess, file_name).exists()\n-                })\n+                wp.saved_files\n+                    .iter()\n+                    .all(|file_name| { !in_incr_comp_dir_sess(sess, file_name).exists() })\n             );\n         }\n     }\n@@ -85,7 +85,7 @@ pub fn save_work_product_index(\n     debug_assert!({\n         new_work_products\n             .iter()\n-            .flat_map(|(_, wp)| wp.saved_files.iter().map(|&(_, ref name)| name))\n+            .flat_map(|(_, wp)| wp.saved_files.iter())\n             .map(|name| in_incr_comp_dir_sess(sess, name))\n             .all(|path| path.exists())\n     });"}, {"sha": "a15ee6d81dbbcccf07bb2621442ff846d3148d67", "filename": "src/librustc_incremental/persist/work_product.rs", "status": "modified", "additions": 6, "deletions": 10, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/649b6323cd20d4a454264798c189107fd1eda33f/src%2Flibrustc_incremental%2Fpersist%2Fwork_product.rs", "raw_url": "https://github.com/rust-lang/rust/raw/649b6323cd20d4a454264798c189107fd1eda33f/src%2Flibrustc_incremental%2Fpersist%2Fwork_product.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_incremental%2Fpersist%2Fwork_product.rs?ref=649b6323cd20d4a454264798c189107fd1eda33f", "patch": "@@ -2,30 +2,26 @@\n \n use crate::persist::fs::*;\n use rustc_fs_util::link_or_copy;\n-use rustc_middle::dep_graph::{WorkProduct, WorkProductFileKind, WorkProductId};\n+use rustc_middle::dep_graph::{WorkProduct, WorkProductId};\n use rustc_session::Session;\n use std::fs as std_fs;\n use std::path::PathBuf;\n \n pub fn copy_cgu_workproducts_to_incr_comp_cache_dir(\n     sess: &Session,\n     cgu_name: &str,\n-    files: &[(WorkProductFileKind, PathBuf)],\n+    files: &[PathBuf],\n ) -> Option<(WorkProductId, WorkProduct)> {\n     debug!(\"copy_cgu_workproducts_to_incr_comp_cache_dir({:?},{:?})\", cgu_name, files);\n     sess.opts.incremental.as_ref()?;\n \n     let saved_files = files\n         .iter()\n-        .map(|&(kind, ref path)| {\n-            let extension = match kind {\n-                WorkProductFileKind::Object => \"o\",\n-                WorkProductFileKind::Bytecode => \"bc\",\n-            };\n-            let file_name = format!(\"{}.{}\", cgu_name, extension);\n+        .map(|path| {\n+            let file_name = format!(\"{}.o\", cgu_name);\n             let path_in_incr_dir = in_incr_comp_dir_sess(sess, &file_name);\n             match link_or_copy(path, &path_in_incr_dir) {\n-                Ok(_) => Some((kind, file_name)),\n+                Ok(_) => Some(file_name),\n                 Err(err) => {\n                     sess.warn(&format!(\n                         \"error copying object file `{}` \\\n@@ -47,7 +43,7 @@ pub fn copy_cgu_workproducts_to_incr_comp_cache_dir(\n }\n \n pub fn delete_workproduct_files(sess: &Session, work_product: &WorkProduct) {\n-    for &(_, ref file_name) in &work_product.saved_files {\n+    for file_name in &work_product.saved_files {\n         let path = in_incr_comp_dir_sess(sess, file_name);\n         match std_fs::remove_file(&path) {\n             Ok(()) => {}"}, {"sha": "f997df25e9919bee97a171c2c13d5023c25f6f35", "filename": "src/librustc_middle/dep_graph/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/649b6323cd20d4a454264798c189107fd1eda33f/src%2Flibrustc_middle%2Fdep_graph%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/649b6323cd20d4a454264798c189107fd1eda33f/src%2Flibrustc_middle%2Fdep_graph%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_middle%2Fdep_graph%2Fmod.rs?ref=649b6323cd20d4a454264798c189107fd1eda33f", "patch": "@@ -12,7 +12,7 @@ mod dep_node;\n pub(crate) use rustc_query_system::dep_graph::DepNodeParams;\n pub use rustc_query_system::dep_graph::{\n     debug, hash_result, DepContext, DepNodeColor, DepNodeIndex, SerializedDepNodeIndex,\n-    WorkProduct, WorkProductFileKind, WorkProductId,\n+    WorkProduct, WorkProductId,\n };\n \n pub use dep_node::{label_strs, DepConstructor, DepKind, DepNode, DepNodeExt};"}, {"sha": "5f14a09b24daaced6255be8eea34c84b99cc396c", "filename": "src/librustc_query_system/dep_graph/graph.rs", "status": "modified", "additions": 1, "deletions": 7, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/649b6323cd20d4a454264798c189107fd1eda33f/src%2Flibrustc_query_system%2Fdep_graph%2Fgraph.rs", "raw_url": "https://github.com/rust-lang/rust/raw/649b6323cd20d4a454264798c189107fd1eda33f/src%2Flibrustc_query_system%2Fdep_graph%2Fgraph.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_query_system%2Fdep_graph%2Fgraph.rs?ref=649b6323cd20d4a454264798c189107fd1eda33f", "patch": "@@ -861,13 +861,7 @@ impl<K: DepKind> DepGraph<K> {\n pub struct WorkProduct {\n     pub cgu_name: String,\n     /// Saved files associated with this CGU.\n-    pub saved_files: Vec<(WorkProductFileKind, String)>,\n-}\n-\n-#[derive(Clone, Copy, Debug, RustcEncodable, RustcDecodable, PartialEq)]\n-pub enum WorkProductFileKind {\n-    Object,\n-    Bytecode,\n+    pub saved_files: Vec<String>,\n }\n \n #[derive(Clone)]"}, {"sha": "f85462eb78bd52de20fb81f65dfde51757b48b66", "filename": "src/librustc_query_system/dep_graph/mod.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/649b6323cd20d4a454264798c189107fd1eda33f/src%2Flibrustc_query_system%2Fdep_graph%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/649b6323cd20d4a454264798c189107fd1eda33f/src%2Flibrustc_query_system%2Fdep_graph%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_query_system%2Fdep_graph%2Fmod.rs?ref=649b6323cd20d4a454264798c189107fd1eda33f", "patch": "@@ -6,7 +6,6 @@ mod query;\n mod serialized;\n \n pub use dep_node::{DepNode, DepNodeParams, WorkProductId};\n-pub use graph::WorkProductFileKind;\n pub use graph::{hash_result, DepGraph, DepNodeColor, DepNodeIndex, TaskDeps, WorkProduct};\n pub use prev::PreviousDepGraph;\n pub use query::DepGraphQuery;"}]}