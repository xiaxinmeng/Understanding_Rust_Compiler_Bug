{"sha": "2c4862245a539a281df31a190d05b8ae8eac58ba", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJjNDg2MjI0NWE1MzlhMjgxZGYzMWExOTBkMDViOGFlOGVhYzU4YmE=", "commit": {"author": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2019-10-24T00:00:00Z"}, "committer": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2019-11-03T09:20:11Z"}, "message": "Validate error patterns and error annotation in ui tests when present\n\nPreviously, when compilation succeeded, neither error patterns nor error\nannotation would be validated. Additionally, when compilation failed,\nonly error patterns would be validated if both error patterns and error\nannotation were present.\n\nNow both error patterns and error annotation are validated when present,\nregardless of compilation status. Furthermore, for test that should run,\nthe error patterns are matched against executable output, which is what\nsome of tests already expect to happen, and when #65506 is merged even\nmore ui tests will.", "tree": {"sha": "fdaf919fae962b3d24027297307a46617b27d4a3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fdaf919fae962b3d24027297307a46617b27d4a3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2c4862245a539a281df31a190d05b8ae8eac58ba", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2c4862245a539a281df31a190d05b8ae8eac58ba", "html_url": "https://github.com/rust-lang/rust/commit/2c4862245a539a281df31a190d05b8ae8eac58ba", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2c4862245a539a281df31a190d05b8ae8eac58ba/comments", "author": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f6c2c4dc43bc0340368ed38cecb309be472df146", "url": "https://api.github.com/repos/rust-lang/rust/commits/f6c2c4dc43bc0340368ed38cecb309be472df146", "html_url": "https://github.com/rust-lang/rust/commit/f6c2c4dc43bc0340368ed38cecb309be472df146"}], "stats": {"total": 19, "additions": 11, "deletions": 8}, "files": [{"sha": "a9acc9733c19ead03713f28cd0ab2f5ce448a8cc", "filename": "src/tools/compiletest/src/runtest.rs", "status": "modified", "additions": 11, "deletions": 8, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/2c4862245a539a281df31a190d05b8ae8eac58ba/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2c4862245a539a281df31a190d05b8ae8eac58ba/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs?ref=2c4862245a539a281df31a190d05b8ae8eac58ba", "patch": "@@ -3137,21 +3137,24 @@ impl<'test> TestCx<'test> {\n                     self.fatal_proc_rec(\"test run succeeded!\", &proc_res);\n                 }\n             }\n+            if !self.props.error_patterns.is_empty() {\n+                // \"// error-pattern\" comments\n+                self.check_error_patterns(&proc_res.stderr, &proc_res);\n+            }\n         }\n \n         debug!(\"run_ui_test: explicit={:?} config.compare_mode={:?} expected_errors={:?} \\\n                proc_res.status={:?} props.error_patterns={:?}\",\n                explicit, self.config.compare_mode, expected_errors, proc_res.status,\n                self.props.error_patterns);\n         if !explicit && self.config.compare_mode.is_none() {\n-            if !proc_res.status.success() {\n-                if !self.props.error_patterns.is_empty() {\n-                    // \"// error-pattern\" comments\n-                    self.check_error_patterns(&proc_res.stderr, &proc_res);\n-                } else {\n-                    // \"//~ERROR comments\"\n-                    self.check_expected_errors(expected_errors, &proc_res);\n-                }\n+            if !self.should_run() && !self.props.error_patterns.is_empty() {\n+                // \"// error-pattern\" comments\n+                self.check_error_patterns(&proc_res.stderr, &proc_res);\n+            }\n+            if !expected_errors.is_empty() {\n+                // \"//~ERROR comments\"\n+                self.check_expected_errors(expected_errors, &proc_res);\n             }\n         }\n "}]}