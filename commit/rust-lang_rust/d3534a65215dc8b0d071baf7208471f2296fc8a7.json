{"sha": "d3534a65215dc8b0d071baf7208471f2296fc8a7", "node_id": "C_kwDOAAsO6NoAKGQzNTM0YTY1MjE1ZGM4YjBkMDcxYmFmNzIwODQ3MWYyMjk2ZmM4YTc", "commit": {"author": {"name": "disco07", "email": "koneenok@outlook.fr", "date": "2023-05-30T05:43:10Z"}, "committer": {"name": "disco07", "email": "koneenok@outlook.fr", "date": "2023-05-30T05:43:10Z"}, "message": "fix issues 10836", "tree": {"sha": "7a135f8a1a8b5a3594bb51639bd9a1c9b53d115a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7a135f8a1a8b5a3594bb51639bd9a1c9b53d115a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d3534a65215dc8b0d071baf7208471f2296fc8a7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d3534a65215dc8b0d071baf7208471f2296fc8a7", "html_url": "https://github.com/rust-lang/rust/commit/d3534a65215dc8b0d071baf7208471f2296fc8a7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d3534a65215dc8b0d071baf7208471f2296fc8a7/comments", "author": {"login": "disco07", "id": 60718751, "node_id": "MDQ6VXNlcjYwNzE4NzUx", "avatar_url": "https://avatars.githubusercontent.com/u/60718751?v=4", "gravatar_id": "", "url": "https://api.github.com/users/disco07", "html_url": "https://github.com/disco07", "followers_url": "https://api.github.com/users/disco07/followers", "following_url": "https://api.github.com/users/disco07/following{/other_user}", "gists_url": "https://api.github.com/users/disco07/gists{/gist_id}", "starred_url": "https://api.github.com/users/disco07/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/disco07/subscriptions", "organizations_url": "https://api.github.com/users/disco07/orgs", "repos_url": "https://api.github.com/users/disco07/repos", "events_url": "https://api.github.com/users/disco07/events{/privacy}", "received_events_url": "https://api.github.com/users/disco07/received_events", "type": "User", "site_admin": false}, "committer": {"login": "disco07", "id": 60718751, "node_id": "MDQ6VXNlcjYwNzE4NzUx", "avatar_url": "https://avatars.githubusercontent.com/u/60718751?v=4", "gravatar_id": "", "url": "https://api.github.com/users/disco07", "html_url": "https://github.com/disco07", "followers_url": "https://api.github.com/users/disco07/followers", "following_url": "https://api.github.com/users/disco07/following{/other_user}", "gists_url": "https://api.github.com/users/disco07/gists{/gist_id}", "starred_url": "https://api.github.com/users/disco07/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/disco07/subscriptions", "organizations_url": "https://api.github.com/users/disco07/orgs", "repos_url": "https://api.github.com/users/disco07/repos", "events_url": "https://api.github.com/users/disco07/events{/privacy}", "received_events_url": "https://api.github.com/users/disco07/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f1fd4673bc997164efbf0ba30cef01ffba24a43f", "url": "https://api.github.com/repos/rust-lang/rust/commits/f1fd4673bc997164efbf0ba30cef01ffba24a43f", "html_url": "https://github.com/rust-lang/rust/commit/f1fd4673bc997164efbf0ba30cef01ffba24a43f"}], "stats": {"total": 71, "additions": 54, "deletions": 17}, "files": [{"sha": "4bd48185f37e5582986173dcbb448898c50f20fb", "filename": "clippy_lints/src/booleans.rs", "status": "modified", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/d3534a65215dc8b0d071baf7208471f2296fc8a7/clippy_lints%2Fsrc%2Fbooleans.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d3534a65215dc8b0d071baf7208471f2296fc8a7/clippy_lints%2Fsrc%2Fbooleans.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fbooleans.rs?ref=d3534a65215dc8b0d071baf7208471f2296fc8a7", "patch": "@@ -8,10 +8,12 @@ use rustc_errors::Applicability;\n use rustc_hir::intravisit::{walk_expr, FnKind, Visitor};\n use rustc_hir::{BinOpKind, Body, Expr, ExprKind, FnDecl, UnOp};\n use rustc_lint::{LateContext, LateLintPass, Level};\n+use rustc_middle::ty::{self, Ty};\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n use rustc_span::def_id::LocalDefId;\n use rustc_span::source_map::Span;\n use rustc_span::sym;\n+use rustc_span::symbol::Ident;\n \n declare_clippy_lint! {\n     /// ### What it does\n@@ -89,6 +91,27 @@ impl<'tcx> LateLintPass<'tcx> for NonminimalBool {\n     }\n }\n \n+fn is_impl_not_trait_with_bool_out<'tcx>(cx: &LateContext<'tcx>, ty: Ty<'tcx>) -> bool {\n+    cx.tcx\n+        .lang_items()\n+        .not_trait()\n+        .filter(|trait_id| implements_trait(cx, ty, *trait_id, &[]))\n+        .and_then(|trait_id| {\n+            cx.tcx.associated_items(trait_id).find_by_name_and_kind(\n+                cx.tcx,\n+                Ident::from_str(\"Output\"),\n+                ty::AssocKind::Type,\n+                trait_id,\n+            )\n+        })\n+        .map_or(false, |assoc_item| {\n+            let proj = cx.tcx.mk_projection(assoc_item.def_id, cx.tcx.mk_substs_trait(ty, []));\n+            let nty = cx.tcx.normalize_erasing_regions(cx.param_env, proj);\n+\n+            nty.is_bool()\n+        })\n+}\n+\n struct NonminimalBoolVisitor<'a, 'tcx> {\n     cx: &'a LateContext<'tcx>,\n }\n@@ -473,6 +496,12 @@ impl<'a, 'tcx> Visitor<'tcx> for NonminimalBoolVisitor<'a, 'tcx> {\n                     self.bool_expr(e);\n                 },\n                 ExprKind::Unary(UnOp::Not, inner) => {\n+                    if let ExprKind::Unary(UnOp::Not, ex) = inner.kind {\n+                        let ty = self.cx.typeck_results().expr_ty(ex);\n+                        if is_impl_not_trait_with_bool_out(self.cx, ty) {\n+                            return;\n+                        }\n+                    }\n                     if self.cx.typeck_results().node_types()[inner.hir_id].is_bool() {\n                         self.bool_expr(e);\n                     }"}, {"sha": "54cbbdef22e0ffa91f7657805dba2fc0f719cabe", "filename": "tests/ui/nonminimal_bool.rs", "status": "modified", "additions": 15, "deletions": 1, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/d3534a65215dc8b0d071baf7208471f2296fc8a7/tests%2Fui%2Fnonminimal_bool.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d3534a65215dc8b0d071baf7208471f2296fc8a7/tests%2Fui%2Fnonminimal_bool.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fnonminimal_bool.rs?ref=d3534a65215dc8b0d071baf7208471f2296fc8a7", "patch": "@@ -10,6 +10,7 @@ fn main() {\n     let e: bool = unimplemented!();\n     let _ = !true;\n     let _ = !false;\n+    // vvv Should not lint\n     let _ = !!a;\n     let _ = false || a;\n     // don't lint on cfgs\n@@ -54,7 +55,6 @@ fn issue4548() {\n \n fn check_expect() {\n     let a: bool = unimplemented!();\n-    #[expect(clippy::nonminimal_bool)]\n     let _ = !!a;\n }\n \n@@ -110,3 +110,17 @@ fn issue_10435() {\n         println!(\"{}\", line!());\n     }\n }\n+\n+fn issue10836() {\n+    struct Foo(bool);\n+    impl std::ops::Not for Foo {\n+        type Output = bool;\n+\n+        fn not(self) -> Self::Output {\n+            !self.0\n+        }\n+    }\n+\n+    // Should not lint\n+    let _: bool = !!Foo(true);\n+}"}, {"sha": "fa14471301ee1f7cdd9ba7695e07a2c36ffaa57c", "filename": "tests/ui/nonminimal_bool.stderr", "status": "modified", "additions": 10, "deletions": 16, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/d3534a65215dc8b0d071baf7208471f2296fc8a7/tests%2Fui%2Fnonminimal_bool.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d3534a65215dc8b0d071baf7208471f2296fc8a7/tests%2Fui%2Fnonminimal_bool.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fnonminimal_bool.stderr?ref=d3534a65215dc8b0d071baf7208471f2296fc8a7", "patch": "@@ -13,37 +13,31 @@ LL |     let _ = !false;\n    |             ^^^^^^ help: try: `true`\n \n error: this boolean expression can be simplified\n-  --> $DIR/nonminimal_bool.rs:13:13\n-   |\n-LL |     let _ = !!a;\n-   |             ^^^ help: try: `a`\n-\n-error: this boolean expression can be simplified\n-  --> $DIR/nonminimal_bool.rs:14:13\n+  --> $DIR/nonminimal_bool.rs:15:13\n    |\n LL |     let _ = false || a;\n    |             ^^^^^^^^^^ help: try: `a`\n \n error: this boolean expression can be simplified\n-  --> $DIR/nonminimal_bool.rs:18:13\n+  --> $DIR/nonminimal_bool.rs:19:13\n    |\n LL |     let _ = !(!a && b);\n    |             ^^^^^^^^^^ help: try: `a || !b`\n \n error: this boolean expression can be simplified\n-  --> $DIR/nonminimal_bool.rs:19:13\n+  --> $DIR/nonminimal_bool.rs:20:13\n    |\n LL |     let _ = !(!a || b);\n    |             ^^^^^^^^^^ help: try: `a && !b`\n \n error: this boolean expression can be simplified\n-  --> $DIR/nonminimal_bool.rs:20:13\n+  --> $DIR/nonminimal_bool.rs:21:13\n    |\n LL |     let _ = !a && !(b && c);\n    |             ^^^^^^^^^^^^^^^ help: try: `!(a || b && c)`\n \n error: this boolean expression can be simplified\n-  --> $DIR/nonminimal_bool.rs:28:13\n+  --> $DIR/nonminimal_bool.rs:29:13\n    |\n LL |     let _ = a == b && c == 5 && a == b;\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^\n@@ -56,7 +50,7 @@ LL |     let _ = a == b && c == 5;\n    |             ~~~~~~~~~~~~~~~~\n \n error: this boolean expression can be simplified\n-  --> $DIR/nonminimal_bool.rs:29:13\n+  --> $DIR/nonminimal_bool.rs:30:13\n    |\n LL |     let _ = a == b || c == 5 || a == b;\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^\n@@ -69,7 +63,7 @@ LL |     let _ = a == b || c == 5;\n    |             ~~~~~~~~~~~~~~~~\n \n error: this boolean expression can be simplified\n-  --> $DIR/nonminimal_bool.rs:30:13\n+  --> $DIR/nonminimal_bool.rs:31:13\n    |\n LL |     let _ = a == b && c == 5 && b == a;\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^\n@@ -82,7 +76,7 @@ LL |     let _ = a == b && c == 5;\n    |             ~~~~~~~~~~~~~~~~\n \n error: this boolean expression can be simplified\n-  --> $DIR/nonminimal_bool.rs:31:13\n+  --> $DIR/nonminimal_bool.rs:32:13\n    |\n LL |     let _ = a != b || !(a != b || c == d);\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n@@ -95,7 +89,7 @@ LL |     let _ = a != b || c != d;\n    |             ~~~~~~~~~~~~~~~~\n \n error: this boolean expression can be simplified\n-  --> $DIR/nonminimal_bool.rs:32:13\n+  --> $DIR/nonminimal_bool.rs:33:13\n    |\n LL |     let _ = a != b && !(a != b && c == d);\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n@@ -113,5 +107,5 @@ error: this boolean expression can be simplified\n LL |     if matches!(true, true) && true {\n    |        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: try: `matches!(true, true)`\n \n-error: aborting due to 13 previous errors\n+error: aborting due to 12 previous errors\n "}]}