{"sha": "dd00582bc878c0e48f13ef46e115af3a8668aa4e", "node_id": "C_kwDOAAsO6NoAKGRkMDA1ODJiYzg3OGMwZTQ4ZjEzZWY0NmUxMTVhZjNhODY2OGFhNGU", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-12-11T08:51:57Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-12-11T08:51:57Z"}, "message": "Rollup merge of #105539 - GuillaumeGomez:hashtag-prepended-lines-non-rust, r=notriddle\n\nrustdoc: Only hide lines starting with `#` in rust code blocks\n\nFixes https://github.com/rust-lang/rust/issues/105527.\n\nSo before approving, this is a big question: in rust code blocks, in a line starts with a `#`, we hide it in the output. However, should we do the same for non-rust code blocks too? I think it's a bit problematic to do it because `#` can be used for many things but I prefer to check first with everyone (might also be worth updating documentation too).\n\ncc ``@rust-lang/rustdoc``\nr? ``@notriddle``", "tree": {"sha": "e732cdfb8a102576b17a4d877cff6959fe3befdc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e732cdfb8a102576b17a4d877cff6959fe3befdc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/dd00582bc878c0e48f13ef46e115af3a8668aa4e", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjlZotCRBK7hj4Ov3rIwAAgtQIAHjJSPEBZYzxCL+2LpC96qHe\nmGtuutirfhuoiXnFlbyrK85tMJKRSrIsh5ixJZW83H/1kxlHqSfLm3tP+E4UlwaI\nnzcw7WaOqS+9iZ0kWi/UDIGXE0aJIk88FIQt7vm2IBTy4dat3GuMbqv7Jgex61iO\nllXjxJg6yK3CHGxmg3tTF1gPGE8QC5VuV7lh680I3x7/YX4vQZMUbbrbvj/aM9Bz\nnLhaovho87++GBDR+m+QhMatnbIJKHHOEN8rcmJfyAcSO6IDCJ6AcAD/5/zUbS/6\nbXawutHCLhWHALWNMPYUTv/Whvd7AcWLa1XzEtmpBpjxzaF5PMmfvCWCFXDm68c=\n=Hyxb\n-----END PGP SIGNATURE-----\n", "payload": "tree e732cdfb8a102576b17a4d877cff6959fe3befdc\nparent 2daa3bcbc2c2dcd05312a176cf0bc50713dffacd\nparent bc63c0edc0d1e82302305a479f53aa1137e96179\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1670748717 +0100\ncommitter GitHub <noreply@github.com> 1670748717 +0100\n\nRollup merge of #105539 - GuillaumeGomez:hashtag-prepended-lines-non-rust, r=notriddle\n\nrustdoc: Only hide lines starting with `#` in rust code blocks\n\nFixes https://github.com/rust-lang/rust/issues/105527.\n\nSo before approving, this is a big question: in rust code blocks, in a line starts with a `#`, we hide it in the output. However, should we do the same for non-rust code blocks too? I think it's a bit problematic to do it because `#` can be used for many things but I prefer to check first with everyone (might also be worth updating documentation too).\n\ncc ``@rust-lang/rustdoc``\nr? ``@notriddle``\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/dd00582bc878c0e48f13ef46e115af3a8668aa4e", "html_url": "https://github.com/rust-lang/rust/commit/dd00582bc878c0e48f13ef46e115af3a8668aa4e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/dd00582bc878c0e48f13ef46e115af3a8668aa4e/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2daa3bcbc2c2dcd05312a176cf0bc50713dffacd", "url": "https://api.github.com/repos/rust-lang/rust/commits/2daa3bcbc2c2dcd05312a176cf0bc50713dffacd", "html_url": "https://github.com/rust-lang/rust/commit/2daa3bcbc2c2dcd05312a176cf0bc50713dffacd"}, {"sha": "bc63c0edc0d1e82302305a479f53aa1137e96179", "url": "https://api.github.com/repos/rust-lang/rust/commits/bc63c0edc0d1e82302305a479f53aa1137e96179", "html_url": "https://github.com/rust-lang/rust/commit/bc63c0edc0d1e82302305a479f53aa1137e96179"}], "stats": {"total": 44, "additions": 41, "deletions": 3}, "files": [{"sha": "1e1c657b0bf22f7d71306f57099be4ac8d9c3145", "filename": "src/librustdoc/html/markdown.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/dd00582bc878c0e48f13ef46e115af3a8668aa4e/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dd00582bc878c0e48f13ef46e115af3a8668aa4e/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs?ref=dd00582bc878c0e48f13ef46e115af3a8668aa4e", "patch": "@@ -246,8 +246,6 @@ impl<'a, I: Iterator<Item = Event<'a>>> Iterator for CodeBlocks<'_, 'a, I> {\n                 _ => {}\n             }\n         }\n-        let lines = origtext.lines().filter_map(|l| map_line(l).for_html());\n-        let text = lines.intersperse(\"\\n\".into()).collect::<String>();\n \n         let parse_result = match kind {\n             CodeBlockKind::Fenced(ref lang) => {\n@@ -260,7 +258,7 @@ impl<'a, I: Iterator<Item = Event<'a>>> Iterator for CodeBlocks<'_, 'a, I> {\n                                  <pre class=\\\"language-{}\\\"><code>{}</code></pre>\\\n                              </div>\",\n                             lang,\n-                            Escape(&text),\n+                            Escape(&origtext),\n                         )\n                         .into(),\n                     ));\n@@ -270,6 +268,9 @@ impl<'a, I: Iterator<Item = Event<'a>>> Iterator for CodeBlocks<'_, 'a, I> {\n             CodeBlockKind::Indented => Default::default(),\n         };\n \n+        let lines = origtext.lines().filter_map(|l| map_line(l).for_html());\n+        let text = lines.intersperse(\"\\n\".into()).collect::<String>();\n+\n         compile_fail = parse_result.compile_fail;\n         should_panic = parse_result.should_panic;\n         ignore = parse_result.ignore;"}, {"sha": "68b31a6ee083d1f82b1bfcfa4131913e451cd0e9", "filename": "src/librustdoc/html/markdown/tests.rs", "status": "modified", "additions": 37, "deletions": 0, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/dd00582bc878c0e48f13ef46e115af3a8668aa4e/src%2Flibrustdoc%2Fhtml%2Fmarkdown%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dd00582bc878c0e48f13ef46e115af3a8668aa4e/src%2Flibrustdoc%2Fhtml%2Fmarkdown%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fmarkdown%2Ftests.rs?ref=dd00582bc878c0e48f13ef46e115af3a8668aa4e", "patch": "@@ -309,3 +309,40 @@ fn test_find_testable_code_line() {\n     t(\"```rust\\n```\\n```rust\\n```\", &[1, 3]);\n     t(\"```rust\\n```\\n ```rust\\n```\", &[1, 3]);\n }\n+\n+#[test]\n+fn test_ascii_with_prepending_hashtag() {\n+    fn t(input: &str, expect: &str) {\n+        let mut map = IdMap::new();\n+        let output = Markdown {\n+            content: input,\n+            links: &[],\n+            ids: &mut map,\n+            error_codes: ErrorCodes::Yes,\n+            edition: DEFAULT_EDITION,\n+            playground: &None,\n+            heading_offset: HeadingOffset::H2,\n+        }\n+        .into_string();\n+        assert_eq!(output, expect, \"original: {}\", input);\n+    }\n+\n+    t(\n+        r#\"```ascii\n+#..#.####.#....#.....##..\n+#..#.#....#....#....#..#.\n+####.###..#....#....#..#.\n+#..#.#....#....#....#..#.\n+#..#.#....#....#....#..#.\n+#..#.####.####.####..##..\n+```\"#,\n+        \"<div class=\\\"example-wrap\\\"><pre class=\\\"language-ascii\\\"><code>\\\n+#..#.####.#....#.....##..\n+#..#.#....#....#....#..#.\n+####.###..#....#....#..#.\n+#..#.#....#....#....#..#.\n+#..#.#....#....#....#..#.\n+#..#.####.####.####..##..\n+</code></pre></div>\",\n+    );\n+}"}]}