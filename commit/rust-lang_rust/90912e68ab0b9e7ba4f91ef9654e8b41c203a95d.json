{"sha": "90912e68ab0b9e7ba4f91ef9654e8b41c203a95d", "node_id": "C_kwDOAAsO6NoAKDkwOTEyZTY4YWIwYjllN2JhNGY5MWVmOTY1NGU4YjQxYzIwM2E5NWQ", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-11-30T07:40:08Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-11-30T07:40:08Z"}, "message": "Auto merge of #91330 - cjgillot:no-ee-features, r=Aaron1011\n\nRemove eval_always for lib_features.\n\nr? `@Aaron1011`", "tree": {"sha": "23470a3e178b70da3a4cdc87b6da5bf6e6338429", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/23470a3e178b70da3a4cdc87b6da5bf6e6338429"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/90912e68ab0b9e7ba4f91ef9654e8b41c203a95d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/90912e68ab0b9e7ba4f91ef9654e8b41c203a95d", "html_url": "https://github.com/rust-lang/rust/commit/90912e68ab0b9e7ba4f91ef9654e8b41c203a95d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/90912e68ab0b9e7ba4f91ef9654e8b41c203a95d/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4c948963306dc195d5b20a0b4300d90a2b423b8b", "url": "https://api.github.com/repos/rust-lang/rust/commits/4c948963306dc195d5b20a0b4300d90a2b423b8b", "html_url": "https://github.com/rust-lang/rust/commit/4c948963306dc195d5b20a0b4300d90a2b423b8b"}, {"sha": "877b2d79d98428cdc9b971a627a7adf10533aed8", "url": "https://api.github.com/repos/rust-lang/rust/commits/877b2d79d98428cdc9b971a627a7adf10533aed8", "html_url": "https://github.com/rust-lang/rust/commit/877b2d79d98428cdc9b971a627a7adf10533aed8"}], "stats": {"total": 16, "additions": 5, "deletions": 11}, "files": [{"sha": "514a49d7e2ce27f25b59706720158ad62b249788", "filename": "compiler/rustc_metadata/src/rmeta/encoder.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/90912e68ab0b9e7ba4f91ef9654e8b41c203a95d/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fencoder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/90912e68ab0b9e7ba4f91ef9654e8b41c203a95d/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fencoder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fencoder.rs?ref=90912e68ab0b9e7ba4f91ef9654e8b41c203a95d", "patch": "@@ -1749,7 +1749,7 @@ impl EncodeContext<'a, 'tcx> {\n     fn encode_lib_features(&mut self) -> Lazy<[(Symbol, Option<Symbol>)]> {\n         empty_proc_macro!(self);\n         let tcx = self.tcx;\n-        let lib_features = tcx.lib_features();\n+        let lib_features = tcx.lib_features(());\n         self.lazy(lib_features.to_vec())\n     }\n "}, {"sha": "268a66b99269bd28d5657f32f1fc1d33161b3559", "filename": "compiler/rustc_middle/src/query/mod.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/90912e68ab0b9e7ba4f91ef9654e8b41c203a95d/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/90912e68ab0b9e7ba4f91ef9654e8b41c203a95d/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs?ref=90912e68ab0b9e7ba4f91ef9654e8b41c203a95d", "patch": "@@ -1485,9 +1485,8 @@ rustc_queries! {\n         desc { |tcx| \"computing crate imported by `{}`\", tcx.def_path_str(def_id.to_def_id()) }\n     }\n \n-    query get_lib_features(_: ()) -> LibFeatures {\n+    query lib_features(_: ()) -> LibFeatures {\n         storage(ArenaCacheSelector<'tcx>)\n-        eval_always\n         desc { \"calculating the lib features map\" }\n     }\n     query defined_lib_features(_: CrateNum)"}, {"sha": "822458d312778d609d4e70f14a3eeadc27ea73e1", "filename": "compiler/rustc_middle/src/ty/context.rs", "status": "modified", "additions": 0, "deletions": 5, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/90912e68ab0b9e7ba4f91ef9654e8b41c203a95d/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/90912e68ab0b9e7ba4f91ef9654e8b41c203a95d/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs?ref=90912e68ab0b9e7ba4f91ef9654e8b41c203a95d", "patch": "@@ -5,7 +5,6 @@ use crate::dep_graph::{DepGraph, DepKind, DepKindStruct};\n use crate::hir::place::Place as HirPlace;\n use crate::infer::canonical::{Canonical, CanonicalVarInfo, CanonicalVarInfos};\n use crate::lint::{struct_lint_level, LintDiagnosticBuilder, LintLevelSource};\n-use crate::middle;\n use crate::middle::resolve_lifetime::{self, LifetimeScopeForPath, ObjectLifetimeDefault};\n use crate::middle::stability;\n use crate::mir::interpret::{self, Allocation, ConstValue, Scalar};\n@@ -1217,10 +1216,6 @@ impl<'tcx> TyCtxt<'tcx> {\n         self.sess.consider_optimizing(&cname, msg)\n     }\n \n-    pub fn lib_features(self) -> &'tcx middle::lib_features::LibFeatures {\n-        self.get_lib_features(())\n-    }\n-\n     /// Obtain all lang items of this crate and all dependencies (recursively)\n     pub fn lang_items(self) -> &'tcx rustc_hir::lang_items::LanguageItems {\n         self.get_lang_items(())"}, {"sha": "10b8c3104fcad1eba4031a54fdf9becd7e2f6c40", "filename": "compiler/rustc_passes/src/lib_features.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/90912e68ab0b9e7ba4f91ef9654e8b41c203a95d/compiler%2Frustc_passes%2Fsrc%2Flib_features.rs", "raw_url": "https://github.com/rust-lang/rust/raw/90912e68ab0b9e7ba4f91ef9654e8b41c203a95d/compiler%2Frustc_passes%2Fsrc%2Flib_features.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Flib_features.rs?ref=90912e68ab0b9e7ba4f91ef9654e8b41c203a95d", "patch": "@@ -124,12 +124,12 @@ impl Visitor<'tcx> for LibFeatureCollector<'tcx> {\n     }\n }\n \n-fn get_lib_features(tcx: TyCtxt<'_>, (): ()) -> LibFeatures {\n+fn lib_features(tcx: TyCtxt<'_>, (): ()) -> LibFeatures {\n     let mut collector = LibFeatureCollector::new(tcx);\n     tcx.hir().walk_attributes(&mut collector);\n     collector.lib_features\n }\n \n pub fn provide(providers: &mut Providers) {\n-    providers.get_lib_features = get_lib_features;\n+    providers.lib_features = lib_features;\n }"}, {"sha": "92911c3cd2455c7789ad572b10f87b5d221b9f0e", "filename": "compiler/rustc_passes/src/stability.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/90912e68ab0b9e7ba4f91ef9654e8b41c203a95d/compiler%2Frustc_passes%2Fsrc%2Fstability.rs", "raw_url": "https://github.com/rust-lang/rust/raw/90912e68ab0b9e7ba4f91ef9654e8b41c203a95d/compiler%2Frustc_passes%2Fsrc%2Fstability.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fstability.rs?ref=90912e68ab0b9e7ba4f91ef9654e8b41c203a95d", "patch": "@@ -970,7 +970,7 @@ pub fn check_unused_or_stable_features(tcx: TyCtxt<'_>) {\n \n     // We always collect the lib features declared in the current crate, even if there are\n     // no unknown features, because the collection also does feature attribute validation.\n-    let local_defined_features = tcx.lib_features().to_vec();\n+    let local_defined_features = tcx.lib_features(()).to_vec();\n     if !remaining_lib_features.is_empty() {\n         check_features(&mut remaining_lib_features, &local_defined_features);\n "}]}