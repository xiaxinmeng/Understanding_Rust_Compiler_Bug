{"sha": "c59199efca5856cdf810919fbf9b5bce32dc4523", "node_id": "MDY6Q29tbWl0NzI0NzEyOmM1OTE5OWVmY2E1ODU2Y2RmODEwOTE5ZmJmOWI1YmNlMzJkYzQ1MjM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-09-04T20:58:37Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-09-04T20:58:37Z"}, "message": "Auto merge of #76292 - Aaron1011:fix/proc-macro-panic-hide, r=petrochenkov\n\nRespect `-Z proc-macro-backtrace` flag for panics inside libproc_macro\n\nFixes #76270\n\nPreviously, any panic occuring during a call to a libproc_macro method\n(e.g. calling `Ident::new` with an invalid identifier) would always\ncause an ICE message to be printed.", "tree": {"sha": "fc2f8031e9f55a159896ea0e903f7a4212c9ea28", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fc2f8031e9f55a159896ea0e903f7a4212c9ea28"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c59199efca5856cdf810919fbf9b5bce32dc4523", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c59199efca5856cdf810919fbf9b5bce32dc4523", "html_url": "https://github.com/rust-lang/rust/commit/c59199efca5856cdf810919fbf9b5bce32dc4523", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c59199efca5856cdf810919fbf9b5bce32dc4523/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "42d896afbd0314375a12465a14dc8d23b1b73a55", "url": "https://api.github.com/repos/rust-lang/rust/commits/42d896afbd0314375a12465a14dc8d23b1b73a55", "html_url": "https://github.com/rust-lang/rust/commit/42d896afbd0314375a12465a14dc8d23b1b73a55"}, {"sha": "53cce257aebe822735ed9eecde152d928a3e7378", "url": "https://api.github.com/repos/rust-lang/rust/commits/53cce257aebe822735ed9eecde152d928a3e7378", "html_url": "https://github.com/rust-lang/rust/commit/53cce257aebe822735ed9eecde152d928a3e7378"}], "stats": {"total": 45, "additions": 42, "deletions": 3}, "files": [{"sha": "39daad4da127d3392e93d86b99d740fb89377f29", "filename": "library/proc_macro/src/bridge/client.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/c59199efca5856cdf810919fbf9b5bce32dc4523/library%2Fproc_macro%2Fsrc%2Fbridge%2Fclient.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c59199efca5856cdf810919fbf9b5bce32dc4523/library%2Fproc_macro%2Fsrc%2Fbridge%2Fclient.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fproc_macro%2Fsrc%2Fbridge%2Fclient.rs?ref=c59199efca5856cdf810919fbf9b5bce32dc4523", "patch": "@@ -305,6 +305,7 @@ impl Bridge<'_> {\n     }\n \n     fn enter<R>(self, f: impl FnOnce() -> R) -> R {\n+        let force_show_panics = self.force_show_panics;\n         // Hide the default panic output within `proc_macro` expansions.\n         // NB. the server can't do this because it may use a different libstd.\n         static HIDE_PANICS_DURING_EXPANSION: Once = Once::new();\n@@ -313,9 +314,7 @@ impl Bridge<'_> {\n             panic::set_hook(Box::new(move |info| {\n                 let show = BridgeState::with(|state| match state {\n                     BridgeState::NotConnected => true,\n-                    // Something weird is going on, so don't suppress any backtraces\n-                    BridgeState::InUse => true,\n-                    BridgeState::Connected(bridge) => bridge.force_show_panics,\n+                    BridgeState::Connected(_) | BridgeState::InUse => force_show_panics,\n                 });\n                 if show {\n                     prev(info)"}, {"sha": "fc15bb9c59db3de0323fd2160f1cc4f89ab33a1f", "filename": "src/test/ui-fulldeps/auxiliary/proc-macro-panic.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/c59199efca5856cdf810919fbf9b5bce32dc4523/src%2Ftest%2Fui-fulldeps%2Fauxiliary%2Fproc-macro-panic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c59199efca5856cdf810919fbf9b5bce32dc4523/src%2Ftest%2Fui-fulldeps%2Fauxiliary%2Fproc-macro-panic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui-fulldeps%2Fauxiliary%2Fproc-macro-panic.rs?ref=c59199efca5856cdf810919fbf9b5bce32dc4523", "patch": "@@ -0,0 +1,13 @@\n+// force-host\n+// no-prefer-dynamic\n+\n+#![crate_type = \"proc-macro\"]\n+\n+extern crate proc_macro;\n+use proc_macro::{TokenStream, Ident, Span};\n+\n+#[proc_macro]\n+pub fn panic_in_libproc_macro(_: TokenStream) -> TokenStream {\n+    Ident::new(\"\", Span::call_site());\n+    TokenStream::new()\n+}"}, {"sha": "981abb4e2c4d23f80440d59a47e278dd5abd993d", "filename": "src/test/ui-fulldeps/issue-76270-panic-in-libproc-macro.rs", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/c59199efca5856cdf810919fbf9b5bce32dc4523/src%2Ftest%2Fui-fulldeps%2Fissue-76270-panic-in-libproc-macro.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c59199efca5856cdf810919fbf9b5bce32dc4523/src%2Ftest%2Fui-fulldeps%2Fissue-76270-panic-in-libproc-macro.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui-fulldeps%2Fissue-76270-panic-in-libproc-macro.rs?ref=c59199efca5856cdf810919fbf9b5bce32dc4523", "patch": "@@ -0,0 +1,17 @@\n+// aux-build:proc-macro-panic.rs\n+// edition:2018\n+// ignore-stage1\n+// only-linux\n+//\n+// FIXME: This should be a normal (stage1, all platforms) test in\n+// src/test/ui/proc-macro once issue #59998 is fixed.\n+\n+// Regression test for issue #76270\n+// Tests that we don't print an ICE message when a panic\n+// occurs in libproc-macro (when `-Z proc-macro-backtrace` is not specified)\n+\n+extern crate proc_macro_panic;\n+\n+proc_macro_panic::panic_in_libproc_macro!(); //~ ERROR proc macro panicked\n+\n+fn main() {}"}, {"sha": "e472242ce4b07a7f548b132d6f1c6e4160d002f7", "filename": "src/test/ui-fulldeps/issue-76270-panic-in-libproc-macro.stderr", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/c59199efca5856cdf810919fbf9b5bce32dc4523/src%2Ftest%2Fui-fulldeps%2Fissue-76270-panic-in-libproc-macro.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c59199efca5856cdf810919fbf9b5bce32dc4523/src%2Ftest%2Fui-fulldeps%2Fissue-76270-panic-in-libproc-macro.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui-fulldeps%2Fissue-76270-panic-in-libproc-macro.stderr?ref=c59199efca5856cdf810919fbf9b5bce32dc4523", "patch": "@@ -0,0 +1,10 @@\n+error: proc macro panicked\n+  --> $DIR/issue-76270-panic-in-libproc-macro.rs:15:1\n+   |\n+LL | proc_macro_panic::panic_in_libproc_macro!();\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+   = help: message: `\"\"` is not a valid identifier\n+\n+error: aborting due to previous error\n+"}]}