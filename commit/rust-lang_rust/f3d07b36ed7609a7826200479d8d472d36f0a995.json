{"sha": "f3d07b36ed7609a7826200479d8d472d36f0a995", "node_id": "MDY6Q29tbWl0NzI0NzEyOmYzZDA3YjM2ZWQ3NjA5YTc4MjYyMDA0NzlkOGQ0NzJkMzZmMGE5OTU=", "commit": {"author": {"name": "Pietro Albini", "email": "pietro@pietroalbini.org", "date": "2020-10-12T15:47:37Z"}, "committer": {"name": "Pietro Albini", "email": "pietro@pietroalbini.org", "date": "2020-10-12T17:53:28Z"}, "message": "build-manifest: allow configuring the number of threads", "tree": {"sha": "5477921fba3ee199ce713060e666b19bd39e9099", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5477921fba3ee199ce713060e666b19bd39e9099"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f3d07b36ed7609a7826200479d8d472d36f0a995", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE1JbYPtLJAsc22U9xPgar6Auq8ZwFAl+EmBgACgkQPgar6Auq\n8ZxrmBAAsVRGQNNoQnGHiRhbQ5ktnKwdEWPbAlWhahV1hgGOFTmgZRP5F/cAHAyj\nr8BwP9d4U3H0FATbTr/EwvQkPNW5RRrQRXqrqRN/ZK/E5FQ8MxB1UkAJ17BQOFpq\nPFVmJedEU52zmkmC/ykCTYmtI858l7/YI9El1NMeZJedpMUPQT1HS9arDvhcPc4M\nmInxMET/iKbFsxFJgUisgeqvcs8JLM6CEFmNXiGI5A+0SXTEZih8FRx6zs2mpS7d\n/R95T3kyuMJfYgWpjPzgf4g3B0U+tefLHYLVlXEt+WeeRaMpLYNyBQYD3fZS9vyP\nPs6YjtlFEtU6nNEK5jcboxb8iessx091fdEcWypGneGCtSoiTZVhu06sSK+nt07t\nlEL9RUUR4ogCxazpteJGO++QMSRY11/0WF5zoYkrmPwDAH0Fm1feSEZexsbKGE2y\n99YuPpPKsemrvFfiRMtk55Qd+ZEdsGDcRO5uEaegrDEQi+N8137ZHDRIAfiMDut0\nAJYTUcGARIVkqydmaWPD23y4UVs/yYcKwzY5V3jrScxTnpe/I4P0Z7X7BfleCX3M\nGxLQHZxxn7pkrOj5nHJqqhPiU/IkYhlD640uKPkgbkGJ6VZOE16d54Zxz1be2sJQ\nvvoFC+/OOPusHY9zvvbf8oDHVPG07Vj90FDvIGwU3ZM14LrPy44=\n=MkW5\n-----END PGP SIGNATURE-----", "payload": "tree 5477921fba3ee199ce713060e666b19bd39e9099\nparent 24d04ccd3977d4eca676439067f096de484f6fa7\nauthor Pietro Albini <pietro@pietroalbini.org> 1602517657 +0200\ncommitter Pietro Albini <pietro@pietroalbini.org> 1602525208 +0200\n\nbuild-manifest: allow configuring the number of threads\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f3d07b36ed7609a7826200479d8d472d36f0a995", "html_url": "https://github.com/rust-lang/rust/commit/f3d07b36ed7609a7826200479d8d472d36f0a995", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f3d07b36ed7609a7826200479d8d472d36f0a995/comments", "author": {"login": "pietroalbini", "id": 2299951, "node_id": "MDQ6VXNlcjIyOTk5NTE=", "avatar_url": "https://avatars.githubusercontent.com/u/2299951?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pietroalbini", "html_url": "https://github.com/pietroalbini", "followers_url": "https://api.github.com/users/pietroalbini/followers", "following_url": "https://api.github.com/users/pietroalbini/following{/other_user}", "gists_url": "https://api.github.com/users/pietroalbini/gists{/gist_id}", "starred_url": "https://api.github.com/users/pietroalbini/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pietroalbini/subscriptions", "organizations_url": "https://api.github.com/users/pietroalbini/orgs", "repos_url": "https://api.github.com/users/pietroalbini/repos", "events_url": "https://api.github.com/users/pietroalbini/events{/privacy}", "received_events_url": "https://api.github.com/users/pietroalbini/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pietroalbini", "id": 2299951, "node_id": "MDQ6VXNlcjIyOTk5NTE=", "avatar_url": "https://avatars.githubusercontent.com/u/2299951?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pietroalbini", "html_url": "https://github.com/pietroalbini", "followers_url": "https://api.github.com/users/pietroalbini/followers", "following_url": "https://api.github.com/users/pietroalbini/following{/other_user}", "gists_url": "https://api.github.com/users/pietroalbini/gists{/gist_id}", "starred_url": "https://api.github.com/users/pietroalbini/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pietroalbini/subscriptions", "organizations_url": "https://api.github.com/users/pietroalbini/orgs", "repos_url": "https://api.github.com/users/pietroalbini/repos", "events_url": "https://api.github.com/users/pietroalbini/events{/privacy}", "received_events_url": "https://api.github.com/users/pietroalbini/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "24d04ccd3977d4eca676439067f096de484f6fa7", "url": "https://api.github.com/repos/rust-lang/rust/commits/24d04ccd3977d4eca676439067f096de484f6fa7", "html_url": "https://github.com/rust-lang/rust/commit/24d04ccd3977d4eca676439067f096de484f6fa7"}], "stats": {"total": 21, "additions": 14, "deletions": 7}, "files": [{"sha": "83ac8396a16e393d0e9a04c27d0e3ad96a9b498e", "filename": "Cargo.lock", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/f3d07b36ed7609a7826200479d8d472d36f0a995/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/f3d07b36ed7609a7826200479d8d472d36f0a995/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=f3d07b36ed7609a7826200479d8d472d36f0a995", "patch": "@@ -243,6 +243,7 @@ dependencies = [\n  \"anyhow\",\n  \"flate2\",\n  \"hex 0.4.2\",\n+ \"num_cpus\",\n  \"rayon\",\n  \"serde\",\n  \"serde_json\","}, {"sha": "4a2c710811f617e54654edf7761d6e174981209b", "filename": "src/tools/build-manifest/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/f3d07b36ed7609a7826200479d8d472d36f0a995/src%2Ftools%2Fbuild-manifest%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/f3d07b36ed7609a7826200479d8d472d36f0a995/src%2Ftools%2Fbuild-manifest%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fbuild-manifest%2FCargo.toml?ref=f3d07b36ed7609a7826200479d8d472d36f0a995", "patch": "@@ -14,3 +14,4 @@ tar = \"0.4.29\"\n sha2 = \"0.9.1\"\n rayon = \"1.3.1\"\n hex = \"0.4.2\"\n+num_cpus = \"1.13.0\""}, {"sha": "6fda9f4e59f5209290bbbae008b1367c8e73f7d0", "filename": "src/tools/build-manifest/src/main.rs", "status": "modified", "additions": 12, "deletions": 7, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/f3d07b36ed7609a7826200479d8d472d36f0a995/src%2Ftools%2Fbuild-manifest%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f3d07b36ed7609a7826200479d8d472d36f0a995/src%2Ftools%2Fbuild-manifest%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fbuild-manifest%2Fsrc%2Fmain.rs?ref=f3d07b36ed7609a7826200479d8d472d36f0a995", "patch": "@@ -207,13 +207,18 @@ fn main() {\n     // related code in this tool and ./x.py dist hash-and-sign can be removed.\n     let legacy = env::var(\"BUILD_MANIFEST_LEGACY\").is_ok();\n \n-    // Avoid overloading the old server in legacy mode.\n-    if legacy {\n-        rayon::ThreadPoolBuilder::new()\n-            .num_threads(1)\n-            .build_global()\n-            .expect(\"failed to initialize Rayon\");\n-    }\n+    let num_threads = if legacy {\n+        // Avoid overloading the old server in legacy mode.\n+        1\n+    } else if let Ok(num) = env::var(\"BUILD_MANIFEST_NUM_THREADS\") {\n+        num.parse().expect(\"invalid number for BUILD_MANIFEST_NUM_THREADS\")\n+    } else {\n+        num_cpus::get()\n+    };\n+    rayon::ThreadPoolBuilder::new()\n+        .num_threads(num_threads)\n+        .build_global()\n+        .expect(\"failed to initialize Rayon\");\n \n     let mut args = env::args().skip(1);\n     let input = PathBuf::from(args.next().unwrap());"}]}