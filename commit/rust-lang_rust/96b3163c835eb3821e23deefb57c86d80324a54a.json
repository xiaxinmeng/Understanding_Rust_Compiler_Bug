{"sha": "96b3163c835eb3821e23deefb57c86d80324a54a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk2YjMxNjNjODM1ZWIzODIxZTIzZGVlZmI1N2M4NmQ4MDMyNGE1NGE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-07-12T14:43:38Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-07-12T14:43:38Z"}, "message": "auto merge of #7717 : dotdash/rust/transmute, r=pcwalton\n\nCurrently, immediate values are copied into an alloca only to have an\r\naddressable storage so that it can be used with memcpy. Obviously we\r\ncan skip the memcpy in this case.", "tree": {"sha": "be7a8c27009bba0517a8391eac22a2fae0ea41d0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/be7a8c27009bba0517a8391eac22a2fae0ea41d0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/96b3163c835eb3821e23deefb57c86d80324a54a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/96b3163c835eb3821e23deefb57c86d80324a54a", "html_url": "https://github.com/rust-lang/rust/commit/96b3163c835eb3821e23deefb57c86d80324a54a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/96b3163c835eb3821e23deefb57c86d80324a54a/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ad708139fefe4710f002c549ba8bbb11af16f267", "url": "https://api.github.com/repos/rust-lang/rust/commits/ad708139fefe4710f002c549ba8bbb11af16f267", "html_url": "https://github.com/rust-lang/rust/commit/ad708139fefe4710f002c549ba8bbb11af16f267"}, {"sha": "7e972772890ec0d28d2aa4e7ff5c7b004e5463e8", "url": "https://api.github.com/repos/rust-lang/rust/commits/7e972772890ec0d28d2aa4e7ff5c7b004e5463e8", "html_url": "https://github.com/rust-lang/rust/commit/7e972772890ec0d28d2aa4e7ff5c7b004e5463e8"}], "stats": {"total": 25, "additions": 11, "deletions": 14}, "files": [{"sha": "9019cd72ff8a7cd905722eb28dedead30b0609c1", "filename": "src/librustc/middle/trans/foreign.rs", "status": "modified", "additions": 11, "deletions": 14, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/96b3163c835eb3821e23deefb57c86d80324a54a/src%2Flibrustc%2Fmiddle%2Ftrans%2Fforeign.rs", "raw_url": "https://github.com/rust-lang/rust/raw/96b3163c835eb3821e23deefb57c86d80324a54a/src%2Flibrustc%2Fmiddle%2Ftrans%2Fforeign.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fforeign.rs?ref=96b3163c835eb3821e23deefb57c86d80324a54a", "patch": "@@ -725,24 +725,21 @@ pub fn trans_intrinsic(ccx: @mut CrateContext,\n             }\n \n             if !ty::type_is_nil(out_type) {\n-                // NB: Do not use a Load and Store here. This causes massive\n-                // code bloat when `transmute` is used on large structural\n-                // types.\n                 let lldestptr = fcx.llretptr.get();\n-                let lldestptr = PointerCast(bcx, lldestptr, Type::i8p());\n-\n                 let llsrcval = get_param(decl, first_real_arg);\n-                let llsrcptr = if ty::type_is_immediate(ccx.tcx, in_type) {\n-                    let llsrcptr = alloca(bcx, llintype, \"__llsrcptr\");\n-                    Store(bcx, llsrcval, llsrcptr);\n-                    llsrcptr\n+                if ty::type_is_immediate(ccx.tcx, in_type) {\n+                    let lldestptr = PointerCast(bcx, lldestptr, llintype.ptr_to());\n+                    Store(bcx, llsrcval, lldestptr);\n                 } else {\n-                    llsrcval\n+                    // NB: Do not use a Load and Store here. This causes massive\n+                    // code bloat when `transmute` is used on large structural\n+                    // types.\n+                    let lldestptr = PointerCast(bcx, lldestptr, Type::i8p());\n+                    let llsrcptr = PointerCast(bcx, llsrcval, Type::i8p());\n+\n+                    let llsize = llsize_of(ccx, llintype);\n+                    call_memcpy(bcx, lldestptr, llsrcptr, llsize, 1);\n                 };\n-                let llsrcptr = PointerCast(bcx, llsrcptr, Type::i8p());\n-\n-                let llsize = llsize_of(ccx, llintype);\n-                call_memcpy(bcx, lldestptr, llsrcptr, llsize, 1);\n             }\n         }\n         \"needs_drop\" => {"}]}