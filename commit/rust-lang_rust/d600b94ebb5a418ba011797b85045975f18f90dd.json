{"sha": "d600b94ebb5a418ba011797b85045975f18f90dd", "node_id": "C_kwDOAAsO6NoAKGQ2MDBiOTRlYmI1YTQxOGJhMDExNzk3Yjg1MDQ1OTc1ZjE4ZjkwZGQ", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2023-01-24T23:38:20Z"}, "committer": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2023-01-26T03:15:36Z"}, "message": "Implement Generator and Future", "tree": {"sha": "5bb98a4d5386938497a9cc904532a2e4134e6874", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5bb98a4d5386938497a9cc904532a2e4134e6874"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d600b94ebb5a418ba011797b85045975f18f90dd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d600b94ebb5a418ba011797b85045975f18f90dd", "html_url": "https://github.com/rust-lang/rust/commit/d600b94ebb5a418ba011797b85045975f18f90dd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d600b94ebb5a418ba011797b85045975f18f90dd/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8434b43a7f9886a0b0e5f36b115d6c26dde4953d", "url": "https://api.github.com/repos/rust-lang/rust/commits/8434b43a7f9886a0b0e5f36b115d6c26dde4953d", "html_url": "https://github.com/rust-lang/rust/commit/8434b43a7f9886a0b0e5f36b115d6c26dde4953d"}], "stats": {"total": 260, "additions": 259, "deletions": 1}, "files": [{"sha": "baff0f8630ee56ce01fcf2665d8e7626fa3cc283", "filename": "compiler/rustc_trait_selection/src/solve/assembly.rs", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/d600b94ebb5a418ba011797b85045975f18f90dd/compiler%2Frustc_trait_selection%2Fsrc%2Fsolve%2Fassembly.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d600b94ebb5a418ba011797b85045975f18f90dd/compiler%2Frustc_trait_selection%2Fsrc%2Fsolve%2Fassembly.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Fsolve%2Fassembly.rs?ref=d600b94ebb5a418ba011797b85045975f18f90dd", "patch": "@@ -138,6 +138,16 @@ pub(super) trait GoalKind<'tcx>: TypeFoldable<'tcx> + Copy + Eq {\n         ecx: &mut EvalCtxt<'_, 'tcx>,\n         goal: Goal<'tcx, Self>,\n     ) -> QueryResult<'tcx>;\n+\n+    fn consider_builtin_future_candidate(\n+        ecx: &mut EvalCtxt<'_, 'tcx>,\n+        goal: Goal<'tcx, Self>,\n+    ) -> QueryResult<'tcx>;\n+\n+    fn consider_builtin_generator_candidate(\n+        ecx: &mut EvalCtxt<'_, 'tcx>,\n+        goal: Goal<'tcx, Self>,\n+    ) -> QueryResult<'tcx>;\n }\n \n impl<'tcx> EvalCtxt<'_, 'tcx> {\n@@ -266,6 +276,10 @@ impl<'tcx> EvalCtxt<'_, 'tcx> {\n             G::consider_builtin_tuple_candidate(self, goal)\n         } else if lang_items.pointee_trait() == Some(trait_def_id) {\n             G::consider_builtin_pointee_candidate(self, goal)\n+        } else if lang_items.future_trait() == Some(trait_def_id) {\n+            G::consider_builtin_future_candidate(self, goal)\n+        } else if lang_items.gen_trait() == Some(trait_def_id) {\n+            G::consider_builtin_generator_candidate(self, goal)\n         } else {\n             Err(NoSolution)\n         };"}, {"sha": "4a9b95af4a27cbc8f20618c10f8099a5e5367106", "filename": "compiler/rustc_trait_selection/src/solve/project_goals.rs", "status": "modified", "additions": 68, "deletions": 1, "changes": 69, "blob_url": "https://github.com/rust-lang/rust/blob/d600b94ebb5a418ba011797b85045975f18f90dd/compiler%2Frustc_trait_selection%2Fsrc%2Fsolve%2Fproject_goals.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d600b94ebb5a418ba011797b85045975f18f90dd/compiler%2Frustc_trait_selection%2Fsrc%2Fsolve%2Fproject_goals.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Fsolve%2Fproject_goals.rs?ref=d600b94ebb5a418ba011797b85045975f18f90dd", "patch": "@@ -16,7 +16,7 @@ use rustc_middle::ty::fast_reject::{DeepRejectCtxt, TreatParams};\n use rustc_middle::ty::{self, Ty, TyCtxt};\n use rustc_middle::ty::{ProjectionPredicate, TypeSuperVisitable, TypeVisitor};\n use rustc_middle::ty::{ToPredicate, TypeVisitable};\n-use rustc_span::DUMMY_SP;\n+use rustc_span::{sym, DUMMY_SP};\n use std::iter;\n use std::ops::ControlFlow;\n \n@@ -482,6 +482,73 @@ impl<'tcx> assembly::GoalKind<'tcx> for ProjectionPredicate<'tcx> {\n             ecx.evaluate_all_and_make_canonical_response(nested_goals)\n         })\n     }\n+\n+    fn consider_builtin_future_candidate(\n+        ecx: &mut EvalCtxt<'_, 'tcx>,\n+        goal: Goal<'tcx, Self>,\n+    ) -> QueryResult<'tcx> {\n+        let self_ty = goal.predicate.self_ty();\n+        let ty::Generator(def_id, substs, _) = *self_ty.kind() else {\n+            return Err(NoSolution);\n+        };\n+\n+        // Generators are not futures unless they come from `async` desugaring\n+        let tcx = ecx.tcx();\n+        if !tcx.generator_is_async(def_id) {\n+            return Err(NoSolution);\n+        }\n+\n+        let term = substs.as_generator().return_ty().into();\n+\n+        Self::consider_assumption(\n+            ecx,\n+            goal,\n+            ty::Binder::dummy(ty::ProjectionPredicate {\n+                projection_ty: ecx.tcx().mk_alias_ty(goal.predicate.def_id(), [self_ty]),\n+                term,\n+            })\n+            .to_predicate(tcx),\n+        )\n+    }\n+\n+    fn consider_builtin_generator_candidate(\n+        ecx: &mut EvalCtxt<'_, 'tcx>,\n+        goal: Goal<'tcx, Self>,\n+    ) -> QueryResult<'tcx> {\n+        let self_ty = goal.predicate.self_ty();\n+        let ty::Generator(def_id, substs, _) = *self_ty.kind() else {\n+            return Err(NoSolution);\n+        };\n+\n+        // `async`-desugared generators do not implement the generator trait\n+        let tcx = ecx.tcx();\n+        if tcx.generator_is_async(def_id) {\n+            return Err(NoSolution);\n+        }\n+\n+        let generator = substs.as_generator();\n+\n+        let name = tcx.associated_item(goal.predicate.def_id()).name;\n+        let term = if name == sym::Return {\n+            generator.return_ty().into()\n+        } else if name == sym::Yield {\n+            generator.yield_ty().into()\n+        } else {\n+            bug!(\"unexpected associated item `<{self_ty} as Generator>::{name}`\")\n+        };\n+\n+        Self::consider_assumption(\n+            ecx,\n+            goal,\n+            ty::Binder::dummy(ty::ProjectionPredicate {\n+                projection_ty: ecx\n+                    .tcx()\n+                    .mk_alias_ty(goal.predicate.def_id(), [self_ty, generator.resume_ty()]),\n+                term,\n+            })\n+            .to_predicate(tcx),\n+        )\n+    }\n }\n \n /// This behavior is also implemented in `rustc_ty_utils` and in the old `project` code."}, {"sha": "d74857dc4b4803bac6b418941d6e9122dd1fae3b", "filename": "compiler/rustc_trait_selection/src/solve/trait_goals.rs", "status": "modified", "additions": 44, "deletions": 0, "changes": 44, "blob_url": "https://github.com/rust-lang/rust/blob/d600b94ebb5a418ba011797b85045975f18f90dd/compiler%2Frustc_trait_selection%2Fsrc%2Fsolve%2Ftrait_goals.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d600b94ebb5a418ba011797b85045975f18f90dd/compiler%2Frustc_trait_selection%2Fsrc%2Fsolve%2Ftrait_goals.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Fsolve%2Ftrait_goals.rs?ref=d600b94ebb5a418ba011797b85045975f18f90dd", "patch": "@@ -192,6 +192,50 @@ impl<'tcx> assembly::GoalKind<'tcx> for TraitPredicate<'tcx> {\n     ) -> QueryResult<'tcx> {\n         ecx.make_canonical_response(Certainty::Yes)\n     }\n+\n+    fn consider_builtin_future_candidate(\n+        ecx: &mut EvalCtxt<'_, 'tcx>,\n+        goal: Goal<'tcx, Self>,\n+    ) -> QueryResult<'tcx> {\n+        let ty::Generator(def_id, _, _) = *goal.predicate.self_ty().kind() else {\n+            return Err(NoSolution);\n+        };\n+\n+        // Generators are not futures unless they come from `async` desugaring\n+        let tcx = ecx.tcx();\n+        if !tcx.generator_is_async(def_id) {\n+            return Err(NoSolution);\n+        }\n+\n+        // Async generator unconditionally implement `Future`\n+        ecx.make_canonical_response(Certainty::Yes)\n+    }\n+\n+    fn consider_builtin_generator_candidate(\n+        ecx: &mut EvalCtxt<'_, 'tcx>,\n+        goal: Goal<'tcx, Self>,\n+    ) -> QueryResult<'tcx> {\n+        let self_ty = goal.predicate.self_ty();\n+        let ty::Generator(def_id, substs, _) = *self_ty.kind() else {\n+            return Err(NoSolution);\n+        };\n+\n+        // `async`-desugared generators do not implement the generator trait\n+        let tcx = ecx.tcx();\n+        if tcx.generator_is_async(def_id) {\n+            return Err(NoSolution);\n+        }\n+\n+        let generator = substs.as_generator();\n+        Self::consider_assumption(\n+            ecx,\n+            goal,\n+            ty::Binder::dummy(\n+                tcx.mk_trait_ref(goal.predicate.def_id(), [self_ty, generator.resume_ty()]),\n+            )\n+            .to_predicate(tcx),\n+        )\n+    }\n }\n \n impl<'tcx> EvalCtxt<'_, 'tcx> {"}, {"sha": "162953180c75ce09717fb2c071edec930acac33f", "filename": "compiler/rustc_trait_selection/src/solve/trait_goals/structural_traits.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d600b94ebb5a418ba011797b85045975f18f90dd/compiler%2Frustc_trait_selection%2Fsrc%2Fsolve%2Ftrait_goals%2Fstructural_traits.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d600b94ebb5a418ba011797b85045975f18f90dd/compiler%2Frustc_trait_selection%2Fsrc%2Fsolve%2Ftrait_goals%2Fstructural_traits.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Fsolve%2Ftrait_goals%2Fstructural_traits.rs?ref=d600b94ebb5a418ba011797b85045975f18f90dd", "patch": "@@ -173,6 +173,7 @@ pub(super) fn instantiate_constituent_tys_for_copy_clone_trait<'tcx>(\n     }\n }\n \n+// Returns a binder of the tupled inputs types and output type from a builtin callable type.\n pub(crate) fn extract_tupled_inputs_and_output_from_callable<'tcx>(\n     tcx: TyCtxt<'tcx>,\n     self_ty: Ty<'tcx>,"}, {"sha": "b395c23ae00572d7ee65a74ecfa71fe6a3dceb8a", "filename": "tests/ui/traits/new-solver/async.fail.stderr", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/d600b94ebb5a418ba011797b85045975f18f90dd/tests%2Fui%2Ftraits%2Fnew-solver%2Fasync.fail.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d600b94ebb5a418ba011797b85045975f18f90dd/tests%2Fui%2Ftraits%2Fnew-solver%2Fasync.fail.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ftraits%2Fnew-solver%2Fasync.fail.stderr?ref=d600b94ebb5a418ba011797b85045975f18f90dd", "patch": "@@ -0,0 +1,17 @@\n+error[E0271]: expected `[async block@$DIR/async.rs:12:17: 12:25]` to be a future that resolves to `i32`, but it resolves to `()`\n+  --> $DIR/async.rs:12:17\n+   |\n+LL |     needs_async(async {});\n+   |     ----------- ^^^^^^^^ expected `i32`, found `()`\n+   |     |\n+   |     required by a bound introduced by this call\n+   |\n+note: required by a bound in `needs_async`\n+  --> $DIR/async.rs:8:31\n+   |\n+LL | fn needs_async(_: impl Future<Output = i32>) {}\n+   |                               ^^^^^^^^^^^^ required by this bound in `needs_async`\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0271`."}, {"sha": "195cc35cad2adb9be9f383868b59066c1a9eee3c", "filename": "tests/ui/traits/new-solver/async.rs", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/d600b94ebb5a418ba011797b85045975f18f90dd/tests%2Fui%2Ftraits%2Fnew-solver%2Fasync.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d600b94ebb5a418ba011797b85045975f18f90dd/tests%2Fui%2Ftraits%2Fnew-solver%2Fasync.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ftraits%2Fnew-solver%2Fasync.rs?ref=d600b94ebb5a418ba011797b85045975f18f90dd", "patch": "@@ -0,0 +1,19 @@\n+// compile-flags: -Ztrait-solver=next\n+// edition: 2021\n+// revisions: pass fail\n+//[pass] check-pass\n+\n+use std::future::Future;\n+\n+fn needs_async(_: impl Future<Output = i32>) {}\n+\n+#[cfg(fail)]\n+fn main() {\n+    needs_async(async {});\n+    //[fail]~^ ERROR to be a future that resolves to `i32`, but it resolves to `()`\n+}\n+\n+#[cfg(pass)]\n+fn main() {\n+    needs_async(async { 1i32 });\n+}"}, {"sha": "d94d41e3587b6572162e2122fc22c7fb4222eb0b", "filename": "tests/ui/traits/new-solver/generator.fail.stderr", "status": "added", "additions": 64, "deletions": 0, "changes": 64, "blob_url": "https://github.com/rust-lang/rust/blob/d600b94ebb5a418ba011797b85045975f18f90dd/tests%2Fui%2Ftraits%2Fnew-solver%2Fgenerator.fail.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d600b94ebb5a418ba011797b85045975f18f90dd/tests%2Fui%2Ftraits%2Fnew-solver%2Fgenerator.fail.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ftraits%2Fnew-solver%2Fgenerator.fail.stderr?ref=d600b94ebb5a418ba011797b85045975f18f90dd", "patch": "@@ -0,0 +1,64 @@\n+error[E0277]: the trait bound `[generator@$DIR/generator.rs:18:21: 18:23]: Generator<A>` is not satisfied\n+  --> $DIR/generator.rs:18:21\n+   |\n+LL |       needs_generator(|| {\n+   |  _____---------------_^\n+   | |     |\n+   | |     required by a bound introduced by this call\n+LL | |\n+LL | |\n+LL | |\n+LL | |         yield ();\n+LL | |     });\n+   | |_____^ the trait `Generator<A>` is not implemented for `[generator@$DIR/generator.rs:18:21: 18:23]`\n+   |\n+note: required by a bound in `needs_generator`\n+  --> $DIR/generator.rs:14:28\n+   |\n+LL | fn needs_generator(_: impl Generator<A, Yield = B, Return = C>) {}\n+   |                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ required by this bound in `needs_generator`\n+\n+error[E0271]: type mismatch resolving `<[generator@$DIR/generator.rs:18:21: 18:23] as Generator<A>>::Yield == B`\n+  --> $DIR/generator.rs:18:21\n+   |\n+LL |       needs_generator(|| {\n+   |  _____---------------_^\n+   | |     |\n+   | |     required by a bound introduced by this call\n+LL | |\n+LL | |\n+LL | |\n+LL | |         yield ();\n+LL | |     });\n+   | |_____^ types differ\n+   |\n+note: required by a bound in `needs_generator`\n+  --> $DIR/generator.rs:14:41\n+   |\n+LL | fn needs_generator(_: impl Generator<A, Yield = B, Return = C>) {}\n+   |                                         ^^^^^^^^^ required by this bound in `needs_generator`\n+\n+error[E0271]: type mismatch resolving `<[generator@$DIR/generator.rs:18:21: 18:23] as Generator<A>>::Return == C`\n+  --> $DIR/generator.rs:18:21\n+   |\n+LL |       needs_generator(|| {\n+   |  _____---------------_^\n+   | |     |\n+   | |     required by a bound introduced by this call\n+LL | |\n+LL | |\n+LL | |\n+LL | |         yield ();\n+LL | |     });\n+   | |_____^ types differ\n+   |\n+note: required by a bound in `needs_generator`\n+  --> $DIR/generator.rs:14:52\n+   |\n+LL | fn needs_generator(_: impl Generator<A, Yield = B, Return = C>) {}\n+   |                                                    ^^^^^^^^^^ required by this bound in `needs_generator`\n+\n+error: aborting due to 3 previous errors\n+\n+Some errors have detailed explanations: E0271, E0277.\n+For more information about an error, try `rustc --explain E0271`."}, {"sha": "364373ca8be7172f35bade6e744e586c96258d1a", "filename": "tests/ui/traits/new-solver/generator.rs", "status": "added", "additions": 32, "deletions": 0, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/d600b94ebb5a418ba011797b85045975f18f90dd/tests%2Fui%2Ftraits%2Fnew-solver%2Fgenerator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d600b94ebb5a418ba011797b85045975f18f90dd/tests%2Fui%2Ftraits%2Fnew-solver%2Fgenerator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ftraits%2Fnew-solver%2Fgenerator.rs?ref=d600b94ebb5a418ba011797b85045975f18f90dd", "patch": "@@ -0,0 +1,32 @@\n+// compile-flags: -Ztrait-solver=next\n+// edition: 2021\n+// revisions: pass fail\n+//[pass] check-pass\n+\n+#![feature(generator_trait, generators)]\n+\n+use std::ops::Generator;\n+\n+struct A;\n+struct B;\n+struct C;\n+\n+fn needs_generator(_: impl Generator<A, Yield = B, Return = C>) {}\n+\n+#[cfg(fail)]\n+fn main() {\n+    needs_generator(|| {\n+        //[fail]~^ ERROR Generator<A>` is not satisfied\n+        //[fail]~| ERROR as Generator<A>>::Yield == B`\n+        //[fail]~| ERROR as Generator<A>>::Return == C`\n+        yield ();\n+    });\n+}\n+\n+#[cfg(pass)]\n+fn main() {\n+    needs_generator(|_: A| {\n+        let _: A = yield B;\n+        C\n+    })\n+}"}]}