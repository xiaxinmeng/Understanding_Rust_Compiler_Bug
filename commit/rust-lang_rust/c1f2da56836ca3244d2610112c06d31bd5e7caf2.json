{"sha": "c1f2da56836ca3244d2610112c06d31bd5e7caf2", "node_id": "C_kwDOAAsO6NoAKGMxZjJkYTU2ODM2Y2EzMjQ0ZDI2MTAxMTJjMDZkMzFiZDVlN2NhZjI", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-06-11T16:38:29Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-06-11T16:38:29Z"}, "message": "Rollup merge of #112528 - jyn514:fix-debuginfo-level, r=Mark-Simulacrum\n\nbootstrap: Don't override `debuginfo-level = 1` to mean `line-tables-only`\n\nThis has real differences in the effective debuginfo: in particular, it omits the module-level information and makes perf less useful (it can't distinguish \"self\" from \"child\" time anymore).\n\nAllow passing `line-tables-only` directly in config.toml instead.\n\nSee https://rust-lang.zulipchat.com/#narrow/stream/131828-t-compiler/topic/debuginfo.20in.20try.20builds/near/365090631 and https://rust-lang.zulipchat.com/#narrow/stream/238009-t-compiler.2Fmeetings/topic/.5Bsteering.5D.202023-06-09/near/364883519 for more discussion. This effectively reverts the cargo half of https://github.com/rust-lang/rust/pull/110221 to avoid regressing https://github.com/rust-lang/rust/issues/60020 again in 1.72.", "tree": {"sha": "e463a6e2e8a296d7fb8718c01ac1d6e7a4fc333b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e463a6e2e8a296d7fb8718c01ac1d6e7a4fc333b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c1f2da56836ca3244d2610112c06d31bd5e7caf2", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkhfiFCRBK7hj4Ov3rIwAA5F4IADmesXqOmtQ1AQx3JQV9ApEB\nW8cFygZ7UL+bkiftneT5pS5xLN7Nt19nhxxuuEUXFFm8FApNzNZptBIAbmr9JnQm\nuSItI2R0OxJBVM8t0VTAixxccUAqgP3ZyQM/vgVlCQLwIYQNpG+OI3bGffx8wzzw\n/d8pPzaqcYh3uteZkfsz0kDv2ZFDOiGUuvZr4qu25ZJY+dbgZm3Ppr7pRYhSkF1e\nU5W9oqNuvgYpF/kDtMT9P6/ed476ZcgGPQ2Zi8h6LrQDH/j6CbdtnbcIn3ryCtUa\nkvHPV258yUjDXz739UCip5r0Jw+t3Q7mxe7OFPRsOl6grwde5zGkWTqBV0PC0VQ=\n=Zfey\n-----END PGP SIGNATURE-----\n", "payload": "tree e463a6e2e8a296d7fb8718c01ac1d6e7a4fc333b\nparent d9ae7180e49321d4784001d28d5b5a7290b05a4b\nparent 123693953f6fb4063f95bd59b288aea8375c3c34\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1686501509 +0200\ncommitter GitHub <noreply@github.com> 1686501509 +0200\n\nRollup merge of #112528 - jyn514:fix-debuginfo-level, r=Mark-Simulacrum\n\nbootstrap: Don't override `debuginfo-level = 1` to mean `line-tables-only`\n\nThis has real differences in the effective debuginfo: in particular, it omits the module-level information and makes perf less useful (it can't distinguish \"self\" from \"child\" time anymore).\n\nAllow passing `line-tables-only` directly in config.toml instead.\n\nSee https://rust-lang.zulipchat.com/#narrow/stream/131828-t-compiler/topic/debuginfo.20in.20try.20builds/near/365090631 and https://rust-lang.zulipchat.com/#narrow/stream/238009-t-compiler.2Fmeetings/topic/.5Bsteering.5D.202023-06-09/near/364883519 for more discussion. This effectively reverts the cargo half of https://github.com/rust-lang/rust/pull/110221 to avoid regressing https://github.com/rust-lang/rust/issues/60020 again in 1.72.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c1f2da56836ca3244d2610112c06d31bd5e7caf2", "html_url": "https://github.com/rust-lang/rust/commit/c1f2da56836ca3244d2610112c06d31bd5e7caf2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c1f2da56836ca3244d2610112c06d31bd5e7caf2/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d9ae7180e49321d4784001d28d5b5a7290b05a4b", "url": "https://api.github.com/repos/rust-lang/rust/commits/d9ae7180e49321d4784001d28d5b5a7290b05a4b", "html_url": "https://github.com/rust-lang/rust/commit/d9ae7180e49321d4784001d28d5b5a7290b05a4b"}, {"sha": "123693953f6fb4063f95bd59b288aea8375c3c34", "url": "https://api.github.com/repos/rust-lang/rust/commits/123693953f6fb4063f95bd59b288aea8375c3c34", "html_url": "https://github.com/rust-lang/rust/commit/123693953f6fb4063f95bd59b288aea8375c3c34"}], "stats": {"total": 93, "additions": 73, "deletions": 20}, "files": [{"sha": "51d94c48f7ffb7fe8f6f1ddcd68cfbb037ac7fb0", "filename": "src/bootstrap/builder.rs", "status": "modified", "additions": 1, "deletions": 6, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/c1f2da56836ca3244d2610112c06d31bd5e7caf2/src%2Fbootstrap%2Fbuilder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c1f2da56836ca3244d2610112c06d31bd5e7caf2/src%2Fbootstrap%2Fbuilder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuilder.rs?ref=c1f2da56836ca3244d2610112c06d31bd5e7caf2", "patch": "@@ -1649,12 +1649,7 @@ impl<'a> Builder<'a> {\n                 self.config.rust_debuginfo_level_tools\n             }\n         };\n-        if debuginfo_level == 1 {\n-            // Use less debuginfo than the default to save on disk space.\n-            cargo.env(profile_var(\"DEBUG\"), \"line-tables-only\");\n-        } else {\n-            cargo.env(profile_var(\"DEBUG\"), debuginfo_level.to_string());\n-        };\n+        cargo.env(profile_var(\"DEBUG\"), debuginfo_level.to_string());\n         if self.cc[&target].args().iter().any(|arg| arg == \"-gz\") {\n             rustflags.arg(\"-Clink-arg=-gz\");\n         }"}, {"sha": "b521ad75d63a1fb8172e92803dd193f8cb99f3b6", "filename": "src/bootstrap/config.rs", "status": "modified", "additions": 72, "deletions": 14, "changes": 86, "blob_url": "https://github.com/rust-lang/rust/blob/c1f2da56836ca3244d2610112c06d31bd5e7caf2/src%2Fbootstrap%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c1f2da56836ca3244d2610112c06d31bd5e7caf2/src%2Fbootstrap%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fconfig.rs?ref=c1f2da56836ca3244d2610112c06d31bd5e7caf2", "patch": "@@ -10,7 +10,7 @@ use std::cell::{Cell, RefCell};\n use std::cmp;\n use std::collections::{HashMap, HashSet};\n use std::env;\n-use std::fmt;\n+use std::fmt::{self, Display};\n use std::fs;\n use std::io::IsTerminal;\n use std::path::{Path, PathBuf};\n@@ -50,6 +50,57 @@ pub enum DryRun {\n     UserSelected,\n }\n \n+#[derive(Copy, Clone, Default)]\n+pub enum DebuginfoLevel {\n+    #[default]\n+    None,\n+    LineTablesOnly,\n+    Limited,\n+    Full,\n+}\n+\n+// NOTE: can't derive(Deserialize) because the intermediate trip through toml::Value only\n+// deserializes i64, and derive() only generates visit_u64\n+impl<'de> Deserialize<'de> for DebuginfoLevel {\n+    fn deserialize<D>(deserializer: D) -> Result<Self, D::Error>\n+    where\n+        D: Deserializer<'de>,\n+    {\n+        use serde::de::Error;\n+\n+        Ok(match Deserialize::deserialize(deserializer)? {\n+            StringOrInt::String(\"none\") | StringOrInt::Int(0) => DebuginfoLevel::None,\n+            StringOrInt::String(\"line-tables-only\") => DebuginfoLevel::LineTablesOnly,\n+            StringOrInt::String(\"limited\") | StringOrInt::Int(1) => DebuginfoLevel::Limited,\n+            StringOrInt::String(\"full\") | StringOrInt::Int(2) => DebuginfoLevel::Full,\n+            StringOrInt::Int(n) => {\n+                let other = serde::de::Unexpected::Signed(n);\n+                return Err(D::Error::invalid_value(other, &\"expected 0, 1, or 2\"));\n+            }\n+            StringOrInt::String(s) => {\n+                let other = serde::de::Unexpected::Str(s);\n+                return Err(D::Error::invalid_value(\n+                    other,\n+                    &\"expected none, line-tables-only, limited, or full\",\n+                ));\n+            }\n+        })\n+    }\n+}\n+\n+/// Suitable for passing to `-C debuginfo`\n+impl Display for DebuginfoLevel {\n+    fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {\n+        use DebuginfoLevel::*;\n+        f.write_str(match self {\n+            None => \"0\",\n+            LineTablesOnly => \"line-tables-only\",\n+            Limited => \"1\",\n+            Full => \"2\",\n+        })\n+    }\n+}\n+\n /// Global configuration for the entire build and/or bootstrap.\n ///\n /// This structure is parsed from `config.toml`, and some of the fields are inferred from `git` or build-time parameters.\n@@ -159,10 +210,10 @@ pub struct Config {\n     pub rust_overflow_checks: bool,\n     pub rust_overflow_checks_std: bool,\n     pub rust_debug_logging: bool,\n-    pub rust_debuginfo_level_rustc: u32,\n-    pub rust_debuginfo_level_std: u32,\n-    pub rust_debuginfo_level_tools: u32,\n-    pub rust_debuginfo_level_tests: u32,\n+    pub rust_debuginfo_level_rustc: DebuginfoLevel,\n+    pub rust_debuginfo_level_std: DebuginfoLevel,\n+    pub rust_debuginfo_level_tools: DebuginfoLevel,\n+    pub rust_debuginfo_level_tests: DebuginfoLevel,\n     pub rust_split_debuginfo: SplitDebuginfo,\n     pub rust_rpath: bool,\n     pub rustc_parallel: bool,\n@@ -810,6 +861,13 @@ impl Default for StringOrBool {\n     }\n }\n \n+#[derive(Deserialize)]\n+#[serde(untagged)]\n+enum StringOrInt<'a> {\n+    String(&'a str),\n+    Int(i64),\n+}\n+\n define_config! {\n     /// TOML representation of how the Rust build is configured.\n     struct Rust {\n@@ -822,11 +880,11 @@ define_config! {\n         overflow_checks: Option<bool> = \"overflow-checks\",\n         overflow_checks_std: Option<bool> = \"overflow-checks-std\",\n         debug_logging: Option<bool> = \"debug-logging\",\n-        debuginfo_level: Option<u32> = \"debuginfo-level\",\n-        debuginfo_level_rustc: Option<u32> = \"debuginfo-level-rustc\",\n-        debuginfo_level_std: Option<u32> = \"debuginfo-level-std\",\n-        debuginfo_level_tools: Option<u32> = \"debuginfo-level-tools\",\n-        debuginfo_level_tests: Option<u32> = \"debuginfo-level-tests\",\n+        debuginfo_level: Option<DebuginfoLevel> = \"debuginfo-level\",\n+        debuginfo_level_rustc: Option<DebuginfoLevel> = \"debuginfo-level-rustc\",\n+        debuginfo_level_std: Option<DebuginfoLevel> = \"debuginfo-level-std\",\n+        debuginfo_level_tools: Option<DebuginfoLevel> = \"debuginfo-level-tools\",\n+        debuginfo_level_tests: Option<DebuginfoLevel> = \"debuginfo-level-tests\",\n         split_debuginfo: Option<String> = \"split-debuginfo\",\n         run_dsymutil: Option<bool> = \"run-dsymutil\",\n         backtrace: Option<bool> = \"backtrace\",\n@@ -1478,17 +1536,17 @@ impl Config {\n \n         config.rust_debug_logging = debug_logging.unwrap_or(config.rust_debug_assertions);\n \n-        let with_defaults = |debuginfo_level_specific: Option<u32>| {\n+        let with_defaults = |debuginfo_level_specific: Option<_>| {\n             debuginfo_level_specific.or(debuginfo_level).unwrap_or(if debug == Some(true) {\n-                1\n+                DebuginfoLevel::Limited\n             } else {\n-                0\n+                DebuginfoLevel::None\n             })\n         };\n         config.rust_debuginfo_level_rustc = with_defaults(debuginfo_level_rustc);\n         config.rust_debuginfo_level_std = with_defaults(debuginfo_level_std);\n         config.rust_debuginfo_level_tools = with_defaults(debuginfo_level_tools);\n-        config.rust_debuginfo_level_tests = debuginfo_level_tests.unwrap_or(0);\n+        config.rust_debuginfo_level_tests = debuginfo_level_tests.unwrap_or(DebuginfoLevel::None);\n \n         let download_rustc = config.download_rustc_commit.is_some();\n         // See https://github.com/rust-lang/compiler-team/issues/326"}]}