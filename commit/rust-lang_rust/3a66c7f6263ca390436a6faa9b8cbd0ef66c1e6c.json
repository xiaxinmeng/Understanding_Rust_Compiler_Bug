{"sha": "3a66c7f6263ca390436a6faa9b8cbd0ef66c1e6c", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNhNjZjN2Y2MjYzY2EzOTA0MzZhNmZhYTliOGNiZDBlZjY2YzFlNmM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-04-08T07:02:06Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-04-08T07:02:06Z"}, "message": "Auto merge of #24120 - aturon:range-perf, r=alexcrichton\n\nA recent change to the implementation of range iterators meant that,\r\neven when stepping by 1, the iterators *always* involved checked\r\narithmetic.\r\n\r\nThis commit reverts to the earlier behavior (while retaining the\r\nrefactoring into traits).\r\n\r\nFixes #24095\r\nCloses #24119\r\ncc #24014 \r\n\r\nr? @alexcrichton", "tree": {"sha": "c3c2216279b3168c5aaf504e14fb8c26ddcf71c0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c3c2216279b3168c5aaf504e14fb8c26ddcf71c0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3a66c7f6263ca390436a6faa9b8cbd0ef66c1e6c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3a66c7f6263ca390436a6faa9b8cbd0ef66c1e6c", "html_url": "https://github.com/rust-lang/rust/commit/3a66c7f6263ca390436a6faa9b8cbd0ef66c1e6c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3a66c7f6263ca390436a6faa9b8cbd0ef66c1e6c/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ce97c197c2ba3f89818721728cff219258497a69", "url": "https://api.github.com/repos/rust-lang/rust/commits/ce97c197c2ba3f89818721728cff219258497a69", "html_url": "https://github.com/rust-lang/rust/commit/ce97c197c2ba3f89818721728cff219258497a69"}, {"sha": "dddcbcfeac13c1cf0a262e7d57e14d6588dcadc2", "url": "https://api.github.com/repos/rust-lang/rust/commits/dddcbcfeac13c1cf0a262e7d57e14d6588dcadc2", "html_url": "https://github.com/rust-lang/rust/commit/dddcbcfeac13c1cf0a262e7d57e14d6588dcadc2"}], "stats": {"total": 48, "additions": 24, "deletions": 24}, "files": [{"sha": "ffe49a25a0d2f5002d63c012c25bd1187f3a3e28", "filename": "src/libcore/iter.rs", "status": "modified", "additions": 23, "deletions": 24, "changes": 47, "blob_url": "https://github.com/rust-lang/rust/blob/3a66c7f6263ca390436a6faa9b8cbd0ef66c1e6c/src%2Flibcore%2Fiter.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3a66c7f6263ca390436a6faa9b8cbd0ef66c1e6c/src%2Flibcore%2Fiter.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fiter.rs?ref=3a66c7f6263ca390436a6faa9b8cbd0ef66c1e6c", "patch": "@@ -60,7 +60,7 @@ use self::MinMaxResult::*;\n \n use clone::Clone;\n use cmp;\n-use cmp::Ord;\n+use cmp::{Ord, PartialOrd, PartialEq};\n use default::Default;\n use marker;\n use mem;\n@@ -2382,7 +2382,7 @@ impl<A, St, F> Iterator for Unfold<St, F> where F: FnMut(&mut St) -> Option<A> {\n /// two `Step` objects.\n #[unstable(feature = \"step_trait\",\n            reason = \"likely to be replaced by finer-grained traits\")]\n-pub trait Step: Ord {\n+pub trait Step: PartialOrd {\n     /// Steps `self` if possible.\n     fn step(&self, by: &Self) -> Option<Self>;\n \n@@ -2549,7 +2549,10 @@ pub fn range_inclusive<A>(start: A, stop: A) -> RangeInclusive<A>\n \n #[unstable(feature = \"core\",\n            reason = \"likely to be replaced by range notation and adapters\")]\n-impl<A: Step + One + Clone> Iterator for RangeInclusive<A> {\n+impl<A> Iterator for RangeInclusive<A> where\n+    A: PartialEq + Step + One + Clone,\n+    for<'a> &'a A: Add<&'a A, Output = A>\n+{\n     type Item = A;\n \n     #[inline]\n@@ -2579,9 +2582,10 @@ impl<A: Step + One + Clone> Iterator for RangeInclusive<A> {\n \n #[unstable(feature = \"core\",\n            reason = \"likely to be replaced by range notation and adapters\")]\n-impl<A> DoubleEndedIterator for RangeInclusive<A>\n-    where A: Step + One + Clone,\n-          for<'a> &'a A: Sub<Output=A>\n+impl<A> DoubleEndedIterator for RangeInclusive<A> where\n+    A: PartialEq + Step + One + Clone,\n+    for<'a> &'a A: Add<&'a A, Output = A>,\n+    for<'a> &'a A: Sub<Output=A>\n {\n     #[inline]\n     fn next_back(&mut self) -> Option<A> {\n@@ -2709,24 +2713,17 @@ macro_rules! range_exact_iter_impl {\n \n #[stable(feature = \"rust1\", since = \"1.0.0\")]\n #[allow(deprecated)]\n-impl<A: Step + One + Clone> Iterator for ops::Range<A> {\n+impl<A: Step + One> Iterator for ops::Range<A> where\n+    for<'a> &'a A: Add<&'a A, Output = A>\n+{\n     type Item = A;\n \n     #[inline]\n     fn next(&mut self) -> Option<A> {\n         if self.start < self.end {\n-            match self.start.step(&A::one()) {\n-                Some(mut n) => {\n-                    mem::swap(&mut n, &mut self.start);\n-                    Some(n)\n-                },\n-                None => {\n-                    let mut n = self.end.clone();\n-                    mem::swap(&mut n, &mut self.start);\n-                    Some(n)\n-\n-                }\n-            }\n+            let mut n = &self.start + &A::one();\n+            mem::swap(&mut n, &mut self.start);\n+            Some(n)\n         } else {\n             None\n         }\n@@ -2748,6 +2745,7 @@ range_exact_iter_impl!(usize u8 u16 u32 isize i8 i16 i32);\n #[stable(feature = \"rust1\", since = \"1.0.0\")]\n #[allow(deprecated)]\n impl<A: Step + One + Clone> DoubleEndedIterator for ops::Range<A> where\n+    for<'a> &'a A: Add<&'a A, Output = A>,\n     for<'a> &'a A: Sub<&'a A, Output = A>\n {\n     #[inline]\n@@ -2763,15 +2761,16 @@ impl<A: Step + One + Clone> DoubleEndedIterator for ops::Range<A> where\n \n #[stable(feature = \"rust1\", since = \"1.0.0\")]\n #[allow(deprecated)]\n-impl<A: Step + One> Iterator for ops::RangeFrom<A> {\n+impl<A: Step + One> Iterator for ops::RangeFrom<A> where\n+    for<'a> &'a A: Add<&'a A, Output = A>\n+{\n     type Item = A;\n \n     #[inline]\n     fn next(&mut self) -> Option<A> {\n-        self.start.step(&A::one()).map(|mut n| {\n-            mem::swap(&mut n, &mut self.start);\n-            n\n-        })\n+        let mut n = &self.start + &A::one();\n+        mem::swap(&mut n, &mut self.start);\n+        Some(n)\n     }\n }\n "}, {"sha": "826e4283ef82748fb400c0b2208ed75f67e5c9a8", "filename": "src/test/compile-fail/range-1.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/3a66c7f6263ca390436a6faa9b8cbd0ef66c1e6c/src%2Ftest%2Fcompile-fail%2Frange-1.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3a66c7f6263ca390436a6faa9b8cbd0ef66c1e6c/src%2Ftest%2Fcompile-fail%2Frange-1.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Frange-1.rs?ref=3a66c7f6263ca390436a6faa9b8cbd0ef66c1e6c", "patch": "@@ -19,6 +19,7 @@ pub fn main() {\n     for i in false..true {}\n     //~^ ERROR the trait\n     //~^^ ERROR the trait\n+    //~^^^ ERROR the trait\n \n     // Unsized type.\n     let arr: &[_] = &[1, 2, 3];"}]}