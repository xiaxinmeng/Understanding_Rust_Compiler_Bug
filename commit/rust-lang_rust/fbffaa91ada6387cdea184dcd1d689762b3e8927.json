{"sha": "fbffaa91ada6387cdea184dcd1d689762b3e8927", "node_id": "C_kwDOAAsO6NoAKGZiZmZhYTkxYWRhNjM4N2NkZWExODRkY2QxZDY4OTc2MmIzZTg5Mjc", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2023-01-02T23:39:17Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-01-02T23:39:17Z"}, "message": "Rollup merge of #105558 - Nilstrieb:less-spam-hir-tree, r=cjgillot\n\nReduce HIR debug output\n\nHIR debug output is currently very verbose, especially when used with the alternate (`#`) flag. This commit reduces the amount of noisy newlines by forcing a few small key types to stay on one line, which makes the output easier to read and scroll by.\n\n```\n$ rustc +after hello_world.rs -Zunpretty=hir-tree | wc -l\n582\n$ rustc +before hello_world.rs -Zunpretty=hir-tree | wc -l\n932\n```", "tree": {"sha": "432d143db3380e5afd9407effa2158987b01a6b9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/432d143db3380e5afd9407effa2158987b01a6b9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fbffaa91ada6387cdea184dcd1d689762b3e8927", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjs2slCRBK7hj4Ov3rIwAAQFYIAK+RIARd18ode8WkIApvLlNz\nDeLumKoqRKSs7s5FxgfLG3h0+MR0AtTwaSvXyebjWROT4kiHtVEDLllJs8A+P8+8\nT0XSbRXJd7ntao7Kb6RtKrjJXkJOueJVGjKDVfBKMeYW313LEnSRbXMJK2k7+8i+\nx2lLw6ktPJKI9F9ynVzZQRvoYE13d8cslkWLyVp7M3QX3VAKQQAfDL/7ClZYeYVo\n51o3UlMA8/ndGSQCEOHnViBBTXEGmd7HDr5ifozrK0rR5lI1X7Bo0HFcnHv6vfs4\n1RvcovmvoCqmUO4ldkYCO8UsTlQo1TjSvuM6eM2F0szycpB8yx6J6YYWFTkjkSE=\n=J+8g\n-----END PGP SIGNATURE-----\n", "payload": "tree 432d143db3380e5afd9407effa2158987b01a6b9\nparent da1ca5df6e0ce759d409ce853d836cb00542c44f\nparent e1787f557223245375571550000eb6441de17b6e\nauthor Michael Goulet <michael@errs.io> 1672702757 -0800\ncommitter GitHub <noreply@github.com> 1672702757 -0800\n\nRollup merge of #105558 - Nilstrieb:less-spam-hir-tree, r=cjgillot\n\nReduce HIR debug output\n\nHIR debug output is currently very verbose, especially when used with the alternate (`#`) flag. This commit reduces the amount of noisy newlines by forcing a few small key types to stay on one line, which makes the output easier to read and scroll by.\n\n```\n$ rustc +after hello_world.rs -Zunpretty=hir-tree | wc -l\n582\n$ rustc +before hello_world.rs -Zunpretty=hir-tree | wc -l\n932\n```\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fbffaa91ada6387cdea184dcd1d689762b3e8927", "html_url": "https://github.com/rust-lang/rust/commit/fbffaa91ada6387cdea184dcd1d689762b3e8927", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fbffaa91ada6387cdea184dcd1d689762b3e8927/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "da1ca5df6e0ce759d409ce853d836cb00542c44f", "url": "https://api.github.com/repos/rust-lang/rust/commits/da1ca5df6e0ce759d409ce853d836cb00542c44f", "html_url": "https://github.com/rust-lang/rust/commit/da1ca5df6e0ce759d409ce853d836cb00542c44f"}, {"sha": "e1787f557223245375571550000eb6441de17b6e", "url": "https://api.github.com/repos/rust-lang/rust/commits/e1787f557223245375571550000eb6441de17b6e", "html_url": "https://github.com/rust-lang/rust/commit/e1787f557223245375571550000eb6441de17b6e"}], "stats": {"total": 53, "additions": 42, "deletions": 11}, "files": [{"sha": "c63caa06818f26e2f3f263d778c140ae5fc588aa", "filename": "compiler/rustc_data_structures/src/sorted_map.rs", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/fbffaa91ada6387cdea184dcd1d689762b3e8927/compiler%2Frustc_data_structures%2Fsrc%2Fsorted_map.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fbffaa91ada6387cdea184dcd1d689762b3e8927/compiler%2Frustc_data_structures%2Fsrc%2Fsorted_map.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_data_structures%2Fsrc%2Fsorted_map.rs?ref=fbffaa91ada6387cdea184dcd1d689762b3e8927", "patch": "@@ -1,6 +1,7 @@\n use crate::stable_hasher::{HashStable, StableHasher, StableOrd};\n use std::borrow::Borrow;\n use std::cmp::Ordering;\n+use std::fmt::Debug;\n use std::mem;\n use std::ops::{Bound, Index, IndexMut, RangeBounds};\n \n@@ -16,7 +17,7 @@ pub use index_map::SortedIndexMultiMap;\n /// stores data in a more compact way. It also supports accessing contiguous\n /// ranges of elements as a slice, and slices of already sorted elements can be\n /// inserted efficiently.\n-#[derive(Clone, PartialEq, Eq, PartialOrd, Ord, Hash, Debug, Encodable, Decodable)]\n+#[derive(Clone, PartialEq, Eq, PartialOrd, Ord, Hash, Encodable, Decodable)]\n pub struct SortedMap<K, V> {\n     data: Vec<(K, V)>,\n }\n@@ -314,5 +315,11 @@ impl<K: HashStable<CTX> + StableOrd, V: HashStable<CTX>, CTX> HashStable<CTX> fo\n     }\n }\n \n+impl<K: Debug, V: Debug> Debug for SortedMap<K, V> {\n+    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {\n+        f.debug_map().entries(self.data.iter().map(|(a, b)| (a, b))).finish()\n+    }\n+}\n+\n #[cfg(test)]\n mod tests;"}, {"sha": "034f06bb889b61f47022102f0fcfe8abe9d5d5cc", "filename": "compiler/rustc_hir/src/hir.rs", "status": "modified", "additions": 15, "deletions": 1, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/fbffaa91ada6387cdea184dcd1d689762b3e8927/compiler%2Frustc_hir%2Fsrc%2Fhir.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fbffaa91ada6387cdea184dcd1d689762b3e8927/compiler%2Frustc_hir%2Fsrc%2Fhir.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir%2Fsrc%2Fhir.rs?ref=fbffaa91ada6387cdea184dcd1d689762b3e8927", "patch": "@@ -854,7 +854,11 @@ impl fmt::Debug for OwnerNodes<'_> {\n                 &self\n                     .nodes\n                     .iter_enumerated()\n-                    .map(|(id, parented_node)| (id, parented_node.as_ref().map(|node| node.parent)))\n+                    .map(|(id, parented_node)| {\n+                        let parented_node = parented_node.as_ref().map(|node| node.parent);\n+\n+                        debug_fn(move |f| write!(f, \"({id:?}, {parented_node:?})\"))\n+                    })\n                     .collect::<Vec<_>>(),\n             )\n             .field(\"bodies\", &self.bodies)\n@@ -3615,3 +3619,13 @@ mod size_asserts {\n     static_assert_size!(TyKind<'_>, 32);\n     // tidy-alphabetical-end\n }\n+\n+fn debug_fn(f: impl Fn(&mut fmt::Formatter<'_>) -> fmt::Result) -> impl fmt::Debug {\n+    struct DebugFn<F>(F);\n+    impl<F: Fn(&mut fmt::Formatter<'_>) -> fmt::Result> fmt::Debug for DebugFn<F> {\n+        fn fmt(&self, fmt: &mut fmt::Formatter<'_>) -> fmt::Result {\n+            (self.0)(fmt)\n+        }\n+    }\n+    DebugFn(f)\n+}"}, {"sha": "5d05adfb55654efb9184d872b62427aea6eefef3", "filename": "compiler/rustc_hir/src/hir_id.rs", "status": "modified", "additions": 18, "deletions": 3, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/fbffaa91ada6387cdea184dcd1d689762b3e8927/compiler%2Frustc_hir%2Fsrc%2Fhir_id.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fbffaa91ada6387cdea184dcd1d689762b3e8927/compiler%2Frustc_hir%2Fsrc%2Fhir_id.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir%2Fsrc%2Fhir_id.rs?ref=fbffaa91ada6387cdea184dcd1d689762b3e8927", "patch": "@@ -1,14 +1,21 @@\n use crate::def_id::{DefId, DefIndex, LocalDefId, CRATE_DEF_ID};\n use rustc_data_structures::stable_hasher::{HashStable, StableHasher, StableOrd, ToStableHashKey};\n use rustc_span::{def_id::DefPathHash, HashStableContext};\n-use std::fmt;\n+use std::fmt::{self, Debug};\n \n-#[derive(Copy, Clone, PartialEq, Eq, Hash, Debug)]\n+#[derive(Copy, Clone, PartialEq, Eq, Hash)]\n #[derive(Encodable, Decodable)]\n pub struct OwnerId {\n     pub def_id: LocalDefId,\n }\n \n+impl Debug for OwnerId {\n+    fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {\n+        // Example: DefId(0:1 ~ aa[7697]::{use#0})\n+        Debug::fmt(&self.def_id, f)\n+    }\n+}\n+\n impl From<OwnerId> for HirId {\n     fn from(owner: OwnerId) -> HirId {\n         HirId { owner, local_id: ItemLocalId::from_u32(0) }\n@@ -60,14 +67,22 @@ impl<CTX: HashStableContext> ToStableHashKey<CTX> for OwnerId {\n /// the `local_id` part of the `HirId` changing, which is a very useful property in\n /// incremental compilation where we have to persist things through changes to\n /// the code base.\n-#[derive(Copy, Clone, PartialEq, Eq, Hash, Debug)]\n+#[derive(Copy, Clone, PartialEq, Eq, Hash)]\n #[derive(Encodable, Decodable, HashStable_Generic)]\n #[rustc_pass_by_value]\n pub struct HirId {\n     pub owner: OwnerId,\n     pub local_id: ItemLocalId,\n }\n \n+impl Debug for HirId {\n+    fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {\n+        // Example: HirId(DefId(0:1 ~ aa[7697]::{use#0}).10)\n+        // Don't use debug_tuple to always keep this on one line.\n+        write!(f, \"HirId({:?}.{:?})\", self.owner, self.local_id)\n+    }\n+}\n+\n impl HirId {\n     /// Signal local id which should never be used.\n     pub const INVALID: HirId ="}, {"sha": "4b6915f77152678f063ffca2141578bf963acfa8", "filename": "src/test/ui/thir-tree.stdout", "status": "modified", "additions": 1, "deletions": 6, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/fbffaa91ada6387cdea184dcd1d689762b3e8927/src%2Ftest%2Fui%2Fthir-tree.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/fbffaa91ada6387cdea184dcd1d689762b3e8927/src%2Ftest%2Fui%2Fthir-tree.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fthir-tree.stdout?ref=fbffaa91ada6387cdea184dcd1d689762b3e8927", "patch": "@@ -32,12 +32,7 @@ Thir {\n             kind: Scope {\n                 region_scope: Node(2),\n                 lint_level: Explicit(\n-                    HirId {\n-                        owner: OwnerId {\n-                            def_id: DefId(0:3 ~ thir_tree[8f1d]::main),\n-                        },\n-                        local_id: 2,\n-                    },\n+                    HirId(DefId(0:3 ~ thir_tree[8f1d]::main).2),\n                 ),\n                 value: e0,\n             },"}]}