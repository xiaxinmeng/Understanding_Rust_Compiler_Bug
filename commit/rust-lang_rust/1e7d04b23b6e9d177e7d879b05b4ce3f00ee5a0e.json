{"sha": "1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e", "node_id": "C_kwDOAAsO6NoAKDFlN2QwNGIyM2I2ZTlkMTc3ZTdkODc5YjA1YjRjZTNmMDBlZTVhMGU", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2022-07-13T14:02:34Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-07-13T14:02:34Z"}, "message": "Rollup merge of #99011 - oli-obk:UnsoundCell, r=eddyb\n\n`UnsafeCell` blocks niches inside its nested type from being available outside\n\nfixes #87341\n\nThis implements the plan by `@eddyb` in https://github.com/rust-lang/rust/issues/87341#issuecomment-886083646\n\nSomewhat related PR (not strictly necessary, but that cleanup made this PR simpler): #94527", "tree": {"sha": "56add3e431aabcba891e91b8247ad0e79ac238ec", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/56add3e431aabcba891e91b8247ad0e79ac238ec"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJiztB6CRBK7hj4Ov3rIwAAPEAIAC8Jr++DLJMMQOfdg1ojsBTR\n/7yrReuRYuMWfbgAq2MFrqdfjC8yEq5Fny41fovf2qSGNDg7ugfXtui5H2q7SrqR\njco5FGv4uihmLV8U/owVzTQbeBYKzQYpPLwb40fKXPaynrilBVg4aAuZe11uVzTk\nkfEudr+aY0ESqM2w1yX2OUyGr0nSEO+vix0kVU5uPGkxquSm96rc3zH/ysNZdNaO\n5QISFQkWU1x7wVfE1QYcWMirk6sonZu+8SbMFpIs4fgNqaxs9+wG72J43MdzCCj4\nes7lzMmKA2+RTAm9Vncn+z4t2WpwatDRCJR+d/2y3V/7bPceI2JKIyo8FGK4SSU=\n=0Y3/\n-----END PGP SIGNATURE-----\n", "payload": "tree 56add3e431aabcba891e91b8247ad0e79ac238ec\nparent 0083cd2fd498edb6a4e37bf4c711d11364e0ef20\nparent 519c07b3ce7f34975aacbe128e55d84411348229\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1657720954 +0530\ncommitter GitHub <noreply@github.com> 1657720954 +0530\n\nRollup merge of #99011 - oli-obk:UnsoundCell, r=eddyb\n\n`UnsafeCell` blocks niches inside its nested type from being available outside\n\nfixes #87341\n\nThis implements the plan by `@eddyb` in https://github.com/rust-lang/rust/issues/87341#issuecomment-886083646\n\nSomewhat related PR (not strictly necessary, but that cleanup made this PR simpler): #94527\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e", "html_url": "https://github.com/rust-lang/rust/commit/1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0083cd2fd498edb6a4e37bf4c711d11364e0ef20", "url": "https://api.github.com/repos/rust-lang/rust/commits/0083cd2fd498edb6a4e37bf4c711d11364e0ef20", "html_url": "https://github.com/rust-lang/rust/commit/0083cd2fd498edb6a4e37bf4c711d11364e0ef20"}, {"sha": "519c07b3ce7f34975aacbe128e55d84411348229", "url": "https://api.github.com/repos/rust-lang/rust/commits/519c07b3ce7f34975aacbe128e55d84411348229", "html_url": "https://github.com/rust-lang/rust/commit/519c07b3ce7f34975aacbe128e55d84411348229"}], "stats": {"total": 652, "additions": 139, "deletions": 513}, "files": [{"sha": "6673d75d99df070de5b6a5bb6b3727b6c786bfd1", "filename": "compiler/rustc_attr/src/builtin.rs", "status": "modified", "additions": 3, "deletions": 5, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e/compiler%2Frustc_attr%2Fsrc%2Fbuiltin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e/compiler%2Frustc_attr%2Fsrc%2Fbuiltin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_attr%2Fsrc%2Fbuiltin.rs?ref=1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e", "patch": "@@ -856,7 +856,6 @@ pub enum ReprAttr {\n     ReprSimd,\n     ReprTransparent,\n     ReprAlign(u32),\n-    ReprNoNiche,\n }\n \n #[derive(Eq, PartialEq, Debug, Copy, Clone)]\n@@ -904,7 +903,6 @@ pub fn parse_repr_attr(sess: &Session, attr: &Attribute) -> Vec<ReprAttr> {\n                     sym::packed => Some(ReprPacked(1)),\n                     sym::simd => Some(ReprSimd),\n                     sym::transparent => Some(ReprTransparent),\n-                    sym::no_niche => Some(ReprNoNiche),\n                     sym::align => {\n                         let mut err = struct_span_err!(\n                             diagnostic,\n@@ -943,7 +941,7 @@ pub fn parse_repr_attr(sess: &Session, attr: &Attribute) -> Vec<ReprAttr> {\n                         Ok(literal) => acc.push(ReprPacked(literal)),\n                         Err(message) => literal_error = Some(message),\n                     };\n-                } else if matches!(name, sym::C | sym::simd | sym::transparent | sym::no_niche)\n+                } else if matches!(name, sym::C | sym::simd | sym::transparent)\n                     || int_type_of_word(name).is_some()\n                 {\n                     recognised = true;\n@@ -1001,7 +999,7 @@ pub fn parse_repr_attr(sess: &Session, attr: &Attribute) -> Vec<ReprAttr> {\n                     } else {\n                         if matches!(\n                             meta_item.name_or_empty(),\n-                            sym::C | sym::simd | sym::transparent | sym::no_niche\n+                            sym::C | sym::simd | sym::transparent\n                         ) || int_type_of_word(meta_item.name_or_empty()).is_some()\n                         {\n                             recognised = true;\n@@ -1039,7 +1037,7 @@ pub fn parse_repr_attr(sess: &Session, attr: &Attribute) -> Vec<ReprAttr> {\n                         .emit();\n                     } else if matches!(\n                         meta_item.name_or_empty(),\n-                        sym::C | sym::simd | sym::transparent | sym::no_niche\n+                        sym::C | sym::simd | sym::transparent\n                     ) || int_type_of_word(meta_item.name_or_empty()).is_some()\n                     {\n                         recognised = true;"}, {"sha": "7616e7a63d1079aa2cbc1fb592b2152be28a04ce", "filename": "compiler/rustc_const_eval/src/interpret/intern.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fintern.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fintern.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fintern.rs?ref=1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e", "patch": "@@ -217,7 +217,7 @@ impl<'rt, 'mir, 'tcx: 'mir, M: CompileTimeMachine<'mir, 'tcx, const_eval::Memory\n         }\n \n         if let Some(def) = mplace.layout.ty.ty_adt_def() {\n-            if Some(def.did()) == self.ecx.tcx.lang_items().unsafe_cell_type() {\n+            if def.is_unsafe_cell() {\n                 // We are crossing over an `UnsafeCell`, we can mutate again. This means that\n                 // References we encounter inside here are interned as pointing to mutable\n                 // allocations."}, {"sha": "53bc2cc8a6980e14d1cbc516d477bb4f5a4727c4", "filename": "compiler/rustc_const_eval/src/interpret/validity.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fvalidity.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fvalidity.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fvalidity.rs?ref=1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e", "patch": "@@ -821,7 +821,7 @@ impl<'rt, 'mir, 'tcx: 'mir, M: Machine<'mir, 'tcx>> ValueVisitor<'mir, 'tcx, M>\n         // Special check preventing `UnsafeCell` in the inner part of constants\n         if let Some(def) = op.layout.ty.ty_adt_def() {\n             if matches!(self.ctfe_mode, Some(CtfeValidationMode::Const { inner: true, .. }))\n-                && Some(def.did()) == self.ecx.tcx.lang_items().unsafe_cell_type()\n+                && def.is_unsafe_cell()\n             {\n                 throw_validation_failure!(self.path, { \"`UnsafeCell` in a `const`\" });\n             }"}, {"sha": "a6f21ccef6d208f0eed0603e1a1b21e0b5abbcf0", "filename": "compiler/rustc_const_eval/src/transform/check_consts/qualifs.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fqualifs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fqualifs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fqualifs.rs?ref=1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e", "patch": "@@ -96,13 +96,13 @@ impl Qualif for HasMutInterior {\n     }\n \n     fn in_adt_inherently<'tcx>(\n-        cx: &ConstCx<'_, 'tcx>,\n+        _cx: &ConstCx<'_, 'tcx>,\n         adt: AdtDef<'tcx>,\n         _: SubstsRef<'tcx>,\n     ) -> bool {\n         // Exactly one type, `UnsafeCell`, has the `HasMutInterior` qualif inherently.\n         // It arises structurally for all other types.\n-        Some(adt.did()) == cx.tcx.lang_items().unsafe_cell_type()\n+        adt.is_unsafe_cell()\n     }\n }\n "}, {"sha": "117bdad971a208fef20b4b29830273877f262319", "filename": "compiler/rustc_feature/src/active.rs", "status": "modified", "additions": 0, "deletions": 3, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e/compiler%2Frustc_feature%2Fsrc%2Factive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e/compiler%2Frustc_feature%2Fsrc%2Factive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_feature%2Fsrc%2Factive.rs?ref=1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e", "patch": "@@ -156,9 +156,6 @@ declare_features! (\n     (active, intrinsics, \"1.0.0\", None, None),\n     /// Allows using `#[lang = \"..\"]` attribute for linking items to special compiler logic.\n     (active, lang_items, \"1.0.0\", None, None),\n-    /// Allows `#[repr(no_niche)]` (an implementation detail of `rustc`,\n-    /// it is not on path for eventual stabilization).\n-    (active, no_niche, \"1.42.0\", None, None),\n     /// Allows using `#[omit_gdb_pretty_printer_section]`.\n     (active, omit_gdb_pretty_printer_section, \"1.5.0\", None, None),\n     /// Allows using `#[prelude_import]` on glob `use` items."}, {"sha": "aca481df2e113ccbdd33e1fc0d8cab85ee01342c", "filename": "compiler/rustc_lint/src/types.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e/compiler%2Frustc_lint%2Fsrc%2Ftypes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e/compiler%2Frustc_lint%2Fsrc%2Ftypes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_lint%2Fsrc%2Ftypes.rs?ref=1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e", "patch": "@@ -703,9 +703,8 @@ fn ty_is_known_nonnull<'tcx>(cx: &LateContext<'tcx>, ty: Ty<'tcx>, mode: CItemKi\n                 return true;\n             }\n \n-            // Types with a `#[repr(no_niche)]` attribute have their niche hidden.\n-            // The attribute is used by the UnsafeCell for example (the only use so far).\n-            if def.repr().hide_niche() {\n+            // `UnsafeCell` has its niche hidden.\n+            if def.is_unsafe_cell() {\n                 return false;\n             }\n "}, {"sha": "809406aff1878879802042e00a5db620c572f206", "filename": "compiler/rustc_middle/src/ty/adt.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e/compiler%2Frustc_middle%2Fsrc%2Fty%2Fadt.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e/compiler%2Frustc_middle%2Fsrc%2Fty%2Fadt.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fadt.rs?ref=1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e", "patch": "@@ -52,6 +52,8 @@ bitflags! {\n         /// Indicates whether the variant list of this ADT is `#[non_exhaustive]`.\n         /// (i.e., this flag is never set unless this ADT is an enum).\n         const IS_VARIANT_LIST_NON_EXHAUSTIVE = 1 << 8;\n+        /// Indicates whether the type is `UnsafeCell`.\n+        const IS_UNSAFE_CELL              = 1 << 9;\n     }\n }\n \n@@ -247,6 +249,9 @@ impl AdtDefData {\n         if Some(did) == tcx.lang_items().manually_drop() {\n             flags |= AdtFlags::IS_MANUALLY_DROP;\n         }\n+        if Some(did) == tcx.lang_items().unsafe_cell_type() {\n+            flags |= AdtFlags::IS_UNSAFE_CELL;\n+        }\n \n         AdtDefData { did, variants, flags, repr }\n     }\n@@ -333,6 +338,12 @@ impl<'tcx> AdtDef<'tcx> {\n         self.flags().contains(AdtFlags::IS_BOX)\n     }\n \n+    /// Returns `true` if this is UnsafeCell<T>.\n+    #[inline]\n+    pub fn is_unsafe_cell(self) -> bool {\n+        self.flags().contains(AdtFlags::IS_UNSAFE_CELL)\n+    }\n+\n     /// Returns `true` if this is `ManuallyDrop<T>`.\n     #[inline]\n     pub fn is_manually_drop(self) -> bool {"}, {"sha": "1ed41db099ca00cb9b9be790c6b904d610b3eed6", "filename": "compiler/rustc_middle/src/ty/layout.rs", "status": "modified", "additions": 30, "deletions": 13, "changes": 43, "blob_url": "https://github.com/rust-lang/rust/blob/1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e/compiler%2Frustc_middle%2Fsrc%2Fty%2Flayout.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e/compiler%2Frustc_middle%2Fsrc%2Fty%2Flayout.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Flayout.rs?ref=1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e", "patch": "@@ -542,14 +542,12 @@ impl<'tcx> LayoutCx<'tcx, TyCtxt<'tcx>> {\n             debug!(\"univariant offset: {:?} field: {:#?}\", offset, field);\n             offsets[i as usize] = offset;\n \n-            if !repr.hide_niche() {\n-                if let Some(mut niche) = field.largest_niche {\n-                    let available = niche.available(dl);\n-                    if available > largest_niche_available {\n-                        largest_niche_available = available;\n-                        niche.offset += offset;\n-                        largest_niche = Some(niche);\n-                    }\n+            if let Some(mut niche) = field.largest_niche {\n+                let available = niche.available(dl);\n+                if available > largest_niche_available {\n+                    largest_niche_available = available;\n+                    niche.offset += offset;\n+                    largest_niche = Some(niche);\n                 }\n             }\n \n@@ -1078,6 +1076,29 @@ impl<'tcx> LayoutCx<'tcx, TyCtxt<'tcx>> {\n \n                     let mut st = self.univariant_uninterned(ty, &variants[v], &def.repr(), kind)?;\n                     st.variants = Variants::Single { index: v };\n+\n+                    if def.is_unsafe_cell() {\n+                        let hide_niches = |scalar: &mut _| match scalar {\n+                            Scalar::Initialized { value, valid_range } => {\n+                                *valid_range = WrappingRange::full(value.size(dl))\n+                            }\n+                            // Already doesn't have any niches\n+                            Scalar::Union { .. } => {}\n+                        };\n+                        match &mut st.abi {\n+                            Abi::Uninhabited => {}\n+                            Abi::Scalar(scalar) => hide_niches(scalar),\n+                            Abi::ScalarPair(a, b) => {\n+                                hide_niches(a);\n+                                hide_niches(b);\n+                            }\n+                            Abi::Vector { element, count: _ } => hide_niches(element),\n+                            Abi::Aggregate { sized: _ } => {}\n+                        }\n+                        st.largest_niche = None;\n+                        return Ok(tcx.intern_layout(st));\n+                    }\n+\n                     let (start, end) = self.tcx.layout_scalar_valid_range(def.did());\n                     match st.abi {\n                         Abi::Scalar(ref mut scalar) | Abi::ScalarPair(ref mut scalar, _) => {\n@@ -1106,11 +1127,7 @@ impl<'tcx> LayoutCx<'tcx, TyCtxt<'tcx>> {\n                             }\n \n                             // Update `largest_niche` if we have introduced a larger niche.\n-                            let niche = if def.repr().hide_niche() {\n-                                None\n-                            } else {\n-                                Niche::from_scalar(dl, Size::ZERO, *scalar)\n-                            };\n+                            let niche = Niche::from_scalar(dl, Size::ZERO, *scalar);\n                             if let Some(niche) = niche {\n                                 match st.largest_niche {\n                                     Some(largest_niche) => {"}, {"sha": "c2c7b3df844ada6c5f43c7db1db43f971abc88b6", "filename": "compiler/rustc_middle/src/ty/mod.rs", "status": "modified", "additions": 1, "deletions": 9, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e/compiler%2Frustc_middle%2Fsrc%2Fty%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e/compiler%2Frustc_middle%2Fsrc%2Fty%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fmod.rs?ref=1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e", "patch": "@@ -1720,11 +1720,9 @@ bitflags! {\n         const IS_TRANSPARENT     = 1 << 2;\n         // Internal only for now. If true, don't reorder fields.\n         const IS_LINEAR          = 1 << 3;\n-        // If true, don't expose any niche to type's context.\n-        const HIDE_NICHE         = 1 << 4;\n         // If true, the type's layout can be randomized using\n         // the seed stored in `ReprOptions.layout_seed`\n-        const RANDOMIZE_LAYOUT   = 1 << 5;\n+        const RANDOMIZE_LAYOUT   = 1 << 4;\n         // Any of these flags being set prevent field reordering optimisation.\n         const IS_UNOPTIMISABLE   = ReprFlags::IS_C.bits\n                                  | ReprFlags::IS_SIMD.bits\n@@ -1781,7 +1779,6 @@ impl ReprOptions {\n                         ReprFlags::empty()\n                     }\n                     attr::ReprTransparent => ReprFlags::IS_TRANSPARENT,\n-                    attr::ReprNoNiche => ReprFlags::HIDE_NICHE,\n                     attr::ReprSimd => ReprFlags::IS_SIMD,\n                     attr::ReprInt(i) => {\n                         size = Some(i);\n@@ -1834,11 +1831,6 @@ impl ReprOptions {\n         self.flags.contains(ReprFlags::IS_LINEAR)\n     }\n \n-    #[inline]\n-    pub fn hide_niche(&self) -> bool {\n-        self.flags.contains(ReprFlags::HIDE_NICHE)\n-    }\n-\n     /// Returns the discriminant type, given these `repr` options.\n     /// This must only be called on enums!\n     pub fn discr_type(&self) -> attr::IntType {"}, {"sha": "20d03d797fed1531a8c0ace9e92489a721077c10", "filename": "compiler/rustc_passes/src/check_attr.rs", "status": "modified", "additions": 2, "deletions": 19, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs?ref=1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e", "patch": "@@ -1808,21 +1808,6 @@ impl CheckAttrVisitor<'_> {\n                         _ => (\"a\", \"struct, enum, or union\"),\n                     }\n                 }\n-                sym::no_niche => {\n-                    if !self.tcx.features().enabled(sym::no_niche) {\n-                        feature_err(\n-                            &self.tcx.sess.parse_sess,\n-                            sym::no_niche,\n-                            hint.span(),\n-                            \"the attribute `repr(no_niche)` is currently unstable\",\n-                        )\n-                        .emit();\n-                    }\n-                    match target {\n-                        Target::Struct | Target::Enum => continue,\n-                        _ => (\"a\", \"struct or enum\"),\n-                    }\n-                }\n                 sym::i8\n                 | sym::u8\n                 | sym::i16\n@@ -1870,10 +1855,8 @@ impl CheckAttrVisitor<'_> {\n         // This is not ideal, but tracking precisely which ones are at fault is a huge hassle.\n         let hint_spans = hints.iter().map(|hint| hint.span());\n \n-        // Error on repr(transparent, <anything else apart from no_niche>).\n-        let non_no_niche = |hint: &&NestedMetaItem| hint.name_or_empty() != sym::no_niche;\n-        let non_no_niche_count = hints.iter().filter(non_no_niche).count();\n-        if is_transparent && non_no_niche_count > 1 {\n+        // Error on repr(transparent, <anything else>).\n+        if is_transparent && hints.len() > 1 {\n             let hint_spans: Vec<_> = hint_spans.clone().collect();\n             struct_span_err!(\n                 self.tcx.sess,"}, {"sha": "99912b491cb7d912001f0e89bd713ea68456e418", "filename": "compiler/rustc_span/src/symbol.rs", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs?ref=1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e", "patch": "@@ -980,7 +980,6 @@ symbols! {\n         no_link,\n         no_main,\n         no_mangle,\n-        no_niche,\n         no_sanitize,\n         no_stack_check,\n         no_start,\n@@ -1153,7 +1152,6 @@ symbols! {\n         repr128,\n         repr_align,\n         repr_align_enum,\n-        repr_no_niche,\n         repr_packed,\n         repr_simd,\n         repr_transparent,"}, {"sha": "8a37fadc56f4c8ef583f50fbac292c13ad4cb418", "filename": "library/core/src/cell.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e/library%2Fcore%2Fsrc%2Fcell.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e/library%2Fcore%2Fsrc%2Fcell.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fcell.rs?ref=1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e", "patch": "@@ -1856,7 +1856,6 @@ impl<T: ?Sized + fmt::Display> fmt::Display for RefMut<'_, T> {\n #[lang = \"unsafe_cell\"]\n #[stable(feature = \"rust1\", since = \"1.0.0\")]\n #[repr(transparent)]\n-#[repr(no_niche)] // rust-lang/rust#68303.\n pub struct UnsafeCell<T: ?Sized> {\n     value: T,\n }"}, {"sha": "f24a7ab61ae8903cd98dfdb3fcb1b992f8834220", "filename": "library/core/src/lib.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e/library%2Fcore%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e/library%2Fcore%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Flib.rs?ref=1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e", "patch": "@@ -191,7 +191,6 @@\n #![feature(never_type)]\n #![feature(no_core)]\n #![feature(no_coverage)] // rust-lang/rust#84605\n-#![feature(no_niche)] // rust-lang/rust#68303\n #![feature(platform_intrinsics)]\n #![feature(prelude_import)]\n #![feature(repr_simd)]"}, {"sha": "73b32066fadcd3addb3e6def2ed0b5c390b2b455", "filename": "src/test/ui/layout/unsafe-cell-hides-niche.rs", "status": "modified", "additions": 64, "deletions": 14, "changes": 78, "blob_url": "https://github.com/rust-lang/rust/blob/1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e/src%2Ftest%2Fui%2Flayout%2Funsafe-cell-hides-niche.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e/src%2Ftest%2Fui%2Flayout%2Funsafe-cell-hides-niche.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flayout%2Funsafe-cell-hides-niche.rs?ref=1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e", "patch": "@@ -3,30 +3,80 @@\n // test checks that an `Option<UnsafeCell<NonZeroU32>>` has the same\n // size in memory as an `Option<UnsafeCell<u32>>` (namely, 8 bytes).\n \n-// run-pass\n+// check-pass\n+// compile-flags: --crate-type=lib\n+// only-x86\n \n-#![feature(no_niche)]\n+#![feature(repr_simd)]\n \n-use std::cell::UnsafeCell;\n+use std::cell::{UnsafeCell, RefCell, Cell};\n use std::mem::size_of;\n use std::num::NonZeroU32 as N32;\n+use std::sync::{Mutex, RwLock};\n \n struct Wrapper<T>(T);\n \n #[repr(transparent)]\n struct Transparent<T>(T);\n \n-#[repr(no_niche)]\n-struct NoNiche<T>(T);\n+struct NoNiche<T>(UnsafeCell<T>);\n \n-fn main() {\n-    assert_eq!(size_of::<Option<Wrapper<u32>>>(),     8);\n-    assert_eq!(size_of::<Option<Wrapper<N32>>>(),     4);\n-    assert_eq!(size_of::<Option<Transparent<u32>>>(), 8);\n-    assert_eq!(size_of::<Option<Transparent<N32>>>(), 4);\n-    assert_eq!(size_of::<Option<NoNiche<u32>>>(),     8);\n-    assert_eq!(size_of::<Option<NoNiche<N32>>>(),     8);\n+struct Size<const S: usize>;\n \n-    assert_eq!(size_of::<Option<UnsafeCell<u32>>>(),  8);\n-    assert_eq!(size_of::<Option<UnsafeCell<N32>>>(),  8);\n+macro_rules! check_sizes {\n+    (check_one_specific_size: $ty:ty, $size:expr) => {\n+        const _: Size::<{$size}> = Size::<{size_of::<$ty>()}>;\n+    };\n+    // Any tests run on `UnsafeCell` must be the same for `Cell`\n+    (UnsafeCell<$ty:ty>: $size:expr => $optioned_size:expr) => {\n+        check_sizes!(Cell<$ty>: $size => $optioned_size);\n+        check_sizes!(@actual_check: UnsafeCell<$ty>: $size => $optioned_size);\n+    };\n+    ($ty:ty: $size:expr => $optioned_size:expr) => {\n+        check_sizes!(@actual_check: $ty: $size => $optioned_size);\n+    };\n+    // This branch does the actual checking logic, the `@actual_check` prefix is here to distinguish\n+    // it from other branches and not accidentally match any.\n+    (@actual_check: $ty:ty: $size:expr => $optioned_size:expr) => {\n+        check_sizes!(check_one_specific_size: $ty, $size);\n+        check_sizes!(check_one_specific_size: Option<$ty>, $optioned_size);\n+        check_sizes!(check_no_niche_opt: $size != $optioned_size, $ty);\n+    };\n+    // only check that there is no niche (size goes up when wrapped in an option),\n+    // don't check actual sizes\n+    ($ty:ty) => {\n+        check_sizes!(check_no_niche_opt: true, $ty);\n+    };\n+    (check_no_niche_opt: $no_niche_opt:expr, $ty:ty) => {\n+        const _: () = if $no_niche_opt { assert!(size_of::<$ty>() < size_of::<Option<$ty>>()); };\n+    };\n }\n+\n+const PTR_SIZE: usize = std::mem::size_of::<*const ()>();\n+\n+check_sizes!(Wrapper<u32>:     4 => 8);\n+check_sizes!(Wrapper<N32>:     4 => 4); // (\u2713 niche opt)\n+check_sizes!(Transparent<u32>: 4 => 8);\n+check_sizes!(Transparent<N32>: 4 => 4); // (\u2713 niche opt)\n+check_sizes!(NoNiche<u32>:     4 => 8);\n+check_sizes!(NoNiche<N32>:     4 => 8);\n+\n+check_sizes!(UnsafeCell<u32>:  4 => 8);\n+check_sizes!(UnsafeCell<N32>:  4 => 8);\n+\n+check_sizes!(UnsafeCell<&()>: PTR_SIZE => PTR_SIZE * 2);\n+check_sizes!(   RefCell<&()>: PTR_SIZE * 2 => PTR_SIZE * 3);\n+\n+check_sizes!(RwLock<&()>);\n+check_sizes!(Mutex<&()>);\n+\n+check_sizes!(UnsafeCell<&[i32]>: PTR_SIZE * 2 => PTR_SIZE * 3);\n+check_sizes!(UnsafeCell<(&(), &())>: PTR_SIZE * 2 => PTR_SIZE * 3);\n+\n+trait Trait {}\n+check_sizes!(UnsafeCell<&dyn Trait>: PTR_SIZE * 2 => PTR_SIZE * 3);\n+\n+#[repr(simd)]\n+pub struct Vec4<T>([T; 4]);\n+\n+check_sizes!(UnsafeCell<Vec4<N32>>: 16 => 32);"}, {"sha": "809e0602671febce0af951ec3c6bd0477ea67688", "filename": "src/test/ui/lint/clashing-extern-fn.rs", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e/src%2Ftest%2Fui%2Flint%2Fclashing-extern-fn.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e/src%2Ftest%2Fui%2Flint%2Fclashing-extern-fn.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Fclashing-extern-fn.rs?ref=1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e", "patch": "@@ -1,7 +1,6 @@\n // check-pass\n // aux-build:external_extern_fn.rs\n #![crate_type = \"lib\"]\n-#![feature(no_niche)]\n #![warn(clashing_extern_declarations)]\n \n mod redeclared_different_signature {\n@@ -400,9 +399,8 @@ mod hidden_niche {\n         #[repr(transparent)]\n         struct Transparent { x: NonZeroUsize }\n \n-        #[repr(no_niche)]\n         #[repr(transparent)]\n-        struct TransparentNoNiche { y: NonZeroUsize }\n+        struct TransparentNoNiche { y: UnsafeCell<NonZeroUsize> }\n \n         extern \"C\" {\n             fn hidden_niche_transparent() -> Option<Transparent>;"}, {"sha": "4607f68499322263dd4f85bf93bf4955eb76206b", "filename": "src/test/ui/lint/clashing-extern-fn.stderr", "status": "modified", "additions": 20, "deletions": 20, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e/src%2Ftest%2Fui%2Flint%2Fclashing-extern-fn.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e/src%2Ftest%2Fui%2Flint%2Fclashing-extern-fn.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Fclashing-extern-fn.stderr?ref=1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e", "patch": "@@ -1,5 +1,5 @@\n warning: `clash` redeclared with a different signature\n-  --> $DIR/clashing-extern-fn.rs:15:13\n+  --> $DIR/clashing-extern-fn.rs:14:13\n    |\n LL |             fn clash(x: u8);\n    |             ---------------- `clash` previously declared here\n@@ -8,15 +8,15 @@ LL |             fn clash(x: u64);\n    |             ^^^^^^^^^^^^^^^^^ this signature doesn't match the previous declaration\n    |\n note: the lint level is defined here\n-  --> $DIR/clashing-extern-fn.rs:5:9\n+  --> $DIR/clashing-extern-fn.rs:4:9\n    |\n LL | #![warn(clashing_extern_declarations)]\n    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    = note: expected `unsafe extern \"C\" fn(u8)`\n               found `unsafe extern \"C\" fn(u64)`\n \n warning: `extern_link_name` redeclared with a different signature\n-  --> $DIR/clashing-extern-fn.rs:53:9\n+  --> $DIR/clashing-extern-fn.rs:52:9\n    |\n LL | /     #[link_name = \"extern_link_name\"]\n LL | |     fn some_new_name(x: i16);\n@@ -29,7 +29,7 @@ LL |           fn extern_link_name(x: u32);\n               found `unsafe extern \"C\" fn(u32)`\n \n warning: `some_other_extern_link_name` redeclares `some_other_new_name` with a different signature\n-  --> $DIR/clashing-extern-fn.rs:56:9\n+  --> $DIR/clashing-extern-fn.rs:55:9\n    |\n LL |       fn some_other_new_name(x: i16);\n    |       ------------------------------- `some_other_new_name` previously declared here\n@@ -43,7 +43,7 @@ LL | |         fn some_other_extern_link_name(x: u32);\n               found `unsafe extern \"C\" fn(u32)`\n \n warning: `other_both_names_different` redeclares `link_name_same` with a different signature\n-  --> $DIR/clashing-extern-fn.rs:60:9\n+  --> $DIR/clashing-extern-fn.rs:59:9\n    |\n LL | /     #[link_name = \"link_name_same\"]\n LL | |     fn both_names_different(x: i16);\n@@ -58,7 +58,7 @@ LL | |         fn other_both_names_different(x: u32);\n               found `unsafe extern \"C\" fn(u32)`\n \n warning: `different_mod` redeclared with a different signature\n-  --> $DIR/clashing-extern-fn.rs:73:9\n+  --> $DIR/clashing-extern-fn.rs:72:9\n    |\n LL |         fn different_mod(x: u8);\n    |         ------------------------ `different_mod` previously declared here\n@@ -70,7 +70,7 @@ LL |         fn different_mod(x: u64);\n               found `unsafe extern \"C\" fn(u64)`\n \n warning: `variadic_decl` redeclared with a different signature\n-  --> $DIR/clashing-extern-fn.rs:83:9\n+  --> $DIR/clashing-extern-fn.rs:82:9\n    |\n LL |     fn variadic_decl(x: u8, ...);\n    |     ----------------------------- `variadic_decl` previously declared here\n@@ -82,7 +82,7 @@ LL |         fn variadic_decl(x: u8);\n               found `unsafe extern \"C\" fn(u8)`\n \n warning: `weigh_banana` redeclared with a different signature\n-  --> $DIR/clashing-extern-fn.rs:143:13\n+  --> $DIR/clashing-extern-fn.rs:142:13\n    |\n LL |             fn weigh_banana(count: *const Banana) -> u64;\n    |             --------------------------------------------- `weigh_banana` previously declared here\n@@ -94,7 +94,7 @@ LL |             fn weigh_banana(count: *const Banana) -> u64;\n               found `unsafe extern \"C\" fn(*const three::Banana) -> u64`\n \n warning: `draw_point` redeclared with a different signature\n-  --> $DIR/clashing-extern-fn.rs:172:13\n+  --> $DIR/clashing-extern-fn.rs:171:13\n    |\n LL |             fn draw_point(p: Point);\n    |             ------------------------ `draw_point` previously declared here\n@@ -106,7 +106,7 @@ LL |             fn draw_point(p: Point);\n               found `unsafe extern \"C\" fn(sameish_members::b::Point)`\n \n warning: `origin` redeclared with a different signature\n-  --> $DIR/clashing-extern-fn.rs:198:13\n+  --> $DIR/clashing-extern-fn.rs:197:13\n    |\n LL |             fn origin() -> Point3;\n    |             ---------------------- `origin` previously declared here\n@@ -118,7 +118,7 @@ LL |             fn origin() -> Point3;\n               found `unsafe extern \"C\" fn() -> same_sized_members_clash::b::Point3`\n \n warning: `transparent_incorrect` redeclared with a different signature\n-  --> $DIR/clashing-extern-fn.rs:221:13\n+  --> $DIR/clashing-extern-fn.rs:220:13\n    |\n LL |             fn transparent_incorrect() -> T;\n    |             -------------------------------- `transparent_incorrect` previously declared here\n@@ -130,7 +130,7 @@ LL |             fn transparent_incorrect() -> isize;\n               found `unsafe extern \"C\" fn() -> isize`\n \n warning: `missing_return_type` redeclared with a different signature\n-  --> $DIR/clashing-extern-fn.rs:239:13\n+  --> $DIR/clashing-extern-fn.rs:238:13\n    |\n LL |             fn missing_return_type() -> usize;\n    |             ---------------------------------- `missing_return_type` previously declared here\n@@ -142,7 +142,7 @@ LL |             fn missing_return_type();\n               found `unsafe extern \"C\" fn()`\n \n warning: `non_zero_usize` redeclared with a different signature\n-  --> $DIR/clashing-extern-fn.rs:257:13\n+  --> $DIR/clashing-extern-fn.rs:256:13\n    |\n LL |             fn non_zero_usize() -> core::num::NonZeroUsize;\n    |             ----------------------------------------------- `non_zero_usize` previously declared here\n@@ -154,7 +154,7 @@ LL |             fn non_zero_usize() -> usize;\n               found `unsafe extern \"C\" fn() -> usize`\n \n warning: `non_null_ptr` redeclared with a different signature\n-  --> $DIR/clashing-extern-fn.rs:259:13\n+  --> $DIR/clashing-extern-fn.rs:258:13\n    |\n LL |             fn non_null_ptr() -> core::ptr::NonNull<usize>;\n    |             ----------------------------------------------- `non_null_ptr` previously declared here\n@@ -166,7 +166,7 @@ LL |             fn non_null_ptr() -> *const usize;\n               found `unsafe extern \"C\" fn() -> *const usize`\n \n warning: `option_non_zero_usize_incorrect` redeclared with a different signature\n-  --> $DIR/clashing-extern-fn.rs:357:13\n+  --> $DIR/clashing-extern-fn.rs:356:13\n    |\n LL |             fn option_non_zero_usize_incorrect() -> usize;\n    |             ---------------------------------------------- `option_non_zero_usize_incorrect` previously declared here\n@@ -178,7 +178,7 @@ LL |             fn option_non_zero_usize_incorrect() -> isize;\n               found `unsafe extern \"C\" fn() -> isize`\n \n warning: `option_non_null_ptr_incorrect` redeclared with a different signature\n-  --> $DIR/clashing-extern-fn.rs:359:13\n+  --> $DIR/clashing-extern-fn.rs:358:13\n    |\n LL |             fn option_non_null_ptr_incorrect() -> *const usize;\n    |             --------------------------------------------------- `option_non_null_ptr_incorrect` previously declared here\n@@ -190,7 +190,7 @@ LL |             fn option_non_null_ptr_incorrect() -> *const isize;\n               found `unsafe extern \"C\" fn() -> *const isize`\n \n warning: `hidden_niche_transparent_no_niche` redeclared with a different signature\n-  --> $DIR/clashing-extern-fn.rs:410:13\n+  --> $DIR/clashing-extern-fn.rs:408:13\n    |\n LL |             fn hidden_niche_transparent_no_niche() -> usize;\n    |             ------------------------------------------------ `hidden_niche_transparent_no_niche` previously declared here\n@@ -202,7 +202,7 @@ LL |             fn hidden_niche_transparent_no_niche() -> Option<TransparentNoN\n               found `unsafe extern \"C\" fn() -> Option<TransparentNoNiche>`\n \n warning: `hidden_niche_unsafe_cell` redeclared with a different signature\n-  --> $DIR/clashing-extern-fn.rs:414:13\n+  --> $DIR/clashing-extern-fn.rs:412:13\n    |\n LL |             fn hidden_niche_unsafe_cell() -> usize;\n    |             --------------------------------------- `hidden_niche_unsafe_cell` previously declared here\n@@ -214,7 +214,7 @@ LL |             fn hidden_niche_unsafe_cell() -> Option<UnsafeCell<NonZeroUsize\n               found `unsafe extern \"C\" fn() -> Option<UnsafeCell<NonZeroUsize>>`\n \n warning: `extern` block uses type `Option<TransparentNoNiche>`, which is not FFI-safe\n-  --> $DIR/clashing-extern-fn.rs:410:55\n+  --> $DIR/clashing-extern-fn.rs:408:55\n    |\n LL |             fn hidden_niche_transparent_no_niche() -> Option<TransparentNoNiche>;\n    |                                                       ^^^^^^^^^^^^^^^^^^^^^^^^^^ not FFI-safe\n@@ -224,7 +224,7 @@ LL |             fn hidden_niche_transparent_no_niche() -> Option<TransparentNoN\n    = note: enum has no representation hint\n \n warning: `extern` block uses type `Option<UnsafeCell<NonZeroUsize>>`, which is not FFI-safe\n-  --> $DIR/clashing-extern-fn.rs:414:46\n+  --> $DIR/clashing-extern-fn.rs:412:46\n    |\n LL |             fn hidden_niche_unsafe_cell() -> Option<UnsafeCell<NonZeroUsize>>;\n    |                                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ not FFI-safe"}, {"sha": "8872ee7119e4a399bba16b4895b5d6bc6026f4a4", "filename": "src/test/ui/repr/feature-gate-no-niche.rs", "status": "removed", "additions": 0, "deletions": 20, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/0083cd2fd498edb6a4e37bf4c711d11364e0ef20/src%2Ftest%2Fui%2Frepr%2Ffeature-gate-no-niche.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0083cd2fd498edb6a4e37bf4c711d11364e0ef20/src%2Ftest%2Fui%2Frepr%2Ffeature-gate-no-niche.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frepr%2Ffeature-gate-no-niche.rs?ref=0083cd2fd498edb6a4e37bf4c711d11364e0ef20", "patch": "@@ -1,20 +0,0 @@\n-use std::num::NonZeroU8 as N8;\n-use std::num::NonZeroU16 as N16;\n-\n-#[repr(no_niche)]\n-pub struct Cloaked(N16);\n-//~^^ ERROR the attribute `repr(no_niche)` is currently unstable [E0658]\n-\n-#[repr(transparent, no_niche)]\n-pub struct Shadowy(N16);\n-//~^^ ERROR the attribute `repr(no_niche)` is currently unstable [E0658]\n-\n-#[repr(no_niche)]\n-pub enum Cloaked1 { _A(N16), }\n-//~^^ ERROR the attribute `repr(no_niche)` is currently unstable [E0658]\n-\n-#[repr(no_niche)]\n-pub enum Cloaked2 { _A(N16), _B(u8, N8) }\n-//~^^ ERROR the attribute `repr(no_niche)` is currently unstable [E0658]\n-\n-fn main() { }"}, {"sha": "34fd417cc99a2e0c4f7e085cf3b6fe82d4e9f49e", "filename": "src/test/ui/repr/feature-gate-no-niche.stderr", "status": "removed", "additions": 0, "deletions": 35, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/0083cd2fd498edb6a4e37bf4c711d11364e0ef20/src%2Ftest%2Fui%2Frepr%2Ffeature-gate-no-niche.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/0083cd2fd498edb6a4e37bf4c711d11364e0ef20/src%2Ftest%2Fui%2Frepr%2Ffeature-gate-no-niche.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frepr%2Ffeature-gate-no-niche.stderr?ref=0083cd2fd498edb6a4e37bf4c711d11364e0ef20", "patch": "@@ -1,35 +0,0 @@\n-error[E0658]: the attribute `repr(no_niche)` is currently unstable\n-  --> $DIR/feature-gate-no-niche.rs:4:8\n-   |\n-LL | #[repr(no_niche)]\n-   |        ^^^^^^^^\n-   |\n-   = help: add `#![feature(no_niche)]` to the crate attributes to enable\n-\n-error[E0658]: the attribute `repr(no_niche)` is currently unstable\n-  --> $DIR/feature-gate-no-niche.rs:8:21\n-   |\n-LL | #[repr(transparent, no_niche)]\n-   |                     ^^^^^^^^\n-   |\n-   = help: add `#![feature(no_niche)]` to the crate attributes to enable\n-\n-error[E0658]: the attribute `repr(no_niche)` is currently unstable\n-  --> $DIR/feature-gate-no-niche.rs:12:8\n-   |\n-LL | #[repr(no_niche)]\n-   |        ^^^^^^^^\n-   |\n-   = help: add `#![feature(no_niche)]` to the crate attributes to enable\n-\n-error[E0658]: the attribute `repr(no_niche)` is currently unstable\n-  --> $DIR/feature-gate-no-niche.rs:16:8\n-   |\n-LL | #[repr(no_niche)]\n-   |        ^^^^^^^^\n-   |\n-   = help: add `#![feature(no_niche)]` to the crate attributes to enable\n-\n-error: aborting due to 4 previous errors\n-\n-For more information about this error, try `rustc --explain E0658`."}, {"sha": "870eda89c20d7cd0cb9b4d575287d882e7f3ca2a", "filename": "src/test/ui/repr/repr-no-niche-inapplicable-to-unions.rs", "status": "removed", "additions": 0, "deletions": 14, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/0083cd2fd498edb6a4e37bf4c711d11364e0ef20/src%2Ftest%2Fui%2Frepr%2Frepr-no-niche-inapplicable-to-unions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0083cd2fd498edb6a4e37bf4c711d11364e0ef20/src%2Ftest%2Fui%2Frepr%2Frepr-no-niche-inapplicable-to-unions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frepr%2Frepr-no-niche-inapplicable-to-unions.rs?ref=0083cd2fd498edb6a4e37bf4c711d11364e0ef20", "patch": "@@ -1,14 +0,0 @@\n-#![feature(no_niche)]\n-\n-use std::num::NonZeroU8 as N8;\n-use std::num::NonZeroU16 as N16;\n-\n-#[repr(no_niche)]\n-pub union Cloaked1 { _A: N16 }\n-//~^^ ERROR attribute should be applied to a struct or enum [E0517]\n-\n-#[repr(no_niche)]\n-pub union Cloaked2 { _A: N16, _B: (u8, N8) }\n-//~^^ ERROR attribute should be applied to a struct or enum [E0517]\n-\n-fn main() { }"}, {"sha": "9af929d409473991a78be237f0df950fc9543736", "filename": "src/test/ui/repr/repr-no-niche-inapplicable-to-unions.stderr", "status": "removed", "additions": 0, "deletions": 19, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/0083cd2fd498edb6a4e37bf4c711d11364e0ef20/src%2Ftest%2Fui%2Frepr%2Frepr-no-niche-inapplicable-to-unions.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/0083cd2fd498edb6a4e37bf4c711d11364e0ef20/src%2Ftest%2Fui%2Frepr%2Frepr-no-niche-inapplicable-to-unions.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frepr%2Frepr-no-niche-inapplicable-to-unions.stderr?ref=0083cd2fd498edb6a4e37bf4c711d11364e0ef20", "patch": "@@ -1,19 +0,0 @@\n-error[E0517]: attribute should be applied to a struct or enum\n-  --> $DIR/repr-no-niche-inapplicable-to-unions.rs:6:8\n-   |\n-LL | #[repr(no_niche)]\n-   |        ^^^^^^^^\n-LL | pub union Cloaked1 { _A: N16 }\n-   | ------------------------------ not a struct or enum\n-\n-error[E0517]: attribute should be applied to a struct or enum\n-  --> $DIR/repr-no-niche-inapplicable-to-unions.rs:10:8\n-   |\n-LL | #[repr(no_niche)]\n-   |        ^^^^^^^^\n-LL | pub union Cloaked2 { _A: N16, _B: (u8, N8) }\n-   | -------------------------------------------- not a struct or enum\n-\n-error: aborting due to 2 previous errors\n-\n-For more information about this error, try `rustc --explain E0517`."}, {"sha": "2e6064aeb00744f1e1c620fe8212fed9d3f28a04", "filename": "src/test/ui/repr/repr-no-niche.rs", "status": "removed", "additions": 0, "deletions": 327, "changes": 327, "blob_url": "https://github.com/rust-lang/rust/blob/0083cd2fd498edb6a4e37bf4c711d11364e0ef20/src%2Ftest%2Fui%2Frepr%2Frepr-no-niche.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0083cd2fd498edb6a4e37bf4c711d11364e0ef20/src%2Ftest%2Fui%2Frepr%2Frepr-no-niche.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frepr%2Frepr-no-niche.rs?ref=0083cd2fd498edb6a4e37bf4c711d11364e0ef20", "patch": "@@ -1,327 +0,0 @@\n-// run-pass\n-\n-// This file tests repr(no_niche), which causes an struct/enum to hide\n-// any niche space that may exist in its internal state from the\n-// context it appears in.\n-\n-// Here are the axes this test is seeking to cover:\n-//\n-// repr annotation:\n-// visible: (); cloaked: (no_niche); transparent: (transparent); shadowy: (transparent, no_niche)\n-//\n-// enum vs struct\n-//\n-// niche-type via type-parameter vs inline declaration\n-\n-#![feature(decl_macro)]\n-#![feature(no_niche)]\n-\n-use std::mem::size_of;\n-use std::num::{NonZeroU8, NonZeroU16};\n-\n-mod struct_inline {\n-    use std::num::NonZeroU16 as N16;\n-\n-    #[derive(Debug)] pub struct Visible(N16);\n-\n-    #[repr(no_niche)]\n-    #[derive(Debug)] pub struct Cloaked(N16);\n-\n-    #[repr(transparent)]\n-    #[derive(Debug)] pub struct Transparent(N16);\n-\n-    #[repr(transparent, no_niche)]\n-    #[derive(Debug)] pub struct Shadowy(N16);\n-}\n-\n-mod struct_param {\n-    #[derive(Debug)] pub struct Visible<T>(T);\n-\n-    #[repr(no_niche)]\n-    #[derive(Debug)] pub struct Cloaked<T>(T);\n-\n-    #[repr(transparent)]\n-    #[derive(Debug)] pub struct Transparent<T>(T);\n-\n-    #[repr(transparent, no_niche)]\n-    #[derive(Debug)] pub struct Shadowy<T>(T);\n-}\n-\n-mod enum_inline {\n-    use crate::two_fifty_six_variant_enum;\n-    use std::num::{NonZeroU8 as N8, NonZeroU16 as N16};\n-\n-    #[derive(Debug)] pub enum Visible1 { _A(N16), }\n-\n-    #[repr(no_niche)]\n-    #[derive(Debug)] pub enum Cloaked1 { _A(N16), }\n-\n-    // (N.B.: transparent enums must be univariant)\n-    #[repr(transparent)]\n-    #[derive(Debug)] pub enum Transparent { _A(N16), }\n-\n-    #[repr(transparent, no_niche)]\n-    #[derive(Debug)] pub enum Shadowy { _A(N16), }\n-\n-    // including multivariant enums for completeness. Payload and\n-    // number of variants (i.e. discriminant size) have been chosen so\n-    // that layout including discriminant is 4 bytes, with no space in\n-    // padding to hide another discrimnant from the surrounding\n-    // context.\n-    //\n-    // (Note that multivariant enums cannot usefully expose a niche in\n-    // general; this test is relying on that.)\n-    two_fifty_six_variant_enum!(Visible2, N8);\n-\n-    two_fifty_six_variant_enum!(#[repr(no_niche)] Cloaked2, N8);\n-}\n-\n-mod enum_param {\n-    use super::two_fifty_six_variant_enum;\n-\n-    #[derive(Debug)] pub enum Visible1<T> { _A(T), }\n-\n-    #[repr(no_niche)]\n-    #[derive(Debug)] pub enum Cloaked1<T> { _A(T), }\n-\n-    // (N.B.: transparent enums must be univariant)\n-    #[repr(transparent)]\n-    #[derive(Debug)] pub enum Transparent<T> { _A(T), }\n-\n-    #[repr(transparent, no_niche)]\n-    #[derive(Debug)] pub enum Shadowy<T> { _A(T), }\n-\n-    // including multivariant enums for completeness. Same notes apply\n-    // here as above (assuming `T` is instantiated with `NonZeroU8`).\n-    two_fifty_six_variant_enum!(Visible2<T>);\n-\n-    two_fifty_six_variant_enum!(#[repr(no_niche)] Cloaked2<T>);\n-}\n-\n-fn main() {\n-    // sanity-checks\n-    assert_eq!(size_of::<struct_inline::Visible>(),               2);\n-    assert_eq!(size_of::<struct_inline::Cloaked>(),               2);\n-    assert_eq!(size_of::<struct_inline::Transparent>(),           2);\n-    assert_eq!(size_of::<struct_inline::Shadowy>(),               2);\n-\n-    assert_eq!(size_of::<struct_param::Visible<NonZeroU16>>(), 2);\n-    assert_eq!(size_of::<struct_param::Cloaked<NonZeroU16>>(), 2);\n-    assert_eq!(size_of::<struct_param::Transparent<NonZeroU16>>(), 2);\n-    assert_eq!(size_of::<struct_param::Shadowy<NonZeroU16>>(), 2);\n-\n-    assert_eq!(size_of::<enum_inline::Visible1>(),    2);\n-    assert_eq!(size_of::<enum_inline::Cloaked1>(),    2);\n-    assert_eq!(size_of::<enum_inline::Transparent>(), 2); // transparent enums are univariant\n-    assert_eq!(size_of::<enum_inline::Shadowy>(),     2);\n-    assert_eq!(size_of::<enum_inline::Visible2>(),    4);\n-    assert_eq!(size_of::<enum_inline::Cloaked2>(),    4);\n-\n-    assert_eq!(size_of::<enum_param::Visible1<NonZeroU16>>(),    2);\n-    assert_eq!(size_of::<enum_param::Cloaked1<NonZeroU16>>(),    2);\n-    assert_eq!(size_of::<enum_param::Transparent<NonZeroU16>>(), 2);\n-    assert_eq!(size_of::<enum_param::Shadowy<NonZeroU16>>(),     2);\n-    assert_eq!(size_of::<enum_param::Visible2<NonZeroU8>>(),     4);\n-    assert_eq!(size_of::<enum_param::Cloaked2<NonZeroU8>>(),     4);\n-\n-    // now the actual tests of no_niche: how do inputs above compose\n-    // with `Option` type constructor. The cases with a `_+2` are the\n-    // ones where no_niche fires.\n-    assert_eq!(size_of::<Option<struct_inline::Visible>>(),       2);\n-    assert_eq!(size_of::<Option<struct_inline::Cloaked>>(),       2+2);\n-    assert_eq!(size_of::<Option<struct_inline::Transparent>>(),   2);\n-    assert_eq!(size_of::<Option<struct_inline::Shadowy>>(),       2+2);\n-\n-    assert_eq!(size_of::<Option<struct_param::Visible<NonZeroU16>>>(),     2);\n-    assert_eq!(size_of::<Option<struct_param::Cloaked<NonZeroU16>>>(),     2+2);\n-    assert_eq!(size_of::<Option<struct_param::Transparent<NonZeroU16>>>(), 2);\n-    assert_eq!(size_of::<Option<struct_param::Shadowy<NonZeroU16>>>(),     2+2);\n-\n-    assert_eq!(size_of::<Option<enum_inline::Visible1>>(),    2);\n-    assert_eq!(size_of::<Option<enum_inline::Cloaked1>>(),    2+2);\n-    assert_eq!(size_of::<Option<enum_inline::Transparent>>(), 2);\n-    assert_eq!(size_of::<Option<enum_inline::Shadowy>>(),     2+2);\n-    // cannot use niche of multivariant payload\n-    assert_eq!(size_of::<Option<enum_inline::Visible2>>(),    4+2);\n-    assert_eq!(size_of::<Option<enum_inline::Cloaked2>>(),    4+2);\n-\n-    assert_eq!(size_of::<Option<enum_param::Visible1<NonZeroU16>>>(),    2);\n-    assert_eq!(size_of::<Option<enum_param::Cloaked1<NonZeroU16>>>(),    2+2);\n-    assert_eq!(size_of::<Option<enum_param::Transparent<NonZeroU16>>>(), 2);\n-    assert_eq!(size_of::<Option<enum_param::Shadowy<NonZeroU16>>>(),     2+2);\n-    // cannot use niche of multivariant payload\n-    assert_eq!(size_of::<Option<enum_param::Visible2<NonZeroU8>>>(),    4+2);\n-    assert_eq!(size_of::<Option<enum_param::Cloaked2<NonZeroU8>>>(),    4+2);\n-}\n-\n-macro two_fifty_six_variant_enum {\n-    ($(#[$attr:meta])* $name:ident<$param:ident>) => {\n-        #[derive(Debug)] $(#[$attr])*\n-        pub enum $name<$param> {\n-            _V00($param, u16), _V01(u16, $param), _V02($param, u16), _V03(u16, $param),\n-            _V04($param, u16), _V05(u16, $param), _V06($param, u16), _V07(u16, $param),\n-            _V08($param, u16), _V09(u16, $param), _V0a($param, u16), _V0b(u16, $param),\n-            _V0c($param, u16), _V0d(u16, $param), _V0e($param, u16), _V0f(u16, $param),\n-\n-            _V10($param, u16), _V11(u16, $param), _V12($param, u16), _V13(u16, $param),\n-            _V14($param, u16), _V15(u16, $param), _V16($param, u16), _V17(u16, $param),\n-            _V18($param, u16), _V19(u16, $param), _V1a($param, u16), _V1b(u16, $param),\n-            _V1c($param, u16), _V1d(u16, $param), _V1e($param, u16), _V1f(u16, $param),\n-\n-            _V20($param, u16), _V21(u16, $param), _V22($param, u16), _V23(u16, $param),\n-            _V24($param, u16), _V25(u16, $param), _V26($param, u16), _V27(u16, $param),\n-            _V28($param, u16), _V29(u16, $param), _V2a($param, u16), _V2b(u16, $param),\n-            _V2c($param, u16), _V2d(u16, $param), _V2e($param, u16), _V2f(u16, $param),\n-\n-            _V30($param, u16), _V31(u16, $param), _V32($param, u16), _V33(u16, $param),\n-            _V34($param, u16), _V35(u16, $param), _V36($param, u16), _V37(u16, $param),\n-            _V38($param, u16), _V39(u16, $param), _V3a($param, u16), _V3b(u16, $param),\n-            _V3c($param, u16), _V3d(u16, $param), _V3e($param, u16), _V3f(u16, $param),\n-\n-            _V40($param, u16), _V41(u16, $param), _V42($param, u16), _V43(u16, $param),\n-            _V44($param, u16), _V45(u16, $param), _V46($param, u16), _V47(u16, $param),\n-            _V48($param, u16), _V49(u16, $param), _V4a($param, u16), _V4b(u16, $param),\n-            _V4c($param, u16), _V4d(u16, $param), _V4e($param, u16), _V4f(u16, $param),\n-\n-            _V50($param, u16), _V51(u16, $param), _V52($param, u16), _V53(u16, $param),\n-            _V54($param, u16), _V55(u16, $param), _V56($param, u16), _V57(u16, $param),\n-            _V58($param, u16), _V59(u16, $param), _V5a($param, u16), _V5b(u16, $param),\n-            _V5c($param, u16), _V5d(u16, $param), _V5e($param, u16), _V5f(u16, $param),\n-\n-            _V60($param, u16), _V61(u16, $param), _V62($param, u16), _V63(u16, $param),\n-            _V64($param, u16), _V65(u16, $param), _V66($param, u16), _V67(u16, $param),\n-            _V68($param, u16), _V69(u16, $param), _V6a($param, u16), _V6b(u16, $param),\n-            _V6c($param, u16), _V6d(u16, $param), _V6e($param, u16), _V6f(u16, $param),\n-\n-            _V70($param, u16), _V71(u16, $param), _V72($param, u16), _V73(u16, $param),\n-            _V74($param, u16), _V75(u16, $param), _V76($param, u16), _V77(u16, $param),\n-            _V78($param, u16), _V79(u16, $param), _V7a($param, u16), _V7b(u16, $param),\n-            _V7c($param, u16), _V7d(u16, $param), _V7e($param, u16), _V7f(u16, $param),\n-\n-            _V80($param, u16), _V81(u16, $param), _V82($param, u16), _V83(u16, $param),\n-            _V84($param, u16), _V85(u16, $param), _V86($param, u16), _V87(u16, $param),\n-            _V88($param, u16), _V89(u16, $param), _V8a($param, u16), _V8b(u16, $param),\n-            _V8c($param, u16), _V8d(u16, $param), _V8e($param, u16), _V8f(u16, $param),\n-\n-            _V90($param, u16), _V91(u16, $param), _V92($param, u16), _V93(u16, $param),\n-            _V94($param, u16), _V95(u16, $param), _V96($param, u16), _V97(u16, $param),\n-            _V98($param, u16), _V99(u16, $param), _V9a($param, u16), _V9b(u16, $param),\n-            _V9c($param, u16), _V9d(u16, $param), _V9e($param, u16), _V9f(u16, $param),\n-\n-            _Va0($param, u16), _Va1(u16, $param), _Va2($param, u16), _Va3(u16, $param),\n-            _Va4($param, u16), _Va5(u16, $param), _Va6($param, u16), _Va7(u16, $param),\n-            _Va8($param, u16), _Va9(u16, $param), _Vaa($param, u16), _Vab(u16, $param),\n-            _Vac($param, u16), _Vad(u16, $param), _Vae($param, u16), _Vaf(u16, $param),\n-\n-            _Vb0($param, u16), _Vb1(u16, $param), _Vb2($param, u16), _Vb3(u16, $param),\n-            _Vb4($param, u16), _Vb5(u16, $param), _Vb6($param, u16), _Vb7(u16, $param),\n-            _Vb8($param, u16), _Vb9(u16, $param), _Vba($param, u16), _Vbb(u16, $param),\n-            _Vbc($param, u16), _Vbd(u16, $param), _Vbe($param, u16), _Vbf(u16, $param),\n-\n-            _Vc0($param, u16), _Vc1(u16, $param), _Vc2($param, u16), _Vc3(u16, $param),\n-            _Vc4($param, u16), _Vc5(u16, $param), _Vc6($param, u16), _Vc7(u16, $param),\n-            _Vc8($param, u16), _Vc9(u16, $param), _Vca($param, u16), _Vcb(u16, $param),\n-            _Vcc($param, u16), _Vcd(u16, $param), _Vce($param, u16), _Vcf(u16, $param),\n-\n-            _Vd0($param, u16), _Vd1(u16, $param), _Vd2($param, u16), _Vd3(u16, $param),\n-            _Vd4($param, u16), _Vd5(u16, $param), _Vd6($param, u16), _Vd7(u16, $param),\n-            _Vd8($param, u16), _Vd9(u16, $param), _Vda($param, u16), _Vdb(u16, $param),\n-            _Vdc($param, u16), _Vdd(u16, $param), _Vde($param, u16), _Vdf(u16, $param),\n-\n-            _Ve0($param, u16), _Ve1(u16, $param), _Ve2($param, u16), _Ve3(u16, $param),\n-            _Ve4($param, u16), _Ve5(u16, $param), _Ve6($param, u16), _Ve7(u16, $param),\n-            _Ve8($param, u16), _Ve9(u16, $param), _Vea($param, u16), _Veb(u16, $param),\n-            _Vec($param, u16), _Ved(u16, $param), _Vee($param, u16), _Vef(u16, $param),\n-\n-            _Vf0($param, u16), _Vf1(u16, $param), _Vf2($param, u16), _Vf3(u16, $param),\n-            _Vf4($param, u16), _Vf5(u16, $param), _Vf6($param, u16), _Vf7(u16, $param),\n-            _Vf8($param, u16), _Vf9(u16, $param), _Vfa($param, u16), _Vfb(u16, $param),\n-            _Vfc($param, u16), _Vfd(u16, $param), _Vfe($param, u16), _Vff(u16, $param),\n-        }\n-    },\n-\n-    ($(#[$attr:meta])* $name:ident, $param:ty) => {\n-        #[derive(Debug)] $(#[$attr])*\n-        pub enum $name {\n-            _V00($param, u16), _V01(u16, $param), _V02($param, u16), _V03(u16, $param),\n-            _V04($param, u16), _V05(u16, $param), _V06($param, u16), _V07(u16, $param),\n-            _V08($param, u16), _V09(u16, $param), _V0a($param, u16), _V0b(u16, $param),\n-            _V0c($param, u16), _V0d(u16, $param), _V0e($param, u16), _V0f(u16, $param),\n-\n-            _V10($param, u16), _V11(u16, $param), _V12($param, u16), _V13(u16, $param),\n-            _V14($param, u16), _V15(u16, $param), _V16($param, u16), _V17(u16, $param),\n-            _V18($param, u16), _V19(u16, $param), _V1a($param, u16), _V1b(u16, $param),\n-            _V1c($param, u16), _V1d(u16, $param), _V1e($param, u16), _V1f(u16, $param),\n-\n-            _V20($param, u16), _V21(u16, $param), _V22($param, u16), _V23(u16, $param),\n-            _V24($param, u16), _V25(u16, $param), _V26($param, u16), _V27(u16, $param),\n-            _V28($param, u16), _V29(u16, $param), _V2a($param, u16), _V2b(u16, $param),\n-            _V2c($param, u16), _V2d(u16, $param), _V2e($param, u16), _V2f(u16, $param),\n-\n-            _V30($param, u16), _V31(u16, $param), _V32($param, u16), _V33(u16, $param),\n-            _V34($param, u16), _V35(u16, $param), _V36($param, u16), _V37(u16, $param),\n-            _V38($param, u16), _V39(u16, $param), _V3a($param, u16), _V3b(u16, $param),\n-            _V3c($param, u16), _V3d(u16, $param), _V3e($param, u16), _V3f(u16, $param),\n-\n-            _V40($param, u16), _V41(u16, $param), _V42($param, u16), _V43(u16, $param),\n-            _V44($param, u16), _V45(u16, $param), _V46($param, u16), _V47(u16, $param),\n-            _V48($param, u16), _V49(u16, $param), _V4a($param, u16), _V4b(u16, $param),\n-            _V4c($param, u16), _V4d(u16, $param), _V4e($param, u16), _V4f(u16, $param),\n-\n-            _V50($param, u16), _V51(u16, $param), _V52($param, u16), _V53(u16, $param),\n-            _V54($param, u16), _V55(u16, $param), _V56($param, u16), _V57(u16, $param),\n-            _V58($param, u16), _V59(u16, $param), _V5a($param, u16), _V5b(u16, $param),\n-            _V5c($param, u16), _V5d(u16, $param), _V5e($param, u16), _V5f(u16, $param),\n-\n-            _V60($param, u16), _V61(u16, $param), _V62($param, u16), _V63(u16, $param),\n-            _V64($param, u16), _V65(u16, $param), _V66($param, u16), _V67(u16, $param),\n-            _V68($param, u16), _V69(u16, $param), _V6a($param, u16), _V6b(u16, $param),\n-            _V6c($param, u16), _V6d(u16, $param), _V6e($param, u16), _V6f(u16, $param),\n-\n-            _V70($param, u16), _V71(u16, $param), _V72($param, u16), _V73(u16, $param),\n-            _V74($param, u16), _V75(u16, $param), _V76($param, u16), _V77(u16, $param),\n-            _V78($param, u16), _V79(u16, $param), _V7a($param, u16), _V7b(u16, $param),\n-            _V7c($param, u16), _V7d(u16, $param), _V7e($param, u16), _V7f(u16, $param),\n-\n-            _V80($param, u16), _V81(u16, $param), _V82($param, u16), _V83(u16, $param),\n-            _V84($param, u16), _V85(u16, $param), _V86($param, u16), _V87(u16, $param),\n-            _V88($param, u16), _V89(u16, $param), _V8a($param, u16), _V8b(u16, $param),\n-            _V8c($param, u16), _V8d(u16, $param), _V8e($param, u16), _V8f(u16, $param),\n-\n-            _V90($param, u16), _V91(u16, $param), _V92($param, u16), _V93(u16, $param),\n-            _V94($param, u16), _V95(u16, $param), _V96($param, u16), _V97(u16, $param),\n-            _V98($param, u16), _V99(u16, $param), _V9a($param, u16), _V9b(u16, $param),\n-            _V9c($param, u16), _V9d(u16, $param), _V9e($param, u16), _V9f(u16, $param),\n-\n-            _Va0($param, u16), _Va1(u16, $param), _Va2($param, u16), _Va3(u16, $param),\n-            _Va4($param, u16), _Va5(u16, $param), _Va6($param, u16), _Va7(u16, $param),\n-            _Va8($param, u16), _Va9(u16, $param), _Vaa($param, u16), _Vab(u16, $param),\n-            _Vac($param, u16), _Vad(u16, $param), _Vae($param, u16), _Vaf(u16, $param),\n-\n-            _Vb0($param, u16), _Vb1(u16, $param), _Vb2($param, u16), _Vb3(u16, $param),\n-            _Vb4($param, u16), _Vb5(u16, $param), _Vb6($param, u16), _Vb7(u16, $param),\n-            _Vb8($param, u16), _Vb9(u16, $param), _Vba($param, u16), _Vbb(u16, $param),\n-            _Vbc($param, u16), _Vbd(u16, $param), _Vbe($param, u16), _Vbf(u16, $param),\n-\n-            _Vc0($param, u16), _Vc1(u16, $param), _Vc2($param, u16), _Vc3(u16, $param),\n-            _Vc4($param, u16), _Vc5(u16, $param), _Vc6($param, u16), _Vc7(u16, $param),\n-            _Vc8($param, u16), _Vc9(u16, $param), _Vca($param, u16), _Vcb(u16, $param),\n-            _Vcc($param, u16), _Vcd(u16, $param), _Vce($param, u16), _Vcf(u16, $param),\n-\n-            _Vd0($param, u16), _Vd1(u16, $param), _Vd2($param, u16), _Vd3(u16, $param),\n-            _Vd4($param, u16), _Vd5(u16, $param), _Vd6($param, u16), _Vd7(u16, $param),\n-            _Vd8($param, u16), _Vd9(u16, $param), _Vda($param, u16), _Vdb(u16, $param),\n-            _Vdc($param, u16), _Vdd(u16, $param), _Vde($param, u16), _Vdf(u16, $param),\n-\n-            _Ve0($param, u16), _Ve1(u16, $param), _Ve2($param, u16), _Ve3(u16, $param),\n-            _Ve4($param, u16), _Ve5(u16, $param), _Ve6($param, u16), _Ve7(u16, $param),\n-            _Ve8($param, u16), _Ve9(u16, $param), _Vea($param, u16), _Veb(u16, $param),\n-            _Vec($param, u16), _Ved(u16, $param), _Vee($param, u16), _Vef(u16, $param),\n-\n-            _Vf0($param, u16), _Vf1(u16, $param), _Vf2($param, u16), _Vf3(u16, $param),\n-            _Vf4($param, u16), _Vf5(u16, $param), _Vf6($param, u16), _Vf7(u16, $param),\n-            _Vf8($param, u16), _Vf9(u16, $param), _Vfa($param, u16), _Vfb(u16, $param),\n-            _Vfc($param, u16), _Vfd(u16, $param), _Vfe($param, u16), _Vff(u16, $param),\n-        }\n-    }\n-}"}, {"sha": "6bce5fbd4c1fecf24cb1144fa812569186834f26", "filename": "src/tools/clippy/clippy_lints/src/non_copy_const.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fnon_copy_const.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fnon_copy_const.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fnon_copy_const.rs?ref=1e7d04b23b6e9d177e7d879b05b4ce3f00ee5a0e", "patch": "@@ -148,7 +148,7 @@ fn is_value_unfrozen_raw<'tcx>(\n         match val.ty().kind() {\n             // the fact that we have to dig into every structs to search enums\n             // leads us to the point checking `UnsafeCell` directly is the only option.\n-            ty::Adt(ty_def, ..) if Some(ty_def.did()) == cx.tcx.lang_items().unsafe_cell_type() => true,\n+            ty::Adt(ty_def, ..) if ty_def.is_unsafe_cell() => true,\n             ty::Array(..) | ty::Adt(..) | ty::Tuple(..) => {\n                 let val = cx.tcx.destructure_mir_constant(cx.param_env, val);\n                 val.fields.iter().any(|field| inner(cx, *field))"}]}