{"sha": "66a376ea4f8caf9049c90888c1c1caa9a109b02c", "node_id": "MDY6Q29tbWl0NzI0NzEyOjY2YTM3NmVhNGY4Y2FmOTA0OWM5MDg4OGMxYzFjYWE5YTEwOWIwMmM=", "commit": {"author": {"name": "John K\u00e5re Alsaker", "email": "john.kare.alsaker@gmail.com", "date": "2018-12-30T20:19:11Z"}, "committer": {"name": "John K\u00e5re Alsaker", "email": "john.kare.alsaker@gmail.com", "date": "2019-05-31T08:21:34Z"}, "message": "Store CtxtInterners for local values in AllArenas", "tree": {"sha": "a5cc2f55b9c1bec57db3f3cf3924e7b70675b435", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a5cc2f55b9c1bec57db3f3cf3924e7b70675b435"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/66a376ea4f8caf9049c90888c1c1caa9a109b02c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/66a376ea4f8caf9049c90888c1c1caa9a109b02c", "html_url": "https://github.com/rust-lang/rust/commit/66a376ea4f8caf9049c90888c1c1caa9a109b02c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/66a376ea4f8caf9049c90888c1c1caa9a109b02c/comments", "author": {"login": "Zoxc", "id": 25784, "node_id": "MDQ6VXNlcjI1Nzg0", "avatar_url": "https://avatars.githubusercontent.com/u/25784?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Zoxc", "html_url": "https://github.com/Zoxc", "followers_url": "https://api.github.com/users/Zoxc/followers", "following_url": "https://api.github.com/users/Zoxc/following{/other_user}", "gists_url": "https://api.github.com/users/Zoxc/gists{/gist_id}", "starred_url": "https://api.github.com/users/Zoxc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Zoxc/subscriptions", "organizations_url": "https://api.github.com/users/Zoxc/orgs", "repos_url": "https://api.github.com/users/Zoxc/repos", "events_url": "https://api.github.com/users/Zoxc/events{/privacy}", "received_events_url": "https://api.github.com/users/Zoxc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Zoxc", "id": 25784, "node_id": "MDQ6VXNlcjI1Nzg0", "avatar_url": "https://avatars.githubusercontent.com/u/25784?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Zoxc", "html_url": "https://github.com/Zoxc", "followers_url": "https://api.github.com/users/Zoxc/followers", "following_url": "https://api.github.com/users/Zoxc/following{/other_user}", "gists_url": "https://api.github.com/users/Zoxc/gists{/gist_id}", "starred_url": "https://api.github.com/users/Zoxc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Zoxc/subscriptions", "organizations_url": "https://api.github.com/users/Zoxc/orgs", "repos_url": "https://api.github.com/users/Zoxc/repos", "events_url": "https://api.github.com/users/Zoxc/events{/privacy}", "received_events_url": "https://api.github.com/users/Zoxc/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3ade426ede7bca4a74bc641a12f2e7fe2cc20c47", "url": "https://api.github.com/repos/rust-lang/rust/commits/3ade426ede7bca4a74bc641a12f2e7fe2cc20c47", "html_url": "https://github.com/rust-lang/rust/commit/3ade426ede7bca4a74bc641a12f2e7fe2cc20c47"}], "stats": {"total": 57, "additions": 30, "deletions": 27}, "files": [{"sha": "4414e677fb5b758adb599c7299d1ae81e39ff6ef", "filename": "src/librustc/infer/mod.rs", "status": "modified", "additions": 2, "deletions": 11, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/66a376ea4f8caf9049c90888c1c1caa9a109b02c/src%2Flibrustc%2Finfer%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/66a376ea4f8caf9049c90888c1c1caa9a109b02c/src%2Flibrustc%2Finfer%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Finfer%2Fmod.rs?ref=66a376ea4f8caf9049c90888c1c1caa9a109b02c", "patch": "@@ -21,11 +21,10 @@ use crate::ty::error::{ExpectedFound, TypeError, UnconstrainedNumeric};\n use crate::ty::fold::{TypeFolder, TypeFoldable};\n use crate::ty::relate::RelateResult;\n use crate::ty::subst::{Kind, InternalSubsts, SubstsRef};\n-use crate::ty::{self, GenericParamDefKind, Ty, TyCtxt, CtxtInterners, InferConst};\n+use crate::ty::{self, GenericParamDefKind, Ty, TyCtxt, InferConst};\n use crate::ty::{FloatVid, IntVid, TyVid, ConstVid};\n use crate::util::nodemap::FxHashMap;\n \n-use arena::SyncDroplessArena;\n use errors::DiagnosticBuilder;\n use rustc_data_structures::unify as ut;\n use std::cell::{Cell, Ref, RefCell, RefMut};\n@@ -468,17 +467,13 @@ impl<'tcx> fmt::Display for FixupError<'tcx> {\n /// `F: for<'b, 'tcx> where 'gcx: 'tcx FnOnce(InferCtxt<'b, 'gcx, 'tcx>)`.\n pub struct InferCtxtBuilder<'a, 'gcx: 'a + 'tcx, 'tcx: 'a> {\n     global_tcx: TyCtxt<'a, 'gcx, 'gcx>,\n-    arena: SyncDroplessArena,\n-    interners: Option<CtxtInterners<'tcx>>,\n     fresh_tables: Option<RefCell<ty::TypeckTables<'tcx>>>,\n }\n \n impl<'a, 'gcx, 'tcx> TyCtxt<'a, 'gcx, 'gcx> {\n     pub fn infer_ctxt(self) -> InferCtxtBuilder<'a, 'gcx, 'tcx> {\n         InferCtxtBuilder {\n             global_tcx: self,\n-            arena: SyncDroplessArena::default(),\n-            interners: None,\n             fresh_tables: None,\n         }\n     }\n@@ -518,14 +513,10 @@ impl<'a, 'gcx, 'tcx> InferCtxtBuilder<'a, 'gcx, 'tcx> {\n     pub fn enter<R>(&'tcx mut self, f: impl for<'b> FnOnce(InferCtxt<'b, 'gcx, 'tcx>) -> R) -> R {\n         let InferCtxtBuilder {\n             global_tcx,\n-            ref arena,\n-            ref mut interners,\n             ref fresh_tables,\n         } = *self;\n         let in_progress_tables = fresh_tables.as_ref();\n-        // Check that we haven't entered before\n-        assert!(interners.is_none());\n-        global_tcx.enter_local(arena, interners, |tcx| {\n+        global_tcx.enter_local(|tcx| {\n             f(InferCtxt {\n                 tcx,\n                 in_progress_tables,"}, {"sha": "d8f66eb1c8048d0bf34ba209ad2d71eb424f30a1", "filename": "src/librustc/ty/context.rs", "status": "modified", "additions": 28, "deletions": 16, "changes": 44, "blob_url": "https://github.com/rust-lang/rust/blob/66a376ea4f8caf9049c90888c1c1caa9a109b02c/src%2Flibrustc%2Fty%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/66a376ea4f8caf9049c90888c1c1caa9a109b02c/src%2Flibrustc%2Fty%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fcontext.rs?ref=66a376ea4f8caf9049c90888c1c1caa9a109b02c", "patch": "@@ -82,13 +82,15 @@ use crate::hir;\n pub struct AllArenas<'tcx> {\n     pub global: WorkerLocal<GlobalArenas<'tcx>>,\n     pub interner: SyncDroplessArena,\n+    pub local_interner: SyncDroplessArena,\n }\n \n impl<'tcx> AllArenas<'tcx> {\n     pub fn new() -> Self {\n         AllArenas {\n             global: WorkerLocal::new(|_| GlobalArenas::default()),\n             interner: SyncDroplessArena::default(),\n+            local_interner: SyncDroplessArena::default(),\n         }\n     }\n }\n@@ -154,7 +156,7 @@ impl<'gcx: 'tcx, 'tcx> CtxtInterners<'tcx> {\n     /// Intern a type\n     #[inline(never)]\n     fn intern_ty(\n-        local: &CtxtInterners<'tcx>,\n+        local: &CtxtInterners<'gcx>,\n         global: &CtxtInterners<'gcx>,\n         st: TyKind<'tcx>\n     ) -> Ty<'tcx> {\n@@ -179,6 +181,12 @@ impl<'gcx: 'tcx, 'tcx> CtxtInterners<'tcx> {\n                         &ty_struct);\n                 }\n \n+                // This is safe because all the types the ty_struct can point to\n+                // already is in the local arena or the global arena\n+                let ty_struct: TyS<'gcx> = unsafe {\n+                    mem::transmute(ty_struct)\n+                };\n+\n                 Interned(local.arena.alloc(ty_struct))\n             }).0\n         } else {\n@@ -1029,8 +1037,8 @@ pub struct FreeRegionInfo {\n #[derive(Copy, Clone)]\n pub struct TyCtxt<'a, 'gcx: 'tcx, 'tcx: 'a> {\n     gcx: &'gcx GlobalCtxt<'gcx>,\n-    interners: &'tcx CtxtInterners<'tcx>,\n-    dummy: PhantomData<&'a ()>,\n+    interners: &'gcx CtxtInterners<'gcx>,\n+    dummy: PhantomData<(&'a (), &'tcx ())>,\n }\n \n impl<'gcx> Deref for TyCtxt<'_, 'gcx, '_> {\n@@ -1045,6 +1053,7 @@ pub struct GlobalCtxt<'tcx> {\n     pub arena: WorkerLocal<Arena<'tcx>>,\n     global_arenas: &'tcx WorkerLocal<GlobalArenas<'tcx>>,\n     global_interners: CtxtInterners<'tcx>,\n+    local_interners: CtxtInterners<'tcx>,\n \n     cstore: &'tcx CrateStoreDyn,\n \n@@ -1262,6 +1271,7 @@ impl<'a, 'gcx, 'tcx> TyCtxt<'a, 'gcx, 'tcx> {\n             s.fatal(&err);\n         });\n         let interners = CtxtInterners::new(&arenas.interner);\n+        let local_interners = CtxtInterners::new(&arenas.local_interner);\n         let common = Common {\n             empty_predicates: ty::GenericPredicates {\n                 parent: None,\n@@ -1321,6 +1331,7 @@ impl<'a, 'gcx, 'tcx> TyCtxt<'a, 'gcx, 'tcx> {\n             arena: WorkerLocal::new(|_| Arena::default()),\n             global_arenas: &arenas.global,\n             global_interners: interners,\n+            local_interners: local_interners,\n             dep_graph,\n             common,\n             types: common_types,\n@@ -1716,18 +1727,15 @@ impl<'gcx> GlobalCtxt<'gcx> {\n     /// with the same lifetime as `arena`.\n     pub fn enter_local<'tcx, F, R>(\n         &'gcx self,\n-        arena: &'tcx SyncDroplessArena,\n-        interners: &'tcx mut Option<CtxtInterners<'tcx>>,\n         f: F\n     ) -> R\n     where\n         F: FnOnce(TyCtxt<'tcx, 'gcx, 'tcx>) -> R,\n         'gcx: 'tcx,\n     {\n-        *interners = Some(CtxtInterners::new(&arena));\n         let tcx = TyCtxt {\n             gcx: self,\n-            interners: interners.as_ref().unwrap(),\n+            interners: &self.local_interners,\n             dummy: PhantomData,\n         };\n         ty::tls::with_related_context(tcx.global_tcx(), |icx| {\n@@ -2333,6 +2341,17 @@ macro_rules! intern_method {\n             pub fn $method(self, v: $alloc) -> &$lt_tcx $ty {\n                 let key = ($alloc_to_key)(&v);\n \n+                let alloc = |v, interners: &'gcx CtxtInterners<'gcx>| {\n+                    // This transmutes $alloc<'tcx> to $alloc<'gcx>\n+                    let v = unsafe {\n+                        mem::transmute(v)\n+                    };\n+                    let i: &$lt_tcx $ty = $alloc_method(&interners.arena, v);\n+                    // Cast to 'gcx\n+                    let i = unsafe { mem::transmute(i) };\n+                    Interned(i)\n+                };\n+\n                 // HACK(eddyb) Depend on flags being accurate to\n                 // determine that all contents are in the global tcx.\n                 // See comments on Lift for why we can't use that.\n@@ -2346,18 +2365,11 @@ macro_rules! intern_method {\n                                 v);\n                         }\n \n-                        Interned($alloc_method(&self.interners.arena, v))\n+                        alloc(v, &self.interners)\n                     }).0\n                 } else {\n                     self.global_interners.$name.borrow_mut().intern_ref(key, || {\n-                        // This transmutes $alloc<'tcx> to $alloc<'gcx>\n-                        let v = unsafe {\n-                            mem::transmute(v)\n-                        };\n-                        let i: &$lt_tcx $ty = $alloc_method(&self.global_interners.arena, v);\n-                        // Cast to 'gcx\n-                        let i = unsafe { mem::transmute(i) };\n-                        Interned(i)\n+                        alloc(v, &self.global_interners)\n                     }).0\n                 }\n             }"}]}