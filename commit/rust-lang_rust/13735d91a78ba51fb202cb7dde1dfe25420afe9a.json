{"sha": "13735d91a78ba51fb202cb7dde1dfe25420afe9a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjEzNzM1ZDkxYTc4YmE1MWZiMjAyY2I3ZGRlMWRmZTI1NDIwYWZlOWE=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-11-02T20:42:38Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-11-02T20:42:38Z"}, "message": "Move diagnostics to hir_expand", "tree": {"sha": "fba691ea156533fe490d4dfec04b262ae2f73f7d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fba691ea156533fe490d4dfec04b262ae2f73f7d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/13735d91a78ba51fb202cb7dde1dfe25420afe9a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/13735d91a78ba51fb202cb7dde1dfe25420afe9a", "html_url": "https://github.com/rust-lang/rust/commit/13735d91a78ba51fb202cb7dde1dfe25420afe9a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/13735d91a78ba51fb202cb7dde1dfe25420afe9a/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b8533413cf082f2d942b78af841e3895db252106", "url": "https://api.github.com/repos/rust-lang/rust/commits/b8533413cf082f2d942b78af841e3895db252106", "html_url": "https://github.com/rust-lang/rust/commit/b8533413cf082f2d942b78af841e3895db252106"}], "stats": {"total": 196, "additions": 107, "deletions": 89}, "files": [{"sha": "5b78bdfef389e99b1df5c23f36525e45ebf9f824", "filename": "crates/ra_hir/src/code_model.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/13735d91a78ba51fb202cb7dde1dfe25420afe9a/crates%2Fra_hir%2Fsrc%2Fcode_model.rs", "raw_url": "https://github.com/rust-lang/rust/raw/13735d91a78ba51fb202cb7dde1dfe25420afe9a/crates%2Fra_hir%2Fsrc%2Fcode_model.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fcode_model.rs?ref=13735d91a78ba51fb202cb7dde1dfe25420afe9a", "patch": "@@ -11,14 +11,16 @@ use hir_def::{\n     type_ref::{Mutability, TypeRef},\n     CrateModuleId, LocalEnumVariantId, LocalStructFieldId, ModuleId,\n };\n-use hir_expand::name::{self, AsName};\n+use hir_expand::{\n+    diagnostics::DiagnosticSink,\n+    name::{self, AsName},\n+};\n use ra_db::{CrateId, Edition};\n use ra_syntax::ast::{self, NameOwner, TypeAscriptionOwner};\n \n use crate::{\n     adt::VariantDef,\n     db::{AstDatabase, DefDatabase, HirDatabase},\n-    diagnostics::DiagnosticSink,\n     expr::{validation::ExprValidator, Body, BodySourceMap},\n     generics::HasGenericParams,\n     ids::{"}, {"sha": "a33af8f467534346c52b17ad7f9facd21d30cb46", "filename": "crates/ra_hir/src/diagnostics.rs", "status": "modified", "additions": 6, "deletions": 75, "changes": 81, "blob_url": "https://github.com/rust-lang/rust/blob/13735d91a78ba51fb202cb7dde1dfe25420afe9a/crates%2Fra_hir%2Fsrc%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/13735d91a78ba51fb202cb7dde1dfe25420afe9a/crates%2Fra_hir%2Fsrc%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fdiagnostics.rs?ref=13735d91a78ba51fb202cb7dde1dfe25420afe9a", "patch": "@@ -1,82 +1,13 @@\n //! FIXME: write short doc here\n \n-use std::{any::Any, fmt};\n+use std::any::Any;\n \n-use ra_syntax::{ast, AstNode, AstPtr, SyntaxNode, SyntaxNodePtr, TextRange};\n+use ra_syntax::{ast, AstNode, AstPtr, SyntaxNodePtr};\n use relative_path::RelativePathBuf;\n \n-use crate::{db::HirDatabase, HirFileId, Name, Source};\n-\n-/// Diagnostic defines hir API for errors and warnings.\n-///\n-/// It is used as a `dyn` object, which you can downcast to a concrete\n-/// diagnostic. DiagnosticSink are structured, meaning that they include rich\n-/// information which can be used by IDE to create fixes. DiagnosticSink are\n-/// expressed in terms of macro-expanded syntax tree nodes (so, it's a bad idea\n-/// to diagnostic in a salsa value).\n-///\n-/// Internally, various subsystems of hir produce diagnostics specific to a\n-/// subsystem (typically, an `enum`), which are safe to store in salsa but do not\n-/// include source locations. Such internal diagnostic are transformed into an\n-/// instance of `Diagnostic` on demand.\n-pub trait Diagnostic: Any + Send + Sync + fmt::Debug + 'static {\n-    fn message(&self) -> String;\n-    fn source(&self) -> Source<SyntaxNodePtr>;\n-    fn highlight_range(&self) -> TextRange {\n-        self.source().ast.range()\n-    }\n-    fn as_any(&self) -> &(dyn Any + Send + 'static);\n-}\n-\n-pub trait AstDiagnostic {\n-    type AST;\n-    fn ast(&self, db: &impl HirDatabase) -> Self::AST;\n-}\n-\n-impl dyn Diagnostic {\n-    pub fn syntax_node(&self, db: &impl HirDatabase) -> SyntaxNode {\n-        let node = db.parse_or_expand(self.source().file_id).unwrap();\n-        self.source().ast.to_node(&node)\n-    }\n-\n-    pub fn downcast_ref<D: Diagnostic>(&self) -> Option<&D> {\n-        self.as_any().downcast_ref()\n-    }\n-}\n+use crate::{db::AstDatabase, HirFileId, Name, Source};\n \n-pub struct DiagnosticSink<'a> {\n-    callbacks: Vec<Box<dyn FnMut(&dyn Diagnostic) -> Result<(), ()> + 'a>>,\n-    default_callback: Box<dyn FnMut(&dyn Diagnostic) + 'a>,\n-}\n-\n-impl<'a> DiagnosticSink<'a> {\n-    pub fn new(cb: impl FnMut(&dyn Diagnostic) + 'a) -> DiagnosticSink<'a> {\n-        DiagnosticSink { callbacks: Vec::new(), default_callback: Box::new(cb) }\n-    }\n-\n-    pub fn on<D: Diagnostic, F: FnMut(&D) + 'a>(mut self, mut cb: F) -> DiagnosticSink<'a> {\n-        let cb = move |diag: &dyn Diagnostic| match diag.downcast_ref::<D>() {\n-            Some(d) => {\n-                cb(d);\n-                Ok(())\n-            }\n-            None => Err(()),\n-        };\n-        self.callbacks.push(Box::new(cb));\n-        self\n-    }\n-\n-    pub(crate) fn push(&mut self, d: impl Diagnostic) {\n-        let d: &dyn Diagnostic = &d;\n-        for cb in self.callbacks.iter_mut() {\n-            match cb(d) {\n-                Ok(()) => return,\n-                Err(()) => (),\n-            }\n-        }\n-        (self.default_callback)(d)\n-    }\n-}\n+pub use hir_expand::diagnostics::{AstDiagnostic, Diagnostic, DiagnosticSink};\n \n #[derive(Debug)]\n pub struct NoSuchField {\n@@ -139,7 +70,7 @@ impl Diagnostic for MissingFields {\n impl AstDiagnostic for MissingFields {\n     type AST = ast::RecordFieldList;\n \n-    fn ast(&self, db: &impl HirDatabase) -> Self::AST {\n+    fn ast(&self, db: &impl AstDatabase) -> Self::AST {\n         let root = db.parse_or_expand(self.source().file_id).unwrap();\n         let node = self.source().ast.to_node(&root);\n         ast::RecordFieldList::cast(node).unwrap()\n@@ -167,7 +98,7 @@ impl Diagnostic for MissingOkInTailExpr {\n impl AstDiagnostic for MissingOkInTailExpr {\n     type AST = ast::Expr;\n \n-    fn ast(&self, db: &impl HirDatabase) -> Self::AST {\n+    fn ast(&self, db: &impl AstDatabase) -> Self::AST {\n         let root = db.parse_or_expand(self.file).unwrap();\n         let node = self.source().ast.to_node(&root);\n         ast::Expr::cast(node).unwrap()"}, {"sha": "3054f1dcedf405270db5e98109734d55d5666e31", "filename": "crates/ra_hir/src/expr/validation.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/13735d91a78ba51fb202cb7dde1dfe25420afe9a/crates%2Fra_hir%2Fsrc%2Fexpr%2Fvalidation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/13735d91a78ba51fb202cb7dde1dfe25420afe9a/crates%2Fra_hir%2Fsrc%2Fexpr%2Fvalidation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fexpr%2Fvalidation.rs?ref=13735d91a78ba51fb202cb7dde1dfe25420afe9a", "patch": "@@ -3,12 +3,13 @@\n use std::sync::Arc;\n \n use hir_def::path::known;\n+use hir_expand::diagnostics::DiagnosticSink;\n use ra_syntax::ast;\n use rustc_hash::FxHashSet;\n \n use crate::{\n     db::HirDatabase,\n-    diagnostics::{DiagnosticSink, MissingFields, MissingOkInTailExpr},\n+    diagnostics::{MissingFields, MissingOkInTailExpr},\n     expr::AstPtr,\n     ty::{ApplicationTy, InferenceResult, Ty, TypeCtor},\n     Adt, Function, Name, Path,"}, {"sha": "4c89c8d384381ddb4773602f04fa339632f8474a", "filename": "crates/ra_hir/src/mock.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/13735d91a78ba51fb202cb7dde1dfe25420afe9a/crates%2Fra_hir%2Fsrc%2Fmock.rs", "raw_url": "https://github.com/rust-lang/rust/raw/13735d91a78ba51fb202cb7dde1dfe25420afe9a/crates%2Fra_hir%2Fsrc%2Fmock.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fmock.rs?ref=13735d91a78ba51fb202cb7dde1dfe25420afe9a", "patch": "@@ -2,6 +2,7 @@\n \n use std::{panic, sync::Arc};\n \n+use hir_expand::diagnostics::DiagnosticSink;\n use parking_lot::Mutex;\n use ra_cfg::CfgOptions;\n use ra_db::{\n@@ -12,7 +13,7 @@ use relative_path::{RelativePath, RelativePathBuf};\n use rustc_hash::FxHashMap;\n use test_utils::{extract_offset, parse_fixture, CURSOR_MARKER};\n \n-use crate::{db, debug::HirDebugHelper, diagnostics::DiagnosticSink};\n+use crate::{db, debug::HirDebugHelper};\n \n pub const WORKSPACE: SourceRootId = SourceRootId(0);\n "}, {"sha": "32a6ab47495fb372efe32c3bed2fe698a8db4995", "filename": "crates/ra_hir/src/nameres.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/13735d91a78ba51fb202cb7dde1dfe25420afe9a/crates%2Fra_hir%2Fsrc%2Fnameres.rs", "raw_url": "https://github.com/rust-lang/rust/raw/13735d91a78ba51fb202cb7dde1dfe25420afe9a/crates%2Fra_hir%2Fsrc%2Fnameres.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fnameres.rs?ref=13735d91a78ba51fb202cb7dde1dfe25420afe9a", "patch": "@@ -55,6 +55,7 @@ mod tests;\n use std::sync::Arc;\n \n use hir_def::{builtin_type::BuiltinType, CrateModuleId};\n+use hir_expand::diagnostics::DiagnosticSink;\n use once_cell::sync::Lazy;\n use ra_arena::Arena;\n use ra_db::{Edition, FileId};\n@@ -65,7 +66,6 @@ use test_utils::tested_by;\n \n use crate::{\n     db::{AstDatabase, DefDatabase},\n-    diagnostics::DiagnosticSink,\n     ids::MacroDefId,\n     nameres::diagnostics::DefDiagnostic,\n     Adt, AstId, Crate, HirFileId, MacroDef, Module, ModuleDef, Name, Path, PathKind, Trait,\n@@ -513,12 +513,13 @@ impl CrateDefMap {\n }\n \n mod diagnostics {\n+    use hir_expand::diagnostics::DiagnosticSink;\n     use ra_syntax::{ast, AstPtr};\n     use relative_path::RelativePathBuf;\n \n     use crate::{\n         db::{AstDatabase, DefDatabase},\n-        diagnostics::{DiagnosticSink, UnresolvedModule},\n+        diagnostics::UnresolvedModule,\n         nameres::CrateModuleId,\n         AstId,\n     };"}, {"sha": "2370e8d4f52fa5f7555ecc9a096186764480fb2d", "filename": "crates/ra_hir/src/ty/infer.rs", "status": "modified", "additions": 4, "deletions": 8, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/13735d91a78ba51fb202cb7dde1dfe25420afe9a/crates%2Fra_hir%2Fsrc%2Fty%2Finfer.rs", "raw_url": "https://github.com/rust-lang/rust/raw/13735d91a78ba51fb202cb7dde1dfe25420afe9a/crates%2Fra_hir%2Fsrc%2Fty%2Finfer.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fty%2Finfer.rs?ref=13735d91a78ba51fb202cb7dde1dfe25420afe9a", "patch": "@@ -25,7 +25,7 @@ use hir_def::{\n     path::known,\n     type_ref::{Mutability, TypeRef},\n };\n-use hir_expand::name;\n+use hir_expand::{diagnostics::DiagnosticSink, name};\n use ra_arena::map::ArenaMap;\n use ra_prof::profile;\n use test_utils::tested_by;\n@@ -40,7 +40,6 @@ use crate::{\n     adt::VariantDef,\n     code_model::TypeAlias,\n     db::HirDatabase,\n-    diagnostics::DiagnosticSink,\n     expr::{BindingAnnotation, Body, ExprId, PatId},\n     resolve::{Resolver, TypeNs},\n     ty::infer::diagnostics::InferenceDiagnostic,\n@@ -719,12 +718,9 @@ impl Expectation {\n }\n \n mod diagnostics {\n-    use crate::{\n-        db::HirDatabase,\n-        diagnostics::{DiagnosticSink, NoSuchField},\n-        expr::ExprId,\n-        Function, HasSource,\n-    };\n+    use hir_expand::diagnostics::DiagnosticSink;\n+\n+    use crate::{db::HirDatabase, diagnostics::NoSuchField, expr::ExprId, Function, HasSource};\n \n     #[derive(Debug, PartialEq, Eq, Clone)]\n     pub(super) enum InferenceDiagnostic {"}, {"sha": "201884b95745ac21b1d52c613af8ba1345b40517", "filename": "crates/ra_hir_expand/src/diagnostics.rs", "status": "added", "additions": 85, "deletions": 0, "changes": 85, "blob_url": "https://github.com/rust-lang/rust/blob/13735d91a78ba51fb202cb7dde1dfe25420afe9a/crates%2Fra_hir_expand%2Fsrc%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/13735d91a78ba51fb202cb7dde1dfe25420afe9a/crates%2Fra_hir_expand%2Fsrc%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_expand%2Fsrc%2Fdiagnostics.rs?ref=13735d91a78ba51fb202cb7dde1dfe25420afe9a", "patch": "@@ -0,0 +1,85 @@\n+//! Semantic errors and warnings.\n+//!\n+//! The `Diagnostic` trait defines a trait object which can represent any\n+//! diagnostic.\n+//!\n+//! `DiagnosticSink` struct is used as an emitter for diagnostic. When creating\n+//! a `DiagnosticSink`, you supply a callback which can react to a `dyn\n+//! Diagnostic` or to any concrete diagnostic (downcasting is sued internally).\n+//!\n+//! Because diagnostics store file offsets, it's a bad idea to store them\n+//! directly in salsa. For this reason, every hir subsytem defines it's own\n+//! strongly-typed closed set of diagnostics which use hir ids internally, are\n+//! stored in salsa and do *not* implement the `Diagnostic` trait. Instead, a\n+//! subsystem provides a separate, non-query-based API which can walk all stored\n+//! values and transform them into instances of `Diagnostic`.\n+\n+use std::{any::Any, fmt};\n+\n+use ra_syntax::{SyntaxNode, SyntaxNodePtr, TextRange};\n+\n+use crate::{db::AstDatabase, Source};\n+\n+pub trait Diagnostic: Any + Send + Sync + fmt::Debug + 'static {\n+    fn message(&self) -> String;\n+    fn source(&self) -> Source<SyntaxNodePtr>;\n+    fn highlight_range(&self) -> TextRange {\n+        self.source().ast.range()\n+    }\n+    fn as_any(&self) -> &(dyn Any + Send + 'static);\n+}\n+\n+pub trait AstDiagnostic {\n+    type AST;\n+    fn ast(&self, db: &impl AstDatabase) -> Self::AST;\n+}\n+\n+impl dyn Diagnostic {\n+    pub fn syntax_node(&self, db: &impl AstDatabase) -> SyntaxNode {\n+        let node = db.parse_or_expand(self.source().file_id).unwrap();\n+        self.source().ast.to_node(&node)\n+    }\n+\n+    pub fn downcast_ref<D: Diagnostic>(&self) -> Option<&D> {\n+        self.as_any().downcast_ref()\n+    }\n+}\n+\n+pub struct DiagnosticSink<'a> {\n+    callbacks: Vec<Box<dyn FnMut(&dyn Diagnostic) -> Result<(), ()> + 'a>>,\n+    default_callback: Box<dyn FnMut(&dyn Diagnostic) + 'a>,\n+}\n+\n+impl<'a> DiagnosticSink<'a> {\n+    /// FIXME: split `new` and `on` into a separate builder type\n+    pub fn new(cb: impl FnMut(&dyn Diagnostic) + 'a) -> DiagnosticSink<'a> {\n+        DiagnosticSink { callbacks: Vec::new(), default_callback: Box::new(cb) }\n+    }\n+\n+    pub fn on<D: Diagnostic, F: FnMut(&D) + 'a>(mut self, mut cb: F) -> DiagnosticSink<'a> {\n+        let cb = move |diag: &dyn Diagnostic| match diag.downcast_ref::<D>() {\n+            Some(d) => {\n+                cb(d);\n+                Ok(())\n+            }\n+            None => Err(()),\n+        };\n+        self.callbacks.push(Box::new(cb));\n+        self\n+    }\n+\n+    pub fn push(&mut self, d: impl Diagnostic) {\n+        let d: &dyn Diagnostic = &d;\n+        self._push(d);\n+    }\n+\n+    fn _push(&mut self, d: &dyn Diagnostic) {\n+        for cb in self.callbacks.iter_mut() {\n+            match cb(d) {\n+                Ok(()) => return,\n+                Err(()) => (),\n+            }\n+        }\n+        (self.default_callback)(d)\n+    }\n+}"}, {"sha": "dd07a16b4cad2296b7e00c55549673c627feda45", "filename": "crates/ra_hir_expand/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/13735d91a78ba51fb202cb7dde1dfe25420afe9a/crates%2Fra_hir_expand%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/13735d91a78ba51fb202cb7dde1dfe25420afe9a/crates%2Fra_hir_expand%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_expand%2Fsrc%2Flib.rs?ref=13735d91a78ba51fb202cb7dde1dfe25420afe9a", "patch": "@@ -9,6 +9,7 @@ pub mod ast_id_map;\n pub mod either;\n pub mod name;\n pub mod hygiene;\n+pub mod diagnostics;\n \n use std::hash::{Hash, Hasher};\n "}]}