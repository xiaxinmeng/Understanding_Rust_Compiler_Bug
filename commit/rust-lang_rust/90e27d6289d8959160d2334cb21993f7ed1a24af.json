{"sha": "90e27d6289d8959160d2334cb21993f7ed1a24af", "node_id": "MDY6Q29tbWl0NzI0NzEyOjkwZTI3ZDYyODlkODk1OTE2MGQyMzM0Y2IyMTk5M2Y3ZWQxYTI0YWY=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2021-07-04T09:42:35Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2021-07-04T09:47:56Z"}, "message": "internal: make `xtask` lighter\n\nMoving tests to `rust-analyzer` crate allows removing walkdir dependency\nfrom `xtask`. It does seem more reasonable to keep tidy tests outside of\nthe \"build system\" and closer to other integration tests.", "tree": {"sha": "284affa30fe501bf0c8d909bcda2a72af2146daf", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/284affa30fe501bf0c8d909bcda2a72af2146daf"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/90e27d6289d8959160d2334cb21993f7ed1a24af", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/90e27d6289d8959160d2334cb21993f7ed1a24af", "html_url": "https://github.com/rust-lang/rust/commit/90e27d6289d8959160d2334cb21993f7ed1a24af", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/90e27d6289d8959160d2334cb21993f7ed1a24af/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e9d52c23b3b4f458a778a75870faa87cac57aaee", "url": "https://api.github.com/repos/rust-lang/rust/commits/e9d52c23b3b4f458a778a75870faa87cac57aaee", "html_url": "https://github.com/rust-lang/rust/commit/e9d52c23b3b4f458a778a75870faa87cac57aaee"}], "stats": {"total": 168, "additions": 76, "deletions": 92}, "files": [{"sha": "b72fbf2fdaebf6385cf3e3473d2b95968b76e210", "filename": "Cargo.lock", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/90e27d6289d8959160d2334cb21993f7ed1a24af/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/90e27d6289d8959160d2334cb21993f7ed1a24af/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=90e27d6289d8959160d2334cb21993f7ed1a24af", "patch": "@@ -1343,6 +1343,7 @@ dependencies = [\n  \"vfs-notify\",\n  \"winapi\",\n  \"xflags\",\n+ \"xshell\",\n ]\n \n [[package]]\n@@ -1957,7 +1958,6 @@ version = \"0.1.0\"\n dependencies = [\n  \"anyhow\",\n  \"flate2\",\n- \"walkdir\",\n  \"write-json\",\n  \"xflags\",\n  \"xshell\","}, {"sha": "c3adbd3468eac69301094ea26974ef66959ab7d6", "filename": "crates/rust-analyzer/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/90e27d6289d8959160d2334cb21993f7ed1a24af/crates%2Frust-analyzer%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/90e27d6289d8959160d2334cb21993f7ed1a24af/crates%2Frust-analyzer%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2FCargo.toml?ref=90e27d6289d8959160d2334cb21993f7ed1a24af", "patch": "@@ -66,6 +66,7 @@ jemallocator = { version = \"0.4.1\", package = \"tikv-jemallocator\", optional = tr\n \n [dev-dependencies]\n expect-test = \"1.1\"\n+xshell = \"0.1\"\n \n test_utils = { path = \"../test_utils\" }\n sourcegen = { path = \"../sourcegen\" }"}, {"sha": "cfc7ca0a37e9032b7c33474076ef898c4b827c7c", "filename": "crates/rust-analyzer/tests/slow-tests/main.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/90e27d6289d8959160d2334cb21993f7ed1a24af/crates%2Frust-analyzer%2Ftests%2Fslow-tests%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/90e27d6289d8959160d2334cb21993f7ed1a24af/crates%2Frust-analyzer%2Ftests%2Fslow-tests%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Ftests%2Fslow-tests%2Fmain.rs?ref=90e27d6289d8959160d2334cb21993f7ed1a24af", "patch": "@@ -9,6 +9,7 @@\n //! be sure without a real client anyway.\n \n mod sourcegen;\n+mod tidy;\n mod testdir;\n mod support;\n "}, {"sha": "eacf6b55b6c0ce430388ba9288081df9e651fcaa", "filename": "crates/rust-analyzer/tests/slow-tests/tidy.rs", "status": "renamed", "additions": 73, "deletions": 87, "changes": 160, "blob_url": "https://github.com/rust-lang/rust/blob/90e27d6289d8959160d2334cb21993f7ed1a24af/crates%2Frust-analyzer%2Ftests%2Fslow-tests%2Ftidy.rs", "raw_url": "https://github.com/rust-lang/rust/raw/90e27d6289d8959160d2334cb21993f7ed1a24af/crates%2Frust-analyzer%2Ftests%2Fslow-tests%2Ftidy.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Ftests%2Fslow-tests%2Ftidy.rs?ref=90e27d6289d8959160d2334cb21993f7ed1a24af", "patch": "@@ -3,14 +3,11 @@ use std::{\n     path::{Path, PathBuf},\n };\n \n-use walkdir::{DirEntry, WalkDir};\n use xshell::{cmd, pushd, pushenv, read_file};\n \n-use crate::project_root;\n-\n #[test]\n fn check_code_formatting() {\n-    let _dir = pushd(project_root()).unwrap();\n+    let _dir = pushd(sourcegen::project_root()).unwrap();\n     let _e = pushenv(\"RUSTUP_TOOLCHAIN\", \"stable\");\n \n     let out = cmd!(\"rustfmt --version\").read().unwrap();\n@@ -32,13 +29,14 @@ fn check_code_formatting() {\n fn check_lsp_extensions_docs() {\n     let expected_hash = {\n         let lsp_ext_rs =\n-            read_file(project_root().join(\"crates/rust-analyzer/src/lsp_ext.rs\")).unwrap();\n+            read_file(sourcegen::project_root().join(\"crates/rust-analyzer/src/lsp_ext.rs\"))\n+                .unwrap();\n         stable_hash(lsp_ext_rs.as_str())\n     };\n \n     let actual_hash = {\n         let lsp_extensions_md =\n-            read_file(project_root().join(\"docs/dev/lsp-extensions.md\")).unwrap();\n+            read_file(sourcegen::project_root().join(\"docs/dev/lsp-extensions.md\")).unwrap();\n         let text = lsp_extensions_md\n             .lines()\n             .find_map(|line| line.strip_prefix(\"lsp_ext.rs hash:\"))\n@@ -63,68 +61,78 @@ Please adjust docs/dev/lsp-extensions.md.\n }\n \n #[test]\n-fn rust_files_are_tidy() {\n+fn files_are_tidy() {\n+    let files = sourcegen::list_files(&sourcegen::project_root().join(\"crates\"));\n+\n     let mut tidy_docs = TidyDocs::default();\n     let mut tidy_marks = TidyMarks::default();\n-    for path in rust_files() {\n-        let text = read_file(&path).unwrap();\n-        check_todo(&path, &text);\n-        check_dbg(&path, &text);\n-        check_test_attrs(&path, &text);\n-        check_trailing_ws(&path, &text);\n-        deny_clippy(&path, &text);\n-        tidy_docs.visit(&path, &text);\n-        tidy_marks.visit(&path, &text);\n+    for path in files {\n+        let extension = path.extension().unwrap_or_default().to_str().unwrap_or_default();\n+        match extension {\n+            \"rs\" => {\n+                let text = read_file(&path).unwrap();\n+                check_todo(&path, &text);\n+                check_dbg(&path, &text);\n+                check_test_attrs(&path, &text);\n+                check_trailing_ws(&path, &text);\n+                deny_clippy(&path, &text);\n+                tidy_docs.visit(&path, &text);\n+                tidy_marks.visit(&path, &text);\n+            }\n+            \"toml\" => {\n+                let text = read_file(&path).unwrap();\n+                check_cargo_toml(&path, text);\n+            }\n+            _ => (),\n+        }\n     }\n+\n     tidy_docs.finish();\n     tidy_marks.finish();\n }\n \n-#[test]\n-fn cargo_files_are_tidy() {\n-    for cargo in cargo_files() {\n-        let mut section = None;\n-        for (line_no, text) in read_file(&cargo).unwrap().lines().enumerate() {\n-            let text = text.trim();\n-            if text.starts_with('[') {\n-                if !text.ends_with(']') {\n+fn check_cargo_toml(path: &Path, text: String) -> () {\n+    let mut section = None;\n+    for (line_no, text) in text.lines().enumerate() {\n+        let text = text.trim();\n+        if text.starts_with('[') {\n+            if !text.ends_with(']') {\n+                panic!(\n+                    \"\\nplease don't add comments or trailing whitespace in section lines.\\n\\\n+                        {}:{}\\n\",\n+                    path.display(),\n+                    line_no + 1\n+                )\n+            }\n+            section = Some(text);\n+            continue;\n+        }\n+        let text: String = text.split_whitespace().collect();\n+        if !text.contains(\"path=\") {\n+            continue;\n+        }\n+        match section {\n+            Some(s) if s.contains(\"dev-dependencies\") => {\n+                if text.contains(\"version\") {\n                     panic!(\n-                        \"\\nplease don't add comments or trailing whitespace in section lines.\\n\\\n-                            {}:{}\\n\",\n-                        cargo.display(),\n+                        \"\\ncargo internal dev-dependencies should not have a version.\\n\\\n+                        {}:{}\\n\",\n+                        path.display(),\n                         line_no + 1\n-                    )\n+                    );\n                 }\n-                section = Some(text);\n-                continue;\n             }\n-            let text: String = text.split_whitespace().collect();\n-            if !text.contains(\"path=\") {\n-                continue;\n-            }\n-            match section {\n-                Some(s) if s.contains(\"dev-dependencies\") => {\n-                    if text.contains(\"version\") {\n-                        panic!(\n-                            \"\\ncargo internal dev-dependencies should not have a version.\\n\\\n-                            {}:{}\\n\",\n-                            cargo.display(),\n-                            line_no + 1\n-                        );\n-                    }\n-                }\n-                Some(s) if s.contains(\"dependencies\") => {\n-                    if !text.contains(\"version\") {\n-                        panic!(\n-                            \"\\ncargo internal dependencies should have a version.\\n\\\n-                            {}:{}\\n\",\n-                            cargo.display(),\n-                            line_no + 1\n-                        );\n-                    }\n+            Some(s) if s.contains(\"dependencies\") => {\n+                if !text.contains(\"version\") {\n+                    panic!(\n+                        \"\\ncargo internal dependencies should have a version.\\n\\\n+                        {}:{}\\n\",\n+                        path.display(),\n+                        line_no + 1\n+                    );\n                 }\n-                _ => {}\n             }\n+            _ => {}\n         }\n     }\n }\n@@ -293,7 +301,7 @@ fn check_todo(path: &Path, text: &str) {\n fn check_dbg(path: &Path, text: &str) {\n     let need_dbg = &[\n         // This file itself obviously needs to use dbg.\n-        \"tests/tidy.rs\",\n+        \"slow-tests/tidy.rs\",\n         // Assists to remove `dbg!()`\n         \"handlers/remove_dbg.rs\",\n         // We have .dbg postfix\n@@ -320,7 +328,9 @@ fn check_test_attrs(path: &Path, text: &str) {\n     let ignore_rule =\n         \"https://github.com/rust-analyzer/rust-analyzer/blob/master/docs/dev/style.md#ignore\";\n     let need_ignore: &[&str] = &[\n-        // Special case to run `#[ignore]` tests\n+        // This file.\n+        \"slow-tests/tidy.rs\",\n+        // Special case to run `#[ignore]` tests.\n         \"ide/src/runnables.rs\",\n         // A legit test which needs to be ignored, as it takes too long to run\n         // :(\n@@ -338,7 +348,11 @@ fn check_test_attrs(path: &Path, text: &str) {\n \n     let panic_rule =\n         \"https://github.com/rust-analyzer/rust-analyzer/blob/master/docs/dev/style.md#should_panic\";\n-    let need_panic: &[&str] = &[\"test_utils/src/fixture.rs\"];\n+    let need_panic: &[&str] = &[\n+        // This file.\n+        \"slow-tests/tidy.rs\",\n+        \"test_utils/src/fixture.rs\",\n+    ];\n     if text.contains(\"#[should_panic\") && !need_panic.iter().any(|p| path.ends_with(p)) {\n         panic!(\n             \"\\ndon't add `#[should_panic]` tests, see:\\n\\n    {}\\n\\n   {}\\n\",\n@@ -422,7 +436,7 @@ impl TidyDocs {\n }\n \n fn is_exclude_dir(p: &Path, dirs_to_exclude: &[&str]) -> bool {\n-    p.strip_prefix(project_root())\n+    p.strip_prefix(sourcegen::project_root())\n         .unwrap()\n         .components()\n         .rev()\n@@ -481,31 +495,3 @@ fn find_mark<'a>(text: &'a str, mark: &'static str) -> Option<&'a str> {\n     let text = &text[..idx];\n     Some(text)\n }\n-\n-fn rust_files() -> impl Iterator<Item = PathBuf> {\n-    rust_files_in(&project_root().join(\"crates\"))\n-}\n-\n-fn cargo_files() -> impl Iterator<Item = PathBuf> {\n-    files_in(&project_root(), \"toml\")\n-        .filter(|path| path.file_name().map(|it| it == \"Cargo.toml\").unwrap_or(false))\n-}\n-\n-fn rust_files_in(path: &Path) -> impl Iterator<Item = PathBuf> {\n-    files_in(path, \"rs\")\n-}\n-\n-fn files_in(path: &Path, ext: &'static str) -> impl Iterator<Item = PathBuf> {\n-    let iter = WalkDir::new(path);\n-    return iter\n-        .into_iter()\n-        .filter_entry(|e| !is_hidden(e))\n-        .map(|e| e.unwrap())\n-        .filter(|e| !e.file_type().is_dir())\n-        .map(|e| e.into_path())\n-        .filter(move |path| path.extension().map(|it| it == ext).unwrap_or(false));\n-\n-    fn is_hidden(entry: &DirEntry) -> bool {\n-        entry.file_name().to_str().map(|s| s.starts_with('.')).unwrap_or(false)\n-    }\n-}", "previous_filename": "xtask/src/tidy.rs"}, {"sha": "3bd7a533f81b1247dfb1ce5821083005e77bf6ca", "filename": "xtask/Cargo.toml", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/90e27d6289d8959160d2334cb21993f7ed1a24af/xtask%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/90e27d6289d8959160d2334cb21993f7ed1a24af/xtask%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/xtask%2FCargo.toml?ref=90e27d6289d8959160d2334cb21993f7ed1a24af", "patch": "@@ -9,7 +9,6 @@ license = \"MIT OR Apache-2.0\"\n [dependencies]\n anyhow = \"1.0.26\"\n flate2 = \"1.0\"\n-walkdir = \"2.3.1\"\n write-json = \"0.1.0\"\n xshell = \"0.1\"\n xflags = \"0.2.1\""}, {"sha": "5e5401ce28857819367c69641376becb51db79d4", "filename": "xtask/src/main.rs", "status": "modified", "additions": 0, "deletions": 3, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/90e27d6289d8959160d2334cb21993f7ed1a24af/xtask%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/90e27d6289d8959160d2334cb21993f7ed1a24af/xtask%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/xtask%2Fsrc%2Fmain.rs?ref=90e27d6289d8959160d2334cb21993f7ed1a24af", "patch": "@@ -9,9 +9,6 @@\n //! `.cargo/config`.\n mod flags;\n \n-#[cfg(test)]\n-mod tidy;\n-\n mod install;\n mod release;\n mod dist;"}]}