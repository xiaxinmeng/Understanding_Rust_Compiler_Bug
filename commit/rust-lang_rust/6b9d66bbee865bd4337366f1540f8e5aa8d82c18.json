{"sha": "6b9d66bbee865bd4337366f1540f8e5aa8d82c18", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZiOWQ2NmJiZWU4NjViZDQzMzczNjZmMTU0MGY4ZTVhYThkODJjMTg=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-03-10T16:46:21Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-03-10T16:46:21Z"}, "message": "Merge #3536\n\n3536: Add get and set for `Env` r=matklad a=edwin0cheng\n\nThis PR add three things :\r\n\r\n1. Add `get` and `set` in `Env`.\r\n2. Implement fixture meta for `with_single_file`. \r\n3. Add `env` meta in fixture.\n\nCo-authored-by: Edwin Cheng <edwin0cheng@gmail.com>", "tree": {"sha": "8a7e50f9cef97fcadcd3832ff196010e03177068", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8a7e50f9cef97fcadcd3832ff196010e03177068"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6b9d66bbee865bd4337366f1540f8e5aa8d82c18", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJeZ8RdCRBK7hj4Ov3rIwAAdHIIACQ/RS5UrJTYJHldZr/lDpZ7\nLsLOux4v3gTsCG6Tfl04h2LWIdHMZCu2hzbfea/X9d7EHmYmiNNyqFLSCzXqpaOo\n94thjDrZy2X6pRWDBppAXDDk1BScatPg2b2KVSh5HCUzQvnMrAkYN22K4yLj9AuJ\nVVLKOgW9v8tMb2VkwqySf60HF4JwuOLswwd60adJ6Dyk0myETvcHoN6SN4F/YTkI\nX5L8XJiwrxbU/TPdhXugqYPs88+ZDUF0XBhZItR6XYxmAlSxgKrEOavqaLhEh2CQ\n0Mt+yxn2NTN3Zq+aa07sBPMDvNDr20+0XV6k6MFzA1EItNF3k6Q4mDKO8H/b7Lg=\n=4C/5\n-----END PGP SIGNATURE-----\n", "payload": "tree 8a7e50f9cef97fcadcd3832ff196010e03177068\nparent 34bc0f4f55a9c2239d77b550b9bbd61b4eef6bb1\nparent 95ba7da1abcd18b49c1a2dfc16c8d0e34c64ef45\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1583858781 +0000\ncommitter GitHub <noreply@github.com> 1583858781 +0000\n\nMerge #3536\n\n3536: Add get and set for `Env` r=matklad a=edwin0cheng\n\nThis PR add three things :\r\n\r\n1. Add `get` and `set` in `Env`.\r\n2. Implement fixture meta for `with_single_file`. \r\n3. Add `env` meta in fixture.\n\nCo-authored-by: Edwin Cheng <edwin0cheng@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6b9d66bbee865bd4337366f1540f8e5aa8d82c18", "html_url": "https://github.com/rust-lang/rust/commit/6b9d66bbee865bd4337366f1540f8e5aa8d82c18", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6b9d66bbee865bd4337366f1540f8e5aa8d82c18/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "34bc0f4f55a9c2239d77b550b9bbd61b4eef6bb1", "url": "https://api.github.com/repos/rust-lang/rust/commits/34bc0f4f55a9c2239d77b550b9bbd61b4eef6bb1", "html_url": "https://github.com/rust-lang/rust/commit/34bc0f4f55a9c2239d77b550b9bbd61b4eef6bb1"}, {"sha": "95ba7da1abcd18b49c1a2dfc16c8d0e34c64ef45", "url": "https://api.github.com/repos/rust-lang/rust/commits/95ba7da1abcd18b49c1a2dfc16c8d0e34c64ef45", "html_url": "https://github.com/rust-lang/rust/commit/95ba7da1abcd18b49c1a2dfc16c8d0e34c64ef45"}], "stats": {"total": 76, "additions": 61, "deletions": 15}, "files": [{"sha": "7f43c297120d13a5c580106c34f6bc1533d907ec", "filename": "crates/ra_db/src/fixture.rs", "status": "modified", "additions": 38, "deletions": 15, "changes": 53, "blob_url": "https://github.com/rust-lang/rust/blob/6b9d66bbee865bd4337366f1540f8e5aa8d82c18/crates%2Fra_db%2Fsrc%2Ffixture.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6b9d66bbee865bd4337366f1540f8e5aa8d82c18/crates%2Fra_db%2Fsrc%2Ffixture.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_db%2Fsrc%2Ffixture.rs?ref=6b9d66bbee865bd4337366f1540f8e5aa8d82c18", "patch": "@@ -5,7 +5,7 @@ use std::sync::Arc;\n \n use ra_cfg::CfgOptions;\n use rustc_hash::FxHashMap;\n-use test_utils::{extract_offset, parse_fixture, CURSOR_MARKER};\n+use test_utils::{extract_offset, parse_fixture, parse_single_fixture, CURSOR_MARKER};\n \n use crate::{\n     input::CrateName, CrateGraph, CrateId, Edition, Env, FileId, FilePosition, RelativePathBuf,\n@@ -45,23 +45,37 @@ pub trait WithFixture: Default + SourceDatabaseExt + 'static {\n \n impl<DB: SourceDatabaseExt + Default + 'static> WithFixture for DB {}\n \n-fn with_single_file(db: &mut dyn SourceDatabaseExt, text: &str) -> FileId {\n+fn with_single_file(db: &mut dyn SourceDatabaseExt, ra_fixture: &str) -> FileId {\n     let file_id = FileId(0);\n     let rel_path: RelativePathBuf = \"/main.rs\".into();\n \n     let mut source_root = SourceRoot::new_local();\n     source_root.insert_file(rel_path.clone(), file_id);\n \n-    let mut crate_graph = CrateGraph::default();\n-    crate_graph.add_crate_root(\n-        file_id,\n-        Edition::Edition2018,\n-        None,\n-        CfgOptions::default(),\n-        Env::default(),\n-    );\n-\n-    db.set_file_text(file_id, Arc::new(text.to_string()));\n+    let fixture = parse_single_fixture(ra_fixture);\n+\n+    let crate_graph = if let Some(entry) = fixture {\n+        let meta = match parse_meta(&entry.meta) {\n+            ParsedMeta::File(it) => it,\n+            _ => panic!(\"with_single_file only support file meta\"),\n+        };\n+\n+        let mut crate_graph = CrateGraph::default();\n+        crate_graph.add_crate_root(file_id, meta.edition, meta.krate, meta.cfg, meta.env);\n+        crate_graph\n+    } else {\n+        let mut crate_graph = CrateGraph::default();\n+        crate_graph.add_crate_root(\n+            file_id,\n+            Edition::Edition2018,\n+            None,\n+            CfgOptions::default(),\n+            Env::default(),\n+        );\n+        crate_graph\n+    };\n+\n+    db.set_file_text(file_id, Arc::new(ra_fixture.to_string()));\n     db.set_file_relative_path(file_id, rel_path);\n     db.set_file_source_root(file_id, WORKSPACE);\n     db.set_source_root(WORKSPACE, Arc::new(source_root));\n@@ -104,7 +118,7 @@ fn with_files(db: &mut dyn SourceDatabaseExt, fixture: &str) -> Option<FilePosit\n                 meta.edition,\n                 Some(krate.clone()),\n                 meta.cfg,\n-                Env::default(),\n+                meta.env,\n             );\n             let prev = crates.insert(krate.clone(), crate_id);\n             assert!(prev.is_none());\n@@ -167,9 +181,10 @@ struct FileMeta {\n     deps: Vec<String>,\n     cfg: CfgOptions,\n     edition: Edition,\n+    env: Env,\n }\n \n-//- /lib.rs crate:foo deps:bar,baz\n+//- /lib.rs crate:foo deps:bar,baz cfg:foo=a,bar=b env:OUTDIR=path/to,OTHER=foo)\n fn parse_meta(meta: &str) -> ParsedMeta {\n     let components = meta.split_ascii_whitespace().collect::<Vec<_>>();\n \n@@ -186,6 +201,7 @@ fn parse_meta(meta: &str) -> ParsedMeta {\n     let mut deps = Vec::new();\n     let mut edition = Edition::Edition2018;\n     let mut cfg = CfgOptions::default();\n+    let mut env = Env::default();\n     for component in components[1..].iter() {\n         let (key, value) = split1(component, ':').unwrap();\n         match key {\n@@ -200,11 +216,18 @@ fn parse_meta(meta: &str) -> ParsedMeta {\n                     }\n                 }\n             }\n+            \"env\" => {\n+                for key in value.split(',') {\n+                    if let Some((k, v)) = split1(key, '=') {\n+                        env.set(k.into(), v.into());\n+                    }\n+                }\n+            }\n             _ => panic!(\"bad component: {:?}\", component),\n         }\n     }\n \n-    ParsedMeta::File(FileMeta { path, krate, deps, edition, cfg })\n+    ParsedMeta::File(FileMeta { path, krate, deps, edition, cfg, env })\n }\n \n fn split1(haystack: &str, delim: char) -> Option<(&str, &str)> {"}, {"sha": "1a1c642029879cf17a1e371d3754ed26ed009895", "filename": "crates/ra_db/src/input.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/6b9d66bbee865bd4337366f1540f8e5aa8d82c18/crates%2Fra_db%2Fsrc%2Finput.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6b9d66bbee865bd4337366f1540f8e5aa8d82c18/crates%2Fra_db%2Fsrc%2Finput.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_db%2Fsrc%2Finput.rs?ref=6b9d66bbee865bd4337366f1540f8e5aa8d82c18", "patch": "@@ -261,6 +261,16 @@ impl fmt::Display for Edition {\n     }\n }\n \n+impl Env {\n+    pub fn set(&mut self, env: &str, value: String) {\n+        self.entries.insert(env.to_owned(), value);\n+    }\n+\n+    pub fn get(&self, env: &str) -> Option<String> {\n+        self.entries.get(env).cloned()\n+    }\n+}\n+\n #[derive(Debug)]\n pub struct ParseEditionError {\n     invalid_input: String,"}, {"sha": "a0d8f4d3769f740eac644f0d981f593a8ff228b6", "filename": "crates/test_utils/src/lib.rs", "status": "modified", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/6b9d66bbee865bd4337366f1540f8e5aa8d82c18/crates%2Ftest_utils%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6b9d66bbee865bd4337366f1540f8e5aa8d82c18/crates%2Ftest_utils%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Ftest_utils%2Fsrc%2Flib.rs?ref=6b9d66bbee865bd4337366f1540f8e5aa8d82c18", "patch": "@@ -202,6 +202,19 @@ pub fn parse_fixture(fixture: &str) -> Vec<FixtureEntry> {\n     res\n }\n \n+/// Same as `parse_fixture`, except it allow empty fixture\n+pub fn parse_single_fixture(fixture: &str) -> Option<FixtureEntry> {\n+    if !fixture.lines().any(|it| it.trim_start().starts_with(\"//-\")) {\n+        return None;\n+    }\n+\n+    let fixtures = parse_fixture(fixture);\n+    if fixtures.len() > 1 {\n+        panic!(\"too many fixtures\");\n+    }\n+    fixtures.into_iter().nth(0)\n+}\n+\n // Comparison functionality borrowed from cargo:\n \n /// Compare a line with an expected pattern."}]}