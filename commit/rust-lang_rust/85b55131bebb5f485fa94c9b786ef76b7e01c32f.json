{"sha": "85b55131bebb5f485fa94c9b786ef76b7e01c32f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg1YjU1MTMxYmViYjVmNDg1ZmE5NGM5Yjc4NmVmNzZiN2UwMWMzMmY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-07-28T18:04:27Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-07-28T18:04:27Z"}, "message": "auto merge of #8092 : dotdash/rust/peak_mem, r=alexcrichton\n\nThis fixes the recently introduced peak memory usage regression by\r\nfreeing the intermediate results as soon as they're not required\r\nanymore instead of keeping them around for the whole compilation\r\nprocess.\r\n\r\nRefs #8077", "tree": {"sha": "39e316c51ead89963fc57839067d3af5cd6943a1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/39e316c51ead89963fc57839067d3af5cd6943a1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/85b55131bebb5f485fa94c9b786ef76b7e01c32f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/85b55131bebb5f485fa94c9b786ef76b7e01c32f", "html_url": "https://github.com/rust-lang/rust/commit/85b55131bebb5f485fa94c9b786ef76b7e01c32f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/85b55131bebb5f485fa94c9b786ef76b7e01c32f/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "293ec2c5820e8b5dc4394e2c11ad3d2e9cfb56eb", "url": "https://api.github.com/repos/rust-lang/rust/commits/293ec2c5820e8b5dc4394e2c11ad3d2e9cfb56eb", "html_url": "https://github.com/rust-lang/rust/commit/293ec2c5820e8b5dc4394e2c11ad3d2e9cfb56eb"}, {"sha": "075560a9f2f715ac0e599a13d26d1a910be36509", "url": "https://api.github.com/repos/rust-lang/rust/commits/075560a9f2f715ac0e599a13d26d1a910be36509", "html_url": "https://github.com/rust-lang/rust/commit/075560a9f2f715ac0e599a13d26d1a910be36509"}], "stats": {"total": 19, "additions": 13, "deletions": 6}, "files": [{"sha": "e81b6919befa5af2f1fc9db324c55d713f472c52", "filename": "src/librustc/driver/driver.rs", "status": "modified", "additions": 13, "deletions": 6, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/85b55131bebb5f485fa94c9b786ef76b7e01c32f/src%2Flibrustc%2Fdriver%2Fdriver.rs", "raw_url": "https://github.com/rust-lang/rust/raw/85b55131bebb5f485fa94c9b786ef76b7e01c32f/src%2Flibrustc%2Fdriver%2Fdriver.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fdriver%2Fdriver.rs?ref=85b55131bebb5f485fa94c9b786ef76b7e01c32f", "patch": "@@ -409,12 +409,19 @@ pub fn stop_after_phase_5(sess: Session) -> bool {\n pub fn compile_input(sess: Session, cfg: ast::CrateConfig, input: &input,\n                      outdir: &Option<Path>, output: &Option<Path>) {\n     let outputs = build_output_filenames(input, outdir, output, [], sess);\n-    let crate = phase_1_parse_input(sess, cfg.clone(), input);\n-    if stop_after_phase_1(sess) { return; }\n-    let expanded_crate = phase_2_configure_and_expand(sess, cfg, crate);\n-    let analysis = phase_3_run_analysis_passes(sess, expanded_crate);\n-    if stop_after_phase_3(sess) { return; }\n-    let trans = phase_4_translate_to_llvm(sess, expanded_crate, &analysis, outputs);\n+    // We need nested scopes here, because the intermediate results can keep\n+    // large chunks of memory alive and we want to free them as soon as\n+    // possible to keep the peak memory usage low\n+    let trans = {\n+        let expanded_crate = {\n+            let crate = phase_1_parse_input(sess, cfg.clone(), input);\n+            if stop_after_phase_1(sess) { return; }\n+            phase_2_configure_and_expand(sess, cfg, crate)\n+        };\n+        let analysis = phase_3_run_analysis_passes(sess, expanded_crate);\n+        if stop_after_phase_3(sess) { return; }\n+        phase_4_translate_to_llvm(sess, expanded_crate, &analysis, outputs)\n+    };\n     phase_5_run_llvm_passes(sess, &trans, outputs);\n     if stop_after_phase_5(sess) { return; }\n     phase_6_link_output(sess, &trans, outputs);"}]}