{"sha": "57735f2a32138d552c51c4b2de04bcd56650db15", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU3NzM1ZjJhMzIxMzhkNTUyYzUxYzRiMmRlMDRiY2Q1NjY1MGRiMTU=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-10-06T17:51:20Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-10-06T17:51:20Z"}, "message": "Merge #6140\n\n6140: honour hover.content_format client capability r=lnicola a=robinvd\n\nThis removes all markdown when the client does not support the markdown MarkupKind.\r\n\r\nOtherwise the output on the editor will have some markdown boilerplate, making it less readable.\r\n\r\nFor example kak_lsp does not currently support markdown.\r\n![image](https://user-images.githubusercontent.com/22073483/95112949-ef0ff080-0741-11eb-82a7-0594fa2cd736.png)\r\n\r\nafter:\r\n![image](https://user-images.githubusercontent.com/22073483/95113089-2bdbe780-0742-11eb-94fa-bcfec6d7347a.png)\r\n\r\n\n\nCo-authored-by: Robin van Dijk <robin@robinjint.nl>", "tree": {"sha": "398602dd3569036af9fe2253d2911fd59c5dc3ce", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/398602dd3569036af9fe2253d2911fd59c5dc3ce"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/57735f2a32138d552c51c4b2de04bcd56650db15", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJffK6YCRBK7hj4Ov3rIwAAdHIIAJ694z1JBtRooW65YtGpVuHh\niy/Cs750m89OuK5p7dr1xaaR743xwulm1gGQNEgAIvhaGvPdF1IGGR3vbWfxO9yz\nxNjNInYcdE3ZQpmvik502xUO1TXFSzHl0uaNR2NunpMhBV4y9buc2jq7KOrE+Roa\n07P7GjuCuwEKmos+9H2gmTVEDGULaM7uRZvUd1Hx7nJPwdBiZrHTV19EPI2v5CXr\nGVRwx0BMA41Ei2bAcrHcBG+lm50LHrs6D6DvF58EH7CnVX0Y6YTrr51jfOItMhjl\nE6LcNKc6L9/dV/ZSXSYwuNmza/3Oa1D/msKxo02zdiMlO0PqMh8BAQec1RRED54=\n=813R\n-----END PGP SIGNATURE-----\n", "payload": "tree 398602dd3569036af9fe2253d2911fd59c5dc3ce\nparent 63fa61795ae00a0f157c2b0034a31ebabb3e7cff\nparent bd7bf4a276c5d49dd18f2df46694a66c4401a65e\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1602006680 +0000\ncommitter GitHub <noreply@github.com> 1602006680 +0000\n\nMerge #6140\n\n6140: honour hover.content_format client capability r=lnicola a=robinvd\n\nThis removes all markdown when the client does not support the markdown MarkupKind.\r\n\r\nOtherwise the output on the editor will have some markdown boilerplate, making it less readable.\r\n\r\nFor example kak_lsp does not currently support markdown.\r\n![image](https://user-images.githubusercontent.com/22073483/95112949-ef0ff080-0741-11eb-82a7-0594fa2cd736.png)\r\n\r\nafter:\r\n![image](https://user-images.githubusercontent.com/22073483/95113089-2bdbe780-0742-11eb-94fa-bcfec6d7347a.png)\r\n\r\n\n\nCo-authored-by: Robin van Dijk <robin@robinjint.nl>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/57735f2a32138d552c51c4b2de04bcd56650db15", "html_url": "https://github.com/rust-lang/rust/commit/57735f2a32138d552c51c4b2de04bcd56650db15", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/57735f2a32138d552c51c4b2de04bcd56650db15/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "63fa61795ae00a0f157c2b0034a31ebabb3e7cff", "url": "https://api.github.com/repos/rust-lang/rust/commits/63fa61795ae00a0f157c2b0034a31ebabb3e7cff", "html_url": "https://github.com/rust-lang/rust/commit/63fa61795ae00a0f157c2b0034a31ebabb3e7cff"}, {"sha": "bd7bf4a276c5d49dd18f2df46694a66c4401a65e", "url": "https://api.github.com/repos/rust-lang/rust/commits/bd7bf4a276c5d49dd18f2df46694a66c4401a65e", "html_url": "https://github.com/rust-lang/rust/commit/bd7bf4a276c5d49dd18f2df46694a66c4401a65e"}], "stats": {"total": 90, "additions": 81, "deletions": 9}, "files": [{"sha": "53265488e60f4b06341e93b3385b388b3531ae91", "filename": "crates/ide/src/hover.rs", "status": "modified", "additions": 45, "deletions": 6, "changes": 51, "blob_url": "https://github.com/rust-lang/rust/blob/57735f2a32138d552c51c4b2de04bcd56650db15/crates%2Fide%2Fsrc%2Fhover.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57735f2a32138d552c51c4b2de04bcd56650db15/crates%2Fide%2Fsrc%2Fhover.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fhover.rs?ref=57735f2a32138d552c51c4b2de04bcd56650db15", "patch": "@@ -15,6 +15,7 @@ use test_utils::mark;\n use crate::{\n     display::{macro_label, ShortLabel, ToNav, TryToNav},\n     link_rewrite::{remove_links, rewrite_links},\n+    markdown_remove::remove_markdown,\n     markup::Markup,\n     runnables::runnable,\n     FileId, FilePosition, NavigationTarget, RangeInfo, Runnable,\n@@ -27,6 +28,7 @@ pub struct HoverConfig {\n     pub debug: bool,\n     pub goto_type_def: bool,\n     pub links_in_hover: bool,\n+    pub markdown: bool,\n }\n \n impl Default for HoverConfig {\n@@ -37,6 +39,7 @@ impl Default for HoverConfig {\n             debug: true,\n             goto_type_def: true,\n             links_in_hover: true,\n+            markdown: true,\n         }\n     }\n }\n@@ -48,6 +51,7 @@ impl HoverConfig {\n         debug: false,\n         goto_type_def: false,\n         links_in_hover: true,\n+        markdown: true,\n     };\n \n     pub fn any(&self) -> bool {\n@@ -91,6 +95,7 @@ pub(crate) fn hover(\n     db: &RootDatabase,\n     position: FilePosition,\n     links_in_hover: bool,\n+    markdown: bool,\n ) -> Option<RangeInfo<HoverResult>> {\n     let sema = Semantics::new(db);\n     let file = sema.parse(position.file_id).syntax().clone();\n@@ -109,7 +114,9 @@ pub(crate) fn hover(\n     };\n     if let Some(definition) = definition {\n         if let Some(markup) = hover_for_definition(db, definition) {\n-            let markup = if links_in_hover {\n+            let markup = if !markdown {\n+                remove_markdown(&markup.as_str())\n+            } else if links_in_hover {\n                 rewrite_links(db, &markup.as_str(), &definition)\n             } else {\n                 remove_links(&markup.as_str())\n@@ -147,7 +154,11 @@ pub(crate) fn hover(\n         }\n     };\n \n-    res.markup = Markup::fenced_block(&ty.display(db));\n+    res.markup = if markdown {\n+        Markup::fenced_block(&ty.display(db))\n+    } else {\n+        ty.display(db).to_string().into()\n+    };\n     let range = sema.original_range(&node).range;\n     Some(RangeInfo::new(range, res))\n }\n@@ -383,12 +394,12 @@ mod tests {\n \n     fn check_hover_no_result(ra_fixture: &str) {\n         let (analysis, position) = fixture::position(ra_fixture);\n-        assert!(analysis.hover(position, true).unwrap().is_none());\n+        assert!(analysis.hover(position, true, true).unwrap().is_none());\n     }\n \n     fn check(ra_fixture: &str, expect: Expect) {\n         let (analysis, position) = fixture::position(ra_fixture);\n-        let hover = analysis.hover(position, true).unwrap().unwrap();\n+        let hover = analysis.hover(position, true, true).unwrap().unwrap();\n \n         let content = analysis.db.file_text(position.file_id);\n         let hovered_element = &content[hover.range];\n@@ -399,7 +410,18 @@ mod tests {\n \n     fn check_hover_no_links(ra_fixture: &str, expect: Expect) {\n         let (analysis, position) = fixture::position(ra_fixture);\n-        let hover = analysis.hover(position, false).unwrap().unwrap();\n+        let hover = analysis.hover(position, false, true).unwrap().unwrap();\n+\n+        let content = analysis.db.file_text(position.file_id);\n+        let hovered_element = &content[hover.range];\n+\n+        let actual = format!(\"*{}*\\n{}\\n\", hovered_element, hover.info.markup);\n+        expect.assert_eq(&actual)\n+    }\n+\n+    fn check_hover_no_markdown(ra_fixture: &str, expect: Expect) {\n+        let (analysis, position) = fixture::position(ra_fixture);\n+        let hover = analysis.hover(position, true, false).unwrap().unwrap();\n \n         let content = analysis.db.file_text(position.file_id);\n         let hovered_element = &content[hover.range];\n@@ -410,7 +432,7 @@ mod tests {\n \n     fn check_actions(ra_fixture: &str, expect: Expect) {\n         let (analysis, position) = fixture::position(ra_fixture);\n-        let hover = analysis.hover(position, true).unwrap().unwrap();\n+        let hover = analysis.hover(position, true, true).unwrap().unwrap();\n         expect.assert_debug_eq(&hover.info.actions)\n     }\n \n@@ -433,6 +455,23 @@ fn main() {\n         );\n     }\n \n+    #[test]\n+    fn hover_remove_markdown_if_configured() {\n+        check_hover_no_markdown(\n+            r#\"\n+pub fn foo() -> u32 { 1 }\n+\n+fn main() {\n+    let foo_test = foo()<|>;\n+}\n+\"#,\n+            expect![[r#\"\n+                *foo()*\n+                u32\n+            \"#]],\n+        );\n+    }\n+\n     #[test]\n     fn hover_shows_long_type_of_an_expression() {\n         check("}, {"sha": "57f3581b6bd013bc40686759c955600304ff44aa", "filename": "crates/ide/src/lib.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/57735f2a32138d552c51c4b2de04bcd56650db15/crates%2Fide%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57735f2a32138d552c51c4b2de04bcd56650db15/crates%2Fide%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Flib.rs?ref=57735f2a32138d552c51c4b2de04bcd56650db15", "patch": "@@ -46,6 +46,7 @@ mod syntax_highlighting;\n mod syntax_tree;\n mod typing;\n mod link_rewrite;\n+mod markdown_remove;\n \n use std::sync::Arc;\n \n@@ -376,8 +377,9 @@ impl Analysis {\n         &self,\n         position: FilePosition,\n         links_in_hover: bool,\n+        markdown: bool,\n     ) -> Cancelable<Option<RangeInfo<HoverResult>>> {\n-        self.with_db(|db| hover::hover(db, position, links_in_hover))\n+        self.with_db(|db| hover::hover(db, position, links_in_hover, markdown))\n     }\n \n     /// Computes parameter information for the given call expression."}, {"sha": "02ad39dfb72346cf41a74f715052d481ae2b9c33", "filename": "crates/ide/src/markdown_remove.rs", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/57735f2a32138d552c51c4b2de04bcd56650db15/crates%2Fide%2Fsrc%2Fmarkdown_remove.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57735f2a32138d552c51c4b2de04bcd56650db15/crates%2Fide%2Fsrc%2Fmarkdown_remove.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fmarkdown_remove.rs?ref=57735f2a32138d552c51c4b2de04bcd56650db15", "patch": "@@ -0,0 +1,23 @@\n+//! Removes markdown from strings.\n+\n+use pulldown_cmark::{Event, Parser, Tag};\n+\n+/// Removes all markdown, keeping the text and code blocks\n+///\n+/// Currently limited in styling, i.e. no ascii tables or lists\n+pub fn remove_markdown(markdown: &str) -> String {\n+    let mut out = String::new();\n+    let parser = Parser::new(markdown);\n+\n+    for event in parser {\n+        match event {\n+            Event::Text(text) | Event::Code(text) => out.push_str(&text),\n+            Event::SoftBreak | Event::HardBreak | Event::Rule | Event::End(Tag::CodeBlock(_)) => {\n+                out.push('\\n')\n+            }\n+            _ => {}\n+        }\n+    }\n+\n+    out\n+}"}, {"sha": "1b9b24698a96057d153e71efe36399bf63cd859c", "filename": "crates/rust-analyzer/src/config.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/57735f2a32138d552c51c4b2de04bcd56650db15/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57735f2a32138d552c51c4b2de04bcd56650db15/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs?ref=57735f2a32138d552c51c4b2de04bcd56650db15", "patch": "@@ -15,7 +15,7 @@ use ide::{\n     AssistConfig, CompletionConfig, DiagnosticsConfig, HoverConfig, InlayHintsConfig,\n     MergeBehaviour,\n };\n-use lsp_types::ClientCapabilities;\n+use lsp_types::{ClientCapabilities, MarkupKind};\n use project_model::{CargoConfig, ProjectJson, ProjectJsonData, ProjectManifest};\n use rustc_hash::FxHashSet;\n use serde::Deserialize;\n@@ -333,13 +333,17 @@ impl Config {\n             debug: data.hoverActions_enable && data.hoverActions_debug,\n             goto_type_def: data.hoverActions_enable && data.hoverActions_gotoTypeDef,\n             links_in_hover: data.hoverActions_linksInHover,\n+            markdown: true,\n         };\n \n         log::info!(\"Config::update() = {:#?}\", self);\n     }\n \n     pub fn update_caps(&mut self, caps: &ClientCapabilities) {\n         if let Some(doc_caps) = caps.text_document.as_ref() {\n+            if let Some(value) = doc_caps.hover.as_ref().and_then(|it| it.content_format.as_ref()) {\n+                self.hover.markdown = value.contains(&MarkupKind::Markdown)\n+            }\n             if let Some(value) = doc_caps.definition.as_ref().and_then(|it| it.link_support) {\n                 self.client_caps.location_link = value;\n             }"}, {"sha": "468655f9c39e753bb6c8dfa230f8f8ee036e1e1a", "filename": "crates/rust-analyzer/src/handlers.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/57735f2a32138d552c51c4b2de04bcd56650db15/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57735f2a32138d552c51c4b2de04bcd56650db15/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs?ref=57735f2a32138d552c51c4b2de04bcd56650db15", "patch": "@@ -618,7 +618,11 @@ pub(crate) fn handle_hover(\n ) -> Result<Option<lsp_ext::Hover>> {\n     let _p = profile::span(\"handle_hover\");\n     let position = from_proto::file_position(&snap, params.text_document_position_params)?;\n-    let info = match snap.analysis.hover(position, snap.config.hover.links_in_hover)? {\n+    let info = match snap.analysis.hover(\n+        position,\n+        snap.config.hover.links_in_hover,\n+        snap.config.hover.markdown,\n+    )? {\n         None => return Ok(None),\n         Some(info) => info,\n     };"}]}