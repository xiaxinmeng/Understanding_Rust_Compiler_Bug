{"sha": "b7333682585d8b8e1ab936fa61b6dbf9a3731050", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI3MzMzNjgyNTg1ZDhiOGUxYWI5MzZmYTYxYjZkYmY5YTM3MzEwNTA=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2020-06-07T16:11:27Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-06-07T16:11:27Z"}, "message": "Rollup merge of #72952 - pnkfelix:regression-test-for-issue-70924, r=nikomatsakis\n\nrun-make regression test for issue #70924.\n\nSometime after my PR #72767 (to fix issue #70924) landed, I realized that I *could* make a local regression test, thanks to `rustc --print sysroot`: I can make a fresh \"copy\" (really mostly symlinks) of the sysroot, and then modify it to recreate the terms of this bug.", "tree": {"sha": "14097103fefe5f935ca4a6e4f7370d21337d7509", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/14097103fefe5f935ca4a6e4f7370d21337d7509"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b7333682585d8b8e1ab936fa61b6dbf9a3731050", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJe3RGwCRBK7hj4Ov3rIwAAdHIIAK+kMtYf7QTsZCuLDHjdvv04\nSF9lgqQIGA8WiVp10N/qCEvU1KGiiNd6zZQ6itk5XDxQSzaobenGPkNregGc61nU\n8zMIn5oITv8DsI2KCLQAQBKqIiOZ3Oxh2RYdG2Oj5ZMKWZyeTs11NEX6KKOK+X8B\nbavyxG/9rFBRVDmZSno7sDOhpmW7+VacTq4Moblv2z4bV50EI3ucZVuCf9s8LbhJ\n1H2IlU0RoBf3JaaWtAqtkv9hb9qEQDQEniy4b92IlvYXoQeVzsxMPY/kq1HnhGPf\nBWcxNuTef/yMUsato2siQ7tTVCPoCOBXyTwh/GEeSlScAgQTMOo0hXx1+lMNz+c=\n=PdJe\n-----END PGP SIGNATURE-----\n", "payload": "tree 14097103fefe5f935ca4a6e4f7370d21337d7509\nparent a2fc33e0c87a258542cd12d6ffae52c43aa3785a\nparent a9d5dffe99e7559beffdfedf165107eeef36ba19\nauthor Dylan DPC <dylan.dpc@gmail.com> 1591546287 +0200\ncommitter GitHub <noreply@github.com> 1591546287 +0200\n\nRollup merge of #72952 - pnkfelix:regression-test-for-issue-70924, r=nikomatsakis\n\nrun-make regression test for issue #70924.\n\nSometime after my PR #72767 (to fix issue #70924) landed, I realized that I *could* make a local regression test, thanks to `rustc --print sysroot`: I can make a fresh \"copy\" (really mostly symlinks) of the sysroot, and then modify it to recreate the terms of this bug.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b7333682585d8b8e1ab936fa61b6dbf9a3731050", "html_url": "https://github.com/rust-lang/rust/commit/b7333682585d8b8e1ab936fa61b6dbf9a3731050", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b7333682585d8b8e1ab936fa61b6dbf9a3731050/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a2fc33e0c87a258542cd12d6ffae52c43aa3785a", "url": "https://api.github.com/repos/rust-lang/rust/commits/a2fc33e0c87a258542cd12d6ffae52c43aa3785a", "html_url": "https://github.com/rust-lang/rust/commit/a2fc33e0c87a258542cd12d6ffae52c43aa3785a"}, {"sha": "a9d5dffe99e7559beffdfedf165107eeef36ba19", "url": "https://api.github.com/repos/rust-lang/rust/commits/a9d5dffe99e7559beffdfedf165107eeef36ba19", "html_url": "https://github.com/rust-lang/rust/commit/a9d5dffe99e7559beffdfedf165107eeef36ba19"}], "stats": {"total": 47, "additions": 47, "deletions": 0}, "files": [{"sha": "50ff3dd56ce92ef35e689616cd8dcc88a8fe2c77", "filename": "src/test/run-make-fulldeps/incr-add-rust-src-component/Makefile", "status": "added", "additions": 44, "deletions": 0, "changes": 44, "blob_url": "https://github.com/rust-lang/rust/blob/b7333682585d8b8e1ab936fa61b6dbf9a3731050/src%2Ftest%2Frun-make-fulldeps%2Fincr-add-rust-src-component%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/b7333682585d8b8e1ab936fa61b6dbf9a3731050/src%2Ftest%2Frun-make-fulldeps%2Fincr-add-rust-src-component%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fincr-add-rust-src-component%2FMakefile?ref=b7333682585d8b8e1ab936fa61b6dbf9a3731050", "patch": "@@ -0,0 +1,44 @@\n+-include ../tools.mk\n+\n+# rust-lang/rust#70924: Test that if we add rust-src component in between two\n+# incremetnal compiles, the compiler does not ICE on the second.\n+\n+# This test uses `ln -s` rather than copying to save testing time, but its\n+# usage doesn't work on windows. So ignore windows.\n+\n+# ignore-windows\n+\n+SYSROOT:=$(shell $(RUSTC) --print sysroot)\n+FAKEROOT=$(TMPDIR)/fakeroot\n+INCR=$(TMPDIR)/incr\n+\n+# Make a local copy of the sysroot; then remove the rust-src part of it, if\n+# present, for the *first* build. Then put in a facsimile of the rust-src\n+# component for the second build, in order to expose the ICE from issue #70924.\n+#\n+# Note that it is much easier to just do `cp -a $(SYSROOT)/* $(FAKEROOT)` as a\n+# first step, but I am concerned that would be too expensive in a unit test\n+# compared to making symbolic links.\n+#\n+# Anyway, the pattern you'll see here is: For every prefix in\n+# root/lib/rustlib/src, link all of prefix parent content, then remove the\n+# prefix, then loop on the next prefix. This way, we basically create a copy of\n+# the context around root/lib/rustlib/src, and can freely add/remove the src\n+# component itself.\n+all:\n+\tmkdir $(FAKEROOT)\n+\tln -s $(SYSROOT)/* $(FAKEROOT)\n+\trm -f $(FAKEROOT)/lib\n+\tmkdir $(FAKEROOT)/lib\n+\tln -s $(SYSROOT)/lib/* $(FAKEROOT)/lib\n+\trm -f $(FAKEROOT)/lib/rustlib\n+\tmkdir $(FAKEROOT)/lib/rustlib\n+\tln -s $(SYSROOT)/lib/rustlib/* $(FAKEROOT)/lib/rustlib\n+\trm -f $(FAKEROOT)/lib/rustlib/src\n+\tmkdir $(FAKEROOT)/lib/rustlib/src\n+\tln -s $(SYSROOT)/lib/rustlib/src/* $(FAKEROOT)/lib/rustlib/src\n+\trm -f $(FAKEROOT)/lib/rustlib/src/rust\n+\t$(RUSTC) --sysroot $(FAKEROOT) -C incremental=$(INCR) main.rs\n+\tmkdir -p $(FAKEROOT)/lib/rustlib/src/rust/src/libstd\n+\ttouch $(FAKEROOT)/lib/rustlib/src/rust/src/libstd/lib.rs\n+\t$(RUSTC) --sysroot $(FAKEROOT) -C incremental=$(INCR) main.rs"}, {"sha": "f6320bcb04aa8f747f266e1105886837414fd921", "filename": "src/test/run-make-fulldeps/incr-add-rust-src-component/main.rs", "status": "added", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/b7333682585d8b8e1ab936fa61b6dbf9a3731050/src%2Ftest%2Frun-make-fulldeps%2Fincr-add-rust-src-component%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b7333682585d8b8e1ab936fa61b6dbf9a3731050/src%2Ftest%2Frun-make-fulldeps%2Fincr-add-rust-src-component%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fincr-add-rust-src-component%2Fmain.rs?ref=b7333682585d8b8e1ab936fa61b6dbf9a3731050", "patch": "@@ -0,0 +1,3 @@\n+fn main() {\n+    println!(\"Hello World\");\n+}"}]}