{"sha": "82728eb7576c46576dfcd3c6b4edc99bd8766572", "node_id": "MDY6Q29tbWl0NzI0NzEyOjgyNzI4ZWI3NTc2YzQ2NTc2ZGZjZDNjNmI0ZWRjOTliZDg3NjY1NzI=", "commit": {"author": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2021-08-20T12:34:46Z"}, "committer": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2021-08-20T12:34:46Z"}, "message": "Switch AstDatabase::exapnd_proc_macro to ExpandResult", "tree": {"sha": "8594dfb80eac86090e472f04569cc7a17be89080", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8594dfb80eac86090e472f04569cc7a17be89080"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/82728eb7576c46576dfcd3c6b4edc99bd8766572", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/82728eb7576c46576dfcd3c6b4edc99bd8766572", "html_url": "https://github.com/rust-lang/rust/commit/82728eb7576c46576dfcd3c6b4edc99bd8766572", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/82728eb7576c46576dfcd3c6b4edc99bd8766572/comments", "author": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "269de9abe39f0a174fa9d6fda2450ef529888c66", "url": "https://api.github.com/repos/rust-lang/rust/commits/269de9abe39f0a174fa9d6fda2450ef529888c66", "html_url": "https://github.com/rust-lang/rust/commit/269de9abe39f0a174fa9d6fda2450ef529888c66"}], "stats": {"total": 53, "additions": 18, "deletions": 35}, "files": [{"sha": "6257050d802135d248ba923a4e305841639bb265", "filename": "crates/hir_expand/src/builtin_attr.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/82728eb7576c46576dfcd3c6b4edc99bd8766572/crates%2Fhir_expand%2Fsrc%2Fbuiltin_attr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/82728eb7576c46576dfcd3c6b4edc99bd8766572/crates%2Fhir_expand%2Fsrc%2Fbuiltin_attr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_expand%2Fsrc%2Fbuiltin_attr.rs?ref=82728eb7576c46576dfcd3c6b4edc99bd8766572", "patch": "@@ -1,5 +1,6 @@\n //! Builtin attributes.\n \n+use mbe::ExpandResult;\n use syntax::ast;\n \n use crate::{db::AstDatabase, name, AstId, CrateId, MacroCallId, MacroDefId, MacroDefKind};\n@@ -18,7 +19,7 @@ macro_rules! register_builtin {\n                 id: MacroCallId,\n                 tt: &tt::Subtree,\n                 item: &tt::Subtree,\n-            ) -> Result<tt::Subtree, mbe::ExpandError> {\n+            ) -> ExpandResult<tt::Subtree> {\n                 let expander = match *self {\n                     $( BuiltinAttrExpander::$variant => $expand, )*\n                 };\n@@ -64,6 +65,6 @@ fn dummy_attr_expand(\n     _id: MacroCallId,\n     _tt: &tt::Subtree,\n     item: &tt::Subtree,\n-) -> Result<tt::Subtree, mbe::ExpandError> {\n-    Ok(item.clone())\n+) -> ExpandResult<tt::Subtree> {\n+    ExpandResult::ok(item.clone())\n }"}, {"sha": "f2b1895046ac271196bcaa4f5922258ac2200ea9", "filename": "crates/hir_expand/src/db.rs", "status": "modified", "additions": 6, "deletions": 16, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/82728eb7576c46576dfcd3c6b4edc99bd8766572/crates%2Fhir_expand%2Fsrc%2Fdb.rs", "raw_url": "https://github.com/rust-lang/rust/raw/82728eb7576c46576dfcd3c6b4edc99bd8766572/crates%2Fhir_expand%2Fsrc%2Fdb.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_expand%2Fsrc%2Fdb.rs?ref=82728eb7576c46576dfcd3c6b4edc99bd8766572", "patch": "@@ -53,19 +53,16 @@ impl TokenExpander {\n             TokenExpander::MacroRules { mac, .. } => mac.expand(tt),\n             TokenExpander::MacroDef { mac, .. } => mac.expand(tt),\n             TokenExpander::Builtin(it) => it.expand(db, id, tt),\n-            // FIXME switch these to ExpandResult as well\n             TokenExpander::BuiltinAttr(it) => match db.macro_arg(id) {\n-                Some(macro_arg) => it.expand(db, id, tt, &macro_arg.0).into(),\n-                None => mbe::ExpandResult::only_err(\n-                    mbe::ExpandError::Other(\"No item argument for attribute\".to_string()).into(),\n-                ),\n+                Some(macro_arg) => it.expand(db, id, tt, &macro_arg.0),\n+                None => mbe::ExpandResult::str_err(\"No item argument for attribute\".to_string()),\n             },\n             TokenExpander::BuiltinDerive(it) => it.expand(db, id, tt),\n             TokenExpander::ProcMacro(_) => {\n                 // We store the result in salsa db to prevent non-deterministic behavior in\n                 // some proc-macro implementation\n                 // See #4315 for details\n-                db.expand_proc_macro(id).into()\n+                db.expand_proc_macro(id)\n             }\n         }\n     }\n@@ -133,7 +130,7 @@ pub trait AstDatabase: SourceDatabase {\n     /// proc macros, since they are not deterministic in general, and\n     /// non-determinism breaks salsa in a very, very, very bad way. @edwin0cheng\n     /// heroically debugged this once!\n-    fn expand_proc_macro(&self, call: MacroCallId) -> Result<tt::Subtree, mbe::ExpandError>;\n+    fn expand_proc_macro(&self, call: MacroCallId) -> ExpandResult<tt::Subtree>;\n     /// Firewall query that returns the error from the `macro_expand` query.\n     fn macro_expand_error(&self, macro_call: MacroCallId) -> Option<ExpandError>;\n \n@@ -379,18 +376,11 @@ fn macro_expand_error(db: &dyn AstDatabase, macro_call: MacroCallId) -> Option<E\n     db.macro_expand(macro_call).err\n }\n \n-fn expand_proc_macro(\n-    db: &dyn AstDatabase,\n-    id: MacroCallId,\n-) -> Result<tt::Subtree, mbe::ExpandError> {\n+fn expand_proc_macro(db: &dyn AstDatabase, id: MacroCallId) -> ExpandResult<tt::Subtree> {\n     let loc: MacroCallLoc = db.lookup_intern_macro(id);\n     let macro_arg = match db.macro_arg(id) {\n         Some(it) => it,\n-        None => {\n-            return Err(\n-                tt::ExpansionError::Unknown(\"No arguments for proc-macro\".to_string()).into()\n-            )\n-        }\n+        None => return ExpandResult::str_err(\"No arguments for proc-macro\".to_string()),\n     };\n \n     let expander = match loc.def.kind {"}, {"sha": "1e5fff07d5129bb155c00fe1f23841a3ae0c7df5", "filename": "crates/hir_expand/src/proc_macro.rs", "status": "modified", "additions": 8, "deletions": 16, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/82728eb7576c46576dfcd3c6b4edc99bd8766572/crates%2Fhir_expand%2Fsrc%2Fproc_macro.rs", "raw_url": "https://github.com/rust-lang/rust/raw/82728eb7576c46576dfcd3c6b4edc99bd8766572/crates%2Fhir_expand%2Fsrc%2Fproc_macro.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_expand%2Fsrc%2Fproc_macro.rs?ref=82728eb7576c46576dfcd3c6b4edc99bd8766572", "patch": "@@ -2,22 +2,14 @@\n \n use crate::db::AstDatabase;\n use base_db::{CrateId, ProcMacroId};\n+use mbe::ExpandResult;\n \n #[derive(Debug, Clone, Copy, Eq, PartialEq, Hash)]\n pub struct ProcMacroExpander {\n     krate: CrateId,\n     proc_macro_id: Option<ProcMacroId>,\n }\n \n-macro_rules! err {\n-    ($fmt:literal, $($tt:tt),*) => {\n-        mbe::ExpandError::ProcMacroError(tt::ExpansionError::Unknown(format!($fmt, $($tt),*)))\n-    };\n-    ($fmt:literal) => {\n-        mbe::ExpandError::ProcMacroError(tt::ExpansionError::Unknown($fmt.to_string()))\n-    }\n-}\n-\n impl ProcMacroExpander {\n     pub fn new(krate: CrateId, proc_macro_id: ProcMacroId) -> Self {\n         Self { krate, proc_macro_id: Some(proc_macro_id) }\n@@ -38,21 +30,21 @@ impl ProcMacroExpander {\n         calling_crate: CrateId,\n         tt: &tt::Subtree,\n         attr_arg: Option<&tt::Subtree>,\n-    ) -> Result<tt::Subtree, mbe::ExpandError> {\n+    ) -> ExpandResult<tt::Subtree> {\n         match self.proc_macro_id {\n             Some(id) => {\n                 let krate_graph = db.crate_graph();\n-                let proc_macro = krate_graph[self.krate]\n-                    .proc_macro\n-                    .get(id.0 as usize)\n-                    .ok_or_else(|| err!(\"No derive macro found.\"))?;\n+                let proc_macro = match krate_graph[self.krate].proc_macro.get(id.0 as usize) {\n+                    Some(proc_macro) => proc_macro,\n+                    None => return ExpandResult::str_err(\"No derive macro found.\".to_string()),\n+                };\n \n                 // Proc macros have access to the environment variables of the invoking crate.\n                 let env = &krate_graph[calling_crate].env;\n \n-                proc_macro.expander.expand(tt, attr_arg, env).map_err(mbe::ExpandError::from)\n+                proc_macro.expander.expand(tt, attr_arg, env).map_err(mbe::ExpandError::from).into()\n             }\n-            None => Err(mbe::ExpandError::UnresolvedProcMacro),\n+            None => ExpandResult::only_err(mbe::ExpandError::UnresolvedProcMacro),\n         }\n     }\n }"}]}