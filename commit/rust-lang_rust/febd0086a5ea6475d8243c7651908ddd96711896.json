{"sha": "febd0086a5ea6475d8243c7651908ddd96711896", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZlYmQwMDg2YTVlYTY0NzVkODI0M2M3NjUxOTA4ZGRkOTY3MTE4OTY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-10-12T20:59:43Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-10-12T20:59:43Z"}, "message": "Auto merge of #6163 - phansch:remove-one-lazy-static, r=flip1995\n\nRemove lazy_static completely and use once_cell feature instead\n\nFollow-up to https://github.com/rust-lang/rust-clippy/pull/6120\n\nThis removes the last remaining `lazy_static` usages and replaces them with `SyncLazy` from the `once_cell` feature.\n\n---\n\nchangelog: none", "tree": {"sha": "1ba0052a5b0f550cf96ecdf0fffabbb65aff3582", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1ba0052a5b0f550cf96ecdf0fffabbb65aff3582"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/febd0086a5ea6475d8243c7651908ddd96711896", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/febd0086a5ea6475d8243c7651908ddd96711896", "html_url": "https://github.com/rust-lang/rust/commit/febd0086a5ea6475d8243c7651908ddd96711896", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/febd0086a5ea6475d8243c7651908ddd96711896/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "18ffea01eeea09cd273de0ff37e0ac8b5b70f7c5", "url": "https://api.github.com/repos/rust-lang/rust/commits/18ffea01eeea09cd273de0ff37e0ac8b5b70f7c5", "html_url": "https://github.com/rust-lang/rust/commit/18ffea01eeea09cd273de0ff37e0ac8b5b70f7c5"}, {"sha": "7b3493c0e95e8cf9656d2cefffc621cb3e5eb726", "url": "https://api.github.com/repos/rust-lang/rust/commits/7b3493c0e95e8cf9656d2cefffc621cb3e5eb726", "html_url": "https://github.com/rust-lang/rust/commit/7b3493c0e95e8cf9656d2cefffc621cb3e5eb726"}], "stats": {"total": 34, "additions": 16, "deletions": 18}, "files": [{"sha": "13db35f4b0ef0282658db2d542d31d42ce04866f", "filename": "Cargo.toml", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/febd0086a5ea6475d8243c7651908ddd96711896/Cargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/febd0086a5ea6475d8243c7651908ddd96711896/Cargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.toml?ref=febd0086a5ea6475d8243c7651908ddd96711896", "patch": "@@ -34,13 +34,11 @@ clippy_lints = { version = \"0.0.212\", path = \"clippy_lints\" }\n semver = \"0.10\"\n rustc_tools_util = { version = \"0.2.0\", path = \"rustc_tools_util\"}\n tempfile = { version = \"3.1.0\", optional = true }\n-lazy_static = \"1.0\"\n \n [dev-dependencies]\n cargo_metadata = \"0.11.1\"\n compiletest_rs = { version = \"0.5.0\", features = [\"tmp\"] }\n tester = \"0.7\"\n-lazy_static = \"1.0\"\n clippy-mini-macro-test = { version = \"0.2\", path = \"mini-macro\" }\n serde = { version = \"1.0\", features = [\"derive\"] }\n derive-new = \"0.5\""}, {"sha": "556b67e0b3742ec1eee0165cf5937b38d8167d9b", "filename": "clippy_dev/src/update_lints.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/febd0086a5ea6475d8243c7651908ddd96711896/clippy_dev%2Fsrc%2Fupdate_lints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/febd0086a5ea6475d8243c7651908ddd96711896/clippy_dev%2Fsrc%2Fupdate_lints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_dev%2Fsrc%2Fupdate_lints.rs?ref=febd0086a5ea6475d8243c7651908ddd96711896", "patch": "@@ -29,7 +29,7 @@ pub fn run(update_mode: UpdateMode) {\n         false,\n         update_mode == UpdateMode::Change,\n         || {\n-            format!(\"pub static ref ALL_LINTS: Vec<Lint> = vec!{:#?};\", sorted_usable_lints)\n+            format!(\"vec!{:#?}\", sorted_usable_lints)\n                 .lines()\n                 .map(ToString::to_string)\n                 .collect::<Vec<_>>()"}, {"sha": "e5d740cecd31c92dc50d68dee0926a9447148c34", "filename": "src/driver.rs", "status": "modified", "additions": 8, "deletions": 9, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/febd0086a5ea6475d8243c7651908ddd96711896/src%2Fdriver.rs", "raw_url": "https://github.com/rust-lang/rust/raw/febd0086a5ea6475d8243c7651908ddd96711896/src%2Fdriver.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdriver.rs?ref=febd0086a5ea6475d8243c7651908ddd96711896", "patch": "@@ -1,4 +1,5 @@\n #![feature(rustc_private)]\n+#![feature(once_cell)]\n #![cfg_attr(feature = \"deny-warnings\", deny(warnings))]\n // warn on lints, that are included in `rust-lang/rust`s bootstrap\n #![warn(rust_2018_idioms, unused_lifetimes)]\n@@ -17,9 +18,9 @@ use rustc_interface::interface;\n use rustc_middle::ty::TyCtxt;\n use rustc_tools_util::VersionInfo;\n \n-use lazy_static::lazy_static;\n use std::borrow::Cow;\n use std::env;\n+use std::lazy::SyncLazy;\n use std::ops::Deref;\n use std::panic;\n use std::path::{Path, PathBuf};\n@@ -230,13 +231,11 @@ You can use tool lints to allow or deny lints from your code, eg.:\n \n const BUG_REPORT_URL: &str = \"https://github.com/rust-lang/rust-clippy/issues/new\";\n \n-lazy_static! {\n-    static ref ICE_HOOK: Box<dyn Fn(&panic::PanicInfo<'_>) + Sync + Send + 'static> = {\n-        let hook = panic::take_hook();\n-        panic::set_hook(Box::new(|info| report_clippy_ice(info, BUG_REPORT_URL)));\n-        hook\n-    };\n-}\n+static ICE_HOOK: SyncLazy<Box<dyn Fn(&panic::PanicInfo<'_>) + Sync + Send + 'static>> = SyncLazy::new(|| {\n+    let hook = panic::take_hook();\n+    panic::set_hook(Box::new(|info| report_clippy_ice(info, BUG_REPORT_URL)));\n+    hook\n+});\n \n fn report_clippy_ice(info: &panic::PanicInfo<'_>, bug_report_url: &str) {\n     // Invoke our ICE handler, which prints the actual panic message and optionally a backtrace\n@@ -295,7 +294,7 @@ fn toolchain_path(home: Option<String>, toolchain: Option<String>) -> Option<Pat\n \n pub fn main() {\n     rustc_driver::init_rustc_env_logger();\n-    lazy_static::initialize(&ICE_HOOK);\n+    SyncLazy::force(&ICE_HOOK);\n     exit(rustc_driver::catch_with_exit_code(move || {\n         let mut orig_args: Vec<String> = env::args().collect();\n "}, {"sha": "624223ff70620592a1b358fd2ba9a4a1130018ea", "filename": "src/lintlist/mod.rs", "status": "modified", "additions": 7, "deletions": 6, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/febd0086a5ea6475d8243c7651908ddd96711896/src%2Flintlist%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/febd0086a5ea6475d8243c7651908ddd96711896/src%2Flintlist%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flintlist%2Fmod.rs?ref=febd0086a5ea6475d8243c7651908ddd96711896", "patch": "@@ -1,15 +1,16 @@\n-//! This file is managed by `cargo dev update_lints`. Do not edit.\n+//! This file is managed by `cargo dev update_lints`. Do not edit or format this file.\n \n-use lazy_static::lazy_static;\n+use std::lazy::SyncLazy;\n \n pub mod lint;\n pub use lint::Level;\n pub use lint::Lint;\n pub use lint::LINT_LEVELS;\n \n-lazy_static! {\n+#[rustfmt::skip]\n+pub static ALL_LINTS: SyncLazy<Vec<Lint>> = SyncLazy::new(|| {\n // begin lint list, do not remove this comment, it\u2019s used in `update_lints`\n-pub static ref ALL_LINTS: Vec<Lint> = vec![\n+vec![\n     Lint {\n         name: \"absurd_extreme_comparisons\",\n         group: \"correctness\",\n@@ -2831,6 +2832,6 @@ pub static ref ALL_LINTS: Vec<Lint> = vec![\n         deprecation: None,\n         module: \"methods\",\n     },\n-];\n+]\n // end lint list, do not remove this comment, it\u2019s used in `update_lints`\n-}\n+});"}]}