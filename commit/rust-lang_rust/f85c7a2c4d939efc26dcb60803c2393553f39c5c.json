{"sha": "f85c7a2c4d939efc26dcb60803c2393553f39c5c", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY4NWM3YTJjNGQ5MzllZmMyNmRjYjYwODAzYzIzOTM1NTNmMzljNWM=", "commit": {"author": {"name": "Eduard-Mihai Burtescu", "email": "edy.burt@gmail.com", "date": "2017-05-31T15:36:09Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2017-05-31T15:36:09Z"}, "message": "Merge pull request #173 from dwrensha/fix-tls-test\n\nfix thread-local-no-dtor test on MacOS and ignore it on Windows", "tree": {"sha": "e27dca0235c16bab1461ca49e670499fad6c95d9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e27dca0235c16bab1461ca49e670499fad6c95d9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f85c7a2c4d939efc26dcb60803c2393553f39c5c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f85c7a2c4d939efc26dcb60803c2393553f39c5c", "html_url": "https://github.com/rust-lang/rust/commit/f85c7a2c4d939efc26dcb60803c2393553f39c5c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f85c7a2c4d939efc26dcb60803c2393553f39c5c/comments", "author": {"login": "eddyb", "id": 77424, "node_id": "MDQ6VXNlcjc3NDI0", "avatar_url": "https://avatars.githubusercontent.com/u/77424?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eddyb", "html_url": "https://github.com/eddyb", "followers_url": "https://api.github.com/users/eddyb/followers", "following_url": "https://api.github.com/users/eddyb/following{/other_user}", "gists_url": "https://api.github.com/users/eddyb/gists{/gist_id}", "starred_url": "https://api.github.com/users/eddyb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eddyb/subscriptions", "organizations_url": "https://api.github.com/users/eddyb/orgs", "repos_url": "https://api.github.com/users/eddyb/repos", "events_url": "https://api.github.com/users/eddyb/events{/privacy}", "received_events_url": "https://api.github.com/users/eddyb/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c817e6e4b3bc2879b08390fb2f5a421467397910", "url": "https://api.github.com/repos/rust-lang/rust/commits/c817e6e4b3bc2879b08390fb2f5a421467397910", "html_url": "https://github.com/rust-lang/rust/commit/c817e6e4b3bc2879b08390fb2f5a421467397910"}, {"sha": "7624bca09e367d50d264d5b2304c9e55db111838", "url": "https://api.github.com/repos/rust-lang/rust/commits/7624bca09e367d50d264d5b2304c9e55db111838", "html_url": "https://github.com/rust-lang/rust/commit/7624bca09e367d50d264d5b2304c9e55db111838"}], "stats": {"total": 16, "additions": 9, "deletions": 7}, "files": [{"sha": "3c254734b328d6a40bbabaec1cf68c5417b9659e", "filename": "src/terminator/mod.rs", "status": "modified", "additions": 7, "deletions": 7, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/f85c7a2c4d939efc26dcb60803c2393553f39c5c/src%2Fterminator%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f85c7a2c4d939efc26dcb60803c2393553f39c5c/src%2Fterminator%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fterminator%2Fmod.rs?ref=f85c7a2c4d939efc26dcb60803c2393553f39c5c", "patch": "@@ -724,11 +724,11 @@ impl<'a, 'tcx> EvalContext<'a, 'tcx> {\n             // Hook pthread calls that go to the thread-local storage memory subsystem\n             \"pthread_key_create\" => {\n                 let key_ptr = args[0].read_ptr(&self.memory)?;\n-                \n+\n                 // Extract the function type out of the signature (that seems easier than constructing it ourselves...)\n                 let dtor_ptr = args[1].read_ptr(&self.memory)?;\n                 let dtor = if dtor_ptr.is_null_ptr() { None } else { Some(self.memory.get_fn(dtor_ptr.alloc_id)?) };\n-                \n+\n                 // Figure out how large a pthread TLS key actually is. This is libc::pthread_key_t.\n                 let key_size = match self.operand_ty(&arg_operands[0]).sty {\n                     TypeVariants::TyRawPtr(TypeAndMut { ty, .. }) => {\n@@ -737,14 +737,14 @@ impl<'a, 'tcx> EvalContext<'a, 'tcx> {\n                     }\n                     _ => return Err(EvalError::AbiViolation(\"Wrong signature used for pthread_key_create: First argument must be a raw pointer.\".to_owned()))\n                 };\n-                \n+\n                 // Create key and write it into the memory where key_ptr wants it\n-                let key = self.memory.create_tls_key(dtor);\n-                if key >= (1 << key_size.bits()) {\n+                let key = self.memory.create_tls_key(dtor) as u128;\n+                if key_size.bits() < 128 && key >= (1u128 << key_size.bits() as u128) {\n                     return Err(EvalError::OutOfTls);\n                 }\n-                self.memory.write_int(key_ptr, key as i128, key_size.bytes())?;\n-                \n+                self.memory.write_uint(key_ptr, key, key_size.bytes())?;\n+\n                 // Return success (0)\n                 self.write_primval(dest, PrimVal::Bytes(0), dest_ty)?;\n             }"}, {"sha": "d5e2051edb70210c3fc9d0bb7bdfca1f7cf23cec", "filename": "tests/run-pass/thread-local-no-dtor.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f85c7a2c4d939efc26dcb60803c2393553f39c5c/tests%2Frun-pass%2Fthread-local-no-dtor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f85c7a2c4d939efc26dcb60803c2393553f39c5c/tests%2Frun-pass%2Fthread-local-no-dtor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-pass%2Fthread-local-no-dtor.rs?ref=f85c7a2c4d939efc26dcb60803c2393553f39c5c", "patch": "@@ -1,3 +1,5 @@\n+//ignore-windows-gnu\n+\n #![feature(libc)]\n extern crate libc;\n "}]}