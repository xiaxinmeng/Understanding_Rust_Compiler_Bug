{"sha": "817b7e0c11d90888a982243f1d5af3ff1d19cf5e", "node_id": "MDY6Q29tbWl0NzI0NzEyOjgxN2I3ZTBjMTFkOTA4ODhhOTgyMjQzZjFkNWFmM2ZmMWQxOWNmNWU=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2021-04-19T20:00:01Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-04-19T20:00:01Z"}, "message": "Rollup merge of #84123 - bjorn3:compile_mono_item_dep_node, r=wesleywiser\n\nIntroduce CompileMonoItem DepNode\n\nThis is likely required for allowing efficient hot code swap support in cg_clif's jit mode. My prototype currently requires re-compiling all functions, which is both slow and uses a lot of memory as there is not support for freeing the memory used by replaced functions yet.\n\ncc https://github.com/bjorn3/rustc_codegen_cranelift/issues/1087", "tree": {"sha": "4c1f9efffd282f8c88185b3f2b086f822192b49f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4c1f9efffd282f8c88185b3f2b086f822192b49f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/817b7e0c11d90888a982243f1d5af3ff1d19cf5e", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgfeFBCRBK7hj4Ov3rIwAAfWIIADsA3RPJNLYmt7SHR8G3N/hs\nWWtXvGanLJq7vj0y8ZEdC0AJiLm8lAUbcnRyMauiphE3HA5Yv72Ub8/M6Rx+wZnT\n9eVs0xWIF6lNeo0H6BwlkXFqLJaK8hQ5bnLOv7GINSPW8jJw5nDui++xLq2UunJa\nAFcA8+4VkOLrXgEyxkJRr+kpa2dHn2m8Ealfi6Ub9QAFJOjgswuGaZJ03MhI0nCW\nXX7yv2Rlnm3iDlyct0niQ8q4inJjFVJLb0YEXOo2AjR54XkEFTIsX/3C9i5s2ujz\nC9ON2H4/3l7Pzo3NPbMLXy+Wl8XYuo3sg67KraTaBSq5V7r8mpEsXAiKqiaKMK4=\n=ZchK\n-----END PGP SIGNATURE-----\n", "payload": "tree 4c1f9efffd282f8c88185b3f2b086f822192b49f\nparent 41f0e13bc53396852f4f1338ce5d8be0d1125b08\nparent 21f13afafe1cf33e1a3b8eeeb31f73868b9a9e2b\nauthor Dylan DPC <dylan.dpc@gmail.com> 1618862401 +0200\ncommitter GitHub <noreply@github.com> 1618862401 +0200\n\nRollup merge of #84123 - bjorn3:compile_mono_item_dep_node, r=wesleywiser\n\nIntroduce CompileMonoItem DepNode\n\nThis is likely required for allowing efficient hot code swap support in cg_clif's jit mode. My prototype currently requires re-compiling all functions, which is both slow and uses a lot of memory as there is not support for freeing the memory used by replaced functions yet.\n\ncc https://github.com/bjorn3/rustc_codegen_cranelift/issues/1087\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/817b7e0c11d90888a982243f1d5af3ff1d19cf5e", "html_url": "https://github.com/rust-lang/rust/commit/817b7e0c11d90888a982243f1d5af3ff1d19cf5e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/817b7e0c11d90888a982243f1d5af3ff1d19cf5e/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "41f0e13bc53396852f4f1338ce5d8be0d1125b08", "url": "https://api.github.com/repos/rust-lang/rust/commits/41f0e13bc53396852f4f1338ce5d8be0d1125b08", "html_url": "https://github.com/rust-lang/rust/commit/41f0e13bc53396852f4f1338ce5d8be0d1125b08"}, {"sha": "21f13afafe1cf33e1a3b8eeeb31f73868b9a9e2b", "url": "https://api.github.com/repos/rust-lang/rust/commits/21f13afafe1cf33e1a3b8eeeb31f73868b9a9e2b", "html_url": "https://github.com/rust-lang/rust/commit/21f13afafe1cf33e1a3b8eeeb31f73868b9a9e2b"}], "stats": {"total": 48, "additions": 39, "deletions": 9}, "files": [{"sha": "aa54d1ae7b9d118426d9702dac6384725e0b50c4", "filename": "compiler/rustc_middle/src/dep_graph/dep_node.rs", "status": "modified", "additions": 28, "deletions": 8, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/817b7e0c11d90888a982243f1d5af3ff1d19cf5e/compiler%2Frustc_middle%2Fsrc%2Fdep_graph%2Fdep_node.rs", "raw_url": "https://github.com/rust-lang/rust/raw/817b7e0c11d90888a982243f1d5af3ff1d19cf5e/compiler%2Frustc_middle%2Fsrc%2Fdep_graph%2Fdep_node.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fdep_graph%2Fdep_node.rs?ref=817b7e0c11d90888a982243f1d5af3ff1d19cf5e", "patch": "@@ -32,8 +32,8 @@\n //! `DepNode` definition happens in the `define_dep_nodes!()` macro. This macro\n //! defines the `DepKind` enum. Each `DepKind` has its own parameters that are\n //! needed at runtime in order to construct a valid `DepNode` fingerprint.\n-//! However, only `CompileCodegenUnit` is constructed explicitly (with\n-//! `make_compile_codegen_unit`).\n+//! However, only `CompileCodegenUnit` and `CompileMonoItem` are constructed\n+//! explicitly (with `make_compile_codegen_unit` cq `make_compile_mono_item`).\n //!\n //! Because the macro sees what parameters a given `DepKind` requires, it can\n //! \"infer\" some properties for each kind of `DepNode`:\n@@ -46,15 +46,17 @@\n //!   `DefId` it was computed from. In other cases, too much information gets\n //!   lost during fingerprint computation.\n //!\n-//! `make_compile_codegen_unit`, together with `DepNode::new()`, ensures that only\n-//! valid `DepNode` instances can be constructed. For example, the API does not\n-//! allow for constructing parameterless `DepNode`s with anything other\n-//! than a zeroed out fingerprint. More generally speaking, it relieves the\n-//! user of the `DepNode` API of having to know how to compute the expected\n-//! fingerprint for a given set of node parameters.\n+//! `make_compile_codegen_unit` and `make_compile_mono_items`, together with\n+//! `DepNode::new()`, ensures that only valid `DepNode` instances can be\n+//! constructed. For example, the API does not allow for constructing\n+//! parameterless `DepNode`s with anything other than a zeroed out fingerprint.\n+//! More generally speaking, it relieves the user of the `DepNode` API of\n+//! having to know how to compute the expected fingerprint for a given set of\n+//! node parameters.\n //!\n //! [dependency graph]: https://rustc-dev-guide.rust-lang.org/query.html\n \n+use crate::mir::mono::MonoItem;\n use crate::ty::TyCtxt;\n \n use rustc_data_structures::fingerprint::Fingerprint;\n@@ -175,6 +177,14 @@ pub mod dep_kind {\n         can_reconstruct_query_key: || false,\n     };\n \n+    pub const CompileMonoItem: DepKindStruct = DepKindStruct {\n+        has_params: true,\n+        is_anon: false,\n+        is_eval_always: false,\n+\n+        can_reconstruct_query_key: || false,\n+    };\n+\n     macro_rules! define_query_dep_kinds {\n         ($(\n             [$($attrs:tt)*]\n@@ -251,6 +261,10 @@ rustc_dep_node_append!([define_dep_nodes!][ <'tcx>\n \n     // WARNING: if `Symbol` is changed, make sure you update `make_compile_codegen_unit` below.\n     [] CompileCodegenUnit(Symbol),\n+\n+    // WARNING: if `MonoItem` is changed, make sure you update `make_compile_mono_item` below.\n+    // Only used by rustc_codegen_cranelift\n+    [] CompileMonoItem(MonoItem),\n ]);\n \n // WARNING: `construct` is generic and does not know that `CompileCodegenUnit` takes `Symbol`s as keys.\n@@ -259,6 +273,12 @@ crate fn make_compile_codegen_unit(tcx: TyCtxt<'_>, name: Symbol) -> DepNode {\n     DepNode::construct(tcx, DepKind::CompileCodegenUnit, &name)\n }\n \n+// WARNING: `construct` is generic and does not know that `CompileMonoItem` takes `MonoItem`s as keys.\n+// Be very careful changing this type signature!\n+crate fn make_compile_mono_item(tcx: TyCtxt<'tcx>, mono_item: &MonoItem<'tcx>) -> DepNode {\n+    DepNode::construct(tcx, DepKind::CompileMonoItem, mono_item)\n+}\n+\n pub type DepNode = rustc_query_system::dep_graph::DepNode<DepKind>;\n \n // We keep a lot of `DepNode`s in memory during compilation. It's not"}, {"sha": "31bea8329587d7469350bd4bc8c550f2a9fbf029", "filename": "compiler/rustc_middle/src/dep_graph/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/817b7e0c11d90888a982243f1d5af3ff1d19cf5e/compiler%2Frustc_middle%2Fsrc%2Fdep_graph%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/817b7e0c11d90888a982243f1d5af3ff1d19cf5e/compiler%2Frustc_middle%2Fsrc%2Fdep_graph%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fdep_graph%2Fmod.rs?ref=817b7e0c11d90888a982243f1d5af3ff1d19cf5e", "patch": "@@ -12,8 +12,8 @@ pub use rustc_query_system::dep_graph::{\n     SerializedDepNodeIndex, WorkProduct, WorkProductId,\n };\n \n-crate use dep_node::make_compile_codegen_unit;\n pub use dep_node::{label_strs, DepKind, DepNode, DepNodeExt};\n+crate use dep_node::{make_compile_codegen_unit, make_compile_mono_item};\n \n pub type DepGraph = rustc_query_system::dep_graph::DepGraph<DepKind>;\n pub type TaskDeps = rustc_query_system::dep_graph::TaskDeps<DepKind>;"}, {"sha": "92a1094bbcdc1bbdfb3bb7b6953bac7d8574c8a1", "filename": "compiler/rustc_middle/src/mir/mono.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/817b7e0c11d90888a982243f1d5af3ff1d19cf5e/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmono.rs", "raw_url": "https://github.com/rust-lang/rust/raw/817b7e0c11d90888a982243f1d5af3ff1d19cf5e/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmono.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmono.rs?ref=817b7e0c11d90888a982243f1d5af3ff1d19cf5e", "patch": "@@ -181,6 +181,11 @@ impl<'tcx> MonoItem<'tcx> {\n         }\n         .map(|hir_id| tcx.hir().span(hir_id))\n     }\n+\n+    // Only used by rustc_codegen_cranelift\n+    pub fn codegen_dep_node(&self, tcx: TyCtxt<'tcx>) -> DepNode {\n+        crate::dep_graph::make_compile_mono_item(tcx, self)\n+    }\n }\n \n impl<'a, 'tcx> HashStable<StableHashingContext<'a>> for MonoItem<'tcx> {"}, {"sha": "ee914fa1ba95cfb2cedf993b0a1da6168042dd79", "filename": "compiler/rustc_query_impl/src/plumbing.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/817b7e0c11d90888a982243f1d5af3ff1d19cf5e/compiler%2Frustc_query_impl%2Fsrc%2Fplumbing.rs", "raw_url": "https://github.com/rust-lang/rust/raw/817b7e0c11d90888a982243f1d5af3ff1d19cf5e/compiler%2Frustc_query_impl%2Fsrc%2Fplumbing.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_query_impl%2Fsrc%2Fplumbing.rs?ref=817b7e0c11d90888a982243f1d5af3ff1d19cf5e", "patch": "@@ -438,6 +438,11 @@ macro_rules! define_queries {\n                 try_load_from_on_disk_cache: |_, _| {},\n             };\n \n+            pub const CompileMonoItem: QueryStruct = QueryStruct {\n+                force_from_dep_node: |_, _| false,\n+                try_load_from_on_disk_cache: |_, _| {},\n+            };\n+\n             $(pub const $name: QueryStruct = {\n                 const is_anon: bool = is_anon!([$($modifiers)*]);\n "}]}