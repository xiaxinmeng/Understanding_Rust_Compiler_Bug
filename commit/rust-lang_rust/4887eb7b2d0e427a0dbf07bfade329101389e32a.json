{"sha": "4887eb7b2d0e427a0dbf07bfade329101389e32a", "node_id": "C_kwDOAAsO6NoAKDQ4ODdlYjdiMmQwZTQyN2EwZGJmMDdiZmFkZTMyOTEwMTM4OWUzMmE", "commit": {"author": {"name": "xFrednet", "email": "xFrednet@gmail.com", "date": "2021-11-25T20:59:55Z"}, "committer": {"name": "xFrednet", "email": "xFrednet@gmail.com", "date": "2022-03-02T16:46:11Z"}, "message": "Added `panics` for unreachable states for expectations (RFC 2383)", "tree": {"sha": "99a66b235c44ff2245378a0747057033903642e2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/99a66b235c44ff2245378a0747057033903642e2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4887eb7b2d0e427a0dbf07bfade329101389e32a", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEsfZNmu/fmIv8KDcv/Ny/Ka9k1gEFAmIfn1MACgkQ/Ny/Ka9k\n1gGPKhAAlMZAsWtEe8w4BLvpkmhcn2ZXYTmTmtWTmYSrKusOvdxFn4WWTpefEQyY\nkc41N1MVKorn9jXTxaivj11wpR2UBYRs1nfYa9BjicHGc3atIfJ/wG87G14IwpWC\nihz15oUWWVT8WgsRFvEUnJ9gdgqXn+DGQyjwhHHFdzFETVcDrABPHNY/2MChjhyC\no1aYUZrpsqhbKgOZLcf0CE5TvPLlHDLBnuU8FuA0sLx11OOE++mfS4h+Sr1k+Wkb\nUivNWA0gFcyxGnw2kZ9QNwPjgdrR5gfJQMgR9F4IFAiQn2O5Vtpt2o8c8XyR/HmU\nKpKfSH7CQAOBfjHWju/McVI9tyApTmxQSTegnezPWSC9ws8vv69Z+T6bWNdRRnpU\noiEebW4+6VQ5YEhU1upBtINzib7rDZzWq7yTsOL9XclXoMZkYh0v5epChEkVOLnv\ng3NtQeRQ673kkBx3T7FUF3lwmqntS+bv8APSjxtr57MQxQd6HU3kh6k1opSe/4n6\nnLA+1UgTd0guCc476EVl5lW9OT9gauCV+XvRSlYRHuaAv/kREMGk4l3v6iQCYfLN\nK332Y3yoxZDnhsgXGwCX/IcjfgfECMpEflIkW3Q+2jqZqTIiTJLCTQhNLMRR89u4\nb9qbxr+HIhAAH03hVYy5YNXsQ+wEW7T8r9By2V3F22BqK1jWlmE=\n=jBG+\n-----END PGP SIGNATURE-----", "payload": "tree 99a66b235c44ff2245378a0747057033903642e2\nparent 3414ad95517933c40d8e66c14b951ee5ede3e0cb\nauthor xFrednet <xFrednet@gmail.com> 1637873995 +0100\ncommitter xFrednet <xFrednet@gmail.com> 1646239571 +0100\n\nAdded `panics` for unreachable states for expectations (RFC 2383)\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4887eb7b2d0e427a0dbf07bfade329101389e32a", "html_url": "https://github.com/rust-lang/rust/commit/4887eb7b2d0e427a0dbf07bfade329101389e32a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4887eb7b2d0e427a0dbf07bfade329101389e32a/comments", "author": {"login": "xFrednet", "id": 17087237, "node_id": "MDQ6VXNlcjE3MDg3MjM3", "avatar_url": "https://avatars.githubusercontent.com/u/17087237?v=4", "gravatar_id": "", "url": "https://api.github.com/users/xFrednet", "html_url": "https://github.com/xFrednet", "followers_url": "https://api.github.com/users/xFrednet/followers", "following_url": "https://api.github.com/users/xFrednet/following{/other_user}", "gists_url": "https://api.github.com/users/xFrednet/gists{/gist_id}", "starred_url": "https://api.github.com/users/xFrednet/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/xFrednet/subscriptions", "organizations_url": "https://api.github.com/users/xFrednet/orgs", "repos_url": "https://api.github.com/users/xFrednet/repos", "events_url": "https://api.github.com/users/xFrednet/events{/privacy}", "received_events_url": "https://api.github.com/users/xFrednet/received_events", "type": "User", "site_admin": false}, "committer": {"login": "xFrednet", "id": 17087237, "node_id": "MDQ6VXNlcjE3MDg3MjM3", "avatar_url": "https://avatars.githubusercontent.com/u/17087237?v=4", "gravatar_id": "", "url": "https://api.github.com/users/xFrednet", "html_url": "https://github.com/xFrednet", "followers_url": "https://api.github.com/users/xFrednet/followers", "following_url": "https://api.github.com/users/xFrednet/following{/other_user}", "gists_url": "https://api.github.com/users/xFrednet/gists{/gist_id}", "starred_url": "https://api.github.com/users/xFrednet/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/xFrednet/subscriptions", "organizations_url": "https://api.github.com/users/xFrednet/orgs", "repos_url": "https://api.github.com/users/xFrednet/repos", "events_url": "https://api.github.com/users/xFrednet/events{/privacy}", "received_events_url": "https://api.github.com/users/xFrednet/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3414ad95517933c40d8e66c14b951ee5ede3e0cb", "url": "https://api.github.com/repos/rust-lang/rust/commits/3414ad95517933c40d8e66c14b951ee5ede3e0cb", "html_url": "https://github.com/rust-lang/rust/commit/3414ad95517933c40d8e66c14b951ee5ede3e0cb"}], "stats": {"total": 30, "additions": 18, "deletions": 12}, "files": [{"sha": "6dc91a5aa9c98465e893f9b45a753ec354f19caf", "filename": "compiler/rustc_errors/src/lib.rs", "status": "modified", "additions": 16, "deletions": 12, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/4887eb7b2d0e427a0dbf07bfade329101389e32a/compiler%2Frustc_errors%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4887eb7b2d0e427a0dbf07bfade329101389e32a/compiler%2Frustc_errors%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_errors%2Fsrc%2Flib.rs?ref=4887eb7b2d0e427a0dbf07bfade329101389e32a", "patch": "@@ -942,18 +942,22 @@ impl Handler {\n \n         let mut inner = self.inner.borrow_mut();\n         for mut diag in diags.into_iter() {\n-            if let Some(mut unstable_id) = diag.level.get_expectation_id() {\n-                let lint_index = unstable_id.get_lint_index();\n-\n-                // The unstable to stable map only maps the unstable it to a stable id\n-                // the lint index is manually transferred here.\n-                unstable_id.set_lint_index(None);\n-                if let Some(mut stable_id) = unstable_to_stable.get(&unstable_id).map(|id| *id) {\n-                    stable_id.set_lint_index(lint_index);\n-                    diag.level = Level::Expect(stable_id);\n-                    inner.fulfilled_expectations.insert(stable_id);\n-                }\n-            }\n+            let mut unstable_id = diag\n+                .level\n+                .get_expectation_id()\n+                .expect(\"all diagnostics inside `unstable_expect_diagnostics` must have a `LintExpectationId`\");\n+\n+            // The unstable to stable map only maps the unstable it to a stable id\n+            // the lint index is manually transferred here.\n+            let lint_index = unstable_id.get_lint_index();\n+            unstable_id.set_lint_index(None);\n+            let mut stable_id = *unstable_to_stable\n+                .get(&unstable_id)\n+                .expect(\"each unstable `LintExpectationId` must have a matching stable id\");\n+\n+            stable_id.set_lint_index(lint_index);\n+            diag.level = Level::Expect(stable_id);\n+            inner.fulfilled_expectations.insert(stable_id);\n \n             (*TRACK_DIAGNOSTICS)(&diag);\n         }"}, {"sha": "7611b41b97eace2167914abba953bee246c3b026", "filename": "compiler/rustc_lint/src/expect.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/4887eb7b2d0e427a0dbf07bfade329101389e32a/compiler%2Frustc_lint%2Fsrc%2Fexpect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4887eb7b2d0e427a0dbf07bfade329101389e32a/compiler%2Frustc_lint%2Fsrc%2Fexpect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_lint%2Fsrc%2Fexpect.rs?ref=4887eb7b2d0e427a0dbf07bfade329101389e32a", "patch": "@@ -20,6 +20,8 @@ pub fn check_expectations(tcx: TyCtxt<'_>) {\n             // holds stable ids\n             if let LintExpectationId::Stable { hir_id, .. } = id {\n                 emit_unfulfilled_expectation_lint(tcx, *hir_id, expectation);\n+            } else {\n+                unreachable!(\"at this stage all `LintExpectationId`s are stable\");\n             }\n         }\n     }"}]}