{"sha": "f635c3757b61d1d8aefa86e1d3acdd7d4dea90f8", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY2MzVjMzc1N2I2MWQxZDhhZWZhODZlMWQzYWNkZDdkNGRlYTkwZjg=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2020-03-27T00:23:49Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-03-27T00:23:49Z"}, "message": "Rollup merge of #69936 - Aaron1011:fix/suggestion-cycle, r=varkor\n\nFix cycle error when emitting suggestion for mismatched `fn` type\n\nFixes #66667\n\nPreviously, we called `tcx.typeck_tables_of` when determining whether or\nnot to emit a suggestion for a type error. However, we might already be\ntype-checking the `DefId` we pass to `typeck_tables_of` (it could be\nanywhere in the query stack).\n\nFortunately, we only need the function signature, not the entire\n`TypeckTables`. By using `tcx.fn_sig`, we avoid the possibility of cycle\nerrors while retaining the ability to emit a suggestion.", "tree": {"sha": "bb74d25bb9075d792b67a5f8b5132e792773b963", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bb74d25bb9075d792b67a5f8b5132e792773b963"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f635c3757b61d1d8aefa86e1d3acdd7d4dea90f8", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJefUeVCRBK7hj4Ov3rIwAAdHIIADHIf6cn/INaQQah6cs+el1m\nuNtA1WLzqj9Dde1wf4nkHtiDkgLZsanOY+RJ2lTi82xnr8neX4auNyxK/Sds9Zh3\nODdAjpbSFWzK5P6rfXtsJG168mrqzteKsc2VZJtYDxR7VnVcWDV5HR7KHHss4LvT\nRdUQ1etEV2XLNNALvw+zKQq47k4ocAy7L1vhvoMmg0ZfxP13y4ohSgTc9tt8CREi\nDOVPuugqw6sPssxieyGFv+Mlxn72ktWA6g99JnOvBpwyQloT9XxLVCfkcbOIhGN1\nAGiSZmKL4V01EC0gEKsOafYL1zqVdYL5VDbJiPeizppfVWx1JkxHmBLBg7JIRac=\n=jvEi\n-----END PGP SIGNATURE-----\n", "payload": "tree bb74d25bb9075d792b67a5f8b5132e792773b963\nparent 0f6144a115b2535feb8a84914105a2896e7e8e92\nparent ff65bffe2b143528ff90d5226b18ceca750d7c02\nauthor Dylan DPC <dylan.dpc@gmail.com> 1585268629 +0100\ncommitter GitHub <noreply@github.com> 1585268629 +0100\n\nRollup merge of #69936 - Aaron1011:fix/suggestion-cycle, r=varkor\n\nFix cycle error when emitting suggestion for mismatched `fn` type\n\nFixes #66667\n\nPreviously, we called `tcx.typeck_tables_of` when determining whether or\nnot to emit a suggestion for a type error. However, we might already be\ntype-checking the `DefId` we pass to `typeck_tables_of` (it could be\nanywhere in the query stack).\n\nFortunately, we only need the function signature, not the entire\n`TypeckTables`. By using `tcx.fn_sig`, we avoid the possibility of cycle\nerrors while retaining the ability to emit a suggestion.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f635c3757b61d1d8aefa86e1d3acdd7d4dea90f8", "html_url": "https://github.com/rust-lang/rust/commit/f635c3757b61d1d8aefa86e1d3acdd7d4dea90f8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f635c3757b61d1d8aefa86e1d3acdd7d4dea90f8/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0f6144a115b2535feb8a84914105a2896e7e8e92", "url": "https://api.github.com/repos/rust-lang/rust/commits/0f6144a115b2535feb8a84914105a2896e7e8e92", "html_url": "https://github.com/rust-lang/rust/commit/0f6144a115b2535feb8a84914105a2896e7e8e92"}, {"sha": "ff65bffe2b143528ff90d5226b18ceca750d7c02", "url": "https://api.github.com/repos/rust-lang/rust/commits/ff65bffe2b143528ff90d5226b18ceca750d7c02", "html_url": "https://github.com/rust-lang/rust/commit/ff65bffe2b143528ff90d5226b18ceca750d7c02"}], "stats": {"total": 97, "additions": 75, "deletions": 22}, "files": [{"sha": "657926a1825fa307ecc058b2321ff4f22001f040", "filename": "src/librustc_typeck/check/op.rs", "status": "modified", "additions": 4, "deletions": 22, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/f635c3757b61d1d8aefa86e1d3acdd7d4dea90f8/src%2Flibrustc_typeck%2Fcheck%2Fop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f635c3757b61d1d8aefa86e1d3acdd7d4dea90f8/src%2Flibrustc_typeck%2Fcheck%2Fop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fop.rs?ref=f635c3757b61d1d8aefa86e1d3acdd7d4dea90f8", "patch": "@@ -492,36 +492,18 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         err.span_label(span, ty.to_string());\n         if let FnDef(def_id, _) = ty.kind {\n             let source_map = self.tcx.sess.source_map();\n-            let hir_id = match self.tcx.hir().as_local_hir_id(def_id) {\n-                Some(hir_id) => hir_id,\n-                None => return false,\n-            };\n             if !self.tcx.has_typeck_tables(def_id) {\n                 return false;\n             }\n-            let fn_sig = {\n-                match self.tcx.typeck_tables_of(def_id).liberated_fn_sigs().get(hir_id) {\n-                    Some(f) => *f,\n-                    None => {\n-                        bug!(\"No fn-sig entry for def_id={:?}\", def_id);\n-                    }\n-                }\n-            };\n+            // We're emitting a suggestion, so we can just ignore regions\n+            let fn_sig = *self.tcx.fn_sig(def_id).skip_binder();\n \n             let other_ty = if let FnDef(def_id, _) = other_ty.kind {\n-                let hir_id = match self.tcx.hir().as_local_hir_id(def_id) {\n-                    Some(hir_id) => hir_id,\n-                    None => return false,\n-                };\n                 if !self.tcx.has_typeck_tables(def_id) {\n                     return false;\n                 }\n-                match self.tcx.typeck_tables_of(def_id).liberated_fn_sigs().get(hir_id) {\n-                    Some(f) => f.clone().output(),\n-                    None => {\n-                        bug!(\"No fn-sig entry for def_id={:?}\", def_id);\n-                    }\n-                }\n+                // We're emitting a suggestion, so we can just ignore regions\n+                self.tcx.fn_sig(def_id).skip_binder().output()\n             } else {\n                 other_ty\n             };"}, {"sha": "7b025be11a09edc0f57678591aa3f00836d87947", "filename": "src/test/ui/issues/issue-66667-function-cmp-cycle.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/f635c3757b61d1d8aefa86e1d3acdd7d4dea90f8/src%2Ftest%2Fui%2Fissues%2Fissue-66667-function-cmp-cycle.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f635c3757b61d1d8aefa86e1d3acdd7d4dea90f8/src%2Ftest%2Fui%2Fissues%2Fissue-66667-function-cmp-cycle.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-66667-function-cmp-cycle.rs?ref=f635c3757b61d1d8aefa86e1d3acdd7d4dea90f8", "patch": "@@ -0,0 +1,16 @@\n+fn first() {\n+    second == 1 //~ ERROR binary operation\n+    //~^ ERROR mismatched types\n+}\n+\n+fn second() {\n+    first == 1 //~ ERROR binary operation\n+    //~^ ERROR mismatched types\n+}\n+\n+fn bar() {\n+    bar == 1 //~ ERROR binary operation\n+    //~^ ERROR mismatched types\n+}\n+\n+fn main() {}"}, {"sha": "887699ef5ce85e09b038e8f5122a7a7f2f486111", "filename": "src/test/ui/issues/issue-66667-function-cmp-cycle.stderr", "status": "added", "additions": 55, "deletions": 0, "changes": 55, "blob_url": "https://github.com/rust-lang/rust/blob/f635c3757b61d1d8aefa86e1d3acdd7d4dea90f8/src%2Ftest%2Fui%2Fissues%2Fissue-66667-function-cmp-cycle.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/f635c3757b61d1d8aefa86e1d3acdd7d4dea90f8/src%2Ftest%2Fui%2Fissues%2Fissue-66667-function-cmp-cycle.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-66667-function-cmp-cycle.stderr?ref=f635c3757b61d1d8aefa86e1d3acdd7d4dea90f8", "patch": "@@ -0,0 +1,55 @@\n+error[E0369]: binary operation `==` cannot be applied to type `fn() {second}`\n+  --> $DIR/issue-66667-function-cmp-cycle.rs:2:12\n+   |\n+LL |     second == 1\n+   |     ------ ^^ - {integer}\n+   |     |\n+   |     fn() {second}\n+\n+error[E0308]: mismatched types\n+  --> $DIR/issue-66667-function-cmp-cycle.rs:2:15\n+   |\n+LL |     second == 1\n+   |               ^ expected fn item, found integer\n+   |\n+   = note: expected fn item `fn() {second}`\n+                 found type `{integer}`\n+\n+error[E0369]: binary operation `==` cannot be applied to type `fn() {first}`\n+  --> $DIR/issue-66667-function-cmp-cycle.rs:7:11\n+   |\n+LL |     first == 1\n+   |     ----- ^^ - {integer}\n+   |     |\n+   |     fn() {first}\n+\n+error[E0308]: mismatched types\n+  --> $DIR/issue-66667-function-cmp-cycle.rs:7:14\n+   |\n+LL |     first == 1\n+   |              ^ expected fn item, found integer\n+   |\n+   = note: expected fn item `fn() {first}`\n+                 found type `{integer}`\n+\n+error[E0369]: binary operation `==` cannot be applied to type `fn() {bar}`\n+  --> $DIR/issue-66667-function-cmp-cycle.rs:12:9\n+   |\n+LL |     bar == 1\n+   |     --- ^^ - {integer}\n+   |     |\n+   |     fn() {bar}\n+\n+error[E0308]: mismatched types\n+  --> $DIR/issue-66667-function-cmp-cycle.rs:12:12\n+   |\n+LL |     bar == 1\n+   |            ^ expected fn item, found integer\n+   |\n+   = note: expected fn item `fn() {bar}`\n+                 found type `{integer}`\n+\n+error: aborting due to 6 previous errors\n+\n+Some errors have detailed explanations: E0308, E0369.\n+For more information about an error, try `rustc --explain E0308`."}]}