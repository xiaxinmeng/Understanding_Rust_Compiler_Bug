{"sha": "503cddeb0f4a4e95e001a92cd2ed1c40587b6105", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUwM2NkZGViMGY0YTRlOTVlMDAxYTkyY2QyZWQxYzQwNTg3YjYxMDU=", "commit": {"author": {"name": "St\u00e9phane Campinas", "email": "stephane.campinas@gmail.com", "date": "2019-01-14T13:41:00Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-01-14T13:41:00Z"}, "message": "Merge pull request #3225 from scampi/issue-3224\n\nrewrite_comment: fix block fallback when failing to rewrite an itemized block", "tree": {"sha": "dbb438f7a01959e5792825a7719a8acf5459c496", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/dbb438f7a01959e5792825a7719a8acf5459c496"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/503cddeb0f4a4e95e001a92cd2ed1c40587b6105", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJcPJFsCRBK7hj4Ov3rIwAAdHIIAALIGHwsBexKCMUl4UBYM/Nw\nLVsWmK/4UbLWM+CNsBYbyKoiGYhMdUmbcbve6XIM40TJXhkGs5ChFIMnk0m4mT8j\n8z0ryGxWBdXs4qZ4F/EyzXLzjZrveKp/9KAwN2iv1p/aSYFNZ6BW/6Zz5iMKwcS3\npp0HJlPhm3XnxMaiV9hLwB+yERMc/cH5ybumNzfHb381qwgPjRu5GVw7siYpK9sS\nDoOeRbCbcmRRhK9BpKnjlA8qRBKSZ2inqiee+DAz7bMGJ55P3QxlAUwmy62nwDUO\nMtScHuQwip7f/nFmjJOIzBQuFFDCarOhqF6LQuuo7vo9x3tG6yBGajg5NQA1YN8=\n=rn0x\n-----END PGP SIGNATURE-----\n", "payload": "tree dbb438f7a01959e5792825a7719a8acf5459c496\nparent a1bbf589652e1ac0551c269ca1835510ee5ae541\nparent 3b18238009f161c0cd765526076ad4b0b8dc8812\nauthor St\u00e9phane Campinas <stephane.campinas@gmail.com> 1547473260 +0100\ncommitter GitHub <noreply@github.com> 1547473260 +0100\n\nMerge pull request #3225 from scampi/issue-3224\n\nrewrite_comment: fix block fallback when failing to rewrite an itemized block"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/503cddeb0f4a4e95e001a92cd2ed1c40587b6105", "html_url": "https://github.com/rust-lang/rust/commit/503cddeb0f4a4e95e001a92cd2ed1c40587b6105", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/503cddeb0f4a4e95e001a92cd2ed1c40587b6105/comments", "author": {"login": "scampi", "id": 795879, "node_id": "MDQ6VXNlcjc5NTg3OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/795879?v=4", "gravatar_id": "", "url": "https://api.github.com/users/scampi", "html_url": "https://github.com/scampi", "followers_url": "https://api.github.com/users/scampi/followers", "following_url": "https://api.github.com/users/scampi/following{/other_user}", "gists_url": "https://api.github.com/users/scampi/gists{/gist_id}", "starred_url": "https://api.github.com/users/scampi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/scampi/subscriptions", "organizations_url": "https://api.github.com/users/scampi/orgs", "repos_url": "https://api.github.com/users/scampi/repos", "events_url": "https://api.github.com/users/scampi/events{/privacy}", "received_events_url": "https://api.github.com/users/scampi/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a1bbf589652e1ac0551c269ca1835510ee5ae541", "url": "https://api.github.com/repos/rust-lang/rust/commits/a1bbf589652e1ac0551c269ca1835510ee5ae541", "html_url": "https://github.com/rust-lang/rust/commit/a1bbf589652e1ac0551c269ca1835510ee5ae541"}, {"sha": "3b18238009f161c0cd765526076ad4b0b8dc8812", "url": "https://api.github.com/repos/rust-lang/rust/commits/3b18238009f161c0cd765526076ad4b0b8dc8812", "html_url": "https://github.com/rust-lang/rust/commit/3b18238009f161c0cd765526076ad4b0b8dc8812"}], "stats": {"total": 63, "additions": 43, "deletions": 20}, "files": [{"sha": "54c3ee1d9d7f6d116e7ba3a39a2253844fd3e49c", "filename": "src/comment.rs", "status": "modified", "additions": 32, "deletions": 20, "changes": 52, "blob_url": "https://github.com/rust-lang/rust/blob/503cddeb0f4a4e95e001a92cd2ed1c40587b6105/src%2Fcomment.rs", "raw_url": "https://github.com/rust-lang/rust/raw/503cddeb0f4a4e95e001a92cd2ed1c40587b6105/src%2Fcomment.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomment.rs?ref=503cddeb0f4a4e95e001a92cd2ed1c40587b6105", "patch": "@@ -421,6 +421,8 @@ impl CodeBlockAttribute {\n /// An item starts with either a star `*` or a dash `-`. Different level of indentation are\n /// handled by shrinking the shape accordingly.\n struct ItemizedBlock {\n+    /// the lines that are identified as part of an itemized block\n+    lines: Vec<String>,\n     /// the number of whitespaces up to the item sigil\n     indent: usize,\n     /// the string that marks the start of an item\n@@ -442,6 +444,7 @@ impl ItemizedBlock {\n         let space_to_sigil = line.chars().take_while(|c| c.is_whitespace()).count();\n         let indent = space_to_sigil + 2;\n         ItemizedBlock {\n+            lines: vec![line[indent..].to_string()],\n             indent,\n             opener: line[..indent].to_string(),\n             line_start: \" \".repeat(indent),\n@@ -461,10 +464,29 @@ impl ItemizedBlock {\n         }\n     }\n \n-    /// Returns true if the line is part of the current itemized block\n-    fn in_block(&self, line: &str) -> bool {\n-        !ItemizedBlock::is_itemized_line(line)\n+    /// Returns true if the line is part of the current itemized block.\n+    /// If it is, then it is added to the internal lines vec.\n+    fn add_line(&mut self, line: &str) -> bool {\n+        if !ItemizedBlock::is_itemized_line(line)\n             && self.indent <= line.chars().take_while(|c| c.is_whitespace()).count()\n+        {\n+            self.lines.push(line.to_string());\n+            return true;\n+        }\n+        false\n+    }\n+\n+    /// Returns the block as a string, with each line trimmed at the start.\n+    fn trimmed_block_as_string(&self) -> String {\n+        self.lines\n+            .iter()\n+            .map(|line| format!(\"{} \", line.trim_start()))\n+            .collect::<String>()\n+    }\n+\n+    /// Returns the block as a string under its original form\n+    fn original_block_as_string(&self) -> String {\n+        self.lines.join(\"\\n\")\n     }\n }\n \n@@ -473,7 +495,6 @@ struct CommentRewrite<'a> {\n     code_block_buffer: String,\n     is_prev_line_multi_line: bool,\n     code_block_attr: Option<CodeBlockAttribute>,\n-    item_block_buffer: String,\n     item_block: Option<ItemizedBlock>,\n     comment_line_separator: String,\n     indent_str: String,\n@@ -511,7 +532,6 @@ impl<'a> CommentRewrite<'a> {\n             code_block_buffer: String::with_capacity(128),\n             is_prev_line_multi_line: false,\n             code_block_attr: None,\n-            item_block_buffer: String::with_capacity(128),\n             item_block: None,\n             comment_line_separator: format!(\"{}{}\", indent_str, line_start),\n             max_chars,\n@@ -561,17 +581,14 @@ impl<'a> CommentRewrite<'a> {\n             ));\n         }\n \n-        if !self.item_block_buffer.is_empty() {\n+        if let Some(ref ib) = self.item_block {\n             // the last few lines are part of an itemized block\n             self.fmt.shape = Shape::legacy(self.max_chars, self.fmt_indent);\n-            let mut ib = None;\n-            ::std::mem::swap(&mut ib, &mut self.item_block);\n-            let ib = ib.unwrap();\n             let item_fmt = ib.create_string_format(&self.fmt);\n             self.result.push_str(&self.comment_line_separator);\n             self.result.push_str(&ib.opener);\n             match rewrite_string(\n-                &self.item_block_buffer.replace(\"\\n\", \" \"),\n+                &ib.trimmed_block_as_string(),\n                 &item_fmt,\n                 self.max_chars.saturating_sub(ib.indent),\n             ) {\n@@ -580,7 +597,7 @@ impl<'a> CommentRewrite<'a> {\n                     &format!(\"{}{}\", &self.comment_line_separator, ib.line_start),\n                 )),\n                 None => self.result.push_str(&Self::join_block(\n-                    &self.item_block_buffer,\n+                    &ib.original_block_as_string(),\n                     &self.comment_line_separator,\n                 )),\n             };\n@@ -604,10 +621,8 @@ impl<'a> CommentRewrite<'a> {\n     ) -> bool {\n         let is_last = i == count_newlines(orig);\n \n-        if let Some(ref ib) = self.item_block {\n-            if ib.in_block(&line) {\n-                self.item_block_buffer.push_str(line.trim_start());\n-                self.item_block_buffer.push('\\n');\n+        if let Some(ref mut ib) = self.item_block {\n+            if ib.add_line(&line) {\n                 return false;\n             }\n             self.is_prev_line_multi_line = false;\n@@ -616,7 +631,7 @@ impl<'a> CommentRewrite<'a> {\n             self.result.push_str(&self.comment_line_separator);\n             self.result.push_str(&ib.opener);\n             match rewrite_string(\n-                &self.item_block_buffer.replace(\"\\n\", \" \"),\n+                &ib.trimmed_block_as_string(),\n                 &item_fmt,\n                 self.max_chars.saturating_sub(ib.indent),\n             ) {\n@@ -625,11 +640,10 @@ impl<'a> CommentRewrite<'a> {\n                     &format!(\"{}{}\", &self.comment_line_separator, ib.line_start),\n                 )),\n                 None => self.result.push_str(&Self::join_block(\n-                    &self.item_block_buffer,\n+                    &ib.original_block_as_string(),\n                     &self.comment_line_separator,\n                 )),\n             };\n-            self.item_block_buffer.clear();\n         } else if self.code_block_attr.is_some() {\n             if line.starts_with(\"```\") {\n                 let code_block = match self.code_block_attr.as_ref().unwrap() {\n@@ -669,8 +683,6 @@ impl<'a> CommentRewrite<'a> {\n             self.code_block_attr = Some(CodeBlockAttribute::new(&line[3..]))\n         } else if self.fmt.config.wrap_comments() && ItemizedBlock::is_itemized_line(&line) {\n             let ib = ItemizedBlock::new(&line);\n-            self.item_block_buffer.push_str(&line[ib.indent..]);\n-            self.item_block_buffer.push('\\n');\n             self.item_block = Some(ib);\n             return false;\n         }"}, {"sha": "6476d2117c661cad2dc9f1009da9aaab98568f93", "filename": "tests/target/issue-3224.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/503cddeb0f4a4e95e001a92cd2ed1c40587b6105/tests%2Ftarget%2Fissue-3224.rs", "raw_url": "https://github.com/rust-lang/rust/raw/503cddeb0f4a4e95e001a92cd2ed1c40587b6105/tests%2Ftarget%2Fissue-3224.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fissue-3224.rs?ref=503cddeb0f4a4e95e001a92cd2ed1c40587b6105", "patch": "@@ -0,0 +1,11 @@\n+// rustfmt-wrap_comments: true\n+\n+//! Test:\n+//! * aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\n+//! * [`examples/simple`] \u2013 Demonstrates use of the [`init`] API with plain\n+//!   structs.\n+//! * [`examples/simple_flatbuffer`] \u2013 Demonstrates use of the [`init`] API with\n+//!   FlatBuffers.\n+//! * [`examples/gravity`] \u2013 Demonstrates use of the [`RLBot::set_game_state`]\n+//!   API\n+fn foo() {}"}]}