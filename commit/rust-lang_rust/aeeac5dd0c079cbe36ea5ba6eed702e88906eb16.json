{"sha": "aeeac5dd0c079cbe36ea5ba6eed702e88906eb16", "node_id": "C_kwDOAAsO6NoAKGFlZWFjNWRkMGMwNzljYmUzNmVhNWJhNmVlZDcwMmU4ODkwNmViMTY", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2022-11-19T06:24:43Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-11-19T06:24:43Z"}, "message": "Rollup merge of #104001 - Ayush1325:custom-entry, r=bjorn3\n\nImprove generating Custom entry function\n\nThis commit is aimed at making compiler-generated entry functions (Basically just C `main` right now) more generic so other targets can do similar things for custom entry. This was initially implemented as part of https://github.com/rust-lang/rust/pull/100316.\n\nCurrently, this moves the entry function name and Call convention to the target spec.\n\nSigned-off-by: Ayush Singh <ayushsingh1325@gmail.com>", "tree": {"sha": "6ecfc7b7f251cbce8e7a83f2c3a77b6d80d462b0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6ecfc7b7f251cbce8e7a83f2c3a77b6d80d462b0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/aeeac5dd0c079cbe36ea5ba6eed702e88906eb16", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjeHarCRBK7hj4Ov3rIwAAsBgIADHgjgEgcLwLOfsMt0hWz4bl\noOlFBtaCOZkNifGLxEpFUTIokbDArvfMAqELM3hDTjv80lJnBMGYS+5Nh/Y8uEbS\nQ1J/F0WOtaR01ja6XaT/vhFngP5y1phSuxd+jM7M0J/wcUuQ0YHoqOC06ubFAqQz\npSGcKYwqAvZEGSRNaWdiCbcA1Msm3jCnQBcigbF14upOZg2hptk0XtZJcqC+Jgh5\nEYxHPlnMEO3jnlETlsw032n0kwP7cQbkas95W/zP5xvXl3vS6+rQMGv25HkPLA4H\nogQG9BmDsOkPymtmic4UqImGF5Le+S2cQhnJiNqNmr/1pqP6ruHh3vJgUxeMOts=\n=IDPB\n-----END PGP SIGNATURE-----\n", "payload": "tree 6ecfc7b7f251cbce8e7a83f2c3a77b6d80d462b0\nparent becc24a23aed2639db3b78acd93ec6d553898583\nparent 2436dff7727732a9f55b1c80888be66ada8e288f\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1668839083 +0530\ncommitter GitHub <noreply@github.com> 1668839083 +0530\n\nRollup merge of #104001 - Ayush1325:custom-entry, r=bjorn3\n\nImprove generating Custom entry function\n\nThis commit is aimed at making compiler-generated entry functions (Basically just C `main` right now) more generic so other targets can do similar things for custom entry. This was initially implemented as part of https://github.com/rust-lang/rust/pull/100316.\n\nCurrently, this moves the entry function name and Call convention to the target spec.\n\nSigned-off-by: Ayush Singh <ayushsingh1325@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/aeeac5dd0c079cbe36ea5ba6eed702e88906eb16", "html_url": "https://github.com/rust-lang/rust/commit/aeeac5dd0c079cbe36ea5ba6eed702e88906eb16", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/aeeac5dd0c079cbe36ea5ba6eed702e88906eb16/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "becc24a23aed2639db3b78acd93ec6d553898583", "url": "https://api.github.com/repos/rust-lang/rust/commits/becc24a23aed2639db3b78acd93ec6d553898583", "html_url": "https://github.com/rust-lang/rust/commit/becc24a23aed2639db3b78acd93ec6d553898583"}, {"sha": "2436dff7727732a9f55b1c80888be66ada8e288f", "url": "https://api.github.com/repos/rust-lang/rust/commits/2436dff7727732a9f55b1c80888be66ada8e288f", "html_url": "https://github.com/rust-lang/rust/commit/2436dff7727732a9f55b1c80888be66ada8e288f"}], "stats": {"total": 197, "additions": 161, "deletions": 36}, "files": [{"sha": "1e22537c2ba42ac27202012738cf55ce004042b7", "filename": "compiler/rustc_codegen_cranelift/src/abi/mod.rs", "status": "modified", "additions": 15, "deletions": 10, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/aeeac5dd0c079cbe36ea5ba6eed702e88906eb16/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fabi%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aeeac5dd0c079cbe36ea5ba6eed702e88906eb16/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fabi%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fabi%2Fmod.rs?ref=aeeac5dd0c079cbe36ea5ba6eed702e88906eb16", "patch": "@@ -22,7 +22,19 @@ fn clif_sig_from_fn_abi<'tcx>(\n     default_call_conv: CallConv,\n     fn_abi: &FnAbi<'tcx, Ty<'tcx>>,\n ) -> Signature {\n-    let call_conv = match fn_abi.conv {\n+    let call_conv = conv_to_call_conv(fn_abi.conv, default_call_conv);\n+\n+    let inputs = fn_abi.args.iter().map(|arg_abi| arg_abi.get_abi_param(tcx).into_iter()).flatten();\n+\n+    let (return_ptr, returns) = fn_abi.ret.get_abi_return(tcx);\n+    // Sometimes the first param is an pointer to the place where the return value needs to be stored.\n+    let params: Vec<_> = return_ptr.into_iter().chain(inputs).collect();\n+\n+    Signature { params, returns, call_conv }\n+}\n+\n+pub(crate) fn conv_to_call_conv(c: Conv, default_call_conv: CallConv) -> CallConv {\n+    match c {\n         Conv::Rust | Conv::C => default_call_conv,\n         Conv::RustCold => CallConv::Cold,\n         Conv::X86_64SysV => CallConv::SystemV,\n@@ -38,15 +50,8 @@ fn clif_sig_from_fn_abi<'tcx>(\n         | Conv::X86VectorCall\n         | Conv::AmdGpuKernel\n         | Conv::AvrInterrupt\n-        | Conv::AvrNonBlockingInterrupt => todo!(\"{:?}\", fn_abi.conv),\n-    };\n-    let inputs = fn_abi.args.iter().map(|arg_abi| arg_abi.get_abi_param(tcx).into_iter()).flatten();\n-\n-    let (return_ptr, returns) = fn_abi.ret.get_abi_return(tcx);\n-    // Sometimes the first param is an pointer to the place where the return value needs to be stored.\n-    let params: Vec<_> = return_ptr.into_iter().chain(inputs).collect();\n-\n-    Signature { params, returns, call_conv }\n+        | Conv::AvrNonBlockingInterrupt => todo!(\"{:?}\", c),\n+    }\n }\n \n pub(crate) fn get_function_sig<'tcx>("}, {"sha": "f7434633ea442b40fa30f4a85370135e8c134017", "filename": "compiler/rustc_codegen_cranelift/src/main_shim.rs", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/aeeac5dd0c079cbe36ea5ba6eed702e88906eb16/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fmain_shim.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aeeac5dd0c079cbe36ea5ba6eed702e88906eb16/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fmain_shim.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fmain_shim.rs?ref=aeeac5dd0c079cbe36ea5ba6eed702e88906eb16", "patch": "@@ -63,10 +63,14 @@ pub(crate) fn maybe_create_entry_wrapper(\n                 AbiParam::new(m.target_config().pointer_type()),\n             ],\n             returns: vec![AbiParam::new(m.target_config().pointer_type() /*isize*/)],\n-            call_conv: CallConv::triple_default(m.isa().triple()),\n+            call_conv: crate::conv_to_call_conv(\n+                tcx.sess.target.options.entry_abi,\n+                CallConv::triple_default(m.isa().triple()),\n+            ),\n         };\n \n-        let cmain_func_id = m.declare_function(\"main\", Linkage::Export, &cmain_sig).unwrap();\n+        let entry_name = tcx.sess.target.options.entry_name.as_ref();\n+        let cmain_func_id = m.declare_function(entry_name, Linkage::Export, &cmain_sig).unwrap();\n \n         let instance = Instance::mono(tcx, rust_main_def_id).polymorphize(tcx);\n "}, {"sha": "2e71c3665daa75ed3e1b096c0ca1bac99e74584c", "filename": "compiler/rustc_codegen_gcc/src/context.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/aeeac5dd0c079cbe36ea5ba6eed702e88906eb16/compiler%2Frustc_codegen_gcc%2Fsrc%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aeeac5dd0c079cbe36ea5ba6eed702e88906eb16/compiler%2Frustc_codegen_gcc%2Fsrc%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_gcc%2Fsrc%2Fcontext.rs?ref=aeeac5dd0c079cbe36ea5ba6eed702e88906eb16", "patch": "@@ -425,8 +425,9 @@ impl<'gcc, 'tcx> MiscMethods<'tcx> for CodegenCx<'gcc, 'tcx> {\n     }\n \n     fn declare_c_main(&self, fn_type: Self::Type) -> Option<Self::Function> {\n-        if self.get_declared_value(\"main\").is_none() {\n-            Some(self.declare_cfn(\"main\", fn_type))\n+        let entry_name = self.sess().target.entry_name.as_ref();\n+        if self.get_declared_value(entry_name).is_none() {\n+            Some(self.declare_entry_fn(entry_name, fn_type, ()))\n         }\n         else {\n             // If the symbol already exists, it is an error: for example, the user wrote"}, {"sha": "eae77508c973abe0c0f50ab70a5e1935bcba246f", "filename": "compiler/rustc_codegen_gcc/src/declare.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/aeeac5dd0c079cbe36ea5ba6eed702e88906eb16/compiler%2Frustc_codegen_gcc%2Fsrc%2Fdeclare.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aeeac5dd0c079cbe36ea5ba6eed702e88906eb16/compiler%2Frustc_codegen_gcc%2Fsrc%2Fdeclare.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_gcc%2Fsrc%2Fdeclare.rs?ref=aeeac5dd0c079cbe36ea5ba6eed702e88906eb16", "patch": "@@ -65,13 +65,13 @@ impl<'gcc, 'tcx> CodegenCx<'gcc, 'tcx> {\n         global\n     }\n \n-    pub fn declare_cfn(&self, name: &str, _fn_type: Type<'gcc>) -> RValue<'gcc> {\n+    pub fn declare_entry_fn(&self, name: &str, _fn_type: Type<'gcc>, callconv: () /*llvm::CCallConv*/) -> RValue<'gcc> {\n         // TODO(antoyo): use the fn_type parameter.\n         let const_string = self.context.new_type::<u8>().make_pointer().make_pointer();\n         let return_type = self.type_i32();\n         let variadic = false;\n         self.linkage.set(FunctionType::Exported);\n-        let func = declare_raw_fn(self, name, () /*llvm::CCallConv*/, return_type, &[self.type_i32(), const_string], variadic);\n+        let func = declare_raw_fn(self, name, callconv, return_type, &[self.type_i32(), const_string], variadic);\n         // NOTE: it is needed to set the current_func here as well, because get_fn() is not called\n         // for the main function.\n         *self.current_func.borrow_mut() = Some(func);"}, {"sha": "a6fd2a7de6bd04eb544c7d10f78111d8de5938e2", "filename": "compiler/rustc_codegen_llvm/src/abi.rs", "status": "modified", "additions": 23, "deletions": 17, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/aeeac5dd0c079cbe36ea5ba6eed702e88906eb16/compiler%2Frustc_codegen_llvm%2Fsrc%2Fabi.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aeeac5dd0c079cbe36ea5ba6eed702e88906eb16/compiler%2Frustc_codegen_llvm%2Fsrc%2Fabi.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fabi.rs?ref=aeeac5dd0c079cbe36ea5ba6eed702e88906eb16", "patch": "@@ -398,23 +398,7 @@ impl<'ll, 'tcx> FnAbiLlvmExt<'ll, 'tcx> for FnAbi<'tcx, Ty<'tcx>> {\n     }\n \n     fn llvm_cconv(&self) -> llvm::CallConv {\n-        match self.conv {\n-            Conv::C | Conv::Rust | Conv::CCmseNonSecureCall => llvm::CCallConv,\n-            Conv::RustCold => llvm::ColdCallConv,\n-            Conv::AmdGpuKernel => llvm::AmdGpuKernel,\n-            Conv::AvrInterrupt => llvm::AvrInterrupt,\n-            Conv::AvrNonBlockingInterrupt => llvm::AvrNonBlockingInterrupt,\n-            Conv::ArmAapcs => llvm::ArmAapcsCallConv,\n-            Conv::Msp430Intr => llvm::Msp430Intr,\n-            Conv::PtxKernel => llvm::PtxKernel,\n-            Conv::X86Fastcall => llvm::X86FastcallCallConv,\n-            Conv::X86Intr => llvm::X86_Intr,\n-            Conv::X86Stdcall => llvm::X86StdcallCallConv,\n-            Conv::X86ThisCall => llvm::X86_ThisCall,\n-            Conv::X86VectorCall => llvm::X86_VectorCall,\n-            Conv::X86_64SysV => llvm::X86_64_SysV,\n-            Conv::X86_64Win64 => llvm::X86_64_Win64,\n-        }\n+        self.conv.into()\n     }\n \n     fn apply_attrs_llfn(&self, cx: &CodegenCx<'ll, 'tcx>, llfn: &'ll Value) {\n@@ -596,3 +580,25 @@ impl<'tcx> AbiBuilderMethods<'tcx> for Builder<'_, '_, 'tcx> {\n         llvm::get_param(self.llfn(), index as c_uint)\n     }\n }\n+\n+impl From<Conv> for llvm::CallConv {\n+    fn from(conv: Conv) -> Self {\n+        match conv {\n+            Conv::C | Conv::Rust | Conv::CCmseNonSecureCall => llvm::CCallConv,\n+            Conv::RustCold => llvm::ColdCallConv,\n+            Conv::AmdGpuKernel => llvm::AmdGpuKernel,\n+            Conv::AvrInterrupt => llvm::AvrInterrupt,\n+            Conv::AvrNonBlockingInterrupt => llvm::AvrNonBlockingInterrupt,\n+            Conv::ArmAapcs => llvm::ArmAapcsCallConv,\n+            Conv::Msp430Intr => llvm::Msp430Intr,\n+            Conv::PtxKernel => llvm::PtxKernel,\n+            Conv::X86Fastcall => llvm::X86FastcallCallConv,\n+            Conv::X86Intr => llvm::X86_Intr,\n+            Conv::X86Stdcall => llvm::X86StdcallCallConv,\n+            Conv::X86ThisCall => llvm::X86_ThisCall,\n+            Conv::X86VectorCall => llvm::X86_VectorCall,\n+            Conv::X86_64SysV => llvm::X86_64_SysV,\n+            Conv::X86_64Win64 => llvm::X86_64_Win64,\n+        }\n+    }\n+}"}, {"sha": "4dcc7cd54477def2a32ab3ea7e06b9f566b08b0c", "filename": "compiler/rustc_codegen_llvm/src/context.rs", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/aeeac5dd0c079cbe36ea5ba6eed702e88906eb16/compiler%2Frustc_codegen_llvm%2Fsrc%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aeeac5dd0c079cbe36ea5ba6eed702e88906eb16/compiler%2Frustc_codegen_llvm%2Fsrc%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fcontext.rs?ref=aeeac5dd0c079cbe36ea5ba6eed702e88906eb16", "patch": "@@ -576,8 +576,14 @@ impl<'ll, 'tcx> MiscMethods<'tcx> for CodegenCx<'ll, 'tcx> {\n     }\n \n     fn declare_c_main(&self, fn_type: Self::Type) -> Option<Self::Function> {\n-        if self.get_declared_value(\"main\").is_none() {\n-            Some(self.declare_cfn(\"main\", llvm::UnnamedAddr::Global, fn_type))\n+        let entry_name = self.sess().target.entry_name.as_ref();\n+        if self.get_declared_value(entry_name).is_none() {\n+            Some(self.declare_entry_fn(\n+                entry_name,\n+                self.sess().target.entry_abi.into(),\n+                llvm::UnnamedAddr::Global,\n+                fn_type,\n+            ))\n         } else {\n             // If the symbol already exists, it is an error: for example, the user wrote\n             // #[no_mangle] extern \"C\" fn main(..) {..}"}, {"sha": "dc21a02cec44a144fef0c9704b3a16af5c1868d2", "filename": "compiler/rustc_codegen_llvm/src/declare.rs", "status": "modified", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/aeeac5dd0c079cbe36ea5ba6eed702e88906eb16/compiler%2Frustc_codegen_llvm%2Fsrc%2Fdeclare.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aeeac5dd0c079cbe36ea5ba6eed702e88906eb16/compiler%2Frustc_codegen_llvm%2Fsrc%2Fdeclare.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fdeclare.rs?ref=aeeac5dd0c079cbe36ea5ba6eed702e88906eb16", "patch": "@@ -90,6 +90,28 @@ impl<'ll, 'tcx> CodegenCx<'ll, 'tcx> {\n         declare_raw_fn(self, name, llvm::CCallConv, unnamed, visibility, fn_type)\n     }\n \n+    /// Declare an entry Function\n+    ///\n+    /// The ABI of this function can change depending on the target (although for now the same as\n+    /// `declare_cfn`)\n+    ///\n+    /// If there\u2019s a value with the same name already declared, the function will\n+    /// update the declaration and return existing Value instead.\n+    pub fn declare_entry_fn(\n+        &self,\n+        name: &str,\n+        callconv: llvm::CallConv,\n+        unnamed: llvm::UnnamedAddr,\n+        fn_type: &'ll Type,\n+    ) -> &'ll Value {\n+        let visibility = if self.tcx.sess.target.default_hidden_visibility {\n+            llvm::Visibility::Hidden\n+        } else {\n+            llvm::Visibility::Default\n+        };\n+        declare_raw_fn(self, name, callconv, unnamed, visibility, fn_type)\n+    }\n+\n     /// Declare a Rust function.\n     ///\n     /// If there\u2019s a value with the same name already declared, the function will"}, {"sha": "22f534d909ab6ca4ccab579d2003b535be8e8376", "filename": "compiler/rustc_codegen_ssa/src/back/symbol_export.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/aeeac5dd0c079cbe36ea5ba6eed702e88906eb16/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Fsymbol_export.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aeeac5dd0c079cbe36ea5ba6eed702e88906eb16/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Fsymbol_export.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Fsymbol_export.rs?ref=aeeac5dd0c079cbe36ea5ba6eed702e88906eb16", "patch": "@@ -180,7 +180,8 @@ fn exported_symbols_provider_local<'tcx>(\n         .collect();\n \n     if tcx.entry_fn(()).is_some() {\n-        let exported_symbol = ExportedSymbol::NoDefId(SymbolName::new(tcx, \"main\"));\n+        let exported_symbol =\n+            ExportedSymbol::NoDefId(SymbolName::new(tcx, tcx.sess.target.entry_name.as_ref()));\n \n         symbols.push((\n             exported_symbol,"}, {"sha": "0c559ec04a413f1e86aab9052148956e89b5a5f3", "filename": "compiler/rustc_target/src/abi/call/mod.rs", "status": "modified", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/aeeac5dd0c079cbe36ea5ba6eed702e88906eb16/compiler%2Frustc_target%2Fsrc%2Fabi%2Fcall%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aeeac5dd0c079cbe36ea5ba6eed702e88906eb16/compiler%2Frustc_target%2Fsrc%2Fabi%2Fcall%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fabi%2Fcall%2Fmod.rs?ref=aeeac5dd0c079cbe36ea5ba6eed702e88906eb16", "patch": "@@ -3,6 +3,7 @@ use crate::abi::{HasDataLayout, TyAbiInterface, TyAndLayout};\n use crate::spec::{self, HasTargetSpec};\n use rustc_span::Symbol;\n use std::fmt;\n+use std::str::FromStr;\n \n mod aarch64;\n mod amdgpu;\n@@ -737,6 +738,33 @@ impl<'a, Ty> FnAbi<'a, Ty> {\n     }\n }\n \n+impl FromStr for Conv {\n+    type Err = String;\n+\n+    fn from_str(s: &str) -> Result<Self, Self::Err> {\n+        match s {\n+            \"C\" => Ok(Conv::C),\n+            \"Rust\" => Ok(Conv::Rust),\n+            \"RustCold\" => Ok(Conv::Rust),\n+            \"ArmAapcs\" => Ok(Conv::ArmAapcs),\n+            \"CCmseNonSecureCall\" => Ok(Conv::CCmseNonSecureCall),\n+            \"Msp430Intr\" => Ok(Conv::Msp430Intr),\n+            \"PtxKernel\" => Ok(Conv::PtxKernel),\n+            \"X86Fastcall\" => Ok(Conv::X86Fastcall),\n+            \"X86Intr\" => Ok(Conv::X86Intr),\n+            \"X86Stdcall\" => Ok(Conv::X86Stdcall),\n+            \"X86ThisCall\" => Ok(Conv::X86ThisCall),\n+            \"X86VectorCall\" => Ok(Conv::X86VectorCall),\n+            \"X86_64SysV\" => Ok(Conv::X86_64SysV),\n+            \"X86_64Win64\" => Ok(Conv::X86_64Win64),\n+            \"AmdGpuKernel\" => Ok(Conv::AmdGpuKernel),\n+            \"AvrInterrupt\" => Ok(Conv::AvrInterrupt),\n+            \"AvrNonBlockingInterrupt\" => Ok(Conv::AvrNonBlockingInterrupt),\n+            _ => Err(format!(\"'{}' is not a valid value for entry function call convetion.\", s)),\n+        }\n+    }\n+}\n+\n // Some types are used a lot. Make sure they don't unintentionally get bigger.\n #[cfg(all(target_arch = \"x86_64\", target_pointer_width = \"64\"))]\n mod size_asserts {"}, {"sha": "75bb76a9de0878afe6f0faa1e65f7adf5f73a580", "filename": "compiler/rustc_target/src/json.rs", "status": "modified", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/aeeac5dd0c079cbe36ea5ba6eed702e88906eb16/compiler%2Frustc_target%2Fsrc%2Fjson.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aeeac5dd0c079cbe36ea5ba6eed702e88906eb16/compiler%2Frustc_target%2Fsrc%2Fjson.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fjson.rs?ref=aeeac5dd0c079cbe36ea5ba6eed702e88906eb16", "patch": "@@ -89,3 +89,28 @@ impl<A: ToJson> ToJson for Option<A> {\n         }\n     }\n }\n+\n+impl ToJson for crate::abi::call::Conv {\n+    fn to_json(&self) -> Json {\n+        let s = match self {\n+            Self::C => \"C\",\n+            Self::Rust => \"Rust\",\n+            Self::RustCold => \"RustCold\",\n+            Self::ArmAapcs => \"ArmAapcs\",\n+            Self::CCmseNonSecureCall => \"CCmseNonSecureCall\",\n+            Self::Msp430Intr => \"Msp430Intr\",\n+            Self::PtxKernel => \"PtxKernel\",\n+            Self::X86Fastcall => \"X86Fastcall\",\n+            Self::X86Intr => \"X86Intr\",\n+            Self::X86Stdcall => \"X86Stdcall\",\n+            Self::X86ThisCall => \"X86ThisCall\",\n+            Self::X86VectorCall => \"X86VectorCall\",\n+            Self::X86_64SysV => \"X86_64SysV\",\n+            Self::X86_64Win64 => \"X86_64Win64\",\n+            Self::AmdGpuKernel => \"AmdGpuKernel\",\n+            Self::AvrInterrupt => \"AvrInterrupt\",\n+            Self::AvrNonBlockingInterrupt => \"AvrNonBlockingInterrupt\",\n+        };\n+        Json::String(s.to_owned())\n+    }\n+}"}, {"sha": "6d936d2cb9ff0463e13ff9d6802a76b38dea4f1c", "filename": "compiler/rustc_target/src/spec/mod.rs", "status": "modified", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/aeeac5dd0c079cbe36ea5ba6eed702e88906eb16/compiler%2Frustc_target%2Fsrc%2Fspec%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aeeac5dd0c079cbe36ea5ba6eed702e88906eb16/compiler%2Frustc_target%2Fsrc%2Fspec%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fmod.rs?ref=aeeac5dd0c079cbe36ea5ba6eed702e88906eb16", "patch": "@@ -34,6 +34,7 @@\n //! the target's settings, though `target-feature` and `link-args` will *add*\n //! to the list specified by the target, rather than replace.\n \n+use crate::abi::call::Conv;\n use crate::abi::Endian;\n use crate::json::{Json, ToJson};\n use crate::spec::abi::{lookup as lookup_abi, Abi};\n@@ -1668,6 +1669,14 @@ pub struct TargetOptions {\n     /// Whether the target supports stack canary checks. `true` by default,\n     /// since this is most common among tier 1 and tier 2 targets.\n     pub supports_stack_protector: bool,\n+\n+    // The name of entry function.\n+    // Default value is \"main\"\n+    pub entry_name: StaticCow<str>,\n+\n+    // The ABI of entry function.\n+    // Default value is `Conv::C`, i.e. C call convention\n+    pub entry_abi: Conv,\n }\n \n /// Add arguments for the given flavor and also for its \"twin\" flavors\n@@ -1884,6 +1893,8 @@ impl Default for TargetOptions {\n             c_enum_min_bits: 32,\n             generate_arange_section: true,\n             supports_stack_protector: true,\n+            entry_name: \"main\".into(),\n+            entry_abi: Conv::C,\n         }\n     }\n }\n@@ -2404,6 +2415,18 @@ impl Target {\n                     }\n                 }\n             } );\n+            ($key_name:ident, Conv) => ( {\n+                let name = (stringify!($key_name)).replace(\"_\", \"-\");\n+                obj.remove(&name).and_then(|o| o.as_str().and_then(|s| {\n+                    match Conv::from_str(s) {\n+                        Ok(c) => {\n+                            base.$key_name = c;\n+                            Some(Ok(()))\n+                        }\n+                        Err(e) => Some(Err(e))\n+                    }\n+                })).unwrap_or(Ok(()))\n+            } );\n         }\n \n         if let Some(j) = obj.remove(\"target-endian\") {\n@@ -2523,6 +2546,8 @@ impl Target {\n         key!(c_enum_min_bits, u64);\n         key!(generate_arange_section, bool);\n         key!(supports_stack_protector, bool);\n+        key!(entry_name);\n+        key!(entry_abi, Conv)?;\n \n         if base.is_builtin {\n             // This can cause unfortunate ICEs later down the line.\n@@ -2773,6 +2798,8 @@ impl ToJson for Target {\n         target_option_val!(c_enum_min_bits);\n         target_option_val!(generate_arange_section);\n         target_option_val!(supports_stack_protector);\n+        target_option_val!(entry_name);\n+        target_option_val!(entry_abi);\n \n         if let Some(abi) = self.default_adjusted_cabi {\n             d.insert(\"default-adjusted-cabi\".into(), Abi::name(abi).to_json());"}]}