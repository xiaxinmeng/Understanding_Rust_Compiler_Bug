{"sha": "b92b7052b711c2097565816797347e1652be08fa", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI5MmI3MDUyYjcxMWMyMDk3NTY1ODE2Nzk3MzQ3ZTE2NTJiZTA4ZmE=", "commit": {"author": {"name": "Tyler Mandry", "email": "tmandry@gmail.com", "date": "2019-11-27T21:28:31Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-11-27T21:28:31Z"}, "message": "Rollup merge of #66222 - Aaron1011:fix/opaque-closure, r=pnkfelix\n\nUse `eq_opaque_type_and_type` when type-checking closure signatures\n\nThis handles the case where a user explicitly annotations a closure\nsignature with a opaque return type.\n\nFixes #63263", "tree": {"sha": "28230beb4343d61b4194609e8b642481f3ce5149", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/28230beb4343d61b4194609e8b642481f3ce5149"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b92b7052b711c2097565816797347e1652be08fa", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJd3up/CRBK7hj4Ov3rIwAAdHIIADim/RrvHy2rqAQmhQhIyrF2\nH1zws5k78p+wHOzmVX03LUHdLBplAXxqj1jzfQPOPO1LRKkA5RU63bhOiSytnapj\nHLhTlicrDfc6wq0wYwOQS5oHGvULFguJVTNzyyQoZO0DQ/hGVPT1zdsRiyVvhYyi\naYY6PHqJDXyv0ey9+z2CJ5dPuUifxo/zUhIm6pUMX1v0CBh+rbhKwWF6hiCtusCw\ntZLKBWvLpUtpQForBy8Ed4obSlb8PwqQ1hJnR2rv0OYFEXI0xlzoYcijU/itO7Bb\n99AK6A/XLbLCK4H3/wI91l8YjjFjF91Dlis4grjCOyVlCh4v7zyYevBR3HLyOJw=\n=7Tab\n-----END PGP SIGNATURE-----\n", "payload": "tree 28230beb4343d61b4194609e8b642481f3ce5149\nparent cb2deb8a9f71c3c47cbc61b41f67e8eba9ccad4d\nparent e8d55d0a43640cd4bdff98b59e962fba006fb819\nauthor Tyler Mandry <tmandry@gmail.com> 1574890111 -0600\ncommitter GitHub <noreply@github.com> 1574890111 -0600\n\nRollup merge of #66222 - Aaron1011:fix/opaque-closure, r=pnkfelix\n\nUse `eq_opaque_type_and_type` when type-checking closure signatures\n\nThis handles the case where a user explicitly annotations a closure\nsignature with a opaque return type.\n\nFixes #63263\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b92b7052b711c2097565816797347e1652be08fa", "html_url": "https://github.com/rust-lang/rust/commit/b92b7052b711c2097565816797347e1652be08fa", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b92b7052b711c2097565816797347e1652be08fa/comments", "author": {"login": "tmandry", "id": 2280544, "node_id": "MDQ6VXNlcjIyODA1NDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/2280544?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmandry", "html_url": "https://github.com/tmandry", "followers_url": "https://api.github.com/users/tmandry/followers", "following_url": "https://api.github.com/users/tmandry/following{/other_user}", "gists_url": "https://api.github.com/users/tmandry/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmandry/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmandry/subscriptions", "organizations_url": "https://api.github.com/users/tmandry/orgs", "repos_url": "https://api.github.com/users/tmandry/repos", "events_url": "https://api.github.com/users/tmandry/events{/privacy}", "received_events_url": "https://api.github.com/users/tmandry/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cb2deb8a9f71c3c47cbc61b41f67e8eba9ccad4d", "url": "https://api.github.com/repos/rust-lang/rust/commits/cb2deb8a9f71c3c47cbc61b41f67e8eba9ccad4d", "html_url": "https://github.com/rust-lang/rust/commit/cb2deb8a9f71c3c47cbc61b41f67e8eba9ccad4d"}, {"sha": "e8d55d0a43640cd4bdff98b59e962fba006fb819", "url": "https://api.github.com/repos/rust-lang/rust/commits/e8d55d0a43640cd4bdff98b59e962fba006fb819", "html_url": "https://github.com/rust-lang/rust/commit/e8d55d0a43640cd4bdff98b59e962fba006fb819"}], "stats": {"total": 33, "additions": 29, "deletions": 4}, "files": [{"sha": "35fb677c053cb99ae7d5955be1144fb8d2b5e739", "filename": "src/librustc_mir/borrow_check/nll/type_check/input_output.rs", "status": "modified", "additions": 16, "deletions": 4, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/b92b7052b711c2097565816797347e1652be08fa/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Ftype_check%2Finput_output.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b92b7052b711c2097565816797347e1652be08fa/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Ftype_check%2Finput_output.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Ftype_check%2Finput_output.rs?ref=b92b7052b711c2097565816797347e1652be08fa", "patch": "@@ -134,15 +134,27 @@ impl<'a, 'tcx> TypeChecker<'a, 'tcx> {\n         };\n \n         // If the user explicitly annotated the output types, enforce those.\n+        // Note that this only happens for closures.\n         if let Some(user_provided_sig) = user_provided_sig {\n             let user_provided_output_ty = user_provided_sig.output();\n             let user_provided_output_ty =\n                 self.normalize(user_provided_output_ty, Locations::All(output_span));\n-            self.equate_normalized_input_or_output(\n-                user_provided_output_ty,\n+            if let Err(err) = self.eq_opaque_type_and_type(\n                 mir_output_ty,\n-                output_span,\n-            );\n+                user_provided_output_ty,\n+                self.mir_def_id,\n+                Locations::All(output_span),\n+                ConstraintCategory::BoringNoLocation\n+            ) {\n+                span_mirbug!(\n+                    self,\n+                    Location::START,\n+                    \"equate_inputs_and_outputs: `{:?}=={:?}` failed with `{:?}`\",\n+                    mir_output_ty,\n+                    user_provided_output_ty,\n+                    err\n+                );\n+            }\n         }\n     }\n "}, {"sha": "7414611a748936fb6797b9175a04f0176ca32558", "filename": "src/test/ui/type-alias-impl-trait/issue-63263-closure-return.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/b92b7052b711c2097565816797347e1652be08fa/src%2Ftest%2Fui%2Ftype-alias-impl-trait%2Fissue-63263-closure-return.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b92b7052b711c2097565816797347e1652be08fa/src%2Ftest%2Fui%2Ftype-alias-impl-trait%2Fissue-63263-closure-return.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftype-alias-impl-trait%2Fissue-63263-closure-return.rs?ref=b92b7052b711c2097565816797347e1652be08fa", "patch": "@@ -0,0 +1,13 @@\n+// Regression test for issue #63263.\n+// Tests that we properly handle closures with an explicit return type\n+// that return an opaque type.\n+\n+// check-pass\n+\n+#![feature(type_alias_impl_trait)]\n+\n+pub type Closure = impl FnOnce();\n+\n+fn main() {\n+    || -> Closure { || () };\n+}"}]}