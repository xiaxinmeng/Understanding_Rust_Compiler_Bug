{"sha": "beb444eaed6b1b387538435e6eb99fa0cd0f0bed", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJlYjQ0NGVhZWQ2YjFiMzg3NTM4NDM1ZTZlYjk5ZmEwY2QwZjBiZWQ=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-03-12T15:31:11Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-03-12T15:31:11Z"}, "message": "Auto merge of #32142 - mitaa:rdoc-maybe-inline-local, r=alexcrichton\n\nrustdoc: improve crate-local inlining\n\nfixes #28537\n\nr? @alexcrichton", "tree": {"sha": "f8523f9a79797f817dcbdc7c6f3569fbae6d7a2e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f8523f9a79797f817dcbdc7c6f3569fbae6d7a2e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/beb444eaed6b1b387538435e6eb99fa0cd0f0bed", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/beb444eaed6b1b387538435e6eb99fa0cd0f0bed", "html_url": "https://github.com/rust-lang/rust/commit/beb444eaed6b1b387538435e6eb99fa0cd0f0bed", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/beb444eaed6b1b387538435e6eb99fa0cd0f0bed/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1a019dc86de1459809f776b869e36f8e71a7665a", "url": "https://api.github.com/repos/rust-lang/rust/commits/1a019dc86de1459809f776b869e36f8e71a7665a", "html_url": "https://github.com/rust-lang/rust/commit/1a019dc86de1459809f776b869e36f8e71a7665a"}, {"sha": "7c983991d9ec1adb3dc608f4f87c48f5bd46641f", "url": "https://api.github.com/repos/rust-lang/rust/commits/7c983991d9ec1adb3dc608f4f87c48f5bd46641f", "html_url": "https://github.com/rust-lang/rust/commit/7c983991d9ec1adb3dc608f4f87c48f5bd46641f"}], "stats": {"total": 108, "additions": 94, "deletions": 14}, "files": [{"sha": "4c03abac9e867b6f43203975eb10928a8332f558", "filename": "src/librustdoc/visit_ast.rs", "status": "modified", "additions": 38, "deletions": 8, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/beb444eaed6b1b387538435e6eb99fa0cd0f0bed/src%2Flibrustdoc%2Fvisit_ast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/beb444eaed6b1b387538435e6eb99fa0cd0f0bed/src%2Flibrustdoc%2Fvisit_ast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fvisit_ast.rs?ref=beb444eaed6b1b387538435e6eb99fa0cd0f0bed", "patch": "@@ -26,6 +26,7 @@ use rustc::middle::stability;\n use rustc_front::hir;\n \n use core;\n+use clean::{Clean, Attributes};\n use doctree::*;\n \n // looks to me like the first two of these are actually\n@@ -182,15 +183,15 @@ impl<'a, 'tcx> RustdocVisitor<'a, 'tcx> {\n                        please_inline: bool) -> Option<hir::ViewPath_> {\n         match path {\n             hir::ViewPathSimple(dst, base) => {\n-                if self.resolve_id(id, Some(dst), false, om, please_inline) {\n+                if self.maybe_inline_local(id, Some(dst), false, om, please_inline) {\n                     None\n                 } else {\n                     Some(hir::ViewPathSimple(dst, base))\n                 }\n             }\n             hir::ViewPathList(p, paths) => {\n                 let mine = paths.into_iter().filter(|path| {\n-                    !self.resolve_id(path.node.id(), None, false, om,\n+                    !self.maybe_inline_local(path.node.id(), None, false, om,\n                                      please_inline)\n                 }).collect::<hir::HirVec<hir::PathListItem>>();\n \n@@ -201,9 +202,8 @@ impl<'a, 'tcx> RustdocVisitor<'a, 'tcx> {\n                 }\n             }\n \n-            // these are feature gated anyway\n             hir::ViewPathGlob(base) => {\n-                if self.resolve_id(id, None, true, om, please_inline) {\n+                if self.maybe_inline_local(id, None, true, om, please_inline) {\n                     None\n                 } else {\n                     Some(hir::ViewPathGlob(base))\n@@ -213,8 +213,32 @@ impl<'a, 'tcx> RustdocVisitor<'a, 'tcx> {\n \n     }\n \n-    fn resolve_id(&mut self, id: ast::NodeId, renamed: Option<ast::Name>,\n+    /// Tries to resolve the target of a `pub use` statement and inlines the\n+    /// target if it is defined locally and would not be documented otherwise,\n+    /// or when it is specifically requested with `please_inline`.\n+    /// (the latter is the case when the import is marked `doc(inline)`)\n+    ///\n+    /// Cross-crate inlining occurs later on during crate cleaning\n+    /// and follows different rules.\n+    ///\n+    /// Returns true if the target has been inlined.\n+    fn maybe_inline_local(&mut self, id: ast::NodeId, renamed: Option<ast::Name>,\n                   glob: bool, om: &mut Module, please_inline: bool) -> bool {\n+\n+        fn inherits_doc_hidden(cx: &core::DocContext, mut node: ast::NodeId) -> bool {\n+            while let Some(id) = cx.map.get_enclosing_scope(node) {\n+                node = id;\n+                let attrs = cx.map.attrs(node).clean(cx);\n+                if attrs.list_def(\"doc\").has_word(\"hidden\") {\n+                    return true;\n+                }\n+                if node == ast::CRATE_NODE_ID {\n+                    break;\n+                }\n+            }\n+            false\n+        }\n+\n         let tcx = match self.cx.tcx_opt() {\n             Some(tcx) => tcx,\n             None => return false\n@@ -226,9 +250,15 @@ impl<'a, 'tcx> RustdocVisitor<'a, 'tcx> {\n         let analysis = match self.analysis {\n             Some(analysis) => analysis, None => return false\n         };\n-        if !please_inline && analysis.access_levels.is_public(def) {\n+\n+        let is_private = !analysis.access_levels.is_public(def);\n+        let is_hidden = inherits_doc_hidden(self.cx, def_node_id);\n+\n+        // Only inline if requested or if the item would otherwise be stripped\n+        if !please_inline && !is_private && !is_hidden {\n             return false\n         }\n+\n         if !self.view_item_stack.insert(def_node_id) { return false }\n \n         let ret = match tcx.map.get(def_node_id) {\n@@ -276,10 +306,10 @@ impl<'a, 'tcx> RustdocVisitor<'a, 'tcx> {\n                 let node = if item.vis == hir::Public {\n                     let please_inline = item.attrs.iter().any(|item| {\n                         match item.meta_item_list() {\n-                            Some(list) => {\n+                            Some(list) if &item.name()[..] == \"doc\" => {\n                                 list.iter().any(|i| &i.name()[..] == \"inline\")\n                             }\n-                            None => false,\n+                            _ => false,\n                         }\n                     });\n                     match self.visit_view_path(node, om, item.id, please_inline) {"}, {"sha": "b40c29dd715292df2460e4561105efafbadd69fe", "filename": "src/test/run-pass/cci_nested_exe.rs", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/beb444eaed6b1b387538435e6eb99fa0cd0f0bed/src%2Ftest%2Frun-pass%2Fcci_nested_exe.rs", "raw_url": "https://github.com/rust-lang/rust/raw/beb444eaed6b1b387538435e6eb99fa0cd0f0bed/src%2Ftest%2Frun-pass%2Fcci_nested_exe.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fcci_nested_exe.rs?ref=beb444eaed6b1b387538435e6eb99fa0cd0f0bed", "patch": "@@ -11,8 +11,6 @@\n // aux-build:cci_nested_lib.rs\n \n \n-#![feature(globs)]\n-\n extern crate cci_nested_lib;\n use cci_nested_lib::*;\n "}, {"sha": "b38e104b7b4eebbfc0708ad81af247ffeed413e8", "filename": "src/test/rustdoc/inline_local/issue-28537.rs", "status": "added", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/beb444eaed6b1b387538435e6eb99fa0cd0f0bed/src%2Ftest%2Frustdoc%2Finline_local%2Fissue-28537.rs", "raw_url": "https://github.com/rust-lang/rust/raw/beb444eaed6b1b387538435e6eb99fa0cd0f0bed/src%2Ftest%2Frustdoc%2Finline_local%2Fissue-28537.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Finline_local%2Fissue-28537.rs?ref=beb444eaed6b1b387538435e6eb99fa0cd0f0bed", "patch": "@@ -0,0 +1,27 @@\n+// Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#[doc(hidden)]\n+pub mod foo {\n+    pub struct Foo;\n+}\n+\n+mod bar {\n+    pub use self::bar::Bar;\n+    mod bar {\n+        pub struct Bar;\n+    }\n+}\n+\n+// @has issue_28537/struct.Foo.html\n+pub use foo::Foo;\n+\n+// @has issue_28537/struct.Bar.html\n+pub use self::bar::Bar;"}, {"sha": "d237ab8dab01a3f29c4335fe0e1d1bfa9711d723", "filename": "src/test/rustdoc/inline_local/please_inline.rs", "status": "added", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/beb444eaed6b1b387538435e6eb99fa0cd0f0bed/src%2Ftest%2Frustdoc%2Finline_local%2Fplease_inline.rs", "raw_url": "https://github.com/rust-lang/rust/raw/beb444eaed6b1b387538435e6eb99fa0cd0f0bed/src%2Ftest%2Frustdoc%2Finline_local%2Fplease_inline.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Finline_local%2Fplease_inline.rs?ref=beb444eaed6b1b387538435e6eb99fa0cd0f0bed", "patch": "@@ -0,0 +1,29 @@\n+// Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+pub mod foo {\n+    pub struct Foo;\n+}\n+\n+// @has please_inline/a/index.html\n+pub mod a {\n+    // @!has - 'pub use foo::'\n+    // @has please_inline/a/struct.Foo.html\n+    #[doc(inline)]\n+    pub use foo::Foo;\n+}\n+\n+// @has please_inline/b/index.html\n+pub mod b {\n+    // @has - 'pub use foo::'\n+    // @!has please_inline/b/struct.Foo.html\n+    #[feature(inline)]\n+    pub use foo::Foo;\n+}"}, {"sha": "00f7d90fabc38d303c57103863a4764c04c06904", "filename": "src/test/rustdoc/recursion1.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/beb444eaed6b1b387538435e6eb99fa0cd0f0bed/src%2Ftest%2Frustdoc%2Frecursion1.rs", "raw_url": "https://github.com/rust-lang/rust/raw/beb444eaed6b1b387538435e6eb99fa0cd0f0bed/src%2Ftest%2Frustdoc%2Frecursion1.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Frecursion1.rs?ref=beb444eaed6b1b387538435e6eb99fa0cd0f0bed", "patch": "@@ -9,7 +9,6 @@\n // except according to those terms.\n \n #![crate_type = \"lib\"]\n-#![feature(globs)]\n \n mod m {\n     pub use self::a::Foo;"}, {"sha": "00f7d90fabc38d303c57103863a4764c04c06904", "filename": "src/test/rustdoc/recursion2.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/beb444eaed6b1b387538435e6eb99fa0cd0f0bed/src%2Ftest%2Frustdoc%2Frecursion2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/beb444eaed6b1b387538435e6eb99fa0cd0f0bed/src%2Ftest%2Frustdoc%2Frecursion2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Frecursion2.rs?ref=beb444eaed6b1b387538435e6eb99fa0cd0f0bed", "patch": "@@ -9,7 +9,6 @@\n // except according to those terms.\n \n #![crate_type = \"lib\"]\n-#![feature(globs)]\n \n mod m {\n     pub use self::a::Foo;"}, {"sha": "1d9b903a279206c4799e3b8b5576df2789b3a714", "filename": "src/test/rustdoc/recursion3.rs", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/beb444eaed6b1b387538435e6eb99fa0cd0f0bed/src%2Ftest%2Frustdoc%2Frecursion3.rs", "raw_url": "https://github.com/rust-lang/rust/raw/beb444eaed6b1b387538435e6eb99fa0cd0f0bed/src%2Ftest%2Frustdoc%2Frecursion3.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Frecursion3.rs?ref=beb444eaed6b1b387538435e6eb99fa0cd0f0bed", "patch": "@@ -8,8 +8,6 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n-#![feature(globs)]\n-\n pub mod longhands {\n     pub use super::*;\n "}]}