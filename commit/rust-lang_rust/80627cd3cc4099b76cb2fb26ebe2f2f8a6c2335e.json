{"sha": "80627cd3cc4099b76cb2fb26ebe2f2f8a6c2335e", "node_id": "MDY6Q29tbWl0NzI0NzEyOjgwNjI3Y2QzY2M0MDk5Yjc2Y2IyZmIyNmViZTJmMmY4YTZjMjMzNWU=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-02-07T12:01:31Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-02-07T12:01:31Z"}, "message": "Auto merge of #22023 - alexcrichton:oops-picked-the-wrong-plugin, r=nikomatsakis\n\nThe compiler would previously fall back to using `-L` and normal lookup paths if\r\na `--extern` path was specified but it did not match (wrong architecture, for\r\nexample). This commit removes this behavior and forces the hand of the crate\r\nloader to *always* use the `--extern` path if specified, no matter whether it is\r\ncorrect or not.\r\n\r\nThis fixes a bug today where the compiler's own libraries are favored in cross\r\ncompilation by accident. For example when a crate using the crates.io version of\r\n`log` was cross compiled, Cargo would compile `log` for the target architecture.\r\nWhen loading the macros, however, the compiler currently favors using the *host*\r\narchitecture (for plugins), and because the `--extern log=...` pointed at an\r\nrlib for the target architecture, that lookup failed. The crate loader  then\r\nfell back on `-L` paths to find the compiler-used `log` crate (the wrong one!)\r\nand then a compile failure happened because the logging macros are slightly\r\ndifferent.", "tree": {"sha": "b6062b374e3ccd87b56e92436df74c3b0d960e6d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b6062b374e3ccd87b56e92436df74c3b0d960e6d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/80627cd3cc4099b76cb2fb26ebe2f2f8a6c2335e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/80627cd3cc4099b76cb2fb26ebe2f2f8a6c2335e", "html_url": "https://github.com/rust-lang/rust/commit/80627cd3cc4099b76cb2fb26ebe2f2f8a6c2335e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/80627cd3cc4099b76cb2fb26ebe2f2f8a6c2335e/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a08504bb35f5cb36b702750ba105063d1e2972ff", "url": "https://api.github.com/repos/rust-lang/rust/commits/a08504bb35f5cb36b702750ba105063d1e2972ff", "html_url": "https://github.com/rust-lang/rust/commit/a08504bb35f5cb36b702750ba105063d1e2972ff"}, {"sha": "48b6aef6605794a9da0d9254960a91bbea0a0737", "url": "https://api.github.com/repos/rust-lang/rust/commits/48b6aef6605794a9da0d9254960a91bbea0a0737", "html_url": "https://github.com/rust-lang/rust/commit/48b6aef6605794a9da0d9254960a91bbea0a0737"}], "stats": {"total": 81, "additions": 72, "deletions": 9}, "files": [{"sha": "3158ccd076522f76dc9eec476b9122bc09bbadd4", "filename": "src/librustc/metadata/loader.rs", "status": "modified", "additions": 3, "deletions": 9, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/80627cd3cc4099b76cb2fb26ebe2f2f8a6c2335e/src%2Flibrustc%2Fmetadata%2Floader.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80627cd3cc4099b76cb2fb26ebe2f2f8a6c2335e/src%2Flibrustc%2Fmetadata%2Floader.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmetadata%2Floader.rs?ref=80627cd3cc4099b76cb2fb26ebe2f2f8a6c2335e", "patch": "@@ -370,9 +370,8 @@ impl<'a> Context<'a> {\n         // must be loaded via -L plus some filtering.\n         if self.hash.is_none() {\n             self.should_match_name = false;\n-            match self.find_commandline_library() {\n-                Some(l) => return Some(l),\n-                None => {}\n+            if let Some(s) = self.sess.opts.externs.get(self.crate_name) {\n+                return self.find_commandline_library(s);\n             }\n             self.should_match_name = true;\n         }\n@@ -619,12 +618,7 @@ impl<'a> Context<'a> {\n         (t.options.dll_prefix.clone(), t.options.dll_suffix.clone())\n     }\n \n-    fn find_commandline_library(&mut self) -> Option<Library> {\n-        let locs = match self.sess.opts.externs.get(self.crate_name) {\n-            Some(s) => s,\n-            None => return None,\n-        };\n-\n+    fn find_commandline_library(&mut self, locs: &[String]) -> Option<Library> {\n         // First, filter out all libraries that look suspicious. We only accept\n         // files which actually exist that have the correct naming scheme for\n         // rlibs/dylibs."}, {"sha": "84032b45159f5b8753f8cc6dd06d4cc6f5671092", "filename": "src/test/run-make/use-extern-for-plugins/Makefile", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/80627cd3cc4099b76cb2fb26ebe2f2f8a6c2335e/src%2Ftest%2Frun-make%2Fuse-extern-for-plugins%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/80627cd3cc4099b76cb2fb26ebe2f2f8a6c2335e/src%2Ftest%2Frun-make%2Fuse-extern-for-plugins%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fuse-extern-for-plugins%2FMakefile?ref=80627cd3cc4099b76cb2fb26ebe2f2f8a6c2335e", "patch": "@@ -0,0 +1,13 @@\n+-include ../tools.mk\n+\n+HOST := $(shell $(RUSTC) -vV | grep 'host:' | sed 's/host: //')\n+ifeq ($(findstring i686,$(HOST)),i686)\n+TARGET := $(subst i686,x86_64,$(HOST))\n+else\n+TARGET := $(subst x86_64,i686,$(HOST))\n+endif\n+\n+all:\n+\t$(RUSTC) foo.rs -C extra-filename=-host\n+\t$(RUSTC) bar.rs -C extra-filename=-targ --target $(TARGET)\n+\t$(RUSTC) baz.rs --extern a=$(TMPDIR)/liba-targ.rlib --target $(TARGET)"}, {"sha": "f279893b77bf94bc8c417a245e0c237151fe22f0", "filename": "src/test/run-make/use-extern-for-plugins/bar.rs", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/80627cd3cc4099b76cb2fb26ebe2f2f8a6c2335e/src%2Ftest%2Frun-make%2Fuse-extern-for-plugins%2Fbar.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80627cd3cc4099b76cb2fb26ebe2f2f8a6c2335e/src%2Ftest%2Frun-make%2Fuse-extern-for-plugins%2Fbar.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fuse-extern-for-plugins%2Fbar.rs?ref=80627cd3cc4099b76cb2fb26ebe2f2f8a6c2335e", "patch": "@@ -0,0 +1,19 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![feature(no_std)]\n+#![no_std]\n+#![crate_type = \"lib\"]\n+#![crate_name = \"a\"]\n+\n+#[macro_export]\n+macro_rules! bar {\n+    () => ()\n+}"}, {"sha": "89d6c6bc58c81736fa0c4e48b1f50e8e52963b3f", "filename": "src/test/run-make/use-extern-for-plugins/baz.rs", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/80627cd3cc4099b76cb2fb26ebe2f2f8a6c2335e/src%2Ftest%2Frun-make%2Fuse-extern-for-plugins%2Fbaz.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80627cd3cc4099b76cb2fb26ebe2f2f8a6c2335e/src%2Ftest%2Frun-make%2Fuse-extern-for-plugins%2Fbaz.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fuse-extern-for-plugins%2Fbaz.rs?ref=80627cd3cc4099b76cb2fb26ebe2f2f8a6c2335e", "patch": "@@ -0,0 +1,18 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![feature(no_std)]\n+#![no_std]\n+#![crate_type = \"lib\"]\n+\n+#[macro_use]\n+extern crate a;\n+\n+bar!();"}, {"sha": "554c0fe0326527de2bfbbe911d18bc9d642ecd29", "filename": "src/test/run-make/use-extern-for-plugins/foo.rs", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/80627cd3cc4099b76cb2fb26ebe2f2f8a6c2335e/src%2Ftest%2Frun-make%2Fuse-extern-for-plugins%2Ffoo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80627cd3cc4099b76cb2fb26ebe2f2f8a6c2335e/src%2Ftest%2Frun-make%2Fuse-extern-for-plugins%2Ffoo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fuse-extern-for-plugins%2Ffoo.rs?ref=80627cd3cc4099b76cb2fb26ebe2f2f8a6c2335e", "patch": "@@ -0,0 +1,19 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![feature(no_std)]\n+#![no_std]\n+#![crate_type = \"lib\"]\n+#![crate_name = \"a\"]\n+\n+#[macro_export]\n+macro_rules! foo {\n+    () => ()\n+}"}]}