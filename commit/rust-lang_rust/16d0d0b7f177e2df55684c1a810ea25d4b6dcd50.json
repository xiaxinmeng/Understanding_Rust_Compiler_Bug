{"sha": "16d0d0b7f177e2df55684c1a810ea25d4b6dcd50", "node_id": "C_kwDOAAsO6NoAKDE2ZDBkMGI3ZjE3N2UyZGY1NTY4NGMxYTgxMGVhMjVkNGI2ZGNkNTA", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-07-10T22:33:49Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-07-10T22:33:49Z"}, "message": "Rollup merge of #99095 - rhysd:issue-99092, r=compiler-errors\n\nRemove duplicate notes from error on inter-crate ambiguous impl of traits\n\nFixes #99092", "tree": {"sha": "695bc1b152e91dd935c2ab9fe6c249b29ee5b25b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/695bc1b152e91dd935c2ab9fe6c249b29ee5b25b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/16d0d0b7f177e2df55684c1a810ea25d4b6dcd50", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJiy1PNCRBK7hj4Ov3rIwAAPLMIAKLXeG4nQMBWc1K1ndKO8l+8\nHz4zQRsNKhaUvKdvkiZVgM+HqEIP3NyTV6D4yIi/bQ/HvYYIIf5twWO++3hV1ARM\nGpQ9T8A8e4Ui3BmkJKN5BFMn0VW3FgEcoX9acoYghgj8clrgZFK+QVOLWp5qpjs4\nkMNDdFEhKDjXHJBEQeb6J5LzTkLKmPrI+ocf5KxFlWbeqSkqgosQWkh0/3T0WlNY\necXOaBB8L+uM842Rf00hfA/YmyREfopLGbrEPa0NUjZSAIeGNypzEiZQoYj8gbDZ\nyN0rliWowU+DAGagEjFCSGr1RPVe239PnJcQqw7iNVNEMacdRqranmdfUxfsiVc=\n=p78z\n-----END PGP SIGNATURE-----\n", "payload": "tree 695bc1b152e91dd935c2ab9fe6c249b29ee5b25b\nparent 342b666d59cea95ce21930aa8e1254dbd76eae10\nparent d5aed20f4712010585532b4de51918bd66ac4797\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1657492429 +0200\ncommitter GitHub <noreply@github.com> 1657492429 +0200\n\nRollup merge of #99095 - rhysd:issue-99092, r=compiler-errors\n\nRemove duplicate notes from error on inter-crate ambiguous impl of traits\n\nFixes #99092\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/16d0d0b7f177e2df55684c1a810ea25d4b6dcd50", "html_url": "https://github.com/rust-lang/rust/commit/16d0d0b7f177e2df55684c1a810ea25d4b6dcd50", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/16d0d0b7f177e2df55684c1a810ea25d4b6dcd50/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "342b666d59cea95ce21930aa8e1254dbd76eae10", "url": "https://api.github.com/repos/rust-lang/rust/commits/342b666d59cea95ce21930aa8e1254dbd76eae10", "html_url": "https://github.com/rust-lang/rust/commit/342b666d59cea95ce21930aa8e1254dbd76eae10"}, {"sha": "d5aed20f4712010585532b4de51918bd66ac4797", "url": "https://api.github.com/repos/rust-lang/rust/commits/d5aed20f4712010585532b4de51918bd66ac4797", "html_url": "https://github.com/rust-lang/rust/commit/d5aed20f4712010585532b4de51918bd66ac4797"}], "stats": {"total": 58, "additions": 45, "deletions": 13}, "files": [{"sha": "52ca23c4b303ebd906a9b10eaf33fcabb7a64f48", "filename": "compiler/rustc_trait_selection/src/traits/coherence.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/16d0d0b7f177e2df55684c1a810ea25d4b6dcd50/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fcoherence.rs", "raw_url": "https://github.com/rust-lang/rust/raw/16d0d0b7f177e2df55684c1a810ea25d4b6dcd50/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fcoherence.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fcoherence.rs?ref=16d0d0b7f177e2df55684c1a810ea25d4b6dcd50", "patch": "@@ -13,7 +13,7 @@ use crate::traits::{\n     self, FulfillmentContext, Normalized, Obligation, ObligationCause, PredicateObligation,\n     PredicateObligations, SelectionContext,\n };\n-//use rustc_data_structures::fx::FxHashMap;\n+use rustc_data_structures::fx::FxIndexSet;\n use rustc_errors::Diagnostic;\n use rustc_hir::def_id::{DefId, LOCAL_CRATE};\n use rustc_infer::infer::{InferCtxt, TyCtxtInferExt};\n@@ -44,7 +44,7 @@ pub enum Conflict {\n \n pub struct OverlapResult<'tcx> {\n     pub impl_header: ty::ImplHeader<'tcx>,\n-    pub intercrate_ambiguity_causes: Vec<IntercrateAmbiguityCause>,\n+    pub intercrate_ambiguity_causes: FxIndexSet<IntercrateAmbiguityCause>,\n \n     /// `true` if the overlap might've been permitted before the shift\n     /// to universes."}, {"sha": "96d83deeeb7ab885e57d717a4d7d47add0c24303", "filename": "compiler/rustc_trait_selection/src/traits/select/candidate_assembly.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/16d0d0b7f177e2df55684c1a810ea25d4b6dcd50/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fcandidate_assembly.rs", "raw_url": "https://github.com/rust-lang/rust/raw/16d0d0b7f177e2df55684c1a810ea25d4b6dcd50/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fcandidate_assembly.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fcandidate_assembly.rs?ref=16d0d0b7f177e2df55684c1a810ea25d4b6dcd50", "patch": "@@ -110,7 +110,7 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n                             IntercrateAmbiguityCause::DownstreamCrate { trait_desc, self_desc }\n                         };\n                         debug!(?cause, \"evaluate_stack: pushing cause\");\n-                        self.intercrate_ambiguity_causes.as_mut().unwrap().push(cause);\n+                        self.intercrate_ambiguity_causes.as_mut().unwrap().insert(cause);\n                     }\n                 }\n             }"}, {"sha": "2bb53a466caa462bfdef02a96442bf18fe9babb3", "filename": "compiler/rustc_trait_selection/src/traits/select/mod.rs", "status": "modified", "additions": 7, "deletions": 7, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/16d0d0b7f177e2df55684c1a810ea25d4b6dcd50/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/16d0d0b7f177e2df55684c1a810ea25d4b6dcd50/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fselect%2Fmod.rs?ref=16d0d0b7f177e2df55684c1a810ea25d4b6dcd50", "patch": "@@ -24,7 +24,7 @@ use crate::traits::error_reporting::InferCtxtExt;\n use crate::traits::project::ProjectAndUnifyResult;\n use crate::traits::project::ProjectionCacheKeyExt;\n use crate::traits::ProjectionCacheKey;\n-use rustc_data_structures::fx::{FxHashMap, FxHashSet};\n+use rustc_data_structures::fx::{FxHashMap, FxHashSet, FxIndexSet};\n use rustc_data_structures::stack::ensure_sufficient_stack;\n use rustc_errors::{Diagnostic, ErrorGuaranteed};\n use rustc_hir as hir;\n@@ -52,7 +52,7 @@ pub use rustc_middle::traits::select::*;\n mod candidate_assembly;\n mod confirmation;\n \n-#[derive(Clone, Debug)]\n+#[derive(Clone, Debug, Eq, PartialEq, Hash)]\n pub enum IntercrateAmbiguityCause {\n     DownstreamCrate { trait_desc: String, self_desc: Option<String> },\n     UpstreamCrateUpdate { trait_desc: String, self_desc: Option<String> },\n@@ -128,7 +128,7 @@ pub struct SelectionContext<'cx, 'tcx> {\n     /// We don't do his until we detect a coherence error because it can\n     /// lead to false overflow results (#47139) and because always\n     /// computing it may negatively impact performance.\n-    intercrate_ambiguity_causes: Option<Vec<IntercrateAmbiguityCause>>,\n+    intercrate_ambiguity_causes: Option<FxIndexSet<IntercrateAmbiguityCause>>,\n \n     /// The mode that trait queries run in, which informs our error handling\n     /// policy. In essence, canonicalized queries need their errors propagated\n@@ -254,14 +254,14 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n     pub fn enable_tracking_intercrate_ambiguity_causes(&mut self) {\n         assert!(self.intercrate);\n         assert!(self.intercrate_ambiguity_causes.is_none());\n-        self.intercrate_ambiguity_causes = Some(vec![]);\n+        self.intercrate_ambiguity_causes = Some(FxIndexSet::default());\n         debug!(\"selcx: enable_tracking_intercrate_ambiguity_causes\");\n     }\n \n     /// Gets the intercrate ambiguity causes collected since tracking\n     /// was enabled and disables tracking at the same time. If\n     /// tracking is not enabled, just returns an empty vector.\n-    pub fn take_intercrate_ambiguity_causes(&mut self) -> Vec<IntercrateAmbiguityCause> {\n+    pub fn take_intercrate_ambiguity_causes(&mut self) -> FxIndexSet<IntercrateAmbiguityCause> {\n         assert!(self.intercrate);\n         self.intercrate_ambiguity_causes.take().unwrap_or_default()\n     }\n@@ -960,7 +960,7 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n                             });\n \n                             debug!(?cause, \"evaluate_stack: pushing cause\");\n-                            self.intercrate_ambiguity_causes.as_mut().unwrap().push(cause);\n+                            self.intercrate_ambiguity_causes.as_mut().unwrap().insert(cause);\n                         }\n                     }\n                 }\n@@ -1252,7 +1252,7 @@ impl<'cx, 'tcx> SelectionContext<'cx, 'tcx> {\n                                  reservation impl ambiguity on {:?}\",\n                             def_id\n                         );\n-                        intercrate_ambiguity_clauses.push(\n+                        intercrate_ambiguity_clauses.insert(\n                             IntercrateAmbiguityCause::ReservationImpl {\n                                 message: value.to_string(),\n                             },"}, {"sha": "2c4a453aefc3404d50e3de3fb58d1b2a219465c0", "filename": "compiler/rustc_trait_selection/src/traits/specialize/mod.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/16d0d0b7f177e2df55684c1a810ea25d4b6dcd50/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fspecialize%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/16d0d0b7f177e2df55684c1a810ea25d4b6dcd50/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fspecialize%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fspecialize%2Fmod.rs?ref=16d0d0b7f177e2df55684c1a810ea25d4b6dcd50", "patch": "@@ -15,7 +15,7 @@ use specialization_graph::GraphExt;\n use crate::infer::{InferCtxt, InferOk, TyCtxtInferExt};\n use crate::traits::select::IntercrateAmbiguityCause;\n use crate::traits::{self, coherence, FutureCompatOverlapErrorKind, ObligationCause, TraitEngine};\n-use rustc_data_structures::fx::FxHashSet;\n+use rustc_data_structures::fx::{FxHashSet, FxIndexSet};\n use rustc_errors::{struct_span_err, EmissionGuarantee, LintDiagnosticBuilder};\n use rustc_hir::def_id::{DefId, LocalDefId};\n use rustc_middle::ty::subst::{InternalSubsts, Subst, SubstsRef};\n@@ -33,7 +33,7 @@ pub struct OverlapError {\n     pub with_impl: DefId,\n     pub trait_desc: String,\n     pub self_desc: Option<String>,\n-    pub intercrate_ambiguity_causes: Vec<IntercrateAmbiguityCause>,\n+    pub intercrate_ambiguity_causes: FxIndexSet<IntercrateAmbiguityCause>,\n     pub involves_placeholder: bool,\n }\n "}, {"sha": "b1ee0795b2eb3b7293fd8f79b21f72b81746a6e4", "filename": "src/test/ui/coherence/coherence-projection-conflict-orphan.stderr", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/16d0d0b7f177e2df55684c1a810ea25d4b6dcd50/src%2Ftest%2Fui%2Fcoherence%2Fcoherence-projection-conflict-orphan.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/16d0d0b7f177e2df55684c1a810ea25d4b6dcd50/src%2Ftest%2Fui%2Fcoherence%2Fcoherence-projection-conflict-orphan.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcoherence%2Fcoherence-projection-conflict-orphan.stderr?ref=16d0d0b7f177e2df55684c1a810ea25d4b6dcd50", "patch": "@@ -8,7 +8,6 @@ LL | impl<A:Iterator> Foo<A::Item> for A { }\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ conflicting implementation for `i32`\n    |\n    = note: upstream crates may add a new impl of trait `std::iter::Iterator` for type `i32` in future versions\n-   = note: upstream crates may add a new impl of trait `std::iter::Iterator` for type `i32` in future versions\n \n error: aborting due to previous error\n "}, {"sha": "5b11c78ab2605667137e459cdd0dd7f61cf061f0", "filename": "src/test/ui/coherence/inter-crate-ambiguity-causes-notes.rs", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/16d0d0b7f177e2df55684c1a810ea25d4b6dcd50/src%2Ftest%2Fui%2Fcoherence%2Finter-crate-ambiguity-causes-notes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/16d0d0b7f177e2df55684c1a810ea25d4b6dcd50/src%2Ftest%2Fui%2Fcoherence%2Finter-crate-ambiguity-causes-notes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcoherence%2Finter-crate-ambiguity-causes-notes.rs?ref=16d0d0b7f177e2df55684c1a810ea25d4b6dcd50", "patch": "@@ -0,0 +1,19 @@\n+struct S;\n+\n+impl From<()> for S {\n+    fn from(x: ()) -> Self {\n+        S\n+    }\n+}\n+\n+impl<I> From<I> for S\n+//~^ ERROR conflicting implementations of trait\n+where\n+    I: Iterator<Item = ()>,\n+{\n+    fn from(x: I) -> Self {\n+        S\n+    }\n+}\n+\n+fn main() {}"}, {"sha": "038a0199a8f270105716725913c4e6142ba50926", "filename": "src/test/ui/coherence/inter-crate-ambiguity-causes-notes.stderr", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/16d0d0b7f177e2df55684c1a810ea25d4b6dcd50/src%2Ftest%2Fui%2Fcoherence%2Finter-crate-ambiguity-causes-notes.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/16d0d0b7f177e2df55684c1a810ea25d4b6dcd50/src%2Ftest%2Fui%2Fcoherence%2Finter-crate-ambiguity-causes-notes.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcoherence%2Finter-crate-ambiguity-causes-notes.stderr?ref=16d0d0b7f177e2df55684c1a810ea25d4b6dcd50", "patch": "@@ -0,0 +1,14 @@\n+error[E0119]: conflicting implementations of trait `std::convert::From<()>` for type `S`\n+  --> $DIR/inter-crate-ambiguity-causes-notes.rs:9:1\n+   |\n+LL | impl From<()> for S {\n+   | ------------------- first implementation here\n+...\n+LL | impl<I> From<I> for S\n+   | ^^^^^^^^^^^^^^^^^^^^^ conflicting implementation for `S`\n+   |\n+   = note: upstream crates may add a new impl of trait `std::iter::Iterator` for type `()` in future versions\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0119`."}]}