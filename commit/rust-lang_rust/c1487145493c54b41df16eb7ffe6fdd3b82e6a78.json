{"sha": "c1487145493c54b41df16eb7ffe6fdd3b82e6a78", "node_id": "MDY6Q29tbWl0NzI0NzEyOmMxNDg3MTQ1NDkzYzU0YjQxZGYxNmViN2ZmZTZmZGQzYjgyZTZhNzg=", "commit": {"author": {"name": "varkor", "email": "github@varkor.com", "date": "2018-11-10T18:08:50Z"}, "committer": {"name": "varkor", "email": "github@varkor.com", "date": "2018-11-10T19:26:49Z"}, "message": "Rewrite `...` as `..=` as a MachineApplicable 2018 idiom lint", "tree": {"sha": "a07989beeab6f805a1673a48ebc30b3b78271886", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a07989beeab6f805a1673a48ebc30b3b78271886"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c1487145493c54b41df16eb7ffe6fdd3b82e6a78", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c1487145493c54b41df16eb7ffe6fdd3b82e6a78", "html_url": "https://github.com/rust-lang/rust/commit/c1487145493c54b41df16eb7ffe6fdd3b82e6a78", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c1487145493c54b41df16eb7ffe6fdd3b82e6a78/comments", "author": {"login": "varkor", "id": 3943692, "node_id": "MDQ6VXNlcjM5NDM2OTI=", "avatar_url": "https://avatars.githubusercontent.com/u/3943692?v=4", "gravatar_id": "", "url": "https://api.github.com/users/varkor", "html_url": "https://github.com/varkor", "followers_url": "https://api.github.com/users/varkor/followers", "following_url": "https://api.github.com/users/varkor/following{/other_user}", "gists_url": "https://api.github.com/users/varkor/gists{/gist_id}", "starred_url": "https://api.github.com/users/varkor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/varkor/subscriptions", "organizations_url": "https://api.github.com/users/varkor/orgs", "repos_url": "https://api.github.com/users/varkor/repos", "events_url": "https://api.github.com/users/varkor/events{/privacy}", "received_events_url": "https://api.github.com/users/varkor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "varkor", "id": 3943692, "node_id": "MDQ6VXNlcjM5NDM2OTI=", "avatar_url": "https://avatars.githubusercontent.com/u/3943692?v=4", "gravatar_id": "", "url": "https://api.github.com/users/varkor", "html_url": "https://github.com/varkor", "followers_url": "https://api.github.com/users/varkor/followers", "following_url": "https://api.github.com/users/varkor/following{/other_user}", "gists_url": "https://api.github.com/users/varkor/gists{/gist_id}", "starred_url": "https://api.github.com/users/varkor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/varkor/subscriptions", "organizations_url": "https://api.github.com/users/varkor/orgs", "repos_url": "https://api.github.com/users/varkor/repos", "events_url": "https://api.github.com/users/varkor/events{/privacy}", "received_events_url": "https://api.github.com/users/varkor/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8315b11b6352cbd91ee096571c31ae7d3ac9613d", "url": "https://api.github.com/repos/rust-lang/rust/commits/8315b11b6352cbd91ee096571c31ae7d3ac9613d", "html_url": "https://github.com/rust-lang/rust/commit/8315b11b6352cbd91ee096571c31ae7d3ac9613d"}], "stats": {"total": 79, "additions": 62, "deletions": 17}, "files": [{"sha": "8acbaaa844d74d06f64d4b52cd4c2843fcabd6f8", "filename": "src/librustc/lint/context.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/c1487145493c54b41df16eb7ffe6fdd3b82e6a78/src%2Flibrustc%2Flint%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c1487145493c54b41df16eb7ffe6fdd3b82e6a78/src%2Flibrustc%2Flint%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Flint%2Fcontext.rs?ref=c1487145493c54b41df16eb7ffe6fdd3b82e6a78", "patch": "@@ -1020,9 +1020,12 @@ impl<'a> ast_visit::Visitor<'a> for EarlyContext<'a> {\n     }\n \n     fn visit_pat(&mut self, p: &'a ast::Pat) {\n-        run_lints!(self, check_pat, p);\n+        let mut visit_subpats = true;\n+        run_lints!(self, check_pat, p, &mut visit_subpats);\n         self.check_id(p.id);\n-        ast_visit::walk_pat(self, p);\n+        if visit_subpats {\n+            ast_visit::walk_pat(self, p);\n+        }\n     }\n \n     fn visit_expr(&mut self, e: &'a ast::Expr) {"}, {"sha": "18922ec5d1739861c19c9de861441162979f2ef5", "filename": "src/librustc/lint/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/c1487145493c54b41df16eb7ffe6fdd3b82e6a78/src%2Flibrustc%2Flint%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c1487145493c54b41df16eb7ffe6fdd3b82e6a78/src%2Flibrustc%2Flint%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Flint%2Fmod.rs?ref=c1487145493c54b41df16eb7ffe6fdd3b82e6a78", "patch": "@@ -341,7 +341,7 @@ pub trait EarlyLintPass: LintPass {\n     fn check_block_post(&mut self, _: &EarlyContext<'_>, _: &ast::Block) { }\n     fn check_stmt(&mut self, _: &EarlyContext<'_>, _: &ast::Stmt) { }\n     fn check_arm(&mut self, _: &EarlyContext<'_>, _: &ast::Arm) { }\n-    fn check_pat(&mut self, _: &EarlyContext<'_>, _: &ast::Pat) { }\n+    fn check_pat(&mut self, _: &EarlyContext<'_>, _: &ast::Pat, _: &mut bool) { }\n     fn check_expr(&mut self, _: &EarlyContext<'_>, _: &ast::Expr) { }\n     fn check_expr_post(&mut self, _: &EarlyContext<'_>, _: &ast::Expr) { }\n     fn check_ty(&mut self, _: &EarlyContext<'_>, _: &ast::Ty) { }"}, {"sha": "652de5dd1205c97ba9c8fbe849fb884eea93b15e", "filename": "src/librustc_lint/builtin.rs", "status": "modified", "additions": 34, "deletions": 10, "changes": 44, "blob_url": "https://github.com/rust-lang/rust/blob/c1487145493c54b41df16eb7ffe6fdd3b82e6a78/src%2Flibrustc_lint%2Fbuiltin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c1487145493c54b41df16eb7ffe6fdd3b82e6a78/src%2Flibrustc_lint%2Fbuiltin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_lint%2Fbuiltin.rs?ref=c1487145493c54b41df16eb7ffe6fdd3b82e6a78", "patch": "@@ -40,13 +40,16 @@ use rustc::util::nodemap::FxHashSet;\n \n use syntax::tokenstream::{TokenTree, TokenStream};\n use syntax::ast;\n+use syntax::ptr::P;\n+use syntax::ast::Expr;\n use syntax::attr;\n use syntax::source_map::Spanned;\n use syntax::edition::Edition;\n use syntax::feature_gate::{AttributeGate, AttributeType, Stability, deprecated_attributes};\n use syntax_pos::{BytePos, Span, SyntaxContext};\n use syntax::symbol::keywords;\n use syntax::errors::{Applicability, DiagnosticBuilder};\n+use syntax::print::pprust::expr_to_string;\n \n use rustc::hir::{self, GenericParamKind, PatKind};\n use rustc::hir::intravisit::FnKind;\n@@ -1407,21 +1410,42 @@ impl LintPass for EllipsisInclusiveRangePatterns {\n }\n \n impl EarlyLintPass for EllipsisInclusiveRangePatterns {\n-    fn check_pat(&mut self, cx: &EarlyContext, pat: &ast::Pat) {\n-        use self::ast::{PatKind, RangeEnd, RangeSyntax};\n+    fn check_pat(&mut self, cx: &EarlyContext, pat: &ast::Pat, visit_subpats: &mut bool) {\n+        use self::ast::{PatKind, RangeEnd, RangeSyntax::DotDotDot};\n+\n+        /// If `pat` is a `...` pattern, return the start and end of the range, as well as the span\n+        /// corresponding to the ellipsis.\n+        fn matches_ellipsis_pat(pat: &ast::Pat) -> Option<(&P<Expr>, &P<Expr>, Span)> {\n+            match &pat.node {\n+                PatKind::Range(a, b, Spanned { span, node: RangeEnd::Included(DotDotDot), .. }) => {\n+                    Some((a, b, *span))\n+                }\n+                _ => None,\n+            }\n+        }\n+\n+        let (parenthesise, endpoints) = match &pat.node {\n+            PatKind::Ref(subpat, _) => (true, matches_ellipsis_pat(&subpat)),\n+            _ => (false, matches_ellipsis_pat(pat)),\n+        };\n \n-        if let PatKind::Range(\n-            _, _, Spanned { span, node: RangeEnd::Included(RangeSyntax::DotDotDot) }\n-        ) = pat.node {\n+        if let Some((start, end, join)) = endpoints {\n             let msg = \"`...` range patterns are deprecated\";\n+            let suggestion = \"use `..=` for an inclusive range\";\n+            let (span, replacement) = if parenthesise {\n+                *visit_subpats = false;\n+                (pat.span, format!(\"&({}..={})\", expr_to_string(&start), expr_to_string(&end)))\n+            } else {\n+                (join, \"..=\".to_owned())\n+            };\n             let mut err = cx.struct_span_lint(ELLIPSIS_INCLUSIVE_RANGE_PATTERNS, span, msg);\n             err.span_suggestion_short_with_applicability(\n-                span, \"use `..=` for an inclusive range\", \"..=\".to_owned(),\n-                // FIXME: outstanding problem with precedence in ref patterns:\n-                // https://github.com/rust-lang/rust/issues/51043#issuecomment-392252285\n-                Applicability::MaybeIncorrect\n+                span,\n+                suggestion,\n+                replacement,\n+                Applicability::MachineApplicable,\n             );\n-            err.emit()\n+            err.emit();\n         }\n     }\n }"}, {"sha": "7eab7d21002905778c494089850c05c9b957bdf4", "filename": "src/librustc_lint/unused.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/c1487145493c54b41df16eb7ffe6fdd3b82e6a78/src%2Flibrustc_lint%2Funused.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c1487145493c54b41df16eb7ffe6fdd3b82e6a78/src%2Flibrustc_lint%2Funused.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_lint%2Funused.rs?ref=c1487145493c54b41df16eb7ffe6fdd3b82e6a78", "patch": "@@ -396,12 +396,12 @@ impl EarlyLintPass for UnusedParens {\n         self.check_unused_parens_expr(cx, &value, msg, followed_by_block);\n     }\n \n-    fn check_pat(&mut self, cx: &EarlyContext, p: &ast::Pat) {\n+    fn check_pat(&mut self, cx: &EarlyContext, p: &ast::Pat, _: &mut bool) {\n         use ast::PatKind::{Paren, Range};\n         // The lint visitor will visit each subpattern of `p`. We do not want to lint any range\n         // pattern no matter where it occurs in the pattern. For something like `&(a..=b)`, there\n         // is a recursive `check_pat` on `a` and `b`, but we will assume that if there are\n-        // unnecessry parens they serve a purpose of readability.\n+        // unnecessary parens they serve a purpose of readability.\n         if let Paren(ref pat) = p.node {\n             match pat.node {\n                 Range(..) => {}"}, {"sha": "f0aee8a51f18b65e72547a25c31d0c1fb0e0076e", "filename": "src/test/ui/lint/inclusive-range-pattern-syntax.fixed", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/c1487145493c54b41df16eb7ffe6fdd3b82e6a78/src%2Ftest%2Fui%2Flint%2Finclusive-range-pattern-syntax.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/c1487145493c54b41df16eb7ffe6fdd3b82e6a78/src%2Ftest%2Fui%2Flint%2Finclusive-range-pattern-syntax.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Finclusive-range-pattern-syntax.fixed?ref=c1487145493c54b41df16eb7ffe6fdd3b82e6a78", "patch": "@@ -20,4 +20,10 @@ fn main() {\n         //~^ WARN `...` range patterns are deprecated\n         _ => {}\n     }\n+\n+    match &despondency {\n+        &(1..=2) => {}\n+        //~^ WARN `...` range patterns are deprecated\n+        _ => {}\n+    }\n }"}, {"sha": "97bc04faa774b4da8c3932fe3d1262cc02ef8505", "filename": "src/test/ui/lint/inclusive-range-pattern-syntax.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/c1487145493c54b41df16eb7ffe6fdd3b82e6a78/src%2Ftest%2Fui%2Flint%2Finclusive-range-pattern-syntax.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c1487145493c54b41df16eb7ffe6fdd3b82e6a78/src%2Ftest%2Fui%2Flint%2Finclusive-range-pattern-syntax.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Finclusive-range-pattern-syntax.rs?ref=c1487145493c54b41df16eb7ffe6fdd3b82e6a78", "patch": "@@ -20,4 +20,10 @@ fn main() {\n         //~^ WARN `...` range patterns are deprecated\n         _ => {}\n     }\n+\n+    match &despondency {\n+        &1...2 => {}\n+        //~^ WARN `...` range patterns are deprecated\n+        _ => {}\n+    }\n }"}, {"sha": "9226137f1152f608bb59124c40070e81dac11f29", "filename": "src/test/ui/lint/inclusive-range-pattern-syntax.stderr", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/c1487145493c54b41df16eb7ffe6fdd3b82e6a78/src%2Ftest%2Fui%2Flint%2Finclusive-range-pattern-syntax.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c1487145493c54b41df16eb7ffe6fdd3b82e6a78/src%2Ftest%2Fui%2Flint%2Finclusive-range-pattern-syntax.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Finclusive-range-pattern-syntax.stderr?ref=c1487145493c54b41df16eb7ffe6fdd3b82e6a78", "patch": "@@ -10,3 +10,9 @@ note: lint level defined here\n LL | #![warn(ellipsis_inclusive_range_patterns)]\n    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n+warning: `...` range patterns are deprecated\n+  --> $DIR/inclusive-range-pattern-syntax.rs:25:9\n+   |\n+LL |         &1...2 => {}\n+   |         ^^^^^^ help: use `..=` for an inclusive range\n+"}, {"sha": "3ac6be2b8ea6a48d2021532e7c2c2bca7c2ff4bd", "filename": "src/test/ui/range/range-inclusive-pattern-precedence.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/c1487145493c54b41df16eb7ffe6fdd3b82e6a78/src%2Ftest%2Fui%2Frange%2Frange-inclusive-pattern-precedence.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c1487145493c54b41df16eb7ffe6fdd3b82e6a78/src%2Ftest%2Fui%2Frange%2Frange-inclusive-pattern-precedence.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frange%2Frange-inclusive-pattern-precedence.stderr?ref=c1487145493c54b41df16eb7ffe6fdd3b82e6a78", "patch": "@@ -11,10 +11,10 @@ LL |         box 10..=15 => {}\n    |             ^^^^^^^ help: add parentheses to clarify the precedence: `(10 ..=15)`\n \n warning: `...` range patterns are deprecated\n-  --> $DIR/range-inclusive-pattern-precedence.rs:24:11\n+  --> $DIR/range-inclusive-pattern-precedence.rs:24:9\n    |\n LL |         &0...9 => {}\n-   |           ^^^ help: use `..=` for an inclusive range\n+   |         ^^^^^^ help: use `..=` for an inclusive range\n    |\n note: lint level defined here\n   --> $DIR/range-inclusive-pattern-precedence.rs:19:9"}]}