{"sha": "4cf36545e65c91a92f7a29681fb7f4346475e81b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRjZjM2NTQ1ZTY1YzkxYTkyZjdhMjk2ODFmYjdmNDM0NjQ3NWU4MWI=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-03-18T14:14:52Z"}, "committer": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-03-18T14:14:52Z"}, "message": "Create AstId for builtin_derive macro in tests", "tree": {"sha": "5f018aed7c3866dfe67bbef812dad9a5a434447b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5f018aed7c3866dfe67bbef812dad9a5a434447b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4cf36545e65c91a92f7a29681fb7f4346475e81b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4cf36545e65c91a92f7a29681fb7f4346475e81b", "html_url": "https://github.com/rust-lang/rust/commit/4cf36545e65c91a92f7a29681fb7f4346475e81b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4cf36545e65c91a92f7a29681fb7f4346475e81b/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d3da042a6297b60799f6f97dd4d58d559a9b5838", "url": "https://api.github.com/repos/rust-lang/rust/commits/d3da042a6297b60799f6f97dd4d58d559a9b5838", "html_url": "https://github.com/rust-lang/rust/commit/d3da042a6297b60799f6f97dd4d58d559a9b5838"}], "stats": {"total": 41, "additions": 28, "deletions": 13}, "files": [{"sha": "a8d267c30ecfac507e81571f37204245e0d538e2", "filename": "crates/hir_expand/src/builtin_derive.rs", "status": "modified", "additions": 28, "deletions": 13, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/4cf36545e65c91a92f7a29681fb7f4346475e81b/crates%2Fhir_expand%2Fsrc%2Fbuiltin_derive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4cf36545e65c91a92f7a29681fb7f4346475e81b/crates%2Fhir_expand%2Fsrc%2Fbuiltin_derive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_expand%2Fsrc%2Fbuiltin_derive.rs?ref=4cf36545e65c91a92f7a29681fb7f4346475e81b", "patch": "@@ -268,14 +268,13 @@ fn partial_ord_expand(\n mod tests {\n     use base_db::{fixture::WithFixture, CrateId, SourceDatabase};\n     use expect_test::{expect, Expect};\n-    use name::{known, Name};\n+    use name::AsName;\n \n     use crate::{test_db::TestDB, AstId, MacroCallId, MacroCallKind, MacroCallLoc};\n \n     use super::*;\n \n-    fn expand_builtin_derive(ra_fixture: &str, name: Name) -> String {\n-        let expander = BuiltinDeriveExpander::find_by_name(&name).unwrap();\n+    fn expand_builtin_derive(ra_fixture: &str) -> String {\n         let fixture = format!(\n             r#\"//- /main.rs crate:main deps:core\n $0\n@@ -288,18 +287,34 @@ $0\n \n         let (db, file_pos) = TestDB::with_position(&fixture);\n         let file_id = file_pos.file_id;\n+        let ast_id_map = db.ast_id_map(file_id.into());\n         let parsed = db.parse(file_id);\n-        let items: Vec<_> =\n-            parsed.syntax_node().descendants().filter_map(ast::Item::cast).collect();\n+        let macros: Vec<_> =\n+            parsed.syntax_node().descendants().filter_map(ast::Macro::cast).collect();\n+        let items: Vec<_> = parsed\n+            .syntax_node()\n+            .descendants()\n+            .filter(|node| !ast::Macro::can_cast(node.kind()))\n+            .filter_map(ast::Item::cast)\n+            .collect();\n+\n+        assert_eq!(macros.len(), 1, \"test must contain exactly 1 macro definition\");\n+        assert_eq!(items.len(), 1, \"test must contain exactly 1 item\");\n+\n+        let macro_ast_id = AstId::new(file_id.into(), ast_id_map.ast_id(&macros[0]));\n+        let name = match &macros[0] {\n+            ast::Macro::MacroRules(rules) => rules.name().unwrap().as_name(),\n+            ast::Macro::MacroDef(def) => def.name().unwrap().as_name(),\n+        };\n \n-        let ast_id_map = db.ast_id_map(file_id.into());\n+        let expander = BuiltinDeriveExpander::find_by_name(&name).unwrap();\n \n         let attr_id = AstId::new(file_id.into(), ast_id_map.ast_id(&items[0]));\n \n         let loc = MacroCallLoc {\n             def: MacroDefId {\n                 krate: CrateId(0),\n-                ast_id: None,\n+                ast_id: Some(macro_ast_id),\n                 kind: MacroDefKind::BuiltInDerive(expander),\n                 local_inner: false,\n             },\n@@ -315,19 +330,19 @@ $0\n         parsed.text().to_string()\n     }\n \n-    fn check_derive(ra_fixture: &str, name: Name, expected: Expect) {\n-        let expanded = expand_builtin_derive(ra_fixture, name);\n+    fn check_derive(ra_fixture: &str, expected: Expect) {\n+        let expanded = expand_builtin_derive(ra_fixture);\n         expected.assert_eq(&expanded);\n     }\n \n     #[test]\n     fn test_copy_expand_simple() {\n         check_derive(\n             r#\"\n+            macro Copy {}\n             #[derive(Copy)]\n             struct Foo;\n             \"#,\n-            known::Copy,\n             expect![[\"impl< >core::marker::CopyforFoo< >{}\"]],\n         );\n     }\n@@ -336,10 +351,10 @@ $0\n     fn test_copy_expand_with_type_params() {\n         check_derive(\n             r#\"\n+            macro Copy {}\n             #[derive(Copy)]\n             struct Foo<A, B>;\n             \"#,\n-            known::Copy,\n             expect![[\"impl<T0:core::marker::Copy,T1:core::marker::Copy>core::marker::CopyforFoo<T0,T1>{}\"]],\n         );\n     }\n@@ -348,10 +363,10 @@ $0\n     fn test_copy_expand_with_lifetimes() {\n         check_derive(\n             r#\"\n+            macro Copy {}\n             #[derive(Copy)]\n             struct Foo<A, B, 'a, 'b>;\n             \"#,\n-            known::Copy,\n             // We currently just ignore lifetimes\n             expect![[\"impl<T0:core::marker::Copy,T1:core::marker::Copy>core::marker::CopyforFoo<T0,T1>{}\"]],\n         );\n@@ -361,10 +376,10 @@ $0\n     fn test_clone_expand() {\n         check_derive(\n             r#\"\n+            macro Clone {}\n             #[derive(Clone)]\n             struct Foo<A, B>;\n             \"#,\n-            known::Clone,\n             expect![[\"impl<T0:core::clone::Clone,T1:core::clone::Clone>core::clone::CloneforFoo<T0,T1>{}\"]],\n         );\n     }"}]}