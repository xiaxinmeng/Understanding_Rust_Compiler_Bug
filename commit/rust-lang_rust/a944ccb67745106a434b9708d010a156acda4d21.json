{"sha": "a944ccb67745106a434b9708d010a156acda4d21", "node_id": "C_kwDOAAsO6NoAKGE5NDRjY2I2Nzc0NTEwNmE0MzRiOTcwOGQwMTBhMTU2YWNkYTRkMjE", "commit": {"author": {"name": "Tianyi Song", "email": "42670338+tysg@users.noreply.github.com", "date": "2022-03-11T03:31:17Z"}, "committer": {"name": "Tianyi Song", "email": "42670338+tysg@users.noreply.github.com", "date": "2022-03-11T08:02:49Z"}, "message": "Check if lhs < rhs in modulos and emit", "tree": {"sha": "655331dd156ef5963ef34e91839d3e0099915bfa", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/655331dd156ef5963ef34e91839d3e0099915bfa"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a944ccb67745106a434b9708d010a156acda4d21", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a944ccb67745106a434b9708d010a156acda4d21", "html_url": "https://github.com/rust-lang/rust/commit/a944ccb67745106a434b9708d010a156acda4d21", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a944ccb67745106a434b9708d010a156acda4d21/comments", "author": {"login": "tysg", "id": 42670338, "node_id": "MDQ6VXNlcjQyNjcwMzM4", "avatar_url": "https://avatars.githubusercontent.com/u/42670338?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tysg", "html_url": "https://github.com/tysg", "followers_url": "https://api.github.com/users/tysg/followers", "following_url": "https://api.github.com/users/tysg/following{/other_user}", "gists_url": "https://api.github.com/users/tysg/gists{/gist_id}", "starred_url": "https://api.github.com/users/tysg/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tysg/subscriptions", "organizations_url": "https://api.github.com/users/tysg/orgs", "repos_url": "https://api.github.com/users/tysg/repos", "events_url": "https://api.github.com/users/tysg/events{/privacy}", "received_events_url": "https://api.github.com/users/tysg/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tysg", "id": 42670338, "node_id": "MDQ6VXNlcjQyNjcwMzM4", "avatar_url": "https://avatars.githubusercontent.com/u/42670338?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tysg", "html_url": "https://github.com/tysg", "followers_url": "https://api.github.com/users/tysg/followers", "following_url": "https://api.github.com/users/tysg/following{/other_user}", "gists_url": "https://api.github.com/users/tysg/gists{/gist_id}", "starred_url": "https://api.github.com/users/tysg/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tysg/subscriptions", "organizations_url": "https://api.github.com/users/tysg/orgs", "repos_url": "https://api.github.com/users/tysg/repos", "events_url": "https://api.github.com/users/tysg/events{/privacy}", "received_events_url": "https://api.github.com/users/tysg/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0c483f69db979f9dc88f96493ea4b21d946d845d", "url": "https://api.github.com/repos/rust-lang/rust/commits/0c483f69db979f9dc88f96493ea4b21d946d845d", "html_url": "https://github.com/rust-lang/rust/commit/0c483f69db979f9dc88f96493ea4b21d946d845d"}], "stats": {"total": 104, "additions": 75, "deletions": 29}, "files": [{"sha": "0b1ab4dfa5a0c74034c6a17198398a25e4551b80", "filename": "clippy_lints/src/identity_op.rs", "status": "modified", "additions": 27, "deletions": 10, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/a944ccb67745106a434b9708d010a156acda4d21/clippy_lints%2Fsrc%2Fidentity_op.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a944ccb67745106a434b9708d010a156acda4d21/clippy_lints%2Fsrc%2Fidentity_op.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fidentity_op.rs?ref=a944ccb67745106a434b9708d010a156acda4d21", "patch": "@@ -5,7 +5,7 @@ use rustc_middle::ty;\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n use rustc_span::source_map::Span;\n \n-use clippy_utils::consts::{constant_simple, Constant};\n+use clippy_utils::consts::{constant_full_int, constant_simple, Constant, FullInt};\n use clippy_utils::diagnostics::span_lint;\n use clippy_utils::{clip, unsext};\n \n@@ -54,6 +54,7 @@ impl<'tcx> LateLintPass<'tcx> for IdentityOp {\n                     check(cx, left, -1, e.span, right.span);\n                     check(cx, right, -1, e.span, left.span);\n                 },\n+                BinOpKind::Rem => check_modulo(cx, left, right, e.span, left.span),\n                 _ => (),\n             }\n         }\n@@ -70,6 +71,18 @@ fn is_allowed(cx: &LateContext<'_>, cmp: BinOp, left: &Expr<'_>, right: &Expr<'_\n             && constant_simple(cx, cx.typeck_results(), left) == Some(Constant::Int(1)))\n }\n \n+fn check_modulo(cx: &LateContext<'_>, left: &Expr<'_>, right: &Expr<'_>, span: Span, arg: Span) {\n+    let lhs_const = constant_full_int(cx, cx.typeck_results(), left);\n+    let rhs_const = constant_full_int(cx, cx.typeck_results(), right);\n+    if match (lhs_const, rhs_const) {\n+        (Some(FullInt::S(lv)), Some(FullInt::S(rv))) => lv.abs() < rv,\n+        (Some(FullInt::U(lv)), Some(FullInt::U(rv))) => lv < rv,\n+        _ => return,\n+    } {\n+        span_ineffective_operation(cx, span, arg);\n+    }\n+}\n+\n fn check(cx: &LateContext<'_>, e: &Expr<'_>, m: i8, span: Span, arg: Span) {\n     if let Some(Constant::Int(v)) = constant_simple(cx, cx.typeck_results(), e).map(Constant::peel_refs) {\n         let check = match *cx.typeck_results().expr_ty(e).peel_refs().kind() {\n@@ -83,15 +96,19 @@ fn check(cx: &LateContext<'_>, e: &Expr<'_>, m: i8, span: Span, arg: Span) {\n             1 => v == 1,\n             _ => unreachable!(),\n         } {\n-            span_lint(\n-                cx,\n-                IDENTITY_OP,\n-                span,\n-                &format!(\n-                    \"the operation is ineffective. Consider reducing it to `{}`\",\n-                    snippet(cx, arg, \"..\")\n-                ),\n-            );\n+            span_ineffective_operation(cx, span, arg);\n         }\n     }\n }\n+\n+fn span_ineffective_operation(cx: &LateContext<'_>, span: Span, arg: Span) {\n+    span_lint(\n+        cx,\n+        IDENTITY_OP,\n+        span,\n+        &format!(\n+            \"the operation is ineffective. Consider reducing it to `{}`\",\n+            snippet(cx, arg, \"..\")\n+        ),\n+    );\n+}"}, {"sha": "5e120947646a8bb16b930189775f816075451ee3", "filename": "tests/ui/identity_op.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/a944ccb67745106a434b9708d010a156acda4d21/tests%2Fui%2Fidentity_op.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a944ccb67745106a434b9708d010a156acda4d21/tests%2Fui%2Fidentity_op.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fidentity_op.rs?ref=a944ccb67745106a434b9708d010a156acda4d21", "patch": "@@ -66,4 +66,10 @@ fn main() {\n     let b = a << 0; // no error: non-integer\n \n     1 * Meter; // no error: non-integer\n+\n+    2 % 3;\n+    -2 % 3;\n+    x + 1 % 3;\n+    (x + 1) % 3; // no error\n+    4 % 3; // no error\n }"}, {"sha": "cb9757d1158dde8883434f97ca6e6f07436851c2", "filename": "tests/ui/identity_op.stderr", "status": "modified", "additions": 19, "deletions": 1, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/a944ccb67745106a434b9708d010a156acda4d21/tests%2Fui%2Fidentity_op.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a944ccb67745106a434b9708d010a156acda4d21/tests%2Fui%2Fidentity_op.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fidentity_op.stderr?ref=a944ccb67745106a434b9708d010a156acda4d21", "patch": "@@ -78,5 +78,23 @@ error: the operation is ineffective. Consider reducing it to `x`\n LL |     x >> &0;\n    |     ^^^^^^^\n \n-error: aborting due to 13 previous errors\n+error: the operation is ineffective. Consider reducing it to `2`\n+  --> $DIR/identity_op.rs:70:5\n+   |\n+LL |     2 % 3;\n+   |     ^^^^^\n+\n+error: the operation is ineffective. Consider reducing it to `-2`\n+  --> $DIR/identity_op.rs:71:5\n+   |\n+LL |     -2 % 3;\n+   |     ^^^^^^\n+\n+error: the operation is ineffective. Consider reducing it to `1`\n+  --> $DIR/identity_op.rs:72:9\n+   |\n+LL |     x + 1 % 3;\n+   |         ^^^^^\n+\n+error: aborting due to 16 previous errors\n "}, {"sha": "3ebe46bc5be7c5b8b4108f4477b70663a5734b38", "filename": "tests/ui/modulo_arithmetic_integral_const.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/a944ccb67745106a434b9708d010a156acda4d21/tests%2Fui%2Fmodulo_arithmetic_integral_const.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a944ccb67745106a434b9708d010a156acda4d21/tests%2Fui%2Fmodulo_arithmetic_integral_const.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmodulo_arithmetic_integral_const.rs?ref=a944ccb67745106a434b9708d010a156acda4d21", "patch": "@@ -1,5 +1,10 @@\n #![warn(clippy::modulo_arithmetic)]\n-#![allow(clippy::no_effect, clippy::unnecessary_operation, clippy::modulo_one)]\n+#![allow(\n+    clippy::no_effect,\n+    clippy::unnecessary_operation,\n+    clippy::modulo_one,\n+    clippy::identity_op\n+)]\n \n fn main() {\n     // Lint when both sides are const and of the opposite sign"}, {"sha": "11b5f77461ba2e93b94779543f77b8770ffbf440", "filename": "tests/ui/modulo_arithmetic_integral_const.stderr", "status": "modified", "additions": 17, "deletions": 17, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/a944ccb67745106a434b9708d010a156acda4d21/tests%2Fui%2Fmodulo_arithmetic_integral_const.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a944ccb67745106a434b9708d010a156acda4d21/tests%2Fui%2Fmodulo_arithmetic_integral_const.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmodulo_arithmetic_integral_const.stderr?ref=a944ccb67745106a434b9708d010a156acda4d21", "patch": "@@ -1,5 +1,5 @@\n error: you are using modulo operator on constants with different signs: `-1 % 2`\n-  --> $DIR/modulo_arithmetic_integral_const.rs:6:5\n+  --> $DIR/modulo_arithmetic_integral_const.rs:11:5\n    |\n LL |     -1 % 2;\n    |     ^^^^^^\n@@ -9,7 +9,7 @@ LL |     -1 % 2;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on constants with different signs: `1 % -2`\n-  --> $DIR/modulo_arithmetic_integral_const.rs:7:5\n+  --> $DIR/modulo_arithmetic_integral_const.rs:12:5\n    |\n LL |     1 % -2;\n    |     ^^^^^^\n@@ -18,7 +18,7 @@ LL |     1 % -2;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on constants with different signs: `-1 % 3`\n-  --> $DIR/modulo_arithmetic_integral_const.rs:8:5\n+  --> $DIR/modulo_arithmetic_integral_const.rs:13:5\n    |\n LL |     (1 - 2) % (1 + 2);\n    |     ^^^^^^^^^^^^^^^^^\n@@ -27,7 +27,7 @@ LL |     (1 - 2) % (1 + 2);\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on constants with different signs: `3 % -1`\n-  --> $DIR/modulo_arithmetic_integral_const.rs:9:5\n+  --> $DIR/modulo_arithmetic_integral_const.rs:14:5\n    |\n LL |     (1 + 2) % (1 - 2);\n    |     ^^^^^^^^^^^^^^^^^\n@@ -36,7 +36,7 @@ LL |     (1 + 2) % (1 - 2);\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on constants with different signs: `-35 % 300000`\n-  --> $DIR/modulo_arithmetic_integral_const.rs:10:5\n+  --> $DIR/modulo_arithmetic_integral_const.rs:15:5\n    |\n LL |     35 * (7 - 4 * 2) % (-500 * -600);\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n@@ -45,7 +45,7 @@ LL |     35 * (7 - 4 * 2) % (-500 * -600);\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on constants with different signs: `-1 % 2`\n-  --> $DIR/modulo_arithmetic_integral_const.rs:12:5\n+  --> $DIR/modulo_arithmetic_integral_const.rs:17:5\n    |\n LL |     -1i8 % 2i8;\n    |     ^^^^^^^^^^\n@@ -54,7 +54,7 @@ LL |     -1i8 % 2i8;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on constants with different signs: `1 % -2`\n-  --> $DIR/modulo_arithmetic_integral_const.rs:13:5\n+  --> $DIR/modulo_arithmetic_integral_const.rs:18:5\n    |\n LL |     1i8 % -2i8;\n    |     ^^^^^^^^^^\n@@ -63,7 +63,7 @@ LL |     1i8 % -2i8;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on constants with different signs: `-1 % 2`\n-  --> $DIR/modulo_arithmetic_integral_const.rs:14:5\n+  --> $DIR/modulo_arithmetic_integral_const.rs:19:5\n    |\n LL |     -1i16 % 2i16;\n    |     ^^^^^^^^^^^^\n@@ -72,7 +72,7 @@ LL |     -1i16 % 2i16;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on constants with different signs: `1 % -2`\n-  --> $DIR/modulo_arithmetic_integral_const.rs:15:5\n+  --> $DIR/modulo_arithmetic_integral_const.rs:20:5\n    |\n LL |     1i16 % -2i16;\n    |     ^^^^^^^^^^^^\n@@ -81,7 +81,7 @@ LL |     1i16 % -2i16;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on constants with different signs: `-1 % 2`\n-  --> $DIR/modulo_arithmetic_integral_const.rs:16:5\n+  --> $DIR/modulo_arithmetic_integral_const.rs:21:5\n    |\n LL |     -1i32 % 2i32;\n    |     ^^^^^^^^^^^^\n@@ -90,7 +90,7 @@ LL |     -1i32 % 2i32;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on constants with different signs: `1 % -2`\n-  --> $DIR/modulo_arithmetic_integral_const.rs:17:5\n+  --> $DIR/modulo_arithmetic_integral_const.rs:22:5\n    |\n LL |     1i32 % -2i32;\n    |     ^^^^^^^^^^^^\n@@ -99,7 +99,7 @@ LL |     1i32 % -2i32;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on constants with different signs: `-1 % 2`\n-  --> $DIR/modulo_arithmetic_integral_const.rs:18:5\n+  --> $DIR/modulo_arithmetic_integral_const.rs:23:5\n    |\n LL |     -1i64 % 2i64;\n    |     ^^^^^^^^^^^^\n@@ -108,7 +108,7 @@ LL |     -1i64 % 2i64;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on constants with different signs: `1 % -2`\n-  --> $DIR/modulo_arithmetic_integral_const.rs:19:5\n+  --> $DIR/modulo_arithmetic_integral_const.rs:24:5\n    |\n LL |     1i64 % -2i64;\n    |     ^^^^^^^^^^^^\n@@ -117,7 +117,7 @@ LL |     1i64 % -2i64;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on constants with different signs: `-1 % 2`\n-  --> $DIR/modulo_arithmetic_integral_const.rs:20:5\n+  --> $DIR/modulo_arithmetic_integral_const.rs:25:5\n    |\n LL |     -1i128 % 2i128;\n    |     ^^^^^^^^^^^^^^\n@@ -126,7 +126,7 @@ LL |     -1i128 % 2i128;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on constants with different signs: `1 % -2`\n-  --> $DIR/modulo_arithmetic_integral_const.rs:21:5\n+  --> $DIR/modulo_arithmetic_integral_const.rs:26:5\n    |\n LL |     1i128 % -2i128;\n    |     ^^^^^^^^^^^^^^\n@@ -135,7 +135,7 @@ LL |     1i128 % -2i128;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on constants with different signs: `-1 % 2`\n-  --> $DIR/modulo_arithmetic_integral_const.rs:22:5\n+  --> $DIR/modulo_arithmetic_integral_const.rs:27:5\n    |\n LL |     -1isize % 2isize;\n    |     ^^^^^^^^^^^^^^^^\n@@ -144,7 +144,7 @@ LL |     -1isize % 2isize;\n    = note: or consider using `rem_euclid` or similar function\n \n error: you are using modulo operator on constants with different signs: `1 % -2`\n-  --> $DIR/modulo_arithmetic_integral_const.rs:23:5\n+  --> $DIR/modulo_arithmetic_integral_const.rs:28:5\n    |\n LL |     1isize % -2isize;\n    |     ^^^^^^^^^^^^^^^^"}]}