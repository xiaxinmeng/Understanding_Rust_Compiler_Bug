{"sha": "62f64af43051fde2b9e643a0f5f06cf88e602a59", "node_id": "MDY6Q29tbWl0NzI0NzEyOjYyZjY0YWY0MzA1MWZkZTJiOWU2NDNhMGY1ZjA2Y2Y4OGU2MDJhNTk=", "commit": {"author": {"name": "bjorn3", "email": "bjorn3@users.noreply.github.com", "date": "2021-03-29T09:39:13Z"}, "committer": {"name": "bjorn3", "email": "bjorn3@users.noreply.github.com", "date": "2021-05-07T16:48:58Z"}, "message": "Use the object crate for metadata reading", "tree": {"sha": "9b535ec921d401f72bd98593f0ac16e5845b74e4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9b535ec921d401f72bd98593f0ac16e5845b74e4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/62f64af43051fde2b9e643a0f5f06cf88e602a59", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/62f64af43051fde2b9e643a0f5f06cf88e602a59", "html_url": "https://github.com/rust-lang/rust/commit/62f64af43051fde2b9e643a0f5f06cf88e602a59", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/62f64af43051fde2b9e643a0f5f06cf88e602a59/comments", "author": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "91dc6967fe5ebb8ff773a168e549482c18bb92d8", "url": "https://api.github.com/repos/rust-lang/rust/commits/91dc6967fe5ebb8ff773a168e549482c18bb92d8", "html_url": "https://github.com/rust-lang/rust/commit/91dc6967fe5ebb8ff773a168e549482c18bb92d8"}], "stats": {"total": 68, "additions": 2, "deletions": 66}, "files": [{"sha": "1ade7c77d123a317fe6aed2ca506c533db3111ad", "filename": "src/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/62f64af43051fde2b9e643a0f5f06cf88e602a59/src%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/62f64af43051fde2b9e643a0f5f06cf88e602a59/src%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flib.rs?ref=62f64af43051fde2b9e643a0f5f06cf88e602a59", "patch": "@@ -165,7 +165,7 @@ impl CodegenBackend for CraneliftCodegenBackend {\n     }\n \n     fn metadata_loader(&self) -> Box<dyn MetadataLoader + Sync> {\n-        Box::new(crate::metadata::CraneliftMetadataLoader)\n+        Box::new(rustc_codegen_ssa::back::metadata::DefaultMetadataLoader)\n     }\n \n     fn provide(&self, _providers: &mut Providers) {}"}, {"sha": "ab238244d68d504c983bfff1ffea366fd6eb7c5f", "filename": "src/metadata.rs", "status": "modified", "additions": 1, "deletions": 65, "changes": 66, "blob_url": "https://github.com/rust-lang/rust/blob/62f64af43051fde2b9e643a0f5f06cf88e602a59/src%2Fmetadata.rs", "raw_url": "https://github.com/rust-lang/rust/raw/62f64af43051fde2b9e643a0f5f06cf88e602a59/src%2Fmetadata.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fmetadata.rs?ref=62f64af43051fde2b9e643a0f5f06cf88e602a59", "patch": "@@ -1,73 +1,9 @@\n-//! Reading and writing of the rustc metadata for rlibs and dylibs\n+//! Writing of the rustc metadata for dylibs\n \n-use std::fs::File;\n-use std::path::Path;\n-\n-use rustc_codegen_ssa::METADATA_FILENAME;\n-use rustc_data_structures::memmap::Mmap;\n-use rustc_data_structures::owning_ref::OwningRef;\n-use rustc_data_structures::rustc_erase_owner;\n-use rustc_data_structures::sync::MetadataRef;\n-use rustc_middle::middle::cstore::MetadataLoader;\n use rustc_middle::ty::TyCtxt;\n-use rustc_target::spec::Target;\n \n use crate::backend::WriteMetadata;\n \n-/// The metadata loader used by cg_clif.\n-///\n-/// The metadata is stored in the same format as cg_llvm.\n-///\n-/// # Metadata location\n-///\n-/// <dl>\n-/// <dt>rlib</dt>\n-/// <dd>The metadata can be found in the `lib.rmeta` file inside of the ar archive.</dd>\n-/// <dt>dylib</dt>\n-/// <dd>The metadata can be found in the `.rustc` section of the shared library.</dd>\n-/// </dl>\n-pub(crate) struct CraneliftMetadataLoader;\n-\n-fn load_metadata_with(\n-    path: &Path,\n-    f: impl for<'a> FnOnce(&'a [u8]) -> Result<&'a [u8], String>,\n-) -> Result<MetadataRef, String> {\n-    let file = File::open(path).map_err(|e| format!(\"{:?}\", e))?;\n-    let data = unsafe { Mmap::map(file) }.map_err(|e| format!(\"{:?}\", e))?;\n-    let metadata = OwningRef::new(data).try_map(f)?;\n-    return Ok(rustc_erase_owner!(metadata.map_owner_box()));\n-}\n-\n-impl MetadataLoader for CraneliftMetadataLoader {\n-    fn get_rlib_metadata(&self, _target: &Target, path: &Path) -> Result<MetadataRef, String> {\n-        load_metadata_with(path, |data| {\n-            let archive = object::read::archive::ArchiveFile::parse(&*data)\n-                .map_err(|e| format!(\"{:?}\", e))?;\n-\n-            for entry_result in archive.members() {\n-                let entry = entry_result.map_err(|e| format!(\"{:?}\", e))?;\n-                if entry.name() == METADATA_FILENAME.as_bytes() {\n-                    return Ok(entry.data());\n-                }\n-            }\n-\n-            Err(\"couldn't find metadata entry\".to_string())\n-        })\n-    }\n-\n-    fn get_dylib_metadata(&self, _target: &Target, path: &Path) -> Result<MetadataRef, String> {\n-        use object::{Object, ObjectSection};\n-\n-        load_metadata_with(path, |data| {\n-            let file = object::File::parse(&data).map_err(|e| format!(\"parse: {:?}\", e))?;\n-            file.section_by_name(\".rustc\")\n-                .ok_or(\"no .rustc section\")?\n-                .data()\n-                .map_err(|e| format!(\"failed to read .rustc section: {:?}\", e))\n-        })\n-    }\n-}\n-\n // Adapted from https://github.com/rust-lang/rust/blob/da573206f87b5510de4b0ee1a9c044127e409bd3/src/librustc_codegen_llvm/base.rs#L47-L112\n pub(crate) fn write_metadata<O: WriteMetadata>(tcx: TyCtxt<'_>, object: &mut O) {\n     use snap::write::FrameEncoder;"}]}