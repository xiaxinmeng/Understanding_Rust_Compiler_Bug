{"sha": "1e18b8a269f58b15da39a1ffa9f4c29b2a55bae8", "node_id": "C_kwDOAAsO6NoAKDFlMThiOGEyNjlmNThiMTVkYTM5YTFmZmE5ZjRjMjliMmE1NWJhZTg", "commit": {"author": {"name": "ThibsG", "email": "thibsg@pm.me", "date": "2021-10-09T13:54:16Z"}, "committer": {"name": "ThibsG", "email": "thibsg@pm.me", "date": "2021-10-09T13:54:16Z"}, "message": "Fix FP in external macros for `mut_mut` lint", "tree": {"sha": "476178356fe1b7c5d01ddc128bf3403409603996", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/476178356fe1b7c5d01ddc128bf3403409603996"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1e18b8a269f58b15da39a1ffa9f4c29b2a55bae8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1e18b8a269f58b15da39a1ffa9f4c29b2a55bae8", "html_url": "https://github.com/rust-lang/rust/commit/1e18b8a269f58b15da39a1ffa9f4c29b2a55bae8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1e18b8a269f58b15da39a1ffa9f4c29b2a55bae8/comments", "author": {"login": "ThibsG", "id": 12683889, "node_id": "MDQ6VXNlcjEyNjgzODg5", "avatar_url": "https://avatars.githubusercontent.com/u/12683889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ThibsG", "html_url": "https://github.com/ThibsG", "followers_url": "https://api.github.com/users/ThibsG/followers", "following_url": "https://api.github.com/users/ThibsG/following{/other_user}", "gists_url": "https://api.github.com/users/ThibsG/gists{/gist_id}", "starred_url": "https://api.github.com/users/ThibsG/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ThibsG/subscriptions", "organizations_url": "https://api.github.com/users/ThibsG/orgs", "repos_url": "https://api.github.com/users/ThibsG/repos", "events_url": "https://api.github.com/users/ThibsG/events{/privacy}", "received_events_url": "https://api.github.com/users/ThibsG/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ThibsG", "id": 12683889, "node_id": "MDQ6VXNlcjEyNjgzODg5", "avatar_url": "https://avatars.githubusercontent.com/u/12683889?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ThibsG", "html_url": "https://github.com/ThibsG", "followers_url": "https://api.github.com/users/ThibsG/followers", "following_url": "https://api.github.com/users/ThibsG/following{/other_user}", "gists_url": "https://api.github.com/users/ThibsG/gists{/gist_id}", "starred_url": "https://api.github.com/users/ThibsG/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ThibsG/subscriptions", "organizations_url": "https://api.github.com/users/ThibsG/orgs", "repos_url": "https://api.github.com/users/ThibsG/repos", "events_url": "https://api.github.com/users/ThibsG/events{/privacy}", "received_events_url": "https://api.github.com/users/ThibsG/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "22144c02c2d790c2e3b74dc0363000511284f6d8", "url": "https://api.github.com/repos/rust-lang/rust/commits/22144c02c2d790c2e3b74dc0363000511284f6d8", "html_url": "https://github.com/rust-lang/rust/commit/22144c02c2d790c2e3b74dc0363000511284f6d8"}], "stats": {"total": 39, "additions": 30, "deletions": 9}, "files": [{"sha": "7c4cac29ba8e8c699b7a5cfdeea61678f0a477ba", "filename": "clippy_lints/src/mut_mut.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/1e18b8a269f58b15da39a1ffa9f4c29b2a55bae8/clippy_lints%2Fsrc%2Fmut_mut.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e18b8a269f58b15da39a1ffa9f4c29b2a55bae8/clippy_lints%2Fsrc%2Fmut_mut.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmut_mut.rs?ref=1e18b8a269f58b15da39a1ffa9f4c29b2a55bae8", "patch": "@@ -82,6 +82,10 @@ impl<'a, 'tcx> intravisit::Visitor<'tcx> for MutVisitor<'a, 'tcx> {\n     }\n \n     fn visit_ty(&mut self, ty: &'tcx hir::Ty<'_>) {\n+        if in_external_macro(self.cx.sess(), ty.span) {\n+            return;\n+        }\n+\n         if let hir::TyKind::Rptr(\n             _,\n             hir::MutTy {"}, {"sha": "0251fada9e85a6ea8aa5dbfc954292835fab394c", "filename": "tests/ui/auxiliary/macro_rules.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/1e18b8a269f58b15da39a1ffa9f4c29b2a55bae8/tests%2Fui%2Fauxiliary%2Fmacro_rules.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e18b8a269f58b15da39a1ffa9f4c29b2a55bae8/tests%2Fui%2Fauxiliary%2Fmacro_rules.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fauxiliary%2Fmacro_rules.rs?ref=1e18b8a269f58b15da39a1ffa9f4c29b2a55bae8", "patch": "@@ -113,3 +113,10 @@ macro_rules! default_numeric_fallback {\n         let x = 22;\n     };\n }\n+\n+#[macro_export]\n+macro_rules! mut_mut {\n+    () => {\n+        let mut_mut_ty: &mut &mut u32 = &mut &mut 1u32;\n+    };\n+}"}, {"sha": "be854d94183329d547df961f1690f32d10d01139", "filename": "tests/ui/mut_mut.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/1e18b8a269f58b15da39a1ffa9f4c29b2a55bae8/tests%2Fui%2Fmut_mut.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e18b8a269f58b15da39a1ffa9f4c29b2a55bae8/tests%2Fui%2Fmut_mut.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmut_mut.rs?ref=1e18b8a269f58b15da39a1ffa9f4c29b2a55bae8", "patch": "@@ -1,6 +1,11 @@\n+// aux-build:macro_rules.rs\n+\n #![allow(unused, clippy::no_effect, clippy::unnecessary_operation)]\n #![warn(clippy::mut_mut)]\n \n+#[macro_use]\n+extern crate macro_rules;\n+\n fn fun(x: &mut &mut u32) -> bool {\n     **x > 0\n }\n@@ -47,3 +52,8 @@ fn issue939() {\n         println!(\":{}\", arg);\n     }\n }\n+\n+fn issue6922() {\n+    // do not lint from an external macro\n+    mut_mut!();\n+}"}, {"sha": "6820a85aa54337f2cad40936ed7d0f6bad95358b", "filename": "tests/ui/mut_mut.stderr", "status": "modified", "additions": 9, "deletions": 9, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/1e18b8a269f58b15da39a1ffa9f4c29b2a55bae8/tests%2Fui%2Fmut_mut.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/1e18b8a269f58b15da39a1ffa9f4c29b2a55bae8/tests%2Fui%2Fmut_mut.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmut_mut.stderr?ref=1e18b8a269f58b15da39a1ffa9f4c29b2a55bae8", "patch": "@@ -1,19 +1,19 @@\n error: generally you want to avoid `&mut &mut _` if possible\n-  --> $DIR/mut_mut.rs:4:11\n+  --> $DIR/mut_mut.rs:9:11\n    |\n LL | fn fun(x: &mut &mut u32) -> bool {\n    |           ^^^^^^^^^^^^^\n    |\n    = note: `-D clippy::mut-mut` implied by `-D warnings`\n \n error: generally you want to avoid `&mut &mut _` if possible\n-  --> $DIR/mut_mut.rs:20:17\n+  --> $DIR/mut_mut.rs:25:17\n    |\n LL |     let mut x = &mut &mut 1u32;\n    |                 ^^^^^^^^^^^^^^\n \n error: generally you want to avoid `&mut &mut _` if possible\n-  --> $DIR/mut_mut.rs:14:9\n+  --> $DIR/mut_mut.rs:19:9\n    |\n LL |         &mut $p\n    |         ^^^^^^^\n@@ -24,37 +24,37 @@ LL |     let mut z = mut_ptr!(&mut 3u32);\n    = note: this error originates in the macro `mut_ptr` (in Nightly builds, run with -Z macro-backtrace for more info)\n \n error: this expression mutably borrows a mutable reference. Consider reborrowing\n-  --> $DIR/mut_mut.rs:22:21\n+  --> $DIR/mut_mut.rs:27:21\n    |\n LL |         let mut y = &mut x;\n    |                     ^^^^^^\n \n error: generally you want to avoid `&mut &mut _` if possible\n-  --> $DIR/mut_mut.rs:26:32\n+  --> $DIR/mut_mut.rs:31:32\n    |\n LL |         let y: &mut &mut u32 = &mut &mut 2;\n    |                                ^^^^^^^^^^^\n \n error: generally you want to avoid `&mut &mut _` if possible\n-  --> $DIR/mut_mut.rs:26:16\n+  --> $DIR/mut_mut.rs:31:16\n    |\n LL |         let y: &mut &mut u32 = &mut &mut 2;\n    |                ^^^^^^^^^^^^^\n \n error: generally you want to avoid `&mut &mut _` if possible\n-  --> $DIR/mut_mut.rs:31:37\n+  --> $DIR/mut_mut.rs:36:37\n    |\n LL |         let y: &mut &mut &mut u32 = &mut &mut &mut 2;\n    |                                     ^^^^^^^^^^^^^^^^\n \n error: generally you want to avoid `&mut &mut _` if possible\n-  --> $DIR/mut_mut.rs:31:16\n+  --> $DIR/mut_mut.rs:36:16\n    |\n LL |         let y: &mut &mut &mut u32 = &mut &mut &mut 2;\n    |                ^^^^^^^^^^^^^^^^^^\n \n error: generally you want to avoid `&mut &mut _` if possible\n-  --> $DIR/mut_mut.rs:31:21\n+  --> $DIR/mut_mut.rs:36:21\n    |\n LL |         let y: &mut &mut &mut u32 = &mut &mut &mut 2;\n    |                     ^^^^^^^^^^^^^"}]}