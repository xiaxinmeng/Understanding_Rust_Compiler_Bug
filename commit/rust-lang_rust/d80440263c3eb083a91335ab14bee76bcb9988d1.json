{"sha": "d80440263c3eb083a91335ab14bee76bcb9988d1", "node_id": "C_kwDOAAsO6NoAKGQ4MDQ0MDI2M2MzZWIwODNhOTEzMzVhYjE0YmVlNzZiY2I5OTg4ZDE", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2023-06-11T00:19:56Z"}, "committer": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2023-06-11T00:19:56Z"}, "message": "Don't suggest boxing an empty if/else arm", "tree": {"sha": "5d53d8120775a6cbdd4339e29911504f9b220779", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5d53d8120775a6cbdd4339e29911504f9b220779"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d80440263c3eb083a91335ab14bee76bcb9988d1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d80440263c3eb083a91335ab14bee76bcb9988d1", "html_url": "https://github.com/rust-lang/rust/commit/d80440263c3eb083a91335ab14bee76bcb9988d1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d80440263c3eb083a91335ab14bee76bcb9988d1/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5dfc17f045aca52ad37a768d0f6704ea5b4fd4dd", "url": "https://api.github.com/repos/rust-lang/rust/commits/5dfc17f045aca52ad37a768d0f6704ea5b4fd4dd", "html_url": "https://github.com/rust-lang/rust/commit/5dfc17f045aca52ad37a768d0f6704ea5b4fd4dd"}], "stats": {"total": 45, "additions": 44, "deletions": 1}, "files": [{"sha": "3e4812e7ca995d4553089c2d316e1e9952c48519", "filename": "compiler/rustc_infer/src/infer/error_reporting/mod.rs", "status": "modified", "additions": 19, "deletions": 1, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/d80440263c3eb083a91335ab14bee76bcb9988d1/compiler%2Frustc_infer%2Fsrc%2Finfer%2Ferror_reporting%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d80440263c3eb083a91335ab14bee76bcb9988d1/compiler%2Frustc_infer%2Fsrc%2Finfer%2Ferror_reporting%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_infer%2Fsrc%2Finfer%2Ferror_reporting%2Fmod.rs?ref=d80440263c3eb083a91335ab14bee76bcb9988d1", "patch": "@@ -847,7 +847,25 @@ impl<'tcx> TypeErrCtxt<'_, 'tcx> {\n                 ) {\n                     err.subdiagnostic(subdiag);\n                 }\n-                if let Some(ret_sp) = opt_suggest_box_span {\n+                // don't suggest wrapping either blocks in `if .. {} else {}`\n+                let is_empty_arm = |id| {\n+                    let hir::Node::Block(blk) = self.tcx.hir().get(id)\n+                    else {\n+                        return false;\n+                    };\n+                    if blk.expr.is_some() || !blk.stmts.is_empty() {\n+                        return false;\n+                    }\n+                    let Some((_, hir::Node::Expr(expr))) = self.tcx.hir().parent_iter(id).nth(1)\n+                    else {\n+                        return false;\n+                    };\n+                    matches!(expr.kind, hir::ExprKind::If(..))\n+                };\n+                if let Some(ret_sp) = opt_suggest_box_span\n+                    && !is_empty_arm(then_id)\n+                    && !is_empty_arm(else_id)\n+                {\n                     self.suggest_boxing_for_return_impl_trait(\n                         err,\n                         ret_sp,"}, {"sha": "befd768b1818a6322d9b170107a889d2319b89ec", "filename": "tests/ui/impl-trait/dont-suggest-box-on-empty-else-arm.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/d80440263c3eb083a91335ab14bee76bcb9988d1/tests%2Fui%2Fimpl-trait%2Fdont-suggest-box-on-empty-else-arm.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d80440263c3eb083a91335ab14bee76bcb9988d1/tests%2Fui%2Fimpl-trait%2Fdont-suggest-box-on-empty-else-arm.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fimpl-trait%2Fdont-suggest-box-on-empty-else-arm.rs?ref=d80440263c3eb083a91335ab14bee76bcb9988d1", "patch": "@@ -0,0 +1,9 @@\n+fn test() -> impl std::fmt::Debug {\n+    if true {\n+        \"boo2\"\n+    } else {\n+        //~^ ERROR `if` and `else` have incompatible types\n+    }\n+}\n+\n+fn main() {}"}, {"sha": "9b63911da7aa35489c3557fa058dab8c79cb6da7", "filename": "tests/ui/impl-trait/dont-suggest-box-on-empty-else-arm.stderr", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/d80440263c3eb083a91335ab14bee76bcb9988d1/tests%2Fui%2Fimpl-trait%2Fdont-suggest-box-on-empty-else-arm.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d80440263c3eb083a91335ab14bee76bcb9988d1/tests%2Fui%2Fimpl-trait%2Fdont-suggest-box-on-empty-else-arm.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fimpl-trait%2Fdont-suggest-box-on-empty-else-arm.stderr?ref=d80440263c3eb083a91335ab14bee76bcb9988d1", "patch": "@@ -0,0 +1,16 @@\n+error[E0308]: `if` and `else` have incompatible types\n+  --> $DIR/dont-suggest-box-on-empty-else-arm.rs:4:12\n+   |\n+LL |       if true {\n+   |       ------- `if` and `else` have incompatible types\n+LL |           \"boo2\"\n+   |           ------ expected because of this\n+LL |       } else {\n+   |  ____________^\n+LL | |\n+LL | |     }\n+   | |_____^ expected `&str`, found `()`\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0308`."}]}