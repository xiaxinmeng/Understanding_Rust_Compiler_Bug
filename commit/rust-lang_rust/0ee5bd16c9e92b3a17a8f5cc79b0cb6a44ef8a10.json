{"sha": "0ee5bd16c9e92b3a17a8f5cc79b0cb6a44ef8a10", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBlZTViZDE2YzllOTJiM2ExN2E4ZjVjYzc5YjBjYjZhNDRlZjhhMTA=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-05-30T06:51:25Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-05-30T07:06:02Z"}, "message": "cancel salsa's validation\n\nThis small fix should improve rust-analyzer resopnsivness for\nreal-time operations like onEnter handling.\n\nTurns out, salsa's validation can take hundreds of milliseconds, and,\nin case no changes were made, it won't be triggering any queries.\n\nBecause we check for cancellation in queries, that means that\nvalidation is not cancellable!\n\nWhat this PR does is injecting check_canceled checks into validation,\nby using salsa's event API, which wasn't meant to be used like this,\nbut, hey, it works!\n\nHere's the onEnter handling before and after this change:\n\nhttps://youtu.be/7-ffPzgvH7o", "tree": {"sha": "2cb254aa6164b722bdc556bb79f18f71b92e9211", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2cb254aa6164b722bdc556bb79f18f71b92e9211"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0ee5bd16c9e92b3a17a8f5cc79b0cb6a44ef8a10", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0ee5bd16c9e92b3a17a8f5cc79b0cb6a44ef8a10", "html_url": "https://github.com/rust-lang/rust/commit/0ee5bd16c9e92b3a17a8f5cc79b0cb6a44ef8a10", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0ee5bd16c9e92b3a17a8f5cc79b0cb6a44ef8a10/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8c3cd8f121d4306732423d1c8804d54e36bd706a", "url": "https://api.github.com/repos/rust-lang/rust/commits/8c3cd8f121d4306732423d1c8804d54e36bd706a", "html_url": "https://github.com/rust-lang/rust/commit/8c3cd8f121d4306732423d1c8804d54e36bd706a"}], "stats": {"total": 5, "additions": 5, "deletions": 0}, "files": [{"sha": "d84a0e7beeea9ad6dbc03597444d598044ce0779", "filename": "crates/ra_ide_api/src/db.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/0ee5bd16c9e92b3a17a8f5cc79b0cb6a44ef8a10/crates%2Fra_ide_api%2Fsrc%2Fdb.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0ee5bd16c9e92b3a17a8f5cc79b0cb6a44ef8a10/crates%2Fra_ide_api%2Fsrc%2Fdb.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Fdb.rs?ref=0ee5bd16c9e92b3a17a8f5cc79b0cb6a44ef8a10", "patch": "@@ -31,6 +31,11 @@ impl salsa::Database for RootDatabase {\n     fn on_propagated_panic(&self) -> ! {\n         Canceled::throw()\n     }\n+    fn salsa_event(&self, event: impl Fn() -> salsa::Event<RootDatabase>) {\n+        if let salsa::EventKind::DidValidateMemoizedValue { .. } = event().kind {\n+            self.check_canceled();\n+        }\n+    }\n }\n \n impl Default for RootDatabase {"}]}