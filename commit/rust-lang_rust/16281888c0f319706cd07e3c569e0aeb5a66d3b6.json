{"sha": "16281888c0f319706cd07e3c569e0aeb5a66d3b6", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE2MjgxODg4YzBmMzE5NzA2Y2QwN2UzYzU2OWUwYWViNWE2NmQzYjY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-07-01T06:30:51Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2016-07-01T06:30:51Z"}, "message": "Auto merge of #34563 - alexcrichton:robust-mk, r=brson\n\nmk: Don't consider LLVM done until it's done\n\nCurrently if an LLVM build is interrupted *after* it creates the llvm-config\nbinary but before it's done it puts us in an inconsistent state where we think\nLLVM is compiled but it's not actually. This tweaks our logic to only consider\nLLVM done building once it's actually done building.\n\nThis should hopefully alleviate problems on the bots where if we interrupt at\nthe wrong time it doesn't corrupt the build directory.", "tree": {"sha": "cd893edfc0ac92598797266e8b98ba72b1aa2b42", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cd893edfc0ac92598797266e8b98ba72b1aa2b42"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/16281888c0f319706cd07e3c569e0aeb5a66d3b6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/16281888c0f319706cd07e3c569e0aeb5a66d3b6", "html_url": "https://github.com/rust-lang/rust/commit/16281888c0f319706cd07e3c569e0aeb5a66d3b6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/16281888c0f319706cd07e3c569e0aeb5a66d3b6/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "375fa6ef371a0ae248968d363226101ef741127e", "url": "https://api.github.com/repos/rust-lang/rust/commits/375fa6ef371a0ae248968d363226101ef741127e", "html_url": "https://github.com/rust-lang/rust/commit/375fa6ef371a0ae248968d363226101ef741127e"}, {"sha": "9e2bd921ea22a31ef133222a1cecb6fb991ae87b", "url": "https://api.github.com/repos/rust-lang/rust/commits/9e2bd921ea22a31ef133222a1cecb6fb991ae87b", "html_url": "https://github.com/rust-lang/rust/commit/9e2bd921ea22a31ef133222a1cecb6fb991ae87b"}], "stats": {"total": 17, "additions": 11, "deletions": 6}, "files": [{"sha": "2298565221072acf3e36dc9a4ff148dc16a40379", "filename": "mk/llvm.mk", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/16281888c0f319706cd07e3c569e0aeb5a66d3b6/mk%2Fllvm.mk", "raw_url": "https://github.com/rust-lang/rust/raw/16281888c0f319706cd07e3c569e0aeb5a66d3b6/mk%2Fllvm.mk", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/mk%2Fllvm.mk?ref=16281888c0f319706cd07e3c569e0aeb5a66d3b6", "patch": "@@ -37,16 +37,19 @@ endif\n ifeq ($(CFG_LLVM_ROOT),)\n \n LLVM_STAMP_$(1) = $$(CFG_LLVM_BUILD_DIR_$(1))/llvm-auto-clean-stamp\n+LLVM_DONE_$(1) = $$(CFG_LLVM_BUILD_DIR_$(1))/llvm-finished-building\n \n-$$(LLVM_CONFIG_$(1)): $$(LLVM_DEPS_TARGET_$(1)) $$(LLVM_STAMP_$(1))\n+$$(LLVM_CONFIG_$(1)): $$(LLVM_DONE_$(1))\n+\n+$$(LLVM_DONE_$(1)): $$(LLVM_DEPS_TARGET_$(1)) $$(LLVM_STAMP_$(1))\n \t@$$(call E, cmake: llvm)\n ifeq ($$(findstring msvc,$(1)),msvc)\n \t$$(Q)$$(CFG_CMAKE) --build $$(CFG_LLVM_BUILD_DIR_$(1)) \\\n \t\t--config $$(LLVM_BUILD_CONFIG_MODE)\n else\n \t$$(Q)$$(MAKE) -C $$(CFG_LLVM_BUILD_DIR_$(1))\n endif\n-\t$$(Q)touch $$(LLVM_CONFIG_$(1))\n+\t$$(Q)touch $$@\n \n ifeq ($$(findstring msvc,$(1)),msvc)\n clean-llvm$(1):"}, {"sha": "557c9a4be54887eb3c7b83bd7b237c27b5beed1f", "filename": "src/bootstrap/build/native.rs", "status": "modified", "additions": 6, "deletions": 4, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/16281888c0f319706cd07e3c569e0aeb5a66d3b6/src%2Fbootstrap%2Fbuild%2Fnative.rs", "raw_url": "https://github.com/rust-lang/rust/raw/16281888c0f319706cd07e3c569e0aeb5a66d3b6/src%2Fbootstrap%2Fbuild%2Fnative.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuild%2Fnative.rs?ref=16281888c0f319706cd07e3c569e0aeb5a66d3b6", "patch": "@@ -20,14 +20,14 @@\n \n use std::path::Path;\n use std::process::Command;\n-use std::fs;\n+use std::fs::{self, File};\n \n use build_helper::output;\n use cmake;\n use gcc;\n \n use build::Build;\n-use build::util::{exe, staticlib, up_to_date};\n+use build::util::{staticlib, up_to_date};\n \n /// Compile LLVM for `target`.\n pub fn llvm(build: &Build, target: &str) {\n@@ -43,9 +43,9 @@ pub fn llvm(build: &Build, target: &str) {\n     // artifacts are missing) then we keep going, otherwise we bail out.\n     let dst = build.llvm_out(target);\n     let stamp = build.src.join(\"src/rustllvm/llvm-auto-clean-trigger\");\n-    let llvm_config = dst.join(\"bin\").join(exe(\"llvm-config\", target));\n+    let done_stamp = dst.join(\"llvm-finished-building\");\n     build.clear_if_dirty(&dst, &stamp);\n-    if fs::metadata(llvm_config).is_ok() {\n+    if fs::metadata(&done_stamp).is_ok() {\n         return\n     }\n \n@@ -111,6 +111,8 @@ pub fn llvm(build: &Build, target: &str) {\n     //        tools. Figure out how to filter them down and only build the right\n     //        tools and libs on all platforms.\n     cfg.build();\n+\n+    t!(File::create(&done_stamp));\n }\n \n fn check_llvm_version(build: &Build, llvm_config: &Path) {"}]}