{"sha": "51468b65a48e7e897ff7ac080c33efb7b5ce289d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUxNDY4YjY1YTQ4ZTdlODk3ZmY3YWMwODBjMzNlZmI3YjVjZTI4OWQ=", "commit": {"author": {"name": "Michael Sullivan", "email": "sully@msully.net", "date": "2012-06-26T19:47:06Z"}, "committer": {"name": "Michael Sullivan", "email": "sully@msully.net", "date": "2012-06-26T21:05:43Z"}, "message": "Properly cleanup slice literals. Closes #2705.", "tree": {"sha": "d64a9c0a6dd323674bcfa17fa8f9b5686bd270d0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d64a9c0a6dd323674bcfa17fa8f9b5686bd270d0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/51468b65a48e7e897ff7ac080c33efb7b5ce289d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/51468b65a48e7e897ff7ac080c33efb7b5ce289d", "html_url": "https://github.com/rust-lang/rust/commit/51468b65a48e7e897ff7ac080c33efb7b5ce289d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/51468b65a48e7e897ff7ac080c33efb7b5ce289d/comments", "author": {"login": "msullivan", "id": 340349, "node_id": "MDQ6VXNlcjM0MDM0OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/340349?v=4", "gravatar_id": "", "url": "https://api.github.com/users/msullivan", "html_url": "https://github.com/msullivan", "followers_url": "https://api.github.com/users/msullivan/followers", "following_url": "https://api.github.com/users/msullivan/following{/other_user}", "gists_url": "https://api.github.com/users/msullivan/gists{/gist_id}", "starred_url": "https://api.github.com/users/msullivan/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/msullivan/subscriptions", "organizations_url": "https://api.github.com/users/msullivan/orgs", "repos_url": "https://api.github.com/users/msullivan/repos", "events_url": "https://api.github.com/users/msullivan/events{/privacy}", "received_events_url": "https://api.github.com/users/msullivan/received_events", "type": "User", "site_admin": false}, "committer": {"login": "msullivan", "id": 340349, "node_id": "MDQ6VXNlcjM0MDM0OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/340349?v=4", "gravatar_id": "", "url": "https://api.github.com/users/msullivan", "html_url": "https://github.com/msullivan", "followers_url": "https://api.github.com/users/msullivan/followers", "following_url": "https://api.github.com/users/msullivan/following{/other_user}", "gists_url": "https://api.github.com/users/msullivan/gists{/gist_id}", "starred_url": "https://api.github.com/users/msullivan/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/msullivan/subscriptions", "organizations_url": "https://api.github.com/users/msullivan/orgs", "repos_url": "https://api.github.com/users/msullivan/repos", "events_url": "https://api.github.com/users/msullivan/events{/privacy}", "received_events_url": "https://api.github.com/users/msullivan/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f17ca3f73e8e6196a7549ae0df721828a3dfd262", "url": "https://api.github.com/repos/rust-lang/rust/commits/f17ca3f73e8e6196a7549ae0df721828a3dfd262", "html_url": "https://github.com/rust-lang/rust/commit/f17ca3f73e8e6196a7549ae0df721828a3dfd262"}], "stats": {"total": 22, "additions": 22, "deletions": 0}, "files": [{"sha": "58d415ad266ce7ddf89ad8845988f4741d4828b4", "filename": "src/rustc/middle/trans/tvec.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/51468b65a48e7e897ff7ac080c33efb7b5ce289d/src%2Frustc%2Fmiddle%2Ftrans%2Ftvec.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51468b65a48e7e897ff7ac080c33efb7b5ce289d/src%2Frustc%2Fmiddle%2Ftrans%2Ftvec.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustc%2Fmiddle%2Ftrans%2Ftvec.rs?ref=51468b65a48e7e897ff7ac080c33efb7b5ce289d", "patch": "@@ -152,8 +152,15 @@ fn trans_evec(bcx: block, args: [@ast::expr]/~,\n           }\n           ast::vstore_slice(_) {\n             let n = vec::len(args);\n+            // Make a fake type to use for the cleanup\n+            let ty = ty::mk_evec(bcx.tcx(),\n+                                 {ty: unit_ty, mutbl: ast::m_mutbl},\n+                                 ty::vstore_fixed(n));\n+\n             let n = C_uint(ccx, n);\n             let vp = base::arrayalloca(bcx, llunitty, n);\n+            add_clean(bcx, vp, ty);\n+\n             let len = Mul(bcx, n, unit_sz);\n \n             let p = base::alloca(bcx, T_struct([T_ptr(llunitty),"}, {"sha": "e8709d8f1082da9cd96e772eaa30fe9f9f03a680", "filename": "src/test/run-pass/vec-slice-drop.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/51468b65a48e7e897ff7ac080c33efb7b5ce289d/src%2Ftest%2Frun-pass%2Fvec-slice-drop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51468b65a48e7e897ff7ac080c33efb7b5ce289d/src%2Ftest%2Frun-pass%2Fvec-slice-drop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fvec-slice-drop.rs?ref=51468b65a48e7e897ff7ac080c33efb7b5ce289d", "patch": "@@ -0,0 +1,15 @@\n+// Make sure that destructors get run on slice literals\n+class foo {\n+    let x: @mut int;\n+    new(x: @mut int) { self.x = x; }\n+    drop { *self.x += 1; }\n+}\n+\n+fn main() {\n+    let x = @mut 0;\n+    {\n+        let l = [foo(x)]/&;\n+        assert *l[0].x == 0;\n+    }\n+    assert *x == 1;\n+}"}]}