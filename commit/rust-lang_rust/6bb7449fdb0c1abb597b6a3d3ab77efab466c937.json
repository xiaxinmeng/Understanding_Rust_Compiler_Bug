{"sha": "6bb7449fdb0c1abb597b6a3d3ab77efab466c937", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZiYjc0NDlmZGIwYzFhYmI1OTdiNmEzZDNhYjc3ZWZhYjQ2NmM5Mzc=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-10-23T20:19:13Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-10-23T20:19:13Z"}, "message": "Rollup merge of #65518 - estebank:i-want-to-break-free, r=eddyb\n\nAvoid ICE when checking `Destination` of `break` inside a closure\n\nFix #65383, fix #62480. This is a `[regression-from-stable-to-stable]` and a fairly small change to avoid the ICE by properly handling this case.", "tree": {"sha": "6428b7e5f4b51ee8252c77c1c356d366cc16a5b9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6428b7e5f4b51ee8252c77c1c356d366cc16a5b9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6bb7449fdb0c1abb597b6a3d3ab77efab466c937", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJdsLXBCRBK7hj4Ov3rIwAAdHIIADE7L2H9UzIMO2dJD1/BmykU\nhz0r9zQfvzHXnC9biVTTBNN8bubPkMew/nB3syki8MqWpCoFfn5NjU7XTVeWHQP7\nHmV0ia8J78X/nC5ZtYcuLvpCW+WtlGrO+eNqTBdejRq1epouF8gnl0Rj3XwqCaPA\n2ZXra+NTKZ+oihSREgYhF4FkaSWAY4t4TWMdfkpj1Cr/Rgr41XvYGTyqQlJUXiyz\nnxhlam0Ksaq/EnjaxQo+tigB1dSRfDC6cQGY/9k/KAbVxqezzNr34Bj8+53EMhgP\nGqLxj1OYXDLyStYgR7J8ENvtxLWdIi3qpAqPXl4GuLunF18XPWlQQInh6D3DxCg=\n=lLTc\n-----END PGP SIGNATURE-----\n", "payload": "tree 6428b7e5f4b51ee8252c77c1c356d366cc16a5b9\nparent a1514b475854e858a3de95b3806d5795e0d6d72e\nparent 0585475efdd1cac3a1143f4a349f3de057635efc\nauthor Mazdak Farrokhzad <twingoow@gmail.com> 1571861953 +0200\ncommitter GitHub <noreply@github.com> 1571861953 +0200\n\nRollup merge of #65518 - estebank:i-want-to-break-free, r=eddyb\n\nAvoid ICE when checking `Destination` of `break` inside a closure\n\nFix #65383, fix #62480. This is a `[regression-from-stable-to-stable]` and a fairly small change to avoid the ICE by properly handling this case.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6bb7449fdb0c1abb597b6a3d3ab77efab466c937", "html_url": "https://github.com/rust-lang/rust/commit/6bb7449fdb0c1abb597b6a3d3ab77efab466c937", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6bb7449fdb0c1abb597b6a3d3ab77efab466c937/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a1514b475854e858a3de95b3806d5795e0d6d72e", "url": "https://api.github.com/repos/rust-lang/rust/commits/a1514b475854e858a3de95b3806d5795e0d6d72e", "html_url": "https://github.com/rust-lang/rust/commit/a1514b475854e858a3de95b3806d5795e0d6d72e"}, {"sha": "0585475efdd1cac3a1143f4a349f3de057635efc", "url": "https://api.github.com/repos/rust-lang/rust/commits/0585475efdd1cac3a1143f4a349f3de057635efc", "html_url": "https://github.com/rust-lang/rust/commit/0585475efdd1cac3a1143f4a349f3de057635efc"}], "stats": {"total": 44, "additions": 38, "deletions": 6}, "files": [{"sha": "8668dd99a8cf44b07baa34ed8496f21b5fee8563", "filename": "src/librustc_typeck/check/expr.rs", "status": "modified", "additions": 12, "deletions": 2, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/6bb7449fdb0c1abb597b6a3d3ab77efab466c937/src%2Flibrustc_typeck%2Fcheck%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6bb7449fdb0c1abb597b6a3d3ab77efab466c937/src%2Flibrustc_typeck%2Fcheck%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fexpr.rs?ref=6bb7449fdb0c1abb597b6a3d3ab77efab466c937", "patch": "@@ -566,7 +566,17 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n             // the `enclosing_loops` field and let's coerce the\n             // type of `expr_opt` into what is expected.\n             let mut enclosing_breakables = self.enclosing_breakables.borrow_mut();\n-            let ctxt = enclosing_breakables.find_breakable(target_id);\n+            let ctxt = match enclosing_breakables.opt_find_breakable(target_id) {\n+                Some(ctxt) => ctxt,\n+                None => { // Avoid ICE when `break` is inside a closure (#65383).\n+                    self.tcx.sess.delay_span_bug(\n+                        expr.span,\n+                        \"break was outside loop, but no error was emitted\",\n+                    );\n+                    return tcx.types.err;\n+                }\n+            };\n+\n             if let Some(ref mut coerce) = ctxt.coerce {\n                 if let Some(ref e) = expr_opt {\n                     coerce.coerce(self, &cause, e, e_ty);\n@@ -592,7 +602,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                 }\n             } else {\n                 // If `ctxt.coerce` is `None`, we can just ignore\n-                // the type of the expresison.  This is because\n+                // the type of the expression.  This is because\n                 // either this was a break *without* a value, in\n                 // which case it is always a legal type (`()`), or\n                 // else an error would have been flagged by the"}, {"sha": "d1a8a6f6026c51438a4c5c2a5cfc9c467c91b333", "filename": "src/librustc_typeck/check/mod.rs", "status": "modified", "additions": 9, "deletions": 3, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/6bb7449fdb0c1abb597b6a3d3ab77efab466c937/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6bb7449fdb0c1abb597b6a3d3ab77efab466c937/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs?ref=6bb7449fdb0c1abb597b6a3d3ab77efab466c937", "patch": "@@ -536,10 +536,16 @@ pub struct EnclosingBreakables<'tcx> {\n \n impl<'tcx> EnclosingBreakables<'tcx> {\n     fn find_breakable(&mut self, target_id: hir::HirId) -> &mut BreakableCtxt<'tcx> {\n-        let ix = *self.by_id.get(&target_id).unwrap_or_else(|| {\n+        self.opt_find_breakable(target_id).unwrap_or_else(|| {\n             bug!(\"could not find enclosing breakable with id {}\", target_id);\n-        });\n-        &mut self.stack[ix]\n+        })\n+    }\n+\n+    fn opt_find_breakable(&mut self, target_id: hir::HirId) -> Option<&mut BreakableCtxt<'tcx>> {\n+        match self.by_id.get(&target_id) {\n+            Some(ix) => Some(&mut self.stack[*ix]),\n+            None => None,\n+        }\n     }\n }\n "}, {"sha": "a6f9d0423d082e201104f3b71a0eca98078ce22e", "filename": "src/test/ui/break-outside-loop.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/6bb7449fdb0c1abb597b6a3d3ab77efab466c937/src%2Ftest%2Fui%2Fbreak-outside-loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6bb7449fdb0c1abb597b6a3d3ab77efab466c937/src%2Ftest%2Fui%2Fbreak-outside-loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fbreak-outside-loop.rs?ref=6bb7449fdb0c1abb597b6a3d3ab77efab466c937", "patch": "@@ -22,4 +22,12 @@ fn main() {\n     let rs: Foo = Foo{t: pth};\n \n     let unconstrained = break; //~ ERROR: `break` outside of a loop\n+\n+    // This used to ICE because `target_id` passed to `check_expr_break` would be the closure and\n+    // not the `loop`, which failed in the call to `find_breakable`. (#65383)\n+    'lab: loop {\n+        || {\n+            break 'lab; //~ ERROR `break` inside of a closure\n+        };\n+    }\n }"}, {"sha": "8e300fd848dab3d9357e896f1e4aa69746614cc0", "filename": "src/test/ui/break-outside-loop.stderr", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/6bb7449fdb0c1abb597b6a3d3ab77efab466c937/src%2Ftest%2Fui%2Fbreak-outside-loop.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/6bb7449fdb0c1abb597b6a3d3ab77efab466c937/src%2Ftest%2Fui%2Fbreak-outside-loop.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fbreak-outside-loop.stderr?ref=6bb7449fdb0c1abb597b6a3d3ab77efab466c937", "patch": "@@ -33,7 +33,15 @@ error[E0268]: `break` outside of a loop\n LL |     let unconstrained = break;\n    |                         ^^^^^ cannot `break` outside of a loop\n \n-error: aborting due to 5 previous errors\n+error[E0267]: `break` inside of a closure\n+  --> $DIR/break-outside-loop.rs:30:13\n+   |\n+LL |         || {\n+   |         -- enclosing closure\n+LL |             break 'lab;\n+   |             ^^^^^^^^^^ cannot `break` inside of a closure\n+\n+error: aborting due to 6 previous errors\n \n Some errors have detailed explanations: E0267, E0268.\n For more information about an error, try `rustc --explain E0267`."}]}