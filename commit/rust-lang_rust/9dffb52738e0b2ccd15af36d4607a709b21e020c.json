{"sha": "9dffb52738e0b2ccd15af36d4607a709b21e020c", "node_id": "C_kwDOAAsO6NoAKDlkZmZiNTI3MzhlMGIyY2NkMTVhZjM2ZDQ2MDdhNzA5YjIxZTAyMGM", "commit": {"author": {"name": "David Koloski", "email": "dkoloski@google.com", "date": "2023-05-11T16:25:56Z"}, "committer": {"name": "David Koloski", "email": "dkoloski@google.com", "date": "2023-05-11T19:10:18Z"}, "message": "Get current target config from` --print=cfg`\n\nCompiletest was switched to querying all targets using\n`--print=all-target-specs-json` and `--print=target-spec-json`\nin #108905. This unintentionally prevented codegen flags like `-Cpanic`\nfrom being reflected in the current target configuration. This change\ngets the current compiletest target config using `--print=cfg` like it\nwas previously while still using the faster prints for getting\ninformation on all other targets.\n\nFixes #110850.", "tree": {"sha": "18b86e6986455586388f708921b03c517d7aa232", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/18b86e6986455586388f708921b03c517d7aa232"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9dffb52738e0b2ccd15af36d4607a709b21e020c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9dffb52738e0b2ccd15af36d4607a709b21e020c", "html_url": "https://github.com/rust-lang/rust/commit/9dffb52738e0b2ccd15af36d4607a709b21e020c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9dffb52738e0b2ccd15af36d4607a709b21e020c/comments", "author": null, "committer": null, "parents": [{"sha": "2a8221dbdfd180a2d56d4b0089f4f3952d8c2bcd", "url": "https://api.github.com/repos/rust-lang/rust/commits/2a8221dbdfd180a2d56d4b0089f4f3952d8c2bcd", "html_url": "https://github.com/rust-lang/rust/commit/2a8221dbdfd180a2d56d4b0089f4f3952d8c2bcd"}], "stats": {"total": 89, "additions": 84, "deletions": 5}, "files": [{"sha": "ba68b5ee9d5b445eadbe40a684dcd9f9dc5878e2", "filename": "src/tools/compiletest/src/common.rs", "status": "modified", "additions": 84, "deletions": 5, "changes": 89, "blob_url": "https://github.com/rust-lang/rust/blob/9dffb52738e0b2ccd15af36d4607a709b21e020c/src%2Ftools%2Fcompiletest%2Fsrc%2Fcommon.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9dffb52738e0b2ccd15af36d4607a709b21e020c/src%2Ftools%2Fcompiletest%2Fsrc%2Fcommon.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fcommon.rs?ref=9dffb52738e0b2ccd15af36d4607a709b21e020c", "patch": "@@ -428,7 +428,6 @@ impl TargetCfgs {\n         ))\n         .unwrap();\n \n-        let mut current = None;\n         let mut all_targets = HashSet::new();\n         let mut all_archs = HashSet::new();\n         let mut all_oses = HashSet::new();\n@@ -449,14 +448,11 @@ impl TargetCfgs {\n             }\n             all_pointer_widths.insert(format!(\"{}bit\", cfg.pointer_width));\n \n-            if target == config.target {\n-                current = Some(cfg);\n-            }\n             all_targets.insert(target.into());\n         }\n \n         Self {\n-            current: current.expect(\"current target not found\"),\n+            current: Self::get_current_target_config(config),\n             all_targets,\n             all_archs,\n             all_oses,\n@@ -467,6 +463,89 @@ impl TargetCfgs {\n             all_pointer_widths,\n         }\n     }\n+\n+    fn get_current_target_config(config: &Config) -> TargetCfg {\n+        let mut arch = None;\n+        let mut os = None;\n+        let mut env = None;\n+        let mut abi = None;\n+        let mut families = Vec::new();\n+        let mut pointer_width = None;\n+        let mut endian = None;\n+        let mut panic = None;\n+\n+        for config in\n+            rustc_output(config, &[\"--print=cfg\", \"--target\", &config.target]).trim().lines()\n+        {\n+            let (name, value) = config\n+                .split_once(\"=\\\"\")\n+                .map(|(name, value)| {\n+                    (\n+                        name,\n+                        Some(\n+                            value\n+                                .strip_suffix(\"\\\"\")\n+                                .expect(\"key-value pair should be properly quoted\"),\n+                        ),\n+                    )\n+                })\n+                .unwrap_or_else(|| (config, None));\n+\n+            match name {\n+                \"target_arch\" => {\n+                    arch = Some(value.expect(\"target_arch should be a key-value pair\").to_string());\n+                }\n+                \"target_os\" => {\n+                    os = Some(value.expect(\"target_os sould be a key-value pair\").to_string());\n+                }\n+                \"target_env\" => {\n+                    env = Some(value.expect(\"target_env should be a key-value pair\").to_string());\n+                }\n+                \"target_abi\" => {\n+                    abi = Some(value.expect(\"target_abi should be a key-value pair\").to_string());\n+                }\n+                \"target_family\" => {\n+                    families\n+                        .push(value.expect(\"target_family should be a key-value pair\").to_string());\n+                }\n+                \"target_pointer_width\" => {\n+                    pointer_width = Some(\n+                        value\n+                            .expect(\"target_pointer_width should be a key-value pair\")\n+                            .parse::<u32>()\n+                            .expect(\"target_pointer_width should be a valid u32\"),\n+                    );\n+                }\n+                \"target_endian\" => {\n+                    endian = Some(match value.expect(\"target_endian should be a key-value pair\") {\n+                        \"big\" => Endian::Big,\n+                        \"little\" => Endian::Little,\n+                        _ => panic!(\"target_endian should be either 'big' or 'little'\"),\n+                    });\n+                }\n+                \"panic\" => {\n+                    panic = Some(match value.expect(\"panic should be a key-value pair\") {\n+                        \"abort\" => PanicStrategy::Abort,\n+                        \"unwind\" => PanicStrategy::Unwind,\n+                        _ => panic!(\"panic should be either 'abort' or 'unwind'\"),\n+                    });\n+                }\n+                _ => (),\n+            }\n+        }\n+\n+        TargetCfg {\n+            arch: arch.expect(\"target configuration should specify target_arch\"),\n+            os: os.expect(\"target configuration should specify target_os\"),\n+            env: env.expect(\"target configuration should specify target_env\"),\n+            abi: abi.expect(\"target configuration should specify target_abi\"),\n+            families,\n+            pointer_width: pointer_width\n+                .expect(\"target configuration should specify target_pointer_width\"),\n+            endian: endian.expect(\"target configuration should specify target_endian\"),\n+            panic: panic.expect(\"target configuration should specify panic\"),\n+        }\n+    }\n }\n \n #[derive(Clone, Debug, serde::Deserialize)]"}]}