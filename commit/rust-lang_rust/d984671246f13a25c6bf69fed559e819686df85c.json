{"sha": "d984671246f13a25c6bf69fed559e819686df85c", "node_id": "C_kwDOAAsO6NoAKGQ5ODQ2NzEyNDZmMTNhMjVjNmJmNjlmZWQ1NTllODE5Njg2ZGY4NWM", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2023-04-04T16:27:47Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-04-04T16:27:47Z"}, "message": "Rollup merge of #109937 - compiler-errors:rustdoc-rpit-cant-be-documented, r=GuillaumeGomez\n\nDon't collect return-position impl traits for documentation\n\n#104889 modified the rustdoc ast collection step to use a HIR visitor, which more thoroughly walks the HIR tree. that means that we're going to encounter inner items (incl return-position impl traits and async fn opaque futures) that are not possible to document.\n\nFIxes (but does not close due to being a beta regression) #109931\n\nr? `@GuillaumeGomez`", "tree": {"sha": "43d292a6cbb694805820e66dd8e6da154653380c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/43d292a6cbb694805820e66dd8e6da154653380c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d984671246f13a25c6bf69fed559e819686df85c", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkLFADCRBK7hj4Ov3rIwAA8yAIAFWGmScuOrpuajgRpTUwqken\n/gpd0+cBvEg8Wk6IH/zlGk+AzELmMaC8IYl9fwCH7wT2qJV2kCiDGIQMxzoAKeM+\nY5IZ0GzxnRn0cxgx7seAgMJvqSnpHdBlUiZMIHOSaxU/DG6aNH0EWjp/D8DeyDdZ\nFk9Sfr1a+6ZUE05ZM5Hqp1vKwcXHs55Dr6XtARxer9lGUZPXIFG1XpWNH2KZruZQ\nIVV+1HdUfW7d1eSCKHcQm6uY+QjUYwYQM2pfaBrPhxZcejkQJ/rTHKeSw4bHe0Sa\n7XVSjOGoBJdQjspE3XRhMDeNeBRQjhmW3KuIKrdNFVicm1nfKlBs+uAB8SEZWgQ=\n=zfnF\n-----END PGP SIGNATURE-----\n", "payload": "tree 43d292a6cbb694805820e66dd8e6da154653380c\nparent 72e535ea992b7a1d831f9cd634090ab9cc35b9b7\nparent 72ef85d83e3095222dc83e0c03531e5150d074c9\nauthor Michael Goulet <michael@errs.io> 1680625667 -0700\ncommitter GitHub <noreply@github.com> 1680625667 -0700\n\nRollup merge of #109937 - compiler-errors:rustdoc-rpit-cant-be-documented, r=GuillaumeGomez\n\nDon't collect return-position impl traits for documentation\n\n#104889 modified the rustdoc ast collection step to use a HIR visitor, which more thoroughly walks the HIR tree. that means that we're going to encounter inner items (incl return-position impl traits and async fn opaque futures) that are not possible to document.\n\nFIxes (but does not close due to being a beta regression) #109931\n\nr? `@GuillaumeGomez`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d984671246f13a25c6bf69fed559e819686df85c", "html_url": "https://github.com/rust-lang/rust/commit/d984671246f13a25c6bf69fed559e819686df85c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d984671246f13a25c6bf69fed559e819686df85c/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "72e535ea992b7a1d831f9cd634090ab9cc35b9b7", "url": "https://api.github.com/repos/rust-lang/rust/commits/72e535ea992b7a1d831f9cd634090ab9cc35b9b7", "html_url": "https://github.com/rust-lang/rust/commit/72e535ea992b7a1d831f9cd634090ab9cc35b9b7"}, {"sha": "72ef85d83e3095222dc83e0c03531e5150d074c9", "url": "https://api.github.com/repos/rust-lang/rust/commits/72ef85d83e3095222dc83e0c03531e5150d074c9", "html_url": "https://github.com/rust-lang/rust/commit/72ef85d83e3095222dc83e0c03531e5150d074c9"}], "stats": {"total": 25, "additions": 24, "deletions": 1}, "files": [{"sha": "c959bb3701ab561a10b11d8d3f22c2bc11ef0ebb", "filename": "src/librustdoc/visit_ast.rs", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/d984671246f13a25c6bf69fed559e819686df85c/src%2Flibrustdoc%2Fvisit_ast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d984671246f13a25c6bf69fed559e819686df85c/src%2Flibrustdoc%2Fvisit_ast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fvisit_ast.rs?ref=d984671246f13a25c6bf69fed559e819686df85c", "patch": "@@ -421,12 +421,20 @@ impl<'a, 'tcx> RustdocVisitor<'a, 'tcx> {\n             | hir::ItemKind::Struct(..)\n             | hir::ItemKind::Union(..)\n             | hir::ItemKind::TyAlias(..)\n-            | hir::ItemKind::OpaqueTy(..)\n+            | hir::ItemKind::OpaqueTy(hir::OpaqueTy {\n+                origin: hir::OpaqueTyOrigin::TyAlias, ..\n+            })\n             | hir::ItemKind::Static(..)\n             | hir::ItemKind::Trait(..)\n             | hir::ItemKind::TraitAlias(..) => {\n                 self.add_to_current_mod(item, renamed, import_id);\n             }\n+            hir::ItemKind::OpaqueTy(hir::OpaqueTy {\n+                origin: hir::OpaqueTyOrigin::AsyncFn(_) | hir::OpaqueTyOrigin::FnReturn(_),\n+                ..\n+            }) => {\n+                // return-position impl traits are never nameable, and should never be documented.\n+            }\n             hir::ItemKind::Const(..) => {\n                 // Underscore constants do not correspond to a nameable item and\n                 // so are never useful in documentation."}, {"sha": "a73e84f3fdc4ebee85b2492f42313351c2334b25", "filename": "tests/rustdoc/async-fn-opaque-item.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/d984671246f13a25c6bf69fed559e819686df85c/tests%2Frustdoc%2Fasync-fn-opaque-item.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d984671246f13a25c6bf69fed559e819686df85c/tests%2Frustdoc%2Fasync-fn-opaque-item.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frustdoc%2Fasync-fn-opaque-item.rs?ref=d984671246f13a25c6bf69fed559e819686df85c", "patch": "@@ -0,0 +1,15 @@\n+// compile-flags: --document-private-items --crate-type=lib\n+// edition: 2021\n+\n+// Issue 109931 -- test against accidentally documenting the `impl Future`\n+// that comes from an async fn desugaring.\n+\n+// Check that we don't document an unnamed opaque type\n+// @!has async_fn_opaque_item/opaque..html\n+\n+// Checking there is only a \"Functions\" header and no \"Opaque types\".\n+// @has async_fn_opaque_item/index.html\n+// @count - '//*[@class=\"small-section-header\"]' 1\n+// @has - '//*[@class=\"small-section-header\"]' 'Functions'\n+\n+pub async fn test() {}"}]}