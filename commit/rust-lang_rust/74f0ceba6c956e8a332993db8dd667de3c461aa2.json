{"sha": "74f0ceba6c956e8a332993db8dd667de3c461aa2", "node_id": "MDY6Q29tbWl0NzI0NzEyOjc0ZjBjZWJhNmM5NTZlOGEzMzI5OTNkYjhkZDY2N2RlM2M0NjFhYTI=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2014-11-26T17:44:06Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2014-11-27T00:49:35Z"}, "message": "rollup merge of #19231: Gankro/ringbuf-into-iter\n\nr? @huonw @csherratt", "tree": {"sha": "001757366faddadec046607182646261f905635a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/001757366faddadec046607182646261f905635a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/74f0ceba6c956e8a332993db8dd667de3c461aa2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/74f0ceba6c956e8a332993db8dd667de3c461aa2", "html_url": "https://github.com/rust-lang/rust/commit/74f0ceba6c956e8a332993db8dd667de3c461aa2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/74f0ceba6c956e8a332993db8dd667de3c461aa2/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "97495da163c017da34ce2bc8ba31388524216ba1", "url": "https://api.github.com/repos/rust-lang/rust/commits/97495da163c017da34ce2bc8ba31388524216ba1", "html_url": "https://github.com/rust-lang/rust/commit/97495da163c017da34ce2bc8ba31388524216ba1"}, {"sha": "865c2dba30cee0d61ca0073aaf5fd32587887674", "url": "https://api.github.com/repos/rust-lang/rust/commits/865c2dba30cee0d61ca0073aaf5fd32587887674", "html_url": "https://github.com/rust-lang/rust/commit/865c2dba30cee0d61ca0073aaf5fd32587887674"}], "stats": {"total": 110, "additions": 102, "deletions": 8}, "files": [{"sha": "e719a6c6da3733f1eba7c7484570f35954469d01", "filename": "src/libcollections/ring_buf.rs", "status": "modified", "additions": 102, "deletions": 8, "changes": 110, "blob_url": "https://github.com/rust-lang/rust/blob/74f0ceba6c956e8a332993db8dd667de3c461aa2/src%2Flibcollections%2Fring_buf.rs", "raw_url": "https://github.com/rust-lang/rust/raw/74f0ceba6c956e8a332993db8dd667de3c461aa2/src%2Flibcollections%2Fring_buf.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcollections%2Fring_buf.rs?ref=74f0ceba6c956e8a332993db8dd667de3c461aa2", "patch": "@@ -34,8 +34,6 @@ static MINIMUM_CAPACITY: uint = 2u;\n \n // FIXME(conventions): implement shrink_to_fit. Awkward with the current design, but it should\n // be scrapped anyway. Defer to rewrite?\n-// FIXME(conventions): implement into_iter\n-\n \n /// `RingBuf` is a circular buffer that implements `Deque`.\n pub struct RingBuf<T> {\n@@ -394,6 +392,14 @@ impl<T> RingBuf<T> {\n         }\n     }\n \n+    /// Consumes the list into an iterator yielding elements by value.\n+    #[unstable = \"matches collection reform specification, waiting for dust to settle\"]\n+    pub fn into_iter(self) -> MoveItems<T> {\n+        MoveItems {\n+            inner: self,\n+        }\n+    }\n+\n     /// Returns the number of elements in the `RingBuf`.\n     ///\n     /// # Example\n@@ -736,11 +742,9 @@ impl<'a, T> Iterator<&'a mut T> for MutItems<'a, T> {\n         }\n         let tail = self.tail;\n         self.tail = wrap_index(self.tail + 1, self.cap);\n-        if mem::size_of::<T>() != 0 {\n-            unsafe { Some(&mut *self.ptr.offset(tail as int)) }\n-        } else {\n-            // use a non-zero pointer\n-            Some(unsafe { mem::transmute(1u) })\n+\n+        unsafe {\n+            Some(&mut *self.ptr.offset(tail as int))\n         }\n     }\n \n@@ -758,12 +762,43 @@ impl<'a, T> DoubleEndedIterator<&'a mut T> for MutItems<'a, T> {\n             return None;\n         }\n         self.head = wrap_index(self.head - 1, self.cap);\n-        unsafe { Some(&mut *self.ptr.offset(self.head as int)) }\n+\n+        unsafe {\n+            Some(&mut *self.ptr.offset(self.head as int))\n+        }\n     }\n }\n \n impl<'a, T> ExactSizeIterator<&'a mut T> for MutItems<'a, T> {}\n \n+// A by-value RingBuf iterator\n+pub struct MoveItems<T> {\n+    inner: RingBuf<T>,\n+}\n+\n+impl<T> Iterator<T> for MoveItems<T> {\n+    #[inline]\n+    fn next(&mut self) -> Option<T> {\n+        self.inner.pop_front()\n+    }\n+\n+    #[inline]\n+    fn size_hint(&self) -> (uint, Option<uint>) {\n+        let len = self.inner.len();\n+        (len, Some(len))\n+    }\n+}\n+\n+impl<T> DoubleEndedIterator<T> for MoveItems<T> {\n+    #[inline]\n+    fn next_back(&mut self) -> Option<T> {\n+        self.inner.pop_back()\n+    }\n+}\n+\n+\n+impl<T> ExactSize<T> for MoveItems<T> {}\n+\n impl<A: PartialEq> PartialEq for RingBuf<A> {\n     fn eq(&self, other: &RingBuf<A>) -> bool {\n         self.len() == other.len() &&\n@@ -1313,6 +1348,65 @@ mod tests {\n         }\n     }\n \n+    #[test]\n+    fn test_into_iter() {\n+\n+        // Empty iter\n+        {\n+            let d: RingBuf<int> = RingBuf::new();\n+            let mut iter = d.into_iter();\n+\n+            assert_eq!(iter.size_hint(), (0, Some(0)));\n+            assert_eq!(iter.next(), None);\n+            assert_eq!(iter.size_hint(), (0, Some(0)));\n+        }\n+\n+        // simple iter\n+        {\n+            let mut d = RingBuf::new();\n+            for i in range(0i, 5) {\n+                d.push_back(i);\n+            }\n+\n+            let b = vec![0,1,2,3,4];\n+            assert_eq!(d.into_iter().collect::<Vec<int>>(), b);\n+        }\n+\n+        // wrapped iter\n+        {\n+            let mut d = RingBuf::new();\n+            for i in range(0i, 5) {\n+                d.push_back(i);\n+            }\n+            for i in range(6, 9) {\n+                d.push_front(i);\n+            }\n+\n+            let b = vec![8,7,6,0,1,2,3,4];\n+            assert_eq!(d.into_iter().collect::<Vec<int>>(), b);\n+        }\n+\n+        // partially used\n+        {\n+            let mut d = RingBuf::new();\n+            for i in range(0i, 5) {\n+                d.push_back(i);\n+            }\n+            for i in range(6, 9) {\n+                d.push_front(i);\n+            }\n+\n+            let mut it = d.into_iter();\n+            assert_eq!(it.size_hint(), (8, Some(8)));\n+            assert_eq!(it.next(), Some(8));\n+            assert_eq!(it.size_hint(), (7, Some(7)));\n+            assert_eq!(it.next_back(), Some(4));\n+            assert_eq!(it.size_hint(), (6, Some(6)));\n+            assert_eq!(it.next(), Some(7));\n+            assert_eq!(it.size_hint(), (5, Some(5)));\n+        }\n+    }\n+\n     #[test]\n     fn test_from_iter() {\n         use std::iter;"}]}