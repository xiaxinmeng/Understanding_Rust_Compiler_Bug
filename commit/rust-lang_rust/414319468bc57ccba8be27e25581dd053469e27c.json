{"sha": "414319468bc57ccba8be27e25581dd053469e27c", "node_id": "C_kwDOAAsO6NoAKDQxNDMxOTQ2OGJjNTdjY2JhOGJlMjdlMjU1ODFkZDA1MzQ2OWUyN2M", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-10-07T02:29:19Z"}, "committer": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-10-07T02:29:19Z"}, "message": "Check WhereClauseReferencesSelf after all other object safety checks", "tree": {"sha": "8a47d26aefe20b4e33096ea0e0bfd76c4b8ab5de", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8a47d26aefe20b4e33096ea0e0bfd76c4b8ab5de"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/414319468bc57ccba8be27e25581dd053469e27c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/414319468bc57ccba8be27e25581dd053469e27c", "html_url": "https://github.com/rust-lang/rust/commit/414319468bc57ccba8be27e25581dd053469e27c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/414319468bc57ccba8be27e25581dd053469e27c/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0ca356586fed56002b10920fd21ddf6fb12de797", "url": "https://api.github.com/repos/rust-lang/rust/commits/0ca356586fed56002b10920fd21ddf6fb12de797", "html_url": "https://github.com/rust-lang/rust/commit/0ca356586fed56002b10920fd21ddf6fb12de797"}], "stats": {"total": 74, "additions": 61, "deletions": 13}, "files": [{"sha": "b6f8f51bdf491d905d55d632ed4c33c91f457628", "filename": "compiler/rustc_trait_selection/src/traits/object_safety.rs", "status": "modified", "additions": 15, "deletions": 13, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/414319468bc57ccba8be27e25581dd053469e27c/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fobject_safety.rs", "raw_url": "https://github.com/rust-lang/rust/raw/414319468bc57ccba8be27e25581dd053469e27c/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fobject_safety.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fobject_safety.rs?ref=414319468bc57ccba8be27e25581dd053469e27c", "patch": "@@ -447,19 +447,6 @@ fn virtual_call_violation_for_method<'tcx>(\n         return Some(MethodViolationCode::Generic);\n     }\n \n-    if tcx\n-        .predicates_of(method.def_id)\n-        .predicates\n-        .iter()\n-        // A trait object can't claim to live more than the concrete type,\n-        // so outlives predicates will always hold.\n-        .cloned()\n-        .filter(|(p, _)| p.to_opt_type_outlives().is_none())\n-        .any(|pred| contains_illegal_self_type_reference(tcx, trait_def_id, pred))\n-    {\n-        return Some(MethodViolationCode::WhereClauseReferencesSelf);\n-    }\n-\n     let receiver_ty = tcx.liberate_late_bound_regions(method.def_id, sig.input(0));\n \n     // Until `unsized_locals` is fully implemented, `self: Self` can't be dispatched on.\n@@ -538,6 +525,21 @@ fn virtual_call_violation_for_method<'tcx>(\n         }\n     }\n \n+    // NOTE: This check happens last, because it results in a lint, and not a\n+    // hard error.\n+    if tcx\n+        .predicates_of(method.def_id)\n+        .predicates\n+        .iter()\n+        // A trait object can't claim to live more than the concrete type,\n+        // so outlives predicates will always hold.\n+        .cloned()\n+        .filter(|(p, _)| p.to_opt_type_outlives().is_none())\n+        .any(|pred| contains_illegal_self_type_reference(tcx, trait_def_id, pred))\n+    {\n+        return Some(MethodViolationCode::WhereClauseReferencesSelf);\n+    }\n+\n     None\n }\n "}, {"sha": "4f4c3634528a14835828fd685083cb83c15d0b95", "filename": "src/test/ui/object-safety/issue-102762.rs", "status": "added", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/414319468bc57ccba8be27e25581dd053469e27c/src%2Ftest%2Fui%2Fobject-safety%2Fissue-102762.rs", "raw_url": "https://github.com/rust-lang/rust/raw/414319468bc57ccba8be27e25581dd053469e27c/src%2Ftest%2Fui%2Fobject-safety%2Fissue-102762.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fobject-safety%2Fissue-102762.rs?ref=414319468bc57ccba8be27e25581dd053469e27c", "patch": "@@ -0,0 +1,26 @@\n+// compile-flags: --crate-type=lib\n+// This test checks that the `where_clauses_object_safety` lint does not cause\n+// other object safety *hard errors* to be suppressed, because we currently\n+// only emit one object safety error per trait...\n+\n+use std::future::Future;\n+use std::pin::Pin;\n+\n+pub trait Fetcher: Send + Sync {\n+    fn get<'a>(self: &'a Box<Self>) -> Pin<Box<dyn Future<Output = Vec<u8>> + 'a>>\n+    where\n+        Self: Sync,\n+    {\n+        todo!()\n+    }\n+}\n+\n+fn fetcher() -> Box<dyn Fetcher> {\n+    //~^ ERROR the trait `Fetcher` cannot be made into an object\n+    todo!()\n+}\n+\n+pub fn foo() {\n+    let fetcher = fetcher();\n+    let _ = fetcher.get();\n+}"}, {"sha": "5041ebe77605158a9389319437bb1f9487df4186", "filename": "src/test/ui/object-safety/issue-102762.stderr", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/414319468bc57ccba8be27e25581dd053469e27c/src%2Ftest%2Fui%2Fobject-safety%2Fissue-102762.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/414319468bc57ccba8be27e25581dd053469e27c/src%2Ftest%2Fui%2Fobject-safety%2Fissue-102762.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fobject-safety%2Fissue-102762.stderr?ref=414319468bc57ccba8be27e25581dd053469e27c", "patch": "@@ -0,0 +1,20 @@\n+error[E0038]: the trait `Fetcher` cannot be made into an object\n+  --> $DIR/issue-102762.rs:18:21\n+   |\n+LL |     fn get<'a>(self: &'a Box<Self>) -> Pin<Box<dyn Future<Output = Vec<u8>> + 'a>>\n+   |                      ------------- help: consider changing method `get`'s `self` parameter to be `&self`: `&Self`\n+...\n+LL | fn fetcher() -> Box<dyn Fetcher> {\n+   |                     ^^^^^^^^^^^ `Fetcher` cannot be made into an object\n+   |\n+note: for a trait to be \"object safe\" it needs to allow building a vtable to allow the call to be resolvable dynamically; for more information visit <https://doc.rust-lang.org/reference/items/traits.html#object-safety>\n+  --> $DIR/issue-102762.rs:10:22\n+   |\n+LL | pub trait Fetcher: Send + Sync {\n+   |           ------- this trait cannot be made into an object...\n+LL |     fn get<'a>(self: &'a Box<Self>) -> Pin<Box<dyn Future<Output = Vec<u8>> + 'a>>\n+   |                      ^^^^^^^^^^^^^ ...because method `get`'s `self` parameter cannot be dispatched on\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0038`."}]}