{"sha": "4f4a819fa92fc61778593c74726f76fd08a2b917", "node_id": "C_kwDOAAsO6NoAKDRmNGE4MTlmYTkyZmM2MTc3ODU5M2M3NDcyNmY3NmZkMDhhMmI5MTc", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-05-31T21:11:34Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-05-31T21:11:34Z"}, "message": "Rollup merge of #97316 - CAD97:bound-misbehavior, r=dtolnay\n\nPut a bound on collection misbehavior\n\nAs currently written, when a logic error occurs in a collection's trait parameters, this allows *completely arbitrary* misbehavior, so long as it does not cause undefined behavior in std. However, because the extent of misbehavior is not specified, it is allowed for *any* code in std to start misbehaving in arbitrary ways which are not formally UB; consider the theoretical example of a global which gets set on an observed logic error. Because the misbehavior is only bound by not resulting in UB from safe APIs and the crate-level encapsulation boundary of all of std, this makes writing user unsafe code that utilizes std theoretically impossible, as it now relies on undocumented QOI (quality of implementation) that unrelated parts of std cannot be caused to misbehave by a misuse of std::collections APIs.\n\nIn practice, this is a nonconcern, because std has reasonable QOI and an implementation that takes advantage of this freedom is essentially a malicious implementation and only compliant by the most langauage-lawyer reading of the documentation.\n\nTo close this hole, we just add a small clause to the existing logic error paragraph that ensures that any misbehavior is limited to the collection which observed the logic error, making it more plausible to prove the soundness of user unsafe code.\n\nThis is not meant to be formal; a formal refinement would likely need to mention that values derived from the collection can also misbehave after a logic error is observed, as well as define what it means to \"observe\" a logic error in the first place. This fix errs on the side of informality in order to close the hole without complicating a normal reading which can assume a reasonable nonmalicious QOI.\n\nSee also [discussion on IRLO][1].\n\n[1]: https://internals.rust-lang.org/t/using-std-collections-and-unsafe-anything-can-happen/16640\n\nr? rust-lang/libs-api ```@rustbot``` label +T-libs-api -T-libs\n\nThis technically adds a new guarantee to the documentation, though I argue as written it's one already implicitly provided.", "tree": {"sha": "d1c43f29ed692fc19881b607eeba42be7666810a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d1c43f29ed692fc19881b607eeba42be7666810a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4f4a819fa92fc61778593c74726f76fd08a2b917", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJiloSHCRBK7hj4Ov3rIwAAzM8IAAvMdEZO/79Sf9B7a10JmyD+\nUH3OyleJkJBK/gBGdJR5r0zRoQpD8ENpwTzHUp6sbzY85iHahUX8tuz57WNOXCh2\nmY4CLUQVZNttRpMvQCSRypf9An48gRoSLlJSZO4Trwqt+jjZj6v3mWlz+Nj57WC3\n7CH7dBmc0oQ130fHbhaAR/QDa3thJzwbVw1ZNUj4aasLsw3EnAyzOaeczK7CSrj5\n3FUUwUlpt9ogmRdDHdmQWJvsMlYWgol8kfBctwNos552VyaVXzoZ0BQCum6WJFgi\nq9MYr3UWyxD6I4AUa7Yz06s9k4nw1DLLrLhFcDZR4lnSx0OR0q6qVaU168MzI70=\n=kA7m\n-----END PGP SIGNATURE-----\n", "payload": "tree d1c43f29ed692fc19881b607eeba42be7666810a\nparent 0595ea1d12cf745e0a672d05341429ecb0917e66\nparent e6b1003c950221a4afac33ecd64877c3ca56ddf8\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1654031494 +0200\ncommitter GitHub <noreply@github.com> 1654031494 +0200\n\nRollup merge of #97316 - CAD97:bound-misbehavior, r=dtolnay\n\nPut a bound on collection misbehavior\n\nAs currently written, when a logic error occurs in a collection's trait parameters, this allows *completely arbitrary* misbehavior, so long as it does not cause undefined behavior in std. However, because the extent of misbehavior is not specified, it is allowed for *any* code in std to start misbehaving in arbitrary ways which are not formally UB; consider the theoretical example of a global which gets set on an observed logic error. Because the misbehavior is only bound by not resulting in UB from safe APIs and the crate-level encapsulation boundary of all of std, this makes writing user unsafe code that utilizes std theoretically impossible, as it now relies on undocumented QOI (quality of implementation) that unrelated parts of std cannot be caused to misbehave by a misuse of std::collections APIs.\n\nIn practice, this is a nonconcern, because std has reasonable QOI and an implementation that takes advantage of this freedom is essentially a malicious implementation and only compliant by the most langauage-lawyer reading of the documentation.\n\nTo close this hole, we just add a small clause to the existing logic error paragraph that ensures that any misbehavior is limited to the collection which observed the logic error, making it more plausible to prove the soundness of user unsafe code.\n\nThis is not meant to be formal; a formal refinement would likely need to mention that values derived from the collection can also misbehave after a logic error is observed, as well as define what it means to \"observe\" a logic error in the first place. This fix errs on the side of informality in order to close the hole without complicating a normal reading which can assume a reasonable nonmalicious QOI.\n\nSee also [discussion on IRLO][1].\n\n[1]: https://internals.rust-lang.org/t/using-std-collections-and-unsafe-anything-can-happen/16640\n\nr? rust-lang/libs-api ```@rustbot``` label +T-libs-api -T-libs\n\nThis technically adds a new guarantee to the documentation, though I argue as written it's one already implicitly provided.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4f4a819fa92fc61778593c74726f76fd08a2b917", "html_url": "https://github.com/rust-lang/rust/commit/4f4a819fa92fc61778593c74726f76fd08a2b917", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4f4a819fa92fc61778593c74726f76fd08a2b917/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0595ea1d12cf745e0a672d05341429ecb0917e66", "url": "https://api.github.com/repos/rust-lang/rust/commits/0595ea1d12cf745e0a672d05341429ecb0917e66", "html_url": "https://github.com/rust-lang/rust/commit/0595ea1d12cf745e0a672d05341429ecb0917e66"}, {"sha": "e6b1003c950221a4afac33ecd64877c3ca56ddf8", "url": "https://api.github.com/repos/rust-lang/rust/commits/e6b1003c950221a4afac33ecd64877c3ca56ddf8", "html_url": "https://github.com/rust-lang/rust/commit/e6b1003c950221a4afac33ecd64877c3ca56ddf8"}], "stats": {"total": 37, "additions": 20, "deletions": 17}, "files": [{"sha": "839088eac21eadf84207b3727f413458210aaa8b", "filename": "library/alloc/src/collections/binary_heap.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/4f4a819fa92fc61778593c74726f76fd08a2b917/library%2Falloc%2Fsrc%2Fcollections%2Fbinary_heap.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4f4a819fa92fc61778593c74726f76fd08a2b917/library%2Falloc%2Fsrc%2Fcollections%2Fbinary_heap.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Falloc%2Fsrc%2Fcollections%2Fbinary_heap.rs?ref=4f4a819fa92fc61778593c74726f76fd08a2b917", "patch": "@@ -166,9 +166,10 @@ mod tests;\n /// item's ordering relative to any other item, as determined by the [`Ord`]\n /// trait, changes while it is in the heap. This is normally only possible\n /// through [`Cell`], [`RefCell`], global state, I/O, or unsafe code. The\n-/// behavior resulting from such a logic error is not specified (it\n-/// could include panics, incorrect results, aborts, memory leaks, or\n-/// non-termination) but will not be undefined behavior.\n+/// behavior resulting from such a logic error is not specified, but will\n+/// be encapsulated to the `BinaryHeap` that observed the logic error and not\n+/// result in undefined behavior. This could include panics, incorrect results,\n+/// aborts, memory leaks, and non-termination.\n ///\n /// # Examples\n ///"}, {"sha": "6027991a0ed2fbb9b1e518ba7e937e6fde87ddae", "filename": "library/alloc/src/collections/btree/map.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/4f4a819fa92fc61778593c74726f76fd08a2b917/library%2Falloc%2Fsrc%2Fcollections%2Fbtree%2Fmap.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4f4a819fa92fc61778593c74726f76fd08a2b917/library%2Falloc%2Fsrc%2Fcollections%2Fbtree%2Fmap.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Falloc%2Fsrc%2Fcollections%2Fbtree%2Fmap.rs?ref=4f4a819fa92fc61778593c74726f76fd08a2b917", "patch": "@@ -64,9 +64,9 @@ pub(super) const MIN_LEN: usize = node::MIN_LEN_AFTER_SPLIT;\n /// It is a logic error for a key to be modified in such a way that the key's ordering relative to\n /// any other key, as determined by the [`Ord`] trait, changes while it is in the map. This is\n /// normally only possible through [`Cell`], [`RefCell`], global state, I/O, or unsafe code.\n-/// The behavior resulting from such a logic error is not specified (it could include panics,\n-/// incorrect results, aborts, memory leaks, or non-termination) but will not be undefined\n-/// behavior.\n+/// The behavior resulting from such a logic error is not specified, but will be encapsulated to the\n+/// `BTreeMap` that observed the logic error and not result in undefined behavior. This could\n+/// include panics, incorrect results, aborts, memory leaks, and non-termination.\n ///\n /// Iterators obtained from functions such as [`BTreeMap::iter`], [`BTreeMap::values`], or\n /// [`BTreeMap::keys`] produce their items in order by key, and take worst-case logarithmic and"}, {"sha": "20ef834eaeef3153ee62f7eeab94e5200052a800", "filename": "library/alloc/src/collections/btree/set.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/4f4a819fa92fc61778593c74726f76fd08a2b917/library%2Falloc%2Fsrc%2Fcollections%2Fbtree%2Fset.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4f4a819fa92fc61778593c74726f76fd08a2b917/library%2Falloc%2Fsrc%2Fcollections%2Fbtree%2Fset.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Falloc%2Fsrc%2Fcollections%2Fbtree%2Fset.rs?ref=4f4a819fa92fc61778593c74726f76fd08a2b917", "patch": "@@ -23,9 +23,9 @@ use super::Recover;\n /// It is a logic error for an item to be modified in such a way that the item's ordering relative\n /// to any other item, as determined by the [`Ord`] trait, changes while it is in the set. This is\n /// normally only possible through [`Cell`], [`RefCell`], global state, I/O, or unsafe code.\n-/// The behavior resulting from such a logic error is not specified (it could include panics,\n-/// incorrect results, aborts, memory leaks, or non-termination) but will not be undefined\n-/// behavior.\n+/// The behavior resulting from such a logic error is not specified, but will be encapsulated to the\n+/// `BTreeSet` that observed the logic error and not result in undefined behavior. This could\n+/// include panics, incorrect results, aborts, memory leaks, and non-termination.\n ///\n /// Iterators returned by [`BTreeSet::iter`] produce their items in order, and take worst-case\n /// logarithmic and amortized constant time per item returned."}, {"sha": "4ec423eb27f31093f5689e700b06edac0fe392a6", "filename": "library/std/src/collections/hash/map.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/4f4a819fa92fc61778593c74726f76fd08a2b917/library%2Fstd%2Fsrc%2Fcollections%2Fhash%2Fmap.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4f4a819fa92fc61778593c74726f76fd08a2b917/library%2Fstd%2Fsrc%2Fcollections%2Fhash%2Fmap.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fcollections%2Fhash%2Fmap.rs?ref=4f4a819fa92fc61778593c74726f76fd08a2b917", "patch": "@@ -54,7 +54,8 @@ use crate::sys;\n /// the [`Eq`] trait, changes while it is in the map. This is normally only\n /// possible through [`Cell`], [`RefCell`], global state, I/O, or unsafe code.\n /// The behavior resulting from such a logic error is not specified, but will\n-/// not result in undefined behavior. This could include panics, incorrect results,\n+/// be encapsulated to the `HashMap` that observed the logic error and not\n+/// result in undefined behavior. This could include panics, incorrect results,\n /// aborts, memory leaks, and non-termination.\n ///\n /// The hash table implementation is a Rust port of Google's [SwissTable]."}, {"sha": "da0572047eca803fe0053ddf855cd780ec59be7b", "filename": "library/std/src/collections/hash/set.rs", "status": "modified", "additions": 8, "deletions": 7, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/4f4a819fa92fc61778593c74726f76fd08a2b917/library%2Fstd%2Fsrc%2Fcollections%2Fhash%2Fset.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4f4a819fa92fc61778593c74726f76fd08a2b917/library%2Fstd%2Fsrc%2Fcollections%2Fhash%2Fset.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fcollections%2Fhash%2Fset.rs?ref=4f4a819fa92fc61778593c74726f76fd08a2b917", "patch": "@@ -33,13 +33,14 @@ use super::map::{map_try_reserve_error, RandomState};\n /// In other words, if two keys are equal, their hashes must be equal.\n ///\n ///\n-/// It is a logic error for an item to be modified in such a way that the\n-/// item's hash, as determined by the [`Hash`] trait, or its equality, as\n-/// determined by the [`Eq`] trait, changes while it is in the set. This is\n-/// normally only possible through [`Cell`], [`RefCell`], global state, I/O, or\n-/// unsafe code. The behavior resulting from such a logic error is not\n-/// specified (it could include panics, incorrect results, aborts, memory\n-/// leaks, or non-termination) but will not be undefined behavior.\n+/// It is a logic error for a key to be modified in such a way that the key's\n+/// hash, as determined by the [`Hash`] trait, or its equality, as determined by\n+/// the [`Eq`] trait, changes while it is in the map. This is normally only\n+/// possible through [`Cell`], [`RefCell`], global state, I/O, or unsafe code.\n+/// The behavior resulting from such a logic error is not specified, but will\n+/// be encapsulated to the `HashSet` that observed the logic error and not\n+/// result in undefined behavior. This could include panics, incorrect results,\n+/// aborts, memory leaks, and non-termination.\n ///\n /// # Examples\n ///"}]}