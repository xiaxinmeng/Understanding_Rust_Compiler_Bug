{"sha": "cd49e41642c1e0bf2d22157914246d181a608c86", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNkNDllNDE2NDJjMWUwYmYyZDIyMTU3OTE0MjQ2ZDE4MWE2MDhjODY=", "commit": {"author": {"name": "Yusuke Tanaka", "email": "yusuktan@maguro.dev", "date": "2020-08-08T10:34:32Z"}, "committer": {"name": "Yusuke Tanaka", "email": "yusuktan@maguro.dev", "date": "2020-08-08T11:49:09Z"}, "message": "Add test for `handle_document_symbol` (#5655)", "tree": {"sha": "95da6d97c7c198c16ce02722c0eb555b5b8cdd9a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/95da6d97c7c198c16ce02722c0eb555b5b8cdd9a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cd49e41642c1e0bf2d22157914246d181a608c86", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQJIBAABCAAyFiEEgbkHgdnD1idvtMJ0QJ1+7h56cWoFAl8ukTUUHHl1c3VrdGFu\nQG1hZ3Vyby5kZXYACgkQQJ1+7h56cWrYRBAAngrPPOF/0cpiL8sALMW8+j+oCCBP\njBGLjpJrRYwl/Q7EKFd4gJqVfzOVk/gfwjLWr80q0ZTvGUlvUChCRNQunPew7B/Y\n5QSe5AbVdO33ANkISdJxg6d/e1UO+5O8C0q3gPLvMi99ZtyrhuwRZ2lC5fX7dvqp\nsxEeyoCZ2/GUIlmN7rFqRoCOXFIEsyU0ZkrHjy6nrag0AVGK/wjLFT2YwouHDIEC\nck+bfl7E1X9z9Ykq9ZyLZirLJd0I1rCxmmJhgucbEqULD0zeUi/UwWK4xdpNVfMZ\ncaAGJD6tLbK/6xu5BZhLvQxpwgDXs9zbOUOGsLuUjL+ZFgo768yiGjNjtFHlz1FZ\n8oluG0Vo88TtStXowEP7/m/I9c70F4bsc59crDWcGYPYWo+bd8q9zVb94E6Tkrvw\n6VgQ4VvcVT9fiaVr2ElVFFHGMqINcvL8cHeDmzUEw4rwGxvmIYbcqctKq6xUPvvd\ncH9zVIQQ6EIovKkdeOW1XehxPxfFIgWpXGi0S/SUUEMv2981vxcP8DAtRv2Gshmw\n3DVAb3QH6dm04HTQ6c+23HjPw0j4lFvCPptIetIOKrAD2JXoavrLJAfFj3EodRHM\nJUBBvfiAv/o1RkYteAmKH/PTQRXcz4t71JZXvKNaBMkmnR15O3dMa6ynTbt9vzky\nVyaONEVemPjlGnQ=\n=2TNO\n-----END PGP SIGNATURE-----", "payload": "tree 95da6d97c7c198c16ce02722c0eb555b5b8cdd9a\nparent b970d675f5072e638ea4c2166e82ca5a580f6c50\nauthor Yusuke Tanaka <yusuktan@maguro.dev> 1596882872 +0900\ncommitter Yusuke Tanaka <yusuktan@maguro.dev> 1596887349 +0900\n\nAdd test for `handle_document_symbol` (#5655)\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cd49e41642c1e0bf2d22157914246d181a608c86", "html_url": "https://github.com/rust-lang/rust/commit/cd49e41642c1e0bf2d22157914246d181a608c86", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cd49e41642c1e0bf2d22157914246d181a608c86/comments", "author": {"login": "magurotuna", "id": 23649474, "node_id": "MDQ6VXNlcjIzNjQ5NDc0", "avatar_url": "https://avatars.githubusercontent.com/u/23649474?v=4", "gravatar_id": "", "url": "https://api.github.com/users/magurotuna", "html_url": "https://github.com/magurotuna", "followers_url": "https://api.github.com/users/magurotuna/followers", "following_url": "https://api.github.com/users/magurotuna/following{/other_user}", "gists_url": "https://api.github.com/users/magurotuna/gists{/gist_id}", "starred_url": "https://api.github.com/users/magurotuna/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/magurotuna/subscriptions", "organizations_url": "https://api.github.com/users/magurotuna/orgs", "repos_url": "https://api.github.com/users/magurotuna/repos", "events_url": "https://api.github.com/users/magurotuna/events{/privacy}", "received_events_url": "https://api.github.com/users/magurotuna/received_events", "type": "User", "site_admin": false}, "committer": {"login": "magurotuna", "id": 23649474, "node_id": "MDQ6VXNlcjIzNjQ5NDc0", "avatar_url": "https://avatars.githubusercontent.com/u/23649474?v=4", "gravatar_id": "", "url": "https://api.github.com/users/magurotuna", "html_url": "https://github.com/magurotuna", "followers_url": "https://api.github.com/users/magurotuna/followers", "following_url": "https://api.github.com/users/magurotuna/following{/other_user}", "gists_url": "https://api.github.com/users/magurotuna/gists{/gist_id}", "starred_url": "https://api.github.com/users/magurotuna/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/magurotuna/subscriptions", "organizations_url": "https://api.github.com/users/magurotuna/orgs", "repos_url": "https://api.github.com/users/magurotuna/repos", "events_url": "https://api.github.com/users/magurotuna/events{/privacy}", "received_events_url": "https://api.github.com/users/magurotuna/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b970d675f5072e638ea4c2166e82ca5a580f6c50", "url": "https://api.github.com/repos/rust-lang/rust/commits/b970d675f5072e638ea4c2166e82ca5a580f6c50", "html_url": "https://github.com/rust-lang/rust/commit/b970d675f5072e638ea4c2166e82ca5a580f6c50"}], "stats": {"total": 321, "additions": 317, "deletions": 4}, "files": [{"sha": "9a4655e4d567c129c60a1373c17b9e30342aa3fa", "filename": "crates/rust-analyzer/tests/heavy_tests/main.rs", "status": "modified", "additions": 317, "deletions": 4, "changes": 321, "blob_url": "https://github.com/rust-lang/rust/blob/cd49e41642c1e0bf2d22157914246d181a608c86/crates%2Frust-analyzer%2Ftests%2Fheavy_tests%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cd49e41642c1e0bf2d22157914246d181a608c86/crates%2Frust-analyzer%2Ftests%2Fheavy_tests%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Ftests%2Fheavy_tests%2Fmain.rs?ref=cd49e41642c1e0bf2d22157914246d181a608c86", "patch": "@@ -5,11 +5,14 @@ use std::{collections::HashMap, path::PathBuf, time::Instant};\n \n use lsp_types::{\n     notification::DidOpenTextDocument,\n-    request::{CodeActionRequest, Completion, Formatting, GotoTypeDefinition, HoverRequest},\n+    request::{\n+        CodeActionRequest, Completion, DocumentSymbolRequest, Formatting, GotoTypeDefinition,\n+        HoverRequest,\n+    },\n     CodeActionContext, CodeActionParams, CompletionParams, DidOpenTextDocumentParams,\n-    DocumentFormattingParams, FormattingOptions, GotoDefinitionParams, HoverParams,\n-    PartialResultParams, Position, Range, TextDocumentItem, TextDocumentPositionParams,\n-    WorkDoneProgressParams,\n+    DocumentFormattingParams, DocumentSymbolParams, FormattingOptions, GotoDefinitionParams,\n+    HoverParams, PartialResultParams, Position, Range, TextDocumentItem,\n+    TextDocumentPositionParams, WorkDoneProgressParams,\n };\n use rust_analyzer::lsp_ext::{OnEnter, Runnables, RunnablesParams};\n use serde_json::json;\n@@ -682,3 +685,313 @@ pub fn foo(_input: TokenStream) -> TokenStream {\n     let value = res.get(\"contents\").unwrap().get(\"value\").unwrap().to_string();\n     assert_eq!(value, r#\"\"```rust\\nfoo::Bar\\n```\\n\\n```rust\\nfn bar()\\n```\"\"#)\n }\n+\n+#[test]\n+fn test_document_symbol_with_hierarchy() {\n+    if skip_slow_tests() {\n+        return;\n+    }\n+\n+    let server = Project::with_fixture(\n+        r#\"\n+//- /Cargo.toml\n+[package]\n+name = \"foo\"\n+version = \"0.0.0\"\n+\n+//- /src/lib.rs\n+mod a {\n+    mod b {\n+        struct B1;\n+        fn b2() {}\n+    }\n+    struct A1;\n+}\n+\"#,\n+    )\n+    .with_config(|config| {\n+        config.client_caps.hierarchical_symbols = true;\n+    })\n+    .server();\n+    server.wait_until_workspace_is_loaded();\n+\n+    server.request::<DocumentSymbolRequest>(\n+        DocumentSymbolParams {\n+            text_document: server.doc_id(\"src/lib.rs\"),\n+            work_done_progress_params: WorkDoneProgressParams::default(),\n+            partial_result_params: PartialResultParams::default(),\n+        },\n+        json!([\n+            {\n+                \"children\": [\n+                    {\n+                        \"children\": [\n+                            {\n+                                \"deprecated\": false,\n+                                \"kind\": 23,\n+                                \"name\": \"B1\",\n+                                \"range\": {\n+                                    \"end\": {\n+                                        \"character\": 18,\n+                                        \"line\": 2\n+                                    },\n+                                    \"start\": {\n+                                        \"character\": 8,\n+                                        \"line\": 2\n+                                    }\n+                                },\n+                                \"selectionRange\": {\n+                                    \"end\": {\n+                                        \"character\": 17,\n+                                        \"line\": 2\n+                                    },\n+                                    \"start\": {\n+                                        \"character\": 15,\n+                                        \"line\": 2\n+                                    }\n+                                },\n+                                \"tags\": []\n+                            },\n+                            {\n+                                \"deprecated\": false,\n+                                \"detail\": \"fn()\",\n+                                \"kind\": 12,\n+                                \"name\": \"b2\",\n+                                \"range\": {\n+                                    \"end\": {\n+                                        \"character\": 18,\n+                                        \"line\": 3\n+                                    },\n+                                    \"start\": {\n+                                        \"character\": 8,\n+                                        \"line\": 3\n+                                    }\n+                                },\n+                                \"selectionRange\": {\n+                                    \"end\": {\n+                                        \"character\": 13,\n+                                        \"line\": 3\n+                                    },\n+                                    \"start\": {\n+                                        \"character\": 11,\n+                                        \"line\": 3\n+                                    }\n+                                },\n+                                \"tags\": []\n+                            }\n+                        ],\n+                        \"deprecated\": false,\n+                        \"kind\": 2,\n+                        \"name\": \"b\",\n+                        \"range\": {\n+                            \"end\": {\n+                                \"character\": 5,\n+                                \"line\": 4\n+                            },\n+                            \"start\": {\n+                                \"character\": 4,\n+                                \"line\": 1\n+                            }\n+                        },\n+                        \"selectionRange\": {\n+                            \"end\": {\n+                                \"character\": 9,\n+                                \"line\": 1\n+                            },\n+                            \"start\": {\n+                                \"character\": 8,\n+                                \"line\": 1\n+                            }\n+                        },\n+                        \"tags\": []\n+                    },\n+                    {\n+                        \"deprecated\": false,\n+                        \"kind\": 23,\n+                        \"name\": \"A1\",\n+                        \"range\": {\n+                            \"end\": {\n+                                \"character\": 14,\n+                                \"line\": 5\n+                            },\n+                            \"start\": {\n+                                \"character\": 4,\n+                                \"line\": 5\n+                            }\n+                        },\n+                        \"selectionRange\": {\n+                            \"end\": {\n+                                \"character\": 13,\n+                                \"line\": 5\n+                            },\n+                            \"start\": {\n+                                \"character\": 11,\n+                                \"line\": 5\n+                            }\n+                        },\n+                        \"tags\": []\n+                    }\n+                ],\n+                \"deprecated\": false,\n+                \"kind\": 2,\n+                \"name\": \"a\",\n+                \"range\": {\n+                    \"end\": {\n+                        \"character\": 1,\n+                        \"line\": 6\n+                    },\n+                    \"start\": {\n+                        \"character\": 0,\n+                        \"line\": 0\n+                    }\n+                },\n+                \"selectionRange\": {\n+                    \"end\": {\n+                        \"character\": 5,\n+                        \"line\": 0\n+                    },\n+                    \"start\": {\n+                        \"character\": 4,\n+                        \"line\": 0\n+                    }\n+                },\n+                \"tags\": []\n+            }\n+        ]),\n+    );\n+}\n+\n+#[test]\n+fn test_document_symbol_without_hierarchy() {\n+    if skip_slow_tests() {\n+        return;\n+    }\n+\n+    let server = project(\n+        r#\"\n+//- /Cargo.toml\n+[package]\n+name = \"foo\"\n+version = \"0.0.0\"\n+\n+//- /src/lib.rs\n+mod a {\n+    mod b {\n+        struct B1;\n+        fn b2() {}\n+    }\n+    struct A1;\n+}\n+\"#,\n+    );\n+    server.wait_until_workspace_is_loaded();\n+\n+    server.request::<DocumentSymbolRequest>(\n+        DocumentSymbolParams {\n+            text_document: server.doc_id(\"src/lib.rs\"),\n+            work_done_progress_params: WorkDoneProgressParams::default(),\n+            partial_result_params: PartialResultParams::default(),\n+        },\n+        json!([\n+            {\n+                \"deprecated\": false,\n+                \"kind\": 2,\n+                \"location\": {\n+                    \"range\": {\n+                        \"end\": {\n+                            \"character\": 1,\n+                            \"line\": 6\n+                        },\n+                        \"start\": {\n+                            \"character\": 0,\n+                            \"line\": 0\n+                        }\n+                    },\n+                    \"uri\": \"file:///[..]/src/lib.rs\"\n+                },\n+                \"name\": \"a\",\n+                \"tags\": []\n+            },\n+            {\n+                \"containerName\": \"a\",\n+                \"deprecated\": false,\n+                \"kind\": 2,\n+                \"location\": {\n+                    \"range\": {\n+                        \"end\": {\n+                            \"character\": 5,\n+                            \"line\": 4\n+                        },\n+                        \"start\": {\n+                            \"character\": 4,\n+                            \"line\": 1\n+                        }\n+                    },\n+                    \"uri\": \"file:///[..]/src/lib.rs\"\n+                },\n+                \"name\": \"b\",\n+                \"tags\": []\n+            },\n+            {\n+                \"containerName\": \"b\",\n+                \"deprecated\": false,\n+                \"kind\": 23,\n+                \"location\": {\n+                    \"range\": {\n+                        \"end\": {\n+                            \"character\": 18,\n+                            \"line\": 2\n+                        },\n+                        \"start\": {\n+                            \"character\": 8,\n+                            \"line\": 2\n+                        }\n+                    },\n+                    \"uri\": \"file:///[..]/src/lib.rs\"\n+                },\n+                \"name\": \"B1\",\n+                \"tags\": []\n+            },\n+            {\n+                \"containerName\": \"b\",\n+                \"deprecated\": false,\n+                \"kind\": 12,\n+                \"location\": {\n+                    \"range\": {\n+                        \"end\": {\n+                            \"character\": 18,\n+                            \"line\": 3\n+                        },\n+                        \"start\": {\n+                            \"character\": 8,\n+                            \"line\": 3\n+                        }\n+                    },\n+                    \"uri\": \"file:///[..]/src/lib.rs\"\n+                },\n+                \"name\": \"b2\",\n+                \"tags\": []\n+            },\n+            {\n+                \"containerName\": \"a\",\n+                \"deprecated\": false,\n+                \"kind\": 23,\n+                \"location\": {\n+                    \"range\": {\n+                        \"end\": {\n+                            \"character\": 14,\n+                            \"line\": 5\n+                        },\n+                        \"start\": {\n+                            \"character\": 4,\n+                            \"line\": 5\n+                        }\n+                    },\n+                    \"uri\": \"file:///[..]/src/lib.rs\"\n+                },\n+                \"name\": \"A1\",\n+                \"tags\": []\n+            }\n+        ]),\n+    );\n+}"}]}