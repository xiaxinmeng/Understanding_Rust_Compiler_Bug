{"sha": "575f690b39559160e31930726b5629dfbd3526fa", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU3NWY2OTBiMzk1NTkxNjBlMzE5MzA3MjZiNTYyOWRmYmQzNTI2ZmE=", "commit": {"author": {"name": "Bj\u00f6rn Steinbrink", "email": "bsteinbr@gmail.com", "date": "2015-12-27T16:56:15Z"}, "committer": {"name": "Bj\u00f6rn Steinbrink", "email": "bsteinbr@gmail.com", "date": "2015-12-27T16:57:49Z"}, "message": "Fix `auto_ref()` for fat pointers\n\n`auto_ref()` currently returns an Rvalue datum for the ref'd value,\nwhich is fine for thin pointers, but for fat pointers this means that\nonce the pointer is moved out of that datum, its memory will be marked\nas dead. And because there is not necessarily an intermediate temporary\ninvolved we can end up marking memory as dead that is actually still\nused.\n\nAs I don't want to break the micro-optimization for thin pointers by\nalways returning an Lvalue datum, I decided to only do so for fat\npointers.\n\nFix #30478", "tree": {"sha": "f38e3884fff7f4e2a22256a94cfd80e8a33d367e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f38e3884fff7f4e2a22256a94cfd80e8a33d367e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/575f690b39559160e31930726b5629dfbd3526fa", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/575f690b39559160e31930726b5629dfbd3526fa", "html_url": "https://github.com/rust-lang/rust/commit/575f690b39559160e31930726b5629dfbd3526fa", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/575f690b39559160e31930726b5629dfbd3526fa/comments", "author": {"login": "dotdash", "id": 230962, "node_id": "MDQ6VXNlcjIzMDk2Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dotdash", "html_url": "https://github.com/dotdash", "followers_url": "https://api.github.com/users/dotdash/followers", "following_url": "https://api.github.com/users/dotdash/following{/other_user}", "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}", "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions", "organizations_url": "https://api.github.com/users/dotdash/orgs", "repos_url": "https://api.github.com/users/dotdash/repos", "events_url": "https://api.github.com/users/dotdash/events{/privacy}", "received_events_url": "https://api.github.com/users/dotdash/received_events", "type": "User", "site_admin": false}, "committer": {"login": "dotdash", "id": 230962, "node_id": "MDQ6VXNlcjIzMDk2Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dotdash", "html_url": "https://github.com/dotdash", "followers_url": "https://api.github.com/users/dotdash/followers", "following_url": "https://api.github.com/users/dotdash/following{/other_user}", "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}", "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions", "organizations_url": "https://api.github.com/users/dotdash/orgs", "repos_url": "https://api.github.com/users/dotdash/repos", "events_url": "https://api.github.com/users/dotdash/events{/privacy}", "received_events_url": "https://api.github.com/users/dotdash/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "38201501dfe193bfa14d792f590effd462a78717", "url": "https://api.github.com/repos/rust-lang/rust/commits/38201501dfe193bfa14d792f590effd462a78717", "html_url": "https://github.com/rust-lang/rust/commit/38201501dfe193bfa14d792f590effd462a78717"}], "stats": {"total": 18, "additions": 11, "deletions": 7}, "files": [{"sha": "85d4876d160be491fbe79552d86bad56645a7a3b", "filename": "src/librustc_trans/trans/expr.rs", "status": "modified", "additions": 11, "deletions": 7, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/575f690b39559160e31930726b5629dfbd3526fa/src%2Flibrustc_trans%2Ftrans%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/575f690b39559160e31930726b5629dfbd3526fa/src%2Flibrustc_trans%2Ftrans%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Ftrans%2Fexpr.rs?ref=575f690b39559160e31930726b5629dfbd3526fa", "patch": "@@ -2187,15 +2187,19 @@ fn auto_ref<'blk, 'tcx>(bcx: Block<'blk, 'tcx>,\n     let referent_ty = lv_datum.ty;\n     let ptr_ty = bcx.tcx().mk_imm_ref(bcx.tcx().mk_region(ty::ReStatic), referent_ty);\n \n+    // Construct the resulting datum. The right datum to return here would be an Lvalue datum,\n+    // because there is cleanup scheduled and the datum doesn't own the data, but for thin pointers\n+    // we microoptimize it to be an Rvalue datum to avoid the extra alloca and level of\n+    // indirection and for thin pointers, this has no ill effects.\n+    let kind  = if type_is_sized(bcx.tcx(), referent_ty) {\n+        RvalueExpr(Rvalue::new(ByValue))\n+    } else {\n+        LvalueExpr(lv_datum.kind)\n+    };\n+\n     // Get the pointer.\n     let llref = lv_datum.to_llref();\n-\n-    // Construct the resulting datum, using what was the \"by ref\"\n-    // ValueRef of type `referent_ty` to be the \"by value\" ValueRef\n-    // of type `&referent_ty`.\n-    // Pointers to DST types are non-immediate, and therefore still use ByRef.\n-    let kind  = if type_is_sized(bcx.tcx(), referent_ty) { ByValue } else { ByRef };\n-    DatumBlock::new(bcx, Datum::new(llref, ptr_ty, RvalueExpr(Rvalue::new(kind))))\n+    DatumBlock::new(bcx, Datum::new(llref, ptr_ty, kind))\n }\n \n fn deref_multiple<'blk, 'tcx>(bcx: Block<'blk, 'tcx>,"}]}