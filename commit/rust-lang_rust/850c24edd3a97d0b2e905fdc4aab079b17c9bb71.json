{"sha": "850c24edd3a97d0b2e905fdc4aab079b17c9bb71", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg1MGMyNGVkZDNhOTdkMGIyZTkwNWZkYzRhYWIwNzliMTdjOWJiNzE=", "commit": {"author": {"name": "Philipp Hansch", "email": "dev@phansch.net", "date": "2019-04-19T10:53:03Z"}, "committer": {"name": "Philipp Hansch", "email": "dev@phansch.net", "date": "2019-04-19T10:53:03Z"}, "message": "Fix false positive in module_name_repetitions lint\n\nThis lint was triggering on modules inside expanded attrs, like\nfor example `#[cfg(test)]` and possibly more.", "tree": {"sha": "61cf6ea6f1c1d0b36b511989a91672da5a0a806f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/61cf6ea6f1c1d0b36b511989a91672da5a0a806f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/850c24edd3a97d0b2e905fdc4aab079b17c9bb71", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQJEBAABCgAuFiEEj4U0bmbiMSg/mWqvgqphyqETl+YFAly5qOQQHGRldkBwaGFu\nc2NoLm5ldAAKCRCCqmHKoROX5oZgD/oCex62MI7uJWyD81N9c+bHTTwDpcB1iDBl\nKN/1hLYeyiZmrSwLfzEe6lmJiwpAIrVPkseaLPu1zPVcchvOFfyza2Vb3FfK4lKJ\nHYVwWcbaTKwdm0vLsal4xVzDpg3B+y2uVUBZu1DvVd2HCInNwYv6jMVwF76HeC1P\n+G2jWZ2iIus4d6n4PZUC8gNxLsXhAGM6g4uU+CGMjRecMgBAo+ec25vZ1MnTCtRw\nU0vG2yOsYb440+1F84yuBsG0V863DvjpoQi5s9lAsPDNZOXUPzxbyGBy+0kZO57C\nyvvq3wGokbV+IH5scYoVg2qmhG7z09RKUHgNjnVGGV9Jbs7dgS/dD9jVWuO+t8BZ\n/2ItXBS3fQBTiGMAJhR2sjYUtCoJtAxBVPFFhl0k3euDfDz7Q1N9KkO50R2W0a19\ndAJKCmRh+W+ESHEmiMGOC6lm85S3UD+ZvA/FNcW0TeIrjsErljoitNvR4IVfxLNS\nx0oh69Nvu0fgR0Ge+phoav5PWE7F0DavxeSfGD8mUBooztXYma3xrqsvR+GIUJii\nvFhkWH6nOx32JCd6FrkifISCAwn5YwMQqu7egQl2MlA+klfkhZtz4WR/GYxLMXcu\nMp/Gn206Ko89G9iA091VO27QiqzT0RGhQXsE+JDuWzkDdIB66LCp0S3jClE1ZOI9\numMryFwGAg==\n=pnmM\n-----END PGP SIGNATURE-----", "payload": "tree 61cf6ea6f1c1d0b36b511989a91672da5a0a806f\nparent 0d9ef393b8c2596aca6a037d3efb513afdf17875\nauthor Philipp Hansch <dev@phansch.net> 1555671183 +0200\ncommitter Philipp Hansch <dev@phansch.net> 1555671183 +0200\n\nFix false positive in module_name_repetitions lint\n\nThis lint was triggering on modules inside expanded attrs, like\nfor example `#[cfg(test)]` and possibly more.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/850c24edd3a97d0b2e905fdc4aab079b17c9bb71", "html_url": "https://github.com/rust-lang/rust/commit/850c24edd3a97d0b2e905fdc4aab079b17c9bb71", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/850c24edd3a97d0b2e905fdc4aab079b17c9bb71/comments", "author": {"login": "phansch", "id": 2042399, "node_id": "MDQ6VXNlcjIwNDIzOTk=", "avatar_url": "https://avatars.githubusercontent.com/u/2042399?v=4", "gravatar_id": "", "url": "https://api.github.com/users/phansch", "html_url": "https://github.com/phansch", "followers_url": "https://api.github.com/users/phansch/followers", "following_url": "https://api.github.com/users/phansch/following{/other_user}", "gists_url": "https://api.github.com/users/phansch/gists{/gist_id}", "starred_url": "https://api.github.com/users/phansch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/phansch/subscriptions", "organizations_url": "https://api.github.com/users/phansch/orgs", "repos_url": "https://api.github.com/users/phansch/repos", "events_url": "https://api.github.com/users/phansch/events{/privacy}", "received_events_url": "https://api.github.com/users/phansch/received_events", "type": "User", "site_admin": false}, "committer": {"login": "phansch", "id": 2042399, "node_id": "MDQ6VXNlcjIwNDIzOTk=", "avatar_url": "https://avatars.githubusercontent.com/u/2042399?v=4", "gravatar_id": "", "url": "https://api.github.com/users/phansch", "html_url": "https://github.com/phansch", "followers_url": "https://api.github.com/users/phansch/followers", "following_url": "https://api.github.com/users/phansch/following{/other_user}", "gists_url": "https://api.github.com/users/phansch/gists{/gist_id}", "starred_url": "https://api.github.com/users/phansch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/phansch/subscriptions", "organizations_url": "https://api.github.com/users/phansch/orgs", "repos_url": "https://api.github.com/users/phansch/repos", "events_url": "https://api.github.com/users/phansch/events{/privacy}", "received_events_url": "https://api.github.com/users/phansch/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0d9ef393b8c2596aca6a037d3efb513afdf17875", "url": "https://api.github.com/repos/rust-lang/rust/commits/0d9ef393b8c2596aca6a037d3efb513afdf17875", "html_url": "https://github.com/rust-lang/rust/commit/0d9ef393b8c2596aca6a037d3efb513afdf17875"}], "stats": {"total": 56, "additions": 33, "deletions": 23}, "files": [{"sha": "3f62a02b4573003cc98cb95394f2aa4f30793516", "filename": "clippy_lints/src/attrs.rs", "status": "modified", "additions": 2, "deletions": 16, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/850c24edd3a97d0b2e905fdc4aab079b17c9bb71/clippy_lints%2Fsrc%2Fattrs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/850c24edd3a97d0b2e905fdc4aab079b17c9bb71/clippy_lints%2Fsrc%2Fattrs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fattrs.rs?ref=850c24edd3a97d0b2e905fdc4aab079b17c9bb71", "patch": "@@ -2,8 +2,8 @@\n \n use crate::reexport::*;\n use crate::utils::{\n-    in_macro, last_line_of_span, paths, snippet_opt, span_lint, span_lint_and_sugg, span_lint_and_then,\n-    without_block_comments,\n+    in_macro, is_present_in_source, last_line_of_span, paths, snippet_opt, span_lint, span_lint_and_sugg,\n+    span_lint_and_then, without_block_comments,\n };\n use if_chain::if_chain;\n use rustc::hir::*;\n@@ -481,20 +481,6 @@ fn is_word(nmi: &NestedMetaItem, expected: &str) -> bool {\n     }\n }\n \n-// If the snippet is empty, it's an attribute that was inserted during macro\n-// expansion and we want to ignore those, because they could come from external\n-// sources that the user has no control over.\n-// For some reason these attributes don't have any expansion info on them, so\n-// we have to check it this way until there is a better way.\n-fn is_present_in_source(cx: &LateContext<'_, '_>, span: Span) -> bool {\n-    if let Some(snippet) = snippet_opt(cx, span) {\n-        if snippet.is_empty() {\n-            return false;\n-        }\n-    }\n-    true\n-}\n-\n declare_lint_pass!(DeprecatedCfgAttribute => [DEPRECATED_CFG_ATTR]);\n \n impl EarlyLintPass for DeprecatedCfgAttribute {"}, {"sha": "27229710641dfbad7d0ecd5dc325435fd369112f", "filename": "clippy_lints/src/enum_variants.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/850c24edd3a97d0b2e905fdc4aab079b17c9bb71/clippy_lints%2Fsrc%2Fenum_variants.rs", "raw_url": "https://github.com/rust-lang/rust/raw/850c24edd3a97d0b2e905fdc4aab079b17c9bb71/clippy_lints%2Fsrc%2Fenum_variants.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fenum_variants.rs?ref=850c24edd3a97d0b2e905fdc4aab079b17c9bb71", "patch": "@@ -1,6 +1,6 @@\n //! lint on enum variants that are prefixed or suffixed by the same characters\n \n-use crate::utils::{camel_case, in_macro};\n+use crate::utils::{camel_case, in_macro, is_present_in_source};\n use crate::utils::{span_help_and_lint, span_lint};\n use rustc::lint::{EarlyContext, EarlyLintPass, Lint, LintArray, LintPass};\n use rustc::{declare_tool_lint, impl_lint_pass};\n@@ -244,7 +244,7 @@ impl EarlyLintPass for EnumVariantNames {\n         let item_name = item.ident.as_str();\n         let item_name_chars = item_name.chars().count();\n         let item_camel = to_camel_case(&item_name);\n-        if !in_macro(item.span) {\n+        if !in_macro(item.span) && is_present_in_source(cx, item.span) {\n             if let Some(&(ref mod_name, ref mod_camel)) = self.modules.last() {\n                 // constants don't have surrounding modules\n                 if !mod_camel.is_empty() {"}, {"sha": "31f6658b4e8ba43e8e738d1b2aa3cac3b941b011", "filename": "clippy_lints/src/utils/mod.rs", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/850c24edd3a97d0b2e905fdc4aab079b17c9bb71/clippy_lints%2Fsrc%2Futils%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/850c24edd3a97d0b2e905fdc4aab079b17c9bb71/clippy_lints%2Fsrc%2Futils%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Futils%2Fmod.rs?ref=850c24edd3a97d0b2e905fdc4aab079b17c9bb71", "patch": "@@ -93,6 +93,20 @@ pub fn in_macro(span: Span) -> bool {\n     span.ctxt().outer().expn_info().is_some()\n }\n \n+// If the snippet is empty, it's an attribute that was inserted during macro\n+// expansion and we want to ignore those, because they could come from external\n+// sources that the user has no control over.\n+// For some reason these attributes don't have any expansion info on them, so\n+// we have to check it this way until there is a better way.\n+pub fn is_present_in_source<'a, T: LintContext<'a>>(cx: &T, span: Span) -> bool {\n+    if let Some(snippet) = snippet_opt(cx, span) {\n+        if snippet.is_empty() {\n+            return false;\n+        }\n+    }\n+    true\n+}\n+\n /// Checks if type is struct, enum or union type with the given def path.\n pub fn match_type(cx: &LateContext<'_, '_>, ty: Ty<'_>, path: &[&str]) -> bool {\n     match ty.sty {"}, {"sha": "669bf01a84c1067f0eb9222c286abc64fb3f7fcf", "filename": "tests/ui/module_name_repetitions.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/850c24edd3a97d0b2e905fdc4aab079b17c9bb71/tests%2Fui%2Fmodule_name_repetitions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/850c24edd3a97d0b2e905fdc4aab079b17c9bb71/tests%2Fui%2Fmodule_name_repetitions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmodule_name_repetitions.rs?ref=850c24edd3a97d0b2e905fdc4aab079b17c9bb71", "patch": "@@ -1,3 +1,5 @@\n+// compile-flags: --test\n+\n #![warn(clippy::module_name_repetitions)]\n #![allow(dead_code)]\n \n@@ -13,4 +15,12 @@ mod foo {\n     pub struct Foobar;\n }\n \n+#[cfg(test)]\n+mod test {\n+    #[test]\n+    fn it_works() {\n+        assert_eq!(2 + 2, 4);\n+    }\n+}\n+\n fn main() {}"}, {"sha": "bdd217a969c05acfcee5efe23b2e111b72451b62", "filename": "tests/ui/module_name_repetitions.stderr", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/850c24edd3a97d0b2e905fdc4aab079b17c9bb71/tests%2Fui%2Fmodule_name_repetitions.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/850c24edd3a97d0b2e905fdc4aab079b17c9bb71/tests%2Fui%2Fmodule_name_repetitions.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmodule_name_repetitions.stderr?ref=850c24edd3a97d0b2e905fdc4aab079b17c9bb71", "patch": "@@ -1,31 +1,31 @@\n error: item name starts with its containing module's name\n-  --> $DIR/module_name_repetitions.rs:6:5\n+  --> $DIR/module_name_repetitions.rs:8:5\n    |\n LL |     pub fn foo_bar() {}\n    |     ^^^^^^^^^^^^^^^^^^^\n    |\n    = note: `-D clippy::module-name-repetitions` implied by `-D warnings`\n \n error: item name ends with its containing module's name\n-  --> $DIR/module_name_repetitions.rs:7:5\n+  --> $DIR/module_name_repetitions.rs:9:5\n    |\n LL |     pub fn bar_foo() {}\n    |     ^^^^^^^^^^^^^^^^^^^\n \n error: item name starts with its containing module's name\n-  --> $DIR/module_name_repetitions.rs:8:5\n+  --> $DIR/module_name_repetitions.rs:10:5\n    |\n LL |     pub struct FooCake {}\n    |     ^^^^^^^^^^^^^^^^^^^^^\n \n error: item name ends with its containing module's name\n-  --> $DIR/module_name_repetitions.rs:9:5\n+  --> $DIR/module_name_repetitions.rs:11:5\n    |\n LL |     pub enum CakeFoo {}\n    |     ^^^^^^^^^^^^^^^^^^^\n \n error: item name starts with its containing module's name\n-  --> $DIR/module_name_repetitions.rs:10:5\n+  --> $DIR/module_name_repetitions.rs:12:5\n    |\n LL |     pub struct Foo7Bar;\n    |     ^^^^^^^^^^^^^^^^^^^"}]}