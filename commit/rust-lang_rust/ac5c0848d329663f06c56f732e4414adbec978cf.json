{"sha": "ac5c0848d329663f06c56f732e4414adbec978cf", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFjNWMwODQ4ZDMyOTY2M2YwNmM1NmY3MzJlNDQxNGFkYmVjOTc4Y2Y=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-05-14T20:46:09Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-05-14T20:46:09Z"}, "message": "Auto merge of #50693 - dlrobertson:fix_50493, r=petrochenkov\n\ntypeck: Save the index of private fields\n\nSave the index of all fields regardless of their visibility. Problems\ncould occur later when attempting to index fields in error recovery if\nthey are not inserted.\n\nFixes: #50493", "tree": {"sha": "238c04a4d6a400e04041e09cb00d94ea8218ef5c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/238c04a4d6a400e04041e09cb00d94ea8218ef5c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ac5c0848d329663f06c56f732e4414adbec978cf", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ac5c0848d329663f06c56f732e4414adbec978cf", "html_url": "https://github.com/rust-lang/rust/commit/ac5c0848d329663f06c56f732e4414adbec978cf", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ac5c0848d329663f06c56f732e4414adbec978cf/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "935a2f12b2a3ce44cbcbd0f7de1b388949cccca2", "url": "https://api.github.com/repos/rust-lang/rust/commits/935a2f12b2a3ce44cbcbd0f7de1b388949cccca2", "html_url": "https://github.com/rust-lang/rust/commit/935a2f12b2a3ce44cbcbd0f7de1b388949cccca2"}, {"sha": "cdd61396c93f34915d145f0ab5b388138b479a3c", "url": "https://api.github.com/repos/rust-lang/rust/commits/cdd61396c93f34915d145f0ab5b388138b479a3c", "html_url": "https://github.com/rust-lang/rust/commit/cdd61396c93f34915d145f0ab5b388138b479a3c"}], "stats": {"total": 63, "additions": 62, "deletions": 1}, "files": [{"sha": "b559251c39172d6906ff154624992ebf723bc735", "filename": "src/librustc_typeck/check/mod.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/ac5c0848d329663f06c56f732e4414adbec978cf/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ac5c0848d329663f06c56f732e4414adbec978cf/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs?ref=ac5c0848d329663f06c56f732e4414adbec978cf", "patch": "@@ -3081,12 +3081,14 @@ impl<'a, 'gcx, 'tcx> FnCtxt<'a, 'gcx, 'tcx> {\n                     if let Some(index) = fields.iter().position(|f| f.name.to_ident() == ident) {\n                         let field = &fields[index];\n                         let field_ty = self.field_ty(expr.span, field, substs);\n+                        // Save the index of all fields regardless of their visibility in case\n+                        // of error recovery.\n+                        self.write_field_index(expr.id, index);\n                         if field.vis.is_accessible_from(def_scope, self.tcx) {\n                             let adjustments = autoderef.adjust_steps(needs);\n                             self.apply_adjustments(base, adjustments);\n                             autoderef.finalize();\n \n-                            self.write_field_index(expr.id, index);\n                             self.tcx.check_stability(field.did, Some(expr.id), expr.span);\n                             return field_ty;\n                         }"}, {"sha": "7d36517d9704b03b67aca67c1b173edfdc1b00d6", "filename": "src/test/compile-fail-fulldeps/proc-macro/auxiliary/issue_50493.rs", "status": "added", "additions": 32, "deletions": 0, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/ac5c0848d329663f06c56f732e4414adbec978cf/src%2Ftest%2Fcompile-fail-fulldeps%2Fproc-macro%2Fauxiliary%2Fissue_50493.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ac5c0848d329663f06c56f732e4414adbec978cf/src%2Ftest%2Fcompile-fail-fulldeps%2Fproc-macro%2Fauxiliary%2Fissue_50493.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail-fulldeps%2Fproc-macro%2Fauxiliary%2Fissue_50493.rs?ref=ac5c0848d329663f06c56f732e4414adbec978cf", "patch": "@@ -0,0 +1,32 @@\n+// Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// force-host\n+// no-prefer-dynamic\n+\n+#![feature(proc_macro, proc_macro_lib)]\n+#![crate_type = \"proc-macro\"]\n+\n+extern crate proc_macro;\n+use proc_macro::TokenStream;\n+\n+#[proc_macro_derive(Derive)]\n+pub fn derive(_: TokenStream) -> TokenStream {\n+    let code = \"\n+        fn one(r: Restricted) {\n+            r.field;\n+        }\n+        fn two(r: Restricted) {\n+            r.field;\n+        }\n+    \";\n+\n+    code.parse().unwrap()\n+}"}, {"sha": "51112f202c8970fee02c728b89247125456983a4", "filename": "src/test/compile-fail-fulldeps/proc-macro/issue-50493.rs", "status": "added", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/ac5c0848d329663f06c56f732e4414adbec978cf/src%2Ftest%2Fcompile-fail-fulldeps%2Fproc-macro%2Fissue-50493.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ac5c0848d329663f06c56f732e4414adbec978cf/src%2Ftest%2Fcompile-fail-fulldeps%2Fproc-macro%2Fissue-50493.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail-fulldeps%2Fproc-macro%2Fissue-50493.rs?ref=ac5c0848d329663f06c56f732e4414adbec978cf", "patch": "@@ -0,0 +1,27 @@\n+// Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// aux-build:issue_50493.rs\n+// ignore-stage1\n+\n+#![feature(proc_macro)]\n+\n+#[macro_use]\n+extern crate issue_50493;\n+\n+#[derive(Derive)] //~ ERROR field `field` of struct `Restricted` is private\n+struct Restricted {\n+    pub(in restricted) field: usize, //~ visibilities can only be restricted to ancestor modules\n+}\n+\n+mod restricted {}\n+\n+fn main() {}\n+"}]}