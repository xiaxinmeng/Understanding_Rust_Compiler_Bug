{"sha": "a03872645fc655125e43e56bd12c335b2fb19c2e", "node_id": "MDY6Q29tbWl0NzI0NzEyOmEwMzg3MjY0NWZjNjU1MTI1ZTQzZTU2YmQxMmMzMzViMmZiMTljMmU=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-08-09T12:07:28Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-08-09T12:07:28Z"}, "message": "Rollup merge of #62950 - mati865:linkcheck, r=alexcrichton\n\nCheck rustbook links on all platforms when running locally\n\ncc https://github.com/rust-lang/rust/issues/62739", "tree": {"sha": "b97c93eb734a22dd8c16a85e4945165cb25f91a5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b97c93eb734a22dd8c16a85e4945165cb25f91a5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a03872645fc655125e43e56bd12c335b2fb19c2e", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJdTWIACRBK7hj4Ov3rIwAAdHIIAIQ+LbSFPzapuEfDiNbeCt+h\nfY0Z1Q4yD35N4hB5e7CpCS6eLVIhtqACpG3TyS49e7fJwdJ8jqZYjy2K1GUaB4q6\nFAazKNoT6UTArvCW5uk9DmqzwahH0fkQywwvmoIdP0mNtucHahIP61xe62ywUNw3\nq07uQ9Q9LiFqvW3WfkxgNfVDzOuF0TD7pgRSLup6lNI+YAFmL0HNhGE95bHehyME\noR3OX6GGxkbTm0ljMm5gUibqGaSfFiuLkiO2DXD/3Bg+Gx1Rxc6qfXk3zxRnnKLZ\n1+KUbyGh/vEvJhUTgnbDQdmvXe6Ss0CLMjN7Ypq/OEyPTOA4sSpYPwtUgCwYKYU=\n=KEEa\n-----END PGP SIGNATURE-----\n", "payload": "tree b97c93eb734a22dd8c16a85e4945165cb25f91a5\nparent 03c524e0f5a5672ac457f1b49229edcc23167ada\nparent c7e16c5f47ac86877ab6c52db61709349e4cf276\nauthor Mazdak Farrokhzad <twingoow@gmail.com> 1565352448 +0200\ncommitter GitHub <noreply@github.com> 1565352448 +0200\n\nRollup merge of #62950 - mati865:linkcheck, r=alexcrichton\n\nCheck rustbook links on all platforms when running locally\n\ncc https://github.com/rust-lang/rust/issues/62739\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a03872645fc655125e43e56bd12c335b2fb19c2e", "html_url": "https://github.com/rust-lang/rust/commit/a03872645fc655125e43e56bd12c335b2fb19c2e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a03872645fc655125e43e56bd12c335b2fb19c2e/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "03c524e0f5a5672ac457f1b49229edcc23167ada", "url": "https://api.github.com/repos/rust-lang/rust/commits/03c524e0f5a5672ac457f1b49229edcc23167ada", "html_url": "https://github.com/rust-lang/rust/commit/03c524e0f5a5672ac457f1b49229edcc23167ada"}, {"sha": "c7e16c5f47ac86877ab6c52db61709349e4cf276", "url": "https://api.github.com/repos/rust-lang/rust/commits/c7e16c5f47ac86877ab6c52db61709349e4cf276", "html_url": "https://github.com/rust-lang/rust/commit/c7e16c5f47ac86877ab6c52db61709349e4cf276"}], "stats": {"total": 49, "additions": 36, "deletions": 13}, "files": [{"sha": "df7eb7c455d0267922fc6bf07fac90c85c02a1f0", "filename": "src/bootstrap/tool.rs", "status": "modified", "additions": 23, "deletions": 3, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/a03872645fc655125e43e56bd12c335b2fb19c2e/src%2Fbootstrap%2Ftool.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a03872645fc655125e43e56bd12c335b2fb19c2e/src%2Fbootstrap%2Ftool.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Ftool.rs?ref=a03872645fc655125e43e56bd12c335b2fb19c2e", "patch": "@@ -9,7 +9,7 @@ use build_helper::t;\n use crate::Mode;\n use crate::Compiler;\n use crate::builder::{Step, RunConfig, ShouldRun, Builder};\n-use crate::util::{exe, add_lib_path};\n+use crate::util::{exe, add_lib_path, CiEnv};\n use crate::compile;\n use crate::channel::GitInfo;\n use crate::channel;\n@@ -279,11 +279,26 @@ pub fn prepare_tool_cargo(\n     cargo\n }\n \n+fn rustbook_features() -> Vec<String> {\n+    let mut features = Vec::new();\n+\n+    // Due to CI budged and risk of spurious failures we want to limit jobs running this check.\n+    // At same time local builds should run it regardless of the platform.\n+    // `CiEnv::None` means it's local build and `CHECK_LINKS` is defined in x86_64-gnu-tools to\n+    // explicitly enable it on single job\n+    if CiEnv::current() == CiEnv::None || env::var(\"CHECK_LINKS\").is_ok() {\n+        features.push(\"linkcheck\".to_string());\n+    }\n+\n+    features\n+}\n+\n macro_rules! bootstrap_tool {\n     ($(\n         $name:ident, $path:expr, $tool_name:expr\n         $(,llvm_tools = $llvm:expr)*\n         $(,is_external_tool = $external:expr)*\n+        $(,features = $features:expr)*\n         ;\n     )+) => {\n         #[derive(Copy, PartialEq, Eq, Clone)]\n@@ -350,7 +365,12 @@ macro_rules! bootstrap_tool {\n                     } else {\n                         SourceType::InTree\n                     },\n-                    extra_features: Vec::new(),\n+                    extra_features: {\n+                        // FIXME(#60643): avoid this lint by using `_`\n+                        let mut _tmp = Vec::new();\n+                        $(_tmp.extend($features);)*\n+                        _tmp\n+                    },\n                 }).expect(\"expected to build -- essential tool\")\n             }\n         }\n@@ -359,7 +379,7 @@ macro_rules! bootstrap_tool {\n }\n \n bootstrap_tool!(\n-    Rustbook, \"src/tools/rustbook\", \"rustbook\";\n+    Rustbook, \"src/tools/rustbook\", \"rustbook\", features = rustbook_features();\n     UnstableBookGen, \"src/tools/unstable-book-gen\", \"unstable-book-gen\";\n     Tidy, \"src/tools/tidy\", \"tidy\";\n     Linkchecker, \"src/tools/linkchecker\", \"linkchecker\";"}, {"sha": "8035195c6ed0ae5cdee52296fa294ed6fde3c2d5", "filename": "src/ci/docker/x86_64-gnu-tools/Dockerfile", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/a03872645fc655125e43e56bd12c335b2fb19c2e/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/a03872645fc655125e43e56bd12c335b2fb19c2e/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2FDockerfile?ref=a03872645fc655125e43e56bd12c335b2fb19c2e", "patch": "@@ -21,6 +21,9 @@ COPY x86_64-gnu-tools/checkregression.py /tmp/\n COPY x86_64-gnu-tools/checktools.sh /tmp/\n COPY x86_64-gnu-tools/repo.sh /tmp/\n \n+# Run rustbook with `linkcheck` feature enabled\n+ENV CHECK_LINKS 1\n+\n ENV RUST_CONFIGURE_ARGS \\\n   --build=x86_64-unknown-linux-gnu \\\n   --save-toolstates=/tmp/toolstates.json"}, {"sha": "a7188f0d11eac264ff3eba66eeffe7e05b4bee2a", "filename": "src/tools/rustbook/Cargo.toml", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/a03872645fc655125e43e56bd12c335b2fb19c2e/src%2Ftools%2Frustbook%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/a03872645fc655125e43e56bd12c335b2fb19c2e/src%2Ftools%2Frustbook%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Frustbook%2FCargo.toml?ref=a03872645fc655125e43e56bd12c335b2fb19c2e", "patch": "@@ -5,14 +5,15 @@ version = \"0.1.0\"\n license = \"MIT OR Apache-2.0\"\n edition = \"2018\"\n \n+[features]\n+linkcheck = [\"mdbook-linkcheck\"]\n+\n [dependencies]\n clap = \"2.25.0\"\n failure = \"0.1\"\n+mdbook-linkcheck = { version = \"0.3.0\", optional = true }\n \n [dependencies.mdbook]\n version = \"0.3.0\"\n default-features = false\n features = [\"search\"]\n-\n-[target.'cfg(all(target_arch = \"x86_64\", target_os = \"linux\"))'.dependencies]\n-mdbook-linkcheck = \"0.3.0\""}, {"sha": "95530b210afd6cb0ce8cac88994e8424c287d8d3", "filename": "src/tools/rustbook/src/main.rs", "status": "modified", "additions": 6, "deletions": 7, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/a03872645fc655125e43e56bd12c335b2fb19c2e/src%2Ftools%2Frustbook%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a03872645fc655125e43e56bd12c335b2fb19c2e/src%2Ftools%2Frustbook%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Frustbook%2Fsrc%2Fmain.rs?ref=a03872645fc655125e43e56bd12c335b2fb19c2e", "patch": "@@ -8,10 +8,9 @@ use clap::{App, ArgMatches, SubCommand, AppSettings};\n use mdbook::MDBook;\n use mdbook::errors::{Result as Result3};\n \n-#[cfg(all(target_arch = \"x86_64\", target_os = \"linux\"))]\n+#[cfg(feature = \"linkcheck\")]\n use mdbook::renderer::RenderContext;\n-\n-#[cfg(all(target_arch = \"x86_64\", target_os = \"linux\"))]\n+#[cfg(feature = \"linkcheck\")]\n use mdbook_linkcheck::{self, errors::BrokenLinks};\n use failure::Error;\n \n@@ -52,7 +51,7 @@ fn main() {\n             if let Err(err) = linkcheck(sub_matches) {\n                 eprintln!(\"Error: {}\", err);\n \n-                #[cfg(all(target_arch = \"x86_64\", target_os = \"linux\"))]\n+                #[cfg(feature = \"linkcheck\")]\n                 {\n                     if let Ok(broken_links) = err.downcast::<BrokenLinks>() {\n                         for cause in broken_links.links().iter() {\n@@ -68,7 +67,7 @@ fn main() {\n     };\n }\n \n-#[cfg(all(target_arch = \"x86_64\", target_os = \"linux\"))]\n+#[cfg(feature = \"linkcheck\")]\n pub fn linkcheck(args: &ArgMatches<'_>) -> Result<(), Error> {\n     let book_dir = get_book_dir(args);\n     let book = MDBook::load(&book_dir).unwrap();\n@@ -78,9 +77,9 @@ pub fn linkcheck(args: &ArgMatches<'_>) -> Result<(), Error> {\n     mdbook_linkcheck::check_links(&render_ctx)\n }\n \n-#[cfg(not(all(target_arch = \"x86_64\", target_os = \"linux\")))]\n+#[cfg(not(feature = \"linkcheck\"))]\n pub fn linkcheck(_args: &ArgMatches<'_>) -> Result<(), Error> {\n-    println!(\"mdbook-linkcheck only works on x86_64 linux targets.\");\n+    println!(\"mdbook-linkcheck is disabled.\");\n     Ok(())\n }\n "}]}