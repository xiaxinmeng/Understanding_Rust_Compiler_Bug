{"sha": "6a6910e5a9bb8d00f9798dea93dcbe61df4c073d", "node_id": "C_kwDOAAsO6NoAKDZhNjkxMGU1YTliYjhkMDBmOTc5OGRlYTkzZGNiZTYxZGY0YzA3M2Q", "commit": {"author": {"name": "Raoul Strackx", "email": "raoul.strackx@fortanix.com", "date": "2022-06-22T11:47:32Z"}, "committer": {"name": "Raoul Strackx", "email": "raoul.strackx@fortanix.com", "date": "2022-06-22T11:49:12Z"}, "message": "Address reviewer comments", "tree": {"sha": "6559bef176ad9d571650ec61861d67ed408fb30e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6559bef176ad9d571650ec61861d67ed408fb30e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6a6910e5a9bb8d00f9798dea93dcbe61df4c073d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6a6910e5a9bb8d00f9798dea93dcbe61df4c073d", "html_url": "https://github.com/rust-lang/rust/commit/6a6910e5a9bb8d00f9798dea93dcbe61df4c073d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6a6910e5a9bb8d00f9798dea93dcbe61df4c073d/comments", "author": {"login": "raoulstrackx", "id": 56830709, "node_id": "MDQ6VXNlcjU2ODMwNzA5", "avatar_url": "https://avatars.githubusercontent.com/u/56830709?v=4", "gravatar_id": "", "url": "https://api.github.com/users/raoulstrackx", "html_url": "https://github.com/raoulstrackx", "followers_url": "https://api.github.com/users/raoulstrackx/followers", "following_url": "https://api.github.com/users/raoulstrackx/following{/other_user}", "gists_url": "https://api.github.com/users/raoulstrackx/gists{/gist_id}", "starred_url": "https://api.github.com/users/raoulstrackx/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/raoulstrackx/subscriptions", "organizations_url": "https://api.github.com/users/raoulstrackx/orgs", "repos_url": "https://api.github.com/users/raoulstrackx/repos", "events_url": "https://api.github.com/users/raoulstrackx/events{/privacy}", "received_events_url": "https://api.github.com/users/raoulstrackx/received_events", "type": "User", "site_admin": false}, "committer": {"login": "raoulstrackx", "id": 56830709, "node_id": "MDQ6VXNlcjU2ODMwNzA5", "avatar_url": "https://avatars.githubusercontent.com/u/56830709?v=4", "gravatar_id": "", "url": "https://api.github.com/users/raoulstrackx", "html_url": "https://github.com/raoulstrackx", "followers_url": "https://api.github.com/users/raoulstrackx/followers", "following_url": "https://api.github.com/users/raoulstrackx/following{/other_user}", "gists_url": "https://api.github.com/users/raoulstrackx/gists{/gist_id}", "starred_url": "https://api.github.com/users/raoulstrackx/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/raoulstrackx/subscriptions", "organizations_url": "https://api.github.com/users/raoulstrackx/orgs", "repos_url": "https://api.github.com/users/raoulstrackx/repos", "events_url": "https://api.github.com/users/raoulstrackx/events{/privacy}", "received_events_url": "https://api.github.com/users/raoulstrackx/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a27aaceee91c1b3a7b4f9b070054290e8530e1bd", "url": "https://api.github.com/repos/rust-lang/rust/commits/a27aaceee91c1b3a7b4f9b070054290e8530e1bd", "html_url": "https://github.com/rust-lang/rust/commit/a27aaceee91c1b3a7b4f9b070054290e8530e1bd"}], "stats": {"total": 15, "additions": 10, "deletions": 5}, "files": [{"sha": "ea24fedd0eb3dbe6d7a6bb701a677afcab612383", "filename": "library/std/src/sys/sgx/abi/usercalls/alloc.rs", "status": "modified", "additions": 10, "deletions": 5, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/6a6910e5a9bb8d00f9798dea93dcbe61df4c073d/library%2Fstd%2Fsrc%2Fsys%2Fsgx%2Fabi%2Fusercalls%2Falloc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6a6910e5a9bb8d00f9798dea93dcbe61df4c073d/library%2Fstd%2Fsrc%2Fsys%2Fsgx%2Fabi%2Fusercalls%2Falloc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Fsgx%2Fabi%2Fusercalls%2Falloc.rs?ref=6a6910e5a9bb8d00f9798dea93dcbe61df4c073d", "patch": "@@ -307,8 +307,9 @@ where\n \n /// Copies `len` bytes of data from enclave pointer `src` to userspace `dst`\n ///\n-/// This function mitigates stale data vulnerabilities\n-/// https://www.intel.com/content/www/us/en/security-center/advisory/intel-sa-00615.html\n+/// This function mitigates stale data vulnerabilities by ensuring all writes to untrusted memory are either:\n+///  - preceded by the VERW instruction and followed by the MFENCE; LFENCE instruction sequence\n+///  - or are in multiples of 8 bytes, aligned to an 8-byte boundary\n ///\n /// # Panics\n /// This function panics if:\n@@ -317,21 +318,25 @@ where\n /// * The `dst` pointer is null\n /// * The `src` memory range is not in enclave memory\n /// * The `dst` memory range is not in user memory\n+///\n+/// # References\n+///  - https://www.intel.com/content/www/us/en/security-center/advisory/intel-sa-00615.html\n+///  - https://www.intel.com/content/www/us/en/developer/articles/technical/software-security-guidance/technical-documentation/processor-mmio-stale-data-vulnerabilities.html#inpage-nav-3-2-2\n pub(crate) unsafe fn copy_to_userspace(src: *const u8, dst: *mut u8, len: usize) {\n     unsafe fn copy_bytewise_to_userspace(src: *const u8, dst: *mut u8, len: usize) {\n         unsafe {\n-            let seg_sel: u16 = 0;\n+            let mut seg_sel: u16 = 0;\n             for off in 0..len {\n                 asm!(\"\n                     mov %ds, ({seg_sel})\n                     verw ({seg_sel})\n                     movb {val}, ({dst})\n                     mfence\n                     lfence\n-                     \",\n+                    \",\n                     val = in(reg_byte) *src.offset(off as isize),\n                     dst = in(reg) dst.offset(off as isize),\n-                    seg_sel = in(reg) &seg_sel,\n+                    seg_sel = in(reg) &mut seg_sel,\n                     options(nostack, att_syntax)\n                 );\n             }"}]}