{"sha": "db00ba9eb2afa1a3db24e208cbd63125d0157090", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRiMDBiYTllYjJhZmExYTNkYjI0ZTIwOGNiZDYzMTI1ZDAxNTcwOTA=", "commit": {"author": {"name": "David Roundy", "email": "roundyd@physics.oregonstate.edu", "date": "2015-12-01T22:29:56Z"}, "committer": {"name": "Dawid Ci\u0119\u017carkiewicz", "email": "dpc@dpc.pw", "date": "2017-03-18T03:15:05Z"}, "message": "Fix race condition in fs::create_dir_all\n\nIt is more robust to not fail if any directory in a path was created\nconcurrently. This change lifts rustc internal `create_dir_racy` that\nwas created to handle such conditions to be new `create_dir_all`\nimplementation.", "tree": {"sha": "b2554b6282dc721e64292a50ed88cd4a810df6a6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b2554b6282dc721e64292a50ed88cd4a810df6a6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/db00ba9eb2afa1a3db24e208cbd63125d0157090", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/db00ba9eb2afa1a3db24e208cbd63125d0157090", "html_url": "https://github.com/rust-lang/rust/commit/db00ba9eb2afa1a3db24e208cbd63125d0157090", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/db00ba9eb2afa1a3db24e208cbd63125d0157090/comments", "author": {"login": "droundy", "id": 137513, "node_id": "MDQ6VXNlcjEzNzUxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/137513?v=4", "gravatar_id": "", "url": "https://api.github.com/users/droundy", "html_url": "https://github.com/droundy", "followers_url": "https://api.github.com/users/droundy/followers", "following_url": "https://api.github.com/users/droundy/following{/other_user}", "gists_url": "https://api.github.com/users/droundy/gists{/gist_id}", "starred_url": "https://api.github.com/users/droundy/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/droundy/subscriptions", "organizations_url": "https://api.github.com/users/droundy/orgs", "repos_url": "https://api.github.com/users/droundy/repos", "events_url": "https://api.github.com/users/droundy/events{/privacy}", "received_events_url": "https://api.github.com/users/droundy/received_events", "type": "User", "site_admin": false}, "committer": {"login": "dpc", "id": 9209, "node_id": "MDQ6VXNlcjkyMDk=", "avatar_url": "https://avatars.githubusercontent.com/u/9209?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dpc", "html_url": "https://github.com/dpc", "followers_url": "https://api.github.com/users/dpc/followers", "following_url": "https://api.github.com/users/dpc/following{/other_user}", "gists_url": "https://api.github.com/users/dpc/gists{/gist_id}", "starred_url": "https://api.github.com/users/dpc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dpc/subscriptions", "organizations_url": "https://api.github.com/users/dpc/orgs", "repos_url": "https://api.github.com/users/dpc/repos", "events_url": "https://api.github.com/users/dpc/events{/privacy}", "received_events_url": "https://api.github.com/users/dpc/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a559452b05c20041a27f518d262573c56b876b64", "url": "https://api.github.com/repos/rust-lang/rust/commits/a559452b05c20041a27f518d262573c56b876b64", "html_url": "https://github.com/rust-lang/rust/commit/a559452b05c20041a27f518d262573c56b876b64"}], "stats": {"total": 76, "additions": 28, "deletions": 48}, "files": [{"sha": "090753b18c0ba4281c61e2c596d0a4f6f8407329", "filename": "src/librustc/util/fs.rs", "status": "modified", "additions": 0, "deletions": 20, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/db00ba9eb2afa1a3db24e208cbd63125d0157090/src%2Flibrustc%2Futil%2Ffs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/db00ba9eb2afa1a3db24e208cbd63125d0157090/src%2Flibrustc%2Futil%2Ffs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Futil%2Ffs.rs?ref=db00ba9eb2afa1a3db24e208cbd63125d0157090", "patch": "@@ -109,23 +109,3 @@ pub fn rename_or_copy_remove<P: AsRef<Path>, Q: AsRef<Path>>(p: P,\n         }\n     }\n }\n-\n-// Like std::fs::create_dir_all, except handles concurrent calls among multiple\n-// threads or processes.\n-pub fn create_dir_racy(path: &Path) -> io::Result<()> {\n-    match fs::create_dir(path) {\n-        Ok(()) => return Ok(()),\n-        Err(ref e) if e.kind() == io::ErrorKind::AlreadyExists => return Ok(()),\n-        Err(ref e) if e.kind() == io::ErrorKind::NotFound => (),\n-        Err(e) => return Err(e),\n-    }\n-    match path.parent() {\n-        Some(p) => try!(create_dir_racy(p)),\n-        None => return Err(io::Error::new(io::ErrorKind::Other, \"failed to create whole tree\")),\n-    }\n-    match fs::create_dir(path) {\n-        Ok(()) => Ok(()),\n-        Err(ref e) if e.kind() == io::ErrorKind::AlreadyExists => Ok(()),\n-        Err(e) => Err(e),\n-    }\n-}"}, {"sha": "2a4a01cd4a453fd1780f7b877940c243550356f1", "filename": "src/librustc_incremental/persist/fs.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/db00ba9eb2afa1a3db24e208cbd63125d0157090/src%2Flibrustc_incremental%2Fpersist%2Ffs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/db00ba9eb2afa1a3db24e208cbd63125d0157090/src%2Flibrustc_incremental%2Fpersist%2Ffs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_incremental%2Fpersist%2Ffs.rs?ref=db00ba9eb2afa1a3db24e208cbd63125d0157090", "patch": "@@ -461,7 +461,7 @@ fn generate_session_dir_path(crate_dir: &Path) -> PathBuf {\n }\n \n fn create_dir(sess: &Session, path: &Path, dir_tag: &str) -> Result<(),()> {\n-    match fs_util::create_dir_racy(path) {\n+    match std_fs::create_dir_all(path) {\n         Ok(()) => {\n             debug!(\"{} directory created successfully\", dir_tag);\n             Ok(())"}, {"sha": "1cc73a3dce04506b8e83b8aa344ecd4ef99d482c", "filename": "src/librustc_save_analysis/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/db00ba9eb2afa1a3db24e208cbd63125d0157090/src%2Flibrustc_save_analysis%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/db00ba9eb2afa1a3db24e208cbd63125d0157090/src%2Flibrustc_save_analysis%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_save_analysis%2Flib.rs?ref=db00ba9eb2afa1a3db24e208cbd63125d0157090", "patch": "@@ -885,7 +885,7 @@ pub fn process_crate<'l, 'tcx>(tcx: TyCtxt<'l, 'tcx, 'tcx>,\n         },\n     };\n \n-    if let Err(e) = rustc::util::fs::create_dir_racy(&root_path) {\n+    if let Err(e) = std::fs::create_dir_all(&root_path) {\n         tcx.sess.err(&format!(\"Could not create directory {}: {}\",\n                               root_path.display(),\n                               e));"}, {"sha": "bb8b4064fab7abd5b7fef34a28613cc317478000", "filename": "src/libstd/fs.rs", "status": "modified", "additions": 20, "deletions": 4, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/db00ba9eb2afa1a3db24e208cbd63125d0157090/src%2Flibstd%2Ffs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/db00ba9eb2afa1a3db24e208cbd63125d0157090/src%2Flibstd%2Ffs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Ffs.rs?ref=db00ba9eb2afa1a3db24e208cbd63125d0157090", "patch": "@@ -1534,6 +1534,12 @@ pub fn create_dir<P: AsRef<Path>>(path: P) -> io::Result<()> {\n /// error conditions for when a directory is being created (after it is\n /// determined to not exist) are outlined by `fs::create_dir`.\n ///\n+/// Notable exception is made for situations where any of the directories\n+/// specified in the `path` could not be created as it was created concurrently.\n+/// Such cases are considered success. In other words: calling `create_dir_all`\n+/// concurrently from multiple threads or processes is guaranteed to not fail\n+/// due to race itself.\n+///\n /// # Examples\n ///\n /// ```\n@@ -1769,11 +1775,21 @@ impl DirBuilder {\n     }\n \n     fn create_dir_all(&self, path: &Path) -> io::Result<()> {\n-        if path == Path::new(\"\") || path.is_dir() { return Ok(()) }\n-        if let Some(p) = path.parent() {\n-            self.create_dir_all(p)?\n+        match self.inner.mkdir(path) {\n+            Ok(()) => return Ok(()),\n+            Err(ref e) if e.kind() == io::ErrorKind::AlreadyExists => return Ok(()),\n+            Err(ref e) if e.kind() == io::ErrorKind::NotFound => {}\n+            Err(e) => return Err(e),\n+        }\n+        match path.parent() {\n+            Some(p) => try!(create_dir_all(p)),\n+            None => return Err(io::Error::new(io::ErrorKind::Other, \"failed to create whole tree\")),\n+        }\n+        match self.inner.mkdir(path) {\n+            Ok(()) => Ok(()),\n+            Err(ref e) if e.kind() == io::ErrorKind::AlreadyExists => Ok(()),\n+            Err(e) => Err(e),\n         }\n-        self.inner.mkdir(path)\n     }\n }\n "}, {"sha": "2865fa6a79253862af85e76ee76bba779a30c8c0", "filename": "src/tools/compiletest/src/runtest.rs", "status": "modified", "additions": 6, "deletions": 22, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/db00ba9eb2afa1a3db24e208cbd63125d0157090/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/db00ba9eb2afa1a3db24e208cbd63125d0157090/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs?ref=db00ba9eb2afa1a3db24e208cbd63125d0157090", "patch": "@@ -25,7 +25,7 @@ use util::logv;\n use std::collections::HashSet;\n use std::env;\n use std::fmt;\n-use std::fs::{self, File};\n+use std::fs::{self, File, create_dir_all};\n use std::io::prelude::*;\n use std::io::{self, BufReader};\n use std::path::{Path, PathBuf};\n@@ -395,7 +395,7 @@ actual:\\n\\\n \n         let out_dir = self.output_base_name().with_extension(\"pretty-out\");\n         let _ = fs::remove_dir_all(&out_dir);\n-        self.create_dir_racy(&out_dir);\n+        create_dir_all(&out_dir).unwrap();\n \n         // FIXME (#9639): This needs to handle non-utf8 paths\n         let mut args = vec![\"-\".to_owned(),\n@@ -1269,7 +1269,7 @@ actual:\\n\\\n \n     fn compose_and_run_compiler(&self, args: ProcArgs, input: Option<String>) -> ProcRes {\n         if !self.props.aux_builds.is_empty() {\n-            self.create_dir_racy(&self.aux_output_dir_name());\n+            create_dir_all(&self.aux_output_dir_name()).unwrap();\n         }\n \n         let aux_dir = self.aux_output_dir_name();\n@@ -1340,22 +1340,6 @@ actual:\\n\\\n                              input)\n     }\n \n-    // Like std::fs::create_dir_all, except handles concurrent calls among multiple\n-    // threads or processes.\n-    fn create_dir_racy(&self, path: &Path) {\n-        match fs::create_dir(path) {\n-            Ok(()) => return,\n-            Err(ref e) if e.kind() == io::ErrorKind::AlreadyExists => return,\n-            Err(ref e) if e.kind() == io::ErrorKind::NotFound => {}\n-            Err(e) => panic!(\"failed to create dir {:?}: {}\", path, e),\n-        }\n-        self.create_dir_racy(path.parent().unwrap());\n-        match fs::create_dir(path) {\n-            Ok(()) => {}\n-            Err(ref e) if e.kind() == io::ErrorKind::AlreadyExists => {}\n-            Err(e) => panic!(\"failed to create dir {:?}: {}\", path, e),\n-        }\n-    }\n \n     fn compose_and_run(&self,\n                        ProcArgs{ args, prog }: ProcArgs,\n@@ -1435,7 +1419,7 @@ actual:\\n\\\n \n \n                 let mir_dump_dir = self.get_mir_dump_dir();\n-                self.create_dir_racy(mir_dump_dir.as_path());\n+                create_dir_all(mir_dump_dir.as_path()).unwrap();\n                 let mut dir_opt = \"dump-mir-dir=\".to_string();\n                 dir_opt.push_str(mir_dump_dir.to_str().unwrap());\n                 debug!(\"dir_opt: {:?}\", dir_opt);\n@@ -1923,7 +1907,7 @@ actual:\\n\\\n \n         let out_dir = self.output_base_name();\n         let _ = fs::remove_dir_all(&out_dir);\n-        self.create_dir_racy(&out_dir);\n+        create_dir_all(&out_dir).unwrap();\n \n         let proc_res = self.document(&out_dir);\n         if !proc_res.status.success() {\n@@ -2299,7 +2283,7 @@ actual:\\n\\\n         if tmpdir.exists() {\n             self.aggressive_rm_rf(&tmpdir).unwrap();\n         }\n-        self.create_dir_racy(&tmpdir);\n+        create_dir_all(&tmpdir).unwrap();\n \n         let host = &self.config.host;\n         let make = if host.contains(\"bitrig\") || host.contains(\"dragonfly\") ||"}]}