{"sha": "25074423828aa4f957d0e90144ac9898b8cb8a3d", "node_id": "C_kwDOAAsO6NoAKDI1MDc0NDIzODI4YWE0Zjk1N2QwZTkwMTQ0YWM5ODk4YjhjYjhhM2Q", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-11-19T10:59:49Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-11-19T10:59:49Z"}, "message": "Merge #10805\n\n10805: ide: dedupe or merge hover actions r=Veykril a=jhgg\n\nfixes #10780 \n\nCo-authored-by: Jake Heinz <jh@discordapp.com>", "tree": {"sha": "bfb1268cc78e69089a78b1209cc8c5819aa9f49a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bfb1268cc78e69089a78b1209cc8c5819aa9f49a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/25074423828aa4f957d0e90144ac9898b8cb8a3d", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhl4OlCRBK7hj4Ov3rIwAAKPEIAFkOQEQu6smcmdKWZY7Y/H+i\nDSX0JhTa5UrBDyk7LhNQ/bQWJmUWyRCqOt4WWmXjdH82mF1nEAJdpbMKKRKmSQ90\n+52L3Y9U2+tivTRLbXes3q/8nvyc6JKrjg7gS0o0hS1iGSBH+jYtMKrWJOlZhv6V\nL/bE9uIlSRyDqJnBqz1KFo8/uEyYTiHiAi3dkZnEJTE3rqw5pht82DUdkoq6wMAi\nyT143YSn5qG9F0chFnprWRYzW1hRu5/VeILOo/fbpW7VA+tO+WaLMprIkxbUhJmi\nxEhvdpvbkBdi8YjAweQPN8sxhub0O/u0nxDaNpFztOz375HwXiKPNADs5YorYrg=\n=fAyu\n-----END PGP SIGNATURE-----\n", "payload": "tree bfb1268cc78e69089a78b1209cc8c5819aa9f49a\nparent f0da9406bcbde1bc727242b481d8de825e84f59a\nparent c28dc00b39d9c89e7b4b024b726af07a32d9972d\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1637319589 +0000\ncommitter GitHub <noreply@github.com> 1637319589 +0000\n\nMerge #10805\n\n10805: ide: dedupe or merge hover actions r=Veykril a=jhgg\n\nfixes #10780 \n\nCo-authored-by: Jake Heinz <jh@discordapp.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/25074423828aa4f957d0e90144ac9898b8cb8a3d", "html_url": "https://github.com/rust-lang/rust/commit/25074423828aa4f957d0e90144ac9898b8cb8a3d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/25074423828aa4f957d0e90144ac9898b8cb8a3d/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f0da9406bcbde1bc727242b481d8de825e84f59a", "url": "https://api.github.com/repos/rust-lang/rust/commits/f0da9406bcbde1bc727242b481d8de825e84f59a", "html_url": "https://github.com/rust-lang/rust/commit/f0da9406bcbde1bc727242b481d8de825e84f59a"}, {"sha": "c28dc00b39d9c89e7b4b024b726af07a32d9972d", "url": "https://api.github.com/repos/rust-lang/rust/commits/c28dc00b39d9c89e7b4b024b726af07a32d9972d", "html_url": "https://github.com/rust-lang/rust/commit/c28dc00b39d9c89e7b4b024b726af07a32d9972d"}], "stats": {"total": 114, "additions": 94, "deletions": 20}, "files": [{"sha": "8d24bdcf4f930d7bf8605c4d45843d01ba6a63b8", "filename": "crates/ide/src/hover.rs", "status": "modified", "additions": 48, "deletions": 4, "changes": 52, "blob_url": "https://github.com/rust-lang/rust/blob/25074423828aa4f957d0e90144ac9898b8cb8a3d/crates%2Fide%2Fsrc%2Fhover.rs", "raw_url": "https://github.com/rust-lang/rust/raw/25074423828aa4f957d0e90144ac9898b8cb8a3d/crates%2Fide%2Fsrc%2Fhover.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fhover.rs?ref=25074423828aa4f957d0e90144ac9898b8cb8a3d", "patch": "@@ -11,7 +11,7 @@ use ide_db::{\n     base_db::FileRange,\n     defs::Definition,\n     helpers::{pick_best_token, FamousDefs},\n-    RootDatabase,\n+    FxIndexSet, RootDatabase,\n };\n use itertools::Itertools;\n use syntax::{ast, match_ast, AstNode, SyntaxKind::*, SyntaxNode, SyntaxToken, T};\n@@ -69,7 +69,7 @@ impl HoverAction {\n     }\n }\n \n-#[derive(Debug, Clone, Eq, PartialEq)]\n+#[derive(Debug, Clone, Eq, PartialEq, Hash)]\n pub struct HoverGotoTypeData {\n     pub mod_path: String,\n     pub nav: NavigationTarget,\n@@ -136,11 +136,12 @@ pub(crate) fn hover(\n         .flatten()\n         .unique_by(|&(def, _)| def)\n         .filter_map(|(def, node)| hover_for_definition(sema, file_id, def, &node, config))\n-        .reduce(|mut acc, HoverResult { markup, actions }| {\n+        .reduce(|mut acc: HoverResult, HoverResult { markup, actions }| {\n             acc.actions.extend(actions);\n             acc.markup = Markup::from(format!(\"{}\\n---\\n{}\", acc.markup, markup));\n             acc\n         });\n+\n     if result.is_none() {\n         // fallbacks, show keywords or types\n         if let Some(res) = render::keyword(sema, config, &original_token) {\n@@ -152,7 +153,10 @@ pub(crate) fn hover(\n             return res;\n         }\n     }\n-    result.map(|res| RangeInfo::new(original_token.text_range(), res))\n+    result.map(|mut res: HoverResult| {\n+        res.actions = dedupe_or_merge_hover_actions(res.actions);\n+        RangeInfo::new(original_token.text_range(), res)\n+    })\n }\n \n pub(crate) fn hover_for_definition(\n@@ -341,3 +345,43 @@ fn walk_and_push_ty(\n         }\n     });\n }\n+\n+fn dedupe_or_merge_hover_actions(actions: Vec<HoverAction>) -> Vec<HoverAction> {\n+    let mut deduped_actions = Vec::with_capacity(actions.len());\n+    let mut go_to_type_targets = FxIndexSet::default();\n+\n+    let mut seen_implementation = false;\n+    let mut seen_reference = false;\n+    let mut seen_runnable = false;\n+    for action in actions {\n+        match action {\n+            HoverAction::GoToType(targets) => {\n+                go_to_type_targets.extend(targets);\n+            }\n+            HoverAction::Implementation(..) => {\n+                if !seen_implementation {\n+                    seen_implementation = true;\n+                    deduped_actions.push(action);\n+                }\n+            }\n+            HoverAction::Reference(..) => {\n+                if !seen_reference {\n+                    seen_reference = true;\n+                    deduped_actions.push(action);\n+                }\n+            }\n+            HoverAction::Runnable(..) => {\n+                if !seen_runnable {\n+                    seen_runnable = true;\n+                    deduped_actions.push(action);\n+                }\n+            }\n+        };\n+    }\n+\n+    if !go_to_type_targets.is_empty() {\n+        deduped_actions.push(HoverAction::GoToType(go_to_type_targets.into_iter().collect()));\n+    }\n+\n+    deduped_actions\n+}"}, {"sha": "5db6fd79749b090e751e2f2dc8f2e6955b1ed7c5", "filename": "crates/ide/src/hover/tests.rs", "status": "modified", "additions": 46, "deletions": 16, "changes": 62, "blob_url": "https://github.com/rust-lang/rust/blob/25074423828aa4f957d0e90144ac9898b8cb8a3d/crates%2Fide%2Fsrc%2Fhover%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/25074423828aa4f957d0e90144ac9898b8cb8a3d/crates%2Fide%2Fsrc%2Fhover%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fhover%2Ftests.rs?ref=25074423828aa4f957d0e90144ac9898b8cb8a3d", "patch": "@@ -173,7 +173,7 @@ m!(ab$0c);\n             ---\n \n             Outer\n-            \"#]],\n+        \"#]],\n     );\n }\n \n@@ -1135,6 +1135,39 @@ fn foo() {\n     );\n }\n \n+#[test]\n+fn test_hover_multiple_actions() {\n+    check_actions(\n+        r#\"\n+struct Bar;\n+struct Foo { bar: Bar }\n+\n+fn foo(Foo { b$0ar }: &Foo) {}\n+        \"#,\n+        expect![[r#\"\n+            [\n+                GoToType(\n+                    [\n+                        HoverGotoTypeData {\n+                            mod_path: \"test::Bar\",\n+                            nav: NavigationTarget {\n+                                file_id: FileId(\n+                                    0,\n+                                ),\n+                                full_range: 0..11,\n+                                focus_range: 7..10,\n+                                name: \"Bar\",\n+                                kind: Struct,\n+                                description: \"struct Bar\",\n+                            },\n+                        },\n+                    ],\n+                ),\n+            ]\n+        \"#]],\n+    )\n+}\n+\n #[test]\n fn test_hover_through_literal_string_in_builtin_macro() {\n     check_hover_no_result(\n@@ -1750,9 +1783,6 @@ fn foo_$0test() {}\n                         cfg: None,\n                     },\n                 ),\n-                GoToType(\n-                    [],\n-                ),\n             ]\n         \"#]],\n     );\n@@ -2749,21 +2779,21 @@ fn main() {\n }\n \"#,\n         expect![[r#\"\n-                *f*\n+            *f*\n \n-                ```rust\n-                f: &i32\n-                ```\n-                ---\n+            ```rust\n+            f: &i32\n+            ```\n+            ---\n \n-                ```rust\n-                test::S\n-                ```\n+            ```rust\n+            test::S\n+            ```\n \n-                ```rust\n-                f: i32\n-                ```\n-            \"#]],\n+            ```rust\n+            f: i32\n+            ```\n+        \"#]],\n     );\n }\n "}]}