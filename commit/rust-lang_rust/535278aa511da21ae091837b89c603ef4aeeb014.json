{"sha": "535278aa511da21ae091837b89c603ef4aeeb014", "node_id": "C_kwDOAAsO6NoAKDUzNTI3OGFhNTExZGEyMWFlMDkxODM3Yjg5YzYwM2VmNGFlZWIwMTQ", "commit": {"author": {"name": "pierwill", "email": "pierwill@users.noreply.github.com", "date": "2021-10-28T17:00:43Z"}, "committer": {"name": "pierwill", "email": "pierwill@users.noreply.github.com", "date": "2021-12-13T16:24:06Z"}, "message": "Add run-make-fulldeps test\n\nImplement RUSTC_FORCE_INCR_COMP_ARTIFACT_HEADER\n\nAlso makes minor docs edits.", "tree": {"sha": "f445b4f2f83a1e17d9d9fab287bf899885199119", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f445b4f2f83a1e17d9d9fab287bf899885199119"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/535278aa511da21ae091837b89c603ef4aeeb014", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/535278aa511da21ae091837b89c603ef4aeeb014", "html_url": "https://github.com/rust-lang/rust/commit/535278aa511da21ae091837b89c603ef4aeeb014", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/535278aa511da21ae091837b89c603ef4aeeb014/comments", "author": {"login": "pierwill", "id": 19642016, "node_id": "MDQ6VXNlcjE5NjQyMDE2", "avatar_url": "https://avatars.githubusercontent.com/u/19642016?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pierwill", "html_url": "https://github.com/pierwill", "followers_url": "https://api.github.com/users/pierwill/followers", "following_url": "https://api.github.com/users/pierwill/following{/other_user}", "gists_url": "https://api.github.com/users/pierwill/gists{/gist_id}", "starred_url": "https://api.github.com/users/pierwill/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pierwill/subscriptions", "organizations_url": "https://api.github.com/users/pierwill/orgs", "repos_url": "https://api.github.com/users/pierwill/repos", "events_url": "https://api.github.com/users/pierwill/events{/privacy}", "received_events_url": "https://api.github.com/users/pierwill/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pierwill", "id": 19642016, "node_id": "MDQ6VXNlcjE5NjQyMDE2", "avatar_url": "https://avatars.githubusercontent.com/u/19642016?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pierwill", "html_url": "https://github.com/pierwill", "followers_url": "https://api.github.com/users/pierwill/followers", "following_url": "https://api.github.com/users/pierwill/following{/other_user}", "gists_url": "https://api.github.com/users/pierwill/gists{/gist_id}", "starred_url": "https://api.github.com/users/pierwill/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pierwill/subscriptions", "organizations_url": "https://api.github.com/users/pierwill/orgs", "repos_url": "https://api.github.com/users/pierwill/repos", "events_url": "https://api.github.com/users/pierwill/events{/privacy}", "received_events_url": "https://api.github.com/users/pierwill/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7d7dfba350f13051fd7a409282fcb36094c2a8e9", "url": "https://api.github.com/repos/rust-lang/rust/commits/7d7dfba350f13051fd7a409282fcb36094c2a8e9", "html_url": "https://github.com/rust-lang/rust/commit/7d7dfba350f13051fd7a409282fcb36094c2a8e9"}], "stats": {"total": 133, "additions": 102, "deletions": 31}, "files": [{"sha": "690afe1d458b9f49603e6d040ec7114d341e31ba", "filename": "compiler/rustc_span/src/def_id.rs", "status": "modified", "additions": 14, "deletions": 5, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/535278aa511da21ae091837b89c603ef4aeeb014/compiler%2Frustc_span%2Fsrc%2Fdef_id.rs", "raw_url": "https://github.com/rust-lang/rust/raw/535278aa511da21ae091837b89c603ef4aeeb014/compiler%2Frustc_span%2Fsrc%2Fdef_id.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Fdef_id.rs?ref=535278aa511da21ae091837b89c603ef4aeeb014", "patch": "@@ -126,14 +126,17 @@ impl Borrow<Fingerprint> for DefPathHash {\n     }\n }\n \n-/// A [`StableCrateId`] is a 64 bit hash of the crate name combined with all\n-/// `-Cmetadata` arguments. It is to [`CrateNum`] what [`DefPathHash`] is to\n+/// A [`StableCrateId`] is a 64-bit hash of a crate name, together with all\n+/// `-Cmetadata` arguments, and some other data. It is to [`CrateNum`] what [`DefPathHash`] is to\n /// [`DefId`]. It is stable across compilation sessions.\n ///\n-/// Since the ID is a hash value there is a (very small) chance that two crates\n+/// Since the ID is a hash value, there is a small chance that two crates\n /// end up with the same [`StableCrateId`]. The compiler will check for such\n /// collisions when loading crates and abort compilation in order to avoid\n /// further trouble.\n+///\n+/// See the discussion in [`DefId`] for more information\n+/// on the possibility of hash collisions in rustc,\n #[derive(Copy, Clone, Hash, PartialEq, Eq, PartialOrd, Ord, Debug)]\n #[derive(HashStable_Generic, Encodable, Decodable)]\n pub struct StableCrateId(pub(crate) u64);\n@@ -174,8 +177,14 @@ impl StableCrateId {\n         // Also incorporate the rustc version. Otherwise, with -Zsymbol-mangling-version=v0\n         // and no -Cmetadata, symbols from the same crate compiled with different versions of\n         // rustc are named the same.\n-        let rustc_version = option_env!(\"CFG_VERSION\").unwrap_or(\"unknown version\").as_bytes();\n-        hasher.write(rustc_version);\n+        //\n+        // RUSTC_FORCE_INCR_COMP_ARTIFACT_HEADER is used to inject rustc version information\n+        // during testing.\n+        if let Some(val) = std::env::var_os(\"RUSTC_FORCE_INCR_COMP_ARTIFACT_HEADER\") {\n+            hasher.write(val.to_string_lossy().into_owned().as_bytes())\n+        } else {\n+            hasher.write(option_env!(\"CFG_VERSION\").unwrap_or(\"unknown version\").as_bytes());\n+        }\n \n         StableCrateId(hasher.finish())\n     }"}, {"sha": "fd66702db7f2a1115b9cfd2f0245d0a7ff04ad39", "filename": "src/test/run-make-fulldeps/crate-hash-rustc-version/Makefile", "status": "added", "additions": 37, "deletions": 0, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/535278aa511da21ae091837b89c603ef4aeeb014/src%2Ftest%2Frun-make-fulldeps%2Fcrate-hash-rustc-version%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/535278aa511da21ae091837b89c603ef4aeeb014/src%2Ftest%2Frun-make-fulldeps%2Fcrate-hash-rustc-version%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fcrate-hash-rustc-version%2FMakefile?ref=535278aa511da21ae091837b89c603ef4aeeb014", "patch": "@@ -0,0 +1,37 @@\n+-include ../../run-make-fulldeps/tools.mk\n+\n+# Ensure that crates compiled with different rustc versions cannot\n+# be dynamically linked.\n+\n+FLAGS := -Cprefer-dynamic -Zsymbol-mangling-version=v0\n+UNAME := $(shell uname)\n+ifeq ($(UNAME),Linux)\n+  EXT=\".so\"\n+  NM_CMD := nm -D\n+endif\n+ifeq ($(UNAME),Darwin)\n+  EXT=\".dylib\"\n+  NM_CMD := nm\n+endif\n+\n+ifndef NM_CMD\n+all:\n+\texit 0\n+else\n+all:\n+\t# a.rs is a dylib\n+\t$(RUSTC) a.rs --crate-type=dylib $(FLAGS)\n+\t# Write symbols to disk.\n+\t$(NM_CMD) $(call DYLIB,a) > $(TMPDIR)/symbolsbefore\n+\t# b.rs is a binary\n+\t$(RUSTC) b.rs --extern a=$(TMPDIR)/liba$(EXT) --crate-type=bin -Crpath $(FLAGS)\n+\t$(call RUN,b)\n+\t# Now re-compile a.rs with another rustc version\n+\tRUSTC_FORCE_INCR_COMP_ARTIFACT_HEADER=deadfeed $(RUSTC) a.rs --crate-type=dylib $(FLAGS)\n+\t# After compiling with a different rustc version, write symbols to disk again.\n+\t$(NM_CMD) $(call DYLIB,a) > $(TMPDIR)/symbolsafter\n+\t# As a sanity check, test if the symbols changed:\n+\t# If the symbols are identical, there's been an error.\n+\tif diff $(TMPDIR)/symbolsbefore $(TMPDIR)/symbolsafter; then exit 1; fi\n+\t$(call FAIL,b)\n+endif"}, {"sha": "d65b5ce8e88316052d5847e7bae8e2cbb8253ebb", "filename": "src/test/run-make-fulldeps/crate-hash-rustc-version/a.rs", "status": "added", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/535278aa511da21ae091837b89c603ef4aeeb014/src%2Ftest%2Frun-make-fulldeps%2Fcrate-hash-rustc-version%2Fa.rs", "raw_url": "https://github.com/rust-lang/rust/raw/535278aa511da21ae091837b89c603ef4aeeb014/src%2Ftest%2Frun-make-fulldeps%2Fcrate-hash-rustc-version%2Fa.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fcrate-hash-rustc-version%2Fa.rs?ref=535278aa511da21ae091837b89c603ef4aeeb014", "patch": "@@ -0,0 +1,4 @@\n+pub fn foo(mut x: String) -> String {\n+    x.push_str(\", world!\");\n+    x\n+}"}, {"sha": "316ac26e73fa2fefa2e953fb9b1a4310285bf6ce", "filename": "src/test/run-make-fulldeps/crate-hash-rustc-version/b.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/535278aa511da21ae091837b89c603ef4aeeb014/src%2Ftest%2Frun-make-fulldeps%2Fcrate-hash-rustc-version%2Fb.rs", "raw_url": "https://github.com/rust-lang/rust/raw/535278aa511da21ae091837b89c603ef4aeeb014/src%2Ftest%2Frun-make-fulldeps%2Fcrate-hash-rustc-version%2Fb.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fcrate-hash-rustc-version%2Fb.rs?ref=535278aa511da21ae091837b89c603ef4aeeb014", "patch": "@@ -0,0 +1,8 @@\n+extern crate a;\n+\n+use a::foo;\n+\n+fn main() {\n+    let x = String::from(\"Hello\");\n+    println!(\"{}\", foo(x));\n+}"}, {"sha": "8aa08b8a22c47ba306c7ab02a6e192377ea5b88c", "filename": "src/test/ui/symbol-names/const-generics-demangling.stderr", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/535278aa511da21ae091837b89c603ef4aeeb014/src%2Ftest%2Fui%2Fsymbol-names%2Fconst-generics-demangling.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/535278aa511da21ae091837b89c603ef4aeeb014/src%2Ftest%2Fui%2Fsymbol-names%2Fconst-generics-demangling.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsymbol-names%2Fconst-generics-demangling.stderr?ref=535278aa511da21ae091837b89c603ef4aeeb014", "patch": "@@ -1,4 +1,4 @@\n-error: symbol-name(_RMCsCRATE_HASH_1cINtB0_8UnsignedKhb_E)\n+error: symbol-name(_RMCsCRATE_HASH_1cINtB<REF>_8UnsignedKhb_E)\n   --> $DIR/const-generics-demangling.rs:8:1\n    |\n LL | #[rustc_symbol_name]\n@@ -16,7 +16,7 @@ error: demangling-alt(<c::Unsigned<11>>)\n LL | #[rustc_symbol_name]\n    | ^^^^^^^^^^^^^^^^^^^^\n \n-error: symbol-name(_RMs_CsCRATE_HASH_1cINtB2_6SignedKsn98_E)\n+error: symbol-name(_RMs_CsCRATE_HASH_1cINtB<REF>_6SignedKsn98_E)\n   --> $DIR/const-generics-demangling.rs:16:1\n    |\n LL | #[rustc_symbol_name]\n@@ -34,7 +34,7 @@ error: demangling-alt(<c::Signed<-152>>)\n LL | #[rustc_symbol_name]\n    | ^^^^^^^^^^^^^^^^^^^^\n \n-error: symbol-name(_RMs0_CsCRATE_HASH_1cINtB3_4BoolKb1_E)\n+error: symbol-name(_RMs0_CsCRATE_HASH_1cINtB<REF>_4BoolKb1_E)\n   --> $DIR/const-generics-demangling.rs:24:1\n    |\n LL | #[rustc_symbol_name]\n@@ -52,7 +52,7 @@ error: demangling-alt(<c::Bool<true>>)\n LL | #[rustc_symbol_name]\n    | ^^^^^^^^^^^^^^^^^^^^\n \n-error: symbol-name(_RMs1_CsCRATE_HASH_1cINtB3_4CharKc2202_E)\n+error: symbol-name(_RMs1_CsCRATE_HASH_1cINtB<REF>_4CharKc2202_E)\n   --> $DIR/const-generics-demangling.rs:32:1\n    |\n LL | #[rustc_symbol_name]"}, {"sha": "06d3cdda2f83302ebda92fec4f363d23a314737e", "filename": "src/test/ui/symbol-names/const-generics-str-demangling.stderr", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/535278aa511da21ae091837b89c603ef4aeeb014/src%2Ftest%2Fui%2Fsymbol-names%2Fconst-generics-str-demangling.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/535278aa511da21ae091837b89c603ef4aeeb014/src%2Ftest%2Fui%2Fsymbol-names%2Fconst-generics-str-demangling.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsymbol-names%2Fconst-generics-str-demangling.stderr?ref=535278aa511da21ae091837b89c603ef4aeeb014", "patch": "@@ -1,4 +1,4 @@\n-error: symbol-name(_RMCsCRATE_HASH_1cINtB0_3StrKRe616263_E)\n+error: symbol-name(_RMCsCRATE_HASH_1cINtB<REF>_3StrKRe616263_E)\n   --> $DIR/const-generics-str-demangling.rs:9:1\n    |\n LL | #[rustc_symbol_name]\n@@ -16,7 +16,7 @@ error: demangling-alt(<c::Str<\"abc\">>)\n LL | #[rustc_symbol_name]\n    | ^^^^^^^^^^^^^^^^^^^^\n \n-error: symbol-name(_RMs_CsCRATE_HASH_1cINtB2_3StrKRe27_E)\n+error: symbol-name(_RMs_CsCRATE_HASH_1cINtB<REF>_3StrKRe27_E)\n   --> $DIR/const-generics-str-demangling.rs:15:1\n    |\n LL | #[rustc_symbol_name]\n@@ -34,7 +34,7 @@ error: demangling-alt(<c::Str<\"'\">>)\n LL | #[rustc_symbol_name]\n    | ^^^^^^^^^^^^^^^^^^^^\n \n-error: symbol-name(_RMs0_CsCRATE_HASH_1cINtB3_3StrKRe090a_E)\n+error: symbol-name(_RMs0_CsCRATE_HASH_1cINtB<REF>_3StrKRe090a_E)\n   --> $DIR/const-generics-str-demangling.rs:21:1\n    |\n LL | #[rustc_symbol_name]\n@@ -52,7 +52,7 @@ error: demangling-alt(<c::Str<\"\\t\\n\">>)\n LL | #[rustc_symbol_name]\n    | ^^^^^^^^^^^^^^^^^^^^\n \n-error: symbol-name(_RMs1_CsCRATE_HASH_1cINtB3_3StrKRee28882c3bc_E)\n+error: symbol-name(_RMs1_CsCRATE_HASH_1cINtB<REF>_3StrKRee28882c3bc_E)\n   --> $DIR/const-generics-str-demangling.rs:27:1\n    |\n LL | #[rustc_symbol_name]\n@@ -70,7 +70,7 @@ error: demangling-alt(<c::Str<\"\u2202\u00fc\">>)\n LL | #[rustc_symbol_name]\n    | ^^^^^^^^^^^^^^^^^^^^\n \n-error: symbol-name(_RMs2_CsCRATE_HASH_1cINtB3_3StrKRee183a1e18390e183ade1839be18394e1839ae18390e183935fe18392e18394e1839be183a0e18398e18394e1839ae183985fe183a1e18390e18393e18398e1839ae18398_E)\n+error: symbol-name(_RMs2_CsCRATE_HASH_1cINtB<REF>_3StrKRee183a1e18390e183ade1839be18394e1839ae18390e183935fe18392e18394e1839be183a0e18398e18394e1839ae183985fe183a1e18390e18393e18398e1839ae18398_E)\n   --> $DIR/const-generics-str-demangling.rs:33:1\n    |\n LL | #[rustc_symbol_name]\n@@ -88,7 +88,7 @@ error: demangling-alt(<c::Str<\"\u10e1\u10d0\u10ed\u10db\u10d4\u10da\u10d0\u10d3_\u10d2\u10d4\u10db\u10e0\u10d8\u10d4\u10da\u10d8\n LL | #[rustc_symbol_name]\n    | ^^^^^^^^^^^^^^^^^^^^\n \n-error: symbol-name(_RMs3_CsCRATE_HASH_1cINtB3_3StrKRef09f908af09fa688f09fa686f09f90ae20c2a720f09f90b6f09f9192e29895f09f94a520c2a720f09fa7a1f09f929bf09f929af09f9299f09f929c_E)\n+error: symbol-name(_RMs3_CsCRATE_HASH_1cINtB<REF>_3StrKRef09f908af09fa688f09fa686f09f90ae20c2a720f09f90b6f09f9192e29895f09f94a520c2a720f09fa7a1f09f929bf09f929af09f9299f09f929c_E)\n   --> $DIR/const-generics-str-demangling.rs:39:1\n    |\n LL | #[rustc_symbol_name]"}, {"sha": "a4c997477ee790cc0685bf283e367cc9c1eb1874", "filename": "src/test/ui/symbol-names/const-generics-structural-demangling.stderr", "status": "modified", "additions": 8, "deletions": 8, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/535278aa511da21ae091837b89c603ef4aeeb014/src%2Ftest%2Fui%2Fsymbol-names%2Fconst-generics-structural-demangling.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/535278aa511da21ae091837b89c603ef4aeeb014/src%2Ftest%2Fui%2Fsymbol-names%2Fconst-generics-structural-demangling.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsymbol-names%2Fconst-generics-structural-demangling.stderr?ref=535278aa511da21ae091837b89c603ef4aeeb014", "patch": "@@ -1,4 +1,4 @@\n-error: symbol-name(_RMCsCRATE_HASH_1cINtB0_7RefByteKRh7b_E)\n+error: symbol-name(_RMCsCRATE_HASH_1cINtB<REF>_7RefByteKRh7b_E)\n   --> $DIR/const-generics-structural-demangling.rs:14:1\n    |\n LL | #[rustc_symbol_name]\n@@ -16,7 +16,7 @@ error: demangling-alt(<c::RefByte<{&123}>>)\n LL | #[rustc_symbol_name]\n    | ^^^^^^^^^^^^^^^^^^^^\n \n-error: symbol-name(_RMs_CsCRATE_HASH_1cINtB2_6RefZstKRAEE)\n+error: symbol-name(_RMs_CsCRATE_HASH_1cINtB<REF>_6RefZstKRAEE)\n   --> $DIR/const-generics-structural-demangling.rs:24:1\n    |\n LL | #[rustc_symbol_name]\n@@ -34,7 +34,7 @@ error: demangling-alt(<c::RefZst<{&[]}>>)\n LL | #[rustc_symbol_name]\n    | ^^^^^^^^^^^^^^^^^^^^\n \n-error: symbol-name(_RMs0_CsCRATE_HASH_1cINtB3_11Array3BytesKAh1_h2_h3_EE)\n+error: symbol-name(_RMs0_CsCRATE_HASH_1cINtB<REF>_11Array3BytesKAh1_h2_h3_EE)\n   --> $DIR/const-generics-structural-demangling.rs:32:1\n    |\n LL | #[rustc_symbol_name]\n@@ -52,7 +52,7 @@ error: demangling-alt(<c::Array3Bytes<{[1, 2, 3]}>>)\n LL | #[rustc_symbol_name]\n    | ^^^^^^^^^^^^^^^^^^^^\n \n-error: symbol-name(_RMs1_CsCRATE_HASH_1cINtB3_13TupleByteBoolKTh1_b0_EE)\n+error: symbol-name(_RMs1_CsCRATE_HASH_1cINtB<REF>_13TupleByteBoolKTh1_b0_EE)\n   --> $DIR/const-generics-structural-demangling.rs:40:1\n    |\n LL | #[rustc_symbol_name]\n@@ -70,7 +70,7 @@ error: demangling-alt(<c::TupleByteBool<{(1, false)}>>)\n LL | #[rustc_symbol_name]\n    | ^^^^^^^^^^^^^^^^^^^^\n \n-error: symbol-name(_RMs2_CsCRATE_HASH_1cINtB3_11OptionUsizeKVNtINtNtCsCRATE_HASH_4core6option6OptionjE4NoneUE)\n+error: symbol-name(_RMs2_CsCRATE_HASH_1cINtB<REF>_11OptionUsizeKVNtINtNtCsCRATE_HASH_4core6option6OptionjE4NoneUE)\n   --> $DIR/const-generics-structural-demangling.rs:50:1\n    |\n LL | #[rustc_symbol_name]\n@@ -88,7 +88,7 @@ error: demangling-alt(<c::OptionUsize<{core::option::Option::<usize>::None}>>)\n LL | #[rustc_symbol_name]\n    | ^^^^^^^^^^^^^^^^^^^^\n \n-error: symbol-name(_RMs3_CsCRATE_HASH_1cINtB3_11OptionUsizeKVNtINtNtCsCRATE_HASH_4core6option6OptionjE4SomeTj0_EE)\n+error: symbol-name(_RMs3_CsCRATE_HASH_1cINtB<REF>_11OptionUsizeKVNtINtNtCsCRATE_HASH_4core6option6OptionjE4SomeTj0_EE)\n   --> $DIR/const-generics-structural-demangling.rs:58:1\n    |\n LL | #[rustc_symbol_name]\n@@ -106,7 +106,7 @@ error: demangling-alt(<c::OptionUsize<{core::option::Option::<usize>::Some(0)}>>\n LL | #[rustc_symbol_name]\n    | ^^^^^^^^^^^^^^^^^^^^\n \n-error: symbol-name(_RMs4_CsCRATE_HASH_1cINtB3_4Foo_KVNtB3_3FooS1sRe616263_2chc78_5sliceRAh1_h2_h3_EEE)\n+error: symbol-name(_RMs4_CsCRATE_HASH_1cINtB<REF>_4Foo_KVNtB<REF>_3FooS1sRe616263_2chc78_5sliceRAh1_h2_h3_EEE)\n   --> $DIR/const-generics-structural-demangling.rs:72:1\n    |\n LL | #[rustc_symbol_name]\n@@ -124,7 +124,7 @@ error: demangling-alt(<c::Foo_<{c::Foo { s: \"abc\", ch: 'x', slice: &[1, 2, 3] }}\n LL | #[rustc_symbol_name]\n    | ^^^^^^^^^^^^^^^^^^^^\n \n-error: symbol-name(_RMs9_CsCRATE_HASH_1cINtB3_4Bar_KVNtB3_3BarS1xh7b_s_1xt1000_EE)\n+error: symbol-name(_RMs9_CsCRATE_HASH_1cINtB<REF>_4Bar_KVNtB<REF>_3BarS1xh7b_s_1xt1000_EE)\n   --> $DIR/const-generics-structural-demangling.rs:88:5\n    |\n LL |     #[rustc_symbol_name]"}, {"sha": "06778e57fb116595745817018a716f87b99b4294", "filename": "src/test/ui/symbol-names/impl1.v0.stderr", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/535278aa511da21ae091837b89c603ef4aeeb014/src%2Ftest%2Fui%2Fsymbol-names%2Fimpl1.v0.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/535278aa511da21ae091837b89c603ef4aeeb014/src%2Ftest%2Fui%2Fsymbol-names%2Fimpl1.v0.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsymbol-names%2Fimpl1.v0.stderr?ref=535278aa511da21ae091837b89c603ef4aeeb014", "patch": "@@ -1,4 +1,4 @@\n-error: symbol-name(_RNvMNtCsCRATE_HASH_5impl13fooNtB2_3Foo3bar)\n+error: symbol-name(_RNvMNtCsCRATE_HASH_5impl13fooNtB<REF>_3Foo3bar)\n   --> $DIR/impl1.rs:14:9\n    |\n LL |         #[rustc_symbol_name]\n@@ -22,7 +22,7 @@ error: def-path(foo::Foo::bar)\n LL |         #[rustc_def_path]\n    |         ^^^^^^^^^^^^^^^^^\n \n-error: symbol-name(_RNvMNtCsCRATE_HASH_5impl13barNtNtB4_3foo3Foo3baz)\n+error: symbol-name(_RNvMNtCsCRATE_HASH_5impl13barNtNtB<REF>_3foo3Foo3baz)\n   --> $DIR/impl1.rs:32:9\n    |\n LL |         #[rustc_symbol_name]\n@@ -46,7 +46,7 @@ error: def-path(bar::<impl foo::Foo>::baz)\n LL |         #[rustc_def_path]\n    |         ^^^^^^^^^^^^^^^^^\n \n-error: symbol-name(_RNvXNCNvCsCRATE_HASH_5impl14mains_0ARDNtB6_3Foop5AssocFG_KCRL0_hvEuNtB6_9AutoTraitEL_j3_NtB2_3Bar6method)\n+error: symbol-name(_RNvXNCNvCsCRATE_HASH_5impl14mains_0ARDNtB<REF>_3Foop5AssocFG_KCRL0_hvEuNtB<REF>_9AutoTraitEL_j3_NtB<REF>_3Bar6method)\n   --> $DIR/impl1.rs:62:13\n    |\n LL |             #[rustc_symbol_name]"}, {"sha": "1cddba920854fb41d4c3d6dca130e9635c91e85e", "filename": "src/test/ui/symbol-names/issue-60925.v0.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/535278aa511da21ae091837b89c603ef4aeeb014/src%2Ftest%2Fui%2Fsymbol-names%2Fissue-60925.v0.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/535278aa511da21ae091837b89c603ef4aeeb014/src%2Ftest%2Fui%2Fsymbol-names%2Fissue-60925.v0.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsymbol-names%2Fissue-60925.v0.stderr?ref=535278aa511da21ae091837b89c603ef4aeeb014", "patch": "@@ -1,4 +1,4 @@\n-error: symbol-name(_RNvMNtCsCRATE_HASH_11issue_609253fooINtB2_3FooNtNtB4_4llvm3FooE3foo)\n+error: symbol-name(_RNvMNtCsCRATE_HASH_11issue_609253fooINtB<REF>_3FooNtNtB<REF>_4llvm3FooE3foo)\n   --> $DIR/issue-60925.rs:21:9\n    |\n LL |         #[rustc_symbol_name]"}, {"sha": "446fb8d6cf6f17437fe6cd394f19d3d98f32916b", "filename": "src/test/ui/symbol-names/issue-75326.v0.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/535278aa511da21ae091837b89c603ef4aeeb014/src%2Ftest%2Fui%2Fsymbol-names%2Fissue-75326.v0.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/535278aa511da21ae091837b89c603ef4aeeb014/src%2Ftest%2Fui%2Fsymbol-names%2Fissue-75326.v0.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsymbol-names%2Fissue-75326.v0.stderr?ref=535278aa511da21ae091837b89c603ef4aeeb014", "patch": "@@ -1,4 +1,4 @@\n-error: symbol-name(_RNvXINICsCRATE_HASH_11issue_75326s_0pppEINtB5_3FooppENtB5_9Iterator24nextB5_)\n+error: symbol-name(_RNvXINICsCRATE_HASH_11issue_75326s_0pppEINtB<REF>_3FooppENtB<REF>_9Iterator24nextB<REF>_)\n   --> $DIR/issue-75326.rs:41:5\n    |\n LL |     #[rustc_symbol_name]"}, {"sha": "6c5e55ed2aeabf9570d883838920e732c0285627", "filename": "src/test/ui/symbol-names/trait-objects.v0.stderr", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/535278aa511da21ae091837b89c603ef4aeeb014/src%2Ftest%2Fui%2Fsymbol-names%2Ftrait-objects.v0.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/535278aa511da21ae091837b89c603ef4aeeb014/src%2Ftest%2Fui%2Fsymbol-names%2Ftrait-objects.v0.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsymbol-names%2Ftrait-objects.v0.stderr?ref=535278aa511da21ae091837b89c603ef4aeeb014", "patch": "@@ -1,4 +1,4 @@\n-error: symbol-name(_RNvXCsCRATE_HASH_13trait_objectsRDG_INtNtNtCsCRATE_HASH_4core3ops8function5FnMutTRL0_hEEp6OutputuEL_NtB2_3Bar6method)\n+error: symbol-name(_RNvXCsCRATE_HASH_13trait_objectsRDG_INtNtNtCsCRATE_HASH_4core3ops8function5FnMutTRL0_hEEp6OutputuEL_NtB<REF>_3Bar6method)\n   --> $DIR/trait-objects.rs:15:5\n    |\n LL |     #[rustc_symbol_name]\n@@ -16,7 +16,7 @@ error: demangling-alt(<&dyn for<'a> core::ops::function::FnMut<(&'a u8,), Output\n LL |     #[rustc_symbol_name]\n    |     ^^^^^^^^^^^^^^^^^^^^\n \n-error: symbol-name(_RNvXs_CsCRATE_HASH_13trait_objectsRDG_INtNtNtCsCRATE_HASH_4core3ops8function5FnMutTRL0_hEEp6OutputuNtNtBI_6marker4SendEL_NtB4_3Foo6method)\n+error: symbol-name(_RNvXs_CsCRATE_HASH_13trait_objectsRDG_INtNtNtCsCRATE_HASH_4core3ops8function5FnMutTRL0_hEEp6OutputuNtNtB<REF>_6marker4SendEL_NtB<REF>_3Foo6method)\n   --> $DIR/trait-objects.rs:27:5\n    |\n LL |     #[rustc_symbol_name]\n@@ -34,7 +34,7 @@ error: demangling-alt(<&dyn for<'a> core::ops::function::FnMut<(&'a u8,), Output\n LL |     #[rustc_symbol_name]\n    |     ^^^^^^^^^^^^^^^^^^^^\n \n-error: symbol-name(_RNvXs0_CsCRATE_HASH_13trait_objectsRDG_INtNtNtCsCRATE_HASH_4core3ops8function5FnMutTRL0_hEEp6OutputuNtNtBJ_6marker4SendEL_NtB5_3Baz6method)\n+error: symbol-name(_RNvXs0_CsCRATE_HASH_13trait_objectsRDG_INtNtNtCsCRATE_HASH_4core3ops8function5FnMutTRL0_hEEp6OutputuNtNtB<REF>_6marker4SendEL_NtB<REF>_3Baz6method)\n   --> $DIR/trait-objects.rs:39:5\n    |\n LL |     #[rustc_symbol_name]"}, {"sha": "f039ba59d231cdba12fd6d6fd1d344ad29e00aad", "filename": "src/tools/compiletest/src/runtest.rs", "status": "modified", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/535278aa511da21ae091837b89c603ef4aeeb014/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/535278aa511da21ae091837b89c603ef4aeeb014/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs?ref=535278aa511da21ae091837b89c603ef4aeeb014", "patch": "@@ -3513,6 +3513,9 @@ impl<'test> TestCx<'test> {\n         const V0_CRATE_HASH_PREFIX_REGEX: &str = r\"_R.*?Cs[0-9a-zA-Z]+_\";\n         const V0_CRATE_HASH_REGEX: &str = r\"Cs[0-9a-zA-Z]+_\";\n         const V0_CRATE_HASH_PLACEHOLDER: &str = r\"CsCRATE_HASH_\";\n+        const V0_BACK_REF_PREFIX_REGEX: &str = r\"\\(_R.*?B[0-9a-zA-Z]_\";\n+        const V0_BACK_REF_REGEX: &str = r\"B[0-9a-zA-Z]_\";\n+        const V0_BACK_REF_PLACEHOLDER: &str = r\"B<REF>_\";\n         const LEGACY_SYMBOL_HASH_REGEX: &str = r\"h[\\w]{16}E?\\)\";\n         const LEGACY_SYMBOL_HASH_PLACEHOLDER: &str = r\"h<SYMBOL_HASH>)\";\n         let test_name = self\n@@ -3547,6 +3550,16 @@ impl<'test> TestCx<'test> {\n                 .replace_all(&normalized, V0_CRATE_HASH_PLACEHOLDER)\n                 .into_owned();\n         }\n+        let back_ref_prefix_re = Regex::new(V0_BACK_REF_PREFIX_REGEX).unwrap();\n+        if back_ref_prefix_re.is_match(&normalized) {\n+            // Normalize back references (see RFC 2603)\n+            let back_ref_regex = format!(\"{}\", V0_BACK_REF_REGEX);\n+            let back_ref_placeholder = format!(\"{}\", V0_BACK_REF_PLACEHOLDER);\n+            normalized = Regex::new(&back_ref_regex)\n+                .unwrap()\n+                .replace_all(&normalized, back_ref_placeholder)\n+                .into_owned();\n+        }\n         // Normalize legacy mangled symbols\n         normalized = Regex::new(LEGACY_SYMBOL_HASH_REGEX)\n             .unwrap()"}]}