{"sha": "46cce4f8f1b71458029ebfd391c37e27cc6c5c9c", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQ2Y2NlNGY4ZjFiNzE0NTgwMjllYmZkMzkxYzM3ZTI3Y2M2YzVjOWM=", "commit": {"author": {"name": "bors[bot]", "email": "bors[bot]@users.noreply.github.com", "date": "2018-10-30T18:32:24Z"}, "committer": {"name": "bors[bot]", "email": "bors[bot]@users.noreply.github.com", "date": "2018-10-30T18:32:24Z"}, "message": "Merge #169\n\n169: Syntax ptr r=matklad a=matklad\n\n\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>", "tree": {"sha": "95344947f1957d03edcbcd6ef8a2786cc1b9142d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/95344947f1957d03edcbcd6ef8a2786cc1b9142d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/46cce4f8f1b71458029ebfd391c37e27cc6c5c9c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/46cce4f8f1b71458029ebfd391c37e27cc6c5c9c", "html_url": "https://github.com/rust-lang/rust/commit/46cce4f8f1b71458029ebfd391c37e27cc6c5c9c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/46cce4f8f1b71458029ebfd391c37e27cc6c5c9c/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "parents": [{"sha": "bc4de7128f474f75a9eff6591923657025099b74", "url": "https://api.github.com/repos/rust-lang/rust/commits/bc4de7128f474f75a9eff6591923657025099b74", "html_url": "https://github.com/rust-lang/rust/commit/bc4de7128f474f75a9eff6591923657025099b74"}, {"sha": "1643d94a65a66f32b9278829dd3af00883f3852b", "url": "https://api.github.com/repos/rust-lang/rust/commits/1643d94a65a66f32b9278829dd3af00883f3852b", "html_url": "https://github.com/rust-lang/rust/commit/1643d94a65a66f32b9278829dd3af00883f3852b"}], "stats": {"total": 94, "additions": 79, "deletions": 15}, "files": [{"sha": "88c7ba356c177db719d04685b9456901a3b3e75b", "filename": "Cargo.lock", "status": "modified", "additions": 6, "deletions": 5, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/46cce4f8f1b71458029ebfd391c37e27cc6c5c9c/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/46cce4f8f1b71458029ebfd391c37e27cc6c5c9c/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=46cce4f8f1b71458029ebfd391c37e27cc6c5c9c", "patch": "@@ -661,7 +661,7 @@ dependencies = [\n  \"serde_json 1.0.32 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"smol_str 0.1.7 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"tempdir 0.3.7 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"text_unit 0.1.4 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"text_unit 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"url_serde 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"walkdir 2.2.5 (registry+https://github.com/rust-lang/crates.io-index)\",\n ]\n@@ -675,6 +675,7 @@ dependencies = [\n  \"parking_lot 0.6.4 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"rowan 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"test_utils 0.1.0\",\n+ \"text_unit 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"unicode-xid 0.1.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"walkdir 2.2.5 (registry+https://github.com/rust-lang/crates.io-index)\",\n ]\n@@ -798,7 +799,7 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n dependencies = [\n  \"parking_lot 0.6.4 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"smol_str 0.1.7 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"text_unit 0.1.4 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"text_unit 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)\",\n ]\n \n [[package]]\n@@ -1038,12 +1039,12 @@ version = \"0.1.0\"\n dependencies = [\n  \"difference 2.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"itertools 0.7.8 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"text_unit 0.1.4 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"text_unit 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)\",\n ]\n \n [[package]]\n name = \"text_unit\"\n-version = \"0.1.4\"\n+version = \"0.1.5\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n dependencies = [\n  \"serde 1.0.80 (registry+https://github.com/rust-lang/crates.io-index)\",\n@@ -1372,7 +1373,7 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n \"checksum tera 0.11.18 (registry+https://github.com/rust-lang/crates.io-index)\" = \"6c87cae42cc4fc480278c7583792cc5da2d51a25be916b7921cbb45c43063b8d\"\n \"checksum teraron 0.0.1 (registry+https://github.com/rust-lang/crates.io-index)\" = \"0d89ad4617d1dec55331067fadaa041e813479e1779616f3d3ce9308bf46184e\"\n \"checksum termion 1.5.1 (registry+https://github.com/rust-lang/crates.io-index)\" = \"689a3bdfaab439fd92bc87df5c4c78417d3cbe537487274e9b0b2dce76e92096\"\n-\"checksum text_unit 0.1.4 (registry+https://github.com/rust-lang/crates.io-index)\" = \"93fc86da66d0b9aa8d359b0ec31b4342c6bc52637eadef05b91b098551a9f8e9\"\n+\"checksum text_unit 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)\" = \"8009d7bdbd896a7e09b595f8f9325a19047fc708653e60d0895202b82135048f\"\n \"checksum textwrap 0.10.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"307686869c93e71f94da64286f9a9524c0f308a9e1c87a583de8e9c9039ad3f6\"\n \"checksum thread_local 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)\" = \"c6b53e329000edc2b34dbe8545fd20e55a333362d0a321909685a19bd28c3f1b\"\n \"checksum time 0.1.40 (registry+https://github.com/rust-lang/crates.io-index)\" = \"d825be0eb33fda1a7e68012d51e9c7f451dc1a69391e7fdc197060bb8c56667b\""}, {"sha": "0220f7d5d3086578cfe87b89f73d5801b31807ce", "filename": "crates/ra_analysis/src/descriptors/mod.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/46cce4f8f1b71458029ebfd391c37e27cc6c5c9c/crates%2Fra_analysis%2Fsrc%2Fdescriptors%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/46cce4f8f1b71458029ebfd391c37e27cc6c5c9c/crates%2Fra_analysis%2Fsrc%2Fdescriptors%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_analysis%2Fsrc%2Fdescriptors%2Fmod.rs?ref=46cce4f8f1b71458029ebfd391c37e27cc6c5c9c", "patch": "@@ -2,7 +2,6 @@ pub(crate) mod module;\n \n use ra_syntax::{\n     ast::{self, AstNode, NameOwner},\n-    text_utils::is_subrange,\n };\n \n #[derive(Debug, Clone)]\n@@ -23,7 +22,7 @@ impl FnDescriptor {\n             let label: String = node\n                 .syntax()\n                 .children()\n-                .filter(|child| !is_subrange(body_range, child.range()))\n+                .filter(|child| !child.range().is_subrange(&body_range))\n                 .map(|node| node.text().to_string())\n                 .collect();\n             label"}, {"sha": "363c72c0b774631df822b80cd305d3deae2b057b", "filename": "crates/ra_analysis/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/46cce4f8f1b71458029ebfd391c37e27cc6c5c9c/crates%2Fra_analysis%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/46cce4f8f1b71458029ebfd391c37e27cc6c5c9c/crates%2Fra_analysis%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_analysis%2Fsrc%2Flib.rs?ref=46cce4f8f1b71458029ebfd391c37e27cc6c5c9c", "patch": "@@ -12,6 +12,7 @@ mod descriptors;\n mod imp;\n mod symbol_index;\n mod completion;\n+mod syntax_ptr;\n \n use std::{\n     fmt,"}, {"sha": "863ad2672bf85c9b2c31ae49f384450aa14cfb89", "filename": "crates/ra_analysis/src/syntax_ptr.rs", "status": "added", "additions": 67, "deletions": 0, "changes": 67, "blob_url": "https://github.com/rust-lang/rust/blob/46cce4f8f1b71458029ebfd391c37e27cc6c5c9c/crates%2Fra_analysis%2Fsrc%2Fsyntax_ptr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/46cce4f8f1b71458029ebfd391c37e27cc6c5c9c/crates%2Fra_analysis%2Fsrc%2Fsyntax_ptr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_analysis%2Fsrc%2Fsyntax_ptr.rs?ref=46cce4f8f1b71458029ebfd391c37e27cc6c5c9c", "patch": "@@ -0,0 +1,67 @@\n+use ra_syntax::{\n+    File, TextRange, SyntaxKind, SyntaxNode, SyntaxNodeRef,\n+    ast::{self, AstNode},\n+};\n+\n+use crate::FileId;\n+use crate::db::SyntaxDatabase;\n+\n+/// SyntaxPtr is a cheap `Copy` id which identifies a particular syntax node,\n+/// without retainig syntax tree in memory. You need to explicitelly `resovle`\n+/// `SyntaxPtr` to get a `SyntaxNode`\n+#[derive(Debug, Clone, Copy, PartialEq, Eq)]\n+pub(crate) struct SyntaxPtr {\n+    file_id: FileId,\n+    local: LocalSyntaxPtr,\n+}\n+\n+impl SyntaxPtr {\n+    pub(crate) fn new(file_id: FileId, node: SyntaxNodeRef) -> SyntaxPtr {\n+        let local = LocalSyntaxPtr::new(node);\n+        SyntaxPtr { file_id, local }\n+    }\n+\n+    pub(crate) fn resolve(self, db: &impl SyntaxDatabase) -> SyntaxNode {\n+        let syntax = db.file_syntax(self.file_id);\n+        self.local.resolve(&syntax)\n+    }\n+}\n+\n+\n+/// A pionter to a syntax node inside a file.\n+#[derive(Debug, Clone, Copy, PartialEq, Eq)]\n+struct LocalSyntaxPtr {\n+    range: TextRange,\n+    kind: SyntaxKind,\n+}\n+\n+impl LocalSyntaxPtr {\n+    fn new(node: SyntaxNodeRef) -> LocalSyntaxPtr {\n+        LocalSyntaxPtr {\n+            range: node.range(),\n+            kind: node.kind(),\n+        }\n+    }\n+\n+    fn resolve(self, file: &File) -> SyntaxNode {\n+        let mut curr = file.syntax();\n+        loop {\n+            if curr.range() == self.range && curr.kind() == self.kind {\n+                return curr.owned();\n+            }\n+            curr = curr.children()\n+                .find(|it| self.range.is_subrange(&it.range()))\n+                .unwrap_or_else(|| panic!(\"can't resovle local ptr to SyntaxNode: {:?}\", self))\n+        }\n+    }\n+}\n+\n+\n+#[test]\n+fn test_local_syntax_ptr() {\n+    let file = File::parse(\"struct Foo { f: u32, }\");\n+    let field = file.syntax().descendants().find_map(ast::NamedFieldDef::cast).unwrap();\n+    let ptr = LocalSyntaxPtr::new(field.syntax());\n+    let field_syntax = ptr.resolve(&file);\n+    assert_eq!(field.syntax(), field_syntax);\n+}"}, {"sha": "a0b168bc6da69a2df745a64314171cc0eae0890f", "filename": "crates/ra_editor/src/completion.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/46cce4f8f1b71458029ebfd391c37e27cc6c5c9c/crates%2Fra_editor%2Fsrc%2Fcompletion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/46cce4f8f1b71458029ebfd391c37e27cc6c5c9c/crates%2Fra_editor%2Fsrc%2Fcompletion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_editor%2Fsrc%2Fcompletion.rs?ref=46cce4f8f1b71458029ebfd391c37e27cc6c5c9c", "patch": "@@ -3,7 +3,6 @@ use rustc_hash::{FxHashMap, FxHashSet};\n use ra_syntax::{\n     algo::visit::{visitor, visitor_ctx, Visitor, VisitorCtx},\n     ast::{self, AstChildren, LoopBodyOwner, ModuleItemOwner},\n-    text_utils::is_subrange,\n     AstNode, File,\n     SyntaxKind::*,\n     SyntaxNodeRef, TextUnit,\n@@ -191,7 +190,7 @@ fn is_in_loop_body(name_ref: ast::NameRef) -> bool {\n             .visit::<ast::LoopExpr, _>(LoopBodyOwner::loop_body)\n             .accept(node);\n         if let Some(Some(body)) = loop_body {\n-            if is_subrange(body.syntax().range(), name_ref.syntax().range()) {\n+            if name_ref.syntax().range().is_subrange(&body.syntax().range()) {\n                 return true;\n             }\n         }"}, {"sha": "043c9bacd85f1e11999bfbac6438cd93f1268bcf", "filename": "crates/ra_syntax/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/46cce4f8f1b71458029ebfd391c37e27cc6c5c9c/crates%2Fra_syntax%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/46cce4f8f1b71458029ebfd391c37e27cc6c5c9c/crates%2Fra_syntax%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_syntax%2FCargo.toml?ref=46cce4f8f1b71458029ebfd391c37e27cc6c5c9c", "patch": "@@ -11,6 +11,7 @@ itertools = \"0.7.8\"\n drop_bomb = \"0.1.4\"\n parking_lot = \"0.6.0\"\n rowan = \"0.1.1\"\n+text_unit = \"0.1.5\"\n \n [dev-dependencies]\n test_utils = { path = \"../test_utils\" }"}, {"sha": "f92529d3ee4800e8df588a61e9857ec1775cc862", "filename": "crates/ra_syntax/src/algo/mod.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/46cce4f8f1b71458029ebfd391c37e27cc6c5c9c/crates%2Fra_syntax%2Fsrc%2Falgo%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/46cce4f8f1b71458029ebfd391c37e27cc6c5c9c/crates%2Fra_syntax%2Fsrc%2Falgo%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_syntax%2Fsrc%2Falgo%2Fmod.rs?ref=46cce4f8f1b71458029ebfd391c37e27cc6c5c9c", "patch": "@@ -2,7 +2,7 @@ pub mod visit;\n // pub mod walk;\n \n use crate::{\n-    text_utils::{contains_offset_nonstrict, is_subrange},\n+    text_utils::{contains_offset_nonstrict},\n     SyntaxNodeRef, TextRange, TextUnit,\n };\n \n@@ -91,7 +91,7 @@ impl<'f> Iterator for LeafAtOffset<'f> {\n \n pub fn find_covering_node(root: SyntaxNodeRef, range: TextRange) -> SyntaxNodeRef {\n     assert!(\n-        is_subrange(root.range(), range),\n+        range.is_subrange(&root.range()),\n         \"node range: {:?}, target range: {:?}\",\n         root.range(),\n         range,"}, {"sha": "a90f8a083d674823b7a2606b3b0f194ca843e7ca", "filename": "crates/ra_syntax/src/text_utils.rs", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/46cce4f8f1b71458029ebfd391c37e27cc6c5c9c/crates%2Fra_syntax%2Fsrc%2Ftext_utils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/46cce4f8f1b71458029ebfd391c37e27cc6c5c9c/crates%2Fra_syntax%2Fsrc%2Ftext_utils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_syntax%2Fsrc%2Ftext_utils.rs?ref=46cce4f8f1b71458029ebfd391c37e27cc6c5c9c", "patch": "@@ -4,10 +4,6 @@ pub fn contains_offset_nonstrict(range: TextRange, offset: TextUnit) -> bool {\n     range.start() <= offset && offset <= range.end()\n }\n \n-pub fn is_subrange(range: TextRange, subrange: TextRange) -> bool {\n-    range.start() <= subrange.start() && subrange.end() <= range.end()\n-}\n-\n pub fn intersect(r1: TextRange, r2: TextRange) -> Option<TextRange> {\n     let start = r1.start().max(r2.start());\n     let end = r1.end().min(r2.end());"}]}