{"sha": "f02439dea78e5c2df42198c7a03e2db6002ff263", "node_id": "C_kwDOAAsO6NoAKGYwMjQzOWRlYTc4ZTVjMmRmNDIxOThjN2EwM2UyZGI2MDAyZmYyNjM", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-02-03T01:19:04Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-02-03T01:19:04Z"}, "message": "Auto merge of #107241 - clubby789:bootstrap-lto-off, r=simulacrum\n\nAdd `rust.lto=off` to bootstrap and set as compiler/library default\n\nCloses #107202\n\nThe issue mentions `embed-bitcode=on`, but here https://github.com/rust-lang/rust/blob/c8e6a9e8b6251bbc8276cb78cabe1998deecbed7/src/bootstrap/compile.rs#L379-L381\nit appears that this is always set for std stage 1+, so I'm unsure if changes are needed here.\n\n`@rustbot` label +A-bootstrap", "tree": {"sha": "ba934c044e040c794ecaf64c5d0ddea604210a5c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ba934c044e040c794ecaf64c5d0ddea604210a5c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f02439dea78e5c2df42198c7a03e2db6002ff263", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f02439dea78e5c2df42198c7a03e2db6002ff263", "html_url": "https://github.com/rust-lang/rust/commit/f02439dea78e5c2df42198c7a03e2db6002ff263", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f02439dea78e5c2df42198c7a03e2db6002ff263/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6c991b07403a3234dd1ec0ac973b8ef97055e605", "url": "https://api.github.com/repos/rust-lang/rust/commits/6c991b07403a3234dd1ec0ac973b8ef97055e605", "html_url": "https://github.com/rust-lang/rust/commit/6c991b07403a3234dd1ec0ac973b8ef97055e605"}, {"sha": "2adf26fc72f354aabd65da176eb9f8806b0d2ef2", "url": "https://api.github.com/repos/rust-lang/rust/commits/2adf26fc72f354aabd65da176eb9f8806b0d2ef2", "html_url": "https://github.com/rust-lang/rust/commit/2adf26fc72f354aabd65da176eb9f8806b0d2ef2"}], "stats": {"total": 21, "additions": 19, "deletions": 2}, "files": [{"sha": "df4478bb0cb85ac75cfb31fbc78349d30fcfa96b", "filename": "config.toml.example", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/f02439dea78e5c2df42198c7a03e2db6002ff263/config.toml.example", "raw_url": "https://github.com/rust-lang/rust/raw/f02439dea78e5c2df42198c7a03e2db6002ff263/config.toml.example", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/config.toml.example?ref=f02439dea78e5c2df42198c7a03e2db6002ff263", "patch": "@@ -662,7 +662,8 @@ changelog-seen = 2\n \n # Select LTO mode that will be used for compiling rustc. By default, thin local LTO\n # (LTO within a single crate) is used (like for any Rust crate). You can also select\n-# \"thin\" or \"fat\" to apply Thin/Fat LTO to the `rustc_driver` dylib.\n+# \"thin\" or \"fat\" to apply Thin/Fat LTO to the `rustc_driver` dylib, or \"off\" to disable\n+# LTO entirely.\n #lto = \"thin-local\"\n \n # ============================================================================="}, {"sha": "07c0d2233caeb29f8a74d03a5963e25dafdcc8c0", "filename": "src/bootstrap/compile.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/f02439dea78e5c2df42198c7a03e2db6002ff263/src%2Fbootstrap%2Fcompile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f02439dea78e5c2df42198c7a03e2db6002ff263/src%2Fbootstrap%2Fcompile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcompile.rs?ref=f02439dea78e5c2df42198c7a03e2db6002ff263", "patch": "@@ -379,6 +379,9 @@ pub fn std_cargo(builder: &Builder<'_>, target: TargetSelection, stage: u32, car\n     if stage >= 1 {\n         cargo.rustflag(\"-Cembed-bitcode=yes\");\n     }\n+    if builder.config.rust_lto == RustcLto::Off {\n+        cargo.rustflag(\"-Clto=off\");\n+    }\n \n     // By default, rustc does not include unwind tables unless they are required\n     // for a particular target. They are not required by RISC-V targets, but\n@@ -722,6 +725,13 @@ impl Step for Rustc {\n                     cargo.rustflag(\"-Cembed-bitcode=yes\");\n                 }\n                 RustcLto::ThinLocal => { /* Do nothing, this is the default */ }\n+                RustcLto::Off => {\n+                    cargo.rustflag(\"-Clto=off\");\n+                }\n+            }\n+        } else {\n+            if builder.config.rust_lto == RustcLto::Off {\n+                cargo.rustflag(\"-Clto=off\");\n             }\n         }\n "}, {"sha": "e5fad538969711ce0516fe242b9cbd5e654d3c34", "filename": "src/bootstrap/config.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f02439dea78e5c2df42198c7a03e2db6002ff263/src%2Fbootstrap%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f02439dea78e5c2df42198c7a03e2db6002ff263/src%2Fbootstrap%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fconfig.rs?ref=f02439dea78e5c2df42198c7a03e2db6002ff263", "patch": "@@ -333,8 +333,9 @@ impl SplitDebuginfo {\n }\n \n /// LTO mode used for compiling rustc itself.\n-#[derive(Default, Clone)]\n+#[derive(Default, Clone, PartialEq)]\n pub enum RustcLto {\n+    Off,\n     #[default]\n     ThinLocal,\n     Thin,\n@@ -349,6 +350,7 @@ impl std::str::FromStr for RustcLto {\n             \"thin-local\" => Ok(RustcLto::ThinLocal),\n             \"thin\" => Ok(RustcLto::Thin),\n             \"fat\" => Ok(RustcLto::Fat),\n+            \"off\" => Ok(RustcLto::Off),\n             _ => Err(format!(\"Invalid value for rustc LTO: {}\", s)),\n         }\n     }"}, {"sha": "b98b13119e8ad56b8c44c73ba4c5e26020ebff20", "filename": "src/bootstrap/defaults/config.compiler.toml", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f02439dea78e5c2df42198c7a03e2db6002ff263/src%2Fbootstrap%2Fdefaults%2Fconfig.compiler.toml", "raw_url": "https://github.com/rust-lang/rust/raw/f02439dea78e5c2df42198c7a03e2db6002ff263/src%2Fbootstrap%2Fdefaults%2Fconfig.compiler.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fdefaults%2Fconfig.compiler.toml?ref=f02439dea78e5c2df42198c7a03e2db6002ff263", "patch": "@@ -12,6 +12,8 @@ debug-logging = true\n incremental = true\n # Print backtrace on internal compiler errors during bootstrap\n backtrace-on-ice = true\n+# Make the compiler and standard library faster to build, at the expense of a ~20% runtime slowdown.\n+lto = \"off\"\n \n [llvm]\n # Will download LLVM from CI if available on your platform."}, {"sha": "f362c4111f107f99c8d6ee14b2dd559d4e11a6a0", "filename": "src/bootstrap/defaults/config.library.toml", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f02439dea78e5c2df42198c7a03e2db6002ff263/src%2Fbootstrap%2Fdefaults%2Fconfig.library.toml", "raw_url": "https://github.com/rust-lang/rust/raw/f02439dea78e5c2df42198c7a03e2db6002ff263/src%2Fbootstrap%2Fdefaults%2Fconfig.library.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fdefaults%2Fconfig.library.toml?ref=f02439dea78e5c2df42198c7a03e2db6002ff263", "patch": "@@ -8,6 +8,8 @@ bench-stage = 0\n [rust]\n # This greatly increases the speed of rebuilds, especially when there are only minor changes. However, it makes the initial build slightly slower.\n incremental = true\n+# Make the compiler and standard library faster to build, at the expense of a ~20% runtime slowdown.\n+lto = \"off\"\n \n [llvm]\n # Will download LLVM from CI if available on your platform."}]}