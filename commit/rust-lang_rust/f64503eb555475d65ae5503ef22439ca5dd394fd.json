{"sha": "f64503eb555475d65ae5503ef22439ca5dd394fd", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY2NDUwM2ViNTU1NDc1ZDY1YWU1NTAzZWYyMjQzOWNhNWRkMzk0ZmQ=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-05-23T19:42:19Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-05-23T19:42:19Z"}, "message": "Auto merge of #85554 - 12101111:fix-dedup-native-libs, r=petrochenkov\n\nnative lib: defer the duplicate check after relevant_lib check.\n\nhttps://github.com/rust-lang/rust/pull/84794 break code using conditional-compilation with `#[link]` attributes.\n\n```rust\n#[cfg(target_env = \"musl\")]\ncfg_if::cfg_if! {\n    if #[cfg(any(target_feature = \"crt-static\", feature = \"llvm-libunwind\"))] {\n        #[link(name = \"unwind\", kind = \"static\", modifiers = \"-bundle\")]\n        extern \"C\" {}\n    } else {\n        #[link(name = \"unwind\", cfg(feature = \"system-llvm-libunwind\"))]\n        #[link(name = \"gcc_s\", cfg(not(feature = \"system-llvm-libunwind\")))]\n        extern \"C\" {}\n    }\n}\n\n```", "tree": {"sha": "4caa83f52b8b3fd06eb95779bbc90ad87cc88f8e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4caa83f52b8b3fd06eb95779bbc90ad87cc88f8e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f64503eb555475d65ae5503ef22439ca5dd394fd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f64503eb555475d65ae5503ef22439ca5dd394fd", "html_url": "https://github.com/rust-lang/rust/commit/f64503eb555475d65ae5503ef22439ca5dd394fd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f64503eb555475d65ae5503ef22439ca5dd394fd/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d8af907491e20339e41d048d6a32b41ddfa91dfe", "url": "https://api.github.com/repos/rust-lang/rust/commits/d8af907491e20339e41d048d6a32b41ddfa91dfe", "html_url": "https://github.com/rust-lang/rust/commit/d8af907491e20339e41d048d6a32b41ddfa91dfe"}, {"sha": "8e42fa55dbaec9a6560b59fb023e50713ef94e93", "url": "https://api.github.com/repos/rust-lang/rust/commits/8e42fa55dbaec9a6560b59fb023e50713ef94e93", "html_url": "https://github.com/rust-lang/rust/commit/8e42fa55dbaec9a6560b59fb023e50713ef94e93"}], "stats": {"total": 50, "additions": 44, "deletions": 6}, "files": [{"sha": "32275e9b073481d97b4b7c41fc960ac500743fc8", "filename": "compiler/rustc_codegen_ssa/src/back/link.rs", "status": "modified", "additions": 8, "deletions": 6, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/f64503eb555475d65ae5503ef22439ca5dd394fd/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f64503eb555475d65ae5503ef22439ca5dd394fd/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs?ref=f64503eb555475d65ae5503ef22439ca5dd394fd", "patch": "@@ -1805,13 +1805,14 @@ fn add_local_native_libraries(\n     let search_path = archive_search_paths(sess);\n     let mut last = (NativeLibKind::Unspecified, None);\n     for lib in relevant_libs {\n-        // Skip if this library is the same as the last.\n-        last = if (lib.kind, lib.name) == last { continue } else { (lib.kind, lib.name) };\n-\n         let name = match lib.name {\n             Some(l) => l,\n             None => continue,\n         };\n+\n+        // Skip if this library is the same as the last.\n+        last = if (lib.kind, lib.name) == last { continue } else { (lib.kind, lib.name) };\n+\n         let verbatim = lib.verbatim.unwrap_or(false);\n         match lib.kind {\n             NativeLibKind::Dylib { as_needed } => {\n@@ -2144,16 +2145,17 @@ fn add_upstream_native_libraries(\n     let mut last = (NativeLibKind::Unspecified, None);\n     for &(cnum, _) in crates {\n         for lib in codegen_results.crate_info.native_libraries[&cnum].iter() {\n-            // Skip if this library is the same as the last.\n-            last = if (lib.kind, lib.name) == last { continue } else { (lib.kind, lib.name) };\n-\n             let name = match lib.name {\n                 Some(l) => l,\n                 None => continue,\n             };\n             if !relevant_lib(sess, &lib) {\n                 continue;\n             }\n+\n+            // Skip if this library is the same as the last.\n+            last = if (lib.kind, lib.name) == last { continue } else { (lib.kind, lib.name) };\n+\n             let verbatim = lib.verbatim.unwrap_or(false);\n             match lib.kind {\n                 NativeLibKind::Dylib { as_needed } => {"}, {"sha": "4e7ce0f02d4dcc0a1697432131854c720f87b667", "filename": "src/test/run-make-fulldeps/link-dedup/Makefile", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/f64503eb555475d65ae5503ef22439ca5dd394fd/src%2Ftest%2Frun-make-fulldeps%2Flink-dedup%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/f64503eb555475d65ae5503ef22439ca5dd394fd/src%2Ftest%2Frun-make-fulldeps%2Flink-dedup%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Flink-dedup%2FMakefile?ref=f64503eb555475d65ae5503ef22439ca5dd394fd", "patch": "@@ -0,0 +1,12 @@\n+# ignore-msvc\n+\n+-include ../tools.mk\n+\n+all:\n+\t$(RUSTC) depa.rs\n+\t$(RUSTC) depb.rs\n+\t$(RUSTC) depc.rs\n+\t$(RUSTC) empty.rs --cfg bar 2>&1 | $(CGREP) '\"-ltesta\" \"-ltestb\" \"-ltesta\"'\n+\t$(RUSTC) empty.rs 2>&1 | $(CGREP) '\"-ltesta\"'\n+\t$(RUSTC) empty.rs 2>&1 | $(CGREP) -v '\"-ltestb\"'\n+\t$(RUSTC) empty.rs 2>&1 | $(CGREP) -v '\"-ltesta\" \"-ltesta\"'"}, {"sha": "e48ffd6413cd078d7fe10922038a1ba51a9315d9", "filename": "src/test/run-make-fulldeps/link-dedup/depa.rs", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/f64503eb555475d65ae5503ef22439ca5dd394fd/src%2Ftest%2Frun-make-fulldeps%2Flink-dedup%2Fdepa.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f64503eb555475d65ae5503ef22439ca5dd394fd/src%2Ftest%2Frun-make-fulldeps%2Flink-dedup%2Fdepa.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Flink-dedup%2Fdepa.rs?ref=f64503eb555475d65ae5503ef22439ca5dd394fd", "patch": "@@ -0,0 +1,7 @@\n+#![crate_type = \"rlib\"]\n+\n+#[link(name = \"testa\")]\n+extern \"C\" {}\n+\n+#[link(name = \"testa\")]\n+extern \"C\" {}"}, {"sha": "b1be21fe005e6b74fed700e37a8d80d7f85269fe", "filename": "src/test/run-make-fulldeps/link-dedup/depb.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/f64503eb555475d65ae5503ef22439ca5dd394fd/src%2Ftest%2Frun-make-fulldeps%2Flink-dedup%2Fdepb.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f64503eb555475d65ae5503ef22439ca5dd394fd/src%2Ftest%2Frun-make-fulldeps%2Flink-dedup%2Fdepb.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Flink-dedup%2Fdepb.rs?ref=f64503eb555475d65ae5503ef22439ca5dd394fd", "patch": "@@ -0,0 +1,8 @@\n+#![feature(link_cfg)]\n+#![crate_type = \"rlib\"]\n+\n+#[link(name = \"testb\", cfg(foo))]\n+extern \"C\" {}\n+\n+#[link(name = \"testb\", cfg(bar))]\n+extern \"C\" {}"}, {"sha": "8dcb3dee5a2a4012db4926fa7a6e44e87e7fe669", "filename": "src/test/run-make-fulldeps/link-dedup/depc.rs", "status": "added", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f64503eb555475d65ae5503ef22439ca5dd394fd/src%2Ftest%2Frun-make-fulldeps%2Flink-dedup%2Fdepc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f64503eb555475d65ae5503ef22439ca5dd394fd/src%2Ftest%2Frun-make-fulldeps%2Flink-dedup%2Fdepc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Flink-dedup%2Fdepc.rs?ref=f64503eb555475d65ae5503ef22439ca5dd394fd", "patch": "@@ -0,0 +1,4 @@\n+#![crate_type = \"rlib\"]\n+\n+#[link(name = \"testa\")]\n+extern \"C\" {}"}, {"sha": "e00ae18f4af39d5e8ad669ad6e01680849a1d8ba", "filename": "src/test/run-make-fulldeps/link-dedup/empty.rs", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/f64503eb555475d65ae5503ef22439ca5dd394fd/src%2Ftest%2Frun-make-fulldeps%2Flink-dedup%2Fempty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f64503eb555475d65ae5503ef22439ca5dd394fd/src%2Ftest%2Frun-make-fulldeps%2Flink-dedup%2Fempty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Flink-dedup%2Fempty.rs?ref=f64503eb555475d65ae5503ef22439ca5dd394fd", "patch": "@@ -0,0 +1,5 @@\n+extern crate depa;\n+extern crate depb;\n+extern crate depc;\n+\n+fn main() {}"}]}