{"sha": "88f0fe784f0db871272acd989c4322d3db185683", "node_id": "C_kwDOAAsO6NoAKDg4ZjBmZTc4NGYwZGI4NzEyNzJhY2Q5ODljNDMyMmQzZGIxODU2ODM", "commit": {"author": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2023-03-14T10:33:40Z"}, "committer": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2023-03-14T10:33:40Z"}, "message": "fix: Fix rustc proc-macro handling being broken on the rustc workspace itself", "tree": {"sha": "f463dfa6a933a09870c19cda496dfc1362d6f0c5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f463dfa6a933a09870c19cda496dfc1362d6f0c5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/88f0fe784f0db871272acd989c4322d3db185683", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/88f0fe784f0db871272acd989c4322d3db185683", "html_url": "https://github.com/rust-lang/rust/commit/88f0fe784f0db871272acd989c4322d3db185683", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/88f0fe784f0db871272acd989c4322d3db185683/comments", "author": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "aaf08bdcc5025b7e53d617793a5b390fec187423", "url": "https://api.github.com/repos/rust-lang/rust/commits/aaf08bdcc5025b7e53d617793a5b390fec187423", "html_url": "https://github.com/rust-lang/rust/commit/aaf08bdcc5025b7e53d617793a5b390fec187423"}], "stats": {"total": 15, "additions": 11, "deletions": 4}, "files": [{"sha": "f63a04ccdb9eaaeedb98f73bc6084a35feee332d", "filename": "crates/project-model/src/build_scripts.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/88f0fe784f0db871272acd989c4322d3db185683/crates%2Fproject-model%2Fsrc%2Fbuild_scripts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/88f0fe784f0db871272acd989c4322d3db185683/crates%2Fproject-model%2Fsrc%2Fbuild_scripts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproject-model%2Fsrc%2Fbuild_scripts.rs?ref=88f0fe784f0db871272acd989c4322d3db185683", "patch": "@@ -428,8 +428,9 @@ impl WorkspaceBuildScripts {\n             for p in rustc.packages() {\n                 let package = &rustc[p];\n                 if package.targets.iter().any(|&it| rustc[it].is_proc_macro) {\n-                    if let Some((_, path)) =\n-                        proc_macro_dylibs.iter().find(|(name, _)| *name == package.name)\n+                    if let Some((_, path)) = proc_macro_dylibs\n+                        .iter()\n+                        .find(|(name, _)| *name.trim_start_matches(\"lib\") == package.name)\n                     {\n                         bs.outputs[p].proc_macro_dylib_path = Some(path.clone());\n                     }"}, {"sha": "23c2f4b524b070de1393934267ef72ae6273faa1", "filename": "crates/project-model/src/workspace.rs", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/88f0fe784f0db871272acd989c4322d3db185683/crates%2Fproject-model%2Fsrc%2Fworkspace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/88f0fe784f0db871272acd989c4322d3db185683/crates%2Fproject-model%2Fsrc%2Fworkspace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproject-model%2Fsrc%2Fworkspace.rs?ref=88f0fe784f0db871272acd989c4322d3db185683", "patch": "@@ -932,7 +932,7 @@ fn cargo_to_crate_graph(\n     if has_private {\n         // If the user provided a path to rustc sources, we add all the rustc_private crates\n         // and create dependencies on them for the crates which opt-in to that\n-        if let Some((rustc_workspace, build_scripts)) = rustc {\n+        if let Some((rustc_workspace, rustc_build_scripts)) = rustc {\n             handle_rustc_crates(\n                 &mut crate_graph,\n                 &mut pkg_to_lib_crate,\n@@ -945,7 +945,13 @@ fn cargo_to_crate_graph(\n                 &pkg_crates,\n                 &cfg_options,\n                 override_cfg,\n-                build_scripts,\n+                if rustc_workspace.workspace_root() == cargo.workspace_root() {\n+                    // the rustc workspace does not use the installed toolchain's proc-macro server\n+                    // so we need to make sure we don't use the pre compiled proc-macros there either\n+                    build_scripts\n+                } else {\n+                    rustc_build_scripts\n+                },\n                 target_layout,\n             );\n         }"}]}