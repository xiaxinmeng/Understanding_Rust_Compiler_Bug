{"sha": "23265741d33b9baff5ae0c50b328ccd54a3c1b47", "node_id": "MDY6Q29tbWl0NzI0NzEyOjIzMjY1NzQxZDMzYjliYWZmNWFlMGM1MGIzMjhjY2Q1NGEzYzFiNDc=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-09-05T10:11:17Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-09-05T10:11:17Z"}, "message": "Rollup merge of #64100 - wesleywiser:fix_miri_const_eval, r=oli-obk\n\nFix const eval bug breaking run-pass tests in Miri\n\nPR #63580 broke miri's ability to run the run-pass test suite with MIR\noptimizations enabled. The issue was that we weren't properly handling\nthe substs and DefId associated with a Promoted value. This didn't break\nanything in rustc because in rustc this code runs before the Inliner\npass which is where the DefId and substs can diverge from their initial\nvalues. It broke Miri though because it ran this code again after\nrunning the optimization pass.\n\nr? @oli-obk\ncc @RalfJung", "tree": {"sha": "28b673732d2874d3541d2a3b6f33beebb84437c1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/28b673732d2874d3541d2a3b6f33beebb84437c1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/23265741d33b9baff5ae0c50b328ccd54a3c1b47", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJdcN9FCRBK7hj4Ov3rIwAAdHIIAG3LRrYgwCESBcdM/ZvbyRvO\nOcPOyAGfxBnVhGZm9sKM90mRLbacgymqe8Xd5YYrtDuuc5BK3QjTVwPHAF+EcXvL\nsG8Gg4BeHKQBh9vHgP4G/nIhjkMX55rqZXkmmyRvo/IlO90nY9ll3cxBQDz33c+0\n4VJ8aOjiHb18dlEnfWnZxKoCW98jkFGaAm7x01LnutbkParGM1YpwXJw9kmu+aOs\n/kG5CJycQH44tX9WEm1UsGCikAgYtx530I1qjipu5bIU+KgzOFG1uvLZnFPHVPNN\nT3CRvpl8AfggnVNXbzpAuGncgQ7NTAIZo1uYb+sSCr3y7A0HdatHyPLD8TEUAus=\n=d6HE\n-----END PGP SIGNATURE-----\n", "payload": "tree 28b673732d2874d3541d2a3b6f33beebb84437c1\nparent 59237ec66526101e895f6b3430be780aa44c9d9d\nparent 46877e289087c67d03572019fca9792d95e55e0c\nauthor Mazdak Farrokhzad <twingoow@gmail.com> 1567678277 +0200\ncommitter GitHub <noreply@github.com> 1567678277 +0200\n\nRollup merge of #64100 - wesleywiser:fix_miri_const_eval, r=oli-obk\n\nFix const eval bug breaking run-pass tests in Miri\n\nPR #63580 broke miri's ability to run the run-pass test suite with MIR\noptimizations enabled. The issue was that we weren't properly handling\nthe substs and DefId associated with a Promoted value. This didn't break\nanything in rustc because in rustc this code runs before the Inliner\npass which is where the DefId and substs can diverge from their initial\nvalues. It broke Miri though because it ran this code again after\nrunning the optimization pass.\n\nr? @oli-obk\ncc @RalfJung\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/23265741d33b9baff5ae0c50b328ccd54a3c1b47", "html_url": "https://github.com/rust-lang/rust/commit/23265741d33b9baff5ae0c50b328ccd54a3c1b47", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/23265741d33b9baff5ae0c50b328ccd54a3c1b47/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "59237ec66526101e895f6b3430be780aa44c9d9d", "url": "https://api.github.com/repos/rust-lang/rust/commits/59237ec66526101e895f6b3430be780aa44c9d9d", "html_url": "https://github.com/rust-lang/rust/commit/59237ec66526101e895f6b3430be780aa44c9d9d"}, {"sha": "46877e289087c67d03572019fca9792d95e55e0c", "url": "https://api.github.com/repos/rust-lang/rust/commits/46877e289087c67d03572019fca9792d95e55e0c", "html_url": "https://github.com/rust-lang/rust/commit/46877e289087c67d03572019fca9792d95e55e0c"}], "stats": {"total": 5, "additions": 3, "deletions": 2}, "files": [{"sha": "f358bb00f4d12a744d5969a00d25572ef18b3c00", "filename": "src/librustc_mir/interpret/place.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/23265741d33b9baff5ae0c50b328ccd54a3c1b47/src%2Flibrustc_mir%2Finterpret%2Fplace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/23265741d33b9baff5ae0c50b328ccd54a3c1b47/src%2Flibrustc_mir%2Finterpret%2Fplace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Finterpret%2Fplace.rs?ref=23265741d33b9baff5ae0c50b328ccd54a3c1b47", "patch": "@@ -585,8 +585,9 @@ where\n         use rustc::mir::StaticKind;\n \n         Ok(match place_static.kind {\n-            StaticKind::Promoted(promoted, _) => {\n-                let instance = self.frame().instance;\n+            StaticKind::Promoted(promoted, promoted_substs) => {\n+                let substs = self.subst_from_frame_and_normalize_erasing_regions(promoted_substs);\n+                let instance = ty::Instance::new(place_static.def_id, substs);\n                 self.const_eval_raw(GlobalId {\n                     instance,\n                     promoted: Some(promoted),"}]}