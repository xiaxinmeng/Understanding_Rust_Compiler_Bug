{"sha": "050fb380aaa5f95ca27d6365cea06ea614c4cbf7", "node_id": "MDY6Q29tbWl0NzI0NzEyOjA1MGZiMzgwYWFhNWY5NWNhMjdkNjM2NWNlYTA2ZWE2MTRjNGNiZjc=", "commit": {"author": {"name": "Nathaniel McCallum", "email": "npmccallum@redhat.com", "date": "2020-08-11T18:09:39Z"}, "committer": {"name": "Nathaniel McCallum", "email": "npmccallum@redhat.com", "date": "2020-08-11T19:02:03Z"}, "message": "Don't spill operands onto the stack in naked functions\n\nCurrently, the code spills operands onto the stack for the purpose of\ndebuginfo. However, naked functions can only contain an asm block. Therefore,\nattempting to spill the operands on the stack is undefined behavior.\n\nFixes https://github.com/rust-lang/rust/issues/42779\ncc https://github.com/rust-lang/rust/issues/32408", "tree": {"sha": "7e441eb0b6a51c9d17cc1d028c44509a84348597", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7e441eb0b6a51c9d17cc1d028c44509a84348597"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/050fb380aaa5f95ca27d6365cea06ea614c4cbf7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/050fb380aaa5f95ca27d6365cea06ea614c4cbf7", "html_url": "https://github.com/rust-lang/rust/commit/050fb380aaa5f95ca27d6365cea06ea614c4cbf7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/050fb380aaa5f95ca27d6365cea06ea614c4cbf7/comments", "author": {"login": "npmccallum", "id": 288304, "node_id": "MDQ6VXNlcjI4ODMwNA==", "avatar_url": "https://avatars.githubusercontent.com/u/288304?v=4", "gravatar_id": "", "url": "https://api.github.com/users/npmccallum", "html_url": "https://github.com/npmccallum", "followers_url": "https://api.github.com/users/npmccallum/followers", "following_url": "https://api.github.com/users/npmccallum/following{/other_user}", "gists_url": "https://api.github.com/users/npmccallum/gists{/gist_id}", "starred_url": "https://api.github.com/users/npmccallum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/npmccallum/subscriptions", "organizations_url": "https://api.github.com/users/npmccallum/orgs", "repos_url": "https://api.github.com/users/npmccallum/repos", "events_url": "https://api.github.com/users/npmccallum/events{/privacy}", "received_events_url": "https://api.github.com/users/npmccallum/received_events", "type": "User", "site_admin": false}, "committer": {"login": "npmccallum", "id": 288304, "node_id": "MDQ6VXNlcjI4ODMwNA==", "avatar_url": "https://avatars.githubusercontent.com/u/288304?v=4", "gravatar_id": "", "url": "https://api.github.com/users/npmccallum", "html_url": "https://github.com/npmccallum", "followers_url": "https://api.github.com/users/npmccallum/followers", "following_url": "https://api.github.com/users/npmccallum/following{/other_user}", "gists_url": "https://api.github.com/users/npmccallum/gists{/gist_id}", "starred_url": "https://api.github.com/users/npmccallum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/npmccallum/subscriptions", "organizations_url": "https://api.github.com/users/npmccallum/orgs", "repos_url": "https://api.github.com/users/npmccallum/repos", "events_url": "https://api.github.com/users/npmccallum/events{/privacy}", "received_events_url": "https://api.github.com/users/npmccallum/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0356bb9fbba55f0a8fbe38731d41f57048f2e00b", "url": "https://api.github.com/repos/rust-lang/rust/commits/0356bb9fbba55f0a8fbe38731d41f57048f2e00b", "html_url": "https://github.com/rust-lang/rust/commit/0356bb9fbba55f0a8fbe38731d41f57048f2e00b"}], "stats": {"total": 8, "additions": 8, "deletions": 0}, "files": [{"sha": "d8a530d98faa7df9f0228b1b11a10af891e030c1", "filename": "src/librustc_codegen_ssa/mir/debuginfo.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/050fb380aaa5f95ca27d6365cea06ea614c4cbf7/src%2Flibrustc_codegen_ssa%2Fmir%2Fdebuginfo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/050fb380aaa5f95ca27d6365cea06ea614c4cbf7/src%2Flibrustc_codegen_ssa%2Fmir%2Fdebuginfo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fmir%2Fdebuginfo.rs?ref=050fb380aaa5f95ca27d6365cea06ea614c4cbf7", "patch": "@@ -1,6 +1,7 @@\n use crate::traits::*;\n use rustc_hir::def_id::CrateNum;\n use rustc_index::vec::IndexVec;\n+use rustc_middle::middle::codegen_fn_attrs::CodegenFnAttrFlags;\n use rustc_middle::mir;\n use rustc_middle::ty;\n use rustc_session::config::DebugInfo;\n@@ -216,6 +217,13 @@ impl<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>> FunctionCx<'a, 'tcx, Bx> {\n             LocalRef::Operand(None) => return,\n \n             LocalRef::Operand(Some(operand)) => {\n+                // Don't spill operands onto the stack in naked functions.\n+                // See: https://github.com/rust-lang/rust/issues/42779\n+                let attrs = bx.tcx().codegen_fn_attrs(self.instance.def_id());\n+                if attrs.flags.contains(CodegenFnAttrFlags::NAKED) {\n+                    return;\n+                }\n+\n                 // \"Spill\" the value onto the stack, for debuginfo,\n                 // without forcing non-debuginfo uses of the local\n                 // to also load from the stack every single time."}]}