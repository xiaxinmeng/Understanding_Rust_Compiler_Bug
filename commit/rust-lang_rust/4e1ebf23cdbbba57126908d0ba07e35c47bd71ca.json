{"sha": "4e1ebf23cdbbba57126908d0ba07e35c47bd71ca", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRlMWViZjIzY2RiYmJhNTcxMjY5MDhkMGJhMDdlMzVjNDdiZDcxY2E=", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2021-07-27T10:52:41Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-07-27T10:52:41Z"}, "message": "Rollup merge of #86764 - estebank:issue-86756, r=pnkfelix\n\nAvoid ICE on type error recovery\n\nFix #86756", "tree": {"sha": "df19bcdd2444ffd6be573ec7d83d2b10bd75c374", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/df19bcdd2444ffd6be573ec7d83d2b10bd75c374"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4e1ebf23cdbbba57126908d0ba07e35c47bd71ca", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJg/+V5CRBK7hj4Ov3rIwAAnoQIABhsZwu+nuoJNJrrlQtCwrjk\nY5rUGazEZ8cg+VdOp+QnPa+1RFb3Tkw0AMsKy5EISDO9cNZvqBwvnD7Rb3ctNKTU\nr9UGBEOD6uho+/UG2cf+n1Ywq0OZP75IhlAVKoko++w3KWiTOqaSz8/NZa+fuWK7\nZKHB/WI341jG4hovAEyq4L8qYmmW/SFNGLIvbFtSp2f09KcbNEL+3RJ8F97B1nm3\nZYXBvQ4VJbR7VA+TCNCxn9i2HN2XQgB0MdoPNto1XZqmlte/DAQABWPuN0/gkk5z\nDV6oGYoEB5Eim1Omxu0QtNxYFm46D9ljLJ/q1j58d9YGrNYHFMfsuQyNlb9m6LM=\n=HZbg\n-----END PGP SIGNATURE-----\n", "payload": "tree df19bcdd2444ffd6be573ec7d83d2b10bd75c374\nparent 99a6474bc45c66823972da3e4e23dc4cf47dd79a\nparent 8ea53624c9a2c4aa6bd207dd25b8d2b19610c99f\nauthor Yuki Okushi <jtitor@2k36.org> 1627383161 +0900\ncommitter GitHub <noreply@github.com> 1627383161 +0900\n\nRollup merge of #86764 - estebank:issue-86756, r=pnkfelix\n\nAvoid ICE on type error recovery\n\nFix #86756\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4e1ebf23cdbbba57126908d0ba07e35c47bd71ca", "html_url": "https://github.com/rust-lang/rust/commit/4e1ebf23cdbbba57126908d0ba07e35c47bd71ca", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4e1ebf23cdbbba57126908d0ba07e35c47bd71ca/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "99a6474bc45c66823972da3e4e23dc4cf47dd79a", "url": "https://api.github.com/repos/rust-lang/rust/commits/99a6474bc45c66823972da3e4e23dc4cf47dd79a", "html_url": "https://github.com/rust-lang/rust/commit/99a6474bc45c66823972da3e4e23dc4cf47dd79a"}, {"sha": "8ea53624c9a2c4aa6bd207dd25b8d2b19610c99f", "url": "https://api.github.com/repos/rust-lang/rust/commits/8ea53624c9a2c4aa6bd207dd25b8d2b19610c99f", "html_url": "https://github.com/rust-lang/rust/commit/8ea53624c9a2c4aa6bd207dd25b8d2b19610c99f"}], "stats": {"total": 70, "additions": 68, "deletions": 2}, "files": [{"sha": "b82437120ce98ff98965fbabfe27caa6bfc40436", "filename": "compiler/rustc_typeck/src/astconv/mod.rs", "status": "modified", "additions": 10, "deletions": 2, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/4e1ebf23cdbbba57126908d0ba07e35c47bd71ca/compiler%2Frustc_typeck%2Fsrc%2Fastconv%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4e1ebf23cdbbba57126908d0ba07e35c47bd71ca/compiler%2Frustc_typeck%2Fsrc%2Fastconv%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fastconv%2Fmod.rs?ref=4e1ebf23cdbbba57126908d0ba07e35c47bd71ca", "patch": "@@ -21,7 +21,7 @@ use rustc_hir::def_id::{DefId, LocalDefId};\n use rustc_hir::intravisit::{walk_generics, Visitor as _};\n use rustc_hir::lang_items::LangItem;\n use rustc_hir::{Constness, GenericArg, GenericArgs};\n-use rustc_middle::ty::subst::{self, InternalSubsts, Subst, SubstsRef};\n+use rustc_middle::ty::subst::{self, GenericArgKind, InternalSubsts, Subst, SubstsRef};\n use rustc_middle::ty::GenericParamDefKind;\n use rustc_middle::ty::{self, Const, DefIdTree, Ty, TyCtxt, TypeFoldable};\n use rustc_session::lint::builtin::AMBIGUOUS_ASSOCIATED_ITEMS;\n@@ -488,12 +488,20 @@ impl<'o, 'tcx> dyn AstConv<'tcx> + 'o {\n                                 tcx.ty_error().into()\n                             } else {\n                                 // This is a default type parameter.\n+                                let substs = substs.unwrap();\n+                                if substs.iter().any(|arg| match arg.unpack() {\n+                                    GenericArgKind::Type(ty) => ty.references_error(),\n+                                    _ => false,\n+                                }) {\n+                                    // Avoid ICE #86756 when type error recovery goes awry.\n+                                    return tcx.ty_error().into();\n+                                }\n                                 self.astconv\n                                     .normalize_ty(\n                                         self.span,\n                                         tcx.at(self.span).type_of(param.def_id).subst_spanned(\n                                             tcx,\n-                                            substs.unwrap(),\n+                                            substs,\n                                             Some(self.span),\n                                         ),\n                                     )"}, {"sha": "7f864eb2850743a4005e10c46ca7bcb8c50a01b3", "filename": "src/test/ui/issues/issue-86756.rs", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/4e1ebf23cdbbba57126908d0ba07e35c47bd71ca/src%2Ftest%2Fui%2Fissues%2Fissue-86756.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4e1ebf23cdbbba57126908d0ba07e35c47bd71ca/src%2Ftest%2Fui%2Fissues%2Fissue-86756.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-86756.rs?ref=4e1ebf23cdbbba57126908d0ba07e35c47bd71ca", "patch": "@@ -0,0 +1,12 @@\n+trait Foo<T, T = T> {}\n+//~^ ERROR the name `T` is already used for a generic parameter in this item's generic parameters\n+\n+fn eq<A, B>() {\n+    eq::<dyn, Foo>\n+    //~^ ERROR cannot find type `dyn` in this scope\n+    //~| ERROR missing generics for trait `Foo`\n+    //~| WARN trait objects without an explicit `dyn` are deprecated\n+    //~| WARN this is accepted in the current edition\n+}\n+\n+fn main() {}"}, {"sha": "1ef219867266036d51b80bfdc8101a02e3c6e8ed", "filename": "src/test/ui/issues/issue-86756.stderr", "status": "added", "additions": 46, "deletions": 0, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/4e1ebf23cdbbba57126908d0ba07e35c47bd71ca/src%2Ftest%2Fui%2Fissues%2Fissue-86756.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/4e1ebf23cdbbba57126908d0ba07e35c47bd71ca/src%2Ftest%2Fui%2Fissues%2Fissue-86756.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-86756.stderr?ref=4e1ebf23cdbbba57126908d0ba07e35c47bd71ca", "patch": "@@ -0,0 +1,46 @@\n+error[E0403]: the name `T` is already used for a generic parameter in this item's generic parameters\n+  --> $DIR/issue-86756.rs:1:14\n+   |\n+LL | trait Foo<T, T = T> {}\n+   |           -  ^ already used\n+   |           |\n+   |           first use of `T`\n+\n+error[E0412]: cannot find type `dyn` in this scope\n+  --> $DIR/issue-86756.rs:5:10\n+   |\n+LL | fn eq<A, B>() {\n+   |           - help: you might be missing a type parameter: `, dyn`\n+LL |     eq::<dyn, Foo>\n+   |          ^^^ not found in this scope\n+\n+warning: trait objects without an explicit `dyn` are deprecated\n+  --> $DIR/issue-86756.rs:5:15\n+   |\n+LL |     eq::<dyn, Foo>\n+   |               ^^^ help: use `dyn`: `dyn Foo`\n+   |\n+   = note: `#[warn(bare_trait_objects)]` on by default\n+   = warning: this is accepted in the current edition (Rust 2015) but is a hard error in Rust 2021!\n+   = note: for more information, see issue #80165 <https://github.com/rust-lang/rust/issues/80165>\n+\n+error[E0107]: missing generics for trait `Foo`\n+  --> $DIR/issue-86756.rs:5:15\n+   |\n+LL |     eq::<dyn, Foo>\n+   |               ^^^ expected at least 1 generic argument\n+   |\n+note: trait defined here, with at least 1 generic parameter: `T`\n+  --> $DIR/issue-86756.rs:1:7\n+   |\n+LL | trait Foo<T, T = T> {}\n+   |       ^^^ -\n+help: add missing generic argument\n+   |\n+LL |     eq::<dyn, Foo<T>>\n+   |               ^^^^^^\n+\n+error: aborting due to 3 previous errors; 1 warning emitted\n+\n+Some errors have detailed explanations: E0107, E0403, E0412.\n+For more information about an error, try `rustc --explain E0107`."}]}