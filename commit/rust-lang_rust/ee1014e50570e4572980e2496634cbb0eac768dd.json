{"sha": "ee1014e50570e4572980e2496634cbb0eac768dd", "node_id": "MDY6Q29tbWl0NzI0NzEyOmVlMTAxNGU1MDU3MGU0NTcyOTgwZTI0OTY2MzRjYmIwZWFjNzY4ZGQ=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-04-07T02:51:17Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-04-07T02:51:17Z"}, "message": "Auto merge of #49222 - Zoxc:print-query-stack, r=nikomatsakis\n\nPrint query stack on ICEs\n\nICE output is now:\n```\nthread 'rustc' panicked at 'no borrowck', librustc_borrowck\\borrowck\\mod.rs:95:5\nnote: Run with `RUST_BACKTRACE=1` for a backtrace.\nquery stack during panic:\n#0 [borrowck] processing `main`\n  --> no-std.rs:10:1\n   |\n10 | fn main() {}\n   | ^^^^^^^^^\nend of query stack\n\nerror: internal compiler error: unexpected panic\n\nnote: the compiler unexpectedly panicked. this is a bug.\n\nnote: we would appreciate a bug report: https://github.com/rust-lang/rust/blob/master/CONTRIBUTING.md#bug-reports\n\nnote: rustc 1.26.0-dev running on x86_64-pc-windows-msvc\n```\n\nFixes #42529.\n\nr? @eddyb", "tree": {"sha": "20af1439556617699e663f7452560acbfed30a30", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/20af1439556617699e663f7452560acbfed30a30"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ee1014e50570e4572980e2496634cbb0eac768dd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ee1014e50570e4572980e2496634cbb0eac768dd", "html_url": "https://github.com/rust-lang/rust/commit/ee1014e50570e4572980e2496634cbb0eac768dd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ee1014e50570e4572980e2496634cbb0eac768dd/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5911314efd39cabd7ee262da31cf0cb3faea4d7b", "url": "https://api.github.com/repos/rust-lang/rust/commits/5911314efd39cabd7ee262da31cf0cb3faea4d7b", "html_url": "https://github.com/rust-lang/rust/commit/5911314efd39cabd7ee262da31cf0cb3faea4d7b"}, {"sha": "4fd188e5f31f14625eb8b1feec38da5ad538e3c9", "url": "https://api.github.com/repos/rust-lang/rust/commits/4fd188e5f31f14625eb8b1feec38da5ad538e3c9", "html_url": "https://github.com/rust-lang/rust/commit/4fd188e5f31f14625eb8b1feec38da5ad538e3c9"}], "stats": {"total": 50, "additions": 49, "deletions": 1}, "files": [{"sha": "232b300e7545d4697b24a043f5b96c4e379dc5e1", "filename": "src/librustc/ty/maps/plumbing.rs", "status": "modified", "additions": 35, "deletions": 0, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/ee1014e50570e4572980e2496634cbb0eac768dd/src%2Flibrustc%2Fty%2Fmaps%2Fplumbing.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee1014e50570e4572980e2496634cbb0eac768dd/src%2Flibrustc%2Fty%2Fmaps%2Fplumbing.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fmaps%2Fplumbing.rs?ref=ee1014e50570e4572980e2496634cbb0eac768dd", "patch": "@@ -14,6 +14,8 @@\n \n use dep_graph::{DepNodeIndex, DepNode, DepKind, DepNodeColor};\n use errors::DiagnosticBuilder;\n+use errors::Level;\n+use ty::tls;\n use ty::{TyCtxt};\n use ty::maps::config::QueryDescription;\n use ty::maps::job::{QueryResult, QueryInfo};\n@@ -108,6 +110,33 @@ impl<'a, 'gcx, 'tcx> TyCtxt<'a, 'gcx, 'tcx> {\n         })\n     }\n \n+    pub fn try_print_query_stack() {\n+        eprintln!(\"query stack during panic:\");\n+\n+        tls::with_context_opt(|icx| {\n+            if let Some(icx) = icx {\n+                let mut current_query = icx.query.clone();\n+                let mut i = 0;\n+\n+                while let Some(query) = current_query {\n+                    let mut db = DiagnosticBuilder::new(icx.tcx.sess.diagnostic(),\n+                        Level::FailureNote,\n+                        &format!(\"#{} [{}] {}\",\n+                                 i,\n+                                 query.info.query.name(),\n+                                 query.info.query.describe(icx.tcx)));\n+                    db.set_span(icx.tcx.sess.codemap().def_span(query.info.span));\n+                    icx.tcx.sess.diagnostic().force_print_db(db);\n+\n+                    current_query = query.parent.clone();\n+                    i += 1;\n+                }\n+            }\n+        });\n+\n+        eprintln!(\"end of query stack\");\n+    }\n+\n     /// Try to read a node index for the node dep_node.\n     /// A node will have an index, when it's already been marked green, or when we can mark it\n     /// green. This function will mark the current task as a reader of the specified node, when\n@@ -219,6 +248,12 @@ macro_rules! define_maps {\n         }\n \n         impl<$tcx> Query<$tcx> {\n+            pub fn name(&self) -> &'static str {\n+                match *self {\n+                    $(Query::$name(_) => stringify!($name),)*\n+                }\n+            }\n+\n             pub fn describe(&self, tcx: TyCtxt) -> String {\n                 let (r, name) = match *self {\n                     $(Query::$name(key) => {"}, {"sha": "32ec837f031bfad02368fdd26831aead7377c46a", "filename": "src/librustc/util/common.rs", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/ee1014e50570e4572980e2496634cbb0eac768dd/src%2Flibrustc%2Futil%2Fcommon.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee1014e50570e4572980e2496634cbb0eac768dd/src%2Flibrustc%2Futil%2Fcommon.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Futil%2Fcommon.rs?ref=ee1014e50570e4572980e2496634cbb0eac768dd", "patch": "@@ -17,12 +17,14 @@ use std::fmt::Debug;\n use std::hash::{Hash, BuildHasher};\n use std::iter::repeat;\n use std::panic;\n+use std::env;\n use std::path::Path;\n use std::time::{Duration, Instant};\n \n use std::sync::mpsc::{Sender};\n use syntax_pos::{SpanData};\n use ty::maps::{QueryMsg};\n+use ty::TyCtxt;\n use dep_graph::{DepNode};\n use proc_macro;\n use lazy_static;\n@@ -48,7 +50,13 @@ lazy_static! {\n \n fn panic_hook(info: &panic::PanicInfo) {\n     if !proc_macro::__internal::in_sess() {\n-        (*DEFAULT_HOOK)(info)\n+        (*DEFAULT_HOOK)(info);\n+\n+        let backtrace = env::var_os(\"RUST_BACKTRACE\").map(|x| &x != \"0\").unwrap_or(false);\n+\n+        if backtrace {\n+            TyCtxt::try_print_query_stack();\n+        }\n     }\n }\n "}, {"sha": "43fe812a6ce80a9522a83bcc5c82113908c9d86a", "filename": "src/librustc_errors/lib.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/ee1014e50570e4572980e2496634cbb0eac768dd/src%2Flibrustc_errors%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee1014e50570e4572980e2496634cbb0eac768dd/src%2Flibrustc_errors%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_errors%2Flib.rs?ref=ee1014e50570e4572980e2496634cbb0eac768dd", "patch": "@@ -641,6 +641,11 @@ impl Handler {\n         self.tracked_diagnostic_codes.borrow().contains(code)\n     }\n \n+    pub fn force_print_db(&self, mut db: DiagnosticBuilder) {\n+        self.emitter.borrow_mut().emit(&db);\n+        db.cancel();\n+    }\n+\n     fn emit_db(&self, db: &DiagnosticBuilder) {\n         let diagnostic = &**db;\n "}]}