{"sha": "36342b4b29dedde44b9aee6362ad5324e6282221", "node_id": "C_kwDOAAsO6NoAKDM2MzQyYjRiMjlkZWRkZTQ0YjlhZWU2MzYyYWQ1MzI0ZTYyODIyMjE", "commit": {"author": {"name": "Jonas Schievink", "email": "jonas.schievink@ferrous-systems.com", "date": "2022-04-25T13:21:30Z"}, "committer": {"name": "Jonas Schievink", "email": "jonas.schievink@ferrous-systems.com", "date": "2022-04-25T13:21:30Z"}, "message": "Don't emit a quickfix for placeholder suggestions", "tree": {"sha": "86b0da9f6af0b0158e011ab404a9ca572ad23d8d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/86b0da9f6af0b0158e011ab404a9ca572ad23d8d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/36342b4b29dedde44b9aee6362ad5324e6282221", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/36342b4b29dedde44b9aee6362ad5324e6282221", "html_url": "https://github.com/rust-lang/rust/commit/36342b4b29dedde44b9aee6362ad5324e6282221", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/36342b4b29dedde44b9aee6362ad5324e6282221/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1d2bd0e37969c81da520b1a790d4cffd9ccd135d", "url": "https://api.github.com/repos/rust-lang/rust/commits/1d2bd0e37969c81da520b1a790d4cffd9ccd135d", "html_url": "https://github.com/rust-lang/rust/commit/1d2bd0e37969c81da520b1a790d4cffd9ccd135d"}], "stats": {"total": 80, "additions": 13, "deletions": 67}, "files": [{"sha": "c3b540e31f77f9857544a1e71326519fc6cd1653", "filename": "crates/rust-analyzer/src/diagnostics/test_data/clippy_pass_by_ref.txt", "status": "modified", "additions": 1, "deletions": 65, "changes": 66, "blob_url": "https://github.com/rust-lang/rust/blob/36342b4b29dedde44b9aee6362ad5324e6282221/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Ftest_data%2Fclippy_pass_by_ref.txt", "raw_url": "https://github.com/rust-lang/rust/raw/36342b4b29dedde44b9aee6362ad5324e6282221/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Ftest_data%2Fclippy_pass_by_ref.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Ftest_data%2Fclippy_pass_by_ref.txt?ref=36342b4b29dedde44b9aee6362ad5324e6282221", "patch": "@@ -296,70 +296,6 @@\n             tags: None,\n             data: None,\n         },\n-        fix: Some(\n-            Fix {\n-                ranges: [\n-                    Range {\n-                        start: Position {\n-                            line: 41,\n-                            character: 23,\n-                        },\n-                        end: Position {\n-                            line: 41,\n-                            character: 28,\n-                        },\n-                    },\n-                ],\n-                action: CodeAction {\n-                    title: \"consider passing by value instead: `self`\",\n-                    group: None,\n-                    kind: Some(\n-                        CodeActionKind(\n-                            \"quickfix\",\n-                        ),\n-                    ),\n-                    command: None,\n-                    edit: Some(\n-                        SnippetWorkspaceEdit {\n-                            changes: Some(\n-                                {\n-                                    Url {\n-                                        scheme: \"file\",\n-                                        cannot_be_a_base: false,\n-                                        username: \"\",\n-                                        password: None,\n-                                        host: None,\n-                                        port: None,\n-                                        path: \"/test/compiler/mir/tagset.rs\",\n-                                        query: None,\n-                                        fragment: None,\n-                                    }: [\n-                                        TextEdit {\n-                                            range: Range {\n-                                                start: Position {\n-                                                    line: 41,\n-                                                    character: 23,\n-                                                },\n-                                                end: Position {\n-                                                    line: 41,\n-                                                    character: 28,\n-                                                },\n-                                            },\n-                                            new_text: \"self\",\n-                                        },\n-                                    ],\n-                                },\n-                            ),\n-                            document_changes: None,\n-                            change_annotations: None,\n-                        },\n-                    ),\n-                    is_preferred: Some(\n-                        true,\n-                    ),\n-                    data: None,\n-                },\n-            },\n-        ),\n+        fix: None,\n     },\n ]"}, {"sha": "4b7805565662aceedcae263abdaff37eb0f803b8", "filename": "crates/rust-analyzer/src/diagnostics/to_proto.rs", "status": "modified", "additions": 12, "deletions": 2, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/36342b4b29dedde44b9aee6362ad5324e6282221/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Fto_proto.rs", "raw_url": "https://github.com/rust-lang/rust/raw/36342b4b29dedde44b9aee6362ad5324e6282221/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Fto_proto.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Fto_proto.rs?ref=36342b4b29dedde44b9aee6362ad5324e6282221", "patch": "@@ -2,7 +2,7 @@\n //! `cargo check` json format to the LSP diagnostic format.\n use std::collections::HashMap;\n \n-use flycheck::{DiagnosticLevel, DiagnosticSpan};\n+use flycheck::{Applicability, DiagnosticLevel, DiagnosticSpan};\n use itertools::Itertools;\n use stdx::format_to;\n use vfs::{AbsPath, AbsPathBuf};\n@@ -159,7 +159,17 @@ fn map_rust_child_diagnostic(\n             }\n             let location = location(config, workspace_root, span);\n             let edit = lsp_types::TextEdit::new(location.range, suggested_replacement.clone());\n-            edit_map.entry(location.uri).or_default().push(edit);\n+\n+            // Only actually emit a quickfix if the suggestion is \"valid enough\".\n+            // We accept both \"MaybeIncorrect\" and \"MachineApplicable\". \"MaybeIncorrect\" means that\n+            // the suggestion is *complete* (contains no placeholders where code needs to be\n+            // inserted), but might not be what the user wants, or might need minor adjustments.\n+            if matches!(\n+                span.suggestion_applicability,\n+                None | Some(Applicability::MaybeIncorrect | Applicability::MachineApplicable)\n+            ) {\n+                edit_map.entry(location.uri).or_default().push(edit);\n+            }\n         }\n     }\n "}]}