{"sha": "08ca5d955832ee412250a776ce811c9d6abf2100", "node_id": "MDY6Q29tbWl0NzI0NzEyOjA4Y2E1ZDk1NTgzMmVlNDEyMjUwYTc3NmNlODExYzlkNmFiZjIxMDA=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2016-03-30T04:51:00Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2016-03-30T04:51:00Z"}, "message": "rustbuild: Fix compile on OSX for 10.7\n\nThis commit should help configure our OSX rustbuild builder for targeting 10.7.\nA key part of this is using `libc++` instead of `libstdc++` as apparently it's\nmore filled out and otherwise LLVM's cmake configuration would fail.", "tree": {"sha": "11e7cee2b902f3da2d717d194984f959ecdbadb7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/11e7cee2b902f3da2d717d194984f959ecdbadb7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/08ca5d955832ee412250a776ce811c9d6abf2100", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/08ca5d955832ee412250a776ce811c9d6abf2100", "html_url": "https://github.com/rust-lang/rust/commit/08ca5d955832ee412250a776ce811c9d6abf2100", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/08ca5d955832ee412250a776ce811c9d6abf2100/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ec666a597743ad57f514d8f271291a8a1f5a0ff0", "url": "https://api.github.com/repos/rust-lang/rust/commits/ec666a597743ad57f514d8f271291a8a1f5a0ff0", "html_url": "https://github.com/rust-lang/rust/commit/ec666a597743ad57f514d8f271291a8a1f5a0ff0"}], "stats": {"total": 48, "additions": 36, "deletions": 12}, "files": [{"sha": "cc4d6c8628b491594a19b6b5c12cdd674f663a7c", "filename": "src/bootstrap/build/mod.rs", "status": "modified", "additions": 21, "deletions": 6, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/08ca5d955832ee412250a776ce811c9d6abf2100/src%2Fbootstrap%2Fbuild%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/08ca5d955832ee412250a776ce811c9d6abf2100/src%2Fbootstrap%2Fbuild%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuild%2Fmod.rs?ref=08ca5d955832ee412250a776ce811c9d6abf2100", "patch": "@@ -312,7 +312,13 @@ impl Build {\n         if !target.contains(\"msvc\") {\n             cargo.env(format!(\"CC_{}\", target), self.cc(target))\n                  .env(format!(\"AR_{}\", target), self.ar(target))\n-                 .env(format!(\"CFLAGS_{}\", target), self.cflags(target));\n+                 .env(format!(\"CFLAGS_{}\", target), self.cflags(target).join(\" \"));\n+        }\n+\n+        // If we're building for OSX, inform the compiler and the linker that\n+        // we want to build a compiler runnable on 10.7\n+        if target.contains(\"apple-darwin\") {\n+            cargo.env(\"MACOSX_DEPLOYMENT_TARGET\", \"10.7\");\n         }\n \n         // Environment variables *required* needed throughout the build\n@@ -481,11 +487,20 @@ impl Build {\n         self.cc[target].0.path()\n     }\n \n-    fn cflags(&self, target: &str) -> String {\n-        self.cc[target].0.args().iter()\n-            .map(|s| s.to_string_lossy())\n-            .collect::<Vec<_>>()\n-            .join(\" \")\n+    fn cflags(&self, target: &str) -> Vec<String> {\n+        let mut base = self.cc[target].0.args().iter()\n+                           .map(|s| s.to_string_lossy().into_owned())\n+                           .collect::<Vec<_>>();\n+\n+        // If we're compiling on OSX then we add a few unconditional flags\n+        // indicating that we want libc++ (more filled out than libstdc++) and\n+        // we want to compile for 10.7. This way we can ensure that\n+        // LLVM/jemalloc/etc are all properly compiled.\n+        if target.contains(\"apple-darwin\") {\n+            base.push(\"-stdlib=libc++\".into());\n+            base.push(\"-mmacosx-version-min=10.7\".into());\n+        }\n+        return base\n     }\n \n     fn ar(&self, target: &str) -> &Path {"}, {"sha": "bf0494bcd8c8c5a4240ca05579d8837d257b2700", "filename": "src/bootstrap/build/native.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/08ca5d955832ee412250a776ce811c9d6abf2100/src%2Fbootstrap%2Fbuild%2Fnative.rs", "raw_url": "https://github.com/rust-lang/rust/raw/08ca5d955832ee412250a776ce811c9d6abf2100/src%2Fbootstrap%2Fbuild%2Fnative.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuild%2Fnative.rs?ref=08ca5d955832ee412250a776ce811c9d6abf2100", "patch": "@@ -86,6 +86,9 @@ pub fn llvm(build: &Build, target: &str) {\n               .define(\"CMAKE_CXX_COMPILER\", build.cxx(target));\n         }\n         cfg.build_arg(\"-j\").build_arg(build.jobs().to_string());\n+\n+        cfg.define(\"CMAKE_C_FLAGS\", build.cflags(target).join(\" \"));\n+        cfg.define(\"CMAKE_CXX_FLAGS\", build.cflags(target).join(\" \"));\n     }\n \n     // FIXME: we don't actually need to build all LLVM tools and all LLVM"}, {"sha": "3290d068ca3d2639d7a811caadd8f4a5d2c1d4c1", "filename": "src/rustc/Cargo.lock", "status": "modified", "additions": 12, "deletions": 6, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/08ca5d955832ee412250a776ce811c9d6abf2100/src%2Frustc%2FCargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/08ca5d955832ee412250a776ce811c9d6abf2100/src%2Frustc%2FCargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustc%2FCargo.lock?ref=08ca5d955832ee412250a776ce811c9d6abf2100", "patch": "@@ -81,7 +81,6 @@ dependencies = [\n  \"rustc_const_eval 0.0.0\",\n  \"rustc_data_structures 0.0.0\",\n  \"rustc_front 0.0.0\",\n- \"rustc_llvm 0.0.0\",\n  \"serialize 0.0.0\",\n  \"syntax 0.0.0\",\n ]\n@@ -92,7 +91,6 @@ version = \"0.0.0\"\n dependencies = [\n  \"log 0.0.0\",\n  \"rustc_front 0.0.0\",\n- \"rustc_llvm 0.0.0\",\n  \"serialize 0.0.0\",\n  \"syntax 0.0.0\",\n ]\n@@ -151,6 +149,7 @@ dependencies = [\n  \"rustc_plugin 0.0.0\",\n  \"rustc_privacy 0.0.0\",\n  \"rustc_resolve 0.0.0\",\n+ \"rustc_save_analysis 0.0.0\",\n  \"rustc_trans 0.0.0\",\n  \"rustc_typeck 0.0.0\",\n  \"serialize 0.0.0\",\n@@ -232,10 +231,6 @@ dependencies = [\n [[package]]\n name = \"rustc_platform_intrinsics\"\n version = \"0.0.0\"\n-dependencies = [\n- \"rustc 0.0.0\",\n- \"rustc_llvm 0.0.0\",\n-]\n \n [[package]]\n name = \"rustc_plugin\"\n@@ -273,6 +268,16 @@ dependencies = [\n  \"syntax 0.0.0\",\n ]\n \n+[[package]]\n+name = \"rustc_save_analysis\"\n+version = \"0.0.0\"\n+dependencies = [\n+ \"log 0.0.0\",\n+ \"rustc 0.0.0\",\n+ \"rustc_front 0.0.0\",\n+ \"syntax 0.0.0\",\n+]\n+\n [[package]]\n name = \"rustc_trans\"\n version = \"0.0.0\"\n@@ -353,6 +358,7 @@ name = \"syntax_ext\"\n version = \"0.0.0\"\n dependencies = [\n  \"fmt_macros 0.0.0\",\n+ \"log 0.0.0\",\n  \"syntax 0.0.0\",\n ]\n "}]}