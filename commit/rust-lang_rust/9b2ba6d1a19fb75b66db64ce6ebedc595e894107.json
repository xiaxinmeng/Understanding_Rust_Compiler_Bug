{"sha": "9b2ba6d1a19fb75b66db64ce6ebedc595e894107", "node_id": "MDY6Q29tbWl0NzI0NzEyOjliMmJhNmQxYTE5ZmI3NWI2NmRiNjRjZTZlYmVkYzU5NWU4OTQxMDc=", "commit": {"author": {"name": "asquared31415", "email": "34665709+asquared31415@users.noreply.github.com", "date": "2021-06-10T03:11:35Z"}, "committer": {"name": "asquared31415", "email": "34665709+asquared31415@users.noreply.github.com", "date": "2021-06-10T03:14:02Z"}, "message": "Fix ICE when `main` is declared in an `extern` block", "tree": {"sha": "f46e5486e322895685056c499d8b54567fd81b56", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f46e5486e322895685056c499d8b54567fd81b56"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9b2ba6d1a19fb75b66db64ce6ebedc595e894107", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9b2ba6d1a19fb75b66db64ce6ebedc595e894107", "html_url": "https://github.com/rust-lang/rust/commit/9b2ba6d1a19fb75b66db64ce6ebedc595e894107", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9b2ba6d1a19fb75b66db64ce6ebedc595e894107/comments", "author": {"login": "asquared31415", "id": 34665709, "node_id": "MDQ6VXNlcjM0NjY1NzA5", "avatar_url": "https://avatars.githubusercontent.com/u/34665709?v=4", "gravatar_id": "", "url": "https://api.github.com/users/asquared31415", "html_url": "https://github.com/asquared31415", "followers_url": "https://api.github.com/users/asquared31415/followers", "following_url": "https://api.github.com/users/asquared31415/following{/other_user}", "gists_url": "https://api.github.com/users/asquared31415/gists{/gist_id}", "starred_url": "https://api.github.com/users/asquared31415/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/asquared31415/subscriptions", "organizations_url": "https://api.github.com/users/asquared31415/orgs", "repos_url": "https://api.github.com/users/asquared31415/repos", "events_url": "https://api.github.com/users/asquared31415/events{/privacy}", "received_events_url": "https://api.github.com/users/asquared31415/received_events", "type": "User", "site_admin": false}, "committer": {"login": "asquared31415", "id": 34665709, "node_id": "MDQ6VXNlcjM0NjY1NzA5", "avatar_url": "https://avatars.githubusercontent.com/u/34665709?v=4", "gravatar_id": "", "url": "https://api.github.com/users/asquared31415", "html_url": "https://github.com/asquared31415", "followers_url": "https://api.github.com/users/asquared31415/followers", "following_url": "https://api.github.com/users/asquared31415/following{/other_user}", "gists_url": "https://api.github.com/users/asquared31415/gists{/gist_id}", "starred_url": "https://api.github.com/users/asquared31415/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/asquared31415/subscriptions", "organizations_url": "https://api.github.com/users/asquared31415/orgs", "repos_url": "https://api.github.com/users/asquared31415/repos", "events_url": "https://api.github.com/users/asquared31415/events{/privacy}", "received_events_url": "https://api.github.com/users/asquared31415/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1639a16ebfaad2aa74fd535c778fd1614475b53d", "url": "https://api.github.com/repos/rust-lang/rust/commits/1639a16ebfaad2aa74fd535c778fd1614475b53d", "html_url": "https://github.com/rust-lang/rust/commit/1639a16ebfaad2aa74fd535c778fd1614475b53d"}], "stats": {"total": 34, "additions": 32, "deletions": 2}, "files": [{"sha": "c0a837985fd62af0755fd64d73ecb9fdeccaf8cb", "filename": "compiler/rustc_ast/src/entry.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/9b2ba6d1a19fb75b66db64ce6ebedc595e894107/compiler%2Frustc_ast%2Fsrc%2Fentry.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b2ba6d1a19fb75b66db64ce6ebedc595e894107/compiler%2Frustc_ast%2Fsrc%2Fentry.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast%2Fsrc%2Fentry.rs?ref=9b2ba6d1a19fb75b66db64ce6ebedc595e894107", "patch": "@@ -1,3 +1,4 @@\n+#[derive(Debug)]\n pub enum EntryPointType {\n     None,\n     MainNamed,"}, {"sha": "c88117712839034d5c78eca6c67b7474c50f6132", "filename": "compiler/rustc_middle/src/ty/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/9b2ba6d1a19fb75b66db64ce6ebedc595e894107/compiler%2Frustc_middle%2Fsrc%2Fty%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b2ba6d1a19fb75b66db64ce6ebedc595e894107/compiler%2Frustc_middle%2Fsrc%2Fty%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fmod.rs?ref=9b2ba6d1a19fb75b66db64ce6ebedc595e894107", "patch": "@@ -126,7 +126,7 @@ pub struct ResolverOutputs {\n     pub main_def: Option<MainDefinition>,\n }\n \n-#[derive(Clone, Copy)]\n+#[derive(Clone, Copy, Debug)]\n pub struct MainDefinition {\n     pub res: Res<ast::NodeId>,\n     pub is_import: bool,"}, {"sha": "34ea5e9abd4d522447097f9efee9c43223d60931", "filename": "compiler/rustc_passes/src/entry.rs", "status": "modified", "additions": 15, "deletions": 1, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/9b2ba6d1a19fb75b66db64ce6ebedc595e894107/compiler%2Frustc_passes%2Fsrc%2Fentry.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b2ba6d1a19fb75b66db64ce6ebedc595e894107/compiler%2Frustc_passes%2Fsrc%2Fentry.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fentry.rs?ref=9b2ba6d1a19fb75b66db64ce6ebedc595e894107", "patch": "@@ -2,7 +2,7 @@ use rustc_ast::entry::EntryPointType;\n use rustc_errors::struct_span_err;\n use rustc_hir::def_id::{DefId, CRATE_DEF_INDEX, LOCAL_CRATE};\n use rustc_hir::itemlikevisit::ItemLikeVisitor;\n-use rustc_hir::{ForeignItem, HirId, ImplItem, Item, ItemKind, TraitItem, CRATE_HIR_ID};\n+use rustc_hir::{ForeignItem, HirId, ImplItem, Item, ItemKind, Node, TraitItem, CRATE_HIR_ID};\n use rustc_middle::hir::map::Map;\n use rustc_middle::ty::query::Providers;\n use rustc_middle::ty::TyCtxt;\n@@ -148,6 +148,20 @@ fn configure_main(tcx: TyCtxt<'_>, visitor: &EntryContext<'_, '_>) -> Option<(De\n     } else if let Some((hir_id, _)) = visitor.attr_main_fn {\n         Some((tcx.hir().local_def_id(hir_id).to_def_id(), EntryFnType::Main))\n     } else if let Some(def_id) = tcx.main_def.and_then(|main_def| main_def.opt_fn_def_id()) {\n+        // non-local main imports are handled below\n+        if def_id.is_local() {\n+            let hir_id = tcx.hir().local_def_id_to_hir_id(def_id.expect_local());\n+            if matches!(tcx.hir().find(hir_id), Some(Node::ForeignItem(_))) {\n+                tcx.sess\n+                    .struct_span_err(\n+                        tcx.hir().span(hir_id),\n+                        \"the `main` function cannot be declared in an `extern` block\",\n+                    )\n+                    .emit();\n+                return None;\n+            }\n+        }\n+\n         if tcx.main_def.unwrap().is_import && !tcx.features().imported_main {\n             let span = tcx.main_def.unwrap().span;\n             feature_err("}, {"sha": "83af7a14ccc7a4236e3255e4c6a7edf21605ecdd", "filename": "src/test/ui/extern/extern-main-issue-86110.rs", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/9b2ba6d1a19fb75b66db64ce6ebedc595e894107/src%2Ftest%2Fui%2Fextern%2Fextern-main-issue-86110.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b2ba6d1a19fb75b66db64ce6ebedc595e894107/src%2Ftest%2Fui%2Fextern%2Fextern-main-issue-86110.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fextern%2Fextern-main-issue-86110.rs?ref=9b2ba6d1a19fb75b66db64ce6ebedc595e894107", "patch": "@@ -0,0 +1,7 @@\n+// missing and missing2 exist to make sure that the error only happens on a `main` declaration\n+extern \"C\" {\n+    fn missing();\n+    fn main();\n+    //~^ the `main` function cannot be declared in an `extern` block\n+    fn missing2();\n+}"}, {"sha": "cd3de227dcffe13b17f2afd74d5e053daf31654f", "filename": "src/test/ui/extern/extern-main-issue-86110.stderr", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/9b2ba6d1a19fb75b66db64ce6ebedc595e894107/src%2Ftest%2Fui%2Fextern%2Fextern-main-issue-86110.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/9b2ba6d1a19fb75b66db64ce6ebedc595e894107/src%2Ftest%2Fui%2Fextern%2Fextern-main-issue-86110.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fextern%2Fextern-main-issue-86110.stderr?ref=9b2ba6d1a19fb75b66db64ce6ebedc595e894107", "patch": "@@ -0,0 +1,8 @@\n+error: the `main` function cannot be declared in an `extern` block\n+  --> $DIR/extern-main-issue-86110.rs:4:5\n+   |\n+LL |     fn main();\n+   |     ^^^^^^^^^^\n+\n+error: aborting due to previous error\n+"}]}