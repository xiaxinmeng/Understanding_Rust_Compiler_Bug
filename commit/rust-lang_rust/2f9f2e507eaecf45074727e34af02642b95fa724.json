{"sha": "2f9f2e507eaecf45074727e34af02642b95fa724", "node_id": "C_kwDOAAsO6NoAKDJmOWYyZTUwN2VhZWNmNDUwNzQ3MjdlMzRhZjAyNjQyYjk1ZmE3MjQ", "commit": {"author": {"name": "The 8472", "email": "git@infinite-source.de", "date": "2022-06-26T20:53:25Z"}, "committer": {"name": "The 8472", "email": "git@infinite-source.de", "date": "2022-07-26T18:31:43Z"}, "message": "Optimized vec::IntoIter::next_chunk impl\n\n```\ntest vec::bench_next_chunk                               ... bench:         696 ns/iter (+/- 22)\nx86_64v1, pr\ntest vec::bench_next_chunk                               ... bench:         309 ns/iter (+/- 4)\n\nznver2, default\ntest vec::bench_next_chunk                               ... bench:      17,272 ns/iter (+/- 117)\nznver2, pr\ntest vec::bench_next_chunk                               ... bench:         211 ns/iter (+/- 3)\n```\n\nThe znver2 default impl seems to be slow due to inlining decisions. It goes through `core::array::iter_next_chunk`\nwhich has a deeper call tree.", "tree": {"sha": "77f407e338439431f1087823c704cd02ebe238b4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/77f407e338439431f1087823c704cd02ebe238b4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2f9f2e507eaecf45074727e34af02642b95fa724", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2f9f2e507eaecf45074727e34af02642b95fa724", "html_url": "https://github.com/rust-lang/rust/commit/2f9f2e507eaecf45074727e34af02642b95fa724", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2f9f2e507eaecf45074727e34af02642b95fa724/comments", "author": {"login": "the8472", "id": 1065730, "node_id": "MDQ6VXNlcjEwNjU3MzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1065730?v=4", "gravatar_id": "", "url": "https://api.github.com/users/the8472", "html_url": "https://github.com/the8472", "followers_url": "https://api.github.com/users/the8472/followers", "following_url": "https://api.github.com/users/the8472/following{/other_user}", "gists_url": "https://api.github.com/users/the8472/gists{/gist_id}", "starred_url": "https://api.github.com/users/the8472/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/the8472/subscriptions", "organizations_url": "https://api.github.com/users/the8472/orgs", "repos_url": "https://api.github.com/users/the8472/repos", "events_url": "https://api.github.com/users/the8472/events{/privacy}", "received_events_url": "https://api.github.com/users/the8472/received_events", "type": "User", "site_admin": false}, "committer": {"login": "the8472", "id": 1065730, "node_id": "MDQ6VXNlcjEwNjU3MzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1065730?v=4", "gravatar_id": "", "url": "https://api.github.com/users/the8472", "html_url": "https://github.com/the8472", "followers_url": "https://api.github.com/users/the8472/followers", "following_url": "https://api.github.com/users/the8472/following{/other_user}", "gists_url": "https://api.github.com/users/the8472/gists{/gist_id}", "starred_url": "https://api.github.com/users/the8472/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/the8472/subscriptions", "organizations_url": "https://api.github.com/users/the8472/orgs", "repos_url": "https://api.github.com/users/the8472/repos", "events_url": "https://api.github.com/users/the8472/events{/privacy}", "received_events_url": "https://api.github.com/users/the8472/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7425fb293f510a6f138e82a963a3bc599a5b9e1c", "url": "https://api.github.com/repos/rust-lang/rust/commits/7425fb293f510a6f138e82a963a3bc599a5b9e1c", "html_url": "https://github.com/rust-lang/rust/commit/7425fb293f510a6f138e82a963a3bc599a5b9e1c"}], "stats": {"total": 66, "additions": 64, "deletions": 2}, "files": [{"sha": "72ac897d4f178d0236193de5f24c516cd1c6692f", "filename": "library/alloc/benches/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/2f9f2e507eaecf45074727e34af02642b95fa724/library%2Falloc%2Fbenches%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f9f2e507eaecf45074727e34af02642b95fa724/library%2Falloc%2Fbenches%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Falloc%2Fbenches%2Flib.rs?ref=2f9f2e507eaecf45074727e34af02642b95fa724", "patch": "@@ -2,6 +2,7 @@\n // See https://github.com/rust-lang/rust/issues/73535#event-3477699747\n #![cfg(not(target_os = \"android\"))]\n #![feature(btree_drain_filter)]\n+#![feature(iter_next_chunk)]\n #![feature(map_first_last)]\n #![feature(repr_simd)]\n #![feature(slice_partition_dedup)]"}, {"sha": "663f6b9dd1c9c038cbe3fbad3cbcb753329d27ec", "filename": "library/alloc/benches/vec.rs", "status": "modified", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/2f9f2e507eaecf45074727e34af02642b95fa724/library%2Falloc%2Fbenches%2Fvec.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f9f2e507eaecf45074727e34af02642b95fa724/library%2Falloc%2Fbenches%2Fvec.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Falloc%2Fbenches%2Fvec.rs?ref=2f9f2e507eaecf45074727e34af02642b95fa724", "patch": "@@ -762,3 +762,23 @@ fn bench_retain_whole_100000(b: &mut Bencher) {\n     let mut v = black_box(vec![826u32; 100000]);\n     b.iter(|| v.retain(|x| *x == 826u32));\n }\n+\n+#[bench]\n+fn bench_next_chunk(b: &mut Bencher) {\n+    let v = vec![13u8; 2048];\n+\n+    b.iter(|| {\n+        const CHUNK: usize = 8;\n+\n+        let mut sum = [0u32; CHUNK];\n+        let mut iter = black_box(v.clone()).into_iter();\n+\n+        while let Ok(chunk) = iter.next_chunk::<CHUNK>() {\n+            for i in 0..CHUNK {\n+                sum[i] += chunk[i] as u32;\n+            }\n+        }\n+\n+        sum\n+    })\n+}"}, {"sha": "cabed9e82f8f984b449748953505aea1ec0223c6", "filename": "library/alloc/src/lib.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/2f9f2e507eaecf45074727e34af02642b95fa724/library%2Falloc%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f9f2e507eaecf45074727e34af02642b95fa724/library%2Falloc%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Falloc%2Fsrc%2Flib.rs?ref=2f9f2e507eaecf45074727e34af02642b95fa724", "patch": "@@ -90,6 +90,7 @@\n #![feature(alloc_layout_extra)]\n #![feature(allocator_api)]\n #![feature(array_chunks)]\n+#![feature(array_into_iter_constructors)]\n #![feature(array_methods)]\n #![feature(array_windows)]\n #![feature(assert_matches)]\n@@ -120,8 +121,11 @@\n #![feature(hasher_prefixfree_extras)]\n #![feature(inplace_iteration)]\n #![feature(iter_advance_by)]\n+#![feature(iter_next_chunk)]\n #![feature(layout_for_ptr)]\n+#![feature(maybe_uninit_array_assume_init)]\n #![feature(maybe_uninit_slice)]\n+#![feature(maybe_uninit_uninit_array)]\n #![cfg_attr(test, feature(new_uninit))]\n #![feature(nonnull_slice_from_raw_parts)]\n #![feature(pattern)]"}, {"sha": "1b483e3fc7793a499fcc236781eea1e5f96f8123", "filename": "library/alloc/src/vec/into_iter.rs", "status": "modified", "additions": 39, "deletions": 2, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/2f9f2e507eaecf45074727e34af02642b95fa724/library%2Falloc%2Fsrc%2Fvec%2Finto_iter.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f9f2e507eaecf45074727e34af02642b95fa724/library%2Falloc%2Fsrc%2Fvec%2Finto_iter.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Falloc%2Fsrc%2Fvec%2Finto_iter.rs?ref=2f9f2e507eaecf45074727e34af02642b95fa724", "patch": "@@ -2,13 +2,14 @@\n use super::AsVecIntoIter;\n use crate::alloc::{Allocator, Global};\n use crate::raw_vec::RawVec;\n+use core::array;\n use core::fmt;\n use core::intrinsics::arith_offset;\n use core::iter::{\n     FusedIterator, InPlaceIterable, SourceIter, TrustedLen, TrustedRandomAccessNoCoerce,\n };\n use core::marker::PhantomData;\n-use core::mem::{self, ManuallyDrop};\n+use core::mem::{self, ManuallyDrop, MaybeUninit};\n #[cfg(not(no_global_oom_handling))]\n use core::ops::Deref;\n use core::ptr::{self, NonNull};\n@@ -124,7 +125,6 @@ impl<T, A: Allocator> IntoIter<T, A> {\n     }\n \n     /// Forgets to Drop the remaining elements while still allowing the backing allocation to be freed.\n-    #[cfg(not(no_global_oom_handling))]\n     pub(crate) fn forget_remaining_elements(&mut self) {\n         self.ptr = self.end;\n     }\n@@ -204,6 +204,43 @@ impl<T, A: Allocator> Iterator for IntoIter<T, A> {\n         self.len()\n     }\n \n+    #[inline]\n+    fn next_chunk<const N: usize>(&mut self) -> Result<[T; N], core::array::IntoIter<T, N>> {\n+        let mut raw_ary = MaybeUninit::uninit_array();\n+\n+        let len = self.len();\n+\n+        if mem::size_of::<T>() == 0 {\n+            if len < N {\n+                self.forget_remaining_elements();\n+                // Safety: ZSTs can be conjured ex nihilo, only the amount has to be correct\n+                return Err(unsafe { array::IntoIter::new_unchecked(raw_ary, 0..len) });\n+            }\n+\n+            self.ptr = unsafe { arith_offset(self.ptr as *const i8, N as isize) as *mut T };\n+            // Safety: ditto\n+            return Ok(unsafe { MaybeUninit::array_assume_init(raw_ary) });\n+        }\n+\n+        if len < N {\n+            // Safety: `len` indicates that this many elements are available and we just checked that\n+            // it fits into the array.\n+            unsafe {\n+                ptr::copy_nonoverlapping(self.ptr, raw_ary.as_mut_ptr() as *mut T, len);\n+                self.forget_remaining_elements();\n+                return Err(array::IntoIter::new_unchecked(raw_ary, 0..len));\n+            }\n+        }\n+\n+        // Safety: `len` is larger than the array size. Copy a fixed amount here to fully initialize\n+        // the array.\n+        return unsafe {\n+            ptr::copy_nonoverlapping(self.ptr, raw_ary.as_mut_ptr() as *mut T, N);\n+            self.ptr = self.ptr.add(N);\n+            Ok(MaybeUninit::array_assume_init(raw_ary))\n+        };\n+    }\n+\n     unsafe fn __iterator_get_unchecked(&mut self, i: usize) -> Self::Item\n     where\n         Self: TrustedRandomAccessNoCoerce,"}]}