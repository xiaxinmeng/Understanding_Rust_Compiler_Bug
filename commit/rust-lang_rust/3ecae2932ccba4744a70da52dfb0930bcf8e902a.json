{"sha": "3ecae2932ccba4744a70da52dfb0930bcf8e902a", "node_id": "C_kwDOAAsO6NoAKDNlY2FlMjkzMmNjYmE0NzQ0YTcwZGE1MmRmYjA5MzBiY2Y4ZTkwMmE", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-04-24T05:53:25Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-04-24T05:53:25Z"}, "message": "Rollup merge of #110706 - scottmcm:transmute_unchecked, r=oli-obk\n\nAdd `intrinsics::transmute_unchecked`\n\nThis takes a whole 3 lines in `compiler/` since it lowers to `CastKind::Transmute` in MIR *exactly* the same as the existing `intrinsics::transmute` does, it just doesn't have the fancy checking in `hir_typeck`.\n\nAdded to enable experimenting with the request in <https://github.com/rust-lang/rust/pull/106281#issuecomment-1496648190> and because the portable-simd folks might be interested for dependently-sized array-vector conversions.\n\nIt also simplifies a couple places in `core`.\n\nSee also https://github.com/rust-lang/rust/pull/108442#issuecomment-1474777273, where `CastKind::Transmute` was added having exactly these semantics before the lang meeting (which I wasn't in) independently expressed interest.", "tree": {"sha": "bcab72d307cf760d83a5be21f62612866bcbad4f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bcab72d307cf760d83a5be21f62612866bcbad4f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3ecae2932ccba4744a70da52dfb0930bcf8e902a", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkRhlVCRBK7hj4Ov3rIwAAUWoIAEaatBYUzvXCx2qKZwQ0RCGv\naXoFaImFSTM0nlGqOAwqwYUSf5i/+pVkMdmB9DBC+fzhvxXV5k4viD7l10gS11Tb\nQbrmID1qWSWZ33dzQAoMbzOzfy5kZehyRUJAZfbtySbNWNWJ2nld5ke63BSTXDxB\nldBBAu4iT7a5OIR97EwL8kiMhSltFWQXJP3vQOcSu690oltfa8hRvMQ+8r1VXIg/\nklhSC4bcTcX5HzSGgzJoQYjgnofnOvvu7Uv4SXOOZ0tUlriurpBU/cK27F2rRtth\nAcZtsREGOH36pfxACgZp0q/hFzBqrGck9/3PSiIauj3CfCMy24HtJA9ASaFFFcA=\n=w8Ti\n-----END PGP SIGNATURE-----\n", "payload": "tree bcab72d307cf760d83a5be21f62612866bcbad4f\nparent 775682dc5e63fec7a062e84a32aa740ca5c45f0b\nparent 1de2257c3f6579028f2b8d97908ba12896abca61\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1682315605 +0200\ncommitter GitHub <noreply@github.com> 1682315605 +0200\n\nRollup merge of #110706 - scottmcm:transmute_unchecked, r=oli-obk\n\nAdd `intrinsics::transmute_unchecked`\n\nThis takes a whole 3 lines in `compiler/` since it lowers to `CastKind::Transmute` in MIR *exactly* the same as the existing `intrinsics::transmute` does, it just doesn't have the fancy checking in `hir_typeck`.\n\nAdded to enable experimenting with the request in <https://github.com/rust-lang/rust/pull/106281#issuecomment-1496648190> and because the portable-simd folks might be interested for dependently-sized array-vector conversions.\n\nIt also simplifies a couple places in `core`.\n\nSee also https://github.com/rust-lang/rust/pull/108442#issuecomment-1474777273, where `CastKind::Transmute` was added having exactly these semantics before the lang meeting (which I wasn't in) independently expressed interest.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3ecae2932ccba4744a70da52dfb0930bcf8e902a", "html_url": "https://github.com/rust-lang/rust/commit/3ecae2932ccba4744a70da52dfb0930bcf8e902a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3ecae2932ccba4744a70da52dfb0930bcf8e902a/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "775682dc5e63fec7a062e84a32aa740ca5c45f0b", "url": "https://api.github.com/repos/rust-lang/rust/commits/775682dc5e63fec7a062e84a32aa740ca5c45f0b", "html_url": "https://github.com/rust-lang/rust/commit/775682dc5e63fec7a062e84a32aa740ca5c45f0b"}, {"sha": "1de2257c3f6579028f2b8d97908ba12896abca61", "url": "https://api.github.com/repos/rust-lang/rust/commits/1de2257c3f6579028f2b8d97908ba12896abca61", "html_url": "https://github.com/rust-lang/rust/commit/1de2257c3f6579028f2b8d97908ba12896abca61"}], "stats": {"total": 97, "additions": 43, "deletions": 54}, "files": [{"sha": "0fcbaa2efabb865ac99999b0a99999974a9ebcf6", "filename": "compiler/rustc_hir_analysis/src/check/intrinsic.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3ecae2932ccba4744a70da52dfb0930bcf8e902a/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fintrinsic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3ecae2932ccba4744a70da52dfb0930bcf8e902a/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fintrinsic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fintrinsic.rs?ref=3ecae2932ccba4744a70da52dfb0930bcf8e902a", "patch": "@@ -198,7 +198,7 @@ pub fn check_intrinsic_type(tcx: TyCtxt<'_>, it: &hir::ForeignItem<'_>) {\n             | sym::assert_zero_valid\n             | sym::assert_mem_uninitialized_valid => (1, Vec::new(), tcx.mk_unit()),\n             sym::forget => (1, vec![param(0)], tcx.mk_unit()),\n-            sym::transmute => (2, vec![param(0)], param(1)),\n+            sym::transmute | sym::transmute_unchecked => (2, vec![param(0)], param(1)),\n             sym::prefetch_read_data\n             | sym::prefetch_write_data\n             | sym::prefetch_read_instruction"}, {"sha": "c7d3f6c9f044c1ded059b4ac5af09a170673dfe5", "filename": "compiler/rustc_mir_transform/src/lower_intrinsics.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3ecae2932ccba4744a70da52dfb0930bcf8e902a/compiler%2Frustc_mir_transform%2Fsrc%2Flower_intrinsics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3ecae2932ccba4744a70da52dfb0930bcf8e902a/compiler%2Frustc_mir_transform%2Fsrc%2Flower_intrinsics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Flower_intrinsics.rs?ref=3ecae2932ccba4744a70da52dfb0930bcf8e902a", "patch": "@@ -221,7 +221,7 @@ impl<'tcx> MirPass<'tcx> for LowerIntrinsics {\n                             terminator.kind = TerminatorKind::Goto { target };\n                         }\n                     }\n-                    sym::transmute => {\n+                    sym::transmute | sym::transmute_unchecked => {\n                         let dst_ty = destination.ty(local_decls, tcx).ty;\n                         let Ok([arg]) = <[_; 1]>::try_from(std::mem::take(args)) else {\n                             span_bug!("}, {"sha": "70b9088de506490502ac444b4ca5431487142e88", "filename": "compiler/rustc_span/src/symbol.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/3ecae2932ccba4744a70da52dfb0930bcf8e902a/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3ecae2932ccba4744a70da52dfb0930bcf8e902a/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs?ref=3ecae2932ccba4744a70da52dfb0930bcf8e902a", "patch": "@@ -1505,6 +1505,7 @@ symbols! {\n         transmute_generic_consts,\n         transmute_opts,\n         transmute_trait,\n+        transmute_unchecked,\n         transparent,\n         transparent_enums,\n         transparent_unions,"}, {"sha": "587877dff552f381c867cea8c6404899fb73d668", "filename": "library/core/src/array/iter.rs", "status": "modified", "additions": 6, "deletions": 12, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/3ecae2932ccba4744a70da52dfb0930bcf8e902a/library%2Fcore%2Fsrc%2Farray%2Fiter.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3ecae2932ccba4744a70da52dfb0930bcf8e902a/library%2Fcore%2Fsrc%2Farray%2Fiter.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Farray%2Fiter.rs?ref=3ecae2932ccba4744a70da52dfb0930bcf8e902a", "patch": "@@ -3,8 +3,9 @@\n use crate::num::NonZeroUsize;\n use crate::{\n     fmt,\n+    intrinsics::transmute_unchecked,\n     iter::{self, ExactSizeIterator, FusedIterator, TrustedLen},\n-    mem::{self, MaybeUninit},\n+    mem::MaybeUninit,\n     ops::{IndexRange, Range},\n     ptr,\n };\n@@ -63,18 +64,11 @@ impl<T, const N: usize> IntoIterator for [T; N] {\n         // an array of `T`.\n         //\n         // With that, this initialization satisfies the invariants.\n-\n-        // FIXME(LukasKalbertodt): actually use `mem::transmute` here, once it\n-        // works with const generics:\n-        //     `mem::transmute::<[T; N], [MaybeUninit<T>; N]>(array)`\n         //\n-        // Until then, we can use `mem::transmute_copy` to create a bitwise copy\n-        // as a different type, then forget `array` so that it is not dropped.\n-        unsafe {\n-            let iter = IntoIter { data: mem::transmute_copy(&self), alive: IndexRange::zero_to(N) };\n-            mem::forget(self);\n-            iter\n-        }\n+        // FIXME: If normal `transmute` ever gets smart enough to allow this\n+        // directly, use it instead of `transmute_unchecked`.\n+        let data: [MaybeUninit<T>; N] = unsafe { transmute_unchecked(self) };\n+        IntoIter { data, alive: IndexRange::zero_to(N) }\n     }\n }\n "}, {"sha": "39edfd8265b41d54cf90be27deb5f07f6fbae830", "filename": "library/core/src/intrinsics.rs", "status": "modified", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/3ecae2932ccba4744a70da52dfb0930bcf8e902a/library%2Fcore%2Fsrc%2Fintrinsics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3ecae2932ccba4744a70da52dfb0930bcf8e902a/library%2Fcore%2Fsrc%2Fintrinsics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fintrinsics.rs?ref=3ecae2932ccba4744a70da52dfb0930bcf8e902a", "patch": "@@ -1376,6 +1376,20 @@ extern \"rust-intrinsic\" {\n     #[rustc_nounwind]\n     pub fn transmute<Src, Dst>(src: Src) -> Dst;\n \n+    /// Like [`transmute`], but even less checked at compile-time: rather than\n+    /// giving an error for `size_of::<Src>() != size_of::<Dst>()`, it's\n+    /// **Undefined Behaviour** at runtime.\n+    ///\n+    /// Prefer normal `transmute` where possible, for the extra checking, since\n+    /// both do exactly the same thing at runtime, if they both compile.\n+    ///\n+    /// This is not expected to ever be exposed directly to users, rather it\n+    /// may eventually be exposed through some more-constrained API.\n+    #[cfg(not(bootstrap))]\n+    #[rustc_const_stable(feature = \"const_transmute\", since = \"1.56.0\")]\n+    #[rustc_nounwind]\n+    pub fn transmute_unchecked<Src, Dst>(src: Src) -> Dst;\n+\n     /// Returns `true` if the actual type given as `T` requires drop\n     /// glue; returns `false` if the actual type provided for `T`\n     /// implements `Copy`.\n@@ -2798,3 +2812,11 @@ pub const unsafe fn write_bytes<T>(dst: *mut T, val: u8, count: usize) {\n         write_bytes(dst, val, count)\n     }\n }\n+\n+/// Polyfill for bootstrap\n+#[cfg(bootstrap)]\n+pub const unsafe fn transmute_unchecked<Src, Dst>(src: Src) -> Dst {\n+    use crate::mem::*;\n+    // SAFETY: It's a transmute -- the caller promised it's fine.\n+    unsafe { transmute_copy(&ManuallyDrop::new(src)) }\n+}"}, {"sha": "2588b7d2befac4b71c866135f12416ddd16923a2", "filename": "library/core/src/mem/maybe_uninit.rs", "status": "modified", "additions": 3, "deletions": 7, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/3ecae2932ccba4744a70da52dfb0930bcf8e902a/library%2Fcore%2Fsrc%2Fmem%2Fmaybe_uninit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3ecae2932ccba4744a70da52dfb0930bcf8e902a/library%2Fcore%2Fsrc%2Fmem%2Fmaybe_uninit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fmem%2Fmaybe_uninit.rs?ref=3ecae2932ccba4744a70da52dfb0930bcf8e902a", "patch": "@@ -945,14 +945,10 @@ impl<T> MaybeUninit<T> {\n         // * `MaybeUninit<T>` and T are guaranteed to have the same layout\n         // * `MaybeUninit` does not drop, so there are no double-frees\n         // And thus the conversion is safe\n-        let ret = unsafe {\n+        unsafe {\n             intrinsics::assert_inhabited::<[T; N]>();\n-            (&array as *const _ as *const [T; N]).read()\n-        };\n-\n-        // FIXME: required to avoid `~const Destruct` bound\n-        super::forget(array);\n-        ret\n+            intrinsics::transmute_unchecked(array)\n+        }\n     }\n \n     /// Assuming all the elements are initialized, get a slice to them."}, {"sha": "664e697c2a5d2976539c759b992e78204ea62beb", "filename": "tests/codegen/intrinsics/transmute.rs", "status": "modified", "additions": 9, "deletions": 33, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/3ecae2932ccba4744a70da52dfb0930bcf8e902a/tests%2Fcodegen%2Fintrinsics%2Ftransmute.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3ecae2932ccba4744a70da52dfb0930bcf8e902a/tests%2Fcodegen%2Fintrinsics%2Ftransmute.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcodegen%2Fintrinsics%2Ftransmute.rs?ref=3ecae2932ccba4744a70da52dfb0930bcf8e902a", "patch": "@@ -8,10 +8,10 @@\n #![feature(inline_const)]\n #![allow(unreachable_code)]\n \n-use std::mem::{transmute, MaybeUninit};\n+use std::mem::MaybeUninit;\n+use std::intrinsics::{transmute, transmute_unchecked};\n \n-// Some of the cases here are statically rejected by `mem::transmute`, so\n-// we need to generate custom MIR for those cases to get to codegen.\n+// Some of these need custom MIR to not get removed by MIR optimizations.\n use std::intrinsics::mir::*;\n \n enum Never {}\n@@ -30,59 +30,35 @@ pub struct Aggregate8(u8);\n \n // CHECK-LABEL: @check_bigger_size(\n #[no_mangle]\n-#[custom_mir(dialect = \"runtime\", phase = \"initial\")]\n pub unsafe fn check_bigger_size(x: u16) -> u32 {\n     // CHECK: call void @llvm.trap\n-    mir!{\n-        {\n-            RET = CastTransmute(x);\n-            Return()\n-        }\n-    }\n+    transmute_unchecked(x)\n }\n \n // CHECK-LABEL: @check_smaller_size(\n #[no_mangle]\n-#[custom_mir(dialect = \"runtime\", phase = \"initial\")]\n pub unsafe fn check_smaller_size(x: u32) -> u16 {\n     // CHECK: call void @llvm.trap\n-    mir!{\n-        {\n-            RET = CastTransmute(x);\n-            Return()\n-        }\n-    }\n+    transmute_unchecked(x)\n }\n \n // CHECK-LABEL: @check_smaller_array(\n #[no_mangle]\n-#[custom_mir(dialect = \"runtime\", phase = \"initial\")]\n pub unsafe fn check_smaller_array(x: [u32; 7]) -> [u32; 3] {\n     // CHECK: call void @llvm.trap\n-    mir!{\n-        {\n-            RET = CastTransmute(x);\n-            Return()\n-        }\n-    }\n+    transmute_unchecked(x)\n }\n \n // CHECK-LABEL: @check_bigger_array(\n #[no_mangle]\n-#[custom_mir(dialect = \"runtime\", phase = \"initial\")]\n pub unsafe fn check_bigger_array(x: [u32; 3]) -> [u32; 7] {\n     // CHECK: call void @llvm.trap\n-    mir!{\n-        {\n-            RET = CastTransmute(x);\n-            Return()\n-        }\n-    }\n+    transmute_unchecked(x)\n }\n \n // CHECK-LABEL: @check_to_uninhabited(\n #[no_mangle]\n-#[custom_mir(dialect = \"runtime\", phase = \"initial\")]\n+#[custom_mir(dialect = \"runtime\", phase = \"optimized\")]\n pub unsafe fn check_to_uninhabited(x: u16) -> BigNever {\n     // CHECK: call void @llvm.trap\n     mir!{\n@@ -95,7 +71,7 @@ pub unsafe fn check_to_uninhabited(x: u16) -> BigNever {\n \n // CHECK-LABEL: @check_from_uninhabited(\n #[no_mangle]\n-#[custom_mir(dialect = \"runtime\", phase = \"initial\")]\n+#[custom_mir(dialect = \"runtime\", phase = \"optimized\")]\n pub unsafe fn check_from_uninhabited(x: BigNever) -> u16 {\n     // CHECK: ret i16 poison\n     mir!{"}]}