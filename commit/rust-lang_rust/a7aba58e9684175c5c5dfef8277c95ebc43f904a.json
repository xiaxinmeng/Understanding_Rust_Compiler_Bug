{"sha": "a7aba58e9684175c5c5dfef8277c95ebc43f904a", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE3YWJhNThlOTY4NDE3NWM1YzVkZmVmODI3N2M5NWViYzQzZjkwNGE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-04-24T02:25:54Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-04-24T02:25:54Z"}, "message": "Auto merge of #83722 - jyn514:stable-help, r=estebank\n\nOn stable, suggest removing `#![feature]` for features that have been stabilized\n\nI don't know how to test this (https://rust-lang.zulipchat.com/#narrow/stream/182449-t-compiler.2Fhelp/topic/Run.20tests.20without.20enabling.20nightly.20features.3F). I confirmed locally that this gives the\nappropriate help with `channel = \"beta\"`:\n\n```\nerror[E0554]: `#![feature]` may not be used on the beta release channel\n --> src/lib.rs:2:1\n  |\n2 | #![feature(min_const_generics)]\n  | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: remove the attribute\n  |\n  = help: the feature `min_const_generics` has been stable since 1.51.0 and no longer requires an attribute to enable\n\nerror[E0554]: `#![feature]` may not be used on the beta release channel\n --> src/lib.rs:3:1\n  |\n3 | #![feature(min_const_generics, min_specialization)]\n  | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  |\n  = help: the feature `min_const_generics` has been stable since 1.51.0 and no longer requires an attribute to enable\n\nerror[E0554]: `#![feature]` may not be used on the beta release channel\n --> src/lib.rs:4:1\n  |\n4 | #![feature(box_patterns)]\n  | ^^^^^^^^^^^^^^^^^^^^^^^^^\n```\n\nCloses https://github.com/rust-lang/rust/issues/83715.", "tree": {"sha": "415eb537541408015b2183b7c823c74d6e08e856", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/415eb537541408015b2183b7c823c74d6e08e856"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a7aba58e9684175c5c5dfef8277c95ebc43f904a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a7aba58e9684175c5c5dfef8277c95ebc43f904a", "html_url": "https://github.com/rust-lang/rust/commit/a7aba58e9684175c5c5dfef8277c95ebc43f904a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a7aba58e9684175c5c5dfef8277c95ebc43f904a/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8ad0821b035e35aed07ec252c2dd831c15a4e26e", "url": "https://api.github.com/repos/rust-lang/rust/commits/8ad0821b035e35aed07ec252c2dd831c15a4e26e", "html_url": "https://github.com/rust-lang/rust/commit/8ad0821b035e35aed07ec252c2dd831c15a4e26e"}, {"sha": "53a11050742ae1c59ccb33302a2d998cd35aed03", "url": "https://api.github.com/repos/rust-lang/rust/commits/53a11050742ae1c59ccb33302a2d998cd35aed03", "html_url": "https://github.com/rust-lang/rust/commit/53a11050742ae1c59ccb33302a2d998cd35aed03"}], "stats": {"total": 36, "additions": 33, "deletions": 3}, "files": [{"sha": "0679ccabe726c76c0f6178565f15d2894bdfe619", "filename": "compiler/rustc_ast_passes/src/feature_gate.rs", "status": "modified", "additions": 33, "deletions": 3, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/a7aba58e9684175c5c5dfef8277c95ebc43f904a/compiler%2Frustc_ast_passes%2Fsrc%2Ffeature_gate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a7aba58e9684175c5c5dfef8277c95ebc43f904a/compiler%2Frustc_ast_passes%2Fsrc%2Ffeature_gate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast_passes%2Fsrc%2Ffeature_gate.rs?ref=a7aba58e9684175c5c5dfef8277c95ebc43f904a", "patch": "@@ -727,16 +727,46 @@ pub fn check_crate(krate: &ast::Crate, sess: &Session) {\n }\n \n fn maybe_stage_features(sess: &Session, krate: &ast::Crate) {\n+    use rustc_errors::Applicability;\n+\n     if !sess.opts.unstable_features.is_nightly_build() {\n+        let lang_features = &sess.features_untracked().declared_lang_features;\n         for attr in krate.attrs.iter().filter(|attr| sess.check_name(attr, sym::feature)) {\n-            struct_span_err!(\n+            let mut err = struct_span_err!(\n                 sess.parse_sess.span_diagnostic,\n                 attr.span,\n                 E0554,\n                 \"`#![feature]` may not be used on the {} release channel\",\n                 option_env!(\"CFG_RELEASE_CHANNEL\").unwrap_or(\"(unknown)\")\n-            )\n-            .emit();\n+            );\n+            let mut all_stable = true;\n+            for ident in\n+                attr.meta_item_list().into_iter().flatten().map(|nested| nested.ident()).flatten()\n+            {\n+                let name = ident.name;\n+                let stable_since = lang_features\n+                    .iter()\n+                    .flat_map(|&(feature, _, since)| if feature == name { since } else { None })\n+                    .next();\n+                if let Some(since) = stable_since {\n+                    err.help(&format!(\n+                        \"the feature `{}` has been stable since {} and no longer requires \\\n+                                  an attribute to enable\",\n+                        name, since\n+                    ));\n+                } else {\n+                    all_stable = false;\n+                }\n+            }\n+            if all_stable {\n+                err.span_suggestion(\n+                    attr.span,\n+                    \"remove the attribute\",\n+                    String::new(),\n+                    Applicability::MachineApplicable,\n+                );\n+            }\n+            err.emit();\n         }\n     }\n }"}]}