{"sha": "444679f202742c8fd00e9d1c7fddfaa9a067e640", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQ0NDY3OWYyMDI3NDJjOGZkMDBlOWQxYzdmZGRmYWE5YTA2N2U2NDA=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-07-22T11:49:18Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-07-22T11:49:18Z"}, "message": "Merge #9674\n\n9674: fix: Fix pattern name resolution when name is also occupied in type namespace r=flodiebold a=jonas-schievink\n\nFixes https://github.com/rust-analyzer/rust-analyzer/issues/8694\n\nCo-authored-by: Jonas Schievink <jonasschievink@gmail.com>", "tree": {"sha": "e1ecd98ca1571694160e8f0f263f6032939ce42c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e1ecd98ca1571694160e8f0f263f6032939ce42c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/444679f202742c8fd00e9d1c7fddfaa9a067e640", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJg+Vs+CRBK7hj4Ov3rIwAAFNkIAJ6ilW1auknpD6Xiv/4VAU1K\nUMBLFqW7oJ0yGzj0XYdvI+u3+11bRHZM9DIsORLPjlf1U+k7ErhqLtSUrl0cVsI4\nQcJKvLKy6XKkvqnHS+prnoTSE8S+OqgjoPqqvEFKs6YZPUt3+/MTvQ0LOHWh1B8o\nLmQ8ypbf8mPxjPo0C4AAvmw0BHXvbv4djp+w9RjCSs7gnCSlXjmDtBJROzT+ss1V\nrx2nxcPKE0tGT4c8FbGtlswE0G7/guCOUvs3bYbEb0T6F0beYA+OhMay7uZn8pi5\nkYAVYKuhPRiaVCgpViWTzNwHWLSkvG5St+DUwVjlagaREnXtfnYvO+mpfUORiaY=\n=H1vy\n-----END PGP SIGNATURE-----\n", "payload": "tree e1ecd98ca1571694160e8f0f263f6032939ce42c\nparent 2fbecccc71a7026f2431ed45179e0cdf16e14ea2\nparent b596c32a4102643a1c45282092beafb5a31c16a4\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1626954558 +0000\ncommitter GitHub <noreply@github.com> 1626954558 +0000\n\nMerge #9674\n\n9674: fix: Fix pattern name resolution when name is also occupied in type namespace r=flodiebold a=jonas-schievink\n\nFixes https://github.com/rust-analyzer/rust-analyzer/issues/8694\n\nCo-authored-by: Jonas Schievink <jonasschievink@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/444679f202742c8fd00e9d1c7fddfaa9a067e640", "html_url": "https://github.com/rust-lang/rust/commit/444679f202742c8fd00e9d1c7fddfaa9a067e640", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/444679f202742c8fd00e9d1c7fddfaa9a067e640/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2fbecccc71a7026f2431ed45179e0cdf16e14ea2", "url": "https://api.github.com/repos/rust-lang/rust/commits/2fbecccc71a7026f2431ed45179e0cdf16e14ea2", "html_url": "https://github.com/rust-lang/rust/commit/2fbecccc71a7026f2431ed45179e0cdf16e14ea2"}, {"sha": "b596c32a4102643a1c45282092beafb5a31c16a4", "url": "https://api.github.com/repos/rust-lang/rust/commits/b596c32a4102643a1c45282092beafb5a31c16a4", "html_url": "https://github.com/rust-lang/rust/commit/b596c32a4102643a1c45282092beafb5a31c16a4"}], "stats": {"total": 62, "additions": 55, "deletions": 7}, "files": [{"sha": "a879ca3823b667cad7d2a062ae54408b9ae63f42", "filename": "crates/hir_ty/src/infer.rs", "status": "modified", "additions": 25, "deletions": 4, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/444679f202742c8fd00e9d1c7fddfaa9a067e640/crates%2Fhir_ty%2Fsrc%2Finfer.rs", "raw_url": "https://github.com/rust-lang/rust/raw/444679f202742c8fd00e9d1c7fddfaa9a067e640/crates%2Fhir_ty%2Fsrc%2Finfer.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Finfer.rs?ref=444679f202742c8fd00e9d1c7fddfaa9a067e640", "patch": "@@ -23,7 +23,7 @@ use hir_def::{\n     expr::{ArithOp, BinaryOp, BindingAnnotation, ExprId, PatId},\n     lang_item::LangItemTarget,\n     path::{path, Path},\n-    resolver::{HasResolver, Resolver, TypeNs},\n+    resolver::{HasResolver, ResolveValueResult, Resolver, TypeNs, ValueNs},\n     type_ref::TypeRef,\n     AdtId, AssocItemId, DefWithBodyId, EnumVariantId, FieldId, FunctionId, HasModule, Lookup,\n     TraitId, TypeAliasId, VariantId,\n@@ -548,7 +548,7 @@ impl<'a> InferenceContext<'a> {\n         self.table.normalize_associated_types_in(ty)\n     }\n \n-    fn resolve_variant(&mut self, path: Option<&Path>) -> (Ty, Option<VariantId>) {\n+    fn resolve_variant(&mut self, path: Option<&Path>, value_ns: bool) -> (Ty, Option<VariantId>) {\n         let path = match path {\n             Some(path) => path,\n             None => return (self.err_ty(), None),\n@@ -557,11 +557,32 @@ impl<'a> InferenceContext<'a> {\n         let ctx = crate::lower::TyLoweringContext::new(self.db, &self.resolver);\n         // FIXME: this should resolve assoc items as well, see this example:\n         // https://play.rust-lang.org/?gist=087992e9e22495446c01c0d4e2d69521\n-        let (resolution, unresolved) =\n+        let (resolution, unresolved) = if value_ns {\n+            match resolver.resolve_path_in_value_ns(self.db.upcast(), path.mod_path()) {\n+                Some(ResolveValueResult::ValueNs(value)) => match value {\n+                    ValueNs::EnumVariantId(var) => {\n+                        let substs = ctx.substs_from_path(path, var.into(), true);\n+                        let ty = self.db.ty(var.parent.into());\n+                        let ty = self.insert_type_vars(ty.substitute(&Interner, &substs));\n+                        return (ty, Some(var.into()));\n+                    }\n+                    ValueNs::StructId(strukt) => {\n+                        let substs = ctx.substs_from_path(path, strukt.into(), true);\n+                        let ty = self.db.ty(strukt.into());\n+                        let ty = self.insert_type_vars(ty.substitute(&Interner, &substs));\n+                        return (ty, Some(strukt.into()));\n+                    }\n+                    _ => return (self.err_ty(), None),\n+                },\n+                Some(ResolveValueResult::Partial(typens, unresolved)) => (typens, Some(unresolved)),\n+                None => return (self.err_ty(), None),\n+            }\n+        } else {\n             match resolver.resolve_path_in_type_ns(self.db.upcast(), path.mod_path()) {\n                 Some(it) => it,\n                 None => return (self.err_ty(), None),\n-            };\n+            }\n+        };\n         return match resolution {\n             TypeNs::AdtId(AdtId::StructId(strukt)) => {\n                 let substs = ctx.substs_from_path(path, strukt.into(), true);"}, {"sha": "d667613428f8cf76cbfdae0559bcd22897076069", "filename": "crates/hir_ty/src/infer/expr.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/444679f202742c8fd00e9d1c7fddfaa9a067e640/crates%2Fhir_ty%2Fsrc%2Finfer%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/444679f202742c8fd00e9d1c7fddfaa9a067e640/crates%2Fhir_ty%2Fsrc%2Finfer%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Finfer%2Fexpr.rs?ref=444679f202742c8fd00e9d1c7fddfaa9a067e640", "patch": "@@ -437,7 +437,7 @@ impl<'a> InferenceContext<'a> {\n                 TyKind::Never.intern(&Interner)\n             }\n             Expr::RecordLit { path, fields, spread } => {\n-                let (ty, def_id) = self.resolve_variant(path.as_deref());\n+                let (ty, def_id) = self.resolve_variant(path.as_deref(), false);\n                 if let Some(variant) = def_id {\n                     self.write_variant_resolution(tgt_expr.into(), variant);\n                 }"}, {"sha": "603237f944beec4e1f8df3e279895ee8441538a5", "filename": "crates/hir_ty/src/infer/pat.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/444679f202742c8fd00e9d1c7fddfaa9a067e640/crates%2Fhir_ty%2Fsrc%2Finfer%2Fpat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/444679f202742c8fd00e9d1c7fddfaa9a067e640/crates%2Fhir_ty%2Fsrc%2Finfer%2Fpat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Finfer%2Fpat.rs?ref=444679f202742c8fd00e9d1c7fddfaa9a067e640", "patch": "@@ -27,7 +27,7 @@ impl<'a> InferenceContext<'a> {\n         id: PatId,\n         ellipsis: Option<usize>,\n     ) -> Ty {\n-        let (ty, def) = self.resolve_variant(path);\n+        let (ty, def) = self.resolve_variant(path, true);\n         let var_data = def.map(|it| it.variant_data(self.db.upcast()));\n         if let Some(variant) = def {\n             self.write_variant_resolution(id.into(), variant);\n@@ -68,7 +68,7 @@ impl<'a> InferenceContext<'a> {\n         default_bm: BindingMode,\n         id: PatId,\n     ) -> Ty {\n-        let (ty, def) = self.resolve_variant(path);\n+        let (ty, def) = self.resolve_variant(path, false);\n         let var_data = def.map(|it| it.variant_data(self.db.upcast()));\n         if let Some(variant) = def {\n             self.write_variant_resolution(id.into(), variant);"}, {"sha": "778d19b747603a40cbb27370fe237726c94766d8", "filename": "crates/hir_ty/src/tests/patterns.rs", "status": "modified", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/444679f202742c8fd00e9d1c7fddfaa9a067e640/crates%2Fhir_ty%2Fsrc%2Ftests%2Fpatterns.rs", "raw_url": "https://github.com/rust-lang/rust/raw/444679f202742c8fd00e9d1c7fddfaa9a067e640/crates%2Fhir_ty%2Fsrc%2Ftests%2Fpatterns.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Ftests%2Fpatterns.rs?ref=444679f202742c8fd00e9d1c7fddfaa9a067e640", "patch": "@@ -889,3 +889,30 @@ fn main() {\n         \"#]],\n     );\n }\n+\n+#[test]\n+fn pattern_lookup_in_value_ns() {\n+    check_types(\n+        r#\"\n+use self::Constructor::*;\n+struct IntRange {\n+    range: (),\n+}\n+enum Constructor {\n+    IntRange(IntRange),\n+}\n+fn main() {\n+    match Constructor::IntRange(IntRange { range: () }) {\n+        IntRange(x) => {\n+            x;\n+          //^ IntRange\n+        }\n+        Constructor::IntRange(x) => {\n+            x;\n+          //^ IntRange\n+        }\n+    }\n+}\n+    \"#,\n+    );\n+}"}]}