{"sha": "8e15b6cfdeeb36aae27518ce6446452392ebc021", "node_id": "C_kwDOAAsO6NoAKDhlMTViNmNmZGVlYjM2YWFlMjc1MThjZTY0NDY0NTIzOTJlYmMwMjE", "commit": {"author": {"name": "Roc Yu", "email": "rocyu@protonmail.com", "date": "2022-04-09T23:14:29Z"}, "committer": {"name": "Roc Yu", "email": "rocyu@protonmail.com", "date": "2022-04-09T23:14:29Z"}, "message": "rustdoc: Reduce allocations in a `html::markdown` function", "tree": {"sha": "da5e56193db49ee4bc2247e7da6da114d0465aa4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/da5e56193db49ee4bc2247e7da6da114d0465aa4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8e15b6cfdeeb36aae27518ce6446452392ebc021", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEyzuvo1e1RYSrfuC8UGjOUUp50n8FAmJSE1UACgkQUGjOUUp5\n0n8n9hAAlbFtUGqJJr0HbKP/NbbX6uNYdQqdkgcuQu83rGXzOdLOoEpS/MLZHLou\ncsfJkDtbZeQw/NvDBWm1TWTA4nsXSJzyMxmX1wNn5XPUZkLDgj8Yh0HrAfdhJcwN\n0wcNodS7/iC1zEj+U/jvmgRcHbhpoLYNGwDn+DbYGwZvluccAWn0hmF+Tt+31WvB\n3GPnXgl/CGDYCclq+SX8PiFKiaaHigza5u7pLtrfCilt2e2fDdpaNHmn8Py7I1mJ\nYmjIlIUeWPejSEuym3gy3W3Nu3ikIhyZfPaxLJ7Fl2bupHYZ4mJQLb8sAhpwA4R3\n9UGmGnGSJzoFtrei7G5qzfxMMcRuujfXzGVF75qhDaXDvQwnlceXGSPMGjul8Mn9\nl+q8b7ra7n0YXyD4tJpPjN1xyeU5Zub7s8lUNZ9ajhdmM0dNxDx8g6YP/e8XuBUN\nfeTVg6ixEvusnKpcamtovLay6i4iLqwRbiPiZjYNpUTVcjl3xpOXtJMgBsVewryK\nE+Y/Gz+BfMo7pPlUONH2fwGaksX3QyUYemC9p0buV2DNtXkAdLwABliffVMLmRnl\nlsXFlZqBoe51kHEpfPJgVnk709lPuOBmGarFI9MNCSIhkK17luaFLpPE6+14Ob/G\nouG3m3Rrxx6QmuacLl5ZO9bP+Kz+7UD1br66PF2Q2Sog4wwIgW0=\n=8Uz2\n-----END PGP SIGNATURE-----", "payload": "tree da5e56193db49ee4bc2247e7da6da114d0465aa4\nparent 8bf93e9b6791acee3a594ed202fdfe45ad9952b5\nauthor Roc Yu <rocyu@protonmail.com> 1649546069 -0400\ncommitter Roc Yu <rocyu@protonmail.com> 1649546069 -0400\n\nrustdoc: Reduce allocations in a `html::markdown` function\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8e15b6cfdeeb36aae27518ce6446452392ebc021", "html_url": "https://github.com/rust-lang/rust/commit/8e15b6cfdeeb36aae27518ce6446452392ebc021", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8e15b6cfdeeb36aae27518ce6446452392ebc021/comments", "author": {"login": "vacuus", "id": 61440569, "node_id": "MDQ6VXNlcjYxNDQwNTY5", "avatar_url": "https://avatars.githubusercontent.com/u/61440569?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vacuus", "html_url": "https://github.com/vacuus", "followers_url": "https://api.github.com/users/vacuus/followers", "following_url": "https://api.github.com/users/vacuus/following{/other_user}", "gists_url": "https://api.github.com/users/vacuus/gists{/gist_id}", "starred_url": "https://api.github.com/users/vacuus/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vacuus/subscriptions", "organizations_url": "https://api.github.com/users/vacuus/orgs", "repos_url": "https://api.github.com/users/vacuus/repos", "events_url": "https://api.github.com/users/vacuus/events{/privacy}", "received_events_url": "https://api.github.com/users/vacuus/received_events", "type": "User", "site_admin": false}, "committer": {"login": "vacuus", "id": 61440569, "node_id": "MDQ6VXNlcjYxNDQwNTY5", "avatar_url": "https://avatars.githubusercontent.com/u/61440569?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vacuus", "html_url": "https://github.com/vacuus", "followers_url": "https://api.github.com/users/vacuus/followers", "following_url": "https://api.github.com/users/vacuus/following{/other_user}", "gists_url": "https://api.github.com/users/vacuus/gists{/gist_id}", "starred_url": "https://api.github.com/users/vacuus/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vacuus/subscriptions", "organizations_url": "https://api.github.com/users/vacuus/orgs", "repos_url": "https://api.github.com/users/vacuus/repos", "events_url": "https://api.github.com/users/vacuus/events{/privacy}", "received_events_url": "https://api.github.com/users/vacuus/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8bf93e9b6791acee3a594ed202fdfe45ad9952b5", "url": "https://api.github.com/repos/rust-lang/rust/commits/8bf93e9b6791acee3a594ed202fdfe45ad9952b5", "html_url": "https://github.com/rust-lang/rust/commit/8bf93e9b6791acee3a594ed202fdfe45ad9952b5"}], "stats": {"total": 12, "additions": 5, "deletions": 7}, "files": [{"sha": "943c521485b18e8b1e4a9b4d5aa0a8d4134bf867", "filename": "src/librustdoc/html/markdown.rs", "status": "modified", "additions": 5, "deletions": 7, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/8e15b6cfdeeb36aae27518ce6446452392ebc021/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8e15b6cfdeeb36aae27518ce6446452392ebc021/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs?ref=8e15b6cfdeeb36aae27518ce6446452392ebc021", "patch": "@@ -251,7 +251,7 @@ impl<'a, I: Iterator<Item = Event<'a>>> Iterator for CodeBlocks<'_, 'a, I> {\n             }\n         }\n         let lines = origtext.lines().filter_map(|l| map_line(l).for_html());\n-        let text = lines.collect::<Vec<Cow<'_, str>>>().join(\"\\n\");\n+        let text = lines.intersperse(\"\\n\".into()).collect::<String>();\n \n         let parse_result = match kind {\n             CodeBlockKind::Fenced(ref lang) => {\n@@ -291,15 +291,13 @@ impl<'a, I: Iterator<Item = Event<'a>>> Iterator for CodeBlocks<'_, 'a, I> {\n             let test = origtext\n                 .lines()\n                 .map(|l| map_line(l).for_code())\n-                .collect::<Vec<Cow<'_, str>>>()\n-                .join(\"\\n\");\n+                .intersperse(\"\\n\".into())\n+                .collect::<String>();\n             let krate = krate.as_ref().map(|s| &**s);\n             let (test, _, _) =\n                 doctest::make_test(&test, krate, false, &Default::default(), edition, None);\n             let channel = if test.contains(\"#![feature(\") { \"&amp;version=nightly\" } else { \"\" };\n \n-            let edition_string = format!(\"&amp;edition={}\", edition);\n-\n             // These characters don't need to be escaped in a URI.\n             // FIXME: use a library function for percent encoding.\n             fn dont_escape(c: u8) -> bool {\n@@ -325,8 +323,8 @@ impl<'a, I: Iterator<Item = Event<'a>>> Iterator for CodeBlocks<'_, 'a, I> {\n                 }\n             }\n             Some(format!(\n-                r#\"<a class=\"test-arrow\" target=\"_blank\" href=\"{}?code={}{}{}\">Run</a>\"#,\n-                url, test_escaped, channel, edition_string\n+                r#\"<a class=\"test-arrow\" target=\"_blank\" href=\"{}?code={}{}&amp;edition={}\">Run</a>\"#,\n+                url, test_escaped, channel, edition,\n             ))\n         });\n "}]}