{"sha": "b7b9cd5e678ca824f0b12d0b8c44107587ffd051", "node_id": "C_kwDOAAsO6NoAKGI3YjljZDVlNjc4Y2E4MjRmMGIxMmQwYjhjNDQxMDc1ODdmZmQwNTE", "commit": {"author": {"name": "Dezhi Wu", "email": "wu543065657@163.com", "date": "2021-10-20T07:05:32Z"}, "committer": {"name": "Dezhi Wu", "email": "wu543065657@163.com", "date": "2021-10-20T07:05:32Z"}, "message": "Fix: only shows one # when we encounter ##", "tree": {"sha": "4eab072315b969a678f66b9b0721c8059ed7b2ea", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4eab072315b969a678f66b9b0721c8059ed7b2ea"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b7b9cd5e678ca824f0b12d0b8c44107587ffd051", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b7b9cd5e678ca824f0b12d0b8c44107587ffd051", "html_url": "https://github.com/rust-lang/rust/commit/b7b9cd5e678ca824f0b12d0b8c44107587ffd051", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b7b9cd5e678ca824f0b12d0b8c44107587ffd051/comments", "author": {"login": "dzvon", "id": 3402811, "node_id": "MDQ6VXNlcjM0MDI4MTE=", "avatar_url": "https://avatars.githubusercontent.com/u/3402811?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dzvon", "html_url": "https://github.com/dzvon", "followers_url": "https://api.github.com/users/dzvon/followers", "following_url": "https://api.github.com/users/dzvon/following{/other_user}", "gists_url": "https://api.github.com/users/dzvon/gists{/gist_id}", "starred_url": "https://api.github.com/users/dzvon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dzvon/subscriptions", "organizations_url": "https://api.github.com/users/dzvon/orgs", "repos_url": "https://api.github.com/users/dzvon/repos", "events_url": "https://api.github.com/users/dzvon/events{/privacy}", "received_events_url": "https://api.github.com/users/dzvon/received_events", "type": "User", "site_admin": false}, "committer": {"login": "dzvon", "id": 3402811, "node_id": "MDQ6VXNlcjM0MDI4MTE=", "avatar_url": "https://avatars.githubusercontent.com/u/3402811?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dzvon", "html_url": "https://github.com/dzvon", "followers_url": "https://api.github.com/users/dzvon/followers", "following_url": "https://api.github.com/users/dzvon/following{/other_user}", "gists_url": "https://api.github.com/users/dzvon/gists{/gist_id}", "starred_url": "https://api.github.com/users/dzvon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dzvon/subscriptions", "organizations_url": "https://api.github.com/users/dzvon/orgs", "repos_url": "https://api.github.com/users/dzvon/repos", "events_url": "https://api.github.com/users/dzvon/events{/privacy}", "received_events_url": "https://api.github.com/users/dzvon/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5051717856dd325027e003c6b64497a2b113ba07", "url": "https://api.github.com/repos/rust-lang/rust/commits/5051717856dd325027e003c6b64497a2b113ba07", "html_url": "https://github.com/rust-lang/rust/commit/5051717856dd325027e003c6b64497a2b113ba07"}], "stats": {"total": 26, "additions": 23, "deletions": 3}, "files": [{"sha": "9ffd085b0c3a15cce454b1e00579d4984969f0ef", "filename": "crates/rust-analyzer/src/markdown.rs", "status": "modified", "additions": 23, "deletions": 3, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/b7b9cd5e678ca824f0b12d0b8c44107587ffd051/crates%2Frust-analyzer%2Fsrc%2Fmarkdown.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b7b9cd5e678ca824f0b12d0b8c44107587ffd051/crates%2Frust-analyzer%2Fsrc%2Fmarkdown.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fmarkdown.rs?ref=b7b9cd5e678ca824f0b12d0b8c44107587ffd051", "patch": "@@ -1,4 +1,6 @@\n //! Transforms markdown\n+use std::borrow::Cow;\n+\n use ide_db::helpers::rust_doc::is_rust_fence;\n \n const RUSTDOC_FENCE: &str = \"```\";\n@@ -8,8 +10,9 @@ pub(crate) fn format_docs(src: &str) -> String {\n     let mut in_code_block = false;\n     let mut is_rust = false;\n \n-    for mut line in src.lines() {\n-        if in_code_block && is_rust && code_line_ignored_by_rustdoc(line) {\n+    for line in src.lines() {\n+        let mut line = Cow::from(line);\n+        if in_code_block && is_rust && code_line_ignored_by_rustdoc(&line) {\n             continue;\n         }\n \n@@ -20,11 +23,18 @@ pub(crate) fn format_docs(src: &str) -> String {\n                 is_rust = is_rust_fence(header);\n \n                 if is_rust {\n-                    line = \"```rust\";\n+                    line = Cow::Borrowed(\"```rust\");\n                 }\n             }\n         }\n \n+        if in_code_block {\n+            let trimmed = line.trim();\n+            if trimmed.starts_with(\"##\") {\n+                line = Cow::Owned(line.replacen(\"##\", \"#\", 1));\n+            }\n+        }\n+\n         processed_lines.push(line);\n     }\n     processed_lines.join(\"\\n\")\n@@ -136,4 +146,14 @@ let a = 1;\n             \"```text\\nfiller\\ntext\\n```\\nSome comment.\\n```rust\\nlet a = 1;\\n```\"\n         );\n     }\n+\n+    #[test]\n+    fn test_format_docs_handles_escape_double_hashes() {\n+        let comment = r#\"```rust\n+let s = \"foo\n+## bar # baz\";\n+```\"#;\n+\n+        assert_eq!(format_docs(comment), \"```rust\\nlet s = \\\"foo\\n# bar # baz\\\";\\n```\");\n+    }\n }"}]}