{"sha": "236576227a299fd19ba836b1834ab50c948af994", "node_id": "C_kwDOAAsO6NoAKDIzNjU3NjIyN2EyOTlmZDE5YmE4MzZiMTgzNGFiNTBjOTQ4YWY5OTQ", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-04-02T11:36:47Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-04-02T11:36:47Z"}, "message": "Auto merge of #14468 - lowr:patch/expand-macro-bang, r=Veykril\n\nExpand Macro Recursively: don't append \"!\" to non-bang macro name\n\nWhen we run `Expand Macro Recursively`, we prepend a comment \"Recursive expansion of foo! macro\" to the expansion result. I've noticed we unconditionally render the macro name with \"!\" and, while super subtle, I feel a bit awkward when the macro is either a derive or attribute macro.", "tree": {"sha": "b37bb4a5dff974fa292d9572839773a43abeeea0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b37bb4a5dff974fa292d9572839773a43abeeea0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/236576227a299fd19ba836b1834ab50c948af994", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/236576227a299fd19ba836b1834ab50c948af994", "html_url": "https://github.com/rust-lang/rust/commit/236576227a299fd19ba836b1834ab50c948af994", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/236576227a299fd19ba836b1834ab50c948af994/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1ebac28f0d47341173a1271b050e4a07693c8bc6", "url": "https://api.github.com/repos/rust-lang/rust/commits/1ebac28f0d47341173a1271b050e4a07693c8bc6", "html_url": "https://github.com/rust-lang/rust/commit/1ebac28f0d47341173a1271b050e4a07693c8bc6"}, {"sha": "613e008593f1caa0b799c1ca5048bd50d28190fd", "url": "https://api.github.com/repos/rust-lang/rust/commits/613e008593f1caa0b799c1ca5048bd50d28190fd", "html_url": "https://github.com/rust-lang/rust/commit/613e008593f1caa0b799c1ca5048bd50d28190fd"}], "stats": {"total": 44, "additions": 23, "deletions": 21}, "files": [{"sha": "4382af434388d8909d2955320e7e400eb8f36063", "filename": "crates/ide/src/expand_macro.rs", "status": "modified", "additions": 22, "deletions": 20, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/236576227a299fd19ba836b1834ab50c948af994/crates%2Fide%2Fsrc%2Fexpand_macro.rs", "raw_url": "https://github.com/rust-lang/rust/raw/236576227a299fd19ba836b1834ab50c948af994/crates%2Fide%2Fsrc%2Fexpand_macro.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fexpand_macro.rs?ref=236576227a299fd19ba836b1834ab50c948af994", "patch": "@@ -83,8 +83,10 @@ pub(crate) fn expand_macro(db: &RootDatabase, position: FilePosition) -> Option<\n             }\n         }\n         if let Some(mac) = ast::MacroCall::cast(node) {\n+            let mut name = mac.path()?.segment()?.name_ref()?.to_string();\n+            name.push('!');\n             break (\n-                mac.path()?.segment()?.name_ref()?.to_string(),\n+                name,\n                 expand_macro_recur(&sema, &mac)?,\n                 mac.syntax().parent().map(|it| it.kind()).unwrap_or(SyntaxKind::MACRO_ITEMS),\n             );\n@@ -235,7 +237,7 @@ fn main() {\n }\n \"#,\n             expect![[r#\"\n-                bar\n+                bar!\n                 5i64 as _\"#]],\n         );\n     }\n@@ -252,7 +254,7 @@ fn main() {\n }\n \"#,\n             expect![[r#\"\n-                bar\n+                bar!\n                 for _ in 0..42{}\"#]],\n         );\n     }\n@@ -273,7 +275,7 @@ macro_rules! baz {\n f$0oo!();\n \"#,\n             expect![[r#\"\n-                foo\n+                foo!\n                 fn b(){}\n             \"#]],\n         );\n@@ -294,7 +296,7 @@ macro_rules! foo {\n f$0oo!();\n         \"#,\n             expect![[r#\"\n-                foo\n+                foo!\n                 fn some_thing() -> u32 {\n                   let a = 0;\n                   a+10\n@@ -328,16 +330,16 @@ fn main() {\n }\n \"#,\n             expect![[r#\"\n-       match_ast\n-       {\n-         if let Some(it) = ast::TraitDef::cast(container.clone()){}\n-         else if let Some(it) = ast::ImplDef::cast(container.clone()){}\n-         else {\n-           {\n-             continue\n-           }\n-         }\n-       }\"#]],\n+                match_ast!\n+                {\n+                  if let Some(it) = ast::TraitDef::cast(container.clone()){}\n+                  else if let Some(it) = ast::ImplDef::cast(container.clone()){}\n+                  else {\n+                    {\n+                      continue\n+                    }\n+                  }\n+                }\"#]],\n         );\n     }\n \n@@ -358,7 +360,7 @@ fn main() {\n }\n \"#,\n             expect![[r#\"\n-                match_ast\n+                match_ast!\n                 {}\"#]],\n         );\n     }\n@@ -383,7 +385,7 @@ fn main() {\n }\n             \"#,\n             expect![[r#\"\n-                foo\n+                foo!\n                 {\n                   macro_rules! bar {\n                     () => {\n@@ -411,7 +413,7 @@ fn main() {\n }\n \"#,\n             expect![[r#\"\n-                foo\n+                foo!\n             \"#]],\n         );\n     }\n@@ -433,7 +435,7 @@ fn main() {\n }\n \"#,\n             expect![[r#\"\n-                foo\n+                foo!\n                 0\"#]],\n         );\n     }\n@@ -451,7 +453,7 @@ fn main() {\n }\n \"#,\n             expect![[r#\"\n-                foo\n+                foo!\n                 fn f<T>(_: &dyn ::std::marker::Copy){}\"#]],\n         );\n     }"}, {"sha": "7a8490e4767e34766d87526c6fd16f8bb92ae9e3", "filename": "editors/code/src/commands.ts", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/236576227a299fd19ba836b1834ab50c948af994/editors%2Fcode%2Fsrc%2Fcommands.ts", "raw_url": "https://github.com/rust-lang/rust/raw/236576227a299fd19ba836b1834ab50c948af994/editors%2Fcode%2Fsrc%2Fcommands.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fcommands.ts?ref=236576227a299fd19ba836b1834ab50c948af994", "patch": "@@ -699,7 +699,7 @@ export function viewFullCrateGraph(ctx: CtxInit): Cmd {\n // The contents of the file come from the `TextDocumentContentProvider`\n export function expandMacro(ctx: CtxInit): Cmd {\n     function codeFormat(expanded: ra.ExpandedMacro): string {\n-        let result = `// Recursive expansion of ${expanded.name}! macro\\n`;\n+        let result = `// Recursive expansion of ${expanded.name} macro\\n`;\n         result += \"// \" + \"=\".repeat(result.length - 3);\n         result += \"\\n\\n\";\n         result += expanded.expansion;"}]}