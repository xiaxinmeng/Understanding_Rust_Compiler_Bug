{"sha": "621f2b7e905644eac2770937434c42f810824631", "node_id": "MDY6Q29tbWl0NzI0NzEyOjYyMWYyYjdlOTA1NjQ0ZWFjMjc3MDkzNzQzNGM0MmY4MTA4MjQ2MzE=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2020-03-21T04:33:30Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-03-21T04:33:30Z"}, "message": "Rollup merge of #70184 - Centril:include-mod-relativism, r=petrochenkov\n\nexpand_include: set `.directory` to dir of included file.\n\nResolves the regression noted in https://github.com/rust-lang/rust/pull/69838/#discussion_r395217057.\n\nr? @petrochenkov\ncc @eddyb @Mark-Simulacrum", "tree": {"sha": "81f227ae0a9a678fb8dba6ba7b38ff1d3306c785", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/81f227ae0a9a678fb8dba6ba7b38ff1d3306c785"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/621f2b7e905644eac2770937434c42f810824631", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJedZkaCRBK7hj4Ov3rIwAAdHIIADHfZ1gxVRVmcf+7WA7wSLSk\nPrMpP2CT7r/hZRtbVxVCVvnBWKJhyFILURZHGWNv1Y2bF+NvHI9Vcq+mn7CBpkT1\n1Dlq5dVKV5tBC+iVZYZC/zony0gPFngvw1wVrVHdZb0UJuKiQaN+06iX0/J3WqGq\nvOkoYhmhHKsPuQM2+srKKIwiPjohF87RZFVLztVmbtybCQyZbW3vM83LqEDucWVg\nAqmDF5s7RhPWTR9qg5zMolofNfCxhB7pG0N0Rccte/7+BPpaL8HzYFInlnWG5Aci\nPOipOx8Vok5Bd88Kw4RTt7mrbIJrposI9NnwlwYxTREqWaXSuUAwI798Y83nTso=\n=iaAz\n-----END PGP SIGNATURE-----\n", "payload": "tree 81f227ae0a9a678fb8dba6ba7b38ff1d3306c785\nparent a3771e4a98fca99278a0cde363389ba98ea0bd45\nparent 0d018a57556d5031601721b2386767f8566243e8\nauthor Mazdak Farrokhzad <twingoow@gmail.com> 1584765210 +0100\ncommitter GitHub <noreply@github.com> 1584765210 +0100\n\nRollup merge of #70184 - Centril:include-mod-relativism, r=petrochenkov\n\nexpand_include: set `.directory` to dir of included file.\n\nResolves the regression noted in https://github.com/rust-lang/rust/pull/69838/#discussion_r395217057.\n\nr? @petrochenkov\ncc @eddyb @Mark-Simulacrum\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/621f2b7e905644eac2770937434c42f810824631", "html_url": "https://github.com/rust-lang/rust/commit/621f2b7e905644eac2770937434c42f810824631", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/621f2b7e905644eac2770937434c42f810824631/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a3771e4a98fca99278a0cde363389ba98ea0bd45", "url": "https://api.github.com/repos/rust-lang/rust/commits/a3771e4a98fca99278a0cde363389ba98ea0bd45", "html_url": "https://github.com/rust-lang/rust/commit/a3771e4a98fca99278a0cde363389ba98ea0bd45"}, {"sha": "0d018a57556d5031601721b2386767f8566243e8", "url": "https://api.github.com/repos/rust-lang/rust/commits/0d018a57556d5031601721b2386767f8566243e8", "html_url": "https://github.com/rust-lang/rust/commit/0d018a57556d5031601721b2386767f8566243e8"}], "stats": {"total": 26, "additions": 25, "deletions": 1}, "files": [{"sha": "718498f04b94ed56fbc63665559eb8cddb3a0367", "filename": "src/librustc_builtin_macros/source_util.rs", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/621f2b7e905644eac2770937434c42f810824631/src%2Flibrustc_builtin_macros%2Fsource_util.rs", "raw_url": "https://github.com/rust-lang/rust/raw/621f2b7e905644eac2770937434c42f810824631/src%2Flibrustc_builtin_macros%2Fsource_util.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_builtin_macros%2Fsource_util.rs?ref=621f2b7e905644eac2770937434c42f810824631", "patch": "@@ -4,13 +4,15 @@ use rustc_ast::token;\n use rustc_ast::tokenstream::TokenStream;\n use rustc_ast_pretty::pprust;\n use rustc_expand::base::{self, *};\n+use rustc_expand::module::DirectoryOwnership;\n use rustc_expand::panictry;\n use rustc_parse::{self, new_sub_parser_from_file, parser::Parser};\n use rustc_session::lint::builtin::INCOMPLETE_INCLUDE;\n use rustc_span::symbol::Symbol;\n use rustc_span::{self, Pos, Span};\n \n use smallvec::SmallVec;\n+use std::rc::Rc;\n \n use rustc_data_structures::sync::Lrc;\n \n@@ -101,7 +103,7 @@ pub fn expand_include<'cx>(\n         None => return DummyResult::any(sp),\n     };\n     // The file will be added to the code map by the parser\n-    let file = match cx.resolve_path(file, sp) {\n+    let mut file = match cx.resolve_path(file, sp) {\n         Ok(f) => f,\n         Err(mut err) => {\n             err.emit();\n@@ -110,6 +112,15 @@ pub fn expand_include<'cx>(\n     };\n     let p = new_sub_parser_from_file(cx.parse_sess(), &file, None, sp);\n \n+    // If in the included file we have e.g., `mod bar;`,\n+    // then the path of `bar.rs` should be relative to the directory of `file`.\n+    // See https://github.com/rust-lang/rust/pull/69838/files#r395217057 for a discussion.\n+    // `MacroExpander::fully_expand_fragment` later restores, so \"stack discipline\" is maintained.\n+    file.pop();\n+    cx.current_expansion.directory_ownership = DirectoryOwnership::Owned { relative: None };\n+    let mod_path = cx.current_expansion.module.mod_path.clone();\n+    cx.current_expansion.module = Rc::new(ModuleData { mod_path, directory: file });\n+\n     struct ExpandResult<'a> {\n         p: Parser<'a>,\n     }"}, {"sha": "ec12f8c5cb442ee72def5fa4e2e4a593d5f2795a", "filename": "src/test/ui/macros/issue-69838-dir/bar.rs", "status": "added", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/621f2b7e905644eac2770937434c42f810824631/src%2Ftest%2Fui%2Fmacros%2Fissue-69838-dir%2Fbar.rs", "raw_url": "https://github.com/rust-lang/rust/raw/621f2b7e905644eac2770937434c42f810824631/src%2Ftest%2Fui%2Fmacros%2Fissue-69838-dir%2Fbar.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacros%2Fissue-69838-dir%2Fbar.rs?ref=621f2b7e905644eac2770937434c42f810824631", "patch": "@@ -0,0 +1,3 @@\n+// ignore-test -- this is an auxiliary file as part of another test.\n+\n+pub fn i_am_in_bar() {}"}, {"sha": "9900b8fd5092cfdd36ccc3cf931e5ea520d3eec7", "filename": "src/test/ui/macros/issue-69838-dir/included.rs", "status": "added", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/621f2b7e905644eac2770937434c42f810824631/src%2Ftest%2Fui%2Fmacros%2Fissue-69838-dir%2Fincluded.rs", "raw_url": "https://github.com/rust-lang/rust/raw/621f2b7e905644eac2770937434c42f810824631/src%2Ftest%2Fui%2Fmacros%2Fissue-69838-dir%2Fincluded.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacros%2Fissue-69838-dir%2Fincluded.rs?ref=621f2b7e905644eac2770937434c42f810824631", "patch": "@@ -0,0 +1,3 @@\n+// ignore-test -- this is an auxiliary file as part of another test.\n+\n+pub mod bar;"}, {"sha": "2a4e97f0ef5f18c084e55e69468bd4cb845025bd", "filename": "src/test/ui/macros/issue-69838-mods-relative-to-included-path.rs", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/621f2b7e905644eac2770937434c42f810824631/src%2Ftest%2Fui%2Fmacros%2Fissue-69838-mods-relative-to-included-path.rs", "raw_url": "https://github.com/rust-lang/rust/raw/621f2b7e905644eac2770937434c42f810824631/src%2Ftest%2Fui%2Fmacros%2Fissue-69838-mods-relative-to-included-path.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacros%2Fissue-69838-mods-relative-to-included-path.rs?ref=621f2b7e905644eac2770937434c42f810824631", "patch": "@@ -0,0 +1,7 @@\n+// check-pass\n+\n+include!(\"issue-69838-dir/included.rs\");\n+\n+fn main() {\n+    bar::i_am_in_bar();\n+}"}]}