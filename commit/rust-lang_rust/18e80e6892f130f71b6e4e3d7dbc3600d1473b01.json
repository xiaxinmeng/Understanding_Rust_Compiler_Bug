{"sha": "18e80e6892f130f71b6e4e3d7dbc3600d1473b01", "node_id": "C_kwDOAAsO6NoAKDE4ZTgwZTY4OTJmMTMwZjcxYjZlNGUzZDdkYmMzNjAwZDE0NzNiMDE", "commit": {"author": {"name": "Jonas Schievink", "email": "jonas.schievink@ferrous-systems.com", "date": "2022-01-12T19:19:10Z"}, "committer": {"name": "Jonas Schievink", "email": "jonas.schievink@ferrous-systems.com", "date": "2022-01-12T19:21:13Z"}, "message": "Remove `ModuleId` from `hir` reexports", "tree": {"sha": "c1579dcc2b89905cb28687307d7f89669391db94", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c1579dcc2b89905cb28687307d7f89669391db94"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/18e80e6892f130f71b6e4e3d7dbc3600d1473b01", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/18e80e6892f130f71b6e4e3d7dbc3600d1473b01", "html_url": "https://github.com/rust-lang/rust/commit/18e80e6892f130f71b6e4e3d7dbc3600d1473b01", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/18e80e6892f130f71b6e4e3d7dbc3600d1473b01/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "16d3a7bf08f0bef707cf7cb7f084d7ff02e03454", "url": "https://api.github.com/repos/rust-lang/rust/commits/16d3a7bf08f0bef707cf7cb7f084d7ff02e03454", "html_url": "https://github.com/rust-lang/rust/commit/16d3a7bf08f0bef707cf7cb7f084d7ff02e03454"}], "stats": {"total": 94, "additions": 50, "deletions": 44}, "files": [{"sha": "871440692580135e31115d568fee70907fa0e997", "filename": "crates/hir/src/lib.rs", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/18e80e6892f130f71b6e4e3d7dbc3600d1473b01/crates%2Fhir%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/18e80e6892f130f71b6e4e3d7dbc3600d1473b01/crates%2Fhir%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Flib.rs?ref=18e80e6892f130f71b6e4e3d7dbc3600d1473b01", "patch": "@@ -49,7 +49,7 @@ use hir_def::{\n     src::HasSource as _,\n     AdtId, AssocItemId, AssocItemLoc, AttrDefId, ConstId, ConstParamId, DefWithBodyId, EnumId,\n     FunctionId, GenericDefId, HasModule, ImplId, ItemContainerId, LifetimeParamId,\n-    LocalEnumVariantId, LocalFieldId, Lookup, StaticId, StructId, TraitId, TypeAliasId,\n+    LocalEnumVariantId, LocalFieldId, Lookup, ModuleId, StaticId, StructId, TraitId, TypeAliasId,\n     TypeParamId, UnionId,\n };\n use hir_expand::{name::name, MacroCallKind, MacroDefKind};\n@@ -115,7 +115,6 @@ pub use {\n         path::{ModPath, PathKind},\n         type_ref::{Mutability, TypeRef},\n         visibility::Visibility,\n-        ModuleId,\n     },\n     hir_expand::{\n         name::{known, Name},\n@@ -183,6 +182,11 @@ impl Crate {\n         Module { id: def_map.module_id(def_map.root()) }\n     }\n \n+    pub fn modules(self, db: &dyn HirDatabase) -> Vec<Module> {\n+        let def_map = db.crate_def_map(self.id);\n+        def_map.modules().map(|(id, _)| def_map.module_id(id).into()).collect()\n+    }\n+\n     pub fn root_file(self, db: &dyn HirDatabase) -> FileId {\n         db.crate_graph()[self.id].root_file_id\n     }"}, {"sha": "f1669d528845347a9a7cd7e0f3219e68227b3785", "filename": "crates/hir/src/symbols.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/18e80e6892f130f71b6e4e3d7dbc3600d1473b01/crates%2Fhir%2Fsrc%2Fsymbols.rs", "raw_url": "https://github.com/rust-lang/rust/raw/18e80e6892f130f71b6e4e3d7dbc3600d1473b01/crates%2Fhir%2Fsrc%2Fsymbols.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Fsymbols.rs?ref=18e80e6892f130f71b6e4e3d7dbc3600d1473b01", "patch": "@@ -102,14 +102,14 @@ pub struct SymbolCollector<'a> {\n /// Given a [`ModuleId`] and a [`HirDatabase`], use the DefMap for the module's crate to collect\n /// all symbols that should be indexed for the given module.\n impl<'a> SymbolCollector<'a> {\n-    pub fn collect(db: &dyn HirDatabase, module_id: ModuleId) -> Vec<FileSymbol> {\n+    pub fn collect(db: &dyn HirDatabase, module: Module) -> Vec<FileSymbol> {\n         let mut symbol_collector = SymbolCollector {\n             db,\n             symbols: Default::default(),\n             current_container_name: None,\n             // The initial work is the root module we're collecting, additional work will\n             // be populated as we traverse the module's definitions.\n-            work: vec![SymbolCollectorWork { module_id, parent: None }],\n+            work: vec![SymbolCollectorWork { module_id: module.into(), parent: None }],\n         };\n \n         while let Some(work) = symbol_collector.work.pop() {"}, {"sha": "9697ba24b80074374ebb64dcfabb838c569b8181", "filename": "crates/ide_db/src/symbol_index.rs", "status": "modified", "additions": 18, "deletions": 22, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/18e80e6892f130f71b6e4e3d7dbc3600d1473b01/crates%2Fide_db%2Fsrc%2Fsymbol_index.rs", "raw_url": "https://github.com/rust-lang/rust/raw/18e80e6892f130f71b6e4e3d7dbc3600d1473b01/crates%2Fide_db%2Fsrc%2Fsymbol_index.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_db%2Fsrc%2Fsymbol_index.rs?ref=18e80e6892f130f71b6e4e3d7dbc3600d1473b01", "patch": "@@ -30,13 +30,13 @@ use std::{\n \n use base_db::{\n     salsa::{self, ParallelDatabase},\n-    CrateId, SourceDatabaseExt, SourceRootId, Upcast,\n+    SourceDatabaseExt, SourceRootId, Upcast,\n };\n use fst::{self, Streamer};\n use hir::{\n-    db::{DefDatabase, HirDatabase},\n+    db::HirDatabase,\n     symbols::{FileSymbol, SymbolCollector},\n-    ModuleId,\n+    Crate, Module,\n };\n use rayon::prelude::*;\n use rustc_hash::FxHashSet;\n@@ -93,7 +93,7 @@ impl Query {\n pub trait SymbolsDatabase: HirDatabase + SourceDatabaseExt + Upcast<dyn HirDatabase> {\n     /// The symbol index for a given module. These modules should only be in source roots that\n     /// are inside local_roots.\n-    fn module_symbols(&self, module_id: ModuleId) -> Arc<SymbolIndex>;\n+    fn module_symbols(&self, module: Module) -> Arc<SymbolIndex>;\n \n     /// The symbol index for a given source root within library_roots.\n     fn library_symbols(&self, source_root_id: SourceRootId) -> Arc<SymbolIndex>;\n@@ -116,20 +116,20 @@ fn library_symbols(db: &dyn SymbolsDatabase, source_root_id: SourceRootId) -> Ar\n     let symbols = db\n         .source_root_crates(source_root_id)\n         .iter()\n-        .flat_map(|&krate| module_ids_for_crate(db.upcast(), krate))\n+        .flat_map(|&krate| Crate::from(krate).modules(db.upcast()))\n         // we specifically avoid calling SymbolsDatabase::module_symbols here, even they do the same thing,\n         // as the index for a library is not going to really ever change, and we do not want to store each\n         // module's index in salsa.\n-        .map(|module_id| SymbolCollector::collect(db.upcast(), module_id))\n+        .map(|module| SymbolCollector::collect(db.upcast(), module))\n         .flatten()\n         .collect();\n \n     Arc::new(SymbolIndex::new(symbols))\n }\n \n-fn module_symbols(db: &dyn SymbolsDatabase, module_id: ModuleId) -> Arc<SymbolIndex> {\n+fn module_symbols(db: &dyn SymbolsDatabase, module: Module) -> Arc<SymbolIndex> {\n     let _p = profile::span(\"module_symbols\");\n-    let symbols = SymbolCollector::collect(db.upcast(), module_id);\n+    let symbols = SymbolCollector::collect(db.upcast(), module);\n     Arc::new(SymbolIndex::new(symbols))\n }\n \n@@ -188,41 +188,36 @@ pub fn world_symbols(db: &RootDatabase, query: Query) -> Vec<FileSymbol> {\n             .map_with(Snap::new(db), |snap, &root| snap.library_symbols(root))\n             .collect()\n     } else {\n-        let mut module_ids = Vec::new();\n+        let mut modules = Vec::new();\n \n         for &root in db.local_roots().iter() {\n             let crates = db.source_root_crates(root);\n             for &krate in crates.iter() {\n-                module_ids.extend(module_ids_for_crate(db, krate));\n+                modules.extend(Crate::from(krate).modules(db));\n             }\n         }\n \n-        module_ids\n+        modules\n             .par_iter()\n-            .map_with(Snap::new(db), |snap, &module_id| snap.module_symbols(module_id))\n+            .map_with(Snap::new(db), |snap, &module| snap.module_symbols(module))\n             .collect()\n     };\n \n     query.search(&indices)\n }\n \n-pub fn crate_symbols(db: &RootDatabase, krate: CrateId, query: Query) -> Vec<FileSymbol> {\n+pub fn crate_symbols(db: &RootDatabase, krate: Crate, query: Query) -> Vec<FileSymbol> {\n     let _p = profile::span(\"crate_symbols\").detail(|| format!(\"{:?}\", query));\n \n-    let module_ids = module_ids_for_crate(db, krate);\n-    let indices: Vec<_> = module_ids\n+    let modules = krate.modules(db);\n+    let indices: Vec<_> = modules\n         .par_iter()\n-        .map_with(Snap::new(db), |snap, &module_id| snap.module_symbols(module_id))\n+        .map_with(Snap::new(db), |snap, &module| snap.module_symbols(module))\n         .collect();\n \n     query.search(&indices)\n }\n \n-fn module_ids_for_crate(db: &dyn DefDatabase, krate: CrateId) -> Vec<ModuleId> {\n-    let def_map = db.crate_def_map(krate);\n-    def_map.modules().map(|(id, _)| def_map.module_id(id)).collect()\n-}\n-\n pub fn index_resolve(db: &RootDatabase, name: &str) -> Vec<FileSymbol> {\n     let mut query = Query::new(name.to_string());\n     query.exact();\n@@ -427,7 +422,8 @@ struct StructInModB;\n         \"#,\n         );\n \n-        let symbols: Vec<_> = module_ids_for_crate(db.upcast(), db.test_crate())\n+        let symbols: Vec<_> = Crate::from(db.test_crate())\n+            .modules(&db)\n             .into_iter()\n             .map(|module_id| (module_id, SymbolCollector::collect(&db, module_id)))\n             .collect();"}, {"sha": "cc51d85da702fdb69cd919815cd955c2eb84a367", "filename": "crates/ide_db/src/test_data/test_symbol_index_collection.txt", "status": "modified", "additions": 24, "deletions": 18, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/18e80e6892f130f71b6e4e3d7dbc3600d1473b01/crates%2Fide_db%2Fsrc%2Ftest_data%2Ftest_symbol_index_collection.txt", "raw_url": "https://github.com/rust-lang/rust/raw/18e80e6892f130f71b6e4e3d7dbc3600d1473b01/crates%2Fide_db%2Fsrc%2Ftest_data%2Ftest_symbol_index_collection.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_db%2Fsrc%2Ftest_data%2Ftest_symbol_index_collection.txt?ref=18e80e6892f130f71b6e4e3d7dbc3600d1473b01", "patch": "@@ -1,11 +1,13 @@\n [\n     (\n-        ModuleId {\n-            krate: CrateId(\n-                0,\n-            ),\n-            block: None,\n-            local_id: Idx::<ModuleData>(0),\n+        Module {\n+            id: ModuleId {\n+                krate: CrateId(\n+                    0,\n+                ),\n+                block: None,\n+                local_id: Idx::<ModuleData>(0),\n+            },\n         },\n         [\n             FileSymbol {\n@@ -459,12 +461,14 @@\n         ],\n     ),\n     (\n-        ModuleId {\n-            krate: CrateId(\n-                0,\n-            ),\n-            block: None,\n-            local_id: Idx::<ModuleData>(1),\n+        Module {\n+            id: ModuleId {\n+                krate: CrateId(\n+                    0,\n+                ),\n+                block: None,\n+                local_id: Idx::<ModuleData>(1),\n+            },\n         },\n         [\n             FileSymbol {\n@@ -492,12 +496,14 @@\n         ],\n     ),\n     (\n-        ModuleId {\n-            krate: CrateId(\n-                0,\n-            ),\n-            block: None,\n-            local_id: Idx::<ModuleData>(2),\n+        Module {\n+            id: ModuleId {\n+                krate: CrateId(\n+                    0,\n+                ),\n+                block: None,\n+                local_id: Idx::<ModuleData>(2),\n+            },\n         },\n         [\n             FileSymbol {"}]}