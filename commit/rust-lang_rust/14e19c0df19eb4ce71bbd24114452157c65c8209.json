{"sha": "14e19c0df19eb4ce71bbd24114452157c65c8209", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE0ZTE5YzBkZjE5ZWI0Y2U3MWJiZDI0MTE0NDUyMTU3YzY1YzgyMDk=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2019-11-06T21:11:42Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-11-06T21:11:42Z"}, "message": "Merge #2179\n\n2179: Use HirDatabase to compute `is_deprecated` r=matklad a=martskins\n\nThis PR fixes #2167 by introducing `attributes_query` and adding `fn attrs(&self, def: crate::AttrDef) -> Option<Arc<[Attr]>>;`  to the `DefDatabase` trait.\r\n\r\nI'm a little concerned about the two spots in `attributes_query` where code is repeated, but I couldn't figure out a way to avoid that, so.. I welcome suggestions :smile: \r\n\r\n\n\nCo-authored-by: Martin Asquino <martin.asquino@gmail.com>", "tree": {"sha": "3cf99a99d4e0238b60ab5b73941798b33f2eb778", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3cf99a99d4e0238b60ab5b73941798b33f2eb778"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/14e19c0df19eb4ce71bbd24114452157c65c8209", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJdwzcOCRBK7hj4Ov3rIwAAdHIIABfztwRKyWWaRJv6EcTAJEAF\nik1J0E+KTiOahuUoVsAJvoggdKT+3FN07MNbYU+g4v+fn5zk3vL4ZqqkGgfAEbKO\nafIRHh/JBAbjRRZls7sb9xTx6kz3gsDL9qe+hW5kj1vO7eVGhbzUl705jzziiDiW\nWnP0pVFUqD2p6cwM9aQtHsv60K3LVxSIaC2x3zD9PlRWof0Mj/fcLsoVVsUODBNc\n6Pz8/wQHRBtBe79gdlU/sIe7EKBk/e4O9bnEkg2s8j0U2Ys3BRay6yDgLI1RQANd\n7dCXCcgkH+5bDK2n2a4lAWg0kwUbBmwMy5w4EAMluVKyn2X06hVkGixAS50W9WA=\n=maY6\n-----END PGP SIGNATURE-----\n", "payload": "tree 3cf99a99d4e0238b60ab5b73941798b33f2eb778\nparent ef988492ee8f9718fdde15cec6d96e4c4cfef3cf\nparent cb3767f28a2f9e443b816b17d5d07b6a1cff90ab\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1573074702 +0000\ncommitter GitHub <noreply@github.com> 1573074702 +0000\n\nMerge #2179\n\n2179: Use HirDatabase to compute `is_deprecated` r=matklad a=martskins\n\nThis PR fixes #2167 by introducing `attributes_query` and adding `fn attrs(&self, def: crate::AttrDef) -> Option<Arc<[Attr]>>;`  to the `DefDatabase` trait.\r\n\r\nI'm a little concerned about the two spots in `attributes_query` where code is repeated, but I couldn't figure out a way to avoid that, so.. I welcome suggestions :smile: \r\n\r\n\n\nCo-authored-by: Martin Asquino <martin.asquino@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/14e19c0df19eb4ce71bbd24114452157c65c8209", "html_url": "https://github.com/rust-lang/rust/commit/14e19c0df19eb4ce71bbd24114452157c65c8209", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/14e19c0df19eb4ce71bbd24114452157c65c8209/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ef988492ee8f9718fdde15cec6d96e4c4cfef3cf", "url": "https://api.github.com/repos/rust-lang/rust/commits/ef988492ee8f9718fdde15cec6d96e4c4cfef3cf", "html_url": "https://github.com/rust-lang/rust/commit/ef988492ee8f9718fdde15cec6d96e4c4cfef3cf"}, {"sha": "cb3767f28a2f9e443b816b17d5d07b6a1cff90ab", "url": "https://api.github.com/repos/rust-lang/rust/commits/cb3767f28a2f9e443b816b17d5d07b6a1cff90ab", "html_url": "https://github.com/rust-lang/rust/commit/cb3767f28a2f9e443b816b17d5d07b6a1cff90ab"}], "stats": {"total": 125, "additions": 111, "deletions": 14}, "files": [{"sha": "9d0db8024945e5ca26a8edfa9fc94968e64db7cd", "filename": "crates/ra_hir/src/code_model.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/14e19c0df19eb4ce71bbd24114452157c65c8209/crates%2Fra_hir%2Fsrc%2Fcode_model.rs", "raw_url": "https://github.com/rust-lang/rust/raw/14e19c0df19eb4ce71bbd24114452157c65c8209/crates%2Fra_hir%2Fsrc%2Fcode_model.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fcode_model.rs?ref=14e19c0df19eb4ce71bbd24114452157c65c8209", "patch": "@@ -2,6 +2,7 @@\n \n pub(crate) mod src;\n pub(crate) mod docs;\n+pub(crate) mod attrs;\n \n use std::sync::Arc;\n "}, {"sha": "f7db36b6681491a8ca6f9147809586a41c891dec", "filename": "crates/ra_hir/src/code_model/attrs.rs", "status": "added", "additions": 92, "deletions": 0, "changes": 92, "blob_url": "https://github.com/rust-lang/rust/blob/14e19c0df19eb4ce71bbd24114452157c65c8209/crates%2Fra_hir%2Fsrc%2Fcode_model%2Fattrs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/14e19c0df19eb4ce71bbd24114452157c65c8209/crates%2Fra_hir%2Fsrc%2Fcode_model%2Fattrs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fcode_model%2Fattrs.rs?ref=14e19c0df19eb4ce71bbd24114452157c65c8209", "patch": "@@ -0,0 +1,92 @@\n+//! FIXME: write short doc here\n+\n+use crate::{\n+    db::{AstDatabase, DefDatabase, HirDatabase},\n+    Adt, Const, Enum, EnumVariant, FieldSource, Function, HasSource, MacroDef, Module, Static,\n+    Struct, StructField, Trait, TypeAlias, Union,\n+};\n+use hir_def::attr::Attr;\n+use hir_expand::hygiene::Hygiene;\n+use ra_syntax::ast;\n+use std::sync::Arc;\n+\n+#[derive(Clone, Copy, Debug, PartialEq, Eq, Hash)]\n+pub enum AttrDef {\n+    Module(Module),\n+    StructField(StructField),\n+    Adt(Adt),\n+    Function(Function),\n+    EnumVariant(EnumVariant),\n+    Static(Static),\n+    Const(Const),\n+    Trait(Trait),\n+    TypeAlias(TypeAlias),\n+    MacroDef(MacroDef),\n+}\n+\n+impl_froms!(\n+    AttrDef: Module,\n+    StructField,\n+    Adt(Struct, Enum, Union),\n+    EnumVariant,\n+    Static,\n+    Const,\n+    Function,\n+    Trait,\n+    TypeAlias,\n+    MacroDef\n+);\n+\n+pub trait Attrs {\n+    fn attrs(&self, db: &impl HirDatabase) -> Option<Arc<[Attr]>>;\n+}\n+\n+pub(crate) fn attributes_query(\n+    db: &(impl DefDatabase + AstDatabase),\n+    def: AttrDef,\n+) -> Option<Arc<[Attr]>> {\n+    match def {\n+        AttrDef::Module(it) => {\n+            let src = it.declaration_source(db)?;\n+            let hygiene = Hygiene::new(db, src.file_id);\n+            Attr::from_attrs_owner(&src.ast, &hygiene)\n+        }\n+        AttrDef::StructField(it) => match it.source(db).ast {\n+            FieldSource::Named(named) => {\n+                let src = it.source(db);\n+                let hygiene = Hygiene::new(db, src.file_id);\n+                Attr::from_attrs_owner(&named, &hygiene)\n+            }\n+            FieldSource::Pos(..) => None,\n+        },\n+        AttrDef::Adt(it) => match it {\n+            Adt::Struct(it) => attrs_from_ast(it, db),\n+            Adt::Enum(it) => attrs_from_ast(it, db),\n+            Adt::Union(it) => attrs_from_ast(it, db),\n+        },\n+        AttrDef::EnumVariant(it) => attrs_from_ast(it, db),\n+        AttrDef::Static(it) => attrs_from_ast(it, db),\n+        AttrDef::Const(it) => attrs_from_ast(it, db),\n+        AttrDef::Function(it) => attrs_from_ast(it, db),\n+        AttrDef::Trait(it) => attrs_from_ast(it, db),\n+        AttrDef::TypeAlias(it) => attrs_from_ast(it, db),\n+        AttrDef::MacroDef(it) => attrs_from_ast(it, db),\n+    }\n+}\n+\n+fn attrs_from_ast<T, D>(node: T, db: &D) -> Option<Arc<[Attr]>>\n+where\n+    T: HasSource,\n+    T::Ast: ast::AttrsOwner,\n+    D: DefDatabase + AstDatabase,\n+{\n+    let src = node.source(db);\n+    let hygiene = Hygiene::new(db, src.file_id);\n+    Attr::from_attrs_owner(&src.ast, &hygiene)\n+}\n+\n+impl<T: Into<AttrDef> + Copy> Attrs for T {\n+    fn attrs(&self, db: &impl HirDatabase) -> Option<Arc<[Attr]>> {\n+        db.attrs((*self).into())\n+    }\n+}"}, {"sha": "75c322c999935428f0264aef4102c9d8e36c781d", "filename": "crates/ra_hir/src/db.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/14e19c0df19eb4ce71bbd24114452157c65c8209/crates%2Fra_hir%2Fsrc%2Fdb.rs", "raw_url": "https://github.com/rust-lang/rust/raw/14e19c0df19eb4ce71bbd24114452157c65c8209/crates%2Fra_hir%2Fsrc%2Fdb.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fdb.rs?ref=14e19c0df19eb4ce71bbd24114452157c65c8209", "patch": "@@ -2,6 +2,7 @@\n \n use std::sync::Arc;\n \n+use hir_def::attr::Attr;\n use ra_db::salsa;\n use ra_syntax::SmolStr;\n \n@@ -75,6 +76,9 @@ pub trait DefDatabase: HirDebugDatabase + DefDatabase2 {\n \n     #[salsa::invoke(crate::code_model::docs::documentation_query)]\n     fn documentation(&self, def: crate::DocDef) -> Option<crate::Documentation>;\n+\n+    #[salsa::invoke(crate::code_model::attrs::attributes_query)]\n+    fn attrs(&self, def: crate::AttrDef) -> Option<Arc<[Attr]>>;\n }\n \n #[salsa::query_group(HirDatabaseStorage)]"}, {"sha": "131f6c797aae6aeabe7b7bbb5dc2f2fa1ff0d6ee", "filename": "crates/ra_hir/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/14e19c0df19eb4ce71bbd24114452157c65c8209/crates%2Fra_hir%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/14e19c0df19eb4ce71bbd24114452157c65c8209/crates%2Fra_hir%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Flib.rs?ref=14e19c0df19eb4ce71bbd24114452157c65c8209", "patch": "@@ -61,6 +61,7 @@ use crate::{ids::MacroFileKind, resolve::Resolver};\n pub use crate::{\n     adt::VariantDef,\n     code_model::{\n+        attrs::{AttrDef, Attrs},\n         docs::{DocDef, Docs, Documentation},\n         src::{HasBodySource, HasSource},\n         Adt, AssocItem, Const, ConstData, Container, Crate, CrateDependency, DefWithBody, Enum,"}, {"sha": "d861303b75e13163e29a2b4ea8a2549be086b727", "filename": "crates/ra_ide_api/src/completion/presentation.rs", "status": "modified", "additions": 13, "deletions": 14, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/14e19c0df19eb4ce71bbd24114452157c65c8209/crates%2Fra_ide_api%2Fsrc%2Fcompletion%2Fpresentation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/14e19c0df19eb4ce71bbd24114452157c65c8209/crates%2Fra_ide_api%2Fsrc%2Fcompletion%2Fpresentation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Fcompletion%2Fpresentation.rs?ref=14e19c0df19eb4ce71bbd24114452157c65c8209", "patch": "@@ -1,8 +1,8 @@\n //! This modules takes care of rendering various definitions as completion items.\n \n-use hir::{db::HirDatabase, Docs, HasSource, HirDisplay, ScopeDef, Ty, TypeWalk};\n+use hir::{db::HirDatabase, Attrs, Docs, HasSource, HirDisplay, ScopeDef, Ty, TypeWalk};\n use join_to_string::join;\n-use ra_syntax::ast::{AttrsOwner, NameOwner};\n+use ra_syntax::ast::NameOwner;\n use test_utils::tested_by;\n \n use crate::completion::{\n@@ -18,11 +18,7 @@ impl Completions {\n         field: hir::StructField,\n         substs: &hir::Substs,\n     ) {\n-        let ast_node = field.source(ctx.db).ast;\n-        let is_deprecated = match ast_node {\n-            hir::FieldSource::Named(m) => is_deprecated(m),\n-            hir::FieldSource::Pos(m) => is_deprecated(m),\n-        };\n+        let is_deprecated = is_deprecated(field, ctx.db);\n         CompletionItem::new(\n             CompletionKind::Reference,\n             ctx.source_range(),\n@@ -185,7 +181,7 @@ impl Completions {\n             CompletionItem::new(CompletionKind::Reference, ctx.source_range(), &macro_declaration)\n                 .kind(CompletionItemKind::Macro)\n                 .set_documentation(docs.clone())\n-                .set_deprecated(is_deprecated(ast_node))\n+                .set_deprecated(is_deprecated(macro_, ctx.db))\n                 .detail(detail);\n \n         builder = if ctx.use_item_syntax.is_some() {\n@@ -218,7 +214,7 @@ impl Completions {\n                     CompletionItemKind::Function\n                 })\n                 .set_documentation(func.docs(ctx.db))\n-                .set_deprecated(is_deprecated(ast_node))\n+                .set_deprecated(is_deprecated(func, ctx.db))\n                 .detail(detail);\n \n         // Add `<>` for generic types\n@@ -250,7 +246,7 @@ impl Completions {\n         CompletionItem::new(CompletionKind::Reference, ctx.source_range(), name.text().to_string())\n             .kind(CompletionItemKind::Const)\n             .set_documentation(constant.docs(ctx.db))\n-            .set_deprecated(is_deprecated(ast_node))\n+            .set_deprecated(is_deprecated(constant, ctx.db))\n             .detail(detail)\n             .add_to(self);\n     }\n@@ -266,13 +262,13 @@ impl Completions {\n         CompletionItem::new(CompletionKind::Reference, ctx.source_range(), name.text().to_string())\n             .kind(CompletionItemKind::TypeAlias)\n             .set_documentation(type_alias.docs(ctx.db))\n-            .set_deprecated(is_deprecated(type_def))\n+            .set_deprecated(is_deprecated(type_alias, ctx.db))\n             .detail(detail)\n             .add_to(self);\n     }\n \n     pub(crate) fn add_enum_variant(&mut self, ctx: &CompletionContext, variant: hir::EnumVariant) {\n-        let is_deprecated = is_deprecated(variant.source(ctx.db).ast);\n+        let is_deprecated = is_deprecated(variant, ctx.db);\n         let name = match variant.name(ctx.db) {\n             Some(it) => it,\n             None => return,\n@@ -291,8 +287,11 @@ impl Completions {\n     }\n }\n \n-fn is_deprecated(node: impl AttrsOwner) -> bool {\n-    node.attrs().filter_map(|x| x.simple_name()).any(|x| x == \"deprecated\")\n+fn is_deprecated(node: impl Attrs, db: &impl HirDatabase) -> bool {\n+    match node.attrs(db) {\n+        None => false,\n+        Some(attrs) => attrs.iter().any(|x| x.is_simple_atom(\"deprecated\")),\n+    }\n }\n \n fn has_non_default_type_params(def: hir::GenericDef, db: &db::RootDatabase) -> bool {"}]}