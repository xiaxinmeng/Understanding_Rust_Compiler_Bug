{"sha": "f667aca127cfcd13c186075a7c98bbd1f9dc2ca7", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY2NjdhY2ExMjdjZmNkMTNjMTg2MDc1YTdjOThiYmQxZjlkYzJjYTc=", "commit": {"author": {"name": "Luqman Aden", "email": "me@luqman.ca", "date": "2021-06-02T00:13:10Z"}, "committer": {"name": "Luqman Aden", "email": "me@luqman.ca", "date": "2021-06-02T00:13:10Z"}, "message": "Tweak wasm_base target spec to indicate linker is not GNU and update linker inferring logic for wasm-ld.", "tree": {"sha": "bbff20782476a07631acfe8d07a872eadfffb8bc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bbff20782476a07631acfe8d07a872eadfffb8bc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f667aca127cfcd13c186075a7c98bbd1f9dc2ca7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f667aca127cfcd13c186075a7c98bbd1f9dc2ca7", "html_url": "https://github.com/rust-lang/rust/commit/f667aca127cfcd13c186075a7c98bbd1f9dc2ca7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f667aca127cfcd13c186075a7c98bbd1f9dc2ca7/comments", "author": {"login": "luqmana", "id": 287063, "node_id": "MDQ6VXNlcjI4NzA2Mw==", "avatar_url": "https://avatars.githubusercontent.com/u/287063?v=4", "gravatar_id": "", "url": "https://api.github.com/users/luqmana", "html_url": "https://github.com/luqmana", "followers_url": "https://api.github.com/users/luqmana/followers", "following_url": "https://api.github.com/users/luqmana/following{/other_user}", "gists_url": "https://api.github.com/users/luqmana/gists{/gist_id}", "starred_url": "https://api.github.com/users/luqmana/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/luqmana/subscriptions", "organizations_url": "https://api.github.com/users/luqmana/orgs", "repos_url": "https://api.github.com/users/luqmana/repos", "events_url": "https://api.github.com/users/luqmana/events{/privacy}", "received_events_url": "https://api.github.com/users/luqmana/received_events", "type": "User", "site_admin": false}, "committer": {"login": "luqmana", "id": 287063, "node_id": "MDQ6VXNlcjI4NzA2Mw==", "avatar_url": "https://avatars.githubusercontent.com/u/287063?v=4", "gravatar_id": "", "url": "https://api.github.com/users/luqmana", "html_url": "https://github.com/luqmana", "followers_url": "https://api.github.com/users/luqmana/followers", "following_url": "https://api.github.com/users/luqmana/following{/other_user}", "gists_url": "https://api.github.com/users/luqmana/gists{/gist_id}", "starred_url": "https://api.github.com/users/luqmana/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/luqmana/subscriptions", "organizations_url": "https://api.github.com/users/luqmana/orgs", "repos_url": "https://api.github.com/users/luqmana/repos", "events_url": "https://api.github.com/users/luqmana/events{/privacy}", "received_events_url": "https://api.github.com/users/luqmana/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "625d5a693e4697bcafdd34fd1a38c281acabb8e9", "url": "https://api.github.com/repos/rust-lang/rust/commits/625d5a693e4697bcafdd34fd1a38c281acabb8e9", "html_url": "https://github.com/rust-lang/rust/commit/625d5a693e4697bcafdd34fd1a38c281acabb8e9"}], "stats": {"total": 11, "additions": 8, "deletions": 3}, "files": [{"sha": "5f8f1110c83a969bdc72e942e63f6f596ccc3103", "filename": "compiler/rustc_codegen_ssa/src/back/link.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f667aca127cfcd13c186075a7c98bbd1f9dc2ca7/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f667aca127cfcd13c186075a7c98bbd1f9dc2ca7/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs?ref=f667aca127cfcd13c186075a7c98bbd1f9dc2ca7", "patch": "@@ -1005,6 +1005,8 @@ fn linker_and_flavor(sess: &Session) -> (PathBuf, LinkerFlavor) {\n                     || stem.ends_with(\"-clang\")\n                 {\n                     LinkerFlavor::Gcc\n+                } else if stem == \"wasm-ld\" || stem.ends_with(\"-wasm-ld\") {\n+                    LinkerFlavor::Lld(LldFlavor::Wasm)\n                 } else if stem == \"ld\" || stem == \"ld.lld\" || stem.ends_with(\"-ld\") {\n                     LinkerFlavor::Ld\n                 } else if stem == \"link\" || stem == \"lld-link\" {"}, {"sha": "4631aa23398966590382f6de4c966c7995c1302b", "filename": "compiler/rustc_codegen_ssa/src/back/linker.rs", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/f667aca127cfcd13c186075a7c98bbd1f9dc2ca7/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flinker.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f667aca127cfcd13c186075a7c98bbd1f9dc2ca7/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flinker.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flinker.rs?ref=f667aca127cfcd13c186075a7c98bbd1f9dc2ca7", "patch": "@@ -472,21 +472,23 @@ impl<'a> Linker for GccLinker<'a> {\n         // eliminate the metadata. If we're building an executable, however,\n         // --gc-sections drops the size of hello world from 1.8MB to 597K, a 67%\n         // reduction.\n-        } else if self.sess.target.linker_is_gnu && !keep_metadata {\n+        } else if (self.sess.target.linker_is_gnu || self.sess.target.is_like_wasm)\n+            && !keep_metadata\n+        {\n             self.linker_arg(\"--gc-sections\");\n         }\n     }\n \n     fn no_gc_sections(&mut self) {\n         if self.sess.target.is_like_osx {\n             self.linker_arg(\"-no_dead_strip\");\n-        } else if self.sess.target.linker_is_gnu {\n+        } else if self.sess.target.linker_is_gnu || self.sess.target.is_like_wasm {\n             self.linker_arg(\"--no-gc-sections\");\n         }\n     }\n \n     fn optimize(&mut self) {\n-        if !self.sess.target.linker_is_gnu {\n+        if !self.sess.target.linker_is_gnu && !self.sess.target.is_like_wasm {\n             return;\n         }\n "}, {"sha": "0c8d77a62b0df55a24666f62e66227fa24b54953", "filename": "compiler/rustc_target/src/spec/wasm_base.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/f667aca127cfcd13c186075a7c98bbd1f9dc2ca7/compiler%2Frustc_target%2Fsrc%2Fspec%2Fwasm_base.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f667aca127cfcd13c186075a7c98bbd1f9dc2ca7/compiler%2Frustc_target%2Fsrc%2Fspec%2Fwasm_base.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fwasm_base.rs?ref=f667aca127cfcd13c186075a7c98bbd1f9dc2ca7", "patch": "@@ -102,6 +102,7 @@ pub fn options() -> TargetOptions {\n         // we use the LLD shipped with the Rust toolchain by default\n         linker: Some(\"rust-lld\".to_owned()),\n         lld_flavor: LldFlavor::Wasm,\n+        linker_is_gnu: false,\n \n         // No need for indirection here, simd types can always be passed by\n         // value as the whole module either has simd or not, which is different"}]}