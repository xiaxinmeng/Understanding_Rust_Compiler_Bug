{"sha": "dd20a6f70145da0adb660a3ba8881b97521ae3c0", "node_id": "C_kwDOAAsO6NoAKGRkMjBhNmY3MDE0NWRhMGFkYjY2MGEzYmE4ODgxYjk3NTIxYWUzYzA", "commit": {"author": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2022-01-06T13:23:35Z"}, "committer": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2022-01-06T13:24:19Z"}, "message": "feat: poke user when supplying faulty configurations", "tree": {"sha": "04b429715e0fe9936f81fbc31296b3c9843f394e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/04b429715e0fe9936f81fbc31296b3c9843f394e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/dd20a6f70145da0adb660a3ba8881b97521ae3c0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/dd20a6f70145da0adb660a3ba8881b97521ae3c0", "html_url": "https://github.com/rust-lang/rust/commit/dd20a6f70145da0adb660a3ba8881b97521ae3c0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/dd20a6f70145da0adb660a3ba8881b97521ae3c0/comments", "author": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8887d2016f2e87332e4de216aaf0b5d125e0fe11", "url": "https://api.github.com/repos/rust-lang/rust/commits/8887d2016f2e87332e4de216aaf0b5d125e0fe11", "html_url": "https://github.com/rust-lang/rust/commit/8887d2016f2e87332e4de216aaf0b5d125e0fe11"}], "stats": {"total": 48, "additions": 36, "deletions": 12}, "files": [{"sha": "9a2e43559157b69c96ebd02b728497bf5396db73", "filename": "crates/rust-analyzer/src/bin/main.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/dd20a6f70145da0adb660a3ba8881b97521ae3c0/crates%2Frust-analyzer%2Fsrc%2Fbin%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dd20a6f70145da0adb660a3ba8881b97521ae3c0/crates%2Frust-analyzer%2Fsrc%2Fbin%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fbin%2Fmain.rs?ref=dd20a6f70145da0adb660a3ba8881b97521ae3c0", "patch": "@@ -150,7 +150,7 @@ fn run_server() -> Result<()> {\n \n     let mut config = Config::new(root_path, initialize_params.capabilities);\n     if let Some(json) = initialize_params.initialization_options {\n-        config.update(json);\n+        let _ = config.update(json);\n     }\n \n     let server_capabilities = rust_analyzer::server_capabilities(&config);"}, {"sha": "de0aba0caa5089c50c30fbc2a2897cc36840ca67", "filename": "crates/rust-analyzer/src/config.rs", "status": "modified", "additions": 22, "deletions": 9, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/dd20a6f70145da0adb660a3ba8881b97521ae3c0/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dd20a6f70145da0adb660a3ba8881b97521ae3c0/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs?ref=dd20a6f70145da0adb660a3ba8881b97521ae3c0", "patch": "@@ -341,7 +341,7 @@ config_data! {\n \n impl Default for ConfigData {\n     fn default() -> Self {\n-        ConfigData::from_json(serde_json::Value::Null)\n+        ConfigData::from_json(serde_json::Value::Null, &mut Vec::new())\n     }\n }\n \n@@ -492,16 +492,21 @@ impl Config {\n             snippets: Default::default(),\n         }\n     }\n-    pub fn update(&mut self, mut json: serde_json::Value) {\n+    pub fn update(\n+        &mut self,\n+        mut json: serde_json::Value,\n+    ) -> Result<(), Vec<(String, serde_json::Error)>> {\n         tracing::info!(\"updating config from JSON: {:#}\", json);\n         if json.is_null() || json.as_object().map_or(false, |it| it.is_empty()) {\n-            return;\n+            return Ok(());\n         }\n-        self.detached_files = get_field::<Vec<PathBuf>>(&mut json, \"detachedFiles\", None, \"[]\")\n-            .into_iter()\n-            .map(AbsPathBuf::assert)\n-            .collect();\n-        self.data = ConfigData::from_json(json);\n+        let mut errors = Vec::new();\n+        self.detached_files =\n+            get_field::<Vec<PathBuf>>(&mut json, &mut errors, \"detachedFiles\", None, \"[]\")\n+                .into_iter()\n+                .map(AbsPathBuf::assert)\n+                .collect();\n+        self.data = ConfigData::from_json(json, &mut errors);\n         self.snippets.clear();\n         for (name, def) in self.data.completion_snippets.iter() {\n             if def.prefix.is_empty() && def.postfix.is_empty() {\n@@ -524,6 +529,11 @@ impl Config {\n                 None => tracing::info!(\"Invalid snippet {}\", name),\n             }\n         }\n+        if errors.is_empty() {\n+            Ok(())\n+        } else {\n+            Err(errors)\n+        }\n     }\n \n     pub fn json_schema() -> serde_json::Value {\n@@ -1116,10 +1126,11 @@ macro_rules! _config_data {\n         #[derive(Debug, Clone)]\n         struct $name { $($field: $ty,)* }\n         impl $name {\n-            fn from_json(mut json: serde_json::Value) -> $name {\n+            fn from_json(mut json: serde_json::Value, error_sink: &mut Vec<(String, serde_json::Error)>) -> $name {\n                 $name {$(\n                     $field: get_field(\n                         &mut json,\n+                        error_sink,\n                         stringify!($field),\n                         None$(.or(Some(stringify!($alias))))*,\n                         $default,\n@@ -1156,6 +1167,7 @@ use _config_data as config_data;\n \n fn get_field<T: DeserializeOwned>(\n     json: &mut serde_json::Value,\n+    error_sink: &mut Vec<(String, serde_json::Error)>,\n     field: &'static str,\n     alias: Option<&'static str>,\n     default: &str,\n@@ -1174,6 +1186,7 @@ fn get_field<T: DeserializeOwned>(\n                 Ok(it) => Some(it),\n                 Err(e) => {\n                     tracing::warn!(\"Failed to deserialize config field at {}: {:?}\", pointer, e);\n+                    error_sink.push((pointer, e));\n                     None\n                 }\n             })"}, {"sha": "af987230defdfd5ae2efecefe296ee755429ecf5", "filename": "crates/rust-analyzer/src/main_loop.rs", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/dd20a6f70145da0adb660a3ba8881b97521ae3c0/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dd20a6f70145da0adb660a3ba8881b97521ae3c0/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs?ref=dd20a6f70145da0adb660a3ba8881b97521ae3c0", "patch": "@@ -9,6 +9,7 @@ use std::{\n use always_assert::always;\n use crossbeam_channel::{select, Receiver};\n use ide_db::base_db::{SourceDatabaseExt, VfsPath};\n+use itertools::Itertools;\n use lsp_server::{Connection, Notification, Request};\n use lsp_types::notification::Notification as _;\n use vfs::{ChangeKind, FileId};\n@@ -731,7 +732,17 @@ impl GlobalState {\n                                     // Note that json can be null according to the spec if the client can't\n                                     // provide a configuration. This is handled in Config::update below.\n                                     let mut config = Config::clone(&*this.config);\n-                                    config.update(json.take());\n+                                    if let Err(errors) = config.update(json.take()) {\n+                                        let errors = errors\n+                                            .iter()\n+                                            .format_with(\"\\n\", |(key, e),f| {\n+                                                f(key)?;\n+                                                f(&\": \")?;\n+                                                f(e)\n+                                            });\n+                                        let msg= format!(\"Failed to deserialize config key(s):\\n{}\", errors);\n+                                        this.show_message(lsp_types::MessageType::WARNING, msg);\n+                                    }\n                                     this.update_configuration(config);\n                                 }\n                             }"}, {"sha": "78aa41191591eb97348a7dd79d6a2970b86eb3ad", "filename": "crates/rust-analyzer/tests/slow-tests/support.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/dd20a6f70145da0adb660a3ba8881b97521ae3c0/crates%2Frust-analyzer%2Ftests%2Fslow-tests%2Fsupport.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dd20a6f70145da0adb660a3ba8881b97521ae3c0/crates%2Frust-analyzer%2Ftests%2Fslow-tests%2Fsupport.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Ftests%2Fslow-tests%2Fsupport.rs?ref=dd20a6f70145da0adb660a3ba8881b97521ae3c0", "patch": "@@ -137,7 +137,7 @@ impl<'a> Project<'a> {\n             },\n         );\n         config.discovered_projects = Some(discovered_projects);\n-        config.update(self.config);\n+        let _ = config.update(self.config);\n \n         Server::new(tmp_dir, config)\n     }"}]}