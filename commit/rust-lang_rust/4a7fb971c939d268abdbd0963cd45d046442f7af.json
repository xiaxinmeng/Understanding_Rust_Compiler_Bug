{"sha": "4a7fb971c939d268abdbd0963cd45d046442f7af", "node_id": "C_kwDOAAsO6NoAKDRhN2ZiOTcxYzkzOWQyNjhhYmRiZDA5NjNjZDQ1ZDA0NjQ0MmY3YWY", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-12-13T04:29:20Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-12-13T04:29:20Z"}, "message": "Auto merge of #91569 - erikdesjardins:vt-align, r=nikic\n\nAttach range metadata to alignment loads from vtables\n\n...because alignment is always nonzero[0].\n\nThis helps eliminate redundant runtime alignment checks, when a DST\nis a field of a struct whose remaining fields have alignment 1.\n\nFixes #91438.\n\n---\n[0]:\n\nThe [reference](https://doc.rust-lang.org/reference/type-layout.html) says that alignment must be at least 1.\n\nAnd in practice, the alignment field for all vtables is generated here: https://github.com/rust-lang/rust/blob/772d51f887fa407216860bf8ecf3f1a32fb795b4/compiler/rustc_middle/src/ty/vtable.rs#L68-L90 and is nonzero because [`Align::bytes()`](https://github.com/rust-lang/rust/blob/772d51f887fa407216860bf8ecf3f1a32fb795b4/compiler/rustc_target/src/abi/mod.rs#L547-L549) is always nonzero.", "tree": {"sha": "d1cd9ebedc0bac90d308fdd5f713a2e2384e62e6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d1cd9ebedc0bac90d308fdd5f713a2e2384e62e6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4a7fb971c939d268abdbd0963cd45d046442f7af", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4a7fb971c939d268abdbd0963cd45d046442f7af", "html_url": "https://github.com/rust-lang/rust/commit/4a7fb971c939d268abdbd0963cd45d046442f7af", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4a7fb971c939d268abdbd0963cd45d046442f7af/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f7fd79ac1d485ab47b62146f6dafed4aad5d9c6d", "url": "https://api.github.com/repos/rust-lang/rust/commits/f7fd79ac1d485ab47b62146f6dafed4aad5d9c6d", "html_url": "https://github.com/rust-lang/rust/commit/f7fd79ac1d485ab47b62146f6dafed4aad5d9c6d"}, {"sha": "94f08334e0839689ff1c959ffaefa4ca19bd26f5", "url": "https://api.github.com/repos/rust-lang/rust/commits/94f08334e0839689ff1c959ffaefa4ca19bd26f5", "html_url": "https://github.com/rust-lang/rust/commit/94f08334e0839689ff1c959ffaefa4ca19bd26f5"}], "stats": {"total": 63, "additions": 56, "deletions": 7}, "files": [{"sha": "2c4e6bbe9a5c1b5ea27bba5732f8652f671ab5b4", "filename": "compiler/rustc_codegen_ssa/src/glue.rs", "status": "modified", "additions": 11, "deletions": 7, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/4a7fb971c939d268abdbd0963cd45d046442f7af/compiler%2Frustc_codegen_ssa%2Fsrc%2Fglue.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4a7fb971c939d268abdbd0963cd45d046442f7af/compiler%2Frustc_codegen_ssa%2Fsrc%2Fglue.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fglue.rs?ref=4a7fb971c939d268abdbd0963cd45d046442f7af", "patch": "@@ -6,6 +6,7 @@ use crate::common::IntPredicate;\n use crate::meth;\n use crate::traits::*;\n use rustc_middle::ty::{self, Ty};\n+use rustc_target::abi::WrappingRange;\n \n pub fn size_and_align_of_dst<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>>(\n     bx: &mut Bx,\n@@ -21,14 +22,17 @@ pub fn size_and_align_of_dst<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>>(\n     }\n     match t.kind() {\n         ty::Dynamic(..) => {\n-            // load size/align from vtable\n+            // Load size/align from vtable.\n             let vtable = info.unwrap();\n-            (\n-                meth::VirtualIndex::from_index(ty::COMMON_VTABLE_ENTRIES_SIZE)\n-                    .get_usize(bx, vtable),\n-                meth::VirtualIndex::from_index(ty::COMMON_VTABLE_ENTRIES_ALIGN)\n-                    .get_usize(bx, vtable),\n-            )\n+            let size = meth::VirtualIndex::from_index(ty::COMMON_VTABLE_ENTRIES_SIZE)\n+                .get_usize(bx, vtable);\n+            let align = meth::VirtualIndex::from_index(ty::COMMON_VTABLE_ENTRIES_ALIGN)\n+                .get_usize(bx, vtable);\n+\n+            // Alignment is always nonzero.\n+            bx.range_metadata(align, WrappingRange { start: 1, end: !0 });\n+\n+            (size, align)\n         }\n         ty::Slice(_) | ty::Str => {\n             let unit = layout.field(bx, 0);"}, {"sha": "021c7b19f89f5dae54b6ead733792ca97885936c", "filename": "src/test/codegen/dst-vtable-align-nonzero.rs", "status": "added", "additions": 45, "deletions": 0, "changes": 45, "blob_url": "https://github.com/rust-lang/rust/blob/4a7fb971c939d268abdbd0963cd45d046442f7af/src%2Ftest%2Fcodegen%2Fdst-vtable-align-nonzero.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4a7fb971c939d268abdbd0963cd45d046442f7af/src%2Ftest%2Fcodegen%2Fdst-vtable-align-nonzero.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fdst-vtable-align-nonzero.rs?ref=4a7fb971c939d268abdbd0963cd45d046442f7af", "patch": "@@ -0,0 +1,45 @@\n+// compile-flags: -O\n+\n+#![crate_type = \"lib\"]\n+\n+// This test checks that we annotate alignment loads from vtables with nonzero range metadata,\n+// and that this allows LLVM to eliminate redundant `align >= 1` checks.\n+\n+pub trait Trait {\n+    fn f(&self);\n+}\n+\n+pub struct WrapperWithAlign1<T: ?Sized> { x: u8, y: T }\n+\n+pub struct WrapperWithAlign2<T: ?Sized> { x: u16, y: T }\n+\n+pub struct Struct<W: ?Sized> {\n+    _field: i8,\n+    dst: W,\n+}\n+\n+// CHECK-LABEL: @eliminates_runtime_check_when_align_1\n+#[no_mangle]\n+pub fn eliminates_runtime_check_when_align_1(\n+    x: &Struct<WrapperWithAlign1<dyn Trait>>\n+) -> &WrapperWithAlign1<dyn Trait> {\n+    // CHECK: load [[USIZE:i[0-9]+]], {{.+}} !range [[RANGE_META:![0-9]+]]\n+    // CHECK-NOT: icmp\n+    // CHECK-NOT: select\n+    // CHECK: ret\n+    &x.dst\n+}\n+\n+// CHECK-LABEL: @does_not_eliminate_runtime_check_when_align_2\n+#[no_mangle]\n+pub fn does_not_eliminate_runtime_check_when_align_2(\n+    x: &Struct<WrapperWithAlign2<dyn Trait>>\n+) -> &WrapperWithAlign2<dyn Trait> {\n+    // CHECK: [[X0:%[0-9]+]] = load [[USIZE]], {{.+}} !range [[RANGE_META]]\n+    // CHECK: [[X1:%[0-9]+]] = icmp {{.+}} [[X0]]\n+    // CHECK: [[X2:%[0-9]+]] = select {{.+}} [[X1]]\n+    // CHECK: ret\n+    &x.dst\n+}\n+\n+// CHECK: [[RANGE_META]] = !{[[USIZE]] 1, [[USIZE]] 0}"}]}