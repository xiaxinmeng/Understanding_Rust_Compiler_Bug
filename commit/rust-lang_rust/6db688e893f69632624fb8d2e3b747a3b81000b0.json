{"sha": "6db688e893f69632624fb8d2e3b747a3b81000b0", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZkYjY4OGU4OTNmNjk2MzI2MjRmYjhkMmUzYjc0N2EzYjgxMDAwYjA=", "commit": {"author": {"name": "Tim Chevalier", "email": "chevalier@alum.wellesley.edu", "date": "2012-01-23T23:46:12Z"}, "committer": {"name": "Tim Chevalier", "email": "chevalier@alum.wellesley.edu", "date": "2012-01-23T23:48:08Z"}, "message": "Check that the names mentioned in tag exports are actually types (or variants)\n\nCheck that in export foo{}, foo is an enum type, and that in export\nfoo{bar, quux}, foo is an enum type and bar and quux are variants belonging\nto foo.", "tree": {"sha": "522ab62d11e6fea23652b7342a4dfbb599483b9d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/522ab62d11e6fea23652b7342a4dfbb599483b9d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6db688e893f69632624fb8d2e3b747a3b81000b0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6db688e893f69632624fb8d2e3b747a3b81000b0", "html_url": "https://github.com/rust-lang/rust/commit/6db688e893f69632624fb8d2e3b747a3b81000b0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6db688e893f69632624fb8d2e3b747a3b81000b0/comments", "author": {"login": "catamorphism", "id": 427212, "node_id": "MDQ6VXNlcjQyNzIxMg==", "avatar_url": "https://avatars.githubusercontent.com/u/427212?v=4", "gravatar_id": "", "url": "https://api.github.com/users/catamorphism", "html_url": "https://github.com/catamorphism", "followers_url": "https://api.github.com/users/catamorphism/followers", "following_url": "https://api.github.com/users/catamorphism/following{/other_user}", "gists_url": "https://api.github.com/users/catamorphism/gists{/gist_id}", "starred_url": "https://api.github.com/users/catamorphism/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/catamorphism/subscriptions", "organizations_url": "https://api.github.com/users/catamorphism/orgs", "repos_url": "https://api.github.com/users/catamorphism/repos", "events_url": "https://api.github.com/users/catamorphism/events{/privacy}", "received_events_url": "https://api.github.com/users/catamorphism/received_events", "type": "User", "site_admin": false}, "committer": {"login": "catamorphism", "id": 427212, "node_id": "MDQ6VXNlcjQyNzIxMg==", "avatar_url": "https://avatars.githubusercontent.com/u/427212?v=4", "gravatar_id": "", "url": "https://api.github.com/users/catamorphism", "html_url": "https://github.com/catamorphism", "followers_url": "https://api.github.com/users/catamorphism/followers", "following_url": "https://api.github.com/users/catamorphism/following{/other_user}", "gists_url": "https://api.github.com/users/catamorphism/gists{/gist_id}", "starred_url": "https://api.github.com/users/catamorphism/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/catamorphism/subscriptions", "organizations_url": "https://api.github.com/users/catamorphism/orgs", "repos_url": "https://api.github.com/users/catamorphism/repos", "events_url": "https://api.github.com/users/catamorphism/events{/privacy}", "received_events_url": "https://api.github.com/users/catamorphism/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9dc59e15061827122dc0f08d3f66acd17ba329dc", "url": "https://api.github.com/repos/rust-lang/rust/commits/9dc59e15061827122dc0f08d3f66acd17ba329dc", "html_url": "https://github.com/rust-lang/rust/commit/9dc59e15061827122dc0f08d3f66acd17ba329dc"}], "stats": {"total": 110, "additions": 108, "deletions": 2}, "files": [{"sha": "3b49f8c33adc00013a1520d8961cc08489d8bba5", "filename": "src/comp/middle/resolve.rs", "status": "modified", "additions": 58, "deletions": 2, "changes": 60, "blob_url": "https://github.com/rust-lang/rust/blob/6db688e893f69632624fb8d2e3b747a3b81000b0/src%2Fcomp%2Fmiddle%2Fresolve.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6db688e893f69632624fb8d2e3b747a3b81000b0/src%2Fcomp%2Fmiddle%2Fresolve.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomp%2Fmiddle%2Fresolve.rs?ref=6db688e893f69632624fb8d2e3b747a3b81000b0", "patch": "@@ -1766,6 +1766,32 @@ fn check_exports(e: @env) {\n         }\n     }\n \n+    fn check_enum_ok(e: @env, sp:span, id: ident, val: @indexed_mod)\n+        -> node_id {\n+        alt val.index.find(id) {\n+           none { e.sess.span_fatal(sp, #fmt(\"error: undefined id %s\\\n+                         in an export\", id)); }\n+           some(ms) {\n+             let maybe_id = list::find(ms) {|m|\n+                  alt m {\n+                     mie_item(an_item) {\n+                      alt an_item.node {\n+                          item_tag(_,_) { /* OK */ some(an_item.id) }\n+                          _ { none }\n+                      }\n+                     }\n+                     _ { none }\n+               }\n+             };\n+             alt maybe_id {\n+                some(an_id) { ret an_id; }\n+                _ { e.sess.span_fatal(sp, #fmt(\"error: %s does not refer \\\n+                          to an enumeration\", id)); }\n+             }\n+         }\n+      }\n+    }\n+\n     e.mod_map.values {|val|\n         alt val.m {\n           some(m) {\n@@ -1776,14 +1802,44 @@ fn check_exports(e: @env) {\n                         check_export(e, ident, val, vi);\n                     }\n                   }\n+                  ast::view_item_export_tag_none(id, _) {\n+                      let _ = check_enum_ok(e, vi.span, id, val);\n+                  }\n+                  ast::view_item_export_tag_some(id, ids, _) {\n+                      // Check that it's an enum and all the given variants\n+                      // belong to it\n+                      let parent_id = check_enum_ok(e, vi.span, id, val);\n+                      for variant_id in ids {\n+                         alt val.index.find(variant_id.node.name) {\n+                            some(ms) {\n+                                list::iter(ms) {|m|\n+                                   alt m {\n+                                     mie_tag_variant(parent_item,_) {\n+                                       if parent_item.id != parent_id {\n+                                          e.sess.span_err(vi.span,\n+                                           #fmt(\"variant %s \\\n+                                           doesn't belong to enum %s\",\n+                                                variant_id.node.name,\n+                                                id));\n+                                       }\n+                                     }\n+                                     _ { e.sess.span_err(vi.span,\n+                                         #fmt(\"%s is not a \\\n+                                         variant\", variant_id.node.name));  }\n+                                       }}\n+                            }\n+                            _ { e.sess.span_err(vi.span, #fmt(\"%s is not a\\\n+                                         variant\", variant_id.node.name));  }\n+                      }\n+                     }\n+                  }\n                   _ { }\n                 }\n             }\n           }\n           none { }\n         }\n-    };\n-}\n+    }}\n \n // Impl resolution\n "}, {"sha": "09018c2167f9acca614a71c3bb9bff756b142f18", "filename": "src/test/compile-fail/bad-tag-export-2.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/6db688e893f69632624fb8d2e3b747a3b81000b0/src%2Ftest%2Fcompile-fail%2Fbad-tag-export-2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6db688e893f69632624fb8d2e3b747a3b81000b0/src%2Ftest%2Fcompile-fail%2Fbad-tag-export-2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fbad-tag-export-2.rs?ref=6db688e893f69632624fb8d2e3b747a3b81000b0", "patch": "@@ -0,0 +1,11 @@\n+// error-pattern:b does not refer to an enumeration\n+import bad::*;\n+\n+mod bad {\n+  export b::{};\n+\n+  fn b() { fail; }\n+}\n+\n+fn main() {\n+}\n\\ No newline at end of file"}, {"sha": "e6934688e21b90e1290ac52fe9374decfedb1af1", "filename": "src/test/compile-fail/bad-tag-export-3.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/6db688e893f69632624fb8d2e3b747a3b81000b0/src%2Ftest%2Fcompile-fail%2Fbad-tag-export-3.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6db688e893f69632624fb8d2e3b747a3b81000b0/src%2Ftest%2Fcompile-fail%2Fbad-tag-export-3.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fbad-tag-export-3.rs?ref=6db688e893f69632624fb8d2e3b747a3b81000b0", "patch": "@@ -0,0 +1,13 @@\n+// error-pattern:b does not refer to an enumeration\n+import bad::*;\n+\n+mod bad {\n+  export b::{f, z};\n+\n+  fn b() { fail; }\n+  fn f() { fail; }\n+  fn z() { fail; }\n+}\n+\n+fn main() {\n+}\n\\ No newline at end of file"}, {"sha": "fadf0c353a36a5e0da0491aa78a904175e915374", "filename": "src/test/compile-fail/bad-tag-export-4.rs", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/6db688e893f69632624fb8d2e3b747a3b81000b0/src%2Ftest%2Fcompile-fail%2Fbad-tag-export-4.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6db688e893f69632624fb8d2e3b747a3b81000b0/src%2Ftest%2Fcompile-fail%2Fbad-tag-export-4.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fbad-tag-export-4.rs?ref=6db688e893f69632624fb8d2e3b747a3b81000b0", "patch": "@@ -0,0 +1,12 @@\n+// error-pattern:f is not a variant\n+import bad::*;\n+\n+mod bad {\n+  export b::{f, z};\n+\n+  enum b { z, k }\n+  fn f() { fail; }\n+}\n+\n+fn main() {\n+}\n\\ No newline at end of file"}, {"sha": "fb9d9b8682c6c5283a9125532593057ba7d3deea", "filename": "src/test/compile-fail/bad-tag-export.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/6db688e893f69632624fb8d2e3b747a3b81000b0/src%2Ftest%2Fcompile-fail%2Fbad-tag-export.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6db688e893f69632624fb8d2e3b747a3b81000b0/src%2Ftest%2Fcompile-fail%2Fbad-tag-export.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fbad-tag-export.rs?ref=6db688e893f69632624fb8d2e3b747a3b81000b0", "patch": "@@ -0,0 +1,14 @@\n+// error-pattern:variant e doesn't belong to enum floop\n+import bad::*;\n+\n+mod bad {\n+\n+  export floop::{a, e};\n+\n+  enum floop {a, b, c}\n+  enum bloop {d, e, f}\n+\n+}\n+\n+fn main() {\n+}\n\\ No newline at end of file"}]}