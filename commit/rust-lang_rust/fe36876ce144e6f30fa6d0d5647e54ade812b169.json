{"sha": "fe36876ce144e6f30fa6d0d5647e54ade812b169", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZlMzY4NzZjZTE0NGU2ZjMwZmE2ZDBkNTY0N2U1NGFkZTgxMmIxNjk=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-10-02T06:53:35Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2016-10-02T06:53:35Z"}, "message": "Auto merge of #36853 - TimNN:rustbuild-out-of-tree, r=alexcrichton\n\nfix out-of-tree rustbuild\n\nSee https://github.com/rust-lang/rust/pull/36456#issuecomment-250589906\n\nr? @alexcrichton", "tree": {"sha": "064327333487e63af999ae348be9328c8502668b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/064327333487e63af999ae348be9328c8502668b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fe36876ce144e6f30fa6d0d5647e54ade812b169", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fe36876ce144e6f30fa6d0d5647e54ade812b169", "html_url": "https://github.com/rust-lang/rust/commit/fe36876ce144e6f30fa6d0d5647e54ade812b169", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fe36876ce144e6f30fa6d0d5647e54ade812b169/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7b33876fcc8f186b24a33459fd9d82bc8568fae2", "url": "https://api.github.com/repos/rust-lang/rust/commits/7b33876fcc8f186b24a33459fd9d82bc8568fae2", "html_url": "https://github.com/rust-lang/rust/commit/7b33876fcc8f186b24a33459fd9d82bc8568fae2"}, {"sha": "62fb242ad64ed97faaf61a8d2d13c237480d4bb5", "url": "https://api.github.com/repos/rust-lang/rust/commits/62fb242ad64ed97faaf61a8d2d13c237480d4bb5", "html_url": "https://github.com/rust-lang/rust/commit/62fb242ad64ed97faaf61a8d2d13c237480d4bb5"}], "stats": {"total": 19, "additions": 12, "deletions": 7}, "files": [{"sha": "b4f61605d472db1f72596f99da37483513097ded", "filename": "src/bootstrap/lib.rs", "status": "modified", "additions": 12, "deletions": 7, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/fe36876ce144e6f30fa6d0d5647e54ade812b169/src%2Fbootstrap%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fe36876ce144e6f30fa6d0d5647e54ade812b169/src%2Fbootstrap%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Flib.rs?ref=fe36876ce144e6f30fa6d0d5647e54ade812b169", "patch": "@@ -557,17 +557,22 @@ impl Build {\n                 continue\n             }\n \n-            if !submodule.path.exists() {\n-                t!(fs::create_dir_all(&submodule.path));\n-            }\n+            // `submodule.path` is the relative path to a submodule (from the repository root)\n+            // `submodule_path` is the path to a submodule from the cwd\n+\n+            // use `submodule.path` when e.g. executing a submodule specific command from the\n+            // repository root\n+            // use `submodule_path` when e.g. executing a normal git command for the submodule\n+            // (set via `current_dir`)\n+            let submodule_path = self.src.join(submodule.path);\n \n             match submodule.state {\n                 State::MaybeDirty => {\n                     // drop staged changes\n-                    self.run(git().current_dir(submodule.path)\n+                    self.run(git().current_dir(&submodule_path)\n                                   .args(&[\"reset\", \"--hard\"]));\n                     // drops unstaged changes\n-                    self.run(git().current_dir(submodule.path)\n+                    self.run(git().current_dir(&submodule_path)\n                                   .args(&[\"clean\", \"-fdx\"]));\n                 },\n                 State::NotInitialized => {\n@@ -577,9 +582,9 @@ impl Build {\n                 State::OutOfSync => {\n                     // drops submodule commits that weren't reported to the (outer) git repository\n                     self.run(git_submodule().arg(\"update\").arg(submodule.path));\n-                    self.run(git().current_dir(submodule.path)\n+                    self.run(git().current_dir(&submodule_path)\n                                   .args(&[\"reset\", \"--hard\"]));\n-                    self.run(git().current_dir(submodule.path)\n+                    self.run(git().current_dir(&submodule_path)\n                                   .args(&[\"clean\", \"-fdx\"]));\n                 },\n             }"}]}