{"sha": "80a95e34fe32ca86982607a85e9c5714eb6262d9", "node_id": "MDY6Q29tbWl0NzI0NzEyOjgwYTk1ZTM0ZmUzMmNhODY5ODI2MDdhODVlOWM1NzE0ZWI2MjYyZDk=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-11-21T17:23:04Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2016-11-21T17:23:04Z"}, "message": "Auto merge of #37912 - sanxiyn:llvm-compat, r=eddyb\n\nRestore compatibility with LLVM 3.7 and 3.8\n\nThis should fix Travis build.", "tree": {"sha": "1630905fd6d656f1723db4f6c27c35d6deab8f8c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1630905fd6d656f1723db4f6c27c35d6deab8f8c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/80a95e34fe32ca86982607a85e9c5714eb6262d9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/80a95e34fe32ca86982607a85e9c5714eb6262d9", "html_url": "https://github.com/rust-lang/rust/commit/80a95e34fe32ca86982607a85e9c5714eb6262d9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/80a95e34fe32ca86982607a85e9c5714eb6262d9/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ebec55406ba94faf8b2cd23b27a8f74df97d1ca4", "url": "https://api.github.com/repos/rust-lang/rust/commits/ebec55406ba94faf8b2cd23b27a8f74df97d1ca4", "html_url": "https://github.com/rust-lang/rust/commit/ebec55406ba94faf8b2cd23b27a8f74df97d1ca4"}, {"sha": "c45f3dee1010cc15c259f536f736396a5a5f585d", "url": "https://api.github.com/repos/rust-lang/rust/commits/c45f3dee1010cc15c259f536f736396a5a5f585d", "html_url": "https://github.com/rust-lang/rust/commit/c45f3dee1010cc15c259f536f736396a5a5f585d"}], "stats": {"total": 42, "additions": 15, "deletions": 27}, "files": [{"sha": "470e8d1fd4578d75eb2bb86274f4674713abfba0", "filename": "src/librustc_llvm/ffi.rs", "status": "modified", "additions": 3, "deletions": 10, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/80a95e34fe32ca86982607a85e9c5714eb6262d9/src%2Flibrustc_llvm%2Fffi.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a95e34fe32ca86982607a85e9c5714eb6262d9/src%2Flibrustc_llvm%2Fffi.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_llvm%2Fffi.rs?ref=80a95e34fe32ca86982607a85e9c5714eb6262d9", "patch": "@@ -395,9 +395,6 @@ pub type RustArchiveMemberRef = *mut RustArchiveMember_opaque;\n #[allow(missing_copy_implementations)]\n pub enum OperandBundleDef_opaque {}\n pub type OperandBundleDefRef = *mut OperandBundleDef_opaque;\n-#[allow(missing_copy_implementations)]\n-pub enum Attribute_opaque {}\n-pub type AttributeRef = *mut Attribute_opaque;\n \n pub type DiagnosticHandler = unsafe extern \"C\" fn(DiagnosticInfoRef, *mut c_void);\n pub type InlineAsmDiagHandler = unsafe extern \"C\" fn(SMDiagnosticRef, *const c_void, c_uint);\n@@ -770,8 +767,6 @@ extern \"C\" {\n                         Name: *const c_char)\n                         -> ValueRef;\n \n-    pub fn LLVMRustCreateAttribute(C: ContextRef, kind: Attribute, val: u64) -> AttributeRef;\n-\n     // Operations on functions\n     pub fn LLVMAddFunction(M: ModuleRef, Name: *const c_char, FunctionTy: TypeRef) -> ValueRef;\n     pub fn LLVMGetNamedFunction(M: ModuleRef, Name: *const c_char) -> ValueRef;\n@@ -790,12 +785,12 @@ extern \"C\" {\n     pub fn LLVMGetGC(Fn: ValueRef) -> *const c_char;\n     pub fn LLVMSetGC(Fn: ValueRef, Name: *const c_char);\n     pub fn LLVMRustAddDereferenceableAttr(Fn: ValueRef, index: c_uint, bytes: u64);\n-    pub fn LLVMRustAddFunctionAttribute(Fn: ValueRef, index: c_uint, attr: AttributeRef);\n+    pub fn LLVMRustAddFunctionAttribute(Fn: ValueRef, index: c_uint, attr: Attribute);\n     pub fn LLVMRustAddFunctionAttrStringValue(Fn: ValueRef,\n                                               index: c_uint,\n                                               Name: *const c_char,\n                                               Value: *const c_char);\n-    pub fn LLVMRustRemoveFunctionAttributes(Fn: ValueRef, index: c_uint, attr: AttributeRef);\n+    pub fn LLVMRustRemoveFunctionAttributes(Fn: ValueRef, index: c_uint, attr: Attribute);\n \n     // Operations on parameters\n     pub fn LLVMCountParams(Fn: ValueRef) -> c_uint;\n@@ -806,8 +801,6 @@ extern \"C\" {\n     pub fn LLVMGetLastParam(Fn: ValueRef) -> ValueRef;\n     pub fn LLVMGetNextParam(Arg: ValueRef) -> ValueRef;\n     pub fn LLVMGetPreviousParam(Arg: ValueRef) -> ValueRef;\n-    pub fn LLVMAddAttribute(Arg: ValueRef, attr: AttributeRef);\n-    pub fn LLVMRemoveAttribute(Arg: ValueRef, attr: AttributeRef);\n     pub fn LLVMSetParamAlignment(Arg: ValueRef, align: c_uint);\n \n     // Operations on basic blocks\n@@ -851,7 +844,7 @@ extern \"C\" {\n     pub fn LLVMAddInstrAttribute(Instr: ValueRef, index: c_uint, IA: c_uint);\n     pub fn LLVMRemoveInstrAttribute(Instr: ValueRef, index: c_uint, IA: c_uint);\n     pub fn LLVMSetInstrParamAlignment(Instr: ValueRef, index: c_uint, align: c_uint);\n-    pub fn LLVMRustAddCallSiteAttribute(Instr: ValueRef, index: c_uint, attr: AttributeRef);\n+    pub fn LLVMRustAddCallSiteAttribute(Instr: ValueRef, index: c_uint, attr: Attribute);\n     pub fn LLVMRustAddDereferenceableCallSiteAttr(Instr: ValueRef, index: c_uint, bytes: u64);\n \n     // Operations on call instructions (only)"}, {"sha": "c4ec418f224b579c00fad7ab0d755d06def05f57", "filename": "src/librustc_llvm/lib.rs", "status": "modified", "additions": 3, "deletions": 7, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/80a95e34fe32ca86982607a85e9c5714eb6262d9/src%2Flibrustc_llvm%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80a95e34fe32ca86982607a85e9c5714eb6262d9/src%2Flibrustc_llvm%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_llvm%2Flib.rs?ref=80a95e34fe32ca86982607a85e9c5714eb6262d9", "patch": "@@ -176,20 +176,16 @@ pub fn set_thread_local(global: ValueRef, is_thread_local: bool) {\n }\n \n impl Attribute {\n-    fn as_object(&self, value: ValueRef) -> AttributeRef {\n-        unsafe { LLVMRustCreateAttribute(LLVMRustGetValueContext(value), *self, 0) }\n-    }\n-\n     pub fn apply_llfn(&self, idx: AttributePlace, llfn: ValueRef) {\n-        unsafe { LLVMRustAddFunctionAttribute(llfn, idx.as_uint(), self.as_object(llfn)) }\n+        unsafe { LLVMRustAddFunctionAttribute(llfn, idx.as_uint(), *self) }\n     }\n \n     pub fn apply_callsite(&self, idx: AttributePlace, callsite: ValueRef) {\n-        unsafe { LLVMRustAddCallSiteAttribute(callsite, idx.as_uint(), self.as_object(callsite)) }\n+        unsafe { LLVMRustAddCallSiteAttribute(callsite, idx.as_uint(), *self) }\n     }\n \n     pub fn unapply_llfn(&self, idx: AttributePlace, llfn: ValueRef) {\n-        unsafe { LLVMRustRemoveFunctionAttributes(llfn, idx.as_uint(), self.as_object(llfn)) }\n+        unsafe { LLVMRustRemoveFunctionAttributes(llfn, idx.as_uint(), *self) }\n     }\n \n     pub fn toggle_llfn(&self, idx: AttributePlace, llfn: ValueRef, set: bool) {"}, {"sha": "b035e134e37d52abedff817571f0f6e362991de8", "filename": "src/rustllvm/RustWrapper.cpp", "status": "modified", "additions": 9, "deletions": 10, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/80a95e34fe32ca86982607a85e9c5714eb6262d9/src%2Frustllvm%2FRustWrapper.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/80a95e34fe32ca86982607a85e9c5714eb6262d9/src%2Frustllvm%2FRustWrapper.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustllvm%2FRustWrapper.cpp?ref=80a95e34fe32ca86982607a85e9c5714eb6262d9", "patch": "@@ -155,13 +155,10 @@ from_rust(LLVMRustAttribute kind) {\n   }\n }\n \n-extern \"C\" LLVMAttributeRef LLVMRustCreateAttribute(LLVMContextRef C, LLVMRustAttribute Kind, uint64_t Val) {\n-  return wrap(Attribute::get(*unwrap(C), from_rust(Kind), Val));\n-}\n-\n-extern \"C\" void LLVMRustAddCallSiteAttribute(LLVMValueRef Instr, unsigned index, LLVMAttributeRef attr) {\n+extern \"C\" void LLVMRustAddCallSiteAttribute(LLVMValueRef Instr, unsigned index, LLVMRustAttribute attr) {\n   CallSite Call = CallSite(unwrap<Instruction>(Instr));\n-  AttrBuilder B(unwrap(attr));\n+  Attribute Attr = Attribute::get(Call->getContext(), from_rust(attr));\n+  AttrBuilder B(Attr);\n   Call.setAttributes(\n     Call.getAttributes().addAttributes(Call->getContext(), index,\n                                        AttributeSet::get(Call->getContext(),\n@@ -183,10 +180,11 @@ extern \"C\" void LLVMRustAddDereferenceableCallSiteAttr(LLVMValueRef Instr,\n \n extern \"C\" void LLVMRustAddFunctionAttribute(LLVMValueRef Fn,\n \t\t\t\t\t     unsigned index,\n-\t\t\t\t\t     LLVMAttributeRef attr)\n+\t\t\t\t\t     LLVMRustAttribute attr)\n {\n   Function *A = unwrap<Function>(Fn);\n-  AttrBuilder B(unwrap(attr));\n+  Attribute Attr = Attribute::get(A->getContext(), from_rust(attr));\n+  AttrBuilder B(Attr);\n   A->addAttributes(index, AttributeSet::get(A->getContext(), index, B));\n }\n \n@@ -212,11 +210,12 @@ extern \"C\" void LLVMRustAddFunctionAttrStringValue(LLVMValueRef Fn,\n \n extern \"C\" void LLVMRustRemoveFunctionAttributes(LLVMValueRef Fn,\n \t\t\t\t\t\t unsigned index,\n-\t\t\t\t\t\t LLVMAttributeRef attr)\n+\t\t\t\t\t\t LLVMRustAttribute attr)\n {\n   Function *F = unwrap<Function>(Fn);\n   const AttributeSet PAL = F->getAttributes();\n-  AttrBuilder B(unwrap(attr));\n+  Attribute Attr = Attribute::get(F->getContext(), from_rust(attr));\n+  AttrBuilder B(Attr);\n   const AttributeSet PALnew =\n     PAL.removeAttributes(F->getContext(), index,\n                          AttributeSet::get(F->getContext(), index, B));"}]}