{"sha": "8a03147f224369f96c2a826bc2dcbde3a6be1f10", "node_id": "MDY6Q29tbWl0NzI0NzEyOjhhMDMxNDdmMjI0MzY5Zjk2YzJhODI2YmMyZGNiZGUzYTZiZTFmMTA=", "commit": {"author": {"name": "Oliver Scherer", "email": "github35764891676564198441@oli-obk.de", "date": "2020-04-09T14:48:36Z"}, "committer": {"name": "Oliver Scherer", "email": "github35764891676564198441@oli-obk.de", "date": "2020-04-09T14:48:36Z"}, "message": "Normalize MIR locals' types for generator layout computation.", "tree": {"sha": "2a9dab30b7463755569d83a06f7ea461bb234fd6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2a9dab30b7463755569d83a06f7ea461bb234fd6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8a03147f224369f96c2a826bc2dcbde3a6be1f10", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8a03147f224369f96c2a826bc2dcbde3a6be1f10", "html_url": "https://github.com/rust-lang/rust/commit/8a03147f224369f96c2a826bc2dcbde3a6be1f10", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8a03147f224369f96c2a826bc2dcbde3a6be1f10/comments", "author": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "committer": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "11f6096a9ef6ad52de2956f4d2df200de7617077", "url": "https://api.github.com/repos/rust-lang/rust/commits/11f6096a9ef6ad52de2956f4d2df200de7617077", "html_url": "https://github.com/rust-lang/rust/commit/11f6096a9ef6ad52de2956f4d2df200de7617077"}], "stats": {"total": 15, "additions": 14, "deletions": 1}, "files": [{"sha": "ca596f63393d7d3c318305a8ffc414f4145160ef", "filename": "src/librustc_mir/transform/generator.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/8a03147f224369f96c2a826bc2dcbde3a6be1f10/src%2Flibrustc_mir%2Ftransform%2Fgenerator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8a03147f224369f96c2a826bc2dcbde3a6be1f10/src%2Flibrustc_mir%2Ftransform%2Fgenerator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fgenerator.rs?ref=8a03147f224369f96c2a826bc2dcbde3a6be1f10", "patch": "@@ -720,15 +720,18 @@ fn compute_layout<'tcx>(\n         _ => bug!(),\n     };\n \n+    let param_env = tcx.param_env(source.def_id());\n+\n     for (local, decl) in body.local_decls.iter_enumerated() {\n         // Ignore locals which are internal or not live\n         if !live_locals.contains(local) || decl.internal {\n             continue;\n         }\n+        let decl_ty = tcx.normalize_erasing_regions(param_env, decl.ty);\n \n         // Sanity check that typeck knows about the type of locals which are\n         // live across a suspension point\n-        if !allowed.contains(&decl.ty) && !allowed_upvars.contains(&decl.ty) {\n+        if !allowed.contains(&decl_ty) && !allowed_upvars.contains(&decl_ty) {\n             span_bug!(\n                 body.span,\n                 \"Broken MIR: generator contains type {} in MIR, \\"}, {"sha": "ebabc3fbf10f9185a3ee9287afeaef3e7c145dbe", "filename": "src/test/ui/repeat_count_const_in_async_fn.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/8a03147f224369f96c2a826bc2dcbde3a6be1f10/src%2Ftest%2Fui%2Frepeat_count_const_in_async_fn.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8a03147f224369f96c2a826bc2dcbde3a6be1f10/src%2Ftest%2Fui%2Frepeat_count_const_in_async_fn.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frepeat_count_const_in_async_fn.rs?ref=8a03147f224369f96c2a826bc2dcbde3a6be1f10", "patch": "@@ -0,0 +1,10 @@\n+// check-pass\n+// edition:2018\n+// compile-flags: --crate-type=lib\n+\n+pub async fn test() {\n+    const C: usize = 4;\n+    foo(&mut [0u8; C]).await;\n+}\n+\n+async fn foo(_: &mut [u8]) {}"}]}