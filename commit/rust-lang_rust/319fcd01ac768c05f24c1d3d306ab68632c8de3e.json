{"sha": "319fcd01ac768c05f24c1d3d306ab68632c8de3e", "node_id": "MDY6Q29tbWl0NzI0NzEyOjMxOWZjZDAxYWM3NjhjMDVmMjRjMWQzZDMwNmFiNjg2MzJjOGRlM2U=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2020-12-02T13:23:51Z"}, "committer": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2020-12-02T13:23:51Z"}, "message": "Attach macro expansion errors to the right file", "tree": {"sha": "b3a483fadbe0547b8af5a34e9f13bd7d817b3956", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b3a483fadbe0547b8af5a34e9f13bd7d817b3956"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/319fcd01ac768c05f24c1d3d306ab68632c8de3e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/319fcd01ac768c05f24c1d3d306ab68632c8de3e", "html_url": "https://github.com/rust-lang/rust/commit/319fcd01ac768c05f24c1d3d306ab68632c8de3e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/319fcd01ac768c05f24c1d3d306ab68632c8de3e/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bb697727a2e43d734a1bf3aae7644a9249aee11e", "url": "https://api.github.com/repos/rust-lang/rust/commits/bb697727a2e43d734a1bf3aae7644a9249aee11e", "html_url": "https://github.com/rust-lang/rust/commit/bb697727a2e43d734a1bf3aae7644a9249aee11e"}], "stats": {"total": 7, "additions": 5, "deletions": 2}, "files": [{"sha": "689a3274c793a507785ae43e17a75904f7c04651", "filename": "crates/hir_def/src/body/lower.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/319fcd01ac768c05f24c1d3d306ab68632c8de3e/crates%2Fhir_def%2Fsrc%2Fbody%2Flower.rs", "raw_url": "https://github.com/rust-lang/rust/raw/319fcd01ac768c05f24c1d3d306ab68632c8de3e/crates%2Fhir_def%2Fsrc%2Fbody%2Flower.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fbody%2Flower.rs?ref=319fcd01ac768c05f24c1d3d306ab68632c8de3e", "patch": "@@ -560,14 +560,17 @@ impl ExprCollector<'_> {\n                     // FIXME: do we still need to allocate this as missing ?\n                     self.alloc_expr(Expr::Missing, syntax_ptr)\n                 } else {\n+                    // File containing the macro call. Expansion errors will be attached here.\n+                    let outer_file = self.expander.current_file_id;\n+\n                     let macro_call = self.expander.to_source(AstPtr::new(&e));\n                     let res = self.expander.enter_expand(self.db, Some(&self.body.item_scope), e);\n \n                     match res.err {\n                         Some(ExpandError::UnresolvedProcMacro) => {\n                             self.source_map.diagnostics.push(BodyDiagnostic::UnresolvedProcMacro(\n                                 UnresolvedProcMacro {\n-                                    file: self.expander.current_file_id,\n+                                    file: outer_file,\n                                     node: syntax_ptr.clone().into(),\n                                     precise_location: None,\n                                     macro_name: None,\n@@ -577,7 +580,7 @@ impl ExprCollector<'_> {\n                         Some(err) => {\n                             self.source_map.diagnostics.push(BodyDiagnostic::MacroError(\n                                 MacroError {\n-                                    file: self.expander.current_file_id,\n+                                    file: outer_file,\n                                     node: syntax_ptr.clone().into(),\n                                     message: err.to_string(),\n                                 },"}]}