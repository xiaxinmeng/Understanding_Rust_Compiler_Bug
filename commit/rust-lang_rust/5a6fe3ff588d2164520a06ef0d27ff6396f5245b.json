{"sha": "5a6fe3ff588d2164520a06ef0d27ff6396f5245b", "node_id": "C_kwDOAAsO6NoAKDVhNmZlM2ZmNTg4ZDIxNjQ1MjBhMDZlZjBkMjdmZjYzOTZmNTI0NWI", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2022-07-14T08:44:19Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-07-14T08:44:19Z"}, "message": "Rollup merge of #97720 - cjgillot:all-fresh, r=petrochenkov\n\nAlways create elided lifetime parameters for functions\n\nAnonymous and elided lifetimes in functions are sometimes (async fns) --and sometimes not (regular fns)-- desugared to implicit generic parameters.\n\nThis difference of treatment makes it some downstream analyses more complicated to handle.  This step is a pre-requisite to perform lifetime elision resolution on AST.\n\nThere is currently an inconsistency in the treatment of argument-position impl-trait for functions and async fns:\n```rust\ntrait Foo<'a> {}\nfn foo(t: impl Foo<'_>) {} //~ ERROR missing lifetime specifier\nasync fn async_foo(t: impl Foo<'_>) {} //~ OK\nfn bar(t: impl Iterator<Item = &'_ u8>) {} //~ ERROR missing lifetime specifier\nasync fn async_bar(t: impl Iterator<Item = &'_ u8>) {} //~ OK\n```\n\nThe current implementation reports \"missing lifetime specifier\" on `foo`, but **accepts it** in `async_foo`.\nThis PR **proposes to accept** the anonymous lifetime in both cases as an extra generic lifetime parameter.\nThis change would be insta-stable, so let's ping t-lang.\nAnonymous lifetimes in GAT bindings keep being forbidden:\n```rust\nfn foo(t: impl Foo<Assoc<'_> = Bar<'_>>) {}\n                         ^^        ^^\n                       forbidden   ok\n```\nI started a discussion here: https://rust-lang.zulipchat.com/#narrow/stream/213817-t-lang/topic/Anonymous.20lifetimes.20in.20universal.20impl-trait/near/284968606\n\nr? ``@petrochenkov``", "tree": {"sha": "1dc36f9f4cbca27370c89917f1a42b3db2aa93c8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1dc36f9f4cbca27370c89917f1a42b3db2aa93c8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5a6fe3ff588d2164520a06ef0d27ff6396f5245b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5a6fe3ff588d2164520a06ef0d27ff6396f5245b", "html_url": "https://github.com/rust-lang/rust/commit/5a6fe3ff588d2164520a06ef0d27ff6396f5245b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5a6fe3ff588d2164520a06ef0d27ff6396f5245b/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "eee0bf459dcdf8ff159e3c8d11600cb73f4519de", "url": "https://api.github.com/repos/rust-lang/rust/commits/eee0bf459dcdf8ff159e3c8d11600cb73f4519de", "html_url": "https://github.com/rust-lang/rust/commit/eee0bf459dcdf8ff159e3c8d11600cb73f4519de"}, {"sha": "dcd248465ee871bfb5798b8491dfb179fbe4a307", "url": "https://api.github.com/repos/rust-lang/rust/commits/dcd248465ee871bfb5798b8491dfb179fbe4a307", "html_url": "https://github.com/rust-lang/rust/commit/dcd248465ee871bfb5798b8491dfb179fbe4a307"}], "stats": {"total": 19, "additions": 12, "deletions": 7}, "files": [{"sha": "94db1773fda69b081ca6b62230f5aacb3659491c", "filename": "clippy_lints/src/inherent_to_string.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/5a6fe3ff588d2164520a06ef0d27ff6396f5245b/clippy_lints%2Fsrc%2Finherent_to_string.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5a6fe3ff588d2164520a06ef0d27ff6396f5245b/clippy_lints%2Fsrc%2Finherent_to_string.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Finherent_to_string.rs?ref=5a6fe3ff588d2164520a06ef0d27ff6396f5245b", "patch": "@@ -2,7 +2,7 @@ use clippy_utils::diagnostics::span_lint_and_help;\n use clippy_utils::ty::{implements_trait, is_type_diagnostic_item};\n use clippy_utils::{get_trait_def_id, paths, return_ty, trait_ref_of_method};\n use if_chain::if_chain;\n-use rustc_hir::{ImplItem, ImplItemKind};\n+use rustc_hir::{GenericParamKind, ImplItem, ImplItemKind};\n use rustc_lint::{LateContext, LateLintPass};\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n use rustc_span::sym;\n@@ -102,7 +102,7 @@ impl<'tcx> LateLintPass<'tcx> for InherentToString {\n             let decl = &signature.decl;\n             if decl.implicit_self.has_implicit_self();\n             if decl.inputs.len() == 1;\n-            if impl_item.generics.params.is_empty();\n+            if impl_item.generics.params.iter().all(|p| matches!(p.kind, GenericParamKind::Lifetime { .. }));\n \n             // Check if return type is String\n             if is_type_diagnostic_item(cx, return_ty(cx, impl_item.hir_id()), sym::String);"}, {"sha": "083c437a293c0937b6be1cdc9f3431bc8ec631f0", "filename": "clippy_lints/src/lifetimes.rs", "status": "modified", "additions": 7, "deletions": 3, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/5a6fe3ff588d2164520a06ef0d27ff6396f5245b/clippy_lints%2Fsrc%2Flifetimes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5a6fe3ff588d2164520a06ef0d27ff6396f5245b/clippy_lints%2Fsrc%2Flifetimes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flifetimes.rs?ref=5a6fe3ff588d2164520a06ef0d27ff6396f5245b", "patch": "@@ -9,8 +9,8 @@ use rustc_hir::intravisit::{\n use rustc_hir::FnRetTy::Return;\n use rustc_hir::{\n     BareFnTy, BodyId, FnDecl, GenericArg, GenericBound, GenericParam, GenericParamKind, Generics, Impl, ImplItem,\n-    ImplItemKind, Item, ItemKind, LangItem, Lifetime, LifetimeName, ParamName, PolyTraitRef, PredicateOrigin,\n-    TraitBoundModifier, TraitFn, TraitItem, TraitItemKind, Ty, TyKind, WherePredicate,\n+    ImplItemKind, Item, ItemKind, LangItem, Lifetime, LifetimeName, LifetimeParamKind, ParamName, PolyTraitRef,\n+    PredicateOrigin, TraitBoundModifier, TraitFn, TraitItem, TraitItemKind, Ty, TyKind, WherePredicate,\n };\n use rustc_lint::{LateContext, LateLintPass};\n use rustc_middle::hir::nested_filter as middle_nested_filter;\n@@ -338,7 +338,10 @@ fn could_use_elision<'tcx>(\n fn allowed_lts_from(named_generics: &[GenericParam<'_>]) -> FxHashSet<RefLt> {\n     let mut allowed_lts = FxHashSet::default();\n     for par in named_generics.iter() {\n-        if let GenericParamKind::Lifetime { .. } = par.kind {\n+        if let GenericParamKind::Lifetime {\n+            kind: LifetimeParamKind::Explicit,\n+        } = par.kind\n+        {\n             allowed_lts.insert(RefLt::Named(par.name.ident().name));\n         }\n     }\n@@ -379,6 +382,7 @@ impl<'a, 'tcx> RefVisitor<'a, 'tcx> {\n                 self.lts.push(RefLt::Static);\n             } else if let LifetimeName::Param(_, ParamName::Fresh) = lt.name {\n                 // Fresh lifetimes generated should be ignored.\n+                self.lts.push(RefLt::Unnamed);\n             } else if lt.is_elided() {\n                 self.lts.push(RefLt::Unnamed);\n             } else {"}, {"sha": "8571607054a0070bed5709fe483b66b8008b3394", "filename": "clippy_lints/src/ptr.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/5a6fe3ff588d2164520a06ef0d27ff6396f5245b/clippy_lints%2Fsrc%2Fptr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5a6fe3ff588d2164520a06ef0d27ff6396f5245b/clippy_lints%2Fsrc%2Fptr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fptr.rs?ref=5a6fe3ff588d2164520a06ef0d27ff6396f5245b", "patch": "@@ -495,12 +495,13 @@ fn check_mut_from_ref<'tcx>(cx: &LateContext<'tcx>, sig: &FnSig<'_>, body: Optio\n     if let FnRetTy::Return(ty) = sig.decl.output\n         && let Some((out, Mutability::Mut, _)) = get_rptr_lm(ty)\n     {\n+        let out_region = cx.tcx.named_region(out.hir_id);\n         let args: Option<Vec<_>> = sig\n             .decl\n             .inputs\n             .iter()\n             .filter_map(get_rptr_lm)\n-            .filter(|&(lt, _, _)| lt.name == out.name)\n+            .filter(|&(lt, _, _)| cx.tcx.named_region(lt.hir_id) == out_region)\n             .map(|(_, mutability, span)| (mutability == Mutability::Not).then(|| span))\n             .collect();\n         if let Some(args) = args"}, {"sha": "94945b2e1a9e250fe64c6a4958108dd79d9070e6", "filename": "clippy_lints/src/types/borrowed_box.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/5a6fe3ff588d2164520a06ef0d27ff6396f5245b/clippy_lints%2Fsrc%2Ftypes%2Fborrowed_box.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5a6fe3ff588d2164520a06ef0d27ff6396f5245b/clippy_lints%2Fsrc%2Ftypes%2Fborrowed_box.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Ftypes%2Fborrowed_box.rs?ref=5a6fe3ff588d2164520a06ef0d27ff6396f5245b", "patch": "@@ -31,7 +31,7 @@ pub(super) fn check(cx: &LateContext<'_>, hir_ty: &hir::Ty<'_>, lt: &Lifetime, m\n                         return false;\n                     }\n \n-                    let ltopt = if lt.is_elided() {\n+                    let ltopt = if lt.name.is_anonymous() {\n                         String::new()\n                     } else {\n                         format!(\"{} \", lt.name.ident().as_str())"}]}