{"sha": "b30c88623cf1f8f3e67b189fb2c5df5a0d89aaed", "node_id": "C_kwDOAAsO6NoAKGIzMGM4ODYyM2NmMWY4ZjNlNjdiMTg5ZmIyYzVkZjVhMGQ4OWFhZWQ", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-09-28T22:15:28Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-09-28T22:15:28Z"}, "message": "Auto merge of #102384 - camelid:extrainfo, r=GuillaumeGomez\n\nrustdoc: Remove `clean::TraitWithExtraInfo` and queryify `is_notable_trait`\n\ncc `@notriddle` `@GuillaumeGomez`", "tree": {"sha": "633d6d34a3dc6d987701c500f3ad87bf8c997474", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/633d6d34a3dc6d987701c500f3ad87bf8c997474"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b30c88623cf1f8f3e67b189fb2c5df5a0d89aaed", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b30c88623cf1f8f3e67b189fb2c5df5a0d89aaed", "html_url": "https://github.com/rust-lang/rust/commit/b30c88623cf1f8f3e67b189fb2c5df5a0d89aaed", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b30c88623cf1f8f3e67b189fb2c5df5a0d89aaed/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ce7f0f1aa0f02c45cad0749e63f3086234b1f422", "url": "https://api.github.com/repos/rust-lang/rust/commits/ce7f0f1aa0f02c45cad0749e63f3086234b1f422", "html_url": "https://github.com/rust-lang/rust/commit/ce7f0f1aa0f02c45cad0749e63f3086234b1f422"}, {"sha": "4bf789fba7b04c745b8d55b020903f7d64b2720d", "url": "https://api.github.com/repos/rust-lang/rust/commits/4bf789fba7b04c745b8d55b020903f7d64b2720d", "html_url": "https://github.com/rust-lang/rust/commit/4bf789fba7b04c745b8d55b020903f7d64b2720d"}], "stats": {"total": 72, "additions": 39, "deletions": 33}, "files": [{"sha": "fb867f8b46b10ba5e4fc2b79ffceda923fdbbd9b", "filename": "compiler/rustc_middle/src/query/mod.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/b30c88623cf1f8f3e67b189fb2c5df5a0d89aaed/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b30c88623cf1f8f3e67b189fb2c5df5a0d89aaed/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs?ref=b30c88623cf1f8f3e67b189fb2c5df5a0d89aaed", "patch": "@@ -1126,6 +1126,11 @@ rustc_queries! {\n         desc { |tcx| \"checking whether `{}` is `doc(hidden)`\", tcx.def_path_str(def_id) }\n     }\n \n+    /// Determines whether an item is annotated with `doc(notable_trait)`.\n+    query is_doc_notable_trait(def_id: DefId) -> bool {\n+        desc { |tcx| \"checking whether `{}` is `doc(notable_trait)`\", tcx.def_path_str(def_id) }\n+    }\n+\n     /// Returns the attributes on the item at `def_id`.\n     ///\n     /// Do not use this directly, use `tcx.get_attrs` instead."}, {"sha": "713f9067a85e2625477f518e7cc1505e72e45a28", "filename": "compiler/rustc_middle/src/ty/util.rs", "status": "modified", "additions": 14, "deletions": 2, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/b30c88623cf1f8f3e67b189fb2c5df5a0d89aaed/compiler%2Frustc_middle%2Fsrc%2Fty%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b30c88623cf1f8f3e67b189fb2c5df5a0d89aaed/compiler%2Frustc_middle%2Fsrc%2Fty%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Futil.rs?ref=b30c88623cf1f8f3e67b189fb2c5df5a0d89aaed", "patch": "@@ -1289,12 +1289,24 @@ pub fn is_doc_hidden(tcx: TyCtxt<'_>, def_id: DefId) -> bool {\n         .any(|items| items.iter().any(|item| item.has_name(sym::hidden)))\n }\n \n+/// Determines whether an item is annotated with `doc(notable_trait)`.\n+pub fn is_doc_notable_trait(tcx: TyCtxt<'_>, def_id: DefId) -> bool {\n+    tcx.get_attrs(def_id, sym::doc)\n+        .filter_map(|attr| attr.meta_item_list())\n+        .any(|items| items.iter().any(|item| item.has_name(sym::notable_trait)))\n+}\n+\n /// Determines whether an item is an intrinsic by Abi.\n pub fn is_intrinsic(tcx: TyCtxt<'_>, def_id: DefId) -> bool {\n     matches!(tcx.fn_sig(def_id).abi(), Abi::RustIntrinsic | Abi::PlatformIntrinsic)\n }\n \n pub fn provide(providers: &mut ty::query::Providers) {\n-    *providers =\n-        ty::query::Providers { normalize_opaque_types, is_doc_hidden, is_intrinsic, ..*providers }\n+    *providers = ty::query::Providers {\n+        normalize_opaque_types,\n+        is_doc_hidden,\n+        is_doc_notable_trait,\n+        is_intrinsic,\n+        ..*providers\n+    }\n }"}, {"sha": "7893429f26f80ca0261389d684ecf6c3aa66d1f0", "filename": "src/librustdoc/clean/inline.rs", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b30c88623cf1f8f3e67b189fb2c5df5a0d89aaed/src%2Flibrustdoc%2Fclean%2Finline.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b30c88623cf1f8f3e67b189fb2c5df5a0d89aaed/src%2Flibrustdoc%2Fclean%2Finline.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Finline.rs?ref=b30c88623cf1f8f3e67b189fb2c5df5a0d89aaed", "patch": "@@ -718,10 +718,6 @@ pub(crate) fn record_extern_trait(cx: &mut DocContext<'_>, did: DefId) {\n     debug!(\"record_extern_trait: {:?}\", did);\n     let trait_ = build_external_trait(cx, did);\n \n-    let trait_ = clean::TraitWithExtraInfo {\n-        trait_,\n-        is_notable: clean::utils::has_doc_flag(cx.tcx, did, sym::notable_trait),\n-    };\n     cx.external_traits.borrow_mut().insert(did, trait_);\n     cx.active_extern_traits.remove(&did);\n }"}, {"sha": "a68b55e26b6a2d0796042a933bed249cd74d15b2", "filename": "src/librustdoc/clean/types.rs", "status": "modified", "additions": 4, "deletions": 8, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/b30c88623cf1f8f3e67b189fb2c5df5a0d89aaed/src%2Flibrustdoc%2Fclean%2Ftypes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b30c88623cf1f8f3e67b189fb2c5df5a0d89aaed/src%2Flibrustdoc%2Fclean%2Ftypes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Ftypes.rs?ref=b30c88623cf1f8f3e67b189fb2c5df5a0d89aaed", "patch": "@@ -119,7 +119,7 @@ pub(crate) struct Crate {\n     pub(crate) module: Item,\n     pub(crate) primitives: ThinVec<(DefId, PrimitiveType)>,\n     /// Only here so that they can be filtered through the rustdoc passes.\n-    pub(crate) external_traits: Rc<RefCell<FxHashMap<DefId, TraitWithExtraInfo>>>,\n+    pub(crate) external_traits: Rc<RefCell<FxHashMap<DefId, Trait>>>,\n }\n \n impl Crate {\n@@ -132,13 +132,6 @@ impl Crate {\n     }\n }\n \n-/// This struct is used to wrap additional information added by rustdoc on a `trait` item.\n-#[derive(Clone, Debug)]\n-pub(crate) struct TraitWithExtraInfo {\n-    pub(crate) trait_: Trait,\n-    pub(crate) is_notable: bool,\n-}\n-\n #[derive(Copy, Clone, Debug)]\n pub(crate) struct ExternalCrate {\n     pub(crate) crate_num: CrateNum,\n@@ -1530,6 +1523,9 @@ impl Trait {\n     pub(crate) fn is_auto(&self, tcx: TyCtxt<'_>) -> bool {\n         tcx.trait_is_auto(self.def_id)\n     }\n+    pub(crate) fn is_notable_trait(&self, tcx: TyCtxt<'_>) -> bool {\n+        tcx.is_doc_notable_trait(self.def_id)\n+    }\n     pub(crate) fn unsafety(&self, tcx: TyCtxt<'_>) -> hir::Unsafety {\n         tcx.trait_def(self.def_id).unsafety\n     }"}, {"sha": "f00dff9828dd282cfda423bd3777d8674c92bbfd", "filename": "src/librustdoc/core.rs", "status": "modified", "additions": 3, "deletions": 5, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/b30c88623cf1f8f3e67b189fb2c5df5a0d89aaed/src%2Flibrustdoc%2Fcore.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b30c88623cf1f8f3e67b189fb2c5df5a0d89aaed/src%2Flibrustdoc%2Fcore.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fcore.rs?ref=b30c88623cf1f8f3e67b189fb2c5df5a0d89aaed", "patch": "@@ -25,7 +25,7 @@ use std::rc::Rc;\n use std::sync::LazyLock;\n \n use crate::clean::inline::build_external_trait;\n-use crate::clean::{self, ItemId, TraitWithExtraInfo};\n+use crate::clean::{self, ItemId};\n use crate::config::{Options as RustdocOptions, OutputFormat, RenderOptions};\n use crate::formats::cache::Cache;\n use crate::passes::collect_intra_doc_links::PreprocessedMarkdownLink;\n@@ -58,7 +58,7 @@ pub(crate) struct DocContext<'tcx> {\n     /// Most of this logic is copied from rustc_lint::late.\n     pub(crate) param_env: ParamEnv<'tcx>,\n     /// Later on moved through `clean::Crate` into `cache`\n-    pub(crate) external_traits: Rc<RefCell<FxHashMap<DefId, clean::TraitWithExtraInfo>>>,\n+    pub(crate) external_traits: Rc<RefCell<FxHashMap<DefId, clean::Trait>>>,\n     /// Used while populating `external_traits` to ensure we don't process the same trait twice at\n     /// the same time.\n     pub(crate) active_extern_traits: FxHashSet<DefId>,\n@@ -388,9 +388,7 @@ pub(crate) fn run_global_ctxt(\n     // Note that in case of `#![no_core]`, the trait is not available.\n     if let Some(sized_trait_did) = ctxt.tcx.lang_items().sized_trait() {\n         let sized_trait = build_external_trait(&mut ctxt, sized_trait_did);\n-        ctxt.external_traits\n-            .borrow_mut()\n-            .insert(sized_trait_did, TraitWithExtraInfo { trait_: sized_trait, is_notable: false });\n+        ctxt.external_traits.borrow_mut().insert(sized_trait_did, sized_trait);\n     }\n \n     debug!(\"crate: {:?}\", tcx.hir().krate());"}, {"sha": "c6f1f9de51a49a4745516e4f7a31cf59b8c1543a", "filename": "src/librustdoc/fold.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b30c88623cf1f8f3e67b189fb2c5df5a0d89aaed/src%2Flibrustdoc%2Ffold.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b30c88623cf1f8f3e67b189fb2c5df5a0d89aaed/src%2Flibrustdoc%2Ffold.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Ffold.rs?ref=b30c88623cf1f8f3e67b189fb2c5df5a0d89aaed", "patch": "@@ -94,7 +94,7 @@ pub(crate) trait DocFolder: Sized {\n \n         let external_traits = { std::mem::take(&mut *c.external_traits.borrow_mut()) };\n         for (k, mut v) in external_traits {\n-            v.trait_.items = v.trait_.items.into_iter().filter_map(|i| self.fold_item(i)).collect();\n+            v.items = v.items.into_iter().filter_map(|i| self.fold_item(i)).collect();\n             c.external_traits.borrow_mut().insert(k, v);\n         }\n "}, {"sha": "2e428cfddcf0a343571e442a06be370e2045d0c0", "filename": "src/librustdoc/formats/cache.rs", "status": "modified", "additions": 3, "deletions": 8, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/b30c88623cf1f8f3e67b189fb2c5df5a0d89aaed/src%2Flibrustdoc%2Fformats%2Fcache.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b30c88623cf1f8f3e67b189fb2c5df5a0d89aaed/src%2Flibrustdoc%2Fformats%2Fcache.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fformats%2Fcache.rs?ref=b30c88623cf1f8f3e67b189fb2c5df5a0d89aaed", "patch": "@@ -4,7 +4,7 @@ use rustc_data_structures::fx::{FxHashMap, FxHashSet};\n use rustc_hir::def_id::{CrateNum, DefId};\n use rustc_middle::middle::privacy::AccessLevels;\n use rustc_middle::ty::{self, TyCtxt};\n-use rustc_span::{sym, Symbol};\n+use rustc_span::Symbol;\n \n use crate::clean::{self, types::ExternalLocation, ExternalCrate, ItemId, PrimitiveType};\n use crate::core::DocContext;\n@@ -62,7 +62,7 @@ pub(crate) struct Cache {\n     /// Implementations of a crate should inherit the documentation of the\n     /// parent trait if no extra documentation is specified, and default methods\n     /// should show up in documentation about trait implementations.\n-    pub(crate) traits: FxHashMap<DefId, clean::TraitWithExtraInfo>,\n+    pub(crate) traits: FxHashMap<DefId, clean::Trait>,\n \n     /// When rendering traits, it's often useful to be able to list all\n     /// implementors of the trait, and this mapping is exactly, that: a mapping\n@@ -225,12 +225,7 @@ impl<'a, 'tcx> DocFolder for CacheBuilder<'a, 'tcx> {\n         // Propagate a trait method's documentation to all implementors of the\n         // trait.\n         if let clean::TraitItem(ref t) = *item.kind {\n-            self.cache.traits.entry(item.item_id.expect_def_id()).or_insert_with(|| {\n-                clean::TraitWithExtraInfo {\n-                    trait_: *t.clone(),\n-                    is_notable: item.attrs.has_doc_flag(sym::notable_trait),\n-                }\n-            });\n+            self.cache.traits.entry(item.item_id.expect_def_id()).or_insert_with(|| (**t).clone());\n         }\n \n         // Collect all the implementors of traits."}, {"sha": "aa9788fad2b6cb643082e7f3f541d7e105c855a5", "filename": "src/librustdoc/html/render/mod.rs", "status": "modified", "additions": 8, "deletions": 3, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/b30c88623cf1f8f3e67b189fb2c5df5a0d89aaed/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b30c88623cf1f8f3e67b189fb2c5df5a0d89aaed/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs?ref=b30c88623cf1f8f3e67b189fb2c5df5a0d89aaed", "patch": "@@ -1294,7 +1294,12 @@ fn notable_traits_decl(decl: &clean::FnDecl, cx: &Context<'_>) -> String {\n                 if let Some(trait_) = &impl_.trait_ {\n                     let trait_did = trait_.def_id();\n \n-                    if cx.cache().traits.get(&trait_did).map_or(false, |t| t.is_notable) {\n+                    if cx\n+                        .cache()\n+                        .traits\n+                        .get(&trait_did)\n+                        .map_or(false, |t| t.is_notable_trait(cx.tcx()))\n+                    {\n                         if out.is_empty() {\n                             write!(\n                                 &mut out,\n@@ -1598,7 +1603,7 @@ fn render_impl(\n             link,\n             render_mode,\n             false,\n-            trait_.map(|t| &t.trait_),\n+            trait_,\n             rendering_params,\n         );\n     }\n@@ -1658,7 +1663,7 @@ fn render_impl(\n                 &mut default_impl_items,\n                 &mut impl_items,\n                 cx,\n-                &t.trait_,\n+                t,\n                 i.inner_impl(),\n                 &i.impl_item,\n                 parent,"}, {"sha": "d13efe6c113beaf4961bceda28f9c8b03fde3f9f", "filename": "src/librustdoc/json/mod.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/b30c88623cf1f8f3e67b189fb2c5df5a0d89aaed/src%2Flibrustdoc%2Fjson%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b30c88623cf1f8f3e67b189fb2c5df5a0d89aaed/src%2Flibrustdoc%2Fjson%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fjson%2Fmod.rs?ref=b30c88623cf1f8f3e67b189fb2c5df5a0d89aaed", "patch": "@@ -108,7 +108,6 @@ impl<'tcx> JsonRenderer<'tcx> {\n             .filter_map(|(&id, trait_item)| {\n                 // only need to synthesize items for external traits\n                 if !id.is_local() {\n-                    let trait_item = &trait_item.trait_;\n                     for item in &trait_item.items {\n                         trace!(\"Adding subitem to {id:?}: {:?}\", item.item_id);\n                         self.item(item.clone()).unwrap();"}, {"sha": "d29ceead4f3a549026a519f8ee83a83695ae6c0b", "filename": "src/librustdoc/visit.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b30c88623cf1f8f3e67b189fb2c5df5a0d89aaed/src%2Flibrustdoc%2Fvisit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b30c88623cf1f8f3e67b189fb2c5df5a0d89aaed/src%2Flibrustdoc%2Fvisit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fvisit.rs?ref=b30c88623cf1f8f3e67b189fb2c5df5a0d89aaed", "patch": "@@ -65,7 +65,7 @@ pub(crate) trait DocVisitor: Sized {\n         // FIXME: make this a simple by-ref for loop once external_traits is cleaned up\n         let external_traits = { std::mem::take(&mut *c.external_traits.borrow_mut()) };\n         for (k, v) in external_traits {\n-            v.trait_.items.iter().for_each(|i| self.visit_item(i));\n+            v.items.iter().for_each(|i| self.visit_item(i));\n             c.external_traits.borrow_mut().insert(k, v);\n         }\n     }"}]}