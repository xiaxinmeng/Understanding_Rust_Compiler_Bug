{"sha": "c318d72b8651e40559c40455475f730cf5f07a1f", "node_id": "MDY6Q29tbWl0NzI0NzEyOmMzMThkNzJiODY1MWU0MDU1OWM0MDQ1NTQ3NWY3MzBjZjVmMDdhMWY=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2014-04-18T17:36:16Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2014-04-18T17:36:16Z"}, "message": "std: Fail more gracefully on thread spawn errors\n\nOn windows, correctly check for errors when spawning threads, and on both\nwindows and unix handle the error more gracefully rather than printing an opaque\nassertion failure.\n\nCloses #13589", "tree": {"sha": "2dde7c982a41872eb865ef794d60966dfb3a4590", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2dde7c982a41872eb865ef794d60966dfb3a4590"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c318d72b8651e40559c40455475f730cf5f07a1f", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c318d72b8651e40559c40455475f730cf5f07a1f", "html_url": "https://github.com/rust-lang/rust/commit/c318d72b8651e40559c40455475f730cf5f07a1f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c318d72b8651e40559c40455475f730cf5f07a1f/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ce2bab68d69ee04e17c0165dbdb7b583d5a7c991", "url": "https://api.github.com/repos/rust-lang/rust/commits/ce2bab68d69ee04e17c0165dbdb7b583d5a7c991", "html_url": "https://github.com/rust-lang/rust/commit/ce2bab68d69ee04e17c0165dbdb7b583d5a7c991"}], "stats": {"total": 21, "additions": 17, "deletions": 4}, "files": [{"sha": "2d952b2a9db17d462a8ff9c1eee58d6fc5a70ed5", "filename": "src/libstd/rt/thread.rs", "status": "modified", "additions": 17, "deletions": 4, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/c318d72b8651e40559c40455475f730cf5f07a1f/src%2Flibstd%2Frt%2Fthread.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c318d72b8651e40559c40455475f730cf5f07a1f/src%2Flibstd%2Frt%2Fthread.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Frt%2Fthread.rs?ref=c318d72b8651e40559c40455475f730cf5f07a1f", "patch": "@@ -150,6 +150,7 @@ mod imp {\n     use libc;\n     use libc::types::os::arch::extra::{LPSECURITY_ATTRIBUTES, SIZE_T, BOOL,\n                                        LPVOID, DWORD, LPDWORD, HANDLE};\n+    use os;\n     use ptr;\n     use rt::stack::RED_ZONE;\n \n@@ -168,8 +169,15 @@ mod imp {\n         // kernel does, might as well make it explicit.  With the current\n         // 20 kB red zone, that makes for a 64 kB minimum stack.\n         let stack_size = (cmp::max(stack, RED_ZONE) + 0xfffe) & (-0xfffe - 1);\n-        CreateThread(ptr::mut_null(), stack_size as libc::size_t,\n-                     super::thread_start, arg, 0, ptr::mut_null())\n+        let ret = CreateThread(ptr::mut_null(), stack_size as libc::size_t,\n+                               super::thread_start, arg, 0, ptr::mut_null());\n+\n+        if ret as uint == 0 {\n+            // be sure to not leak the closure\n+            let _p: ~proc():Send = cast::transmute(arg);\n+            fail!(\"failed to spawn native thread: {}\", os::last_os_error());\n+        }\n+        return ret;\n     }\n \n     pub unsafe fn join(native: rust_thread) {\n@@ -243,9 +251,14 @@ mod imp {\n         };\n \n         let arg: *libc::c_void = cast::transmute(p);\n-        assert_eq!(pthread_create(&mut native, &attr,\n-                                  super::thread_start, arg), 0);\n+        let ret = pthread_create(&mut native, &attr, super::thread_start, arg);\n         assert_eq!(pthread_attr_destroy(&mut attr), 0);\n+\n+        if ret != 0 {\n+            // be sure to not leak the closure\n+            let _p: ~proc():Send = cast::transmute(arg);\n+            fail!(\"failed to spawn native thread: {}\", os::last_os_error());\n+        }\n         native\n     }\n "}]}