{"sha": "96c93036af139380d8ba10087cecc79aca0fb005", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk2YzkzMDM2YWYxMzkzODBkOGJhMTAwODdjZWNjNzlhY2EwZmIwMDU=", "commit": {"author": {"name": "Oliver Schneider", "email": "oli-obk@users.noreply.github.com", "date": "2017-02-17T12:40:05Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2017-02-17T12:40:05Z"}, "message": "Merge pull request #1549 from Manishearth/never_loop\n\nNew never loop lint", "tree": {"sha": "26839318413708c3ef6ced88022cdd2d33ef0e31", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/26839318413708c3ef6ced88022cdd2d33ef0e31"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/96c93036af139380d8ba10087cecc79aca0fb005", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/96c93036af139380d8ba10087cecc79aca0fb005", "html_url": "https://github.com/rust-lang/rust/commit/96c93036af139380d8ba10087cecc79aca0fb005", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/96c93036af139380d8ba10087cecc79aca0fb005/comments", "author": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "51931c70b35a75c3e9cee9191daa4d0f601a0422", "url": "https://api.github.com/repos/rust-lang/rust/commits/51931c70b35a75c3e9cee9191daa4d0f601a0422", "html_url": "https://github.com/rust-lang/rust/commit/51931c70b35a75c3e9cee9191daa4d0f601a0422"}, {"sha": "6c8a6c18ab3639c9f33bbc2fa39eaef97e6c6aac", "url": "https://api.github.com/repos/rust-lang/rust/commits/6c8a6c18ab3639c9f33bbc2fa39eaef97e6c6aac", "html_url": "https://github.com/rust-lang/rust/commit/6c8a6c18ab3639c9f33bbc2fa39eaef97e6c6aac"}], "stats": {"total": 153, "additions": 149, "deletions": 4}, "files": [{"sha": "90f67e8aec73def059337f6306d712d424a5aa46", "filename": "CHANGELOG.md", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/96c93036af139380d8ba10087cecc79aca0fb005/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/96c93036af139380d8ba10087cecc79aca0fb005/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=96c93036af139380d8ba10087cecc79aca0fb005", "patch": "@@ -1,6 +1,7 @@\n # Change Log\n All notable changes to this project will be documented in this file.\n \n+* New [`never_loop`] lint\n * New [`mut_from_ref`] lint\n \n ## 0.0.114 \u2014 2017-02-08\n@@ -384,6 +385,7 @@ All notable changes to this project will be documented in this file.\n [`needless_return`]: https://github.com/Manishearth/rust-clippy/wiki#needless_return\n [`needless_update`]: https://github.com/Manishearth/rust-clippy/wiki#needless_update\n [`neg_multiply`]: https://github.com/Manishearth/rust-clippy/wiki#neg_multiply\n+[`never_loop`]: https://github.com/Manishearth/rust-clippy/wiki#never_loop\n [`new_ret_no_self`]: https://github.com/Manishearth/rust-clippy/wiki#new_ret_no_self\n [`new_without_default`]: https://github.com/Manishearth/rust-clippy/wiki#new_without_default\n [`new_without_default_derive`]: https://github.com/Manishearth/rust-clippy/wiki#new_without_default_derive"}, {"sha": "9e4b9fba1b6319d29aa1a44fe05cddd9a3228e5d", "filename": "README.md", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/96c93036af139380d8ba10087cecc79aca0fb005/README.md", "raw_url": "https://github.com/rust-lang/rust/raw/96c93036af139380d8ba10087cecc79aca0fb005/README.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/README.md?ref=96c93036af139380d8ba10087cecc79aca0fb005", "patch": "@@ -180,7 +180,7 @@ transparently:\n \n ## Lints\n \n-There are 189 lints included in this crate:\n+There are 190 lints included in this crate:\n \n name                                                                                                                   | default | triggers on\n -----------------------------------------------------------------------------------------------------------------------|---------|----------------------------------------------------------------------------------------------------------------------------------\n@@ -291,6 +291,7 @@ name\n [needless_return](https://github.com/Manishearth/rust-clippy/wiki#needless_return)                                     | warn    | using a return statement like `return expr;` where an expression would suffice\n [needless_update](https://github.com/Manishearth/rust-clippy/wiki#needless_update)                                     | warn    | using `Foo { ..base }` when there are no missing fields\n [neg_multiply](https://github.com/Manishearth/rust-clippy/wiki#neg_multiply)                                           | warn    | multiplying integers with -1\n+[never_loop](https://github.com/Manishearth/rust-clippy/wiki#never_loop)                                               | warn    | any loop with an unconditional `break` statement\n [new_ret_no_self](https://github.com/Manishearth/rust-clippy/wiki#new_ret_no_self)                                     | warn    | not returning `Self` in a `new` method\n [new_without_default](https://github.com/Manishearth/rust-clippy/wiki#new_without_default)                             | warn    | `fn new() -> Self` method without `Default` implementation\n [new_without_default_derive](https://github.com/Manishearth/rust-clippy/wiki#new_without_default_derive)               | warn    | `fn new() -> Self` without `#[derive]`able `Default` implementation"}, {"sha": "13ad8b41f963978cd93bfb27720e7696fab38043", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/96c93036af139380d8ba10087cecc79aca0fb005/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/96c93036af139380d8ba10087cecc79aca0fb005/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=96c93036af139380d8ba10087cecc79aca0fb005", "patch": "@@ -405,6 +405,7 @@ pub fn register_plugins(reg: &mut rustc_plugin::Registry) {\n         loops::FOR_LOOP_OVER_RESULT,\n         loops::ITER_NEXT_LOOP,\n         loops::NEEDLESS_RANGE_LOOP,\n+        loops::NEVER_LOOP,\n         loops::REVERSE_RANGE_LOOP,\n         loops::UNUSED_COLLECT,\n         loops::WHILE_LET_LOOP,"}, {"sha": "d7f952255fe283d4273ab0f15c8496a5974b0480", "filename": "clippy_lints/src/loops.rs", "status": "modified", "additions": 67, "deletions": 1, "changes": 68, "blob_url": "https://github.com/rust-lang/rust/blob/96c93036af139380d8ba10087cecc79aca0fb005/clippy_lints%2Fsrc%2Floops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/96c93036af139380d8ba10087cecc79aca0fb005/clippy_lints%2Fsrc%2Floops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Floops.rs?ref=96c93036af139380d8ba10087cecc79aca0fb005", "patch": "@@ -286,6 +286,23 @@ declare_lint! {\n     \"looping on a map using `iter` when `keys` or `values` would do\"\n }\n \n+/// **What it does:** Checks for loops that contain an unconditional `break`.\n+///\n+/// **Why is this bad?** This loop never loops, all it does is obfuscating the\n+/// code.\n+///\n+/// **Known problems:** None.\n+///\n+/// **Example:**\n+/// ```rust\n+/// loop { ..; break; }\n+/// ```\n+declare_lint! {\n+    pub NEVER_LOOP,\n+    Warn,\n+    \"any loop with an unconditional `break` statement\"\n+}\n+\n #[derive(Copy, Clone)]\n pub struct Pass;\n \n@@ -303,7 +320,8 @@ impl LintPass for Pass {\n                     EXPLICIT_COUNTER_LOOP,\n                     EMPTY_LOOP,\n                     WHILE_LET_ON_ITERATOR,\n-                    FOR_KV_MAP)\n+                    FOR_KV_MAP,\n+                    NEVER_LOOP)\n     }\n }\n \n@@ -324,6 +342,9 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for Pass {\n                           \"empty `loop {}` detected. You may want to either use `panic!()` or add \\\n                            `std::thread::sleep(..);` to the loop body.\");\n             }\n+            if never_loop_block(block) {\n+                span_lint(cx, NEVER_LOOP, expr.span, \"this loop never actually loops\");\n+            }\n \n             // extract the expression from the first statement (if any) in a block\n             let inner_stmt_expr = extract_expr_from_first_stmt(block);\n@@ -402,6 +423,51 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for Pass {\n     }\n }\n \n+fn never_loop_block(block: &Block) -> bool {\n+    block.stmts.iter().any(never_loop_stmt) || block.expr.as_ref().map_or(false, |e| never_loop_expr(e))\n+}\n+\n+fn never_loop_stmt(stmt: &Stmt) -> bool {\n+    match stmt.node {\n+        StmtSemi(ref e, _) |\n+        StmtExpr(ref e, _) => never_loop_expr(e),\n+        StmtDecl(ref d, _) => never_loop_decl(d),\n+    }\n+}\n+\n+fn never_loop_decl(decl: &Decl) -> bool {\n+    if let DeclLocal(ref local) = decl.node {\n+        local.init.as_ref().map_or(false, |e| never_loop_expr(e))\n+    } else {\n+        false\n+    }\n+}\n+\n+fn never_loop_expr(expr: &Expr) -> bool {\n+    match expr.node {\n+        ExprBreak(..) | ExprRet(..) => true,\n+        ExprBox(ref e) |\n+        ExprUnary(_, ref e) |\n+        ExprBinary(_, ref e, _) | // because short-circuiting\n+        ExprCast(ref e, _) |\n+        ExprType(ref e, _) |\n+        ExprField(ref e, _) |\n+        ExprTupField(ref e, _) |\n+        ExprRepeat(ref e, _) |\n+        ExprAddrOf(_, ref e) => never_loop_expr(e),\n+        ExprAssign(ref e1, ref e2) |\n+        ExprAssignOp(_, ref e1, ref e2) |\n+        ExprIndex(ref e1, ref e2) => never_loop_expr(e1) || never_loop_expr(e2),\n+        ExprArray(ref es) |\n+        ExprTup(ref es) |\n+        ExprMethodCall(_, _, ref es) => es.iter().any(|e| never_loop_expr(e)),\n+        ExprCall(ref e, ref es) => never_loop_expr(e) || es.iter().any(|e| never_loop_expr(e)),\n+        ExprBlock(ref block) => never_loop_block(block),\n+        ExprStruct(_, _, ref base) => base.as_ref().map_or(false, |e| never_loop_expr(e)),\n+        _ => false,\n+    }\n+}\n+\n fn check_for_loop<'a, 'tcx>(\n     cx: &LateContext<'a, 'tcx>,\n     pat: &'tcx Pat,"}, {"sha": "087f1a1e6af3c32e3137c1bcf14b80b9b637948f", "filename": "tests/ui/never_loop.rs", "status": "added", "additions": 34, "deletions": 0, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/96c93036af139380d8ba10087cecc79aca0fb005/tests%2Fui%2Fnever_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/96c93036af139380d8ba10087cecc79aca0fb005/tests%2Fui%2Fnever_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fnever_loop.rs?ref=96c93036af139380d8ba10087cecc79aca0fb005", "patch": "@@ -0,0 +1,34 @@\n+#![feature(plugin)]\n+#![plugin(clippy)]\n+\n+#![deny(never_loop)]\n+#![allow(dead_code, unused)]\n+\n+fn main() {\n+    loop {\n+        println!(\"This is only ever printed once\");\n+        break;\n+    }\n+\n+    let x = 1;\n+    loop {\n+        println!(\"This, too\"); // but that's OK\n+        if x == 1 {\n+            break;\n+        }\n+    }\n+\n+    loop {\n+        loop {\n+            // another one\n+            break;\n+        }\n+        break;\n+    }\n+\n+    loop {\n+        loop {\n+            if x == 1 { return; }\n+        }\n+    }\n+}"}, {"sha": "ebb98a6cf1461e226a13c4d2b1c32729cb52e098", "filename": "tests/ui/never_loop.stderr", "status": "added", "additions": 41, "deletions": 0, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/96c93036af139380d8ba10087cecc79aca0fb005/tests%2Fui%2Fnever_loop.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/96c93036af139380d8ba10087cecc79aca0fb005/tests%2Fui%2Fnever_loop.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fnever_loop.stderr?ref=96c93036af139380d8ba10087cecc79aca0fb005", "patch": "@@ -0,0 +1,41 @@\n+error: this loop never actually loops\n+  --> $DIR/never_loop.rs:8:5\n+   |\n+8  |       loop {\n+   |  _____^ starting here...\n+9  | |         println!(\"This is only ever printed once\");\n+10 | |         break;\n+11 | |     }\n+   | |_____^ ...ending here\n+   |\n+note: lint level defined here\n+  --> $DIR/never_loop.rs:4:9\n+   |\n+4  | #![deny(never_loop)]\n+   |         ^^^^^^^^^^\n+\n+error: this loop never actually loops\n+  --> $DIR/never_loop.rs:21:5\n+   |\n+21 |       loop {\n+   |  _____^ starting here...\n+22 | |         loop {\n+23 | |             // another one\n+24 | |             break;\n+25 | |         }\n+26 | |         break;\n+27 | |     }\n+   | |_____^ ...ending here\n+\n+error: this loop never actually loops\n+  --> $DIR/never_loop.rs:22:9\n+   |\n+22 |           loop {\n+   |  _________^ starting here...\n+23 | |             // another one\n+24 | |             break;\n+25 | |         }\n+   | |_________^ ...ending here\n+\n+error: aborting due to 3 previous errors\n+"}, {"sha": "1eb067e9684d502fe8b61e1f61f6f1f3118e02e8", "filename": "tests/ui/unused_labels.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/96c93036af139380d8ba10087cecc79aca0fb005/tests%2Fui%2Funused_labels.rs", "raw_url": "https://github.com/rust-lang/rust/raw/96c93036af139380d8ba10087cecc79aca0fb005/tests%2Fui%2Funused_labels.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Funused_labels.rs?ref=96c93036af139380d8ba10087cecc79aca0fb005", "patch": "@@ -1,7 +1,7 @@\n #![plugin(clippy)]\n #![feature(plugin)]\n \n-#![allow(dead_code, items_after_statements)]\n+#![allow(dead_code, items_after_statements, never_loop)]\n #![deny(unused_label)]\n \n fn unused_label() {"}, {"sha": "253aebe4444347ab7d2b2aa7724d5a1d8aa0b586", "filename": "tests/ui/while_loop.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/96c93036af139380d8ba10087cecc79aca0fb005/tests%2Fui%2Fwhile_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/96c93036af139380d8ba10087cecc79aca0fb005/tests%2Fui%2Fwhile_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fwhile_loop.rs?ref=96c93036af139380d8ba10087cecc79aca0fb005", "patch": "@@ -2,7 +2,7 @@\n #![plugin(clippy)]\n \n #![deny(while_let_loop, empty_loop, while_let_on_iterator)]\n-#![allow(dead_code, unused, cyclomatic_complexity)]\n+#![allow(dead_code, never_loop, unused, cyclomatic_complexity)]\n \n fn main() {\n     let y = Some(true);"}]}