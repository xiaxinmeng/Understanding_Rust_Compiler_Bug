{"sha": "963305bda8723a461afe37ddb7fc6da9f56bf100", "node_id": "C_kwDOAAsO6NoAKDk2MzMwNWJkYTg3MjNhNDYxYWZlMzdkZGI3ZmM2ZGE5ZjU2YmYxMDA", "commit": {"author": {"name": "L\u00e9o Lanteri Thauvin", "email": "leseulartichaut@gmail.com", "date": "2023-03-02T13:26:12Z"}, "committer": {"name": "L\u00e9o Lanteri Thauvin", "email": "leseulartichaut@gmail.com", "date": "2023-03-12T13:57:38Z"}, "message": "Forbid the use of `#[target_feature]` on `start`", "tree": {"sha": "b0b84f5a2497868a154ebc2ed8892eb53cced116", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b0b84f5a2497868a154ebc2ed8892eb53cced116"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/963305bda8723a461afe37ddb7fc6da9f56bf100", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/963305bda8723a461afe37ddb7fc6da9f56bf100", "html_url": "https://github.com/rust-lang/rust/commit/963305bda8723a461afe37ddb7fc6da9f56bf100", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/963305bda8723a461afe37ddb7fc6da9f56bf100/comments", "author": {"login": "LeSeulArtichaut", "id": 38361244, "node_id": "MDQ6VXNlcjM4MzYxMjQ0", "avatar_url": "https://avatars.githubusercontent.com/u/38361244?v=4", "gravatar_id": "", "url": "https://api.github.com/users/LeSeulArtichaut", "html_url": "https://github.com/LeSeulArtichaut", "followers_url": "https://api.github.com/users/LeSeulArtichaut/followers", "following_url": "https://api.github.com/users/LeSeulArtichaut/following{/other_user}", "gists_url": "https://api.github.com/users/LeSeulArtichaut/gists{/gist_id}", "starred_url": "https://api.github.com/users/LeSeulArtichaut/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/LeSeulArtichaut/subscriptions", "organizations_url": "https://api.github.com/users/LeSeulArtichaut/orgs", "repos_url": "https://api.github.com/users/LeSeulArtichaut/repos", "events_url": "https://api.github.com/users/LeSeulArtichaut/events{/privacy}", "received_events_url": "https://api.github.com/users/LeSeulArtichaut/received_events", "type": "User", "site_admin": false}, "committer": {"login": "LeSeulArtichaut", "id": 38361244, "node_id": "MDQ6VXNlcjM4MzYxMjQ0", "avatar_url": "https://avatars.githubusercontent.com/u/38361244?v=4", "gravatar_id": "", "url": "https://api.github.com/users/LeSeulArtichaut", "html_url": "https://github.com/LeSeulArtichaut", "followers_url": "https://api.github.com/users/LeSeulArtichaut/followers", "following_url": "https://api.github.com/users/LeSeulArtichaut/following{/other_user}", "gists_url": "https://api.github.com/users/LeSeulArtichaut/gists{/gist_id}", "starred_url": "https://api.github.com/users/LeSeulArtichaut/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/LeSeulArtichaut/subscriptions", "organizations_url": "https://api.github.com/users/LeSeulArtichaut/orgs", "repos_url": "https://api.github.com/users/LeSeulArtichaut/repos", "events_url": "https://api.github.com/users/LeSeulArtichaut/events{/privacy}", "received_events_url": "https://api.github.com/users/LeSeulArtichaut/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "db266939822a5a89473871abff6beea39b083af6", "url": "https://api.github.com/repos/rust-lang/rust/commits/db266939822a5a89473871abff6beea39b083af6", "html_url": "https://github.com/rust-lang/rust/commit/db266939822a5a89473871abff6beea39b083af6"}], "stats": {"total": 39, "additions": 39, "deletions": 0}, "files": [{"sha": "0105cbf36dee2459d8b761e0ae0f871e4424249e", "filename": "compiler/rustc_hir_analysis/messages.ftl", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/963305bda8723a461afe37ddb7fc6da9f56bf100/compiler%2Frustc_hir_analysis%2Fmessages.ftl", "raw_url": "https://github.com/rust-lang/rust/raw/963305bda8723a461afe37ddb7fc6da9f56bf100/compiler%2Frustc_hir_analysis%2Fmessages.ftl", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_analysis%2Fmessages.ftl?ref=963305bda8723a461afe37ddb7fc6da9f56bf100", "patch": "@@ -133,6 +133,9 @@ hir_analysis_target_feature_on_main = `main` function is not allowed to have `#[\n hir_analysis_start_not_track_caller = `start` is not allowed to be `#[track_caller]`\n     .label = `start` is not allowed to be `#[track_caller]`\n \n+hir_analysis_start_not_target_feature = `start` is not allowed to have `#[target_feature]`\n+    .label = `start` is not allowed to have `#[target_feature]`\n+\n hir_analysis_start_not_async = `start` is not allowed to be `async`\n     .label = `start` is not allowed to be `async`\n "}, {"sha": "f57197edeb74dd377bfff053220be6484a593977", "filename": "compiler/rustc_hir_analysis/src/errors.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/963305bda8723a461afe37ddb7fc6da9f56bf100/compiler%2Frustc_hir_analysis%2Fsrc%2Ferrors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/963305bda8723a461afe37ddb7fc6da9f56bf100/compiler%2Frustc_hir_analysis%2Fsrc%2Ferrors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_analysis%2Fsrc%2Ferrors.rs?ref=963305bda8723a461afe37ddb7fc6da9f56bf100", "patch": "@@ -344,6 +344,15 @@ pub(crate) struct StartTrackCaller {\n     pub start: Span,\n }\n \n+#[derive(Diagnostic)]\n+#[diag(hir_analysis_start_not_target_feature)]\n+pub(crate) struct StartTargetFeature {\n+    #[primary_span]\n+    pub span: Span,\n+    #[label]\n+    pub start: Span,\n+}\n+\n #[derive(Diagnostic)]\n #[diag(hir_analysis_start_not_async, code = \"E0752\")]\n pub(crate) struct StartAsync {"}, {"sha": "be07bb4584605e28faf5044c1d9e5b81aa81f698", "filename": "compiler/rustc_hir_analysis/src/lib.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/963305bda8723a461afe37ddb7fc6da9f56bf100/compiler%2Frustc_hir_analysis%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/963305bda8723a461afe37ddb7fc6da9f56bf100/compiler%2Frustc_hir_analysis%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_analysis%2Fsrc%2Flib.rs?ref=963305bda8723a461afe37ddb7fc6da9f56bf100", "patch": "@@ -378,6 +378,13 @@ fn check_start_fn_ty(tcx: TyCtxt<'_>, start_def_id: DefId) {\n                             });\n                             error = true;\n                         }\n+                        if attr.has_name(sym::target_feature) {\n+                            tcx.sess.emit_err(errors::StartTargetFeature {\n+                                span: attr.span,\n+                                start: start_span,\n+                            });\n+                            error = true;\n+                        }\n                     }\n \n                     if error {"}, {"sha": "50e8ce2fdd5ed6a12aad0ed940fdbea06c625521", "filename": "tests/ui/rfcs/rfc-2396-target_feature-11/issue-108645-target-feature-on-start.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/963305bda8723a461afe37ddb7fc6da9f56bf100/tests%2Fui%2Frfcs%2Frfc-2396-target_feature-11%2Fissue-108645-target-feature-on-start.rs", "raw_url": "https://github.com/rust-lang/rust/raw/963305bda8723a461afe37ddb7fc6da9f56bf100/tests%2Fui%2Frfcs%2Frfc-2396-target_feature-11%2Fissue-108645-target-feature-on-start.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Frfcs%2Frfc-2396-target_feature-11%2Fissue-108645-target-feature-on-start.rs?ref=963305bda8723a461afe37ddb7fc6da9f56bf100", "patch": "@@ -0,0 +1,9 @@\n+// only-x86_64\n+\n+#![feature(start)]\n+#![feature(target_feature_11)]\n+\n+#[start]\n+#[target_feature(enable = \"avx2\")]\n+//~^ ERROR `start` is not allowed to have `#[target_feature]`\n+fn start(_argc: isize, _argv: *const *const u8) -> isize { 0 }"}, {"sha": "07687f3c7f4a2f03adc543fd3495342a79ee5555", "filename": "tests/ui/rfcs/rfc-2396-target_feature-11/issue-108645-target-feature-on-start.stderr", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/963305bda8723a461afe37ddb7fc6da9f56bf100/tests%2Fui%2Frfcs%2Frfc-2396-target_feature-11%2Fissue-108645-target-feature-on-start.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/963305bda8723a461afe37ddb7fc6da9f56bf100/tests%2Fui%2Frfcs%2Frfc-2396-target_feature-11%2Fissue-108645-target-feature-on-start.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Frfcs%2Frfc-2396-target_feature-11%2Fissue-108645-target-feature-on-start.stderr?ref=963305bda8723a461afe37ddb7fc6da9f56bf100", "patch": "@@ -0,0 +1,11 @@\n+error: `start` is not allowed to have `#[target_feature]`\n+  --> $DIR/issue-108645-target-feature-on-start.rs:7:1\n+   |\n+LL | #[target_feature(enable = \"avx2\")]\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+LL |\n+LL | fn start(_argc: isize, _argv: *const *const u8) -> isize { 0 }\n+   | -------------------------------------------------------- `start` is not allowed to have `#[target_feature]`\n+\n+error: aborting due to previous error\n+"}]}