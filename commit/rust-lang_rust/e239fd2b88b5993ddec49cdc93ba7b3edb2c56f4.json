{"sha": "e239fd2b88b5993ddec49cdc93ba7b3edb2c56f4", "node_id": "C_kwDOAAsO6NoAKGUyMzlmZDJiODhiNTk5M2RkZWM0OWNkYzkzYmE3YjNlZGIyYzU2ZjQ", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2022-05-14T04:42:55Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-05-14T04:42:55Z"}, "message": "Rollup merge of #97031 - eholk:drop-tracking-type-error, r=compiler-errors\n\nDrop tracking: handle invalid assignments better\n\nPreviously this test case was crashing with an index out of bounds error deep in the call to `needs_drop`. We avoid this by detecting clearly invalid assignees in the `mutate` callback and ignoring these.", "tree": {"sha": "141881e84d4465db2ce36b1081a02c60ca3ccf68", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/141881e84d4465db2ce36b1081a02c60ca3ccf68"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e239fd2b88b5993ddec49cdc93ba7b3edb2c56f4", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJifzNPCRBK7hj4Ov3rIwAA8JcIADa8XOjrpaXdFd9cOTnAlyCA\nbCU8eKHYZpWPadCDyQ3PpTlCYr1bSxRyhCJCsY1RPGMDy6DH0bOJoSuemTvWiiqG\nt/EPa8TVBnFH4zOXsWGvcreLpil6KSuwZKFEYuQPOuHyaOIfRay/lj6KQyZMmaf5\nFYPbQ/5Vh7q7AmqOn2u4hMr8UhVWsbPSjg2MbB0yZFLfJwy8kGjzXdUhPiP34D9p\nEa+wutYjC3JMVxAC+u05bypT3Wt9f0xE5XD60Ex/O0Fmy76KrURqar8hTKc62pls\nWjiEI/qgagmIBZDcfa9rGNqPPH8Uc5FyEOxo8FLpgxMby5Kj/pvrQZ+F/125ay4=\n=KI5Y\n-----END PGP SIGNATURE-----\n", "payload": "tree 141881e84d4465db2ce36b1081a02c60ca3ccf68\nparent ec14d946ae0bfffebf15aa2b53504debfedfcb39\nparent 6665a4328b4076285e4c233995b5a08aeff4b603\nauthor Yuki Okushi <jtitor@2k36.org> 1652503375 +0900\ncommitter GitHub <noreply@github.com> 1652503375 +0900\n\nRollup merge of #97031 - eholk:drop-tracking-type-error, r=compiler-errors\n\nDrop tracking: handle invalid assignments better\n\nPreviously this test case was crashing with an index out of bounds error deep in the call to `needs_drop`. We avoid this by detecting clearly invalid assignees in the `mutate` callback and ignoring these.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e239fd2b88b5993ddec49cdc93ba7b3edb2c56f4", "html_url": "https://github.com/rust-lang/rust/commit/e239fd2b88b5993ddec49cdc93ba7b3edb2c56f4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e239fd2b88b5993ddec49cdc93ba7b3edb2c56f4/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ec14d946ae0bfffebf15aa2b53504debfedfcb39", "url": "https://api.github.com/repos/rust-lang/rust/commits/ec14d946ae0bfffebf15aa2b53504debfedfcb39", "html_url": "https://github.com/rust-lang/rust/commit/ec14d946ae0bfffebf15aa2b53504debfedfcb39"}, {"sha": "6665a4328b4076285e4c233995b5a08aeff4b603", "url": "https://api.github.com/repos/rust-lang/rust/commits/6665a4328b4076285e4c233995b5a08aeff4b603", "html_url": "https://github.com/rust-lang/rust/commit/6665a4328b4076285e4c233995b5a08aeff4b603"}], "stats": {"total": 34, "additions": 34, "deletions": 0}, "files": [{"sha": "e89a8961996158f24c2eb9517ac1f52dd90c8239", "filename": "compiler/rustc_typeck/src/check/generator_interior/drop_ranges/record_consumed_borrow.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/e239fd2b88b5993ddec49cdc93ba7b3edb2c56f4/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fgenerator_interior%2Fdrop_ranges%2Frecord_consumed_borrow.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e239fd2b88b5993ddec49cdc93ba7b3edb2c56f4/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fgenerator_interior%2Fdrop_ranges%2Frecord_consumed_borrow.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fgenerator_interior%2Fdrop_ranges%2Frecord_consumed_borrow.rs?ref=e239fd2b88b5993ddec49cdc93ba7b3edb2c56f4", "patch": "@@ -180,6 +180,15 @@ impl<'tcx> expr_use_visitor::Delegate<'tcx> for ExprUseDelegate<'tcx> {\n         diag_expr_id: HirId,\n     ) {\n         debug!(\"mutate {assignee_place:?}; diag_expr_id={diag_expr_id:?}\");\n+\n+        if assignee_place.place.base == PlaceBase::Rvalue\n+            && assignee_place.place.projections.is_empty()\n+        {\n+            // Assigning to an Rvalue is illegal unless done through a dereference. We would have\n+            // already gotten a type error, so we will just return here.\n+            return;\n+        }\n+\n         // If the type being assigned needs dropped, then the mutation counts as a borrow\n         // since it is essentially doing `Drop::drop(&mut x); x = new_value;`.\n         if assignee_place.place.base_ty.needs_drop(self.tcx, self.param_env) {"}, {"sha": "c3423ad629f166f60b14f4a00d28aab4f04eeb7b", "filename": "src/test/ui/async-await/issue-73741-type-err-drop-tracking.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/e239fd2b88b5993ddec49cdc93ba7b3edb2c56f4/src%2Ftest%2Fui%2Fasync-await%2Fissue-73741-type-err-drop-tracking.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e239fd2b88b5993ddec49cdc93ba7b3edb2c56f4/src%2Ftest%2Fui%2Fasync-await%2Fissue-73741-type-err-drop-tracking.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fissue-73741-type-err-drop-tracking.rs?ref=e239fd2b88b5993ddec49cdc93ba7b3edb2c56f4", "patch": "@@ -0,0 +1,14 @@\n+// edition:2018\n+// compile-flags: -Zdrop-tracking\n+// Regression test for issue #73741\n+// Ensures that we don't emit spurious errors when\n+// a type error ocurrs in an `async fn`\n+\n+async fn weird() {\n+    1 = 2; //~ ERROR invalid left-hand side\n+\n+    let mut loop_count = 0;\n+    async {}.await\n+}\n+\n+fn main() {}"}, {"sha": "d4e3b6c3bf40dabbf30f22200a29cc2578dbd4d5", "filename": "src/test/ui/async-await/issue-73741-type-err-drop-tracking.stderr", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/e239fd2b88b5993ddec49cdc93ba7b3edb2c56f4/src%2Ftest%2Fui%2Fasync-await%2Fissue-73741-type-err-drop-tracking.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e239fd2b88b5993ddec49cdc93ba7b3edb2c56f4/src%2Ftest%2Fui%2Fasync-await%2Fissue-73741-type-err-drop-tracking.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fissue-73741-type-err-drop-tracking.stderr?ref=e239fd2b88b5993ddec49cdc93ba7b3edb2c56f4", "patch": "@@ -0,0 +1,11 @@\n+error[E0070]: invalid left-hand side of assignment\n+  --> $DIR/issue-73741-type-err-drop-tracking.rs:8:7\n+   |\n+LL |     1 = 2;\n+   |     - ^\n+   |     |\n+   |     cannot assign to this expression\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0070`."}]}