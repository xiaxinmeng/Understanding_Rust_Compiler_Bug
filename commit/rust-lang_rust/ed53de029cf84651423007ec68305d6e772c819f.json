{"sha": "ed53de029cf84651423007ec68305d6e772c819f", "node_id": "MDY6Q29tbWl0NzI0NzEyOmVkNTNkZTAyOWNmODQ2NTE0MjMwMDdlYzY4MzA1ZDZlNzcyYzgxOWY=", "commit": {"author": {"name": "Dennis Hamester", "email": "dennis.hamester@gmail.com", "date": "2020-07-11T17:39:02Z"}, "committer": {"name": "Dennis Hamester", "email": "dennis.hamester@gmail.com", "date": "2020-07-22T19:36:30Z"}, "message": "rustdoc: Always warn when linking from public to private items\n\nChange the logic such that linking from a public to a private item always\ntriggers intra_doc_link_resolution_failure. Previously, the warning was\nnot emitted when --document-private-items is passed.\n\nAlso don't rely anymore on the item's visibility, which would falsely trigger\nthe lint now that the check for --document-private-items is gone.", "tree": {"sha": "cdb40eb0a80b7103912e61bfeb89cf298c3c9a6c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cdb40eb0a80b7103912e61bfeb89cf298c3c9a6c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ed53de029cf84651423007ec68305d6e772c819f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ed53de029cf84651423007ec68305d6e772c819f", "html_url": "https://github.com/rust-lang/rust/commit/ed53de029cf84651423007ec68305d6e772c819f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ed53de029cf84651423007ec68305d6e772c819f/comments", "author": {"login": "dennis-hamester", "id": 2039492, "node_id": "MDQ6VXNlcjIwMzk0OTI=", "avatar_url": "https://avatars.githubusercontent.com/u/2039492?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dennis-hamester", "html_url": "https://github.com/dennis-hamester", "followers_url": "https://api.github.com/users/dennis-hamester/followers", "following_url": "https://api.github.com/users/dennis-hamester/following{/other_user}", "gists_url": "https://api.github.com/users/dennis-hamester/gists{/gist_id}", "starred_url": "https://api.github.com/users/dennis-hamester/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dennis-hamester/subscriptions", "organizations_url": "https://api.github.com/users/dennis-hamester/orgs", "repos_url": "https://api.github.com/users/dennis-hamester/repos", "events_url": "https://api.github.com/users/dennis-hamester/events{/privacy}", "received_events_url": "https://api.github.com/users/dennis-hamester/received_events", "type": "User", "site_admin": false}, "committer": {"login": "dennis-hamester", "id": 2039492, "node_id": "MDQ6VXNlcjIwMzk0OTI=", "avatar_url": "https://avatars.githubusercontent.com/u/2039492?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dennis-hamester", "html_url": "https://github.com/dennis-hamester", "followers_url": "https://api.github.com/users/dennis-hamester/followers", "following_url": "https://api.github.com/users/dennis-hamester/following{/other_user}", "gists_url": "https://api.github.com/users/dennis-hamester/gists{/gist_id}", "starred_url": "https://api.github.com/users/dennis-hamester/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dennis-hamester/subscriptions", "organizations_url": "https://api.github.com/users/dennis-hamester/orgs", "repos_url": "https://api.github.com/users/dennis-hamester/repos", "events_url": "https://api.github.com/users/dennis-hamester/events{/privacy}", "received_events_url": "https://api.github.com/users/dennis-hamester/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9e92106d457abd14f82adc29e7f2496861e07916", "url": "https://api.github.com/repos/rust-lang/rust/commits/9e92106d457abd14f82adc29e7f2496861e07916", "html_url": "https://github.com/rust-lang/rust/commit/9e92106d457abd14f82adc29e7f2496861e07916"}], "stats": {"total": 46, "additions": 36, "deletions": 10}, "files": [{"sha": "8e113cfa563c8010ed8e3fe18bb58e386d7fc230", "filename": "src/librustdoc/passes/collect_intra_doc_links.rs", "status": "modified", "additions": 12, "deletions": 5, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/ed53de029cf84651423007ec68305d6e772c819f/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ed53de029cf84651423007ec68305d6e772c819f/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs?ref=ed53de029cf84651423007ec68305d6e772c819f", "patch": "@@ -790,13 +790,20 @@ impl<'a, 'tcx> DocFolder for LinkCollector<'a, 'tcx> {\n                 item.attrs.links.push((ori_link, None, fragment));\n             } else {\n                 debug!(\"intra-doc link to {} resolved to {:?}\", path_str, res);\n-                if let Some(local) = res.opt_def_id().and_then(|def_id| def_id.as_local()) {\n+\n+                // item can be non-local e.g. when using #[doc(primitive = \"pointer\")]\n+                if let Some((src_id, dst_id)) = res\n+                    .opt_def_id()\n+                    .and_then(|def_id| def_id.as_local())\n+                    .and_then(|dst_id| item.def_id.as_local().map(|src_id| (src_id, dst_id)))\n+                {\n                     use rustc_hir::def_id::LOCAL_CRATE;\n \n-                    let hir_id = self.cx.tcx.hir().as_local_hir_id(local);\n-                    if !self.cx.tcx.privacy_access_levels(LOCAL_CRATE).is_exported(hir_id)\n-                        && (item.visibility == Visibility::Public)\n-                        && !self.cx.render_options.document_private\n+                    let hir_src = self.cx.tcx.hir().as_local_hir_id(src_id);\n+                    let hir_dst = self.cx.tcx.hir().as_local_hir_id(dst_id);\n+\n+                    if self.cx.tcx.privacy_access_levels(LOCAL_CRATE).is_exported(hir_src)\n+                        && !self.cx.tcx.privacy_access_levels(LOCAL_CRATE).is_exported(hir_dst)\n                     {\n                         privacy_error(cx, &item, &path_str, &dox, link_range);\n                         continue;"}, {"sha": "6a23afb0798a9307d19ab1aeda285702be8883bf", "filename": "src/test/rustdoc-ui/intra-links-private.private.stderr", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/ed53de029cf84651423007ec68305d6e772c819f/src%2Ftest%2Frustdoc-ui%2Fintra-links-private.private.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/ed53de029cf84651423007ec68305d6e772c819f/src%2Ftest%2Frustdoc-ui%2Fintra-links-private.private.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fintra-links-private.private.stderr?ref=ed53de029cf84651423007ec68305d6e772c819f", "patch": "@@ -0,0 +1,10 @@\n+warning: public documentation for `DocMe` links to private item `DontDocMe`\n+  --> $DIR/intra-links-private.rs:5:11\n+   |\n+LL | /// docs [DontDocMe]\n+   |           ^^^^^^^^^ this item is private\n+   |\n+   = note: `#[warn(intra_doc_link_resolution_failure)]` on by default\n+\n+warning: 1 warning emitted\n+"}, {"sha": "6a23afb0798a9307d19ab1aeda285702be8883bf", "filename": "src/test/rustdoc-ui/intra-links-private.public.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ed53de029cf84651423007ec68305d6e772c819f/src%2Ftest%2Frustdoc-ui%2Fintra-links-private.public.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/ed53de029cf84651423007ec68305d6e772c819f/src%2Ftest%2Frustdoc-ui%2Fintra-links-private.public.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fintra-links-private.public.stderr?ref=ed53de029cf84651423007ec68305d6e772c819f", "patch": "@@ -1,5 +1,5 @@\n warning: public documentation for `DocMe` links to private item `DontDocMe`\n-  --> $DIR/intra-links-private.rs:6:11\n+  --> $DIR/intra-links-private.rs:5:11\n    |\n LL | /// docs [DontDocMe]\n    |           ^^^^^^^^^ this item is private"}, {"sha": "613236d75d2ee952e847f7ac23590a95509bfccd", "filename": "src/test/rustdoc-ui/intra-links-private.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/ed53de029cf84651423007ec68305d6e772c819f/src%2Ftest%2Frustdoc-ui%2Fintra-links-private.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ed53de029cf84651423007ec68305d6e772c819f/src%2Ftest%2Frustdoc-ui%2Fintra-links-private.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fintra-links-private.rs?ref=ed53de029cf84651423007ec68305d6e772c819f", "patch": "@@ -1,10 +1,9 @@\n // check-pass\n // revisions: public private\n // [private]compile-flags: --document-private-items\n-#![cfg_attr(private, deny(intra_doc_link_resolution_failure))]\n \n /// docs [DontDocMe]\n-//[public]~^ WARNING public documentation for `DocMe` links to private item `DontDocMe`\n+//~^ WARNING public documentation for `DocMe` links to private item `DontDocMe`\n // FIXME: for [private] we should also make sure the link was actually generated\n pub struct DocMe;\n struct DontDocMe;"}, {"sha": "3c41f7e63e637386cad7cb9c0107572fff2d1054", "filename": "src/test/rustdoc-ui/issue-74134.private.stderr", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/ed53de029cf84651423007ec68305d6e772c819f/src%2Ftest%2Frustdoc-ui%2Fissue-74134.private.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/ed53de029cf84651423007ec68305d6e772c819f/src%2Ftest%2Frustdoc-ui%2Fissue-74134.private.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fissue-74134.private.stderr?ref=ed53de029cf84651423007ec68305d6e772c819f", "patch": "@@ -0,0 +1,10 @@\n+warning: public documentation for `public_item` links to private item `PrivateType`\n+  --> $DIR/issue-74134.rs:19:10\n+   |\n+LL |     /// [`PrivateType`]\n+   |          ^^^^^^^^^^^^^ this item is private\n+   |\n+   = note: `#[warn(intra_doc_link_resolution_failure)]` on by default\n+\n+warning: 1 warning emitted\n+"}, {"sha": "b1be9123aaf838cf4750c84dc06fb23d1f01b5cd", "filename": "src/test/rustdoc-ui/issue-74134.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/ed53de029cf84651423007ec68305d6e772c819f/src%2Ftest%2Frustdoc-ui%2Fissue-74134.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ed53de029cf84651423007ec68305d6e772c819f/src%2Ftest%2Frustdoc-ui%2Fissue-74134.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fissue-74134.rs?ref=ed53de029cf84651423007ec68305d6e772c819f", "patch": "@@ -4,7 +4,7 @@\n \n // There are 4 cases here:\n // 1. public item  -> public type:  no warning\n-// 2. public item  -> private type: warning, if --document-private-items is not passed\n+// 2. public item  -> private type: warning\n // 3. private item -> public type:  no warning\n // 4. private item -> private type: no warning\n // All 4 cases are tested with and without --document-private-items.\n@@ -17,7 +17,7 @@ pub struct PublicType;\n pub struct Public {\n     /// [`PublicType`]\n     /// [`PrivateType`]\n-    //[public]~^ WARNING public documentation for `public_item` links to private item `PrivateType`\n+    //~^ WARNING public documentation for `public_item` links to private item `PrivateType`\n     pub public_item: u32,\n \n     /// [`PublicType`]"}]}