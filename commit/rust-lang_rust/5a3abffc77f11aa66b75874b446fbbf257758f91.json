{"sha": "5a3abffc77f11aa66b75874b446fbbf257758f91", "node_id": "MDY6Q29tbWl0NzI0NzEyOjVhM2FiZmZjNzdmMTFhYTY2Yjc1ODc0YjQ0NmZiYmYyNTc3NThmOTE=", "commit": {"author": {"name": "Oliver Scherer", "email": "github35764891676564198441@oli-obk.de", "date": "2018-12-18T12:33:02Z"}, "committer": {"name": "Oliver Scherer", "email": "github35764891676564198441@oli-obk.de", "date": "2018-12-18T12:33:02Z"}, "message": "Automatically open an issue when a tool breaks", "tree": {"sha": "f97f3c9f2b28d31294957cc676ca05b458b029d8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f97f3c9f2b28d31294957cc676ca05b458b029d8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5a3abffc77f11aa66b75874b446fbbf257758f91", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5a3abffc77f11aa66b75874b446fbbf257758f91", "html_url": "https://github.com/rust-lang/rust/commit/5a3abffc77f11aa66b75874b446fbbf257758f91", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5a3abffc77f11aa66b75874b446fbbf257758f91/comments", "author": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "committer": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "041254b81495a5aa67af839e00b890e78ed0cbeb", "url": "https://api.github.com/repos/rust-lang/rust/commits/041254b81495a5aa67af839e00b890e78ed0cbeb", "html_url": "https://github.com/rust-lang/rust/commit/041254b81495a5aa67af839e00b890e78ed0cbeb"}], "stats": {"total": 42, "additions": 39, "deletions": 3}, "files": [{"sha": "b863b9dde0d790d45a4fc5f18c339433c5b741e4", "filename": "src/tools/publish_toolstate.py", "status": "modified", "additions": 39, "deletions": 3, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/5a3abffc77f11aa66b75874b446fbbf257758f91/src%2Ftools%2Fpublish_toolstate.py", "raw_url": "https://github.com/rust-lang/rust/raw/5a3abffc77f11aa66b75874b446fbbf257758f91/src%2Ftools%2Fpublish_toolstate.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fpublish_toolstate.py?ref=5a3abffc77f11aa66b75874b446fbbf257758f91", "patch": "@@ -45,11 +45,41 @@ def read_current_status(current_commit, path):\n                 return json.loads(status)\n     return {}\n \n+def issue(\n+    title,\n+    tool,\n+    maintainers,\n+    relevant_pr_number,\n+    relevant_pr_user,\n+):\n+    # Open an issue about the toolstate failure.\n+    gh_url = 'https://api.github.com/repos/rust-lang/rust/issues'\n+    assignees = [x.strip() for x in maintainers.split('@') if x != '']\n+    assignees.append(relevant_pr_user)\n+    response = urllib2.urlopen(urllib2.Request(\n+        gh_url,\n+        json.dumps({\n+            'body': '''\\\n+            @{}: your PR ({}) broke {}\n+\n+            If you have the time it would be great if you could open a PR against {} that\n+            fixes the fallout from your PR.\n+            '''.format(relevant_pr_user, relevant_pr_number, tool, tool),\n+            'title': title,\n+            'assignees': assignees,\n+        }),\n+        {\n+            'Authorization': 'token ' + github_token,\n+            'Content-Type': 'application/json',\n+        }\n+    ))\n+    response.read()\n \n def update_latest(\n     current_commit,\n     relevant_pr_number,\n     relevant_pr_url,\n+    relevant_pr_user,\n     current_datetime\n ):\n     '''Updates `_data/latest.json` to match build result of the given commit.\n@@ -85,8 +115,11 @@ def update_latest(\n                         .format(tool, os, old, new, MAINTAINERS.get(tool))\n                 elif new < old:\n                     changed = True\n-                    message += '\ud83d\udc94 {} on {}: {} \u2192 {} (cc {}, @rust-lang/infra).\\n' \\\n-                        .format(tool, os, old, new, MAINTAINERS.get(tool))\n+                    title = '\ud83d\udc94 {} on {}: {} \u2192 {}' \\\n+                        .format(tool, os, old, new)\n+                    message += '{} (cc {}, @rust-lang/infra).\\n' \\\n+                        .format(title, MAINTAINERS.get(tool))\n+                    issue(title, tool, MAINTAINERS.get(tool), relevant_pr_number, relevant_pr_user)\n \n             if changed:\n                 status['commit'] = current_commit\n@@ -109,20 +142,23 @@ def update_latest(\n     save_message_to_path = sys.argv[3]\n     github_token = sys.argv[4]\n \n-    relevant_pr_match = re.search('#([0-9]+)', cur_commit_msg)\n+    relevant_pr_match = re.search('Auto merge of #([0-9]+) - ([^:]+)', cur_commit_msg)\n     if relevant_pr_match:\n         number = relevant_pr_match.group(1)\n+        relevant_pr_user = relevant_pr_match.group(2)\n         relevant_pr_number = 'rust-lang/rust#' + number\n         relevant_pr_url = 'https://github.com/rust-lang/rust/pull/' + number\n     else:\n         number = '-1'\n+        relevant_pr_user = '<unknown user>'\n         relevant_pr_number = '<unknown PR>'\n         relevant_pr_url = '<unknown>'\n \n     message = update_latest(\n         cur_commit,\n         relevant_pr_number,\n         relevant_pr_url,\n+        relevant_pr_user,\n         cur_datetime\n     )\n     if not message:"}]}