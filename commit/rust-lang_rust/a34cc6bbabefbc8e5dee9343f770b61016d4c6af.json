{"sha": "a34cc6bbabefbc8e5dee9343f770b61016d4c6af", "node_id": "MDY6Q29tbWl0NzI0NzEyOmEzNGNjNmJiYWJlZmJjOGU1ZGVlOTM0M2Y3NzBiNjEwMTZkNGM2YWY=", "commit": {"author": {"name": "Yuki Okushi", "email": "huyuumi.dev@gmail.com", "date": "2021-03-23T01:15:40Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-03-23T01:15:40Z"}, "message": "Rollup merge of #82732 - GuillaumeGomez:remove-theme-file, r=Nemo157\n\nRemove theme.js file\n\nFixes #82616.\n\nThe first commit moves the `theme.js` file into `main.js`, which requires to also run a small `.replace` on the `main.js` content.\n\nThe second commit is just a small cleanup to centralize DOM ids.\n\nSince it removes a file from rustdoc output: cc `@rust-lang/docs-rs`\n\ncc `@jsha`\nr? `@jyn514`", "tree": {"sha": "e2b6eb29dee310730d511c1c2c49cb62b7336510", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e2b6eb29dee310730d511c1c2c49cb62b7336510"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a34cc6bbabefbc8e5dee9343f770b61016d4c6af", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgWUE9CRBK7hj4Ov3rIwAAdHIIAKfK0dfVq5CH64/DZULv4DYL\nOkiu0ZN9lpdrQIwbTpaSCnyyDk/axZH1fTvb9bPntnh10SvGytxrXHGRJSz/0AcL\n2zNyO7du08Vp79Vel/+gRGc0ZUl7Y+zuFg5ZkZZJUJLe5zHSjHdjb0xFP/FyZDD3\nJxPZ8yt/lS+S6EV05nbXbfvgyu+G0UXNwenWp6FRMPDGtkVbBItXnEpDI+5R7oVp\n8PEcErjd+aaavUpjnTYmlZkCU+8CTVwjenorgz2VbCMmZo3mz6CLeu/Ya7AOpOZe\nfV9WSvGBBqGndDdlHpu3fmcySCaOusOiKiJsPbpz2CTbsFY9/9+9OAb0SZ4Ecio=\n=2QRb\n-----END PGP SIGNATURE-----\n", "payload": "tree e2b6eb29dee310730d511c1c2c49cb62b7336510\nparent 9cae1fb94a50b768b184248ccccbadf082edf9d6\nparent 524fdf00346002ecaee50ce357ddfc0c85485e4e\nauthor Yuki Okushi <huyuumi.dev@gmail.com> 1616462140 +0900\ncommitter GitHub <noreply@github.com> 1616462140 +0900\n\nRollup merge of #82732 - GuillaumeGomez:remove-theme-file, r=Nemo157\n\nRemove theme.js file\n\nFixes #82616.\n\nThe first commit moves the `theme.js` file into `main.js`, which requires to also run a small `.replace` on the `main.js` content.\n\nThe second commit is just a small cleanup to centralize DOM ids.\n\nSince it removes a file from rustdoc output: cc `@rust-lang/docs-rs`\n\ncc `@jsha`\nr? `@jyn514`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a34cc6bbabefbc8e5dee9343f770b61016d4c6af", "html_url": "https://github.com/rust-lang/rust/commit/a34cc6bbabefbc8e5dee9343f770b61016d4c6af", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a34cc6bbabefbc8e5dee9343f770b61016d4c6af/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9cae1fb94a50b768b184248ccccbadf082edf9d6", "url": "https://api.github.com/repos/rust-lang/rust/commits/9cae1fb94a50b768b184248ccccbadf082edf9d6", "html_url": "https://github.com/rust-lang/rust/commit/9cae1fb94a50b768b184248ccccbadf082edf9d6"}, {"sha": "524fdf00346002ecaee50ce357ddfc0c85485e4e", "url": "https://api.github.com/repos/rust-lang/rust/commits/524fdf00346002ecaee50ce357ddfc0c85485e4e", "html_url": "https://github.com/rust-lang/rust/commit/524fdf00346002ecaee50ce357ddfc0c85485e4e"}], "stats": {"total": 157, "additions": 83, "deletions": 74}, "files": [{"sha": "68d70f27c8c7888acb6360295c73cc375db10cfc", "filename": "src/librustdoc/html/layout.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/a34cc6bbabefbc8e5dee9343f770b61016d4c6af/src%2Flibrustdoc%2Fhtml%2Flayout.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a34cc6bbabefbc8e5dee9343f770b61016d4c6af/src%2Flibrustdoc%2Fhtml%2Flayout.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Flayout.rs?ref=a34cc6bbabefbc8e5dee9343f770b61016d4c6af", "patch": "@@ -88,7 +88,6 @@ crate fn render<T: Print, S: Print>(\n         </button>\\\n         <div id=\\\"theme-choices\\\" role=\\\"menu\\\"></div>\\\n     </div>\\\n-    <script src=\\\"{static_root_path}theme{suffix}.js\\\"></script>\\\n     <nav class=\\\"sub\\\">\\\n         <form class=\\\"search-form\\\">\\\n             <div class=\\\"search-container\\\">\\"}, {"sha": "501d8e8e02e8469d29183c0cf4b6eb9440415c52", "filename": "src/librustdoc/html/render/write_shared.rs", "status": "modified", "additions": 5, "deletions": 56, "changes": 61, "blob_url": "https://github.com/rust-lang/rust/blob/a34cc6bbabefbc8e5dee9343f770b61016d4c6af/src%2Flibrustdoc%2Fhtml%2Frender%2Fwrite_shared.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a34cc6bbabefbc8e5dee9343f770b61016d4c6af/src%2Flibrustdoc%2Fhtml%2Frender%2Fwrite_shared.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fwrite_shared.rs?ref=a34cc6bbabefbc8e5dee9343f770b61016d4c6af", "patch": "@@ -130,65 +130,14 @@ pub(super) fn write_shared(\n \n     let mut themes: Vec<&String> = themes.iter().collect();\n     themes.sort();\n-    // To avoid theme switch latencies as much as possible, we put everything theme related\n-    // at the beginning of the html files into another js file.\n-    let theme_js = format!(\n-        r#\"var themes = document.getElementById(\"theme-choices\");\n-var themePicker = document.getElementById(\"theme-picker\");\n-\n-function showThemeButtonState() {{\n-    themes.style.display = \"block\";\n-    themePicker.style.borderBottomRightRadius = \"0\";\n-    themePicker.style.borderBottomLeftRadius = \"0\";\n-}}\n-\n-function hideThemeButtonState() {{\n-    themes.style.display = \"none\";\n-    themePicker.style.borderBottomRightRadius = \"3px\";\n-    themePicker.style.borderBottomLeftRadius = \"3px\";\n-}}\n-\n-function switchThemeButtonState() {{\n-    if (themes.style.display === \"block\") {{\n-        hideThemeButtonState();\n-    }} else {{\n-        showThemeButtonState();\n-    }}\n-}};\n-\n-function handleThemeButtonsBlur(e) {{\n-    var active = document.activeElement;\n-    var related = e.relatedTarget;\n-\n-    if (active.id !== \"theme-picker\" &&\n-        (!active.parentNode || active.parentNode.id !== \"theme-choices\") &&\n-        (!related ||\n-         (related.id !== \"theme-picker\" &&\n-          (!related.parentNode || related.parentNode.id !== \"theme-choices\")))) {{\n-        hideThemeButtonState();\n-    }}\n-}}\n-\n-themePicker.onclick = switchThemeButtonState;\n-themePicker.onblur = handleThemeButtonsBlur;\n-{}.forEach(function(item) {{\n-    var but = document.createElement(\"button\");\n-    but.textContent = item;\n-    but.onclick = function(el) {{\n-        switchTheme(currentTheme, mainTheme, item, true);\n-        useSystemTheme(false);\n-    }};\n-    but.onblur = handleThemeButtonsBlur;\n-    themes.appendChild(but);\n-}});\"#,\n-        serde_json::to_string(&themes).unwrap()\n-    );\n-\n-    write_minify(&cx.shared.fs, cx.path(\"theme.js\"), &theme_js, options.enable_minification)?;\n+\n     write_minify(\n         &cx.shared.fs,\n         cx.path(\"main.js\"),\n-        static_files::MAIN_JS,\n+        &static_files::MAIN_JS.replace(\n+            \"/* INSERT THEMES HERE */\",\n+            &format!(\" = {}\", serde_json::to_string(&themes).unwrap()),\n+        ),\n         options.enable_minification,\n     )?;\n     write_minify("}, {"sha": "da2952bbebdbe5e19fd0802aa6e673bf8fefd7a3", "filename": "src/librustdoc/html/static/main.js", "status": "modified", "additions": 69, "deletions": 8, "changes": 77, "blob_url": "https://github.com/rust-lang/rust/blob/a34cc6bbabefbc8e5dee9343f770b61016d4c6af/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fmain.js", "raw_url": "https://github.com/rust-lang/rust/raw/a34cc6bbabefbc8e5dee9343f770b61016d4c6af/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fmain.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fmain.js?ref=a34cc6bbabefbc8e5dee9343f770b61016d4c6af", "patch": "@@ -2,7 +2,7 @@\n // Local js definitions:\n /* global addClass, getSettingValue, hasClass */\n /* global onEach, onEachLazy, hasOwnProperty, removeClass, updateLocalStorage */\n-/* global hideThemeButtonState, showThemeButtonState */\n+/* global switchTheme, useSystemTheme */\n \n if (!String.prototype.startsWith) {\n     String.prototype.startsWith = function(searchString, position) {\n@@ -85,12 +85,15 @@ function getSearchElement() {\n     return document.getElementById(\"search\");\n }\n \n+var THEME_PICKER_ELEMENT_ID = \"theme-picker\";\n+var THEMES_ELEMENT_ID = \"theme-choices\";\n+\n function getThemesElement() {\n-    return document.getElementById(\"theme-choices\");\n+    return document.getElementById(THEMES_ELEMENT_ID);\n }\n \n function getThemePickerElement() {\n-    return document.getElementById(\"theme-picker\");\n+    return document.getElementById(THEME_PICKER_ELEMENT_ID);\n }\n \n // Returns the current URL without any query parameter or hash.\n@@ -108,6 +111,65 @@ function defocusSearchBar() {\n     getSearchInput().blur();\n }\n \n+function showThemeButtonState() {\n+    var themePicker = getThemePickerElement();\n+    var themeChoices = getThemesElement();\n+\n+    themeChoices.style.display = \"block\";\n+    themePicker.style.borderBottomRightRadius = \"0\";\n+    themePicker.style.borderBottomLeftRadius = \"0\";\n+}\n+\n+function hideThemeButtonState() {\n+    var themePicker = getThemePickerElement();\n+    var themeChoices = getThemesElement();\n+\n+    themeChoices.style.display = \"none\";\n+    themePicker.style.borderBottomRightRadius = \"3px\";\n+    themePicker.style.borderBottomLeftRadius = \"3px\";\n+}\n+\n+// Set up the theme picker list.\n+(function () {\n+    var themeChoices = getThemesElement();\n+    var themePicker = getThemePickerElement();\n+    var availableThemes/* INSERT THEMES HERE */;\n+\n+    function switchThemeButtonState() {\n+        if (themeChoices.style.display === \"block\") {\n+            hideThemeButtonState();\n+        } else {\n+            showThemeButtonState();\n+        }\n+    }\n+\n+    function handleThemeButtonsBlur(e) {\n+        var active = document.activeElement;\n+        var related = e.relatedTarget;\n+\n+        if (active.id !== THEME_PICKER_ELEMENT_ID &&\n+            (!active.parentNode || active.parentNode.id !== THEMES_ELEMENT_ID) &&\n+            (!related ||\n+             (related.id !== THEME_PICKER_ELEMENT_ID &&\n+              (!related.parentNode || related.parentNode.id !== THEMES_ELEMENT_ID)))) {\n+            hideThemeButtonState();\n+        }\n+    }\n+\n+    themePicker.onclick = switchThemeButtonState;\n+    themePicker.onblur = handleThemeButtonsBlur;\n+    availableThemes.forEach(function(item) {\n+        var but = document.createElement(\"button\");\n+        but.textContent = item;\n+        but.onclick = function() {\n+            switchTheme(window.currentTheme, window.mainTheme, item, true);\n+            useSystemTheme(false);\n+        };\n+        but.onblur = handleThemeButtonsBlur;\n+        themeChoices.appendChild(but);\n+    });\n+}());\n+\n (function() {\n     \"use strict\";\n \n@@ -461,8 +523,7 @@ function defocusSearchBar() {\n                 break;\n \n             default:\n-                var themePicker = getThemePickerElement();\n-                if (themePicker.parentNode.contains(ev.target)) {\n+                if (getThemePickerElement().parentNode.contains(ev.target)) {\n                     handleThemeKeyDown(ev);\n                 }\n             }\n@@ -475,7 +536,7 @@ function defocusSearchBar() {\n         switch (getVirtualKey(ev)) {\n         case \"ArrowUp\":\n             ev.preventDefault();\n-            if (active.previousElementSibling && ev.target.id !== \"theme-picker\") {\n+            if (active.previousElementSibling && ev.target.id !== THEME_PICKER_ELEMENT_ID) {\n                 active.previousElementSibling.focus();\n             } else {\n                 showThemeButtonState();\n@@ -484,7 +545,7 @@ function defocusSearchBar() {\n             break;\n         case \"ArrowDown\":\n             ev.preventDefault();\n-            if (active.nextElementSibling && ev.target.id !== \"theme-picker\") {\n+            if (active.nextElementSibling && ev.target.id !== THEME_PICKER_ELEMENT_ID) {\n                 active.nextElementSibling.focus();\n             } else {\n                 showThemeButtonState();\n@@ -494,7 +555,7 @@ function defocusSearchBar() {\n         case \"Enter\":\n         case \"Return\":\n         case \"Space\":\n-            if (ev.target.id === \"theme-picker\" && themes.style.display === \"none\") {\n+            if (ev.target.id === THEME_PICKER_ELEMENT_ID && themes.style.display === \"none\") {\n                 ev.preventDefault();\n                 showThemeButtonState();\n                 themes.firstElementChild.focus();"}, {"sha": "c68128516d252df82d1f873452bd17c8ca8e62c6", "filename": "src/librustdoc/html/static/storage.js", "status": "modified", "additions": 9, "deletions": 9, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/a34cc6bbabefbc8e5dee9343f770b61016d4c6af/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fstorage.js", "raw_url": "https://github.com/rust-lang/rust/raw/a34cc6bbabefbc8e5dee9343f770b61016d4c6af/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fstorage.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fstorage.js?ref=a34cc6bbabefbc8e5dee9343f770b61016d4c6af", "patch": "@@ -2,8 +2,8 @@\n /* global resourcesSuffix */\n \n var darkThemes = [\"dark\", \"ayu\"];\n-var currentTheme = document.getElementById(\"themeStyle\");\n-var mainTheme = document.getElementById(\"mainThemeStyle\");\n+window.currentTheme = document.getElementById(\"themeStyle\");\n+window.mainTheme = document.getElementById(\"mainThemeStyle\");\n \n var settingsDataset = (function () {\n     var settingsElement = document.getElementById(\"default-settings\");\n@@ -137,7 +137,7 @@ function switchTheme(styleElem, mainStyleElem, newTheme, saveTheme) {\n     }\n }\n \n-// This function is called from \"theme.js\", generated in `html/render/mod.rs`.\n+// This function is called from \"main.js\".\n // eslint-disable-next-line no-unused-vars\n function useSystemTheme(value) {\n     if (value === undefined) {\n@@ -161,8 +161,8 @@ var updateSystemTheme = (function() {\n                 .getPropertyValue('content');\n \n             switchTheme(\n-                currentTheme,\n-                mainTheme,\n+                window.currentTheme,\n+                window.mainTheme,\n                 JSON.parse(cssTheme) || \"light\",\n                 true\n             );\n@@ -180,10 +180,10 @@ var updateSystemTheme = (function() {\n \n             if (mql.matches) {\n                 // prefers a dark theme\n-                switchTheme(currentTheme, mainTheme, darkTheme, true);\n+                switchTheme(window.currentTheme, window.mainTheme, darkTheme, true);\n             } else {\n                 // prefers a light theme, or has no preference\n-                switchTheme(currentTheme, mainTheme, lightTheme, true);\n+                switchTheme(window.currentTheme, window.mainTheme, lightTheme, true);\n             }\n \n             // note: we save the theme so that it doesn't suddenly change when\n@@ -212,8 +212,8 @@ if (getSettingValue(\"use-system-theme\") !== \"false\" && window.matchMedia) {\n     updateSystemTheme();\n } else {\n     switchTheme(\n-        currentTheme,\n-        mainTheme,\n+        window.currentTheme,\n+        window.mainTheme,\n         getSettingValue(\"theme\") || \"light\",\n         false\n     );"}]}