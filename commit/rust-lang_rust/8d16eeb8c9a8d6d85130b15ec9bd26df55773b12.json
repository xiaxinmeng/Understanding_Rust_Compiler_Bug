{"sha": "8d16eeb8c9a8d6d85130b15ec9bd26df55773b12", "node_id": "MDY6Q29tbWl0NzI0NzEyOjhkMTZlZWI4YzlhOGQ2ZDg1MTMwYjE1ZWM5YmQyNmRmNTU3NzNiMTI=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-05-10T08:25:32Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-05-10T08:25:32Z"}, "message": "Auto merge of #71775 - petrochenkov:crtcfg, r=matthewjasper\n\nEnable `cfg` predicate for `target_feature = \"crt-static\"` only if the target supports it\n\nThat's what all other `target_feature`s do.", "tree": {"sha": "b31597466a498f9d97fe2eb15ce63c6387abe909", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b31597466a498f9d97fe2eb15ce63c6387abe909"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8d16eeb8c9a8d6d85130b15ec9bd26df55773b12", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8d16eeb8c9a8d6d85130b15ec9bd26df55773b12", "html_url": "https://github.com/rust-lang/rust/commit/8d16eeb8c9a8d6d85130b15ec9bd26df55773b12", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8d16eeb8c9a8d6d85130b15ec9bd26df55773b12/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b3269536d0a883caa0904cf6589aa1310ff70b5e", "url": "https://api.github.com/repos/rust-lang/rust/commits/b3269536d0a883caa0904cf6589aa1310ff70b5e", "html_url": "https://github.com/rust-lang/rust/commit/b3269536d0a883caa0904cf6589aa1310ff70b5e"}, {"sha": "33b6631d9b2c79c548a9abdaf585a230b5f14ad9", "url": "https://api.github.com/repos/rust-lang/rust/commits/33b6631d9b2c79c548a9abdaf585a230b5f14ad9", "html_url": "https://github.com/rust-lang/rust/commit/33b6631d9b2c79c548a9abdaf585a230b5f14ad9"}], "stats": {"total": 20, "additions": 6, "deletions": 14}, "files": [{"sha": "7637108e18b39a70401ae50fd5533b02d57a6db5", "filename": "src/librustc_interface/util.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/8d16eeb8c9a8d6d85130b15ec9bd26df55773b12/src%2Flibrustc_interface%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8d16eeb8c9a8d6d85130b15ec9bd26df55773b12/src%2Flibrustc_interface%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_interface%2Futil.rs?ref=8d16eeb8c9a8d6d85130b15ec9bd26df55773b12", "patch": "@@ -49,7 +49,7 @@ pub fn add_configuration(\n \n     cfg.extend(codegen_backend.target_features(sess).into_iter().map(|feat| (tf, Some(feat))));\n \n-    if sess.crt_static_feature(None) {\n+    if sess.crt_static(None) {\n         cfg.insert((tf, Some(Symbol::intern(\"crt-static\"))));\n     }\n }"}, {"sha": "4b1cc71c822f3aaa8d9ab102ccec661edc419fdd", "filename": "src/librustc_session/session.rs", "status": "modified", "additions": 3, "deletions": 8, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/8d16eeb8c9a8d6d85130b15ec9bd26df55773b12/src%2Flibrustc_session%2Fsession.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8d16eeb8c9a8d6d85130b15ec9bd26df55773b12/src%2Flibrustc_session%2Fsession.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_session%2Fsession.rs?ref=8d16eeb8c9a8d6d85130b15ec9bd26df55773b12", "patch": "@@ -598,16 +598,11 @@ impl Session {\n \n     /// Check whether this compile session and crate type use static crt.\n     pub fn crt_static(&self, crate_type: Option<CrateType>) -> bool {\n-        // If the target does not opt in to crt-static support, use its default.\n-        if self.target.target.options.crt_static_respected {\n-            self.crt_static_feature(crate_type)\n-        } else {\n-            self.target.target.options.crt_static_default\n+        if !self.target.target.options.crt_static_respected {\n+            // If the target does not opt in to crt-static support, use its default.\n+            return self.target.target.options.crt_static_default;\n         }\n-    }\n \n-    /// Check whether this compile session and crate type use `crt-static` feature.\n-    pub fn crt_static_feature(&self, crate_type: Option<CrateType>) -> bool {\n         let requested_features = self.opts.cg.target_feature.split(',');\n         let found_negative = requested_features.clone().any(|r| r == \"-crt-static\");\n         let found_positive = requested_features.clone().any(|r| r == \"+crt-static\");"}, {"sha": "f89d1edd6586a015f757d692d38f6c2ce748d446", "filename": "src/test/ui/crt-static-on-works.rs", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/8d16eeb8c9a8d6d85130b15ec9bd26df55773b12/src%2Ftest%2Fui%2Fcrt-static-on-works.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8d16eeb8c9a8d6d85130b15ec9bd26df55773b12/src%2Ftest%2Fui%2Fcrt-static-on-works.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcrt-static-on-works.rs?ref=8d16eeb8c9a8d6d85130b15ec9bd26df55773b12", "patch": "@@ -1,9 +1,6 @@\n // run-pass\n-\n-#![allow(stable_features)]\n-// compile-flags:-C target-feature=+crt-static -Z unstable-options\n-\n-#![feature(cfg_target_feature)]\n+// compile-flags:-C target-feature=+crt-static\n+// only-msvc\n \n #[cfg(target_feature = \"crt-static\")]\n fn main() {}"}]}