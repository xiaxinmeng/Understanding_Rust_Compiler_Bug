{"sha": "4e725bad73747a4c93a3ac53106e4b4006edc665", "node_id": "C_kwDOAAsO6NoAKDRlNzI1YmFkNzM3NDdhNGM5M2EzYWM1MzEwNmU0YjQwMDZlZGM2NjU", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-06-04T20:27:53Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-06-04T20:27:53Z"}, "message": "Auto merge of #97191 - wesleywiser:main_thread_name, r=ChrisDenton\n\nCall the OS function to set the main thread's name on program init\n\nNormally, `Thread::spawn` takes care of setting the thread's name, if\none was provided, but since the main thread wasn't created by calling\n`Thread::spawn`, we need to call that function in `std::rt::init`.\n\nThis is mainly useful for system tools like debuggers and profilers\nwhich might show the thread name to a user. Prior to these changes, gdb\nand WinDbg would show all thread names except the main thread's name to\na user. I've validated that this patch resolves the issue for both\ndebuggers.", "tree": {"sha": "7d11e5ed27f3d5baa63894bca6600a0b0e0c2a97", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7d11e5ed27f3d5baa63894bca6600a0b0e0c2a97"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4e725bad73747a4c93a3ac53106e4b4006edc665", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4e725bad73747a4c93a3ac53106e4b4006edc665", "html_url": "https://github.com/rust-lang/rust/commit/4e725bad73747a4c93a3ac53106e4b4006edc665", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4e725bad73747a4c93a3ac53106e4b4006edc665/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3a8e71385940c2f02ec4b23876c0a36fd09bdefe", "url": "https://api.github.com/repos/rust-lang/rust/commits/3a8e71385940c2f02ec4b23876c0a36fd09bdefe", "html_url": "https://github.com/rust-lang/rust/commit/3a8e71385940c2f02ec4b23876c0a36fd09bdefe"}, {"sha": "cb87ce22857bef0cf57a919d4c415211f0b1ab1d", "url": "https://api.github.com/repos/rust-lang/rust/commits/cb87ce22857bef0cf57a919d4c415211f0b1ab1d", "html_url": "https://github.com/rust-lang/rust/commit/cb87ce22857bef0cf57a919d4c415211f0b1ab1d"}], "stats": {"total": 67, "additions": 66, "deletions": 1}, "files": [{"sha": "1505878e18c0dcdedb66b266b7f6829f48acb6d0", "filename": "library/std/src/sys/unix/mod.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/4e725bad73747a4c93a3ac53106e4b4006edc665/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4e725bad73747a4c93a3ac53106e4b4006edc665/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fmod.rs?ref=4e725bad73747a4c93a3ac53106e4b4006edc665", "patch": "@@ -1,5 +1,6 @@\n #![allow(missing_docs, nonstandard_style)]\n \n+use crate::ffi::CStr;\n use crate::io::ErrorKind;\n \n pub use self::rand::hashmap_random_keys;\n@@ -66,6 +67,15 @@ pub unsafe fn init(argc: isize, argv: *const *const u8) {\n     stack_overflow::init();\n     args::init(argc, argv);\n \n+    // Normally, `thread::spawn` will call `Thread::set_name` but since this thread\n+    // already exists, we have to call it ourselves. We only do this on macos\n+    // because some unix-like operating systems such as Linux share process-id and\n+    // thread-id for the main thread and so renaming the main thread will rename the\n+    // process and we only want to enable this on platforms we've tested.\n+    if cfg!(target_os = \"macos\") {\n+        thread::Thread::set_name(&CStr::from_bytes_with_nul_unchecked(b\"main\\0\"));\n+    }\n+\n     unsafe fn sanitize_standard_fds() {\n         #[cfg(not(miri))]\n         // The standard fds are always available in Miri."}, {"sha": "b3f6d2d0aaed4213ab80f487faf552dea345ee92", "filename": "library/std/src/sys/windows/mod.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/4e725bad73747a4c93a3ac53106e4b4006edc665/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4e725bad73747a4c93a3ac53106e4b4006edc665/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fmod.rs?ref=4e725bad73747a4c93a3ac53106e4b4006edc665", "patch": "@@ -1,6 +1,6 @@\n #![allow(missing_docs, nonstandard_style)]\n \n-use crate::ffi::{OsStr, OsString};\n+use crate::ffi::{CStr, OsStr, OsString};\n use crate::io::ErrorKind;\n use crate::os::windows::ffi::{OsStrExt, OsStringExt};\n use crate::path::PathBuf;\n@@ -49,6 +49,10 @@ cfg_if::cfg_if! {\n // NOTE: this is not guaranteed to run, for example when Rust code is called externally.\n pub unsafe fn init(_argc: isize, _argv: *const *const u8) {\n     stack_overflow::init();\n+\n+    // Normally, `thread::spawn` will call `Thread::set_name` but since this thread already\n+    // exists, we have to call it ourselves.\n+    thread::Thread::set_name(&CStr::from_bytes_with_nul_unchecked(b\"main\\0\"));\n }\n \n // SAFETY: must be called only once during runtime cleanup."}, {"sha": "7a35a5189463a0beb28042d86467416dc12926e4", "filename": "src/test/debuginfo/thread-names.rs", "status": "added", "additions": 51, "deletions": 0, "changes": 51, "blob_url": "https://github.com/rust-lang/rust/blob/4e725bad73747a4c93a3ac53106e4b4006edc665/src%2Ftest%2Fdebuginfo%2Fthread-names.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4e725bad73747a4c93a3ac53106e4b4006edc665/src%2Ftest%2Fdebuginfo%2Fthread-names.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fdebuginfo%2Fthread-names.rs?ref=4e725bad73747a4c93a3ac53106e4b4006edc665", "patch": "@@ -0,0 +1,51 @@\n+// compile-flags:-g\n+// We can't set the main thread name on Linux because it renames the process (#97191)\n+// ignore-linux\n+// ignore-android\n+// ignore-dragonfly\n+// ignore-emscripten\n+// ignore-freebsd\n+// ignore-haiku\n+// ignore-ios\n+// ignore-netbsd\n+// ignore-openbsd\n+// ignore-solaris\n+// ignore-sgx\n+// ignore-windows-gnu\n+\n+// === GDB TESTS ==================================================================================\n+//\n+// gdb-command:run\n+//\n+// gdb-command:info threads\n+// gdb-check:  1    Thread [...] [...] \"main\" [...]\n+// gdb-check:* 2    Thread [...] [...] \"my new thread\" [...]\n+\n+// === LLDB TESTS =================================================================================\n+//\n+// lldb-command:run\n+//\n+// lldb-command:thread info 1\n+// lldb-check:thread #1:[...]name = 'main'[...]\n+// lldb-command:thread info 2\n+// lldb-check:thread #2:[...]name = 'my new thread'[...]\n+\n+// === CDB TESTS ==================================================================================\n+//\n+// cdb-command:g\n+//\n+// cdb-command:~\n+// cdb-check:   0  Id: [...] Suspend: 1 Teb: [...] Unfrozen \"main\"\n+// cdb-check:.  [...]  Id: [...] Suspend: 1 Teb: [...] Unfrozen \"my new thread\"\n+\n+use std::thread;\n+\n+fn main() {\n+    let handle = thread::Builder::new().name(\"my new thread\".into()).spawn(|| {\n+        zzz(); // #break\n+    }).unwrap();\n+\n+    handle.join().unwrap();\n+}\n+\n+fn zzz() {}"}]}