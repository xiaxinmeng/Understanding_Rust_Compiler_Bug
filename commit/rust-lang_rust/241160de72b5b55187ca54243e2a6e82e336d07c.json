{"sha": "241160de72b5b55187ca54243e2a6e82e336d07c", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI0MTE2MGRlNzJiNWI1NTE4N2NhNTQyNDNlMmE2ZTgyZTMzNmQwN2M=", "commit": {"author": {"name": "David Wood", "email": "david@davidtw.co", "date": "2020-10-14T17:16:05Z"}, "committer": {"name": "David Wood", "email": "david@davidtw.co", "date": "2020-12-16T10:33:45Z"}, "message": "bootstrap: copy `llvm-dwp` to sysroot\n\n`llvm-dwp` is required for linking the DWARF objects into DWARF packages\nwhen using Split DWARF, especially given that rustc produces multiple\nDWARF objects (one for each codegen unit).\n\nSigned-off-by: David Wood <david@davidtw.co>", "tree": {"sha": "d1031d32d561a4000c55e57406aa6d888dbb9d6a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d1031d32d561a4000c55e57406aa6d888dbb9d6a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/241160de72b5b55187ca54243e2a6e82e336d07c", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEfgm2/wUjk9OnjxlyJZLnbIc4H9kFAl/Z4okACgkQJZLnbIc4\nH9m9Mg/+PxnO2HNOXj2UvFXFn8Awtxo4Jnx8pUbWQeDd/xkHFbWxEA7Yzdg6pXCI\nknTLCYMq6yP15xtIxwRF5ngtFRpYEUMnDVtAVEcLS+JhkeRqrdZnrA8FQVVB05ON\nfCz1/zMTn6E0teL18l+aL5w0pdNhnpCSMMTLhBvaRgj4L5ZQDKoviubrLO0I2tW/\nHo76iWa2BEfXBJ4a66BOJz+iIhGvTTp0NeTP6UadmPfnLovabm6l0CPT/6V0WISQ\nIPYE4u+DRTICm01P2cltDjcAlx+CmtzRB3F5RDN/QqNf+U6mYYdldFMaM82rSeqK\nWEBud5D98IQVUMOkRh47NxTb+0G575AOvU1NOKATFHOvCYMI1AWvFkQKx0NmCKuF\nANrVJI5KkDA7d1UgQCdBpDCCAxjc5IJ/ne2SwGDehJEAQ9JruxhTe7IZQ+TfKxLe\n1o0JyUMHppMpiiM/KVro5zFnWjGHhRAYkhakykdh+v5gAO28of/1zrpoZifLk2yQ\nrsya37wk0l5Wb+L0aC+nh4HWNp0SNKvuw6O72lewPVbuZ3qAcV0qsvstV84VYVbn\ng9gFm8WXjcQ+EZoEuXXRipAVegu1K/uVtgxDo+N//wCxOiZGGQnz6drVOpPBSrHy\nQ2NyInh7ZySTXwRtd7H6SSbW8uRJB9EizsEsPcjwngUieVyvPSg=\n=npJb\n-----END PGP SIGNATURE-----", "payload": "tree d1031d32d561a4000c55e57406aa6d888dbb9d6a\nparent 6890312ea3b7f59bc18de68930524b8853442627\nauthor David Wood <david@davidtw.co> 1602695765 +0100\ncommitter David Wood <david@davidtw.co> 1608114825 +0000\n\nbootstrap: copy `llvm-dwp` to sysroot\n\n`llvm-dwp` is required for linking the DWARF objects into DWARF packages\nwhen using Split DWARF, especially given that rustc produces multiple\nDWARF objects (one for each codegen unit).\n\nSigned-off-by: David Wood <david@davidtw.co>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/241160de72b5b55187ca54243e2a6e82e336d07c", "html_url": "https://github.com/rust-lang/rust/commit/241160de72b5b55187ca54243e2a6e82e336d07c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/241160de72b5b55187ca54243e2a6e82e336d07c/comments", "author": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "committer": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6890312ea3b7f59bc18de68930524b8853442627", "url": "https://api.github.com/repos/rust-lang/rust/commits/6890312ea3b7f59bc18de68930524b8853442627", "html_url": "https://github.com/rust-lang/rust/commit/6890312ea3b7f59bc18de68930524b8853442627"}], "stats": {"total": 35, "additions": 24, "deletions": 11}, "files": [{"sha": "fbebb26c746206cc31e20d8240da5bd4895b2b4d", "filename": "src/bootstrap/compile.rs", "status": "modified", "additions": 15, "deletions": 5, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/241160de72b5b55187ca54243e2a6e82e336d07c/src%2Fbootstrap%2Fcompile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/241160de72b5b55187ca54243e2a6e82e336d07c/src%2Fbootstrap%2Fcompile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcompile.rs?ref=241160de72b5b55187ca54243e2a6e82e336d07c", "patch": "@@ -969,15 +969,25 @@ impl Step for Assemble {\n \n         copy_codegen_backends_to_sysroot(builder, build_compiler, target_compiler);\n \n+        // We prepend this bin directory to the user PATH when linking Rust binaries. To\n+        // avoid shadowing the system LLD we rename the LLD we provide to `rust-lld`.\n         let libdir = builder.sysroot_libdir(target_compiler, target_compiler.host);\n+        let libdir_bin = libdir.parent().unwrap().join(\"bin\");\n+        t!(fs::create_dir_all(&libdir_bin));\n+\n         if let Some(lld_install) = lld_install {\n             let src_exe = exe(\"lld\", target_compiler.host);\n             let dst_exe = exe(\"rust-lld\", target_compiler.host);\n-            // we prepend this bin directory to the user PATH when linking Rust binaries. To\n-            // avoid shadowing the system LLD we rename the LLD we provide to `rust-lld`.\n-            let dst = libdir.parent().unwrap().join(\"bin\");\n-            t!(fs::create_dir_all(&dst));\n-            builder.copy(&lld_install.join(\"bin\").join(&src_exe), &dst.join(&dst_exe));\n+            builder.copy(&lld_install.join(\"bin\").join(&src_exe), &libdir_bin.join(&dst_exe));\n+        }\n+\n+        // Similarly, copy `llvm-dwp` into libdir for Split DWARF.\n+        {\n+            let src_exe = exe(\"llvm-dwp\", target_compiler.host);\n+            let dst_exe = exe(\"rust-llvm-dwp\", target_compiler.host);\n+            let llvm_config_bin = builder.ensure(native::Llvm { target: target_compiler.host });\n+            let llvm_bin_dir = llvm_config_bin.parent().unwrap();\n+            builder.copy(&llvm_bin_dir.join(&src_exe), &libdir_bin.join(&dst_exe));\n         }\n \n         // Ensure that `libLLVM.so` ends up in the newly build compiler directory,"}, {"sha": "25905895116fa85f83f8b558f80d812b1e8ce095", "filename": "src/bootstrap/dist.rs", "status": "modified", "additions": 9, "deletions": 6, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/241160de72b5b55187ca54243e2a6e82e336d07c/src%2Fbootstrap%2Fdist.rs", "raw_url": "https://github.com/rust-lang/rust/raw/241160de72b5b55187ca54243e2a6e82e336d07c/src%2Fbootstrap%2Fdist.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fdist.rs?ref=241160de72b5b55187ca54243e2a6e82e336d07c", "patch": "@@ -523,17 +523,20 @@ impl Step for Rustc {\n             // component for now.\n             maybe_install_llvm_runtime(builder, host, image);\n \n+            let src_dir = builder.sysroot_libdir(compiler, host).parent().unwrap().join(\"bin\");\n+            let dst_dir = image.join(\"lib/rustlib\").join(&*host.triple).join(\"bin\");\n+            t!(fs::create_dir_all(&dst_dir));\n+\n             // Copy over lld if it's there\n             if builder.config.lld_enabled {\n                 let exe = exe(\"rust-lld\", compiler.host);\n-                let src =\n-                    builder.sysroot_libdir(compiler, host).parent().unwrap().join(\"bin\").join(&exe);\n-                // for the rationale about this rename check `compile::copy_lld_to_sysroot`\n-                let dst = image.join(\"lib/rustlib\").join(&*host.triple).join(\"bin\").join(&exe);\n-                t!(fs::create_dir_all(&dst.parent().unwrap()));\n-                builder.copy(&src, &dst);\n+                builder.copy(&src_dir.join(&exe), &dst_dir.join(&exe));\n             }\n \n+            // Copy over llvm-dwp if it's there\n+            let exe = exe(\"rust-llvm-dwp\", compiler.host);\n+            builder.copy(&src_dir.join(&exe), &dst_dir.join(&exe));\n+\n             // Man pages\n             t!(fs::create_dir_all(image.join(\"share/man/man1\")));\n             let man_src = builder.src.join(\"src/doc/man\");"}]}