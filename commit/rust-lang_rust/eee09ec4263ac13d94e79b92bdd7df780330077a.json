{"sha": "eee09ec4263ac13d94e79b92bdd7df780330077a", "node_id": "C_kwDOAAsO6NoAKGVlZTA5ZWM0MjYzYWMxM2Q5NGU3OWI5MmJkZDdkZjc4MDMzMDA3N2E", "commit": {"author": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2021-12-17T15:27:26Z"}, "committer": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2021-12-17T22:00:03Z"}, "message": "Remove 'speculative evaluation' of predicates\n\nPerforming 'speculative evaluation' introduces caching bugs that\ncannot be fixed without invasive changes to projection.\n\nHopefully, we can win back most of the performance lost by\nre-adding 'cache completion'\n\nFixes #90662", "tree": {"sha": "4cbcfddaad3cf27bc316ae396430689d14719323", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4cbcfddaad3cf27bc316ae396430689d14719323"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/eee09ec4263ac13d94e79b92bdd7df780330077a", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE7J9Gc3TfBwj2K399tAh+UQ6YsWQFAmG9CGkACgkQtAh+UQ6Y\nsWTtMxAAmAmhDQWuafI/UZzC9z3neB1q3R/539yLjEeZLaJLj5KdV425rVQtSaq2\n+F/CE+vBjDIYbg1E30cxVdBA1OnSwTqbLw0+g+KVcfPCDmkMgGPOAP90LSUPfr40\nBXsB+BaVFVxbX7FoTqKQf/sQROycwU3/3HuWFPelbXwhY1fI9kbWzeOpdhfc3sG1\nit74RvxoMWo0Dmz13GlmWJGBx8rPjB77Scnz8M6t/BqzEvyQ2u2hpBRirQGQuH4d\n1OTWzJXdUDHcHn9K5Ble2KCHgxREElOIrCp1fNDYPcvXQEzxQSVAWBarcLdMT5ku\nEq7PZyaHuTpNom7MZwing4qkFq428suD/qMCmz4AukOfyfx0wQUpPwjn4KiRB/st\n5wJdU7HUqhD28ZEMxKYOPMaVoRSulrzGnnkS2ildqbyqQD1c81EHlADsSScYQg8W\nGGWZHWpc4Wq+/ScTtADFBuKvU/+e/WW3uGjJGtiDc9lXjSqwpfhCYvOlWb4Zx7wd\nLiEXcu9SjDkCgzePmP2qiw2KRohE3KJOh7sGVP4s4Mbdv9rQGpcXWAcKTDS57Ccz\nFRcAz9uBLEXNj/5W7irmSZLNO06MeN+cE00mKyC8j4lhefqcsh8OtmQycIq5q5HS\nRsOUnxomstcQ+/c9/5fwQ6KL6K7Q+TQs6adnlIkW3GPAECtj4j4=\n=mY8Y\n-----END PGP SIGNATURE-----", "payload": "tree 4cbcfddaad3cf27bc316ae396430689d14719323\nparent 34dc0d0f249a33fda18755991b4e73ad786d2b19\nauthor Aaron Hill <aa1ronham@gmail.com> 1639754846 -0500\ncommitter Aaron Hill <aa1ronham@gmail.com> 1639778403 -0500\n\nRemove 'speculative evaluation' of predicates\n\nPerforming 'speculative evaluation' introduces caching bugs that\ncannot be fixed without invasive changes to projection.\n\nHopefully, we can win back most of the performance lost by\nre-adding 'cache completion'\n\nFixes #90662\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/eee09ec4263ac13d94e79b92bdd7df780330077a", "html_url": "https://github.com/rust-lang/rust/commit/eee09ec4263ac13d94e79b92bdd7df780330077a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/eee09ec4263ac13d94e79b92bdd7df780330077a/comments", "author": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "34dc0d0f249a33fda18755991b4e73ad786d2b19", "url": "https://api.github.com/repos/rust-lang/rust/commits/34dc0d0f249a33fda18755991b4e73ad786d2b19", "html_url": "https://github.com/rust-lang/rust/commit/34dc0d0f249a33fda18755991b4e73ad786d2b19"}], "stats": {"total": 53, "additions": 35, "deletions": 18}, "files": [{"sha": "35145fed8c427d63264f919f5eb2775e0ed5cd98", "filename": "compiler/rustc_trait_selection/src/traits/project.rs", "status": "modified", "additions": 1, "deletions": 18, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/eee09ec4263ac13d94e79b92bdd7df780330077a/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fproject.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eee09ec4263ac13d94e79b92bdd7df780330077a/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fproject.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fproject.rs?ref=eee09ec4263ac13d94e79b92bdd7df780330077a", "patch": "@@ -10,7 +10,6 @@ use super::PredicateObligation;\n use super::Selection;\n use super::SelectionContext;\n use super::SelectionError;\n-use super::TraitQueryMode;\n use super::{\n     ImplSourceClosureData, ImplSourceDiscriminantKindData, ImplSourceFnPointerData,\n     ImplSourceGeneratorData, ImplSourcePointeeData, ImplSourceUserDefinedData,\n@@ -946,27 +945,11 @@ fn opt_normalize_projection_type<'a, 'b, 'tcx>(\n             };\n \n             let mut deduped: SsoHashSet<_> = Default::default();\n-            let mut canonical =\n-                SelectionContext::with_query_mode(selcx.infcx(), TraitQueryMode::Canonical);\n-\n             result.obligations.drain_filter(|projected_obligation| {\n                 if !deduped.insert(projected_obligation.clone()) {\n                     return true;\n                 }\n-                // If any global obligations always apply, considering regions, then we don't\n-                // need to include them. The `is_global` check rules out inference variables,\n-                // so there's no need for the caller of `opt_normalize_projection_type`\n-                // to evaluate them.\n-                // Note that we do *not* discard obligations that evaluate to\n-                // `EvaluatedtoOkModuloRegions`. Evaluating these obligations\n-                // inside of a query (e.g. `evaluate_obligation`) can change\n-                // the result to `EvaluatedToOkModuloRegions`, while an\n-                // `EvaluatedToOk` obligation will never change the result.\n-                // See #85360 for more details\n-                projected_obligation.is_global(canonical.tcx())\n-                    && canonical\n-                        .evaluate_root_obligation(projected_obligation)\n-                        .map_or(false, |res| res.must_apply_considering_regions())\n+                false\n             });\n \n             if use_cache {"}, {"sha": "879f30071bfdb0e685cd70282079fe887555d5c9", "filename": "src/test/ui/traits/issue-90662-projection-caching.rs", "status": "added", "additions": 34, "deletions": 0, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/eee09ec4263ac13d94e79b92bdd7df780330077a/src%2Ftest%2Fui%2Ftraits%2Fissue-90662-projection-caching.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eee09ec4263ac13d94e79b92bdd7df780330077a/src%2Ftest%2Fui%2Ftraits%2Fissue-90662-projection-caching.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftraits%2Fissue-90662-projection-caching.rs?ref=eee09ec4263ac13d94e79b92bdd7df780330077a", "patch": "@@ -0,0 +1,34 @@\n+// check-pass\n+\n+// Regression test for issue #90662\n+// Tests that projection caching does not cause a spurious error\n+\n+trait HasProvider<T: ?Sized> {}\n+trait Provider<M> {\n+    type Interface: ?Sized;\n+}\n+\n+trait Repository {}\n+trait Service {}\n+\n+struct DbConnection;\n+impl<M> Provider<M> for DbConnection {\n+    type Interface = DbConnection;\n+}\n+\n+struct RepositoryImpl;\n+impl<M: HasProvider<DbConnection>> Provider<M> for RepositoryImpl {\n+    type Interface = dyn Repository;\n+}\n+\n+struct ServiceImpl;\n+impl<M: HasProvider<dyn Repository>> Provider<M> for ServiceImpl {\n+    type Interface = dyn Service;\n+}\n+\n+struct TestModule;\n+impl HasProvider<<DbConnection as Provider<Self>>::Interface> for TestModule {}\n+impl HasProvider<<RepositoryImpl as Provider<Self>>::Interface> for TestModule {}\n+impl HasProvider<<ServiceImpl as Provider<Self>>::Interface> for TestModule {}\n+\n+fn main() {}"}]}