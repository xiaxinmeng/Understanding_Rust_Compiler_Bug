{"sha": "73d5c42076bd9fd1df59965a95963f5d6d62b88c", "node_id": "MDY6Q29tbWl0NzI0NzEyOjczZDVjNDIwNzZiZDlmZDFkZjU5OTY1YTk1OTYzZjVkNmQ2MmI4OGM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-10-11T22:34:57Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-10-11T22:34:57Z"}, "message": "Auto merge of #1580 - Aaron1011:feature/backtrace-fn-ptr, r=RalfJung\n\nAdd an `fn_ptr` field to `MiriFrame`\n\nThe `backtrace-rs` crate can use this to implement\n`Frame::symbol_address`, which is used to skip frames\nabove the call to `Backtrace::capture` on the stack.\n\nThe function pointer will not be useable for comparison purposes if the\nfunction is generic, as CTFE creates a new function pointer for each\ncast of a (monomorphized) generic function. However, this already\naffects code running under Miri, and isn't a problem for `backtrace-rs`\n(which only casts a non-generic function).\n\nI've added logic to allow `MiriFrame` to have either 4 or 5 fields - if\na 5th field is present, we write the function pointer to it.", "tree": {"sha": "fb7c62cc0d59ca0b3f779ed0c40b5c54765671f2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fb7c62cc0d59ca0b3f779ed0c40b5c54765671f2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/73d5c42076bd9fd1df59965a95963f5d6d62b88c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/73d5c42076bd9fd1df59965a95963f5d6d62b88c", "html_url": "https://github.com/rust-lang/rust/commit/73d5c42076bd9fd1df59965a95963f5d6d62b88c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/73d5c42076bd9fd1df59965a95963f5d6d62b88c/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c467345bb0bab892dc66d74d902e4195e4c05ab9", "url": "https://api.github.com/repos/rust-lang/rust/commits/c467345bb0bab892dc66d74d902e4195e4c05ab9", "html_url": "https://github.com/rust-lang/rust/commit/c467345bb0bab892dc66d74d902e4195e4c05ab9"}, {"sha": "c889eba4b27e9b365a8824969aa3deb0525fa0c0", "url": "https://api.github.com/repos/rust-lang/rust/commits/c889eba4b27e9b365a8824969aa3deb0525fa0c0", "html_url": "https://github.com/rust-lang/rust/commit/c889eba4b27e9b365a8824969aa3deb0525fa0c0"}], "stats": {"total": 84, "additions": 57, "deletions": 27}, "files": [{"sha": "ee83a389eee539467caaa0bee0ce4512d0202eb8", "filename": "README.md", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/73d5c42076bd9fd1df59965a95963f5d6d62b88c/README.md", "raw_url": "https://github.com/rust-lang/rust/raw/73d5c42076bd9fd1df59965a95963f5d6d62b88c/README.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/README.md?ref=73d5c42076bd9fd1df59965a95963f5d6d62b88c", "patch": "@@ -292,6 +292,10 @@ extern \"Rust\" {\n     ///     lineno: u32,\n     ///     // The column number currently being executed in `filename`, starting from '1'.\n     ///     colno: u32,\n+    ///     // The function pointer to the function currently being executed.\n+    ///     // This can be compared against function pointers obtained by\n+    ///     // casting a function (e.g. `my_fn as *mut ()`)\n+    ///     fn_ptr: *mut ()\n     /// }\n     /// ```\n     ///"}, {"sha": "8cf7ac207528c98053a0d4b37d6813e1f9f95a1f", "filename": "src/shims/backtrace.rs", "status": "modified", "additions": 19, "deletions": 2, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/73d5c42076bd9fd1df59965a95963f5d6d62b88c/src%2Fshims%2Fbacktrace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/73d5c42076bd9fd1df59965a95963f5d6d62b88c/src%2Fshims%2Fbacktrace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fshims%2Fbacktrace.rs?ref=73d5c42076bd9fd1df59965a95963f5d6d62b88c", "patch": "@@ -92,8 +92,18 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n             throw_ub_format!(\"expected function pointer, found {:?}\", ptr);\n         };\n \n-        if dest.layout.layout.fields.count() != 4 {\n-            throw_ub_format!(\"bad declaration of miri_resolve_frame - should return a struct with 4 fields\");\n+        // Reconstruct the original function pointer,\n+        // which we pass to user code.\n+        let mut fn_ptr = ptr;\n+        fn_ptr.offset = Size::from_bytes(0);\n+        let fn_ptr = Scalar::Ptr(fn_ptr);\n+\n+        let num_fields = dest.layout.layout.fields.count();\n+\n+        if !(4..=5).contains(&num_fields) {\n+            // Always mention 5 fields, since the 4-field struct\n+            // is deprecated and slated for removal.\n+            throw_ub_format!(\"bad declaration of miri_resolve_frame - should return a struct with 5 fields\");\n         }\n \n         let pos = BytePos(ptr.offset.bytes().try_into().unwrap());\n@@ -122,6 +132,13 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n         this.write_immediate(filename_alloc.to_ref(), this.mplace_field(dest, 1)?.into())?;\n         this.write_scalar(lineno_alloc, this.mplace_field(dest, 2)?.into())?;\n         this.write_scalar(colno_alloc, this.mplace_field(dest, 3)?.into())?;\n+\n+        // Support a 4-field struct for now - this is deprecated\n+        // and slated for removal.\n+        if num_fields == 5 {\n+            this.write_scalar(fn_ptr, this.mplace_field(dest, 4)?.into())?;\n+        }\n+\n         Ok(())\n     }\n }"}, {"sha": "23379992d5ecb535b16c32833508deb20c79ec00", "filename": "tests/compile-fail/backtrace/bad-backtrace-decl.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/73d5c42076bd9fd1df59965a95963f5d6d62b88c/tests%2Fcompile-fail%2Fbacktrace%2Fbad-backtrace-decl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/73d5c42076bd9fd1df59965a95963f5d6d62b88c/tests%2Fcompile-fail%2Fbacktrace%2Fbad-backtrace-decl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Fbacktrace%2Fbad-backtrace-decl.rs?ref=73d5c42076bd9fd1df59965a95963f5d6d62b88c", "patch": "@@ -7,7 +7,7 @@ fn main() {\n     let frames = unsafe { miri_get_backtrace(0) };\n     for frame in frames.into_iter() {\n         unsafe {\n-            miri_resolve_frame(*frame, 0); //~ ERROR Undefined Behavior: bad declaration of miri_resolve_frame - should return a struct with 4 fields\n+            miri_resolve_frame(*frame, 0); //~ ERROR Undefined Behavior: bad declaration of miri_resolve_frame - should return a struct with 5 fields\n         }\n     }\n }"}, {"sha": "19169060038e07d5aee763e8febdd61e9790def5", "filename": "tests/run-pass/backtrace-api.rs", "status": "modified", "additions": 23, "deletions": 14, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/73d5c42076bd9fd1df59965a95963f5d6d62b88c/tests%2Frun-pass%2Fbacktrace-api.rs", "raw_url": "https://github.com/rust-lang/rust/raw/73d5c42076bd9fd1df59965a95963f5d6d62b88c/tests%2Frun-pass%2Fbacktrace-api.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-pass%2Fbacktrace-api.rs?ref=73d5c42076bd9fd1df59965a95963f5d6d62b88c", "patch": "@@ -2,20 +2,6 @@\n // normalize-stderr-test \"RUSTLIB/(.*):\\d+:\\d+ \"-> \"RUSTLIB/$1:LL:COL \"\n // normalize-stderr-test \"::<.*>\" -> \"\"\n \n-extern \"Rust\" {\n-    fn miri_get_backtrace(flags: u64) -> Box<[*mut ()]>;\n-    fn miri_resolve_frame(ptr: *mut (), flags: u64) -> MiriFrame;\n-}\n-\n-#[derive(Debug)]\n-#[repr(C)]\n-struct MiriFrame {\n-    name: Box<[u8]>,\n-    filename: Box<[u8]>,\n-    lineno: u32,\n-    colno: u32\n-}\n-\n #[inline(never)] fn func_a() -> Box<[*mut ()]> { func_b::<u8>() }\n #[inline(never)] fn func_b<T>() -> Box<[*mut ()]> { func_c() }\n \n@@ -34,6 +20,10 @@ fn main() {\n         let name = String::from_utf8(miri_frame.name.into()).unwrap();\n         let filename = String::from_utf8(miri_frame.filename.into()).unwrap();\n \n+        if name == \"func_a\" {\n+            assert_eq!(func_a as *mut (), miri_frame.fn_ptr);\n+        }\n+\n         // Print every frame to stderr.\n         let out = format!(\"{}:{}:{} ({})\", filename, miri_frame.lineno, miri_frame.colno, name);\n         eprintln!(\"{}\", out);\n@@ -45,3 +35,22 @@ fn main() {\n         }\n     }\n }\n+\n+// This goes at the bottom of the file so that we can change it\n+// without disturbing line numbers of the functions in the backtrace.\n+\n+extern \"Rust\" {\n+    fn miri_get_backtrace(flags: u64) -> Box<[*mut ()]>;\n+    fn miri_resolve_frame(ptr: *mut (), flags: u64) -> MiriFrame;\n+}\n+\n+#[derive(Debug)]\n+#[repr(C)]\n+struct MiriFrame {\n+    name: Box<[u8]>,\n+    filename: Box<[u8]>,\n+    lineno: u32,\n+    colno: u32,\n+    fn_ptr: *mut (),\n+}\n+"}, {"sha": "a5208221da4053631d61a37648c1affbec88687f", "filename": "tests/run-pass/backtrace-api.stderr", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/73d5c42076bd9fd1df59965a95963f5d6d62b88c/tests%2Frun-pass%2Fbacktrace-api.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/73d5c42076bd9fd1df59965a95963f5d6d62b88c/tests%2Frun-pass%2Fbacktrace-api.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-pass%2Fbacktrace-api.stderr?ref=73d5c42076bd9fd1df59965a95963f5d6d62b88c", "patch": "@@ -1,8 +1,8 @@\n-$DIR/backtrace-api.rs:27:59 (func_d)\n-$DIR/backtrace-api.rs:26:50 (func_c)\n-$DIR/backtrace-api.rs:20:53 (func_b)\n-$DIR/backtrace-api.rs:19:50 (func_a)\n-$DIR/backtrace-api.rs:31:18 (main)\n+$DIR/backtrace-api.rs:13:59 (func_d)\n+$DIR/backtrace-api.rs:12:50 (func_c)\n+$DIR/backtrace-api.rs:6:53 (func_b)\n+$DIR/backtrace-api.rs:5:50 (func_a)\n+$DIR/backtrace-api.rs:17:18 (main)\n RUSTLIB/core/src/ops/function.rs:LL:COL (<fn() as std::ops::FnOnce<()>>::call_once - shim(fn()))\n RUSTLIB/std/src/sys_common/backtrace.rs:LL:COL (std::sys_common::backtrace::__rust_begin_short_backtrace)\n RUSTLIB/std/src/rt.rs:LL:COL (std::rt::lang_start::{closure#0})"}, {"sha": "175ff3b82946194c62ffdf20cf9de0ece53aaa8c", "filename": "tests/run-pass/backtrace-api.stdout", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/73d5c42076bd9fd1df59965a95963f5d6d62b88c/tests%2Frun-pass%2Fbacktrace-api.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/73d5c42076bd9fd1df59965a95963f5d6d62b88c/tests%2Frun-pass%2Fbacktrace-api.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-pass%2Fbacktrace-api.stdout?ref=73d5c42076bd9fd1df59965a95963f5d6d62b88c", "patch": "@@ -1,5 +1,5 @@\n-$DIR/backtrace-api.rs:27:59 (func_d)\n-$DIR/backtrace-api.rs:26:50 (func_c)\n-$DIR/backtrace-api.rs:20:53 (func_b::<u8>)\n-$DIR/backtrace-api.rs:19:50 (func_a)\n-$DIR/backtrace-api.rs:31:18 (main)\n+$DIR/backtrace-api.rs:13:59 (func_d)\n+$DIR/backtrace-api.rs:12:50 (func_c)\n+$DIR/backtrace-api.rs:6:53 (func_b::<u8>)\n+$DIR/backtrace-api.rs:5:50 (func_a)\n+$DIR/backtrace-api.rs:17:18 (main)"}]}