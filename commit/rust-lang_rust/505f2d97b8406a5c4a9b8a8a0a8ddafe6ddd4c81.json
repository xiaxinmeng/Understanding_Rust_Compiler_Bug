{"sha": "505f2d97b8406a5c4a9b8a8a0a8ddafe6ddd4c81", "node_id": "C_kwDOAAsO6NoAKDUwNWYyZDk3Yjg0MDZhNWM0YTliOGE4YTBhOGRkYWZlNmRkZDRjODE", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-05-06T14:12:29Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-05-06T14:12:29Z"}, "message": "Auto merge of #12177 - jonas-schievink:mbe-output-float-literals, r=jonas-schievink\n\nfix: fix macro expansion with float tokens\n\nFixes https://github.com/rust-lang/rust-analyzer/issues/12170\n\nThe parser tells us to consume up to 3 tokens, but on the MBE side all float literals are a single `tt::Literal`, so make sure to only consume a single MBE leaf.", "tree": {"sha": "45337c84c45d8c19601922a060cd6b2e595dec65", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/45337c84c45d8c19601922a060cd6b2e595dec65"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/505f2d97b8406a5c4a9b8a8a0a8ddafe6ddd4c81", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/505f2d97b8406a5c4a9b8a8a0a8ddafe6ddd4c81", "html_url": "https://github.com/rust-lang/rust/commit/505f2d97b8406a5c4a9b8a8a0a8ddafe6ddd4c81", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/505f2d97b8406a5c4a9b8a8a0a8ddafe6ddd4c81/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "10dd471fd1d7006c0abbb8e4f4c8a1e0103ffbe8", "url": "https://api.github.com/repos/rust-lang/rust/commits/10dd471fd1d7006c0abbb8e4f4c8a1e0103ffbe8", "html_url": "https://github.com/rust-lang/rust/commit/10dd471fd1d7006c0abbb8e4f4c8a1e0103ffbe8"}, {"sha": "7db55313a17a488a8e437fbd184290995f04a32d", "url": "https://api.github.com/repos/rust-lang/rust/commits/7db55313a17a488a8e437fbd184290995f04a32d", "html_url": "https://github.com/rust-lang/rust/commit/7db55313a17a488a8e437fbd184290995f04a32d"}], "stats": {"total": 42, "additions": 41, "deletions": 1}, "files": [{"sha": "66cc2843d62e6559dcb9bdde8a8d57377ae36603", "filename": "crates/hir-def/src/macro_expansion_tests/mbe/meta_syntax.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/505f2d97b8406a5c4a9b8a8a0a8ddafe6ddd4c81/crates%2Fhir-def%2Fsrc%2Fmacro_expansion_tests%2Fmbe%2Fmeta_syntax.rs", "raw_url": "https://github.com/rust-lang/rust/raw/505f2d97b8406a5c4a9b8a8a0a8ddafe6ddd4c81/crates%2Fhir-def%2Fsrc%2Fmacro_expansion_tests%2Fmbe%2Fmeta_syntax.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-def%2Fsrc%2Fmacro_expansion_tests%2Fmbe%2Fmeta_syntax.rs?ref=505f2d97b8406a5c4a9b8a8a0a8ddafe6ddd4c81", "patch": "@@ -80,7 +80,7 @@ macro_rules! f3 { ($i:_) => () }\n \n #[test]\n fn test_rustc_issue_57597() {\n-    // <https://github.com/rust-lang/rust/blob/master/src/test/ui/issues/issue-57597.rs>\n+    // <https://github.com/rust-lang/rust/blob/master/src/test/ui/macros/issue-57597.rs>\n     check(\n         r#\"\n macro_rules! m0 { ($($($i:ident)?)+) => {}; }"}, {"sha": "0f606f3cfd661d56a1d1a82024a06c7dbd2e5f08", "filename": "crates/hir-def/src/macro_expansion_tests/mbe/tt_conversion.rs", "status": "modified", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/505f2d97b8406a5c4a9b8a8a0a8ddafe6ddd4c81/crates%2Fhir-def%2Fsrc%2Fmacro_expansion_tests%2Fmbe%2Ftt_conversion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/505f2d97b8406a5c4a9b8a8a0a8ddafe6ddd4c81/crates%2Fhir-def%2Fsrc%2Fmacro_expansion_tests%2Fmbe%2Ftt_conversion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-def%2Fsrc%2Fmacro_expansion_tests%2Fmbe%2Ftt_conversion.rs?ref=505f2d97b8406a5c4a9b8a8a0a8ddafe6ddd4c81", "patch": "@@ -38,6 +38,7 @@ macro_rules! m {\n         let _ = 12E+99_f64;\n         let _ = \"rust1\";\n         let _ = -92;\n+        let _ = -1.3e4f32;\n     }\n }\n fn f() {\n@@ -52,6 +53,7 @@ macro_rules! m {\n         let _ = 12E+99_f64;\n         let _ = \"rust1\";\n         let _ = -92;\n+        let _ = -1.3e4f32;\n     }\n }\n fn f() {\n@@ -60,6 +62,7 @@ fn f() {\n     let _ = 12E+99_f64;\n     let _ = \"rust1\";\n     let _ = -92;\n+    let _ = -1.3e4f32;\n }\n \"#]],\n     );\n@@ -148,3 +151,27 @@ $ = ();\n \"#]],\n     )\n }\n+\n+#[test]\n+fn float_literal_in_output() {\n+    check(\n+        r#\"\n+macro_rules! constant {\n+    ($e:expr ;) => {$e};\n+}\n+\n+const _: () = constant!(0.0;);\n+const _: () = constant!(0.;);\n+const _: () = constant!(0e0;);\n+\"#,\n+        expect![[r#\"\n+macro_rules! constant {\n+    ($e:expr ;) => {$e};\n+}\n+\n+const _: () = 0.0;\n+const _: () = 0.;\n+const _: () = 0e0;\n+\"#]],\n+    );\n+}"}, {"sha": "83d22af92325eae3b65be0861499d8e9a4d32a1a", "filename": "crates/mbe/src/syntax_bridge.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/505f2d97b8406a5c4a9b8a8a0a8ddafe6ddd4c81/crates%2Fmbe%2Fsrc%2Fsyntax_bridge.rs", "raw_url": "https://github.com/rust-lang/rust/raw/505f2d97b8406a5c4a9b8a8a0a8ddafe6ddd4c81/crates%2Fmbe%2Fsrc%2Fsyntax_bridge.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fmbe%2Fsrc%2Fsyntax_bridge.rs?ref=505f2d97b8406a5c4a9b8a8a0a8ddafe6ddd4c81", "patch": "@@ -266,11 +266,13 @@ fn convert_tokens<C: TokenConvertor>(conv: &mut C) -> tt::Subtree {\n                     let mut text = token.to_text(conv).to_string();\n                     if kind == FLOAT_NUMBER_START_1 || kind == FLOAT_NUMBER_START_2 {\n                         let (dot, dot_range) = conv.bump().unwrap();\n+                        assert_eq!(dot.kind(conv), DOT);\n                         text += &*dot.to_text(conv);\n                         range = TextRange::new(range.start(), dot_range.end());\n \n                         if kind == FLOAT_NUMBER_START_2 {\n                             let (tail, tail_range) = conv.bump().unwrap();\n+                            assert_eq!(tail.kind(conv), FLOAT_NUMBER_PART);\n                             text += &*tail.to_text(conv);\n                             range = TextRange::new(range.start(), tail_range.end());\n                         }"}, {"sha": "2dbf1f31980c0957384e6409e761f08538551555", "filename": "crates/mbe/src/tt_iter.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/505f2d97b8406a5c4a9b8a8a0a8ddafe6ddd4c81/crates%2Fmbe%2Fsrc%2Ftt_iter.rs", "raw_url": "https://github.com/rust-lang/rust/raw/505f2d97b8406a5c4a9b8a8a0a8ddafe6ddd4c81/crates%2Fmbe%2Fsrc%2Ftt_iter.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fmbe%2Fsrc%2Ftt_iter.rs?ref=505f2d97b8406a5c4a9b8a8a0a8ddafe6ddd4c81", "patch": "@@ -90,9 +90,20 @@ impl<'a> TtIter<'a> {\n \n         let mut cursor = buffer.begin();\n         let mut error = false;\n+        let mut float_fragments_to_skip = 0;\n         for step in tree_traversal.iter() {\n             match step {\n                 parser::Step::Token { kind, mut n_input_tokens } => {\n+                    if float_fragments_to_skip > 0 {\n+                        float_fragments_to_skip -= 1;\n+                        n_input_tokens = 0;\n+                    }\n+                    match kind {\n+                        SyntaxKind::LIFETIME_IDENT => n_input_tokens = 2,\n+                        SyntaxKind::FLOAT_NUMBER_START_1 => float_fragments_to_skip = 1,\n+                        SyntaxKind::FLOAT_NUMBER_START_2 => float_fragments_to_skip = 2,\n+                        _ => {}\n+                    }\n                     if kind == SyntaxKind::LIFETIME_IDENT {\n                         n_input_tokens = 2;\n                     }"}]}