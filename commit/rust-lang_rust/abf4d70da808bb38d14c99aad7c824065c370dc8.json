{"sha": "abf4d70da808bb38d14c99aad7c824065c370dc8", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFiZjRkNzBkYTgwOGJiMzhkMTRjOTlhYWQ3YzgyNDA2NWMzNzBkYzg=", "commit": {"author": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2018-02-23T18:24:45Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2018-02-23T18:24:45Z"}, "message": "Rollup merge of #47933 - Zoxc:plugin-panics, r=nikomatsakis\n\nDo not run the default panic hook inside procedural macros.\n\nFixes #47812\n\nr? @nikomatsakis", "tree": {"sha": "37e56420c8150799b265bd99298f5598f00eda76", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/37e56420c8150799b265bd99298f5598f00eda76"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/abf4d70da808bb38d14c99aad7c824065c370dc8", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJakFxtCRBK7hj4Ov3rIwAAdHIIAJ0cdNsGPGG94yZ4gN19QNpf\nJMkEXJXCjHb/ITbBwlrel6aFClzU0uMQhsDcAnAqKDVhbTrSrzDDy17mCj0OE6R4\nEvD7cAbujmT6YDB3RhqvgGAXihUKW/jV8G97aHj8R7TX1vPBIb3f7pJ/WuEePOgt\nP0G8XrgVPH6EVZoHpOevUGaTXfPh5TQpuw/y8a6QSZYQYWp4lbNYe+2pZn5gYD9K\nug28oDdFGLY7JithaSZvEFzGU+tyeTrqxQYuxslYVT6/7nPkJxuHmashaX3wZDqZ\nccPz68VTjyB3McidRUVhB6tbnT/oL3frjgNzrfRl1H6LDpHhrq1IAOlOwC3bekM=\n=mNPP\n-----END PGP SIGNATURE-----\n", "payload": "tree 37e56420c8150799b265bd99298f5598f00eda76\nparent 063deba92e44809125a433ca6e6c1ad0993313bf\nparent 9d3719bcfa45c977dcfd12a2d5f188652f56bdaf\nauthor Manish Goregaokar <manishsmail@gmail.com> 1519410285 -0800\ncommitter GitHub <noreply@github.com> 1519410285 -0800\n\nRollup merge of #47933 - Zoxc:plugin-panics, r=nikomatsakis\n\nDo not run the default panic hook inside procedural macros.\n\nFixes #47812\n\nr? @nikomatsakis\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/abf4d70da808bb38d14c99aad7c824065c370dc8", "html_url": "https://github.com/rust-lang/rust/commit/abf4d70da808bb38d14c99aad7c824065c370dc8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/abf4d70da808bb38d14c99aad7c824065c370dc8/comments", "author": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "063deba92e44809125a433ca6e6c1ad0993313bf", "url": "https://api.github.com/repos/rust-lang/rust/commits/063deba92e44809125a433ca6e6c1ad0993313bf", "html_url": "https://github.com/rust-lang/rust/commit/063deba92e44809125a433ca6e6c1ad0993313bf"}, {"sha": "9d3719bcfa45c977dcfd12a2d5f188652f56bdaf", "url": "https://api.github.com/repos/rust-lang/rust/commits/9d3719bcfa45c977dcfd12a2d5f188652f56bdaf", "html_url": "https://github.com/rust-lang/rust/commit/9d3719bcfa45c977dcfd12a2d5f188652f56bdaf"}], "stats": {"total": 43, "additions": 40, "deletions": 3}, "files": [{"sha": "8f25820d3a5278a4d5a866b17033bcbccceea5c6", "filename": "src/Cargo.lock", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/abf4d70da808bb38d14c99aad7c824065c370dc8/src%2FCargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/abf4d70da808bb38d14c99aad7c824065c370dc8/src%2FCargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2FCargo.lock?ref=abf4d70da808bb38d14c99aad7c824065c370dc8", "patch": "@@ -1623,7 +1623,9 @@ dependencies = [\n  \"fmt_macros 0.0.0\",\n  \"graphviz 0.0.0\",\n  \"jobserver 0.1.9 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"lazy_static 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"log 0.4.1 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"proc_macro 0.0.0\",\n  \"rustc_apfloat 0.0.0\",\n  \"rustc_back 0.0.0\",\n  \"rustc_const_math 0.0.0\","}, {"sha": "878a536836d23a4450e092fa3505a20c6a706248", "filename": "src/libproc_macro/lib.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/abf4d70da808bb38d14c99aad7c824065c370dc8/src%2Flibproc_macro%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/abf4d70da808bb38d14c99aad7c824065c370dc8/src%2Flibproc_macro%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibproc_macro%2Flib.rs?ref=abf4d70da808bb38d14c99aad7c824065c370dc8", "patch": "@@ -844,6 +844,12 @@ pub mod __internal {\n         })\n     }\n \n+    pub fn in_sess() -> bool\n+    {\n+        let p = CURRENT_SESS.with(|p| p.get());\n+        !p.0.is_null()\n+    }\n+\n     pub fn with_sess<F, R>(f: F) -> R\n         where F: FnOnce((&ParseSess, Mark)) -> R\n     {"}, {"sha": "7e84a69dd7913b99356acd128321d93a0cf5602e", "filename": "src/librustc/Cargo.toml", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/abf4d70da808bb38d14c99aad7c824065c370dc8/src%2Flibrustc%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/abf4d70da808bb38d14c99aad7c824065c370dc8/src%2Flibrustc%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2FCargo.toml?ref=abf4d70da808bb38d14c99aad7c824065c370dc8", "patch": "@@ -14,7 +14,9 @@ bitflags = \"1.0\"\n fmt_macros = { path = \"../libfmt_macros\" }\n graphviz = { path = \"../libgraphviz\" }\n jobserver = \"0.1\"\n+lazy_static = \"1.0.0\"\n log = { version = \"0.4\", features = [\"release_max_level_info\", \"std\"] }\n+proc_macro = { path = \"../libproc_macro\" }\n rustc_apfloat = { path = \"../librustc_apfloat\" }\n rustc_back = { path = \"../librustc_back\" }\n rustc_const_math = { path = \"../librustc_const_math\" }"}, {"sha": "2e7bf4d001d267259a09996c6492f337fcb7ba7a", "filename": "src/librustc/lib.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/abf4d70da808bb38d14c99aad7c824065c370dc8/src%2Flibrustc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/abf4d70da808bb38d14c99aad7c824065c370dc8/src%2Flibrustc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Flib.rs?ref=abf4d70da808bb38d14c99aad7c824065c370dc8", "patch": "@@ -60,6 +60,7 @@\n #![feature(never_type)]\n #![feature(non_exhaustive)]\n #![feature(nonzero)]\n+#![feature(proc_macro_internals)]\n #![feature(quote)]\n #![feature(refcell_replace_swap)]\n #![feature(rustc_diagnostic_macros)]\n@@ -81,6 +82,7 @@ extern crate core;\n extern crate fmt_macros;\n extern crate getopts;\n extern crate graphviz;\n+#[macro_use] extern crate lazy_static;\n #[cfg(windows)]\n extern crate libc;\n extern crate rustc_back;\n@@ -92,6 +94,7 @@ extern crate rustc_errors as errors;\n #[macro_use] extern crate syntax;\n extern crate syntax_pos;\n extern crate jobserver;\n+extern crate proc_macro;\n \n extern crate serialize as rustc_serialize; // used by deriving\n "}, {"sha": "55e9a98e7ef1329e4b12cf397699ebc46dc8b4c1", "filename": "src/librustc/util/common.rs", "status": "modified", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/abf4d70da808bb38d14c99aad7c824065c370dc8/src%2Flibrustc%2Futil%2Fcommon.rs", "raw_url": "https://github.com/rust-lang/rust/raw/abf4d70da808bb38d14c99aad7c824065c370dc8/src%2Flibrustc%2Futil%2Fcommon.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Futil%2Fcommon.rs?ref=abf4d70da808bb38d14c99aad7c824065c370dc8", "patch": "@@ -16,13 +16,16 @@ use std::ffi::CString;\n use std::fmt::Debug;\n use std::hash::{Hash, BuildHasher};\n use std::iter::repeat;\n+use std::panic;\n use std::path::Path;\n use std::time::{Duration, Instant};\n \n use std::sync::mpsc::{Sender};\n use syntax_pos::{SpanData};\n use ty::maps::{QueryMsg};\n use dep_graph::{DepNode};\n+use proc_macro;\n+use lazy_static;\n \n // The name of the associated type for `Fn` return types\n pub const FN_OUTPUT_NAME: &'static str = \"Output\";\n@@ -34,6 +37,24 @@ pub struct ErrorReported;\n \n thread_local!(static TIME_DEPTH: Cell<usize> = Cell::new(0));\n \n+lazy_static! {\n+    static ref DEFAULT_HOOK: Box<Fn(&panic::PanicInfo) + Sync + Send + 'static> = {\n+        let hook = panic::take_hook();\n+        panic::set_hook(Box::new(panic_hook));\n+        hook\n+    };\n+}\n+\n+fn panic_hook(info: &panic::PanicInfo) {\n+    if !proc_macro::__internal::in_sess() {\n+        (*DEFAULT_HOOK)(info)\n+    }\n+}\n+\n+pub fn install_panic_hook() {\n+    lazy_static::initialize(&DEFAULT_HOOK);\n+}\n+\n /// Initialized for -Z profile-queries\n thread_local!(static PROFQ_CHAN: RefCell<Option<Sender<ProfileQueriesMsg>>> = RefCell::new(None));\n "}, {"sha": "eb67c9ce4b7d8be2e614f59df1ff71bb87823e11", "filename": "src/librustc_driver/driver.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/abf4d70da808bb38d14c99aad7c824065c370dc8/src%2Flibrustc_driver%2Fdriver.rs", "raw_url": "https://github.com/rust-lang/rust/raw/abf4d70da808bb38d14c99aad7c824065c370dc8/src%2Flibrustc_driver%2Fdriver.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Fdriver.rs?ref=abf4d70da808bb38d14c99aad7c824065c370dc8", "patch": "@@ -24,7 +24,7 @@ use rustc::middle::cstore::CrateStore;\n use rustc::middle::privacy::AccessLevels;\n use rustc::ty::{self, TyCtxt, Resolutions, AllArenas};\n use rustc::traits;\n-use rustc::util::common::{ErrorReported, time};\n+use rustc::util::common::{ErrorReported, time, install_panic_hook};\n use rustc_allocator as allocator;\n use rustc_borrowck as borrowck;\n use rustc_incremental;\n@@ -123,6 +123,8 @@ pub fn compile_input(trans: Box<TransCrate>,\n         let outputs = build_output_filenames(input, outdir, output, &krate.attrs, sess);\n         let crate_name =\n             ::rustc_trans_utils::link::find_crate_name(Some(sess), &krate.attrs, input);\n+        install_panic_hook();\n+\n         let ExpansionResult { expanded_crate, defs, analysis, resolutions, mut hir_forest } = {\n             phase_2_configure_and_expand(\n                 sess,"}, {"sha": "462eaf0341704a66987eb650cb621df47f5acaf0", "filename": "src/test/ui-fulldeps/proc-macro/load-panic.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/abf4d70da808bb38d14c99aad7c824065c370dc8/src%2Ftest%2Fui-fulldeps%2Fproc-macro%2Fload-panic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/abf4d70da808bb38d14c99aad7c824065c370dc8/src%2Ftest%2Fui-fulldeps%2Fproc-macro%2Fload-panic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui-fulldeps%2Fproc-macro%2Fload-panic.rs?ref=abf4d70da808bb38d14c99aad7c824065c370dc8", "patch": "@@ -9,6 +9,7 @@\n // except according to those terms.\n \n // aux-build:derive-panic.rs\n+// compile-flags:--error-format human\n \n #[macro_use]\n extern crate derive_panic;"}, {"sha": "ab2ab84315a9390a84ecd646fe430c901568b876", "filename": "src/test/ui-fulldeps/proc-macro/load-panic.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/abf4d70da808bb38d14c99aad7c824065c370dc8/src%2Ftest%2Fui-fulldeps%2Fproc-macro%2Fload-panic.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/abf4d70da808bb38d14c99aad7c824065c370dc8/src%2Ftest%2Fui-fulldeps%2Fproc-macro%2Fload-panic.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui-fulldeps%2Fproc-macro%2Fload-panic.stderr?ref=abf4d70da808bb38d14c99aad7c824065c370dc8", "patch": "@@ -1,7 +1,7 @@\n error: proc-macro derive panicked\n-  --> $DIR/load-panic.rs:16:10\n+  --> $DIR/load-panic.rs:17:10\n    |\n-16 | #[derive(A)]\n+17 | #[derive(A)]\n    |          ^\n    |\n    = help: message: nope!"}]}