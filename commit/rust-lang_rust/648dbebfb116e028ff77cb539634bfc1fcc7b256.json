{"sha": "648dbebfb116e028ff77cb539634bfc1fcc7b256", "node_id": "C_kwDOAAsO6NoAKDY0OGRiZWJmYjExNmUwMjhmZjc3Y2I1Mzk2MzRiZmMxZmNjN2IyNTY", "commit": {"author": {"name": "Jason Newcomb", "email": "jsnewcomb@pm.me", "date": "2022-06-05T00:21:56Z"}, "committer": {"name": "Jason Newcomb", "email": "jsnewcomb@pm.me", "date": "2022-06-05T00:35:41Z"}, "message": "Actually get the correct `ParamEnv` in `derive_partial_eq_without_eq`", "tree": {"sha": "ade4f7c592beeb091c13f7fcb6960ea2eeb58924", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ade4f7c592beeb091c13f7fcb6960ea2eeb58924"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/648dbebfb116e028ff77cb539634bfc1fcc7b256", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/648dbebfb116e028ff77cb539634bfc1fcc7b256", "html_url": "https://github.com/rust-lang/rust/commit/648dbebfb116e028ff77cb539634bfc1fcc7b256", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/648dbebfb116e028ff77cb539634bfc1fcc7b256/comments", "author": {"login": "Jarcho", "id": 7761774, "node_id": "MDQ6VXNlcjc3NjE3NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/7761774?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Jarcho", "html_url": "https://github.com/Jarcho", "followers_url": "https://api.github.com/users/Jarcho/followers", "following_url": "https://api.github.com/users/Jarcho/following{/other_user}", "gists_url": "https://api.github.com/users/Jarcho/gists{/gist_id}", "starred_url": "https://api.github.com/users/Jarcho/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Jarcho/subscriptions", "organizations_url": "https://api.github.com/users/Jarcho/orgs", "repos_url": "https://api.github.com/users/Jarcho/repos", "events_url": "https://api.github.com/users/Jarcho/events{/privacy}", "received_events_url": "https://api.github.com/users/Jarcho/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Jarcho", "id": 7761774, "node_id": "MDQ6VXNlcjc3NjE3NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/7761774?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Jarcho", "html_url": "https://github.com/Jarcho", "followers_url": "https://api.github.com/users/Jarcho/followers", "following_url": "https://api.github.com/users/Jarcho/following{/other_user}", "gists_url": "https://api.github.com/users/Jarcho/gists{/gist_id}", "starred_url": "https://api.github.com/users/Jarcho/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Jarcho/subscriptions", "organizations_url": "https://api.github.com/users/Jarcho/orgs", "repos_url": "https://api.github.com/users/Jarcho/repos", "events_url": "https://api.github.com/users/Jarcho/events{/privacy}", "received_events_url": "https://api.github.com/users/Jarcho/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a0821fbd756147a2018aed5ed2deb16ba481cd59", "url": "https://api.github.com/repos/rust-lang/rust/commits/a0821fbd756147a2018aed5ed2deb16ba481cd59", "html_url": "https://github.com/rust-lang/rust/commit/a0821fbd756147a2018aed5ed2deb16ba481cd59"}], "stats": {"total": 112, "additions": 66, "deletions": 46}, "files": [{"sha": "28f218a8e344f1228585e75829795a9683580018", "filename": "clippy_lints/src/derive.rs", "status": "modified", "additions": 51, "deletions": 43, "changes": 94, "blob_url": "https://github.com/rust-lang/rust/blob/648dbebfb116e028ff77cb539634bfc1fcc7b256/clippy_lints%2Fsrc%2Fderive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/648dbebfb116e028ff77cb539634bfc1fcc7b256/clippy_lints%2Fsrc%2Fderive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fderive.rs?ref=648dbebfb116e028ff77cb539634bfc1fcc7b256", "patch": "@@ -4,15 +4,18 @@ use clippy_utils::ty::{implements_trait, implements_trait_with_env, is_copy};\n use clippy_utils::{is_lint_allowed, match_def_path};\n use if_chain::if_chain;\n use rustc_errors::Applicability;\n+use rustc_hir::def_id::DefId;\n use rustc_hir::intravisit::{walk_expr, walk_fn, walk_item, FnKind, Visitor};\n use rustc_hir::{\n-    self as hir, BlockCheckMode, BodyId, Expr, ExprKind, FnDecl, HirId, Impl, Item, ItemKind, UnsafeSource, Unsafety,\n+    self as hir, BlockCheckMode, BodyId, Constness, Expr, ExprKind, FnDecl, HirId, Impl, Item, ItemKind, UnsafeSource,\n+    Unsafety,\n };\n use rustc_lint::{LateContext, LateLintPass};\n use rustc_middle::hir::nested_filter;\n-use rustc_middle::ty::subst::GenericArg;\n+use rustc_middle::traits::Reveal;\n use rustc_middle::ty::{\n-    self, BoundConstness, ImplPolarity, ParamEnv, PredicateKind, TraitPredicate, TraitRef, Ty, Visibility,\n+    self, Binder, BoundConstness, GenericParamDefKind, ImplPolarity, ParamEnv, PredicateKind, TraitPredicate, TraitRef,\n+    Ty, TyCtxt, Visibility,\n };\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n use rustc_span::source_map::Span;\n@@ -463,49 +466,16 @@ fn check_partial_eq_without_eq<'tcx>(cx: &LateContext<'tcx>, span: Span, trait_r\n         if let ty::Adt(adt, substs) = ty.kind();\n         if cx.tcx.visibility(adt.did()) == Visibility::Public;\n         if let Some(eq_trait_def_id) = cx.tcx.get_diagnostic_item(sym::Eq);\n-        if let Some(peq_trait_def_id) = cx.tcx.get_diagnostic_item(sym::PartialEq);\n         if let Some(def_id) = trait_ref.trait_def_id();\n         if cx.tcx.is_diagnostic_item(sym::PartialEq, def_id);\n-        // New `ParamEnv` replacing `T: PartialEq` with `T: Eq`\n-        let param_env = ParamEnv::new(\n-            cx.tcx.mk_predicates(cx.param_env.caller_bounds().iter().map(|p| {\n-                let kind = p.kind();\n-                match kind.skip_binder() {\n-                    PredicateKind::Trait(p)\n-                        if p.trait_ref.def_id == peq_trait_def_id\n-                            && p.trait_ref.substs.get(0) == p.trait_ref.substs.get(1)\n-                            && matches!(p.trait_ref.self_ty().kind(), ty::Param(_))\n-                            && p.constness == BoundConstness::NotConst\n-                            && p.polarity == ImplPolarity::Positive =>\n-                    {\n-                        cx.tcx.mk_predicate(kind.rebind(PredicateKind::Trait(TraitPredicate {\n-                            trait_ref: TraitRef::new(\n-                                eq_trait_def_id,\n-                                cx.tcx.mk_substs([GenericArg::from(p.trait_ref.self_ty())].into_iter()),\n-                            ),\n-                            constness: BoundConstness::NotConst,\n-                            polarity: ImplPolarity::Positive,\n-                        })))\n-                    },\n-                    _ => p,\n-                }\n-            })),\n-            cx.param_env.reveal(),\n-            cx.param_env.constness(),\n-        );\n-        if !implements_trait_with_env(cx.tcx, param_env, ty, eq_trait_def_id, substs);\n+        let param_env = param_env_for_derived_eq(cx.tcx, adt.did(), eq_trait_def_id);\n+        if !implements_trait_with_env(cx.tcx, param_env, ty, eq_trait_def_id, &[]);\n+        // If all of our fields implement `Eq`, we can implement `Eq` too\n+        if adt\n+            .all_fields()\n+            .map(|f| f.ty(cx.tcx, substs))\n+            .all(|ty| implements_trait_with_env(cx.tcx, param_env, ty, eq_trait_def_id, &[]));\n         then {\n-            // If all of our fields implement `Eq`, we can implement `Eq` too\n-            for variant in adt.variants() {\n-                for field in &variant.fields {\n-                    let ty = field.ty(cx.tcx, substs);\n-\n-                    if !implements_trait(cx, ty, eq_trait_def_id, substs) {\n-                        return;\n-                    }\n-                }\n-            }\n-\n             span_lint_and_sugg(\n                 cx,\n                 DERIVE_PARTIAL_EQ_WITHOUT_EQ,\n@@ -518,3 +488,41 @@ fn check_partial_eq_without_eq<'tcx>(cx: &LateContext<'tcx>, span: Span, trait_r\n         }\n     }\n }\n+\n+/// Creates the `ParamEnv` used for the give type's derived `Eq` impl.\n+fn param_env_for_derived_eq(tcx: TyCtxt<'_>, did: DefId, eq_trait_id: DefId) -> ParamEnv<'_> {\n+    // Initial map from generic index to param def.\n+    // Vec<(param_def, needs_eq)>\n+    let mut params = tcx\n+        .generics_of(did)\n+        .params\n+        .iter()\n+        .map(|p| (p, matches!(p.kind, GenericParamDefKind::Type { .. })))\n+        .collect::<Vec<_>>();\n+\n+    let ty_predicates = tcx.predicates_of(did).predicates;\n+    for (p, _) in ty_predicates {\n+        if let PredicateKind::Trait(p) = p.kind().skip_binder()\n+            && p.trait_ref.def_id == eq_trait_id\n+            && let ty::Param(self_ty) = p.trait_ref.self_ty().kind()\n+            && p.constness == BoundConstness::NotConst\n+        {\n+            // Flag types which already have an `Eq` bound.\n+            params[self_ty.index as usize].1 = false;\n+        }\n+    }\n+\n+    ParamEnv::new(\n+        tcx.mk_predicates(ty_predicates.iter().map(|&(p, _)| p).chain(\n+            params.iter().filter(|&&(_, needs_eq)| needs_eq).map(|&(param, _)| {\n+                tcx.mk_predicate(Binder::dummy(PredicateKind::Trait(TraitPredicate {\n+                    trait_ref: TraitRef::new(eq_trait_id, tcx.mk_substs([tcx.mk_param_from_def(param)].into_iter())),\n+                    constness: BoundConstness::NotConst,\n+                    polarity: ImplPolarity::Positive,\n+                })))\n+            }),\n+        )),\n+        Reveal::UserFacing,\n+        Constness::NotConst,\n+    )\n+}"}, {"sha": "bbbe467590f91ae9f5530c87fe734761ab5599ad", "filename": "tests/ui/derive_partial_eq_without_eq.fixed", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/648dbebfb116e028ff77cb539634bfc1fcc7b256/tests%2Fui%2Fderive_partial_eq_without_eq.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/648dbebfb116e028ff77cb539634bfc1fcc7b256/tests%2Fui%2Fderive_partial_eq_without_eq.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fderive_partial_eq_without_eq.fixed?ref=648dbebfb116e028ff77cb539634bfc1fcc7b256", "patch": "@@ -52,7 +52,7 @@ impl PartialEq for ManualPartialEqImpl {\n }\n \n // Generic fields should be properly checked for Eq-ness\n-#[derive(PartialEq)]\n+#[derive(PartialEq, Eq)]\n pub struct GenericNotEq<T: Eq, U: PartialEq> {\n     foo: T,\n     bar: U,\n@@ -95,7 +95,7 @@ pub enum EnumNotEq {\n #[derive(Debug, PartialEq, Eq, Clone)]\n pub struct RustFixWithOtherDerives;\n \n-#[derive(PartialEq)]\n+#[derive(PartialEq, Eq)]\n pub struct Generic<T>(T);\n \n #[derive(PartialEq, Eq)]"}, {"sha": "794c5dab8445bb1f11a91f5cdd6f0d4f56fc5237", "filename": "tests/ui/derive_partial_eq_without_eq.stderr", "status": "modified", "additions": 13, "deletions": 1, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/648dbebfb116e028ff77cb539634bfc1fcc7b256/tests%2Fui%2Fderive_partial_eq_without_eq.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/648dbebfb116e028ff77cb539634bfc1fcc7b256/tests%2Fui%2Fderive_partial_eq_without_eq.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fderive_partial_eq_without_eq.stderr?ref=648dbebfb116e028ff77cb539634bfc1fcc7b256", "patch": "@@ -6,6 +6,12 @@ LL | #[derive(Debug, PartialEq)]\n    |\n    = note: `-D clippy::derive-partial-eq-without-eq` implied by `-D warnings`\n \n+error: you are deriving `PartialEq` and can implement `Eq`\n+  --> $DIR/derive_partial_eq_without_eq.rs:55:10\n+   |\n+LL | #[derive(PartialEq)]\n+   |          ^^^^^^^^^ help: consider deriving `Eq` as well: `PartialEq, Eq`\n+\n error: you are deriving `PartialEq` and can implement `Eq`\n   --> $DIR/derive_partial_eq_without_eq.rs:61:10\n    |\n@@ -42,6 +48,12 @@ error: you are deriving `PartialEq` and can implement `Eq`\n LL | #[derive(Debug, PartialEq, Clone)]\n    |                 ^^^^^^^^^ help: consider deriving `Eq` as well: `PartialEq, Eq`\n \n+error: you are deriving `PartialEq` and can implement `Eq`\n+  --> $DIR/derive_partial_eq_without_eq.rs:98:10\n+   |\n+LL | #[derive(PartialEq)]\n+   |          ^^^^^^^^^ help: consider deriving `Eq` as well: `PartialEq, Eq`\n+\n error: you are deriving `PartialEq` and can implement `Eq`\n   --> $DIR/derive_partial_eq_without_eq.rs:105:14\n    |\n@@ -54,5 +66,5 @@ error: you are deriving `PartialEq` and can implement `Eq`\n LL |     #[derive(PartialEq)]\n    |              ^^^^^^^^^ help: consider deriving `Eq` as well: `PartialEq, Eq`\n \n-error: aborting due to 9 previous errors\n+error: aborting due to 11 previous errors\n "}]}