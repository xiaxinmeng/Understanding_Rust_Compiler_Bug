{"sha": "70d2372adaf48bb24f8b829417229149bd103e4a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjcwZDIzNzJhZGFmNDhiYjI0ZjhiODI5NDE3MjI5MTQ5YmQxMDNlNGE=", "commit": {"author": {"name": "Aidan Hobson Sayers", "email": "aidanhs@cantab.net", "date": "2017-01-15T22:33:58Z"}, "committer": {"name": "Aidan Hobson Sayers", "email": "aidanhs@cantab.net", "date": "2017-01-16T03:06:45Z"}, "message": "Expose a feature to force use of alloc_system, teach rustbuild\n\nThis fixes jemalloc-less local rebuilds, where we tell cargo that\nwe're actually stage1", "tree": {"sha": "771726183f4b644dda75df603c7f2c5c710144b7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/771726183f4b644dda75df603c7f2c5c710144b7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/70d2372adaf48bb24f8b829417229149bd103e4a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/70d2372adaf48bb24f8b829417229149bd103e4a", "html_url": "https://github.com/rust-lang/rust/commit/70d2372adaf48bb24f8b829417229149bd103e4a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/70d2372adaf48bb24f8b829417229149bd103e4a/comments", "author": {"login": "aidanhs", "id": 1050652, "node_id": "MDQ6VXNlcjEwNTA2NTI=", "avatar_url": "https://avatars.githubusercontent.com/u/1050652?v=4", "gravatar_id": "", "url": "https://api.github.com/users/aidanhs", "html_url": "https://github.com/aidanhs", "followers_url": "https://api.github.com/users/aidanhs/followers", "following_url": "https://api.github.com/users/aidanhs/following{/other_user}", "gists_url": "https://api.github.com/users/aidanhs/gists{/gist_id}", "starred_url": "https://api.github.com/users/aidanhs/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/aidanhs/subscriptions", "organizations_url": "https://api.github.com/users/aidanhs/orgs", "repos_url": "https://api.github.com/users/aidanhs/repos", "events_url": "https://api.github.com/users/aidanhs/events{/privacy}", "received_events_url": "https://api.github.com/users/aidanhs/received_events", "type": "User", "site_admin": false}, "committer": {"login": "aidanhs", "id": 1050652, "node_id": "MDQ6VXNlcjEwNTA2NTI=", "avatar_url": "https://avatars.githubusercontent.com/u/1050652?v=4", "gravatar_id": "", "url": "https://api.github.com/users/aidanhs", "html_url": "https://github.com/aidanhs", "followers_url": "https://api.github.com/users/aidanhs/followers", "following_url": "https://api.github.com/users/aidanhs/following{/other_user}", "gists_url": "https://api.github.com/users/aidanhs/gists{/gist_id}", "starred_url": "https://api.github.com/users/aidanhs/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/aidanhs/subscriptions", "organizations_url": "https://api.github.com/users/aidanhs/orgs", "repos_url": "https://api.github.com/users/aidanhs/repos", "events_url": "https://api.github.com/users/aidanhs/events{/privacy}", "received_events_url": "https://api.github.com/users/aidanhs/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b0c52c587fe9ba287053359fff5ed886b7edb27c", "url": "https://api.github.com/repos/rust-lang/rust/commits/b0c52c587fe9ba287053359fff5ed886b7edb27c", "html_url": "https://github.com/rust-lang/rust/commit/b0c52c587fe9ba287053359fff5ed886b7edb27c"}], "stats": {"total": 22, "additions": 17, "deletions": 5}, "files": [{"sha": "2464c9782780631bb0e4886ffd6ff930a88cb9d1", "filename": "src/bootstrap/compile.rs", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/70d2372adaf48bb24f8b829417229149bd103e4a/src%2Fbootstrap%2Fcompile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/70d2372adaf48bb24f8b829417229149bd103e4a/src%2Fbootstrap%2Fcompile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcompile.rs?ref=70d2372adaf48bb24f8b829417229149bd103e4a", "patch": "@@ -42,7 +42,16 @@ pub fn std(build: &Build, target: &str, compiler: &Compiler) {\n     let out_dir = build.cargo_out(compiler, Mode::Libstd, target);\n     build.clear_if_dirty(&out_dir, &build.compiler_path(compiler));\n     let mut cargo = build.cargo(compiler, Mode::Libstd, target, \"build\");\n-    cargo.arg(\"--features\").arg(build.std_features())\n+    let mut features = build.std_features();\n+    // When doing a local rebuild we tell cargo that we're stage1 rather than\n+    // stage0. This works fine if the local rust and being-built rust have the\n+    // same view of what the default allocator is, but fails otherwise. Since\n+    // we don't have a way to express an allocator preference yet, work\n+    // around the issue in the case of a local rebuild with jemalloc disabled.\n+    if compiler.stage == 0 && build.local_rebuild && !build.config.use_jemalloc {\n+        features.push_str(\" force_alloc_system\");\n+    }\n+    cargo.arg(\"--features\").arg(features)\n          .arg(\"--manifest-path\")\n          .arg(build.src.join(\"src/rustc/std_shim/Cargo.toml\"));\n "}, {"sha": "8146e7fb1edaf4a5b0a413d781a06dbd7d7b943b", "filename": "src/libstd/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/70d2372adaf48bb24f8b829417229149bd103e4a/src%2Flibstd%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/70d2372adaf48bb24f8b829417229149bd103e4a/src%2Flibstd%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2FCargo.toml?ref=70d2372adaf48bb24f8b829417229149bd103e4a", "patch": "@@ -31,4 +31,5 @@ gcc = \"0.3.27\"\n backtrace = []\n debug-jemalloc = [\"alloc_jemalloc/debug\"]\n jemalloc = [\"alloc_jemalloc\"]\n+force_alloc_system = []\n panic-unwind = [\"panic_unwind\"]"}, {"sha": "37632ac76f2dbab5c2e04793a892f7aad619fd9c", "filename": "src/libstd/lib.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/70d2372adaf48bb24f8b829417229149bd103e4a/src%2Flibstd%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/70d2372adaf48bb24f8b829417229149bd103e4a/src%2Flibstd%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Flib.rs?ref=70d2372adaf48bb24f8b829417229149bd103e4a", "patch": "@@ -219,9 +219,10 @@\n // Tell the compiler to link to either panic_abort or panic_unwind\n #![needs_panic_runtime]\n \n-// Always use alloc_system during stage0 since jemalloc might be unavailable or\n-// disabled (Issue #30592)\n-#![cfg_attr(stage0, feature(alloc_system))]\n+// Always use alloc_system during stage0 since we don't know if the alloc_*\n+// crate the stage0 compiler will pick by default is available (most\n+// obviously, if the user has disabled jemalloc in `./configure`).\n+#![cfg_attr(any(stage0, feature = \"force_alloc_system\"), feature(alloc_system))]\n \n // Turn warnings into errors, but only after stage0, where it can be useful for\n // code to emit warnings during language transitions\n@@ -333,7 +334,7 @@ extern crate libc;\n // We always need an unwinder currently for backtraces\n extern crate unwind;\n \n-#[cfg(stage0)]\n+#[cfg(any(stage0, feature = \"force_alloc_system\"))]\n extern crate alloc_system;\n \n // compiler-rt intrinsics"}, {"sha": "7260a8440734d9ea0f64a47167d06126dc76160d", "filename": "src/rustc/std_shim/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/70d2372adaf48bb24f8b829417229149bd103e4a/src%2Frustc%2Fstd_shim%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/70d2372adaf48bb24f8b829417229149bd103e4a/src%2Frustc%2Fstd_shim%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustc%2Fstd_shim%2FCargo.toml?ref=70d2372adaf48bb24f8b829417229149bd103e4a", "patch": "@@ -38,4 +38,5 @@ core = { path = \"../../libcore\" }\n backtrace = [\"std/backtrace\"]\n debug-jemalloc = [\"std/debug-jemalloc\"]\n jemalloc = [\"std/jemalloc\"]\n+force_alloc_system = [\"std/force_alloc_system\"]\n panic-unwind = [\"std/panic-unwind\"]"}]}