{"sha": "c8623461a57e7882ac47b5da13a1a03efa58f603", "node_id": "MDY6Q29tbWl0NzI0NzEyOmM4NjIzNDYxYTU3ZTc4ODJhYzQ3YjVkYTEzYTFhMDNlZmE1OGY2MDM=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-09-11T21:11:59Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-09-11T21:11:59Z"}, "message": "Merge #5981\n\n5981: Properly preserve macro braces during dbg! removal r=jonas-schievink a=SomeoneToIgnore\n\nDo `dbg![2 + 2] * 5` -> `(2 + 2) * 5`\r\n\r\nThis PR also implicitly handles the `{}` case too, but I decided not to add it into the test case since it's a compiler error on the latest stable rustc.\n\nCo-authored-by: Kirill Bulatov <mail4score@gmail.com>", "tree": {"sha": "5559fe8ce90fff8f0e5ed9debf67a0c7306f668a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5559fe8ce90fff8f0e5ed9debf67a0c7306f668a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c8623461a57e7882ac47b5da13a1a03efa58f603", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfW+gfCRBK7hj4Ov3rIwAAdHIIAJ3WOggnXmMMX7IAiI10tv9q\nrkj58tRDHOKO1lQ5HJcXTOZy5uDfnPBtRqlrQhEe7He9+toN9cxkw5L6ZssxLHag\nRl08gkVVYNp4nkE6M1WTSJ0QdQXN1B5AbSsEiFBJqLjVv8ar7EEotGKJvmFlNeAq\nllc3KusI++pbI4VPmkOmUI/OGm8hPm84zDO/rLapr0oBI0suQWciz3jWrrPDGvS3\npeEW47B+olVHAqZ+bXx8LQHsky7GMjedCZYu8Td7Lg9YhJS03I+ROK7Dy8TIvVoH\nYfEmWh+KJnffGVzj2ThTTkVqbFZbFJ53BA+BfKXVh7ym3LQ90UTbzUVz5EJSvbY=\n=FRSc\n-----END PGP SIGNATURE-----\n", "payload": "tree 5559fe8ce90fff8f0e5ed9debf67a0c7306f668a\nparent 199ebf110353da2da4d706f72adede96149ba977\nparent 779ea2ea0a0aa70075d28d72dd96c1bc1e709300\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1599858719 +0000\ncommitter GitHub <noreply@github.com> 1599858719 +0000\n\nMerge #5981\n\n5981: Properly preserve macro braces during dbg! removal r=jonas-schievink a=SomeoneToIgnore\n\nDo `dbg![2 + 2] * 5` -> `(2 + 2) * 5`\r\n\r\nThis PR also implicitly handles the `{}` case too, but I decided not to add it into the test case since it's a compiler error on the latest stable rustc.\n\nCo-authored-by: Kirill Bulatov <mail4score@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c8623461a57e7882ac47b5da13a1a03efa58f603", "html_url": "https://github.com/rust-lang/rust/commit/c8623461a57e7882ac47b5da13a1a03efa58f603", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c8623461a57e7882ac47b5da13a1a03efa58f603/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "199ebf110353da2da4d706f72adede96149ba977", "url": "https://api.github.com/repos/rust-lang/rust/commits/199ebf110353da2da4d706f72adede96149ba977", "html_url": "https://github.com/rust-lang/rust/commit/199ebf110353da2da4d706f72adede96149ba977"}, {"sha": "779ea2ea0a0aa70075d28d72dd96c1bc1e709300", "url": "https://api.github.com/repos/rust-lang/rust/commits/779ea2ea0a0aa70075d28d72dd96c1bc1e709300", "html_url": "https://github.com/rust-lang/rust/commit/779ea2ea0a0aa70075d28d72dd96c1bc1e709300"}], "stats": {"total": 41, "additions": 16, "deletions": 25}, "files": [{"sha": "a8ab2aecc405b95f016c0687c0dbfa97d98b9b60", "filename": "crates/assists/src/handlers/remove_dbg.rs", "status": "modified", "additions": 16, "deletions": 25, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/c8623461a57e7882ac47b5da13a1a03efa58f603/crates%2Fassists%2Fsrc%2Fhandlers%2Fremove_dbg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c8623461a57e7882ac47b5da13a1a03efa58f603/crates%2Fassists%2Fsrc%2Fhandlers%2Fremove_dbg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fassists%2Fsrc%2Fhandlers%2Fremove_dbg.rs?ref=c8623461a57e7882ac47b5da13a1a03efa58f603", "patch": "@@ -43,15 +43,18 @@ pub(crate) fn remove_dbg(acc: &mut Assists, ctx: &AssistContext) -> Option<()> {\n \n fn adjusted_macro_contents(macro_call: &ast::MacroCall) -> Option<String> {\n     let contents = get_valid_macrocall_contents(&macro_call, \"dbg\")?;\n-    let is_leaf = macro_call.syntax().next_sibling().is_none();\n     let macro_text_with_brackets = macro_call.token_tree()?.syntax().text();\n-    let slice_index = if is_leaf || !needs_parentheses_around_macro_contents(contents) {\n-        TextRange::new(TextSize::of('('), macro_text_with_brackets.len() - TextSize::of(')'))\n+    let macro_text_in_brackets = macro_text_with_brackets.slice(TextRange::new(\n+        TextSize::of('('),\n+        macro_text_with_brackets.len() - TextSize::of(')'),\n+    ));\n+\n+    let is_leaf = macro_call.syntax().next_sibling().is_none();\n+    Some(if !is_leaf && needs_parentheses_around_macro_contents(contents) {\n+        format!(\"({})\", macro_text_in_brackets)\n     } else {\n-        // leave parenthesis around macro contents to preserve the semantics\n-        TextRange::up_to(macro_text_with_brackets.len())\n-    };\n-    Some(macro_text_with_brackets.slice(slice_index).to_string())\n+        macro_text_in_brackets.to_string()\n+    })\n }\n \n /// Verifies that the given macro_call actually matches the given name\n@@ -90,19 +93,10 @@ fn needs_parentheses_around_macro_contents(macro_contents: Vec<SyntaxElement>) -\n     if macro_contents.len() < 2 {\n         return false;\n     }\n-\n-    let mut macro_contents_kind_not_in_brackets = Vec::with_capacity(macro_contents.len());\n-\n-    let mut first_bracket_in_macro = None;\n     let mut unpaired_brackets_in_contents = Vec::new();\n     for element in macro_contents {\n         match element.kind() {\n-            T!['('] | T!['['] | T!['{'] => {\n-                if let None = first_bracket_in_macro {\n-                    first_bracket_in_macro = Some(element.clone())\n-                }\n-                unpaired_brackets_in_contents.push(element);\n-            }\n+            T!['('] | T!['['] | T!['{'] => unpaired_brackets_in_contents.push(element),\n             T![')'] => {\n                 if !matches!(unpaired_brackets_in_contents.pop(), Some(correct_bracket) if correct_bracket.kind() == T!['('])\n                 {\n@@ -121,19 +115,15 @@ fn needs_parentheses_around_macro_contents(macro_contents: Vec<SyntaxElement>) -\n                     return true;\n                 }\n             }\n-            other_kind => {\n-                if unpaired_brackets_in_contents.is_empty() {\n-                    macro_contents_kind_not_in_brackets.push(other_kind);\n+            symbol_kind => {\n+                let symbol_not_in_bracket = unpaired_brackets_in_contents.is_empty();\n+                if symbol_not_in_bracket && symbol_kind.is_punct() {\n+                    return true;\n                 }\n             }\n         }\n     }\n-\n     !unpaired_brackets_in_contents.is_empty()\n-        || matches!(first_bracket_in_macro, Some(bracket) if bracket.kind() != T!['('])\n-        || macro_contents_kind_not_in_brackets\n-            .into_iter()\n-            .any(|macro_contents_kind| macro_contents_kind.is_punct())\n }\n \n #[cfg(test)]\n@@ -244,6 +234,7 @@ fn main() {\n         );\n \n         check_assist(remove_dbg, r#\"let res = <|>dbg!(2 + 2) * 5\"#, r#\"let res = (2 + 2) * 5\"#);\n+        check_assist(remove_dbg, r#\"let res = <|>dbg![2 + 2] * 5\"#, r#\"let res = (2 + 2) * 5\"#);\n     }\n \n     #[test]"}]}