{"sha": "4a75995fbd0c5a342fe0556eba080e1ae7fe0802", "node_id": "C_kwDOAAsO6NoAKDRhNzU5OTVmYmQwYzVhMzQyZmUwNTU2ZWJhMDgwZTFhZTdmZTA4MDI", "commit": {"author": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2023-02-08T20:30:44Z"}, "committer": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2023-02-20T18:25:37Z"}, "message": "Move state fixup into a different method.", "tree": {"sha": "6083538b890b2ac7001eb309ba630436bb0fc779", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6083538b890b2ac7001eb309ba630436bb0fc779"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4a75995fbd0c5a342fe0556eba080e1ae7fe0802", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4a75995fbd0c5a342fe0556eba080e1ae7fe0802", "html_url": "https://github.com/rust-lang/rust/commit/4a75995fbd0c5a342fe0556eba080e1ae7fe0802", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4a75995fbd0c5a342fe0556eba080e1ae7fe0802/comments", "author": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "267cd1d2c5abf5f0d825822a4179ba807b69ffb4", "url": "https://api.github.com/repos/rust-lang/rust/commits/267cd1d2c5abf5f0d825822a4179ba807b69ffb4", "html_url": "https://github.com/rust-lang/rust/commit/267cd1d2c5abf5f0d825822a4179ba807b69ffb4"}], "stats": {"total": 12, "additions": 6, "deletions": 6}, "files": [{"sha": "54899fd4db49de4e88a1adee9d54f78c5d39084d", "filename": "compiler/rustc_mir_transform/src/const_prop.rs", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/4a75995fbd0c5a342fe0556eba080e1ae7fe0802/compiler%2Frustc_mir_transform%2Fsrc%2Fconst_prop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4a75995fbd0c5a342fe0556eba080e1ae7fe0802/compiler%2Frustc_mir_transform%2Fsrc%2Fconst_prop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Fconst_prop.rs?ref=4a75995fbd0c5a342fe0556eba080e1ae7fe0802", "patch": "@@ -13,11 +13,7 @@ use rustc_index::vec::IndexVec;\n use rustc_middle::mir::visit::{\n     MutVisitor, MutatingUseContext, NonMutatingUseContext, PlaceContext, Visitor,\n };\n-use rustc_middle::mir::{\n-    BasicBlock, BinOp, Body, Constant, ConstantKind, Local, LocalDecl, LocalKind, Location,\n-    Operand, Place, Rvalue, SourceInfo, Statement, StatementKind, Terminator, TerminatorKind,\n-    RETURN_PLACE,\n-};\n+use rustc_middle::mir::*;\n use rustc_middle::ty::layout::{LayoutError, LayoutOf, LayoutOfHelpers, TyAndLayout};\n use rustc_middle::ty::InternalSubsts;\n use rustc_middle::ty::{self, ConstKind, Instance, ParamEnv, Ty, TyCtxt, TypeVisitable};\n@@ -1008,7 +1004,7 @@ impl<'tcx> MutVisitor<'tcx> for ConstPropagator<'_, 'tcx> {\n         let source_info = terminator.source_info;\n         self.source_info = Some(source_info);\n         self.super_terminator(terminator, location);\n-        // Do NOT early return in this function, it does some crucial fixup of the state at the end!\n+\n         match &mut terminator.kind {\n             TerminatorKind::Assert { expected, ref mut cond, .. } => {\n                 if let Some(ref value) = self.eval_operand(&cond)\n@@ -1050,6 +1046,10 @@ impl<'tcx> MutVisitor<'tcx> for ConstPropagator<'_, 'tcx> {\n             // gated on `mir_opt_level=3`.\n             TerminatorKind::Call { .. } => {}\n         }\n+    }\n+\n+    fn visit_basic_block_data(&mut self, block: BasicBlock, data: &mut BasicBlockData<'tcx>) {\n+        self.super_basic_block_data(block, data);\n \n         // We remove all Locals which are restricted in propagation to their containing blocks and\n         // which were modified in the current block."}]}