{"sha": "def3fd8e9224128ffdf4cb0a7f08306f757a059a", "node_id": "C_kwDOAAsO6NoAKGRlZjNmZDhlOTIyNDEyOGZmZGY0Y2IwYTdmMDgzMDZmNzU3YTA1OWE", "commit": {"author": {"name": "flip1995", "email": "philipp.krones@embecosm.com", "date": "2022-04-21T12:29:45Z"}, "committer": {"name": "Philipp Krones", "email": "hello@philkrones.com", "date": "2022-06-14T12:50:51Z"}, "message": "Add -Zvirtual-function-elimination flag\n\nAdds the virtual-function-elimination unstable compiler flag and a check\nthat this flag is only used in combination with -Clto. LLVM can only\napply this optimization with fat LTO.", "tree": {"sha": "dfd55346b3c64be7fa02a3f014b37edae44e0fb9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/dfd55346b3c64be7fa02a3f014b37edae44e0fb9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/def3fd8e9224128ffdf4cb0a7f08306f757a059a", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEij1UXJ/PQTcb99vTHKDfKvWdaKUFAmKohCsACgkQHKDfKvWd\naKXdJA/8CMoofxussTWoRcE4nV6CVqnxYUhlY3MDgsdfuZ+RTX/VN6/bGU9U/XlM\nuB0+vYlOJYwA+L4Ti14Y4ueDmzf/gXRMHAefIFWlov3G2tZw6/6VGgCrSJdHYyxt\nbOQY98m9MkHknW2ZXBLr+Nw0rxB8mz0iykZluMRS4vjQXrZ1hTrQNQNhRTGM6ut4\n1fKjJbDhFWcTYxGaM3aoX5Awesi52FKicM+RrNGsgQxTmQyW2hJedeMflnDIj1RR\n/bradHe4W5svsvIVhnxLzgjd9hlMtmNOVGCvSGKtOPUOV+WpeP6sY7WNINGthees\ncgZbwVNHFCXlyHw/6jMBuY3y1UGBqp0YWF84pqg1nz3xuTKwCKwMfEBqA8fPn+Lm\n7xsIaijdLyQSrPRFlP3gWDNIosJtCP+F56Hw2tap6fxt4Ozzj1l0kVFzKfAp60Ss\n+Nd6WPMlOCPHDRJ7Nvd3RRu9SqV953RDF1sWYgnNsrqYipPcHRF3kESMvNka7MxF\nowhuSq/Mywe/oMmyvWoI/44xxIHop6eZiNz/I+MxELW7RrpJhBeRQR25+jxhYHbA\nFUvG76Vvq6Df7+3Ss8EWItHGXg5yHxMiJwTCgBUwku5jO+zCjYRSUweEH2X9Vuf6\n5BS7QbQlSx3krneleHqoENJIsPfAH7QBkY/zn72BQeCbzg0D0m8=\n=Q6j0\n-----END PGP SIGNATURE-----", "payload": "tree dfd55346b3c64be7fa02a3f014b37edae44e0fb9\nparent da895e7938e8d6f8d221fce2876d225bf58df865\nauthor flip1995 <philipp.krones@embecosm.com> 1650544185 +0100\ncommitter Philipp Krones <hello@philkrones.com> 1655211051 +0200\n\nAdd -Zvirtual-function-elimination flag\n\nAdds the virtual-function-elimination unstable compiler flag and a check\nthat this flag is only used in combination with -Clto. LLVM can only\napply this optimization with fat LTO.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/def3fd8e9224128ffdf4cb0a7f08306f757a059a", "html_url": "https://github.com/rust-lang/rust/commit/def3fd8e9224128ffdf4cb0a7f08306f757a059a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/def3fd8e9224128ffdf4cb0a7f08306f757a059a/comments", "author": {"login": "flip1995", "id": 9744647, "node_id": "MDQ6VXNlcjk3NDQ2NDc=", "avatar_url": "https://avatars.githubusercontent.com/u/9744647?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flip1995", "html_url": "https://github.com/flip1995", "followers_url": "https://api.github.com/users/flip1995/followers", "following_url": "https://api.github.com/users/flip1995/following{/other_user}", "gists_url": "https://api.github.com/users/flip1995/gists{/gist_id}", "starred_url": "https://api.github.com/users/flip1995/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flip1995/subscriptions", "organizations_url": "https://api.github.com/users/flip1995/orgs", "repos_url": "https://api.github.com/users/flip1995/repos", "events_url": "https://api.github.com/users/flip1995/events{/privacy}", "received_events_url": "https://api.github.com/users/flip1995/received_events", "type": "User", "site_admin": false}, "committer": {"login": "flip1995", "id": 9744647, "node_id": "MDQ6VXNlcjk3NDQ2NDc=", "avatar_url": "https://avatars.githubusercontent.com/u/9744647?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flip1995", "html_url": "https://github.com/flip1995", "followers_url": "https://api.github.com/users/flip1995/followers", "following_url": "https://api.github.com/users/flip1995/following{/other_user}", "gists_url": "https://api.github.com/users/flip1995/gists{/gist_id}", "starred_url": "https://api.github.com/users/flip1995/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flip1995/subscriptions", "organizations_url": "https://api.github.com/users/flip1995/orgs", "repos_url": "https://api.github.com/users/flip1995/repos", "events_url": "https://api.github.com/users/flip1995/events{/privacy}", "received_events_url": "https://api.github.com/users/flip1995/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "da895e7938e8d6f8d221fce2876d225bf58df865", "url": "https://api.github.com/repos/rust-lang/rust/commits/da895e7938e8d6f8d221fce2876d225bf58df865", "html_url": "https://github.com/rust-lang/rust/commit/da895e7938e8d6f8d221fce2876d225bf58df865"}], "stats": {"total": 16, "additions": 10, "deletions": 6}, "files": [{"sha": "30a29ed6ed38f8640bfe80adf2872f9b89c2801f", "filename": "compiler/rustc_interface/src/tests.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/def3fd8e9224128ffdf4cb0a7f08306f757a059a/compiler%2Frustc_interface%2Fsrc%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/def3fd8e9224128ffdf4cb0a7f08306f757a059a/compiler%2Frustc_interface%2Fsrc%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2Fsrc%2Ftests.rs?ref=def3fd8e9224128ffdf4cb0a7f08306f757a059a", "patch": "@@ -797,6 +797,7 @@ fn test_debugging_options_tracking_hash() {\n     tracked!(unleash_the_miri_inside_of_you, true);\n     tracked!(use_ctors_section, Some(true));\n     tracked!(verify_llvm_ir, true);\n+    tracked!(virtual_function_elimination, true);\n     tracked!(wasi_exec_model, Some(WasiExecModel::Reactor));\n \n     macro_rules! tracked_no_crate_hash {"}, {"sha": "0f60ffda2ee57b95d394df6fbaa398b1856640ec", "filename": "compiler/rustc_session/src/options.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/def3fd8e9224128ffdf4cb0a7f08306f757a059a/compiler%2Frustc_session%2Fsrc%2Foptions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/def3fd8e9224128ffdf4cb0a7f08306f757a059a/compiler%2Frustc_session%2Fsrc%2Foptions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Foptions.rs?ref=def3fd8e9224128ffdf4cb0a7f08306f757a059a", "patch": "@@ -1579,6 +1579,9 @@ options! {\n         \"in general, enable more debug printouts (default: no)\"),\n     verify_llvm_ir: bool = (false, parse_bool, [TRACKED],\n         \"verify LLVM IR (default: no)\"),\n+    virtual_function_elimination: bool = (false, parse_bool, [TRACKED],\n+        \"enables dead virtual function elimination optimization. \\\n+        Requires `-Clto[=[fat,yes]]`\"),\n     wasi_exec_model: Option<WasiExecModel> = (None, parse_wasi_exec_model, [TRACKED],\n         \"whether to build a wasi command or reactor\"),\n "}, {"sha": "18aa717f6768c4c4e082a491befaeb7a1c3a4287", "filename": "compiler/rustc_session/src/session.rs", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/def3fd8e9224128ffdf4cb0a7f08306f757a059a/compiler%2Frustc_session%2Fsrc%2Fsession.rs", "raw_url": "https://github.com/rust-lang/rust/raw/def3fd8e9224128ffdf4cb0a7f08306f757a059a/compiler%2Frustc_session%2Fsrc%2Fsession.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Fsession.rs?ref=def3fd8e9224128ffdf4cb0a7f08306f757a059a", "patch": "@@ -1431,14 +1431,14 @@ fn validate_commandline_args_with_session_available(sess: &Session) {\n         );\n     }\n \n-    // LLVM CFI requires LTO.\n-    if sess.is_sanitizer_cfi_enabled() {\n-        if sess.opts.cg.lto == config::LtoCli::Unspecified\n-            || sess.opts.cg.lto == config::LtoCli::No\n-            || sess.opts.cg.lto == config::LtoCli::Thin\n-        {\n+    // LLVM CFI and VFE both require LTO.\n+    if sess.lto() != config::Lto::Fat {\n+        if sess.is_sanitizer_cfi_enabled() {\n             sess.err(\"`-Zsanitizer=cfi` requires `-Clto`\");\n         }\n+        if sess.opts.debugging_opts.virtual_function_elimination {\n+            sess.err(\"`-Zvirtual-function-elimination` requires `-Clto`\");\n+        }\n     }\n \n     if sess.opts.debugging_opts.stack_protector != StackProtector::None {"}]}