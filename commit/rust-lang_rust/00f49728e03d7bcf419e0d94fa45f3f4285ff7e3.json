{"sha": "00f49728e03d7bcf419e0d94fa45f3f4285ff7e3", "node_id": "MDY6Q29tbWl0NzI0NzEyOjAwZjQ5NzI4ZTAzZDdiY2Y0MTllMGQ5NGZhNDVmM2Y0Mjg1ZmY3ZTM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-07-05T22:28:53Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-07-05T22:28:53Z"}, "message": "Auto merge of #51732 - GuillaumeGomez:cmd-line-lint-rustdoc, r=QuietMisdreavus\n\nAdd command line lint manipulation in rustdoc\n\nFixes #50082.\n\nr? @QuietMisdreavus", "tree": {"sha": "48f75bb95e8b120556add2a8e1035a064a564906", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/48f75bb95e8b120556add2a8e1035a064a564906"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/00f49728e03d7bcf419e0d94fa45f3f4285ff7e3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/00f49728e03d7bcf419e0d94fa45f3f4285ff7e3", "html_url": "https://github.com/rust-lang/rust/commit/00f49728e03d7bcf419e0d94fa45f3f4285ff7e3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/00f49728e03d7bcf419e0d94fa45f3f4285ff7e3/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2d5a295d518b499360ec05df5447351a1e325846", "url": "https://api.github.com/repos/rust-lang/rust/commits/2d5a295d518b499360ec05df5447351a1e325846", "html_url": "https://github.com/rust-lang/rust/commit/2d5a295d518b499360ec05df5447351a1e325846"}, {"sha": "e221be89e0772de3ff2999921b6a89005f19bafd", "url": "https://api.github.com/repos/rust-lang/rust/commits/e221be89e0772de3ff2999921b6a89005f19bafd", "html_url": "https://github.com/rust-lang/rust/commit/e221be89e0772de3ff2999921b6a89005f19bafd"}], "stats": {"total": 78, "additions": 58, "deletions": 20}, "files": [{"sha": "074cab3b5d251230749e0301a26aa04e24e9e015", "filename": "src/librustc/session/config.rs", "status": "modified", "additions": 24, "deletions": 17, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/00f49728e03d7bcf419e0d94fa45f3f4285ff7e3/src%2Flibrustc%2Fsession%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/00f49728e03d7bcf419e0d94fa45f3f4285ff7e3/src%2Flibrustc%2Fsession%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fsession%2Fconfig.rs?ref=00f49728e03d7bcf419e0d94fa45f3f4285ff7e3", "patch": "@@ -1747,6 +1747,29 @@ pub fn parse_cfgspecs(cfgspecs: Vec<String>) -> ast::CrateConfig {\n         .collect::<ast::CrateConfig>()\n }\n \n+pub fn get_cmd_lint_options(matches: &getopts::Matches,\n+                            error_format: ErrorOutputType)\n+                            -> (Vec<(String, lint::Level)>, bool, Option<lint::Level>) {\n+    let mut lint_opts = vec![];\n+    let mut describe_lints = false;\n+\n+    for &level in &[lint::Allow, lint::Warn, lint::Deny, lint::Forbid] {\n+        for lint_name in matches.opt_strs(level.as_str()) {\n+            if lint_name == \"help\" {\n+                describe_lints = true;\n+            } else {\n+                lint_opts.push((lint_name.replace(\"-\", \"_\"), level));\n+            }\n+        }\n+    }\n+\n+    let lint_cap = matches.opt_str(\"cap-lints\").map(|cap| {\n+        lint::Level::from_str(&cap)\n+            .unwrap_or_else(|| early_error(error_format, &format!(\"unknown lint level: `{}`\", cap)))\n+    });\n+    (lint_opts, describe_lints, lint_cap)\n+}\n+\n pub fn build_session_options_and_crate_config(\n     matches: &getopts::Matches,\n ) -> (Options, ast::CrateConfig) {\n@@ -1824,23 +1847,7 @@ pub fn build_session_options_and_crate_config(\n     let crate_types = parse_crate_types_from_list(unparsed_crate_types)\n         .unwrap_or_else(|e| early_error(error_format, &e[..]));\n \n-    let mut lint_opts = vec![];\n-    let mut describe_lints = false;\n-\n-    for &level in &[lint::Allow, lint::Warn, lint::Deny, lint::Forbid] {\n-        for lint_name in matches.opt_strs(level.as_str()) {\n-            if lint_name == \"help\" {\n-                describe_lints = true;\n-            } else {\n-                lint_opts.push((lint_name.replace(\"-\", \"_\"), level));\n-            }\n-        }\n-    }\n-\n-    let lint_cap = matches.opt_str(\"cap-lints\").map(|cap| {\n-        lint::Level::from_str(&cap)\n-            .unwrap_or_else(|| early_error(error_format, &format!(\"unknown lint level: `{}`\", cap)))\n-    });\n+    let (lint_opts, describe_lints, lint_cap) = get_cmd_lint_options(matches, error_format);\n \n     let mut debugging_opts = build_debugging_options(matches, error_format);\n "}, {"sha": "2514fa044dd6bacc9a01ddeed8bd168a2d740981", "filename": "src/librustdoc/core.rs", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/00f49728e03d7bcf419e0d94fa45f3f4285ff7e3/src%2Flibrustdoc%2Fcore.rs", "raw_url": "https://github.com/rust-lang/rust/raw/00f49728e03d7bcf419e0d94fa45f3f4285ff7e3/src%2Flibrustdoc%2Fcore.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fcore.rs?ref=00f49728e03d7bcf419e0d94fa45f3f4285ff7e3", "patch": "@@ -178,7 +178,10 @@ pub fn run_core(search_paths: SearchPaths,\n                 force_unstable_if_unmarked: bool,\n                 edition: Edition,\n                 cg: CodegenOptions,\n-                error_format: ErrorOutputType) -> (clean::Crate, RenderInfo)\n+                error_format: ErrorOutputType,\n+                cmd_lints: Vec<(String, lint::Level)>,\n+                lint_cap: Option<lint::Level>,\n+                describe_lints: bool) -> (clean::Crate, RenderInfo)\n {\n     // Parse, resolve, and typecheck the given crate.\n \n@@ -200,6 +203,7 @@ pub fn run_core(search_paths: SearchPaths,\n                             Some((lint.name_lower(), lint::Allow))\n                         }\n                     })\n+                    .chain(cmd_lints.into_iter())\n                     .collect::<Vec<_>>();\n \n     let host_triple = TargetTriple::from_triple(config::host_triple());\n@@ -213,7 +217,7 @@ pub fn run_core(search_paths: SearchPaths,\n         } else {\n             vec![]\n         },\n-        lint_cap: Some(lint::Forbid),\n+        lint_cap: Some(lint_cap.unwrap_or_else(|| lint::Forbid)),\n         cg,\n         externs,\n         target_triple: triple.unwrap_or(host_triple),\n@@ -226,6 +230,7 @@ pub fn run_core(search_paths: SearchPaths,\n         },\n         error_format,\n         edition,\n+        describe_lints,\n         ..config::basic_options()\n     };\n     driver::spawn_thread_pool(sessopts, move |sessopts| {"}, {"sha": "5f4739bd22276ac10247e3871a43664d573ac8fd", "filename": "src/librustdoc/lib.rs", "status": "modified", "additions": 27, "deletions": 1, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/00f49728e03d7bcf419e0d94fa45f3f4285ff7e3/src%2Flibrustdoc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/00f49728e03d7bcf419e0d94fa45f3f4285ff7e3/src%2Flibrustdoc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Flib.rs?ref=00f49728e03d7bcf419e0d94fa45f3f4285ff7e3", "patch": "@@ -68,6 +68,7 @@ use rustc::session::search_paths::SearchPaths;\n use rustc::session::config::{ErrorOutputType, RustcOptGroup, Externs, CodegenOptions};\n use rustc::session::config::{nightly_options, build_codegen_options};\n use rustc_target::spec::TargetTriple;\n+use rustc::session::config::get_cmd_lint_options;\n \n #[macro_use]\n pub mod externalfiles;\n@@ -308,6 +309,28 @@ pub fn opts() -> Vec<RustcOptGroup> {\n                        \"disable-minification\",\n                        \"Disable minification applied on JS files\")\n         }),\n+        unstable(\"warn\", |o| {\n+            o.optmulti(\"W\", \"warn\", \"Set lint warnings\", \"OPT\")\n+        }),\n+        unstable(\"allow\", |o| {\n+            o.optmulti(\"A\", \"allow\", \"Set lint allowed\", \"OPT\")\n+        }),\n+        unstable(\"deny\", |o| {\n+            o.optmulti(\"D\", \"deny\", \"Set lint denied\", \"OPT\")\n+        }),\n+        unstable(\"forbid\", |o| {\n+            o.optmulti(\"F\", \"forbid\", \"Set lint forbidden\", \"OPT\")\n+        }),\n+        unstable(\"cap-lints\", |o| {\n+            o.optmulti(\n+                \"\",\n+                \"cap-lints\",\n+                \"Set the most restrictive lint level. \\\n+                 More restrictive lints are capped at this \\\n+                 level. By default, it is at `forbid` level.\",\n+                \"LEVEL\",\n+            )\n+        }),\n     ]\n }\n \n@@ -640,6 +663,8 @@ where R: 'static + Send,\n         *x == \"force-unstable-if-unmarked\"\n     });\n \n+    let (lint_opts, describe_lints, lint_cap) = get_cmd_lint_options(matches, error_format);\n+\n     let (tx, rx) = channel();\n \n     rustc_driver::monitor(move || syntax::with_globals(move || {\n@@ -648,7 +673,8 @@ where R: 'static + Send,\n         let (mut krate, renderinfo) =\n             core::run_core(paths, cfgs, externs, Input::File(cratefile), triple, maybe_sysroot,\n                            display_warnings, crate_name.clone(),\n-                           force_unstable_if_unmarked, edition, cg, error_format);\n+                           force_unstable_if_unmarked, edition, cg, error_format,\n+                           lint_opts, lint_cap, describe_lints);\n \n         info!(\"finished with rustc\");\n "}]}