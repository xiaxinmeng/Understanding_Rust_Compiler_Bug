{"sha": "a01fd1af19314a73e5436a912f1cac2341ea11cd", "node_id": "MDY6Q29tbWl0NzI0NzEyOmEwMWZkMWFmMTkzMTRhNzNlNTQzNmE5MTJmMWNhYzIzNDFlYTExY2Q=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2021-04-05T10:02:47Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2021-04-05T10:02:47Z"}, "message": "internal: explain \"extract if condition\" refactoring", "tree": {"sha": "19d03d2f7516f29f65f1e1de8ee1ab2254f2e98c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/19d03d2f7516f29f65f1e1de8ee1ab2254f2e98c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a01fd1af19314a73e5436a912f1cac2341ea11cd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a01fd1af19314a73e5436a912f1cac2341ea11cd", "html_url": "https://github.com/rust-lang/rust/commit/a01fd1af19314a73e5436a912f1cac2341ea11cd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a01fd1af19314a73e5436a912f1cac2341ea11cd/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "58924cfae1be231e01736407fa666f31898a699e", "url": "https://api.github.com/repos/rust-lang/rust/commits/58924cfae1be231e01736407fa666f31898a699e", "html_url": "https://github.com/rust-lang/rust/commit/58924cfae1be231e01736407fa666f31898a699e"}], "stats": {"total": 39, "additions": 29, "deletions": 10}, "files": [{"sha": "4d10a2eadcb0045143eced111ffb9d2332259d7f", "filename": "crates/rust-analyzer/src/handlers.rs", "status": "modified", "additions": 9, "deletions": 9, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/a01fd1af19314a73e5436a912f1cac2341ea11cd/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a01fd1af19314a73e5436a912f1cac2341ea11cd/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs?ref=a01fd1af19314a73e5436a912f1cac2341ea11cd", "patch": "@@ -927,22 +927,22 @@ pub(crate) fn handle_formatting(\n     let captured_stderr = String::from_utf8(output.stderr).unwrap_or_default();\n \n     if !output.status.success() {\n-        match output.status.code() {\n-            Some(1)\n-                if !captured_stderr.contains(\"not installed\")\n-                    && !captured_stderr.contains(\"not available\") =>\n-            {\n+        let rustfmt_not_installed =\n+            captured_stderr.contains(\"not installed\") || captured_stderr.contains(\"not available\");\n+\n+        return match output.status.code() {\n+            Some(1) if !rustfmt_not_installed => {\n                 // While `rustfmt` doesn't have a specific exit code for parse errors this is the\n                 // likely cause exiting with 1. Most Language Servers swallow parse errors on\n                 // formatting because otherwise an error is surfaced to the user on top of the\n                 // syntax error diagnostics they're already receiving. This is especially jarring\n                 // if they have format on save enabled.\n                 log::info!(\"rustfmt exited with status 1, assuming parse error and ignoring\");\n-                return Ok(None);\n+                Ok(None)\n             }\n             _ => {\n                 // Something else happened - e.g. `rustfmt` is missing or caught a signal\n-                return Err(LspError::new(\n+                Err(LspError::new(\n                     -32900,\n                     format!(\n                         r#\"rustfmt exited with:\n@@ -952,9 +952,9 @@ pub(crate) fn handle_formatting(\n                         output.status, captured_stdout, captured_stderr,\n                     ),\n                 )\n-                .into());\n+                .into())\n             }\n-        }\n+        };\n     }\n \n     let (new_text, new_line_endings) = LineEndings::normalize(captured_stdout);"}, {"sha": "48ce4b92a6eb64e50f73fe622140bf27506cbadc", "filename": "docs/dev/style.md", "status": "modified", "additions": 20, "deletions": 1, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/a01fd1af19314a73e5436a912f1cac2341ea11cd/docs%2Fdev%2Fstyle.md", "raw_url": "https://github.com/rust-lang/rust/raw/a01fd1af19314a73e5436a912f1cac2341ea11cd/docs%2Fdev%2Fstyle.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/docs%2Fdev%2Fstyle.md?ref=a01fd1af19314a73e5436a912f1cac2341ea11cd", "patch": "@@ -842,7 +842,26 @@ Re-using originally single-purpose function often leads to bad coupling.\n \n ## Helper Variables\n \n-Introduce helper variables freely, especially for multiline conditions.\n+Introduce helper variables freely, especially for multiline conditions:\n+\n+```rust\n+// GOOD\n+let rustfmt_not_installed =\n+    captured_stderr.contains(\"not installed\") || captured_stderr.contains(\"not available\");\n+\n+match output.status.code() {\n+    Some(1) if !rustfmt_not_installed => Ok(None),\n+    _ => Err(format_err!(\"rustfmt failed:\\n{}\", captured_stderr)),\n+};\n+\n+// BAD\n+match output.status.code() {\n+    Some(1)\n+        if !captured_stderr.contains(\"not installed\")\n+           && !captured_stderr.contains(\"not available\") => Ok(None),\n+    _ => Err(format_err!(\"rustfmt failed:\\n{}\", captured_stderr)),\n+};\n+```\n \n **Rationale:** like blocks, single-use variables are a cognitively cheap abstraction, as they have access to all the context.\n Extra variables help during debugging, they make it easy to print/view important intermediate results."}]}