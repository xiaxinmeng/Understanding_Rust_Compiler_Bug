{"sha": "2dfb5e6ac03e9cc6973dffe9ad69e858510604ee", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJkZmI1ZTZhYzAzZTljYzY5NzNkZmZlOWFkNjllODU4NTEwNjA0ZWU=", "commit": {"author": {"name": "Florian Diebold", "email": "flodiebold@gmail.com", "date": "2019-01-06T23:03:30Z"}, "committer": {"name": "Florian Diebold", "email": "flodiebold@gmail.com", "date": "2019-01-06T23:05:19Z"}, "message": "Improve types for node_expr / node_pat", "tree": {"sha": "7c33751c8d61debbed276bd1e56046ce230c43e5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7c33751c8d61debbed276bd1e56046ce230c43e5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2dfb5e6ac03e9cc6973dffe9ad69e858510604ee", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2dfb5e6ac03e9cc6973dffe9ad69e858510604ee", "html_url": "https://github.com/rust-lang/rust/commit/2dfb5e6ac03e9cc6973dffe9ad69e858510604ee", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2dfb5e6ac03e9cc6973dffe9ad69e858510604ee/comments", "author": {"login": "flodiebold", "id": 906069, "node_id": "MDQ6VXNlcjkwNjA2OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/906069?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flodiebold", "html_url": "https://github.com/flodiebold", "followers_url": "https://api.github.com/users/flodiebold/followers", "following_url": "https://api.github.com/users/flodiebold/following{/other_user}", "gists_url": "https://api.github.com/users/flodiebold/gists{/gist_id}", "starred_url": "https://api.github.com/users/flodiebold/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flodiebold/subscriptions", "organizations_url": "https://api.github.com/users/flodiebold/orgs", "repos_url": "https://api.github.com/users/flodiebold/repos", "events_url": "https://api.github.com/users/flodiebold/events{/privacy}", "received_events_url": "https://api.github.com/users/flodiebold/received_events", "type": "User", "site_admin": false}, "committer": {"login": "flodiebold", "id": 906069, "node_id": "MDQ6VXNlcjkwNjA2OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/906069?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flodiebold", "html_url": "https://github.com/flodiebold", "followers_url": "https://api.github.com/users/flodiebold/followers", "following_url": "https://api.github.com/users/flodiebold/following{/other_user}", "gists_url": "https://api.github.com/users/flodiebold/gists{/gist_id}", "starred_url": "https://api.github.com/users/flodiebold/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flodiebold/subscriptions", "organizations_url": "https://api.github.com/users/flodiebold/orgs", "repos_url": "https://api.github.com/users/flodiebold/repos", "events_url": "https://api.github.com/users/flodiebold/events{/privacy}", "received_events_url": "https://api.github.com/users/flodiebold/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "71f7d82e45145281b9aec5bcdc694524864e552b", "url": "https://api.github.com/repos/rust-lang/rust/commits/71f7d82e45145281b9aec5bcdc694524864e552b", "html_url": "https://github.com/rust-lang/rust/commit/71f7d82e45145281b9aec5bcdc694524864e552b"}], "stats": {"total": 26, "additions": 11, "deletions": 15}, "files": [{"sha": "54ce1b638babc63f2f542b710215595a85338d31", "filename": "crates/ra_analysis/src/completion/complete_dot.rs", "status": "modified", "additions": 4, "deletions": 8, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/2dfb5e6ac03e9cc6973dffe9ad69e858510604ee/crates%2Fra_analysis%2Fsrc%2Fcompletion%2Fcomplete_dot.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2dfb5e6ac03e9cc6973dffe9ad69e858510604ee/crates%2Fra_analysis%2Fsrc%2Fcompletion%2Fcomplete_dot.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_analysis%2Fsrc%2Fcompletion%2Fcomplete_dot.rs?ref=2dfb5e6ac03e9cc6973dffe9ad69e858510604ee", "patch": "@@ -1,5 +1,3 @@\n-use ra_db::LocalSyntaxPtr;\n-use ra_syntax::ast::AstNode;\n use hir::{Ty, Def};\n \n use crate::Cancelable;\n@@ -13,12 +11,10 @@ pub(super) fn complete_dot(acc: &mut Completions, ctx: &CompletionContext) -> Ca\n     };\n     let infer_result = function.infer(ctx.db)?;\n     let syntax_mapping = function.body_syntax_mapping(ctx.db)?;\n-    let expr =\n-        if let Some(expr) = syntax_mapping.syntax_expr(LocalSyntaxPtr::new(receiver.syntax())) {\n-            expr\n-        } else {\n-            return Ok(());\n-        };\n+    let expr = match syntax_mapping.node_expr(receiver) {\n+        Some(expr) => expr,\n+        None => return Ok(()),\n+    };\n     let receiver_ty = infer_result[expr].clone();\n     if !ctx.is_method_call {\n         complete_fields(acc, ctx, receiver_ty)?;"}, {"sha": "06632df4f2202d434c5bbff150be96c61123d1cf", "filename": "crates/ra_analysis/src/hover.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/2dfb5e6ac03e9cc6973dffe9ad69e858510604ee/crates%2Fra_analysis%2Fsrc%2Fhover.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2dfb5e6ac03e9cc6973dffe9ad69e858510604ee/crates%2Fra_analysis%2Fsrc%2Fhover.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_analysis%2Fsrc%2Fhover.rs?ref=2dfb5e6ac03e9cc6973dffe9ad69e858510604ee", "patch": "@@ -65,9 +65,9 @@ pub(crate) fn type_of(db: &RootDatabase, frange: FileRange) -> Cancelable<Option\n     )?);\n     let infer = function.infer(db)?;\n     let syntax_mapping = function.body_syntax_mapping(db)?;\n-    if let Some(expr) = syntax_mapping.node_expr(node) {\n+    if let Some(expr) = ast::Expr::cast(node).and_then(|e| syntax_mapping.node_expr(e)) {\n         Ok(Some(infer[expr].to_string()))\n-    } else if let Some(pat) = syntax_mapping.node_pat(node) {\n+    } else if let Some(pat) = ast::Pat::cast(node).and_then(|p| syntax_mapping.node_pat(p)) {\n         Ok(Some(infer[pat].to_string()))\n     } else {\n         Ok(None)"}, {"sha": "b0063cad26de0a894c0ecfcf24e5bdfd3284e765", "filename": "crates/ra_hir/src/expr.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/2dfb5e6ac03e9cc6973dffe9ad69e858510604ee/crates%2Fra_hir%2Fsrc%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2dfb5e6ac03e9cc6973dffe9ad69e858510604ee/crates%2Fra_hir%2Fsrc%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fexpr.rs?ref=2dfb5e6ac03e9cc6973dffe9ad69e858510604ee", "patch": "@@ -5,7 +5,7 @@ use rustc_hash::FxHashMap;\n \n use ra_arena::{Arena, RawId, impl_arena_id, map::ArenaMap};\n use ra_db::{LocalSyntaxPtr, Cancelable};\n-use ra_syntax::{SyntaxNodeRef, ast::{self, AstNode, LoopBodyOwner, ArgListOwner, NameOwner}};\n+use ra_syntax::ast::{self, AstNode, LoopBodyOwner, ArgListOwner, NameOwner};\n \n use crate::{Path, type_ref::{Mutability, TypeRef}, Name, HirDatabase, DefId, Def, name::AsName};\n \n@@ -77,9 +77,9 @@ impl BodySyntaxMapping {\n     pub fn syntax_expr(&self, ptr: LocalSyntaxPtr) -> Option<ExprId> {\n         self.expr_syntax_mapping.get(&ptr).cloned()\n     }\n-    pub fn node_expr(&self, node: SyntaxNodeRef) -> Option<ExprId> {\n+    pub fn node_expr(&self, node: ast::Expr) -> Option<ExprId> {\n         self.expr_syntax_mapping\n-            .get(&LocalSyntaxPtr::new(node))\n+            .get(&LocalSyntaxPtr::new(node.syntax()))\n             .cloned()\n     }\n     pub fn pat_syntax(&self, pat: PatId) -> Option<LocalSyntaxPtr> {\n@@ -88,9 +88,9 @@ impl BodySyntaxMapping {\n     pub fn syntax_pat(&self, ptr: LocalSyntaxPtr) -> Option<PatId> {\n         self.pat_syntax_mapping.get(&ptr).cloned()\n     }\n-    pub fn node_pat(&self, node: SyntaxNodeRef) -> Option<PatId> {\n+    pub fn node_pat(&self, node: ast::Pat) -> Option<PatId> {\n         self.pat_syntax_mapping\n-            .get(&LocalSyntaxPtr::new(node))\n+            .get(&LocalSyntaxPtr::new(node.syntax()))\n             .cloned()\n     }\n "}]}