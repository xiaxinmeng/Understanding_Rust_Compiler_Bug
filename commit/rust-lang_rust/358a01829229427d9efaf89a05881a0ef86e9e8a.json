{"sha": "358a01829229427d9efaf89a05881a0ef86e9e8a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM1OGEwMTgyOTIyOTQyN2Q5ZWZhZjg5YTA1ODgxYTBlZjg2ZTllOGE=", "commit": {"author": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2021-09-10T15:23:15Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-09-10T15:23:15Z"}, "message": "Rollup merge of #87441 - ibraheemdev:i-86865, r=cjgillot\n\nEmit suggestion when passing byte literal to format macro\n\nCloses #86865", "tree": {"sha": "d4819221c281c1c310284aac1c07520b84cd7405", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d4819221c281c1c310284aac1c07520b84cd7405"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/358a01829229427d9efaf89a05881a0ef86e9e8a", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhO3hkCRBK7hj4Ov3rIwAAwBUIADekaMMpA3OqlpqQW0kCuisE\nl6StQsNeg+AoTAj681fhvkDh9yS1hsIlO7H0aF6J1nZwqrcFgN94e+JKCxoX2d5m\nGi+UJX8CcjWYX8MbFP11KweanmsC4mxMpkcIEQXJI74v9J2XSqeP6A+NwwHfl+B5\nr9X/W0T5pPLg5tAoCEDLshiU9sH1X5KuxoDHrMUiMvMNCmVMKI1M3tdQOZuL1gVH\n17Cj32P1bYwGgVf8dR5PJSOYfT/5U0+316S1JVJ+93eVnObj6PsFD+tfD7iW24R9\nBpM5zSbhZ8wbV8tTAHvd6zhqPFXjkjsApqfvuTnUXHaXXzDEu1OGttRaNwD0g60=\n=T3Jx\n-----END PGP SIGNATURE-----\n", "payload": "tree d4819221c281c1c310284aac1c07520b84cd7405\nparent e422612f8ed51d41fdc6afc8f1ef4949c450815e\nparent f56034ec3e9728881a343683040a97b1386ec34a\nauthor Manish Goregaokar <manishsmail@gmail.com> 1631287395 -0700\ncommitter GitHub <noreply@github.com> 1631287395 -0700\n\nRollup merge of #87441 - ibraheemdev:i-86865, r=cjgillot\n\nEmit suggestion when passing byte literal to format macro\n\nCloses #86865\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/358a01829229427d9efaf89a05881a0ef86e9e8a", "html_url": "https://github.com/rust-lang/rust/commit/358a01829229427d9efaf89a05881a0ef86e9e8a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/358a01829229427d9efaf89a05881a0ef86e9e8a/comments", "author": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e422612f8ed51d41fdc6afc8f1ef4949c450815e", "url": "https://api.github.com/repos/rust-lang/rust/commits/e422612f8ed51d41fdc6afc8f1ef4949c450815e", "html_url": "https://github.com/rust-lang/rust/commit/e422612f8ed51d41fdc6afc8f1ef4949c450815e"}, {"sha": "f56034ec3e9728881a343683040a97b1386ec34a", "url": "https://api.github.com/repos/rust-lang/rust/commits/f56034ec3e9728881a343683040a97b1386ec34a", "html_url": "https://github.com/rust-lang/rust/commit/f56034ec3e9728881a343683040a97b1386ec34a"}], "stats": {"total": 76, "additions": 61, "deletions": 15}, "files": [{"sha": "693114e378664851ccc7179b65f1f87db5f0fd46", "filename": "compiler/rustc_builtin_macros/src/asm.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/358a01829229427d9efaf89a05881a0ef86e9e8a/compiler%2Frustc_builtin_macros%2Fsrc%2Fasm.rs", "raw_url": "https://github.com/rust-lang/rust/raw/358a01829229427d9efaf89a05881a0ef86e9e8a/compiler%2Frustc_builtin_macros%2Fsrc%2Fasm.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_builtin_macros%2Fsrc%2Fasm.rs?ref=358a01829229427d9efaf89a05881a0ef86e9e8a", "patch": "@@ -510,7 +510,7 @@ fn expand_preparsed_asm(ecx: &mut ExtCtxt<'_>, args: AsmArgs) -> Option<ast::Inl\n             match expr_to_spanned_string(ecx, template_expr, msg) {\n                 Ok(template_part) => template_part,\n                 Err(err) => {\n-                    if let Some(mut err) = err {\n+                    if let Some((mut err, _)) = err {\n                         err.emit();\n                     }\n                     return None;"}, {"sha": "c7626dec4d7c0b29bc5c07efb1f0f2c1a0154906", "filename": "compiler/rustc_builtin_macros/src/format.rs", "status": "modified", "additions": 9, "deletions": 7, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/358a01829229427d9efaf89a05881a0ef86e9e8a/compiler%2Frustc_builtin_macros%2Fsrc%2Fformat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/358a01829229427d9efaf89a05881a0ef86e9e8a/compiler%2Frustc_builtin_macros%2Fsrc%2Fformat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_builtin_macros%2Fsrc%2Fformat.rs?ref=358a01829229427d9efaf89a05881a0ef86e9e8a", "patch": "@@ -964,17 +964,19 @@ pub fn expand_preparsed_format_args(\n         }\n         Ok(fmt) => fmt,\n         Err(err) => {\n-            if let Some(mut err) = err {\n+            if let Some((mut err, suggested)) = err {\n                 let sugg_fmt = match args.len() {\n                     0 => \"{}\".to_string(),\n                     _ => format!(\"{}{{}}\", \"{} \".repeat(args.len())),\n                 };\n-                err.span_suggestion(\n-                    fmt_sp.shrink_to_lo(),\n-                    \"you might be missing a string literal to format with\",\n-                    format!(\"\\\"{}\\\", \", sugg_fmt),\n-                    Applicability::MaybeIncorrect,\n-                );\n+                if !suggested {\n+                    err.span_suggestion(\n+                        fmt_sp.shrink_to_lo(),\n+                        \"you might be missing a string literal to format with\",\n+                        format!(\"\\\"{}\\\", \", sugg_fmt),\n+                        Applicability::MaybeIncorrect,\n+                    );\n+                }\n                 err.emit();\n             }\n             return DummyResult::raw_expr(sp, true);"}, {"sha": "6a135dd4f1f6a79903cfba89111e5cacd59c9eb6", "filename": "compiler/rustc_expand/src/base.rs", "status": "modified", "additions": 22, "deletions": 7, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/358a01829229427d9efaf89a05881a0ef86e9e8a/compiler%2Frustc_expand%2Fsrc%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/358a01829229427d9efaf89a05881a0ef86e9e8a/compiler%2Frustc_expand%2Fsrc%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_expand%2Fsrc%2Fbase.rs?ref=358a01829229427d9efaf89a05881a0ef86e9e8a", "patch": "@@ -10,7 +10,7 @@ use rustc_ast::{self as ast, AstLike, Attribute, Item, NodeId, PatKind};\n use rustc_attr::{self as attr, Deprecation, Stability};\n use rustc_data_structures::fx::FxHashMap;\n use rustc_data_structures::sync::{self, Lrc};\n-use rustc_errors::{DiagnosticBuilder, ErrorReported};\n+use rustc_errors::{Applicability, DiagnosticBuilder, ErrorReported};\n use rustc_lint_defs::builtin::PROC_MACRO_BACK_COMPAT;\n use rustc_lint_defs::BuiltinLintDiagnostics;\n use rustc_parse::{self, nt_to_tokenstream, parser, MACRO_ARGUMENTS};\n@@ -1136,36 +1136,51 @@ impl<'a> ExtCtxt<'a> {\n }\n \n /// Extracts a string literal from the macro expanded version of `expr`,\n-/// emitting `err_msg` if `expr` is not a string literal. This does not stop\n-/// compilation on error, merely emits a non-fatal error and returns `None`.\n+/// returning a diagnostic error of `err_msg` if `expr` is not a string literal.\n+/// The returned bool indicates whether an applicable suggestion has already been\n+/// added to the diagnostic to avoid emitting multiple suggestions. `Err(None)`\n+/// indicates that an ast error was encountered.\n pub fn expr_to_spanned_string<'a>(\n     cx: &'a mut ExtCtxt<'_>,\n     expr: P<ast::Expr>,\n     err_msg: &str,\n-) -> Result<(Symbol, ast::StrStyle, Span), Option<DiagnosticBuilder<'a>>> {\n+) -> Result<(Symbol, ast::StrStyle, Span), Option<(DiagnosticBuilder<'a>, bool)>> {\n     // Perform eager expansion on the expression.\n     // We want to be able to handle e.g., `concat!(\"foo\", \"bar\")`.\n     let expr = cx.expander().fully_expand_fragment(AstFragment::Expr(expr)).make_expr();\n \n     Err(match expr.kind {\n         ast::ExprKind::Lit(ref l) => match l.kind {\n             ast::LitKind::Str(s, style) => return Ok((s, style, expr.span)),\n+            ast::LitKind::ByteStr(_) => {\n+                let mut err = cx.struct_span_err(l.span, err_msg);\n+                err.span_suggestion(\n+                    expr.span.shrink_to_lo(),\n+                    \"consider removing the leading `b`\",\n+                    String::new(),\n+                    Applicability::MaybeIncorrect,\n+                );\n+                Some((err, true))\n+            }\n             ast::LitKind::Err(_) => None,\n-            _ => Some(cx.struct_span_err(l.span, err_msg)),\n+            _ => Some((cx.struct_span_err(l.span, err_msg), false)),\n         },\n         ast::ExprKind::Err => None,\n-        _ => Some(cx.struct_span_err(expr.span, err_msg)),\n+        _ => Some((cx.struct_span_err(expr.span, err_msg), false)),\n     })\n }\n \n+/// Extracts a string literal from the macro expanded version of `expr`,\n+/// emitting `err_msg` if `expr` is not a string literal. This does not stop\n+/// compilation on error, merely emits a non-fatal error and returns `None`.\n pub fn expr_to_string(\n     cx: &mut ExtCtxt<'_>,\n     expr: P<ast::Expr>,\n     err_msg: &str,\n ) -> Option<(Symbol, ast::StrStyle)> {\n     expr_to_spanned_string(cx, expr, err_msg)\n         .map_err(|err| {\n-            err.map(|mut err| {\n+            err.map(|(mut err, _)| {\n                 err.emit();\n             })\n         })"}, {"sha": "01e0a20a5115c125731bea5af0eae8534b53df0e", "filename": "src/test/ui/issues/issue-86865.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/358a01829229427d9efaf89a05881a0ef86e9e8a/src%2Ftest%2Fui%2Fissues%2Fissue-86865.rs", "raw_url": "https://github.com/rust-lang/rust/raw/358a01829229427d9efaf89a05881a0ef86e9e8a/src%2Ftest%2Fui%2Fissues%2Fissue-86865.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-86865.rs?ref=358a01829229427d9efaf89a05881a0ef86e9e8a", "patch": "@@ -0,0 +1,11 @@\n+use std::fmt::Write;\n+\n+fn main() {\n+    println!(b\"foo\");\n+    //~^ ERROR format argument must be a string literal\n+    //~| HELP consider removing the leading `b`\n+    let mut s = String::new();\n+    write!(s, b\"foo{}\", \"bar\");\n+    //~^ ERROR format argument must be a string literal\n+    //~| HELP consider removing the leading `b`\n+}"}, {"sha": "eed755366311be409970a0dd9c725c85a8728311", "filename": "src/test/ui/issues/issue-86865.stderr", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/358a01829229427d9efaf89a05881a0ef86e9e8a/src%2Ftest%2Fui%2Fissues%2Fissue-86865.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/358a01829229427d9efaf89a05881a0ef86e9e8a/src%2Ftest%2Fui%2Fissues%2Fissue-86865.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-86865.stderr?ref=358a01829229427d9efaf89a05881a0ef86e9e8a", "patch": "@@ -0,0 +1,18 @@\n+error: format argument must be a string literal\n+  --> $DIR/issue-86865.rs:4:14\n+   |\n+LL |     println!(b\"foo\");\n+   |              -^^^^^\n+   |              |\n+   |              help: consider removing the leading `b`\n+\n+error: format argument must be a string literal\n+  --> $DIR/issue-86865.rs:8:15\n+   |\n+LL |     write!(s, b\"foo{}\", \"bar\");\n+   |               -^^^^^^^\n+   |               |\n+   |               help: consider removing the leading `b`\n+\n+error: aborting due to 2 previous errors\n+"}]}