{"sha": "cc9d7fff8fa11665e16823e28140e681c495fc39", "node_id": "C_kwDOAAsO6NoAKGNjOWQ3ZmZmOGZhMTE2NjVlMTY4MjNlMjgxNDBlNjgxYzQ5NWZjMzk", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-11-12T21:48:37Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-11-12T21:48:37Z"}, "message": "Auto merge of #7966 - Alexendoo:batch-rustfmt, r=camsteffen\n\nRun rustfmt on batches of multiple files\n\nchangelog: none\n\nThis gives `cargo dev fmt` a nice speed boost, down from 90s (because old) on my laptop and 120s (because windows) on my desktop to ~5s on both\n\n250 at a time was to give windows a good amount of headroom (failed at ~800, https://github.com/rust-lang/rust/issues/40384)\n\nAlso adds rustfmt to the toolchain file and has the clippy_dev workflow test using the pinned version as a follow up to #7963", "tree": {"sha": "752ba58526d6eb80bf3376a74560c0a47902ca14", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/752ba58526d6eb80bf3376a74560c0a47902ca14"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cc9d7fff8fa11665e16823e28140e681c495fc39", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cc9d7fff8fa11665e16823e28140e681c495fc39", "html_url": "https://github.com/rust-lang/rust/commit/cc9d7fff8fa11665e16823e28140e681c495fc39", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cc9d7fff8fa11665e16823e28140e681c495fc39/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4f82dd83dfd6f64708b4f0d572c567dfeb7b2092", "url": "https://api.github.com/repos/rust-lang/rust/commits/4f82dd83dfd6f64708b4f0d572c567dfeb7b2092", "html_url": "https://github.com/rust-lang/rust/commit/4f82dd83dfd6f64708b4f0d572c567dfeb7b2092"}, {"sha": "507030f7c429f24ce7e2030e9633803da0c80bf4", "url": "https://api.github.com/repos/rust-lang/rust/commits/507030f7c429f24ce7e2030e9633803da0c80bf4", "html_url": "https://github.com/rust-lang/rust/commit/507030f7c429f24ce7e2030e9633803da0c80bf4"}], "stats": {"total": 54, "additions": 25, "deletions": 29}, "files": [{"sha": "fe8bce00fa82e162ebcffca2944482dcefe1ffe9", "filename": ".github/workflows/clippy_dev.yml", "status": "modified", "additions": 0, "deletions": 12, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/cc9d7fff8fa11665e16823e28140e681c495fc39/.github%2Fworkflows%2Fclippy_dev.yml", "raw_url": "https://github.com/rust-lang/rust/raw/cc9d7fff8fa11665e16823e28140e681c495fc39/.github%2Fworkflows%2Fclippy_dev.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.github%2Fworkflows%2Fclippy_dev.yml?ref=cc9d7fff8fa11665e16823e28140e681c495fc39", "patch": "@@ -25,18 +25,6 @@ jobs:\n     - name: Checkout\n       uses: actions/checkout@v2.3.3\n \n-    - name: remove toolchain file\n-      run: rm rust-toolchain\n-\n-    - name: rust-toolchain\n-      uses: actions-rs/toolchain@v1.0.6\n-      with:\n-        toolchain: nightly\n-        target: x86_64-unknown-linux-gnu\n-        profile: minimal\n-        components: rustfmt\n-        default: true\n-\n     # Run\n     - name: Build\n       run: cargo build --features deny-warnings"}, {"sha": "9ceadee58ea5981777ff171d7a94ad7c9f09e41d", "filename": "clippy_dev/src/fmt.rs", "status": "modified", "additions": 24, "deletions": 16, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/cc9d7fff8fa11665e16823e28140e681c495fc39/clippy_dev%2Fsrc%2Ffmt.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cc9d7fff8fa11665e16823e28140e681c495fc39/clippy_dev%2Fsrc%2Ffmt.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_dev%2Fsrc%2Ffmt.rs?ref=cc9d7fff8fa11665e16823e28140e681c495fc39", "patch": "@@ -1,6 +1,7 @@\n use crate::clippy_project_root;\n+use itertools::Itertools;\n use shell_escape::escape;\n-use std::ffi::OsStr;\n+use std::ffi::{OsStr, OsString};\n use std::path::Path;\n use std::process::{self, Command};\n use std::{fs, io};\n@@ -56,15 +57,22 @@ pub fn run(check: bool, verbose: bool) {\n         success &= cargo_fmt(context, &project_root.join(\"rustc_tools_util\"))?;\n         success &= cargo_fmt(context, &project_root.join(\"lintcheck\"))?;\n \n-        for entry in WalkDir::new(project_root.join(\"tests\")) {\n-            let entry = entry?;\n-            let path = entry.path();\n-\n-            if path.extension() != Some(\"rs\".as_ref()) || entry.file_name() == \"ice-3891.rs\" {\n-                continue;\n-            }\n-\n-            success &= rustfmt(context, path)?;\n+        let chunks = WalkDir::new(project_root.join(\"tests\"))\n+            .into_iter()\n+            .filter_map(|entry| {\n+                let entry = entry.expect(\"failed to find tests\");\n+                let path = entry.path();\n+\n+                if path.extension() != Some(\"rs\".as_ref()) || entry.file_name() == \"ice-3891.rs\" {\n+                    None\n+                } else {\n+                    Some(entry.into_path().into_os_string())\n+                }\n+            })\n+            .chunks(250);\n+\n+        for chunk in &chunks {\n+            success &= rustfmt(context, chunk)?;\n         }\n \n         Ok(success)\n@@ -185,14 +193,14 @@ fn rustfmt_test(context: &FmtContext) -> Result<(), CliError> {\n     }\n }\n \n-fn rustfmt(context: &FmtContext, path: &Path) -> Result<bool, CliError> {\n-    let mut args = vec![path.as_os_str()];\n+fn rustfmt(context: &FmtContext, paths: impl Iterator<Item = OsString>) -> Result<bool, CliError> {\n+    let mut args = Vec::new();\n     if context.check {\n-        args.push(\"--check\".as_ref());\n+        args.push(OsString::from(\"--check\"));\n     }\n+    args.extend(paths);\n+\n     let success = exec(context, \"rustfmt\", std::env::current_dir()?, &args)?;\n-    if !success {\n-        eprintln!(\"rustfmt failed on {}\", path.display());\n-    }\n+\n     Ok(success)\n }"}, {"sha": "31e2aecad2ccbc635f9b1c2ab4c17ca8df6e0072", "filename": "rust-toolchain", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cc9d7fff8fa11665e16823e28140e681c495fc39/rust-toolchain", "raw_url": "https://github.com/rust-lang/rust/raw/cc9d7fff8fa11665e16823e28140e681c495fc39/rust-toolchain", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/rust-toolchain?ref=cc9d7fff8fa11665e16823e28140e681c495fc39", "patch": "@@ -1,3 +1,3 @@\n [toolchain]\n channel = \"nightly-2021-11-04\"\n-components = [\"llvm-tools-preview\", \"rustc-dev\", \"rust-src\"]\n+components = [\"llvm-tools-preview\", \"rustc-dev\", \"rust-src\", \"rustfmt\"]"}]}