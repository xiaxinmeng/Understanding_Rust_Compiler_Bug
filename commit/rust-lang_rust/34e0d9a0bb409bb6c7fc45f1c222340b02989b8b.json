{"sha": "34e0d9a0bb409bb6c7fc45f1c222340b02989b8b", "node_id": "C_kwDOAAsO6NoAKDM0ZTBkOWEwYmI0MDliYjZjN2ZjNDVmMWMyMjIzNDBiMDI5ODliOGI", "commit": {"author": {"name": "cameron", "email": "cameron.studdstreet@gmail.com", "date": "2022-08-14T22:07:47Z"}, "committer": {"name": "cameron", "email": "cameron.studdstreet@gmail.com", "date": "2022-08-14T22:07:47Z"}, "message": "suggest lazy-static for non-const statics", "tree": {"sha": "c86ef095c108db756b59ae6ab2481ab628306fc7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c86ef095c108db756b59ae6ab2481ab628306fc7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/34e0d9a0bb409bb6c7fc45f1c222340b02989b8b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/34e0d9a0bb409bb6c7fc45f1c222340b02989b8b", "html_url": "https://github.com/rust-lang/rust/commit/34e0d9a0bb409bb6c7fc45f1c222340b02989b8b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/34e0d9a0bb409bb6c7fc45f1c222340b02989b8b/comments", "author": {"login": "cameron1024", "id": 29902409, "node_id": "MDQ6VXNlcjI5OTAyNDA5", "avatar_url": "https://avatars.githubusercontent.com/u/29902409?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cameron1024", "html_url": "https://github.com/cameron1024", "followers_url": "https://api.github.com/users/cameron1024/followers", "following_url": "https://api.github.com/users/cameron1024/following{/other_user}", "gists_url": "https://api.github.com/users/cameron1024/gists{/gist_id}", "starred_url": "https://api.github.com/users/cameron1024/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cameron1024/subscriptions", "organizations_url": "https://api.github.com/users/cameron1024/orgs", "repos_url": "https://api.github.com/users/cameron1024/repos", "events_url": "https://api.github.com/users/cameron1024/events{/privacy}", "received_events_url": "https://api.github.com/users/cameron1024/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cameron1024", "id": 29902409, "node_id": "MDQ6VXNlcjI5OTAyNDA5", "avatar_url": "https://avatars.githubusercontent.com/u/29902409?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cameron1024", "html_url": "https://github.com/cameron1024", "followers_url": "https://api.github.com/users/cameron1024/followers", "following_url": "https://api.github.com/users/cameron1024/following{/other_user}", "gists_url": "https://api.github.com/users/cameron1024/gists{/gist_id}", "starred_url": "https://api.github.com/users/cameron1024/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cameron1024/subscriptions", "organizations_url": "https://api.github.com/users/cameron1024/orgs", "repos_url": "https://api.github.com/users/cameron1024/repos", "events_url": "https://api.github.com/users/cameron1024/events{/privacy}", "received_events_url": "https://api.github.com/users/cameron1024/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "75b7e52e92c3b00fc891b47f5b2efdff0a2be55a", "url": "https://api.github.com/repos/rust-lang/rust/commits/75b7e52e92c3b00fc891b47f5b2efdff0a2be55a", "html_url": "https://github.com/rust-lang/rust/commit/75b7e52e92c3b00fc891b47f5b2efdff0a2be55a"}], "stats": {"total": 14, "additions": 14, "deletions": 0}, "files": [{"sha": "c9cfc1f3f469c8f3ce3d5598a14e97f61cbea19f", "filename": "compiler/rustc_const_eval/src/transform/check_consts/ops.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/34e0d9a0bb409bb6c7fc45f1c222340b02989b8b/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/34e0d9a0bb409bb6c7fc45f1c222340b02989b8b/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fcheck_consts%2Fops.rs?ref=34e0d9a0bb409bb6c7fc45f1c222340b02989b8b", "patch": "@@ -1,6 +1,7 @@\n //! Concrete error types for all operations which may be invalid in a certain const context.\n \n use hir::def_id::LocalDefId;\n+use hir::ConstContext;\n use rustc_errors::{\n     error_code, struct_span_err, Applicability, DiagnosticBuilder, ErrorGuaranteed,\n };\n@@ -331,6 +332,10 @@ impl<'tcx> NonConstOp<'tcx> for FnCallNonConst<'tcx> {\n             ccx.const_kind(),\n         ));\n \n+        if let ConstContext::Static(_) = ccx.const_kind() {\n+            err.note(\"consider wrapping this expression in `Lazy::new(|| ...)` from the `once_cell` crate: https://crates.io/crates/once_cell\");\n+        }\n+\n         err\n     }\n }"}, {"sha": "245c3a40e05062631907c8ea7913337c4a79f0bc", "filename": "src/test/ui/borrowck/issue-64453.stderr", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/34e0d9a0bb409bb6c7fc45f1c222340b02989b8b/src%2Ftest%2Fui%2Fborrowck%2Fissue-64453.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/34e0d9a0bb409bb6c7fc45f1c222340b02989b8b/src%2Ftest%2Fui%2Fborrowck%2Fissue-64453.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fborrowck%2Fissue-64453.stderr?ref=34e0d9a0bb409bb6c7fc45f1c222340b02989b8b", "patch": "@@ -14,6 +14,7 @@ LL | static settings_dir: String = format!(\"\");\n    |                               ^^^^^^^^^^^\n    |\n    = note: calls in statics are limited to constant functions, tuple structs and tuple variants\n+   = note: consider wrapping this expression in `Lazy::new(|| ...)` from the `once_cell` crate: https://crates.io/crates/once_cell\n    = note: this error originates in the macro `format` (in Nightly builds, run with -Z macro-backtrace for more info)\n \n error[E0507]: cannot move out of static item `settings_dir`"}, {"sha": "3c193ca34acce85b4c6a27c672a295fcb0934c58", "filename": "src/test/ui/check-static-values-constraints.stderr", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/34e0d9a0bb409bb6c7fc45f1c222340b02989b8b/src%2Ftest%2Fui%2Fcheck-static-values-constraints.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/34e0d9a0bb409bb6c7fc45f1c222340b02989b8b/src%2Ftest%2Fui%2Fcheck-static-values-constraints.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcheck-static-values-constraints.stderr?ref=34e0d9a0bb409bb6c7fc45f1c222340b02989b8b", "patch": "@@ -22,6 +22,7 @@ LL |     field2: SafeEnum::Variant4(\"str\".to_string())\n    |                                      ^^^^^^^^^^^\n    |\n    = note: calls in statics are limited to constant functions, tuple structs and tuple variants\n+   = note: consider wrapping this expression in `Lazy::new(|| ...)` from the `once_cell` crate: https://crates.io/crates/once_cell\n \n error[E0010]: allocations are not allowed in statics\n   --> $DIR/check-static-values-constraints.rs:94:5"}, {"sha": "0fec3581873eb73c5114f702e3e66ea9fa1bec4f", "filename": "src/test/ui/consts/issue-32829-2.stderr", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/34e0d9a0bb409bb6c7fc45f1c222340b02989b8b/src%2Ftest%2Fui%2Fconsts%2Fissue-32829-2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/34e0d9a0bb409bb6c7fc45f1c222340b02989b8b/src%2Ftest%2Fui%2Fconsts%2Fissue-32829-2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fissue-32829-2.stderr?ref=34e0d9a0bb409bb6c7fc45f1c222340b02989b8b", "patch": "@@ -13,6 +13,7 @@ LL |         invalid();\n    |         ^^^^^^^^^\n    |\n    = note: calls in statics are limited to constant functions, tuple structs and tuple variants\n+   = note: consider wrapping this expression in `Lazy::new(|| ...)` from the `once_cell` crate: https://crates.io/crates/once_cell\n \n error[E0015]: cannot call non-const fn `invalid` in statics\n   --> $DIR/issue-32829-2.rs:54:9\n@@ -21,6 +22,7 @@ LL |         invalid();\n    |         ^^^^^^^^^\n    |\n    = note: calls in statics are limited to constant functions, tuple structs and tuple variants\n+   = note: consider wrapping this expression in `Lazy::new(|| ...)` from the `once_cell` crate: https://crates.io/crates/once_cell\n \n error: aborting due to 3 previous errors\n "}, {"sha": "1e0652722ff2d9f3628515bb247869b9545d25a4", "filename": "src/test/ui/consts/mir_check_nonconst.stderr", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/34e0d9a0bb409bb6c7fc45f1c222340b02989b8b/src%2Ftest%2Fui%2Fconsts%2Fmir_check_nonconst.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/34e0d9a0bb409bb6c7fc45f1c222340b02989b8b/src%2Ftest%2Fui%2Fconsts%2Fmir_check_nonconst.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fmir_check_nonconst.stderr?ref=34e0d9a0bb409bb6c7fc45f1c222340b02989b8b", "patch": "@@ -5,6 +5,7 @@ LL | static foo: Foo = bar();\n    |                   ^^^^^\n    |\n    = note: calls in statics are limited to constant functions, tuple structs and tuple variants\n+   = note: consider wrapping this expression in `Lazy::new(|| ...)` from the `once_cell` crate: https://crates.io/crates/once_cell\n \n error: aborting due to previous error\n "}, {"sha": "e320df4b7ad8f95dc2ce29b443abed72b28ea08c", "filename": "src/test/ui/issues/issue-16538.mir.stderr", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/34e0d9a0bb409bb6c7fc45f1c222340b02989b8b/src%2Ftest%2Fui%2Fissues%2Fissue-16538.mir.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/34e0d9a0bb409bb6c7fc45f1c222340b02989b8b/src%2Ftest%2Fui%2Fissues%2Fissue-16538.mir.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-16538.mir.stderr?ref=34e0d9a0bb409bb6c7fc45f1c222340b02989b8b", "patch": "@@ -5,6 +5,7 @@ LL | static foo: &Y::X = &*Y::foo(Y::x as *const Y::X);\n    |                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |\n    = note: calls in statics are limited to constant functions, tuple structs and tuple variants\n+   = note: consider wrapping this expression in `Lazy::new(|| ...)` from the `once_cell` crate: https://crates.io/crates/once_cell\n \n error[E0133]: use of extern static is unsafe and requires unsafe function or block\n   --> $DIR/issue-16538.rs:14:30"}, {"sha": "4a862869274f8943d827673209b7d51140492e77", "filename": "src/test/ui/issues/issue-16538.thir.stderr", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/34e0d9a0bb409bb6c7fc45f1c222340b02989b8b/src%2Ftest%2Fui%2Fissues%2Fissue-16538.thir.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/34e0d9a0bb409bb6c7fc45f1c222340b02989b8b/src%2Ftest%2Fui%2Fissues%2Fissue-16538.thir.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-16538.thir.stderr?ref=34e0d9a0bb409bb6c7fc45f1c222340b02989b8b", "patch": "@@ -21,6 +21,7 @@ LL | static foo: &Y::X = &*Y::foo(Y::x as *const Y::X);\n    |                       ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |\n    = note: calls in statics are limited to constant functions, tuple structs and tuple variants\n+   = note: consider wrapping this expression in `Lazy::new(|| ...)` from the `once_cell` crate: https://crates.io/crates/once_cell\n \n error: aborting due to 3 previous errors\n "}, {"sha": "c6c80e41cf67e29e9a2fd19bc8d431d5db5a0374", "filename": "src/test/ui/issues/issue-25901.stderr", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/34e0d9a0bb409bb6c7fc45f1c222340b02989b8b/src%2Ftest%2Fui%2Fissues%2Fissue-25901.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/34e0d9a0bb409bb6c7fc45f1c222340b02989b8b/src%2Ftest%2Fui%2Fissues%2Fissue-25901.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-25901.stderr?ref=34e0d9a0bb409bb6c7fc45f1c222340b02989b8b", "patch": "@@ -16,6 +16,7 @@ note: impl defined here, but it is not `const`\n LL | impl Deref for A {\n    | ^^^^^^^^^^^^^^^^\n    = note: calls in statics are limited to constant functions, tuple structs and tuple variants\n+   = note: consider wrapping this expression in `Lazy::new(|| ...)` from the `once_cell` crate: https://crates.io/crates/once_cell\n \n error: aborting due to previous error\n "}, {"sha": "dec0123184d705564f59607e4e0a7649c5ed6f63", "filename": "src/test/ui/static/static-vec-repeat-not-constant.stderr", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/34e0d9a0bb409bb6c7fc45f1c222340b02989b8b/src%2Ftest%2Fui%2Fstatic%2Fstatic-vec-repeat-not-constant.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/34e0d9a0bb409bb6c7fc45f1c222340b02989b8b/src%2Ftest%2Fui%2Fstatic%2Fstatic-vec-repeat-not-constant.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fstatic%2Fstatic-vec-repeat-not-constant.stderr?ref=34e0d9a0bb409bb6c7fc45f1c222340b02989b8b", "patch": "@@ -5,6 +5,7 @@ LL | static a: [isize; 2] = [foo(); 2];\n    |                         ^^^^^\n    |\n    = note: calls in statics are limited to constant functions, tuple structs and tuple variants\n+   = note: consider wrapping this expression in `Lazy::new(|| ...)` from the `once_cell` crate: https://crates.io/crates/once_cell\n \n error: aborting due to previous error\n "}]}