{"sha": "ec24442e60bce2605a64ac3aef5784510e4a5fd5", "node_id": "MDY6Q29tbWl0NzI0NzEyOmVjMjQ0NDJlNjBiY2UyNjA1YTY0YWMzYWVmNTc4NDUxMGU0YTVmZDU=", "commit": {"author": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2016-10-28T02:02:27Z"}, "committer": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2016-11-20T01:17:02Z"}, "message": "Provide hint when cast needs a dereference\n\nFor a given code:\n\n```rust\nvec![0.0].iter().map(|s| s as i16).collect::<Vec<i16>>();\n```\n\ndisplay:\n\n```nocode\nerror: casting `&f64` as `i16` is invalid\n --> foo.rs:2:35\n  |\n2 |     vec![0.0].iter().map(|s| s as i16).collect::<Vec<i16>>();\n  |                              -    ^^^ cannot cast `&f64` as `i16`\n  |                              |\n  |                              did you mean `*s`?\n```\n\ninstead of:\n\n```nocode\nerror: casting `&f64` as `i16` is invalid\n --> <anon>:2:30\n  |\n2 |     vec![0.0].iter().map(|s| s as i16).collect();\n  |                              ^^^^^^^^\n  |\n  = help: cast through a raw pointer first\n```", "tree": {"sha": "28a579e94c392baf1a5e7fbd7155ca6985a10443", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/28a579e94c392baf1a5e7fbd7155ca6985a10443"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ec24442e60bce2605a64ac3aef5784510e4a5fd5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ec24442e60bce2605a64ac3aef5784510e4a5fd5", "html_url": "https://github.com/rust-lang/rust/commit/ec24442e60bce2605a64ac3aef5784510e4a5fd5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ec24442e60bce2605a64ac3aef5784510e4a5fd5/comments", "author": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "committer": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fb025b483a5ef96bba944055c47af620d2afb602", "url": "https://api.github.com/repos/rust-lang/rust/commits/fb025b483a5ef96bba944055c47af620d2afb602", "html_url": "https://github.com/rust-lang/rust/commit/fb025b483a5ef96bba944055c47af620d2afb602"}], "stats": {"total": 49, "additions": 47, "deletions": 2}, "files": [{"sha": "5839c606566c31c73ea834d54d3615d7f840a755", "filename": "src/librustc_typeck/check/cast.rs", "status": "modified", "additions": 42, "deletions": 2, "changes": 44, "blob_url": "https://github.com/rust-lang/rust/blob/ec24442e60bce2605a64ac3aef5784510e4a5fd5/src%2Flibrustc_typeck%2Fcheck%2Fcast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ec24442e60bce2605a64ac3aef5784510e4a5fd5/src%2Flibrustc_typeck%2Fcheck%2Fcast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fcast.rs?ref=ec24442e60bce2605a64ac3aef5784510e4a5fd5", "patch": "@@ -102,6 +102,7 @@ enum CastError {\n     /// Cast of thin to fat raw ptr (eg. `*const () as *const [u8]`)\n     SizedUnsizedCast,\n     IllegalCast,\n+    NeedDeref,\n     NeedViaPtr,\n     NeedViaThinPtr,\n     NeedViaInt,\n@@ -138,6 +139,25 @@ impl<'a, 'gcx, 'tcx> CastCheck<'tcx> {\n \n     fn report_cast_error(&self, fcx: &FnCtxt<'a, 'gcx, 'tcx>, e: CastError) {\n         match e {\n+            CastError::NeedDeref => {\n+                let cast_ty = fcx.ty_to_string(self.cast_ty);\n+                let mut err = fcx.type_error_struct(self.cast_span,\n+                                       |actual| {\n+                                           format!(\"casting `{}` as `{}` is invalid\",\n+                                                   actual,\n+                                                   cast_ty)\n+                                       },\n+                                       self.expr_ty);\n+                err.span_label(self.expr.span,\n+                               &format!(\"cannot cast `{}` as `{}`\",\n+                                        fcx.ty_to_string(self.expr_ty),\n+                                        cast_ty));\n+                if let Ok(snippet) = fcx.sess().codemap().span_to_snippet(self.expr.span) {\n+                    err.span_label(self.expr.span,\n+                                   &format!(\"did you mean `*{}`?\", snippet));\n+                }\n+                err.emit();\n+            }\n             CastError::NeedViaThinPtr |\n             CastError::NeedViaPtr => {\n                 let mut err = fcx.type_error_struct(self.span,\n@@ -390,8 +410,28 @@ impl<'a, 'gcx, 'tcx> CastCheck<'tcx> {\n             (Ptr(m_e), Ptr(m_c)) => self.check_ptr_ptr_cast(fcx, m_e, m_c), // ptr-ptr-cast\n             (Ptr(m_expr), Int(_)) => self.check_ptr_addr_cast(fcx, m_expr), // ptr-addr-cast\n             (FnPtr, Int(_)) => Ok(CastKind::FnPtrAddrCast),\n-            (RPtr(_), Int(_)) |\n-            (RPtr(_), Float) => Err(CastError::NeedViaPtr),\n+            (RPtr(p), Int(_)) |\n+            (RPtr(p), Float) => {\n+                match p.ty.sty {\n+                    ty::TypeVariants::TyInt(_) |\n+                    ty::TypeVariants::TyUint(_) |\n+                    ty::TypeVariants::TyFloat(_) => {\n+                        Err(CastError::NeedDeref)\n+                    }\n+                    ty::TypeVariants::TyInfer(t) => {\n+                        match t {\n+                            ty::InferTy::IntVar(_) |\n+                            ty::InferTy::FloatVar(_) |\n+                            ty::InferTy::FreshIntTy(_) |\n+                            ty::InferTy::FreshFloatTy(_) => {\n+                                Err(CastError::NeedDeref)\n+                            }\n+                            _ => Err(CastError::NeedViaPtr),\n+                        }\n+                    }\n+                    _ => Err(CastError::NeedViaPtr),\n+                }\n+            }\n             // * -> ptr\n             (Int(_), Ptr(mt)) => self.check_addr_ptr_cast(fcx, mt), // addr-ptr-cast\n             (FnPtr, Ptr(mt)) => self.check_fptr_ptr_cast(fcx, mt),"}, {"sha": "b98f464c902278443f7ecec8231ea4efc6c6508b", "filename": "src/test/compile-fail/cast-rfc0401.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/ec24442e60bce2605a64ac3aef5784510e4a5fd5/src%2Ftest%2Fcompile-fail%2Fcast-rfc0401.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ec24442e60bce2605a64ac3aef5784510e4a5fd5/src%2Ftest%2Fcompile-fail%2Fcast-rfc0401.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fcast-rfc0401.rs?ref=ec24442e60bce2605a64ac3aef5784510e4a5fd5", "patch": "@@ -115,4 +115,9 @@ fn main()\n     let _ = cf as *const Bar;\n     //~^ ERROR casting\n     //~^^ NOTE vtable kinds\n+\n+    vec![0.0].iter().map(|s| s as f32).collect::<Vec<f32>>();\n+    //~^ ERROR casting `&{float}` as `f32` is invalid\n+    //~| NOTE cannot cast `&{float}` as `f32`\n+    //~| NOTE did you mean `*s`?\n }"}]}