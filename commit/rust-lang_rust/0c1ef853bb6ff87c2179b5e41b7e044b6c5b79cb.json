{"sha": "0c1ef853bb6ff87c2179b5e41b7e044b6c5b79cb", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBjMWVmODUzYmI2ZmY4N2MyMTc5YjVlNDFiN2UwNDRiNmM1Yjc5Y2I=", "commit": {"author": {"name": "Ivan Lozano", "email": "ivanlozano@google.com", "date": "2020-05-26T17:41:40Z"}, "committer": {"name": "Ivan Lozano", "email": "ivanlozano@google.com", "date": "2020-05-27T18:10:40Z"}, "message": "Add -Z profile-emit=<path> for Gcov gcda output.\n\nAdds a -Z flag to control the file path that the Gcov gcda output is\nwritten to during runtime. This flag expects a path and filename, e.g.\n-Z profile-emit=gcov/out/lib.gcda.\n\nThis works similar to GCC/Clang's -fprofile-dir flag which allows\ncontrol over the output path for gcda coverage files.", "tree": {"sha": "49c8ddc2d0a0988315b2cb38dda4200e3d2cd4fc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/49c8ddc2d0a0988315b2cb38dda4200e3d2cd4fc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0c1ef853bb6ff87c2179b5e41b7e044b6c5b79cb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0c1ef853bb6ff87c2179b5e41b7e044b6c5b79cb", "html_url": "https://github.com/rust-lang/rust/commit/0c1ef853bb6ff87c2179b5e41b7e044b6c5b79cb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0c1ef853bb6ff87c2179b5e41b7e044b6c5b79cb/comments", "author": {"login": "ivanloz", "id": 45980681, "node_id": "MDQ6VXNlcjQ1OTgwNjgx", "avatar_url": "https://avatars.githubusercontent.com/u/45980681?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ivanloz", "html_url": "https://github.com/ivanloz", "followers_url": "https://api.github.com/users/ivanloz/followers", "following_url": "https://api.github.com/users/ivanloz/following{/other_user}", "gists_url": "https://api.github.com/users/ivanloz/gists{/gist_id}", "starred_url": "https://api.github.com/users/ivanloz/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ivanloz/subscriptions", "organizations_url": "https://api.github.com/users/ivanloz/orgs", "repos_url": "https://api.github.com/users/ivanloz/repos", "events_url": "https://api.github.com/users/ivanloz/events{/privacy}", "received_events_url": "https://api.github.com/users/ivanloz/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ivanloz", "id": 45980681, "node_id": "MDQ6VXNlcjQ1OTgwNjgx", "avatar_url": "https://avatars.githubusercontent.com/u/45980681?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ivanloz", "html_url": "https://github.com/ivanloz", "followers_url": "https://api.github.com/users/ivanloz/followers", "following_url": "https://api.github.com/users/ivanloz/following{/other_user}", "gists_url": "https://api.github.com/users/ivanloz/gists{/gist_id}", "starred_url": "https://api.github.com/users/ivanloz/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ivanloz/subscriptions", "organizations_url": "https://api.github.com/users/ivanloz/orgs", "repos_url": "https://api.github.com/users/ivanloz/repos", "events_url": "https://api.github.com/users/ivanloz/events{/privacy}", "received_events_url": "https://api.github.com/users/ivanloz/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "aeca4d6428c52cbf2c8d1f28657b0bdf92e4ea7c", "url": "https://api.github.com/repos/rust-lang/rust/commits/aeca4d6428c52cbf2c8d1f28657b0bdf92e4ea7c", "html_url": "https://github.com/rust-lang/rust/commit/aeca4d6428c52cbf2c8d1f28657b0bdf92e4ea7c"}], "stats": {"total": 15, "additions": 11, "deletions": 4}, "files": [{"sha": "333eb805221ff0fda5ec6b462fde4dd76a60c0b2", "filename": "src/librustc_codegen_llvm/debuginfo/metadata.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/0c1ef853bb6ff87c2179b5e41b7e044b6c5b79cb/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fmetadata.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0c1ef853bb6ff87c2179b5e41b7e044b6c5b79cb/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fmetadata.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fmetadata.rs?ref=0c1ef853bb6ff87c2179b5e41b7e044b6c5b79cb", "patch": "@@ -959,16 +959,16 @@ pub fn compile_unit_metadata(\n         if tcx.sess.opts.debugging_opts.profile {\n             let cu_desc_metadata =\n                 llvm::LLVMRustMetadataAsValue(debug_context.llcontext, unit_metadata);\n+            let default_gcda_path = &tcx.output_filenames(LOCAL_CRATE).with_extension(\"gcda\");\n+            let gcda_path =\n+                tcx.sess.opts.debugging_opts.profile_emit.as_ref().unwrap_or(default_gcda_path);\n \n             let gcov_cu_info = [\n                 path_to_mdstring(\n                     debug_context.llcontext,\n                     &tcx.output_filenames(LOCAL_CRATE).with_extension(\"gcno\"),\n                 ),\n-                path_to_mdstring(\n-                    debug_context.llcontext,\n-                    &tcx.output_filenames(LOCAL_CRATE).with_extension(\"gcda\"),\n-                ),\n+                path_to_mdstring(debug_context.llcontext, &gcda_path),\n                 cu_desc_metadata,\n             ];\n             let gcov_metadata = llvm::LLVMMDNodeInContext("}, {"sha": "91a4bc2b86856ce6d9c65387534f0218abfca173", "filename": "src/librustc_interface/tests.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/0c1ef853bb6ff87c2179b5e41b7e044b6c5b79cb/src%2Flibrustc_interface%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0c1ef853bb6ff87c2179b5e41b7e044b6c5b79cb/src%2Flibrustc_interface%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_interface%2Ftests.rs?ref=0c1ef853bb6ff87c2179b5e41b7e044b6c5b79cb", "patch": "@@ -557,6 +557,7 @@ fn test_debugging_options_tracking_hash() {\n     tracked!(plt, Some(true));\n     tracked!(print_fuel, Some(\"abc\".to_string()));\n     tracked!(profile, true);\n+    tracked!(profile_emit, Some(PathBuf::from(\"abc\")));\n     tracked!(relro_level, Some(RelroLevel::Full));\n     tracked!(report_delayed_bugs, true);\n     tracked!(run_dsymutil, false);"}, {"sha": "a38e7f063d79ae88daa355432f9d89c72c8381a4", "filename": "src/librustc_session/options.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/0c1ef853bb6ff87c2179b5e41b7e044b6c5b79cb/src%2Flibrustc_session%2Foptions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0c1ef853bb6ff87c2179b5e41b7e044b6c5b79cb/src%2Flibrustc_session%2Foptions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_session%2Foptions.rs?ref=0c1ef853bb6ff87c2179b5e41b7e044b6c5b79cb", "patch": "@@ -955,6 +955,9 @@ options! {DebuggingOptions, DebuggingSetter, basic_debugging_options,\n         \"print layout information for each type encountered (default: no)\"),\n     profile: bool = (false, parse_bool, [TRACKED],\n         \"insert profiling code (default: no)\"),\n+    profile_emit: Option<PathBuf> = (None, parse_opt_pathbuf, [TRACKED],\n+        \"file path to emit profiling data at runtime when using 'profile' \\\n+        (default based on relative source path)\"),\n     query_dep_graph: bool = (false, parse_bool, [UNTRACKED],\n         \"enable queries of the dependency graph for regression testing (default: no)\"),\n     query_stats: bool = (false, parse_bool, [UNTRACKED],"}, {"sha": "04d382b475ed298111d1e614f045a0589706140f", "filename": "src/test/run-make-fulldeps/profile/Makefile", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/0c1ef853bb6ff87c2179b5e41b7e044b6c5b79cb/src%2Ftest%2Frun-make-fulldeps%2Fprofile%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/0c1ef853bb6ff87c2179b5e41b7e044b6c5b79cb/src%2Ftest%2Frun-make-fulldeps%2Fprofile%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fprofile%2FMakefile?ref=0c1ef853bb6ff87c2179b5e41b7e044b6c5b79cb", "patch": "@@ -7,3 +7,6 @@ all:\n \t$(call RUN,test) || exit 1\n \t[ -e \"$(TMPDIR)/test.gcno\" ] || (echo \"No .gcno file\"; exit 1)\n \t[ -e \"$(TMPDIR)/test.gcda\" ] || (echo \"No .gcda file\"; exit 1)\n+\t$(RUSTC) -g -Z profile -Z profile-emit=$(TMPDIR)/abc/abc.gcda test.rs\n+\t$(call RUN,test) || exit 1\n+\t[ -e \"$(TMPDIR)/abc/abc.gcda\" ] || (echo \"gcda file not emitted to defined path\"; exit 1)"}]}