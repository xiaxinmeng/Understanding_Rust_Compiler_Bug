{"sha": "b11c3e3829d61f7a9165f9b6a14a0e5c9a9626f1", "node_id": "MDY6Q29tbWl0NzI0NzEyOmIxMWMzZTM4MjlkNjFmN2E5MTY1ZjliNmExNGEwZTVjOWE5NjI2ZjE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-01-14T03:01:52Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-01-14T03:01:52Z"}, "message": "auto merge of #11525 : luqmana/rust/trait-coercions, r=pcwalton\n\nFixes 2 annoying issues with implicit trait object coercion: #11481 & #11197.", "tree": {"sha": "418b101fb6a579ee3726542ffcc08cdbcc4eaafc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/418b101fb6a579ee3726542ffcc08cdbcc4eaafc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b11c3e3829d61f7a9165f9b6a14a0e5c9a9626f1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b11c3e3829d61f7a9165f9b6a14a0e5c9a9626f1", "html_url": "https://github.com/rust-lang/rust/commit/b11c3e3829d61f7a9165f9b6a14a0e5c9a9626f1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b11c3e3829d61f7a9165f9b6a14a0e5c9a9626f1/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ab66f762548228a9491de8c955141b8d62b1f5fa", "url": "https://api.github.com/repos/rust-lang/rust/commits/ab66f762548228a9491de8c955141b8d62b1f5fa", "html_url": "https://github.com/rust-lang/rust/commit/ab66f762548228a9491de8c955141b8d62b1f5fa"}, {"sha": "d42e75883bda9a3f74c541edd0b070a82303d8f1", "url": "https://api.github.com/repos/rust-lang/rust/commits/d42e75883bda9a3f74c541edd0b070a82303d8f1", "html_url": "https://github.com/rust-lang/rust/commit/d42e75883bda9a3f74c541edd0b070a82303d8f1"}], "stats": {"total": 87, "additions": 63, "deletions": 24}, "files": [{"sha": "8cf39d14763b395ec07cfee1f77693cc52d02777", "filename": "src/librustc/middle/mem_categorization.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/b11c3e3829d61f7a9165f9b6a14a0e5c9a9626f1/src%2Flibrustc%2Fmiddle%2Fmem_categorization.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b11c3e3829d61f7a9165f9b6a14a0e5c9a9626f1/src%2Flibrustc%2Fmiddle%2Fmem_categorization.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fmem_categorization.rs?ref=b11c3e3829d61f7a9165f9b6a14a0e5c9a9626f1", "patch": "@@ -345,9 +345,12 @@ impl mem_categorization_ctxt {\n                 match **adjustment {\n                     ty::AutoObject(..) => {\n                         // Implicity casts a concrete object to trait object\n-                        // Result is an rvalue\n+                        // so just patch up the type\n                         let expr_ty = ty::expr_ty_adjusted(self.tcx, expr);\n-                        self.cat_rvalue_node(expr, expr_ty)\n+                        @cmt_ {\n+                            ty: expr_ty,\n+                            ..*self.cat_expr_unadjusted(expr)\n+                        }\n                     }\n \n                     ty::AutoAddEnv(..) => {"}, {"sha": "8d3b953af1829898664d80cdf9597150f2215be6", "filename": "src/librustc/middle/trans/expr.rs", "status": "modified", "additions": 4, "deletions": 11, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/b11c3e3829d61f7a9165f9b6a14a0e5c9a9626f1/src%2Flibrustc%2Fmiddle%2Ftrans%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b11c3e3829d61f7a9165f9b6a14a0e5c9a9626f1/src%2Flibrustc%2Fmiddle%2Ftrans%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fexpr.rs?ref=b11c3e3829d61f7a9165f9b6a14a0e5c9a9626f1", "patch": "@@ -229,19 +229,12 @@ pub fn trans_to_datum<'a>(bcx: &'a Block<'a>, expr: &ast::Expr)\n                 }\n             };\n         }\n-        AutoObject(ref sigil, ref region, _, _, _, _) => {\n+        AutoObject(..) => {\n \n             let adjusted_ty = ty::expr_ty_adjusted(bcx.tcx(), expr);\n             let scratch = scratch_datum(bcx, adjusted_ty, \"__adjust\", false);\n \n-            let trait_store = match *sigil {\n-                ast::BorrowedSigil => ty::RegionTraitStore(region.expect(\"expected valid region\")),\n-                ast::OwnedSigil => ty::UniqTraitStore,\n-                ast::ManagedSigil => ty::BoxTraitStore\n-            };\n-\n-            bcx = meth::trans_trait_cast(bcx, expr, expr.id, SaveIn(scratch.val),\n-                                         trait_store, false /* no adjustments */);\n+            bcx = meth::trans_trait_cast(bcx, expr, expr.id, SaveIn(scratch.val), Some(datum));\n \n             datum = scratch.to_appropriate_datum(bcx);\n             datum.add_clean(bcx);\n@@ -834,9 +827,9 @@ fn trans_rvalue_dps_unadjusted<'a>(\n         }\n         ast::ExprCast(val, _) => {\n             match ty::get(node_id_type(bcx, expr.id)).sty {\n-                ty::ty_trait(_, _, store, _, _) => {\n+                ty::ty_trait(..) => {\n                     return meth::trans_trait_cast(bcx, val, expr.id,\n-                                                  dest, store, true /* adjustments */);\n+                                                  dest, None);\n                 }\n                 _ => {\n                     bcx.tcx().sess.span_bug(expr.span,"}, {"sha": "f8aef908381189349342f8c93901c7bd318c5072", "filename": "src/librustc/middle/trans/meth.rs", "status": "modified", "additions": 8, "deletions": 11, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/b11c3e3829d61f7a9165f9b6a14a0e5c9a9626f1/src%2Flibrustc%2Fmiddle%2Ftrans%2Fmeth.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b11c3e3829d61f7a9165f9b6a14a0e5c9a9626f1/src%2Flibrustc%2Fmiddle%2Ftrans%2Fmeth.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fmeth.rs?ref=b11c3e3829d61f7a9165f9b6a14a0e5c9a9626f1", "patch": "@@ -637,22 +637,14 @@ pub fn trans_trait_cast<'a>(\n                         val: &ast::Expr,\n                         id: ast::NodeId,\n                         dest: expr::Dest,\n-                        _store: ty::TraitStore,\n-                        do_adjustments: bool)\n+                        obj: Option<Datum>)\n                         -> &'a Block<'a> {\n     let mut bcx = bcx;\n     let _icx = push_ctxt(\"impl::trans_cast\");\n \n-    // Pick the right trans function\n-    let trans_into = if do_adjustments {\n-        expr::trans_into\n-    } else {\n-        expr::trans_into_unadjusted\n-    };\n-\n     let lldest = match dest {\n         Ignore => {\n-            return trans_into(bcx, val, Ignore);\n+            return expr::trans_into(bcx, val, Ignore);\n         }\n         SaveIn(dest) => dest\n     };\n@@ -667,7 +659,12 @@ pub fn trans_trait_cast<'a>(\n     llboxdest = PointerCast(bcx,\n                             llboxdest,\n                             type_of(bcx.ccx(), v_ty).ptr_to());\n-    bcx = trans_into(bcx, val, SaveIn(llboxdest));\n+    bcx = match obj {\n+        Some(datum) => {\n+            datum.store_to_dest(bcx, SaveIn(llboxdest))\n+        }\n+        None => expr::trans_into(bcx, val, SaveIn(llboxdest))\n+    };\n \n     // Store the vtable into the pair or triple.\n     // This is structured a bit funny because of dynamic borrow failures."}, {"sha": "bef6165d120a5f2ea216f439f5ea11d52b96e140", "filename": "src/test/compile-fail/use-after-move-implicity-coerced-object.rs", "status": "added", "additions": 37, "deletions": 0, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/b11c3e3829d61f7a9165f9b6a14a0e5c9a9626f1/src%2Ftest%2Fcompile-fail%2Fuse-after-move-implicity-coerced-object.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b11c3e3829d61f7a9165f9b6a14a0e5c9a9626f1/src%2Ftest%2Fcompile-fail%2Fuse-after-move-implicity-coerced-object.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fuse-after-move-implicity-coerced-object.rs?ref=b11c3e3829d61f7a9165f9b6a14a0e5c9a9626f1", "patch": "@@ -0,0 +1,37 @@\n+// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+struct Number {\n+    n: i64\n+}\n+\n+impl ToStr for Number {\n+    fn to_str(&self) -> ~str {\n+        self.n.to_str()\n+    }\n+}\n+\n+struct List {\n+    list: ~[~ToStr]\n+}\n+\n+impl List {\n+    fn push(&mut self, n: ~ToStr) {\n+        self.list.push(n);\n+    }\n+}\n+\n+fn main() {\n+    let n = ~Number { n: 42 };\n+    let mut l = ~List { list: ~[] };\n+    l.push(n);\n+    //^~ NOTE: `n` moved here because it has type `~Number`, which is non-copyable (perhaps you meant to use clone()?)\n+    let x = n.to_str(); //~ ERROR: use of moved value: `n`\n+}"}, {"sha": "365831eda83dfc2d7049cf026545d9b68ec3653d", "filename": "src/test/run-pass/trait-coercion.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/b11c3e3829d61f7a9165f9b6a14a0e5c9a9626f1/src%2Ftest%2Frun-pass%2Ftrait-coercion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b11c3e3829d61f7a9165f9b6a14a0e5c9a9626f1/src%2Ftest%2Frun-pass%2Ftrait-coercion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Ftrait-coercion.rs?ref=b11c3e3829d61f7a9165f9b6a14a0e5c9a9626f1", "patch": "@@ -10,6 +10,8 @@\n \n #[feature(managed_boxes)];\n \n+use std::io;\n+\n trait Trait {\n     fn f(&self);\n }\n@@ -29,6 +31,10 @@ fn f(x: @Trait) {\n     x.f();\n }\n \n+fn foo(mut a: ~Writer) {\n+    a.write(bytes!(\"Hello\\n\"));\n+}\n+\n pub fn main() {\n     let a = Struct { x: 1, y: 2 };\n     let b: @Trait = @a;\n@@ -38,5 +44,8 @@ pub fn main() {\n     let d: &Trait = &a;\n     d.f();\n     f(@a);\n+\n+    let out = io::stdout();\n+    foo(~out);\n }\n "}]}