{"sha": "2a9ad77d952d658b4566a3201b98598e7f1e2ebd", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJhOWFkNzdkOTUyZDY1OGI0NTY2YTMyMDFiOTg1OThlN2YxZTJlYmQ=", "commit": {"author": {"name": "Andy Russell", "email": "arussell123@gmail.com", "date": "2019-01-07T04:18:00Z"}, "committer": {"name": "Andy Russell", "email": "arussell123@gmail.com", "date": "2019-01-07T04:23:20Z"}, "message": "slightly optimize compiletest test collection\n\nSave quite a few syscalls and avoiding pushing in a loop.", "tree": {"sha": "eb72ce7b20695b38562ec88301ea63e6af07e5bf", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/eb72ce7b20695b38562ec88301ea63e6af07e5bf"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2a9ad77d952d658b4566a3201b98598e7f1e2ebd", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQFKBAABCAA0FiEELriChyEaiMu0yCg7viIhAz7bw3QFAlwy1DwWHGFydXNzZWxs\nMTIzQGdtYWlsLmNvbQAKCRC+IiEDPtvDdB2PCACTUIAV1nzF3fBlI67SWWhad1wJ\ndwa9PyfTHCV9/M1fXZVFcJcpV/CoKJIQilh/w46j06aKh/JQJIbdLa4U0g0kw8od\nlSv2+nlM9IhXtsTlFLstykQX+p3g5ZDFJrJAyHK4poL+n+3YuzB1EY6rrgUo8mGn\n2Thfy3/c0i2hY8/I+PkWv8Ex0I6SDzbQRAhrsRcNQTnaXT6DY4rMghpJhAB9tyBW\ngr/Vgb9DmjleIREMA8neT1NHdJu0wnYGpLI9hoSTv/RUxVsOgCjC967eWDq7juBO\nHpi5DF5e7T9DBZRGdqmkAq4q7doRvPImktcxiAhpuozdEVBbAqX4nM3fmKde\n=xYtQ\n-----END PGP SIGNATURE-----", "payload": "tree eb72ce7b20695b38562ec88301ea63e6af07e5bf\nparent b92552d5578e4544006da0dd5e793a19c2149321\nauthor Andy Russell <arussell123@gmail.com> 1546834680 -0500\ncommitter Andy Russell <arussell123@gmail.com> 1546835000 -0500\n\nslightly optimize compiletest test collection\n\nSave quite a few syscalls and avoiding pushing in a loop.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2a9ad77d952d658b4566a3201b98598e7f1e2ebd", "html_url": "https://github.com/rust-lang/rust/commit/2a9ad77d952d658b4566a3201b98598e7f1e2ebd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2a9ad77d952d658b4566a3201b98598e7f1e2ebd/comments", "author": {"login": "euclio", "id": 1372438, "node_id": "MDQ6VXNlcjEzNzI0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1372438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/euclio", "html_url": "https://github.com/euclio", "followers_url": "https://api.github.com/users/euclio/followers", "following_url": "https://api.github.com/users/euclio/following{/other_user}", "gists_url": "https://api.github.com/users/euclio/gists{/gist_id}", "starred_url": "https://api.github.com/users/euclio/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/euclio/subscriptions", "organizations_url": "https://api.github.com/users/euclio/orgs", "repos_url": "https://api.github.com/users/euclio/repos", "events_url": "https://api.github.com/users/euclio/events{/privacy}", "received_events_url": "https://api.github.com/users/euclio/received_events", "type": "User", "site_admin": false}, "committer": {"login": "euclio", "id": 1372438, "node_id": "MDQ6VXNlcjEzNzI0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1372438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/euclio", "html_url": "https://github.com/euclio", "followers_url": "https://api.github.com/users/euclio/followers", "following_url": "https://api.github.com/users/euclio/following{/other_user}", "gists_url": "https://api.github.com/users/euclio/gists{/gist_id}", "starred_url": "https://api.github.com/users/euclio/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/euclio/subscriptions", "organizations_url": "https://api.github.com/users/euclio/orgs", "repos_url": "https://api.github.com/users/euclio/repos", "events_url": "https://api.github.com/users/euclio/events{/privacy}", "received_events_url": "https://api.github.com/users/euclio/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b92552d5578e4544006da0dd5e793a19c2149321", "url": "https://api.github.com/repos/rust-lang/rust/commits/b92552d5578e4544006da0dd5e793a19c2149321", "html_url": "https://github.com/rust-lang/rust/commit/b92552d5578e4544006da0dd5e793a19c2149321"}], "stats": {"total": 61, "additions": 27, "deletions": 34}, "files": [{"sha": "2e5feca54151c99faebb0540e683fa10f2651733", "filename": "src/tools/compiletest/src/main.rs", "status": "modified", "additions": 27, "deletions": 34, "changes": 61, "blob_url": "https://github.com/rust-lang/rust/blob/2a9ad77d952d658b4566a3201b98598e7f1e2ebd/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2a9ad77d952d658b4566a3201b98598e7f1e2ebd/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs?ref=2a9ad77d952d658b4566a3201b98598e7f1e2ebd", "patch": "@@ -489,7 +489,7 @@ pub fn run_tests(config: &Config) {\n     // Let tests know which target they're running as\n     env::set_var(\"TARGET\", &config.target);\n \n-    let res = test::run_tests_console(&opts, tests.into_iter().collect());\n+    let res = test::run_tests_console(&opts, tests);\n     match res {\n         Ok(true) => {}\n         Ok(false) => panic!(\"Some tests failed\"),\n@@ -548,22 +548,18 @@ fn collect_tests_from_dir(\n     relative_dir_path: &Path,\n     tests: &mut Vec<test::TestDescAndFn>,\n ) -> io::Result<()> {\n-    // Ignore directories that contain a file\n-    // `compiletest-ignore-dir`.\n-    for file in fs::read_dir(dir)? {\n-        let file = file?;\n-        let name = file.file_name();\n-        if name == *\"compiletest-ignore-dir\" {\n-            return Ok(());\n-        }\n-        if name == *\"Makefile\" && config.mode == Mode::RunMake {\n-            let paths = TestPaths {\n-                file: dir.to_path_buf(),\n-                relative_dir: relative_dir_path.parent().unwrap().to_path_buf(),\n-            };\n-            tests.extend(make_test(config, &paths));\n-            return Ok(());\n-        }\n+    // Ignore directories that contain a file named `compiletest-ignore-dir`.\n+    if dir.join(\"compiletest-ignore-dir\").exists() {\n+        return Ok(());\n+    }\n+\n+    if config.mode == Mode::RunMake && dir.join(\"Makefile\").exists() {\n+        let paths = TestPaths {\n+            file: dir.to_path_buf(),\n+            relative_dir: relative_dir_path.parent().unwrap().to_path_buf(),\n+        };\n+        tests.extend(make_test(config, &paths));\n+        return Ok(());\n     }\n \n     // If we find a test foo/bar.rs, we have to build the\n@@ -577,8 +573,7 @@ fn collect_tests_from_dir(\n \n     // Add each `.rs` file as a test, and recurse further on any\n     // subdirectories we find, except for `aux` directories.\n-    let dirs = fs::read_dir(dir)?;\n-    for file in dirs {\n+    for file in fs::read_dir(dir)? {\n         let file = file?;\n         let file_path = file.path();\n         let file_name = file.file_name();\n@@ -679,7 +674,7 @@ fn collect_timestamps(path: &PathBuf) -> impl Iterator<Item=FileTime> {\n     WalkDir::new(path)\n         .into_iter()\n         .map(|entry| entry.unwrap())\n-        .filter(|entry| entry.metadata().unwrap().is_file())\n+        .filter(|entry| entry.file_type().is_file())\n         .map(|entry| mtime(entry.path()))\n }\n \n@@ -707,14 +702,12 @@ fn up_to_date(\n         .expect(\"Could not find Rust source root\");\n     let stamp = mtime(&stamp_name);\n     let mut inputs = vec![mtime(&testpaths.file), mtime(&config.rustc_path)];\n-    for aux in props.aux.iter() {\n-        inputs.push(mtime(&testpaths\n-            .file\n-            .parent()\n-            .unwrap()\n-            .join(\"auxiliary\")\n-            .join(aux)));\n-    }\n+    inputs.extend(\n+        props\n+            .aux\n+            .iter()\n+            .map(|aux| mtime(&testpaths.file.parent().unwrap().join(\"auxiliary\").join(aux))),\n+    );\n     // Relevant pretty printer files\n     let pretty_printer_files = [\n         \"src/etc/debugger_pretty_printers_common.py\",\n@@ -723,20 +716,20 @@ fn up_to_date(\n         \"src/etc/lldb_batchmode.py\",\n         \"src/etc/lldb_rust_formatters.py\",\n     ];\n-    for pretty_printer_file in &pretty_printer_files {\n-        inputs.push(mtime(&rust_src_dir.join(pretty_printer_file)));\n-    }\n+    inputs.extend(pretty_printer_files.iter().map(|pretty_printer_file| {\n+        mtime(&rust_src_dir.join(pretty_printer_file))\n+    }));\n     inputs.extend(collect_timestamps(&config.run_lib_path));\n     if let Some(ref rustdoc_path) = config.rustdoc_path {\n         inputs.push(mtime(&rustdoc_path));\n         inputs.push(mtime(&rust_src_dir.join(\"src/etc/htmldocck.py\")));\n     }\n \n     // UI test files.\n-    for extension in UI_EXTENSIONS {\n+    inputs.extend(UI_EXTENSIONS.iter().map(|extension| {\n         let path = &expected_output_path(testpaths, revision, &config.compare_mode, extension);\n-        inputs.push(mtime(path));\n-    }\n+        mtime(path)\n+    }));\n \n     // Compiletest itself.\n     inputs.extend(collect_timestamps(&rust_src_dir.join(\"src/tools/compiletest/\")));"}]}