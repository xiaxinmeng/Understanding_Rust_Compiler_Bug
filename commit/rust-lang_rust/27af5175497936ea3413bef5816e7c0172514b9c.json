{"sha": "27af5175497936ea3413bef5816e7c0172514b9c", "node_id": "C_kwDOAAsO6NoAKDI3YWY1MTc1NDk3OTM2ZWEzNDEzYmVmNTgxNmU3YzAxNzI1MTRiOWM", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-04-20T03:51:09Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-04-20T03:51:09Z"}, "message": "Auto merge of #96082 - michaelwoerister:less_impl_stable_hash_via_hash, r=compiler-errors\n\nincr. comp.: Don't export impl_stable_hash_via_hash!() and warn about using it.\n\nFixes https://github.com/rust-lang/rust/issues/96013.", "tree": {"sha": "17c9839aa67e9683d60920fa04248835c9da6108", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/17c9839aa67e9683d60920fa04248835c9da6108"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/27af5175497936ea3413bef5816e7c0172514b9c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/27af5175497936ea3413bef5816e7c0172514b9c", "html_url": "https://github.com/rust-lang/rust/commit/27af5175497936ea3413bef5816e7c0172514b9c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/27af5175497936ea3413bef5816e7c0172514b9c/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a2df8baea6fb7199822d39cfcfddb197604aa8a2", "url": "https://api.github.com/repos/rust-lang/rust/commits/a2df8baea6fb7199822d39cfcfddb197604aa8a2", "html_url": "https://github.com/rust-lang/rust/commit/a2df8baea6fb7199822d39cfcfddb197604aa8a2"}, {"sha": "c0be61972461458ac28195e2034fa6e3d775fcf3", "url": "https://api.github.com/repos/rust-lang/rust/commits/c0be61972461458ac28195e2034fa6e3d775fcf3", "html_url": "https://github.com/rust-lang/rust/commit/c0be61972461458ac28195e2034fa6e3d775fcf3"}], "stats": {"total": 75, "additions": 38, "deletions": 37}, "files": [{"sha": "25353290fd50c4943c018554102791388342163d", "filename": "compiler/rustc_data_structures/src/stable_hasher.rs", "status": "modified", "additions": 12, "deletions": 3, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/27af5175497936ea3413bef5816e7c0172514b9c/compiler%2Frustc_data_structures%2Fsrc%2Fstable_hasher.rs", "raw_url": "https://github.com/rust-lang/rust/raw/27af5175497936ea3413bef5816e7c0172514b9c/compiler%2Frustc_data_structures%2Fsrc%2Fstable_hasher.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_data_structures%2Fsrc%2Fstable_hasher.rs?ref=27af5175497936ea3413bef5816e7c0172514b9c", "patch": "@@ -207,9 +207,14 @@ pub trait ToStableHashKey<HCX> {\n     fn to_stable_hash_key(&self, hcx: &HCX) -> Self::KeyType;\n }\n \n-// Implement HashStable by just calling `Hash::hash()`. This works fine for\n-// self-contained values that don't depend on the hashing context `CTX`.\n-#[macro_export]\n+/// Implement HashStable by just calling `Hash::hash()`.\n+///\n+/// **WARNING** This is only valid for types that *really* don't need any context for fingerprinting.\n+/// But it is easy to misuse this macro (see [#96013](https://github.com/rust-lang/rust/issues/96013)\n+/// for examples). Therefore this macro is not exported and should only be used in the limited cases\n+/// here in this module.\n+///\n+/// Use `#[derive(HashStable_Generic)]` instead.\n macro_rules! impl_stable_hash_via_hash {\n     ($t:ty) => {\n         impl<CTX> $crate::stable_hasher::HashStable<CTX> for $t {\n@@ -246,12 +251,14 @@ impl<CTX> HashStable<CTX> for ! {\n }\n \n impl<CTX> HashStable<CTX> for ::std::num::NonZeroU32 {\n+    #[inline]\n     fn hash_stable(&self, ctx: &mut CTX, hasher: &mut StableHasher) {\n         self.get().hash_stable(ctx, hasher)\n     }\n }\n \n impl<CTX> HashStable<CTX> for ::std::num::NonZeroUsize {\n+    #[inline]\n     fn hash_stable(&self, ctx: &mut CTX, hasher: &mut StableHasher) {\n         self.get().hash_stable(ctx, hasher)\n     }\n@@ -272,12 +279,14 @@ impl<CTX> HashStable<CTX> for f64 {\n }\n \n impl<CTX> HashStable<CTX> for ::std::cmp::Ordering {\n+    #[inline]\n     fn hash_stable(&self, ctx: &mut CTX, hasher: &mut StableHasher) {\n         (*self as i8).hash_stable(ctx, hasher);\n     }\n }\n \n impl<T1: HashStable<CTX>, CTX> HashStable<CTX> for (T1,) {\n+    #[inline]\n     fn hash_stable(&self, ctx: &mut CTX, hasher: &mut StableHasher) {\n         let (ref _0,) = *self;\n         _0.hash_stable(ctx, hasher);"}, {"sha": "4e6ab0edf6666377c97b16e433619dd6c785f2c2", "filename": "compiler/rustc_errors/src/lib.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/27af5175497936ea3413bef5816e7c0172514b9c/compiler%2Frustc_errors%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/27af5175497936ea3413bef5816e7c0172514b9c/compiler%2Frustc_errors%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_errors%2Fsrc%2Flib.rs?ref=27af5175497936ea3413bef5816e7c0172514b9c", "patch": "@@ -37,6 +37,7 @@ pub use rustc_error_messages::{\n };\n pub use rustc_lint_defs::{pluralize, Applicability};\n use rustc_span::source_map::SourceMap;\n+use rustc_span::HashStableContext;\n use rustc_span::{Loc, Span};\n \n use std::borrow::Cow;\n@@ -1494,6 +1495,7 @@ pub fn add_elided_lifetime_in_path_suggestion(\n /// Useful type to use with `Result<>` indicate that an error has already\n /// been reported to the user, so no need to continue checking.\n #[derive(Clone, Copy, Debug, Encodable, Decodable, Hash, PartialEq, Eq, PartialOrd, Ord)]\n+#[derive(HashStable_Generic)]\n pub struct ErrorGuaranteed(());\n \n impl ErrorGuaranteed {\n@@ -1503,5 +1505,3 @@ impl ErrorGuaranteed {\n         ErrorGuaranteed(())\n     }\n }\n-\n-rustc_data_structures::impl_stable_hash_via_hash!(ErrorGuaranteed);"}, {"sha": "346ac9e96440abfb1eae0ec9932bf40d5b6fdd91", "filename": "compiler/rustc_hir/src/hir_id.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/27af5175497936ea3413bef5816e7c0172514b9c/compiler%2Frustc_hir%2Fsrc%2Fhir_id.rs", "raw_url": "https://github.com/rust-lang/rust/raw/27af5175497936ea3413bef5816e7c0172514b9c/compiler%2Frustc_hir%2Fsrc%2Fhir_id.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir%2Fsrc%2Fhir_id.rs?ref=27af5175497936ea3413bef5816e7c0172514b9c", "patch": "@@ -76,9 +76,10 @@ rustc_index::newtype_index! {\n     /// integers starting at zero, so a mapping that maps all or most nodes within\n     /// an \"item-like\" to something else can be implemented by a `Vec` instead of a\n     /// tree or hash map.\n+    #[derive(HashStable_Generic)]\n     pub struct ItemLocalId { .. }\n }\n-rustc_data_structures::impl_stable_hash_via_hash!(ItemLocalId);\n+\n impl ItemLocalId {\n     /// Signal local id which should never be used.\n     pub const INVALID: ItemLocalId = ItemLocalId::MAX;"}, {"sha": "f590172af4f9ccf8c2b33e456b6be0fd4dec2ea6", "filename": "compiler/rustc_lint_defs/src/lib.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/27af5175497936ea3413bef5816e7c0172514b9c/compiler%2Frustc_lint_defs%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/27af5175497936ea3413bef5816e7c0172514b9c/compiler%2Frustc_lint_defs%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_lint_defs%2Fsrc%2Flib.rs?ref=27af5175497936ea3413bef5816e7c0172514b9c", "patch": "@@ -8,6 +8,7 @@ use rustc_ast::node_id::{NodeId, NodeMap};\n use rustc_ast::{AttrId, Attribute};\n use rustc_data_structures::stable_hasher::{HashStable, StableHasher, ToStableHashKey};\n use rustc_error_messages::MultiSpan;\n+use rustc_hir::HashStableContext;\n use rustc_hir::HirId;\n use rustc_span::edition::Edition;\n use rustc_span::{sym, symbol::Ident, Span, Symbol};\n@@ -146,7 +147,7 @@ impl<HCX: rustc_hir::HashStableContext> ToStableHashKey<HCX> for LintExpectation\n /// Setting for how to handle a lint.\n ///\n /// See: <https://doc.rust-lang.org/rustc/lints/levels.html>\n-#[derive(Clone, Copy, PartialEq, PartialOrd, Eq, Ord, Debug, Hash)]\n+#[derive(Clone, Copy, PartialEq, PartialOrd, Eq, Ord, Debug, Hash, HashStable_Generic)]\n pub enum Level {\n     /// The `allow` level will not issue any message.\n     Allow,\n@@ -174,8 +175,6 @@ pub enum Level {\n     Forbid,\n }\n \n-rustc_data_structures::impl_stable_hash_via_hash!(Level);\n-\n impl Level {\n     /// Converts a level to a lower-case string.\n     pub fn as_str(self) -> &'static str {"}, {"sha": "12c5c4445d46f333c9437fd7270a81afac91692a", "filename": "compiler/rustc_session/src/config.rs", "status": "modified", "additions": 16, "deletions": 19, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/27af5175497936ea3413bef5816e7c0172514b9c/compiler%2Frustc_session%2Fsrc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/27af5175497936ea3413bef5816e7c0172514b9c/compiler%2Frustc_session%2Fsrc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Fconfig.rs?ref=27af5175497936ea3413bef5816e7c0172514b9c", "patch": "@@ -3,14 +3,14 @@\n \n pub use crate::options::*;\n \n-use crate::lint;\n use crate::search_paths::SearchPath;\n use crate::utils::{CanonicalizedPath, NativeLib, NativeLibKind};\n use crate::{early_error, early_warn, Session};\n+use crate::{lint, HashStableContext};\n \n use rustc_data_structures::fx::{FxHashMap, FxHashSet};\n-use rustc_data_structures::impl_stable_hash_via_hash;\n \n+use rustc_data_structures::stable_hasher::ToStableHashKey;\n use rustc_target::abi::{Align, TargetDataLayout};\n use rustc_target::spec::{LinkerFlavor, SplitDebuginfo, Target, TargetTriple, TargetWarnings};\n use rustc_target::spec::{PanicStrategy, SanitizerSet, TARGETS};\n@@ -78,7 +78,7 @@ pub enum CFProtection {\n     Full,\n }\n \n-#[derive(Clone, Copy, Debug, PartialEq, Hash)]\n+#[derive(Clone, Copy, Debug, PartialEq, Hash, HashStable_Generic)]\n pub enum OptLevel {\n     No,         // -O0\n     Less,       // -O1\n@@ -88,8 +88,6 @@ pub enum OptLevel {\n     SizeMin,    // -Oz\n }\n \n-impl_stable_hash_via_hash!(OptLevel);\n-\n /// This is what the `LtoCli` values get mapped to after resolving defaults and\n /// and taking other command line options into account.\n ///\n@@ -230,15 +228,13 @@ impl SwitchWithOptPath {\n     }\n }\n \n-#[derive(Copy, Clone, Debug, PartialEq, Eq, PartialOrd, Ord, Hash)]\n+#[derive(Copy, Clone, Debug, PartialEq, Eq, PartialOrd, Ord, Hash, HashStable_Generic)]\n #[derive(Encodable, Decodable)]\n pub enum SymbolManglingVersion {\n     Legacy,\n     V0,\n }\n \n-impl_stable_hash_via_hash!(SymbolManglingVersion);\n-\n #[derive(Clone, Copy, Debug, PartialEq, Hash)]\n pub enum DebugInfo {\n     None,\n@@ -277,7 +273,7 @@ impl FromStr for SplitDwarfKind {\n     }\n }\n \n-#[derive(Clone, Copy, PartialEq, Eq, Hash, Debug, PartialOrd, Ord)]\n+#[derive(Clone, Copy, PartialEq, Eq, Hash, Debug, PartialOrd, Ord, HashStable_Generic)]\n #[derive(Encodable, Decodable)]\n pub enum OutputType {\n     Bitcode,\n@@ -290,7 +286,13 @@ pub enum OutputType {\n     DepInfo,\n }\n \n-impl_stable_hash_via_hash!(OutputType);\n+impl<HCX: HashStableContext> ToStableHashKey<HCX> for OutputType {\n+    type KeyType = Self;\n+\n+    fn to_stable_hash_key(&self, _: &HCX) -> Self::KeyType {\n+        *self\n+    }\n+}\n \n impl OutputType {\n     fn is_compatible_with_codegen_units_and_single_output_file(&self) -> bool {\n@@ -396,7 +398,7 @@ pub enum TrimmedDefPaths {\n /// *Do not* switch `BTreeMap` out for an unsorted container type! That would break\n /// dependency tracking for command-line arguments. Also only hash keys, since tracking\n /// should only depend on the output types, not the paths they're written to.\n-#[derive(Clone, Debug, Hash)]\n+#[derive(Clone, Debug, Hash, HashStable_Generic)]\n pub struct OutputTypes(BTreeMap<OutputType, Option<PathBuf>>);\n \n impl OutputTypes {\n@@ -585,7 +587,7 @@ impl Input {\n     }\n }\n \n-#[derive(Clone, Hash, Debug)]\n+#[derive(Clone, Hash, Debug, HashStable_Generic)]\n pub struct OutputFilenames {\n     pub out_directory: PathBuf,\n     filestem: String,\n@@ -594,8 +596,6 @@ pub struct OutputFilenames {\n     pub outputs: OutputTypes,\n }\n \n-impl_stable_hash_via_hash!(OutputFilenames);\n-\n pub const RLINK_EXT: &str = \"rlink\";\n pub const RUST_CGU_EXT: &str = \"rcgu\";\n pub const DWARF_OBJECT_EXT: &str = \"dwo\";\n@@ -808,15 +808,14 @@ impl DebuggingOptions {\n }\n \n // The type of entry function, so users can have their own entry functions\n-#[derive(Copy, Clone, PartialEq, Hash, Debug)]\n+#[derive(Copy, Clone, PartialEq, Hash, Debug, HashStable_Generic)]\n pub enum EntryFnType {\n     Main,\n     Start,\n }\n \n-impl_stable_hash_via_hash!(EntryFnType);\n-\n #[derive(Copy, PartialEq, PartialOrd, Clone, Ord, Eq, Hash, Debug, Encodable, Decodable)]\n+#[derive(HashStable_Generic)]\n pub enum CrateType {\n     Executable,\n     Dylib,\n@@ -826,8 +825,6 @@ pub enum CrateType {\n     ProcMacro,\n }\n \n-impl_stable_hash_via_hash!(CrateType);\n-\n impl CrateType {\n     /// When generated, is this crate type an archive?\n     pub fn is_archive(&self) -> bool {"}, {"sha": "56a6b6f3b03efe6d18c98fd80ad69e1fa6c5af2c", "filename": "compiler/rustc_session/src/search_paths.rs", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/27af5175497936ea3413bef5816e7c0172514b9c/compiler%2Frustc_session%2Fsrc%2Fsearch_paths.rs", "raw_url": "https://github.com/rust-lang/rust/raw/27af5175497936ea3413bef5816e7c0172514b9c/compiler%2Frustc_session%2Fsrc%2Fsearch_paths.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Fsearch_paths.rs?ref=27af5175497936ea3413bef5816e7c0172514b9c", "patch": "@@ -26,7 +26,7 @@ pub struct SearchPathFile {\n     pub file_name_str: String,\n }\n \n-#[derive(PartialEq, Clone, Copy, Debug, Hash, Eq, Encodable, Decodable)]\n+#[derive(PartialEq, Clone, Copy, Debug, Hash, Eq, Encodable, Decodable, HashStable_Generic)]\n pub enum PathKind {\n     Native,\n     Crate,\n@@ -36,8 +36,6 @@ pub enum PathKind {\n     All,\n }\n \n-rustc_data_structures::impl_stable_hash_via_hash!(PathKind);\n-\n impl PathKind {\n     pub fn matches(&self, kind: PathKind) -> bool {\n         match (self, kind) {"}, {"sha": "8064c217457bb561bc66185b27d75822f0fbce1e", "filename": "compiler/rustc_session/src/utils.rs", "status": "modified", "additions": 2, "deletions": 4, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/27af5175497936ea3413bef5816e7c0172514b9c/compiler%2Frustc_session%2Fsrc%2Futils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/27af5175497936ea3413bef5816e7c0172514b9c/compiler%2Frustc_session%2Fsrc%2Futils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Futils.rs?ref=27af5175497936ea3413bef5816e7c0172514b9c", "patch": "@@ -18,6 +18,7 @@ impl Session {\n }\n \n #[derive(Copy, Clone, Debug, PartialEq, Eq, PartialOrd, Ord, Hash, Encodable, Decodable)]\n+#[derive(HashStable_Generic)]\n pub enum NativeLibKind {\n     /// Static library (e.g. `libfoo.a` on Linux or `foo.lib` on Windows/MSVC)\n     Static {\n@@ -57,9 +58,8 @@ impl NativeLibKind {\n     }\n }\n \n-rustc_data_structures::impl_stable_hash_via_hash!(NativeLibKind);\n-\n #[derive(Clone, Debug, PartialEq, Eq, PartialOrd, Ord, Hash, Encodable, Decodable)]\n+#[derive(HashStable_Generic)]\n pub struct NativeLib {\n     pub name: String,\n     pub new_name: Option<String>,\n@@ -73,8 +73,6 @@ impl NativeLib {\n     }\n }\n \n-rustc_data_structures::impl_stable_hash_via_hash!(NativeLib);\n-\n /// A path that has been canonicalized along with its original, non-canonicalized form\n #[derive(Clone, Debug, PartialEq, Eq, PartialOrd, Ord)]\n pub struct CanonicalizedPath {"}, {"sha": "b0307cc20d174f39645a81d5a8f7646ff515eda9", "filename": "compiler/rustc_span/src/lib.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/27af5175497936ea3413bef5816e7c0172514b9c/compiler%2Frustc_span%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/27af5175497936ea3413bef5816e7c0172514b9c/compiler%2Frustc_span%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Flib.rs?ref=27af5175497936ea3413bef5816e7c0172514b9c", "patch": "@@ -1130,6 +1130,7 @@ impl ExternalSource {\n pub struct OffsetOverflowError;\n \n #[derive(Copy, Clone, Debug, PartialEq, Eq, PartialOrd, Ord, Hash, Encodable, Decodable)]\n+#[derive(HashStable_Generic)]\n pub enum SourceFileHashAlgorithm {\n     Md5,\n     Sha1,\n@@ -1149,8 +1150,6 @@ impl FromStr for SourceFileHashAlgorithm {\n     }\n }\n \n-rustc_data_structures::impl_stable_hash_via_hash!(SourceFileHashAlgorithm);\n-\n /// The hash of the on-disk source file used for debug info.\n #[derive(Copy, Clone, PartialEq, Eq, Debug)]\n #[derive(HashStable_Generic, Encodable, Decodable)]"}]}