{"sha": "c4611a0e6bda21408f814bfaeb5d961fc84c25ff", "node_id": "MDY6Q29tbWl0NzI0NzEyOmM0NjExYTBlNmJkYTIxNDA4ZjgxNGJmYWViNWQ5NjFmYzg0YzI1ZmY=", "commit": {"author": {"name": "Seiichi Uchida", "email": "seuchida@gmail.com", "date": "2019-02-10T15:32:06Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-02-10T15:32:06Z"}, "message": "Merge pull request #3326 from scampi/issue-3302\n\nfix formatting of strings within a macro", "tree": {"sha": "c2fcf2f3a9a38320e4d728d7c908aa4f2cffc1ac", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c2fcf2f3a9a38320e4d728d7c908aa4f2cffc1ac"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c4611a0e6bda21408f814bfaeb5d961fc84c25ff", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJcYEP2CRBK7hj4Ov3rIwAAdHIIAGcpx7oGGWkUy+4thhdz9Pf+\nw25zIDqfmgT86rpRI4FTsQ6BVXpuGD6V3N/lCLg+wx00xTfVcJ2g0TMgsDBpAA2x\nD8AsUBZ3sWoNdYR9sNaTrKxO3MljzJv0wXoahH7qEdHPedK3a2idEKHsCVefyvvJ\nuym1hF22/DVBRnPHq5VrkqW+SKo3n6a09Il9BHLLRugoB1qdpX4PXnQo9svs/UL5\njN4AteouzYfb6CENJJ0jzjWzdPGSehDRJV43VNG1IFY9Vk+CN0eDSTyl1yjELz09\n5d38K6VwyEOq/T21+yTiFhqkUtkD500t6IeuzDnAQYxhQ8mIW5r1EefXJnTErY0=\n=v7ml\n-----END PGP SIGNATURE-----\n", "payload": "tree c2fcf2f3a9a38320e4d728d7c908aa4f2cffc1ac\nparent e28fae99747af538a30452413692a015da93b490\nparent b86dd161df35086d55dd627fa97337635cd2b046\nauthor Seiichi Uchida <seuchida@gmail.com> 1549812726 +0900\ncommitter GitHub <noreply@github.com> 1549812726 +0900\n\nMerge pull request #3326 from scampi/issue-3302\n\nfix formatting of strings within a macro"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c4611a0e6bda21408f814bfaeb5d961fc84c25ff", "html_url": "https://github.com/rust-lang/rust/commit/c4611a0e6bda21408f814bfaeb5d961fc84c25ff", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c4611a0e6bda21408f814bfaeb5d961fc84c25ff/comments", "author": {"login": "topecongiro", "id": 21980157, "node_id": "MDQ6VXNlcjIxOTgwMTU3", "avatar_url": "https://avatars.githubusercontent.com/u/21980157?v=4", "gravatar_id": "", "url": "https://api.github.com/users/topecongiro", "html_url": "https://github.com/topecongiro", "followers_url": "https://api.github.com/users/topecongiro/followers", "following_url": "https://api.github.com/users/topecongiro/following{/other_user}", "gists_url": "https://api.github.com/users/topecongiro/gists{/gist_id}", "starred_url": "https://api.github.com/users/topecongiro/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/topecongiro/subscriptions", "organizations_url": "https://api.github.com/users/topecongiro/orgs", "repos_url": "https://api.github.com/users/topecongiro/repos", "events_url": "https://api.github.com/users/topecongiro/events{/privacy}", "received_events_url": "https://api.github.com/users/topecongiro/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e28fae99747af538a30452413692a015da93b490", "url": "https://api.github.com/repos/rust-lang/rust/commits/e28fae99747af538a30452413692a015da93b490", "html_url": "https://github.com/rust-lang/rust/commit/e28fae99747af538a30452413692a015da93b490"}, {"sha": "b86dd161df35086d55dd627fa97337635cd2b046", "url": "https://api.github.com/repos/rust-lang/rust/commits/b86dd161df35086d55dd627fa97337635cd2b046", "html_url": "https://github.com/rust-lang/rust/commit/b86dd161df35086d55dd627fa97337635cd2b046"}], "stats": {"total": 110, "additions": 103, "deletions": 7}, "files": [{"sha": "c993d8390fc58fd88f0db635af649975fb591ed8", "filename": "src/lib.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/c4611a0e6bda21408f814bfaeb5d961fc84c25ff/src%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c4611a0e6bda21408f814bfaeb5d961fc84c25ff/src%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flib.rs?ref=c4611a0e6bda21408f814bfaeb5d961fc84c25ff", "patch": "@@ -50,6 +50,7 @@ use crate::comment::LineClasses;\n use crate::formatting::{FormatErrorMap, FormattingError, ReportedErrors, SourceFile};\n use crate::issues::Issue;\n use crate::shape::Indent;\n+use crate::utils::indent_next_line;\n \n pub use crate::config::{\n     load_config, CliOptions, Color, Config, Edition, EmitMode, FileLines, FileName, NewlineStyle,\n@@ -438,7 +439,7 @@ fn format_code_block(code_snippet: &str, config: &Config) -> Option<FormattedSni\n             }\n             result.push_str(&line);\n             result.push('\\n');\n-            need_indent = !kind.is_string() || line.ends_with('\\\\');\n+            need_indent = indent_next_line(kind, &line, config);\n         }\n         result.push('}');\n         result\n@@ -499,7 +500,7 @@ fn format_code_block(code_snippet: &str, config: &Config) -> Option<FormattedSni\n             line\n         };\n         result.push_str(trimmed_line);\n-        is_indented = !kind.is_string() || line.ends_with('\\\\');\n+        is_indented = indent_next_line(kind, line, config);\n     }\n     Some(FormattedSnippet {\n         snippet: result,"}, {"sha": "a925331f9fe2d594a3736be6b55aa55da67067dd", "filename": "src/macros.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/c4611a0e6bda21408f814bfaeb5d961fc84c25ff/src%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c4611a0e6bda21408f814bfaeb5d961fc84c25ff/src%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fmacros.rs?ref=c4611a0e6bda21408f814bfaeb5d961fc84c25ff", "patch": "@@ -43,8 +43,8 @@ use crate::shape::{Indent, Shape};\n use crate::source_map::SpanUtils;\n use crate::spanned::Spanned;\n use crate::utils::{\n-    format_visibility, is_empty_line, mk_sp, remove_trailing_white_spaces, rewrite_ident,\n-    trim_left_preserve_layout, wrap_str, NodeIdExt,\n+    format_visibility, indent_next_line, is_empty_line, mk_sp, remove_trailing_white_spaces,\n+    rewrite_ident, trim_left_preserve_layout, wrap_str, NodeIdExt,\n };\n use crate::visitor::FmtVisitor;\n \n@@ -1299,7 +1299,7 @@ impl MacroBranch {\n                     {\n                         s += &indent_str;\n                     }\n-                    (s + l + \"\\n\", !kind.is_string() || l.ends_with('\\\\'))\n+                    (s + l + \"\\n\", indent_next_line(kind, &l, &config))\n                 },\n             )\n             .0;"}, {"sha": "4a26fc4c5ddfb5691bdea61e361d3665cc016d68", "filename": "src/utils.rs", "status": "modified", "additions": 11, "deletions": 2, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/c4611a0e6bda21408f814bfaeb5d961fc84c25ff/src%2Futils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c4611a0e6bda21408f814bfaeb5d961fc84c25ff/src%2Futils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Futils.rs?ref=c4611a0e6bda21408f814bfaeb5d961fc84c25ff", "patch": "@@ -526,8 +526,10 @@ pub fn trim_left_preserve_layout(orig: &str, indent: Indent, config: &Config) ->\n                 Some(get_prefix_space_width(config, &line))\n             };\n \n-            let new_veto_trim_value = (kind.is_string()\n-                || (config.version() == Version::Two && kind.is_commented_string()))\n+            // just InString{Commented} in order to allow the start of a string to be indented\n+            let new_veto_trim_value = (kind == FullCodeCharKind::InString\n+                || (config.version() == Version::Two\n+                    && kind == FullCodeCharKind::InStringCommented))\n                 && !line.ends_with('\\\\');\n             let line = if veto_trim || new_veto_trim_value {\n                 veto_trim = new_veto_trim_value;\n@@ -574,6 +576,13 @@ pub fn trim_left_preserve_layout(orig: &str, indent: Indent, config: &Config) ->\n     )\n }\n \n+/// Based on the given line, determine if the next line can be indented or not.\n+/// This allows to preserve the indentation of multi-line literals.\n+pub fn indent_next_line(kind: FullCodeCharKind, line: &str, config: &Config) -> bool {\n+    !(kind.is_string() || (config.version() == Version::Two && kind.is_commented_string()))\n+        || line.ends_with('\\\\')\n+}\n+\n pub fn is_empty_line(s: &str) -> bool {\n     s.is_empty() || s.chars().all(char::is_whitespace)\n }"}, {"sha": "c037584fd71078218e7a19f356727021e34d5eec", "filename": "tests/source/issue-3302.rs", "status": "added", "additions": 43, "deletions": 0, "changes": 43, "blob_url": "https://github.com/rust-lang/rust/blob/c4611a0e6bda21408f814bfaeb5d961fc84c25ff/tests%2Fsource%2Fissue-3302.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c4611a0e6bda21408f814bfaeb5d961fc84c25ff/tests%2Fsource%2Fissue-3302.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fissue-3302.rs?ref=c4611a0e6bda21408f814bfaeb5d961fc84c25ff", "patch": "@@ -0,0 +1,43 @@\n+// rustfmt-version: Two\n+\n+macro_rules! moo1 {\n+    () => {\n+        bar! {\n+\"\n+\"\n+        }\n+    };\n+}\n+\n+macro_rules! moo2 {\n+    () => {\n+        bar! {\n+        \"\n+\"\n+        }\n+    };\n+}\n+\n+macro_rules! moo3 {\n+    () => {\n+        42\n+        /*\n+        bar! {\n+        \"\n+        toto\n+tata\"\n+        }\n+        */\n+    };\n+}\n+\n+macro_rules! moo4 {\n+    () => {\n+        bar! {\n+\"\n+    foo\n+        bar\n+baz\"\n+        }\n+    };\n+}"}, {"sha": "146cb983819339bd6112c5428203cf30613cee6d", "filename": "tests/target/issue-3302.rs", "status": "added", "additions": 43, "deletions": 0, "changes": 43, "blob_url": "https://github.com/rust-lang/rust/blob/c4611a0e6bda21408f814bfaeb5d961fc84c25ff/tests%2Ftarget%2Fissue-3302.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c4611a0e6bda21408f814bfaeb5d961fc84c25ff/tests%2Ftarget%2Fissue-3302.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fissue-3302.rs?ref=c4611a0e6bda21408f814bfaeb5d961fc84c25ff", "patch": "@@ -0,0 +1,43 @@\n+// rustfmt-version: Two\n+\n+macro_rules! moo1 {\n+    () => {\n+        bar! {\n+        \"\n+\"\n+        }\n+    };\n+}\n+\n+macro_rules! moo2 {\n+    () => {\n+        bar! {\n+        \"\n+\"\n+        }\n+    };\n+}\n+\n+macro_rules! moo3 {\n+    () => {\n+        42\n+        /*\n+        bar! {\n+        \"\n+        toto\n+tata\"\n+        }\n+        */\n+    };\n+}\n+\n+macro_rules! moo4 {\n+    () => {\n+        bar! {\n+        \"\n+    foo\n+        bar\n+baz\"\n+        }\n+    };\n+}"}]}