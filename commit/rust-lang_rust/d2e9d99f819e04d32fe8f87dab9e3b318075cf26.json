{"sha": "d2e9d99f819e04d32fe8f87dab9e3b318075cf26", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQyZTlkOTlmODE5ZTA0ZDMyZmU4Zjg3ZGFiOWUzYjMxODA3NWNmMjY=", "commit": {"author": {"name": "Eric Holk", "email": "eric.holk@gmail.com", "date": "2012-08-11T00:15:31Z"}, "committer": {"name": "Eric Holk", "email": "eric.holk@gmail.com", "date": "2012-08-11T01:19:42Z"}, "message": "Handle failure during select nicely. Fixes #3176", "tree": {"sha": "f7a3d311f77f38b667c935cf80d18f7c97e62930", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f7a3d311f77f38b667c935cf80d18f7c97e62930"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d2e9d99f819e04d32fe8f87dab9e3b318075cf26", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d2e9d99f819e04d32fe8f87dab9e3b318075cf26", "html_url": "https://github.com/rust-lang/rust/commit/d2e9d99f819e04d32fe8f87dab9e3b318075cf26", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d2e9d99f819e04d32fe8f87dab9e3b318075cf26/comments", "author": {"login": "eholk", "id": 105766, "node_id": "MDQ6VXNlcjEwNTc2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/105766?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eholk", "html_url": "https://github.com/eholk", "followers_url": "https://api.github.com/users/eholk/followers", "following_url": "https://api.github.com/users/eholk/following{/other_user}", "gists_url": "https://api.github.com/users/eholk/gists{/gist_id}", "starred_url": "https://api.github.com/users/eholk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eholk/subscriptions", "organizations_url": "https://api.github.com/users/eholk/orgs", "repos_url": "https://api.github.com/users/eholk/repos", "events_url": "https://api.github.com/users/eholk/events{/privacy}", "received_events_url": "https://api.github.com/users/eholk/received_events", "type": "User", "site_admin": false}, "committer": {"login": "eholk", "id": 105766, "node_id": "MDQ6VXNlcjEwNTc2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/105766?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eholk", "html_url": "https://github.com/eholk", "followers_url": "https://api.github.com/users/eholk/followers", "following_url": "https://api.github.com/users/eholk/following{/other_user}", "gists_url": "https://api.github.com/users/eholk/gists{/gist_id}", "starred_url": "https://api.github.com/users/eholk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eholk/subscriptions", "organizations_url": "https://api.github.com/users/eholk/orgs", "repos_url": "https://api.github.com/users/eholk/repos", "events_url": "https://api.github.com/users/eholk/events{/privacy}", "received_events_url": "https://api.github.com/users/eholk/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7634e2911b6cedd7d06bbfd716922c4a750b47ae", "url": "https://api.github.com/repos/rust-lang/rust/commits/7634e2911b6cedd7d06bbfd716922c4a750b47ae", "html_url": "https://github.com/rust-lang/rust/commit/7634e2911b6cedd7d06bbfd716922c4a750b47ae"}], "stats": {"total": 33, "additions": 30, "deletions": 3}, "files": [{"sha": "dfacfcf038cbede5a86cfb24633cafdad5035516", "filename": "src/libcore/pipes.rs", "status": "modified", "additions": 7, "deletions": 3, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/d2e9d99f819e04d32fe8f87dab9e3b318075cf26/src%2Flibcore%2Fpipes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d2e9d99f819e04d32fe8f87dab9e3b318075cf26/src%2Flibcore%2Fpipes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fpipes.rs?ref=d2e9d99f819e04d32fe8f87dab9e3b318075cf26", "patch": "@@ -530,16 +530,20 @@ fn sender_terminate<T: send>(p: *packet<T>) {\n #[doc(hidden)]\n fn receiver_terminate<T: send>(p: *packet<T>) {\n     let p = unsafe { &*p };\n-    assert p.header.blocked_task.is_null();\n     match swap_state_rel(p.header.state, terminated) {\n       empty => {\n+        assert p.header.blocked_task.is_null();\n         // the sender will clean up\n       }\n       blocked => {\n-        // this shouldn't happen.\n-        fail ~\"terminating a blocked packet\"\n+        let old_task = swap_task(p.header.blocked_task, ptr::null());\n+        if !old_task.is_null() {\n+            rustrt::rust_task_deref(old_task);\n+            assert old_task == rustrt::rust_get_task();\n+        }\n       }\n       terminated | full => {\n+        assert p.header.blocked_task.is_null();\n         // I have to clean up, use drop_glue\n       }\n     }"}, {"sha": "e89d6466135fdc6ccc3e2275f28bdceff806039d", "filename": "src/test/run-pass/issue-3176.rs", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/d2e9d99f819e04d32fe8f87dab9e3b318075cf26/src%2Ftest%2Frun-pass%2Fissue-3176.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d2e9d99f819e04d32fe8f87dab9e3b318075cf26/src%2Ftest%2Frun-pass%2Fissue-3176.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fissue-3176.rs?ref=d2e9d99f819e04d32fe8f87dab9e3b318075cf26", "patch": "@@ -0,0 +1,23 @@\n+import pipes::{select2, selectable};\n+\n+fn main() {\n+    let (c,p) = pipes::stream();\n+    do task::try {\n+        let (c2,p2) = pipes::stream();\n+        do task::spawn {\n+            p2.recv();\n+            #error[\"brother fails\"];\n+            fail;\n+        }   \n+        let (c3,p3) = pipes::stream();\n+        c.send(c3);\n+        c2.send(());\n+        #error[\"child blocks\"];\n+        let (c, p) = pipes::stream();\n+        (p, p3).select();\n+        c.send(());\n+    };  \n+    #error[\"parent tries\"];\n+    assert !p.recv().try_send(());\n+    #error(\"all done!\");\n+}"}]}