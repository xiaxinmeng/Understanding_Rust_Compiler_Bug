{"sha": "8ec36d779b760eed8625ec69a983461e2ffe3914", "node_id": "MDY6Q29tbWl0NzI0NzEyOjhlYzM2ZDc3OWI3NjBlZWQ4NjI1ZWM2OWE5ODM0NjFlMmZmZTM5MTQ=", "commit": {"author": {"name": "ILyoan", "email": "ilyoan@gmail.com", "date": "2013-01-29T11:19:23Z"}, "committer": {"name": "ILyoan", "email": "ilyoan@gmail.com", "date": "2013-01-29T12:03:05Z"}, "message": "fix #2673: avoid visiting the same crate twice", "tree": {"sha": "5b1fef224982a8b6f14f21403e68681a252128e9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5b1fef224982a8b6f14f21403e68681a252128e9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8ec36d779b760eed8625ec69a983461e2ffe3914", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8ec36d779b760eed8625ec69a983461e2ffe3914", "html_url": "https://github.com/rust-lang/rust/commit/8ec36d779b760eed8625ec69a983461e2ffe3914", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8ec36d779b760eed8625ec69a983461e2ffe3914/comments", "author": {"login": "ILyoan", "id": 2672194, "node_id": "MDQ6VXNlcjI2NzIxOTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/2672194?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ILyoan", "html_url": "https://github.com/ILyoan", "followers_url": "https://api.github.com/users/ILyoan/followers", "following_url": "https://api.github.com/users/ILyoan/following{/other_user}", "gists_url": "https://api.github.com/users/ILyoan/gists{/gist_id}", "starred_url": "https://api.github.com/users/ILyoan/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ILyoan/subscriptions", "organizations_url": "https://api.github.com/users/ILyoan/orgs", "repos_url": "https://api.github.com/users/ILyoan/repos", "events_url": "https://api.github.com/users/ILyoan/events{/privacy}", "received_events_url": "https://api.github.com/users/ILyoan/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ILyoan", "id": 2672194, "node_id": "MDQ6VXNlcjI2NzIxOTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/2672194?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ILyoan", "html_url": "https://github.com/ILyoan", "followers_url": "https://api.github.com/users/ILyoan/followers", "following_url": "https://api.github.com/users/ILyoan/following{/other_user}", "gists_url": "https://api.github.com/users/ILyoan/gists{/gist_id}", "starred_url": "https://api.github.com/users/ILyoan/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ILyoan/subscriptions", "organizations_url": "https://api.github.com/users/ILyoan/orgs", "repos_url": "https://api.github.com/users/ILyoan/repos", "events_url": "https://api.github.com/users/ILyoan/events{/privacy}", "received_events_url": "https://api.github.com/users/ILyoan/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fc9650b1467a7388e60838ddbeb1755d5fe149b5", "url": "https://api.github.com/repos/rust-lang/rust/commits/fc9650b1467a7388e60838ddbeb1755d5fe149b5", "html_url": "https://github.com/rust-lang/rust/commit/fc9650b1467a7388e60838ddbeb1755d5fe149b5"}], "stats": {"total": 28, "additions": 19, "deletions": 9}, "files": [{"sha": "7faae196000ef5d93aa3ed534ab83b9b4f18f07d", "filename": "src/rt/rust_crate_map.cpp", "status": "modified", "additions": 19, "deletions": 9, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/8ec36d779b760eed8625ec69a983461e2ffe3914/src%2Frt%2Frust_crate_map.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/8ec36d779b760eed8625ec69a983461e2ffe3914/src%2Frt%2Frust_crate_map.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_crate_map.cpp?ref=8ec36d779b760eed8625ec69a983461e2ffe3914", "patch": "@@ -9,6 +9,7 @@\n // except according to those terms.\n \n #include \"rust_crate_map.h\"\n+#include <set>\n \n void iter_module_map(const mod_entry* map,\n                      void (*fn)(const mod_entry* entry, void *cookie),\n@@ -20,18 +21,27 @@ void iter_module_map(const mod_entry* map,\n \n void iter_crate_map(const cratemap* map,\n                     void (*fn)(const mod_entry* map, void *cookie),\n-                    void *cookie) {\n-    // First iterate this crate\n-    iter_module_map(map->entries(), fn, cookie);\n-    // Then recurse on linked crates\n-    // FIXME (#2673) this does double work in diamond-shaped deps. could\n-    //   keep a set of visited addresses, if it turns out to be actually\n-    //   slow\n-    for (cratemap::iterator i = map->begin(), e = map->end(); i != e; ++i) {\n-        iter_crate_map(*i, fn, cookie);\n+                    void *cookie,\n+                    std::set<const cratemap*>& visited) {\n+    if (visited.find(map) == visited.end()) {\n+        // Mark this crate visited\n+        visited.insert(map);\n+        // First iterate this crate\n+        iter_module_map(map->entries(), fn, cookie);\n+        // Then recurse on linked crates\n+        for (cratemap::iterator i = map->begin(),\n+                e = map->end(); i != e; ++i) {\n+            iter_crate_map(*i, fn, cookie, visited);\n+        }\n     }\n }\n \n+void iter_crate_map(const cratemap* map,\n+                    void (*fn)(const mod_entry* map, void *cookie),\n+                    void *cookie) {\n+    std::set<const cratemap*> visited;\n+    iter_crate_map(map, fn, cookie, visited);\n+}\n //\n // Local Variables:\n // mode: C++"}]}