{"sha": "0718eeb64849b00e8f0a5cc4f96603b61ff8c049", "node_id": "MDY6Q29tbWl0NzI0NzEyOjA3MThlZWI2NDg0OWIwMGU4ZjBhNWNjNGY5NjYwM2I2MWZmOGMwNDk=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-12-19T07:35:04Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-12-19T07:35:04Z"}, "message": "Auto merge of #6464 - ahouts:make-needless_update-ignore-non_exhaustive-structs, r=phansch\n\nmake needless_update ignore non_exhaustive structs\n\nchangelog: make `needless_update` lint ignore `non_exhaustive` structs\n\nfixes #6323", "tree": {"sha": "a5e7fe12e44b4d6833f928fc41d4c0aead9aa31d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a5e7fe12e44b4d6833f928fc41d4c0aead9aa31d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0718eeb64849b00e8f0a5cc4f96603b61ff8c049", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0718eeb64849b00e8f0a5cc4f96603b61ff8c049", "html_url": "https://github.com/rust-lang/rust/commit/0718eeb64849b00e8f0a5cc4f96603b61ff8c049", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0718eeb64849b00e8f0a5cc4f96603b61ff8c049/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a898df4fa7e18234ee4fc6d8207378af637685dd", "url": "https://api.github.com/repos/rust-lang/rust/commits/a898df4fa7e18234ee4fc6d8207378af637685dd", "html_url": "https://github.com/rust-lang/rust/commit/a898df4fa7e18234ee4fc6d8207378af637685dd"}, {"sha": "a24c6f14fa89dafc879ad76a185f43bc50f0bbb9", "url": "https://api.github.com/repos/rust-lang/rust/commits/a24c6f14fa89dafc879ad76a185f43bc50f0bbb9", "html_url": "https://github.com/rust-lang/rust/commit/a24c6f14fa89dafc879ad76a185f43bc50f0bbb9"}], "stats": {"total": 20, "additions": 18, "deletions": 2}, "files": [{"sha": "41cf541ecf5ef59d8e814bae9ffde7d72d56f511", "filename": "clippy_lints/src/needless_update.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/0718eeb64849b00e8f0a5cc4f96603b61ff8c049/clippy_lints%2Fsrc%2Fneedless_update.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0718eeb64849b00e8f0a5cc4f96603b61ff8c049/clippy_lints%2Fsrc%2Fneedless_update.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fneedless_update.rs?ref=0718eeb64849b00e8f0a5cc4f96603b61ff8c049", "patch": "@@ -8,6 +8,9 @@ declare_clippy_lint! {\n     /// **What it does:** Checks for needlessly including a base struct on update\n     /// when all fields are changed anyway.\n     ///\n+    /// This lint is not applied to structs marked with\n+    /// [non_exhaustive](https://doc.rust-lang.org/reference/attributes/type_system.html).\n+    ///\n     /// **Why is this bad?** This will cost resources (because the base has to be\n     /// somewhere), and make the code less readable.\n     ///\n@@ -49,7 +52,9 @@ impl<'tcx> LateLintPass<'tcx> for NeedlessUpdate {\n         if let ExprKind::Struct(_, ref fields, Some(ref base)) = expr.kind {\n             let ty = cx.typeck_results().expr_ty(expr);\n             if let ty::Adt(def, _) = ty.kind() {\n-                if fields.len() == def.non_enum_variant().fields.len() {\n+                if fields.len() == def.non_enum_variant().fields.len()\n+                    && !def.variants[0_usize.into()].is_field_list_non_exhaustive()\n+                {\n                     span_lint(\n                         cx,\n                         NEEDLESS_UPDATE,"}, {"sha": "b93ff048a62f21de1f957e5c1df595552dae851d", "filename": "tests/ui/needless_update.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/0718eeb64849b00e8f0a5cc4f96603b61ff8c049/tests%2Fui%2Fneedless_update.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0718eeb64849b00e8f0a5cc4f96603b61ff8c049/tests%2Fui%2Fneedless_update.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fneedless_update.rs?ref=0718eeb64849b00e8f0a5cc4f96603b61ff8c049", "patch": "@@ -6,9 +6,20 @@ struct S {\n     pub b: i32,\n }\n \n+#[non_exhaustive]\n+struct T {\n+    pub x: i32,\n+    pub y: i32,\n+}\n+\n fn main() {\n     let base = S { a: 0, b: 0 };\n     S { ..base }; // no error\n     S { a: 1, ..base }; // no error\n     S { a: 1, b: 1, ..base };\n+\n+    let base = T { x: 0, y: 0 };\n+    T { ..base }; // no error\n+    T { x: 1, ..base }; // no error\n+    T { x: 1, y: 1, ..base }; // no error\n }"}, {"sha": "b154b3b306ddcc1fab314d1d11ef898865015f7c", "filename": "tests/ui/needless_update.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0718eeb64849b00e8f0a5cc4f96603b61ff8c049/tests%2Fui%2Fneedless_update.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/0718eeb64849b00e8f0a5cc4f96603b61ff8c049/tests%2Fui%2Fneedless_update.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fneedless_update.stderr?ref=0718eeb64849b00e8f0a5cc4f96603b61ff8c049", "patch": "@@ -1,5 +1,5 @@\n error: struct update has no effect, all the fields in the struct have already been specified\n-  --> $DIR/needless_update.rs:13:23\n+  --> $DIR/needless_update.rs:19:23\n    |\n LL |     S { a: 1, b: 1, ..base };\n    |                       ^^^^"}]}