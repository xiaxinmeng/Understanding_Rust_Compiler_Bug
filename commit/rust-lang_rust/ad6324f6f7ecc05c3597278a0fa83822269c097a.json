{"sha": "ad6324f6f7ecc05c3597278a0fa83822269c097a", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFkNjMyNGY2ZjdlY2MwNWMzNTk3Mjc4YTBmYTgzODIyMjY5YzA5N2E=", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2017-11-18T16:30:19Z"}, "committer": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2017-11-19T11:14:56Z"}, "message": "Fix path search in docs", "tree": {"sha": "a3d2c5b1ab90e79cd7032ac1d0e32d50fe559040", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a3d2c5b1ab90e79cd7032ac1d0e32d50fe559040"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ad6324f6f7ecc05c3597278a0fa83822269c097a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ad6324f6f7ecc05c3597278a0fa83822269c097a", "html_url": "https://github.com/rust-lang/rust/commit/ad6324f6f7ecc05c3597278a0fa83822269c097a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ad6324f6f7ecc05c3597278a0fa83822269c097a/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "18250b0349848fbfca53153cf121724c773dd508", "url": "https://api.github.com/repos/rust-lang/rust/commits/18250b0349848fbfca53153cf121724c773dd508", "html_url": "https://github.com/rust-lang/rust/commit/18250b0349848fbfca53153cf121724c773dd508"}], "stats": {"total": 196, "additions": 114, "deletions": 82}, "files": [{"sha": "2f83585d70832a5f49963e6109c7382cfc41599d", "filename": "src/librustdoc/html/static/main.js", "status": "modified", "additions": 114, "deletions": 82, "changes": 196, "blob_url": "https://github.com/rust-lang/rust/blob/ad6324f6f7ecc05c3597278a0fa83822269c097a/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fmain.js", "raw_url": "https://github.com/rust-lang/rust/raw/ad6324f6f7ecc05c3597278a0fa83822269c097a/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fmain.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fmain.js?ref=ad6324f6f7ecc05c3597278a0fa83822269c097a", "patch": "@@ -374,11 +374,10 @@\n                 results = {},\n                 split = valLower.split(\"::\");\n \n-            // remove empty keywords\n-            for (var j = 0; j < split.length; ++j) {\n-                split[j].toLowerCase();\n-                if (split[j] === \"\") {\n-                    split.splice(j, 1);\n+            for (var z = 0; z < split.length; ++z) {\n+                if (split[z] === \"\") {\n+                    split.slice(z, 1);\n+                    z -= 1;\n                 }\n             }\n \n@@ -405,9 +404,7 @@\n                     if (obj.generics &&\n                         obj.generics.length >= val.generics.length) {\n                         var elems = obj.generics.slice(0);\n-                        for (var y = 0;\n-                             y < val.generics.length;\n-                             ++y) {\n+                        for (var y = 0; y < val.generics.length; ++y) {\n                             // The point here is to find the type that matches the most.\n                             var lev = { pos: -1, lev: MAX_LEV_DISTANCE + 1};\n                             for (var x = 0; x < elems.length; ++x) {\n@@ -529,6 +526,22 @@\n                 return literalSearch === true ? false : lev_distance;\n             }\n \n+            function checkPath(startsWith, ty) {\n+                var lev_total = 0;\n+                var path = ty.path.split(\"::\");\n+                if (startsWith.length > path.length) {\n+                    return MAX_LEV_DISTANCE + 1;\n+                }\n+                for (var i = path.length - 1; i < startsWith.length; ++i) {\n+                    var lev = levenshtein(startsWith[i], path[i]);\n+                    if (lev > MAX_LEV_DISTANCE) {\n+                        return MAX_LEV_DISTANCE + 1;\n+                    }\n+                    lev_total += lev;\n+                }\n+                return Math.round(lev_total / startsWith.length);\n+            }\n+\n             function typePassesFilter(filter, type) {\n                 // No filter\n                 if (filter < 0) return true;\n@@ -665,85 +678,106 @@\n                 query.search = val;\n                 // gather matching search results up to a certain maximum\n                 val = val.replace(/\\_/g, \"\");\n-                var valGenerics = extractGenerics(val);\n+\n                 var results_length = 0;\n-                for (var i = 0; i < split.length; ++i) {\n-                    for (var j = 0; j < nSearchWords; ++j) {\n-                        var lev_distance;\n-                        var ty = searchIndex[j];\n-                        if (!ty) {\n+                var valGenerics = extractGenerics(val);\n+\n+                var paths = valLower.split(\"::\");\n+                var j;\n+                for (j = 0; j < paths.length; ++j) {\n+                    if (paths[j] === \"\") {\n+                        paths.splice(j, 1);\n+                        j -= 1;\n+                    }\n+                }\n+                val = paths[paths.length - 1];\n+                var startsWith = paths.slice(0, paths.length > 1 ? paths.length - 1 : 1);\n+\n+                for (j = 0; j < nSearchWords; ++j) {\n+                    var lev_distance;\n+                    var ty = searchIndex[j];\n+                    if (!ty) {\n+                        continue;\n+                    }\n+                    var lev_add = 0;\n+                    if (paths.length > 1) {\n+                        var lev = checkPath(startsWith, ty);\n+                        if (lev > MAX_LEV_DISTANCE) {\n                             continue;\n+                        } else if (lev > 0) {\n+                            lev_add = 1;\n                         }\n-                        var returned = false;\n-                        var in_args = false;\n-                        var index = -1;\n-                        // we want lev results to go lower than others\n-                        var lev = MAX_LEV_DISTANCE;\n-                        var fullId = itemTypes[ty.ty] + ty.path + ty.name;\n-\n-                        if (searchWords[j].indexOf(split[i]) > -1 ||\n-                            searchWords[j].indexOf(val) > -1 ||\n-                            searchWords[j].replace(/_/g, \"\").indexOf(val) > -1)\n-                        {\n-                            // filter type: ... queries\n-                            if (typePassesFilter(typeFilter, ty) &&\n-                                results[fullId] === undefined) {\n-                                index = searchWords[j].replace(/_/g, \"\").indexOf(val);\n-                            }\n+                    }\n+\n+                    var returned = false;\n+                    var in_args = false;\n+                    var index = -1;\n+                    // we want lev results to go lower than others\n+                    var lev = MAX_LEV_DISTANCE + 1;\n+                    var fullId = itemTypes[ty.ty] + ty.path + ty.name;\n+\n+                    if (searchWords[j].indexOf(val) > -1 ||\n+                        searchWords[j].replace(/_/g, \"\").indexOf(val) > -1)\n+                    {\n+                        // filter type: ... queries\n+                        if (typePassesFilter(typeFilter, ty) &&\n+                            results[fullId] === undefined) {\n+                            index = searchWords[j].replace(/_/g, \"\").indexOf(val);\n                         }\n-                        if ((lev_distance = levenshtein(searchWords[j], val)) <= MAX_LEV_DISTANCE) {\n-                            if (typePassesFilter(typeFilter, ty) &&\n-                                (results[fullId] === undefined ||\n-                                 results[fullId].lev > lev_distance)) {\n-                                lev = Math.min(lev, lev_distance);\n-                                index = Math.max(0, index);\n-                            }\n+                    }\n+                    if ((lev_distance = levenshtein(searchWords[j], val)) <= MAX_LEV_DISTANCE) {\n+                        if (typePassesFilter(typeFilter, ty) &&\n+                            (results[fullId] === undefined ||\n+                             results[fullId].lev > lev_distance)) {\n+                            lev = Math.min(lev, lev_distance);\n+                            index = Math.max(0, index);\n                         }\n-                        if ((lev_distance = findArg(searchIndex[j], valGenerics))\n-                            <= MAX_LEV_DISTANCE) {\n-                            if (typePassesFilter(typeFilter, ty) &&\n-                                (results[fullId] === undefined ||\n-                                 results[fullId].lev > lev_distance)) {\n-                                in_args = true;\n-                                lev = Math.min(lev_distance, lev);\n-                                index = Math.max(0, index);\n-                            }\n+                    }\n+                    if ((lev_distance = findArg(searchIndex[j], valGenerics))\n+                        <= MAX_LEV_DISTANCE) {\n+                        if (typePassesFilter(typeFilter, ty) &&\n+                            (results[fullId] === undefined ||\n+                             results[fullId].lev > lev_distance)) {\n+                            in_args = true;\n+                            lev = Math.min(lev_distance, lev);\n+                            index = Math.max(0, index);\n                         }\n-                        if ((lev_distance = checkReturned(searchIndex[j], valGenerics)) <=\n-                            MAX_LEV_DISTANCE) {\n-                            if (typePassesFilter(typeFilter, ty) &&\n-                                (results[fullId] === undefined ||\n-                                 results[fullId].lev > lev_distance)) {\n-                                returned = true;\n-                                lev = Math.min(lev_distance, lev);\n-                                index = Math.max(0, index);\n-                            }\n+                    }\n+                    if ((lev_distance = checkReturned(searchIndex[j], valGenerics)) <=\n+                        MAX_LEV_DISTANCE) {\n+                        if (typePassesFilter(typeFilter, ty) &&\n+                            (results[fullId] === undefined ||\n+                             results[fullId].lev > lev_distance)) {\n+                            returned = true;\n+                            lev = Math.min(lev_distance, lev);\n+                            index = Math.max(0, index);\n                         }\n-                        if (index !== -1) {\n-                            if (results[fullId] === undefined) {\n-                                results[fullId] = {\n-                                    id: j,\n-                                    index: index,\n-                                    lev: lev,\n-                                    in_args: in_args,\n-                                    returned: returned,\n-                                };\n-                                results_length += 1;\n-                            } else {\n-                                if (results[fullId].lev > lev) {\n-                                    results[fullId].lev = lev;\n-                                }\n-                                if (in_args === true) {\n-                                    results[fullId].in_args = true;\n-                                }\n-                                if (returned === true) {\n-                                    results[fullId].returned = true;\n-                                }\n+                    }\n+                    lev += lev_add;\n+                    if (index !== -1) {\n+                        if (results[fullId] === undefined) {\n+                            results[fullId] = {\n+                                id: j,\n+                                index: index,\n+                                lev: lev,\n+                                in_args: in_args,\n+                                returned: returned,\n+                            };\n+                            results_length += 1;\n+                        } else {\n+                            if (results[fullId].lev > lev) {\n+                                results[fullId].lev = lev;\n+                            }\n+                            if (in_args === true) {\n+                                results[fullId].in_args = true;\n+                            }\n+                            if (returned === true) {\n+                                results[fullId].returned = true;\n                             }\n                         }\n-                        if (results_length === max) {\n-                            break;\n-                        }\n+                    }\n+                    if (results_length === max) {\n+                        break;\n                     }\n                 }\n             }\n@@ -834,16 +868,14 @@\n                 var result = results[i];\n \n                 // this validation does not make sense when searching by types\n-                if (result.dontValidate) {\n+                if (result.dontValidate || result.returned === true && result.param === true) {\n                     continue;\n                 }\n                 var name = result.item.name.toLowerCase(),\n                     path = result.item.path.toLowerCase(),\n                     parent = result.item.parent;\n \n-                if (result.returned === false && result.param === false &&\n-                    validateResult(name, path, split, parent) === false)\n-                {\n+                if (validateResult(name, path, split, parent) === false) {\n                     result.id = -1;\n                 }\n             }"}]}