{"sha": "ef38662d044714f55c87a12571bd30da51c199aa", "node_id": "C_kwDOAAsO6NoAKGVmMzg2NjJkMDQ0NzE0ZjU1Yzg3YTEyNTcxYmQzMGRhNTFjMTk5YWE", "commit": {"author": {"name": "est31", "email": "MTest31@outlook.com", "date": "2023-05-18T08:33:35Z"}, "committer": {"name": "est31", "email": "MTest31@outlook.com", "date": "2023-05-18T09:16:57Z"}, "message": "Some improvements to the manual_let_else lint suggestions\n\n* Replace variables inside | patterns in the if let: let v = if let V::A(v) | V::B(v) = v { v } else ...\n* Support nested patterns: let v = if let Ok(Ok(Ok(v))) = v { v } else ...\n* Support tuple structs with more than one arg: let v = V::W(v, _) = v { v } else ...\n* Correctly handle .. in tuple struct patterns: let v = V::X(v, ..) = v { v } else ...", "tree": {"sha": "d9811c3a7ff6036b8e1b59b0a25ad4c4a85766bb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d9811c3a7ff6036b8e1b59b0a25ad4c4a85766bb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ef38662d044714f55c87a12571bd30da51c199aa", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ef38662d044714f55c87a12571bd30da51c199aa", "html_url": "https://github.com/rust-lang/rust/commit/ef38662d044714f55c87a12571bd30da51c199aa", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ef38662d044714f55c87a12571bd30da51c199aa/comments", "author": {"login": "est31", "id": 8872119, "node_id": "MDQ6VXNlcjg4NzIxMTk=", "avatar_url": "https://avatars.githubusercontent.com/u/8872119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/est31", "html_url": "https://github.com/est31", "followers_url": "https://api.github.com/users/est31/followers", "following_url": "https://api.github.com/users/est31/following{/other_user}", "gists_url": "https://api.github.com/users/est31/gists{/gist_id}", "starred_url": "https://api.github.com/users/est31/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/est31/subscriptions", "organizations_url": "https://api.github.com/users/est31/orgs", "repos_url": "https://api.github.com/users/est31/repos", "events_url": "https://api.github.com/users/est31/events{/privacy}", "received_events_url": "https://api.github.com/users/est31/received_events", "type": "User", "site_admin": false}, "committer": {"login": "est31", "id": 8872119, "node_id": "MDQ6VXNlcjg4NzIxMTk=", "avatar_url": "https://avatars.githubusercontent.com/u/8872119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/est31", "html_url": "https://github.com/est31", "followers_url": "https://api.github.com/users/est31/followers", "following_url": "https://api.github.com/users/est31/following{/other_user}", "gists_url": "https://api.github.com/users/est31/gists{/gist_id}", "starred_url": "https://api.github.com/users/est31/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/est31/subscriptions", "organizations_url": "https://api.github.com/users/est31/orgs", "repos_url": "https://api.github.com/users/est31/repos", "events_url": "https://api.github.com/users/est31/events{/privacy}", "received_events_url": "https://api.github.com/users/est31/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "83a4b0987f54afbfaad8fed61882231a6632bc71", "url": "https://api.github.com/repos/rust-lang/rust/commits/83a4b0987f54afbfaad8fed61882231a6632bc71", "html_url": "https://github.com/rust-lang/rust/commit/83a4b0987f54afbfaad8fed61882231a6632bc71"}], "stats": {"total": 128, "additions": 97, "deletions": 31}, "files": [{"sha": "389b0a4a62dc55b70a2df1acd7da510a6e34995b", "filename": "clippy_lints/src/manual_let_else.rs", "status": "modified", "additions": 52, "deletions": 19, "changes": 71, "blob_url": "https://github.com/rust-lang/rust/blob/ef38662d044714f55c87a12571bd30da51c199aa/clippy_lints%2Fsrc%2Fmanual_let_else.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ef38662d044714f55c87a12571bd30da51c199aa/clippy_lints%2Fsrc%2Fmanual_let_else.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmanual_let_else.rs?ref=ef38662d044714f55c87a12571bd30da51c199aa", "patch": "@@ -146,10 +146,9 @@ fn emit_manual_let_else(\n         \"this could be rewritten as `let...else`\",\n         |diag| {\n             // This is far from perfect, for example there needs to be:\n-            // * mut additions for the bindings\n-            // * renamings of the bindings for `PatKind::Or`\n+            // * tracking for multi-binding cases: let (foo, bar) = if let (Some(foo), Ok(bar)) = ...\n+            // * renamings of the bindings for many `PatKind`s like structs, slices, etc.\n             // * unused binding collision detection with existing ones\n-            // * putting patterns with at the top level | inside ()\n             // for this to be machine applicable.\n             let mut app = Applicability::HasPlaceholders;\n             let (sn_expr, _) = snippet_with_context(cx, expr.span, span.ctxt(), \"\", &mut app);\n@@ -160,28 +159,62 @@ fn emit_manual_let_else(\n             } else {\n                 format!(\"{{ {sn_else} }}\")\n             };\n-            let sn_bl = match pat.kind {\n-                PatKind::Or(..) => {\n-                    let (sn_pat, _) = snippet_with_context(cx, pat.span, span.ctxt(), \"\", &mut app);\n-                    format!(\"({sn_pat})\")\n-                },\n-                // Replace the variable name iff `TupleStruct` has one argument like `Variant(v)`.\n-                PatKind::TupleStruct(ref w, args, ..) if args.len() == 1 => {\n-                    let sn_wrapper = cx.sess().source_map().span_to_snippet(w.span()).unwrap_or_default();\n-                    let (sn_inner, _) = snippet_with_context(cx, local.span, span.ctxt(), \"\", &mut app);\n-                    format!(\"{sn_wrapper}({sn_inner})\")\n-                },\n-                _ => {\n-                    let (sn_pat, _) = snippet_with_context(cx, pat.span, span.ctxt(), \"\", &mut app);\n-                    sn_pat.into_owned()\n-                },\n-            };\n+            let sn_bl = replace_in_pattern(cx, span, local, pat, &mut app);\n             let sugg = format!(\"let {sn_bl} = {sn_expr} else {else_bl};\");\n             diag.span_suggestion(span, \"consider writing\", sugg, app);\n         },\n     );\n }\n \n+// replaces the locals in the pattern\n+fn replace_in_pattern(\n+    cx: &LateContext<'_>,\n+    span: Span,\n+    local: &Pat<'_>,\n+    pat: &Pat<'_>,\n+    app: &mut Applicability,\n+) -> String {\n+    let mut bindings_count = 0;\n+    pat.each_binding_or_first(&mut |_, _, _, _| bindings_count += 1);\n+    // If the pattern creates multiple bindings, exit early,\n+    // as otherwise we might paste the pattern to the positions of multiple bindings.\n+    if bindings_count > 1 {\n+        let (sn_pat, _) = snippet_with_context(cx, pat.span, span.ctxt(), \"\", app);\n+        return sn_pat.into_owned();\n+    }\n+\n+    match pat.kind {\n+        PatKind::Binding(..) => {\n+            let (sn_bdg, _) = snippet_with_context(cx, local.span, span.ctxt(), \"\", app);\n+            return sn_bdg.to_string();\n+        },\n+        PatKind::Or(pats) => {\n+            let patterns = pats\n+                .iter()\n+                .map(|pat| replace_in_pattern(cx, span, local, pat, app))\n+                .collect::<Vec<_>>();\n+            let or_pat = patterns.join(\" | \");\n+            return format!(\"({or_pat})\");\n+        },\n+        // Replace the variable name iff `TupleStruct` has one argument like `Variant(v)`.\n+        PatKind::TupleStruct(ref w, args, dot_dot_pos) => {\n+            let mut args = args\n+                .iter()\n+                .map(|pat| replace_in_pattern(cx, span, local, pat, app))\n+                .collect::<Vec<_>>();\n+            if let Some(pos) = dot_dot_pos.as_opt_usize() {\n+                args.insert(pos, \"..\".to_owned());\n+            }\n+            let args = args.join(\", \");\n+            let sn_wrapper = cx.sess().source_map().span_to_snippet(w.span()).unwrap_or_default();\n+            return format!(\"{sn_wrapper}({args})\");\n+        },\n+        _ => {},\n+    }\n+    let (sn_pat, _) = snippet_with_context(cx, pat.span, span.ctxt(), \"\", app);\n+    sn_pat.into_owned()\n+}\n+\n /// Check whether an expression is divergent. May give false negatives.\n fn expr_diverges(cx: &LateContext<'_>, expr: &Expr<'_>) -> bool {\n     struct V<'cx, 'tcx> {"}, {"sha": "351ea0e4f509ea9919fc00ab392816d694d4c820", "filename": "tests/ui/manual_let_else.rs", "status": "modified", "additions": 13, "deletions": 3, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/ef38662d044714f55c87a12571bd30da51c199aa/tests%2Fui%2Fmanual_let_else.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ef38662d044714f55c87a12571bd30da51c199aa/tests%2Fui%2Fmanual_let_else.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmanual_let_else.rs?ref=ef38662d044714f55c87a12571bd30da51c199aa", "patch": "@@ -146,10 +146,20 @@ fn fire() {\n         Variant::A(0, 0)\n     }\n \n-    // Should not be renamed\n     let v = if let Variant::A(a, 0) = e() { a } else { return };\n-    // Should be renamed\n-    let v = if let Variant::B(b) = e() { b } else { return };\n+\n+    // `mut v` is inserted into the pattern\n+    let mut v = if let Variant::B(b) = e() { b } else { return };\n+\n+    // Nesting works\n+    let nested = Ok(Some(e()));\n+    let v = if let Ok(Some(Variant::B(b))) | Err(Some(Variant::A(b, _))) = nested {\n+        b\n+    } else {\n+        return;\n+    };\n+    // dot dot works\n+    let v = if let Variant::A(.., a) = e() { a } else { return };\n }\n \n fn not_fire() {"}, {"sha": "0e876797134746dc3bafb84959730d6e6b017eae", "filename": "tests/ui/manual_let_else.stderr", "status": "modified", "additions": 29, "deletions": 6, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/ef38662d044714f55c87a12571bd30da51c199aa/tests%2Fui%2Fmanual_let_else.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/ef38662d044714f55c87a12571bd30da51c199aa/tests%2Fui%2Fmanual_let_else.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmanual_let_else.stderr?ref=ef38662d044714f55c87a12571bd30da51c199aa", "patch": "@@ -260,25 +260,48 @@ LL |     create_binding_if_some!(w, g());\n    = note: this error originates in the macro `create_binding_if_some` (in Nightly builds, run with -Z macro-backtrace for more info)\n \n error: this could be rewritten as `let...else`\n-  --> $DIR/manual_let_else.rs:150:5\n+  --> $DIR/manual_let_else.rs:149:5\n    |\n LL |     let v = if let Variant::A(a, 0) = e() { a } else { return };\n-   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: consider writing: `let Variant::A(a, 0) = e() else { return };`\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: consider writing: `let Variant::A(v, 0) = e() else { return };`\n \n error: this could be rewritten as `let...else`\n   --> $DIR/manual_let_else.rs:152:5\n    |\n-LL |     let v = if let Variant::B(b) = e() { b } else { return };\n-   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: consider writing: `let Variant::B(v) = e() else { return };`\n+LL |     let mut v = if let Variant::B(b) = e() { b } else { return };\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: consider writing: `let Variant::B(mut v) = e() else { return };`\n \n error: this could be rewritten as `let...else`\n-  --> $DIR/manual_let_else.rs:262:5\n+  --> $DIR/manual_let_else.rs:156:5\n+   |\n+LL | /     let v = if let Ok(Some(Variant::B(b))) | Err(Some(Variant::A(b, _))) = nested {\n+LL | |         b\n+LL | |     } else {\n+LL | |         return;\n+LL | |     };\n+   | |______^\n+   |\n+help: consider writing\n+   |\n+LL ~     let (Ok(Some(Variant::B(v))) | Err(Some(Variant::A(v, _)))) = nested else {\n+LL +         return;\n+LL +     };\n+   |\n+\n+error: this could be rewritten as `let...else`\n+  --> $DIR/manual_let_else.rs:162:5\n+   |\n+LL |     let v = if let Variant::A(.., a) = e() { a } else { return };\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ help: consider writing: `let Variant::A(.., v) = e() else { return };`\n+\n+error: this could be rewritten as `let...else`\n+  --> $DIR/manual_let_else.rs:272:5\n    |\n LL | /     let _ = match ff {\n LL | |         Some(value) => value,\n LL | |         _ => macro_call!(),\n LL | |     };\n    | |______^ help: consider writing: `let Some(_) = ff else { macro_call!() };`\n \n-error: aborting due to 20 previous errors\n+error: aborting due to 22 previous errors\n "}, {"sha": "dfca3b023cd58259d7e7d683c40266d82a56bc60", "filename": "tests/ui/manual_let_else_match.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ef38662d044714f55c87a12571bd30da51c199aa/tests%2Fui%2Fmanual_let_else_match.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ef38662d044714f55c87a12571bd30da51c199aa/tests%2Fui%2Fmanual_let_else_match.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmanual_let_else_match.rs?ref=ef38662d044714f55c87a12571bd30da51c199aa", "patch": "@@ -68,7 +68,7 @@ fn fire() {\n     let f = Variant::Bar(1);\n \n     let _value = match f {\n-        Variant::Bar(_) | Variant::Baz(_) => (),\n+        Variant::Bar(v) | Variant::Baz(v) => v,\n         _ => return,\n     };\n "}, {"sha": "13ed35bc1d5dbdb8896ae018ce754ac756afc85e", "filename": "tests/ui/manual_let_else_match.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/ef38662d044714f55c87a12571bd30da51c199aa/tests%2Fui%2Fmanual_let_else_match.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/ef38662d044714f55c87a12571bd30da51c199aa/tests%2Fui%2Fmanual_let_else_match.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmanual_let_else_match.stderr?ref=ef38662d044714f55c87a12571bd30da51c199aa", "patch": "@@ -58,10 +58,10 @@ error: this could be rewritten as `let...else`\n   --> $DIR/manual_let_else_match.rs:70:5\n    |\n LL | /     let _value = match f {\n-LL | |         Variant::Bar(_) | Variant::Baz(_) => (),\n+LL | |         Variant::Bar(v) | Variant::Baz(v) => v,\n LL | |         _ => return,\n LL | |     };\n-   | |______^ help: consider writing: `let (Variant::Bar(_) | Variant::Baz(_)) = f else { return };`\n+   | |______^ help: consider writing: `let (Variant::Bar(_value) | Variant::Baz(_value)) = f else { return };`\n \n error: this could be rewritten as `let...else`\n   --> $DIR/manual_let_else_match.rs:76:5"}]}