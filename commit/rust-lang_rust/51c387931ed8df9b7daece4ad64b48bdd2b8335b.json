{"sha": "51c387931ed8df9b7daece4ad64b48bdd2b8335b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUxYzM4NzkzMWVkOGRmOWI3ZGFlY2U0YWQ2NGI0OGJkZDJiODMzNWI=", "commit": {"author": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-09-08T10:28:13Z"}, "committer": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-09-08T10:28:13Z"}, "message": "Rollup merge of #53315 - nikomatsakis:newtype-index, r=Mark-Simulacrum\n\nuse `NonZeroU32` in `newtype_index!`macro, change syntax\n\nVarious improvements to the `newtype_index!` macro:\n\n- Use `NonZeroU32` so that `Option<T>` is cheap\n- More ergonomic helper method, no need to import `Idx` trait all the time\n- Improve syntax to use `struct` keyword so that ripgrep works to find type def'n\n\nFixes https://github.com/rust-lang/rust/issues/50337\n\nI'm curious to see if this passes tests =)", "tree": {"sha": "f5f2ded8fa1727bcfc7324f85691353e6ebe729f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f5f2ded8fa1727bcfc7324f85691353e6ebe729f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/51c387931ed8df9b7daece4ad64b48bdd2b8335b", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEZ1R8CLMp8f2GxWoQ/vbIBR0OATwFAluTpD4ACgkQ/vbIBR0O\nATzgehAAveeEK5vwsTgSJJyIFAcM1pcxz8fhk6aFUQab/P02i4U74HoEn+rN7Av5\nhRd73aAS/nqj8SW2YaQ5iE3WfA5emG6/V0pg4hkOyxlWlu3+Y2IOKWuZa738Jkj9\nvYJ47NamlstwdomgJRoVivKL3qU0K231Kn0mHI/PFXqPmQg4XcvWmzRp0Pn3ctc1\nPwHq79LLc6t+3kQqGpMlRHGW22IlEKDOU19Usft7tin4K6ef5EH4NdcvdUWKUNRN\n2giZIhGAtPDWGt1GaWOfy18auAiA39GFQgHtJXvR+lHyfRR5ZgSG7/KuifuqZS6x\nVD9Ux5xjBzrfoHxZevWMqWTq3rCyvEGkH728qoLDaaj05y6AgGDj18ButOcGG+OJ\nr5Hn9U2HbSEvF51BAJhD23mY0FFT5WAObVXijgKJer7sSedZQNq1aoSAq+VcymAe\nSO//Yt80mqLsAe37H8tYAMnMPAEyyfYb1JlmZV6VUrWIKtwBNGBo5WEiOexPtscg\nH8elZByptgtFODuCw1uyD2e0+NAHr2UjHmLn8DWfPJLKjaTLQHxWUCi+bXnRmCZY\nPH1XniVjCpoc+dNoD0efvvGYipJntW0RUjeI2ICEK7LQBuMzmPTfb0h3v2fVWSbl\n+UzhHeEGwYjod4B21s9c0TP4riPAxNhJ0NxrfIcWtE2hXwmjzz4=\n=wBV9\n-----END PGP SIGNATURE-----", "payload": "tree f5f2ded8fa1727bcfc7324f85691353e6ebe729f\nparent b1ef2b81b93ee53d29a0fe71934eeda52740fb1b\nparent ab43c1e9a43d5c62e0e6ea7442221a2d2f638f7f\nauthor kennytm <kennytm@gmail.com> 1536402493 +0800\ncommitter kennytm <kennytm@gmail.com> 1536402493 +0800\n\nRollup merge of #53315 - nikomatsakis:newtype-index, r=Mark-Simulacrum\n\nuse `NonZeroU32` in `newtype_index!`macro, change syntax\n\nVarious improvements to the `newtype_index!` macro:\n\n- Use `NonZeroU32` so that `Option<T>` is cheap\n- More ergonomic helper method, no need to import `Idx` trait all the time\n- Improve syntax to use `struct` keyword so that ripgrep works to find type def'n\n\nFixes https://github.com/rust-lang/rust/issues/50337\n\nI'm curious to see if this passes tests =)\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/51c387931ed8df9b7daece4ad64b48bdd2b8335b", "html_url": "https://github.com/rust-lang/rust/commit/51c387931ed8df9b7daece4ad64b48bdd2b8335b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/51c387931ed8df9b7daece4ad64b48bdd2b8335b/comments", "author": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b1ef2b81b93ee53d29a0fe71934eeda52740fb1b", "url": "https://api.github.com/repos/rust-lang/rust/commits/b1ef2b81b93ee53d29a0fe71934eeda52740fb1b", "html_url": "https://github.com/rust-lang/rust/commit/b1ef2b81b93ee53d29a0fe71934eeda52740fb1b"}, {"sha": "ab43c1e9a43d5c62e0e6ea7442221a2d2f638f7f", "url": "https://api.github.com/repos/rust-lang/rust/commits/ab43c1e9a43d5c62e0e6ea7442221a2d2f638f7f", "html_url": "https://github.com/rust-lang/rust/commit/ab43c1e9a43d5c62e0e6ea7442221a2d2f638f7f"}], "stats": {"total": 499, "additions": 299, "deletions": 200}, "files": [{"sha": "f5a46060759ddd1440d71243505d2f6a05dcbd45", "filename": "src/librustc/dep_graph/graph.rs", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc%2Fdep_graph%2Fgraph.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc%2Fdep_graph%2Fgraph.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fdep_graph%2Fgraph.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -39,10 +39,12 @@ pub struct DepGraph {\n     fingerprints: Lrc<Lock<IndexVec<DepNodeIndex, Fingerprint>>>\n }\n \n-newtype_index!(DepNodeIndex);\n+newtype_index! {\n+    pub struct DepNodeIndex { .. }\n+}\n \n impl DepNodeIndex {\n-    const INVALID: DepNodeIndex = DepNodeIndex(::std::u32::MAX);\n+    const INVALID: DepNodeIndex = DepNodeIndex::MAX;\n }\n \n #[derive(Copy, Clone, Debug, PartialEq, Eq, Hash)]\n@@ -1125,14 +1127,16 @@ impl DepNodeColorMap {\n         match self.values[index] {\n             COMPRESSED_NONE => None,\n             COMPRESSED_RED => Some(DepNodeColor::Red),\n-            value => Some(DepNodeColor::Green(DepNodeIndex(value - COMPRESSED_FIRST_GREEN)))\n+            value => Some(DepNodeColor::Green(DepNodeIndex::from_u32(\n+                value - COMPRESSED_FIRST_GREEN\n+            )))\n         }\n     }\n \n     fn insert(&mut self, index: SerializedDepNodeIndex, color: DepNodeColor) {\n         self.values[index] = match color {\n             DepNodeColor::Red => COMPRESSED_RED,\n-            DepNodeColor::Green(index) => index.0 + COMPRESSED_FIRST_GREEN,\n+            DepNodeColor::Green(index) => index.as_u32() + COMPRESSED_FIRST_GREEN,\n         }\n     }\n }"}, {"sha": "4c896a33e59c1543e19e63cece80398c78e141a5", "filename": "src/librustc/dep_graph/serialized.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc%2Fdep_graph%2Fserialized.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc%2Fdep_graph%2Fserialized.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fdep_graph%2Fserialized.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -14,7 +14,9 @@ use dep_graph::DepNode;\n use ich::Fingerprint;\n use rustc_data_structures::indexed_vec::{IndexVec, Idx};\n \n-newtype_index!(SerializedDepNodeIndex);\n+newtype_index! {\n+    pub struct SerializedDepNodeIndex { .. }\n+}\n \n /// Data for use when recompiling the **current crate**.\n #[derive(Debug, RustcEncodable, RustcDecodable)]"}, {"sha": "420ffbcfee6cd29f1a6d5f20576a2a7cf132d13b", "filename": "src/librustc/hir/def_id.rs", "status": "modified", "additions": 9, "deletions": 21, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc%2Fhir%2Fdef_id.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc%2Fhir%2Fdef_id.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Fdef_id.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -15,8 +15,8 @@ use serialize;\n use std::fmt;\n use std::u32;\n \n-newtype_index!(CrateNum\n-    {\n+newtype_index! {\n+    pub struct CrateNum {\n         ENCODABLE = custom\n         DEBUG_FORMAT = \"crate{}\",\n \n@@ -27,40 +27,28 @@ newtype_index!(CrateNum\n         /// Virtual crate for builtin macros\n         // FIXME(jseyfried): this is also used for custom derives until proc-macro crates get\n         // `CrateNum`s.\n-        const BUILTIN_MACROS_CRATE = u32::MAX,\n+        const BUILTIN_MACROS_CRATE = CrateNum::MAX_AS_U32,\n \n         /// A CrateNum value that indicates that something is wrong.\n-        const INVALID_CRATE = u32::MAX - 1,\n+        const INVALID_CRATE = CrateNum::MAX_AS_U32 - 1,\n \n         /// A special CrateNum that we use for the tcx.rcache when decoding from\n         /// the incr. comp. cache.\n-        const RESERVED_FOR_INCR_COMP_CACHE = u32::MAX - 2,\n-    });\n+        const RESERVED_FOR_INCR_COMP_CACHE = CrateNum::MAX_AS_U32 - 2,\n+    }\n+}\n \n impl CrateNum {\n     pub fn new(x: usize) -> CrateNum {\n-        assert!(x < (u32::MAX as usize));\n-        CrateNum(x as u32)\n-    }\n-\n-    pub fn from_u32(x: u32) -> CrateNum {\n-        CrateNum(x)\n-    }\n-\n-    pub fn as_usize(&self) -> usize {\n-        self.0 as usize\n-    }\n-\n-    pub fn as_u32(&self) -> u32 {\n-        self.0\n+        CrateNum::from_usize(x)\n     }\n \n     pub fn as_def_id(&self) -> DefId { DefId { krate: *self, index: CRATE_DEF_INDEX } }\n }\n \n impl fmt::Display for CrateNum {\n     fn fmt(&self, f: &mut fmt::Formatter) -> fmt::Result {\n-        fmt::Display::fmt(&self.0, f)\n+        fmt::Display::fmt(&self.as_u32(), f)\n     }\n }\n "}, {"sha": "8b7438cbe63250d4c8e3dfab318a51fe327d716c", "filename": "src/librustc/ich/impls_mir.rs", "status": "modified", "additions": 0, "deletions": 5, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc%2Fich%2Fimpls_mir.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc%2Fich%2Fimpls_mir.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fich%2Fimpls_mir.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -102,7 +102,6 @@ impl<'a> HashStable<StableHashingContext<'a>> for mir::Local {\n     fn hash_stable<W: StableHasherResult>(&self,\n                                           hcx: &mut StableHashingContext<'a>,\n                                           hasher: &mut StableHasher<W>) {\n-        use rustc_data_structures::indexed_vec::Idx;\n         self.index().hash_stable(hcx, hasher);\n     }\n }\n@@ -112,7 +111,6 @@ impl<'a> HashStable<StableHashingContext<'a>> for mir::BasicBlock {\n     fn hash_stable<W: StableHasherResult>(&self,\n                                           hcx: &mut StableHashingContext<'a>,\n                                           hasher: &mut StableHasher<W>) {\n-        use rustc_data_structures::indexed_vec::Idx;\n         self.index().hash_stable(hcx, hasher);\n     }\n }\n@@ -122,7 +120,6 @@ impl<'a> HashStable<StableHashingContext<'a>> for mir::Field {\n     fn hash_stable<W: StableHasherResult>(&self,\n                                           hcx: &mut StableHashingContext<'a>,\n                                           hasher: &mut StableHasher<W>) {\n-        use rustc_data_structures::indexed_vec::Idx;\n         self.index().hash_stable(hcx, hasher);\n     }\n }\n@@ -133,7 +130,6 @@ for mir::SourceScope {\n     fn hash_stable<W: StableHasherResult>(&self,\n                                           hcx: &mut StableHashingContext<'a>,\n                                           hasher: &mut StableHasher<W>) {\n-        use rustc_data_structures::indexed_vec::Idx;\n         self.index().hash_stable(hcx, hasher);\n     }\n }\n@@ -143,7 +139,6 @@ impl<'a> HashStable<StableHashingContext<'a>> for mir::Promoted {\n     fn hash_stable<W: StableHasherResult>(&self,\n                                           hcx: &mut StableHashingContext<'a>,\n                                           hasher: &mut StableHasher<W>) {\n-        use rustc_data_structures::indexed_vec::Idx;\n         self.index().hash_stable(hcx, hasher);\n     }\n }"}, {"sha": "e90c4f62f59d5c0ba3c09b5cd42cd9ec7f38ab92", "filename": "src/librustc/ich/impls_ty.rs", "status": "modified", "additions": 0, "deletions": 3, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc%2Fich%2Fimpls_ty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc%2Fich%2Fimpls_ty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fich%2Fimpls_ty.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -143,7 +143,6 @@ impl<'a> HashStable<StableHashingContext<'a>> for ty::RegionVid {\n     fn hash_stable<W: StableHasherResult>(&self,\n                                           hcx: &mut StableHashingContext<'a>,\n                                           hasher: &mut StableHasher<W>) {\n-        use rustc_data_structures::indexed_vec::Idx;\n         self.index().hash_stable(hcx, hasher);\n     }\n }\n@@ -153,7 +152,6 @@ impl<'gcx> HashStable<StableHashingContext<'gcx>> for ty::CanonicalVar {\n     fn hash_stable<W: StableHasherResult>(&self,\n                                           hcx: &mut StableHashingContext<'gcx>,\n                                           hasher: &mut StableHasher<W>) {\n-        use rustc_data_structures::indexed_vec::Idx;\n         self.index().hash_stable(hcx, hasher);\n     }\n }\n@@ -774,7 +772,6 @@ impl_stable_hash_for!(enum ty::cast::CastKind {\n     FnPtrAddrCast\n });\n \n-impl_stable_hash_for!(tuple_struct ::middle::region::FirstStatementIndex { idx });\n impl_stable_hash_for!(struct ::middle::region::Scope { id, code });\n \n impl<'a> ToStableHashKey<StableHashingContext<'a>> for region::Scope {"}, {"sha": "eabcf1ce4136361878b3879dc62df4271eee517d", "filename": "src/librustc/infer/error_reporting/mod.rs", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc%2Finfer%2Ferror_reporting%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc%2Finfer%2Ferror_reporting%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Finfer%2Ferror_reporting%2Fmod.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -73,8 +73,6 @@ use syntax::ast::DUMMY_NODE_ID;\n use syntax_pos::{Pos, Span};\n use errors::{Applicability, DiagnosticBuilder, DiagnosticStyledString};\n \n-use rustc_data_structures::indexed_vec::Idx;\n-\n mod note;\n \n mod need_type_info;"}, {"sha": "d8f3b9a05bd40f57c3009d3b290a57b06e031672", "filename": "src/librustc/infer/region_constraints/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc%2Finfer%2Fregion_constraints%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc%2Finfer%2Fregion_constraints%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Finfer%2Fregion_constraints%2Fmod.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -16,7 +16,7 @@ use self::CombineMapType::*;\n use super::{MiscVariable, RegionVariableOrigin, SubregionOrigin};\n use super::unify_key;\n \n-use rustc_data_structures::indexed_vec::{IndexVec, Idx};\n+use rustc_data_structures::indexed_vec::IndexVec;\n use rustc_data_structures::fx::{FxHashMap, FxHashSet};\n use rustc_data_structures::unify as ut;\n use ty::{self, Ty, TyCtxt};"}, {"sha": "cdc92877a5ae82e0596f6b256af74e78136852fb", "filename": "src/librustc/infer/unify_key.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc%2Finfer%2Funify_key.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc%2Finfer%2Funify_key.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Finfer%2Funify_key.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -49,8 +49,8 @@ impl UnifyValue for RegionVidKey {\n \n impl UnifyKey for ty::RegionVid {\n     type Value = RegionVidKey;\n-    fn index(&self) -> u32 { self.0 }\n-    fn from_index(i: u32) -> ty::RegionVid { ty::RegionVid(i) }\n+    fn index(&self) -> u32 { u32::from(*self) }\n+    fn from_index(i: u32) -> ty::RegionVid { ty::RegionVid::from(i) }\n     fn tag() -> &'static str { \"RegionVid\" }\n }\n "}, {"sha": "f6a8f8dc172d4c0266b9b73b9547ef3380ede793", "filename": "src/librustc/middle/region.rs", "status": "modified", "additions": 6, "deletions": 4, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc%2Fmiddle%2Fregion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc%2Fmiddle%2Fregion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fregion.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -159,11 +159,13 @@ pub struct BlockRemainder {\n     pub first_statement_index: FirstStatementIndex,\n }\n \n-newtype_index!(FirstStatementIndex\n-    {\n-        pub idx\n+newtype_index! {\n+    pub struct FirstStatementIndex {\n         MAX = SCOPE_DATA_REMAINDER_MAX\n-    });\n+    }\n+}\n+\n+impl_stable_hash_for!(struct ::middle::region::FirstStatementIndex { private });\n \n impl From<ScopeData> for Scope {\n     #[inline]"}, {"sha": "c6a1281061fe430ec6eb5816d34b0194276ba58d", "filename": "src/librustc/mir/mod.rs", "status": "modified", "additions": 25, "deletions": 13, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc%2Fmir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc%2Fmir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmir%2Fmod.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -131,9 +131,6 @@ pub struct Mir<'tcx> {\n     cache: cache::Cache,\n }\n \n-/// where execution begins\n-pub const START_BLOCK: BasicBlock = BasicBlock(0);\n-\n impl<'tcx> Mir<'tcx> {\n     pub fn new(\n         basic_blocks: IndexVec<BasicBlock, BasicBlockData<'tcx>>,\n@@ -239,7 +236,7 @@ impl<'tcx> Mir<'tcx> {\n \n     #[inline]\n     pub fn local_kind(&self, local: Local) -> LocalKind {\n-        let index = local.0 as usize;\n+        let index = local.as_usize();\n         if index == 0 {\n             debug_assert!(\n                 self.local_decls[local].mutability == Mutability::Mut,\n@@ -523,11 +520,12 @@ impl BorrowKind {\n ///////////////////////////////////////////////////////////////////////////\n // Variables and temps\n \n-newtype_index!(Local\n-    {\n+newtype_index! {\n+    pub struct Local {\n         DEBUG_FORMAT = \"_{}\",\n         const RETURN_PLACE = 0,\n-    });\n+    }\n+}\n \n /// Classifies locals into categories. See `Mir::local_kind`.\n #[derive(PartialEq, Eq, Debug)]\n@@ -852,7 +850,12 @@ pub struct UpvarDecl {\n ///////////////////////////////////////////////////////////////////////////\n // BasicBlock\n \n-newtype_index!(BasicBlock { DEBUG_FORMAT = \"bb{}\" });\n+newtype_index! {\n+    pub struct BasicBlock {\n+        DEBUG_FORMAT = \"bb{}\",\n+        const START_BLOCK = 0,\n+    }\n+}\n \n impl BasicBlock {\n     pub fn start_location(self) -> Location {\n@@ -1822,7 +1825,11 @@ pub type PlaceProjection<'tcx> = Projection<'tcx, Place<'tcx>, Local, Ty<'tcx>>;\n /// and the index is a local.\n pub type PlaceElem<'tcx> = ProjectionElem<'tcx, Local, Ty<'tcx>>;\n \n-newtype_index!(Field { DEBUG_FORMAT = \"field[{}]\" });\n+newtype_index! {\n+    pub struct Field {\n+        DEBUG_FORMAT = \"field[{}]\"\n+    }\n+}\n \n impl<'tcx> Place<'tcx> {\n     pub fn field(self, f: Field, ty: Ty<'tcx>) -> Place<'tcx> {\n@@ -1895,11 +1902,12 @@ impl<'tcx> Debug for Place<'tcx> {\n ///////////////////////////////////////////////////////////////////////////\n // Scopes\n \n-newtype_index!(SourceScope\n-    {\n+newtype_index! {\n+    pub struct SourceScope {\n         DEBUG_FORMAT = \"scope[{}]\",\n         const OUTERMOST_SOURCE_SCOPE = 0,\n-    });\n+    }\n+}\n \n #[derive(Clone, Debug, RustcEncodable, RustcDecodable)]\n pub struct SourceScopeData {\n@@ -2271,7 +2279,11 @@ pub struct Constant<'tcx> {\n     pub literal: &'tcx ty::Const<'tcx>,\n }\n \n-newtype_index!(Promoted { DEBUG_FORMAT = \"promoted[{}]\" });\n+newtype_index! {\n+    pub struct Promoted {\n+        DEBUG_FORMAT = \"promoted[{}]\"\n+    }\n+}\n \n impl<'tcx> Debug for Constant<'tcx> {\n     fn fmt(&self, fmt: &mut Formatter) -> fmt::Result {"}, {"sha": "b5ec1ad36ab7efbb903d133562ba6edc12c86762", "filename": "src/librustc/ty/sty.rs", "status": "modified", "additions": 17, "deletions": 26, "changes": 43, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc%2Fty%2Fsty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc%2Fty%2Fsty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fsty.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -1034,11 +1034,12 @@ impl<'a, 'gcx, 'tcx> ParamTy {\n /// is the outer fn.\n ///\n /// [dbi]: http://en.wikipedia.org/wiki/De_Bruijn_index\n-newtype_index!(DebruijnIndex\n-    {\n+newtype_index! {\n+    pub struct DebruijnIndex {\n         DEBUG_FORMAT = \"DebruijnIndex({})\",\n         const INNERMOST = 0,\n-    });\n+    }\n+}\n \n pub type Region<'tcx> = &'tcx RegionKind;\n \n@@ -1176,30 +1177,18 @@ pub struct FloatVid {\n     pub index: u32,\n }\n \n-newtype_index!(RegionVid\n-    {\n-        pub idx\n+newtype_index! {\n+    pub struct RegionVid {\n         DEBUG_FORMAT = custom,\n-    });\n+    }\n+}\n \n impl Atom for RegionVid {\n     fn index(self) -> usize {\n         Idx::index(self)\n     }\n }\n \n-impl From<usize> for RegionVid {\n-    fn from(i: usize) -> RegionVid {\n-        RegionVid::new(i)\n-    }\n-}\n-\n-impl From<RegionVid> for usize {\n-    fn from(vid: RegionVid) -> usize {\n-        Idx::index(vid)\n-    }\n-}\n-\n #[derive(Clone, Copy, PartialEq, Eq, PartialOrd, Ord, Hash, RustcEncodable, RustcDecodable)]\n pub enum InferTy {\n     TyVar(TyVid),\n@@ -1217,7 +1206,9 @@ pub enum InferTy {\n     CanonicalTy(CanonicalVar),\n }\n \n-newtype_index!(CanonicalVar);\n+newtype_index! {\n+    pub struct CanonicalVar { .. }\n+}\n \n /// A `ProjectionPredicate` for an `ExistentialTraitRef`.\n #[derive(Clone, Copy, PartialEq, Eq, PartialOrd, Ord, Hash, Debug, RustcEncodable, RustcDecodable)]\n@@ -1282,8 +1273,8 @@ impl DebruijnIndex {\n     ///\n     /// you would need to shift the index for `'a` into 1 new binder.\n     #[must_use]\n-    pub const fn shifted_in(self, amount: u32) -> DebruijnIndex {\n-        DebruijnIndex(self.0 + amount)\n+    pub fn shifted_in(self, amount: u32) -> DebruijnIndex {\n+        DebruijnIndex::from_u32(self.as_u32() + amount)\n     }\n \n     /// Update this index in place by shifting it \"in\" through\n@@ -1295,8 +1286,8 @@ impl DebruijnIndex {\n     /// Returns the resulting index when this value is moved out from\n     /// `amount` number of new binders.\n     #[must_use]\n-    pub const fn shifted_out(self, amount: u32) -> DebruijnIndex {\n-        DebruijnIndex(self.0 - amount)\n+    pub fn shifted_out(self, amount: u32) -> DebruijnIndex {\n+        DebruijnIndex::from_u32(self.as_u32() - amount)\n     }\n \n     /// Update in place by shifting out from `amount` binders.\n@@ -1325,11 +1316,11 @@ impl DebruijnIndex {\n     /// bound by one of the binders we are shifting out of, that is an\n     /// error (and should fail an assertion failure).\n     pub fn shifted_out_to_binder(self, to_binder: DebruijnIndex) -> Self {\n-        self.shifted_out((to_binder.0 - INNERMOST.0) as u32)\n+        self.shifted_out(to_binder.as_u32() - INNERMOST.as_u32())\n     }\n }\n \n-impl_stable_hash_for!(tuple_struct DebruijnIndex { index });\n+impl_stable_hash_for!(struct DebruijnIndex { private });\n \n /// Region utilities\n impl RegionKind {"}, {"sha": "e8236e21e246342e7f1db270b6b15a63d776a90a", "filename": "src/librustc/util/ppaux.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc%2Futil%2Fppaux.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc%2Futil%2Fppaux.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Futil%2Fppaux.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -26,7 +26,6 @@ use std::cell::Cell;\n use std::fmt;\n use std::usize;\n \n-use rustc_data_structures::indexed_vec::Idx;\n use rustc_target::spec::abi::Abi;\n use syntax::ast::CRATE_NODE_ID;\n use syntax::symbol::{Symbol, InternedString};"}, {"sha": "258fe643c3067cad32126a200fa6a4c2cce90378", "filename": "src/librustc_codegen_llvm/mir/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_codegen_llvm%2Fmir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_codegen_llvm%2Fmir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fmir%2Fmod.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -32,7 +32,7 @@ use syntax::symbol::keywords;\n use std::iter;\n \n use rustc_data_structures::bitvec::BitArray;\n-use rustc_data_structures::indexed_vec::{IndexVec, Idx};\n+use rustc_data_structures::indexed_vec::IndexVec;\n \n pub use self::constant::codegen_static_initializer;\n "}, {"sha": "bfa0e0a451e6f86ad0d40b981ce7fa54743fc125", "filename": "src/librustc_codegen_llvm/mir/operand.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_codegen_llvm%2Fmir%2Foperand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_codegen_llvm%2Fmir%2Foperand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fmir%2Foperand.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -13,7 +13,6 @@ use rustc::mir;\n use rustc::mir::interpret::{ConstValue, ScalarMaybeUndef};\n use rustc::ty;\n use rustc::ty::layout::{self, Align, LayoutOf, TyLayout};\n-use rustc_data_structures::indexed_vec::Idx;\n use rustc_data_structures::sync::Lrc;\n \n use base;"}, {"sha": "4baab1763c31059288385dfe5b9a193482c49945", "filename": "src/librustc_codegen_llvm/mir/place.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_codegen_llvm%2Fmir%2Fplace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_codegen_llvm%2Fmir%2Fplace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fmir%2Fplace.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -13,7 +13,6 @@ use rustc::ty::{self, Ty};\n use rustc::ty::layout::{self, Align, TyLayout, LayoutOf, Size};\n use rustc::mir;\n use rustc::mir::tcx::PlaceTy;\n-use rustc_data_structures::indexed_vec::Idx;\n use base;\n use builder::Builder;\n use common::{CodegenCx, C_undef, C_usize, C_u8, C_u32, C_uint, C_null, C_uint_big};"}, {"sha": "186bc6d43ccc560a0afb47d0fd27ee926167357a", "filename": "src/librustc_data_structures/indexed_vec.rs", "status": "modified", "additions": 151, "deletions": 63, "changes": 214, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_data_structures%2Findexed_vec.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_data_structures%2Findexed_vec.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_data_structures%2Findexed_vec.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -48,25 +48,42 @@ impl Idx for u32 {\n     fn index(self) -> usize { self as usize }\n }\n \n+/// Creates a struct type `S` that can be used as an index with\n+/// `IndexVec` and so on.\n+///\n+/// There are two ways of interacting with these indices:\n+///\n+/// - The `From` impls are the preferred way. So you can do\n+///   `S::from(v)` with a `usize` or `u32`. And you can convert back\n+///   to an integer with `u32::from(s)`.\n+///\n+/// - Alternatively, you can use the methods `S::new(v)` and `s.index()`\n+///   to create/return a value.\n+///\n+/// Internally, the index uses a u32, so the index must not exceed\n+/// `u32::MAX`. You can also customize things like the `Debug` impl,\n+/// what traits are derived, and so forth via the macro.\n #[macro_export]\n macro_rules! newtype_index {\n     // ---- public rules ----\n \n     // Use default constants\n-    ($name:ident) => (\n+    ($v:vis struct $name:ident { .. }) => (\n         newtype_index!(\n             // Leave out derives marker so we can use its absence to ensure it comes first\n             @type         [$name]\n-            @max          [::std::u32::MAX]\n+            @max          [::std::u32::MAX - 1]\n+            @vis          [$v]\n             @debug_format [\"{}\"]);\n     );\n \n     // Define any constants\n-    ($name:ident { $($tokens:tt)+ }) => (\n+    ($v:vis struct $name:ident { $($tokens:tt)+ }) => (\n         newtype_index!(\n             // Leave out derives marker so we can use its absence to ensure it comes first\n             @type         [$name]\n-            @max          [::std::u32::MAX]\n+            @max          [::std::u32::MAX - 1]\n+            @vis          [$v]\n             @debug_format [\"{}\"]\n                           $($tokens)+);\n     );\n@@ -75,55 +92,153 @@ macro_rules! newtype_index {\n \n     // Base case, user-defined constants (if any) have already been defined\n     (@derives      [$($derives:ident,)*]\n-     @pub          [$($pub:tt)*]\n      @type         [$type:ident]\n      @max          [$max:expr]\n+     @vis          [$v:vis]\n      @debug_format [$debug_format:tt]) => (\n         #[derive(Copy, Clone, PartialEq, Eq, Hash, PartialOrd, Ord, $($derives),*)]\n-        pub struct $type($($pub)* u32);\n+        $v struct $type {\n+            private: u32\n+        }\n+\n+        impl $type {\n+            $v const MAX_AS_U32: u32 = $max;\n+\n+            $v const MAX: $type = $type::from_u32_const($max);\n+\n+            #[inline]\n+            $v fn from_usize(value: usize) -> Self {\n+                assert!(value <= ($max as usize));\n+                unsafe {\n+                    $type::from_u32_unchecked(value as u32)\n+                }\n+            }\n+\n+            #[inline]\n+            $v fn from_u32(value: u32) -> Self {\n+                assert!(value <= $max);\n+                unsafe {\n+                    $type::from_u32_unchecked(value)\n+                }\n+            }\n+\n+            /// Hacky variant of `from_u32` for use in constants.\n+            /// This version checks the \"max\" constraint by using an\n+            /// invalid array dereference.\n+            #[inline]\n+            $v const fn from_u32_const(value: u32) -> Self {\n+                // This will fail at const eval time unless `value <=\n+                // max` is true (in which case we get the index 0).\n+                // It will also fail at runtime, of course, but in a\n+                // kind of wacky way.\n+                let _ = [\"out of range value used\"][\n+                    !(value <= $max) as usize\n+                ];\n+\n+                unsafe {\n+                    $type { private: value }\n+                }\n+            }\n+\n+            #[inline]\n+            $v const unsafe fn from_u32_unchecked(value: u32) -> Self {\n+                $type { private: value }\n+            }\n+\n+            /// Extract value of this index as an integer.\n+            #[inline]\n+            $v fn index(self) -> usize {\n+                self.as_usize()\n+            }\n+\n+            /// Extract value of this index as a usize.\n+            #[inline]\n+            $v fn as_u32(self) -> u32 {\n+                self.private\n+            }\n+\n+            /// Extract value of this index as a u32.\n+            #[inline]\n+            $v fn as_usize(self) -> usize {\n+                self.as_u32() as usize\n+            }\n+        }\n \n         impl Idx for $type {\n             #[inline]\n             fn new(value: usize) -> Self {\n-                assert!(value < ($max) as usize);\n-                $type(value as u32)\n+                Self::from(value)\n             }\n \n             #[inline]\n             fn index(self) -> usize {\n-                self.0 as usize\n+                usize::from(self)\n             }\n         }\n \n         impl ::std::iter::Step for $type {\n+            #[inline]\n             fn steps_between(start: &Self, end: &Self) -> Option<usize> {\n                 <usize as ::std::iter::Step>::steps_between(\n                     &Idx::index(*start),\n                     &Idx::index(*end),\n                 )\n             }\n \n+            #[inline]\n             fn replace_one(&mut self) -> Self {\n                 ::std::mem::replace(self, Self::new(1))\n             }\n \n+            #[inline]\n             fn replace_zero(&mut self) -> Self {\n                 ::std::mem::replace(self, Self::new(0))\n             }\n \n+            #[inline]\n             fn add_one(&self) -> Self {\n                 Self::new(Idx::index(*self) + 1)\n             }\n \n+            #[inline]\n             fn sub_one(&self) -> Self {\n                 Self::new(Idx::index(*self) - 1)\n             }\n \n+            #[inline]\n             fn add_usize(&self, u: usize) -> Option<Self> {\n                 Idx::index(*self).checked_add(u).map(Self::new)\n             }\n         }\n \n+        impl From<$type> for u32 {\n+            #[inline]\n+            fn from(v: $type) -> u32 {\n+                v.as_u32()\n+            }\n+        }\n+\n+        impl From<$type> for usize {\n+            #[inline]\n+            fn from(v: $type) -> usize {\n+                v.as_usize()\n+            }\n+        }\n+\n+        impl From<usize> for $type {\n+            #[inline]\n+            fn from(value: usize) -> Self {\n+                $type::from_usize(value)\n+            }\n+        }\n+\n+        impl From<u32> for $type {\n+            #[inline]\n+            fn from(value: u32) -> Self {\n+                $type::from_u32(value)\n+            }\n+        }\n+\n         newtype_index!(\n             @handle_debug\n             @derives      [$($derives,)*]\n@@ -144,7 +259,7 @@ macro_rules! newtype_index {\n      @debug_format [$debug_format:tt]) => (\n         impl ::std::fmt::Debug for $type {\n             fn fmt(&self, fmt: &mut ::std::fmt::Formatter) -> ::std::fmt::Result {\n-                write!(fmt, $debug_format, self.0)\n+                write!(fmt, $debug_format, self.as_u32())\n             }\n         }\n     );\n@@ -167,199 +282,172 @@ macro_rules! newtype_index {\n             @debug_format [$debug_format]);\n     );\n \n-    // Handle the case where someone wants to make the internal field public\n-    (@type         [$type:ident]\n-     @max          [$max:expr]\n-     @debug_format [$debug_format:tt]\n-                   pub idx\n-                   $($tokens:tt)*) => (\n-        newtype_index!(\n-            @pub          [pub]\n-            @type         [$type]\n-            @max          [$max]\n-            @debug_format [$debug_format]\n-                          $($tokens)*);\n-    );\n-\n-    // The default case is that the internal field is private\n-    (@type         [$type:ident]\n-     @max          [$max:expr]\n-     @debug_format [$debug_format:tt]\n-                   $($tokens:tt)*) => (\n-        newtype_index!(\n-            @pub          []\n-            @type         [$type]\n-            @max          [$max]\n-            @debug_format [$debug_format]\n-                          $($tokens)*);\n-    );\n-\n     // Append comma to end of derives list if it's missing\n-    (@pub          [$($pub:tt)*]\n-     @type         [$type:ident]\n+    (@type         [$type:ident]\n      @max          [$max:expr]\n+     @vis          [$v:vis]\n      @debug_format [$debug_format:tt]\n                    derive [$($derives:ident),*]\n                    $($tokens:tt)*) => (\n         newtype_index!(\n-            @pub          [$($pub)*]\n             @type         [$type]\n             @max          [$max]\n+            @vis          [$v]\n             @debug_format [$debug_format]\n                           derive [$($derives,)*]\n                           $($tokens)*);\n     );\n \n     // By not including the @derives marker in this list nor in the default args, we can force it\n     // to come first if it exists. When encodable is custom, just use the derives list as-is.\n-    (@pub          [$($pub:tt)*]\n-     @type         [$type:ident]\n+    (@type         [$type:ident]\n      @max          [$max:expr]\n+     @vis          [$v:vis]\n      @debug_format [$debug_format:tt]\n                    derive [$($derives:ident,)+]\n                    ENCODABLE = custom\n                    $($tokens:tt)*) => (\n         newtype_index!(\n             @derives      [$($derives,)+]\n-            @pub          [$($pub)*]\n             @type         [$type]\n             @max          [$max]\n+            @vis          [$v]\n             @debug_format [$debug_format]\n                           $($tokens)*);\n     );\n \n     // By not including the @derives marker in this list nor in the default args, we can force it\n     // to come first if it exists. When encodable isn't custom, add serialization traits by default.\n-    (@pub          [$($pub:tt)*]\n-     @type         [$type:ident]\n+    (@type         [$type:ident]\n      @max          [$max:expr]\n+     @vis          [$v:vis]\n      @debug_format [$debug_format:tt]\n                    derive [$($derives:ident,)+]\n                    $($tokens:tt)*) => (\n         newtype_index!(\n             @derives      [$($derives,)+ RustcDecodable, RustcEncodable,]\n-            @pub          [$($pub)*]\n             @type         [$type]\n             @max          [$max]\n+            @vis          [$v]\n             @debug_format [$debug_format]\n                           $($tokens)*);\n     );\n \n     // The case where no derives are added, but encodable is overridden. Don't\n     // derive serialization traits\n-    (@pub          [$($pub:tt)*]\n-     @type         [$type:ident]\n+    (@type         [$type:ident]\n      @max          [$max:expr]\n+     @vis          [$v:vis]\n      @debug_format [$debug_format:tt]\n                    ENCODABLE = custom\n                    $($tokens:tt)*) => (\n         newtype_index!(\n             @derives      []\n-            @pub          [$($pub)*]\n             @type         [$type]\n             @max          [$max]\n+            @vis          [$v]\n             @debug_format [$debug_format]\n                           $($tokens)*);\n     );\n \n     // The case where no derives are added, add serialization derives by default\n-    (@pub          [$($pub:tt)*]\n-     @type         [$type:ident]\n+    (@type         [$type:ident]\n      @max          [$max:expr]\n+     @vis          [$v:vis]\n      @debug_format [$debug_format:tt]\n                    $($tokens:tt)*) => (\n         newtype_index!(\n             @derives      [RustcDecodable, RustcEncodable,]\n-            @pub          [$($pub)*]\n             @type         [$type]\n             @max          [$max]\n+            @vis          [$v]\n             @debug_format [$debug_format]\n                           $($tokens)*);\n     );\n \n     // Rewrite final without comma to one that includes comma\n     (@derives      [$($derives:ident,)*]\n-     @pub          [$($pub:tt)*]\n      @type         [$type:ident]\n      @max          [$max:expr]\n+     @vis          [$v:vis]\n      @debug_format [$debug_format:tt]\n                    $name:ident = $constant:expr) => (\n         newtype_index!(\n             @derives      [$($derives,)*]\n-            @pub          [$($pub)*]\n             @type         [$type]\n             @max          [$max]\n+            @vis          [$v]\n             @debug_format [$debug_format]\n                           $name = $constant,);\n     );\n \n     // Rewrite final const without comma to one that includes comma\n     (@derives      [$($derives:ident,)*]\n-     @pub          [$($pub:tt)*]\n      @type         [$type:ident]\n      @max          [$_max:expr]\n+     @vis          [$v:vis]\n      @debug_format [$debug_format:tt]\n                    $(#[doc = $doc:expr])*\n                    const $name:ident = $constant:expr) => (\n         newtype_index!(\n             @derives      [$($derives,)*]\n-            @pub          [$($pub)*]\n             @type         [$type]\n             @max          [$max]\n+            @vis          [$v]\n             @debug_format [$debug_format]\n                           $(#[doc = $doc])* const $name = $constant,);\n     );\n \n     // Replace existing default for max\n     (@derives      [$($derives:ident,)*]\n-     @pub          [$($pub:tt)*]\n      @type         [$type:ident]\n      @max          [$_max:expr]\n+     @vis          [$v:vis]\n      @debug_format [$debug_format:tt]\n                    MAX = $max:expr,\n                    $($tokens:tt)*) => (\n         newtype_index!(\n             @derives      [$($derives,)*]\n-            @pub          [$($pub)*]\n             @type         [$type]\n             @max          [$max]\n+            @vis          [$v]\n             @debug_format [$debug_format]\n                           $($tokens)*);\n     );\n \n     // Replace existing default for debug_format\n     (@derives      [$($derives:ident,)*]\n-     @pub          [$($pub:tt)*]\n      @type         [$type:ident]\n      @max          [$max:expr]\n+     @vis          [$v:vis]\n      @debug_format [$_debug_format:tt]\n                    DEBUG_FORMAT = $debug_format:tt,\n                    $($tokens:tt)*) => (\n         newtype_index!(\n             @derives      [$($derives,)*]\n-            @pub          [$($pub)*]\n             @type         [$type]\n             @max          [$max]\n+            @vis          [$v]\n             @debug_format [$debug_format]\n                           $($tokens)*);\n     );\n \n     // Assign a user-defined constant\n     (@derives      [$($derives:ident,)*]\n-     @pub          [$($pub:tt)*]\n      @type         [$type:ident]\n      @max          [$max:expr]\n+     @vis          [$v:vis]\n      @debug_format [$debug_format:tt]\n                    $(#[doc = $doc:expr])*\n                    const $name:ident = $constant:expr,\n                    $($tokens:tt)*) => (\n         $(#[doc = $doc])*\n-        pub const $name: $type = $type($constant);\n+        pub const $name: $type = $type::from_u32_const($constant);\n         newtype_index!(\n             @derives      [$($derives,)*]\n-            @pub          [$($pub)*]\n             @type         [$type]\n             @max          [$max]\n+            @vis          [$v]\n             @debug_format [$debug_format]\n                           $($tokens)*);\n     );"}, {"sha": "215c44dec6913365cef39f528e2e005e0d4dbb1a", "filename": "src/librustc_data_structures/stable_hasher.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_data_structures%2Fstable_hasher.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_data_structures%2Fstable_hasher.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_data_structures%2Fstable_hasher.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -217,6 +217,14 @@ impl_stable_hash_via_hash!(i128);\n impl_stable_hash_via_hash!(char);\n impl_stable_hash_via_hash!(());\n \n+impl<CTX> HashStable<CTX> for ::std::num::NonZeroU32 {\n+    fn hash_stable<W: StableHasherResult>(&self,\n+                                          ctx: &mut CTX,\n+                                          hasher: &mut StableHasher<W>) {\n+        self.get().hash_stable(ctx, hasher)\n+    }\n+}\n+\n impl<CTX> HashStable<CTX> for f32 {\n     fn hash_stable<W: StableHasherResult>(&self,\n                                           ctx: &mut CTX,"}, {"sha": "57c00f252ef16f0caa647db89595d5453f776283", "filename": "src/librustc_driver/test.rs", "status": "modified", "additions": 14, "deletions": 9, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_driver%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_driver%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Ftest.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -183,8 +183,13 @@ fn test_env_with_pool<F>(\n     });\n }\n \n-const D1: ty::DebruijnIndex = ty::INNERMOST;\n-const D2: ty::DebruijnIndex = D1.shifted_in(1);\n+fn d1() -> ty::DebruijnIndex {\n+    ty::INNERMOST\n+}\n+\n+fn d2() -> ty::DebruijnIndex {\n+    d1().shifted_in(1)\n+}\n \n impl<'a, 'gcx, 'tcx> Env<'a, 'gcx, 'tcx> {\n     pub fn tcx(&self) -> TyCtxt<'a, 'gcx, 'tcx> {\n@@ -337,7 +342,7 @@ impl<'a, 'gcx, 'tcx> Env<'a, 'gcx, 'tcx> {\n     }\n \n     pub fn t_rptr_late_bound(&self, id: u32) -> Ty<'tcx> {\n-        let r = self.re_late_bound_with_debruijn(id, D1);\n+        let r = self.re_late_bound_with_debruijn(id, d1());\n         self.infcx.tcx.mk_imm_ref(r, self.tcx().types.isize)\n     }\n \n@@ -494,7 +499,7 @@ fn subst_ty_renumber_bound() {\n \n         // t_expected = fn(&'a isize)\n         let t_expected = {\n-            let t_ptr_bound2 = env.t_rptr_late_bound_with_debruijn(1, D2);\n+            let t_ptr_bound2 = env.t_rptr_late_bound_with_debruijn(1, d2());\n             env.t_fn(&[t_ptr_bound2], env.t_nil())\n         };\n \n@@ -531,7 +536,7 @@ fn subst_ty_renumber_some_bounds() {\n         //\n         // but not that the Debruijn index is different in the different cases.\n         let t_expected = {\n-            let t_rptr_bound2 = env.t_rptr_late_bound_with_debruijn(1, D2);\n+            let t_rptr_bound2 = env.t_rptr_late_bound_with_debruijn(1, d2());\n             env.t_pair(t_rptr_bound1, env.t_fn(&[t_rptr_bound2], env.t_nil()))\n         };\n \n@@ -559,10 +564,10 @@ fn escaping() {\n         let t_rptr_free1 = env.t_rptr_free(1);\n         assert!(!t_rptr_free1.has_escaping_regions());\n \n-        let t_rptr_bound1 = env.t_rptr_late_bound_with_debruijn(1, D1);\n+        let t_rptr_bound1 = env.t_rptr_late_bound_with_debruijn(1, d1());\n         assert!(t_rptr_bound1.has_escaping_regions());\n \n-        let t_rptr_bound2 = env.t_rptr_late_bound_with_debruijn(1, D2);\n+        let t_rptr_bound2 = env.t_rptr_late_bound_with_debruijn(1, d2());\n         assert!(t_rptr_bound2.has_escaping_regions());\n \n         // t_fn = fn(A)\n@@ -578,7 +583,7 @@ fn escaping() {\n #[test]\n fn subst_region_renumber_region() {\n     test_env(EMPTY_SOURCE_STR, errors(&[]), |env| {\n-        let re_bound1 = env.re_late_bound_with_debruijn(1, D1);\n+        let re_bound1 = env.re_late_bound_with_debruijn(1, d1());\n \n         // type t_source<'a> = fn(&'a isize)\n         let t_source = {\n@@ -593,7 +598,7 @@ fn subst_region_renumber_region() {\n         //\n         // but not that the Debruijn index is different in the different cases.\n         let t_expected = {\n-            let t_rptr_bound2 = env.t_rptr_late_bound_with_debruijn(1, D2);\n+            let t_rptr_bound2 = env.t_rptr_late_bound_with_debruijn(1, d2());\n             env.t_fn(&[t_rptr_bound2], env.t_nil())\n         };\n "}, {"sha": "3f8cd03660c43ab6708420f79eb03509076453cf", "filename": "src/librustc_mir/borrow_check/error_reporting.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Fborrow_check%2Ferror_reporting.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Fborrow_check%2Ferror_reporting.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Ferror_reporting.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -16,7 +16,6 @@ use rustc::mir::{LocalDecl, LocalKind, Location, Operand, Place};\n use rustc::mir::{ProjectionElem, Rvalue, Statement, StatementKind};\n use rustc::ty;\n use rustc_data_structures::fx::FxHashSet;\n-use rustc_data_structures::indexed_vec::Idx;\n use rustc_data_structures::sync::Lrc;\n use rustc_errors::DiagnosticBuilder;\n use syntax_pos::Span;"}, {"sha": "91008e8f9690ecf154c6c94d213ed5e906c0bebc", "filename": "src/librustc_mir/borrow_check/location.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Fborrow_check%2Flocation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Fborrow_check%2Flocation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Flocation.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -27,7 +27,11 @@ crate struct LocationTable {\n     statements_before_block: IndexVec<BasicBlock, usize>,\n }\n \n-newtype_index!(LocationIndex { DEBUG_FORMAT = \"LocationIndex({})\" });\n+newtype_index! {\n+    pub struct LocationIndex {\n+        DEBUG_FORMAT = \"LocationIndex({})\"\n+    }\n+}\n \n #[derive(Copy, Clone, Debug)]\n crate enum RichLocation {"}, {"sha": "290c7032388053f0b1376b35e1d22295e8a4ae58", "filename": "src/librustc_mir/borrow_check/move_errors.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Fborrow_check%2Fmove_errors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Fborrow_check%2Fmove_errors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Fmove_errors.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -12,7 +12,6 @@ use core::unicode::property::Pattern_White_Space;\n use rustc::mir::*;\n use rustc::ty;\n use rustc_errors::DiagnosticBuilder;\n-use rustc_data_structures::indexed_vec::Idx;\n use syntax_pos::Span;\n \n use borrow_check::MirBorrowckCtxt;"}, {"sha": "41c846509cddb33253dca85eccd13ae85a07638c", "filename": "src/librustc_mir/borrow_check/nll/constraints/mod.rs", "status": "modified", "additions": 10, "deletions": 2, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Fconstraints%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Fconstraints%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Fconstraints%2Fmod.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -99,6 +99,14 @@ impl fmt::Debug for OutlivesConstraint {\n     }\n }\n \n-newtype_index!(ConstraintIndex { DEBUG_FORMAT = \"ConstraintIndex({})\" });\n+newtype_index! {\n+    pub struct ConstraintIndex {\n+        DEBUG_FORMAT = \"ConstraintIndex({})\"\n+    }\n+}\n \n-newtype_index!(ConstraintSccIndex { DEBUG_FORMAT = \"ConstraintSccIndex({})\" });\n+newtype_index! {\n+    pub struct ConstraintSccIndex {\n+        DEBUG_FORMAT = \"ConstraintSccIndex({})\"\n+    }\n+}"}, {"sha": "465707ecc17ddcfc58c041d083c095bd6fffb69d", "filename": "src/librustc_mir/borrow_check/nll/facts.rs", "status": "modified", "additions": 0, "deletions": 12, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Ffacts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Ffacts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Ffacts.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -100,18 +100,6 @@ impl Atom for LocationIndex {\n     }\n }\n \n-impl From<usize> for LocationIndex {\n-    fn from(i: usize) -> LocationIndex {\n-        LocationIndex::new(i)\n-    }\n-}\n-\n-impl From<LocationIndex> for usize {\n-    fn from(vid: LocationIndex) -> usize {\n-        Idx::index(vid)\n-    }\n-}\n-\n struct FactWriter<'w> {\n     location_table: &'w LocationTable,\n     dir: &'w Path,"}, {"sha": "34e893d2a59f24970b9c92ff46c12ca5bc475143", "filename": "src/librustc_mir/borrow_check/nll/region_infer/graphviz.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Fregion_infer%2Fgraphviz.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Fregion_infer%2Fgraphviz.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Fregion_infer%2Fgraphviz.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -15,7 +15,6 @@\n use super::*;\n use borrow_check::nll::constraints::OutlivesConstraint;\n use dot::{self, IntoCow};\n-use rustc_data_structures::indexed_vec::Idx;\n use std::borrow::Cow;\n use std::io::{self, Write};\n "}, {"sha": "3dafab2f5a9f4da0ddd8e8b3b0b7fd50a9583ee6", "filename": "src/librustc_mir/borrow_check/nll/region_infer/values.rs", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Fregion_infer%2Fvalues.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Fregion_infer%2Fvalues.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Fregion_infer%2Fvalues.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -123,13 +123,17 @@ impl RegionValueElements {\n \n /// A single integer representing a `Location` in the MIR control-flow\n /// graph. Constructed efficiently from `RegionValueElements`.\n-newtype_index!(PointIndex { DEBUG_FORMAT = \"PointIndex({})\" });\n+newtype_index! {\n+    pub struct PointIndex { DEBUG_FORMAT = \"PointIndex({})\" }\n+}\n \n /// A single integer representing a (non-zero) `UniverseIndex`.\n /// Computed just by subtracting one from `UniverseIndex`; this is\n /// because the `0` value for `UniverseIndex` represents the root\n /// universe, and we don't need/want a bit for that one.\n-newtype_index!(PlaceholderIndex { DEBUG_FORMAT = \"PlaceholderIndex({})\" });\n+newtype_index! {\n+    pub struct PlaceholderIndex { DEBUG_FORMAT = \"PlaceholderIndex({})\" }\n+}\n \n /// An individual element in a region value -- the value of a\n /// particular region variable consists of a set of these elements."}, {"sha": "467554dc38a67e4be9d5717c3ae48b42a25ffc50", "filename": "src/librustc_mir/borrow_check/nll/type_check/liveness/liveness_map.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Ftype_check%2Fliveness%2Fliveness_map.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Ftype_check%2Fliveness%2Fliveness_map.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Ftype_check%2Fliveness%2Fliveness_map.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -97,6 +97,6 @@ impl NllLivenessMap {\n /// compute liveness information. For many locals, we are able to\n /// skip liveness information: for example, those variables whose\n /// types contain no regions.\n-newtype_index!(\n-    LiveVar\n-);\n+newtype_index! {\n+    pub struct LiveVar { .. }\n+}"}, {"sha": "4b39d58cd96a82e3c7479aa84429241bb63908f5", "filename": "src/librustc_mir/borrow_check/nll/type_check/liveness/local_use_map.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Ftype_check%2Fliveness%2Flocal_use_map.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Ftype_check%2Fliveness%2Flocal_use_map.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Ftype_check%2Fliveness%2Flocal_use_map.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -48,7 +48,9 @@ struct Appearance {\n     next: Option<AppearanceIndex>,\n }\n \n-newtype_index!(AppearanceIndex);\n+newtype_index! {\n+    pub struct AppearanceIndex { .. }\n+}\n \n impl vll::LinkElem for Appearance {\n     type LinkIndex = AppearanceIndex;"}, {"sha": "82158acc9e6ab312b73daa965ca4387f4d3c0e9d", "filename": "src/librustc_mir/borrow_check/nll/type_check/mod.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Ftype_check%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Ftype_check%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Ftype_check%2Fmod.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -42,7 +42,6 @@ use syntax_pos::{Span, DUMMY_SP};\n use transform::{MirPass, MirSource};\n \n use rustc_data_structures::fx::FxHashSet;\n-use rustc_data_structures::indexed_vec::Idx;\n \n macro_rules! span_mirbug {\n     ($context:expr, $elem:expr, $($message:tt)*) => ({"}, {"sha": "8ffce9c94926fa5437217fb2e578396c6f253c79", "filename": "src/librustc_mir/borrow_check/nll/type_check/relate_tys.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Ftype_check%2Frelate_tys.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Ftype_check%2Frelate_tys.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Ftype_check%2Frelate_tys.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -20,7 +20,7 @@ use rustc::ty::relate::{self, Relate, RelateResult, TypeRelation};\n use rustc::ty::subst::Kind;\n use rustc::ty::{self, CanonicalTy, CanonicalVar, RegionVid, Ty, TyCtxt};\n use rustc_data_structures::fx::FxHashMap;\n-use rustc_data_structures::indexed_vec::{Idx, IndexVec};\n+use rustc_data_structures::indexed_vec::IndexVec;\n use std::mem;\n \n pub(super) fn sub_types<'tcx>("}, {"sha": "322a6977bedd0b925165bdfa9f8e352922c5c5f2", "filename": "src/librustc_mir/build/mod.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Fbuild%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Fbuild%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fbuild%2Fmod.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -402,7 +402,9 @@ struct CFG<'tcx> {\n     basic_blocks: IndexVec<BasicBlock, BasicBlockData<'tcx>>,\n }\n \n-newtype_index!(ScopeId);\n+newtype_index! {\n+    pub struct ScopeId { .. }\n+}\n \n ///////////////////////////////////////////////////////////////////////////\n /// The `BlockAnd` \"monad\" packages up the new basic block along with a"}, {"sha": "38e0854bcd61eddabdd00c694f9efc45018d9a43", "filename": "src/librustc_mir/build/scope.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Fbuild%2Fscope.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Fbuild%2Fscope.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fbuild%2Fscope.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -95,7 +95,6 @@ use rustc::hir;\n use rustc::hir::def_id::LOCAL_CRATE;\n use rustc::mir::*;\n use syntax_pos::{Span};\n-use rustc_data_structures::indexed_vec::Idx;\n use rustc_data_structures::fx::FxHashMap;\n \n #[derive(Debug)]"}, {"sha": "154830c2e77e07277bc1fd3ea8ed7dc1fe10ed8e", "filename": "src/librustc_mir/const_eval.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Fconst_eval.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Fconst_eval.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fconst_eval.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -19,7 +19,7 @@ use rustc::mir;\n use rustc::ty::{self, TyCtxt, Instance, query::TyCtxtAt};\n use rustc::ty::layout::{LayoutOf, TyLayout};\n use rustc::ty::subst::Subst;\n-use rustc_data_structures::indexed_vec::{IndexVec, Idx};\n+use rustc_data_structures::indexed_vec::IndexVec;\n \n use syntax::ast::Mutability;\n use syntax::source_map::Span;"}, {"sha": "1dc91cd05b33e9c7aeef0457942904c43ea47117", "filename": "src/librustc_mir/dataflow/at_location.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Fdataflow%2Fat_location.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Fdataflow%2Fat_location.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fdataflow%2Fat_location.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -13,7 +13,6 @@\n \n use rustc::mir::{BasicBlock, Location};\n use rustc_data_structures::indexed_set::{HybridIdxSet, IdxSet, Iter};\n-use rustc_data_structures::indexed_vec::Idx;\n \n use dataflow::{BitDenotation, BlockSets, DataflowResults};\n use dataflow::move_paths::{HasMoveData, MovePathIndex};"}, {"sha": "2b5d26c748704f1655ff225b08b859d82b5f9788", "filename": "src/librustc_mir/dataflow/graphviz.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Fdataflow%2Fgraphviz.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Fdataflow%2Fgraphviz.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fdataflow%2Fgraphviz.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -13,7 +13,6 @@\n use syntax::ast::NodeId;\n use rustc::mir::{BasicBlock, Mir};\n use rustc_data_structures::bitslice::bits_to_string;\n-use rustc_data_structures::indexed_vec::Idx;\n \n use dot;\n use dot::IntoCow;"}, {"sha": "461285ff9bc106422dda4d97f10be82a74f61cf4", "filename": "src/librustc_mir/interpret/operand.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Finterpret%2Foperand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Finterpret%2Foperand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Finterpret%2Foperand.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -16,7 +16,7 @@ use std::convert::TryInto;\n \n use rustc::{mir, ty};\n use rustc::ty::layout::{self, Size, LayoutOf, TyLayout, HasDataLayout, IntegerExt};\n-use rustc_data_structures::indexed_vec::Idx;\n+\n use rustc::mir::interpret::{\n     GlobalId, AllocId,\n     ConstValue, Pointer, Scalar, ScalarMaybeUndef,"}, {"sha": "d01593ca5e91c6a1878d23892a7cff56708b34a3", "filename": "src/librustc_mir/interpret/place.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Finterpret%2Fplace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Finterpret%2Fplace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Finterpret%2Fplace.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -18,7 +18,6 @@ use rustc::ich::StableHashingContext;\n use rustc::mir;\n use rustc::ty::{self, Ty};\n use rustc::ty::layout::{self, Size, Align, LayoutOf, TyLayout, HasDataLayout};\n-use rustc_data_structures::indexed_vec::Idx;\n use rustc_data_structures::stable_hasher::{HashStable, StableHasher, StableHasherResult};\n \n use rustc::mir::interpret::{"}, {"sha": "d4024981c3754cac0e1445afc1c59b0d81730505", "filename": "src/librustc_mir/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Flib.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -24,6 +24,7 @@ Rust MIR: a lowered representation of Rust. Also: an experiment!\n #![feature(box_syntax)]\n #![feature(crate_visibility_modifier)]\n #![feature(core_intrinsics)]\n+#![feature(const_fn)]\n #![feature(decl_macro)]\n #![cfg_attr(stage0, feature(macro_vis_matcher))]\n #![feature(exhaustive_patterns)]"}, {"sha": "4d19e9dfbf98abd3623ed81fb2fa6070c6b26248", "filename": "src/librustc_mir/transform/const_prop.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -26,7 +26,7 @@ use interpret::{self, Value, OpTy, MemoryKind};\n use transform::{MirPass, MirSource};\n use syntax::source_map::{Span, DUMMY_SP};\n use rustc::ty::subst::Substs;\n-use rustc_data_structures::indexed_vec::{IndexVec, Idx};\n+use rustc_data_structures::indexed_vec::IndexVec;\n use rustc::ty::ParamEnv;\n use rustc::ty::layout::{\n     LayoutOf, TyLayout, LayoutError,\n@@ -133,7 +133,6 @@ impl<'b, 'a, 'tcx:'b> ConstPropagator<'b, 'a, 'tcx> {\n         self.ecx.tcx.span = source_info.span;\n         let lint_root = match self.mir.source_scope_local_data {\n             ClearCrossCrate::Set(ref ivs) => {\n-                use rustc_data_structures::indexed_vec::Idx;\n                 //FIXME(#51314): remove this check\n                 if source_info.scope.index() >= ivs.len() {\n                     return None;"}, {"sha": "bf538112e41ed26ec434092858648a6df1081fb1", "filename": "src/librustc_mir/transform/elaborate_drops.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Ftransform%2Felaborate_drops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Ftransform%2Felaborate_drops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Felaborate_drops.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -19,7 +19,6 @@ use rustc::ty::{self, TyCtxt};\n use rustc::mir::*;\n use rustc::util::nodemap::FxHashMap;\n use rustc_data_structures::indexed_set::IdxSet;\n-use rustc_data_structures::indexed_vec::Idx;\n use transform::{MirPass, MirSource};\n use util::patch::MirPatch;\n use util::elaborate_drops::{DropFlagState, Unwind, elaborate_drop};"}, {"sha": "81fc235c23346aa1515951cdc573ca612b7ee0de", "filename": "src/librustc_mir/transform/qualify_consts.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Ftransform%2Fqualify_consts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Ftransform%2Fqualify_consts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fqualify_consts.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -16,7 +16,7 @@\n \n use rustc_data_structures::bitvec::BitArray;\n use rustc_data_structures::indexed_set::IdxSet;\n-use rustc_data_structures::indexed_vec::{IndexVec, Idx};\n+use rustc_data_structures::indexed_vec::IndexVec;\n use rustc_data_structures::fx::FxHashSet;\n use rustc::hir;\n use rustc::hir::def_id::DefId;"}, {"sha": "9faaeea3f5b70038073c9e8ae8df3c6862f35310", "filename": "src/librustc_mir/transform/rustc_peek.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Ftransform%2Frustc_peek.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Ftransform%2Frustc_peek.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Frustc_peek.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -15,7 +15,6 @@ use syntax_pos::Span;\n use rustc::ty::{self, TyCtxt};\n use rustc::mir::{self, Mir, Location};\n use rustc_data_structures::indexed_set::IdxSet;\n-use rustc_data_structures::indexed_vec::Idx;\n use transform::{MirPass, MirSource};\n \n use dataflow::{do_dataflow, DebugFormatted};"}, {"sha": "0b883f68bff40f464062acff65b5af2b17026917", "filename": "src/librustc_mir/util/graphviz.rs", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Futil%2Fgraphviz.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_mir%2Futil%2Fgraphviz.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Futil%2Fgraphviz.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -15,8 +15,6 @@ use rustc::ty::TyCtxt;\n use std::fmt::Debug;\n use std::io::{self, Write};\n \n-use rustc_data_structures::indexed_vec::Idx;\n-\n use super::pretty::dump_mir_def_ids;\n \n /// Write a graphviz DOT graph of a list of MIRs."}, {"sha": "65dd71de1443f89b6161262a16433ce5c92a02a3", "filename": "src/librustc_typeck/astconv.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_typeck%2Fastconv.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibrustc_typeck%2Fastconv.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fastconv.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -25,10 +25,11 @@ use rustc::ty::{self, Ty, TyCtxt, ToPredicate, TypeFoldable};\n use rustc::ty::{GenericParamDef, GenericParamDefKind};\n use rustc::ty::wf::object_region_bounds;\n use rustc_target::spec::abi;\n+use std::collections::BTreeSet;\n use std::slice;\n use require_c_abi_if_variadic;\n use util::common::ErrorReported;\n-use util::nodemap::{FxHashSet, FxHashMap};\n+use util::nodemap::FxHashMap;\n use errors::{FatalError, DiagnosticId};\n use lint;\n \n@@ -996,7 +997,9 @@ impl<'o, 'gcx: 'tcx, 'tcx> dyn AstConv<'gcx, 'tcx>+'o {\n             return tcx.types.err;\n         }\n \n-        let mut associated_types = FxHashSet::default();\n+        // use a btreeset to keep output in a more consistent order\n+        let mut associated_types = BTreeSet::default();\n+\n         for tr in traits::supertraits(tcx, principal) {\n             associated_types.extend(tcx.associated_items(tr.def_id())\n                 .filter(|item| item.kind == ty::AssociatedKind::Type)"}, {"sha": "416be50bfe9ea4f52a19ba7e9dbe4cf28721708e", "filename": "src/libserialize/serialize.rs", "status": "modified", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibserialize%2Fserialize.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51c387931ed8df9b7daece4ad64b48bdd2b8335b/src%2Flibserialize%2Fserialize.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibserialize%2Fserialize.rs?ref=51c387931ed8df9b7daece4ad64b48bdd2b8335b", "patch": "@@ -361,6 +361,18 @@ impl Decodable for u32 {\n     }\n }\n \n+impl Encodable for ::std::num::NonZeroU32 {\n+    fn encode<S: Encoder>(&self, s: &mut S) -> Result<(), S::Error> {\n+        s.emit_u32(self.get())\n+    }\n+}\n+\n+impl Decodable for ::std::num::NonZeroU32 {\n+    fn decode<D: Decoder>(d: &mut D) -> Result<Self, D::Error> {\n+        d.read_u32().map(|d| ::std::num::NonZeroU32::new(d).unwrap())\n+    }\n+}\n+\n impl Encodable for u64 {\n     fn encode<S: Encoder>(&self, s: &mut S) -> Result<(), S::Error> {\n         s.emit_u64(*self)\n@@ -895,3 +907,4 @@ impl<T: UseSpecializedDecodable> Decodable for T {\n impl<'a, T: ?Sized + Encodable> UseSpecializedEncodable for &'a T {}\n impl<T: ?Sized + Encodable> UseSpecializedEncodable for Box<T> {}\n impl<T: Decodable> UseSpecializedDecodable for Box<T> {}\n+"}]}