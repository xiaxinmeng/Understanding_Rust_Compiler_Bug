{"sha": "94be27fc44763afbf67d36010d4aa05639191e4b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk0YmUyN2ZjNDQ3NjNhZmJmNjdkMzYwMTBkNGFhMDU2MzkxOTFlNGI=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-12-30T18:30:30Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-12-30T18:31:07Z"}, "message": "Move expand macro to the new context", "tree": {"sha": "7c1c6f94918bbb4343f0a2122c8989978ff5b9ac", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7c1c6f94918bbb4343f0a2122c8989978ff5b9ac"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/94be27fc44763afbf67d36010d4aa05639191e4b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/94be27fc44763afbf67d36010d4aa05639191e4b", "html_url": "https://github.com/rust-lang/rust/commit/94be27fc44763afbf67d36010d4aa05639191e4b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/94be27fc44763afbf67d36010d4aa05639191e4b/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "68f47a5b10cfbb7b0168a0f24ddc7d8ced6cedda", "url": "https://api.github.com/repos/rust-lang/rust/commits/68f47a5b10cfbb7b0168a0f24ddc7d8ced6cedda", "html_url": "https://github.com/rust-lang/rust/commit/68f47a5b10cfbb7b0168a0f24ddc7d8ced6cedda"}], "stats": {"total": 128, "additions": 53, "deletions": 75}, "files": [{"sha": "2c8362286d0b1aaa1323c244acad2d596777bb97", "filename": "editors/code/src/commands/analyzer_status.ts", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/94be27fc44763afbf67d36010d4aa05639191e4b/editors%2Fcode%2Fsrc%2Fcommands%2Fanalyzer_status.ts", "raw_url": "https://github.com/rust-lang/rust/raw/94be27fc44763afbf67d36010d4aa05639191e4b/editors%2Fcode%2Fsrc%2Fcommands%2Fanalyzer_status.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fcommands%2Fanalyzer_status.ts?ref=94be27fc44763afbf67d36010d4aa05639191e4b", "patch": "@@ -37,7 +37,7 @@ export function analyzerStatus(ctx: Ctx): Cmd {\n \n class TextDocumentContentProvider\n     implements vscode.TextDocumentContentProvider {\n-    ctx: Ctx;\n+    private ctx: Ctx;\n     uri = vscode.Uri.parse('rust-analyzer-status://status');\n     eventEmitter = new vscode.EventEmitter<vscode.Uri>();\n "}, {"sha": "da208257a2a2389cca9f014ac1e7c809359116d9", "filename": "editors/code/src/commands/expand_macro.ts", "status": "modified", "additions": 47, "deletions": 55, "changes": 102, "blob_url": "https://github.com/rust-lang/rust/blob/94be27fc44763afbf67d36010d4aa05639191e4b/editors%2Fcode%2Fsrc%2Fcommands%2Fexpand_macro.ts", "raw_url": "https://github.com/rust-lang/rust/raw/94be27fc44763afbf67d36010d4aa05639191e4b/editors%2Fcode%2Fsrc%2Fcommands%2Fexpand_macro.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fcommands%2Fexpand_macro.ts?ref=94be27fc44763afbf67d36010d4aa05639191e4b", "patch": "@@ -1,60 +1,23 @@\n import * as vscode from 'vscode';\n-import { Position, TextDocumentIdentifier } from 'vscode-languageclient';\n-import { Server } from '../server';\n+import * as lc from 'vscode-languageclient';\n \n-export const expandMacroUri = vscode.Uri.parse(\n-    'rust-analyzer://expandMacro/[EXPANSION].rs',\n-);\n-\n-export class ExpandMacroContentProvider\n-    implements vscode.TextDocumentContentProvider {\n-    public eventEmitter = new vscode.EventEmitter<vscode.Uri>();\n-\n-    public provideTextDocumentContent(\n-        _uri: vscode.Uri,\n-    ): vscode.ProviderResult<string> {\n-        async function handle() {\n-            const editor = vscode.window.activeTextEditor;\n-            if (editor == null) {\n-                return '';\n-            }\n-\n-            const position = editor.selection.active;\n-            const request: MacroExpandParams = {\n-                textDocument: { uri: editor.document.uri.toString() },\n-                position,\n-            };\n-            const expanded = await Server.client.sendRequest<ExpandedMacro>(\n-                'rust-analyzer/expandMacro',\n-                request,\n-            );\n-\n-            if (expanded == null) {\n-                return 'Not available';\n-            }\n-\n-            return code_format(expanded);\n-        }\n-\n-        return handle();\n-    }\n-\n-    get onDidChange(): vscode.Event<vscode.Uri> {\n-        return this.eventEmitter.event;\n-    }\n-}\n+import { Ctx, Cmd } from '../ctx';\n \n // Opens the virtual file that will show the syntax tree\n //\n // The contents of the file come from the `TextDocumentContentProvider`\n-export function createHandle(provider: ExpandMacroContentProvider) {\n-    return async () => {\n-        const uri = expandMacroUri;\n-\n-        const document = await vscode.workspace.openTextDocument(uri);\n-\n-        provider.eventEmitter.fire(uri);\n+export function expandMacro(ctx: Ctx): Cmd {\n+    const tdcp = new TextDocumentContentProvider(ctx);\n+    ctx.pushCleanup(\n+        vscode.workspace.registerTextDocumentContentProvider(\n+            'rust-analyzer',\n+            tdcp,\n+        ),\n+    );\n \n+    return async () => {\n+        const document = await vscode.workspace.openTextDocument(tdcp.uri);\n+        tdcp.eventEmitter.fire(tdcp.uri);\n         return vscode.window.showTextDocument(\n             document,\n             vscode.ViewColumn.Two,\n@@ -63,11 +26,6 @@ export function createHandle(provider: ExpandMacroContentProvider) {\n     };\n }\n \n-interface MacroExpandParams {\n-    textDocument: TextDocumentIdentifier;\n-    position: Position;\n-}\n-\n interface ExpandedMacro {\n     name: string;\n     expansion: string;\n@@ -81,3 +39,37 @@ function code_format(expanded: ExpandedMacro): string {\n \n     return result;\n }\n+\n+class TextDocumentContentProvider\n+    implements vscode.TextDocumentContentProvider {\n+    private ctx: Ctx;\n+    uri = vscode.Uri.parse('rust-analyzer://expandMacro/[EXPANSION].rs');\n+    eventEmitter = new vscode.EventEmitter<vscode.Uri>();\n+\n+    constructor(ctx: Ctx) {\n+        this.ctx = ctx;\n+    }\n+\n+    async provideTextDocumentContent(_uri: vscode.Uri): Promise<string> {\n+        const editor = vscode.window.activeTextEditor;\n+        if (editor == null) return '';\n+\n+        const position = editor.selection.active;\n+        const request: lc.TextDocumentPositionParams = {\n+            textDocument: { uri: editor.document.uri.toString() },\n+            position,\n+        };\n+        const expanded = await this.ctx.client.sendRequest<ExpandedMacro>(\n+            'rust-analyzer/expandMacro',\n+            request,\n+        );\n+\n+        if (expanded == null) return 'Not available';\n+\n+        return code_format(expanded);\n+    }\n+\n+    get onDidChange(): vscode.Event<vscode.Uri> {\n+        return this.eventEmitter.event;\n+    }\n+}"}, {"sha": "325ae3da84f430513c3ff094d9155573fecace0f", "filename": "editors/code/src/commands/index.ts", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/94be27fc44763afbf67d36010d4aa05639191e4b/editors%2Fcode%2Fsrc%2Fcommands%2Findex.ts", "raw_url": "https://github.com/rust-lang/rust/raw/94be27fc44763afbf67d36010d4aa05639191e4b/editors%2Fcode%2Fsrc%2Fcommands%2Findex.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fcommands%2Findex.ts?ref=94be27fc44763afbf67d36010d4aa05639191e4b", "patch": "@@ -6,7 +6,7 @@ import { joinLines } from './join_lines';\n import { onEnter } from './on_enter';\n import { parentModule } from './parent_module';\n import { syntaxTree } from './syntax_tree';\n-import * as expandMacro from './expand_macro';\n+import { expandMacro } from './expand_macro';\n import * as inlayHints from './inlay_hints';\n import * as runnables from './runnables';\n "}, {"sha": "20ff7e5ca047487472f27c287e91500ba0ab3f61", "filename": "editors/code/src/commands/syntax_tree.ts", "status": "modified", "additions": 3, "deletions": 4, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/94be27fc44763afbf67d36010d4aa05639191e4b/editors%2Fcode%2Fsrc%2Fcommands%2Fsyntax_tree.ts", "raw_url": "https://github.com/rust-lang/rust/raw/94be27fc44763afbf67d36010d4aa05639191e4b/editors%2Fcode%2Fsrc%2Fcommands%2Fsyntax_tree.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fcommands%2Fsyntax_tree.ts?ref=94be27fc44763afbf67d36010d4aa05639191e4b", "patch": "@@ -66,10 +66,9 @@ interface SyntaxTreeParams {\n \n class TextDocumentContentProvider\n     implements vscode.TextDocumentContentProvider {\n-    ctx: Ctx;\n+    private ctx: Ctx;\n     uri = vscode.Uri.parse('rust-analyzer://syntaxtree');\n     eventEmitter = new vscode.EventEmitter<vscode.Uri>();\n-    syntaxTree: string = 'Not available';\n \n     constructor(ctx: Ctx) {\n         this.ctx = ctx;\n@@ -86,8 +85,8 @@ class TextDocumentContentProvider\n             range = editor.selection.isEmpty\n                 ? undefined\n                 : this.ctx.client.code2ProtocolConverter.asRange(\n-                    editor.selection,\n-                );\n+                      editor.selection,\n+                  );\n         }\n \n         const request: SyntaxTreeParams = {"}, {"sha": "b8e3396a6e6aee198207e3b215b6353fa4337eb9", "filename": "editors/code/src/main.ts", "status": "modified", "additions": 1, "deletions": 14, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/94be27fc44763afbf67d36010d4aa05639191e4b/editors%2Fcode%2Fsrc%2Fmain.ts", "raw_url": "https://github.com/rust-lang/rust/raw/94be27fc44763afbf67d36010d4aa05639191e4b/editors%2Fcode%2Fsrc%2Fmain.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fmain.ts?ref=94be27fc44763afbf67d36010d4aa05639191e4b", "patch": "@@ -2,7 +2,6 @@ import * as vscode from 'vscode';\n import * as lc from 'vscode-languageclient';\n \n import * as commands from './commands';\n-import { ExpandMacroContentProvider } from './commands/expand_macro';\n import { HintsUpdater } from './commands/inlay_hints';\n import { StatusDisplay } from './commands/watch_status';\n import * as events from './events';\n@@ -20,6 +19,7 @@ export async function activate(context: vscode.ExtensionContext) {\n     ctx.registerCommand('joinLines', commands.joinLines);\n     ctx.registerCommand('parentModule', commands.parentModule);\n     ctx.registerCommand('syntaxTree', commands.syntaxTree);\n+    ctx.registerCommand('expandMacro', commands.expandMacro);\n \n     function disposeOnDeactivation(disposable: vscode.Disposable) {\n         context.subscriptions.push(disposable);\n@@ -65,25 +65,12 @@ export async function activate(context: vscode.ExtensionContext) {\n             params => watchStatus.handleProgressNotification(params),\n         ],\n     ];\n-    const expandMacroContentProvider = new ExpandMacroContentProvider();\n \n     // The events below are plain old javascript events, triggered and handled by vscode\n     vscode.window.onDidChangeActiveTextEditor(\n         events.changeActiveTextEditor.makeHandler(),\n     );\n \n-    disposeOnDeactivation(\n-        vscode.workspace.registerTextDocumentContentProvider(\n-            'rust-analyzer',\n-            expandMacroContentProvider,\n-        ),\n-    );\n-\n-    registerCommand(\n-        'rust-analyzer.expandMacro',\n-        commands.expandMacro.createHandle(expandMacroContentProvider),\n-    );\n-\n     const startServer = () => Server.start(allNotifications);\n     const reloadCommand = () => reloadServer(startServer);\n "}]}