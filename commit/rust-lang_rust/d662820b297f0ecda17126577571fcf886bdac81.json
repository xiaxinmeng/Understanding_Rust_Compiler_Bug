{"sha": "d662820b297f0ecda17126577571fcf886bdac81", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ2NjI4MjBiMjk3ZjBlY2RhMTcxMjY1Nzc1NzFmY2Y4ODZiZGFjODE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-11-27T22:17:41Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-11-27T22:17:41Z"}, "message": "auto merge of #10680 : alexcrichton/rust/relax-feature-gate, r=thestinger\n\nInstead of forcibly always aborting compilation, allow usage of\r\n #[warn(unknown_features)] and related lint attributes to selectively abort\r\n compilation. By default, this lint is deny.", "tree": {"sha": "d55e01c29b9320ac0f34695daadddf510275abeb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d55e01c29b9320ac0f34695daadddf510275abeb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d662820b297f0ecda17126577571fcf886bdac81", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d662820b297f0ecda17126577571fcf886bdac81", "html_url": "https://github.com/rust-lang/rust/commit/d662820b297f0ecda17126577571fcf886bdac81", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d662820b297f0ecda17126577571fcf886bdac81/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e147a090a5c7125428c16b142922002f7a645ea1", "url": "https://api.github.com/repos/rust-lang/rust/commits/e147a090a5c7125428c16b142922002f7a645ea1", "html_url": "https://github.com/rust-lang/rust/commit/e147a090a5c7125428c16b142922002f7a645ea1"}, {"sha": "a9bd049fc09445a20ab8a9283a24f1074403d061", "url": "https://api.github.com/repos/rust-lang/rust/commits/a9bd049fc09445a20ab8a9283a24f1074403d061", "html_url": "https://github.com/rust-lang/rust/commit/a9bd049fc09445a20ab8a9283a24f1074403d061"}], "stats": {"total": 39, "additions": 34, "deletions": 5}, "files": [{"sha": "c175bd3a404a338528313e47d162686b73683318", "filename": "src/librustc/front/feature_gate.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/d662820b297f0ecda17126577571fcf886bdac81/src%2Flibrustc%2Ffront%2Ffeature_gate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d662820b297f0ecda17126577571fcf886bdac81/src%2Flibrustc%2Ffront%2Ffeature_gate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ffront%2Ffeature_gate.rs?ref=d662820b297f0ecda17126577571fcf886bdac81", "patch": "@@ -18,6 +18,8 @@\n //! Features are enabled in programs via the crate-level attributes of\n //! #[feature(...)] with a comma-separated list of features.\n \n+use middle::lint;\n+\n use syntax::ast;\n use syntax::attr::AttrMetaMethods;\n use syntax::codemap::Span;\n@@ -209,7 +211,10 @@ pub fn check_crate(sess: Session, crate: &ast::Crate) {\n                                                      directive not necessary\");\n                         }\n                         None => {\n-                            sess.span_err(mi.span, \"unknown feature\");\n+                            sess.add_lint(lint::unknown_features,\n+                                          ast::CRATE_NODE_ID,\n+                                          mi.span,\n+                                          ~\"unknown feature\");\n                         }\n                     }\n                 }"}, {"sha": "6af07947fdeccf6e60921a502f9d7a4bc3aed96b", "filename": "src/librustc/middle/lint.rs", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/d662820b297f0ecda17126577571fcf886bdac81/src%2Flibrustc%2Fmiddle%2Flint.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d662820b297f0ecda17126577571fcf886bdac81/src%2Flibrustc%2Fmiddle%2Flint.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Flint.rs?ref=d662820b297f0ecda17126577571fcf886bdac81", "patch": "@@ -59,6 +59,7 @@ use syntax::codemap::Span;\n use syntax::codemap;\n use syntax::parse::token;\n use syntax::{ast, ast_util, visit};\n+use syntax::ast_util::IdVisitingOperation;\n use syntax::visit::Visitor;\n \n #[deriving(Clone, Eq)]\n@@ -77,6 +78,7 @@ pub enum lint {\n     unused_unsafe,\n     unsafe_block,\n     attribute_usage,\n+    unknown_features,\n \n     managed_heap_memory,\n     owned_heap_memory,\n@@ -321,6 +323,13 @@ static lint_table: &'static [(&'static str, LintSpec)] = &[\n         desc: \"mass-change the level for lints which produce warnings\",\n         default: warn\n     }),\n+\n+    (\"unknown_features\",\n+     LintSpec {\n+        lint: unknown_features,\n+        desc: \"unknown features found in create-level #[feature] directives\",\n+        default: deny,\n+    }),\n ];\n \n /*\n@@ -1320,7 +1329,7 @@ impl<'self> Visitor<()> for Context<'self> {\n     }\n }\n \n-impl<'self> ast_util::IdVisitingOperation for Context<'self> {\n+impl<'self> IdVisitingOperation for Context<'self> {\n     fn visit_id(&self, id: ast::NodeId) {\n         match self.tcx.sess.lints.pop(&id) {\n             None => {}\n@@ -1356,6 +1365,7 @@ pub fn check_crate(tcx: ty::ctxt,\n         cx.set_level(lint, level, CommandLine);\n     }\n     cx.with_lint_attrs(crate.attrs, |cx| {\n+        cx.visit_id(ast::CRATE_NODE_ID);\n         cx.visit_ids(|v| {\n             v.visited_outermost = true;\n             visit::walk_crate(v, crate, ());"}, {"sha": "ed4d32ada0987b3ffb1d556fb5b359fd4a1f519a", "filename": "src/test/compile-fail/gated-bad-feature.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/d662820b297f0ecda17126577571fcf886bdac81/src%2Ftest%2Fcompile-fail%2Fgated-bad-feature.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d662820b297f0ecda17126577571fcf886bdac81/src%2Ftest%2Fcompile-fail%2Fgated-bad-feature.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fgated-bad-feature.rs?ref=d662820b297f0ecda17126577571fcf886bdac81", "patch": "@@ -13,9 +13,8 @@\n     foo(bar),\n     foo = \"baz\"\n )];\n-//~^^^^ ERROR: unknown feature\n-//~^^^^ ERROR: malformed feature\n-//~^^^^ ERROR: malformed feature\n+//~^^^ ERROR: malformed feature\n+//~^^^ ERROR: malformed feature\n \n #[feature]; //~ ERROR: malformed feature\n #[feature = \"foo\"]; //~ ERROR: malformed feature"}, {"sha": "15f446a671cac269bed490476be7a23321eefdc2", "filename": "src/test/compile-fail/lint-unknown-feature.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/d662820b297f0ecda17126577571fcf886bdac81/src%2Ftest%2Fcompile-fail%2Flint-unknown-feature.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d662820b297f0ecda17126577571fcf886bdac81/src%2Ftest%2Fcompile-fail%2Flint-unknown-feature.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Flint-unknown-feature.rs?ref=d662820b297f0ecda17126577571fcf886bdac81", "patch": "@@ -0,0 +1,15 @@\n+// Copyright 2013 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#[deny(unknown_features)];\n+\n+#[feature(this_is_not_a_feature)]; //~ ERROR: unknown feature\n+\n+fn main() {}"}]}