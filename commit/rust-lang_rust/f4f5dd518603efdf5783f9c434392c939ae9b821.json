{"sha": "f4f5dd518603efdf5783f9c434392c939ae9b821", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY0ZjVkZDUxODYwM2VmZGY1NzgzZjljNDM0MzkyYzkzOWFlOWI4MjE=", "commit": {"author": {"name": "Mara Bos", "email": "m-ou.se@m-ou.se", "date": "2021-08-31T15:54:54Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-08-31T15:54:54Z"}, "message": "Rollup merge of #88391 - GuillaumeGomez:fix-json-enum-variant, r=camelid,notriddle\n\nFix json tuple struct enum variant\n\nFixes #87887.\n\ncc `@dsherret` `@camelid`\n\nr? `@notriddle`", "tree": {"sha": "515d4d2806400fa3de46b938f039f4cc46e651de", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/515d4d2806400fa3de46b938f039f4cc46e651de"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f4f5dd518603efdf5783f9c434392c939ae9b821", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhLlDOCRBK7hj4Ov3rIwAAJ1wIACWGwa/dp6Z60z8qaIEbXdmT\nLkpo/3eUiF4psMyXX+76n3OCOa6wnM1hcb9sIUfpl3fvVgtg07KDHOvnWCkL2IUn\ni+H7WQ5+qymTXzPAHhzrO80qOGjCUxezTVOj7OblVFJrmeE9MpFqVo8Jt2waE8Ca\nQ+OueueMpZV6uKAsFXOqq6bcbULvbs8u4Myvc1OeSb2dRq1GNpR9mDfoXIAoyDKn\nx2lqbFHJjb5iLrZkAMAqllBEHLtQb1OKwerdcWnzZWoHeHFJFMm0oJAK6lzGYssQ\nnIZ723oS0Qpcn6y2Ilozv6q+uuCzBoVFwvfWc2LpFHsO3HBCRYxtr7ucV+V1Fy8=\n=I3MG\n-----END PGP SIGNATURE-----\n", "payload": "tree 515d4d2806400fa3de46b938f039f4cc46e651de\nparent 175c8cb851e0c43520e0ccbf17c37f7786516490\nparent a5213888e04b6bacda5198dc41026b604fe410ef\nauthor Mara Bos <m-ou.se@m-ou.se> 1630425294 +0200\ncommitter GitHub <noreply@github.com> 1630425294 +0200\n\nRollup merge of #88391 - GuillaumeGomez:fix-json-enum-variant, r=camelid,notriddle\n\nFix json tuple struct enum variant\n\nFixes #87887.\n\ncc `@dsherret` `@camelid`\n\nr? `@notriddle`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f4f5dd518603efdf5783f9c434392c939ae9b821", "html_url": "https://github.com/rust-lang/rust/commit/f4f5dd518603efdf5783f9c434392c939ae9b821", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f4f5dd518603efdf5783f9c434392c939ae9b821/comments", "author": {"login": "m-ou-se", "id": 783247, "node_id": "MDQ6VXNlcjc4MzI0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/783247?v=4", "gravatar_id": "", "url": "https://api.github.com/users/m-ou-se", "html_url": "https://github.com/m-ou-se", "followers_url": "https://api.github.com/users/m-ou-se/followers", "following_url": "https://api.github.com/users/m-ou-se/following{/other_user}", "gists_url": "https://api.github.com/users/m-ou-se/gists{/gist_id}", "starred_url": "https://api.github.com/users/m-ou-se/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/m-ou-se/subscriptions", "organizations_url": "https://api.github.com/users/m-ou-se/orgs", "repos_url": "https://api.github.com/users/m-ou-se/repos", "events_url": "https://api.github.com/users/m-ou-se/events{/privacy}", "received_events_url": "https://api.github.com/users/m-ou-se/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "175c8cb851e0c43520e0ccbf17c37f7786516490", "url": "https://api.github.com/repos/rust-lang/rust/commits/175c8cb851e0c43520e0ccbf17c37f7786516490", "html_url": "https://github.com/rust-lang/rust/commit/175c8cb851e0c43520e0ccbf17c37f7786516490"}, {"sha": "a5213888e04b6bacda5198dc41026b604fe410ef", "url": "https://api.github.com/repos/rust-lang/rust/commits/a5213888e04b6bacda5198dc41026b604fe410ef", "html_url": "https://github.com/rust-lang/rust/commit/a5213888e04b6bacda5198dc41026b604fe410ef"}], "stats": {"total": 108, "additions": 79, "deletions": 29}, "files": [{"sha": "b566239423e0455654e597c627ac8adef8ce22e4", "filename": "src/librustdoc/clean/mod.rs", "status": "modified", "additions": 18, "deletions": 8, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/f4f5dd518603efdf5783f9c434392c939ae9b821/src%2Flibrustdoc%2Fclean%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f4f5dd518603efdf5783f9c434392c939ae9b821/src%2Flibrustdoc%2Fclean%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Fmod.rs?ref=f4f5dd518603efdf5783f9c434392c939ae9b821", "patch": "@@ -1702,12 +1702,28 @@ impl Clean<VariantStruct> for rustc_hir::VariantData<'_> {\n     }\n }\n \n+impl Clean<Vec<Item>> for hir::VariantData<'_> {\n+    fn clean(&self, cx: &mut DocContext<'_>) -> Vec<Item> {\n+        self.fields().iter().map(|x| x.clean(cx)).collect()\n+    }\n+}\n+\n impl Clean<Item> for ty::VariantDef {\n     fn clean(&self, cx: &mut DocContext<'_>) -> Item {\n         let kind = match self.ctor_kind {\n             CtorKind::Const => Variant::CLike,\n             CtorKind::Fn => Variant::Tuple(\n-                self.fields.iter().map(|f| cx.tcx.type_of(f.did).clean(cx)).collect(),\n+                self.fields\n+                    .iter()\n+                    .map(|field| {\n+                        let name = Some(field.ident.name);\n+                        let kind = StructFieldItem(cx.tcx.type_of(field.did).clean(cx));\n+                        let what_rustc_thinks =\n+                            Item::from_def_id_and_parts(field.did, name, kind, cx);\n+                        // don't show `pub` for fields, which are always public\n+                        Item { visibility: Visibility::Inherited, ..what_rustc_thinks }\n+                    })\n+                    .collect(),\n             ),\n             CtorKind::Fictive => Variant::Struct(VariantStruct {\n                 struct_type: CtorKind::Fictive,\n@@ -1737,13 +1753,7 @@ impl Clean<Variant> for hir::VariantData<'_> {\n     fn clean(&self, cx: &mut DocContext<'_>) -> Variant {\n         match self {\n             hir::VariantData::Struct(..) => Variant::Struct(self.clean(cx)),\n-            // Important note here: `Variant::Tuple` is used on tuple structs which are not in an\n-            // enum (so where converting from `ty::VariantDef`). In case we are in an enum, the kind\n-            // is provided by the `Variant` wrapper directly, and since we need the fields' name\n-            // (even for a tuple struct variant!), it's simpler to just store it as a\n-            // `Variant::Struct` instead of a `Variant::Tuple` (otherwise it would force us to make\n-            // a lot of changes when rendering them to generate the name as well).\n-            hir::VariantData::Tuple(..) => Variant::Struct(self.clean(cx)),\n+            hir::VariantData::Tuple(..) => Variant::Tuple(self.clean(cx)),\n             hir::VariantData::Unit(..) => Variant::CLike,\n         }\n     }"}, {"sha": "4194c99c0ba707ec197e797406816d32e5dc5bf8", "filename": "src/librustdoc/clean/types.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/f4f5dd518603efdf5783f9c434392c939ae9b821/src%2Flibrustdoc%2Fclean%2Ftypes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f4f5dd518603efdf5783f9c434392c939ae9b821/src%2Flibrustdoc%2Fclean%2Ftypes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Ftypes.rs?ref=f4f5dd518603efdf5783f9c434392c939ae9b821", "patch": "@@ -715,6 +715,7 @@ impl ItemKind {\n             StructItem(s) => s.fields.iter(),\n             UnionItem(u) => u.fields.iter(),\n             VariantItem(Variant::Struct(v)) => v.fields.iter(),\n+            VariantItem(Variant::Tuple(v)) => v.iter(),\n             EnumItem(e) => e.variants.iter(),\n             TraitItem(t) => t.items.iter(),\n             ImplItem(i) => i.items.iter(),\n@@ -1937,7 +1938,7 @@ crate struct Enum {\n #[derive(Clone, Debug)]\n crate enum Variant {\n     CLike,\n-    Tuple(Vec<Type>),\n+    Tuple(Vec<Item>),\n     Struct(VariantStruct),\n }\n "}, {"sha": "b4859e4c9c7fe2e10340f66df721dc7ef9214e3d", "filename": "src/librustdoc/fold.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f4f5dd518603efdf5783f9c434392c939ae9b821/src%2Flibrustdoc%2Ffold.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f4f5dd518603efdf5783f9c434392c939ae9b821/src%2Flibrustdoc%2Ffold.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Ffold.rs?ref=f4f5dd518603efdf5783f9c434392c939ae9b821", "patch": "@@ -56,6 +56,10 @@ crate trait DocFolder: Sized {\n                             || j.fields.iter().any(|f| f.is_stripped());\n                         VariantItem(Variant::Struct(j))\n                     }\n+                    Variant::Tuple(fields) => {\n+                        let fields = fields.into_iter().filter_map(|x| self.fold_item(x)).collect();\n+                        VariantItem(Variant::Tuple(fields))\n+                    }\n                     _ => VariantItem(i2),\n                 }\n             }"}, {"sha": "722cfc97a8d898e8047d2c7e906a2875c4076bf3", "filename": "src/librustdoc/html/render/print_item.rs", "status": "modified", "additions": 24, "deletions": 17, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/f4f5dd518603efdf5783f9c434392c939ae9b821/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f4f5dd518603efdf5783f9c434392c939ae9b821/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs?ref=f4f5dd518603efdf5783f9c434392c939ae9b821", "patch": "@@ -937,6 +937,19 @@ fn item_union(w: &mut Buffer, cx: &Context<'_>, it: &clean::Item, s: &clean::Uni\n     document_type_layout(w, cx, def_id);\n }\n \n+fn print_tuple_struct_fields(w: &mut Buffer, cx: &Context<'_>, s: &[clean::Item]) {\n+    for (i, ty) in s\n+        .iter()\n+        .map(|f| if let clean::StructFieldItem(ref ty) = *f.kind { ty } else { unreachable!() })\n+        .enumerate()\n+    {\n+        if i > 0 {\n+            w.write_str(\",&nbsp;\");\n+        }\n+        write!(w, \"{}\", ty.print(cx));\n+    }\n+}\n+\n fn item_enum(w: &mut Buffer, cx: &Context<'_>, it: &clean::Item, e: &clean::Enum) {\n     wrap_into_docblock(w, |w| {\n         wrap_item(w, \"enum\", |w| {\n@@ -964,14 +977,9 @@ fn item_enum(w: &mut Buffer, cx: &Context<'_>, it: &clean::Item, e: &clean::Enum\n                     match *v.kind {\n                         clean::VariantItem(ref var) => match var {\n                             clean::Variant::CLike => write!(w, \"{}\", name),\n-                            clean::Variant::Tuple(ref tys) => {\n+                            clean::Variant::Tuple(ref s) => {\n                                 write!(w, \"{}(\", name);\n-                                for (i, ty) in tys.iter().enumerate() {\n-                                    if i > 0 {\n-                                        w.write_str(\",&nbsp;\")\n-                                    }\n-                                    write!(w, \"{}\", ty.print(cx));\n-                                }\n+                                print_tuple_struct_fields(w, cx, s);\n                                 w.write_str(\")\");\n                             }\n                             clean::Variant::Struct(ref s) => {\n@@ -1024,14 +1032,9 @@ fn item_enum(w: &mut Buffer, cx: &Context<'_>, it: &clean::Item, e: &clean::Enum\n                 id = id,\n                 name = variant.name.as_ref().unwrap()\n             );\n-            if let clean::VariantItem(clean::Variant::Tuple(ref tys)) = *variant.kind {\n+            if let clean::VariantItem(clean::Variant::Tuple(ref s)) = *variant.kind {\n                 w.write_str(\"(\");\n-                for (i, ty) in tys.iter().enumerate() {\n-                    if i > 0 {\n-                        w.write_str(\",&nbsp;\");\n-                    }\n-                    write!(w, \"{}\", ty.print(cx));\n-                }\n+                print_tuple_struct_fields(w, cx, s);\n                 w.write_str(\")\");\n             }\n             w.write_str(\"</code>\");\n@@ -1041,7 +1044,11 @@ fn item_enum(w: &mut Buffer, cx: &Context<'_>, it: &clean::Item, e: &clean::Enum\n             document_non_exhaustive(w, variant);\n \n             use crate::clean::Variant;\n-            if let clean::VariantItem(Variant::Struct(ref s)) = *variant.kind {\n+            if let Some((extra, fields)) = match *variant.kind {\n+                clean::VariantItem(Variant::Struct(ref s)) => Some((\"\", &s.fields)),\n+                clean::VariantItem(Variant::Tuple(ref fields)) => Some((\"Tuple \", fields)),\n+                _ => None,\n+            } {\n                 let variant_id = cx.derive_id(format!(\n                     \"{}.{}.fields\",\n                     ItemType::Variant,\n@@ -1051,10 +1058,10 @@ fn item_enum(w: &mut Buffer, cx: &Context<'_>, it: &clean::Item, e: &clean::Enum\n                 write!(\n                     w,\n                     \"<h3>{extra}Fields of <b>{name}</b></h3><div>\",\n-                    extra = if s.struct_type == CtorKind::Fn { \"Tuple \" } else { \"\" },\n+                    extra = extra,\n                     name = variant.name.as_ref().unwrap(),\n                 );\n-                for field in &s.fields {\n+                for field in fields {\n                     use crate::clean::StructFieldItem;\n                     if let StructFieldItem(ref ty) = *field.kind {\n                         let id = cx.derive_id(format!("}, {"sha": "9453e6d35ee6796ce28f98d195bfabe7c36dfff5", "filename": "src/librustdoc/json/conversions.rs", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/f4f5dd518603efdf5783f9c434392c939ae9b821/src%2Flibrustdoc%2Fjson%2Fconversions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f4f5dd518603efdf5783f9c434392c939ae9b821/src%2Flibrustdoc%2Fjson%2Fconversions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fjson%2Fconversions.rs?ref=f4f5dd518603efdf5783f9c434392c939ae9b821", "patch": "@@ -569,7 +569,18 @@ impl FromWithTcx<clean::Variant> for Variant {\n         use clean::Variant::*;\n         match variant {\n             CLike => Variant::Plain,\n-            Tuple(t) => Variant::Tuple(t.into_iter().map(|x| x.into_tcx(tcx)).collect()),\n+            Tuple(fields) => Variant::Tuple(\n+                fields\n+                    .into_iter()\n+                    .map(|f| {\n+                        if let clean::StructFieldItem(ty) = *f.kind {\n+                            ty.into_tcx(tcx)\n+                        } else {\n+                            unreachable!()\n+                        }\n+                    })\n+                    .collect(),\n+            ),\n             Struct(s) => Variant::Struct(ids(s.fields)),\n         }\n     }"}, {"sha": "a93880453ba274916cca5561235e5179ac9da166", "filename": "src/librustdoc/passes/stripper.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f4f5dd518603efdf5783f9c434392c939ae9b821/src%2Flibrustdoc%2Fpasses%2Fstripper.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f4f5dd518603efdf5783f9c434392c939ae9b821/src%2Flibrustdoc%2Fpasses%2Fstripper.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fstripper.rs?ref=f4f5dd518603efdf5783f9c434392c939ae9b821", "patch": "@@ -94,8 +94,8 @@ impl<'a> DocFolder for Stripper<'a> {\n \n             // implementations of traits are always public.\n             clean::ImplItem(ref imp) if imp.trait_.is_some() => true,\n-            // Struct variant fields have inherited visibility\n-            clean::VariantItem(clean::Variant::Struct(..)) => true,\n+            // Variant fields have inherited visibility\n+            clean::VariantItem(clean::Variant::Struct(..) | clean::Variant::Tuple(..)) => true,\n             _ => false,\n         };\n "}, {"sha": "246e6a09007b347ec0cb79071d701aae62597b74", "filename": "src/test/rustdoc-json/enums/variant_struct.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/f4f5dd518603efdf5783f9c434392c939ae9b821/src%2Ftest%2Frustdoc-json%2Fenums%2Fvariant_struct.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f4f5dd518603efdf5783f9c434392c939ae9b821/src%2Ftest%2Frustdoc-json%2Fenums%2Fvariant_struct.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-json%2Fenums%2Fvariant_struct.rs?ref=f4f5dd518603efdf5783f9c434392c939ae9b821", "patch": "@@ -0,0 +1,11 @@\n+// @has variant_struct.json \"$.index[*][?(@.name=='EnumStruct')].visibility\" \\\"public\\\"\n+// @has - \"$.index[*][?(@.name=='EnumStruct')].kind\" \\\"enum\\\"\n+pub enum EnumStruct {\n+    // @has - \"$.index[*][?(@.name=='VariantS')].inner.variant_kind\" \\\"struct\\\"\n+    // @has - \"$.index[*][?(@.name=='x')]\"\n+    // @has - \"$.index[*][?(@.name=='y')]\"\n+    VariantS {\n+        x: u32,\n+        y: String,\n+    },\n+}"}, {"sha": "d948dc552cdbcab874b9b4a2e41be150c1e0e02a", "filename": "src/test/rustdoc-json/enums/variant_tuple_struct.rs", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/f4f5dd518603efdf5783f9c434392c939ae9b821/src%2Ftest%2Frustdoc-json%2Fenums%2Fvariant_tuple_struct.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f4f5dd518603efdf5783f9c434392c939ae9b821/src%2Ftest%2Frustdoc-json%2Fenums%2Fvariant_tuple_struct.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-json%2Fenums%2Fvariant_tuple_struct.rs?ref=f4f5dd518603efdf5783f9c434392c939ae9b821", "patch": "@@ -0,0 +1,6 @@\n+// @has variant_tuple_struct.json \"$.index[*][?(@.name=='EnumTupleStruct')].visibility\" \\\"public\\\"\n+// @has - \"$.index[*][?(@.name=='EnumTupleStruct')].kind\" \\\"enum\\\"\n+pub enum EnumTupleStruct {\n+    // @has - \"$.index[*][?(@.name=='VariantA')].inner.variant_kind\" \\\"tuple\\\"\n+    VariantA(u32, String),\n+}"}]}