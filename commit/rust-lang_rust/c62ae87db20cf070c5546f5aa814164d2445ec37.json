{"sha": "c62ae87db20cf070c5546f5aa814164d2445ec37", "node_id": "MDY6Q29tbWl0NzI0NzEyOmM2MmFlODdkYjIwY2YwNzBjNTU0NmY1YWE4MTQxNjRkMjQ0NWVjMzc=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-03-15T21:16:04Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-03-15T21:16:04Z"}, "message": "Auto merge of #23206 - nagisa:print-io, r=alexcrichton\n\nr? @alexcrichton or @aturon \r\n\r\nThis still needs to somehow figure out how to avoid unstable warnings arising from the use of unstable functions. I tried to use `#[allow_internal_unstable]` but it still spits out warnings as far as I can see. @huonw (I think you implemented it) does `#[allow_internal_unstable]` not work for some reason or am I using it incorrectly?", "tree": {"sha": "fa8658d0f9c77946d896eb91691f28dc4a25d114", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fa8658d0f9c77946d896eb91691f28dc4a25d114"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c62ae87db20cf070c5546f5aa814164d2445ec37", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c62ae87db20cf070c5546f5aa814164d2445ec37", "html_url": "https://github.com/rust-lang/rust/commit/c62ae87db20cf070c5546f5aa814164d2445ec37", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c62ae87db20cf070c5546f5aa814164d2445ec37/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "542e2bb3910f8860d49b4b40bcd78d9c74e733ff", "url": "https://api.github.com/repos/rust-lang/rust/commits/542e2bb3910f8860d49b4b40bcd78d9c74e733ff", "html_url": "https://github.com/rust-lang/rust/commit/542e2bb3910f8860d49b4b40bcd78d9c74e733ff"}, {"sha": "6e92f0580b0bfe8433df73a9139eaa72c47258b2", "url": "https://api.github.com/repos/rust-lang/rust/commits/6e92f0580b0bfe8433df73a9139eaa72c47258b2", "html_url": "https://github.com/rust-lang/rust/commit/6e92f0580b0bfe8433df73a9139eaa72c47258b2"}], "stats": {"total": 119, "additions": 62, "deletions": 57}, "files": [{"sha": "e132e9833c16df16ce933dade29094acfc85d4bc", "filename": "src/librustc_driver/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/c62ae87db20cf070c5546f5aa814164d2445ec37/src%2Flibrustc_driver%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c62ae87db20cf070c5546f5aa814164d2445ec37/src%2Flibrustc_driver%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Flib.rs?ref=c62ae87db20cf070c5546f5aa814164d2445ec37", "patch": "@@ -37,7 +37,7 @@\n #![feature(staged_api)]\n #![feature(exit_status)]\n #![feature(io)]\n-#![feature(set_panic)]\n+#![feature(set_stdio)]\n \n extern crate arena;\n extern crate flate;"}, {"sha": "bd4177861dd42f9d53ee6b3d5861fa8a0bc41ae0", "filename": "src/librustdoc/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/c62ae87db20cf070c5546f5aa814164d2445ec37/src%2Flibrustdoc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c62ae87db20cf070c5546f5aa814164d2445ec37/src%2Flibrustdoc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Flib.rs?ref=c62ae87db20cf070c5546f5aa814164d2445ec37", "patch": "@@ -26,7 +26,7 @@\n #![feature(core)]\n #![feature(exit_status)]\n #![feature(int_uint)]\n-#![feature(set_panic)]\n+#![feature(set_stdio)]\n #![feature(libc)]\n #![feature(old_path)]\n #![feature(rustc_private)]"}, {"sha": "35ef375174ad059fb515b942ccea783990cd0491", "filename": "src/libstd/io/mod.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/c62ae87db20cf070c5546f5aa814164d2445ec37/src%2Flibstd%2Fio%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c62ae87db20cf070c5546f5aa814164d2445ec37/src%2Flibstd%2Fio%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fio%2Fmod.rs?ref=c62ae87db20cf070c5546f5aa814164d2445ec37", "patch": "@@ -33,10 +33,10 @@ pub use self::buffered::IntoInnerError;\n pub use self::cursor::Cursor;\n pub use self::error::{Result, Error, ErrorKind};\n pub use self::util::{copy, sink, Sink, empty, Empty, repeat, Repeat};\n-pub use self::stdio::{stdin, stdout, stderr, Stdin, Stdout, Stderr};\n+pub use self::stdio::{stdin, stdout, stderr, _print, Stdin, Stdout, Stderr};\n pub use self::stdio::{StdoutLock, StderrLock, StdinLock};\n #[doc(no_inline, hidden)]\n-pub use self::stdio::set_panic;\n+pub use self::stdio::{set_panic, set_print};\n \n #[macro_use] mod lazy;\n "}, {"sha": "75d047d5c9c85dd3bdb4d346216b42bceda2cbbf", "filename": "src/libstd/io/stdio.rs", "status": "modified", "additions": 47, "deletions": 5, "changes": 52, "blob_url": "https://github.com/rust-lang/rust/blob/c62ae87db20cf070c5546f5aa814164d2445ec37/src%2Flibstd%2Fio%2Fstdio.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c62ae87db20cf070c5546f5aa814164d2445ec37/src%2Flibstd%2Fio%2Fstdio.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fio%2Fstdio.rs?ref=c62ae87db20cf070c5546f5aa814164d2445ec37", "patch": "@@ -11,13 +11,21 @@\n use prelude::v1::*;\n use io::prelude::*;\n \n+use cell::RefCell;\n use cmp;\n use fmt;\n use io::lazy::Lazy;\n use io::{self, BufReader, LineWriter};\n use sync::{Arc, Mutex, MutexGuard};\n use sys::stdio;\n \n+/// Stdout used by print! and println! macroses\n+thread_local! {\n+    static LOCAL_STDOUT: RefCell<Option<Box<Write + Send>>> = {\n+        RefCell::new(None)\n+    }\n+}\n+\n /// A handle to a raw instance of the standard input stream of this process.\n ///\n /// This handle is not synchronized or buffered in any fashion. Constructed via\n@@ -338,15 +346,15 @@ impl<'a> Write for StderrLock<'a> {\n     fn flush(&mut self) -> io::Result<()> { self.inner.flush() }\n }\n \n-/// Resets the task-local stdout handle to the specified writer\n+/// Resets the task-local stderr handle to the specified writer\n ///\n-/// This will replace the current task's stdout handle, returning the old\n-/// handle. All future calls to `print` and friends will emit their output to\n+/// This will replace the current task's stderr handle, returning the old\n+/// handle. All future calls to `panic!` and friends will emit their output to\n /// this specified handle.\n ///\n /// Note that this does not need to be called for all new tasks; the default\n-/// output handle is to the process's stdout stream.\n-#[unstable(feature = \"set_panic\",\n+/// output handle is to the process's stderr stream.\n+#[unstable(feature = \"set_stdio\",\n            reason = \"this function may disappear completely or be replaced \\\n                      with a more general mechanism\")]\n #[doc(hidden)]\n@@ -360,3 +368,37 @@ pub fn set_panic(sink: Box<Write + Send>) -> Option<Box<Write + Send>> {\n         Some(s)\n     })\n }\n+\n+/// Resets the task-local stdout handle to the specified writer\n+///\n+/// This will replace the current task's stdout handle, returning the old\n+/// handle. All future calls to `print!` and friends will emit their output to\n+/// this specified handle.\n+///\n+/// Note that this does not need to be called for all new tasks; the default\n+/// output handle is to the process's stdout stream.\n+#[unstable(feature = \"set_stdio\",\n+           reason = \"this function may disappear completely or be replaced \\\n+                     with a more general mechanism\")]\n+#[doc(hidden)]\n+pub fn set_print(sink: Box<Write + Send>) -> Option<Box<Write + Send>> {\n+    use mem;\n+    LOCAL_STDOUT.with(move |slot| {\n+        mem::replace(&mut *slot.borrow_mut(), Some(sink))\n+    }).and_then(|mut s| {\n+        let _ = s.flush();\n+        Some(s)\n+    })\n+}\n+\n+#[unstable(feature = \"print\",\n+           reason = \"implementation detail which may disappear or be replaced at any time\")]\n+#[doc(hidden)]\n+pub fn _print(args: fmt::Arguments) {\n+    if let Err(e) = LOCAL_STDOUT.with(|s| match s.borrow_mut().as_mut() {\n+        Some(w) => w.write_fmt(args),\n+        None => stdout().write_fmt(args)\n+    }) {\n+        panic!(\"failed printing to stdout: {}\", e);\n+    }\n+}"}, {"sha": "7378f43f757bf7990c4dc3929bbccdde68ade1e7", "filename": "src/libstd/macros.rs", "status": "modified", "additions": 9, "deletions": 6, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/c62ae87db20cf070c5546f5aa814164d2445ec37/src%2Flibstd%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c62ae87db20cf070c5546f5aa814164d2445ec37/src%2Flibstd%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fmacros.rs?ref=c62ae87db20cf070c5546f5aa814164d2445ec37", "patch": "@@ -60,19 +60,21 @@ macro_rules! panic {\n     });\n }\n \n+/// Macro for printing to the standard output.\n+///\n /// Equivalent to the `println!` macro except that a newline is not printed at\n /// the end of the message.\n #[macro_export]\n #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+#[allow_internal_unstable]\n macro_rules! print {\n-    ($($arg:tt)*) => ($crate::old_io::stdio::print_args(format_args!($($arg)*)))\n+    ($($arg:tt)*) => ($crate::io::_print(format_args!($($arg)*)));\n }\n \n-/// Macro for printing to a task's stdout handle.\n+/// Macro for printing to the standard output.\n ///\n-/// Each task can override its stdout handle via `std::old_io::stdio::set_stdout`.\n-/// The syntax of this macro is the same as that used for `format!`. For more\n-/// information, see `std::fmt` and `std::old_io::stdio`.\n+/// Use the `format!` syntax to write data to the standard output.\n+/// See `std::fmt` for more information.\n ///\n /// # Examples\n ///\n@@ -83,7 +85,8 @@ macro_rules! print {\n #[macro_export]\n #[stable(feature = \"rust1\", since = \"1.0.0\")]\n macro_rules! println {\n-    ($($arg:tt)*) => ($crate::old_io::stdio::println_args(format_args!($($arg)*)))\n+    ($fmt:expr) => (print!(concat!($fmt, \"\\n\")));\n+    ($fmt:expr, $($arg:tt)*) => (print!(concat!($fmt, \"\\n\"), $($arg)*));\n }\n \n /// Helper macro for unwrapping `Result` values while returning early with an"}, {"sha": "dcc34505730939ad9dc839bbd78a642d6dc0e8a4", "filename": "src/libstd/old_io/stdio.rs", "status": "modified", "additions": 0, "deletions": 14, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/c62ae87db20cf070c5546f5aa814164d2445ec37/src%2Flibstd%2Fold_io%2Fstdio.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c62ae87db20cf070c5546f5aa814164d2445ec37/src%2Flibstd%2Fold_io%2Fstdio.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fold_io%2Fstdio.rs?ref=c62ae87db20cf070c5546f5aa814164d2445ec37", "patch": "@@ -535,18 +535,4 @@ mod tests {\n         stdout();\n         stderr();\n     }\n-\n-    #[test]\n-    fn capture_stdout() {\n-        use old_io::{ChanReader, ChanWriter};\n-\n-        let (tx, rx) = channel();\n-        let (mut r, w) = (ChanReader::new(rx), ChanWriter::new(tx));\n-        // FIXME (#22405): Replace `Box::new` with `box` here when/if possible.\n-        let _t = thread::spawn(move|| {\n-            set_stdout(Box::new(w));\n-            println!(\"hello!\");\n-        });\n-        assert_eq!(r.read_to_string().unwrap(), \"hello!\\n\");\n-    }\n }"}, {"sha": "8fe0cd6ebd4e0c78e780b0eda1e4c0f7fb2e7baa", "filename": "src/libtest/lib.rs", "status": "modified", "additions": 2, "deletions": 9, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/c62ae87db20cf070c5546f5aa814164d2445ec37/src%2Flibtest%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c62ae87db20cf070c5546f5aa814164d2445ec37/src%2Flibtest%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibtest%2Flib.rs?ref=c62ae87db20cf070c5546f5aa814164d2445ec37", "patch": "@@ -39,13 +39,12 @@\n #![feature(collections)]\n #![feature(core)]\n #![feature(int_uint)]\n-#![feature(old_io)]\n #![feature(rustc_private)]\n #![feature(staged_api)]\n #![feature(std_misc)]\n #![feature(io)]\n #![feature(libc)]\n-#![feature(set_panic)]\n+#![feature(set_stdio)]\n \n extern crate getopts;\n extern crate serialize;\n@@ -908,7 +907,6 @@ pub fn run_test(opts: &TestOpts,\n         return;\n     }\n \n-    #[allow(deprecated)] // set_stdout\n     fn run_test_inner(desc: TestDesc,\n                       monitor_ch: Sender<MonitorMsg>,\n                       nocapture: bool,\n@@ -920,11 +918,6 @@ pub fn run_test(opts: &TestOpts,\n             }\n             fn flush(&mut self) -> io::Result<()> { Ok(()) }\n         }\n-        impl Writer for Sink {\n-            fn write_all(&mut self, data: &[u8]) -> std::old_io::IoResult<()> {\n-                Writer::write_all(&mut *self.0.lock().unwrap(), data)\n-            }\n-        }\n \n         thread::spawn(move || {\n             let data = Arc::new(Mutex::new(Vec::new()));\n@@ -936,7 +929,7 @@ pub fn run_test(opts: &TestOpts,\n \n             let result_guard = cfg.spawn(move || {\n                 if !nocapture {\n-                    std::old_io::stdio::set_stdout(box Sink(data2.clone()));\n+                    io::set_print(box Sink(data2.clone()));\n                     io::set_panic(box Sink(data2));\n                 }\n                 testfn.invoke(())"}, {"sha": "84d86c5746c0bcfdaa81c9e62b630c5625fbc8fb", "filename": "src/libtest/stats.rs", "status": "modified", "additions": 0, "deletions": 19, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/c62ae87db20cf070c5546f5aa814164d2445ec37/src%2Flibtest%2Fstats.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c62ae87db20cf070c5546f5aa814164d2445ec37/src%2Flibtest%2Fstats.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibtest%2Fstats.rs?ref=c62ae87db20cf070c5546f5aa814164d2445ec37", "patch": "@@ -11,9 +11,6 @@\n #![allow(missing_docs)]\n \n use std::cmp::Ordering::{self, Less, Greater, Equal};\n-use std::collections::hash_map::Entry::{Occupied, Vacant};\n-use std::collections::hash_map;\n-use std::hash::Hash;\n use std::mem;\n use std::num::{Float, FromPrimitive};\n \n@@ -330,22 +327,6 @@ pub fn winsorize<T: Float + FromPrimitive>(samples: &mut [T], pct: T) {\n     }\n }\n \n-/// Returns a HashMap with the number of occurrences of every element in the\n-/// sequence that the iterator exposes.\n-#[cfg(not(stage0))]\n-pub fn freq_count<T, U>(iter: T) -> hash_map::HashMap<U, uint>\n-  where T: Iterator<Item=U>, U: Eq + Clone + Hash\n-{\n-    let mut map: hash_map::HashMap<U,uint> = hash_map::HashMap::new();\n-    for elem in iter {\n-        match map.entry(elem) {\n-            Occupied(mut entry) => { *entry.get_mut() += 1; },\n-            Vacant(entry) => { entry.insert(1); },\n-        }\n-    }\n-    map\n-}\n-\n // Test vectors generated from R, using the script src/etc/stat-test-vectors.r.\n \n #[cfg(test)]"}]}