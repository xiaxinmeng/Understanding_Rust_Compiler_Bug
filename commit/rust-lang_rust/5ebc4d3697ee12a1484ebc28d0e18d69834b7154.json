{"sha": "5ebc4d3697ee12a1484ebc28d0e18d69834b7154", "node_id": "MDY6Q29tbWl0NzI0NzEyOjVlYmM0ZDM2OTdlZTEyYTE0ODRlYmMyOGQwZTE4ZDY5ODM0YjcxNTQ=", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2021-06-04T21:13:39Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-06-04T21:13:39Z"}, "message": "Rollup merge of #85939 - m-ou-se:fix-remove-ref-macro-invocation, r=estebank\n\nFix suggestion for removing &mut from &mut macro!().\n\nFixes #85933\n\nBefore: (Note the suggestions.)\n```\nerror[E0308]: mismatched types\n --> src/main.rs:2:21\n  |\n2 |     let _: String = &mut format!(\"\");\n  |            ------   ^^^^^^^^^^^^^^^^\n  |            |        |\n  |            |        expected struct `String`, found `&mut String`\n  |            |        help: consider removing the borrow: `mut format!(\"\")`\n  |            expected due to this\n\nerror[E0308]: mismatched types\n --> src/main.rs:3:21\n  |\n3 |     let _: String = &mut (format!(\"\"));\n  |            ------   ^^^^^^^^^^^^^^^^^^\n  |            |        |\n  |            |        expected struct `String`, found `&mut String`\n  |            |        help: consider removing the borrow: `mut (format!(\"\"))`\n  |            expected due to this\n```\n\nAfter:\n```\nerror[E0308]: mismatched types\n --> src/main.rs:2:21\n  |\n2 |     let _: String = &mut format!(\"\");\n  |            ------   ^^^^^^^^^^^^^^^^\n  |            |        |\n  |            |        expected struct `String`, found `&mut String`\n  |            |        help: consider removing the borrow: `format!(\"\")`\n  |            expected due to this\n\nerror[E0308]: mismatched types\n --> src/main.rs:3:21\n  |\n3 |     let _: String = &mut (format!(\"\"));\n  |            ------   ^^^^^^^^^^^^^^^^^^\n  |            |        |\n  |            |        expected struct `String`, found `&mut String`\n  |            |        help: consider removing the borrow: `format!(\"\")`\n  |            expected due to this\n```", "tree": {"sha": "d85d0d4532ae16e933406e5fcbaa7e80de612de2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d85d0d4532ae16e933406e5fcbaa7e80de612de2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5ebc4d3697ee12a1484ebc28d0e18d69834b7154", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgupeFCRBK7hj4Ov3rIwAAaJQIAJfpXg1NzfLNBncf5J8BNy+D\nfnDOMOD7iiMb0JrFYC9v2y0nxh/aAv0tXhu1EbKnm7nrqDcrLVOMdwxlf4Qi10uO\nIHTc2bDybKyyrbJZkeKlHfrTTLP7rDnnBwwIbH+d5JGPngHHsygTiP9j5DknuNti\nLZs8YSj0Uef8Pc7Xw1AyeylUWC77uj/KhIpwM20PHMICfT+/x5iU17aodV6Ls/aY\nj2DJm8Xq4XVtRm/w0+BwzfBIbGls/AGnt6I7MwddgeyrU+gIIY5UP8SdP/aSXjyi\nZZAH3psmwfTotZHIApHhPG/9QAUBlC+b6vPdxCSA8inwbM2+3uK8PYoqTCiGXcw=\n=UHam\n-----END PGP SIGNATURE-----\n", "payload": "tree d85d0d4532ae16e933406e5fcbaa7e80de612de2\nparent ec9e7d5df1f3cec1889573f9fb470c174cf96dfa\nparent ecebb669d5fa442b903a3a17f72cbf2268a5a080\nauthor Yuki Okushi <jtitor@2k36.org> 1622841219 +0900\ncommitter GitHub <noreply@github.com> 1622841219 +0900\n\nRollup merge of #85939 - m-ou-se:fix-remove-ref-macro-invocation, r=estebank\n\nFix suggestion for removing &mut from &mut macro!().\n\nFixes #85933\n\nBefore: (Note the suggestions.)\n```\nerror[E0308]: mismatched types\n --> src/main.rs:2:21\n  |\n2 |     let _: String = &mut format!(\"\");\n  |            ------   ^^^^^^^^^^^^^^^^\n  |            |        |\n  |            |        expected struct `String`, found `&mut String`\n  |            |        help: consider removing the borrow: `mut format!(\"\")`\n  |            expected due to this\n\nerror[E0308]: mismatched types\n --> src/main.rs:3:21\n  |\n3 |     let _: String = &mut (format!(\"\"));\n  |            ------   ^^^^^^^^^^^^^^^^^^\n  |            |        |\n  |            |        expected struct `String`, found `&mut String`\n  |            |        help: consider removing the borrow: `mut (format!(\"\"))`\n  |            expected due to this\n```\n\nAfter:\n```\nerror[E0308]: mismatched types\n --> src/main.rs:2:21\n  |\n2 |     let _: String = &mut format!(\"\");\n  |            ------   ^^^^^^^^^^^^^^^^\n  |            |        |\n  |            |        expected struct `String`, found `&mut String`\n  |            |        help: consider removing the borrow: `format!(\"\")`\n  |            expected due to this\n\nerror[E0308]: mismatched types\n --> src/main.rs:3:21\n  |\n3 |     let _: String = &mut (format!(\"\"));\n  |            ------   ^^^^^^^^^^^^^^^^^^\n  |            |        |\n  |            |        expected struct `String`, found `&mut String`\n  |            |        help: consider removing the borrow: `format!(\"\")`\n  |            expected due to this\n```\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5ebc4d3697ee12a1484ebc28d0e18d69834b7154", "html_url": "https://github.com/rust-lang/rust/commit/5ebc4d3697ee12a1484ebc28d0e18d69834b7154", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5ebc4d3697ee12a1484ebc28d0e18d69834b7154/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ec9e7d5df1f3cec1889573f9fb470c174cf96dfa", "url": "https://api.github.com/repos/rust-lang/rust/commits/ec9e7d5df1f3cec1889573f9fb470c174cf96dfa", "html_url": "https://github.com/rust-lang/rust/commit/ec9e7d5df1f3cec1889573f9fb470c174cf96dfa"}, {"sha": "ecebb669d5fa442b903a3a17f72cbf2268a5a080", "url": "https://api.github.com/repos/rust-lang/rust/commits/ecebb669d5fa442b903a3a17f72cbf2268a5a080", "html_url": "https://github.com/rust-lang/rust/commit/ecebb669d5fa442b903a3a17f72cbf2268a5a080"}], "stats": {"total": 40, "additions": 36, "deletions": 4}, "files": [{"sha": "33bc25accb319dceffcf2862d321aaf476cbee1f", "filename": "compiler/rustc_typeck/src/check/demand.rs", "status": "modified", "additions": 11, "deletions": 3, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/5ebc4d3697ee12a1484ebc28d0e18d69834b7154/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fdemand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5ebc4d3697ee12a1484ebc28d0e18d69834b7154/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fdemand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fdemand.rs?ref=5ebc4d3697ee12a1484ebc28d0e18d69834b7154", "patch": "@@ -17,6 +17,7 @@ use rustc_span::Span;\n use super::method::probe;\n \n use std::fmt;\n+use std::iter;\n \n impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n     pub fn emit_coerce_suggestions(\n@@ -573,12 +574,19 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                 // We have `&T`, check if what was expected was `T`. If so,\n                 // we may want to suggest removing a `&`.\n                 if sm.is_imported(expr.span) {\n-                    if let Ok(src) = sm.span_to_snippet(sp) {\n-                        if let Some(src) = src.strip_prefix('&') {\n+                    // Go through the spans from which this span was expanded,\n+                    // and find the one that's pointing inside `sp`.\n+                    //\n+                    // E.g. for `&format!(\"\")`, where we want the span to the\n+                    // `format!()` invocation instead of its expansion.\n+                    if let Some(call_span) =\n+                        iter::successors(Some(expr.span), |s| s.parent()).find(|&s| sp.contains(s))\n+                    {\n+                        if let Ok(code) = sm.span_to_snippet(call_span) {\n                             return Some((\n                                 sp,\n                                 \"consider removing the borrow\",\n-                                src.to_string(),\n+                                code,\n                                 Applicability::MachineApplicable,\n                             ));\n                         }"}, {"sha": "599a79fc08af46d9922128d10f5e24a08c3d1b90", "filename": "src/test/ui/suggestions/format-borrow.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/5ebc4d3697ee12a1484ebc28d0e18d69834b7154/src%2Ftest%2Fui%2Fsuggestions%2Fformat-borrow.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5ebc4d3697ee12a1484ebc28d0e18d69834b7154/src%2Ftest%2Fui%2Fsuggestions%2Fformat-borrow.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggestions%2Fformat-borrow.rs?ref=5ebc4d3697ee12a1484ebc28d0e18d69834b7154", "patch": "@@ -3,4 +3,8 @@ fn main() {\n     //~^ ERROR mismatched types\n     let b: String = &format!(\"b\");\n     //~^ ERROR mismatched types\n+    let c: String = &mut format!(\"c\");\n+    //~^ ERROR mismatched types\n+    let d: String = &mut (format!(\"d\"));\n+    //~^ ERROR mismatched types\n }"}, {"sha": "0881b024712c5daa1c75b39100f5e4a420d6cbba", "filename": "src/test/ui/suggestions/format-borrow.stderr", "status": "modified", "additions": 21, "deletions": 1, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/5ebc4d3697ee12a1484ebc28d0e18d69834b7154/src%2Ftest%2Fui%2Fsuggestions%2Fformat-borrow.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/5ebc4d3697ee12a1484ebc28d0e18d69834b7154/src%2Ftest%2Fui%2Fsuggestions%2Fformat-borrow.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggestions%2Fformat-borrow.stderr?ref=5ebc4d3697ee12a1484ebc28d0e18d69834b7154", "patch": "@@ -18,6 +18,26 @@ LL |     let b: String = &format!(\"b\");\n    |            |        help: consider removing the borrow: `format!(\"b\")`\n    |            expected due to this\n \n-error: aborting due to 2 previous errors\n+error[E0308]: mismatched types\n+  --> $DIR/format-borrow.rs:6:21\n+   |\n+LL |     let c: String = &mut format!(\"c\");\n+   |            ------   ^^^^^^^^^^^^^^^^^\n+   |            |        |\n+   |            |        expected struct `String`, found `&mut String`\n+   |            |        help: consider removing the borrow: `format!(\"c\")`\n+   |            expected due to this\n+\n+error[E0308]: mismatched types\n+  --> $DIR/format-borrow.rs:8:21\n+   |\n+LL |     let d: String = &mut (format!(\"d\"));\n+   |            ------   ^^^^^^^^^^^^^^^^^^^\n+   |            |        |\n+   |            |        expected struct `String`, found `&mut String`\n+   |            |        help: consider removing the borrow: `format!(\"d\")`\n+   |            expected due to this\n+\n+error: aborting due to 4 previous errors\n \n For more information about this error, try `rustc --explain E0308`."}]}