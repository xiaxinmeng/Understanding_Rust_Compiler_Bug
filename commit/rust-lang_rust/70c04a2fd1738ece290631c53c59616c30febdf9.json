{"sha": "70c04a2fd1738ece290631c53c59616c30febdf9", "node_id": "C_kwDOAAsO6NoAKDcwYzA0YTJmZDE3MzhlY2UyOTA2MzFjNTNjNTk2MTZjMzBmZWJkZjk", "commit": {"author": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2022-11-09T20:39:07Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-11-09T20:39:07Z"}, "message": "Rollup merge of #104184 - jyn514:rustdoc-version, r=davidtwco\n\nFix `rustdoc --version` when used with download-rustc\n\nPreviously, rustdoc would unconditionally report the version that *rustc* was compiled with. That showed things like `nightly-2022-10-30`, which wasn't right, since this was a `dev` build compiled from source.\n\nFix it by changing `rustc_driver::version` to a macro expanded at invocation time.\n\ncc https://github.com/rust-lang/rust/issues/103206#issuecomment-1284123084", "tree": {"sha": "bc2d4cc03695a0ead4727eae58f93c2874813fc2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bc2d4cc03695a0ead4727eae58f93c2874813fc2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/70c04a2fd1738ece290631c53c59616c30febdf9", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjbA/rCRBK7hj4Ov3rIwAAXzAIAAO5ODyJdMdba3RcLWA548po\n+n213hhaP/1zSff0bXLvT0L1DM9NtcZc6qLEEgJscH1GWXbLY5vQKEsdUljFiZni\nMkE2P7AZiiOmtM5smE0bRNV+ZOQbp3iuNZTmjw6x/R62UExJNFNvjrKPY9DqvvzO\nIvKh6A3reev0SM8gBhFCfAkFgMDQLEyoKBIUbJ3HeFRepS9LoDKGGu974jSOZWti\nkHBZtSGJkJwv3HlhqT2Wjh2pntf8CU2DnHTeT5c8JppQm1bFQghiytZyOVWWXZPB\nyeuShB8aFb1EQHXZdMn+Gbbu9OxPApFO0fy6m4/FJiKrixt7o8vwAyrhvDsnq+s=\n=SLKS\n-----END PGP SIGNATURE-----\n", "payload": "tree bc2d4cc03695a0ead4727eae58f93c2874813fc2\nparent 656f56c2d697488bd775449c8e711c5cd1070901\nparent a68ec2205335e2c3de8ba56fb6a31b99f10c95a6\nauthor Manish Goregaokar <manishsmail@gmail.com> 1668026347 -0500\ncommitter GitHub <noreply@github.com> 1668026347 -0500\n\nRollup merge of #104184 - jyn514:rustdoc-version, r=davidtwco\n\nFix `rustdoc --version` when used with download-rustc\n\nPreviously, rustdoc would unconditionally report the version that *rustc* was compiled with. That showed things like `nightly-2022-10-30`, which wasn't right, since this was a `dev` build compiled from source.\n\nFix it by changing `rustc_driver::version` to a macro expanded at invocation time.\n\ncc https://github.com/rust-lang/rust/issues/103206#issuecomment-1284123084\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/70c04a2fd1738ece290631c53c59616c30febdf9", "html_url": "https://github.com/rust-lang/rust/commit/70c04a2fd1738ece290631c53c59616c30febdf9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/70c04a2fd1738ece290631c53c59616c30febdf9/comments", "author": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "656f56c2d697488bd775449c8e711c5cd1070901", "url": "https://api.github.com/repos/rust-lang/rust/commits/656f56c2d697488bd775449c8e711c5cd1070901", "html_url": "https://github.com/rust-lang/rust/commit/656f56c2d697488bd775449c8e711c5cd1070901"}, {"sha": "a68ec2205335e2c3de8ba56fb6a31b99f10c95a6", "url": "https://api.github.com/repos/rust-lang/rust/commits/a68ec2205335e2c3de8ba56fb6a31b99f10c95a6", "html_url": "https://github.com/rust-lang/rust/commit/a68ec2205335e2c3de8ba56fb6a31b99f10c95a6"}], "stats": {"total": 71, "additions": 42, "deletions": 29}, "files": [{"sha": "2ba012a77b0a908788f0272705f82f7c875cb1a7", "filename": "compiler/rustc_codegen_cranelift/src/debuginfo/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/70c04a2fd1738ece290631c53c59616c30febdf9/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fdebuginfo%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/70c04a2fd1738ece290631c53c59616c30febdf9/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fdebuginfo%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fdebuginfo%2Fmod.rs?ref=70c04a2fd1738ece290631c53c59616c30febdf9", "patch": "@@ -59,7 +59,7 @@ impl DebugContext {\n \n         let producer = format!(\n             \"cg_clif (rustc {}, cranelift {})\",\n-            rustc_interface::util::version_str().unwrap_or(\"unknown version\"),\n+            rustc_interface::util::rustc_version_str().unwrap_or(\"unknown version\"),\n             cranelift_codegen::VERSION,\n         );\n         let comp_dir = tcx"}, {"sha": "e043368fdfe0210ae475bd7b151310538ba099cc", "filename": "compiler/rustc_driver/src/lib.rs", "status": "modified", "additions": 32, "deletions": 10, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/70c04a2fd1738ece290631c53c59616c30febdf9/compiler%2Frustc_driver%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/70c04a2fd1738ece290631c53c59616c30febdf9/compiler%2Frustc_driver%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_driver%2Fsrc%2Flib.rs?ref=70c04a2fd1738ece290631c53c59616c30febdf9", "patch": "@@ -6,6 +6,7 @@\n \n #![doc(html_root_url = \"https://doc.rust-lang.org/nightly/nightly-rustc/\")]\n #![feature(once_cell)]\n+#![feature(decl_macro)]\n #![recursion_limit = \"256\"]\n #![allow(rustc::potential_query_instability)]\n #![deny(rustc::untranslatable_diagnostic)]\n@@ -753,20 +754,41 @@ fn print_crate_info(\n }\n \n /// Prints version information\n-pub fn version(binary: &str, matches: &getopts::Matches) {\n+///\n+/// NOTE: this is a macro to support drivers built at a different time than the main `rustc_driver` crate.\n+pub macro version($binary: literal, $matches: expr) {\n+    fn unw(x: Option<&str>) -> &str {\n+        x.unwrap_or(\"unknown\")\n+    }\n+    $crate::version_at_macro_invocation(\n+        $binary,\n+        $matches,\n+        unw(option_env!(\"CFG_VERSION\")),\n+        unw(option_env!(\"CFG_VER_HASH\")),\n+        unw(option_env!(\"CFG_VER_DATE\")),\n+        unw(option_env!(\"CFG_RELEASE\")),\n+    )\n+}\n+\n+#[doc(hidden)] // use the macro instead\n+pub fn version_at_macro_invocation(\n+    binary: &str,\n+    matches: &getopts::Matches,\n+    version: &str,\n+    commit_hash: &str,\n+    commit_date: &str,\n+    release: &str,\n+) {\n     let verbose = matches.opt_present(\"verbose\");\n \n-    println!(\"{} {}\", binary, util::version_str().unwrap_or(\"unknown version\"));\n+    println!(\"{} {}\", binary, version);\n \n     if verbose {\n-        fn unw(x: Option<&str>) -> &str {\n-            x.unwrap_or(\"unknown\")\n-        }\n         println!(\"binary: {}\", binary);\n-        println!(\"commit-hash: {}\", unw(util::commit_hash_str()));\n-        println!(\"commit-date: {}\", unw(util::commit_date_str()));\n+        println!(\"commit-hash: {}\", commit_hash);\n+        println!(\"commit-date: {}\", commit_date);\n         println!(\"host: {}\", config::host_triple());\n-        println!(\"release: {}\", unw(util::release_str()));\n+        println!(\"release: {}\", release);\n \n         let debug_flags = matches.opt_strs(\"Z\");\n         let backend_name = debug_flags.iter().find_map(|x| x.strip_prefix(\"codegen-backend=\"));\n@@ -1082,7 +1104,7 @@ pub fn handle_options(args: &[String]) -> Option<getopts::Matches> {\n     }\n \n     if matches.opt_present(\"version\") {\n-        version(\"rustc\", &matches);\n+        version!(\"rustc\", &matches);\n         return None;\n     }\n \n@@ -1227,7 +1249,7 @@ pub fn report_ice(info: &panic::PanicInfo<'_>, bug_report_url: &str) {\n         format!(\"we would appreciate a bug report: {}\", bug_report_url).into(),\n         format!(\n             \"rustc {} running on {}\",\n-            util::version_str().unwrap_or(\"unknown_version\"),\n+            util::version_str!().unwrap_or(\"unknown_version\"),\n             config::host_triple()\n         )\n         .into(),"}, {"sha": "542b638bbd7a40dcb5596aca193092332b93a811", "filename": "compiler/rustc_interface/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/70c04a2fd1738ece290631c53c59616c30febdf9/compiler%2Frustc_interface%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/70c04a2fd1738ece290631c53c59616c30febdf9/compiler%2Frustc_interface%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2Fsrc%2Flib.rs?ref=70c04a2fd1738ece290631c53c59616c30febdf9", "patch": "@@ -1,4 +1,5 @@\n #![feature(box_patterns)]\n+#![feature(decl_macro)]\n #![feature(internal_output_capture)]\n #![feature(thread_spawn_unchecked)]\n #![feature(once_cell)]"}, {"sha": "2fe3fb2fa5668013978287aa75086ea0d42480ce", "filename": "compiler/rustc_interface/src/util.rs", "status": "modified", "additions": 6, "deletions": 16, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/70c04a2fd1738ece290631c53c59616c30febdf9/compiler%2Frustc_interface%2Fsrc%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/70c04a2fd1738ece290631c53c59616c30febdf9/compiler%2Frustc_interface%2Fsrc%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2Fsrc%2Futil.rs?ref=70c04a2fd1738ece290631c53c59616c30febdf9", "patch": "@@ -327,7 +327,7 @@ fn get_codegen_sysroot(maybe_sysroot: &Option<PathBuf>, backend_name: &str) -> M\n     let mut file: Option<PathBuf> = None;\n \n     let expected_names = &[\n-        format!(\"rustc_codegen_{}-{}\", backend_name, release_str().expect(\"CFG_RELEASE\")),\n+        format!(\"rustc_codegen_{}-{}\", backend_name, env!(\"CFG_RELEASE\")),\n         format!(\"rustc_codegen_{}\", backend_name),\n     ];\n     for entry in d.filter_map(|e| e.ok()) {\n@@ -554,22 +554,12 @@ pub fn build_output_filenames(\n     }\n }\n \n-/// Returns a version string such as \"1.46.0 (04488afe3 2020-08-24)\"\n-pub fn version_str() -> Option<&'static str> {\n+/// Returns a version string such as \"1.46.0 (04488afe3 2020-08-24)\" when invoked by an in-tree tool.\n+pub macro version_str() {\n     option_env!(\"CFG_VERSION\")\n }\n \n-/// Returns a version string such as \"0.12.0-dev\".\n-pub fn release_str() -> Option<&'static str> {\n-    option_env!(\"CFG_RELEASE\")\n-}\n-\n-/// Returns the full SHA1 hash of HEAD of the Git repo from which rustc was built.\n-pub fn commit_hash_str() -> Option<&'static str> {\n-    option_env!(\"CFG_VER_HASH\")\n-}\n-\n-/// Returns the \"commit date\" of HEAD of the Git repo from which rustc was built as a static string.\n-pub fn commit_date_str() -> Option<&'static str> {\n-    option_env!(\"CFG_VER_DATE\")\n+/// Returns the version string for `rustc` itself (which may be different from a tool version).\n+pub fn rustc_version_str() -> Option<&'static str> {\n+    version_str!()\n }"}, {"sha": "789dd398be50d7298da6dd2bdbfae5e9df742142", "filename": "src/librustdoc/config.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/70c04a2fd1738ece290631c53c59616c30febdf9/src%2Flibrustdoc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/70c04a2fd1738ece290631c53c59616c30febdf9/src%2Flibrustdoc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fconfig.rs?ref=70c04a2fd1738ece290631c53c59616c30febdf9", "patch": "@@ -326,7 +326,7 @@ impl Options {\n             crate::usage(\"rustdoc\");\n             return Err(0);\n         } else if matches.opt_present(\"version\") {\n-            rustc_driver::version(\"rustdoc\", matches);\n+            rustc_driver::version!(\"rustdoc\", matches);\n             return Err(0);\n         }\n "}, {"sha": "a60e7cb10fa515c8b4f17745808f7f8d3d575f70", "filename": "src/librustdoc/html/layout.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/70c04a2fd1738ece290631c53c59616c30febdf9/src%2Flibrustdoc%2Fhtml%2Flayout.rs", "raw_url": "https://github.com/rust-lang/rust/raw/70c04a2fd1738ece290631c53c59616c30febdf9/src%2Flibrustdoc%2Fhtml%2Flayout.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Flayout.rs?ref=70c04a2fd1738ece290631c53c59616c30febdf9", "patch": "@@ -71,7 +71,7 @@ pub(crate) fn render<T: Print, S: Print>(\n     let mut themes: Vec<String> = style_files.iter().map(|s| s.basename().unwrap()).collect();\n     themes.sort();\n \n-    let rustdoc_version = rustc_interface::util::version_str().unwrap_or(\"unknown version\");\n+    let rustdoc_version = rustc_interface::util::version_str!().unwrap_or(\"unknown version\");\n     let content = Buffer::html().to_display(t); // Note: This must happen before making the sidebar.\n     let sidebar = Buffer::html().to_display(sidebar);\n     PageLayout {"}]}