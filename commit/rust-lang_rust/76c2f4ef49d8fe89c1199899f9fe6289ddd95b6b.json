{"sha": "76c2f4ef49d8fe89c1199899f9fe6289ddd95b6b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjc2YzJmNGVmNDlkOGZlODljMTE5OTg5OWY5ZmU2Mjg5ZGRkOTViNmI=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-05-03T09:48:44Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-05-03T09:48:44Z"}, "message": "Merge #4278\n\n4278: Log panics in apply_document_changes r=matklad a=lnicola\n\nThis doesn't necessarily help (because of https://github.com/rust-analyzer/rust-analyzer/issues/4263#issuecomment-623078531), but maybe we could leave it in there for a while in case it catches something.\n\nCo-authored-by: Lauren\u021biu Nicola <lnicola@dend.ro>", "tree": {"sha": "06be8f61590fdb76aeb9d557a10f913ef65f4f7b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/06be8f61590fdb76aeb9d557a10f913ef65f4f7b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/76c2f4ef49d8fe89c1199899f9fe6289ddd95b6b", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJerpN8CRBK7hj4Ov3rIwAAdHIIAFPcZOB/y5IfbBI7s9JDF2nI\n+lXPa3Efng7jB88m88XFESbqghsAD2lKu/0RPDnSPIFGAQRHAy+Eu/xQKWPBEAnc\nBA6dJR+10Tcaz8Y8Z/oE1gmOzbMDagD2gwLDv+XfIpN5x9FKhowm+D35zqz+hu3K\nuYvSeM9o8LFReGNdshQsc5i2pSYjd2ukx7L09YPkkF1LnsovPs/4h8xiSFHI1qRJ\n+lSGYhkX4HZFa78VNcjpnIvx0QD6b8UrCssRAEcVyFcB/Sv1ac7plsxXe82e4fab\nOvW7MQsMjQ2eGStzA8p/iSGgRNhl1LfXRZyCAKAo8Z0eUVe6wAwN1PtCsIkVscc=\n=YQ2b\n-----END PGP SIGNATURE-----\n", "payload": "tree 06be8f61590fdb76aeb9d557a10f913ef65f4f7b\nparent 682c079043656a55775eff33d806da517542f9eb\nparent 074d1ac2f7b3e8a6d4088983ac63235f71d3e6a5\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1588499324 +0000\ncommitter GitHub <noreply@github.com> 1588499324 +0000\n\nMerge #4278\n\n4278: Log panics in apply_document_changes r=matklad a=lnicola\n\nThis doesn't necessarily help (because of https://github.com/rust-analyzer/rust-analyzer/issues/4263#issuecomment-623078531), but maybe we could leave it in there for a while in case it catches something.\n\nCo-authored-by: Lauren\u021biu Nicola <lnicola@dend.ro>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/76c2f4ef49d8fe89c1199899f9fe6289ddd95b6b", "html_url": "https://github.com/rust-lang/rust/commit/76c2f4ef49d8fe89c1199899f9fe6289ddd95b6b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/76c2f4ef49d8fe89c1199899f9fe6289ddd95b6b/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "682c079043656a55775eff33d806da517542f9eb", "url": "https://api.github.com/repos/rust-lang/rust/commits/682c079043656a55775eff33d806da517542f9eb", "html_url": "https://github.com/rust-lang/rust/commit/682c079043656a55775eff33d806da517542f9eb"}, {"sha": "074d1ac2f7b3e8a6d4088983ac63235f71d3e6a5", "url": "https://api.github.com/repos/rust-lang/rust/commits/074d1ac2f7b3e8a6d4088983ac63235f71d3e6a5", "html_url": "https://github.com/rust-lang/rust/commit/074d1ac2f7b3e8a6d4088983ac63235f71d3e6a5"}], "stats": {"total": 18, "additions": 17, "deletions": 1}, "files": [{"sha": "401fae755651b7f5a7a9431f29860b73a8c42208", "filename": "crates/rust-analyzer/src/main_loop.rs", "status": "modified", "additions": 17, "deletions": 1, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/76c2f4ef49d8fe89c1199899f9fe6289ddd95b6b/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/76c2f4ef49d8fe89c1199899f9fe6289ddd95b6b/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs?ref=76c2f4ef49d8fe89c1199899f9fe6289ddd95b6b", "patch": "@@ -666,6 +666,10 @@ fn apply_document_changes(\n     mut line_index: Cow<'_, LineIndex>,\n     content_changes: Vec<TextDocumentContentChangeEvent>,\n ) {\n+    // Remove when https://github.com/rust-analyzer/rust-analyzer/issues/4263 is fixed.\n+    let backup_text = old_text.clone();\n+    let backup_changes = content_changes.clone();\n+\n     // The changes we got must be applied sequentially, but can cross lines so we\n     // have to keep our line index updated.\n     // Some clients (e.g. Code) sort the ranges in reverse. As an optimization, we\n@@ -693,7 +697,19 @@ fn apply_document_changes(\n                 }\n                 index_valid = IndexValid::UpToLine(range.start.line);\n                 let range = range.conv_with(&line_index);\n-                old_text.replace_range(Range::<usize>::from(range), &change.text);\n+                let mut text = old_text.to_owned();\n+                match std::panic::catch_unwind(move || {\n+                    text.replace_range(Range::<usize>::from(range), &change.text);\n+                    text\n+                }) {\n+                    Ok(t) => *old_text = t,\n+                    Err(e) => {\n+                        eprintln!(\"Bug in incremental text synchronization. Please report the following output on https://github.com/rust-analyzer/rust-analyzer/issues/4263\");\n+                        dbg!(&backup_text);\n+                        dbg!(&backup_changes);\n+                        std::panic::resume_unwind(e);\n+                    }\n+                }\n             }\n             None => {\n                 *old_text = change.text;"}]}