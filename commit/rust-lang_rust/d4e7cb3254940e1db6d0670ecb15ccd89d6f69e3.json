{"sha": "d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ0ZTdjYjMyNTQ5NDBlMWRiNmQwNjcwZWNiMTVjY2Q4OWQ2ZjY5ZTM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-06-24T22:42:26Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-06-24T22:42:26Z"}, "message": "Auto merge of #86272 - nagisa:nagisa/tidy-llvm-components, r=Mark-Simulacrum\n\ntidy: verify that test revisions with --target have associated needs-llvm-components directives\n\nThis ensures that people who tend to write `--target` `#[no_core]` tests don't miss specifying the `needs-llvm-components` directive. This is necessary for the test suite to pass when LLVM is compiled with a subset of components enabled.\n\nWhile here I also took the opportunity to implement a more fine-grained handling of the ignore directives, so that they are evaluated for each revision, rather than for the entire test. With this even if people have `arm` component disabled, only the revision that depends on the arm component will not run.\n\nFixes https://github.com/rust-lang/rust/issues/82405", "tree": {"sha": "b3cb75cfcb21fb5986925b4b0b9e68890b0ff9df", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b3cb75cfcb21fb5986925b4b0b9e68890b0ff9df"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "html_url": "https://github.com/rust-lang/rust/commit/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7c3872e6bfd555d2ad753ac1f871db3bd7f2a547", "url": "https://api.github.com/repos/rust-lang/rust/commits/7c3872e6bfd555d2ad753ac1f871db3bd7f2a547", "html_url": "https://github.com/rust-lang/rust/commit/7c3872e6bfd555d2ad753ac1f871db3bd7f2a547"}, {"sha": "cfcb2b664d6f1419a6219f88b060dee420736407", "url": "https://api.github.com/repos/rust-lang/rust/commits/cfcb2b664d6f1419a6219f88b060dee420736407", "html_url": "https://github.com/rust-lang/rust/commit/cfcb2b664d6f1419a6219f88b060dee420736407"}], "stats": {"total": 924, "additions": 517, "deletions": 407}, "files": [{"sha": "9ec7ba83c4278b263b4e57add025815a0780d673", "filename": "src/test/assembly/asm/mips-types.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fassembly%2Fasm%2Fmips-types.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fassembly%2Fasm%2Fmips-types.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fassembly%2Fasm%2Fmips-types.rs?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -2,8 +2,9 @@\n // revisions: mips32 mips64\n // assembly-output: emit-asm\n //[mips32] compile-flags: --target mips-unknown-linux-gnu\n+//[mips32] needs-llvm-components: mips\n //[mips64] compile-flags: --target mips64-unknown-linux-gnuabi64\n-// needs-llvm-components: mips\n+//[mips64] needs-llvm-components: mips\n \n #![feature(no_core, lang_items, rustc_attrs, repr_simd)]\n #![crate_type = \"rlib\"]"}, {"sha": "1e263649e860a335d9291e76773e5c18db81f366", "filename": "src/test/assembly/asm/powerpc-types.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fassembly%2Fasm%2Fpowerpc-types.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fassembly%2Fasm%2Fpowerpc-types.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fassembly%2Fasm%2Fpowerpc-types.rs?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -2,8 +2,9 @@\n // revisions: powerpc powerpc64\n // assembly-output: emit-asm\n //[powerpc] compile-flags: --target powerpc-unknown-linux-gnu\n+//[powerpc] needs-llvm-components: powerpc\n //[powerpc64] compile-flags: --target powerpc64-unknown-linux-gnu\n-// needs-llvm-components: powerpc\n+//[powerpc64] needs-llvm-components: powerpc\n \n #![feature(no_core, lang_items, rustc_attrs, repr_simd)]\n #![crate_type = \"rlib\"]"}, {"sha": "e62a6197b9a5e319adc698b4ea29c465afbee48c", "filename": "src/test/assembly/asm/riscv-types.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fassembly%2Fasm%2Friscv-types.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fassembly%2Fasm%2Friscv-types.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fassembly%2Fasm%2Friscv-types.rs?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -2,9 +2,10 @@\n // revisions: riscv64 riscv32\n // assembly-output: emit-asm\n //[riscv64] compile-flags: --target riscv64imac-unknown-none-elf\n+//[riscv64] needs-llvm-components: riscv\n //[riscv32] compile-flags: --target riscv32imac-unknown-none-elf\n+//[riscv32] needs-llvm-components: riscv\n // compile-flags: -C target-feature=+d\n-// needs-llvm-components: riscv\n // min-system-llvm-version: 12.0\n \n #![feature(no_core, lang_items, rustc_attrs)]"}, {"sha": "c926fd7b3f56539a81d8c905c7f946df22fa8b61", "filename": "src/test/assembly/asm/x86-modifiers.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fassembly%2Fasm%2Fx86-modifiers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fassembly%2Fasm%2Fx86-modifiers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fassembly%2Fasm%2Fx86-modifiers.rs?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -3,7 +3,9 @@\n // assembly-output: emit-asm\n // compile-flags: -O\n //[x86_64] compile-flags: --target x86_64-unknown-linux-gnu\n+//[x86_64] needs-llvm-components: x86\n //[i686] compile-flags: --target i686-unknown-linux-gnu\n+//[i686] needs-llvm-components: x86\n // compile-flags: -C llvm-args=--x86-asm-syntax=intel\n // compile-flags: -C target-feature=+avx512bw\n "}, {"sha": "d25f3a03777a6746beed80a72b1e525062374421", "filename": "src/test/assembly/asm/x86-types.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fassembly%2Fasm%2Fx86-types.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fassembly%2Fasm%2Fx86-types.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fassembly%2Fasm%2Fx86-types.rs?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -2,7 +2,9 @@\n // revisions: x86_64 i686\n // assembly-output: emit-asm\n //[x86_64] compile-flags: --target x86_64-unknown-linux-gnu\n+//[x86_64] needs-llvm-components: x86\n //[i686] compile-flags: --target i686-unknown-linux-gnu\n+//[i686] needs-llvm-components: x86\n // compile-flags: -C llvm-args=--x86-asm-syntax=intel\n // compile-flags: -C target-feature=+avx512bw\n "}, {"sha": "b331d45668ab378711f10001434f8101eba80252", "filename": "src/test/assembly/static-relocation-model.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fassembly%2Fstatic-relocation-model.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fassembly%2Fstatic-relocation-model.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fassembly%2Fstatic-relocation-model.rs?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -1,10 +1,12 @@\n // min-llvm-version: 12.0.0\n-// needs-llvm-components: aarch64 x86 powerpc\n // revisions: x64 A64 ppc64le\n // assembly-output: emit-asm\n // [x64] compile-flags: --target x86_64-unknown-linux-gnu -Crelocation-model=static\n+// [x64] needs-llvm-components: x86\n // [A64] compile-flags: --target aarch64-unknown-linux-gnu -Crelocation-model=static\n+// [A64] needs-llvm-components: aarch64\n // [ppc64le] compile-flags: --target powerpc64le-unknown-linux-gnu -Crelocation-model=static\n+// [ppc64le] needs-llvm-components: powerpc\n \n #![feature(no_core, lang_items)]\n #![no_core]"}, {"sha": "b4fda5f8c8428d0c879382dbf0a6e616af8315f6", "filename": "src/test/codegen/abi-efiapi.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fcodegen%2Fabi-efiapi.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fcodegen%2Fabi-efiapi.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fabi-efiapi.rs?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -1,13 +1,16 @@\n // Checks if the correct annotation for the efiapi ABI is passed to llvm.\n \n // revisions:x86_64 i686 aarch64 arm riscv\n-// needs-llvm-components: aarch64 arm riscv\n-\n //[x86_64] compile-flags: --target x86_64-unknown-uefi\n+//[x86_64] needs-llvm-components: aarch64 arm riscv\n //[i686] compile-flags: --target i686-unknown-linux-musl\n+//[i686] needs-llvm-components: aarch64 arm riscv\n //[aarch64] compile-flags: --target aarch64-unknown-none\n+//[aarch64] needs-llvm-components: aarch64 arm riscv\n //[arm] compile-flags: --target armv7r-none-eabi\n+//[arm] needs-llvm-components: aarch64 arm riscv\n //[riscv] compile-flags: --target riscv64gc-unknown-none-elf\n+//[riscv] needs-llvm-components: aarch64 arm riscv\n // compile-flags: -C no-prepopulate-passes\n \n #![crate_type = \"lib\"]"}, {"sha": "135177016bf9a9e3fe50196920c6a082d5a0ffbd", "filename": "src/test/codegen/asm-sanitize-llvm.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fcodegen%2Fasm-sanitize-llvm.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fcodegen%2Fasm-sanitize-llvm.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fasm-sanitize-llvm.rs?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -1,5 +1,6 @@\n-// FIXME(nagisa): remove the flags here once all targets support `asm!`.\n+// FIXME(nagisa): remove the flags below once all targets support `asm!`.\n // compile-flags: --target x86_64-unknown-linux-gnu\n+// needs-llvm-components: x86\n \n // Verify we sanitize the special tokens for the LLVM inline-assembly, ensuring people won't\n // inadvertently rely on the LLVM-specific syntax and features."}, {"sha": "5d77d3f14bb12bd9066a362ec6acdbbdfab0f062", "filename": "src/test/codegen/default-requires-uwtable.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fcodegen%2Fdefault-requires-uwtable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fcodegen%2Fdefault-requires-uwtable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fdefault-requires-uwtable.rs?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -1,8 +1,9 @@\n // revisions: WINDOWS ANDROID\n-// needs-llvm-components: x86 arm\n // compile-flags: -C panic=abort\n // [WINDOWS] compile-flags: --target=x86_64-pc-windows-msvc\n+// [WINDOWS] needs-llvm-components: x86\n // [ANDROID] compile-flags: --target=armv7-linux-androideabi\n+// [ANDROID] needs-llvm-components: arm\n \n #![feature(no_core, lang_items)]\n #![crate_type = \"lib\"]"}, {"sha": "17258a264a5e60c668ea3166219346e4f06f91fe", "filename": "src/test/codegen/i686-macosx-deployment-target.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fcodegen%2Fi686-macosx-deployment-target.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fcodegen%2Fi686-macosx-deployment-target.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fi686-macosx-deployment-target.rs?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -3,6 +3,7 @@\n // See issue #60235.\n \n // compile-flags: -O --target=i686-apple-darwin --crate-type=rlib\n+// needs-llvm-components: x86\n // rustc-env:MACOSX_DEPLOYMENT_TARGET=10.9\n #![feature(no_core, lang_items)]\n #![no_core]"}, {"sha": "043040a95e364b89a3f9c421cd106e2120631d77", "filename": "src/test/codegen/i686-no-macosx-deployment-target.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fcodegen%2Fi686-no-macosx-deployment-target.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fcodegen%2Fi686-no-macosx-deployment-target.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fi686-no-macosx-deployment-target.rs?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -3,6 +3,7 @@\n // See issue #60235.\n \n // compile-flags: -O --target=i686-apple-darwin --crate-type=rlib\n+// needs-llvm-components: x86\n // unset-rustc-env:MACOSX_DEPLOYMENT_TARGET\n #![feature(no_core, lang_items)]\n #![no_core]"}, {"sha": "f228d7c55008487c583114f1e59e61b490b7bd8d", "filename": "src/test/codegen/sparc-struct-abi.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fcodegen%2Fsparc-struct-abi.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fcodegen%2Fsparc-struct-abi.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fsparc-struct-abi.rs?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -1,9 +1,8 @@\n-//\n // Checks that we correctly codegen extern \"C\" functions returning structs.\n // See issue #52638.\n \n-// only-sparc64\n // compile-flags: -O --target=sparc64-unknown-linux-gnu --crate-type=rlib\n+// needs-llvm-components: sparc\n #![feature(no_core, lang_items)]\n #![no_core]\n "}, {"sha": "8e673d11d98e941075e21ba79f97ce35de0cdf69", "filename": "src/test/codegen/x86_64-macosx-deployment-target.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fcodegen%2Fx86_64-macosx-deployment-target.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fcodegen%2Fx86_64-macosx-deployment-target.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fx86_64-macosx-deployment-target.rs?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -3,6 +3,7 @@\n // See issue #60235.\n \n // compile-flags: -O --target=x86_64-apple-darwin --crate-type=rlib\n+// needs-llvm-components: x86\n // rustc-env:MACOSX_DEPLOYMENT_TARGET=10.9\n #![feature(no_core, lang_items)]\n #![no_core]"}, {"sha": "25ae6924de03e191e8c77f9dec335cff0de95c43", "filename": "src/test/codegen/x86_64-no-macosx-deployment-target.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fcodegen%2Fx86_64-no-macosx-deployment-target.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fcodegen%2Fx86_64-no-macosx-deployment-target.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fx86_64-no-macosx-deployment-target.rs?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -3,6 +3,7 @@\n // See issue #60235.\n \n // compile-flags: -O --target=x86_64-apple-darwin --crate-type=rlib\n+// needs-llvm-components: x86\n // unset-rustc-env:MACOSX_DEPLOYMENT_TARGET\n #![feature(no_core, lang_items)]\n #![no_core]"}, {"sha": "bf6ea6b67f9bbfbc63b898c135fa0fd94f19e057", "filename": "src/test/ui/asm/inline-syntax.arm.stderr", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fui%2Fasm%2Finline-syntax.arm.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fui%2Fasm%2Finline-syntax.arm.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasm%2Finline-syntax.arm.stderr?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -13,7 +13,7 @@ LL | .intel_syntax noprefix\n    | ^\n \n error: unknown directive\n-  --> $DIR/inline-syntax.rs:29:15\n+  --> $DIR/inline-syntax.rs:31:15\n    |\n LL |         asm!(\".intel_syntax noprefix\", \"nop\");\n    |               ^\n@@ -25,7 +25,7 @@ LL |     .intel_syntax noprefix\n    |     ^\n \n error: unknown directive\n-  --> $DIR/inline-syntax.rs:32:15\n+  --> $DIR/inline-syntax.rs:34:15\n    |\n LL |         asm!(\".intel_syntax aaa noprefix\", \"nop\");\n    |               ^\n@@ -37,7 +37,7 @@ LL |     .intel_syntax aaa noprefix\n    |     ^\n \n error: unknown directive\n-  --> $DIR/inline-syntax.rs:35:15\n+  --> $DIR/inline-syntax.rs:37:15\n    |\n LL |         asm!(\".att_syntax noprefix\", \"nop\");\n    |               ^\n@@ -49,7 +49,7 @@ LL |     .att_syntax noprefix\n    |     ^\n \n error: unknown directive\n-  --> $DIR/inline-syntax.rs:38:15\n+  --> $DIR/inline-syntax.rs:40:15\n    |\n LL |         asm!(\".att_syntax bbb noprefix\", \"nop\");\n    |               ^\n@@ -61,7 +61,7 @@ LL |     .att_syntax bbb noprefix\n    |     ^\n \n error: unknown directive\n-  --> $DIR/inline-syntax.rs:41:15\n+  --> $DIR/inline-syntax.rs:43:15\n    |\n LL |         asm!(\".intel_syntax noprefix; nop\");\n    |               ^\n@@ -73,7 +73,7 @@ LL |     .intel_syntax noprefix; nop\n    |     ^\n \n error: unknown directive\n-  --> $DIR/inline-syntax.rs:47:13\n+  --> $DIR/inline-syntax.rs:49:13\n    |\n LL |             .intel_syntax noprefix\n    |             ^"}, {"sha": "481990398f4c6ac0a1ed00aed3bdec4735b24d52", "filename": "src/test/ui/asm/inline-syntax.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fui%2Fasm%2Finline-syntax.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fui%2Fasm%2Finline-syntax.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasm%2Finline-syntax.rs?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -1,11 +1,13 @@\n-// needs-llvm-components: arm\n // revisions: x86_64 arm\n //[x86_64] compile-flags: --target x86_64-unknown-linux-gnu\n //[x86_64] check-pass\n+//[x86_64] needs-llvm-components: x86\n //[x86_64_allowed] compile-flags: --target x86_64-unknown-linux-gnu\n //[x86_64_allowed] check-pass\n+//[x86_64_allowed] needs-llvm-components: x86\n //[arm] compile-flags: --target armv7-unknown-linux-gnueabihf\n //[arm] build-fail\n+//[arm] needs-llvm-components: arm\n \n #![feature(no_core, lang_items, rustc_attrs)]\n #![crate_type = \"rlib\"]"}, {"sha": "dcbc17bb26089380e71045b68fde32f27a55978b", "filename": "src/test/ui/asm/inline-syntax.x86_64.stderr", "status": "modified", "additions": 7, "deletions": 7, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fui%2Fasm%2Finline-syntax.x86_64.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fui%2Fasm%2Finline-syntax.x86_64.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasm%2Finline-syntax.x86_64.stderr?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -1,43 +1,43 @@\n warning: avoid using `.intel_syntax`, Intel syntax is the default\n-  --> $DIR/inline-syntax.rs:55:14\n+  --> $DIR/inline-syntax.rs:57:14\n    |\n LL | global_asm!(\".intel_syntax noprefix\", \"nop\");\n    |              ^^^^^^^^^^^^^^^^^^^^^^\n    |\n    = note: `#[warn(bad_asm_style)]` on by default\n \n warning: avoid using `.intel_syntax`, Intel syntax is the default\n-  --> $DIR/inline-syntax.rs:29:15\n+  --> $DIR/inline-syntax.rs:31:15\n    |\n LL |         asm!(\".intel_syntax noprefix\", \"nop\");\n    |               ^^^^^^^^^^^^^^^^^^^^^^\n \n warning: avoid using `.intel_syntax`, Intel syntax is the default\n-  --> $DIR/inline-syntax.rs:32:15\n+  --> $DIR/inline-syntax.rs:34:15\n    |\n LL |         asm!(\".intel_syntax aaa noprefix\", \"nop\");\n    |               ^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n warning: avoid using `.att_syntax`, prefer using `options(att_syntax)` instead\n-  --> $DIR/inline-syntax.rs:35:15\n+  --> $DIR/inline-syntax.rs:37:15\n    |\n LL |         asm!(\".att_syntax noprefix\", \"nop\");\n    |               ^^^^^^^^^^^^^^^^^^^^\n \n warning: avoid using `.att_syntax`, prefer using `options(att_syntax)` instead\n-  --> $DIR/inline-syntax.rs:38:15\n+  --> $DIR/inline-syntax.rs:40:15\n    |\n LL |         asm!(\".att_syntax bbb noprefix\", \"nop\");\n    |               ^^^^^^^^^^^^^^^^^^^^^^^^\n \n warning: avoid using `.intel_syntax`, Intel syntax is the default\n-  --> $DIR/inline-syntax.rs:41:15\n+  --> $DIR/inline-syntax.rs:43:15\n    |\n LL |         asm!(\".intel_syntax noprefix; nop\");\n    |               ^^^^^^^^^^^^^^^^^^^^^^\n \n warning: avoid using `.intel_syntax`, Intel syntax is the default\n-  --> $DIR/inline-syntax.rs:47:13\n+  --> $DIR/inline-syntax.rs:49:13\n    |\n LL |             .intel_syntax noprefix\n    |             ^^^^^^^^^^^^^^^^^^^^^^"}, {"sha": "50248a55838f2a5e993b121daa4702a34fc58c44", "filename": "src/test/ui/borrowck/two-phase-reservation-sharing-interference.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fui%2Fborrowck%2Ftwo-phase-reservation-sharing-interference.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fui%2Fborrowck%2Ftwo-phase-reservation-sharing-interference.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fborrowck%2Ftwo-phase-reservation-sharing-interference.rs?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -1,8 +1,8 @@\n // revisions: nll_target\n \n-// The following revisions are disabled due to missing support from two-phase beyond autorefs\n+// The nll_beyond revision is disabled due to missing support from two-phase beyond autorefs\n //[nll_beyond]compile-flags: -Z borrowck=mir -Z two-phase-beyond-autoref\n-//[nll_beyond] should-fail\n+//[nll_beyond]should-fail\n \n //[nll_target]compile-flags: -Z borrowck=mir\n "}, {"sha": "9e4521df8c34f4d84c065af641cf79abad1f29e8", "filename": "src/test/ui/cmse-nonsecure/cmse-nonsecure-call/params-on-registers.rs", "status": "modified", "additions": 12, "deletions": 4, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fui%2Fcmse-nonsecure%2Fcmse-nonsecure-call%2Fparams-on-registers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fui%2Fcmse-nonsecure%2Fcmse-nonsecure-call%2Fparams-on-registers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcmse-nonsecure%2Fcmse-nonsecure-call%2Fparams-on-registers.rs?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -1,13 +1,21 @@\n // build-pass\n // compile-flags: --target thumbv8m.main-none-eabi --crate-type lib\n-// only-thumbv8m.main-none-eabi\n-#![feature(abi_c_cmse_nonsecure_call)]\n-#![no_std]\n+// needs-llvm-components: arm\n+#![feature(abi_c_cmse_nonsecure_call, no_core, lang_items, intrinsics)]\n+#![no_core]\n+#[lang=\"sized\"]\n+pub trait Sized { }\n+#[lang=\"copy\"]\n+pub trait Copy { }\n+\n+extern \"rust-intrinsic\" {\n+    pub fn transmute<T, U>(e: T) -> U;\n+}\n \n #[no_mangle]\n pub fn test(a: u32, b: u32, c: u32, d: u32) -> u32 {\n     let non_secure_function = unsafe {\n-        core::mem::transmute::<usize, extern \"C-cmse-nonsecure-call\" fn(u32, u32, u32, u32) -> u32>(\n+        transmute::<usize, extern \"C-cmse-nonsecure-call\" fn(u32, u32, u32, u32) -> u32>(\n             0x10000004,\n         )\n     };"}, {"sha": "9697146d5c3d83623b7d2390bf07de83f65bb447", "filename": "src/test/ui/cmse-nonsecure/cmse-nonsecure-call/params-on-stack.rs", "status": "modified", "additions": 14, "deletions": 4, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fui%2Fcmse-nonsecure%2Fcmse-nonsecure-call%2Fparams-on-stack.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fui%2Fcmse-nonsecure%2Fcmse-nonsecure-call%2Fparams-on-stack.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcmse-nonsecure%2Fcmse-nonsecure-call%2Fparams-on-stack.rs?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -1,12 +1,22 @@\n+// build-fail\n // compile-flags: --target thumbv8m.main-none-eabi --crate-type lib\n-// only-thumbv8m.main-none-eabi\n-#![feature(abi_c_cmse_nonsecure_call)]\n-#![no_std]\n+// needs-llvm-components: arm\n+// min-llvm-version: 11.0\n+#![feature(abi_c_cmse_nonsecure_call, no_core, lang_items, intrinsics)]\n+#![no_core]\n+#[lang=\"sized\"]\n+pub trait Sized { }\n+#[lang=\"copy\"]\n+pub trait Copy { }\n+\n+extern \"rust-intrinsic\" {\n+    pub fn transmute<T, U>(e: T) -> U;\n+}\n \n #[no_mangle]\n pub fn test(a: u32, b: u32, c: u32, d: u32, e: u32) -> u32 {\n     let non_secure_function = unsafe {\n-        core::mem::transmute::<\n+        transmute::<\n             usize,\n             extern \"C-cmse-nonsecure-call\" fn(u32, u32, u32, u32, u32) -> u32>\n         ("}, {"sha": "f32b3709002e6c2db959b33f3b7b5e16381744f4", "filename": "src/test/ui/cmse-nonsecure/cmse-nonsecure-call/wrong-abi-location-1.rs", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fui%2Fcmse-nonsecure%2Fcmse-nonsecure-call%2Fwrong-abi-location-1.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fui%2Fcmse-nonsecure%2Fcmse-nonsecure-call%2Fwrong-abi-location-1.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcmse-nonsecure%2Fcmse-nonsecure-call%2Fwrong-abi-location-1.rs?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -1,6 +1,8 @@\n // compile-flags: --target thumbv8m.main-none-eabi --crate-type lib\n-// only-thumbv8m.main-none-eabi\n-#![feature(abi_c_cmse_nonsecure_call)]\n-#![no_std]\n+// needs-llvm-components: arm\n+#![feature(abi_c_cmse_nonsecure_call, lang_items, no_core)]\n+#![no_core]\n+#[lang=\"sized\"]\n+trait Sized { }\n \n pub extern \"C-cmse-nonsecure-call\" fn test() {} //~ ERROR [E0781]"}, {"sha": "3564ab4b6cd4dd76241a6de8bac0f96d8d5516fe", "filename": "src/test/ui/cmse-nonsecure/cmse-nonsecure-call/wrong-abi-location-1.stderr", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fui%2Fcmse-nonsecure%2Fcmse-nonsecure-call%2Fwrong-abi-location-1.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fui%2Fcmse-nonsecure%2Fcmse-nonsecure-call%2Fwrong-abi-location-1.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcmse-nonsecure%2Fcmse-nonsecure-call%2Fwrong-abi-location-1.stderr?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -1,8 +1,8 @@\n-error[E0781]: the `\"cmse-nonsecure-call\"` ABI is only allowed on function pointers.\n-  --> $DIR/wrong-abi-location-1.rs:6:1\n+error[E0781]: the `\"C-cmse-nonsecure-call\"` ABI is only allowed on function pointers.\n+  --> $DIR/wrong-abi-location-1.rs:8:1\n    |\n-LL | pub extern \"C-cmse-nonsecure-call\" fn test() {} //~ ERROR [E0781]\n-   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+LL | pub extern \"C-cmse-nonsecure-call\" fn test() {}\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n error: aborting due to previous error\n "}, {"sha": "6f8bb24aa69e84f120992167cb011b87e052fc0c", "filename": "src/test/ui/cmse-nonsecure/cmse-nonsecure-call/wrong-abi-location-2.rs", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fui%2Fcmse-nonsecure%2Fcmse-nonsecure-call%2Fwrong-abi-location-2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fui%2Fcmse-nonsecure%2Fcmse-nonsecure-call%2Fwrong-abi-location-2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcmse-nonsecure%2Fcmse-nonsecure-call%2Fwrong-abi-location-2.rs?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -1,7 +1,9 @@\n // compile-flags: --target thumbv8m.main-none-eabi --crate-type lib\n-// only-thumbv8m.main-none-eabi\n-#![feature(abi_c_cmse_nonsecure_call)]\n-#![no_std]\n+// needs-llvm-components: arm\n+#![feature(abi_c_cmse_nonsecure_call, lang_items, no_core)]\n+#![no_core]\n+#[lang=\"sized\"]\n+trait Sized { }\n \n extern \"C-cmse-nonsecure-call\" { //~ ERROR [E0781]\n     fn test();"}, {"sha": "76073f548848a70bfaa1a47ab9c8ecefffbf7bff", "filename": "src/test/ui/cmse-nonsecure/cmse-nonsecure-call/wrong-abi-location-2.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fui%2Fcmse-nonsecure%2Fcmse-nonsecure-call%2Fwrong-abi-location-2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fui%2Fcmse-nonsecure%2Fcmse-nonsecure-call%2Fwrong-abi-location-2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcmse-nonsecure%2Fcmse-nonsecure-call%2Fwrong-abi-location-2.stderr?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -1,8 +1,8 @@\n error[E0781]: the `\"C-cmse-nonsecure-call\"` ABI is only allowed on function pointers.\n-  --> $DIR/wrong-abi-location-2.rs:6:1\n+  --> $DIR/wrong-abi-location-2.rs:8:1\n    |\n LL | / extern \"C-cmse-nonsecure-call\" {\n-LL | |     fn test(); //~ ERROR [E0781]\n+LL | |     fn test();\n LL | | }\n    | |_^\n "}, {"sha": "8cde9ba58b93b0a3e24c228cc01186d5074bd935", "filename": "src/test/ui/cmse-nonsecure/cmse-nonsecure-entry/params-on-registers.rs", "status": "modified", "additions": 9, "deletions": 5, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fui%2Fcmse-nonsecure%2Fcmse-nonsecure-entry%2Fparams-on-registers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fui%2Fcmse-nonsecure%2Fcmse-nonsecure-entry%2Fparams-on-registers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcmse-nonsecure%2Fcmse-nonsecure-entry%2Fparams-on-registers.rs?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -1,11 +1,15 @@\n // build-pass\n // compile-flags: --target thumbv8m.main-none-eabi --crate-type lib\n-// only-thumbv8m.main-none-eabi\n-#![feature(cmse_nonsecure_entry)]\n-#![no_std]\n+// needs-llvm-components: arm\n+#![feature(cmse_nonsecure_entry, no_core, lang_items)]\n+#![no_core]\n+#[lang=\"sized\"]\n+trait Sized { }\n+#[lang=\"copy\"]\n+trait Copy { }\n \n #[no_mangle]\n #[cmse_nonsecure_entry]\n-pub extern \"C\" fn entry_function(a: u32, b: u32, c: u32, d: u32) -> u32 {\n-    a + b + c + d\n+pub extern \"C\" fn entry_function(_: u32, _: u32, _: u32, d: u32) -> u32 {\n+    d\n }"}, {"sha": "74321fdfdde907b5694b04a5ea928f0a004dc587", "filename": "src/test/ui/cmse-nonsecure/cmse-nonsecure-entry/params-on-stack.rs", "status": "modified", "additions": 11, "deletions": 5, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fui%2Fcmse-nonsecure%2Fcmse-nonsecure-entry%2Fparams-on-stack.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fui%2Fcmse-nonsecure%2Fcmse-nonsecure-entry%2Fparams-on-stack.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcmse-nonsecure%2Fcmse-nonsecure-entry%2Fparams-on-stack.rs?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -1,10 +1,16 @@\n+// build-fail\n // compile-flags: --target thumbv8m.main-none-eabi --crate-type lib\n-// only-thumbv8m.main-none-eabi\n-#![feature(cmse_nonsecure_entry)]\n-#![no_std]\n+// needs-llvm-components: arm\n+// min-llvm-version: 11.0\n+#![feature(cmse_nonsecure_entry, no_core, lang_items)]\n+#![no_core]\n+#[lang=\"sized\"]\n+trait Sized { }\n+#[lang=\"copy\"]\n+trait Copy { }\n \n #[no_mangle]\n #[cmse_nonsecure_entry]\n-pub extern \"C\" fn entry_function(a: u32, b: u32, c: u32, d: u32, e: u32) -> u32 { //~ ERROR\n-    a + b + c + d + e\n+pub extern \"C\" fn entry_function(_: u32, _: u32, _: u32, _: u32, e: u32) -> u32 {\n+    e\n }"}, {"sha": "6320d296373c09236a8328d2069c4639fae4cf98", "filename": "src/test/ui/cmse-nonsecure/cmse-nonsecure-entry/wrong-abi.rs", "status": "modified", "additions": 8, "deletions": 5, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fui%2Fcmse-nonsecure%2Fcmse-nonsecure-entry%2Fwrong-abi.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fui%2Fcmse-nonsecure%2Fcmse-nonsecure-entry%2Fwrong-abi.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcmse-nonsecure%2Fcmse-nonsecure-entry%2Fwrong-abi.rs?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -1,10 +1,13 @@\n // compile-flags: --target thumbv8m.main-none-eabi --crate-type lib\n-// only-thumbv8m.main-none-eabi\n-#![feature(cmse_nonsecure_entry)]\n-#![no_std]\n+// needs-llvm-components: arm\n+#![feature(cmse_nonsecure_entry, no_core, lang_items)]\n+#![no_core]\n+#[lang=\"sized\"]\n+trait Sized { }\n \n #[no_mangle]\n #[cmse_nonsecure_entry]\n-pub fn entry_function(a: u32, b: u32, c: u32, d: u32) -> u32 { //~ ERROR [E0776]\n-    a + b + c + d\n+//~^ ERROR `#[cmse_nonsecure_entry]` requires C ABI [E0776]\n+pub fn entry_function(_: u32, _: u32, _: u32, d: u32) -> u32 {\n+    d\n }"}, {"sha": "36d76c9674adff6754947d238740eb24fc3554bc", "filename": "src/test/ui/cmse-nonsecure/cmse-nonsecure-entry/wrong-abi.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fui%2Fcmse-nonsecure%2Fcmse-nonsecure-entry%2Fwrong-abi.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fui%2Fcmse-nonsecure%2Fcmse-nonsecure-entry%2Fwrong-abi.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcmse-nonsecure%2Fcmse-nonsecure-entry%2Fwrong-abi.stderr?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -1,5 +1,5 @@\n-error[E0776]: `#[cmse_nonsecure_entry]` functions require C ABI\n-  --> $DIR/wrong-abi.rs:7:1\n+error[E0776]: `#[cmse_nonsecure_entry]` requires C ABI\n+  --> $DIR/wrong-abi.rs:9:1\n    |\n LL | #[cmse_nonsecure_entry]\n    | ^^^^^^^^^^^^^^^^^^^^^^^"}, {"sha": "de4ccc185608c82ebadf5dbdd65a099ece02130a", "filename": "src/test/ui/crate-loading/missing-std.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fui%2Fcrate-loading%2Fmissing-std.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fui%2Fcrate-loading%2Fmissing-std.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcrate-loading%2Fmissing-std.rs?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -1,4 +1,5 @@\n // compile-flags: --target x86_64-unknown-uefi\n+// needs-llvm-components: x86\n // rustc-env:CARGO=/usr/bin/cargo\n // rustc-env:RUSTUP_HOME=/home/bors/.rustup\n #![no_core]"}, {"sha": "e61486fdc6ffd22069596fdb3f80b9b45293b904", "filename": "src/test/ui/crate-loading/missing-std.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fui%2Fcrate-loading%2Fmissing-std.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fui%2Fcrate-loading%2Fmissing-std.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcrate-loading%2Fmissing-std.stderr?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -1,5 +1,5 @@\n error[E0463]: can't find crate for `core`\n-  --> $DIR/missing-std.rs:5:1\n+  --> $DIR/missing-std.rs:6:1\n    |\n LL | extern crate core;\n    | ^^^^^^^^^^^^^^^^^^ can't find crate"}, {"sha": "7a6b9eda3fa123a40675c5a620231ac6eca89abb", "filename": "src/test/ui/sanitize/crt-static.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fui%2Fsanitize%2Fcrt-static.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fui%2Fsanitize%2Fcrt-static.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsanitize%2Fcrt-static.rs?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -1,4 +1,5 @@\n // compile-flags: -Z sanitizer=address -C target-feature=+crt-static --target x86_64-unknown-linux-gnu\n+// needs-llvm-components: x86\n \n #![feature(no_core)]\n #![no_core]"}, {"sha": "bcafc2891fda82893e86abbde549049db8e5c75d", "filename": "src/test/ui/sanitize/incompatible.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fui%2Fsanitize%2Fincompatible.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fui%2Fsanitize%2Fincompatible.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsanitize%2Fincompatible.rs?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -1,4 +1,5 @@\n // compile-flags: -Z sanitizer=address -Z sanitizer=memory --target x86_64-unknown-linux-gnu\n+// needs-llvm-components: x86\n // error-pattern: error: `-Zsanitizer=address` is incompatible with `-Zsanitizer=memory`\n \n #![feature(no_core)]"}, {"sha": "9f29c76353bac9da0537ae523a9f837443d4853b", "filename": "src/test/ui/sanitize/unsupported-target.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fui%2Fsanitize%2Funsupported-target.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftest%2Fui%2Fsanitize%2Funsupported-target.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsanitize%2Funsupported-target.rs?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -1,4 +1,5 @@\n // compile-flags: -Z sanitizer=leak --target i686-unknown-linux-gnu\n+// needs-llvm-components: x86\n // error-pattern: error: leak sanitizer is not supported for this target\n #![feature(no_core)]\n #![no_core]"}, {"sha": "764f20552773a2500373f95ae1cfa68ab72b416c", "filename": "src/tools/compiletest/src/header.rs", "status": "modified", "additions": 213, "deletions": 249, "changes": 462, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftools%2Fcompiletest%2Fsrc%2Fheader.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftools%2Fcompiletest%2Fsrc%2Fheader.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fheader.rs?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -27,260 +27,29 @@ enum ParsedNameDirective {\n /// the test.\n #[derive(Default)]\n pub struct EarlyProps {\n-    pub ignore: bool,\n-    pub should_fail: bool,\n     pub aux: Vec<String>,\n     pub aux_crate: Vec<(String, String)>,\n     pub revisions: Vec<String>,\n }\n \n impl EarlyProps {\n     pub fn from_file(config: &Config, testfile: &Path) -> Self {\n-        let file = File::open(testfile).unwrap();\n+        let file = File::open(testfile).expect(\"open test file to parse earlyprops\");\n         Self::from_reader(config, testfile, file)\n     }\n \n     pub fn from_reader<R: Read>(config: &Config, testfile: &Path, rdr: R) -> Self {\n         let mut props = EarlyProps::default();\n-        let rustc_has_profiler_support = env::var_os(\"RUSTC_PROFILER_SUPPORT\").is_some();\n-        let rustc_has_sanitizer_support = env::var_os(\"RUSTC_SANITIZER_SUPPORT\").is_some();\n-        let has_asm_support = util::has_asm_support(&config.target);\n-        let has_asan = util::ASAN_SUPPORTED_TARGETS.contains(&&*config.target);\n-        let has_lsan = util::LSAN_SUPPORTED_TARGETS.contains(&&*config.target);\n-        let has_msan = util::MSAN_SUPPORTED_TARGETS.contains(&&*config.target);\n-        let has_tsan = util::TSAN_SUPPORTED_TARGETS.contains(&&*config.target);\n-        let has_hwasan = util::HWASAN_SUPPORTED_TARGETS.contains(&&*config.target);\n-        // for `-Z gcc-ld=lld`\n-        let has_rust_lld = config\n-            .compile_lib_path\n-            .join(\"rustlib\")\n-            .join(&config.target)\n-            .join(\"bin\")\n-            .join(\"gcc-ld\")\n-            .join(if config.host.contains(\"windows\") { \"ld.exe\" } else { \"ld\" })\n-            .exists();\n-\n-        iter_header(testfile, None, rdr, &mut |ln| {\n-            // we should check if any only-<platform> exists and if it exists\n-            // and does not matches the current platform, skip the test\n-            if !props.ignore {\n-                props.ignore = match config.parse_cfg_name_directive(ln, \"ignore\") {\n-                    ParsedNameDirective::Match => true,\n-                    ParsedNameDirective::NoMatch => props.ignore,\n-                };\n-\n-                if config.has_cfg_prefix(ln, \"only\") {\n-                    props.ignore = match config.parse_cfg_name_directive(ln, \"only\") {\n-                        ParsedNameDirective::Match => props.ignore,\n-                        ParsedNameDirective::NoMatch => true,\n-                    };\n-                }\n-\n-                if ignore_llvm(config, ln) {\n-                    props.ignore = true;\n-                }\n-\n-                if config.run_clang_based_tests_with.is_none()\n-                    && config.parse_needs_matching_clang(ln)\n-                {\n-                    props.ignore = true;\n-                }\n-\n-                if !has_asm_support && config.parse_name_directive(ln, \"needs-asm-support\") {\n-                    props.ignore = true;\n-                }\n-\n-                if !rustc_has_profiler_support && config.parse_needs_profiler_support(ln) {\n-                    props.ignore = true;\n-                }\n-\n-                if !config.run_enabled() && config.parse_name_directive(ln, \"needs-run-enabled\") {\n-                    props.ignore = true;\n-                }\n-\n-                if !rustc_has_sanitizer_support\n-                    && config.parse_name_directive(ln, \"needs-sanitizer-support\")\n-                {\n-                    props.ignore = true;\n-                }\n-\n-                if !has_asan && config.parse_name_directive(ln, \"needs-sanitizer-address\") {\n-                    props.ignore = true;\n-                }\n-\n-                if !has_lsan && config.parse_name_directive(ln, \"needs-sanitizer-leak\") {\n-                    props.ignore = true;\n-                }\n-\n-                if !has_msan && config.parse_name_directive(ln, \"needs-sanitizer-memory\") {\n-                    props.ignore = true;\n-                }\n-\n-                if !has_tsan && config.parse_name_directive(ln, \"needs-sanitizer-thread\") {\n-                    props.ignore = true;\n-                }\n-\n-                if !has_hwasan && config.parse_name_directive(ln, \"needs-sanitizer-hwaddress\") {\n-                    props.ignore = true;\n-                }\n-\n-                if config.target_panic == PanicStrategy::Abort\n-                    && config.parse_name_directive(ln, \"needs-unwind\")\n-                {\n-                    props.ignore = true;\n-                }\n-\n-                if config.target == \"wasm32-unknown-unknown\" && config.parse_check_run_results(ln) {\n-                    props.ignore = true;\n-                }\n-\n-                if config.debugger == Some(Debugger::Cdb) && ignore_cdb(config, ln) {\n-                    props.ignore = true;\n-                }\n-\n-                if config.debugger == Some(Debugger::Gdb) && ignore_gdb(config, ln) {\n-                    props.ignore = true;\n-                }\n-\n-                if config.debugger == Some(Debugger::Lldb) && ignore_lldb(config, ln) {\n-                    props.ignore = true;\n-                }\n-\n-                if !has_rust_lld && config.parse_name_directive(ln, \"needs-rust-lld\") {\n-                    props.ignore = true;\n-                }\n-            }\n-\n+        iter_header(testfile, rdr, &mut |_, ln| {\n             if let Some(s) = config.parse_aux_build(ln) {\n                 props.aux.push(s);\n             }\n-\n             if let Some(ac) = config.parse_aux_crate(ln) {\n                 props.aux_crate.push(ac);\n             }\n-\n             config.parse_and_update_revisions(ln, &mut props.revisions);\n-\n-            props.should_fail = props.should_fail || config.parse_name_directive(ln, \"should-fail\");\n         });\n-\n         return props;\n-\n-        fn ignore_cdb(config: &Config, line: &str) -> bool {\n-            if let Some(actual_version) = config.cdb_version {\n-                if let Some(min_version) = line.strip_prefix(\"min-cdb-version:\").map(str::trim) {\n-                    let min_version = extract_cdb_version(min_version).unwrap_or_else(|| {\n-                        panic!(\"couldn't parse version range: {:?}\", min_version);\n-                    });\n-\n-                    // Ignore if actual version is smaller than the minimum\n-                    // required version\n-                    return actual_version < min_version;\n-                }\n-            }\n-            false\n-        }\n-\n-        fn ignore_gdb(config: &Config, line: &str) -> bool {\n-            if let Some(actual_version) = config.gdb_version {\n-                if let Some(rest) = line.strip_prefix(\"min-gdb-version:\").map(str::trim) {\n-                    let (start_ver, end_ver) = extract_version_range(rest, extract_gdb_version)\n-                        .unwrap_or_else(|| {\n-                            panic!(\"couldn't parse version range: {:?}\", rest);\n-                        });\n-\n-                    if start_ver != end_ver {\n-                        panic!(\"Expected single GDB version\")\n-                    }\n-                    // Ignore if actual version is smaller than the minimum\n-                    // required version\n-                    return actual_version < start_ver;\n-                } else if let Some(rest) = line.strip_prefix(\"ignore-gdb-version:\").map(str::trim) {\n-                    let (min_version, max_version) =\n-                        extract_version_range(rest, extract_gdb_version).unwrap_or_else(|| {\n-                            panic!(\"couldn't parse version range: {:?}\", rest);\n-                        });\n-\n-                    if max_version < min_version {\n-                        panic!(\"Malformed GDB version range: max < min\")\n-                    }\n-\n-                    return actual_version >= min_version && actual_version <= max_version;\n-                }\n-            }\n-            false\n-        }\n-\n-        fn ignore_lldb(config: &Config, line: &str) -> bool {\n-            if let Some(actual_version) = config.lldb_version {\n-                if let Some(min_version) = line.strip_prefix(\"min-lldb-version:\").map(str::trim) {\n-                    let min_version = min_version.parse().unwrap_or_else(|e| {\n-                        panic!(\n-                            \"Unexpected format of LLDB version string: {}\\n{:?}\",\n-                            min_version, e\n-                        );\n-                    });\n-                    // Ignore if actual version is smaller the minimum required\n-                    // version\n-                    actual_version < min_version\n-                } else {\n-                    line.starts_with(\"rust-lldb\") && !config.lldb_native_rust\n-                }\n-            } else {\n-                false\n-            }\n-        }\n-\n-        fn ignore_llvm(config: &Config, line: &str) -> bool {\n-            if config.system_llvm && line.starts_with(\"no-system-llvm\") {\n-                return true;\n-            }\n-            if let Some(needed_components) =\n-                config.parse_name_value_directive(line, \"needs-llvm-components\")\n-            {\n-                let components: HashSet<_> = config.llvm_components.split_whitespace().collect();\n-                if let Some(missing_component) = needed_components\n-                    .split_whitespace()\n-                    .find(|needed_component| !components.contains(needed_component))\n-                {\n-                    if env::var_os(\"COMPILETEST_NEEDS_ALL_LLVM_COMPONENTS\").is_some() {\n-                        panic!(\"missing LLVM component: {}\", missing_component);\n-                    }\n-                    return true;\n-                }\n-            }\n-            if let Some(actual_version) = config.llvm_version {\n-                if let Some(rest) = line.strip_prefix(\"min-llvm-version:\").map(str::trim) {\n-                    let min_version = extract_llvm_version(rest).unwrap();\n-                    // Ignore if actual version is smaller the minimum required\n-                    // version\n-                    actual_version < min_version\n-                } else if let Some(rest) =\n-                    line.strip_prefix(\"min-system-llvm-version:\").map(str::trim)\n-                {\n-                    let min_version = extract_llvm_version(rest).unwrap();\n-                    // Ignore if using system LLVM and actual version\n-                    // is smaller the minimum required version\n-                    config.system_llvm && actual_version < min_version\n-                } else if let Some(rest) = line.strip_prefix(\"ignore-llvm-version:\").map(str::trim)\n-                {\n-                    // Syntax is: \"ignore-llvm-version: <version1> [- <version2>]\"\n-                    let (v_min, v_max) = extract_version_range(rest, extract_llvm_version)\n-                        .unwrap_or_else(|| {\n-                            panic!(\"couldn't parse version range: {:?}\", rest);\n-                        });\n-                    if v_max < v_min {\n-                        panic!(\"Malformed LLVM version range: max < min\")\n-                    }\n-                    // Ignore if version lies inside of range.\n-                    actual_version >= v_min && actual_version <= v_max\n-                } else {\n-                    false\n-                }\n-            } else {\n-                false\n-            }\n-        }\n     }\n }\n \n@@ -440,7 +209,11 @@ impl TestProps {\n         if !testfile.is_dir() {\n             let file = File::open(testfile).unwrap();\n \n-            iter_header(testfile, cfg, file, &mut |ln| {\n+            iter_header(testfile, file, &mut |revision, ln| {\n+                if revision.is_some() && revision != cfg {\n+                    return;\n+                }\n+\n                 if let Some(ep) = config.parse_error_pattern(ln) {\n                     self.error_patterns.push(ep);\n                 }\n@@ -672,12 +445,12 @@ impl TestProps {\n     }\n }\n \n-fn iter_header<R: Read>(testfile: &Path, cfg: Option<&str>, rdr: R, it: &mut dyn FnMut(&str)) {\n+fn iter_header<R: Read>(testfile: &Path, rdr: R, it: &mut dyn FnMut(Option<&str>, &str)) {\n     if testfile.is_dir() {\n         return;\n     }\n \n-    let comment = if testfile.to_string_lossy().ends_with(\".rs\") { \"//\" } else { \"#\" };\n+    let comment = if testfile.extension().map(|e| e == \"rs\") == Some(true) { \"//\" } else { \"#\" };\n \n     let mut rdr = BufReader::new(rdr);\n     let mut ln = String::new();\n@@ -699,18 +472,12 @@ fn iter_header<R: Read>(testfile: &Path, cfg: Option<&str>, rdr: R, it: &mut dyn\n             if let Some(close_brace) = ln.find(']') {\n                 let open_brace = ln.find('[').unwrap();\n                 let lncfg = &ln[open_brace + 1..close_brace];\n-                let matches = match cfg {\n-                    Some(s) => s == &lncfg[..],\n-                    None => false,\n-                };\n-                if matches {\n-                    it(ln[(close_brace + 1)..].trim_start());\n-                }\n+                it(Some(lncfg), ln[(close_brace + 1)..].trim_start());\n             } else {\n                 panic!(\"malformed condition directive: expected `{}[foo]`, found `{}`\", comment, ln)\n             }\n         } else if ln.starts_with(comment) {\n-            it(ln[comment.len()..].trim_start());\n+            it(None, ln[comment.len()..].trim_start());\n         }\n     }\n }\n@@ -1026,11 +793,12 @@ pub fn extract_llvm_version(version: &str) -> Option<u32> {\n     Some(version)\n }\n \n-// Takes a directive of the form \"<version1> [- <version2>]\",\n-// returns the numeric representation of <version1> and <version2> as\n-// tuple: (<version1> as u32, <version2> as u32)\n-// If the <version2> part is omitted, the second component of the tuple\n-// is the same as <version1>.\n+/// Takes a directive of the form \"<version1> [- <version2>]\",\n+/// returns the numeric representation of <version1> and <version2> as\n+/// tuple: (<version1> as u32, <version2> as u32)\n+///\n+/// If the <version2> part is omitted, the second component of the tuple\n+/// is the same as <version1>.\n fn extract_version_range<F>(line: &str, parse: F) -> Option<(u32, u32)>\n where\n     F: Fn(&str) -> Option<u32>,\n@@ -1056,3 +824,199 @@ where\n \n     Some((min, max))\n }\n+\n+pub fn make_test_description<R: Read>(\n+    config: &Config,\n+    name: test::TestName,\n+    path: &Path,\n+    src: R,\n+    cfg: Option<&str>,\n+) -> test::TestDesc {\n+    let mut ignore = false;\n+    let mut should_fail = false;\n+\n+    let rustc_has_profiler_support = env::var_os(\"RUSTC_PROFILER_SUPPORT\").is_some();\n+    let rustc_has_sanitizer_support = env::var_os(\"RUSTC_SANITIZER_SUPPORT\").is_some();\n+    let has_asm_support = util::has_asm_support(&config.target);\n+    let has_asan = util::ASAN_SUPPORTED_TARGETS.contains(&&*config.target);\n+    let has_lsan = util::LSAN_SUPPORTED_TARGETS.contains(&&*config.target);\n+    let has_msan = util::MSAN_SUPPORTED_TARGETS.contains(&&*config.target);\n+    let has_tsan = util::TSAN_SUPPORTED_TARGETS.contains(&&*config.target);\n+    let has_hwasan = util::HWASAN_SUPPORTED_TARGETS.contains(&&*config.target);\n+    // for `-Z gcc-ld=lld`\n+    let has_rust_lld = config\n+        .compile_lib_path\n+        .join(\"rustlib\")\n+        .join(&config.target)\n+        .join(\"bin\")\n+        .join(\"gcc-ld\")\n+        .join(if config.host.contains(\"windows\") { \"ld.exe\" } else { \"ld\" })\n+        .exists();\n+    iter_header(path, src, &mut |revision, ln| {\n+        if revision.is_some() && revision != cfg {\n+            return;\n+        }\n+        ignore = match config.parse_cfg_name_directive(ln, \"ignore\") {\n+            ParsedNameDirective::Match => true,\n+            ParsedNameDirective::NoMatch => ignore,\n+        };\n+        if config.has_cfg_prefix(ln, \"only\") {\n+            ignore = match config.parse_cfg_name_directive(ln, \"only\") {\n+                ParsedNameDirective::Match => ignore,\n+                ParsedNameDirective::NoMatch => true,\n+            };\n+        }\n+        ignore |= ignore_llvm(config, ln);\n+        ignore |=\n+            config.run_clang_based_tests_with.is_none() && config.parse_needs_matching_clang(ln);\n+        ignore |= !has_asm_support && config.parse_name_directive(ln, \"needs-asm-support\");\n+        ignore |= !rustc_has_profiler_support && config.parse_needs_profiler_support(ln);\n+        ignore |= !config.run_enabled() && config.parse_name_directive(ln, \"needs-run-enabled\");\n+        ignore |= !rustc_has_sanitizer_support\n+            && config.parse_name_directive(ln, \"needs-sanitizer-support\");\n+        ignore |= !has_asan && config.parse_name_directive(ln, \"needs-sanitizer-address\");\n+        ignore |= !has_lsan && config.parse_name_directive(ln, \"needs-sanitizer-leak\");\n+        ignore |= !has_msan && config.parse_name_directive(ln, \"needs-sanitizer-memory\");\n+        ignore |= !has_tsan && config.parse_name_directive(ln, \"needs-sanitizer-thread\");\n+        ignore |= !has_hwasan && config.parse_name_directive(ln, \"needs-sanitizer-hwaddress\");\n+        ignore |= config.target_panic == PanicStrategy::Abort\n+            && config.parse_name_directive(ln, \"needs-unwind\");\n+        ignore |= config.target == \"wasm32-unknown-unknown\" && config.parse_check_run_results(ln);\n+        ignore |= config.debugger == Some(Debugger::Cdb) && ignore_cdb(config, ln);\n+        ignore |= config.debugger == Some(Debugger::Gdb) && ignore_gdb(config, ln);\n+        ignore |= config.debugger == Some(Debugger::Lldb) && ignore_lldb(config, ln);\n+        ignore |= !has_rust_lld && config.parse_name_directive(ln, \"needs-rust-lld\");\n+        should_fail |= config.parse_name_directive(ln, \"should-fail\");\n+    });\n+\n+    // The `should-fail` annotation doesn't apply to pretty tests,\n+    // since we run the pretty printer across all tests by default.\n+    // If desired, we could add a `should-fail-pretty` annotation.\n+    let should_panic = match config.mode {\n+        crate::common::Pretty => test::ShouldPanic::No,\n+        _ if should_fail => test::ShouldPanic::Yes,\n+        _ => test::ShouldPanic::No,\n+    };\n+\n+    test::TestDesc {\n+        name,\n+        ignore,\n+        should_panic,\n+        allow_fail: false,\n+        #[cfg(not(bootstrap))]\n+        compile_fail: false,\n+        #[cfg(not(bootstrap))]\n+        no_run: false,\n+        test_type: test::TestType::Unknown,\n+    }\n+}\n+\n+fn ignore_cdb(config: &Config, line: &str) -> bool {\n+    if let Some(actual_version) = config.cdb_version {\n+        if let Some(min_version) = line.strip_prefix(\"min-cdb-version:\").map(str::trim) {\n+            let min_version = extract_cdb_version(min_version).unwrap_or_else(|| {\n+                panic!(\"couldn't parse version range: {:?}\", min_version);\n+            });\n+\n+            // Ignore if actual version is smaller than the minimum\n+            // required version\n+            return actual_version < min_version;\n+        }\n+    }\n+    false\n+}\n+\n+fn ignore_gdb(config: &Config, line: &str) -> bool {\n+    if let Some(actual_version) = config.gdb_version {\n+        if let Some(rest) = line.strip_prefix(\"min-gdb-version:\").map(str::trim) {\n+            let (start_ver, end_ver) = extract_version_range(rest, extract_gdb_version)\n+                .unwrap_or_else(|| {\n+                    panic!(\"couldn't parse version range: {:?}\", rest);\n+                });\n+\n+            if start_ver != end_ver {\n+                panic!(\"Expected single GDB version\")\n+            }\n+            // Ignore if actual version is smaller than the minimum\n+            // required version\n+            return actual_version < start_ver;\n+        } else if let Some(rest) = line.strip_prefix(\"ignore-gdb-version:\").map(str::trim) {\n+            let (min_version, max_version) = extract_version_range(rest, extract_gdb_version)\n+                .unwrap_or_else(|| {\n+                    panic!(\"couldn't parse version range: {:?}\", rest);\n+                });\n+\n+            if max_version < min_version {\n+                panic!(\"Malformed GDB version range: max < min\")\n+            }\n+\n+            return actual_version >= min_version && actual_version <= max_version;\n+        }\n+    }\n+    false\n+}\n+\n+fn ignore_lldb(config: &Config, line: &str) -> bool {\n+    if let Some(actual_version) = config.lldb_version {\n+        if let Some(min_version) = line.strip_prefix(\"min-lldb-version:\").map(str::trim) {\n+            let min_version = min_version.parse().unwrap_or_else(|e| {\n+                panic!(\"Unexpected format of LLDB version string: {}\\n{:?}\", min_version, e);\n+            });\n+            // Ignore if actual version is smaller the minimum required\n+            // version\n+            actual_version < min_version\n+        } else {\n+            line.starts_with(\"rust-lldb\") && !config.lldb_native_rust\n+        }\n+    } else {\n+        false\n+    }\n+}\n+\n+fn ignore_llvm(config: &Config, line: &str) -> bool {\n+    if config.system_llvm && line.starts_with(\"no-system-llvm\") {\n+        return true;\n+    }\n+    if let Some(needed_components) =\n+        config.parse_name_value_directive(line, \"needs-llvm-components\")\n+    {\n+        let components: HashSet<_> = config.llvm_components.split_whitespace().collect();\n+        if let Some(missing_component) = needed_components\n+            .split_whitespace()\n+            .find(|needed_component| !components.contains(needed_component))\n+        {\n+            if env::var_os(\"COMPILETEST_NEEDS_ALL_LLVM_COMPONENTS\").is_some() {\n+                panic!(\"missing LLVM component: {}\", missing_component);\n+            }\n+            return true;\n+        }\n+    }\n+    if let Some(actual_version) = config.llvm_version {\n+        if let Some(rest) = line.strip_prefix(\"min-llvm-version:\").map(str::trim) {\n+            let min_version = extract_llvm_version(rest).unwrap();\n+            // Ignore if actual version is smaller the minimum required\n+            // version\n+            actual_version < min_version\n+        } else if let Some(rest) = line.strip_prefix(\"min-system-llvm-version:\").map(str::trim) {\n+            let min_version = extract_llvm_version(rest).unwrap();\n+            // Ignore if using system LLVM and actual version\n+            // is smaller the minimum required version\n+            config.system_llvm && actual_version < min_version\n+        } else if let Some(rest) = line.strip_prefix(\"ignore-llvm-version:\").map(str::trim) {\n+            // Syntax is: \"ignore-llvm-version: <version1> [- <version2>]\"\n+            let (v_min, v_max) =\n+                extract_version_range(rest, extract_llvm_version).unwrap_or_else(|| {\n+                    panic!(\"couldn't parse version range: {:?}\", rest);\n+                });\n+            if v_max < v_min {\n+                panic!(\"Malformed LLVM version range: max < min\")\n+            }\n+            // Ignore if version lies inside of range.\n+            actual_version >= v_min && actual_version <= v_max\n+        } else {\n+            false\n+        }\n+    } else {\n+        false\n+    }\n+}"}, {"sha": "2485dbadab5bfdbb5bb6cb55f4ec336a90f98778", "filename": "src/tools/compiletest/src/header/tests.rs", "status": "modified", "additions": 62, "deletions": 51, "changes": 113, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftools%2Fcompiletest%2Fsrc%2Fheader%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftools%2Fcompiletest%2Fsrc%2Fheader%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fheader%2Ftests.rs?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -1,7 +1,7 @@\n use std::path::Path;\n \n use crate::common::{Config, Debugger};\n-use crate::header::{parse_normalization_string, EarlyProps};\n+use crate::header::{make_test_description, parse_normalization_string, EarlyProps};\n \n #[test]\n fn test_parse_normalization_string() {\n@@ -66,6 +66,13 @@ fn parse_rs(config: &Config, contents: &str) -> EarlyProps {\n     EarlyProps::from_reader(config, Path::new(\"a.rs\"), bytes)\n }\n \n+fn check_ignore(config: &Config, contents: &str) -> bool {\n+    let tn = test::DynTestName(String::new());\n+    let p = Path::new(\"a.rs\");\n+    let d = make_test_description(&config, tn, p, std::io::Cursor::new(contents), None);\n+    d.ignore\n+}\n+\n fn parse_makefile(config: &Config, contents: &str) -> EarlyProps {\n     let bytes = contents.as_bytes();\n     EarlyProps::from_reader(config, Path::new(\"Makefile\"), bytes)\n@@ -74,9 +81,13 @@ fn parse_makefile(config: &Config, contents: &str) -> EarlyProps {\n #[test]\n fn should_fail() {\n     let config = config();\n+    let tn = test::DynTestName(String::new());\n+    let p = Path::new(\"a.rs\");\n \n-    assert!(!parse_rs(&config, \"\").should_fail);\n-    assert!(parse_rs(&config, \"// should-fail\").should_fail);\n+    let d = make_test_description(&config, tn.clone(), p, std::io::Cursor::new(\"\"), None);\n+    assert_eq!(d.should_panic, test::ShouldPanic::No);\n+    let d = make_test_description(&config, tn, p, std::io::Cursor::new(\"// should-fail\"), None);\n+    assert_eq!(d.should_panic, test::ShouldPanic::Yes);\n }\n \n #[test]\n@@ -112,97 +123,97 @@ fn no_system_llvm() {\n     let mut config = config();\n \n     config.system_llvm = false;\n-    assert!(!parse_rs(&config, \"// no-system-llvm\").ignore);\n+    assert!(!check_ignore(&config, \"// no-system-llvm\"));\n \n     config.system_llvm = true;\n-    assert!(parse_rs(&config, \"// no-system-llvm\").ignore);\n+    assert!(check_ignore(&config, \"// no-system-llvm\"));\n }\n \n #[test]\n fn llvm_version() {\n     let mut config = config();\n \n     config.llvm_version = Some(80102);\n-    assert!(parse_rs(&config, \"// min-llvm-version: 9.0\").ignore);\n+    assert!(check_ignore(&config, \"// min-llvm-version: 9.0\"));\n \n     config.llvm_version = Some(90001);\n-    assert!(parse_rs(&config, \"// min-llvm-version: 9.2\").ignore);\n+    assert!(check_ignore(&config, \"// min-llvm-version: 9.2\"));\n \n     config.llvm_version = Some(90301);\n-    assert!(!parse_rs(&config, \"// min-llvm-version: 9.2\").ignore);\n+    assert!(!check_ignore(&config, \"// min-llvm-version: 9.2\"));\n \n     config.llvm_version = Some(100000);\n-    assert!(!parse_rs(&config, \"// min-llvm-version: 9.0\").ignore);\n+    assert!(!check_ignore(&config, \"// min-llvm-version: 9.0\"));\n }\n \n #[test]\n fn ignore_target() {\n     let mut config = config();\n     config.target = \"x86_64-unknown-linux-gnu\".to_owned();\n \n-    assert!(parse_rs(&config, \"// ignore-x86_64-unknown-linux-gnu\").ignore);\n-    assert!(parse_rs(&config, \"// ignore-x86_64\").ignore);\n-    assert!(parse_rs(&config, \"// ignore-linux\").ignore);\n-    assert!(parse_rs(&config, \"// ignore-gnu\").ignore);\n-    assert!(parse_rs(&config, \"// ignore-64bit\").ignore);\n+    assert!(check_ignore(&config, \"// ignore-x86_64-unknown-linux-gnu\"));\n+    assert!(check_ignore(&config, \"// ignore-x86_64\"));\n+    assert!(check_ignore(&config, \"// ignore-linux\"));\n+    assert!(check_ignore(&config, \"// ignore-gnu\"));\n+    assert!(check_ignore(&config, \"// ignore-64bit\"));\n \n-    assert!(!parse_rs(&config, \"// ignore-i686\").ignore);\n-    assert!(!parse_rs(&config, \"// ignore-windows\").ignore);\n-    assert!(!parse_rs(&config, \"// ignore-msvc\").ignore);\n-    assert!(!parse_rs(&config, \"// ignore-32bit\").ignore);\n+    assert!(!check_ignore(&config, \"// ignore-i686\"));\n+    assert!(!check_ignore(&config, \"// ignore-windows\"));\n+    assert!(!check_ignore(&config, \"// ignore-msvc\"));\n+    assert!(!check_ignore(&config, \"// ignore-32bit\"));\n }\n \n #[test]\n fn only_target() {\n     let mut config = config();\n     config.target = \"x86_64-pc-windows-gnu\".to_owned();\n \n-    assert!(parse_rs(&config, \"// only-i686\").ignore);\n-    assert!(parse_rs(&config, \"// only-linux\").ignore);\n-    assert!(parse_rs(&config, \"// only-msvc\").ignore);\n-    assert!(parse_rs(&config, \"// only-32bit\").ignore);\n+    assert!(check_ignore(&config, \"// only-i686\"));\n+    assert!(check_ignore(&config, \"// only-linux\"));\n+    assert!(check_ignore(&config, \"// only-msvc\"));\n+    assert!(check_ignore(&config, \"// only-32bit\"));\n \n-    assert!(!parse_rs(&config, \"// only-x86_64-pc-windows-gnu\").ignore);\n-    assert!(!parse_rs(&config, \"// only-x86_64\").ignore);\n-    assert!(!parse_rs(&config, \"// only-windows\").ignore);\n-    assert!(!parse_rs(&config, \"// only-gnu\").ignore);\n-    assert!(!parse_rs(&config, \"// only-64bit\").ignore);\n+    assert!(!check_ignore(&config, \"// only-x86_64-pc-windows-gnu\"));\n+    assert!(!check_ignore(&config, \"// only-x86_64\"));\n+    assert!(!check_ignore(&config, \"// only-windows\"));\n+    assert!(!check_ignore(&config, \"// only-gnu\"));\n+    assert!(!check_ignore(&config, \"// only-64bit\"));\n }\n \n #[test]\n fn stage() {\n     let mut config = config();\n     config.stage_id = \"stage1\".to_owned();\n \n-    assert!(parse_rs(&config, \"// ignore-stage1\").ignore);\n-    assert!(!parse_rs(&config, \"// ignore-stage2\").ignore);\n+    assert!(check_ignore(&config, \"// ignore-stage1\"));\n+    assert!(!check_ignore(&config, \"// ignore-stage2\"));\n }\n \n #[test]\n fn cross_compile() {\n     let mut config = config();\n     config.host = \"x86_64-apple-darwin\".to_owned();\n     config.target = \"wasm32-unknown-unknown\".to_owned();\n-    assert!(parse_rs(&config, \"// ignore-cross-compile\").ignore);\n+    assert!(check_ignore(&config, \"// ignore-cross-compile\"));\n \n     config.target = config.host.clone();\n-    assert!(!parse_rs(&config, \"// ignore-cross-compile\").ignore);\n+    assert!(!check_ignore(&config, \"// ignore-cross-compile\"));\n }\n \n #[test]\n fn debugger() {\n     let mut config = config();\n     config.debugger = None;\n-    assert!(!parse_rs(&config, \"// ignore-cdb\").ignore);\n+    assert!(!check_ignore(&config, \"// ignore-cdb\"));\n \n     config.debugger = Some(Debugger::Cdb);\n-    assert!(parse_rs(&config, \"// ignore-cdb\").ignore);\n+    assert!(check_ignore(&config, \"// ignore-cdb\"));\n \n     config.debugger = Some(Debugger::Gdb);\n-    assert!(parse_rs(&config, \"// ignore-gdb\").ignore);\n+    assert!(check_ignore(&config, \"// ignore-gdb\"));\n \n     config.debugger = Some(Debugger::Lldb);\n-    assert!(parse_rs(&config, \"// ignore-lldb\").ignore);\n+    assert!(check_ignore(&config, \"// ignore-lldb\"));\n }\n \n #[test]\n@@ -211,42 +222,42 @@ fn sanitizers() {\n \n     // Target that supports all sanitizers:\n     config.target = \"x86_64-unknown-linux-gnu\".to_owned();\n-    assert!(!parse_rs(&config, \"// needs-sanitizer-address\").ignore);\n-    assert!(!parse_rs(&config, \"// needs-sanitizer-leak\").ignore);\n-    assert!(!parse_rs(&config, \"// needs-sanitizer-memory\").ignore);\n-    assert!(!parse_rs(&config, \"// needs-sanitizer-thread\").ignore);\n+    assert!(!check_ignore(&config, \"// needs-sanitizer-address\"));\n+    assert!(!check_ignore(&config, \"// needs-sanitizer-leak\"));\n+    assert!(!check_ignore(&config, \"// needs-sanitizer-memory\"));\n+    assert!(!check_ignore(&config, \"// needs-sanitizer-thread\"));\n \n     // Target that doesn't support sanitizers:\n     config.target = \"wasm32-unknown-emscripten\".to_owned();\n-    assert!(parse_rs(&config, \"// needs-sanitizer-address\").ignore);\n-    assert!(parse_rs(&config, \"// needs-sanitizer-leak\").ignore);\n-    assert!(parse_rs(&config, \"// needs-sanitizer-memory\").ignore);\n-    assert!(parse_rs(&config, \"// needs-sanitizer-thread\").ignore);\n+    assert!(check_ignore(&config, \"// needs-sanitizer-address\"));\n+    assert!(check_ignore(&config, \"// needs-sanitizer-leak\"));\n+    assert!(check_ignore(&config, \"// needs-sanitizer-memory\"));\n+    assert!(check_ignore(&config, \"// needs-sanitizer-thread\"));\n }\n \n #[test]\n fn asm_support() {\n     let mut config = config();\n \n     config.target = \"avr-unknown-gnu-atmega328\".to_owned();\n-    assert!(parse_rs(&config, \"// needs-asm-support\").ignore);\n+    assert!(check_ignore(&config, \"// needs-asm-support\"));\n \n     config.target = \"i686-unknown-netbsd\".to_owned();\n-    assert!(!parse_rs(&config, \"// needs-asm-support\").ignore);\n+    assert!(!check_ignore(&config, \"// needs-asm-support\"));\n }\n \n #[test]\n fn channel() {\n     let mut config = config();\n     config.channel = \"beta\".into();\n \n-    assert!(parse_rs(&config, \"// ignore-beta\").ignore);\n-    assert!(parse_rs(&config, \"// only-nightly\").ignore);\n-    assert!(parse_rs(&config, \"// only-stable\").ignore);\n+    assert!(check_ignore(&config, \"// ignore-beta\"));\n+    assert!(check_ignore(&config, \"// only-nightly\"));\n+    assert!(check_ignore(&config, \"// only-stable\"));\n \n-    assert!(!parse_rs(&config, \"// only-beta\").ignore);\n-    assert!(!parse_rs(&config, \"// ignore-nightly\").ignore);\n-    assert!(!parse_rs(&config, \"// ignore-stable\").ignore);\n+    assert!(!check_ignore(&config, \"// only-beta\"));\n+    assert!(!check_ignore(&config, \"// ignore-nightly\"));\n+    assert!(!check_ignore(&config, \"// ignore-stable\"));\n }\n \n #[test]"}, {"sha": "46432d5e4f5bcd9c1a73376e3d9a3b4bdf9e4115", "filename": "src/tools/compiletest/src/main.rs", "status": "modified", "additions": 21, "deletions": 43, "changes": 64, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -8,7 +8,7 @@ extern crate test;\n use crate::common::{\n     expected_output_path, output_base_dir, output_relative_path, PanicStrategy, UI_EXTENSIONS,\n };\n-use crate::common::{CompareMode, Config, Debugger, Mode, PassMode, Pretty, TestPaths};\n+use crate::common::{CompareMode, Config, Debugger, Mode, PassMode, TestPaths};\n use crate::util::logv;\n use getopts::Options;\n use std::env;\n@@ -22,7 +22,7 @@ use test::ColorConfig;\n use tracing::*;\n use walkdir::WalkDir;\n \n-use self::header::EarlyProps;\n+use self::header::{make_test_description, EarlyProps};\n \n #[cfg(test)]\n mod tests;\n@@ -620,26 +620,13 @@ pub fn is_test(file_name: &OsString) -> bool {\n }\n \n fn make_test(config: &Config, testpaths: &TestPaths, inputs: &Stamp) -> Vec<test::TestDescAndFn> {\n-    let early_props = if config.mode == Mode::RunMake {\n-        // Allow `ignore` directives to be in the Makefile.\n-        EarlyProps::from_file(config, &testpaths.file.join(\"Makefile\"))\n+    let test_path = if config.mode == Mode::RunMake {\n+        // Parse directives in the Makefile\n+        testpaths.file.join(\"Makefile\")\n     } else {\n-        EarlyProps::from_file(config, &testpaths.file)\n-    };\n-\n-    // The `should-fail` annotation doesn't apply to pretty tests,\n-    // since we run the pretty printer across all tests by default.\n-    // If desired, we could add a `should-fail-pretty` annotation.\n-    let should_panic = match config.mode {\n-        Pretty => test::ShouldPanic::No,\n-        _ => {\n-            if early_props.should_fail {\n-                test::ShouldPanic::Yes\n-            } else {\n-                test::ShouldPanic::No\n-            }\n-        }\n+        PathBuf::from(&testpaths.file)\n     };\n+    let early_props = EarlyProps::from_file(config, &test_path);\n \n     // Incremental tests are special, they inherently cannot be run in parallel.\n     // `runtest::run` will be responsible for iterating over revisions.\n@@ -651,29 +638,20 @@ fn make_test(config: &Config, testpaths: &TestPaths, inputs: &Stamp) -> Vec<test\n     revisions\n         .into_iter()\n         .map(|revision| {\n-            let ignore = early_props.ignore\n-                // Ignore tests that already run and are up to date with respect to inputs.\n-                || is_up_to_date(\n-                    config,\n-                    testpaths,\n-                    &early_props,\n-                    revision.map(|s| s.as_str()),\n-                    inputs,\n-                );\n-            test::TestDescAndFn {\n-                desc: test::TestDesc {\n-                    name: make_test_name(config, testpaths, revision),\n-                    ignore,\n-                    should_panic,\n-                    allow_fail: false,\n-                    #[cfg(not(bootstrap))]\n-                    compile_fail: false,\n-                    #[cfg(not(bootstrap))]\n-                    no_run: false,\n-                    test_type: test::TestType::Unknown,\n-                },\n-                testfn: make_test_closure(config, testpaths, revision),\n-            }\n+            let src_file =\n+                std::fs::File::open(&test_path).expect(\"open test file to parse ignores\");\n+            let cfg = revision.map(|v| &**v);\n+            let test_name = crate::make_test_name(config, testpaths, revision);\n+            let mut desc = make_test_description(config, test_name, &test_path, src_file, cfg);\n+            // Ignore tests that already run and are up to date with respect to inputs.\n+            desc.ignore |= is_up_to_date(\n+                config,\n+                testpaths,\n+                &early_props,\n+                revision.map(|s| s.as_str()),\n+                inputs,\n+            );\n+            test::TestDescAndFn { desc, testfn: make_test_closure(config, testpaths, revision) }\n         })\n         .collect()\n }"}, {"sha": "a1c41eb99810e8c51b247b6b6dcb47f9604fb981", "filename": "src/tools/tidy/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftools%2Ftidy%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftools%2Ftidy%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Flib.rs?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -47,6 +47,7 @@ pub mod extdeps;\n pub mod features;\n pub mod pal;\n pub mod style;\n+pub mod target_specific_tests;\n pub mod ui_tests;\n pub mod unit_tests;\n pub mod unstable_book;"}, {"sha": "440c352ea5320de9319e91c01525929028e3b96f", "filename": "src/tools/tidy/src/main.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftools%2Ftidy%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftools%2Ftidy%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Fmain.rs?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -55,6 +55,8 @@ fn main() {\n             }\n         }\n \n+        check!(target_specific_tests, &src_path);\n+\n         // Checks that are done on the cargo workspace.\n         check!(deps, &root_path, &cargo);\n         check!(extdeps, &root_path);"}, {"sha": "8e1749196d2ec5927675b98b072b4231b8e40ca5", "filename": "src/tools/tidy/src/target_specific_tests.rs", "status": "added", "additions": 96, "deletions": 0, "changes": 96, "blob_url": "https://github.com/rust-lang/rust/blob/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftools%2Ftidy%2Fsrc%2Ftarget_specific_tests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3/src%2Ftools%2Ftidy%2Fsrc%2Ftarget_specific_tests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Ftarget_specific_tests.rs?ref=d4e7cb3254940e1db6d0670ecb15ccd89d6f69e3", "patch": "@@ -0,0 +1,96 @@\n+//! Tidy check to ensure that all target specific tests (those that require a `--target` flag)\n+//! also require the pre-requisite LLVM components to run.\n+\n+use std::collections::BTreeMap;\n+use std::path::Path;\n+\n+const COMMENT: &str = \"//\";\n+const LLVM_COMPONENTS_HEADER: &str = \"needs-llvm-components:\";\n+const COMPILE_FLAGS_HEADER: &str = \"compile-flags:\";\n+\n+/// Iterate through compiletest headers in a test contents.\n+///\n+/// Adjusted from compiletest/src/header.rs.\n+fn iter_header<'a>(contents: &'a str, it: &mut dyn FnMut(Option<&'a str>, &'a str)) {\n+    for ln in contents.lines() {\n+        let ln = ln.trim();\n+        if ln.starts_with(COMMENT) && ln[COMMENT.len()..].trim_start().starts_with('[') {\n+            if let Some(close_brace) = ln.find(']') {\n+                let open_brace = ln.find('[').unwrap();\n+                let lncfg = &ln[open_brace + 1..close_brace];\n+                it(Some(lncfg), ln[(close_brace + 1)..].trim_start());\n+            } else {\n+                panic!(\"malformed condition directive: expected `//[foo]`, found `{}`\", ln)\n+            }\n+        } else if ln.starts_with(COMMENT) {\n+            it(None, ln[COMMENT.len()..].trim_start());\n+        }\n+    }\n+}\n+\n+#[derive(Default, Debug)]\n+struct RevisionInfo<'a> {\n+    target_arch: Option<&'a str>,\n+    llvm_components: Option<Vec<&'a str>>,\n+}\n+\n+pub fn check(path: &Path, bad: &mut bool) {\n+    let tests = path.join(\"test\");\n+    super::walk(\n+        &tests,\n+        &mut |path| path.extension().map(|p| p == \"rs\") == Some(false),\n+        &mut |entry, content| {\n+            let file = entry.path().display();\n+            let mut header_map = BTreeMap::new();\n+            iter_header(content, &mut |cfg, directive| {\n+                if let Some(value) = directive.strip_prefix(LLVM_COMPONENTS_HEADER) {\n+                    let info = header_map.entry(cfg).or_insert(RevisionInfo::default());\n+                    let comp_vec = info.llvm_components.get_or_insert(Vec::new());\n+                    for component in value.split(' ') {\n+                        let component = component.trim();\n+                        if !component.is_empty() {\n+                            comp_vec.push(component);\n+                        }\n+                    }\n+                } else if directive.starts_with(COMPILE_FLAGS_HEADER) {\n+                    let compile_flags = &directive[COMPILE_FLAGS_HEADER.len()..];\n+                    if let Some((_, v)) = compile_flags.split_once(\"--target\") {\n+                        if let Some((arch, _)) =\n+                            v.trim_start_matches(|c| c == ' ' || c == '=').split_once(\"-\")\n+                        {\n+                            let info = header_map.entry(cfg).or_insert(RevisionInfo::default());\n+                            info.target_arch.replace(arch);\n+                        } else {\n+                            eprintln!(\"{}: seems to have a malformed --target value\", file);\n+                            *bad = true;\n+                        }\n+                    }\n+                }\n+            });\n+            for (rev, RevisionInfo { target_arch, llvm_components }) in &header_map {\n+                let rev = rev.unwrap_or(\"[unspecified]\");\n+                match (target_arch, llvm_components) {\n+                    (None, None) => {}\n+                    (Some(_), None) => {\n+                        eprintln!(\n+                            \"{}: revision {} should specify `{}` as it has `--target` set\",\n+                            file, rev, LLVM_COMPONENTS_HEADER\n+                        );\n+                        *bad = true;\n+                    }\n+                    (None, Some(_)) => {\n+                        eprintln!(\n+                            \"{}: revision {} should not specify `{}` as it doesn't need `--target`\",\n+                            file, rev, LLVM_COMPONENTS_HEADER\n+                        );\n+                        *bad = true;\n+                    }\n+                    (Some(_), Some(_)) => {\n+                        // FIXME: check specified components against the target architectures we\n+                        // gathered.\n+                    }\n+                }\n+            }\n+        },\n+    );\n+}"}]}