{"sha": "fd7c454d516e3af90d8c0d0d8a22655345fec2d7", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZkN2M0NTRkNTE2ZTNhZjkwZDhjMGQwZDhhMjI2NTUzNDVmZWMyZDc=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-03-30T16:45:05Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-03-30T16:45:05Z"}, "message": "Merge #8186\n\n8186: Lower traits to `TraitRef` instead of `TypeRef` r=matklad a=Veykril\n\n\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>", "tree": {"sha": "6e5292a731c7039d92c636bc66a27714845ffb1c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6e5292a731c7039d92c636bc66a27714845ffb1c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fd7c454d516e3af90d8c0d0d8a22655345fec2d7", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgY1WRCRBK7hj4Ov3rIwAAdHIIADLWdJJ7Gy0DfRmCUdZPZAcX\nzS9FZoAMnawRij/u/VZ8dkEWHarcWVI87IrTQeJHNxVuWo41LL4af6XmTnTUw+p2\nYF4Gs1UP3RGGbDn9qpxwpSp7rFLVmeckMebKUdwvk7/kvFt8jchhipDB6ZA1GFaD\n5FZxfhF6ko2QGqf+Dgodi4e2F+iaWkMdilVbDQnEPfqga2qomSV/SsDN8J5ALhiS\nX37OR1Oy+8iZZGuK6oqNMW84PuLhHavIK+nlCRdX73ArHU73dlq9Exc/ceXjZcvr\nDXbXUsit1GnWjCKPZQBqAyvkAKuYHB6EsT4nP/EBGBnTR5dyeXPrPMakCYp50yw=\n=vmZA\n-----END PGP SIGNATURE-----\n", "payload": "tree 6e5292a731c7039d92c636bc66a27714845ffb1c\nparent 277db63a08d9910ffbcf1eded723c176941feff1\nparent b4bb7743810b1e6ac8b897a465c430e9ed8d5c44\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1617122705 +0000\ncommitter GitHub <noreply@github.com> 1617122705 +0000\n\nMerge #8186\n\n8186: Lower traits to `TraitRef` instead of `TypeRef` r=matklad a=Veykril\n\n\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fd7c454d516e3af90d8c0d0d8a22655345fec2d7", "html_url": "https://github.com/rust-lang/rust/commit/fd7c454d516e3af90d8c0d0d8a22655345fec2d7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fd7c454d516e3af90d8c0d0d8a22655345fec2d7/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "277db63a08d9910ffbcf1eded723c176941feff1", "url": "https://api.github.com/repos/rust-lang/rust/commits/277db63a08d9910ffbcf1eded723c176941feff1", "html_url": "https://github.com/rust-lang/rust/commit/277db63a08d9910ffbcf1eded723c176941feff1"}, {"sha": "b4bb7743810b1e6ac8b897a465c430e9ed8d5c44", "url": "https://api.github.com/repos/rust-lang/rust/commits/b4bb7743810b1e6ac8b897a465c430e9ed8d5c44", "html_url": "https://github.com/rust-lang/rust/commit/b4bb7743810b1e6ac8b897a465c430e9ed8d5c44"}], "stats": {"total": 140, "additions": 100, "deletions": 40}, "files": [{"sha": "97f162315390dc3318dcc83d09f74e77265f7bdc", "filename": "crates/hir/src/lib.rs", "status": "modified", "additions": 7, "deletions": 6, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/fd7c454d516e3af90d8c0d0d8a22655345fec2d7/crates%2Fhir%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd7c454d516e3af90d8c0d0d8a22655345fec2d7/crates%2Fhir%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Flib.rs?ref=fd7c454d516e3af90d8c0d0d8a22655345fec2d7", "patch": "@@ -44,6 +44,7 @@ use hir_def::{\n     per_ns::PerNs,\n     resolver::{HasResolver, Resolver},\n     src::HasSource as _,\n+    type_ref::TraitRef,\n     AdtId, AssocContainerId, AssocItemId, AssocItemLoc, AttrDefId, ConstId, ConstParamId,\n     DefWithBodyId, EnumId, FunctionId, GenericDefId, HasModule, ImplId, LifetimeParamId,\n     LocalEnumVariantId, LocalFieldId, Lookup, ModuleId, StaticId, StructId, TraitId, TypeAliasId,\n@@ -1573,9 +1574,9 @@ impl Impl {\n         };\n \n         let filter = |impl_def: &Impl| {\n-            let target_ty = impl_def.target_ty(db);\n-            let rref = target_ty.remove_ref();\n-            ty.equals_ctor(rref.as_ref().map_or(&target_ty.ty, |it| &it.ty))\n+            let self_ty = impl_def.self_ty(db);\n+            let rref = self_ty.remove_ref();\n+            ty.equals_ctor(rref.as_ref().map_or(&self_ty.ty, |it| &it.ty))\n         };\n \n         let mut all = Vec::new();\n@@ -1613,16 +1614,16 @@ impl Impl {\n \n     // FIXME: the return type is wrong. This should be a hir version of\n     // `TraitRef` (ie, resolved `TypeRef`).\n-    pub fn target_trait(self, db: &dyn HirDatabase) -> Option<TypeRef> {\n+    pub fn trait_(self, db: &dyn HirDatabase) -> Option<TraitRef> {\n         db.impl_data(self.id).target_trait.clone()\n     }\n \n-    pub fn target_ty(self, db: &dyn HirDatabase) -> Type {\n+    pub fn self_ty(self, db: &dyn HirDatabase) -> Type {\n         let impl_data = db.impl_data(self.id);\n         let resolver = self.id.resolver(db.upcast());\n         let krate = self.id.lookup(db.upcast()).container.krate();\n         let ctx = hir_ty::TyLoweringContext::new(db, &resolver);\n-        let ty = ctx.lower_ty(&impl_data.target_type);\n+        let ty = ctx.lower_ty(&impl_data.self_ty);\n         Type::new_with_resolver_inner(db, krate, &resolver, ty)\n     }\n "}, {"sha": "214bcc64834a58f505e46b571c1353ff40d63ecd", "filename": "crates/hir_def/src/data.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/fd7c454d516e3af90d8c0d0d8a22655345fec2d7/crates%2Fhir_def%2Fsrc%2Fdata.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd7c454d516e3af90d8c0d0d8a22655345fec2d7/crates%2Fhir_def%2Fsrc%2Fdata.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fdata.rs?ref=fd7c454d516e3af90d8c0d0d8a22655345fec2d7", "patch": "@@ -10,7 +10,7 @@ use crate::{\n     body::Expander,\n     db::DefDatabase,\n     item_tree::{AssocItem, FunctionQualifier, ItemTreeId, ModItem, Param},\n-    type_ref::{TypeBound, TypeRef},\n+    type_ref::{TraitRef, TypeBound, TypeRef},\n     visibility::RawVisibility,\n     AssocContainerId, AssocItemId, ConstId, ConstLoc, FunctionId, FunctionLoc, HasModule, ImplId,\n     Intern, Lookup, ModuleId, StaticId, TraitId, TypeAliasId, TypeAliasLoc,\n@@ -156,8 +156,8 @@ impl TraitData {\n \n #[derive(Debug, Clone, PartialEq, Eq)]\n pub struct ImplData {\n-    pub target_trait: Option<TypeRef>,\n-    pub target_type: TypeRef,\n+    pub target_trait: Option<TraitRef>,\n+    pub self_ty: TypeRef,\n     pub items: Vec<AssocItemId>,\n     pub is_negative: bool,\n }\n@@ -170,7 +170,7 @@ impl ImplData {\n         let item_tree = impl_loc.id.item_tree(db);\n         let impl_def = &item_tree[impl_loc.id.value];\n         let target_trait = impl_def.target_trait.map(|id| item_tree[id].clone());\n-        let target_type = item_tree[impl_def.target_type].clone();\n+        let self_ty = item_tree[impl_def.self_ty].clone();\n         let is_negative = impl_def.is_negative;\n         let module_id = impl_loc.container;\n         let container = AssocContainerId::ImplId(id);\n@@ -187,7 +187,7 @@ impl ImplData {\n         );\n         let items = items.into_iter().map(|(_, item)| item).collect();\n \n-        Arc::new(ImplData { target_trait, target_type, items, is_negative })\n+        Arc::new(ImplData { target_trait, self_ty, items, is_negative })\n     }\n }\n "}, {"sha": "5449bbf5d0241b70238f561e13efdfe4ba66779e", "filename": "crates/hir_def/src/item_tree.rs", "status": "modified", "additions": 40, "deletions": 3, "changes": 43, "blob_url": "https://github.com/rust-lang/rust/blob/fd7c454d516e3af90d8c0d0d8a22655345fec2d7/crates%2Fhir_def%2Fsrc%2Fitem_tree.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd7c454d516e3af90d8c0d0d8a22655345fec2d7/crates%2Fhir_def%2Fsrc%2Fitem_tree.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fitem_tree.rs?ref=fd7c454d516e3af90d8c0d0d8a22655345fec2d7", "patch": "@@ -31,7 +31,7 @@ use crate::{\n     db::DefDatabase,\n     generics::GenericParams,\n     path::{path, AssociatedTypeBinding, GenericArgs, ImportAlias, ModPath, Path, PathKind},\n-    type_ref::{Mutability, TypeBound, TypeRef},\n+    type_ref::{Mutability, TraitRef, TypeBound, TypeRef},\n     visibility::RawVisibility,\n };\n \n@@ -147,6 +147,7 @@ impl ItemTree {\n                 vis,\n                 generics,\n                 type_refs,\n+                trait_refs,\n                 inner_items,\n             } = &mut **data;\n \n@@ -173,6 +174,7 @@ impl ItemTree {\n             generics.arena.shrink_to_fit();\n             type_refs.arena.shrink_to_fit();\n             type_refs.map.shrink_to_fit();\n+            trait_refs.map.shrink_to_fit();\n \n             inner_items.shrink_to_fit();\n         }\n@@ -295,6 +297,32 @@ impl TypeRefStorage {\n     }\n }\n \n+/// `TraitRef` interner.\n+#[derive(Default, Debug, Eq, PartialEq)]\n+struct TraitRefStorage {\n+    arena: Arena<Arc<TraitRef>>,\n+    map: FxHashMap<Arc<TraitRef>, Idx<Arc<TraitRef>>>,\n+}\n+\n+impl TraitRefStorage {\n+    // Note: We lie about the `Idx<TraitRef>` to hide the interner details.\n+\n+    fn intern(&mut self, ty: TraitRef) -> Idx<TraitRef> {\n+        if let Some(id) = self.map.get(&ty) {\n+            return Idx::from_raw(id.into_raw());\n+        }\n+\n+        let ty = Arc::new(ty);\n+        let idx = self.arena.alloc(ty.clone());\n+        self.map.insert(ty, idx);\n+        Idx::from_raw(idx.into_raw())\n+    }\n+\n+    fn lookup(&self, id: Idx<TraitRef>) -> &TraitRef {\n+        &self.arena[Idx::from_raw(id.into_raw())]\n+    }\n+}\n+\n #[derive(Default, Debug, Eq, PartialEq)]\n struct ItemTreeData {\n     imports: Arena<Import>,\n@@ -319,6 +347,7 @@ struct ItemTreeData {\n     vis: ItemVisibilities,\n     generics: GenericParamsStorage,\n     type_refs: TypeRefStorage,\n+    trait_refs: TraitRefStorage,\n \n     inner_items: FxHashMap<FileAstId<ast::BlockExpr>, SmallVec<[ModItem; 1]>>,\n }\n@@ -556,6 +585,14 @@ impl Index<Idx<TypeRef>> for ItemTree {\n     }\n }\n \n+impl Index<Idx<TraitRef>> for ItemTree {\n+    type Output = TraitRef;\n+\n+    fn index(&self, id: Idx<TraitRef>) -> &Self::Output {\n+        self.data().trait_refs.lookup(id)\n+    }\n+}\n+\n impl<N: ItemTreeNode> Index<FileItemTreeId<N>> for ItemTree {\n     type Output = N;\n     fn index(&self, id: FileItemTreeId<N>) -> &N {\n@@ -692,8 +729,8 @@ pub struct Trait {\n #[derive(Debug, Clone, Eq, PartialEq)]\n pub struct Impl {\n     pub generic_params: GenericParamsId,\n-    pub target_trait: Option<Idx<TypeRef>>,\n-    pub target_type: Idx<TypeRef>,\n+    pub target_trait: Option<Idx<TraitRef>>,\n+    pub self_ty: Idx<TypeRef>,\n     pub is_negative: bool,\n     pub items: Box<[AssocItem]>,\n     pub ast_id: FileAstId<ast::Impl>,"}, {"sha": "8d38628111395f0c3a1dc1497902265f8afb772f", "filename": "crates/hir_def/src/item_tree/lower.rs", "status": "modified", "additions": 13, "deletions": 4, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/fd7c454d516e3af90d8c0d0d8a22655345fec2d7/crates%2Fhir_def%2Fsrc%2Fitem_tree%2Flower.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd7c454d516e3af90d8c0d0d8a22655345fec2d7/crates%2Fhir_def%2Fsrc%2Fitem_tree%2Flower.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fitem_tree%2Flower.rs?ref=fd7c454d516e3af90d8c0d0d8a22655345fec2d7", "patch": "@@ -11,7 +11,7 @@ use syntax::{\n \n use crate::{\n     generics::{GenericParams, TypeParamData, TypeParamProvenance},\n-    type_ref::LifetimeRef,\n+    type_ref::{LifetimeRef, TraitRef},\n };\n \n use super::*;\n@@ -536,8 +536,11 @@ impl Ctx {\n     fn lower_impl(&mut self, impl_def: &ast::Impl) -> Option<FileItemTreeId<Impl>> {\n         let generic_params =\n             self.lower_generic_params_and_inner_items(GenericsOwner::Impl, impl_def);\n-        let target_trait = impl_def.trait_().map(|tr| self.lower_type_ref(&tr));\n-        let target_type = self.lower_type_ref(&impl_def.self_ty()?);\n+        // FIXME: If trait lowering fails, due to a non PathType for example, we treat this impl\n+        // as if it was an non-trait impl. Ideally we want to create a unique missing ref that only\n+        // equals itself.\n+        let target_trait = impl_def.trait_().and_then(|tr| self.lower_trait_ref(&tr));\n+        let self_ty = self.lower_type_ref(&impl_def.self_ty()?);\n         let is_negative = impl_def.excl_token().is_some();\n \n         // We cannot use `assoc_items()` here as that does not include macro calls.\n@@ -554,7 +557,7 @@ impl Ctx {\n             })\n             .collect();\n         let ast_id = self.source_ast_id_map.ast_id(impl_def);\n-        let res = Impl { generic_params, target_trait, target_type, is_negative, items, ast_id };\n+        let res = Impl { generic_params, target_trait, self_ty, is_negative, items, ast_id };\n         Some(id(self.data().impls.alloc(res)))\n     }\n \n@@ -740,10 +743,16 @@ impl Ctx {\n         self.data().vis.alloc(vis)\n     }\n \n+    fn lower_trait_ref(&mut self, trait_ref: &ast::Type) -> Option<Idx<TraitRef>> {\n+        let trait_ref = TraitRef::from_ast(&self.body_ctx, trait_ref.clone())?;\n+        Some(self.data().trait_refs.intern(trait_ref))\n+    }\n+\n     fn lower_type_ref(&mut self, type_ref: &ast::Type) -> Idx<TypeRef> {\n         let tyref = TypeRef::from_ast(&self.body_ctx, type_ref.clone());\n         self.data().type_refs.intern(tyref)\n     }\n+\n     fn lower_type_ref_opt(&mut self, type_ref: Option<ast::Type>) -> Idx<TypeRef> {\n         match type_ref.map(|ty| self.lower_type_ref(&ty)) {\n             Some(it) => it,"}, {"sha": "4c24aae94f3828ceeda11c26761916e66489abca", "filename": "crates/hir_def/src/type_ref.rs", "status": "modified", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/fd7c454d516e3af90d8c0d0d8a22655345fec2d7/crates%2Fhir_def%2Fsrc%2Ftype_ref.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd7c454d516e3af90d8c0d0d8a22655345fec2d7/crates%2Fhir_def%2Fsrc%2Ftype_ref.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Ftype_ref.rs?ref=fd7c454d516e3af90d8c0d0d8a22655345fec2d7", "patch": "@@ -51,6 +51,23 @@ impl Rawness {\n     }\n }\n \n+#[derive(Clone, PartialEq, Eq, Hash, Debug)]\n+pub struct TraitRef {\n+    pub path: Path,\n+}\n+\n+impl TraitRef {\n+    /// Converts an `ast::PathType` to a `hir::TraitRef`.\n+    pub(crate) fn from_ast(ctx: &LowerCtx, node: ast::Type) -> Option<Self> {\n+        // FIXME: Use `Path::from_src`\n+        match node {\n+            ast::Type::PathType(path) => {\n+                path.path().and_then(|it| ctx.lower_path(it)).map(|path| TraitRef { path })\n+            }\n+            _ => None,\n+        }\n+    }\n+}\n /// Compare ty::Ty\n #[derive(Clone, PartialEq, Eq, Hash, Debug)]\n pub enum TypeRef {"}, {"sha": "afbfa12d512850815a26012a5763d12a67df376e", "filename": "crates/hir_ty/src/lower.rs", "status": "modified", "additions": 4, "deletions": 8, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/fd7c454d516e3af90d8c0d0d8a22655345fec2d7/crates%2Fhir_ty%2Fsrc%2Flower.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd7c454d516e3af90d8c0d0d8a22655345fec2d7/crates%2Fhir_ty%2Fsrc%2Flower.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Flower.rs?ref=fd7c454d516e3af90d8c0d0d8a22655345fec2d7", "patch": "@@ -15,7 +15,7 @@ use hir_def::{\n     generics::{TypeParamProvenance, WherePredicate, WherePredicateTypeTarget},\n     path::{GenericArg, Path, PathSegment, PathSegments},\n     resolver::{HasResolver, Resolver, TypeNs},\n-    type_ref::{TypeBound, TypeRef},\n+    type_ref::{TraitRef as HirTraitRef, TypeBound, TypeRef},\n     AdtId, AssocContainerId, AssocItemId, ConstId, ConstParamId, EnumId, EnumVariantId, FunctionId,\n     GenericDefId, HasModule, ImplId, LocalFieldId, Lookup, StaticId, StructId, TraitId,\n     TypeAliasId, TypeParamId, UnionId, VariantId,\n@@ -667,14 +667,10 @@ impl<'a> TyLoweringContext<'a> {\n \n     fn lower_trait_ref(\n         &self,\n-        type_ref: &TypeRef,\n+        trait_ref: &HirTraitRef,\n         explicit_self_ty: Option<Ty>,\n     ) -> Option<TraitRef> {\n-        let path = match type_ref {\n-            TypeRef::Path(path) => path,\n-            _ => return None,\n-        };\n-        self.lower_trait_ref_from_path(path, explicit_self_ty)\n+        self.lower_trait_ref_from_path(&trait_ref.path, explicit_self_ty)\n     }\n \n     fn trait_ref_substs_from_path(\n@@ -1253,7 +1249,7 @@ pub(crate) fn impl_self_ty_query(db: &dyn HirDatabase, impl_id: ImplId) -> Binde\n     let generics = generics(db.upcast(), impl_id.into());\n     let ctx =\n         TyLoweringContext::new(db, &resolver).with_type_param_mode(TypeParamLoweringMode::Variable);\n-    Binders::new(generics.len(), ctx.lower_ty(&impl_data.target_type))\n+    Binders::new(generics.len(), ctx.lower_ty(&impl_data.self_ty))\n }\n \n pub(crate) fn const_param_ty_query(db: &dyn HirDatabase, def: ConstParamId) -> Ty {"}, {"sha": "67e2e5a1cf959eb8c6cf0111147cd27f8e81513e", "filename": "crates/ide/src/doc_links.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/fd7c454d516e3af90d8c0d0d8a22655345fec2d7/crates%2Fide%2Fsrc%2Fdoc_links.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd7c454d516e3af90d8c0d0d8a22655345fec2d7/crates%2Fide%2Fsrc%2Fdoc_links.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fdoc_links.rs?ref=fd7c454d516e3af90d8c0d0d8a22655345fec2d7", "patch": "@@ -237,7 +237,7 @@ fn get_doc_link(db: &RootDatabase, definition: Definition) -> Option<String> {\n                 .and_then(|assoc| match assoc.container(db) {\n                     AssocItemContainer::Trait(t) => Some(t.into()),\n                     AssocItemContainer::Impl(impld) => {\n-                        impld.target_ty(db).as_adt().map(|adt| adt.into())\n+                        impld.self_ty(db).as_adt().map(|adt| adt.into())\n                     }\n                 })\n                 .unwrap_or_else(|| f.clone().into()),"}, {"sha": "7e35a1450e3a9007350e72d1cca19f9e824deb5d", "filename": "crates/ide/src/hover.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/fd7c454d516e3af90d8c0d0d8a22655345fec2d7/crates%2Fide%2Fsrc%2Fhover.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd7c454d516e3af90d8c0d0d8a22655345fec2d7/crates%2Fide%2Fsrc%2Fhover.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fhover.rs?ref=fd7c454d516e3af90d8c0d0d8a22655345fec2d7", "patch": "@@ -195,7 +195,7 @@ fn show_implementations_action(db: &RootDatabase, def: Definition) -> Option<Hov\n     let adt = match def {\n         Definition::ModuleDef(ModuleDef::Trait(it)) => return it.try_to_nav(db).map(to_action),\n         Definition::ModuleDef(ModuleDef::Adt(it)) => Some(it),\n-        Definition::SelfType(it) => it.target_ty(db).as_adt(),\n+        Definition::SelfType(it) => it.self_ty(db).as_adt(),\n         _ => None,\n     }?;\n     adt.try_to_nav(db).map(to_action)\n@@ -318,7 +318,7 @@ fn definition_owner_name(db: &RootDatabase, def: &Definition) -> Option<String>\n         Definition::ModuleDef(md) => match md {\n             ModuleDef::Function(f) => match f.as_assoc_item(db)?.container(db) {\n                 AssocItemContainer::Trait(t) => Some(t.name(db)),\n-                AssocItemContainer::Impl(i) => i.target_ty(db).as_adt().map(|adt| adt.name(db)),\n+                AssocItemContainer::Impl(i) => i.self_ty(db).as_adt().map(|adt| adt.name(db)),\n             },\n             ModuleDef::Variant(e) => Some(e.parent_enum(db).name(db)),\n             _ => None,\n@@ -376,7 +376,7 @@ fn hover_for_definition(\n         },\n         Definition::Local(it) => hover_for_local(it, db),\n         Definition::SelfType(impl_def) => {\n-            impl_def.target_ty(db).as_adt().and_then(|adt| from_hir_fmt(db, adt, mod_path))\n+            impl_def.self_ty(db).as_adt().and_then(|adt| from_hir_fmt(db, adt, mod_path))\n         }\n         Definition::GenericParam(it) => from_hir_fmt(db, it, None),\n         Definition::Label(it) => Some(Markup::fenced_block(&it.name(db))),"}, {"sha": "98456967a321968c53556eece398cbcf3549ffa6", "filename": "crates/ide/src/references/rename.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/fd7c454d516e3af90d8c0d0d8a22655345fec2d7/crates%2Fide%2Fsrc%2Freferences%2Frename.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd7c454d516e3af90d8c0d0d8a22655345fec2d7/crates%2Fide%2Fsrc%2Freferences%2Frename.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Freferences%2Frename.rs?ref=fd7c454d516e3af90d8c0d0d8a22655345fec2d7", "patch": "@@ -307,7 +307,7 @@ fn rename_to_self(sema: &Semantics<RootDatabase>, local: hir::Local) -> RenameRe\n         hir::AssocItemContainer::Impl(impl_) => impl_,\n     };\n     let first_param_ty = first_param.ty();\n-    let impl_ty = impl_.target_ty(sema.db);\n+    let impl_ty = impl_.self_ty(sema.db);\n     let (ty, self_param) = if impl_ty.remove_ref().is_some() {\n         // if the impl is a ref to the type we can just match the `&T` with self directly\n         (first_param_ty.clone(), \"self\")"}, {"sha": "11bd385bb992a99f2c63a4950e9402659ebaef83", "filename": "crates/ide/src/runnables.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/fd7c454d516e3af90d8c0d0d8a22655345fec2d7/crates%2Fide%2Fsrc%2Frunnables.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd7c454d516e3af90d8c0d0d8a22655345fec2d7/crates%2Fide%2Fsrc%2Frunnables.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Frunnables.rs?ref=fd7c454d516e3af90d8c0d0d8a22655345fec2d7", "patch": "@@ -298,7 +298,7 @@ fn module_def_doctest(sema: &Semantics<RootDatabase>, def: hir::ModuleDef) -> Op\n             // FIXME: this also looks very wrong\n             if let Some(assoc_def) = assoc_def {\n                 if let hir::AssocItemContainer::Impl(imp) = assoc_def.container(sema.db) {\n-                    let ty = imp.target_ty(sema.db);\n+                    let ty = imp.self_ty(sema.db);\n                     if let Some(adt) = ty.as_adt() {\n                         let name = adt.name(sema.db);\n                         let idx = path.rfind(':').map_or(0, |idx| idx + 1);"}, {"sha": "dc14552d603091f87a530974cef5147a814d5737", "filename": "crates/ide_assists/src/handlers/generate_default_from_new.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/fd7c454d516e3af90d8c0d0d8a22655345fec2d7/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fgenerate_default_from_new.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd7c454d516e3af90d8c0d0d8a22655345fec2d7/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fgenerate_default_from_new.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fgenerate_default_from_new.rs?ref=fd7c454d516e3af90d8c0d0d8a22655345fec2d7", "patch": "@@ -92,7 +92,7 @@ fn is_default_implemented(ctx: &AssistContext, impl_: &Impl) -> bool {\n         None => return false,\n     };\n \n-    let ty = impl_def.target_ty(db);\n+    let ty = impl_def.self_ty(db);\n     let krate = impl_def.module(db).krate();\n     let default = FamousDefs(&ctx.sema, Some(krate)).core_default_Default();\n     let default_trait = match default {"}, {"sha": "910010a044fc9bd85b29723f0bae868ca5d8079e", "filename": "crates/ide_assists/src/handlers/generate_is_empty_from_len.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/fd7c454d516e3af90d8c0d0d8a22655345fec2d7/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fgenerate_is_empty_from_len.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd7c454d516e3af90d8c0d0d8a22655345fec2d7/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fgenerate_is_empty_from_len.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fgenerate_is_empty_from_len.rs?ref=fd7c454d516e3af90d8c0d0d8a22655345fec2d7", "patch": "@@ -91,7 +91,7 @@ fn get_impl_method(\n \n     let scope = ctx.sema.scope(impl_.syntax());\n     let krate = impl_def.module(db).krate();\n-    let ty = impl_def.target_ty(db);\n+    let ty = impl_def.self_ty(db);\n     let traits_in_scope = scope.traits_in_scope();\n     ty.iterate_method_candidates(db, krate, &traits_in_scope, Some(fn_name), |_, func| Some(func))\n }"}, {"sha": "d67524937e60b6f85e6634a656139385dda6c053", "filename": "crates/ide_assists/src/utils.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/fd7c454d516e3af90d8c0d0d8a22655345fec2d7/crates%2Fide_assists%2Fsrc%2Futils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd7c454d516e3af90d8c0d0d8a22655345fec2d7/crates%2Fide_assists%2Fsrc%2Futils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_assists%2Fsrc%2Futils.rs?ref=fd7c454d516e3af90d8c0d0d8a22655345fec2d7", "patch": "@@ -338,11 +338,11 @@ pub(crate) fn find_struct_impl(\n         // (we currently use the wrong type parameter)\n         // also we wouldn't want to use e.g. `impl S<u32>`\n \n-        let same_ty = match blk.target_ty(db).as_adt() {\n+        let same_ty = match blk.self_ty(db).as_adt() {\n             Some(def) => def == struct_def,\n             None => false,\n         };\n-        let not_trait_impl = blk.target_trait(db).is_none();\n+        let not_trait_impl = blk.trait_(db).is_none();\n \n         if !(same_ty && not_trait_impl) {\n             None"}, {"sha": "e2994eed4fff17fc0e26c967f5a149e08c9c6d25", "filename": "crates/ide_completion/src/completions.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/fd7c454d516e3af90d8c0d0d8a22655345fec2d7/crates%2Fide_completion%2Fsrc%2Fcompletions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd7c454d516e3af90d8c0d0d8a22655345fec2d7/crates%2Fide_completion%2Fsrc%2Fcompletions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Fcompletions.rs?ref=fd7c454d516e3af90d8c0d0d8a22655345fec2d7", "patch": "@@ -220,7 +220,7 @@ fn complete_enum_variants(\n         };\n \n         if let Some(impl_) = ctx.impl_def.as_ref().and_then(|impl_| ctx.sema.to_def(impl_)) {\n-            if impl_.target_ty(ctx.db) == *ty {\n+            if impl_.self_ty(ctx.db) == *ty {\n                 for &variant in &variants {\n                     let self_path = hir::ModPath::from_segments(\n                         hir::PathKind::Plain,"}, {"sha": "808d7ff7e66c47e55124c3b11b95b99223bbe507", "filename": "crates/ide_completion/src/completions/pattern.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/fd7c454d516e3af90d8c0d0d8a22655345fec2d7/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fpattern.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd7c454d516e3af90d8c0d0d8a22655345fec2d7/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fpattern.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fpattern.rs?ref=fd7c454d516e3af90d8c0d0d8a22655345fec2d7", "patch": "@@ -40,7 +40,7 @@ pub(crate) fn complete_pattern(acc: &mut Completions, ctx: &CompletionContext) {\n                 _ => false,\n             },\n             hir::ScopeDef::MacroDef(_) => true,\n-            hir::ScopeDef::ImplSelfType(impl_) => match impl_.target_ty(ctx.db).as_adt() {\n+            hir::ScopeDef::ImplSelfType(impl_) => match impl_.self_ty(ctx.db).as_adt() {\n                 Some(hir::Adt::Struct(strukt)) => {\n                     acc.add_struct_pat(ctx, strukt, Some(name.clone()));\n                     true"}, {"sha": "1891eb5b36509f7c98a034920e2d8bae8acc8f86", "filename": "crates/ide_completion/src/completions/qualified_path.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/fd7c454d516e3af90d8c0d0d8a22655345fec2d7/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fqualified_path.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd7c454d516e3af90d8c0d0d8a22655345fec2d7/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fqualified_path.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Fcompletions%2Fqualified_path.rs?ref=fd7c454d516e3af90d8c0d0d8a22655345fec2d7", "patch": "@@ -117,7 +117,7 @@ pub(crate) fn complete_qualified_path(acc: &mut Completions, ctx: &CompletionCon\n             if let Some(krate) = ctx.krate {\n                 let ty = match resolution {\n                     PathResolution::TypeParam(param) => param.ty(ctx.db),\n-                    PathResolution::SelfType(impl_def) => impl_def.target_ty(ctx.db),\n+                    PathResolution::SelfType(impl_def) => impl_def.self_ty(ctx.db),\n                     _ => return,\n                 };\n "}, {"sha": "8ce648367116c1f3da30797ff517986cd4962a7b", "filename": "crates/ide_db/src/helpers/import_assets.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/fd7c454d516e3af90d8c0d0d8a22655345fec2d7/crates%2Fide_db%2Fsrc%2Fhelpers%2Fimport_assets.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd7c454d516e3af90d8c0d0d8a22655345fec2d7/crates%2Fide_db%2Fsrc%2Fhelpers%2Fimport_assets.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_db%2Fsrc%2Fhelpers%2Fimport_assets.rs?ref=fd7c454d516e3af90d8c0d0d8a22655345fec2d7", "patch": "@@ -361,7 +361,7 @@ fn item_for_path_search(db: &RootDatabase, item: ItemInNs) -> Option<ItemInNs> {\n             Some(assoc_item) => match assoc_item.container(db) {\n                 AssocItemContainer::Trait(trait_) => ItemInNs::from(ModuleDef::from(trait_)),\n                 AssocItemContainer::Impl(impl_) => {\n-                    ItemInNs::from(ModuleDef::from(impl_.target_ty(db).as_adt()?))\n+                    ItemInNs::from(ModuleDef::from(impl_.self_ty(db).as_adt()?))\n                 }\n             },\n             None => item,"}]}