{"sha": "7baf68b0bdf38baeba482075b12fc50f9ff51d13", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdiYWY2OGIwYmRmMzhiYWViYTQ4MjA3NWIxMmZjNTBmOWZmNTFkMTM=", "commit": {"author": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2011-11-09T19:01:12Z"}, "committer": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2011-11-10T04:05:49Z"}, "message": "hack around the problem that x86_64 expects first few args in regs.\ncall on c-stack expects all data to be delivered on the stack.", "tree": {"sha": "ffae4e33bb1abf753c14a3a20081bbb50a56f382", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ffae4e33bb1abf753c14a3a20081bbb50a56f382"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7baf68b0bdf38baeba482075b12fc50f9ff51d13", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7baf68b0bdf38baeba482075b12fc50f9ff51d13", "html_url": "https://github.com/rust-lang/rust/commit/7baf68b0bdf38baeba482075b12fc50f9ff51d13", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7baf68b0bdf38baeba482075b12fc50f9ff51d13/comments", "author": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fc064f441026f2f34417925a26c1f6d73a7faf2c", "url": "https://api.github.com/repos/rust-lang/rust/commits/fc064f441026f2f34417925a26c1f6d73a7faf2c", "html_url": "https://github.com/rust-lang/rust/commit/fc064f441026f2f34417925a26c1f6d73a7faf2c"}], "stats": {"total": 41, "additions": 38, "deletions": 3}, "files": [{"sha": "d9221067175f0f44290459f39cbcfd0785da9f4c", "filename": "src/rt/arch/x86_64/ccall.S", "status": "modified", "additions": 32, "deletions": 3, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/7baf68b0bdf38baeba482075b12fc50f9ff51d13/src%2Frt%2Farch%2Fx86_64%2Fccall.S", "raw_url": "https://github.com/rust-lang/rust/raw/7baf68b0bdf38baeba482075b12fc50f9ff51d13/src%2Frt%2Farch%2Fx86_64%2Fccall.S", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Farch%2Fx86_64%2Fccall.S?ref=7baf68b0bdf38baeba482075b12fc50f9ff51d13", "patch": "@@ -1,4 +1,9 @@\n-    .text\n+#include \"regs.h\"\n+\n+#define ARG0 RUSTRT_ARG0_S\n+#define ARG1 RUSTRT_ARG1_S\n+        \n+        .text\n \n // upcall_call_c_stack(void (*fn)(), void *new_esp)\n //\n@@ -21,8 +26,32 @@ upcall_call_c_stack_float:\n #endif\n     push %rbp\n     mov %rsp,%rbp          // save rsp\n-    mov %rsi,%rsp          // switch stack\n-    call *%rdi\n+    mov ARG1,%rsp          // switch stack\n+\n+    // Hack: the arguments to the function are sitting\n+    // on the stack right now, as in i386 calling\n+    // convention.  We need them in registers.\n+    // For now, we just load them into registers.\n+    //\n+    // This is a total hack because it does not consider\n+    // the actual arguments of the target function.\n+    // It fails if there are non-INTEGER class arguments,\n+    // which would get pushed on the stack, or if there are\n+    // additional arguments beyond those that will get\n+    // passed in registers.\n+    mov ARG0,%r11     // Remember target address\n+    mov  0(%rsp),RUSTRT_ARG0_S\n+    mov  8(%rsp),RUSTRT_ARG1_S\n+    mov 16(%rsp),RUSTRT_ARG2_S\n+    mov 24(%rsp),RUSTRT_ARG3_S\n+#   ifdef RUSTRT_ARG4_S        \n+    mov 32(%rsp),RUSTRT_ARG4_S\n+#   endif\n+#   ifdef RUSTRT_ARG5_S        \n+    mov 40(%rsp),RUSTRT_ARG5_S\n+#   endif\n+        \n+    call *%r11\n     mov %rbp,%rsp          // would like to use \"leave\" but it's slower\n     pop %rbp\n     ret"}, {"sha": "5ebcdf7429b36206e5c2c8becfc4f5b3843c0f3e", "filename": "src/rt/arch/x86_64/regs.h", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/7baf68b0bdf38baeba482075b12fc50f9ff51d13/src%2Frt%2Farch%2Fx86_64%2Fregs.h", "raw_url": "https://github.com/rust-lang/rust/raw/7baf68b0bdf38baeba482075b12fc50f9ff51d13/src%2Frt%2Farch%2Fx86_64%2Fregs.h", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Farch%2Fx86_64%2Fregs.h?ref=7baf68b0bdf38baeba482075b12fc50f9ff51d13", "patch": "@@ -21,9 +21,15 @@\n #if defined(__MINGW32__) || defined(_WINDOWS)\n #   define RUSTRT_ARG0_S %rcx\n #   define RUSTRT_ARG1_S %rdx\n+#   define RUSTRT_ARG2_S %r8\n+#   define RUSTRT_ARG3_S %r9\n #else\n #   define RUSTRT_ARG0_S %rdi\n #   define RUSTRT_ARG1_S %rsi\n+#   define RUSTRT_ARG2_S %rdx\n+#   define RUSTRT_ARG3_S %rcx\n+#   define RUSTRT_ARG4_S %r8\n+#   define RUSTRT_ARG5_S %r9\n #endif\n \n "}]}