{"sha": "6fca1a925985105e4393bbca227f868ee2de5c96", "node_id": "C_kwDOAAsO6NoAKDZmY2ExYTkyNTk4NTEwNWU0MzkzYmJjYTIyN2Y4NjhlZTJkZTVjOTY", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-05-04T06:09:03Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-05-04T06:09:03Z"}, "message": "Rollup merge of #110859 - compiler-errors:no-negative-drop-impls, r=oli-obk\n\nExplicitly reject negative and reservation drop impls\n\nFixes #110858\n\nIt doesn't really make sense for a type to have a `!Drop` impl. Or at least, I don't want us to implicitly assign a meaning to it by the way the compiler *currently* handles it (incompletely), and rather I would like to see a PR (or an RFC...) assign a meaning to `!Drop` if we actually wanted one for it.", "tree": {"sha": "a17338ec1a8a911d960a26804f7bd912ca9ba378", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a17338ec1a8a911d960a26804f7bd912ca9ba378"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6fca1a925985105e4393bbca227f868ee2de5c96", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkU0v/CRBK7hj4Ov3rIwAAlnEIAIrqSiUKyaDuPmrSMjpl/7UC\nmoRN3dv6035jevHFE17gX9TQaJYSiap66Qx6eoZKaThg2QQcQPPxg6djwVxOY7LD\nKRYMoIlzLVSi/FjX0UvBGmjsmgSXr8D+8ez/biA2zgZMPyG4UvQsy0P2DzbbhY8y\ndCuegZxw6krD3SszsZgCCyTwcPR4sE5t7+zAXCDm6zlVoGdX0okjesfYEpSCs/uW\nO3WfmhFRLjG5LU4Npfj0dFcecFzr8f3sOosZGGz2QZ1c2UoMaQKe1LkDWNVuDaeO\nrSRF6i7dSqnRueICpWgB0NAgCcfR36xhIF8kxeKNS7jAjFSrb94jmZLFutgVmOk=\n=d682\n-----END PGP SIGNATURE-----\n", "payload": "tree a17338ec1a8a911d960a26804f7bd912ca9ba378\nparent 129195f57c02c8a8e4cfc4b766d4ff7a3a837882\nparent bd146c72ac2faf6bbf189ad92d06e0bcd6cc92fc\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1683180543 +0200\ncommitter GitHub <noreply@github.com> 1683180543 +0200\n\nRollup merge of #110859 - compiler-errors:no-negative-drop-impls, r=oli-obk\n\nExplicitly reject negative and reservation drop impls\n\nFixes #110858\n\nIt doesn't really make sense for a type to have a `!Drop` impl. Or at least, I don't want us to implicitly assign a meaning to it by the way the compiler *currently* handles it (incompletely), and rather I would like to see a PR (or an RFC...) assign a meaning to `!Drop` if we actually wanted one for it.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6fca1a925985105e4393bbca227f868ee2de5c96", "html_url": "https://github.com/rust-lang/rust/commit/6fca1a925985105e4393bbca227f868ee2de5c96", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6fca1a925985105e4393bbca227f868ee2de5c96/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "129195f57c02c8a8e4cfc4b766d4ff7a3a837882", "url": "https://api.github.com/repos/rust-lang/rust/commits/129195f57c02c8a8e4cfc4b766d4ff7a3a837882", "html_url": "https://github.com/rust-lang/rust/commit/129195f57c02c8a8e4cfc4b766d4ff7a3a837882"}, {"sha": "bd146c72ac2faf6bbf189ad92d06e0bcd6cc92fc", "url": "https://api.github.com/repos/rust-lang/rust/commits/bd146c72ac2faf6bbf189ad92d06e0bcd6cc92fc", "html_url": "https://github.com/rust-lang/rust/commit/bd146c72ac2faf6bbf189ad92d06e0bcd6cc92fc"}], "stats": {"total": 102, "additions": 74, "deletions": 28}, "files": [{"sha": "eaa75bde6c6c4ea104ef2dcc62655872a54ac459", "filename": "compiler/rustc_hir_analysis/messages.ftl", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/6fca1a925985105e4393bbca227f868ee2de5c96/compiler%2Frustc_hir_analysis%2Fmessages.ftl", "raw_url": "https://github.com/rust-lang/rust/raw/6fca1a925985105e4393bbca227f868ee2de5c96/compiler%2Frustc_hir_analysis%2Fmessages.ftl", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_analysis%2Fmessages.ftl?ref=6fca1a925985105e4393bbca227f868ee2de5c96", "patch": "@@ -280,3 +280,7 @@ hir_analysis_const_specialize = cannot specialize on const impl with non-const i\n hir_analysis_static_specialize = cannot specialize on `'static` lifetime\n \n hir_analysis_missing_tilde_const = missing `~const` qualifier for specialization\n+\n+hir_analysis_drop_impl_negative = negative `Drop` impls are not supported\n+\n+hir_analysis_drop_impl_reservation = reservation `Drop` impls are not supported"}, {"sha": "bae80807f71b90c74672b129b8ad1b34138f1eb2", "filename": "compiler/rustc_hir_analysis/src/check/dropck.rs", "status": "modified", "additions": 16, "deletions": 1, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/6fca1a925985105e4393bbca227f868ee2de5c96/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fdropck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6fca1a925985105e4393bbca227f868ee2de5c96/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fdropck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fdropck.rs?ref=6fca1a925985105e4393bbca227f868ee2de5c96", "patch": "@@ -1,14 +1,16 @@\n // FIXME(@lcnr): Move this module out of `rustc_hir_analysis`.\n //\n // We don't do any drop checking during hir typeck.\n-use crate::hir::def_id::{DefId, LocalDefId};\n use rustc_errors::{struct_span_err, ErrorGuaranteed};\n use rustc_middle::ty::error::TypeError;\n use rustc_middle::ty::relate::{Relate, RelateResult, TypeRelation};\n use rustc_middle::ty::subst::SubstsRef;\n use rustc_middle::ty::util::IgnoreRegions;\n use rustc_middle::ty::{self, Predicate, Ty, TyCtxt};\n \n+use crate::errors;\n+use crate::hir::def_id::{DefId, LocalDefId};\n+\n /// This function confirms that the `Drop` implementation identified by\n /// `drop_impl_did` is not any more specialized than the type it is\n /// attached to (Issue #8142).\n@@ -27,6 +29,19 @@ use rustc_middle::ty::{self, Predicate, Ty, TyCtxt};\n ///    cannot do `struct S<T>; impl<T:Clone> Drop for S<T> { ... }`).\n ///\n pub fn check_drop_impl(tcx: TyCtxt<'_>, drop_impl_did: DefId) -> Result<(), ErrorGuaranteed> {\n+    match tcx.impl_polarity(drop_impl_did) {\n+        ty::ImplPolarity::Positive => {}\n+        ty::ImplPolarity::Negative => {\n+            return Err(tcx.sess.emit_err(errors::DropImplPolarity::Negative {\n+                span: tcx.def_span(drop_impl_did),\n+            }));\n+        }\n+        ty::ImplPolarity::Reservation => {\n+            return Err(tcx.sess.emit_err(errors::DropImplPolarity::Reservation {\n+                span: tcx.def_span(drop_impl_did),\n+            }));\n+        }\n+    }\n     let dtor_self_type = tcx.type_of(drop_impl_did).subst_identity();\n     let dtor_predicates = tcx.predicates_of(drop_impl_did);\n     match dtor_self_type.kind() {"}, {"sha": "c0ee777722e73c431dfcb65364ffd6eaa6f5f289", "filename": "compiler/rustc_hir_analysis/src/errors.rs", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/6fca1a925985105e4393bbca227f868ee2de5c96/compiler%2Frustc_hir_analysis%2Fsrc%2Ferrors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6fca1a925985105e4393bbca227f868ee2de5c96/compiler%2Frustc_hir_analysis%2Fsrc%2Ferrors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_analysis%2Fsrc%2Ferrors.rs?ref=6fca1a925985105e4393bbca227f868ee2de5c96", "patch": "@@ -823,3 +823,17 @@ pub(crate) struct MissingTildeConst {\n     #[primary_span]\n     pub span: Span,\n }\n+\n+#[derive(Diagnostic)]\n+pub(crate) enum DropImplPolarity {\n+    #[diag(hir_analysis_drop_impl_negative)]\n+    Negative {\n+        #[primary_span]\n+        span: Span,\n+    },\n+    #[diag(hir_analysis_drop_impl_reservation)]\n+    Reservation {\n+        #[primary_span]\n+        span: Span,\n+    },\n+}"}, {"sha": "e5b2d342452f33a5edd59a0933af3c1711e39bb3", "filename": "compiler/rustc_middle/src/ty/util.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/6fca1a925985105e4393bbca227f868ee2de5c96/compiler%2Frustc_middle%2Fsrc%2Fty%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6fca1a925985105e4393bbca227f868ee2de5c96/compiler%2Frustc_middle%2Fsrc%2Fty%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Futil.rs?ref=6fca1a925985105e4393bbca227f868ee2de5c96", "patch": "@@ -360,16 +360,16 @@ impl<'tcx> TyCtxt<'tcx> {\n         let ty = self.type_of(adt_did).subst_identity();\n         let mut dtor_candidate = None;\n         self.for_each_relevant_impl(drop_trait, ty, |impl_did| {\n-            let Some(item_id) = self.associated_item_def_ids(impl_did).first() else {\n-                self.sess.delay_span_bug(self.def_span(impl_did), \"Drop impl without drop function\");\n-                return;\n-            };\n-\n             if validate(self, impl_did).is_err() {\n                 // Already `ErrorGuaranteed`, no need to delay a span bug here.\n                 return;\n             }\n \n+            let Some(item_id) = self.associated_item_def_ids(impl_did).first() else {\n+                self.sess.delay_span_bug(self.def_span(impl_did), \"Drop impl without drop function\");\n+                return;\n+            };\n+\n             if let Some((old_item_id, _)) = dtor_candidate {\n                 self.sess\n                     .struct_span_err(self.def_span(item_id), \"multiple drop impls found\")"}, {"sha": "3704a1a5a392c0113b0a29827aa2a62bb4768feb", "filename": "tests/ui/consts/const-block-const-bound.rs", "status": "modified", "additions": 0, "deletions": 6, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/6fca1a925985105e4393bbca227f868ee2de5c96/tests%2Fui%2Fconsts%2Fconst-block-const-bound.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6fca1a925985105e4393bbca227f868ee2de5c96/tests%2Fui%2Fconsts%2Fconst-block-const-bound.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fconsts%2Fconst-block-const-bound.rs?ref=6fca1a925985105e4393bbca227f868ee2de5c96", "patch": "@@ -11,15 +11,9 @@ impl Drop for UnconstDrop {\n     fn drop(&mut self) {}\n }\n \n-struct NonDrop;\n-\n-impl !Drop for NonDrop {}\n-\n fn main() {\n     const {\n         f(UnconstDrop);\n         //~^ ERROR can't drop\n-        f(NonDrop);\n-        //~^ ERROR can't drop\n     }\n }"}, {"sha": "caf24e7afcf456d4ad1bc8d499771c9fdcfde4ab", "filename": "tests/ui/consts/const-block-const-bound.stderr", "status": "modified", "additions": 2, "deletions": 16, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/6fca1a925985105e4393bbca227f868ee2de5c96/tests%2Fui%2Fconsts%2Fconst-block-const-bound.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/6fca1a925985105e4393bbca227f868ee2de5c96/tests%2Fui%2Fconsts%2Fconst-block-const-bound.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fconsts%2Fconst-block-const-bound.stderr?ref=6fca1a925985105e4393bbca227f868ee2de5c96", "patch": "@@ -1,5 +1,5 @@\n error[E0277]: can't drop `UnconstDrop` in const contexts\n-  --> $DIR/const-block-const-bound.rs:20:9\n+  --> $DIR/const-block-const-bound.rs:16:9\n    |\n LL |         f(UnconstDrop);\n    |         ^^^^^^^^^^^^^^ the trait `~const Destruct` is not implemented for `UnconstDrop`\n@@ -12,20 +12,6 @@ LL |         &f(UnconstDrop);\n LL |         &mut f(UnconstDrop);\n    |         ++++\n \n-error[E0277]: can't drop `NonDrop` in const contexts\n-  --> $DIR/const-block-const-bound.rs:22:9\n-   |\n-LL |         f(NonDrop);\n-   |         ^^^^^^^^^^ the trait `~const Destruct` is not implemented for `NonDrop`\n-   |\n-   = note: the trait bound `NonDrop: ~const Destruct` is not satisfied\n-help: consider borrowing here\n-   |\n-LL |         &f(NonDrop);\n-   |         +\n-LL |         &mut f(NonDrop);\n-   |         ++++\n-\n-error: aborting due to 2 previous errors\n+error: aborting due to previous error\n \n For more information about this error, try `rustc --explain E0277`."}, {"sha": "ae63632b55efd6caf225d42eb36396ab7a250e6b", "filename": "tests/ui/dropck/negative.rs", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/6fca1a925985105e4393bbca227f868ee2de5c96/tests%2Fui%2Fdropck%2Fnegative.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6fca1a925985105e4393bbca227f868ee2de5c96/tests%2Fui%2Fdropck%2Fnegative.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fdropck%2Fnegative.rs?ref=6fca1a925985105e4393bbca227f868ee2de5c96", "patch": "@@ -0,0 +1,7 @@\n+#![feature(negative_impls)]\n+\n+struct NonDrop;\n+impl !Drop for NonDrop {}\n+//~^ ERROR negative `Drop` impls are not supported\n+\n+fn main() {}"}, {"sha": "d613e30b5ea59f5e835d1919b29b8cfc6252f6a2", "filename": "tests/ui/dropck/negative.stderr", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/6fca1a925985105e4393bbca227f868ee2de5c96/tests%2Fui%2Fdropck%2Fnegative.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/6fca1a925985105e4393bbca227f868ee2de5c96/tests%2Fui%2Fdropck%2Fnegative.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fdropck%2Fnegative.stderr?ref=6fca1a925985105e4393bbca227f868ee2de5c96", "patch": "@@ -0,0 +1,8 @@\n+error: negative `Drop` impls are not supported\n+  --> $DIR/negative.rs:4:1\n+   |\n+LL | impl !Drop for NonDrop {}\n+   | ^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: aborting due to previous error\n+"}, {"sha": "f7199d4ec44074d63c02aaf3e228e9f31f2746ea", "filename": "tests/ui/dropck/reservation.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/6fca1a925985105e4393bbca227f868ee2de5c96/tests%2Fui%2Fdropck%2Freservation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6fca1a925985105e4393bbca227f868ee2de5c96/tests%2Fui%2Fdropck%2Freservation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fdropck%2Freservation.rs?ref=6fca1a925985105e4393bbca227f868ee2de5c96", "patch": "@@ -0,0 +1,10 @@\n+#![feature(rustc_attrs)]\n+\n+struct ReservedDrop;\n+#[rustc_reservation_impl = \"message\"]\n+impl Drop for ReservedDrop {\n+//~^ ERROR reservation `Drop` impls are not supported\n+    fn drop(&mut self) {}\n+}\n+\n+fn main() {}"}, {"sha": "19325d6ed4401775a382d95443c465453495e958", "filename": "tests/ui/dropck/reservation.stderr", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/6fca1a925985105e4393bbca227f868ee2de5c96/tests%2Fui%2Fdropck%2Freservation.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/6fca1a925985105e4393bbca227f868ee2de5c96/tests%2Fui%2Fdropck%2Freservation.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fdropck%2Freservation.stderr?ref=6fca1a925985105e4393bbca227f868ee2de5c96", "patch": "@@ -0,0 +1,8 @@\n+error: reservation `Drop` impls are not supported\n+  --> $DIR/reservation.rs:5:1\n+   |\n+LL | impl Drop for ReservedDrop {\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: aborting due to previous error\n+"}]}