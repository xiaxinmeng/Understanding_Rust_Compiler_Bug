{"sha": "54ef80043a3864495555c96791118ab3a725fe6b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU0ZWY4MDA0M2EzODY0NDk1NTU1Yzk2NzkxMTE4YWIzYTcyNWZlNmI=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-04-27T02:48:17Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-04-27T02:48:17Z"}, "message": "Auto merge of #37860 - giannicic:defaultimpl, r=nagisa\n\n#37653 support `default impl` for specialization\n\nthis commit implements the first step of the `default impl` feature:\n\n> all items in a `default impl` are (implicitly) `default` and hence\n> specializable.\n\nIn order to test this feature I've copied all the tests provided for the\n`default` method implementation (in run-pass/specialization and\ncompile-fail/specialization directories) and moved the `default` keyword\nfrom the item to the impl.\nSee [referenced](https://github.com/rust-lang/rust/issues/37653) issue for further info\n\nr? @aturon", "tree": {"sha": "4e19eb056c15ad2bebc60e937f2b1381078c56c9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4e19eb056c15ad2bebc60e937f2b1381078c56c9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/54ef80043a3864495555c96791118ab3a725fe6b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/54ef80043a3864495555c96791118ab3a725fe6b", "html_url": "https://github.com/rust-lang/rust/commit/54ef80043a3864495555c96791118ab3a725fe6b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/54ef80043a3864495555c96791118ab3a725fe6b/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6e0c5af9de7727074af21735bdc9197cb9f1ff49", "url": "https://api.github.com/repos/rust-lang/rust/commits/6e0c5af9de7727074af21735bdc9197cb9f1ff49", "html_url": "https://github.com/rust-lang/rust/commit/6e0c5af9de7727074af21735bdc9197cb9f1ff49"}, {"sha": "b48eb5e0be2a6e06d9629f770288c46f7bcb326c", "url": "https://api.github.com/repos/rust-lang/rust/commits/b48eb5e0be2a6e06d9629f770288c46f7bcb326c", "html_url": "https://github.com/rust-lang/rust/commit/b48eb5e0be2a6e06d9629f770288c46f7bcb326c"}], "stats": {"total": 1265, "additions": 1222, "deletions": 43}, "files": [{"sha": "c9fcdf7647b9cfa79e42164ca858d728a7685dd7", "filename": "src/grammar/parser-lalr.y", "status": "modified", "additions": 14, "deletions": 7, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Fgrammar%2Fparser-lalr.y", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Fgrammar%2Fparser-lalr.y", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fgrammar%2Fparser-lalr.y?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -89,6 +89,7 @@ extern char *yytext;\n %token TRAIT\n %token TYPE\n %token UNSAFE\n+%token DEFAULT\n %token USE\n %token WHILE\n %token CONTINUE\n@@ -534,6 +535,12 @@ maybe_unsafe\n | %empty { $$ = mk_none(); }\n ;\n \n+maybe_default_maybe_unsafe\n+: DEFAULT UNSAFE { $$ = mk_atom(\"DefaultUnsafe\"); }\n+| DEFAULT        { $$ = mk_atom(\"Default\"); }\n+|         UNSAFE { $$ = mk_atom(\"Unsafe\"); }\n+| %empty { $$ = mk_none(); }\n+\n trait_method\n : type_method { $$ = mk_node(\"Required\", 1, $1); }\n | method      { $$ = mk_node(\"Provided\", 1, $1); }\n@@ -588,27 +595,27 @@ impl_method\n // they are ambiguous with traits. We do the same here, regrettably,\n // by splitting ty into ty and ty_prim.\n item_impl\n-: maybe_unsafe IMPL generic_params ty_prim_sum maybe_where_clause '{' maybe_inner_attrs maybe_impl_items '}'\n+: maybe_default_maybe_unsafe IMPL generic_params ty_prim_sum maybe_where_clause '{' maybe_inner_attrs maybe_impl_items '}'\n {\n   $$ = mk_node(\"ItemImpl\", 6, $1, $3, $4, $5, $7, $8);\n }\n-| maybe_unsafe IMPL generic_params '(' ty ')' maybe_where_clause '{' maybe_inner_attrs maybe_impl_items '}'\n+| maybe_default_maybe_unsafe IMPL generic_params '(' ty ')' maybe_where_clause '{' maybe_inner_attrs maybe_impl_items '}'\n {\n   $$ = mk_node(\"ItemImpl\", 6, $1, $3, 5, $6, $9, $10);\n }\n-| maybe_unsafe IMPL generic_params trait_ref FOR ty_sum maybe_where_clause '{' maybe_inner_attrs maybe_impl_items '}'\n+| maybe_default_maybe_unsafe IMPL generic_params trait_ref FOR ty_sum maybe_where_clause '{' maybe_inner_attrs maybe_impl_items '}'\n {\n   $$ = mk_node(\"ItemImpl\", 6, $3, $4, $6, $7, $9, $10);\n }\n-| maybe_unsafe IMPL generic_params '!' trait_ref FOR ty_sum maybe_where_clause '{' maybe_inner_attrs maybe_impl_items '}'\n+| maybe_default_maybe_unsafe IMPL generic_params '!' trait_ref FOR ty_sum maybe_where_clause '{' maybe_inner_attrs maybe_impl_items '}'\n {\n   $$ = mk_node(\"ItemImplNeg\", 7, $1, $3, $5, $7, $8, $10, $11);\n }\n-| maybe_unsafe IMPL generic_params trait_ref FOR DOTDOT '{' '}'\n+| maybe_default_maybe_unsafe IMPL generic_params trait_ref FOR DOTDOT '{' '}'\n {\n   $$ = mk_node(\"ItemImplDefault\", 3, $1, $3, $4);\n }\n-| maybe_unsafe IMPL generic_params '!' trait_ref FOR DOTDOT '{' '}'\n+| maybe_default_maybe_unsafe IMPL generic_params '!' trait_ref FOR DOTDOT '{' '}'\n {\n   $$ = mk_node(\"ItemImplDefaultNeg\", 3, $1, $3, $4);\n }\n@@ -1935,4 +1942,4 @@ brackets_delimited_token_trees\n                $2,\n                mk_node(\"TTTok\", 1, mk_atom(\"]\")));\n }\n-;\n+;\n\\ No newline at end of file"}, {"sha": "8f4dce5a78303d51d2c5850fd4fceb6af612df39", "filename": "src/librustc/hir/lowering.rs", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustc%2Fhir%2Flowering.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustc%2Fhir%2Flowering.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Flowering.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -1326,7 +1326,13 @@ impl<'a> LoweringContext<'a> {\n                 hir::ItemDefaultImpl(self.lower_unsafety(unsafety),\n                                      trait_ref)\n             }\n-            ItemKind::Impl(unsafety, polarity, ref generics, ref ifce, ref ty, ref impl_items) => {\n+            ItemKind::Impl(unsafety,\n+                           polarity,\n+                           defaultness,\n+                           ref generics,\n+                           ref ifce,\n+                           ref ty,\n+                           ref impl_items) => {\n                 let new_impl_items = impl_items.iter()\n                                                .map(|item| self.lower_impl_item_ref(item))\n                                                .collect();\n@@ -1340,6 +1346,7 @@ impl<'a> LoweringContext<'a> {\n \n                 hir::ItemImpl(self.lower_unsafety(unsafety),\n                               self.lower_impl_polarity(polarity),\n+                              self.lower_defaultness(defaultness, true /* [1] */),\n                               self.lower_generics(generics),\n                               ifce,\n                               self.lower_ty(ty),\n@@ -1355,6 +1362,9 @@ impl<'a> LoweringContext<'a> {\n             }\n             ItemKind::MacroDef(..) | ItemKind::Mac(..) => panic!(\"Shouldn't still be around\"),\n         }\n+\n+        // [1] `defaultness.has_value()` is never called for an `impl`, always `true` in order to\n+        //     not cause an assertion failure inside the `lower_defaultness` function\n     }\n \n     fn lower_trait_item(&mut self, i: &TraitItem) -> hir::TraitItem {"}, {"sha": "cb7f530b9952f779011e899b13dbde7fde04b977", "filename": "src/librustc/hir/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustc%2Fhir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustc%2Fhir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Fmod.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -1712,6 +1712,7 @@ pub enum Item_ {\n     /// An implementation, eg `impl<A> Trait for Foo { .. }`\n     ItemImpl(Unsafety,\n              ImplPolarity,\n+             Defaultness,\n              Generics,\n              Option<TraitRef>, // (optional) trait this impl implements\n              P<Ty>, // self"}, {"sha": "a78d5ce1c16d0995e38372b9f911fd80af70208b", "filename": "src/librustc/hir/print.rs", "status": "modified", "additions": 11, "deletions": 5, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustc%2Fhir%2Fprint.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustc%2Fhir%2Fprint.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Fprint.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -678,12 +678,14 @@ impl<'a> State<'a> {\n             }\n             hir::ItemImpl(unsafety,\n                           polarity,\n+                          defaultness,\n                           ref generics,\n                           ref opt_trait,\n                           ref ty,\n                           ref impl_items) => {\n                 self.head(\"\")?;\n                 self.print_visibility(&item.vis)?;\n+                self.print_defaultness(defaultness)?;\n                 self.print_unsafety(unsafety)?;\n                 self.word_nbsp(\"impl\")?;\n \n@@ -820,6 +822,14 @@ impl<'a> State<'a> {\n         }\n     }\n \n+    pub fn print_defaultness(&mut self, defaultness: hir::Defaultness) -> io::Result<()> {\n+        match defaultness {\n+            hir::Defaultness::Default { .. } => self.word_nbsp(\"default\")?,\n+            hir::Defaultness::Final => (),\n+        }\n+        Ok(())\n+    }\n+\n     pub fn print_struct(&mut self,\n                         struct_def: &hir::VariantData,\n                         generics: &hir::Generics,\n@@ -931,11 +941,7 @@ impl<'a> State<'a> {\n         self.hardbreak_if_not_bol()?;\n         self.maybe_print_comment(ii.span.lo)?;\n         self.print_outer_attributes(&ii.attrs)?;\n-\n-        match ii.defaultness {\n-            hir::Defaultness::Default { .. } => self.word_nbsp(\"default\")?,\n-            hir::Defaultness::Final => (),\n-        }\n+        self.print_defaultness(ii.defaultness)?;\n \n         match ii.node {\n             hir::ImplItemKind::Const(ref ty, expr) => {"}, {"sha": "3aeee1c1b981f4e861213579e7fa23a2f6a83641", "filename": "src/librustc/ich/impls_hir.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustc%2Fich%2Fimpls_hir.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustc%2Fich%2Fimpls_hir.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fich%2Fimpls_hir.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -933,7 +933,7 @@ impl_stable_hash_for!(enum hir::Item_ {\n     ItemUnion(variant_data, generics),\n     ItemTrait(unsafety, generics, bounds, item_refs),\n     ItemDefaultImpl(unsafety, trait_ref),\n-    ItemImpl(unsafety, impl_polarity, generics, trait_ref, ty, impl_item_refs)\n+    ItemImpl(unsafety, impl_polarity, impl_defaultness, generics, trait_ref, ty, impl_item_refs)\n });\n \n impl_stable_hash_for!(struct hir::TraitItemRef {"}, {"sha": "60171f1a4289a9afb51a97a8b04fe7894727ca00", "filename": "src/librustc/middle/cstore.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustc%2Fmiddle%2Fcstore.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustc%2Fmiddle%2Fcstore.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fcstore.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -195,6 +195,7 @@ pub trait CrateStore {\n     fn implementations_of_trait(&self, filter: Option<DefId>) -> Vec<DefId>;\n \n     // impl info\n+    fn impl_defaultness(&self, def: DefId) -> hir::Defaultness;\n     fn impl_parent(&self, impl_def_id: DefId) -> Option<DefId>;\n \n     // trait/impl-item info\n@@ -329,6 +330,7 @@ impl CrateStore for DummyCrateStore {\n     fn implementations_of_trait(&self, filter: Option<DefId>) -> Vec<DefId> { vec![] }\n \n     // impl info\n+    fn impl_defaultness(&self, def: DefId) -> hir::Defaultness { bug!(\"impl_defaultness\") }\n     fn impl_parent(&self, def: DefId) -> Option<DefId> { bug!(\"impl_parent\") }\n \n     // trait/impl-item info"}, {"sha": "939d7364d9e06bcedb839db9af70948b6342a8b8", "filename": "src/librustc/middle/reachable.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustc%2Fmiddle%2Freachable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustc%2Fmiddle%2Freachable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Freachable.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -49,7 +49,7 @@ fn item_might_be_inlined(item: &hir::Item) -> bool {\n     }\n \n     match item.node {\n-        hir::ItemImpl(_, _, ref generics, ..) |\n+        hir::ItemImpl(_, _, _, ref generics, ..) |\n         hir::ItemFn(.., ref generics, _) => {\n             generics_require_inlining(generics)\n         }\n@@ -185,7 +185,7 @@ impl<'a, 'tcx> ReachableContext<'a, 'tcx> {\n                             // does too.\n                             let impl_node_id = self.tcx.hir.as_local_node_id(impl_did).unwrap();\n                             match self.tcx.hir.expect_item(impl_node_id).node {\n-                                hir::ItemImpl(_, _, ref generics, ..) => {\n+                                hir::ItemImpl(_, _, _, ref generics, ..) => {\n                                     generics_require_inlining(generics)\n                                 }\n                                 _ => false"}, {"sha": "a8ba708cc2cd41427904d4fdb279b3a53efd2f8b", "filename": "src/librustc/middle/resolve_lifetime.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustc%2Fmiddle%2Fresolve_lifetime.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustc%2Fmiddle%2Fresolve_lifetime.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fresolve_lifetime.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -331,7 +331,7 @@ impl<'a, 'tcx> Visitor<'tcx> for LifetimeContext<'a, 'tcx> {\n             hir::ItemStruct(_, ref generics) |\n             hir::ItemUnion(_, ref generics) |\n             hir::ItemTrait(_, ref generics, ..) |\n-            hir::ItemImpl(_, _, ref generics, ..) => {\n+            hir::ItemImpl(_, _, _, ref generics, ..) => {\n                 // These kinds of items have only early bound lifetime parameters.\n                 let mut index = if let hir::ItemTrait(..) = item.node {\n                     1 // Self comes before lifetimes\n@@ -834,7 +834,7 @@ impl<'a, 'tcx> LifetimeContext<'a, 'tcx> {\n             }\n             match parent.node {\n                 hir::ItemTrait(_, ref generics, ..) |\n-                hir::ItemImpl(_, _, ref generics, ..) => {\n+                hir::ItemImpl(_, _, _, ref generics, ..) => {\n                     index += (generics.lifetimes.len() + generics.ty_params.len()) as u32;\n                 }\n                 _ => {}"}, {"sha": "e01f97eb1f3a0340dbe635139ed7985becf977b6", "filename": "src/librustc/traits/project.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustc%2Ftraits%2Fproject.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustc%2Ftraits%2Fproject.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ftraits%2Fproject.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -923,7 +923,8 @@ fn assemble_candidates_from_impls<'cx, 'gcx, 'tcx>(\n                         // being invoked).\n                         node_item.item.defaultness.has_value()\n                     } else {\n-                        node_item.item.defaultness.is_default()\n+                        node_item.item.defaultness.is_default() ||\n+                        selcx.tcx().impl_is_default(node_item.node.def_id())\n                     };\n \n                     // Only reveal a specializable default if we're past type-checking"}, {"sha": "1d10c3a969509cacff5f5508bb35cdbc38b3300a", "filename": "src/librustc/traits/util.rs", "status": "modified", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustc%2Ftraits%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustc%2Ftraits%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ftraits%2Futil.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -13,6 +13,8 @@ use ty::subst::{Subst, Substs};\n use ty::{self, Ty, TyCtxt, ToPredicate, ToPolyTraitRef};\n use ty::outlives::Component;\n use util::nodemap::FxHashSet;\n+use hir::{self};\n+use traits::specialize::specialization_graph::NodeItem;\n \n use super::{Obligation, ObligationCause, PredicateObligation, SelectionContext, Normalized};\n \n@@ -504,6 +506,30 @@ impl<'a, 'gcx, 'tcx> TyCtxt<'a, 'gcx, 'tcx> {\n         };\n         ty::Binder((trait_ref, sig.skip_binder().output()))\n     }\n+\n+    pub fn impl_is_default(self, node_item_def_id: DefId) -> bool {\n+        match self.hir.as_local_node_id(node_item_def_id) {\n+            Some(node_id) => {\n+                let item = self.hir.expect_item(node_id);\n+                if let hir::ItemImpl(_, _, defaultness, ..) = item.node {\n+                    defaultness.is_default()\n+                } else {\n+                    false\n+                }\n+            }\n+            None => {\n+                self.global_tcx()\n+                    .sess\n+                    .cstore\n+                    .impl_defaultness(node_item_def_id)\n+                    .is_default()\n+            }\n+        }\n+    }\n+\n+    pub fn impl_item_is_final(self, node_item: &NodeItem<hir::Defaultness>) -> bool {\n+        node_item.item.is_final() && !self.impl_is_default(node_item.node.def_id())\n+    }\n }\n \n pub enum TupleArgumentsFlag { Yes, No }"}, {"sha": "ddb3332be37318d273add716e883bf15e750c022", "filename": "src/librustc_metadata/cstore_impl.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustc_metadata%2Fcstore_impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustc_metadata%2Fcstore_impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Fcstore_impl.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -178,6 +178,12 @@ impl CrateStore for cstore::CStore {\n         result\n     }\n \n+    fn impl_defaultness(&self, def: DefId) -> hir::Defaultness\n+    {\n+        self.dep_graph.read(DepNode::MetaData(def));\n+        self.get_crate_data(def.krate).get_impl_defaultness(def.index)\n+    }\n+\n     fn impl_parent(&self, impl_def: DefId) -> Option<DefId> {\n         self.dep_graph.read(DepNode::MetaData(impl_def));\n         self.get_crate_data(impl_def.krate).get_parent_impl(impl_def.index)"}, {"sha": "37913dad7eeb58a2cd174158f6d40281d78030cf", "filename": "src/librustc_metadata/decoder.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustc_metadata%2Fdecoder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustc_metadata%2Fdecoder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Fdecoder.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -629,6 +629,10 @@ impl<'a, 'tcx> CrateMetadata {\n         self.get_impl_data(id).polarity\n     }\n \n+    pub fn get_impl_defaultness(&self, id: DefIndex) -> hir::Defaultness {\n+        self.get_impl_data(id).defaultness\n+    }\n+\n     pub fn get_coerce_unsized_info(&self,\n                                    id: DefIndex)\n                                    -> Option<ty::adjustment::CoerceUnsizedInfo> {"}, {"sha": "3676e5a7f0f724d83cd9dc58971f15b219014464", "filename": "src/librustc_metadata/encoder.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustc_metadata%2Fencoder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustc_metadata%2Fencoder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Fencoder.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -706,14 +706,15 @@ impl<'a, 'b: 'a, 'tcx: 'b> EntryBuilder<'a, 'b, 'tcx> {\n             hir::ItemDefaultImpl(..) => {\n                 let data = ImplData {\n                     polarity: hir::ImplPolarity::Positive,\n+                    defaultness: hir::Defaultness::Final,\n                     parent_impl: None,\n                     coerce_unsized_info: None,\n                     trait_ref: tcx.impl_trait_ref(def_id).map(|trait_ref| self.lazy(&trait_ref)),\n                 };\n \n                 EntryKind::DefaultImpl(self.lazy(&data))\n             }\n-            hir::ItemImpl(_, polarity, ..) => {\n+            hir::ItemImpl(_, polarity, defaultness, ..) => {\n                 let trait_ref = tcx.impl_trait_ref(def_id);\n                 let parent = if let Some(trait_ref) = trait_ref {\n                     let trait_def = tcx.trait_def(trait_ref.def_id);\n@@ -740,6 +741,7 @@ impl<'a, 'b: 'a, 'tcx: 'b> EntryBuilder<'a, 'b, 'tcx> {\n \n                 let data = ImplData {\n                     polarity: polarity,\n+                    defaultness: defaultness,\n                     parent_impl: parent,\n                     coerce_unsized_info: coerce_unsized_info,\n                     trait_ref: trait_ref.map(|trait_ref| self.lazy(&trait_ref)),"}, {"sha": "5870903e7718fd0820cb1341d78d9ab321abb2d4", "filename": "src/librustc_metadata/schema.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustc_metadata%2Fschema.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustc_metadata%2Fschema.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Fschema.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -406,6 +406,7 @@ impl_stable_hash_for!(struct TraitData<'tcx> {\n #[derive(RustcEncodable, RustcDecodable)]\n pub struct ImplData<'tcx> {\n     pub polarity: hir::ImplPolarity,\n+    pub defaultness: hir::Defaultness,\n     pub parent_impl: Option<DefId>,\n \n     /// This is `Some` only for impls of `CoerceUnsized`.\n@@ -415,6 +416,7 @@ pub struct ImplData<'tcx> {\n \n impl_stable_hash_for!(struct ImplData<'tcx> {\n     polarity,\n+    defaultness,\n     parent_impl,\n     coerce_unsized_info,\n     trait_ref"}, {"sha": "4639847651c74f41ccaedcd818ecf6a94c2d2892", "filename": "src/librustc_save_analysis/dump_visitor.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustc_save_analysis%2Fdump_visitor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustc_save_analysis%2Fdump_visitor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_save_analysis%2Fdump_visitor.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -430,7 +430,7 @@ impl<'l, 'tcx: 'l, 'll, D: Dump + 'll> DumpVisitor<'l, 'tcx, 'll, D> {\n                             }\n                             None => {\n                                 if let Some(NodeItem(item)) = self.tcx.hir.get_if_local(id) {\n-                                    if let hir::ItemImpl(_, _, _, _, ref ty, _) = item.node {\n+                                    if let hir::ItemImpl(_, _, _, _, _, ref ty, _) = item.node {\n                                         trait_id = self.lookup_def_id(ty.id);\n                                     }\n                                 }"}, {"sha": "77155a474aed44c253d86328bd7bda8767fd1f62", "filename": "src/librustc_trans/collector.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustc_trans%2Fcollector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustc_trans%2Fcollector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fcollector.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -880,7 +880,7 @@ impl<'b, 'a, 'v> ItemLikeVisitor<'v> for RootCollector<'b, 'a, 'v> {\n                 let parent_node_id = hir_map.get_parent_node(ii.id);\n                 let is_impl_generic = match hir_map.expect_item(parent_node_id) {\n                     &hir::Item {\n-                        node: hir::ItemImpl(_, _, ref generics, ..),\n+                        node: hir::ItemImpl(_, _, _, ref generics, ..),\n                         ..\n                     } => {\n                         generics.is_type_parameterized()\n@@ -911,6 +911,7 @@ fn create_trans_items_for_default_impls<'a, 'tcx>(scx: &SharedCrateContext<'a, '\n     let tcx = scx.tcx();\n     match item.node {\n         hir::ItemImpl(_,\n+                      _,\n                       _,\n                       ref generics,\n                       ..,"}, {"sha": "fe003f3f24230acbea01fd04a876a49a17808cf1", "filename": "src/librustc_typeck/check/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -1141,7 +1141,7 @@ fn check_specialization_validity<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>,\n         .map(|node_item| node_item.map(|parent| parent.defaultness));\n \n     if let Some(parent) = parent {\n-        if parent.item.is_final() {\n+        if tcx.impl_item_is_final(&parent) {\n             report_forbidden_specialization(tcx, impl_item, parent.node.def_id());\n         }\n     }"}, {"sha": "503212f2c970e24d105a3e712e9e8b3746d7745e", "filename": "src/librustc_typeck/check/wfcheck.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustc_typeck%2Fcheck%2Fwfcheck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustc_typeck%2Fcheck%2Fwfcheck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fwfcheck.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -105,11 +105,11 @@ impl<'a, 'gcx> CheckTypeWellFormedVisitor<'a, 'gcx> {\n             ///\n             /// won't be allowed unless there's an *explicit* implementation of `Send`\n             /// for `T`\n-            hir::ItemImpl(_, hir::ImplPolarity::Positive, _,\n+            hir::ItemImpl(_, hir::ImplPolarity::Positive, _, _,\n                           ref trait_ref, ref self_ty, _) => {\n                 self.check_impl(item, self_ty, trait_ref);\n             }\n-            hir::ItemImpl(_, hir::ImplPolarity::Negative, _, Some(_), ..) => {\n+            hir::ItemImpl(_, hir::ImplPolarity::Negative, _, _, Some(_), ..) => {\n                 // FIXME(#27579) what amount of WF checking do we need for neg impls?\n \n                 let trait_ref = tcx.impl_trait_ref(tcx.hir.local_def_id(item.id)).unwrap();"}, {"sha": "4672975d056b8679c897a079f4e0d8a7f283146f", "filename": "src/librustc_typeck/coherence/unsafety.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustc_typeck%2Fcoherence%2Funsafety.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustc_typeck%2Fcoherence%2Funsafety.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcoherence%2Funsafety.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -87,7 +87,7 @@ impl<'cx, 'tcx, 'v> ItemLikeVisitor<'v> for UnsafetyChecker<'cx, 'tcx> {\n             hir::ItemDefaultImpl(unsafety, _) => {\n                 self.check_unsafety_coherence(item, None, unsafety, hir::ImplPolarity::Positive);\n             }\n-            hir::ItemImpl(unsafety, polarity, ref generics, Some(_), _, _) => {\n+            hir::ItemImpl(unsafety, polarity, _, ref generics, ..) => {\n                 self.check_unsafety_coherence(item, Some(generics), unsafety, polarity);\n             }\n             _ => {}"}, {"sha": "3cd8b8bd48914891539049aa377399a9fad2da28", "filename": "src/librustc_typeck/collect.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustc_typeck%2Fcollect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustc_typeck%2Fcollect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcollect.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -309,7 +309,7 @@ fn type_param_predicates<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>,\n         NodeItem(item) => {\n             match item.node {\n                 ItemFn(.., ref generics, _) |\n-                ItemImpl(_, _, ref generics, ..) |\n+                ItemImpl(_, _, _, ref generics, ..) |\n                 ItemTy(_, ref generics) |\n                 ItemEnum(_, ref generics) |\n                 ItemStruct(_, ref generics) |\n@@ -825,7 +825,7 @@ fn generics_of<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>,\n         NodeItem(item) => {\n             match item.node {\n                 ItemFn(.., ref generics, _) |\n-                ItemImpl(_, _, ref generics, ..) => generics,\n+                ItemImpl(_, _, _, ref generics, ..) => generics,\n \n                 ItemTy(_, ref generics) |\n                 ItemEnum(_, ref generics) |\n@@ -1236,7 +1236,7 @@ fn predicates_of<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>,\n         NodeItem(item) => {\n             match item.node {\n                 ItemFn(.., ref generics, _) |\n-                ItemImpl(_, _, ref generics, ..) |\n+                ItemImpl(_, _, _, ref generics, ..) |\n                 ItemTy(_, ref generics) |\n                 ItemEnum(_, ref generics) |\n                 ItemStruct(_, ref generics) |"}, {"sha": "71594825cdb01215c8ab5fdcbd2a0a74a526c9fa", "filename": "src/librustdoc/doctree.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustdoc%2Fdoctree.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustdoc%2Fdoctree.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fdoctree.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -214,6 +214,7 @@ pub struct Trait {\n pub struct Impl {\n     pub unsafety: hir::Unsafety,\n     pub polarity: hir::ImplPolarity,\n+    pub defaultness: hir::Defaultness,\n     pub generics: hir::Generics,\n     pub trait_: Option<hir::TraitRef>,\n     pub for_: P<hir::Ty>,"}, {"sha": "d463e41c58a2a3281206510a116a8d29687ed4e5", "filename": "src/librustdoc/visit_ast.rs", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustdoc%2Fvisit_ast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibrustdoc%2Fvisit_ast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fvisit_ast.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -502,7 +502,13 @@ impl<'a, 'tcx> RustdocVisitor<'a, 'tcx> {\n                 om.traits.push(t);\n             },\n \n-            hir::ItemImpl(unsafety, polarity, ref gen, ref tr, ref ty, ref item_ids) => {\n+            hir::ItemImpl(unsafety,\n+                          polarity,\n+                          defaultness,\n+                          ref gen,\n+                          ref tr,\n+                          ref ty,\n+                          ref item_ids) => {\n                 // Don't duplicate impls when inlining, we'll pick them up\n                 // regardless of where they're located.\n                 if !self.inlining {\n@@ -512,6 +518,7 @@ impl<'a, 'tcx> RustdocVisitor<'a, 'tcx> {\n                     let i = Impl {\n                         unsafety: unsafety,\n                         polarity: polarity,\n+                        defaultness: defaultness,\n                         generics: gen.clone(),\n                         trait_: tr.clone(),\n                         for_: ty.clone(),"}, {"sha": "e5bb02fe08230253ddfa15006aa864a9879c0a9d", "filename": "src/libsyntax/ast.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibsyntax%2Fast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibsyntax%2Fast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fast.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -1852,6 +1852,7 @@ pub enum ItemKind {\n     /// E.g. `impl<A> Foo<A> { .. }` or `impl<A> Trait for Foo<A> { .. }`\n     Impl(Unsafety,\n              ImplPolarity,\n+             Defaultness,\n              Generics,\n              Option<TraitRef>, // (optional) trait this impl implements\n              P<Ty>, // self"}, {"sha": "b6a2c983fd4d7fb687abc39bea3ea65ddb14a844", "filename": "src/libsyntax/feature_gate.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibsyntax%2Ffeature_gate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibsyntax%2Ffeature_gate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Ffeature_gate.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -1215,7 +1215,7 @@ impl<'a> Visitor<'a> for PostExpansionVisitor<'a> {\n                                     and possibly buggy\");\n             }\n \n-            ast::ItemKind::Impl(_, polarity, _, _, _, _) => {\n+            ast::ItemKind::Impl(_, polarity, defaultness, _, _, _, _) => {\n                 match polarity {\n                     ast::ImplPolarity::Negative => {\n                         gate_feature_post!(&self, optin_builtin_traits,\n@@ -1225,6 +1225,12 @@ impl<'a> Visitor<'a> for PostExpansionVisitor<'a> {\n                     },\n                     _ => {}\n                 }\n+\n+                if let ast::Defaultness::Default = defaultness {\n+                    gate_feature_post!(&self, specialization,\n+                                       i.span,\n+                                       \"specialization is unstable\");\n+                }\n             }\n \n             _ => {}"}, {"sha": "58cf50cdc000ce3026dda2ad2ec1814926237378", "filename": "src/libsyntax/fold.rs", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibsyntax%2Ffold.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibsyntax%2Ffold.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Ffold.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -897,9 +897,16 @@ pub fn noop_fold_item_kind<T: Folder>(i: ItemKind, folder: &mut T) -> ItemKind {\n         ItemKind::DefaultImpl(unsafety, ref trait_ref) => {\n             ItemKind::DefaultImpl(unsafety, folder.fold_trait_ref((*trait_ref).clone()))\n         }\n-        ItemKind::Impl(unsafety, polarity, generics, ifce, ty, impl_items) => ItemKind::Impl(\n+        ItemKind::Impl(unsafety,\n+                       polarity,\n+                       defaultness,\n+                       generics,\n+                       ifce,\n+                       ty,\n+                       impl_items) => ItemKind::Impl(\n             unsafety,\n             polarity,\n+            defaultness,\n             folder.fold_generics(generics),\n             ifce.map(|trait_ref| folder.fold_trait_ref(trait_ref.clone())),\n             folder.fold_ty(ty),"}, {"sha": "cba77335143710d89e83d091dc2ead945c58e6b5", "filename": "src/libsyntax/parse/parser.rs", "status": "modified", "additions": 27, "deletions": 7, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibsyntax%2Fparse%2Fparser.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibsyntax%2Fparse%2Fparser.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fparse%2Fparser.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -4865,7 +4865,9 @@ impl<'a> Parser<'a> {\n     ///    impl<T> Foo { ... }\n     ///    impl<T> ToString for &'static T { ... }\n     ///    impl Send for .. {}\n-    fn parse_item_impl(&mut self, unsafety: ast::Unsafety) -> PResult<'a, ItemInfo> {\n+    fn parse_item_impl(&mut self,\n+                       unsafety: ast::Unsafety,\n+                       defaultness: Defaultness) -> PResult<'a, ItemInfo> {\n         let impl_span = self.span;\n \n         // First, parse type parameters if necessary.\n@@ -4918,6 +4920,11 @@ impl<'a> Parser<'a> {\n                                           allowed to have generics\");\n             }\n \n+            if let ast::Defaultness::Default = defaultness {\n+                self.span_err(impl_span, \"`default impl` is not allowed for \\\n+                                         default trait implementations\");\n+            }\n+\n             self.expect(&token::OpenDelim(token::Brace))?;\n             self.expect(&token::CloseDelim(token::Brace))?;\n             Ok((keywords::Invalid.ident(),\n@@ -4946,7 +4953,7 @@ impl<'a> Parser<'a> {\n             }\n \n             Ok((keywords::Invalid.ident(),\n-             ItemKind::Impl(unsafety, polarity, generics, opt_trait, ty, impl_items),\n+             ItemKind::Impl(unsafety, polarity, defaultness, generics, opt_trait, ty, impl_items),\n              Some(attrs)))\n         }\n     }\n@@ -5759,13 +5766,19 @@ impl<'a> Parser<'a> {\n                                     maybe_append(attrs, extra_attrs));\n             return Ok(Some(item));\n         }\n-        if self.check_keyword(keywords::Unsafe) &&\n-            self.look_ahead(1, |t| t.is_keyword(keywords::Impl))\n+        if (self.check_keyword(keywords::Unsafe) &&\n+            self.look_ahead(1, |t| t.is_keyword(keywords::Impl))) ||\n+           (self.check_keyword(keywords::Default) &&\n+            self.look_ahead(1, |t| t.is_keyword(keywords::Unsafe)) &&\n+            self.look_ahead(2, |t| t.is_keyword(keywords::Impl)))\n         {\n             // IMPL ITEM\n+            let defaultness = self.parse_defaultness()?;\n             self.expect_keyword(keywords::Unsafe)?;\n             self.expect_keyword(keywords::Impl)?;\n-            let (ident, item_, extra_attrs) = self.parse_item_impl(ast::Unsafety::Unsafe)?;\n+            let (ident,\n+                 item_,\n+                 extra_attrs) = self.parse_item_impl(ast::Unsafety::Unsafe, defaultness)?;\n             let prev_span = self.prev_span;\n             let item = self.mk_item(lo.to(prev_span),\n                                     ident,\n@@ -5859,9 +5872,16 @@ impl<'a> Parser<'a> {\n                                     maybe_append(attrs, extra_attrs));\n             return Ok(Some(item));\n         }\n-        if self.eat_keyword(keywords::Impl) {\n+        if (self.check_keyword(keywords::Impl)) ||\n+           (self.check_keyword(keywords::Default) &&\n+            self.look_ahead(1, |t| t.is_keyword(keywords::Impl)))\n+        {\n             // IMPL ITEM\n-            let (ident, item_, extra_attrs) = self.parse_item_impl(ast::Unsafety::Normal)?;\n+            let defaultness = self.parse_defaultness()?;\n+            self.expect_keyword(keywords::Impl)?;\n+            let (ident,\n+                 item_,\n+                 extra_attrs) = self.parse_item_impl(ast::Unsafety::Normal, defaultness)?;\n             let prev_span = self.prev_span;\n             let item = self.mk_item(lo.to(prev_span),\n                                     ident,"}, {"sha": "a911c21ed98d05e890c3c84e0c2b86667567c9e7", "filename": "src/libsyntax/print/pprust.rs", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibsyntax%2Fprint%2Fpprust.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibsyntax%2Fprint%2Fpprust.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fprint%2Fpprust.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -1317,12 +1317,14 @@ impl<'a> State<'a> {\n             }\n             ast::ItemKind::Impl(unsafety,\n                           polarity,\n+                          defaultness,\n                           ref generics,\n                           ref opt_trait,\n                           ref ty,\n                           ref impl_items) => {\n                 self.head(\"\")?;\n                 self.print_visibility(&item.vis)?;\n+                self.print_defaultness(defaultness)?;\n                 self.print_unsafety(unsafety)?;\n                 self.word_nbsp(\"impl\")?;\n \n@@ -1477,6 +1479,13 @@ impl<'a> State<'a> {\n         }\n     }\n \n+    pub fn print_defaultness(&mut self, defatulness: ast::Defaultness) -> io::Result<()> {\n+        if let ast::Defaultness::Default = defatulness {\n+            try!(self.word_nbsp(\"default\"));\n+        }\n+        Ok(())\n+    }\n+\n     pub fn print_struct(&mut self,\n                         struct_def: &ast::VariantData,\n                         generics: &ast::Generics,\n@@ -1602,9 +1611,7 @@ impl<'a> State<'a> {\n         self.hardbreak_if_not_bol()?;\n         self.maybe_print_comment(ii.span.lo)?;\n         self.print_outer_attributes(&ii.attrs)?;\n-        if let ast::Defaultness::Default = ii.defaultness {\n-            self.word_nbsp(\"default\")?;\n-        }\n+        self.print_defaultness(ii.defaultness)?;\n         match ii.node {\n             ast::ImplItemKind::Const(ref ty, ref expr) => {\n                 self.print_associated_const(ii.ident, &ty, Some(&expr), &ii.vis)?;"}, {"sha": "2e42c6986e64e1d527af2b5699958e6c98e144c5", "filename": "src/libsyntax/visit.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibsyntax%2Fvisit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibsyntax%2Fvisit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fvisit.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -266,7 +266,7 @@ pub fn walk_item<'a, V: Visitor<'a>>(visitor: &mut V, item: &'a Item) {\n         ItemKind::DefaultImpl(_, ref trait_ref) => {\n             visitor.visit_trait_ref(trait_ref)\n         }\n-        ItemKind::Impl(_, _,\n+        ItemKind::Impl(_, _, _,\n                  ref type_parameters,\n                  ref opt_trait_reference,\n                  ref typ,"}, {"sha": "be7883cad5f38ca52bda1c23a70b7dc4e49bded9", "filename": "src/libsyntax_ext/deriving/generic/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibsyntax_ext%2Fderiving%2Fgeneric%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Flibsyntax_ext%2Fderiving%2Fgeneric%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_ext%2Fderiving%2Fgeneric%2Fmod.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -658,6 +658,7 @@ impl<'a> TraitDef<'a> {\n                 a,\n                 ast::ItemKind::Impl(unsafety,\n                                     ast::ImplPolarity::Positive,\n+                                    ast::Defaultness::Final,\n                                     trait_generics,\n                                     opt_trait_ref,\n                                     self_type,"}, {"sha": "ad55f44255b48eec4d3896f532ccd9c4893acf2e", "filename": "src/test/compile-fail/specialization/defaultimpl/specialization-default-projection.rs", "status": "added", "additions": 46, "deletions": 0, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Fcompile-fail%2Fspecialization%2Fdefaultimpl%2Fspecialization-default-projection.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Fcompile-fail%2Fspecialization%2Fdefaultimpl%2Fspecialization-default-projection.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fspecialization%2Fdefaultimpl%2Fspecialization-default-projection.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -0,0 +1,46 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![feature(specialization)]\n+\n+// Make sure we can't project defaulted associated types\n+\n+trait Foo {\n+    type Assoc;\n+}\n+\n+default impl<T> Foo for T {\n+    type Assoc = ();\n+}\n+\n+impl Foo for u8 {\n+    type Assoc = String;\n+}\n+\n+fn generic<T>() -> <T as Foo>::Assoc {\n+    // `T` could be some downstream crate type that specializes (or,\n+    // for that matter, `u8`).\n+\n+    () //~ ERROR mismatched types\n+}\n+\n+fn monomorphic() -> () {\n+    // Even though we know that `()` is not specialized in a\n+    // downstream crate, typeck refuses to project here.\n+\n+    generic::<()>() //~ ERROR mismatched types\n+}\n+\n+fn main() {\n+    // No error here, we CAN project from `u8`, as there is no `default`\n+    // in that impl.\n+    let s: String = generic::<u8>();\n+    println!(\"{}\", s); // bad news if this all compiles\n+}"}, {"sha": "7353f7ac8c5c0c38bed49d14b7e70d24f7874660", "filename": "src/test/compile-fail/specialization/defaultimpl/specialization-default-types.rs", "status": "added", "additions": 45, "deletions": 0, "changes": 45, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Fcompile-fail%2Fspecialization%2Fdefaultimpl%2Fspecialization-default-types.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Fcompile-fail%2Fspecialization%2Fdefaultimpl%2Fspecialization-default-types.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fspecialization%2Fdefaultimpl%2Fspecialization-default-types.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -0,0 +1,45 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// It should not be possible to use the concrete value of a defaulted\n+// associated type in the impl defining it -- otherwise, what happens\n+// if it's overridden?\n+\n+#![feature(specialization)]\n+\n+trait Example {\n+    type Output;\n+    fn generate(self) -> Self::Output;\n+}\n+\n+default impl<T> Example for T {\n+    type Output = Box<T>;\n+    fn generate(self) -> Self::Output {\n+        Box::new(self) //~ ERROR mismatched types\n+    }\n+}\n+\n+impl Example for bool {\n+    type Output = bool;\n+    fn generate(self) -> bool { self }\n+}\n+\n+fn trouble<T>(t: T) -> Box<T> {\n+    Example::generate(t) //~ ERROR mismatched types\n+}\n+\n+fn weaponize() -> bool {\n+    let b: Box<bool> = trouble(true);\n+    *b\n+}\n+\n+fn main() {\n+    weaponize();\n+}"}, {"sha": "5bab4c5438e51c2708e038c156fd28c0df2c8662", "filename": "src/test/compile-fail/specialization/defaultimpl/specialization-feature-gate-default.rs", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Fcompile-fail%2Fspecialization%2Fdefaultimpl%2Fspecialization-feature-gate-default.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Fcompile-fail%2Fspecialization%2Fdefaultimpl%2Fspecialization-feature-gate-default.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fspecialization%2Fdefaultimpl%2Fspecialization-feature-gate-default.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -0,0 +1,21 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// Check that specialization must be ungated to use the `default` keyword\n+\n+trait Foo {\n+    fn foo(&self);\n+}\n+\n+default impl<T> Foo for T { //~ ERROR specialization is unstable\n+    fn foo(&self) {}\n+}\n+\n+fn main() {}"}, {"sha": "c1746d765dd9f5f86239c882e7a1bf6fde8b7f7b", "filename": "src/test/compile-fail/specialization/defaultimpl/specialization-no-default-trait-implementations.rs", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Fcompile-fail%2Fspecialization%2Fdefaultimpl%2Fspecialization-no-default-trait-implementations.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Fcompile-fail%2Fspecialization%2Fdefaultimpl%2Fspecialization-no-default-trait-implementations.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fspecialization%2Fdefaultimpl%2Fspecialization-no-default-trait-implementations.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -0,0 +1,19 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![feature(specialization)]\n+#![feature(optin_builtin_traits)]\n+\n+trait Foo {}\n+\n+default impl Foo for .. {}\n+//~^ ERROR `default impl` is not allowed for default trait implementations\n+\n+fn main() {}"}, {"sha": "2874108157d832e73bbd50cb6de5222d568c35a0", "filename": "src/test/compile-fail/specialization/defaultimpl/specialization-no-default.rs", "status": "added", "additions": 95, "deletions": 0, "changes": 95, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Fcompile-fail%2Fspecialization%2Fdefaultimpl%2Fspecialization-no-default.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Fcompile-fail%2Fspecialization%2Fdefaultimpl%2Fspecialization-no-default.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fspecialization%2Fdefaultimpl%2Fspecialization-no-default.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -0,0 +1,95 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![feature(specialization)]\n+\n+// Check a number of scenarios in which one impl tries to override another,\n+// without correctly using `default`.\n+\n+////////////////////////////////////////////////////////////////////////////////\n+// Test 1: one layer of specialization, multiple methods, missing `default`\n+////////////////////////////////////////////////////////////////////////////////\n+\n+trait Foo {\n+    fn foo(&self);\n+    fn bar(&self);\n+}\n+\n+impl<T> Foo for T {\n+    fn foo(&self) {}\n+    fn bar(&self) {}\n+}\n+\n+impl Foo for u8 {}\n+impl Foo for u16 {\n+    fn foo(&self) {} //~ ERROR E0520\n+}\n+impl Foo for u32 {\n+    fn bar(&self) {} //~ ERROR E0520\n+}\n+\n+////////////////////////////////////////////////////////////////////////////////\n+// Test 2: one layer of specialization, missing `default` on associated type\n+////////////////////////////////////////////////////////////////////////////////\n+\n+trait Bar {\n+    type T;\n+}\n+\n+impl<T> Bar for T {\n+    type T = u8;\n+}\n+\n+impl Bar for u8 {\n+    type T = (); //~ ERROR E0520\n+}\n+\n+////////////////////////////////////////////////////////////////////////////////\n+// Test 3a: multiple layers of specialization, missing interior `default`\n+////////////////////////////////////////////////////////////////////////////////\n+\n+trait Baz {\n+    fn baz(&self);\n+}\n+\n+default impl<T> Baz for T {\n+    fn baz(&self) {}\n+}\n+\n+impl<T: Clone> Baz for T {\n+    fn baz(&self) {}\n+}\n+\n+impl Baz for i32 {\n+    fn baz(&self) {} //~ ERROR E0520\n+}\n+\n+////////////////////////////////////////////////////////////////////////////////\n+// Test 3b: multiple layers of specialization, missing interior `default`,\n+// redundant `default` in bottom layer.\n+////////////////////////////////////////////////////////////////////////////////\n+\n+trait Redundant {\n+    fn redundant(&self);\n+}\n+\n+default impl<T> Redundant for T {\n+    fn redundant(&self) {}\n+}\n+\n+impl<T: Clone> Redundant for T {\n+    fn redundant(&self) {}\n+}\n+\n+default impl Redundant for i32 {\n+    fn redundant(&self) {} //~ ERROR E0520\n+}\n+\n+fn main() {}"}, {"sha": "dd060f8ef40dca8ceb23b9bf74b7b4f39458162f", "filename": "src/test/run-pass/specialization/defaultimpl/auxiliary/go_trait.rs", "status": "added", "additions": 53, "deletions": 0, "changes": 53, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fauxiliary%2Fgo_trait.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fauxiliary%2Fgo_trait.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fauxiliary%2Fgo_trait.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -0,0 +1,53 @@\n+// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![feature(specialization)]\n+\n+// Common code used for tests that model the Fn/FnMut/FnOnce hierarchy.\n+\n+pub trait Go {\n+    fn go(&self, arg: isize);\n+}\n+\n+pub fn go<G:Go>(this: &G, arg: isize) {\n+    this.go(arg)\n+}\n+\n+pub trait GoMut {\n+    fn go_mut(&mut self, arg: isize);\n+}\n+\n+pub fn go_mut<G:GoMut>(this: &mut G, arg: isize) {\n+    this.go_mut(arg)\n+}\n+\n+pub trait GoOnce {\n+    fn go_once(self, arg: isize);\n+}\n+\n+pub fn go_once<G:GoOnce>(this: G, arg: isize) {\n+    this.go_once(arg)\n+}\n+\n+default impl<G> GoMut for G\n+    where G : Go\n+{\n+    fn go_mut(&mut self, arg: isize) {\n+        go(&*self, arg)\n+    }\n+}\n+\n+default impl<G> GoOnce for G\n+    where G : GoMut\n+{\n+    fn go_once(mut self, arg: isize) {\n+        go_mut(&mut self, arg)\n+    }\n+}"}, {"sha": "71dd7c99009ea5a0920c0e35bf943e69c4316b55", "filename": "src/test/run-pass/specialization/defaultimpl/auxiliary/specialization_cross_crate.rs", "status": "added", "additions": 82, "deletions": 0, "changes": 82, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fauxiliary%2Fspecialization_cross_crate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fauxiliary%2Fspecialization_cross_crate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fauxiliary%2Fspecialization_cross_crate.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -0,0 +1,82 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![feature(specialization)]\n+\n+pub trait Foo {\n+    fn foo(&self) -> &'static str;\n+}\n+\n+default impl<T> Foo for T {\n+    fn foo(&self) -> &'static str {\n+        \"generic\"\n+    }\n+}\n+\n+default impl<T: Clone> Foo for T {\n+    fn foo(&self) -> &'static str {\n+        \"generic Clone\"\n+    }\n+}\n+\n+default impl<T, U> Foo for (T, U) where T: Clone, U: Clone {\n+    fn foo(&self) -> &'static str {\n+        \"generic pair\"\n+    }\n+}\n+\n+default impl<T: Clone> Foo for (T, T) {\n+    fn foo(&self) -> &'static str {\n+        \"generic uniform pair\"\n+    }\n+}\n+\n+default impl Foo for (u8, u32) {\n+    fn foo(&self) -> &'static str {\n+        \"(u8, u32)\"\n+    }\n+}\n+\n+default impl Foo for (u8, u8) {\n+    fn foo(&self) -> &'static str {\n+        \"(u8, u8)\"\n+    }\n+}\n+\n+default impl<T: Clone> Foo for Vec<T> {\n+    fn foo(&self) -> &'static str {\n+        \"generic Vec\"\n+    }\n+}\n+\n+impl Foo for Vec<i32> {\n+    fn foo(&self) -> &'static str {\n+        \"Vec<i32>\"\n+    }\n+}\n+\n+impl Foo for String {\n+    fn foo(&self) -> &'static str {\n+        \"String\"\n+    }\n+}\n+\n+impl Foo for i32 {\n+    fn foo(&self) -> &'static str {\n+        \"i32\"\n+    }\n+}\n+\n+pub trait MyMarker {}\n+default impl<T: Clone + MyMarker> Foo for T {\n+    fn foo(&self) -> &'static str {\n+        \"generic Clone + MyMarker\"\n+    }\n+}"}, {"sha": "9d0ea64fed428d6cefe7beb02a8ddd0ee5f1ad4d", "filename": "src/test/run-pass/specialization/defaultimpl/auxiliary/specialization_cross_crate_defaults.rs", "status": "added", "additions": 49, "deletions": 0, "changes": 49, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fauxiliary%2Fspecialization_cross_crate_defaults.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fauxiliary%2Fspecialization_cross_crate_defaults.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fauxiliary%2Fspecialization_cross_crate_defaults.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -0,0 +1,49 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+\n+#![feature(specialization)]\n+\n+// First, test only use of explicit `default` items:\n+\n+pub trait Foo {\n+    fn foo(&self) -> bool;\n+}\n+\n+default impl<T> Foo for T {\n+    fn foo(&self) -> bool { false }\n+}\n+\n+impl Foo for i32 {}\n+\n+impl Foo for i64 {\n+    fn foo(&self) -> bool { true }\n+}\n+\n+// Next, test mixture of explicit `default` and provided methods:\n+\n+pub trait Bar {\n+    fn bar(&self) -> i32 { 0 }\n+}\n+\n+impl<T> Bar for T {} // use the provided method\n+\n+impl Bar for i32 {\n+    fn bar(&self) -> i32 { 1 }\n+}\n+impl<'a> Bar for &'a str {}\n+\n+default impl<T> Bar for Vec<T> {\n+    fn bar(&self) -> i32 { 2 }\n+}\n+impl Bar for Vec<i32> {}\n+impl Bar for Vec<i64> {\n+    fn bar(&self) -> i32 { 3 }\n+}"}, {"sha": "6b999f3835835af47943f4f065fafc89bca17aed", "filename": "src/test/run-pass/specialization/defaultimpl/specialization-allowed-cross-crate.rs", "status": "added", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fspecialization-allowed-cross-crate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fspecialization-allowed-cross-crate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fspecialization-allowed-cross-crate.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -0,0 +1,31 @@\n+// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// aux-build:go_trait.rs\n+\n+#![feature(specialization)]\n+\n+extern crate go_trait;\n+\n+use go_trait::{Go,GoMut};\n+use std::fmt::Debug;\n+use std::default::Default;\n+\n+struct MyThingy;\n+\n+impl Go for MyThingy {\n+    fn go(&self, arg: isize) { }\n+}\n+\n+impl GoMut for MyThingy {\n+    fn go_mut(&mut self, arg: isize) { }\n+}\n+\n+fn main() { }"}, {"sha": "b99ba3d0f1c931987f4e5ec228c085eea8481568", "filename": "src/test/run-pass/specialization/defaultimpl/specialization-assoc-fns.rs", "status": "added", "additions": 37, "deletions": 0, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fspecialization-assoc-fns.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fspecialization-assoc-fns.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fspecialization-assoc-fns.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -0,0 +1,37 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// Test that non-method associated functions can be specialized\n+\n+#![feature(specialization)]\n+\n+trait Foo {\n+    fn mk() -> Self;\n+}\n+\n+default impl<T: Default> Foo for T {\n+    fn mk() -> T {\n+        T::default()\n+    }\n+}\n+\n+impl Foo for Vec<u8> {\n+    fn mk() -> Vec<u8> {\n+        vec![0]\n+    }\n+}\n+\n+fn main() {\n+    let v1: Vec<i32> = Foo::mk();\n+    let v2: Vec<u8> = Foo::mk();\n+\n+    assert!(v1.len() == 0);\n+    assert!(v2.len() == 1);\n+}"}, {"sha": "7daecc842f3f9fd8a2140a3785db00b2f34cbffc", "filename": "src/test/run-pass/specialization/defaultimpl/specialization-basics-unsafe.rs", "status": "added", "additions": 106, "deletions": 0, "changes": 106, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fspecialization-basics-unsafe.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fspecialization-basics-unsafe.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fspecialization-basics-unsafe.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -0,0 +1,106 @@\n+// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![feature(specialization)]\n+\n+// Tests a variety of basic specialization scenarios and method\n+// dispatch for them.\n+\n+unsafe trait Foo {\n+    fn foo(&self) -> &'static str;\n+}\n+\n+default unsafe impl<T> Foo for T {\n+    fn foo(&self) -> &'static str {\n+        \"generic\"\n+    }\n+}\n+\n+default unsafe impl<T: Clone> Foo for T {\n+    fn foo(&self) -> &'static str {\n+        \"generic Clone\"\n+    }\n+}\n+\n+default unsafe impl<T, U> Foo for (T, U) where T: Clone, U: Clone {\n+    fn foo(&self) -> &'static str {\n+        \"generic pair\"\n+    }\n+}\n+\n+default unsafe impl<T: Clone> Foo for (T, T) {\n+    fn foo(&self) -> &'static str {\n+        \"generic uniform pair\"\n+    }\n+}\n+\n+default unsafe impl Foo for (u8, u32) {\n+    fn foo(&self) -> &'static str {\n+        \"(u8, u32)\"\n+    }\n+}\n+\n+default unsafe impl Foo for (u8, u8) {\n+    fn foo(&self) -> &'static str {\n+        \"(u8, u8)\"\n+    }\n+}\n+\n+default unsafe impl<T: Clone> Foo for Vec<T> {\n+    fn foo(&self) -> &'static str {\n+        \"generic Vec\"\n+    }\n+}\n+\n+default unsafe impl Foo for Vec<i32> {\n+    fn foo(&self) -> &'static str {\n+        \"Vec<i32>\"\n+    }\n+}\n+\n+default unsafe impl Foo for String {\n+    fn foo(&self) -> &'static str {\n+        \"String\"\n+    }\n+}\n+\n+default unsafe impl Foo for i32 {\n+    fn foo(&self) -> &'static str {\n+        \"i32\"\n+    }\n+}\n+\n+struct NotClone;\n+\n+unsafe trait MyMarker {}\n+default unsafe impl<T: Clone + MyMarker> Foo for T {\n+    fn foo(&self) -> &'static str {\n+        \"generic Clone + MyMarker\"\n+    }\n+}\n+\n+#[derive(Clone)]\n+struct MarkedAndClone;\n+unsafe impl MyMarker for MarkedAndClone {}\n+\n+fn  main() {\n+    assert!(NotClone.foo() == \"generic\");\n+    assert!(0u8.foo() == \"generic Clone\");\n+    assert!(vec![NotClone].foo() == \"generic\");\n+    assert!(vec![0u8].foo() == \"generic Vec\");\n+    assert!(vec![0i32].foo() == \"Vec<i32>\");\n+    assert!(0i32.foo() == \"i32\");\n+    assert!(String::new().foo() == \"String\");\n+    assert!(((), 0).foo() == \"generic pair\");\n+    assert!(((), ()).foo() == \"generic uniform pair\");\n+    assert!((0u8, 0u32).foo() == \"(u8, u32)\");\n+    assert!((0u8, 0u8).foo() == \"(u8, u8)\");\n+    assert!(MarkedAndClone.foo() == \"generic Clone + MyMarker\");\n+}"}, {"sha": "594f1e4fcdfc26b834c9bea5f57cd3482653b6d0", "filename": "src/test/run-pass/specialization/defaultimpl/specialization-basics.rs", "status": "added", "additions": 106, "deletions": 0, "changes": 106, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fspecialization-basics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fspecialization-basics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fspecialization-basics.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -0,0 +1,106 @@\n+// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![feature(specialization)]\n+\n+// Tests a variety of basic specialization scenarios and method\n+// dispatch for them.\n+\n+trait Foo {\n+    fn foo(&self) -> &'static str;\n+}\n+\n+default impl<T> Foo for T {\n+    fn foo(&self) -> &'static str {\n+        \"generic\"\n+    }\n+}\n+\n+default impl<T: Clone> Foo for T {\n+    fn foo(&self) -> &'static str {\n+        \"generic Clone\"\n+    }\n+}\n+\n+default impl<T, U> Foo for (T, U) where T: Clone, U: Clone {\n+    fn foo(&self) -> &'static str {\n+        \"generic pair\"\n+    }\n+}\n+\n+default impl<T: Clone> Foo for (T, T) {\n+    fn foo(&self) -> &'static str {\n+        \"generic uniform pair\"\n+    }\n+}\n+\n+default impl Foo for (u8, u32) {\n+    fn foo(&self) -> &'static str {\n+        \"(u8, u32)\"\n+    }\n+}\n+\n+default impl Foo for (u8, u8) {\n+    fn foo(&self) -> &'static str {\n+        \"(u8, u8)\"\n+    }\n+}\n+\n+default impl<T: Clone> Foo for Vec<T> {\n+    fn foo(&self) -> &'static str {\n+        \"generic Vec\"\n+    }\n+}\n+\n+impl Foo for Vec<i32> {\n+    fn foo(&self) -> &'static str {\n+        \"Vec<i32>\"\n+    }\n+}\n+\n+impl Foo for String {\n+    fn foo(&self) -> &'static str {\n+        \"String\"\n+    }\n+}\n+\n+impl Foo for i32 {\n+    fn foo(&self) -> &'static str {\n+        \"i32\"\n+    }\n+}\n+\n+struct NotClone;\n+\n+trait MyMarker {}\n+default impl<T: Clone + MyMarker> Foo for T {\n+    fn foo(&self) -> &'static str {\n+        \"generic Clone + MyMarker\"\n+    }\n+}\n+\n+#[derive(Clone)]\n+struct MarkedAndClone;\n+impl MyMarker for MarkedAndClone {}\n+\n+fn  main() {\n+    assert!(NotClone.foo() == \"generic\");\n+    assert!(0u8.foo() == \"generic Clone\");\n+    assert!(vec![NotClone].foo() == \"generic\");\n+    assert!(vec![0u8].foo() == \"generic Vec\");\n+    assert!(vec![0i32].foo() == \"Vec<i32>\");\n+    assert!(0i32.foo() == \"i32\");\n+    assert!(String::new().foo() == \"String\");\n+    assert!(((), 0).foo() == \"generic pair\");\n+    assert!(((), ()).foo() == \"generic uniform pair\");\n+    assert!((0u8, 0u32).foo() == \"(u8, u32)\");\n+    assert!((0u8, 0u8).foo() == \"(u8, u8)\");\n+    assert!(MarkedAndClone.foo() == \"generic Clone + MyMarker\");\n+}"}, {"sha": "62c7e3e2e4431065f1d282c8340d7c4037489e40", "filename": "src/test/run-pass/specialization/defaultimpl/specialization-cross-crate-defaults.rs", "status": "added", "additions": 49, "deletions": 0, "changes": 49, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fspecialization-cross-crate-defaults.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fspecialization-cross-crate-defaults.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fspecialization-cross-crate-defaults.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -0,0 +1,49 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// aux-build:specialization_cross_crate_defaults.rs\n+\n+#![feature(specialization)]\n+\n+extern crate specialization_cross_crate_defaults;\n+\n+use specialization_cross_crate_defaults::*;\n+\n+struct LocalDefault;\n+struct LocalOverride;\n+\n+impl Foo for LocalDefault {}\n+\n+impl Foo for LocalOverride {\n+    fn foo(&self) -> bool { true }\n+}\n+\n+fn test_foo() {\n+    assert!(!0i8.foo());\n+    assert!(!0i32.foo());\n+    assert!(0i64.foo());\n+\n+    assert!(!LocalDefault.foo());\n+    assert!(LocalOverride.foo());\n+}\n+\n+fn test_bar() {\n+    assert!(0u8.bar() == 0);\n+    assert!(0i32.bar() == 1);\n+    assert!(\"hello\".bar() == 0);\n+    assert!(vec![()].bar() == 2);\n+    assert!(vec![0i32].bar() == 2);\n+    assert!(vec![0i64].bar() == 3);\n+}\n+\n+fn main() {\n+    test_foo();\n+    test_bar();\n+}"}, {"sha": "b9548539e16490b1fea6deae8f68531571cd8809", "filename": "src/test/run-pass/specialization/defaultimpl/specialization-cross-crate-no-gate.rs", "status": "added", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fspecialization-cross-crate-no-gate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fspecialization-cross-crate-no-gate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fspecialization-cross-crate-no-gate.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -0,0 +1,29 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// Test that specialization works even if only the upstream crate enables it\n+\n+// aux-build:specialization_cross_crate.rs\n+\n+extern crate specialization_cross_crate;\n+\n+use specialization_cross_crate::*;\n+\n+fn  main() {\n+    assert!(0u8.foo() == \"generic Clone\");\n+    assert!(vec![0u8].foo() == \"generic Vec\");\n+    assert!(vec![0i32].foo() == \"Vec<i32>\");\n+    assert!(0i32.foo() == \"i32\");\n+    assert!(String::new().foo() == \"String\");\n+    assert!(((), 0).foo() == \"generic pair\");\n+    assert!(((), ()).foo() == \"generic uniform pair\");\n+    assert!((0u8, 0u32).foo() == \"(u8, u32)\");\n+    assert!((0u8, 0u8).foo() == \"(u8, u8)\");\n+}"}, {"sha": "7517824b62bba4329007a2fe03bfebd04cc3690a", "filename": "src/test/run-pass/specialization/defaultimpl/specialization-cross-crate.rs", "status": "added", "additions": 58, "deletions": 0, "changes": 58, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fspecialization-cross-crate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fspecialization-cross-crate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fspecialization-cross-crate.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -0,0 +1,58 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// aux-build:specialization_cross_crate.rs\n+\n+#![feature(specialization)]\n+\n+extern crate specialization_cross_crate;\n+\n+use specialization_cross_crate::*;\n+\n+struct NotClone;\n+\n+#[derive(Clone)]\n+struct MarkedAndClone;\n+impl MyMarker for MarkedAndClone {}\n+\n+struct MyType<T>(T);\n+default impl<T> Foo for MyType<T> {\n+    fn foo(&self) -> &'static str {\n+        \"generic MyType\"\n+    }\n+}\n+\n+impl Foo for MyType<u8> {\n+    fn foo(&self) -> &'static str {\n+        \"MyType<u8>\"\n+    }\n+}\n+\n+struct MyOtherType;\n+impl Foo for MyOtherType {}\n+\n+fn  main() {\n+    assert!(NotClone.foo() == \"generic\");\n+    assert!(0u8.foo() == \"generic Clone\");\n+    assert!(vec![NotClone].foo() == \"generic\");\n+    assert!(vec![0u8].foo() == \"generic Vec\");\n+    assert!(vec![0i32].foo() == \"Vec<i32>\");\n+    assert!(0i32.foo() == \"i32\");\n+    assert!(String::new().foo() == \"String\");\n+    assert!(((), 0).foo() == \"generic pair\");\n+    assert!(((), ()).foo() == \"generic uniform pair\");\n+    assert!((0u8, 0u32).foo() == \"(u8, u32)\");\n+    assert!((0u8, 0u8).foo() == \"(u8, u8)\");\n+    assert!(MarkedAndClone.foo() == \"generic Clone + MyMarker\");\n+\n+    assert!(MyType(()).foo() == \"generic MyType\");\n+    assert!(MyType(0u8).foo() == \"MyType<u8>\");\n+    assert!(MyOtherType.foo() == \"generic\");\n+}"}, {"sha": "4ac9afc1c897fa27e4fcfe357475985563a4f588", "filename": "src/test/run-pass/specialization/defaultimpl/specialization-default-methods.rs", "status": "added", "additions": 94, "deletions": 0, "changes": 94, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fspecialization-default-methods.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fspecialization-default-methods.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fspecialization-default-methods.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -0,0 +1,94 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![feature(specialization)]\n+\n+// Test that default methods are cascaded correctly\n+\n+// First, test only use of explicit `default` items:\n+\n+trait Foo {\n+    fn foo(&self) -> bool;\n+}\n+\n+// Specialization tree for Foo:\n+//\n+//        T\n+//       / \\\n+//    i32   i64\n+\n+default impl<T> Foo for T {\n+    fn foo(&self) -> bool { false }\n+}\n+\n+impl Foo for i32 {}\n+\n+impl Foo for i64 {\n+    fn foo(&self) -> bool { true }\n+}\n+\n+fn test_foo() {\n+    assert!(!0i8.foo());\n+    assert!(!0i32.foo());\n+    assert!(0i64.foo());\n+}\n+\n+// Next, test mixture of explicit `default` and provided methods:\n+\n+trait Bar {\n+    fn bar(&self) -> i32 { 0 }\n+}\n+\n+// Specialization tree for Bar.\n+// Uses of $ designate that method is provided\n+//\n+//           $Bar   (the trait)\n+//             |\n+//             T\n+//            /|\\\n+//           / | \\\n+//          /  |  \\\n+//         /   |   \\\n+//        /    |    \\\n+//       /     |     \\\n+//     $i32   &str  $Vec<T>\n+//                    /\\\n+//                   /  \\\n+//            Vec<i32>  $Vec<i64>\n+\n+// use the provided method\n+impl<T> Bar for T {}\n+\n+impl Bar for i32 {\n+    fn bar(&self) -> i32 { 1 }\n+}\n+impl<'a> Bar for &'a str {}\n+\n+default impl<T> Bar for Vec<T> {\n+    fn bar(&self) -> i32 { 2 }\n+}\n+impl Bar for Vec<i32> {}\n+impl Bar for Vec<i64> {\n+    fn bar(&self) -> i32 { 3 }\n+}\n+\n+fn test_bar() {\n+    assert!(0u8.bar() == 0);\n+    assert!(0i32.bar() == 1);\n+    assert!(\"hello\".bar() == 0);\n+    assert!(vec![()].bar() == 2);\n+    assert!(vec![0i32].bar() == 2);\n+    assert!(vec![0i64].bar() == 3);\n+}\n+\n+fn main() {\n+    test_foo();\n+    test_bar();\n+}"}, {"sha": "f77b88e2f850ae622b604f8840e15e4ff0619896", "filename": "src/test/run-pass/specialization/defaultimpl/specialization-out-of-order.rs", "status": "added", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fspecialization-out-of-order.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fspecialization-out-of-order.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fspecialization-out-of-order.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -0,0 +1,27 @@\n+// Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// Test that you can list the more specific impl before the more general one.\n+\n+#![feature(specialization)]\n+\n+trait Foo {\n+    type Out;\n+}\n+\n+impl Foo for bool {\n+    type Out = ();\n+}\n+\n+default impl<T> Foo for T {\n+    type Out = bool;\n+}\n+\n+fn main() {}"}, {"sha": "500cded38c1adfc154a6dae17960e514c2d2d06c", "filename": "src/test/run-pass/specialization/defaultimpl/specialization-overlap-projection.rs", "status": "added", "additions": 33, "deletions": 0, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fspecialization-overlap-projection.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fspecialization-overlap-projection.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fspecialization-overlap-projection.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -0,0 +1,33 @@\n+// Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// Test that impls on projected self types can resolve overlap, even when the\n+// projections involve specialization, so long as the associated type is\n+// provided by the most specialized impl.\n+\n+#![feature(specialization)]\n+\n+trait Assoc {\n+    type Output;\n+}\n+\n+default impl<T> Assoc for T {\n+    type Output = bool;\n+}\n+\n+impl Assoc for u8 { type Output = u8; }\n+impl Assoc for u16 { type Output = u16; }\n+\n+trait Foo {}\n+impl Foo for u32 {}\n+impl Foo for <u8 as Assoc>::Output {}\n+impl Foo for <u16 as Assoc>::Output {}\n+\n+fn main() {}"}, {"sha": "2397c3e2bff5dbd5bde7a67a0ad79e168d5ea5cd", "filename": "src/test/run-pass/specialization/defaultimpl/specialization-projection-alias.rs", "status": "added", "additions": 32, "deletions": 0, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fspecialization-projection-alias.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fspecialization-projection-alias.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fspecialization-projection-alias.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -0,0 +1,32 @@\n+// Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![feature(specialization)]\n+\n+// Regression test for ICE when combining specialized associated types and type\n+// aliases\n+\n+trait Id_ {\n+    type Out;\n+}\n+\n+type Id<T> = <T as Id_>::Out;\n+\n+default impl<T> Id_ for T {\n+    type Out = T;\n+}\n+\n+fn test_proection() {\n+    let x: Id<bool> = panic!();\n+}\n+\n+fn main() {\n+\n+}"}, {"sha": "6a833ba6760f64ab7b6739904e1ee80e876cd9e4", "filename": "src/test/run-pass/specialization/defaultimpl/specialization-projection.rs", "status": "added", "additions": 49, "deletions": 0, "changes": 49, "blob_url": "https://github.com/rust-lang/rust/blob/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fspecialization-projection.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54ef80043a3864495555c96791118ab3a725fe6b/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fspecialization-projection.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fspecialization%2Fdefaultimpl%2Fspecialization-projection.rs?ref=54ef80043a3864495555c96791118ab3a725fe6b", "patch": "@@ -0,0 +1,49 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![feature(specialization)]\n+\n+// Make sure we *can* project non-defaulted associated types\n+// cf compile-fail/specialization-default-projection.rs\n+\n+// First, do so without any use of specialization\n+\n+trait Foo {\n+    type Assoc;\n+}\n+\n+impl<T> Foo for T {\n+    type Assoc = ();\n+}\n+\n+fn generic_foo<T>() -> <T as Foo>::Assoc {\n+    ()\n+}\n+\n+// Next, allow for one layer of specialization\n+\n+trait Bar {\n+    type Assoc;\n+}\n+\n+default impl<T> Bar for T {\n+    type Assoc = ();\n+}\n+\n+impl<T: Clone> Bar for T {\n+    type Assoc = u8;\n+}\n+\n+fn generic_bar_clone<T: Clone>() -> <T as Bar>::Assoc {\n+    0u8\n+}\n+\n+fn main() {\n+}"}]}