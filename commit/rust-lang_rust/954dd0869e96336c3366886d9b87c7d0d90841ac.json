{"sha": "954dd0869e96336c3366886d9b87c7d0d90841ac", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk1NGRkMDg2OWU5NjMzNmMzMzY2ODg2ZDliODdjN2QwZDkwODQxYWM=", "commit": {"author": {"name": "Marcus Klaas", "email": "mail@marcusklaas.nl", "date": "2015-12-25T18:07:51Z"}, "committer": {"name": "Marcus Klaas", "email": "mail@marcusklaas.nl", "date": "2015-12-25T18:07:51Z"}, "message": "Preserve mutability for typed self arguments", "tree": {"sha": "d28de619d233ea6805195fde5280fcf0947c302a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d28de619d233ea6805195fde5280fcf0947c302a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/954dd0869e96336c3366886d9b87c7d0d90841ac", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/954dd0869e96336c3366886d9b87c7d0d90841ac", "html_url": "https://github.com/rust-lang/rust/commit/954dd0869e96336c3366886d9b87c7d0d90841ac", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/954dd0869e96336c3366886d9b87c7d0d90841ac/comments", "author": {"login": "marcusklaas", "id": 1255413, "node_id": "MDQ6VXNlcjEyNTU0MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1255413?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marcusklaas", "html_url": "https://github.com/marcusklaas", "followers_url": "https://api.github.com/users/marcusklaas/followers", "following_url": "https://api.github.com/users/marcusklaas/following{/other_user}", "gists_url": "https://api.github.com/users/marcusklaas/gists{/gist_id}", "starred_url": "https://api.github.com/users/marcusklaas/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marcusklaas/subscriptions", "organizations_url": "https://api.github.com/users/marcusklaas/orgs", "repos_url": "https://api.github.com/users/marcusklaas/repos", "events_url": "https://api.github.com/users/marcusklaas/events{/privacy}", "received_events_url": "https://api.github.com/users/marcusklaas/received_events", "type": "User", "site_admin": false}, "committer": {"login": "marcusklaas", "id": 1255413, "node_id": "MDQ6VXNlcjEyNTU0MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1255413?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marcusklaas", "html_url": "https://github.com/marcusklaas", "followers_url": "https://api.github.com/users/marcusklaas/followers", "following_url": "https://api.github.com/users/marcusklaas/following{/other_user}", "gists_url": "https://api.github.com/users/marcusklaas/gists{/gist_id}", "starred_url": "https://api.github.com/users/marcusklaas/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marcusklaas/subscriptions", "organizations_url": "https://api.github.com/users/marcusklaas/orgs", "repos_url": "https://api.github.com/users/marcusklaas/repos", "events_url": "https://api.github.com/users/marcusklaas/events{/privacy}", "received_events_url": "https://api.github.com/users/marcusklaas/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c0b7de7c521dc65b2ad2b5a3c81fb56030f4af22", "url": "https://api.github.com/repos/rust-lang/rust/commits/c0b7de7c521dc65b2ad2b5a3c81fb56030f4af22", "html_url": "https://github.com/rust-lang/rust/commit/c0b7de7c521dc65b2ad2b5a3c81fb56030f4af22"}], "stats": {"total": 38, "additions": 26, "deletions": 12}, "files": [{"sha": "2224d9a5cb6ce4cc463697884309c76cb1ea0a5a", "filename": "src/items.rs", "status": "modified", "additions": 20, "deletions": 12, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/954dd0869e96336c3366886d9b87c7d0d90841ac/src%2Fitems.rs", "raw_url": "https://github.com/rust-lang/rust/raw/954dd0869e96336c3366886d9b87c7d0d90841ac/src%2Fitems.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fitems.rs?ref=954dd0869e96336c3366886d9b87c7d0d90841ac", "patch": "@@ -930,27 +930,35 @@ fn rewrite_explicit_self(explicit_self: &ast::ExplicitSelf, args: &[ast::Arg]) -\n             }\n         }\n         ast::ExplicitSelf_::SelfExplicit(ref ty, _) => {\n-            Some(format!(\"self: {}\", pprust::ty_to_string(ty)))\n+            assert!(!args.is_empty(), \"&[ast::Arg] shouldn't be empty.\");\n+\n+            let mutability = explicit_self_mutability(&args[0]);\n+\n+            Some(format!(\"{}self: {}\",\n+                         format_mutability(mutability),\n+                         pprust::ty_to_string(ty)))\n         }\n         ast::ExplicitSelf_::SelfValue(_) => {\n-            assert!(args.len() >= 1, \"&[ast::Arg] shouldn't be empty.\");\n+            assert!(!args.is_empty(), \"&[ast::Arg] shouldn't be empty.\");\n \n-            // this hacky solution caused by absence of `Mutability` in `SelfValue`.\n-            let mut_str = {\n-                if let ast::Pat_::PatIdent(ast::BindingMode::BindByValue(mutability), _, _) =\n-                       args[0].pat.node {\n-                    format_mutability(mutability)\n-                } else {\n-                    panic!(\"there is a bug or change in structure of AST, aborting.\");\n-                }\n-            };\n+            let mutability = explicit_self_mutability(&args[0]);\n \n-            Some(format!(\"{}self\", mut_str))\n+            Some(format!(\"{}self\", format_mutability(mutability)))\n         }\n         _ => None,\n     }\n }\n \n+// Hacky solution caused by absence of `Mutability` in `SelfValue` and\n+// `SelfExplicit` variants of `ast::ExplicitSelf_`.\n+fn explicit_self_mutability(arg: &ast::Arg) -> ast::Mutability {\n+    if let ast::Pat_::PatIdent(ast::BindingMode::BindByValue(mutability), _, _) = arg.pat.node {\n+        mutability\n+    } else {\n+        unreachable!()\n+    }\n+}\n+\n pub fn span_lo_for_arg(arg: &ast::Arg) -> BytePos {\n     if is_named_arg(arg) {\n         arg.pat.span.lo"}, {"sha": "016350ca6d63d60d37f916aeb88d5ad34118cd1e", "filename": "tests/source/impls.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/954dd0869e96336c3366886d9b87c7d0d90841ac/tests%2Fsource%2Fimpls.rs", "raw_url": "https://github.com/rust-lang/rust/raw/954dd0869e96336c3366886d9b87c7d0d90841ac/tests%2Fsource%2Fimpls.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fimpls.rs?ref=954dd0869e96336c3366886d9b87c7d0d90841ac", "patch": "@@ -58,3 +58,5 @@ impl Blah {\n     fn boop() {}\n     add_fun!();\n }\n+\n+impl X { fn do_parse(  mut  self : X ) {} }"}, {"sha": "9f12a6fd7ffc1fb061a07c6292239978bb3acfab", "filename": "tests/target/impls.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/954dd0869e96336c3366886d9b87c7d0d90841ac/tests%2Ftarget%2Fimpls.rs", "raw_url": "https://github.com/rust-lang/rust/raw/954dd0869e96336c3366886d9b87c7d0d90841ac/tests%2Ftarget%2Fimpls.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fimpls.rs?ref=954dd0869e96336c3366886d9b87c7d0d90841ac", "patch": "@@ -72,3 +72,7 @@ impl Blah {\n     fn boop() {}\n     add_fun!();\n }\n+\n+impl X {\n+    fn do_parse(mut self: X) {}\n+}"}]}