{"sha": "4de9c6d4913a02b5ce19a14e9e2ab0c46ceea771", "node_id": "C_kwDOAAsO6NoAKDRkZTljNmQ0OTEzYTAyYjVjZTE5YTE0ZTllMmFiMGM0NmNlZWE3NzE", "commit": {"author": {"name": "Michael Howell", "email": "michael@notriddle.com", "date": "2023-02-16T22:32:38Z"}, "committer": {"name": "Michael Howell", "email": "michael@notriddle.com", "date": "2023-02-17T01:16:09Z"}, "message": "rustdoc: search by macro when query ends with `!`\n\nRelated to #96399", "tree": {"sha": "4a8d56f30ffd5c60f68262fddb975dbef95ca382", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4a8d56f30ffd5c60f68262fddb975dbef95ca382"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4de9c6d4913a02b5ce19a14e9e2ab0c46ceea771", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4de9c6d4913a02b5ce19a14e9e2ab0c46ceea771", "html_url": "https://github.com/rust-lang/rust/commit/4de9c6d4913a02b5ce19a14e9e2ab0c46ceea771", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4de9c6d4913a02b5ce19a14e9e2ab0c46ceea771/comments", "author": {"login": "notriddle", "id": 1593513, "node_id": "MDQ6VXNlcjE1OTM1MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1593513?v=4", "gravatar_id": "", "url": "https://api.github.com/users/notriddle", "html_url": "https://github.com/notriddle", "followers_url": "https://api.github.com/users/notriddle/followers", "following_url": "https://api.github.com/users/notriddle/following{/other_user}", "gists_url": "https://api.github.com/users/notriddle/gists{/gist_id}", "starred_url": "https://api.github.com/users/notriddle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/notriddle/subscriptions", "organizations_url": "https://api.github.com/users/notriddle/orgs", "repos_url": "https://api.github.com/users/notriddle/repos", "events_url": "https://api.github.com/users/notriddle/events{/privacy}", "received_events_url": "https://api.github.com/users/notriddle/received_events", "type": "User", "site_admin": false}, "committer": {"login": "notriddle", "id": 1593513, "node_id": "MDQ6VXNlcjE1OTM1MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1593513?v=4", "gravatar_id": "", "url": "https://api.github.com/users/notriddle", "html_url": "https://github.com/notriddle", "followers_url": "https://api.github.com/users/notriddle/followers", "following_url": "https://api.github.com/users/notriddle/following{/other_user}", "gists_url": "https://api.github.com/users/notriddle/gists{/gist_id}", "starred_url": "https://api.github.com/users/notriddle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/notriddle/subscriptions", "organizations_url": "https://api.github.com/users/notriddle/orgs", "repos_url": "https://api.github.com/users/notriddle/repos", "events_url": "https://api.github.com/users/notriddle/events{/privacy}", "received_events_url": "https://api.github.com/users/notriddle/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c5d1b3ea9665e77e3af2f17b311bf65469eedc19", "url": "https://api.github.com/repos/rust-lang/rust/commits/c5d1b3ea9665e77e3af2f17b311bf65469eedc19", "html_url": "https://github.com/rust-lang/rust/commit/c5d1b3ea9665e77e3af2f17b311bf65469eedc19"}], "stats": {"total": 155, "additions": 132, "deletions": 23}, "files": [{"sha": "6a8e93a243681e78582f3ab1a72b8dfddeb4fc14", "filename": "src/librustdoc/html/static/js/search.js", "status": "modified", "additions": 24, "deletions": 4, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/4de9c6d4913a02b5ce19a14e9e2ab0c46ceea771/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsearch.js", "raw_url": "https://github.com/rust-lang/rust/raw/4de9c6d4913a02b5ce19a14e9e2ab0c46ceea771/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsearch.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsearch.js?ref=4de9c6d4913a02b5ce19a14e9e2ab0c46ceea771", "patch": "@@ -300,20 +300,21 @@ function initSearch(rawSearchIndex) {\n      * @return {integer}\n      */\n     function getIdentEndPosition(parserState) {\n+        const start = parserState.pos;\n         let end = parserState.pos;\n-        let foundExclamation = false;\n+        let foundExclamation = -1;\n         while (parserState.pos < parserState.length) {\n             const c = parserState.userQuery[parserState.pos];\n             if (!isIdentCharacter(c)) {\n                 if (c === \"!\") {\n-                    if (foundExclamation) {\n+                    if (foundExclamation !== -1) {\n                         throw new Error(\"Cannot have more than one `!` in an ident\");\n                     } else if (parserState.pos + 1 < parserState.length &&\n                         isIdentCharacter(parserState.userQuery[parserState.pos + 1])\n                     ) {\n                         throw new Error(\"`!` can only be at the end of an ident\");\n                     }\n-                    foundExclamation = true;\n+                    foundExclamation = parserState.pos;\n                 } else if (isErrorCharacter(c)) {\n                     throw new Error(`Unexpected \\`${c}\\``);\n                 } else if (\n@@ -326,16 +327,35 @@ function initSearch(rawSearchIndex) {\n                     if (!isPathStart(parserState)) {\n                         break;\n                     }\n+                    if (foundExclamation !== -1) {\n+                        if (start <= (end - 2)) {\n+                            throw new Error(\"Cannot have associated items in macros\");\n+                        } else {\n+                            // if start == end - 1, we got the never type\n+                            // while the never type has no associated macros, we still\n+                            // can parse a path like that\n+                            foundExclamation = -1;\n+                        }\n+                    }\n                     // Skip current \":\".\n                     parserState.pos += 1;\n-                    foundExclamation = false;\n                 } else {\n                     throw new Error(`Unexpected \\`${c}\\``);\n                 }\n             }\n             parserState.pos += 1;\n             end = parserState.pos;\n         }\n+        // if start == end - 1, we got the never type\n+        if (foundExclamation !== -1 && start <= (end - 2)) {\n+            if (parserState.typeFilter === null) {\n+                parserState.typeFilter = \"macro\";\n+            } else if (parserState.typeFilter !== \"macro\") {\n+                throw new Error(`Invalid search type: macro \\`!\\` and ` +\n+                    `\\`${parserState.typeFilter}\\` both specified`);\n+            }\n+            end = foundExclamation;\n+        }\n         return end;\n     }\n "}, {"sha": "f82a2472063ce62b15086a0d630d789a3363881d", "filename": "tests/rustdoc-js-std/parser-errors.js", "status": "modified", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/4de9c6d4913a02b5ce19a14e9e2ab0c46ceea771/tests%2Frustdoc-js-std%2Fparser-errors.js", "raw_url": "https://github.com/rust-lang/rust/raw/4de9c6d4913a02b5ce19a14e9e2ab0c46ceea771/tests%2Frustdoc-js-std%2Fparser-errors.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frustdoc-js-std%2Fparser-errors.js?ref=4de9c6d4913a02b5ce19a14e9e2ab0c46ceea771", "patch": "@@ -37,6 +37,8 @@ const QUERY = [\n     \"mod : :\",\n     \"a!a\",\n     \"a!!\",\n+    \"mod:a!\",\n+    \"a!::a\",\n ];\n \n const PARSED = [\n@@ -382,4 +384,22 @@ const PARSED = [\n         userQuery: \"a!!\",\n         error: 'Cannot have more than one `!` in an ident',\n     },\n+    {\n+        elems: [],\n+        foundElems: 0,\n+        original: \"mod:a!\",\n+        returned: [],\n+        typeFilter: -1,\n+        userQuery: \"mod:a!\",\n+        error: 'Invalid search type: macro `!` and `mod` both specified',\n+    },\n+    {\n+        elems: [],\n+        foundElems: 0,\n+        original: \"a!::a\",\n+        returned: [],\n+        typeFilter: -1,\n+        userQuery: \"a!::a\",\n+        error: 'Cannot have associated items in macros',\n+    },\n ];"}, {"sha": "01f65b478f8e9bdb0a6e298fc18aebd32f1284cc", "filename": "tests/rustdoc-js-std/parser-filter.js", "status": "modified", "additions": 46, "deletions": 1, "changes": 47, "blob_url": "https://github.com/rust-lang/rust/blob/4de9c6d4913a02b5ce19a14e9e2ab0c46ceea771/tests%2Frustdoc-js-std%2Fparser-filter.js", "raw_url": "https://github.com/rust-lang/rust/raw/4de9c6d4913a02b5ce19a14e9e2ab0c46ceea771/tests%2Frustdoc-js-std%2Fparser-filter.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frustdoc-js-std%2Fparser-filter.js?ref=4de9c6d4913a02b5ce19a14e9e2ab0c46ceea771", "patch": "@@ -1,4 +1,4 @@\n-const QUERY = ['fn:foo', 'enum : foo', 'macro<f>:foo'];\n+const QUERY = ['fn:foo', 'enum : foo', 'macro<f>:foo', 'macro!', 'macro:mac!', 'a::mac!'];\n \n const PARSED = [\n     {\n@@ -40,4 +40,49 @@ const PARSED = [\n         userQuery: \"macro<f>:foo\",\n         error: \"Unexpected `:`\",\n     },\n+    {\n+        elems: [{\n+            name: \"macro\",\n+            fullPath: [\"macro\"],\n+            pathWithoutLast: [],\n+            pathLast: \"macro\",\n+            generics: [],\n+        }],\n+        foundElems: 1,\n+        original: \"macro!\",\n+        returned: [],\n+        typeFilter: 14,\n+        userQuery: \"macro!\",\n+        error: null,\n+    },\n+    {\n+        elems: [{\n+            name: \"mac\",\n+            fullPath: [\"mac\"],\n+            pathWithoutLast: [],\n+            pathLast: \"mac\",\n+            generics: [],\n+        }],\n+        foundElems: 1,\n+        original: \"macro:mac!\",\n+        returned: [],\n+        typeFilter: 14,\n+        userQuery: \"macro:mac!\",\n+        error: null,\n+    },\n+    {\n+        elems: [{\n+            name: \"a::mac\",\n+            fullPath: [\"a\", \"mac\"],\n+            pathWithoutLast: [\"a\"],\n+            pathLast: \"mac\",\n+            generics: [],\n+        }],\n+        foundElems: 1,\n+        original: \"a::mac!\",\n+        returned: [],\n+        typeFilter: 14,\n+        userQuery: \"a::mac!\",\n+        error: null,\n+    },\n ];"}, {"sha": "6c17d00f16edc1e6658dcdb4a386e993ca467251", "filename": "tests/rustdoc-js-std/parser-ident.js", "status": "modified", "additions": 22, "deletions": 18, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/4de9c6d4913a02b5ce19a14e9e2ab0c46ceea771/tests%2Frustdoc-js-std%2Fparser-ident.js", "raw_url": "https://github.com/rust-lang/rust/raw/4de9c6d4913a02b5ce19a14e9e2ab0c46ceea771/tests%2Frustdoc-js-std%2Fparser-ident.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frustdoc-js-std%2Fparser-ident.js?ref=4de9c6d4913a02b5ce19a14e9e2ab0c46ceea771", "patch": "@@ -3,6 +3,7 @@ const QUERY = [\n     \"!\",\n     \"a!\",\n     \"a!::b\",\n+    \"!::b\",\n     \"a!::b!\",\n ];\n \n@@ -47,47 +48,50 @@ const PARSED = [\n     },\n     {\n         elems: [{\n-            name: \"a!\",\n-            fullPath: [\"a!\"],\n+            name: \"a\",\n+            fullPath: [\"a\"],\n             pathWithoutLast: [],\n-            pathLast: \"a!\",\n+            pathLast: \"a\",\n             generics: [],\n         }],\n         foundElems: 1,\n         original: \"a!\",\n         returned: [],\n-        typeFilter: -1,\n+        typeFilter: 14,\n         userQuery: \"a!\",\n         error: null,\n     },\n     {\n-        elems: [{\n-            name: \"a!::b\",\n-            fullPath: [\"a!\", \"b\"],\n-            pathWithoutLast: [\"a!\"],\n-            pathLast: \"b\",\n-            generics: [],\n-        }],\n-        foundElems: 1,\n+        elems: [],\n+        foundElems: 0,\n         original: \"a!::b\",\n         returned: [],\n         typeFilter: -1,\n         userQuery: \"a!::b\",\n-        error: null,\n+        error: \"Cannot have associated items in macros\",\n     },\n     {\n         elems: [{\n-            name: \"a!::b!\",\n-            fullPath: [\"a!\", \"b!\"],\n-            pathWithoutLast: [\"a!\"],\n-            pathLast: \"b!\",\n+            name: \"!::b\",\n+            fullPath: [\"!\", \"b\"],\n+            pathWithoutLast: [\"!\"],\n+            pathLast: \"b\",\n             generics: [],\n         }],\n         foundElems: 1,\n+        original: \"!::b\",\n+        returned: [],\n+        typeFilter: -1,\n+        userQuery: \"!::b\",\n+        error: null,\n+    },\n+    {\n+        elems: [],\n+        foundElems: 0,\n         original: \"a!::b!\",\n         returned: [],\n         typeFilter: -1,\n         userQuery: \"a!::b!\",\n-        error: null,\n+        error: \"Cannot have associated items in macros\",\n     },\n ];"}, {"sha": "2b179ce146bf0cc5a1b7f77169c554ede5b80fe6", "filename": "tests/rustdoc-js/macro-search.js", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/4de9c6d4913a02b5ce19a14e9e2ab0c46ceea771/tests%2Frustdoc-js%2Fmacro-search.js", "raw_url": "https://github.com/rust-lang/rust/raw/4de9c6d4913a02b5ce19a14e9e2ab0c46ceea771/tests%2Frustdoc-js%2Fmacro-search.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frustdoc-js%2Fmacro-search.js?ref=4de9c6d4913a02b5ce19a14e9e2ab0c46ceea771", "patch": "@@ -0,0 +1,10 @@\n+// exact-check\n+\n+const QUERY = 'abracadabra!';\n+\n+const EXPECTED = {\n+    'others': [\n+        { 'path': 'macro_search', 'name': 'abracadabra' },\n+        { 'path': 'macro_search', 'name': 'abracadabra_b' },\n+    ],\n+};"}, {"sha": "dc397490cf583f996e75b6dff5c7710dddbd57ff", "filename": "tests/rustdoc-js/macro-search.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/4de9c6d4913a02b5ce19a14e9e2ab0c46ceea771/tests%2Frustdoc-js%2Fmacro-search.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4de9c6d4913a02b5ce19a14e9e2ab0c46ceea771/tests%2Frustdoc-js%2Fmacro-search.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frustdoc-js%2Fmacro-search.rs?ref=4de9c6d4913a02b5ce19a14e9e2ab0c46ceea771", "patch": "@@ -0,0 +1,10 @@\n+#[macro_export]\n+macro_rules! abracadabra {\n+    () => {}\n+}\n+#[macro_export]\n+macro_rules! abracadabra_b {\n+    () => {}\n+}\n+pub fn abracadabra() {}\n+pub fn abracadabra_c() {}"}]}