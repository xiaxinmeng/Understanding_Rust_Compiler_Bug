{"sha": "fc9d578bc5ada5162f49ed02a547cf87f2456a93", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZjOWQ1NzhiYzVhZGE1MTYyZjQ5ZWQwMmE1NDdjZjg3ZjI0NTZhOTM=", "commit": {"author": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2021-02-22T21:54:09Z"}, "committer": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2021-02-22T22:07:22Z"}, "message": "expand: Preserve order of inert attributes during expansion", "tree": {"sha": "b19edc32bc0f09be847c126a60ae7271fc45b4ea", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b19edc32bc0f09be847c126a60ae7271fc45b4ea"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fc9d578bc5ada5162f49ed02a547cf87f2456a93", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fc9d578bc5ada5162f49ed02a547cf87f2456a93", "html_url": "https://github.com/rust-lang/rust/commit/fc9d578bc5ada5162f49ed02a547cf87f2456a93", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fc9d578bc5ada5162f49ed02a547cf87f2456a93/comments", "author": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "committer": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c02d21033d3603f1dac3bfd6062c37f69a1681cd", "url": "https://api.github.com/repos/rust-lang/rust/commits/c02d21033d3603f1dac3bfd6062c37f69a1681cd", "html_url": "https://github.com/rust-lang/rust/commit/c02d21033d3603f1dac3bfd6062c37f69a1681cd"}], "stats": {"total": 112, "additions": 55, "deletions": 57}, "files": [{"sha": "10c19ea105e4a2b2280d44244d7d4e3d56ae334e", "filename": "compiler/rustc_expand/src/expand.rs", "status": "modified", "additions": 14, "deletions": 9, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/fc9d578bc5ada5162f49ed02a547cf87f2456a93/compiler%2Frustc_expand%2Fsrc%2Fexpand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fc9d578bc5ada5162f49ed02a547cf87f2456a93/compiler%2Frustc_expand%2Fsrc%2Fexpand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_expand%2Fsrc%2Fexpand.rs?ref=fc9d578bc5ada5162f49ed02a547cf87f2456a93", "patch": "@@ -301,6 +301,8 @@ pub enum InvocationKind {\n     },\n     Attr {\n         attr: ast::Attribute,\n+        // Re-insertion position for inert attributes.\n+        pos: usize,\n         item: Annotatable,\n         // Required for resolving derive helper attributes.\n         derives: Vec<Path>,\n@@ -690,7 +692,7 @@ impl<'a, 'b> MacroExpander<'a, 'b> {\n                 }\n                 _ => unreachable!(),\n             },\n-            InvocationKind::Attr { attr, mut item, derives } => match ext {\n+            InvocationKind::Attr { attr, pos, mut item, derives } => match ext {\n                 SyntaxExtensionKind::Attr(expander) => {\n                     self.gate_proc_macro_input(&item);\n                     self.gate_proc_macro_attr_item(span, &item);\n@@ -721,7 +723,7 @@ impl<'a, 'b> MacroExpander<'a, 'b> {\n                                 ExpandResult::Retry(item) => {\n                                     // Reassemble the original invocation for retrying.\n                                     return ExpandResult::Retry(Invocation {\n-                                        kind: InvocationKind::Attr { attr, item, derives },\n+                                        kind: InvocationKind::Attr { attr, pos, item, derives },\n                                         ..invoc\n                                     });\n                                 }\n@@ -739,7 +741,7 @@ impl<'a, 'b> MacroExpander<'a, 'b> {\n                     if *mark_used {\n                         self.cx.sess.mark_attr_used(&attr);\n                     }\n-                    item.visit_attrs(|attrs| attrs.push(attr));\n+                    item.visit_attrs(|attrs| attrs.insert(pos, attr));\n                     fragment_kind.expect_from_annotatables(iter::once(item))\n                 }\n                 _ => unreachable!(),\n@@ -1000,17 +1002,20 @@ impl<'a, 'b> InvocationCollector<'a, 'b> {\n \n     fn collect_attr(\n         &mut self,\n-        (attr, derives): (ast::Attribute, Vec<Path>),\n+        (attr, pos, derives): (ast::Attribute, usize, Vec<Path>),\n         item: Annotatable,\n         kind: AstFragmentKind,\n     ) -> AstFragment {\n-        self.collect(kind, InvocationKind::Attr { attr, item, derives })\n+        self.collect(kind, InvocationKind::Attr { attr, pos, item, derives })\n     }\n \n     /// If `item` is an attribute invocation, remove the attribute and return it together with\n-    /// derives following it. We have to collect the derives in order to resolve legacy derive\n-    /// helpers (helpers written before derives that introduce them).\n-    fn take_first_attr(&mut self, item: &mut impl HasAttrs) -> Option<(ast::Attribute, Vec<Path>)> {\n+    /// its position and derives following it. We have to collect the derives in order to resolve\n+    /// legacy derive helpers (helpers written before derives that introduce them).\n+    fn take_first_attr(\n+        &mut self,\n+        item: &mut impl HasAttrs,\n+    ) -> Option<(ast::Attribute, usize, Vec<Path>)> {\n         let mut attr = None;\n \n         item.visit_attrs(|attrs| {\n@@ -1033,7 +1038,7 @@ impl<'a, 'b> InvocationCollector<'a, 'b> {\n                         })\n                         .collect();\n \n-                    (attr, following_derives)\n+                    (attr, attr_pos, following_derives)\n                 })\n         });\n "}, {"sha": "4a7e48eed46c3130e9e9f8ed470094e70fdc3dee", "filename": "src/test/ui/proc-macro/derive-helper-legacy-spurious.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/fc9d578bc5ada5162f49ed02a547cf87f2456a93/src%2Ftest%2Fui%2Fproc-macro%2Fderive-helper-legacy-spurious.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fc9d578bc5ada5162f49ed02a547cf87f2456a93/src%2Ftest%2Fui%2Fproc-macro%2Fderive-helper-legacy-spurious.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Fderive-helper-legacy-spurious.rs?ref=fc9d578bc5ada5162f49ed02a547cf87f2456a93", "patch": "@@ -6,8 +6,7 @@\n extern crate test_macros;\n \n #[derive(Empty)] //~ ERROR cannot determine resolution for the attribute macro `derive`\n-#[empty_helper] //~ WARN derive helper attribute is used before it is introduced\n-                //~| WARN this was previously accepted\n+#[empty_helper] //~ ERROR cannot find attribute `empty_helper` in this scope\n struct Foo {}\n \n fn main() {}"}, {"sha": "fd1ed8a3d0ff3e4e520c1269974641ca73694f0f", "filename": "src/test/ui/proc-macro/derive-helper-legacy-spurious.stderr", "status": "modified", "additions": 2, "deletions": 8, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/fc9d578bc5ada5162f49ed02a547cf87f2456a93/src%2Ftest%2Fui%2Fproc-macro%2Fderive-helper-legacy-spurious.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/fc9d578bc5ada5162f49ed02a547cf87f2456a93/src%2Ftest%2Fui%2Fproc-macro%2Fderive-helper-legacy-spurious.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Fderive-helper-legacy-spurious.stderr?ref=fc9d578bc5ada5162f49ed02a547cf87f2456a93", "patch": "@@ -12,17 +12,11 @@ LL | #[derive(Empty)]\n    |\n    = note: import resolution is stuck, try simplifying macro imports\n \n-warning: derive helper attribute is used before it is introduced\n+error: cannot find attribute `empty_helper` in this scope\n   --> $DIR/derive-helper-legacy-spurious.rs:9:3\n    |\n-LL | #[derive(Empty)]\n-   |          ----- the attribute is introduced here\n LL | #[empty_helper]\n    |   ^^^^^^^^^^^^\n-   |\n-   = note: `#[warn(legacy_derive_helpers)]` on by default\n-   = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n-   = note: for more information, see issue #79202 <https://github.com/rust-lang/rust/issues/79202>\n \n-error: aborting due to 2 previous errors; 1 warning emitted\n+error: aborting due to 3 previous errors\n "}, {"sha": "cc215545952df3c43107e999346b30aff3009702", "filename": "src/test/ui/proc-macro/inert-attribute-order.stdout", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/fc9d578bc5ada5162f49ed02a547cf87f2456a93/src%2Ftest%2Fui%2Fproc-macro%2Finert-attribute-order.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/fc9d578bc5ada5162f49ed02a547cf87f2456a93/src%2Ftest%2Fui%2Fproc-macro%2Finert-attribute-order.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Finert-attribute-order.stdout?ref=fc9d578bc5ada5162f49ed02a547cf87f2456a93", "patch": "@@ -1,7 +1,7 @@\n PRINT-ATTR INPUT (DISPLAY): /// 1\n-#[doc = \"3\"] #[doc = \"4\"] #[rustfmt :: attr5] /// 6\n-#[print_attr(nodebug)] #[rustfmt :: attr2] struct S ;\n-PRINT-ATTR RE-COLLECTED (DISPLAY): #[doc = \" 1\"] #[doc = \"3\"] #[doc = \"4\"] #[rustfmt :: attr5] #[doc = \" 6\"]\n-#[print_attr(nodebug)] #[rustfmt :: attr2] struct S ;\n-PRINT-ATTR INPUT (DISPLAY): #[doc = \" 1\"] #[doc = \"3\"] #[doc = \"4\"] #[doc = \" 6\"] #[rustfmt :: attr2]\n-#[rustfmt :: attr5] struct S ;\n+#[rustfmt :: attr2] #[doc = \"3\"] #[doc = \"4\"] #[rustfmt :: attr5] /// 6\n+#[print_attr(nodebug)] struct S ;\n+PRINT-ATTR RE-COLLECTED (DISPLAY): #[doc = \" 1\"] #[rustfmt :: attr2] #[doc = \"3\"] #[doc = \"4\"]\n+#[rustfmt :: attr5] #[doc = \" 6\"] #[print_attr(nodebug)] struct S ;\n+PRINT-ATTR INPUT (DISPLAY): #[doc = \" 1\"] #[rustfmt :: attr2] #[doc = \"3\"] #[doc = \"4\"]\n+#[rustfmt :: attr5] #[doc = \" 6\"] struct S ;"}, {"sha": "15e63c20eb9bc581790abf52c7e6e78a77f87a6d", "filename": "src/test/ui/proc-macro/issue-75930-derive-cfg.stdout", "status": "modified", "additions": 32, "deletions": 32, "changes": 64, "blob_url": "https://github.com/rust-lang/rust/blob/fc9d578bc5ada5162f49ed02a547cf87f2456a93/src%2Ftest%2Fui%2Fproc-macro%2Fissue-75930-derive-cfg.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/fc9d578bc5ada5162f49ed02a547cf87f2456a93/src%2Ftest%2Fui%2Fproc-macro%2Fissue-75930-derive-cfg.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Fissue-75930-derive-cfg.stdout?ref=fc9d578bc5ada5162f49ed02a547cf87f2456a93", "patch": "@@ -1,4 +1,4 @@\n-PRINT-ATTR INPUT (DISPLAY): #[allow(dead_code)] #[derive(Print)] #[print_helper(b)] #[print_helper(a)]\n+PRINT-ATTR INPUT (DISPLAY): #[print_helper(a)] #[allow(dead_code)] #[derive(Print)] #[print_helper(b)]\n struct Foo < #[cfg(FALSE)] A, B >\n {\n     #[cfg(FALSE)] first : String, #[cfg_attr(FALSE, deny(warnings))] second :\n@@ -23,6 +23,31 @@ struct Foo < #[cfg(FALSE)] A, B >\n      }], #[print_helper(d)] fourth : B\n }\n PRINT-ATTR INPUT (DEBUG): TokenStream [\n+    Punct {\n+        ch: '#',\n+        spacing: Alone,\n+        span: $DIR/issue-75930-derive-cfg.rs:16:1: 16:2 (#0),\n+    },\n+    Group {\n+        delimiter: Bracket,\n+        stream: TokenStream [\n+            Ident {\n+                ident: \"print_helper\",\n+                span: $DIR/issue-75930-derive-cfg.rs:16:3: 16:15 (#0),\n+            },\n+            Group {\n+                delimiter: Parenthesis,\n+                stream: TokenStream [\n+                    Ident {\n+                        ident: \"a\",\n+                        span: $DIR/issue-75930-derive-cfg.rs:16:16: 16:17 (#0),\n+                    },\n+                ],\n+                span: $DIR/issue-75930-derive-cfg.rs:16:15: 16:18 (#0),\n+            },\n+        ],\n+        span: $DIR/issue-75930-derive-cfg.rs:16:2: 16:19 (#0),\n+    },\n     Punct {\n         ch: '#',\n         spacing: Alone,\n@@ -98,31 +123,6 @@ PRINT-ATTR INPUT (DEBUG): TokenStream [\n         ],\n         span: $DIR/issue-75930-derive-cfg.rs:21:2: 21:19 (#0),\n     },\n-    Punct {\n-        ch: '#',\n-        spacing: Alone,\n-        span: $DIR/issue-75930-derive-cfg.rs:16:1: 16:2 (#0),\n-    },\n-    Group {\n-        delimiter: Bracket,\n-        stream: TokenStream [\n-            Ident {\n-                ident: \"print_helper\",\n-                span: $DIR/issue-75930-derive-cfg.rs:16:3: 16:15 (#0),\n-            },\n-            Group {\n-                delimiter: Parenthesis,\n-                stream: TokenStream [\n-                    Ident {\n-                        ident: \"a\",\n-                        span: $DIR/issue-75930-derive-cfg.rs:16:16: 16:17 (#0),\n-                    },\n-                ],\n-                span: $DIR/issue-75930-derive-cfg.rs:16:15: 16:18 (#0),\n-            },\n-        ],\n-        span: $DIR/issue-75930-derive-cfg.rs:16:2: 16:19 (#0),\n-    },\n     Ident {\n         ident: \"struct\",\n         span: $DIR/issue-75930-derive-cfg.rs:22:1: 22:7 (#0),\n@@ -1194,7 +1194,7 @@ PRINT-ATTR INPUT (DEBUG): TokenStream [\n         span: $DIR/issue-75930-derive-cfg.rs:22:32: 65:2 (#0),\n     },\n ]\n-PRINT-DERIVE INPUT (DISPLAY): #[allow(dead_code)] #[print_helper(b)] #[print_helper(a)] struct Foo < B >\n+PRINT-DERIVE INPUT (DISPLAY): #[print_helper(a)] #[allow(dead_code)] #[print_helper(b)] struct Foo < B >\n {\n     second : bool, third :\n     [u8 ;\n@@ -1217,14 +1217,14 @@ PRINT-DERIVE INPUT (DEBUG): TokenStream [\n         delimiter: Bracket,\n         stream: TokenStream [\n             Ident {\n-                ident: \"allow\",\n+                ident: \"print_helper\",\n                 span: $DIR/issue-75930-derive-cfg.rs:22:1: 65:2 (#0),\n             },\n             Group {\n                 delimiter: Parenthesis,\n                 stream: TokenStream [\n                     Ident {\n-                        ident: \"dead_code\",\n+                        ident: \"a\",\n                         span: $DIR/issue-75930-derive-cfg.rs:22:1: 65:2 (#0),\n                     },\n                 ],\n@@ -1242,14 +1242,14 @@ PRINT-DERIVE INPUT (DEBUG): TokenStream [\n         delimiter: Bracket,\n         stream: TokenStream [\n             Ident {\n-                ident: \"print_helper\",\n+                ident: \"allow\",\n                 span: $DIR/issue-75930-derive-cfg.rs:22:1: 65:2 (#0),\n             },\n             Group {\n                 delimiter: Parenthesis,\n                 stream: TokenStream [\n                     Ident {\n-                        ident: \"b\",\n+                        ident: \"dead_code\",\n                         span: $DIR/issue-75930-derive-cfg.rs:22:1: 65:2 (#0),\n                     },\n                 ],\n@@ -1274,7 +1274,7 @@ PRINT-DERIVE INPUT (DEBUG): TokenStream [\n                 delimiter: Parenthesis,\n                 stream: TokenStream [\n                     Ident {\n-                        ident: \"a\",\n+                        ident: \"b\",\n                         span: $DIR/issue-75930-derive-cfg.rs:22:1: 65:2 (#0),\n                     },\n                 ],"}]}