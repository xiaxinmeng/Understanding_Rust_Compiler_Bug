{"sha": "6fa5a2f66fddd473d265e646b41da43d20e87ec2", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZmYTVhMmY2NmZkZGQ0NzNkMjY1ZTY0NmI0MWRhNDNkMjBlODdlYzI=", "commit": {"author": {"name": "Bj\u00f6rn Steinbrink", "email": "bsteinbr@gmail.com", "date": "2014-10-08T21:20:18Z"}, "committer": {"name": "Bj\u00f6rn Steinbrink", "email": "bsteinbr@gmail.com", "date": "2014-10-09T09:09:17Z"}, "message": "Properly translate boolean statics to be stored as i8\n\nWhile booleans are represented as i1 in SSA values, LLVM expects them\nto be stored/loaded as i8 values. Using i1 as we do now works, but\nkills some optimizations, so we should switch to i8, just like we do\neverywhere else.\n\nFixes #16959.", "tree": {"sha": "93bf344c9e2090cbb46a17ee53913f2ae41cd6dd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/93bf344c9e2090cbb46a17ee53913f2ae41cd6dd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6fa5a2f66fddd473d265e646b41da43d20e87ec2", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6fa5a2f66fddd473d265e646b41da43d20e87ec2", "html_url": "https://github.com/rust-lang/rust/commit/6fa5a2f66fddd473d265e646b41da43d20e87ec2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6fa5a2f66fddd473d265e646b41da43d20e87ec2/comments", "author": {"login": "dotdash", "id": 230962, "node_id": "MDQ6VXNlcjIzMDk2Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dotdash", "html_url": "https://github.com/dotdash", "followers_url": "https://api.github.com/users/dotdash/followers", "following_url": "https://api.github.com/users/dotdash/following{/other_user}", "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}", "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions", "organizations_url": "https://api.github.com/users/dotdash/orgs", "repos_url": "https://api.github.com/users/dotdash/repos", "events_url": "https://api.github.com/users/dotdash/events{/privacy}", "received_events_url": "https://api.github.com/users/dotdash/received_events", "type": "User", "site_admin": false}, "committer": {"login": "dotdash", "id": 230962, "node_id": "MDQ6VXNlcjIzMDk2Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dotdash", "html_url": "https://github.com/dotdash", "followers_url": "https://api.github.com/users/dotdash/followers", "following_url": "https://api.github.com/users/dotdash/following{/other_user}", "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}", "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions", "organizations_url": "https://api.github.com/users/dotdash/orgs", "repos_url": "https://api.github.com/users/dotdash/repos", "events_url": "https://api.github.com/users/dotdash/events{/privacy}", "received_events_url": "https://api.github.com/users/dotdash/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "57af34b9ad2a4a5a8932ccb06d022d5f8c5807bc", "url": "https://api.github.com/repos/rust-lang/rust/commits/57af34b9ad2a4a5a8932ccb06d022d5f8c5807bc", "html_url": "https://github.com/rust-lang/rust/commit/57af34b9ad2a4a5a8932ccb06d022d5f8c5807bc"}], "stats": {"total": 17, "additions": 15, "deletions": 2}, "files": [{"sha": "d175919fb81084f9ddb616c19150583ca828b509", "filename": "src/librustc/middle/trans/base.rs", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/6fa5a2f66fddd473d265e646b41da43d20e87ec2/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6fa5a2f66fddd473d265e646b41da43d20e87ec2/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs?ref=6fa5a2f66fddd473d265e646b41da43d20e87ec2", "patch": "@@ -2680,12 +2680,18 @@ pub fn get_item_val(ccx: &CrateContext, id: ast::NodeId) -> ValueRef {\n \n                     // We need the translated value here, because for enums the\n                     // LLVM type is not fully determined by the Rust type.\n-                    let (v, inlineable, _) = consts::const_expr(ccx, &**expr, is_local);\n+                    let (v, inlineable, ty) = consts::const_expr(ccx, &**expr, is_local);\n                     ccx.const_values().borrow_mut().insert(id, v);\n                     let mut inlineable = inlineable;\n \n                     unsafe {\n-                        let llty = llvm::LLVMTypeOf(v);\n+                        // boolean SSA values are i1, but they have to be stored in i8 slots,\n+                        // otherwise some LLVM optimization passes don't work as expected\n+                        let llty = if ty::type_is_bool(ty) {\n+                            llvm::LLVMInt8TypeInContext(ccx.llcx())\n+                        } else {\n+                            llvm::LLVMTypeOf(v)\n+                        };\n                         if contains_null(sym.as_slice()) {\n                             ccx.sess().fatal(\n                                 format!(\"Illegal null byte in export_name value: `{}`\","}, {"sha": "5e4692bd0f617321ed2042ace6d58294303a9f6b", "filename": "src/librustc/middle/trans/consts.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/6fa5a2f66fddd473d265e646b41da43d20e87ec2/src%2Flibrustc%2Fmiddle%2Ftrans%2Fconsts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6fa5a2f66fddd473d265e646b41da43d20e87ec2/src%2Flibrustc%2Fmiddle%2Ftrans%2Fconsts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fconsts.rs?ref=6fa5a2f66fddd473d265e646b41da43d20e87ec2", "patch": "@@ -701,6 +701,13 @@ pub fn trans_const(ccx: &CrateContext, m: ast::Mutability, id: ast::NodeId) {\n         // At this point, get_item_val has already translated the\n         // constant's initializer to determine its LLVM type.\n         let v = ccx.const_values().borrow().get_copy(&id);\n+        // boolean SSA values are i1, but they have to be stored in i8 slots,\n+        // otherwise some LLVM optimization passes don't work as expected\n+        let v = if llvm::LLVMTypeOf(v) == Type::i1(ccx).to_ref() {\n+            llvm::LLVMConstZExt(v, Type::i8(ccx).to_ref())\n+        } else {\n+            v\n+        };\n         llvm::LLVMSetInitializer(g, v);\n \n         // `get_item_val` left `g` with external linkage, but we just set an"}]}