{"sha": "6c3c3e0952b63cfae51392863e94d79c2d76deb9", "node_id": "C_kwDOAAsO6NoAKDZjM2MzZTA5NTJiNjNjZmFlNTEzOTI4NjNlOTRkNzljMmQ3NmRlYjk", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2021-11-28T18:00:37Z"}, "committer": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2021-11-29T16:49:31Z"}, "message": "CTFE: support assert_zero_valid and assert_uninit_valid", "tree": {"sha": "ecdda752236c95b4443ce78f9b89f1ff348015a5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ecdda752236c95b4443ce78f9b89f1ff348015a5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6c3c3e0952b63cfae51392863e94d79c2d76deb9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6c3c3e0952b63cfae51392863e94d79c2d76deb9", "html_url": "https://github.com/rust-lang/rust/commit/6c3c3e0952b63cfae51392863e94d79c2d76deb9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6c3c3e0952b63cfae51392863e94d79c2d76deb9/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "58f9efd36de5669ab731ec7ebf565999ff17b159", "url": "https://api.github.com/repos/rust-lang/rust/commits/58f9efd36de5669ab731ec7ebf565999ff17b159", "html_url": "https://github.com/rust-lang/rust/commit/58f9efd36de5669ab731ec7ebf565999ff17b159"}], "stats": {"total": 117, "additions": 88, "deletions": 29}, "files": [{"sha": "025d2998b00525e4ee1a1e99ea8143ee365393d7", "filename": "compiler/rustc_const_eval/src/interpret/intrinsics.rs", "status": "modified", "additions": 25, "deletions": 1, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/6c3c3e0952b63cfae51392863e94d79c2d76deb9/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fintrinsics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6c3c3e0952b63cfae51392863e94d79c2d76deb9/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fintrinsics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Fintrinsics.rs?ref=6c3c3e0952b63cfae51392863e94d79c2d76deb9", "patch": "@@ -394,10 +394,12 @@ impl<'mir, 'tcx: 'mir, M: Machine<'mir, 'tcx>> InterpCx<'mir, 'tcx, M> {\n             sym::transmute => {\n                 self.copy_op_transmute(&args[0], dest)?;\n             }\n-            sym::assert_inhabited => {\n+            sym::assert_inhabited | sym::assert_zero_valid | sym::assert_uninit_valid => {\n                 let ty = instance.substs.type_at(0);\n                 let layout = self.layout_of(ty)?;\n \n+                // For *all* intrinsics we first check `is_uninhabited` to give a more specific\n+                // error message.\n                 if layout.abi.is_uninhabited() {\n                     // The run-time intrinsic panics just to get a good backtrace; here we abort\n                     // since there is no problem showing a backtrace even for aborts.\n@@ -409,6 +411,28 @@ impl<'mir, 'tcx: 'mir, M: Machine<'mir, 'tcx>> InterpCx<'mir, 'tcx, M> {\n                         ),\n                     )?;\n                 }\n+                if intrinsic_name == sym::assert_zero_valid\n+                    && !layout.might_permit_raw_init(self, /*zero:*/ true)\n+                {\n+                    M::abort(\n+                        self,\n+                        format!(\n+                            \"aborted execution: attempted to zero-initialize type `{}`, which is invalid\",\n+                            ty\n+                        ),\n+                    )?;\n+                }\n+                if intrinsic_name == sym::assert_uninit_valid\n+                    && !layout.might_permit_raw_init(self, /*zero:*/ false)\n+                {\n+                    M::abort(\n+                        self,\n+                        format!(\n+                            \"aborted execution: attempted to leave type `{}` uninitialized, which is invalid\",\n+                            ty\n+                        ),\n+                    )?;\n+                }\n             }\n             sym::simd_insert => {\n                 let index = u64::from(self.read_scalar(&args[1])?.to_u32()?);"}, {"sha": "edbc250eb0d0c2a243da0244046d1cfad5c82c48", "filename": "library/core/src/intrinsics.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/6c3c3e0952b63cfae51392863e94d79c2d76deb9/library%2Fcore%2Fsrc%2Fintrinsics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6c3c3e0952b63cfae51392863e94d79c2d76deb9/library%2Fcore%2Fsrc%2Fintrinsics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fintrinsics.rs?ref=6c3c3e0952b63cfae51392863e94d79c2d76deb9", "patch": "@@ -860,12 +860,14 @@ extern \"rust-intrinsic\" {\n     /// zero-initialization: This will statically either panic, or do nothing.\n     ///\n     /// This intrinsic does not have a stable counterpart.\n+    #[rustc_const_unstable(feature = \"const_assert_type2\", issue = \"none\")]\n     pub fn assert_zero_valid<T>();\n \n     /// A guard for unsafe functions that cannot ever be executed if `T` has invalid\n     /// bit patterns: This will statically either panic, or do nothing.\n     ///\n     /// This intrinsic does not have a stable counterpart.\n+    #[rustc_const_unstable(feature = \"const_assert_type2\", issue = \"none\")]\n     pub fn assert_uninit_valid<T>();\n \n     /// Gets a reference to a static `Location` indicating where it was called."}, {"sha": "31ff6aed03b2fd733b682adf59747d3fb12eb076", "filename": "src/test/ui/consts/assert-type-intrinsics.rs", "status": "added", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/6c3c3e0952b63cfae51392863e94d79c2d76deb9/src%2Ftest%2Fui%2Fconsts%2Fassert-type-intrinsics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6c3c3e0952b63cfae51392863e94d79c2d76deb9/src%2Ftest%2Fui%2Fconsts%2Fassert-type-intrinsics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fassert-type-intrinsics.rs?ref=6c3c3e0952b63cfae51392863e94d79c2d76deb9", "patch": "@@ -0,0 +1,22 @@\n+// error-pattern: any use of this value will cause an error\n+\n+#![feature(never_type)]\n+#![feature(const_maybe_uninit_assume_init, const_assert_type2)]\n+#![feature(core_intrinsics)]\n+\n+use std::intrinsics;\n+\n+#[allow(invalid_value)]\n+fn main() {\n+    use std::mem::MaybeUninit;\n+\n+    const _BAD1: () = unsafe {\n+        MaybeUninit::<!>::uninit().assume_init();\n+    };\n+    const _BAD2: () = unsafe {\n+        intrinsics::assert_uninit_valid::<bool>();\n+    };\n+    const _BAD3: () = unsafe {\n+        intrinsics::assert_zero_valid::<&'static i32>();\n+    };\n+}"}, {"sha": "bb57ee82cc16f973dfb448490a2992d87cafbad5", "filename": "src/test/ui/consts/assert-type-intrinsics.stderr", "status": "added", "additions": 39, "deletions": 0, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/6c3c3e0952b63cfae51392863e94d79c2d76deb9/src%2Ftest%2Fui%2Fconsts%2Fassert-type-intrinsics.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/6c3c3e0952b63cfae51392863e94d79c2d76deb9/src%2Ftest%2Fui%2Fconsts%2Fassert-type-intrinsics.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fassert-type-intrinsics.stderr?ref=6c3c3e0952b63cfae51392863e94d79c2d76deb9", "patch": "@@ -0,0 +1,39 @@\n+error: any use of this value will cause an error\n+  --> $DIR/assert-type-intrinsics.rs:14:9\n+   |\n+LL | /     const _BAD1: () = unsafe {\n+LL | |         MaybeUninit::<!>::uninit().assume_init();\n+   | |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ aborted execution: attempted to instantiate uninhabited type `!`\n+LL | |     };\n+   | |______-\n+   |\n+   = note: `#[deny(const_err)]` on by default\n+   = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n+   = note: for more information, see issue #71800 <https://github.com/rust-lang/rust/issues/71800>\n+\n+error: any use of this value will cause an error\n+  --> $DIR/assert-type-intrinsics.rs:17:9\n+   |\n+LL | /     const _BAD2: () = unsafe {\n+LL | |         intrinsics::assert_uninit_valid::<bool>();\n+   | |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ aborted execution: attempted to leave type `bool` uninitialized, which is invalid\n+LL | |     };\n+   | |______-\n+   |\n+   = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n+   = note: for more information, see issue #71800 <https://github.com/rust-lang/rust/issues/71800>\n+\n+error: any use of this value will cause an error\n+  --> $DIR/assert-type-intrinsics.rs:20:9\n+   |\n+LL | /     const _BAD3: () = unsafe {\n+LL | |         intrinsics::assert_zero_valid::<&'static i32>();\n+   | |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ aborted execution: attempted to zero-initialize type `&i32`, which is invalid\n+LL | |     };\n+   | |______-\n+   |\n+   = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n+   = note: for more information, see issue #71800 <https://github.com/rust-lang/rust/issues/71800>\n+\n+error: aborting due to 3 previous errors\n+"}, {"sha": "77370e1ccc59e2e74d8d27ed7b6a59765264b4d1", "filename": "src/test/ui/consts/assume-type-intrinsics.rs", "status": "removed", "additions": 0, "deletions": 13, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/58f9efd36de5669ab731ec7ebf565999ff17b159/src%2Ftest%2Fui%2Fconsts%2Fassume-type-intrinsics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/58f9efd36de5669ab731ec7ebf565999ff17b159/src%2Ftest%2Fui%2Fconsts%2Fassume-type-intrinsics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fassume-type-intrinsics.rs?ref=58f9efd36de5669ab731ec7ebf565999ff17b159", "patch": "@@ -1,13 +0,0 @@\n-// error-pattern: any use of this value will cause an error\n-\n-#![feature(never_type)]\n-#![feature(const_maybe_uninit_assume_init)]\n-\n-#[allow(invalid_value)]\n-fn main() {\n-    use std::mem::MaybeUninit;\n-\n-    const _BAD: () = unsafe {\n-        MaybeUninit::<!>::uninit().assume_init();\n-    };\n-}"}, {"sha": "e660730396fa1c97e8e0ca197a9a04f13585ad34", "filename": "src/test/ui/consts/assume-type-intrinsics.stderr", "status": "removed", "additions": 0, "deletions": 15, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/58f9efd36de5669ab731ec7ebf565999ff17b159/src%2Ftest%2Fui%2Fconsts%2Fassume-type-intrinsics.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/58f9efd36de5669ab731ec7ebf565999ff17b159/src%2Ftest%2Fui%2Fconsts%2Fassume-type-intrinsics.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fassume-type-intrinsics.stderr?ref=58f9efd36de5669ab731ec7ebf565999ff17b159", "patch": "@@ -1,15 +0,0 @@\n-error: any use of this value will cause an error\n-  --> $DIR/assume-type-intrinsics.rs:11:9\n-   |\n-LL | /     const _BAD: () = unsafe {\n-LL | |         MaybeUninit::<!>::uninit().assume_init();\n-   | |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ aborted execution: attempted to instantiate uninhabited type `!`\n-LL | |     };\n-   | |______-\n-   |\n-   = note: `#[deny(const_err)]` on by default\n-   = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n-   = note: for more information, see issue #71800 <https://github.com/rust-lang/rust/issues/71800>\n-\n-error: aborting due to previous error\n-"}]}