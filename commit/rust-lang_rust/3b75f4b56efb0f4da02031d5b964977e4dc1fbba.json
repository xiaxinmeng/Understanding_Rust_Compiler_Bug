{"sha": "3b75f4b56efb0f4da02031d5b964977e4dc1fbba", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNiNzVmNGI1NmVmYjBmNGRhMDIwMzFkNWI5NjQ5NzdlNGRjMWZiYmE=", "commit": {"author": {"name": "Steve Klabnik", "email": "steve@steveklabnik.com", "date": "2016-05-11T13:27:43Z"}, "committer": {"name": "Steve Klabnik", "email": "steve@steveklabnik.com", "date": "2016-05-11T13:27:43Z"}, "message": "Rollup merge of #33345 - birkenfeld:issue-31754, r=pnkfelix\n\nmiddle: reset loop labels while visiting closure\n\nThis should fix #31754 and follow-up #25343.  Before the latter, the closure was visited twice in the context of the enclosing fn, which made even a single closure with a loop label emit a warning.\n\nWith this change, the closure is still visited within the context of the main fn (which is intended, since it is not a separate item) but resets the found loop labels while being visited.\n\nFixes: #31754\n\nNote: I amended the test file from #25343, but I don't know if the original or amended test are effective, since as far as I could see, compiletest's run-pass tests do not check for zero warnings emitted?\n\n/cc @Manishearth", "tree": {"sha": "278f09955374c1ce8d768dc05be4cd88ab1009a8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/278f09955374c1ce8d768dc05be4cd88ab1009a8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3b75f4b56efb0f4da02031d5b964977e4dc1fbba", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3b75f4b56efb0f4da02031d5b964977e4dc1fbba", "html_url": "https://github.com/rust-lang/rust/commit/3b75f4b56efb0f4da02031d5b964977e4dc1fbba", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3b75f4b56efb0f4da02031d5b964977e4dc1fbba/comments", "author": {"login": "steveklabnik", "id": 27786, "node_id": "MDQ6VXNlcjI3Nzg2", "avatar_url": "https://avatars.githubusercontent.com/u/27786?v=4", "gravatar_id": "", "url": "https://api.github.com/users/steveklabnik", "html_url": "https://github.com/steveklabnik", "followers_url": "https://api.github.com/users/steveklabnik/followers", "following_url": "https://api.github.com/users/steveklabnik/following{/other_user}", "gists_url": "https://api.github.com/users/steveklabnik/gists{/gist_id}", "starred_url": "https://api.github.com/users/steveklabnik/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/steveklabnik/subscriptions", "organizations_url": "https://api.github.com/users/steveklabnik/orgs", "repos_url": "https://api.github.com/users/steveklabnik/repos", "events_url": "https://api.github.com/users/steveklabnik/events{/privacy}", "received_events_url": "https://api.github.com/users/steveklabnik/received_events", "type": "User", "site_admin": false}, "committer": {"login": "steveklabnik", "id": 27786, "node_id": "MDQ6VXNlcjI3Nzg2", "avatar_url": "https://avatars.githubusercontent.com/u/27786?v=4", "gravatar_id": "", "url": "https://api.github.com/users/steveklabnik", "html_url": "https://github.com/steveklabnik", "followers_url": "https://api.github.com/users/steveklabnik/followers", "following_url": "https://api.github.com/users/steveklabnik/following{/other_user}", "gists_url": "https://api.github.com/users/steveklabnik/gists{/gist_id}", "starred_url": "https://api.github.com/users/steveklabnik/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/steveklabnik/subscriptions", "organizations_url": "https://api.github.com/users/steveklabnik/orgs", "repos_url": "https://api.github.com/users/steveklabnik/repos", "events_url": "https://api.github.com/users/steveklabnik/events{/privacy}", "received_events_url": "https://api.github.com/users/steveklabnik/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "82c4f5915bfb330db596d06b74eb406d21845f9e", "url": "https://api.github.com/repos/rust-lang/rust/commits/82c4f5915bfb330db596d06b74eb406d21845f9e", "html_url": "https://github.com/rust-lang/rust/commit/82c4f5915bfb330db596d06b74eb406d21845f9e"}, {"sha": "6fed0132f314622700da9cd9f5746cfc4f4bb87f", "url": "https://api.github.com/repos/rust-lang/rust/commits/6fed0132f314622700da9cd9f5746cfc4f4bb87f", "html_url": "https://github.com/rust-lang/rust/commit/6fed0132f314622700da9cd9f5746cfc4f4bb87f"}], "stats": {"total": 22, "additions": 21, "deletions": 1}, "files": [{"sha": "5c062316310101a35478092e4d5d3418fd5a250d", "filename": "src/librustc/middle/resolve_lifetime.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/3b75f4b56efb0f4da02031d5b964977e4dc1fbba/src%2Flibrustc%2Fmiddle%2Fresolve_lifetime.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3b75f4b56efb0f4da02031d5b964977e4dc1fbba/src%2Flibrustc%2Fmiddle%2Fresolve_lifetime.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fresolve_lifetime.rs?ref=3b75f4b56efb0f4da02031d5b964977e4dc1fbba", "patch": "@@ -193,7 +193,12 @@ impl<'a, 'v> Visitor<'v> for LifetimeContext<'a> {\n                 })\n             }\n             FnKind::Closure(_) => {\n-                self.add_scope_and_walk_fn(fk, fd, b, s, fn_id)\n+                // Closures have their own set of labels, save labels just\n+                // like for foreign items above.\n+                let saved = replace(&mut self.labels_in_fn, vec![]);\n+                let result = self.add_scope_and_walk_fn(fk, fd, b, s, fn_id);\n+                replace(&mut self.labels_in_fn, saved);\n+                result\n             }\n         }\n     }"}, {"sha": "64e7350fb824471fc39a716efd39822b7c7a619f", "filename": "src/test/run-pass/issue-25343.rs", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/3b75f4b56efb0f4da02031d5b964977e4dc1fbba/src%2Ftest%2Frun-pass%2Fissue-25343.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3b75f4b56efb0f4da02031d5b964977e4dc1fbba/src%2Ftest%2Frun-pass%2Fissue-25343.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fissue-25343.rs?ref=3b75f4b56efb0f4da02031d5b964977e4dc1fbba", "patch": "@@ -8,9 +8,24 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n+#[allow(unused)]\n fn main() {\n     || {\n         'label: loop {\n         }\n     };\n+\n+    // More cases added from issue 31754\n+\n+    'label2: loop {\n+        break;\n+    }\n+\n+    let closure = || {\n+        'label2: loop {}\n+    };\n+\n+    fn inner_fn() {\n+        'label2: loop {}\n+    }\n }"}]}