{"sha": "94db37a4f5add29a0a7d993eafc5595f4df01574", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk0ZGIzN2E0ZjVhZGQyOWEwYTdkOTkzZWFmYzU1OTVmNGRmMDE1NzQ=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-10-08T10:21:01Z"}, "committer": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-10-13T04:23:20Z"}, "message": "mbe: reduce panictry! uses.", "tree": {"sha": "1cde075d00ace163316a173c32bc0d182f69c55e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1cde075d00ace163316a173c32bc0d182f69c55e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/94db37a4f5add29a0a7d993eafc5595f4df01574", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/94db37a4f5add29a0a7d993eafc5595f4df01574", "html_url": "https://github.com/rust-lang/rust/commit/94db37a4f5add29a0a7d993eafc5595f4df01574", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/94db37a4f5add29a0a7d993eafc5595f4df01574/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1721c9685b1ee69f1e17b3a8b09145b10fdfbe4a", "url": "https://api.github.com/repos/rust-lang/rust/commits/1721c9685b1ee69f1e17b3a8b09145b10fdfbe4a", "html_url": "https://github.com/rust-lang/rust/commit/1721c9685b1ee69f1e17b3a8b09145b10fdfbe4a"}], "stats": {"total": 52, "additions": 27, "deletions": 25}, "files": [{"sha": "0cb5eff1ef29a5adcab6f681de21053ad74e1c0e", "filename": "src/libsyntax/ext/mbe/macro_parser.rs", "status": "modified", "additions": 27, "deletions": 25, "changes": 52, "blob_url": "https://github.com/rust-lang/rust/blob/94db37a4f5add29a0a7d993eafc5595f4df01574/src%2Flibsyntax%2Fext%2Fmbe%2Fmacro_parser.rs", "raw_url": "https://github.com/rust-lang/rust/raw/94db37a4f5add29a0a7d993eafc5595f4df01574/src%2Flibsyntax%2Fext%2Fmbe%2Fmacro_parser.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fmbe%2Fmacro_parser.rs?ref=94db37a4f5add29a0a7d993eafc5595f4df01574", "patch": "@@ -76,7 +76,7 @@ use TokenTreeOrTokenTreeSlice::*;\n \n use crate::ast::{Ident, Name};\n use crate::ext::mbe::{self, TokenTree};\n-use crate::parse::{Directory, ParseSess};\n+use crate::parse::{Directory, ParseSess, PResult};\n use crate::parse::parser::{Parser, PathStyle};\n use crate::parse::token::{self, DocComment, Nonterminal, Token};\n use crate::print::pprust;\n@@ -893,48 +893,50 @@ fn parse_nt(p: &mut Parser<'_>, sp: Span, name: Symbol) -> Nonterminal {\n     }\n     // check at the beginning and the parser checks after each bump\n     p.process_potential_macro_variable();\n-    match name {\n-        sym::item => match panictry!(p.parse_item()) {\n+    match parse_nt_inner(p, sp, name) {\n+        Ok(nt) => nt,\n+        Err(mut err) => {\n+            err.emit();\n+            FatalError.raise();\n+        }\n+    }\n+}\n+\n+fn parse_nt_inner<'a>(p: &mut Parser<'a>, sp: Span, name: Symbol) -> PResult<'a, Nonterminal> {\n+    Ok(match name {\n+        sym::item => match p.parse_item()? {\n             Some(i) => token::NtItem(i),\n-            None => {\n-                p.fatal(\"expected an item keyword\").emit();\n-                FatalError.raise();\n-            }\n+            None => return Err(p.fatal(\"expected an item keyword\")),\n         },\n-        sym::block => token::NtBlock(panictry!(p.parse_block())),\n-        sym::stmt => match panictry!(p.parse_stmt()) {\n+        sym::block => token::NtBlock(p.parse_block()?),\n+        sym::stmt => match p.parse_stmt()? {\n             Some(s) => token::NtStmt(s),\n-            None => {\n-                p.fatal(\"expected a statement\").emit();\n-                FatalError.raise();\n-            }\n+            None => return Err(p.fatal(\"expected a statement\")),\n         },\n-        sym::pat => token::NtPat(panictry!(p.parse_pat(None))),\n-        sym::expr => token::NtExpr(panictry!(p.parse_expr())),\n-        sym::literal => token::NtLiteral(panictry!(p.parse_literal_maybe_minus())),\n-        sym::ty => token::NtTy(panictry!(p.parse_ty())),\n+        sym::pat => token::NtPat(p.parse_pat(None)?),\n+        sym::expr => token::NtExpr(p.parse_expr()?),\n+        sym::literal => token::NtLiteral(p.parse_literal_maybe_minus()?),\n+        sym::ty => token::NtTy(p.parse_ty()?),\n         // this could be handled like a token, since it is one\n         sym::ident => if let Some((name, is_raw)) = get_macro_name(&p.token) {\n             let span = p.token.span;\n             p.bump();\n             token::NtIdent(Ident::new(name, span), is_raw)\n         } else {\n             let token_str = pprust::token_to_string(&p.token);\n-            p.fatal(&format!(\"expected ident, found {}\", &token_str)).emit();\n-            FatalError.raise()\n+            return Err(p.fatal(&format!(\"expected ident, found {}\", &token_str)));\n         }\n-        sym::path => token::NtPath(panictry!(p.parse_path(PathStyle::Type))),\n-        sym::meta => token::NtMeta(panictry!(p.parse_attr_item())),\n-        sym::vis => token::NtVis(panictry!(p.parse_visibility(true))),\n+        sym::path => token::NtPath(p.parse_path(PathStyle::Type)?),\n+        sym::meta => token::NtMeta(p.parse_attr_item()?),\n+        sym::vis => token::NtVis(p.parse_visibility(true)?),\n         sym::lifetime => if p.check_lifetime() {\n             token::NtLifetime(p.expect_lifetime().ident)\n         } else {\n             let token_str = pprust::token_to_string(&p.token);\n-            p.fatal(&format!(\"expected a lifetime, found `{}`\", &token_str)).emit();\n-            FatalError.raise();\n+            return Err(p.fatal(&format!(\"expected a lifetime, found `{}`\", &token_str)));\n         }\n         // this is not supposed to happen, since it has been checked\n         // when compiling the macro.\n         _ => p.span_bug(sp, \"invalid fragment specifier\"),\n-    }\n+    })\n }"}]}