{"sha": "6ead62235a50e43b08a103d403d6fbfbc2b48352", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZlYWQ2MjIzNWE1MGU0M2IwOGExMDNkNDAzZDZmYmZiYzJiNDgzNTI=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-08-26T13:10:42Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-08-26T13:10:42Z"}, "message": "Auto merge of #75893 - Dylan-DPC:fix/offset-to-u64, r=oli-obk\n\nchange offset from u32 to u64\n\nReferences #71696\n\nr? @oli-obk\n\n(closed the earlier pr because the rebase got messed up)", "tree": {"sha": "32bdff721f8b2c369a373d8de1860f0a6560e8b3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/32bdff721f8b2c369a373d8de1860f0a6560e8b3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6ead62235a50e43b08a103d403d6fbfbc2b48352", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6ead62235a50e43b08a103d403d6fbfbc2b48352", "html_url": "https://github.com/rust-lang/rust/commit/6ead62235a50e43b08a103d403d6fbfbc2b48352", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6ead62235a50e43b08a103d403d6fbfbc2b48352/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ffd59bf9c62125813abae8ca52f0ac3a67459e8f", "url": "https://api.github.com/repos/rust-lang/rust/commits/ffd59bf9c62125813abae8ca52f0ac3a67459e8f", "html_url": "https://github.com/rust-lang/rust/commit/ffd59bf9c62125813abae8ca52f0ac3a67459e8f"}, {"sha": "f6a4a76a9afabc3288cc288d46bf0def0431d822", "url": "https://api.github.com/repos/rust-lang/rust/commits/f6a4a76a9afabc3288cc288d46bf0def0431d822", "html_url": "https://github.com/rust-lang/rust/commit/f6a4a76a9afabc3288cc288d46bf0def0431d822"}], "stats": {"total": 57, "additions": 25, "deletions": 32}, "files": [{"sha": "7ac7d9b23f172640686813b74489b4352fb7d823", "filename": "src/librustc_middle/mir/mod.rs", "status": "modified", "additions": 7, "deletions": 7, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/6ead62235a50e43b08a103d403d6fbfbc2b48352/src%2Flibrustc_middle%2Fmir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6ead62235a50e43b08a103d403d6fbfbc2b48352/src%2Flibrustc_middle%2Fmir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_middle%2Fmir%2Fmod.rs?ref=6ead62235a50e43b08a103d403d6fbfbc2b48352", "patch": "@@ -1564,10 +1564,10 @@ pub enum ProjectionElem<V, T> {\n     /// ```\n     ConstantIndex {\n         /// index or -index (in Python terms), depending on from_end\n-        offset: u32,\n+        offset: u64,\n         /// The thing being indexed must be at least this long. For arrays this\n         /// is always the exact length.\n-        min_length: u32,\n+        min_length: u64,\n         /// Counting backwards from end? This is always false when indexing an\n         /// array.\n         from_end: bool,\n@@ -1578,8 +1578,8 @@ pub enum ProjectionElem<V, T> {\n     /// If `from_end` is true `slice[from..slice.len() - to]`.\n     /// Otherwise `array[from..to]`.\n     Subslice {\n-        from: u32,\n-        to: u32,\n+        from: u64,\n+        to: u64,\n         /// Whether `to` counts from the start or end of the array/slice.\n         /// For `PlaceElem`s this is `true` if and only if the base is a slice.\n         /// For `ProjectionKind`, this can also be `true` for arrays.\n@@ -1616,7 +1616,7 @@ pub type PlaceElem<'tcx> = ProjectionElem<Local, Ty<'tcx>>;\n \n // At least on 64 bit systems, `PlaceElem` should not be larger than two pointers.\n #[cfg(target_arch = \"x86_64\")]\n-static_assert_size!(PlaceElem<'_>, 16);\n+static_assert_size!(PlaceElem<'_>, 24);\n \n /// Alias for projections as they appear in `UserTypeProjection`, where we\n /// need neither the `V` parameter for `Index` nor the `T` for `Field`.\n@@ -2330,7 +2330,7 @@ impl<'tcx> UserTypeProjections {\n         self.map_projections(|pat_ty_proj| pat_ty_proj.index())\n     }\n \n-    pub fn subslice(self, from: u32, to: u32) -> Self {\n+    pub fn subslice(self, from: u64, to: u64) -> Self {\n         self.map_projections(|pat_ty_proj| pat_ty_proj.subslice(from, to))\n     }\n \n@@ -2376,7 +2376,7 @@ impl UserTypeProjection {\n         self\n     }\n \n-    pub(crate) fn subslice(mut self, from: u32, to: u32) -> Self {\n+    pub(crate) fn subslice(mut self, from: u64, to: u64) -> Self {\n         self.projs.push(ProjectionElem::Subslice { from, to, from_end: true });\n         self\n     }"}, {"sha": "b486b8b589cfddeba3104056346e55746e9084c0", "filename": "src/librustc_mir/borrow_check/mod.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/6ead62235a50e43b08a103d403d6fbfbc2b48352/src%2Flibrustc_mir%2Fborrow_check%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6ead62235a50e43b08a103d403d6fbfbc2b48352/src%2Flibrustc_mir%2Fborrow_check%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Fmod.rs?ref=6ead62235a50e43b08a103d403d6fbfbc2b48352", "patch": "@@ -1694,8 +1694,8 @@ impl<'cx, 'tcx> MirBorrowckCtxt<'cx, 'tcx> {\n         desired_action: InitializationRequiringAction,\n         place_span: (PlaceRef<'tcx>, Span),\n         maybe_uninits: &BitSet<MovePathIndex>,\n-        from: u32,\n-        to: u32,\n+        from: u64,\n+        to: u64,\n     ) {\n         if let Some(mpi) = self.move_path_for_place(place_span.0) {\n             let move_paths = &self.move_data.move_paths;"}, {"sha": "69c4f633770f2bc8869e786076fbb4aa72f54d0a", "filename": "src/librustc_mir/borrow_check/type_check/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/6ead62235a50e43b08a103d403d6fbfbc2b48352/src%2Flibrustc_mir%2Fborrow_check%2Ftype_check%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6ead62235a50e43b08a103d403d6fbfbc2b48352/src%2Flibrustc_mir%2Fborrow_check%2Ftype_check%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Ftype_check%2Fmod.rs?ref=6ead62235a50e43b08a103d403d6fbfbc2b48352", "patch": "@@ -649,7 +649,7 @@ impl<'a, 'b, 'tcx> TypeVerifier<'a, 'b, 'tcx> {\n                 PlaceTy::from_ty(match base_ty.kind {\n                     ty::Array(inner, _) => {\n                         assert!(!from_end, \"array subslices should not use from_end\");\n-                        tcx.mk_array(inner, (to - from) as u64)\n+                        tcx.mk_array(inner, to - from)\n                     }\n                     ty::Slice(..) => {\n                         assert!(from_end, \"slice subslices should use from_end\");"}, {"sha": "e088dc6a954a3b451975e2a9aa9028bb885632ab", "filename": "src/librustc_mir/dataflow/move_paths/builder.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/6ead62235a50e43b08a103d403d6fbfbc2b48352/src%2Flibrustc_mir%2Fdataflow%2Fmove_paths%2Fbuilder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6ead62235a50e43b08a103d403d6fbfbc2b48352/src%2Flibrustc_mir%2Fdataflow%2Fmove_paths%2Fbuilder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fdataflow%2Fmove_paths%2Fbuilder.rs?ref=6ead62235a50e43b08a103d403d6fbfbc2b48352", "patch": "@@ -480,7 +480,7 @@ impl<'b, 'a, 'tcx> Gatherer<'b, 'a, 'tcx> {\n                 }\n             };\n             let base_ty = base_place.ty(self.builder.body, self.builder.tcx).ty;\n-            let len: u32 = match base_ty.kind {\n+            let len: u64 = match base_ty.kind {\n                 ty::Array(_, size) => {\n                     let length = size.eval_usize(self.builder.tcx, self.builder.param_env);\n                     length"}, {"sha": "6ba6103b311a3e3b90d7cf8e694846df382cb634", "filename": "src/librustc_mir/interpret/place.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/6ead62235a50e43b08a103d403d6fbfbc2b48352/src%2Flibrustc_mir%2Finterpret%2Fplace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6ead62235a50e43b08a103d403d6fbfbc2b48352/src%2Flibrustc_mir%2Finterpret%2Fplace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Finterpret%2Fplace.rs?ref=6ead62235a50e43b08a103d403d6fbfbc2b48352", "patch": "@@ -549,17 +549,17 @@ where\n \n             ConstantIndex { offset, min_length, from_end } => {\n                 let n = base.len(self)?;\n-                if n < u64::from(min_length) {\n+                if n < min_length {\n                     // This can only be reached in ConstProp and non-rustc-MIR.\n                     throw_ub!(BoundsCheckFailed { len: min_length.into(), index: n });\n                 }\n \n                 let index = if from_end {\n                     assert!(0 < offset && offset <= min_length);\n-                    n.checked_sub(u64::from(offset)).unwrap()\n+                    n.checked_sub(offset).unwrap()\n                 } else {\n                     assert!(offset < min_length);\n-                    u64::from(offset)\n+                    offset\n                 };\n \n                 self.mplace_index(base, index)?"}, {"sha": "479b6c2a6ca9fb33e0b2088d42322ea5fbace51c", "filename": "src/librustc_mir/shim.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/6ead62235a50e43b08a103d403d6fbfbc2b48352/src%2Flibrustc_mir%2Fshim.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6ead62235a50e43b08a103d403d6fbfbc2b48352/src%2Flibrustc_mir%2Fshim.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fshim.rs?ref=6ead62235a50e43b08a103d403d6fbfbc2b48352", "patch": "@@ -295,7 +295,7 @@ impl<'a, 'tcx> DropElaborator<'a, 'tcx> for DropShimElaborator<'a, 'tcx> {\n     fn downcast_subpath(&self, _path: Self::Path, _variant: VariantIdx) -> Option<Self::Path> {\n         Some(())\n     }\n-    fn array_subpath(&self, _path: Self::Path, _index: u32, _size: u32) -> Option<Self::Path> {\n+    fn array_subpath(&self, _path: Self::Path, _index: u64, _size: u64) -> Option<Self::Path> {\n         None\n     }\n }"}, {"sha": "5f1930693568cc83a8d8a9c8c9adb313738d3f65", "filename": "src/librustc_mir/transform/elaborate_drops.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/6ead62235a50e43b08a103d403d6fbfbc2b48352/src%2Flibrustc_mir%2Ftransform%2Felaborate_drops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6ead62235a50e43b08a103d403d6fbfbc2b48352/src%2Flibrustc_mir%2Ftransform%2Felaborate_drops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Felaborate_drops.rs?ref=6ead62235a50e43b08a103d403d6fbfbc2b48352", "patch": "@@ -219,7 +219,7 @@ impl<'a, 'b, 'tcx> DropElaborator<'a, 'tcx> for Elaborator<'a, 'b, 'tcx> {\n         })\n     }\n \n-    fn array_subpath(&self, path: Self::Path, index: u32, size: u32) -> Option<Self::Path> {\n+    fn array_subpath(&self, path: Self::Path, index: u64, size: u64) -> Option<Self::Path> {\n         dataflow::move_path_children_matching(self.ctxt.move_data(), path, |e| match e {\n             ProjectionElem::ConstantIndex { offset, min_length, from_end } => {\n                 debug_assert!(size == min_length, \"min_length should be exact for arrays\");"}, {"sha": "130409b9df5c00c2c14a39be32ba975b6f3cf8dd", "filename": "src/librustc_mir/util/aggregate.rs", "status": "modified", "additions": 2, "deletions": 4, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/6ead62235a50e43b08a103d403d6fbfbc2b48352/src%2Flibrustc_mir%2Futil%2Faggregate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6ead62235a50e43b08a103d403d6fbfbc2b48352/src%2Flibrustc_mir%2Futil%2Faggregate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Futil%2Faggregate.rs?ref=6ead62235a50e43b08a103d403d6fbfbc2b48352", "patch": "@@ -3,6 +3,7 @@ use rustc_middle::mir::*;\n use rustc_middle::ty::{Ty, TyCtxt};\n use rustc_target::abi::VariantIdx;\n \n+use std::convert::TryFrom;\n use std::iter::TrustedLen;\n \n /// Expand `lhs = Rvalue::Aggregate(kind, operands)` into assignments to the fields.\n@@ -52,14 +53,11 @@ pub fn expand_aggregate<'tcx>(\n         .enumerate()\n         .map(move |(i, (op, ty))| {\n             let lhs_field = if let AggregateKind::Array(_) = kind {\n-                // FIXME(eddyb) `offset` should be u64.\n-                let offset = i as u32;\n-                assert_eq!(offset as usize, i);\n+                let offset = u64::try_from(i).unwrap();\n                 tcx.mk_place_elem(\n                     lhs,\n                     ProjectionElem::ConstantIndex {\n                         offset,\n-                        // FIXME(eddyb) `min_length` doesn't appear to be used.\n                         min_length: offset + 1,\n                         from_end: false,\n                     },"}, {"sha": "642935d243d0d927dffd9575f84fb0a4b6e404b9", "filename": "src/librustc_mir/util/elaborate_drops.rs", "status": "modified", "additions": 1, "deletions": 6, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/6ead62235a50e43b08a103d403d6fbfbc2b48352/src%2Flibrustc_mir%2Futil%2Felaborate_drops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6ead62235a50e43b08a103d403d6fbfbc2b48352/src%2Flibrustc_mir%2Futil%2Felaborate_drops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Futil%2Felaborate_drops.rs?ref=6ead62235a50e43b08a103d403d6fbfbc2b48352", "patch": "@@ -10,8 +10,6 @@ use rustc_middle::ty::{self, Ty, TyCtxt};\n use rustc_target::abi::VariantIdx;\n use std::fmt;\n \n-use std::convert::TryInto;\n-\n /// The value of an inserted drop flag.\n #[derive(Debug, PartialEq, Eq, Copy, Clone)]\n pub enum DropFlagState {\n@@ -150,7 +148,7 @@ pub trait DropElaborator<'a, 'tcx>: fmt::Debug {\n     /// If this returns `None`, elements of `path` will not get a dedicated drop flag.\n     ///\n     /// This is only relevant for array patterns, which can move out of individual array elements.\n-    fn array_subpath(&self, path: Self::Path, index: u32, size: u32) -> Option<Self::Path>;\n+    fn array_subpath(&self, path: Self::Path, index: u64, size: u64) -> Option<Self::Path>;\n }\n \n #[derive(Debug)]\n@@ -744,9 +742,6 @@ where\n         let tcx = self.tcx();\n \n         if let Some(size) = opt_size {\n-            let size: u32 = size.try_into().unwrap_or_else(|_| {\n-                bug!(\"move out check isn't implemented for array sizes bigger than u32::MAX\");\n-            });\n             let fields: Vec<(Place<'tcx>, Option<D::Path>)> = (0..size)\n                 .map(|i| {\n                     ("}, {"sha": "3a525d10b08175cda5f8976e181f073ba7b64e78", "filename": "src/librustc_mir_build/build/matches/mod.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/6ead62235a50e43b08a103d403d6fbfbc2b48352/src%2Flibrustc_mir_build%2Fbuild%2Fmatches%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6ead62235a50e43b08a103d403d6fbfbc2b48352/src%2Flibrustc_mir_build%2Fbuild%2Fmatches%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir_build%2Fbuild%2Fmatches%2Fmod.rs?ref=6ead62235a50e43b08a103d403d6fbfbc2b48352", "patch": "@@ -609,8 +609,8 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n \n             PatKind::Array { ref prefix, ref slice, ref suffix }\n             | PatKind::Slice { ref prefix, ref slice, ref suffix } => {\n-                let from = u32::try_from(prefix.len()).unwrap();\n-                let to = u32::try_from(suffix.len()).unwrap();\n+                let from = u64::try_from(prefix.len()).unwrap();\n+                let to = u64::try_from(suffix.len()).unwrap();\n                 for subpattern in prefix {\n                     self.visit_primary_bindings(subpattern, pattern_user_ty.clone().index(), f);\n                 }"}, {"sha": "c6d39947f7d153842790ca06a9786665c51e1363", "filename": "src/librustc_mir_build/build/matches/util.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/6ead62235a50e43b08a103d403d6fbfbc2b48352/src%2Flibrustc_mir_build%2Fbuild%2Fmatches%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6ead62235a50e43b08a103d403d6fbfbc2b48352/src%2Flibrustc_mir_build%2Fbuild%2Fmatches%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir_build%2Fbuild%2Fmatches%2Futil.rs?ref=6ead62235a50e43b08a103d403d6fbfbc2b48352", "patch": "@@ -40,17 +40,17 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n \n         match_pairs.extend(prefix.iter().enumerate().map(|(idx, subpattern)| {\n             let elem =\n-                ProjectionElem::ConstantIndex { offset: idx as u32, min_length, from_end: false };\n+                ProjectionElem::ConstantIndex { offset: idx as u64, min_length, from_end: false };\n             let place = tcx.mk_place_elem(*place, elem);\n             MatchPair::new(place, subpattern)\n         }));\n \n         if let Some(subslice_pat) = opt_slice {\n-            let suffix_len = suffix.len() as u32;\n+            let suffix_len = suffix.len() as u64;\n             let subslice = tcx.mk_place_elem(\n                 *place,\n                 ProjectionElem::Subslice {\n-                    from: prefix.len() as u32,\n+                    from: prefix.len() as u64,\n                     to: if exact_size { min_length - suffix_len } else { suffix_len },\n                     from_end: !exact_size,\n                 },\n@@ -59,7 +59,7 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n         }\n \n         match_pairs.extend(suffix.iter().rev().enumerate().map(|(idx, subpattern)| {\n-            let end_offset = (idx + 1) as u32;\n+            let end_offset = (idx + 1) as u64;\n             let elem = ProjectionElem::ConstantIndex {\n                 offset: if exact_size { min_length - end_offset } else { end_offset },\n                 min_length,"}]}