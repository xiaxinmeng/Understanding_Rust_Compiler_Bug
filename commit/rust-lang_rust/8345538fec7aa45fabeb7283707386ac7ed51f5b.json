{"sha": "8345538fec7aa45fabeb7283707386ac7ed51f5b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjgzNDU1MzhmZWM3YWE0NWZhYmViNzI4MzcwNzM4NmFjN2VkNTFmNWI=", "commit": {"author": {"name": "Chris Denton", "email": "christophersdenton@gmail.com", "date": "2021-05-19T22:34:15Z"}, "committer": {"name": "Chris Denton", "email": "christophersdenton@gmail.com", "date": "2021-05-19T22:34:15Z"}, "message": "Windows `Command` environment variables are case-preserving\n\nBut comparing is case-insensitive.", "tree": {"sha": "c95a3c1091b3e21fdc74934d6be7fa75aabd9b5f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c95a3c1091b3e21fdc74934d6be7fa75aabd9b5f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8345538fec7aa45fabeb7283707386ac7ed51f5b", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE+p/jD6jrzmnSIWJLcTRy8vRWJ94FAmClkmcACgkQcTRy8vRW\nJ96eoA//c+LB2Zhu7/G9QAAlP6q63hcr/jeJIY3H5cjSP32/hrx+81r0lUZnqstQ\n4ju1kwWkyDmEcdljbIddIwvqEeL6SP/mgNGURO7tFnZPiwsBVu5Oa/09JsugDlug\nxgWZZNk+5JaTcjKd6YsJqAw88pYYsJ/PQQSrMM3KU02jrVXuH8VF1089G1xRy/m0\nKm4ntMsk7iBJiDchjQR3Sq23/mUnHXdS3YgeVv5gXIA51U7XlzfPdAxdTX7Xo+xZ\nLVZDu6cKCeM8z6zIKlgmkPbKqavoVIWLcqipSMAKOis2ODsXce6LEnKIZV5xbUCF\nGZhg4+pdH2A7/6NL9ROoS3CVrA5uVo0rEvcT63/RcojQYivfv9D7IASG/mp/ArCb\ngWSVxYpXEGTCsF0DSzROf3zNLN6533iYw2635TWXu2sydfqpNFlPOS73sN/FrjR9\n9wMJHLrxZGb73gzsK4Sg78mqZAB2zgxMHfp/qCodCqAzV+tVUE14fdPsLtI8Y6mh\nmP/X+MMSmdqXUzF2+D1xPT2aZeqX9dgcBAg/bb2mfcdHejHosCQjxzfSgOuPd+pZ\n/948QRCxJo4upfiY9JxD6iNkfAablJWiDhad81l3CYbiGH2hvByB0XEwQVKFOIwN\nznZNVZCa+G/YmGkZ6lgXqKihgKtqfjcEmu/PAdv/x3j/8vcA+1g=\n=0NMR\n-----END PGP SIGNATURE-----", "payload": "tree c95a3c1091b3e21fdc74934d6be7fa75aabd9b5f\nparent f94942d8421dc4b1da86d07069571ddb43127235\nauthor Chris Denton <christophersdenton@gmail.com> 1621463655 +0100\ncommitter Chris Denton <christophersdenton@gmail.com> 1621463655 +0100\n\nWindows `Command` environment variables are case-preserving\n\nBut comparing is case-insensitive.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8345538fec7aa45fabeb7283707386ac7ed51f5b", "html_url": "https://github.com/rust-lang/rust/commit/8345538fec7aa45fabeb7283707386ac7ed51f5b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8345538fec7aa45fabeb7283707386ac7ed51f5b/comments", "author": {"login": "ChrisDenton", "id": 4459874, "node_id": "MDQ6VXNlcjQ0NTk4NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/4459874?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ChrisDenton", "html_url": "https://github.com/ChrisDenton", "followers_url": "https://api.github.com/users/ChrisDenton/followers", "following_url": "https://api.github.com/users/ChrisDenton/following{/other_user}", "gists_url": "https://api.github.com/users/ChrisDenton/gists{/gist_id}", "starred_url": "https://api.github.com/users/ChrisDenton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ChrisDenton/subscriptions", "organizations_url": "https://api.github.com/users/ChrisDenton/orgs", "repos_url": "https://api.github.com/users/ChrisDenton/repos", "events_url": "https://api.github.com/users/ChrisDenton/events{/privacy}", "received_events_url": "https://api.github.com/users/ChrisDenton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ChrisDenton", "id": 4459874, "node_id": "MDQ6VXNlcjQ0NTk4NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/4459874?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ChrisDenton", "html_url": "https://github.com/ChrisDenton", "followers_url": "https://api.github.com/users/ChrisDenton/followers", "following_url": "https://api.github.com/users/ChrisDenton/following{/other_user}", "gists_url": "https://api.github.com/users/ChrisDenton/gists{/gist_id}", "starred_url": "https://api.github.com/users/ChrisDenton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ChrisDenton/subscriptions", "organizations_url": "https://api.github.com/users/ChrisDenton/orgs", "repos_url": "https://api.github.com/users/ChrisDenton/repos", "events_url": "https://api.github.com/users/ChrisDenton/events{/privacy}", "received_events_url": "https://api.github.com/users/ChrisDenton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f94942d8421dc4b1da86d07069571ddb43127235", "url": "https://api.github.com/repos/rust-lang/rust/commits/f94942d8421dc4b1da86d07069571ddb43127235", "html_url": "https://github.com/rust-lang/rust/commit/f94942d8421dc4b1da86d07069571ddb43127235"}], "stats": {"total": 137, "additions": 128, "deletions": 9}, "files": [{"sha": "919415039caba45a6a66cd5983feddcf3ef87d74", "filename": "library/std/src/sys/windows/c.rs", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/8345538fec7aa45fabeb7283707386ac7ed51f5b/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8345538fec7aa45fabeb7283707386ac7ed51f5b/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fc.rs?ref=8345538fec7aa45fabeb7283707386ac7ed51f5b", "patch": "@@ -68,6 +68,10 @@ pub type ADDRESS_FAMILY = USHORT;\n pub const TRUE: BOOL = 1;\n pub const FALSE: BOOL = 0;\n \n+pub const CSTR_LESS_THAN: c_int = 1;\n+pub const CSTR_EQUAL: c_int = 2;\n+pub const CSTR_GREATER_THAN: c_int = 3;\n+\n pub const FILE_ATTRIBUTE_READONLY: DWORD = 0x1;\n pub const FILE_ATTRIBUTE_DIRECTORY: DWORD = 0x10;\n pub const FILE_ATTRIBUTE_REPARSE_POINT: DWORD = 0x400;\n@@ -1072,6 +1076,14 @@ extern \"system\" {\n     pub fn ReleaseSRWLockShared(SRWLock: PSRWLOCK);\n     pub fn TryAcquireSRWLockExclusive(SRWLock: PSRWLOCK) -> BOOLEAN;\n     pub fn TryAcquireSRWLockShared(SRWLock: PSRWLOCK) -> BOOLEAN;\n+\n+    pub fn CompareStringOrdinal(\n+        lpString1: LPCWSTR,\n+        cchCount1: c_int,\n+        lpString2: LPCWSTR,\n+        cchCount2: c_int,\n+        bIgnoreCase: BOOL,\n+    ) -> c_int;\n }\n \n // Functions that aren't available on every version of Windows that we support,"}, {"sha": "909017bcc0fd36a486e0a9ee1232bf2dc70b06b2", "filename": "library/std/src/sys/windows/process.rs", "status": "modified", "additions": 55, "deletions": 9, "changes": 64, "blob_url": "https://github.com/rust-lang/rust/blob/8345538fec7aa45fabeb7283707386ac7ed51f5b/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fprocess.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8345538fec7aa45fabeb7283707386ac7ed51f5b/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fprocess.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fprocess.rs?ref=8345538fec7aa45fabeb7283707386ac7ed51f5b", "patch": "@@ -4,6 +4,7 @@\n mod tests;\n \n use crate::borrow::Borrow;\n+use crate::cmp;\n use crate::collections::BTreeMap;\n use crate::convert::{TryFrom, TryInto};\n use crate::env;\n@@ -34,32 +35,76 @@ use libc::{c_void, EXIT_FAILURE, EXIT_SUCCESS};\n // Command\n ////////////////////////////////////////////////////////////////////////////////\n \n-#[derive(Clone, Debug, Eq, PartialEq, Ord, PartialOrd)]\n+#[derive(Clone, Debug, Eq)]\n #[doc(hidden)]\n-pub struct EnvKey(OsString);\n+pub struct EnvKey {\n+    os_string: OsString,\n+    // This stores a UTF-16 encoded string to workaround the mismatch between\n+    // Rust's OsString (WTF-8) and the Windows API string type (UTF-16).\n+    // Normally converting on every API call is acceptable but here\n+    // `c::CompareStringOrdinal` will be called for every use of `==`.\n+    utf16: Vec<u16>,\n+}\n+\n+// Windows environment variables preserve their case but comparisons use\n+// simplified case folding. So we call `CompareStringOrdinal` to get the OS to\n+// perform the comparison.\n+impl Ord for EnvKey {\n+    fn cmp(&self, other: &Self) -> cmp::Ordering {\n+        unsafe {\n+            let result = c::CompareStringOrdinal(\n+                self.utf16.as_ptr(),\n+                self.utf16.len() as _,\n+                other.utf16.as_ptr(),\n+                other.utf16.len() as _,\n+                c::TRUE,\n+            );\n+            match result {\n+                c::CSTR_LESS_THAN => cmp::Ordering::Less,\n+                c::CSTR_EQUAL => cmp::Ordering::Equal,\n+                c::CSTR_GREATER_THAN => cmp::Ordering::Greater,\n+                // `CompareStringOrdinal` should never fail so long as the parameters are correct.\n+                _ => panic!(\"comparing environment keys failed: {}\", Error::last_os_error()),\n+            }\n+        }\n+    }\n+}\n+impl PartialOrd for EnvKey {\n+    fn partial_cmp(&self, other: &Self) -> Option<cmp::Ordering> {\n+        Some(self.cmp(other))\n+    }\n+}\n+impl PartialEq for EnvKey {\n+    fn eq(&self, other: &Self) -> bool {\n+        if self.utf16.len() != other.utf16.len() {\n+            false\n+        } else {\n+            self.cmp(other) == cmp::Ordering::Equal\n+        }\n+    }\n+}\n \n impl From<OsString> for EnvKey {\n-    fn from(mut k: OsString) -> Self {\n-        k.make_ascii_uppercase();\n-        EnvKey(k)\n+    fn from(k: OsString) -> Self {\n+        EnvKey { utf16: k.encode_wide().collect(), os_string: k }\n     }\n }\n \n impl From<EnvKey> for OsString {\n     fn from(k: EnvKey) -> Self {\n-        k.0\n+        k.os_string\n     }\n }\n \n impl Borrow<OsStr> for EnvKey {\n     fn borrow(&self) -> &OsStr {\n-        &self.0\n+        &self.os_string\n     }\n }\n \n impl AsRef<OsStr> for EnvKey {\n     fn as_ref(&self) -> &OsStr {\n-        &self.0\n+        &self.os_string\n     }\n }\n \n@@ -531,7 +576,8 @@ fn make_envp(maybe_env: Option<BTreeMap<EnvKey, OsString>>) -> io::Result<(*mut\n         let mut blk = Vec::new();\n \n         for (k, v) in env {\n-            blk.extend(ensure_no_nuls(k.0)?.encode_wide());\n+            ensure_no_nuls(k.os_string)?;\n+            blk.extend(k.utf16);\n             blk.push('=' as u16);\n             blk.extend(ensure_no_nuls(v)?.encode_wide());\n             blk.push(0);"}, {"sha": "ff3f9131cc889b3303b9bc6e5dbd552ac433084b", "filename": "library/std/src/sys/windows/process/tests.rs", "status": "modified", "additions": 61, "deletions": 0, "changes": 61, "blob_url": "https://github.com/rust-lang/rust/blob/8345538fec7aa45fabeb7283707386ac7ed51f5b/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fprocess%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8345538fec7aa45fabeb7283707386ac7ed51f5b/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fprocess%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fprocess%2Ftests.rs?ref=8345538fec7aa45fabeb7283707386ac7ed51f5b", "patch": "@@ -1,5 +1,7 @@\n use super::make_command_line;\n+use crate::env;\n use crate::ffi::{OsStr, OsString};\n+use crate::process::Command;\n \n #[test]\n fn test_make_command_line() {\n@@ -41,3 +43,62 @@ fn test_make_command_line() {\n         \"\\\"\\u{03c0}\\u{042f}\\u{97f3}\\u{00e6}\\u{221e}\\\"\"\n     );\n }\n+\n+// On Windows, environment args are case preserving but comparisons are case-insensitive.\n+// See: #85242\n+#[test]\n+fn windows_env_unicode_case() {\n+    let test_cases = [\n+        (\"\u00e4\", \"\u00c4\"),\n+        (\"\u00df\", \"SS\"),\n+        (\"\u00c4\", \"\u00d6\"),\n+        (\"\u00c4\", \"\u00d6\"),\n+        (\"I\", \"\u0130\"),\n+        (\"I\", \"i\"),\n+        (\"I\", \"\u0131\"),\n+        (\"i\", \"I\"),\n+        (\"i\", \"\u0130\"),\n+        (\"i\", \"\u0131\"),\n+        (\"\u0130\", \"I\"),\n+        (\"\u0130\", \"i\"),\n+        (\"\u0130\", \"\u0131\"),\n+        (\"\u0131\", \"I\"),\n+        (\"\u0131\", \"i\"),\n+        (\"\u0131\", \"\u0130\"),\n+        (\"\u00e4\", \"\u00c4\"),\n+        (\"\u00df\", \"SS\"),\n+        (\"\u00c4\", \"\u00d6\"),\n+        (\"\u00c4\", \"\u00d6\"),\n+        (\"I\", \"\u0130\"),\n+        (\"I\", \"i\"),\n+        (\"I\", \"\u0131\"),\n+        (\"i\", \"I\"),\n+        (\"i\", \"\u0130\"),\n+        (\"i\", \"\u0131\"),\n+        (\"\u0130\", \"I\"),\n+        (\"\u0130\", \"i\"),\n+        (\"\u0130\", \"\u0131\"),\n+        (\"\u0131\", \"I\"),\n+        (\"\u0131\", \"i\"),\n+        (\"\u0131\", \"\u0130\"),\n+    ];\n+    // Test that `cmd.env` matches `env::set_var` when setting two strings that\n+    // may (or may not) be case-folded when compared.\n+    for (a, b) in test_cases.iter() {\n+        let mut cmd = Command::new(\"cmd\");\n+        cmd.env(a, \"1\");\n+        cmd.env(b, \"2\");\n+        env::set_var(a, \"1\");\n+        env::set_var(b, \"2\");\n+\n+        for (key, value) in cmd.get_envs() {\n+            assert_eq!(\n+                env::var(key).ok(),\n+                value.map(|s| s.to_string_lossy().into_owned()),\n+                \"command environment mismatch: {} {}\",\n+                a,\n+                b\n+            );\n+        }\n+    }\n+}"}]}