{"sha": "0a9c80053ffcd72d076ca3792bf4a9ddb94eaf95", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBhOWM4MDA1M2ZmY2Q3MmQwNzZjYTM3OTJiZjRhOWRkYjk0ZWFmOTU=", "commit": {"author": {"name": "Edwin Cheng", "email": "edwin0cheng@gmail.com", "date": "2019-11-20T04:21:31Z"}, "committer": {"name": "Edwin Cheng", "email": "edwin0cheng@gmail.com", "date": "2019-11-20T13:33:01Z"}, "message": "Fix expand macro", "tree": {"sha": "fc8009de0176c6904c3dd0484775e85592c9464d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fc8009de0176c6904c3dd0484775e85592c9464d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0a9c80053ffcd72d076ca3792bf4a9ddb94eaf95", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0a9c80053ffcd72d076ca3792bf4a9ddb94eaf95", "html_url": "https://github.com/rust-lang/rust/commit/0a9c80053ffcd72d076ca3792bf4a9ddb94eaf95", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0a9c80053ffcd72d076ca3792bf4a9ddb94eaf95/comments", "author": {"login": "edwin0cheng", "id": 11014119, "node_id": "MDQ6VXNlcjExMDE0MTE5", "avatar_url": "https://avatars.githubusercontent.com/u/11014119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/edwin0cheng", "html_url": "https://github.com/edwin0cheng", "followers_url": "https://api.github.com/users/edwin0cheng/followers", "following_url": "https://api.github.com/users/edwin0cheng/following{/other_user}", "gists_url": "https://api.github.com/users/edwin0cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/edwin0cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/edwin0cheng/subscriptions", "organizations_url": "https://api.github.com/users/edwin0cheng/orgs", "repos_url": "https://api.github.com/users/edwin0cheng/repos", "events_url": "https://api.github.com/users/edwin0cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/edwin0cheng/received_events", "type": "User", "site_admin": false}, "committer": {"login": "edwin0cheng", "id": 11014119, "node_id": "MDQ6VXNlcjExMDE0MTE5", "avatar_url": "https://avatars.githubusercontent.com/u/11014119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/edwin0cheng", "html_url": "https://github.com/edwin0cheng", "followers_url": "https://api.github.com/users/edwin0cheng/followers", "following_url": "https://api.github.com/users/edwin0cheng/following{/other_user}", "gists_url": "https://api.github.com/users/edwin0cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/edwin0cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/edwin0cheng/subscriptions", "organizations_url": "https://api.github.com/users/edwin0cheng/orgs", "repos_url": "https://api.github.com/users/edwin0cheng/repos", "events_url": "https://api.github.com/users/edwin0cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/edwin0cheng/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b568bcfe6d94d5f4c6cdc012b766473e5b771a26", "url": "https://api.github.com/repos/rust-lang/rust/commits/b568bcfe6d94d5f4c6cdc012b766473e5b771a26", "html_url": "https://github.com/rust-lang/rust/commit/b568bcfe6d94d5f4c6cdc012b766473e5b771a26"}], "stats": {"total": 25, "additions": 16, "deletions": 9}, "files": [{"sha": "caa8d0082f4fe98a90bd896b81dec6f75ab0a87b", "filename": "crates/ra_hir/src/source_binder.rs", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/0a9c80053ffcd72d076ca3792bf4a9ddb94eaf95/crates%2Fra_hir%2Fsrc%2Fsource_binder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0a9c80053ffcd72d076ca3792bf4a9ddb94eaf95/crates%2Fra_hir%2Fsrc%2Fsource_binder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fsource_binder.rs?ref=0a9c80053ffcd72d076ca3792bf4a9ddb94eaf95", "patch": "@@ -405,9 +405,16 @@ impl SourceAnalyzer {\n         implements_trait(&canonical_ty, db, &self.resolver, krate, std_future_trait)\n     }\n \n-    pub fn expand(&self, db: &impl HirDatabase, macro_call: &ast::MacroCall) -> Option<Expansion> {\n-        let def = self.resolve_macro_call(db, macro_call)?.id;\n-        let ast_id = AstId::new(self.file_id, db.ast_id_map(self.file_id).ast_id(macro_call));\n+    pub fn expand(\n+        &self,\n+        db: &impl HirDatabase,\n+        macro_call: Source<&ast::MacroCall>,\n+    ) -> Option<Expansion> {\n+        let def = self.resolve_macro_call(db, macro_call.value)?.id;\n+        let ast_id = AstId::new(\n+            macro_call.file_id,\n+            db.ast_id_map(macro_call.file_id).ast_id(macro_call.value),\n+        );\n         let macro_call_loc = MacroCallLoc { def, ast_id };\n         Some(Expansion { macro_call_id: db.intern_macro(macro_call_loc) })\n     }"}, {"sha": "2f1abf509a00549b1359cef237341023a30ec8b9", "filename": "crates/ra_ide_api/src/expand.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0a9c80053ffcd72d076ca3792bf4a9ddb94eaf95/crates%2Fra_ide_api%2Fsrc%2Fexpand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0a9c80053ffcd72d076ca3792bf4a9ddb94eaf95/crates%2Fra_ide_api%2Fsrc%2Fexpand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Fexpand.rs?ref=0a9c80053ffcd72d076ca3792bf4a9ddb94eaf95", "patch": "@@ -55,7 +55,7 @@ pub(crate) fn descend_into_macros(\n         }\n         let source_analyzer =\n             hir::SourceAnalyzer::new(db, token.with_value(token.value.parent()).as_ref(), None);\n-        let exp = source_analyzer.expand(db, &macro_call)?;\n+        let exp = source_analyzer.expand(db, token.with_value(&macro_call))?;\n         exp.map_token_down(db, token.as_ref())\n     })\n     .last()"}, {"sha": "7f39262dc93697592a3a1b45128c40eb976efed8", "filename": "crates/ra_ide_api/src/expand_macro.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/0a9c80053ffcd72d076ca3792bf4a9ddb94eaf95/crates%2Fra_ide_api%2Fsrc%2Fexpand_macro.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0a9c80053ffcd72d076ca3792bf4a9ddb94eaf95/crates%2Fra_ide_api%2Fsrc%2Fexpand_macro.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Fexpand_macro.rs?ref=0a9c80053ffcd72d076ca3792bf4a9ddb94eaf95", "patch": "@@ -23,7 +23,7 @@ pub(crate) fn expand_macro(db: &RootDatabase, position: FilePosition) -> Option<\n     let mac = name_ref.syntax().ancestors().find_map(ast::MacroCall::cast)?;\n \n     let source = hir::Source::new(position.file_id.into(), mac.syntax());\n-    let expanded = expand_macro_recur(db, source, &mac)?;\n+    let expanded = expand_macro_recur(db, source, source.with_value(&mac))?;\n \n     // FIXME:\n     // macro expansion may lose all white space information\n@@ -35,19 +35,19 @@ pub(crate) fn expand_macro(db: &RootDatabase, position: FilePosition) -> Option<\n fn expand_macro_recur(\n     db: &RootDatabase,\n     source: hir::Source<&SyntaxNode>,\n-    macro_call: &ast::MacroCall,\n+    macro_call: hir::Source<&ast::MacroCall>,\n ) -> Option<SyntaxNode> {\n     let analyzer = hir::SourceAnalyzer::new(db, source, None);\n-    let expansion = analyzer.expand(db, &macro_call)?;\n+    let expansion = analyzer.expand(db, macro_call)?;\n     let macro_file_id = expansion.file_id();\n     let expanded: SyntaxNode = db.parse_or_expand(macro_file_id)?;\n \n     let children = expanded.descendants().filter_map(ast::MacroCall::cast);\n     let mut replaces = FxHashMap::default();\n \n     for child in children.into_iter() {\n-        let source = hir::Source::new(macro_file_id, source.value);\n-        let new_node = expand_macro_recur(db, source, &child)?;\n+        let node = hir::Source::new(macro_file_id, &child);\n+        let new_node = expand_macro_recur(db, source, node)?;\n \n         replaces.insert(child.syntax().clone().into(), new_node.into());\n     }"}]}