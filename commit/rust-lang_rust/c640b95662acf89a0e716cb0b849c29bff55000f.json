{"sha": "c640b95662acf89a0e716cb0b849c29bff55000f", "node_id": "MDY6Q29tbWl0NzI0NzEyOmM2NDBiOTU2NjJhY2Y4OWEwZTcxNmNiMGI4NDljMjliZmY1NTAwMGY=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2020-03-26T20:44:05Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-03-26T20:44:05Z"}, "message": "Rollup merge of #70413 - AminArria:match-pattern-incorrect-warning, r=Centril,Nadrieril,varkor\n\nFix incorrect pattern warning \"unreachable pattern\"\n\nFixes #70372\n\nAdded `is_under_guard` parameter to `_match::is_useful` and only add it to the matrix if `false`\n\nTested with:\n```rust\n#![feature(or_patterns)]\nfn main() {\n    match (3,42) {\n        (a,_) | (_,a) if a > 10 => {println!(\"{}\", a)}\n        _ => ()\n    }\n\n    match Some((3,42)) {\n        Some((a, _)) | Some((_, a)) if a > 10 => {println!(\"{}\", a)}\n        _ => ()\n\n    }\n\n    match Some((3,42)) {\n        Some((a, _) | (_, a)) if a > 10 => {println!(\"{}\", a)}\n        _ => ()\n    }\n}\n```", "tree": {"sha": "37fc5e62149c5f1d44217dcb851c164327e6c4c4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/37fc5e62149c5f1d44217dcb851c164327e6c4c4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c640b95662acf89a0e716cb0b849c29bff55000f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJefRQVCRBK7hj4Ov3rIwAAdHIIABESaR51lwRZ4378cT+jNM1G\nsE/k5KJdjnsk5oMqDCYC6z/c5jvUL5uWrwi7OAQOaxig+fGc2R60Q3KTWwBaVYZ5\nHnctyycpkEQTxw8VcyPF8eHxsw92dySNqyguMN4jcgcfveg1t3G9JNlt/Y+KqybZ\nTBtKSVZUvmwPqQecTdloRID/+JvurTtbI/00HnCMBofxKy2aYt9eowdVmkDhKLaz\n/rWGLPVNwdOCxgTKuQX57ZD27JU2i8IGNNR7HwtDKMD66CGWKQkVXjUmzHdVi+cy\nbkkQC36hVKK/F0es+Xxw+b0knl/roVbqtkSN+djSvYyNux4MvmIMty344fD/o6g=\n=fO9v\n-----END PGP SIGNATURE-----\n", "payload": "tree 37fc5e62149c5f1d44217dcb851c164327e6c4c4\nparent de3d1e9fa9743db0e99ea41b9c0b127b19d1bbbb\nparent ae7fa3042da8d432c6048b89d320c73e43615b97\nauthor Dylan DPC <dylan.dpc@gmail.com> 1585255445 +0100\ncommitter GitHub <noreply@github.com> 1585255445 +0100\n\nRollup merge of #70413 - AminArria:match-pattern-incorrect-warning, r=Centril,Nadrieril,varkor\n\nFix incorrect pattern warning \"unreachable pattern\"\n\nFixes #70372\n\nAdded `is_under_guard` parameter to `_match::is_useful` and only add it to the matrix if `false`\n\nTested with:\n```rust\n#![feature(or_patterns)]\nfn main() {\n    match (3,42) {\n        (a,_) | (_,a) if a > 10 => {println!(\"{}\", a)}\n        _ => ()\n    }\n\n    match Some((3,42)) {\n        Some((a, _)) | Some((_, a)) if a > 10 => {println!(\"{}\", a)}\n        _ => ()\n\n    }\n\n    match Some((3,42)) {\n        Some((a, _) | (_, a)) if a > 10 => {println!(\"{}\", a)}\n        _ => ()\n    }\n}\n```\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c640b95662acf89a0e716cb0b849c29bff55000f", "html_url": "https://github.com/rust-lang/rust/commit/c640b95662acf89a0e716cb0b849c29bff55000f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c640b95662acf89a0e716cb0b849c29bff55000f/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "de3d1e9fa9743db0e99ea41b9c0b127b19d1bbbb", "url": "https://api.github.com/repos/rust-lang/rust/commits/de3d1e9fa9743db0e99ea41b9c0b127b19d1bbbb", "html_url": "https://github.com/rust-lang/rust/commit/de3d1e9fa9743db0e99ea41b9c0b127b19d1bbbb"}, {"sha": "ae7fa3042da8d432c6048b89d320c73e43615b97", "url": "https://api.github.com/repos/rust-lang/rust/commits/ae7fa3042da8d432c6048b89d320c73e43615b97", "html_url": "https://github.com/rust-lang/rust/commit/ae7fa3042da8d432c6048b89d320c73e43615b97"}], "stats": {"total": 71, "additions": 63, "deletions": 8}, "files": [{"sha": "5c69cea8b9169d1fc22241948f5722dfc055ded7", "filename": "src/librustc_mir_build/hair/pattern/_match.rs", "status": "modified", "additions": 36, "deletions": 6, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/c640b95662acf89a0e716cb0b849c29bff55000f/src%2Flibrustc_mir_build%2Fhair%2Fpattern%2F_match.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c640b95662acf89a0e716cb0b849c29bff55000f/src%2Flibrustc_mir_build%2Fhair%2Fpattern%2F_match.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir_build%2Fhair%2Fpattern%2F_match.rs?ref=c640b95662acf89a0e716cb0b849c29bff55000f", "patch": "@@ -1619,12 +1619,17 @@ impl<'tcx> fmt::Debug for MissingConstructors<'tcx> {\n /// relation to preceding patterns, it is not reachable) and exhaustiveness\n /// checking (if a wildcard pattern is useful in relation to a matrix, the\n /// matrix isn't exhaustive).\n+///\n+/// `is_under_guard` is used to inform if the pattern has a guard. If it\n+/// has one it must not be inserted into the matrix. This shouldn't be\n+/// relied on for soundness.\n crate fn is_useful<'p, 'tcx>(\n     cx: &mut MatchCheckCtxt<'p, 'tcx>,\n     matrix: &Matrix<'p, 'tcx>,\n     v: &PatStack<'p, 'tcx>,\n     witness_preference: WitnessPreference,\n     hir_id: HirId,\n+    is_under_guard: bool,\n     is_top_level: bool,\n ) -> Usefulness<'tcx, 'p> {\n     let &Matrix(ref rows) = matrix;\n@@ -1653,7 +1658,7 @@ crate fn is_useful<'p, 'tcx>(\n         let mut unreachable_pats = Vec::new();\n         let mut any_is_useful = false;\n         for v in vs {\n-            let res = is_useful(cx, &matrix, &v, witness_preference, hir_id, false);\n+            let res = is_useful(cx, &matrix, &v, witness_preference, hir_id, is_under_guard, false);\n             match res {\n                 Useful(pats) => {\n                     any_is_useful = true;\n@@ -1664,7 +1669,10 @@ crate fn is_useful<'p, 'tcx>(\n                     bug!(\"Encountered or-pat in `v` during exhaustiveness checking\")\n                 }\n             }\n-            matrix.push(v);\n+            // If pattern has a guard don't add it to the matrix\n+            if !is_under_guard {\n+                matrix.push(v);\n+            }\n         }\n         return if any_is_useful { Useful(unreachable_pats) } else { NotUseful };\n     }\n@@ -1712,7 +1720,18 @@ crate fn is_useful<'p, 'tcx>(\n             Some(hir_id),\n         )\n         .into_iter()\n-        .map(|c| is_useful_specialized(cx, matrix, v, c, pcx.ty, witness_preference, hir_id))\n+        .map(|c| {\n+            is_useful_specialized(\n+                cx,\n+                matrix,\n+                v,\n+                c,\n+                pcx.ty,\n+                witness_preference,\n+                hir_id,\n+                is_under_guard,\n+            )\n+        })\n         .find(|result| result.is_useful())\n         .unwrap_or(NotUseful)\n     } else {\n@@ -1746,14 +1765,24 @@ crate fn is_useful<'p, 'tcx>(\n             split_grouped_constructors(cx.tcx, cx.param_env, pcx, all_ctors, matrix, DUMMY_SP, None)\n                 .into_iter()\n                 .map(|c| {\n-                    is_useful_specialized(cx, matrix, v, c, pcx.ty, witness_preference, hir_id)\n+                    is_useful_specialized(\n+                        cx,\n+                        matrix,\n+                        v,\n+                        c,\n+                        pcx.ty,\n+                        witness_preference,\n+                        hir_id,\n+                        is_under_guard,\n+                    )\n                 })\n                 .find(|result| result.is_useful())\n                 .unwrap_or(NotUseful)\n         } else {\n             let matrix = matrix.specialize_wildcard();\n             let v = v.to_tail();\n-            let usefulness = is_useful(cx, &matrix, &v, witness_preference, hir_id, false);\n+            let usefulness =\n+                is_useful(cx, &matrix, &v, witness_preference, hir_id, is_under_guard, false);\n \n             // In this case, there's at least one \"free\"\n             // constructor that is only matched against by\n@@ -1810,14 +1839,15 @@ fn is_useful_specialized<'p, 'tcx>(\n     lty: Ty<'tcx>,\n     witness_preference: WitnessPreference,\n     hir_id: HirId,\n+    is_under_guard: bool,\n ) -> Usefulness<'tcx, 'p> {\n     debug!(\"is_useful_specialized({:#?}, {:#?}, {:?})\", v, ctor, lty);\n \n     let ctor_wild_subpatterns =\n         cx.pattern_arena.alloc_from_iter(ctor.wildcard_subpatterns(cx, lty));\n     let matrix = matrix.specialize_constructor(cx, &ctor, ctor_wild_subpatterns);\n     v.specialize_constructor(cx, &ctor, ctor_wild_subpatterns)\n-        .map(|v| is_useful(cx, &matrix, &v, witness_preference, hir_id, false))\n+        .map(|v| is_useful(cx, &matrix, &v, witness_preference, hir_id, is_under_guard, false))\n         .map(|u| u.apply_constructor(cx, &ctor, lty))\n         .unwrap_or(NotUseful)\n }"}, {"sha": "c2eeac60b8b3bc709e2357f123f67ca2c0622ec4", "filename": "src/librustc_mir_build/hair/pattern/check_match.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/c640b95662acf89a0e716cb0b849c29bff55000f/src%2Flibrustc_mir_build%2Fhair%2Fpattern%2Fcheck_match.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c640b95662acf89a0e716cb0b849c29bff55000f/src%2Flibrustc_mir_build%2Fhair%2Fpattern%2Fcheck_match.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir_build%2Fhair%2Fpattern%2Fcheck_match.rs?ref=c640b95662acf89a0e716cb0b849c29bff55000f", "patch": "@@ -360,7 +360,7 @@ fn check_arms<'p, 'tcx>(\n     let mut catchall = None;\n     for (arm_index, (pat, id, has_guard)) in arms.iter().copied().enumerate() {\n         let v = PatStack::from_pattern(pat);\n-        match is_useful(cx, &seen, &v, LeaveOutWitness, id, true) {\n+        match is_useful(cx, &seen, &v, LeaveOutWitness, id, has_guard, true) {\n             NotUseful => {\n                 match source {\n                     hir::MatchSource::IfDesugar { .. } | hir::MatchSource::WhileDesugar => bug!(),\n@@ -410,7 +410,10 @@ fn check_not_useful<'p, 'tcx>(\n ) -> Result<(), Vec<super::Pat<'tcx>>> {\n     let wild_pattern = cx.pattern_arena.alloc(super::Pat::wildcard_from_ty(ty));\n     let v = PatStack::from_pattern(wild_pattern);\n-    match is_useful(cx, matrix, &v, ConstructWitness, hir_id, true) {\n+\n+    // false is given for `is_under_guard` argument due to the wildcard\n+    // pattern not having a guard\n+    match is_useful(cx, matrix, &v, ConstructWitness, hir_id, false, true) {\n         NotUseful => Ok(()), // This is good, wildcard pattern isn't reachable.\n         UsefulWithWitness(pats) => Err(if pats.is_empty() {\n             bug!(\"Exhaustiveness check returned no witnesses\")"}, {"sha": "eb6706e50006f7d6c005664a3a6261786a0410d0", "filename": "src/test/ui/or-patterns/issue-70413-no-unreachable-pat-and-guard.rs", "status": "added", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/c640b95662acf89a0e716cb0b849c29bff55000f/src%2Ftest%2Fui%2For-patterns%2Fissue-70413-no-unreachable-pat-and-guard.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c640b95662acf89a0e716cb0b849c29bff55000f/src%2Ftest%2Fui%2For-patterns%2Fissue-70413-no-unreachable-pat-and-guard.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2For-patterns%2Fissue-70413-no-unreachable-pat-and-guard.rs?ref=c640b95662acf89a0e716cb0b849c29bff55000f", "patch": "@@ -0,0 +1,22 @@\n+// check-pass\n+\n+#![deny(unreachable_patterns)]\n+\n+#![feature(or_patterns)]\n+fn main() {\n+    match (3,42) {\n+        (a,_) | (_,a) if a > 10 => {println!(\"{}\", a)}\n+        _ => ()\n+    }\n+\n+    match Some((3,42)) {\n+        Some((a, _)) | Some((_, a)) if a > 10 => {println!(\"{}\", a)}\n+        _ => ()\n+\n+    }\n+\n+    match Some((3,42)) {\n+        Some((a, _) | (_, a)) if a > 10 => {println!(\"{}\", a)}\n+        _ => ()\n+    }\n+}"}]}