{"sha": "e67e1655854b8f2c94dff80f4da2e595bd1ceaa8", "node_id": "C_kwDOAAsO6NoAKGU2N2UxNjU1ODU0YjhmMmM5NGRmZjgwZjRkYTJlNTk1YmQxY2VhYTg", "commit": {"author": {"name": "Josh Stone", "email": "jistone@redhat.com", "date": "2022-06-27T17:05:55Z"}, "committer": {"name": "Josh Stone", "email": "jistone@redhat.com", "date": "2022-06-27T17:05:55Z"}, "message": "Make `ThinBox<T>` covariant in `T`\n\nJust like `Box<T>`, we want `ThinBox<T>` to be covariant in `T`, but the\nprojection in `WithHeader<<T as Pointee>::Metadata>` was making it\ninvariant. This is now hidden as `WithOpaqueHeader`, which we type-cast\nwhenever the real `WithHeader<H>` type is needed.", "tree": {"sha": "6ae5fbdbf49550cfa0b7fff0d99a49ca97a7aa92", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6ae5fbdbf49550cfa0b7fff0d99a49ca97a7aa92"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e67e1655854b8f2c94dff80f4da2e595bd1ceaa8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e67e1655854b8f2c94dff80f4da2e595bd1ceaa8", "html_url": "https://github.com/rust-lang/rust/commit/e67e1655854b8f2c94dff80f4da2e595bd1ceaa8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e67e1655854b8f2c94dff80f4da2e595bd1ceaa8/comments", "author": {"login": "cuviper", "id": 36186, "node_id": "MDQ6VXNlcjM2MTg2", "avatar_url": "https://avatars.githubusercontent.com/u/36186?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cuviper", "html_url": "https://github.com/cuviper", "followers_url": "https://api.github.com/users/cuviper/followers", "following_url": "https://api.github.com/users/cuviper/following{/other_user}", "gists_url": "https://api.github.com/users/cuviper/gists{/gist_id}", "starred_url": "https://api.github.com/users/cuviper/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cuviper/subscriptions", "organizations_url": "https://api.github.com/users/cuviper/orgs", "repos_url": "https://api.github.com/users/cuviper/repos", "events_url": "https://api.github.com/users/cuviper/events{/privacy}", "received_events_url": "https://api.github.com/users/cuviper/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cuviper", "id": 36186, "node_id": "MDQ6VXNlcjM2MTg2", "avatar_url": "https://avatars.githubusercontent.com/u/36186?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cuviper", "html_url": "https://github.com/cuviper", "followers_url": "https://api.github.com/users/cuviper/followers", "following_url": "https://api.github.com/users/cuviper/following{/other_user}", "gists_url": "https://api.github.com/users/cuviper/gists{/gist_id}", "starred_url": "https://api.github.com/users/cuviper/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cuviper/subscriptions", "organizations_url": "https://api.github.com/users/cuviper/orgs", "repos_url": "https://api.github.com/users/cuviper/repos", "events_url": "https://api.github.com/users/cuviper/events{/privacy}", "received_events_url": "https://api.github.com/users/cuviper/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bd2e51a338e36372b200a22f3e0e22189a1063e6", "url": "https://api.github.com/repos/rust-lang/rust/commits/bd2e51a338e36372b200a22f3e0e22189a1063e6", "html_url": "https://github.com/rust-lang/rust/commit/bd2e51a338e36372b200a22f3e0e22189a1063e6"}], "stats": {"total": 40, "additions": 34, "deletions": 6}, "files": [{"sha": "627b52be052123953d00a10bff359998a9f6d2f3", "filename": "library/alloc/src/boxed/thin.rs", "status": "modified", "additions": 27, "deletions": 6, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/e67e1655854b8f2c94dff80f4da2e595bd1ceaa8/library%2Falloc%2Fsrc%2Fboxed%2Fthin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e67e1655854b8f2c94dff80f4da2e595bd1ceaa8/library%2Falloc%2Fsrc%2Fboxed%2Fthin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Falloc%2Fsrc%2Fboxed%2Fthin.rs?ref=e67e1655854b8f2c94dff80f4da2e595bd1ceaa8", "patch": "@@ -29,7 +29,9 @@ use core::ptr::{self, NonNull};\n /// ```\n #[unstable(feature = \"thin_box\", issue = \"92791\")]\n pub struct ThinBox<T: ?Sized> {\n-    ptr: WithHeader<<T as Pointee>::Metadata>,\n+    // This is essentially `WithHeader<<T as Pointee>::Metadata>`,\n+    // but that would be invariant in `T`, and we want covariance.\n+    ptr: WithOpaqueHeader,\n     _marker: PhantomData<T>,\n }\n \n@@ -49,7 +51,7 @@ impl<T> ThinBox<T> {\n     #[cfg(not(no_global_oom_handling))]\n     pub fn new(value: T) -> Self {\n         let meta = ptr::metadata(&value);\n-        let ptr = WithHeader::new(meta, value);\n+        let ptr = WithOpaqueHeader::new(meta, value);\n         ThinBox { ptr, _marker: PhantomData }\n     }\n }\n@@ -73,7 +75,7 @@ impl<Dyn: ?Sized> ThinBox<Dyn> {\n         T: Unsize<Dyn>,\n     {\n         let meta = ptr::metadata(&value as &Dyn);\n-        let ptr = WithHeader::new(meta, value);\n+        let ptr = WithOpaqueHeader::new(meta, value);\n         ThinBox { ptr, _marker: PhantomData }\n     }\n }\n@@ -120,7 +122,7 @@ impl<T: ?Sized> Drop for ThinBox<T> {\n         unsafe {\n             let value = self.deref_mut();\n             let value = value as *mut T;\n-            self.ptr.drop::<T>(value);\n+            self.with_header().drop::<T>(value);\n         }\n     }\n }\n@@ -130,11 +132,16 @@ impl<T: ?Sized> ThinBox<T> {\n     fn meta(&self) -> <T as Pointee>::Metadata {\n         //  Safety:\n         //  -   NonNull and valid.\n-        unsafe { *self.ptr.header() }\n+        unsafe { *self.with_header().header() }\n     }\n \n     fn data(&self) -> *mut u8 {\n-        self.ptr.value()\n+        self.with_header().value()\n+    }\n+\n+    fn with_header(&self) -> &WithHeader<<T as Pointee>::Metadata> {\n+        // SAFETY: both types are transparent to `NonNull<u8>`\n+        unsafe { &*((&self.ptr) as *const WithOpaqueHeader as *const WithHeader<_>) }\n     }\n }\n \n@@ -143,8 +150,22 @@ impl<T: ?Sized> ThinBox<T> {\n ///    metadata (`H`) are ZSTs.\n /// 2. A pointer to a valid `T` that has a header `H` directly before the\n ///    pointed-to location.\n+#[repr(transparent)]\n struct WithHeader<H>(NonNull<u8>, PhantomData<H>);\n \n+/// An opaque representation of `WithHeader<H>` to avoid the\n+/// projection invariance of `<T as Pointee>::Metadata`.\n+#[repr(transparent)]\n+struct WithOpaqueHeader(NonNull<u8>);\n+\n+impl WithOpaqueHeader {\n+    #[cfg(not(no_global_oom_handling))]\n+    fn new<H, T>(header: H, value: T) -> Self {\n+        let ptr = WithHeader::new(header, value);\n+        Self(ptr.0)\n+    }\n+}\n+\n impl<H> WithHeader<H> {\n     #[cfg(not(no_global_oom_handling))]\n     fn new<T>(header: H, value: T) -> WithHeader<H> {"}, {"sha": "368aa564f94367ed564c0c70e421d523aa7cbbdd", "filename": "library/alloc/tests/thin_box.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/e67e1655854b8f2c94dff80f4da2e595bd1ceaa8/library%2Falloc%2Ftests%2Fthin_box.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e67e1655854b8f2c94dff80f4da2e595bd1ceaa8/library%2Falloc%2Ftests%2Fthin_box.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Falloc%2Ftests%2Fthin_box.rs?ref=e67e1655854b8f2c94dff80f4da2e595bd1ceaa8", "patch": "@@ -26,6 +26,13 @@ fn want_thin() {\n     assert!(is_thin::<i32>());\n }\n \n+#[allow(dead_code)]\n+fn assert_covariance() {\n+    fn thin_box<'new>(b: ThinBox<[&'static str]>) -> ThinBox<[&'new str]> {\n+        b\n+    }\n+}\n+\n #[track_caller]\n fn verify_aligned<T>(ptr: *const T) {\n     // Use `black_box` to attempt to obscure the fact that we're calling this"}]}