{"sha": "1c0ed0d4c4bd7b39299966e57806d29ce38c95af", "node_id": "C_kwDOAAsO6NoAKDFjMGVkMGQ0YzRiZDdiMzkyOTk5NjZlNTc4MDZkMjljZTM4Yzk1YWY", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-10-01T00:35:35Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-10-01T00:35:35Z"}, "message": "Auto merge of #89183 - cjgillot:noenc, r=oli-obk\n\nMove encode_metadata out of CrateStore.\n\n`rustc_metadata` is already accessible by all client crates. It does not need to be called trough a trait object.", "tree": {"sha": "303f4d35ef24fb4dde91f0b21e3b13fa9eff6b27", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/303f4d35ef24fb4dde91f0b21e3b13fa9eff6b27"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1c0ed0d4c4bd7b39299966e57806d29ce38c95af", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1c0ed0d4c4bd7b39299966e57806d29ce38c95af", "html_url": "https://github.com/rust-lang/rust/commit/1c0ed0d4c4bd7b39299966e57806d29ce38c95af", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "aa7aca3b954131720df725e70d12e902eb3be1de", "url": "https://api.github.com/repos/rust-lang/rust/commits/aa7aca3b954131720df725e70d12e902eb3be1de", "html_url": "https://github.com/rust-lang/rust/commit/aa7aca3b954131720df725e70d12e902eb3be1de"}, {"sha": "2d51b78ca9d305552883eea5cf83228f49fefce7", "url": "https://api.github.com/repos/rust-lang/rust/commits/2d51b78ca9d305552883eea5cf83228f49fefce7", "html_url": "https://github.com/rust-lang/rust/commit/2d51b78ca9d305552883eea5cf83228f49fefce7"}], "stats": {"total": 113, "additions": 57, "deletions": 56}, "files": [{"sha": "157c1749c8782ee3c93bc90494062fe78b74e064", "filename": "Cargo.lock", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=1c0ed0d4c4bd7b39299966e57806d29ce38c95af", "patch": "@@ -3706,6 +3706,7 @@ dependencies = [\n  \"rustc_incremental\",\n  \"rustc_index\",\n  \"rustc_macros\",\n+ \"rustc_metadata\",\n  \"rustc_middle\",\n  \"rustc_serialize\",\n  \"rustc_session\","}, {"sha": "a0e99267c2b705771b9c9cfee2e11a41c12a5cf1", "filename": "compiler/rustc_codegen_cranelift/scripts/filter_profile.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_codegen_cranelift%2Fscripts%2Ffilter_profile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_codegen_cranelift%2Fscripts%2Ffilter_profile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fscripts%2Ffilter_profile.rs?ref=1c0ed0d4c4bd7b39299966e57806d29ce38c95af", "patch": "@@ -96,7 +96,7 @@ fn main() -> Result<(), Box<dyn std::error::Error>> {\n             stack = &stack[..index + REPORT_SYMBOL_NAMES.len()];\n         }\n \n-        const ENCODE_METADATA: &str = \"rustc_middle::ty::context::TyCtxt::encode_metadata\";\n+        const ENCODE_METADATA: &str = \"rustc_metadata::rmeta::encoder::encode_metadata\";\n         if let Some(index) = stack.find(ENCODE_METADATA) {\n             stack = &stack[..index + ENCODE_METADATA.len()];\n         }"}, {"sha": "32cc50eebe4364ad8c6707757c63e87501304196", "filename": "compiler/rustc_codegen_cranelift/src/driver/aot.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fdriver%2Faot.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fdriver%2Faot.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fdriver%2Faot.rs?ref=1c0ed0d4c4bd7b39299966e57806d29ce38c95af", "patch": "@@ -6,8 +6,8 @@ use std::path::PathBuf;\n use rustc_ast::{InlineAsmOptions, InlineAsmTemplatePiece};\n use rustc_codegen_ssa::{CodegenResults, CompiledModule, CrateInfo, ModuleKind};\n use rustc_data_structures::stable_hasher::{HashStable, StableHasher};\n+use rustc_metadata::EncodedMetadata;\n use rustc_middle::dep_graph::{WorkProduct, WorkProductId};\n-use rustc_middle::middle::cstore::EncodedMetadata;\n use rustc_middle::mir::mono::{CodegenUnit, MonoItem};\n use rustc_session::cgu_reuse_tracker::CguReuse;\n use rustc_session::config::{DebugInfo, OutputType};"}, {"sha": "beb97edf09e895d778a38e9dc973cc2e0f42dd1d", "filename": "compiler/rustc_codegen_cranelift/src/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_codegen_cranelift%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_codegen_cranelift%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Flib.rs?ref=1c0ed0d4c4bd7b39299966e57806d29ce38c95af", "patch": "@@ -30,8 +30,8 @@ use std::any::Any;\n use rustc_codegen_ssa::traits::CodegenBackend;\n use rustc_codegen_ssa::CodegenResults;\n use rustc_errors::ErrorReported;\n+use rustc_metadata::EncodedMetadata;\n use rustc_middle::dep_graph::{WorkProduct, WorkProductId};\n-use rustc_middle::middle::cstore::EncodedMetadata;\n use rustc_session::config::OutputFilenames;\n use rustc_session::Session;\n "}, {"sha": "1c8fd0b01d9d94ed346e67bf5ae734bb9d12b50b", "filename": "compiler/rustc_codegen_cranelift/src/metadata.rs", "status": "modified", "additions": 7, "deletions": 3, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fmetadata.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fmetadata.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fmetadata.rs?ref=1c0ed0d4c4bd7b39299966e57806d29ce38c95af", "patch": "@@ -3,16 +3,20 @@\n use object::write::{Object, StandardSegment, Symbol, SymbolSection};\n use object::{SectionKind, SymbolFlags, SymbolKind, SymbolScope};\n \n-use rustc_middle::middle::cstore::EncodedMetadata;\n+use rustc_metadata::EncodedMetadata;\n use rustc_middle::ty::TyCtxt;\n \n // Adapted from https://github.com/rust-lang/rust/blob/da573206f87b5510de4b0ee1a9c044127e409bd3/src/librustc_codegen_llvm/base.rs#L47-L112\n-pub(crate) fn new_metadata_object(tcx: TyCtxt<'_>, cgu_name: &str, metadata: &EncodedMetadata) -> Vec<u8> {\n+pub(crate) fn new_metadata_object(\n+    tcx: TyCtxt<'_>,\n+    cgu_name: &str,\n+    metadata: &EncodedMetadata,\n+) -> Vec<u8> {\n     use snap::write::FrameEncoder;\n     use std::io::Write;\n \n     let mut compressed = rustc_metadata::METADATA_HEADER.to_vec();\n-    FrameEncoder::new(&mut compressed).write_all(&metadata.raw_data).unwrap();\n+    FrameEncoder::new(&mut compressed).write_all(metadata.raw_data()).unwrap();\n \n     let triple = crate::target_triple(tcx.sess);\n "}, {"sha": "9f96096574fe158734744768d1cff77ed3f1db20", "filename": "compiler/rustc_codegen_gcc/src/base.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_codegen_gcc%2Fsrc%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_codegen_gcc%2Fsrc%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_gcc%2Fsrc%2Fbase.rs?ref=1c0ed0d4c4bd7b39299966e57806d29ce38c95af", "patch": "@@ -7,14 +7,14 @@ use gccjit::{\n     GlobalKind,\n };\n use rustc_middle::dep_graph;\n-use rustc_middle::middle::cstore::EncodedMetadata;\n use rustc_middle::middle::exported_symbols;\n use rustc_middle::ty::TyCtxt;\n use rustc_middle::mir::mono::Linkage;\n use rustc_codegen_ssa::{ModuleCodegen, ModuleKind};\n use rustc_codegen_ssa::base::maybe_create_entry_wrapper;\n use rustc_codegen_ssa::mono_item::MonoItemExt;\n use rustc_codegen_ssa::traits::DebugInfoMethods;\n+use rustc_metadata::EncodedMetadata;\n use rustc_session::config::DebugInfo;\n use rustc_span::Symbol;\n \n@@ -149,7 +149,7 @@ pub fn write_compressed_metadata<'tcx>(tcx: TyCtxt<'tcx>, metadata: &EncodedMeta\n \n     let context = &gcc_module.context;\n     let mut compressed = rustc_metadata::METADATA_HEADER.to_vec();\n-    FrameEncoder::new(&mut compressed).write_all(&metadata.raw_data).unwrap();\n+    FrameEncoder::new(&mut compressed).write_all(&metadata.raw_data()).unwrap();\n \n     let name = exported_symbols::metadata_symbol_name(tcx);\n     let typ = context.new_array_type(None, context.new_type::<u8>(), compressed.len() as i32);"}, {"sha": "629003d7982b90072e0a57ee727a21cc0ee877a8", "filename": "compiler/rustc_codegen_gcc/src/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_codegen_gcc%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_codegen_gcc%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_gcc%2Fsrc%2Flib.rs?ref=1c0ed0d4c4bd7b39299966e57806d29ce38c95af", "patch": "@@ -60,8 +60,8 @@ use rustc_codegen_ssa::target_features::supported_target_features;\n use rustc_codegen_ssa::traits::{CodegenBackend, ExtraBackendMethods, ModuleBufferMethods, ThinBufferMethods, WriteBackendMethods};\n use rustc_data_structures::fx::FxHashMap;\n use rustc_errors::{ErrorReported, Handler};\n+use rustc_metadata::EncodedMetadata;\n use rustc_middle::dep_graph::{WorkProduct, WorkProductId};\n-use rustc_middle::middle::cstore::EncodedMetadata;\n use rustc_middle::ty::TyCtxt;\n use rustc_session::config::{Lto, OptLevel, OutputFilenames};\n use rustc_session::Session;"}, {"sha": "3026c2fa0309aed4c046e3dc3da594fba0927672", "filename": "compiler/rustc_codegen_llvm/src/base.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_codegen_llvm%2Fsrc%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_codegen_llvm%2Fsrc%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fbase.rs?ref=1c0ed0d4c4bd7b39299966e57806d29ce38c95af", "patch": "@@ -25,9 +25,9 @@ use rustc_codegen_ssa::mono_item::MonoItemExt;\n use rustc_codegen_ssa::traits::*;\n use rustc_codegen_ssa::{ModuleCodegen, ModuleKind};\n use rustc_data_structures::small_c_str::SmallCStr;\n+use rustc_metadata::EncodedMetadata;\n use rustc_middle::dep_graph;\n use rustc_middle::middle::codegen_fn_attrs::CodegenFnAttrs;\n-use rustc_middle::middle::cstore::EncodedMetadata;\n use rustc_middle::middle::exported_symbols;\n use rustc_middle::mir::mono::{Linkage, Visibility};\n use rustc_middle::ty::TyCtxt;\n@@ -64,7 +64,7 @@ pub fn write_compressed_metadata<'tcx>(\n \n     let (metadata_llcx, metadata_llmod) = (&*llvm_module.llcx, llvm_module.llmod());\n     let mut compressed = rustc_metadata::METADATA_HEADER.to_vec();\n-    FrameEncoder::new(&mut compressed).write_all(&metadata.raw_data).unwrap();\n+    FrameEncoder::new(&mut compressed).write_all(metadata.raw_data()).unwrap();\n \n     let llmeta = common::bytes_in_context(metadata_llcx, &compressed);\n     let llconst = common::struct_in_context(metadata_llcx, &[llmeta], false);"}, {"sha": "79bdace5158326833ae28e073e359c61d3876ee8", "filename": "compiler/rustc_codegen_llvm/src/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_codegen_llvm%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_codegen_llvm%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Flib.rs?ref=1c0ed0d4c4bd7b39299966e57806d29ce38c95af", "patch": "@@ -27,8 +27,8 @@ use rustc_codegen_ssa::ModuleCodegen;\n use rustc_codegen_ssa::{CodegenResults, CompiledModule};\n use rustc_data_structures::fx::FxHashMap;\n use rustc_errors::{ErrorReported, FatalError, Handler};\n+use rustc_metadata::EncodedMetadata;\n use rustc_middle::dep_graph::{WorkProduct, WorkProductId};\n-use rustc_middle::middle::cstore::EncodedMetadata;\n use rustc_middle::ty::TyCtxt;\n use rustc_session::config::{OptLevel, OutputFilenames, PrintRequest};\n use rustc_session::Session;"}, {"sha": "54641df61793e37c120920d7b779674cd3b9e2d4", "filename": "compiler/rustc_codegen_ssa/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_codegen_ssa%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_codegen_ssa%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2FCargo.toml?ref=1c0ed0d4c4bd7b39299966e57806d29ce38c95af", "patch": "@@ -32,6 +32,7 @@ rustc_hir = { path = \"../rustc_hir\" }\n rustc_incremental = { path = \"../rustc_incremental\" }\n rustc_index = { path = \"../rustc_index\" }\n rustc_macros = { path = \"../rustc_macros\" }\n+rustc_metadata = { path = \"../rustc_metadata\" }\n rustc_target = { path = \"../rustc_target\" }\n rustc_session = { path = \"../rustc_session\" }\n "}, {"sha": "1c0442a231a580e7607b7846b97069227cb4eb50", "filename": "compiler/rustc_codegen_ssa/src/back/link.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs?ref=1c0ed0d4c4bd7b39299966e57806d29ce38c95af", "patch": "@@ -327,7 +327,7 @@ fn link_rlib<'a, B: ArchiveBuilder<'a>>(\n             // metadata in rlib files is wrapped in a \"dummy\" object file for\n             // the target platform so the rlib can be processed entirely by\n             // normal linkers for the platform.\n-            let metadata = create_metadata_file(sess, &codegen_results.metadata.raw_data);\n+            let metadata = create_metadata_file(sess, codegen_results.metadata.raw_data());\n             ab.add_file(&emit_metadata(sess, &metadata, tmpdir));\n \n             // After adding all files to the archive, we need to update the"}, {"sha": "31722d07414d062203d09abb33860ec12e8513a1", "filename": "compiler/rustc_codegen_ssa/src/back/write.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Fwrite.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Fwrite.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Fwrite.rs?ref=1c0ed0d4c4bd7b39299966e57806d29ce38c95af", "patch": "@@ -21,8 +21,8 @@ use rustc_hir::def_id::{CrateNum, LOCAL_CRATE};\n use rustc_incremental::{\n     copy_cgu_workproduct_to_incr_comp_cache_dir, in_incr_comp_dir, in_incr_comp_dir_sess,\n };\n+use rustc_metadata::EncodedMetadata;\n use rustc_middle::dep_graph::{WorkProduct, WorkProductId};\n-use rustc_middle::middle::cstore::EncodedMetadata;\n use rustc_middle::middle::exported_symbols::SymbolExportLevel;\n use rustc_middle::ty::TyCtxt;\n use rustc_session::cgu_reuse_tracker::CguReuseTracker;"}, {"sha": "9bb4982754c20cb3acaecd78c991603d540e6bc3", "filename": "compiler/rustc_codegen_ssa/src/base.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_codegen_ssa%2Fsrc%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_codegen_ssa%2Fsrc%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fbase.rs?ref=1c0ed0d4c4bd7b39299966e57806d29ce38c95af", "patch": "@@ -18,8 +18,8 @@ use rustc_hir as hir;\n use rustc_hir::def_id::{DefId, LOCAL_CRATE};\n use rustc_hir::lang_items::LangItem;\n use rustc_index::vec::Idx;\n+use rustc_metadata::EncodedMetadata;\n use rustc_middle::middle::codegen_fn_attrs::CodegenFnAttrs;\n-use rustc_middle::middle::cstore::EncodedMetadata;\n use rustc_middle::middle::lang_items;\n use rustc_middle::mir::mono::{CodegenUnit, CodegenUnitNameBuilder, MonoItem};\n use rustc_middle::ty::layout::{HasTyCtxt, LayoutOf, TyAndLayout};"}, {"sha": "70b351f643314c24fbe25f9417962bd1424f4983", "filename": "compiler/rustc_codegen_ssa/src/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_codegen_ssa%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_codegen_ssa%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Flib.rs?ref=1c0ed0d4c4bd7b39299966e57806d29ce38c95af", "patch": "@@ -158,7 +158,7 @@ pub struct CodegenResults {\n     pub modules: Vec<CompiledModule>,\n     pub allocator_module: Option<CompiledModule>,\n     pub metadata_module: Option<CompiledModule>,\n-    pub metadata: rustc_middle::middle::cstore::EncodedMetadata,\n+    pub metadata: rustc_metadata::EncodedMetadata,\n     pub crate_info: CrateInfo,\n }\n "}, {"sha": "50a46877c5acaeb5bafe93917bd2e90b3a405fbc", "filename": "compiler/rustc_codegen_ssa/src/traits/backend.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_codegen_ssa%2Fsrc%2Ftraits%2Fbackend.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_codegen_ssa%2Fsrc%2Ftraits%2Fbackend.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Ftraits%2Fbackend.rs?ref=1c0ed0d4c4bd7b39299966e57806d29ce38c95af", "patch": "@@ -6,8 +6,9 @@ use crate::{CodegenResults, ModuleCodegen};\n use rustc_ast::expand::allocator::AllocatorKind;\n use rustc_data_structures::fx::FxHashMap;\n use rustc_errors::ErrorReported;\n+use rustc_metadata::EncodedMetadata;\n use rustc_middle::dep_graph::{WorkProduct, WorkProductId};\n-use rustc_middle::middle::cstore::{EncodedMetadata, MetadataLoaderDyn};\n+use rustc_middle::middle::cstore::MetadataLoaderDyn;\n use rustc_middle::ty::layout::{FnAbiOf, HasTyCtxt, LayoutOf, TyAndLayout};\n use rustc_middle::ty::query::Providers;\n use rustc_middle::ty::{Ty, TyCtxt};"}, {"sha": "55a3fcd0266c4acbdcc39b6a879ecd15d974b3f9", "filename": "compiler/rustc_interface/src/passes.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_interface%2Fsrc%2Fpasses.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_interface%2Fsrc%2Fpasses.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2Fsrc%2Fpasses.rs?ref=1c0ed0d4c4bd7b39299966e57806d29ce38c95af", "patch": "@@ -16,9 +16,9 @@ use rustc_hir::def_id::{StableCrateId, LOCAL_CRATE};\n use rustc_hir::Crate;\n use rustc_lint::LintStore;\n use rustc_metadata::creader::CStore;\n+use rustc_metadata::{encode_metadata, EncodedMetadata};\n use rustc_middle::arena::Arena;\n use rustc_middle::dep_graph::DepGraph;\n-use rustc_middle::middle;\n use rustc_middle::middle::cstore::{MetadataLoader, MetadataLoaderDyn};\n use rustc_middle::ty::query::Providers;\n use rustc_middle::ty::{self, GlobalCtxt, ResolverOutputs, TyCtxt};\n@@ -977,7 +977,7 @@ fn analysis(tcx: TyCtxt<'_>, (): ()) -> Result<()> {\n fn encode_and_write_metadata(\n     tcx: TyCtxt<'_>,\n     outputs: &OutputFilenames,\n-) -> (middle::cstore::EncodedMetadata, bool) {\n+) -> (EncodedMetadata, bool) {\n     #[derive(PartialEq, Eq, PartialOrd, Ord)]\n     enum MetadataKind {\n         None,\n@@ -1000,8 +1000,8 @@ fn encode_and_write_metadata(\n         .unwrap_or(MetadataKind::None);\n \n     let metadata = match metadata_kind {\n-        MetadataKind::None => middle::cstore::EncodedMetadata::new(),\n-        MetadataKind::Uncompressed | MetadataKind::Compressed => tcx.encode_metadata(),\n+        MetadataKind::None => EncodedMetadata::new(),\n+        MetadataKind::Uncompressed | MetadataKind::Compressed => encode_metadata(tcx),\n     };\n \n     let _prof_timer = tcx.sess.prof.generic_activity(\"write_crate_metadata\");\n@@ -1020,7 +1020,7 @@ fn encode_and_write_metadata(\n             .tempdir_in(out_filename.parent().unwrap())\n             .unwrap_or_else(|err| tcx.sess.fatal(&format!(\"couldn't create a temp dir: {}\", err)));\n         let metadata_tmpdir = MaybeTempDir::new(metadata_tmpdir, tcx.sess.opts.cg.save_temps);\n-        let metadata_filename = emit_metadata(tcx.sess, &metadata.raw_data, &metadata_tmpdir);\n+        let metadata_filename = emit_metadata(tcx.sess, metadata.raw_data(), &metadata_tmpdir);\n         if let Err(e) = util::non_durable_rename(&metadata_filename, &out_filename) {\n             tcx.sess.fatal(&format!(\"failed to write {}: {}\", out_filename.display(), e));\n         }"}, {"sha": "644b849a9f899e17bb81ccfec572c1591cc64489", "filename": "compiler/rustc_metadata/src/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_metadata%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_metadata%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_metadata%2Fsrc%2Flib.rs?ref=1c0ed0d4c4bd7b39299966e57806d29ce38c95af", "patch": "@@ -30,4 +30,4 @@ pub mod creader;\n pub mod dynamic_lib;\n pub mod locator;\n \n-pub use rmeta::METADATA_HEADER;\n+pub use rmeta::{encode_metadata, EncodedMetadata, METADATA_HEADER};"}, {"sha": "bd1d99640f81d6256fc55b6e5864a33f8e7550da", "filename": "compiler/rustc_metadata/src/rmeta/decoder/cstore_impl.rs", "status": "modified", "additions": 1, "deletions": 6, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fdecoder%2Fcstore_impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fdecoder%2Fcstore_impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fdecoder%2Fcstore_impl.rs?ref=1c0ed0d4c4bd7b39299966e57806d29ce38c95af", "patch": "@@ -1,7 +1,6 @@\n use crate::creader::{CStore, LoadedMacro};\n use crate::foreign_modules;\n use crate::native_libs;\n-use crate::rmeta::encoder;\n \n use rustc_ast as ast;\n use rustc_data_structures::stable_map::FxHashMap;\n@@ -10,7 +9,7 @@ use rustc_hir::def_id::{CrateNum, DefId, DefIdMap, CRATE_DEF_INDEX, LOCAL_CRATE}\n use rustc_hir::definitions::{DefKey, DefPath, DefPathHash};\n use rustc_middle::hir::exports::Export;\n use rustc_middle::middle::cstore::ForeignModule;\n-use rustc_middle::middle::cstore::{CrateSource, CrateStore, EncodedMetadata};\n+use rustc_middle::middle::cstore::{CrateSource, CrateStore};\n use rustc_middle::middle::exported_symbols::ExportedSymbol;\n use rustc_middle::middle::stability::DeprecationEntry;\n use rustc_middle::ty::query::Providers;\n@@ -511,8 +510,4 @@ impl CrateStore for CStore {\n     fn expn_hash_to_expn_id(&self, cnum: CrateNum, index_guess: u32, hash: ExpnHash) -> ExpnId {\n         self.get_crate_data(cnum).expn_hash_to_expn_id(index_guess, hash)\n     }\n-\n-    fn encode_metadata(&self, tcx: TyCtxt<'_>) -> EncodedMetadata {\n-        encoder::encode_metadata(tcx)\n-    }\n }"}, {"sha": "1e3bf8aca8bdcbd204f58179db0f09eb0fdde22c", "filename": "compiler/rustc_metadata/src/rmeta/encoder.rs", "status": "modified", "additions": 21, "deletions": 2, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fencoder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fencoder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fencoder.rs?ref=1c0ed0d4c4bd7b39299966e57806d29ce38c95af", "patch": "@@ -18,7 +18,7 @@ use rustc_hir::{AnonConst, GenericParamKind};\n use rustc_index::bit_set::GrowableBitSet;\n use rustc_index::vec::Idx;\n use rustc_middle::hir::map::Map;\n-use rustc_middle::middle::cstore::{EncodedMetadata, ForeignModule, LinkagePreference, NativeLib};\n+use rustc_middle::middle::cstore::{ForeignModule, LinkagePreference, NativeLib};\n use rustc_middle::middle::dependency_format::Linkage;\n use rustc_middle::middle::exported_symbols::{\n     metadata_symbol_name, ExportedSymbol, SymbolExportLevel,\n@@ -2101,7 +2101,26 @@ fn prefetch_mir(tcx: TyCtxt<'_>) {\n // will allow us to slice the metadata to the precise length that we just\n // generated regardless of trailing bytes that end up in it.\n \n-pub(super) fn encode_metadata(tcx: TyCtxt<'_>) -> EncodedMetadata {\n+#[derive(Encodable, Decodable)]\n+pub struct EncodedMetadata {\n+    raw_data: Vec<u8>,\n+}\n+\n+impl EncodedMetadata {\n+    #[inline]\n+    pub fn new() -> EncodedMetadata {\n+        EncodedMetadata { raw_data: Vec::new() }\n+    }\n+\n+    #[inline]\n+    pub fn raw_data(&self) -> &[u8] {\n+        &self.raw_data[..]\n+    }\n+}\n+\n+pub fn encode_metadata(tcx: TyCtxt<'_>) -> EncodedMetadata {\n+    let _prof_timer = tcx.prof.verbose_generic_activity(\"generate_crate_metadata\");\n+\n     // Since encoding metadata is not in a query, and nothing is cached,\n     // there's no need to do dep-graph tracking for any of it.\n     tcx.dep_graph.assert_ignored();"}, {"sha": "af06e1cf3f98020e307798ddb321f15f107a2dab", "filename": "compiler/rustc_metadata/src/rmeta/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fmod.rs?ref=1c0ed0d4c4bd7b39299966e57806d29ce38c95af", "patch": "@@ -33,6 +33,7 @@ use decoder::DecodeContext;\n pub use decoder::{provide, provide_extern};\n crate use decoder::{CrateMetadata, CrateNumMap, MetadataBlob};\n use encoder::EncodeContext;\n+pub use encoder::{encode_metadata, EncodedMetadata};\n use rustc_span::hygiene::SyntaxContextData;\n \n mod decoder;"}, {"sha": "2a1bb43a466b09638a995efc9ebc829d16c3f93d", "filename": "compiler/rustc_middle/src/middle/cstore.rs", "status": "modified", "additions": 0, "deletions": 16, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_middle%2Fsrc%2Fmiddle%2Fcstore.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_middle%2Fsrc%2Fmiddle%2Fcstore.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fmiddle%2Fcstore.rs?ref=1c0ed0d4c4bd7b39299966e57806d29ce38c95af", "patch": "@@ -2,8 +2,6 @@\n //! are *mostly* used as a part of that interface, but these should\n //! probably get a better home if someone can find one.\n \n-use crate::ty::TyCtxt;\n-\n use rustc_ast as ast;\n use rustc_data_structures::sync::{self, MetadataRef};\n use rustc_hir::def_id::{CrateNum, DefId, StableCrateId, LOCAL_CRATE};\n@@ -150,17 +148,6 @@ pub enum ExternCrateSource {\n     Path,\n }\n \n-#[derive(Encodable, Decodable)]\n-pub struct EncodedMetadata {\n-    pub raw_data: Vec<u8>,\n-}\n-\n-impl EncodedMetadata {\n-    pub fn new() -> EncodedMetadata {\n-        EncodedMetadata { raw_data: Vec::new() }\n-    }\n-}\n-\n /// The backend's way to give the crate store access to the metadata in a library.\n /// Note that it returns the raw metadata bytes stored in the library file, whether\n /// it is compressed, uncompressed, some weird mix, etc.\n@@ -204,9 +191,6 @@ pub trait CrateStore: std::fmt::Debug {\n     /// Fetch a DefId from a DefPathHash for a foreign crate.\n     fn def_path_hash_to_def_id(&self, cnum: CrateNum, hash: DefPathHash) -> DefId;\n     fn expn_hash_to_expn_id(&self, cnum: CrateNum, index_guess: u32, hash: ExpnHash) -> ExpnId;\n-\n-    // utility functions\n-    fn encode_metadata(&self, tcx: TyCtxt<'_>) -> EncodedMetadata;\n }\n \n pub type CrateStoreDyn = dyn CrateStore + sync::Sync;"}, {"sha": "1e8ae81333673e26926c5ce92f1bc068064d2253", "filename": "compiler/rustc_middle/src/ty/context.rs", "status": "modified", "additions": 0, "deletions": 6, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs?ref=1c0ed0d4c4bd7b39299966e57806d29ce38c95af", "patch": "@@ -7,7 +7,6 @@ use crate::ich::{NodeIdHashingMode, StableHashingContext};\n use crate::infer::canonical::{Canonical, CanonicalVarInfo, CanonicalVarInfos};\n use crate::lint::{struct_lint_level, LintDiagnosticBuilder, LintLevelSource};\n use crate::middle;\n-use crate::middle::cstore::EncodedMetadata;\n use crate::middle::resolve_lifetime::{self, LifetimeScopeForPath, ObjectLifetimeDefault};\n use crate::middle::stability;\n use crate::mir::interpret::{self, AllocId, Allocation, ConstValue, Scalar};\n@@ -1324,11 +1323,6 @@ impl<'tcx> TyCtxt<'tcx> {\n         )\n     }\n \n-    pub fn encode_metadata(self) -> EncodedMetadata {\n-        let _prof_timer = self.prof.verbose_generic_activity(\"generate_crate_metadata\");\n-        self.untracked_resolutions.cstore.encode_metadata(self)\n-    }\n-\n     /// Note that this is *untracked* and should only be used within the query\n     /// system if the result is otherwise tracked through queries\n     pub fn cstore_untracked(self) -> &'tcx ty::CrateStoreDyn {"}, {"sha": "7c16f7bdaf7c10872fab83a6024325476f087af5", "filename": "src/test/run-make-fulldeps/hotplug_codegen_backend/the_backend.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/src%2Ftest%2Frun-make-fulldeps%2Fhotplug_codegen_backend%2Fthe_backend.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1c0ed0d4c4bd7b39299966e57806d29ce38c95af/src%2Ftest%2Frun-make-fulldeps%2Fhotplug_codegen_backend%2Fthe_backend.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fhotplug_codegen_backend%2Fthe_backend.rs?ref=1c0ed0d4c4bd7b39299966e57806d29ce38c95af", "patch": "@@ -2,11 +2,12 @@\n #![deny(warnings)]\n \n extern crate rustc_codegen_ssa;\n-extern crate rustc_errors;\n-extern crate rustc_middle;\n extern crate rustc_data_structures;\n extern crate rustc_driver;\n+extern crate rustc_errors;\n extern crate rustc_hir;\n+extern crate rustc_metadata;\n+extern crate rustc_middle;\n extern crate rustc_session;\n extern crate rustc_span;\n extern crate rustc_symbol_mangling;\n@@ -16,8 +17,8 @@ use rustc_codegen_ssa::traits::CodegenBackend;\n use rustc_codegen_ssa::{CodegenResults, CrateInfo};\n use rustc_data_structures::fx::FxHashMap;\n use rustc_errors::ErrorReported;\n+use rustc_metadata::EncodedMetadata;\n use rustc_middle::dep_graph::{WorkProduct, WorkProductId};\n-use rustc_middle::middle::cstore::EncodedMetadata;\n use rustc_middle::ty::TyCtxt;\n use rustc_session::config::OutputFilenames;\n use rustc_session::Session;"}]}