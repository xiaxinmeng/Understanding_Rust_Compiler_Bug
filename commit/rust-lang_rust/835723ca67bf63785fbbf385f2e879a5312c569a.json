{"sha": "835723ca67bf63785fbbf385f2e879a5312c569a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjgzNTcyM2NhNjdiZjYzNzg1ZmJiZjM4NWYyZTg3OWE1MzEyYzU2OWE=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-07-05T14:06:50Z"}, "committer": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-07-05T14:06:50Z"}, "message": "Fix visibility computation with modules from the same block", "tree": {"sha": "7b9793055d1f25a748a40ec967719b5b9e072d7a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7b9793055d1f25a748a40ec967719b5b9e072d7a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/835723ca67bf63785fbbf385f2e879a5312c569a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/835723ca67bf63785fbbf385f2e879a5312c569a", "html_url": "https://github.com/rust-lang/rust/commit/835723ca67bf63785fbbf385f2e879a5312c569a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/835723ca67bf63785fbbf385f2e879a5312c569a/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ac300eaceb76fbd3f81a7c10d70b2a91ca5b89bc", "url": "https://api.github.com/repos/rust-lang/rust/commits/ac300eaceb76fbd3f81a7c10d70b2a91ca5b89bc", "html_url": "https://github.com/rust-lang/rust/commit/ac300eaceb76fbd3f81a7c10d70b2a91ca5b89bc"}], "stats": {"total": 67, "additions": 53, "deletions": 14}, "files": [{"sha": "ea5804c2f07e27cb78802e1076a725cc472fe7f4", "filename": "crates/hir_def/src/body/tests/block.rs", "status": "modified", "additions": 37, "deletions": 0, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/835723ca67bf63785fbbf385f2e879a5312c569a/crates%2Fhir_def%2Fsrc%2Fbody%2Ftests%2Fblock.rs", "raw_url": "https://github.com/rust-lang/rust/raw/835723ca67bf63785fbbf385f2e879a5312c569a/crates%2Fhir_def%2Fsrc%2Fbody%2Ftests%2Fblock.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fbody%2Ftests%2Fblock.rs?ref=835723ca67bf63785fbbf385f2e879a5312c569a", "patch": "@@ -344,3 +344,40 @@ fn foo() {\n         \"#]],\n     )\n }\n+\n+#[test]\n+fn is_visible_from_same_def_map() {\n+    // Regression test for https://github.com/rust-analyzer/rust-analyzer/issues/9481\n+    check_at(\n+        r#\"\n+fn outer() {\n+    mod command {\n+        use crate::name;\n+    }\n+\n+    mod tests {\n+        use super::*;\n+    }\n+    $0\n+}\n+        \"#,\n+        expect![[r#\"\n+            block scope\n+            command: t\n+            name: _\n+            tests: t\n+\n+            block scope::command\n+            name: _\n+\n+            block scope::tests\n+            name: _\n+            outer: v\n+\n+            crate\n+            outer: v\n+        \"#]],\n+    );\n+    // FIXME: `name` should not be visible in the block scope. This happens because ItemTrees store\n+    // inner items incorrectly.\n+}"}, {"sha": "ec8185ec3606a3973248d677c5287b1f810b819e", "filename": "crates/hir_def/src/lib.rs", "status": "modified", "additions": 0, "deletions": 12, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/835723ca67bf63785fbbf385f2e879a5312c569a/crates%2Fhir_def%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/835723ca67bf63785fbbf385f2e879a5312c569a/crates%2Fhir_def%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Flib.rs?ref=835723ca67bf63785fbbf385f2e879a5312c569a", "patch": "@@ -115,18 +115,6 @@ impl ModuleId {\n     pub fn containing_block(&self) -> Option<BlockId> {\n         self.block\n     }\n-\n-    /// Returns `true` if this module represents a block expression.\n-    ///\n-    /// Returns `false` if this module is a submodule *inside* a block expression\n-    /// (eg. `m` in `{ mod m {} }`).\n-    pub fn is_block_root(&self, db: &dyn db::DefDatabase) -> bool {\n-        if self.block.is_none() {\n-            return false;\n-        }\n-\n-        self.def_map(db)[self.local_id].parent.is_none()\n-    }\n }\n \n /// An ID of a module, **local** to a specific crate"}, {"sha": "d6790e74e140c0b760c3b24bdcb0198cf43b80ca", "filename": "crates/hir_def/src/visibility.rs", "status": "modified", "additions": 16, "deletions": 2, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/835723ca67bf63785fbbf385f2e879a5312c569a/crates%2Fhir_def%2Fsrc%2Fvisibility.rs", "raw_url": "https://github.com/rust-lang/rust/raw/835723ca67bf63785fbbf385f2e879a5312c569a/crates%2Fhir_def%2Fsrc%2Fvisibility.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fvisibility.rs?ref=835723ca67bf63785fbbf385f2e879a5312c569a", "patch": "@@ -134,8 +134,22 @@ impl Visibility {\n         // visibility as the containing module (even though no items are directly nameable from\n         // there, getting this right is important for method resolution).\n         // In that case, we adjust the visibility of `to_module` to point to the containing module.\n-        if to_module.is_block_root(db) {\n-            to_module = to_module.containing_module(db).unwrap();\n+        // Additional complication: `to_module` might be in `from_module`'s `DefMap`, which we're\n+        // currently computing, so we must not call the `def_map` query for it.\n+        let arc;\n+        let to_module_def_map =\n+            if to_module.krate == def_map.krate() && to_module.block == def_map.block_id() {\n+                def_map\n+            } else {\n+                arc = to_module.def_map(db);\n+                &arc\n+            };\n+        let is_block_root = match to_module.block {\n+            Some(_) => to_module_def_map[to_module.local_id].parent.is_none(),\n+            None => false,\n+        };\n+        if is_block_root {\n+            to_module = to_module_def_map.containing_module(to_module.local_id).unwrap();\n         }\n \n         // from_module needs to be a descendant of to_module"}]}