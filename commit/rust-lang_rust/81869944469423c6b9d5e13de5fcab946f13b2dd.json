{"sha": "81869944469423c6b9d5e13de5fcab946f13b2dd", "node_id": "MDY6Q29tbWl0NzI0NzEyOjgxODY5OTQ0NDY5NDIzYzZiOWQ1ZTEzZGU1ZmNhYjk0NmYxM2IyZGQ=", "commit": {"author": {"name": "Oliver Scherer", "email": "github35764891676564198441@oli-obk.de", "date": "2019-05-29T12:41:01Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-05-29T12:41:01Z"}, "message": "Rollup merge of #60549 - euclio:doctest-panic-messages, r=GuillaumeGomez\n\ndo not print panic message on doctest failures\n\nThis PR cleans up rustdoc test output by silently unwinding on failure instead of using `panic!`. It also improves the clarity and consistency of the output on test failure, and adds test cases for failure modes that were previously untested.", "tree": {"sha": "f65c0ed59787e9dd04c6721084c19038ef821031", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f65c0ed59787e9dd04c6721084c19038ef821031"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/81869944469423c6b9d5e13de5fcab946f13b2dd", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJc7n3dCRBK7hj4Ov3rIwAAdHIIAJzcwJt9ko8Haelxs/51HQ71\nzvEzbbDZ2ENLXfz+39nm/tT6+rgb/oplAKW0oj82OQlJxUZzA+cJ6VjKGNeUUTcG\n80uKGQwYVRq0mQJ61LOREaR0bhCQHTCytuYQgjzHKSwnk1xtbVRI0/Dhty9pj8E/\nb+zCSvmeIKWcxQ07fLkvQ6SXTaScTC5yQOzs6kbnFMzTtaki5py0b2+eXyD+Vmih\n8JtsBoT0eWq+dzVoW3xn7vZwLPfO65KMSnLj+f73/xhYi9eGvNugzn4g0scFKgey\nZB1aHHGJp5Dyz9wl90BOcpsPnZuxq/7eXsSG06lfUZ4W8+wy0zw9kI0cFjKq0H8=\n=DJ3u\n-----END PGP SIGNATURE-----\n", "payload": "tree f65c0ed59787e9dd04c6721084c19038ef821031\nparent 81970852e172c04322cbf8ba23effabeb491c83c\nparent 89d437ec76cab8153ada936c5d67ef2deb901eb4\nauthor Oliver Scherer <github35764891676564198441@oli-obk.de> 1559133661 +0200\ncommitter GitHub <noreply@github.com> 1559133661 +0200\n\nRollup merge of #60549 - euclio:doctest-panic-messages, r=GuillaumeGomez\n\ndo not print panic message on doctest failures\n\nThis PR cleans up rustdoc test output by silently unwinding on failure instead of using `panic!`. It also improves the clarity and consistency of the output on test failure, and adds test cases for failure modes that were previously untested.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/81869944469423c6b9d5e13de5fcab946f13b2dd", "html_url": "https://github.com/rust-lang/rust/commit/81869944469423c6b9d5e13de5fcab946f13b2dd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/81869944469423c6b9d5e13de5fcab946f13b2dd/comments", "author": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "81970852e172c04322cbf8ba23effabeb491c83c", "url": "https://api.github.com/repos/rust-lang/rust/commits/81970852e172c04322cbf8ba23effabeb491c83c", "html_url": "https://github.com/rust-lang/rust/commit/81970852e172c04322cbf8ba23effabeb491c83c"}, {"sha": "89d437ec76cab8153ada936c5d67ef2deb901eb4", "url": "https://api.github.com/repos/rust-lang/rust/commits/89d437ec76cab8153ada936c5d67ef2deb901eb4", "html_url": "https://github.com/rust-lang/rust/commit/89d437ec76cab8153ada936c5d67ef2deb901eb4"}], "stats": {"total": 267, "additions": 224, "deletions": 43}, "files": [{"sha": "9d1a0cc074c8814a40f6a16dc4d5bd04419bd6ea", "filename": "src/librustdoc/test.rs", "status": "modified", "additions": 114, "deletions": 25, "changes": 139, "blob_url": "https://github.com/rust-lang/rust/blob/81869944469423c6b9d5e13de5fcab946f13b2dd/src%2Flibrustdoc%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/81869944469423c6b9d5e13de5fcab946f13b2dd/src%2Flibrustdoc%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Ftest.rs?ref=81869944469423c6b9d5e13de5fcab946f13b2dd", "patch": "@@ -17,7 +17,7 @@ use std::io::prelude::*;\n use std::io;\n use std::panic::{self, AssertUnwindSafe};\n use std::path::PathBuf;\n-use std::process::Command;\n+use std::process::{self, Command};\n use std::str;\n use std::sync::{Arc, Mutex};\n use syntax::symbol::sym;\n@@ -160,13 +160,45 @@ fn scrape_test_config(krate: &::rustc::hir::Crate) -> TestOptions {\n     opts\n }\n \n-fn run_test(test: &str, cratename: &str, filename: &FileName, line: usize,\n-            cfgs: Vec<String>, libs: Vec<SearchPath>,\n-            cg: CodegenOptions, externs: Externs,\n-            should_panic: bool, no_run: bool, as_test_harness: bool,\n-            compile_fail: bool, mut error_codes: Vec<String>, opts: &TestOptions,\n-            maybe_sysroot: Option<PathBuf>, linker: Option<PathBuf>, edition: Edition,\n-            persist_doctests: Option<PathBuf>) {\n+/// Documentation test failure modes.\n+enum TestFailure {\n+    /// The test failed to compile.\n+    CompileError,\n+    /// The test is marked `compile_fail` but compiled successfully.\n+    UnexpectedCompilePass,\n+    /// The test failed to compile (as expected) but the compiler output did not contain all\n+    /// expected error codes.\n+    MissingErrorCodes(Vec<String>),\n+    /// The test binary was unable to be executed.\n+    ExecutionError(io::Error),\n+    /// The test binary exited with a non-zero exit code.\n+    ///\n+    /// This typically means an assertion in the test failed or another form of panic occurred.\n+    ExecutionFailure(process::Output),\n+    /// The test is marked `should_panic` but the test binary executed successfully.\n+    UnexpectedRunPass,\n+}\n+\n+fn run_test(\n+    test: &str,\n+    cratename: &str,\n+    filename: &FileName,\n+    line: usize,\n+    cfgs: Vec<String>,\n+    libs: Vec<SearchPath>,\n+    cg: CodegenOptions,\n+    externs: Externs,\n+    should_panic: bool,\n+    no_run: bool,\n+    as_test_harness: bool,\n+    compile_fail: bool,\n+    mut error_codes: Vec<String>,\n+    opts: &TestOptions,\n+    maybe_sysroot: Option<PathBuf>,\n+    linker: Option<PathBuf>,\n+    edition: Edition,\n+    persist_doctests: Option<PathBuf>,\n+) -> Result<(), TestFailure> {\n     let (test, line_offset) = match panic::catch_unwind(|| {\n         make_test(test, Some(cratename), as_test_harness, opts, edition)\n     }) {\n@@ -307,44 +339,43 @@ fn run_test(test: &str, cratename: &str, filename: &FileName, line: usize,\n \n     match (compile_result, compile_fail) {\n         (Ok(()), true) => {\n-            panic!(\"test compiled while it wasn't supposed to\")\n+            return Err(TestFailure::UnexpectedCompilePass);\n         }\n         (Ok(()), false) => {}\n         (Err(_), true) => {\n-            if error_codes.len() > 0 {\n+            if !error_codes.is_empty() {\n                 let out = String::from_utf8(data.lock().unwrap().to_vec()).unwrap();\n                 error_codes.retain(|err| !out.contains(err));\n+\n+                if !error_codes.is_empty() {\n+                    return Err(TestFailure::MissingErrorCodes(error_codes));\n+                }\n             }\n         }\n         (Err(_), false) => {\n-            panic!(\"couldn't compile the test\")\n+            return Err(TestFailure::CompileError);\n         }\n     }\n \n-    if error_codes.len() > 0 {\n-        panic!(\"Some expected error codes were not found: {:?}\", error_codes);\n+    if no_run {\n+        return Ok(());\n     }\n \n-    if no_run { return }\n-\n     // Run the code!\n     let mut cmd = Command::new(output_file);\n \n     match cmd.output() {\n-        Err(e) => panic!(\"couldn't run the test: {}{}\", e,\n-                        if e.kind() == io::ErrorKind::PermissionDenied {\n-                            \" - maybe your tempdir is mounted with noexec?\"\n-                        } else { \"\" }),\n+        Err(e) => return Err(TestFailure::ExecutionError(e)),\n         Ok(out) => {\n             if should_panic && out.status.success() {\n-                panic!(\"test executable succeeded when it should have failed\");\n+                return Err(TestFailure::UnexpectedRunPass);\n             } else if !should_panic && !out.status.success() {\n-                panic!(\"test executable failed:\\n{}\\n{}\\n\",\n-                       str::from_utf8(&out.stdout).unwrap_or(\"\"),\n-                       str::from_utf8(&out.stderr).unwrap_or(\"\"));\n+                return Err(TestFailure::ExecutionFailure(out));\n             }\n         }\n     }\n+\n+    Ok(())\n }\n \n /// Transforms a test into code that can be compiled into a Rust binary, and returns the number of\n@@ -711,7 +742,7 @@ impl Tester for Collector {\n                 allow_fail: config.allow_fail,\n             },\n             testfn: testing::DynTestFn(box move || {\n-                run_test(\n+                let res = run_test(\n                     &test,\n                     &cratename,\n                     &filename,\n@@ -730,7 +761,65 @@ impl Tester for Collector {\n                     linker,\n                     edition,\n                     persist_doctests\n-                )\n+                );\n+\n+                if let Err(err) = res {\n+                    match err {\n+                        TestFailure::CompileError => {\n+                            eprint!(\"Couldn't compile the test.\");\n+                        }\n+                        TestFailure::UnexpectedCompilePass => {\n+                            eprint!(\"Test compiled successfully, but it's marked `compile_fail`.\");\n+                        }\n+                        TestFailure::UnexpectedRunPass => {\n+                            eprint!(\"Test executable succeeded, but it's marked `should_panic`.\");\n+                        }\n+                        TestFailure::MissingErrorCodes(codes) => {\n+                            eprint!(\"Some expected error codes were not found: {:?}\", codes);\n+                        }\n+                        TestFailure::ExecutionError(err) => {\n+                            eprint!(\"Couldn't run the test: {}\", err);\n+                            if err.kind() == io::ErrorKind::PermissionDenied {\n+                                eprint!(\" - maybe your tempdir is mounted with noexec?\");\n+                            }\n+                        }\n+                        TestFailure::ExecutionFailure(out) => {\n+                            let reason = if let Some(code) = out.status.code() {\n+                                format!(\"exit code {}\", code)\n+                            } else {\n+                                String::from(\"terminated by signal\")\n+                            };\n+\n+                            eprintln!(\"Test executable failed ({}).\", reason);\n+\n+                            // FIXME(#12309): An unfortunate side-effect of capturing the test\n+                            // executable's output is that the relative ordering between the test's\n+                            // stdout and stderr is lost. However, this is better than the\n+                            // alternative: if the test executable inherited the parent's I/O\n+                            // handles the output wouldn't be captured at all, even on success.\n+                            //\n+                            // The ordering could be preserved if the test process' stderr was\n+                            // redirected to stdout, but that functionality does not exist in the\n+                            // standard library, so it may not be portable enough.\n+                            let stdout = str::from_utf8(&out.stdout).unwrap_or_default();\n+                            let stderr = str::from_utf8(&out.stderr).unwrap_or_default();\n+\n+                            if !stdout.is_empty() || !stderr.is_empty() {\n+                                eprintln!();\n+\n+                                if !stdout.is_empty() {\n+                                    eprintln!(\"stdout:\\n{}\", stdout);\n+                                }\n+\n+                                if !stderr.is_empty() {\n+                                    eprintln!(\"stderr:\\n{}\", stderr);\n+                                }\n+                            }\n+                        }\n+                    }\n+\n+                    panic::resume_unwind(box ());\n+                }\n             }),\n         });\n     }"}, {"sha": "297d6efd45fee44aff913a50a5e85bd178688cfd", "filename": "src/test/rustdoc-ui/failed-doctest-compile-fail.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/81869944469423c6b9d5e13de5fcab946f13b2dd/src%2Ftest%2Frustdoc-ui%2Ffailed-doctest-compile-fail.rs", "raw_url": "https://github.com/rust-lang/rust/raw/81869944469423c6b9d5e13de5fcab946f13b2dd/src%2Ftest%2Frustdoc-ui%2Ffailed-doctest-compile-fail.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Ffailed-doctest-compile-fail.rs?ref=81869944469423c6b9d5e13de5fcab946f13b2dd", "patch": "@@ -0,0 +1,11 @@\n+// FIXME: if/when the output of the test harness can be tested on its own, this test should be\n+// adapted to use that, and that normalize line can go away\n+\n+// compile-flags:--test\n+// normalize-stdout-test: \"src/test/rustdoc-ui\" -> \"$$DIR\"\n+// failure-status: 101\n+\n+/// ```compile_fail\n+/// println!(\"Hello\");\n+/// ```\n+pub struct Foo;"}, {"sha": "74e33d7beebeb66ae72032915f25bd6387b52eaf", "filename": "src/test/rustdoc-ui/failed-doctest-compile-fail.stdout", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/81869944469423c6b9d5e13de5fcab946f13b2dd/src%2Ftest%2Frustdoc-ui%2Ffailed-doctest-compile-fail.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/81869944469423c6b9d5e13de5fcab946f13b2dd/src%2Ftest%2Frustdoc-ui%2Ffailed-doctest-compile-fail.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Ffailed-doctest-compile-fail.stdout?ref=81869944469423c6b9d5e13de5fcab946f13b2dd", "patch": "@@ -0,0 +1,14 @@\n+\n+running 1 test\n+test $DIR/failed-doctest-compile-fail.rs - Foo (line 8) ... FAILED\n+\n+failures:\n+\n+---- $DIR/failed-doctest-compile-fail.rs - Foo (line 8) stdout ----\n+Test compiled successfully, but it's marked `compile_fail`.\n+\n+failures:\n+    $DIR/failed-doctest-compile-fail.rs - Foo (line 8)\n+\n+test result: FAILED. 0 passed; 1 failed; 0 ignored; 0 measured; 0 filtered out\n+"}, {"sha": "62102062d4991381c1a8d23d43536a03089742e7", "filename": "src/test/rustdoc-ui/failed-doctest-missing-codes.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/81869944469423c6b9d5e13de5fcab946f13b2dd/src%2Ftest%2Frustdoc-ui%2Ffailed-doctest-missing-codes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/81869944469423c6b9d5e13de5fcab946f13b2dd/src%2Ftest%2Frustdoc-ui%2Ffailed-doctest-missing-codes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Ffailed-doctest-missing-codes.rs?ref=81869944469423c6b9d5e13de5fcab946f13b2dd", "patch": "@@ -0,0 +1,11 @@\n+// FIXME: if/when the output of the test harness can be tested on its own, this test should be\n+// adapted to use that, and that normalize line can go away\n+\n+// compile-flags:--test\n+// normalize-stdout-test: \"src/test/rustdoc-ui\" -> \"$$DIR\"\n+// failure-status: 101\n+\n+/// ```compile_fail,E0004\n+/// let x: () = 5i32;\n+/// ```\n+pub struct Foo;"}, {"sha": "d206b721765b2470d7b5b877046fda122fe1a8fc", "filename": "src/test/rustdoc-ui/failed-doctest-missing-codes.stdout", "status": "added", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/81869944469423c6b9d5e13de5fcab946f13b2dd/src%2Ftest%2Frustdoc-ui%2Ffailed-doctest-missing-codes.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/81869944469423c6b9d5e13de5fcab946f13b2dd/src%2Ftest%2Frustdoc-ui%2Ffailed-doctest-missing-codes.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Ffailed-doctest-missing-codes.stdout?ref=81869944469423c6b9d5e13de5fcab946f13b2dd", "patch": "@@ -0,0 +1,26 @@\n+\n+running 1 test\n+test $DIR/failed-doctest-missing-codes.rs - Foo (line 8) ... FAILED\n+\n+failures:\n+\n+---- $DIR/failed-doctest-missing-codes.rs - Foo (line 8) stdout ----\n+error[E0308]: mismatched types\n+ --> $DIR/failed-doctest-missing-codes.rs:9:13\n+  |\n+3 | let x: () = 5i32;\n+  |             ^^^^ expected (), found i32\n+  |\n+  = note: expected type `()`\n+             found type `i32`\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0308`.\n+Some expected error codes were not found: [\"E0004\"]\n+\n+failures:\n+    $DIR/failed-doctest-missing-codes.rs - Foo (line 8)\n+\n+test result: FAILED. 0 passed; 1 failed; 0 ignored; 0 measured; 0 filtered out\n+"}, {"sha": "d2cdeb8f8f50e8d110b884464e8b15611830bf0e", "filename": "src/test/rustdoc-ui/failed-doctest-output.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/81869944469423c6b9d5e13de5fcab946f13b2dd/src%2Ftest%2Frustdoc-ui%2Ffailed-doctest-output.rs", "raw_url": "https://github.com/rust-lang/rust/raw/81869944469423c6b9d5e13de5fcab946f13b2dd/src%2Ftest%2Frustdoc-ui%2Ffailed-doctest-output.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Ffailed-doctest-output.rs?ref=81869944469423c6b9d5e13de5fcab946f13b2dd", "patch": "@@ -5,10 +5,13 @@\n // compile-flags:--test\n // normalize-stdout-test: \"src/test/rustdoc-ui\" -> \"$$DIR\"\n // failure-status: 101\n-// rustc-env:RUST_BACKTRACE=0\n \n // doctest fails at runtime\n /// ```\n+/// println!(\"stdout 1\");\n+/// eprintln!(\"stderr 1\");\n+/// println!(\"stdout 2\");\n+/// eprintln!(\"stderr 2\");\n /// panic!(\"oh no\");\n /// ```\n pub struct SomeStruct;"}, {"sha": "0c42c652d786c724b1e23dd3afb398e41902d608", "filename": "src/test/rustdoc-ui/failed-doctest-output.stdout", "status": "modified", "additions": 18, "deletions": 14, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/81869944469423c6b9d5e13de5fcab946f13b2dd/src%2Ftest%2Frustdoc-ui%2Ffailed-doctest-output.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/81869944469423c6b9d5e13de5fcab946f13b2dd/src%2Ftest%2Frustdoc-ui%2Ffailed-doctest-output.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Ffailed-doctest-output.stdout?ref=81869944469423c6b9d5e13de5fcab946f13b2dd", "patch": "@@ -1,35 +1,39 @@\n \n running 2 tests\n-test $DIR/failed-doctest-output.rs - OtherStruct (line 17) ... FAILED\n-test $DIR/failed-doctest-output.rs - SomeStruct (line 11) ... FAILED\n+test $DIR/failed-doctest-output.rs - OtherStruct (line 20) ... FAILED\n+test $DIR/failed-doctest-output.rs - SomeStruct (line 10) ... FAILED\n \n failures:\n \n----- $DIR/failed-doctest-output.rs - OtherStruct (line 17) stdout ----\n+---- $DIR/failed-doctest-output.rs - OtherStruct (line 20) stdout ----\n error[E0425]: cannot find value `no` in this scope\n- --> $DIR/failed-doctest-output.rs:18:1\n+ --> $DIR/failed-doctest-output.rs:21:1\n   |\n 3 | no\n   | ^^ not found in this scope\n \n error: aborting due to previous error\n \n For more information about this error, try `rustc --explain E0425`.\n-thread '$DIR/failed-doctest-output.rs - OtherStruct (line 17)' panicked at 'couldn't compile the test', src/librustdoc/test.rs:320:13\n+Couldn't compile the test.\n+---- $DIR/failed-doctest-output.rs - SomeStruct (line 10) stdout ----\n+Test executable failed (exit code 101).\n+\n+stdout:\n+stdout 1\n+stdout 2\n+\n+stderr:\n+stderr 1\n+stderr 2\n+thread 'main' panicked at 'oh no', $DIR/failed-doctest-output.rs:7:1\n note: Run with `RUST_BACKTRACE=1` environment variable to display a backtrace.\n \n----- $DIR/failed-doctest-output.rs - SomeStruct (line 11) stdout ----\n-thread '$DIR/failed-doctest-output.rs - SomeStruct (line 11)' panicked at 'test executable failed:\n-\n-thread 'main' panicked at 'oh no', $DIR/failed-doctest-output.rs:3:1\n-note: Run with `RUST_BACKTRACE=1` environment variable to display a backtrace.\n-\n-', src/librustdoc/test.rs:342:17\n \n \n failures:\n-    $DIR/failed-doctest-output.rs - OtherStruct (line 17)\n-    $DIR/failed-doctest-output.rs - SomeStruct (line 11)\n+    $DIR/failed-doctest-output.rs - OtherStruct (line 20)\n+    $DIR/failed-doctest-output.rs - SomeStruct (line 10)\n \n test result: FAILED. 0 passed; 2 failed; 0 ignored; 0 measured; 0 filtered out\n "}, {"sha": "400fb97804aabcef1e0b1de46bc9983d89ab2828", "filename": "src/test/rustdoc-ui/failed-doctest-should-panic.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/81869944469423c6b9d5e13de5fcab946f13b2dd/src%2Ftest%2Frustdoc-ui%2Ffailed-doctest-should-panic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/81869944469423c6b9d5e13de5fcab946f13b2dd/src%2Ftest%2Frustdoc-ui%2Ffailed-doctest-should-panic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Ffailed-doctest-should-panic.rs?ref=81869944469423c6b9d5e13de5fcab946f13b2dd", "patch": "@@ -0,0 +1,11 @@\n+// FIXME: if/when the output of the test harness can be tested on its own, this test should be\n+// adapted to use that, and that normalize line can go away\n+\n+// compile-flags:--test\n+// normalize-stdout-test: \"src/test/rustdoc-ui\" -> \"$$DIR\"\n+// failure-status: 101\n+\n+/// ```should_panic\n+/// println!(\"Hello, world!\");\n+/// ```\n+pub struct Foo;"}, {"sha": "081b64b50af9b9aba65269cd2371c117bf865878", "filename": "src/test/rustdoc-ui/failed-doctest-should-panic.stdout", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/81869944469423c6b9d5e13de5fcab946f13b2dd/src%2Ftest%2Frustdoc-ui%2Ffailed-doctest-should-panic.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/81869944469423c6b9d5e13de5fcab946f13b2dd/src%2Ftest%2Frustdoc-ui%2Ffailed-doctest-should-panic.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Ffailed-doctest-should-panic.stdout?ref=81869944469423c6b9d5e13de5fcab946f13b2dd", "patch": "@@ -0,0 +1,14 @@\n+\n+running 1 test\n+test $DIR/failed-doctest-should-panic.rs - Foo (line 8) ... FAILED\n+\n+failures:\n+\n+---- $DIR/failed-doctest-should-panic.rs - Foo (line 8) stdout ----\n+Test executable succeeded, but it's marked `should_panic`.\n+\n+failures:\n+    $DIR/failed-doctest-should-panic.rs - Foo (line 8)\n+\n+test result: FAILED. 0 passed; 1 failed; 0 ignored; 0 measured; 0 filtered out\n+"}, {"sha": "0350c016436071649470192ac656dcd9fd830ea0", "filename": "src/test/rustdoc-ui/unparseable-doc-test.stdout", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/81869944469423c6b9d5e13de5fcab946f13b2dd/src%2Ftest%2Frustdoc-ui%2Funparseable-doc-test.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/81869944469423c6b9d5e13de5fcab946f13b2dd/src%2Ftest%2Frustdoc-ui%2Funparseable-doc-test.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Funparseable-doc-test.stdout?ref=81869944469423c6b9d5e13de5fcab946f13b2dd", "patch": "@@ -13,9 +13,7 @@ error: unterminated double quote string\n \n error: aborting due to previous error\n \n-thread '$DIR/unparseable-doc-test.rs - foo (line 6)' panicked at 'couldn't compile the test', src/librustdoc/test.rs:320:13\n-note: Run with `RUST_BACKTRACE=1` environment variable to display a backtrace.\n-\n+Couldn't compile the test.\n \n failures:\n     $DIR/unparseable-doc-test.rs - foo (line 6)"}]}