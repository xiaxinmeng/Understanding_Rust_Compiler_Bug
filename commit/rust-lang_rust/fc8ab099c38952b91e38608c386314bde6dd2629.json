{"sha": "fc8ab099c38952b91e38608c386314bde6dd2629", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZjOGFiMDk5YzM4OTUyYjkxZTM4NjA4YzM4NjMxNGJkZTZkZDI2Mjk=", "commit": {"author": {"name": "Eduardo Broto", "email": "ebroto@tutanota.com", "date": "2020-05-15T19:17:37Z"}, "committer": {"name": "Eduardo Broto", "email": "ebroto@tutanota.com", "date": "2020-05-15T19:17:37Z"}, "message": "identity_op: allow `1 << 0`", "tree": {"sha": "d7ea03f7a6f2e5d08c78d19df8fc655afa9d4e9a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d7ea03f7a6f2e5d08c78d19df8fc655afa9d4e9a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fc8ab099c38952b91e38608c386314bde6dd2629", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fc8ab099c38952b91e38608c386314bde6dd2629", "html_url": "https://github.com/rust-lang/rust/commit/fc8ab099c38952b91e38608c386314bde6dd2629", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fc8ab099c38952b91e38608c386314bde6dd2629/comments", "author": {"login": "ebroto", "id": 816908, "node_id": "MDQ6VXNlcjgxNjkwOA==", "avatar_url": "https://avatars.githubusercontent.com/u/816908?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ebroto", "html_url": "https://github.com/ebroto", "followers_url": "https://api.github.com/users/ebroto/followers", "following_url": "https://api.github.com/users/ebroto/following{/other_user}", "gists_url": "https://api.github.com/users/ebroto/gists{/gist_id}", "starred_url": "https://api.github.com/users/ebroto/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ebroto/subscriptions", "organizations_url": "https://api.github.com/users/ebroto/orgs", "repos_url": "https://api.github.com/users/ebroto/repos", "events_url": "https://api.github.com/users/ebroto/events{/privacy}", "received_events_url": "https://api.github.com/users/ebroto/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ebroto", "id": 816908, "node_id": "MDQ6VXNlcjgxNjkwOA==", "avatar_url": "https://avatars.githubusercontent.com/u/816908?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ebroto", "html_url": "https://github.com/ebroto", "followers_url": "https://api.github.com/users/ebroto/followers", "following_url": "https://api.github.com/users/ebroto/following{/other_user}", "gists_url": "https://api.github.com/users/ebroto/gists{/gist_id}", "starred_url": "https://api.github.com/users/ebroto/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ebroto/subscriptions", "organizations_url": "https://api.github.com/users/ebroto/orgs", "repos_url": "https://api.github.com/users/ebroto/repos", "events_url": "https://api.github.com/users/ebroto/events{/privacy}", "received_events_url": "https://api.github.com/users/ebroto/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e1842b0cace2a73b55e6d85dc145a102603c7e5a", "url": "https://api.github.com/repos/rust-lang/rust/commits/e1842b0cace2a73b55e6d85dc145a102603c7e5a", "html_url": "https://github.com/rust-lang/rust/commit/e1842b0cace2a73b55e6d85dc145a102603c7e5a"}], "stats": {"total": 47, "additions": 44, "deletions": 3}, "files": [{"sha": "78e07d25f67c573cf122a36039ac487312149dd8", "filename": "clippy_lints/src/identity_op.rs", "status": "modified", "additions": 20, "deletions": 2, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/fc8ab099c38952b91e38608c386314bde6dd2629/clippy_lints%2Fsrc%2Fidentity_op.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fc8ab099c38952b91e38608c386314bde6dd2629/clippy_lints%2Fsrc%2Fidentity_op.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fidentity_op.rs?ref=fc8ab099c38952b91e38608c386314bde6dd2629", "patch": "@@ -1,4 +1,5 @@\n-use rustc_hir::{BinOpKind, Expr, ExprKind};\n+use if_chain::if_chain;\n+use rustc_hir::{BinOp, BinOpKind, Expr, ExprKind};\n use rustc_lint::{LateContext, LateLintPass};\n use rustc_middle::ty;\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n@@ -32,7 +33,10 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for IdentityOp {\n         if e.span.from_expansion() {\n             return;\n         }\n-        if let ExprKind::Binary(ref cmp, ref left, ref right) = e.kind {\n+        if let ExprKind::Binary(cmp, ref left, ref right) = e.kind {\n+            if is_allowed(cx, cmp, left, right) {\n+                return;\n+            }\n             match cmp.node {\n                 BinOpKind::Add | BinOpKind::BitOr | BinOpKind::BitXor => {\n                     check(cx, left, 0, e.span, right.span);\n@@ -54,6 +58,20 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for IdentityOp {\n     }\n }\n \n+fn is_allowed(cx: &LateContext<'_, '_>, cmp: BinOp, left: &Expr<'_>, right: &Expr<'_>) -> bool {\n+    // `1 << 0` is a common pattern in bit manipulation code\n+    if_chain! {\n+        if let BinOpKind::Shl = cmp.node;\n+        if let Some(Constant::Int(0)) = constant_simple(cx, cx.tables, right);\n+        if let Some(Constant::Int(1)) = constant_simple(cx, cx.tables, left);\n+        then {\n+            return true;\n+        }\n+    }\n+\n+    false\n+}\n+\n #[allow(clippy::cast_possible_wrap)]\n fn check(cx: &LateContext<'_, '_>, e: &Expr<'_>, m: i8, span: Span, arg: Span) {\n     if let Some(Constant::Int(v)) = constant_simple(cx, cx.tables, e) {"}, {"sha": "ceaacaaf6bd706618ecac1133af2b63d9d261595", "filename": "tests/ui/identity_op.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/fc8ab099c38952b91e38608c386314bde6dd2629/tests%2Fui%2Fidentity_op.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fc8ab099c38952b91e38608c386314bde6dd2629/tests%2Fui%2Fidentity_op.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fidentity_op.rs?ref=fc8ab099c38952b91e38608c386314bde6dd2629", "patch": "@@ -33,4 +33,9 @@ fn main() {\n \n     let u: u8 = 0;\n     u & 255;\n+\n+    1 << 0; // no error, this case is allowed, see issue 3430\n+    42 << 0;\n+    1 >> 0;\n+    42 >> 0;\n }"}, {"sha": "d8d44a74f9ab0fb05c1b19f7566eb2be6ad3e7be", "filename": "tests/ui/identity_op.stderr", "status": "modified", "additions": 19, "deletions": 1, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/fc8ab099c38952b91e38608c386314bde6dd2629/tests%2Fui%2Fidentity_op.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/fc8ab099c38952b91e38608c386314bde6dd2629/tests%2Fui%2Fidentity_op.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fidentity_op.stderr?ref=fc8ab099c38952b91e38608c386314bde6dd2629", "patch": "@@ -48,5 +48,23 @@ error: the operation is ineffective. Consider reducing it to `u`\n LL |     u & 255;\n    |     ^^^^^^^\n \n-error: aborting due to 8 previous errors\n+error: the operation is ineffective. Consider reducing it to `42`\n+  --> $DIR/identity_op.rs:38:5\n+   |\n+LL |     42 << 0;\n+   |     ^^^^^^^\n+\n+error: the operation is ineffective. Consider reducing it to `1`\n+  --> $DIR/identity_op.rs:39:5\n+   |\n+LL |     1 >> 0;\n+   |     ^^^^^^\n+\n+error: the operation is ineffective. Consider reducing it to `42`\n+  --> $DIR/identity_op.rs:40:5\n+   |\n+LL |     42 >> 0;\n+   |     ^^^^^^^\n+\n+error: aborting due to 11 previous errors\n "}]}