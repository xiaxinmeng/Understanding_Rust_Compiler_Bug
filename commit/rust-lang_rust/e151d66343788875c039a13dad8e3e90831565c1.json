{"sha": "e151d66343788875c039a13dad8e3e90831565c1", "node_id": "C_kwDOAAsO6NoAKGUxNTFkNjYzNDM3ODg4NzVjMDM5YTEzZGFkOGUzZTkwODMxNTY1YzE", "commit": {"author": {"name": "David Wood", "email": "david.wood@huawei.com", "date": "2022-06-28T10:51:15Z"}, "committer": {"name": "David Wood", "email": "david.wood@huawei.com", "date": "2022-06-30T07:59:22Z"}, "message": "lint: port deprecated attr diagnostics\n\nSigned-off-by: David Wood <david.wood@huawei.com>", "tree": {"sha": "0043ac185706b441142eeda49a79367a3b179c86", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0043ac185706b441142eeda49a79367a3b179c86"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e151d66343788875c039a13dad8e3e90831565c1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e151d66343788875c039a13dad8e3e90831565c1", "html_url": "https://github.com/rust-lang/rust/commit/e151d66343788875c039a13dad8e3e90831565c1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e151d66343788875c039a13dad8e3e90831565c1/comments", "author": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "committer": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "18a48c1d6c7815eb56bac3798819a3d109e5c95c", "url": "https://api.github.com/repos/rust-lang/rust/commits/18a48c1d6c7815eb56bac3798819a3d109e5c95c", "html_url": "https://github.com/rust-lang/rust/commit/18a48c1d6c7815eb56bac3798819a3d109e5c95c"}], "stats": {"total": 55, "additions": 31, "deletions": 24}, "files": [{"sha": "74a6e7ecdb568c397fb0e1fc4abb6b38102dc10b", "filename": "compiler/rustc_error_messages/locales/en-US/lint.ftl", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/e151d66343788875c039a13dad8e3e90831565c1/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Flint.ftl", "raw_url": "https://github.com/rust-lang/rust/raw/e151d66343788875c039a13dad8e3e90831565c1/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Flint.ftl", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Flint.ftl?ref=e151d66343788875c039a13dad8e3e90831565c1", "patch": "@@ -334,3 +334,7 @@ lint-builtin-missing-debug-impl =\n \n lint-builtin-anonymous-params = anonymous parameters are deprecated and will be removed in the next edition\n     .suggestion = try naming the parameter or explicitly ignoring it\n+\n+lint-builtin-deprecated-attr-link = use of deprecated attribute `{$name}`: {$reason}. See {$link}\n+lint-builtin-deprecated-attr-used = use of deprecated attribute `{$name}`: no longer used.\n+lint-builtin-deprecated-attr-default-suggestion = remove this attribute"}, {"sha": "147c4e94326e4d8d31b00bcf01eb59054405c534", "filename": "compiler/rustc_lint/src/builtin.rs", "status": "modified", "additions": 27, "deletions": 24, "changes": 51, "blob_url": "https://github.com/rust-lang/rust/blob/e151d66343788875c039a13dad8e3e90831565c1/compiler%2Frustc_lint%2Fsrc%2Fbuiltin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e151d66343788875c039a13dad8e3e90831565c1/compiler%2Frustc_lint%2Fsrc%2Fbuiltin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_lint%2Fsrc%2Fbuiltin.rs?ref=e151d66343788875c039a13dad8e3e90831565c1", "patch": "@@ -969,24 +969,6 @@ impl DeprecatedAttr {\n     }\n }\n \n-fn lint_deprecated_attr(\n-    cx: &EarlyContext<'_>,\n-    attr: &ast::Attribute,\n-    msg: &str,\n-    suggestion: Option<&str>,\n-) {\n-    cx.struct_span_lint(DEPRECATED, attr.span, |lint| {\n-        lint.build(msg)\n-            .span_suggestion_short(\n-                attr.span,\n-                suggestion.unwrap_or(\"remove this attribute\"),\n-                \"\",\n-                Applicability::MachineApplicable,\n-            )\n-            .emit();\n-    })\n-}\n-\n impl EarlyLintPass for DeprecatedAttr {\n     fn check_attribute(&mut self, cx: &EarlyContext<'_>, attr: &ast::Attribute) {\n         for BuiltinAttribute { name, gate, .. } in &self.depr_attrs {\n@@ -998,17 +980,38 @@ impl EarlyLintPass for DeprecatedAttr {\n                     _,\n                 ) = gate\n                 {\n-                    let msg =\n-                        format!(\"use of deprecated attribute `{}`: {}. See {}\", name, reason, link);\n-                    lint_deprecated_attr(cx, attr, &msg, suggestion);\n+                    cx.struct_span_lint(DEPRECATED, attr.span, |lint| {\n+                        // FIXME(davidtwco) translatable deprecated attr\n+                        lint.build(fluent::lint::builtin_deprecated_attr_link)\n+                            .set_arg(\"name\", name)\n+                            .set_arg(\"reason\", reason)\n+                            .set_arg(\"link\", link)\n+                            .span_suggestion_short(\n+                                attr.span,\n+                                suggestion.map(|s| s.into()).unwrap_or(\n+                                    fluent::lint::builtin_deprecated_attr_default_suggestion,\n+                                ),\n+                                \"\",\n+                                Applicability::MachineApplicable,\n+                            )\n+                            .emit();\n+                    });\n                 }\n                 return;\n             }\n         }\n         if attr.has_name(sym::no_start) || attr.has_name(sym::crate_id) {\n-            let path_str = pprust::path_to_string(&attr.get_normal_item().path);\n-            let msg = format!(\"use of deprecated attribute `{}`: no longer used.\", path_str);\n-            lint_deprecated_attr(cx, attr, &msg, None);\n+            cx.struct_span_lint(DEPRECATED, attr.span, |lint| {\n+                lint.build(fluent::lint::builtin_deprecated_attr_used)\n+                    .set_arg(\"name\", pprust::path_to_string(&attr.get_normal_item().path))\n+                    .span_suggestion_short(\n+                        attr.span,\n+                        fluent::lint::builtin_deprecated_attr_default_suggestion,\n+                        \"\",\n+                        Applicability::MachineApplicable,\n+                    )\n+                    .emit();\n+            });\n         }\n     }\n }"}]}