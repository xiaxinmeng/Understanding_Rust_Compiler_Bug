{"sha": "d2c19e0bcc2c11e83187dcfc48f9fa110ecf2318", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQyYzE5ZTBiY2MyYzExZTgzMTg3ZGNmYzQ4ZjlmYTExMGVjZjIzMTg=", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2018-11-27T10:53:18Z"}, "committer": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2018-12-03T12:02:02Z"}, "message": "Retag needs to know whether this is a 2-phase-reborrow", "tree": {"sha": "f4709b5cf001638fb9101018abb02dccc22ed07f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f4709b5cf001638fb9101018abb02dccc22ed07f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d2c19e0bcc2c11e83187dcfc48f9fa110ecf2318", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d2c19e0bcc2c11e83187dcfc48f9fa110ecf2318", "html_url": "https://github.com/rust-lang/rust/commit/d2c19e0bcc2c11e83187dcfc48f9fa110ecf2318", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d2c19e0bcc2c11e83187dcfc48f9fa110ecf2318/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7139e1c3ab0f6b912955f27a0f7df13c582ce5ec", "url": "https://api.github.com/repos/rust-lang/rust/commits/7139e1c3ab0f6b912955f27a0f7df13c582ce5ec", "html_url": "https://github.com/rust-lang/rust/commit/7139e1c3ab0f6b912955f27a0f7df13c582ce5ec"}], "stats": {"total": 110, "additions": 52, "deletions": 58}, "files": [{"sha": "c29872266312a553232e8dd0289a85aff7f4ee63", "filename": "src/librustc/ich/impls_mir.rs", "status": "modified", "additions": 12, "deletions": 45, "changes": 57, "blob_url": "https://github.com/rust-lang/rust/blob/d2c19e0bcc2c11e83187dcfc48f9fa110ecf2318/src%2Flibrustc%2Fich%2Fimpls_mir.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d2c19e0bcc2c11e83187dcfc48f9fa110ecf2318/src%2Flibrustc%2Fich%2Fimpls_mir.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fich%2Fimpls_mir.rs?ref=d2c19e0bcc2c11e83187dcfc48f9fa110ecf2318", "patch": "@@ -193,51 +193,18 @@ for mir::TerminatorKind<'gcx> {\n \n impl_stable_hash_for!(struct mir::Statement<'tcx> { source_info, kind });\n \n-impl<'a, 'gcx> HashStable<StableHashingContext<'a>>\n-for mir::StatementKind<'gcx> {\n-    fn hash_stable<W: StableHasherResult>(&self,\n-                                          hcx: &mut StableHashingContext<'a>,\n-                                          hasher: &mut StableHasher<W>) {\n-        mem::discriminant(self).hash_stable(hcx, hasher);\n-\n-        match *self {\n-            mir::StatementKind::Assign(ref place, ref rvalue) => {\n-                place.hash_stable(hcx, hasher);\n-                rvalue.hash_stable(hcx, hasher);\n-            }\n-            mir::StatementKind::FakeRead(ref cause, ref place) => {\n-                cause.hash_stable(hcx, hasher);\n-                place.hash_stable(hcx, hasher);\n-            }\n-            mir::StatementKind::SetDiscriminant { ref place, variant_index } => {\n-                place.hash_stable(hcx, hasher);\n-                variant_index.hash_stable(hcx, hasher);\n-            }\n-            mir::StatementKind::StorageLive(ref place) |\n-            mir::StatementKind::StorageDead(ref place) => {\n-                place.hash_stable(hcx, hasher);\n-            }\n-            mir::StatementKind::EscapeToRaw(ref place) => {\n-                place.hash_stable(hcx, hasher);\n-            }\n-            mir::StatementKind::Retag { fn_entry, ref place } => {\n-                fn_entry.hash_stable(hcx, hasher);\n-                place.hash_stable(hcx, hasher);\n-            }\n-            mir::StatementKind::AscribeUserType(ref place, ref variance, ref c_ty) => {\n-                place.hash_stable(hcx, hasher);\n-                variance.hash_stable(hcx, hasher);\n-                c_ty.hash_stable(hcx, hasher);\n-            }\n-            mir::StatementKind::Nop => {}\n-            mir::StatementKind::InlineAsm { ref asm, ref outputs, ref inputs } => {\n-                asm.hash_stable(hcx, hasher);\n-                outputs.hash_stable(hcx, hasher);\n-                inputs.hash_stable(hcx, hasher);\n-            }\n-        }\n-    }\n-}\n+impl_stable_hash_for!(impl<'gcx> for enum mir::StatementKind<'gcx> [ mir::StatementKind ] {\n+    Assign(place, rvalue),\n+    FakeRead(cause, place),\n+    SetDiscriminant { place, variant_index },\n+    StorageLive(place),\n+    StorageDead(place),\n+    EscapeToRaw(place),\n+    Retag { fn_entry, two_phase, place },\n+    AscribeUserType(place, variance, c_ty),\n+    Nop,\n+    InlineAsm { asm, outputs, inputs },\n+});\n \n impl_stable_hash_for!(enum mir::FakeReadCause { ForMatchGuard, ForMatchedPlace, ForLet });\n "}, {"sha": "8c4a40c00c35ef0b312c2170869de0555cca124a", "filename": "src/librustc/mir/mod.rs", "status": "modified", "additions": 11, "deletions": 3, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/d2c19e0bcc2c11e83187dcfc48f9fa110ecf2318/src%2Flibrustc%2Fmir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d2c19e0bcc2c11e83187dcfc48f9fa110ecf2318/src%2Flibrustc%2Fmir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmir%2Fmod.rs?ref=d2c19e0bcc2c11e83187dcfc48f9fa110ecf2318", "patch": "@@ -1778,6 +1778,10 @@ pub enum StatementKind<'tcx> {\n         /// `fn_entry` indicates whether this is the initial retag that happens in the\n         /// function prolog.\n         fn_entry: bool,\n+        /// `two_phase` indicates whether this is just the reservation action of\n+        /// a two-phase borrow.\n+        two_phase: bool,\n+        /// The place to retag\n         place: Place<'tcx>,\n     },\n \n@@ -1841,8 +1845,12 @@ impl<'tcx> Debug for Statement<'tcx> {\n         match self.kind {\n             Assign(ref place, ref rv) => write!(fmt, \"{:?} = {:?}\", place, rv),\n             FakeRead(ref cause, ref place) => write!(fmt, \"FakeRead({:?}, {:?})\", cause, place),\n-            Retag { fn_entry, ref place } =>\n-                write!(fmt, \"Retag({}{:?})\", if fn_entry { \"[fn entry] \" } else { \"\" }, place),\n+            Retag { fn_entry, two_phase, ref place } =>\n+                write!(fmt, \"Retag({}{}{:?})\",\n+                    if fn_entry { \"[fn entry] \" } else { \"\" },\n+                    if two_phase { \"[2phase] \" } else { \"\" },\n+                    place,\n+                ),\n             EscapeToRaw(ref place) => write!(fmt, \"EscapeToRaw({:?})\", place),\n             StorageLive(ref place) => write!(fmt, \"StorageLive({:?})\", place),\n             StorageDead(ref place) => write!(fmt, \"StorageDead({:?})\", place),\n@@ -3019,7 +3027,7 @@ EnumTypeFoldableImpl! {\n         (StatementKind::StorageLive)(a),\n         (StatementKind::StorageDead)(a),\n         (StatementKind::InlineAsm) { asm, outputs, inputs },\n-        (StatementKind::Retag) { fn_entry, place },\n+        (StatementKind::Retag) { fn_entry, two_phase, place },\n         (StatementKind::EscapeToRaw)(place),\n         (StatementKind::AscribeUserType)(a, v, b),\n         (StatementKind::Nop),"}, {"sha": "d40d85a193789e9de6b135bc1a1606723affc689", "filename": "src/librustc/mir/visit.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/d2c19e0bcc2c11e83187dcfc48f9fa110ecf2318/src%2Flibrustc%2Fmir%2Fvisit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d2c19e0bcc2c11e83187dcfc48f9fa110ecf2318/src%2Flibrustc%2Fmir%2Fvisit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmir%2Fvisit.rs?ref=d2c19e0bcc2c11e83187dcfc48f9fa110ecf2318", "patch": "@@ -154,9 +154,10 @@ macro_rules! make_mir_visitor {\n \n             fn visit_retag(&mut self,\n                            fn_entry: & $($mutability)* bool,\n+                           two_phase: & $($mutability)* bool,\n                            place: & $($mutability)* Place<'tcx>,\n                            location: Location) {\n-                self.super_retag(fn_entry, place, location);\n+                self.super_retag(fn_entry, two_phase, place, location);\n             }\n \n             fn visit_place(&mut self,\n@@ -417,8 +418,9 @@ macro_rules! make_mir_visitor {\n                         }\n                     }\n                     StatementKind::Retag { ref $($mutability)* fn_entry,\n+                                           ref $($mutability)* two_phase,\n                                            ref $($mutability)* place } => {\n-                        self.visit_retag(fn_entry, place, location);\n+                        self.visit_retag(fn_entry, two_phase, place, location);\n                     }\n                     StatementKind::AscribeUserType(\n                         ref $($mutability)* place,\n@@ -724,6 +726,7 @@ macro_rules! make_mir_visitor {\n \n             fn super_retag(&mut self,\n                            _fn_entry: & $($mutability)* bool,\n+                           _two_phase: & $($mutability)* bool,\n                            place: & $($mutability)* Place<'tcx>,\n                            location: Location) {\n                 self.visit_place("}, {"sha": "f43cfb90fc4a1cf69bb6e24c1b2035419321db74", "filename": "src/librustc_mir/interpret/machine.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d2c19e0bcc2c11e83187dcfc48f9fa110ecf2318/src%2Flibrustc_mir%2Finterpret%2Fmachine.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d2c19e0bcc2c11e83187dcfc48f9fa110ecf2318/src%2Flibrustc_mir%2Finterpret%2Fmachine.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Finterpret%2Fmachine.rs?ref=d2c19e0bcc2c11e83187dcfc48f9fa110ecf2318", "patch": "@@ -204,6 +204,7 @@ pub trait Machine<'a, 'mir, 'tcx>: Sized {\n     fn retag(\n         _ecx: &mut EvalContext<'a, 'mir, 'tcx, Self>,\n         _fn_entry: bool,\n+        _two_phase: bool,\n         _place: PlaceTy<'tcx, Self::PointerTag>,\n     ) -> EvalResult<'tcx> {\n         Ok(())"}, {"sha": "84cc5127f38adb90a3985863f2bd66312597cece", "filename": "src/librustc_mir/interpret/step.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d2c19e0bcc2c11e83187dcfc48f9fa110ecf2318/src%2Flibrustc_mir%2Finterpret%2Fstep.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d2c19e0bcc2c11e83187dcfc48f9fa110ecf2318/src%2Flibrustc_mir%2Finterpret%2Fstep.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Finterpret%2Fstep.rs?ref=d2c19e0bcc2c11e83187dcfc48f9fa110ecf2318", "patch": "@@ -119,9 +119,9 @@ impl<'a, 'mir, 'tcx, M: Machine<'a, 'mir, 'tcx>> EvalContext<'a, 'mir, 'tcx, M>\n             FakeRead(..) => {}\n \n             // Stacked Borrows.\n-            Retag { fn_entry, ref place } => {\n+            Retag { fn_entry, two_phase, ref place } => {\n                 let dest = self.eval_place(place)?;\n-                M::retag(self, fn_entry, dest)?;\n+                M::retag(self, fn_entry, two_phase, dest)?;\n             }\n             EscapeToRaw(ref op) => {\n                 let op = self.eval_operand(op, None)?;"}, {"sha": "811b85446cb23b59eb02210a0980bb5f3bd98107", "filename": "src/librustc_mir/transform/add_retag.rs", "status": "modified", "additions": 13, "deletions": 4, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/d2c19e0bcc2c11e83187dcfc48f9fa110ecf2318/src%2Flibrustc_mir%2Ftransform%2Fadd_retag.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d2c19e0bcc2c11e83187dcfc48f9fa110ecf2318/src%2Flibrustc_mir%2Ftransform%2Fadd_retag.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fadd_retag.rs?ref=d2c19e0bcc2c11e83187dcfc48f9fa110ecf2318", "patch": "@@ -118,7 +118,7 @@ impl MirPass for AddRetag {\n             basic_blocks[START_BLOCK].statements.splice(0..0,\n                 places.into_iter().map(|place| Statement {\n                     source_info,\n-                    kind: StatementKind::Retag { fn_entry: true, place },\n+                    kind: StatementKind::Retag { fn_entry: true, two_phase: false, place },\n                 })\n             );\n         }\n@@ -154,7 +154,7 @@ impl MirPass for AddRetag {\n         for (source_info, dest_place, dest_block) in returns {\n             basic_blocks[dest_block].statements.insert(0, Statement {\n                 source_info,\n-                kind: StatementKind::Retag { fn_entry: false, place: dest_place },\n+                kind: StatementKind::Retag { fn_entry: false, two_phase: false, place: dest_place },\n             });\n         }\n \n@@ -191,12 +191,21 @@ impl MirPass for AddRetag {\n                     // Assignments of reference or ptr type are the ones where we may have\n                     // to update tags.  This includes `x = &[mut] ...` and hence\n                     // we also retag after taking a reference!\n-                    StatementKind::Assign(ref place, _) if needs_retag(place) => {\n+                    StatementKind::Assign(ref place, box ref rvalue) if needs_retag(place) => {\n+                        let two_phase = match rvalue {\n+                            Rvalue::Ref(_, borrow_kind, _) =>\n+                                borrow_kind.allows_two_phase_borrow(),\n+                            _ => false\n+                        };\n                         // Insert a retag after the assignment.\n                         let source_info = block_data.statements[i].source_info;\n                         block_data.statements.insert(i+1, Statement {\n                             source_info,\n-                            kind: StatementKind::Retag { fn_entry: false, place: place.clone() },\n+                            kind: StatementKind::Retag {\n+                                fn_entry: false,\n+                                two_phase,\n+                                place: place.clone(),\n+                            },\n                         });\n                     }\n                     // Do nothing for the rest"}, {"sha": "ab71cefd434bd22f25f942638477b8cda1285347", "filename": "src/librustc_mir/transform/inline.rs", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/d2c19e0bcc2c11e83187dcfc48f9fa110ecf2318/src%2Flibrustc_mir%2Ftransform%2Finline.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d2c19e0bcc2c11e83187dcfc48f9fa110ecf2318/src%2Flibrustc_mir%2Ftransform%2Finline.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Finline.rs?ref=d2c19e0bcc2c11e83187dcfc48f9fa110ecf2318", "patch": "@@ -707,8 +707,14 @@ impl<'a, 'tcx> MutVisitor<'tcx> for Integrator<'a, 'tcx> {\n         self.in_cleanup_block = false;\n     }\n \n-    fn visit_retag(&mut self, fn_entry: &mut bool, place: &mut Place<'tcx>, loc: Location) {\n-        self.super_retag(fn_entry, place, loc);\n+    fn visit_retag(\n+        &mut self,\n+        fn_entry: &mut bool,\n+        two_phase: &mut bool,\n+        place: &mut Place<'tcx>,\n+        loc: Location,\n+    ) {\n+        self.super_retag(fn_entry, two_phase, place, loc);\n \n         // We have to patch all inlined retags to be aware that they are no longer\n         // happening on function entry."}]}