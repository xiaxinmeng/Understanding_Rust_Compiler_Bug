{"sha": "bedcaad97eaeb5ae09c2782a76d92749ac5585c4", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJlZGNhYWQ5N2VhZWI1YWUwOWMyNzgyYTc2ZDkyNzQ5YWM1NTg1YzQ=", "commit": {"author": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2011-12-19T23:17:49Z"}, "committer": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2011-12-20T00:24:10Z"}, "message": "rt: Give upcall_del_stack the same convention as other upcalls", "tree": {"sha": "c384bfb5cfbac0f3d559d9185e7a788ded09d12a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c384bfb5cfbac0f3d559d9185e7a788ded09d12a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bedcaad97eaeb5ae09c2782a76d92749ac5585c4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bedcaad97eaeb5ae09c2782a76d92749ac5585c4", "html_url": "https://github.com/rust-lang/rust/commit/bedcaad97eaeb5ae09c2782a76d92749ac5585c4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bedcaad97eaeb5ae09c2782a76d92749ac5585c4/comments", "author": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "55a2fd18ec8f2e9aeee699296b7a500b49ff0c5e", "url": "https://api.github.com/repos/rust-lang/rust/commits/55a2fd18ec8f2e9aeee699296b7a500b49ff0c5e", "html_url": "https://github.com/rust-lang/rust/commit/55a2fd18ec8f2e9aeee699296b7a500b49ff0c5e"}], "stats": {"total": 41, "additions": 17, "deletions": 24}, "files": [{"sha": "5804a683028636bfe87199393e0eec8eca8fbec2", "filename": "src/rt/arch/i386/morestack.S", "status": "modified", "additions": 9, "deletions": 18, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/bedcaad97eaeb5ae09c2782a76d92749ac5585c4/src%2Frt%2Farch%2Fi386%2Fmorestack.S", "raw_url": "https://github.com/rust-lang/rust/raw/bedcaad97eaeb5ae09c2782a76d92749ac5585c4/src%2Frt%2Farch%2Fi386%2Fmorestack.S", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Farch%2Fi386%2Fmorestack.S?ref=bedcaad97eaeb5ae09c2782a76d92749ac5585c4", "patch": "@@ -68,6 +68,7 @@\n \n #if defined(__APPLE__)\n #define RUST_GET_TASK           L_rust_get_task$stub\n+#define UPCALL_DEL_STACK        L_upcall_del_stack$stub\n #define UPCALL_CALL_C           L_upcall_call_shim_on_c_stack$stub\n #define MORESTACK               ___morestack\n #else\n@@ -87,8 +88,8 @@\n #endif\n \n .globl UPCALL_NEW_STACK\n-.globl UPCALL_DEL_STACK\n #ifndef __APPLE__\n+.globl UPCALL_DEL_STACK\n .globl RUST_GET_TASK\n .globl UPCALL_CALL_C_STACK\n #endif\n@@ -213,24 +214,13 @@ MORESTACK:\n \t// Switch back to the rust stack\n \tmovl %ebp, %esp\n \n-\t// Remember that __morestack is called misaligned so %ebp\n-\t// is not aligned to a 16-byte boundary, these 4 bytes realign.\n-\tsubl $4, %esp\n+\t// Realign stack - remember that __morestack was called misaligned\n+\tsubl $12, %esp\n \n \t// Now that we're on the return path we want to avoid\n \t// stomping on %eax. FIXME: Need to save and restore %eax to\n \t// actually preserve it across the call to delete the stack\n-#ifdef __APPLE__\n-\tcall 1f\n-1:\tpopl %ecx\n-\tmovl L_upcall_del_stack$non_lazy_ptr-1b(%ecx),%ecx\n-\tpushl %ecx\n-#else\n-\tpushl $UPCALL_DEL_STACK\n-#endif\n-\n-\tpushl $0\n-\tcall UPCALL_CALL_C\n+\tcall UPCALL_DEL_STACK\n \n \taddl $12,%esp\n \n@@ -267,9 +257,6 @@ MORESTACK:\n L_upcall_new_stack$non_lazy_ptr:\n \t.indirect_symbol _upcall_new_stack\n \t.long 0\n-L_upcall_del_stack$non_lazy_ptr:\n-\t.indirect_symbol _upcall_del_stack\n-\t.long 0\n \n .section __IMPORT,__jump_table,symbol_stubs,pure_instructions+self_modifying_code,5\n \n@@ -278,6 +265,10 @@ L_rust_get_task$stub:\n \t.indirect_symbol _rust_get_task\n \t.ascii\t \"\\364\\364\\364\\364\\364\"\n \n+L_upcall_del_stack$stub:\n+\t.indirect_symbol _upcall_del_stack\n+\t.ascii\t \"\\364\\364\\364\\364\\364\"\n+\n L_upcall_call_shim_on_c_stack$stub:\n \t.indirect_symbol _upcall_call_shim_on_c_stack\n \t.ascii\t \"\\364\\364\\364\\364\\364\""}, {"sha": "f72e7107b5f5208140e2571e90514f4618b20e2d", "filename": "src/rt/arch/x86_64/morestack.S", "status": "modified", "additions": 2, "deletions": 4, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/bedcaad97eaeb5ae09c2782a76d92749ac5585c4/src%2Frt%2Farch%2Fx86_64%2Fmorestack.S", "raw_url": "https://github.com/rust-lang/rust/raw/bedcaad97eaeb5ae09c2782a76d92749ac5585c4/src%2Frt%2Farch%2Fx86_64%2Fmorestack.S", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Farch%2Fx86_64%2Fmorestack.S?ref=bedcaad97eaeb5ae09c2782a76d92749ac5585c4", "patch": "@@ -117,13 +117,11 @@ MORESTACK:\n \tpushq $0\n \n \t// FIXME: Should preserve %rax here\n-\tmovq UPCALL_DEL_STACK@GOTPCREL(%rip), %rsi\n-\tmovq $0, %rdi\n #ifdef __APPLE__\n-\tcall UPCALL_CALL_C\n+\tcall UPCALL_DEL_STACK\n #endif\n #ifdef __linux__\n-\tcall UPCALL_CALL_C@PLT\n+\tcall UPCALL_DEL_STACK@PLT\n #endif\n \n \taddq $8, %rsp"}, {"sha": "981ce0ffb7e2aebe70f11344970fd7b877bc69f8", "filename": "src/rt/rust_upcall.cpp", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/bedcaad97eaeb5ae09c2782a76d92749ac5585c4/src%2Frt%2Frust_upcall.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/bedcaad97eaeb5ae09c2782a76d92749ac5585c4/src%2Frt%2Frust_upcall.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_upcall.cpp?ref=bedcaad97eaeb5ae09c2782a76d92749ac5585c4", "patch": "@@ -614,13 +614,17 @@ upcall_new_stack(struct rust_new_stack2_args *args) {\n                                       args->args_sz);\n }\n \n-// FIXME: As above\n extern \"C\" CDECL void\n-upcall_del_stack() {\n+upcall_s_del_stack() {\n     rust_task *task = rust_scheduler::get_task();\n     task->del_stack();\n }\n \n+extern \"C\" CDECL void\n+upcall_del_stack() {\n+    UPCALL_SWITCH_STACK(NULL, upcall_s_del_stack);\n+}\n+\n // Landing pads need to call this to insert the\n // correct limit into TLS.\n // NB: This must run on the Rust stack because it"}]}