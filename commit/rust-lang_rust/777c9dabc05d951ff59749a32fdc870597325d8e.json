{"sha": "777c9dabc05d951ff59749a32fdc870597325d8e", "node_id": "MDY6Q29tbWl0NzI0NzEyOjc3N2M5ZGFiYzA1ZDk1MWZmNTk3NDlhMzJmZGM4NzA1OTczMjVkOGU=", "commit": {"author": {"name": "bjorn3", "email": "bjorn3@users.noreply.github.com", "date": "2020-11-04T18:06:13Z"}, "committer": {"name": "bjorn3", "email": "bjorn3@users.noreply.github.com", "date": "2020-11-06T18:33:54Z"}, "message": "Add rustup pull command", "tree": {"sha": "78512b37e9b56bdf54d08566a712eab4d2cd34ca", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/78512b37e9b56bdf54d08566a712eab4d2cd34ca"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/777c9dabc05d951ff59749a32fdc870597325d8e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/777c9dabc05d951ff59749a32fdc870597325d8e", "html_url": "https://github.com/rust-lang/rust/commit/777c9dabc05d951ff59749a32fdc870597325d8e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/777c9dabc05d951ff59749a32fdc870597325d8e/comments", "author": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "19931e2d87a08017b3aca869e8482c9b995f04a3", "url": "https://api.github.com/repos/rust-lang/rust/commits/19931e2d87a08017b3aca869e8482c9b995f04a3", "html_url": "https://github.com/rust-lang/rust/commit/19931e2d87a08017b3aca869e8482c9b995f04a3"}], "stats": {"total": 30, "additions": 23, "deletions": 7}, "files": [{"sha": "430f5c469b4b2618c6f4f83ed939055443a52640", "filename": "scripts/rustup.sh", "status": "modified", "additions": 23, "deletions": 7, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/777c9dabc05d951ff59749a32fdc870597325d8e/scripts%2Frustup.sh", "raw_url": "https://github.com/rust-lang/rust/raw/777c9dabc05d951ff59749a32fdc870597325d8e/scripts%2Frustup.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/scripts%2Frustup.sh?ref=777c9dabc05d951ff59749a32fdc870597325d8e", "patch": "@@ -27,14 +27,30 @@ case $1 in\n         git commit -m \"Rustup to $(rustc -V)\"\n         ;;\n     \"push\")\n-\tcg_clif=$(pwd)\n-\tpushd ../rust\n-\tbranch=update_cg_clif-$(date +%Y-%m-%d)\n-\tgit checkout -b \"$branch\"\n-\tgit subtree pull --prefix=compiler/rustc_codegen_cranelift/ https://github.com/bjorn3/rustc_codegen_cranelift.git master\n-\tgit push -u my \"$branch\"\n-\tpopd\n+        cg_clif=$(pwd)\n+        pushd ../rust\n+        git pull origin master\n+        branch=sync_cg_clif-$(date +%Y-%m-%d)\n+        git checkout -b \"$branch\"\n+        git subtree pull --prefix=compiler/rustc_codegen_cranelift/ https://github.com/bjorn3/rustc_codegen_cranelift.git master\n+        git push -u my \"$branch\"\n+\n+        # immediately merge the merge commit into cg_clif to prevent merge conflicts when syncing\n+        # from rust-lang/rust later\n+        git subtree push --prefix=compiler/rustc_codegen_cranelift/ \"$cg_clif\" sync_from_rust\n+        popd\n+        git merge sync_from_rust\n \t;;\n+    \"pull\")\n+        cg_clif=$(pwd)\n+        pushd ../rust\n+        git pull origin master\n+        rust_vers=\"$(git rev-parse HEAD)\"\n+        git subtree push --prefix=compiler/rustc_codegen_cranelift/ \"$cg_clif\" sync_from_rust\n+        popd\n+        git merge sync_from_rust -m \"Sync from rust $rust_vers\"\n+        git branch -d sync_from_rust\n+        ;;\n     *)\n         echo \"Unknown command '$1'\"\n         echo \"Usage: ./rustup.sh prepare|commit\""}]}