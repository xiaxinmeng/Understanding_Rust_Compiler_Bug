{"sha": "ca0499d73685f084d8fd77417411d6f5162cc593", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNhMDQ5OWQ3MzY4NWYwODRkOGZkNzc0MTc0MTFkNmY1MTYyY2M1OTM=", "commit": {"author": {"name": "Marco A L Barbosa", "email": "malbarbo@gmail.com", "date": "2018-01-02T20:02:42Z"}, "committer": {"name": "Marco A L Barbosa", "email": "malbarbo@gmail.com", "date": "2018-01-03T15:49:13Z"}, "message": "ci: use musl shared script in dist-x86_64-musl", "tree": {"sha": "aabdda2502836f6fbbb641f3bb97dacd27c91fc3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/aabdda2502836f6fbbb641f3bb97dacd27c91fc3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ca0499d73685f084d8fd77417411d6f5162cc593", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ca0499d73685f084d8fd77417411d6f5162cc593", "html_url": "https://github.com/rust-lang/rust/commit/ca0499d73685f084d8fd77417411d6f5162cc593", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ca0499d73685f084d8fd77417411d6f5162cc593/comments", "author": {"login": "malbarbo", "id": 1678126, "node_id": "MDQ6VXNlcjE2NzgxMjY=", "avatar_url": "https://avatars.githubusercontent.com/u/1678126?v=4", "gravatar_id": "", "url": "https://api.github.com/users/malbarbo", "html_url": "https://github.com/malbarbo", "followers_url": "https://api.github.com/users/malbarbo/followers", "following_url": "https://api.github.com/users/malbarbo/following{/other_user}", "gists_url": "https://api.github.com/users/malbarbo/gists{/gist_id}", "starred_url": "https://api.github.com/users/malbarbo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/malbarbo/subscriptions", "organizations_url": "https://api.github.com/users/malbarbo/orgs", "repos_url": "https://api.github.com/users/malbarbo/repos", "events_url": "https://api.github.com/users/malbarbo/events{/privacy}", "received_events_url": "https://api.github.com/users/malbarbo/received_events", "type": "User", "site_admin": false}, "committer": {"login": "malbarbo", "id": 1678126, "node_id": "MDQ6VXNlcjE2NzgxMjY=", "avatar_url": "https://avatars.githubusercontent.com/u/1678126?v=4", "gravatar_id": "", "url": "https://api.github.com/users/malbarbo", "html_url": "https://github.com/malbarbo", "followers_url": "https://api.github.com/users/malbarbo/followers", "following_url": "https://api.github.com/users/malbarbo/following{/other_user}", "gists_url": "https://api.github.com/users/malbarbo/gists{/gist_id}", "starred_url": "https://api.github.com/users/malbarbo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/malbarbo/subscriptions", "organizations_url": "https://api.github.com/users/malbarbo/orgs", "repos_url": "https://api.github.com/users/malbarbo/repos", "events_url": "https://api.github.com/users/malbarbo/events{/privacy}", "received_events_url": "https://api.github.com/users/malbarbo/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b24d12e622052da1fc262a682e02e19af215e0b8", "url": "https://api.github.com/repos/rust-lang/rust/commits/b24d12e622052da1fc262a682e02e19af215e0b8", "html_url": "https://github.com/rust-lang/rust/commit/b24d12e622052da1fc262a682e02e19af215e0b8"}], "stats": {"total": 25, "additions": 17, "deletions": 8}, "files": [{"sha": "77a55b33e41b25963c1af3ba11bc84b7d7dde672", "filename": "src/ci/docker/dist-x86_64-musl/Dockerfile", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/ca0499d73685f084d8fd77417411d6f5162cc593/src%2Fci%2Fdocker%2Fdist-x86_64-musl%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/ca0499d73685f084d8fd77417411d6f5162cc593/src%2Fci%2Fdocker%2Fdist-x86_64-musl%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-x86_64-musl%2FDockerfile?ref=ca0499d73685f084d8fd77417411d6f5162cc593", "patch": "@@ -17,8 +17,14 @@ RUN apt-get update && apt-get install -y --no-install-recommends \\\n   pkg-config\n \n WORKDIR /build/\n-COPY dist-x86_64-musl/build-musl.sh /build/\n-RUN sh /build/build-musl.sh && rm -rf /build\n+\n+COPY scripts/musl.sh /build/\n+# We need to mitigate rust-lang/rust#34978 when compiling musl itself as well\n+RUN CC=gcc \\\n+    CFLAGS=\"-fPIC -Wa,-mrelax-relocations=no\" \\\n+    CXX=g++ \\\n+    CXXFLAGS=\"-Wa,-mrelax-relocations=no\" \\\n+    bash musl.sh x86_64 && rm -rf /build\n \n COPY scripts/sccache.sh /scripts/\n RUN sh /scripts/sccache.sh"}, {"sha": "011fd88231df0cb1a078e7d581080f70084220f5", "filename": "src/ci/docker/scripts/musl.sh", "status": "renamed", "additions": 9, "deletions": 6, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/ca0499d73685f084d8fd77417411d6f5162cc593/src%2Fci%2Fdocker%2Fscripts%2Fmusl.sh", "raw_url": "https://github.com/rust-lang/rust/raw/ca0499d73685f084d8fd77417411d6f5162cc593/src%2Fci%2Fdocker%2Fscripts%2Fmusl.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fscripts%2Fmusl.sh?ref=ca0499d73685f084d8fd77417411d6f5162cc593", "patch": "@@ -11,14 +11,13 @@\n \n set -ex\n \n-# We need to mitigate rust-lang/rust#34978 when compiling musl itself as well\n-export CFLAGS=\"-fPIC -Wa,-mrelax-relocations=no\"\n-export CXXFLAGS=\"-Wa,-mrelax-relocations=no\"\n+TAG=$1\n+shift\n \n MUSL=musl-1.1.17\n curl https://www.musl-libc.org/releases/$MUSL.tar.gz | tar xzf -\n cd $MUSL\n-./configure --prefix=/musl-x86_64 --disable-shared\n+./configure --disable-shared --prefix=/musl-$TAG $@\n make -j10\n make install\n \n@@ -33,6 +32,10 @@ curl -L https://github.com/llvm-mirror/libunwind/archive/release_37.tar.gz | tar\n mkdir libunwind-build\n cd libunwind-build\n cmake ../libunwind-release_37 -DLLVM_PATH=/build/llvm-release_37 \\\n-          -DLIBUNWIND_ENABLE_SHARED=0\n+          -DLIBUNWIND_ENABLE_SHARED=0 \\\n+          -DCMAKE_C_COMPILER=$CC \\\n+          -DCMAKE_CXX_COMPILER=$CXX \\\n+          -DCMAKE_C_FLAGS=\"$CFLAGS\" \\\n+          -DCMAKE_CXX_FLAGS=\"$CXXFLAGS\"\n make -j10\n-cp lib/libunwind.a /musl-x86_64/lib\n+cp lib/libunwind.a /musl-$TAG/lib", "previous_filename": "src/ci/docker/dist-x86_64-musl/build-musl.sh"}]}