{"sha": "e500dcb8cb7b3c1d9d6045aeb38f8a51dcce89b5", "node_id": "C_kwDOAAsO6NoAKGU1MDBkY2I4Y2I3YjNjMWQ5ZDYwNDVhZWIzOGY4YTUxZGNjZTg5YjU", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-10-19T19:38:40Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-10-19T19:38:40Z"}, "message": "Rollup merge of #103223 - compiler-errors:deref-sugg-slow, r=wesleywiser\n\nUse already checked RHS ty for LHS deref suggestions\n\nThere's no reason to do the `check_lhs_assignable` and RHS `check_expr_with_hint` in that order, so invert them and use the typeck results to avoid exponential blowup on error.\n\nFixes #103219", "tree": {"sha": "780e4a46de2f6f34a29514a3a21bf3bc330fd4da", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/780e4a46de2f6f34a29514a3a21bf3bc330fd4da"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e500dcb8cb7b3c1d9d6045aeb38f8a51dcce89b5", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjUFJACRBK7hj4Ov3rIwAAE6wIAJIgUVe9AssFyBUiopELCrYu\ndVjNxQwiZUFKGSYFlUDlpOyyFXRVuSn9oAT4cBpHv06tiRXg6xCN5ckXeultDbK3\ncV8KGII1dKGh3JI3b1BDIwggZ6Ebozul9sxZEfcqokd4yFF/3NQP+3TU7owgf8xz\nO5SNig1nFSGuS6qAEDT+hNc2+9XKN8v6RFVrmgErp2usCtljS+bmGWAinUujYija\nll9D6JNLmezg9HzkH9H5tSHOxKQpwP8HNM6HNj90J671N12j4ITgzGFLC3xAgsHK\nGW4PlxtnDIviJH9oJlSq5FQ2P1exPWTLeC5x16BAzm+OicC63d4/Xx7f5MwTIqE=\n=mtjA\n-----END PGP SIGNATURE-----\n", "payload": "tree 780e4a46de2f6f34a29514a3a21bf3bc330fd4da\nparent 433f736b86e67cea31fb4e72b092ec9b0364936c\nparent d38dc68aa3f4a7e859b6a84242bcfd37c03d707b\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1666208320 +0200\ncommitter GitHub <noreply@github.com> 1666208320 +0200\n\nRollup merge of #103223 - compiler-errors:deref-sugg-slow, r=wesleywiser\n\nUse already checked RHS ty for LHS deref suggestions\n\nThere's no reason to do the `check_lhs_assignable` and RHS `check_expr_with_hint` in that order, so invert them and use the typeck results to avoid exponential blowup on error.\n\nFixes #103219\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e500dcb8cb7b3c1d9d6045aeb38f8a51dcce89b5", "html_url": "https://github.com/rust-lang/rust/commit/e500dcb8cb7b3c1d9d6045aeb38f8a51dcce89b5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e500dcb8cb7b3c1d9d6045aeb38f8a51dcce89b5/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "433f736b86e67cea31fb4e72b092ec9b0364936c", "url": "https://api.github.com/repos/rust-lang/rust/commits/433f736b86e67cea31fb4e72b092ec9b0364936c", "html_url": "https://github.com/rust-lang/rust/commit/433f736b86e67cea31fb4e72b092ec9b0364936c"}, {"sha": "d38dc68aa3f4a7e859b6a84242bcfd37c03d707b", "url": "https://api.github.com/repos/rust-lang/rust/commits/d38dc68aa3f4a7e859b6a84242bcfd37c03d707b", "html_url": "https://github.com/rust-lang/rust/commit/d38dc68aa3f4a7e859b6a84242bcfd37c03d707b"}], "stats": {"total": 224, "additions": 219, "deletions": 5}, "files": [{"sha": "ccdfd3a056b8349e6dadf245b868cb90518347d1", "filename": "compiler/rustc_hir_analysis/src/check/expr.rs", "status": "modified", "additions": 6, "deletions": 5, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/e500dcb8cb7b3c1d9d6045aeb38f8a51dcce89b5/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e500dcb8cb7b3c1d9d6045aeb38f8a51dcce89b5/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fexpr.rs?ref=e500dcb8cb7b3c1d9d6045aeb38f8a51dcce89b5", "patch": "@@ -1130,11 +1130,6 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n             }\n         };\n \n-        self.check_lhs_assignable(lhs, \"E0070\", span, |err| {\n-            let rhs_ty = self.check_expr(&rhs);\n-            suggest_deref_binop(err, rhs_ty);\n-        });\n-\n         // This is (basically) inlined `check_expr_coercable_to_type`, but we want\n         // to suggest an additional fixup here in `suggest_deref_binop`.\n         let rhs_ty = self.check_expr_with_hint(&rhs, lhs_ty);\n@@ -1145,6 +1140,12 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n             diag.emit();\n         }\n \n+        self.check_lhs_assignable(lhs, \"E0070\", span, |err| {\n+            if let Some(rhs_ty) = self.typeck_results.borrow().expr_ty_opt(rhs) {\n+                suggest_deref_binop(err, rhs_ty);\n+            }\n+        });\n+\n         self.require_type_is_sized(lhs_ty, lhs.span, traits::AssignmentLhsSized);\n \n         if lhs_ty.references_error() || rhs_ty.references_error() {"}, {"sha": "80dfd683524ce627c11c2c219055ad256a94da29", "filename": "src/test/ui/typeck/slow-lhs-suggestion.rs", "status": "added", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/e500dcb8cb7b3c1d9d6045aeb38f8a51dcce89b5/src%2Ftest%2Fui%2Ftypeck%2Fslow-lhs-suggestion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e500dcb8cb7b3c1d9d6045aeb38f8a51dcce89b5/src%2Ftest%2Fui%2Ftypeck%2Fslow-lhs-suggestion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Fslow-lhs-suggestion.rs?ref=e500dcb8cb7b3c1d9d6045aeb38f8a51dcce89b5", "patch": "@@ -0,0 +1,26 @@\n+fn main() {\n+    1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1;\n+    //~^ ERROR invalid left-hand side of assignment\n+    //~| ERROR invalid left-hand side of assignment\n+    //~| ERROR invalid left-hand side of assignment\n+    //~| ERROR invalid left-hand side of assignment\n+    //~| ERROR invalid left-hand side of assignment\n+    //~| ERROR invalid left-hand side of assignment\n+    //~| ERROR invalid left-hand side of assignment\n+    //~| ERROR invalid left-hand side of assignment\n+    //~| ERROR invalid left-hand side of assignment\n+    //~| ERROR invalid left-hand side of assignment\n+    //~| ERROR invalid left-hand side of assignment\n+    //~| ERROR invalid left-hand side of assignment\n+    //~| ERROR invalid left-hand side of assignment\n+    //~| ERROR invalid left-hand side of assignment\n+    //~| ERROR invalid left-hand side of assignment\n+    //~| ERROR invalid left-hand side of assignment\n+    //~| ERROR invalid left-hand side of assignment\n+    //~| ERROR invalid left-hand side of assignment\n+    //~| ERROR invalid left-hand side of assignment\n+    //~| ERROR invalid left-hand side of assignment\n+    //~| ERROR invalid left-hand side of assignment\n+    //~| ERROR invalid left-hand side of assignment\n+    //~| ERROR invalid left-hand side of assignment\n+}"}, {"sha": "c5bf795eeee6acf939f2836b8ea649281372e777", "filename": "src/test/ui/typeck/slow-lhs-suggestion.stderr", "status": "added", "additions": 187, "deletions": 0, "changes": 187, "blob_url": "https://github.com/rust-lang/rust/blob/e500dcb8cb7b3c1d9d6045aeb38f8a51dcce89b5/src%2Ftest%2Fui%2Ftypeck%2Fslow-lhs-suggestion.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e500dcb8cb7b3c1d9d6045aeb38f8a51dcce89b5/src%2Ftest%2Fui%2Ftypeck%2Fslow-lhs-suggestion.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Fslow-lhs-suggestion.stderr?ref=e500dcb8cb7b3c1d9d6045aeb38f8a51dcce89b5", "patch": "@@ -0,0 +1,187 @@\n+error[E0070]: invalid left-hand side of assignment\n+  --> $DIR/slow-lhs-suggestion.rs:2:95\n+   |\n+LL |     1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1;\n+   |                                                                                             - ^\n+   |                                                                                             |\n+   |                                                                                             cannot assign to this expression\n+\n+error[E0070]: invalid left-hand side of assignment\n+  --> $DIR/slow-lhs-suggestion.rs:2:91\n+   |\n+LL |     1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1;\n+   |                                                                                         - ^\n+   |                                                                                         |\n+   |                                                                                         cannot assign to this expression\n+\n+error[E0070]: invalid left-hand side of assignment\n+  --> $DIR/slow-lhs-suggestion.rs:2:87\n+   |\n+LL |     1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1;\n+   |                                                                                     - ^\n+   |                                                                                     |\n+   |                                                                                     cannot assign to this expression\n+\n+error[E0070]: invalid left-hand side of assignment\n+  --> $DIR/slow-lhs-suggestion.rs:2:83\n+   |\n+LL |     1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1;\n+   |                                                                                 - ^\n+   |                                                                                 |\n+   |                                                                                 cannot assign to this expression\n+\n+error[E0070]: invalid left-hand side of assignment\n+  --> $DIR/slow-lhs-suggestion.rs:2:79\n+   |\n+LL |     1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1;\n+   |                                                                             - ^\n+   |                                                                             |\n+   |                                                                             cannot assign to this expression\n+\n+error[E0070]: invalid left-hand side of assignment\n+  --> $DIR/slow-lhs-suggestion.rs:2:75\n+   |\n+LL |     1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1;\n+   |                                                                         - ^\n+   |                                                                         |\n+   |                                                                         cannot assign to this expression\n+\n+error[E0070]: invalid left-hand side of assignment\n+  --> $DIR/slow-lhs-suggestion.rs:2:71\n+   |\n+LL |     1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1;\n+   |                                                                     - ^\n+   |                                                                     |\n+   |                                                                     cannot assign to this expression\n+\n+error[E0070]: invalid left-hand side of assignment\n+  --> $DIR/slow-lhs-suggestion.rs:2:67\n+   |\n+LL |     1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1;\n+   |                                                                 - ^\n+   |                                                                 |\n+   |                                                                 cannot assign to this expression\n+\n+error[E0070]: invalid left-hand side of assignment\n+  --> $DIR/slow-lhs-suggestion.rs:2:63\n+   |\n+LL |     1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1;\n+   |                                                             - ^\n+   |                                                             |\n+   |                                                             cannot assign to this expression\n+\n+error[E0070]: invalid left-hand side of assignment\n+  --> $DIR/slow-lhs-suggestion.rs:2:59\n+   |\n+LL |     1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1;\n+   |                                                         - ^\n+   |                                                         |\n+   |                                                         cannot assign to this expression\n+\n+error[E0070]: invalid left-hand side of assignment\n+  --> $DIR/slow-lhs-suggestion.rs:2:55\n+   |\n+LL |     1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1;\n+   |                                                     - ^\n+   |                                                     |\n+   |                                                     cannot assign to this expression\n+\n+error[E0070]: invalid left-hand side of assignment\n+  --> $DIR/slow-lhs-suggestion.rs:2:51\n+   |\n+LL |     1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1;\n+   |                                                 - ^\n+   |                                                 |\n+   |                                                 cannot assign to this expression\n+\n+error[E0070]: invalid left-hand side of assignment\n+  --> $DIR/slow-lhs-suggestion.rs:2:47\n+   |\n+LL |     1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1;\n+   |                                             - ^\n+   |                                             |\n+   |                                             cannot assign to this expression\n+\n+error[E0070]: invalid left-hand side of assignment\n+  --> $DIR/slow-lhs-suggestion.rs:2:43\n+   |\n+LL |     1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1;\n+   |                                         - ^\n+   |                                         |\n+   |                                         cannot assign to this expression\n+\n+error[E0070]: invalid left-hand side of assignment\n+  --> $DIR/slow-lhs-suggestion.rs:2:39\n+   |\n+LL |     1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1;\n+   |                                     - ^\n+   |                                     |\n+   |                                     cannot assign to this expression\n+\n+error[E0070]: invalid left-hand side of assignment\n+  --> $DIR/slow-lhs-suggestion.rs:2:35\n+   |\n+LL |     1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1;\n+   |                                 - ^\n+   |                                 |\n+   |                                 cannot assign to this expression\n+\n+error[E0070]: invalid left-hand side of assignment\n+  --> $DIR/slow-lhs-suggestion.rs:2:31\n+   |\n+LL |     1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1;\n+   |                             - ^\n+   |                             |\n+   |                             cannot assign to this expression\n+\n+error[E0070]: invalid left-hand side of assignment\n+  --> $DIR/slow-lhs-suggestion.rs:2:27\n+   |\n+LL |     1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1;\n+   |                         - ^\n+   |                         |\n+   |                         cannot assign to this expression\n+\n+error[E0070]: invalid left-hand side of assignment\n+  --> $DIR/slow-lhs-suggestion.rs:2:23\n+   |\n+LL |     1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1;\n+   |                     - ^\n+   |                     |\n+   |                     cannot assign to this expression\n+\n+error[E0070]: invalid left-hand side of assignment\n+  --> $DIR/slow-lhs-suggestion.rs:2:19\n+   |\n+LL |     1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1;\n+   |                 - ^\n+   |                 |\n+   |                 cannot assign to this expression\n+\n+error[E0070]: invalid left-hand side of assignment\n+  --> $DIR/slow-lhs-suggestion.rs:2:15\n+   |\n+LL |     1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1;\n+   |             - ^\n+   |             |\n+   |             cannot assign to this expression\n+\n+error[E0070]: invalid left-hand side of assignment\n+  --> $DIR/slow-lhs-suggestion.rs:2:11\n+   |\n+LL |     1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1;\n+   |         - ^\n+   |         |\n+   |         cannot assign to this expression\n+\n+error[E0070]: invalid left-hand side of assignment\n+  --> $DIR/slow-lhs-suggestion.rs:2:7\n+   |\n+LL |     1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1 = 1;\n+   |     - ^\n+   |     |\n+   |     cannot assign to this expression\n+\n+error: aborting due to 23 previous errors\n+\n+For more information about this error, try `rustc --explain E0070`."}]}