{"sha": "5d24760245567ccf9f938a063c2f13ea527bef9c", "node_id": "C_kwDOAAsO6NoAKDVkMjQ3NjAyNDU1NjdjY2Y5ZjkzOGEwNjNjMmYxM2VhNTI3YmVmOWM", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-12-15T11:46:00Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-12-15T11:46:00Z"}, "message": "Rollup merge of #105623 - compiler-errors:generator-type-size-fix, r=Nilstrieb\n\nFix `-Z print-type-sizes` for generators with discriminant field ordered first\n\nFixes #105589\nFixes #105591", "tree": {"sha": "a04509a3c4751e13900d2dc056502db89f858f79", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a04509a3c4751e13900d2dc056502db89f858f79"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5d24760245567ccf9f938a063c2f13ea527bef9c", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjmwj4CRBK7hj4Ov3rIwAA/a4IADHdc4lxkR5zzV0MVu7UCOgh\niPHk8UI1rqXAPQOcF1PtM75sysAbOAFxgoulKPWiAFOLEZco3VsxOnXeu4L55hUr\nFcgFvvmyYGqSA1ynj1gBNTXbRbvTDDqIAMQEBq9ujvnNR5lc2mVVQS2HS8hgPamg\nAB3YShkDu62D8Ybp8DSqbOIa7+NAjdolHxme6RROmTlUvcnLulVJjIP3MZkrkvyg\nnuV3PkFQxrev4NRq0j9VXid5011vqCQynzHTNKwd97uTsT+IdOLKcU3CLXASsK4R\nF2Jhcyvz9+XcJ5FaVP6jv6dEaNpqX/sXUc0IBEd2a/BNPfSCmWnaSZLTIaM00UQ=\n=u670\n-----END PGP SIGNATURE-----\n", "payload": "tree a04509a3c4751e13900d2dc056502db89f858f79\nparent c00eac355845637b604d3b0225e5416430776e21\nparent bdc3c4bf553ca10a1cbaeee8af061eef79417379\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1671104760 +0100\ncommitter GitHub <noreply@github.com> 1671104760 +0100\n\nRollup merge of #105623 - compiler-errors:generator-type-size-fix, r=Nilstrieb\n\nFix `-Z print-type-sizes` for generators with discriminant field ordered first\n\nFixes #105589\nFixes #105591\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5d24760245567ccf9f938a063c2f13ea527bef9c", "html_url": "https://github.com/rust-lang/rust/commit/5d24760245567ccf9f938a063c2f13ea527bef9c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5d24760245567ccf9f938a063c2f13ea527bef9c/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c00eac355845637b604d3b0225e5416430776e21", "url": "https://api.github.com/repos/rust-lang/rust/commits/c00eac355845637b604d3b0225e5416430776e21", "html_url": "https://github.com/rust-lang/rust/commit/c00eac355845637b604d3b0225e5416430776e21"}, {"sha": "bdc3c4bf553ca10a1cbaeee8af061eef79417379", "url": "https://api.github.com/repos/rust-lang/rust/commits/bdc3c4bf553ca10a1cbaeee8af061eef79417379", "html_url": "https://github.com/rust-lang/rust/commit/bdc3c4bf553ca10a1cbaeee8af061eef79417379"}], "stats": {"total": 218, "additions": 89, "deletions": 129}, "files": [{"sha": "c761a4dbe4500bfbc78b9576bbfabb873a4de662", "filename": "compiler/rustc_ty_utils/src/layout.rs", "status": "modified", "additions": 23, "deletions": 7, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/5d24760245567ccf9f938a063c2f13ea527bef9c/compiler%2Frustc_ty_utils%2Fsrc%2Flayout.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5d24760245567ccf9f938a063c2f13ea527bef9c/compiler%2Frustc_ty_utils%2Fsrc%2Flayout.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ty_utils%2Fsrc%2Flayout.rs?ref=5d24760245567ccf9f938a063c2f13ea527bef9c", "patch": "@@ -919,7 +919,7 @@ fn variant_info_for_generator<'tcx>(\n     def_id: DefId,\n     substs: ty::SubstsRef<'tcx>,\n ) -> (Vec<VariantInfo>, Option<Size>) {\n-    let Variants::Multiple { tag, ref tag_encoding, .. } = layout.variants else {\n+    let Variants::Multiple { tag, ref tag_encoding, tag_field, .. } = layout.variants else {\n         return (vec![], None);\n     };\n \n@@ -975,12 +975,28 @@ fn variant_info_for_generator<'tcx>(\n             if variant_size == Size::ZERO {\n                 variant_size = upvars_size;\n             }\n-            // We need to add the discriminant size back into min_size, since it is subtracted\n-            // later during printing.\n-            variant_size += match tag_encoding {\n-                TagEncoding::Direct => tag.size(cx),\n-                _ => Size::ZERO,\n-            };\n+\n+            // This `if` deserves some explanation.\n+            //\n+            // The layout code has a choice of where to place the discriminant of this generator.\n+            // If the discriminant of the generator is placed early in the layout (before the\n+            // variant's own fields), then it'll implicitly be counted towards the size of the\n+            // variant, since we use the maximum offset to calculate size.\n+            //    (side-note: I know this is a bit problematic given upvars placement, etc).\n+            //\n+            // This is important, since the layout printing code always subtracts this discriminant\n+            // size from the variant size if the struct is \"enum\"-like, so failing to account for it\n+            // will either lead to numerical underflow, or an underreported variant size...\n+            //\n+            // However, if the discriminant is placed past the end of the variant, then we need\n+            // to factor in the size of the discriminant manually. This really should be refactored\n+            // better, but this \"works\" for now.\n+            if layout.fields.offset(tag_field) >= variant_size {\n+                variant_size += match tag_encoding {\n+                    TagEncoding::Direct => tag.size(cx),\n+                    _ => Size::ZERO,\n+                };\n+            }\n \n             VariantInfo {\n                 name: Some(Symbol::intern(&ty::GeneratorSubsts::variant_name(variant_idx))),"}, {"sha": "1598b0696913b6e18dc59a2ed556a3505b3f9367", "filename": "src/test/ui/print_type_sizes/async.rs", "status": "modified", "additions": 2, "deletions": 10, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/5d24760245567ccf9f938a063c2f13ea527bef9c/src%2Ftest%2Fui%2Fprint_type_sizes%2Fasync.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5d24760245567ccf9f938a063c2f13ea527bef9c/src%2Ftest%2Fui%2Fprint_type_sizes%2Fasync.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fprint_type_sizes%2Fasync.rs?ref=5d24760245567ccf9f938a063c2f13ea527bef9c", "patch": "@@ -1,19 +1,11 @@\n-// compile-flags: -Z print-type-sizes\n+// compile-flags: -Z print-type-sizes --crate-type lib\n // edition:2021\n // build-pass\n // ignore-pass\n \n-#![feature(start)]\n-\n async fn wait() {}\n \n-async fn test(arg: [u8; 8192]) {\n+pub async fn test(arg: [u8; 8192]) {\n     wait().await;\n     drop(arg);\n }\n-\n-#[start]\n-fn start(_: isize, _: *const *const u8) -> isize {\n-    let _ = test([0; 8192]);\n-    0\n-}"}, {"sha": "6e47bb4930dc5306e8666c1e8fb7d407706398bc", "filename": "src/test/ui/print_type_sizes/async.stdout", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/5d24760245567ccf9f938a063c2f13ea527bef9c/src%2Ftest%2Fui%2Fprint_type_sizes%2Fasync.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/5d24760245567ccf9f938a063c2f13ea527bef9c/src%2Ftest%2Fui%2Fprint_type_sizes%2Fasync.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fprint_type_sizes%2Fasync.stdout?ref=5d24760245567ccf9f938a063c2f13ea527bef9c", "patch": "@@ -1,4 +1,4 @@\n-print-type-size type: `[async fn body@$DIR/async.rs:10:32: 13:2]`: 16386 bytes, alignment: 1 bytes\n+print-type-size type: `[async fn body@$DIR/async.rs:8:36: 11:2]`: 16386 bytes, alignment: 1 bytes\n print-type-size     discriminant: 1 bytes\n print-type-size     variant `Suspend0`: 16385 bytes\n print-type-size         field `.arg`: 8192 bytes, offset: 0 bytes, alignment: 1 bytes\n@@ -16,14 +16,14 @@ print-type-size type: `std::mem::MaybeUninit<[u8; 8192]>`: 8192 bytes, alignment\n print-type-size     variant `MaybeUninit`: 8192 bytes\n print-type-size         field `.uninit`: 0 bytes\n print-type-size         field `.value`: 8192 bytes\n-print-type-size type: `[async fn body@$DIR/async.rs:8:17: 8:19]`: 1 bytes, alignment: 1 bytes\n+print-type-size type: `[async fn body@$DIR/async.rs:6:17: 6:19]`: 1 bytes, alignment: 1 bytes\n print-type-size     discriminant: 1 bytes\n print-type-size     variant `Unresumed`: 0 bytes\n print-type-size     variant `Returned`: 0 bytes\n print-type-size     variant `Panicked`: 0 bytes\n-print-type-size type: `std::mem::ManuallyDrop<[async fn body@$DIR/async.rs:8:17: 8:19]>`: 1 bytes, alignment: 1 bytes\n+print-type-size type: `std::mem::ManuallyDrop<[async fn body@$DIR/async.rs:6:17: 6:19]>`: 1 bytes, alignment: 1 bytes\n print-type-size     field `.value`: 1 bytes\n-print-type-size type: `std::mem::MaybeUninit<[async fn body@$DIR/async.rs:8:17: 8:19]>`: 1 bytes, alignment: 1 bytes\n+print-type-size type: `std::mem::MaybeUninit<[async fn body@$DIR/async.rs:6:17: 6:19]>`: 1 bytes, alignment: 1 bytes\n print-type-size     variant `MaybeUninit`: 1 bytes\n print-type-size         field `.uninit`: 0 bytes\n print-type-size         field `.value`: 1 bytes"}, {"sha": "d1cd36274ef3e88970904b45708405415f0fa959", "filename": "src/test/ui/print_type_sizes/generator.rs", "status": "modified", "additions": 3, "deletions": 5, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/5d24760245567ccf9f938a063c2f13ea527bef9c/src%2Ftest%2Fui%2Fprint_type_sizes%2Fgenerator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5d24760245567ccf9f938a063c2f13ea527bef9c/src%2Ftest%2Fui%2Fprint_type_sizes%2Fgenerator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fprint_type_sizes%2Fgenerator.rs?ref=5d24760245567ccf9f938a063c2f13ea527bef9c", "patch": "@@ -1,8 +1,8 @@\n-// compile-flags: -Z print-type-sizes\n+// compile-flags: -Z print-type-sizes --crate-type=lib\n // build-pass\n // ignore-pass\n \n-#![feature(start, generators, generator_trait)]\n+#![feature(generators, generator_trait)]\n \n use std::ops::Generator;\n \n@@ -13,8 +13,6 @@ fn generator<const C: usize>(array: [u8; C]) -> impl Generator<Yield = (), Retur\n     }\n }\n \n-#[start]\n-fn start(_: isize, _: *const *const u8) -> isize {\n+pub fn foo() {\n     let _ = generator([0; 8192]);\n-    0\n }"}, {"sha": "1a85fe95bb6f771679ae01786c1bd89c56a2ab6f", "filename": "src/test/ui/print_type_sizes/generator_discr_placement.rs", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/5d24760245567ccf9f938a063c2f13ea527bef9c/src%2Ftest%2Fui%2Fprint_type_sizes%2Fgenerator_discr_placement.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5d24760245567ccf9f938a063c2f13ea527bef9c/src%2Ftest%2Fui%2Fprint_type_sizes%2Fgenerator_discr_placement.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fprint_type_sizes%2Fgenerator_discr_placement.rs?ref=5d24760245567ccf9f938a063c2f13ea527bef9c", "patch": "@@ -0,0 +1,23 @@\n+// compile-flags: -Z print-type-sizes --crate-type lib\n+// build-pass\n+// ignore-pass\n+\n+// Tests a generator that has its discriminant as the *final* field.\n+\n+// Avoid emitting panic handlers, like the rest of these tests...\n+#![feature(generators)]\n+\n+pub fn foo() {\n+    let a = || {\n+        {\n+            let w: i32 = 4;\n+            yield;\n+            drop(w);\n+        }\n+        {\n+            let z: i32 = 7;\n+            yield;\n+            drop(z);\n+        }\n+    };\n+}"}, {"sha": "7f8f4ccae7c14c6fbe752324f214fc2eced33820", "filename": "src/test/ui/print_type_sizes/generator_discr_placement.stdout", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/5d24760245567ccf9f938a063c2f13ea527bef9c/src%2Ftest%2Fui%2Fprint_type_sizes%2Fgenerator_discr_placement.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/5d24760245567ccf9f938a063c2f13ea527bef9c/src%2Ftest%2Fui%2Fprint_type_sizes%2Fgenerator_discr_placement.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fprint_type_sizes%2Fgenerator_discr_placement.stdout?ref=5d24760245567ccf9f938a063c2f13ea527bef9c", "patch": "@@ -0,0 +1,11 @@\n+print-type-size type: `[generator@$DIR/generator_discr_placement.rs:11:13: 11:15]`: 8 bytes, alignment: 4 bytes\n+print-type-size     discriminant: 1 bytes\n+print-type-size     variant `Suspend0`: 7 bytes\n+print-type-size         padding: 3 bytes\n+print-type-size         field `.w`: 4 bytes, alignment: 4 bytes\n+print-type-size     variant `Suspend1`: 7 bytes\n+print-type-size         padding: 3 bytes\n+print-type-size         field `.z`: 4 bytes, alignment: 4 bytes\n+print-type-size     variant `Unresumed`: 0 bytes\n+print-type-size     variant `Returned`: 0 bytes\n+print-type-size     variant `Panicked`: 0 bytes"}, {"sha": "05097087d5a811e1c07a8e36bb50b755aa0941e6", "filename": "src/test/ui/print_type_sizes/generics.rs", "status": "modified", "additions": 2, "deletions": 22, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/5d24760245567ccf9f938a063c2f13ea527bef9c/src%2Ftest%2Fui%2Fprint_type_sizes%2Fgenerics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5d24760245567ccf9f938a063c2f13ea527bef9c/src%2Ftest%2Fui%2Fprint_type_sizes%2Fgenerics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fprint_type_sizes%2Fgenerics.rs?ref=5d24760245567ccf9f938a063c2f13ea527bef9c", "patch": "@@ -1,4 +1,4 @@\n-// compile-flags: -Z print-type-sizes\n+// compile-flags: -Z print-type-sizes --crate-type=lib\n // build-pass\n // ignore-pass\n // ^-- needed because `--pass check` does not emit the output needed.\n@@ -8,24 +8,6 @@\n // monomorphized, in the MIR of the original function in which they\n // occur, to have their size reported.\n \n-#![feature(start)]\n-\n-// In an ad-hoc attempt to avoid the injection of unwinding code\n-// (which clutters the output of `-Z print-type-sizes` with types from\n-// `unwind::libunwind`):\n-//\n-//   * I am not using Default to build values because that seems to\n-//     cause the injection of unwinding code. (Instead I just make `fn new`\n-//     methods.)\n-//\n-//   * Pair derive Copy to ensure that we don't inject\n-//     unwinding code into generic uses of Pair when T itself is also\n-//     Copy.\n-//\n-//     (I suspect this reflect some naivety within the rust compiler\n-//      itself; it should be checking for drop glue, i.e., a destructor\n-//      somewhere in the monomorphized types. It should not matter whether\n-//      the type is Copy.)\n #[derive(Copy, Clone)]\n pub struct Pair<T> {\n     _car: T,\n@@ -61,11 +43,9 @@ pub fn f1<T:Copy>(x: T) {\n         Pair::new(FiftyBytes::new(), FiftyBytes::new());\n }\n \n-#[start]\n-fn start(_: isize, _: *const *const u8) -> isize {\n+pub fn start() {\n     let _b: Pair<u8> = Pair::new(0, 0);\n     let _s: Pair<SevenBytes> = Pair::new(SevenBytes::new(), SevenBytes::new());\n     let ref _z: ZeroSized = ZeroSized;\n     f1::<SevenBytes>(SevenBytes::new());\n-    0\n }"}, {"sha": "9159038924719f288091a30166a4a362b2a7fc07", "filename": "src/test/ui/print_type_sizes/multiple_types.rs", "status": "modified", "additions": 1, "deletions": 11, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/5d24760245567ccf9f938a063c2f13ea527bef9c/src%2Ftest%2Fui%2Fprint_type_sizes%2Fmultiple_types.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5d24760245567ccf9f938a063c2f13ea527bef9c/src%2Ftest%2Fui%2Fprint_type_sizes%2Fmultiple_types.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fprint_type_sizes%2Fmultiple_types.rs?ref=5d24760245567ccf9f938a063c2f13ea527bef9c", "patch": "@@ -1,23 +1,13 @@\n-// compile-flags: -Z print-type-sizes\n+// compile-flags: -Z print-type-sizes --crate-type=lib\n // build-pass\n \n // This file illustrates that when multiple structural types occur in\n // a function, every one of them is included in the output.\n \n-#![feature(start)]\n-\n pub struct SevenBytes([u8;  7]);\n pub struct FiftyBytes([u8; 50]);\n \n pub enum Enum {\n     Small(SevenBytes),\n     Large(FiftyBytes),\n }\n-\n-#[start]\n-fn start(_: isize, _: *const *const u8) -> isize {\n-    let _e: Enum;\n-    let _f: FiftyBytes;\n-    let _s: SevenBytes;\n-    0\n-}"}, {"sha": "5e620f248b65d35b1dd4243686249b7cb44aac46", "filename": "src/test/ui/print_type_sizes/niche-filling.rs", "status": "modified", "additions": 3, "deletions": 7, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/5d24760245567ccf9f938a063c2f13ea527bef9c/src%2Ftest%2Fui%2Fprint_type_sizes%2Fniche-filling.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5d24760245567ccf9f938a063c2f13ea527bef9c/src%2Ftest%2Fui%2Fprint_type_sizes%2Fniche-filling.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fprint_type_sizes%2Fniche-filling.rs?ref=5d24760245567ccf9f938a063c2f13ea527bef9c", "patch": "@@ -1,4 +1,4 @@\n-// compile-flags: -Z print-type-sizes\n+// compile-flags: -Z print-type-sizes --crate-type=lib\n // build-pass\n // ignore-pass\n // ^-- needed because `--pass check` does not emit the output needed.\n@@ -14,7 +14,6 @@\n // aligned (while on most it is 8-byte aligned) and so the resulting\n // padding and overall computed sizes can be quite different.\n \n-#![feature(start)]\n #![feature(rustc_attrs)]\n #![allow(dead_code)]\n \n@@ -56,7 +55,7 @@ pub struct NestedNonZero {\n \n impl Default for NestedNonZero {\n     fn default() -> Self {\n-        NestedNonZero { pre: 0, val: NonZeroU32::new(1).unwrap(), post: 0 }\n+        NestedNonZero { pre: 0, val: unsafe { NonZeroU32::new_unchecked(1) }, post: 0 }\n     }\n }\n \n@@ -76,8 +75,7 @@ pub union Union2<A: Copy, B: Copy> {\n     b: B,\n }\n \n-#[start]\n-fn start(_: isize, _: *const *const u8) -> isize {\n+pub fn test() {\n     let _x: MyOption<NonZeroU32> = Default::default();\n     let _y: EmbeddedDiscr = Default::default();\n     let _z: MyOption<IndirectNonZero> = Default::default();\n@@ -96,6 +94,4 @@ fn start(_: isize, _: *const *const u8) -> isize {\n     // ...even when theoretically possible.\n     let _j: MyOption<Union1<NonZeroU32>> = Default::default();\n     let _k: MyOption<Union2<NonZeroU32, NonZeroU32>> = Default::default();\n-\n-    0\n }"}, {"sha": "2ec5d9e64bfbfbad3de1496e7cdf2773002d6194", "filename": "src/test/ui/print_type_sizes/no_duplicates.rs", "status": "modified", "additions": 2, "deletions": 6, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/5d24760245567ccf9f938a063c2f13ea527bef9c/src%2Ftest%2Fui%2Fprint_type_sizes%2Fno_duplicates.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5d24760245567ccf9f938a063c2f13ea527bef9c/src%2Ftest%2Fui%2Fprint_type_sizes%2Fno_duplicates.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fprint_type_sizes%2Fno_duplicates.rs?ref=5d24760245567ccf9f938a063c2f13ea527bef9c", "patch": "@@ -1,4 +1,4 @@\n-// compile-flags: -Z print-type-sizes\n+// compile-flags: -Z print-type-sizes --crate-type=lib\n // build-pass\n // ignore-pass\n // ^-- needed because `--pass check` does not emit the output needed.\n@@ -8,16 +8,12 @@\n // (even if multiple functions), it is only printed once in the\n // print-type-sizes output.\n \n-#![feature(start)]\n-\n pub struct SevenBytes([u8; 7]);\n \n pub fn f1() {\n     let _s: SevenBytes = SevenBytes([0; 7]);\n }\n \n-#[start]\n-fn start(_: isize, _: *const *const u8) -> isize {\n+pub fn test() {\n     let _s: SevenBytes = SevenBytes([0; 7]);\n-    0\n }"}, {"sha": "5ddfe4bf4dbb0a9bfaed5ac3a2a0a95547de2da9", "filename": "src/test/ui/print_type_sizes/packed.rs", "status": "modified", "additions": 5, "deletions": 15, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/5d24760245567ccf9f938a063c2f13ea527bef9c/src%2Ftest%2Fui%2Fprint_type_sizes%2Fpacked.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5d24760245567ccf9f938a063c2f13ea527bef9c/src%2Ftest%2Fui%2Fprint_type_sizes%2Fpacked.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fprint_type_sizes%2Fpacked.rs?ref=5d24760245567ccf9f938a063c2f13ea527bef9c", "patch": "@@ -1,4 +1,4 @@\n-// compile-flags: -Z print-type-sizes\n+// compile-flags: -Z print-type-sizes --crate-type=lib\n // build-pass\n // ignore-pass\n // ^-- needed because `--pass check` does not emit the output needed.\n@@ -13,11 +13,10 @@\n // padding and overall computed sizes can be quite different.\n \n #![allow(dead_code)]\n-#![feature(start)]\n \n #[derive(Default)]\n #[repr(packed)]\n-struct Packed1 {\n+pub struct Packed1 {\n     a: u8,\n     b: u8,\n     g: i32,\n@@ -28,7 +27,7 @@ struct Packed1 {\n \n #[derive(Default)]\n #[repr(packed(2))]\n-struct Packed2 {\n+pub struct Packed2 {\n     a: u8,\n     b: u8,\n     g: i32,\n@@ -40,7 +39,7 @@ struct Packed2 {\n #[derive(Default)]\n #[repr(packed(2))]\n #[repr(C)]\n-struct Packed2C {\n+pub struct Packed2C {\n     a: u8,\n     b: u8,\n     g: i32,\n@@ -50,20 +49,11 @@ struct Packed2C {\n }\n \n #[derive(Default)]\n-struct Padded {\n+pub struct Padded {\n     a: u8,\n     b: u8,\n     g: i32,\n     c: u8,\n     h: i16,\n     d: u8,\n }\n-\n-#[start]\n-fn start(_: isize, _: *const *const u8) -> isize {\n-    let _c: Packed1 = Default::default();\n-    let _d: Packed2 = Default::default();\n-    let _e: Packed2C = Default::default();\n-    let _f: Padded = Default::default();\n-    0\n-}"}, {"sha": "f41c677dc6c08ff7bd0a0b61c489b677fbd89b2c", "filename": "src/test/ui/print_type_sizes/padding.rs", "status": "modified", "additions": 1, "deletions": 7, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/5d24760245567ccf9f938a063c2f13ea527bef9c/src%2Ftest%2Fui%2Fprint_type_sizes%2Fpadding.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5d24760245567ccf9f938a063c2f13ea527bef9c/src%2Ftest%2Fui%2Fprint_type_sizes%2Fpadding.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fprint_type_sizes%2Fpadding.rs?ref=5d24760245567ccf9f938a063c2f13ea527bef9c", "patch": "@@ -1,4 +1,4 @@\n-// compile-flags: -Z print-type-sizes\n+// compile-flags: -Z print-type-sizes --crate-type=lib\n // build-pass\n \n // This file illustrates how padding is handled: alignment\n@@ -9,7 +9,6 @@\n // aligned (while on most it is 8-byte aligned) and so the resulting\n // padding and overall computed sizes can be quite different.\n \n-#![feature(start)]\n #![allow(dead_code)]\n \n struct S {\n@@ -27,8 +26,3 @@ enum E2 {\n     A(i8, i32),\n     B(S),\n }\n-\n-#[start]\n-fn start(_: isize, _: *const *const u8) -> isize {\n-    0\n-}"}, {"sha": "0bd11ebc958433a3369b7addf8a8d2213be792d2", "filename": "src/test/ui/print_type_sizes/repr-align.rs", "status": "modified", "additions": 3, "deletions": 9, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/5d24760245567ccf9f938a063c2f13ea527bef9c/src%2Ftest%2Fui%2Fprint_type_sizes%2Frepr-align.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5d24760245567ccf9f938a063c2f13ea527bef9c/src%2Ftest%2Fui%2Fprint_type_sizes%2Frepr-align.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fprint_type_sizes%2Frepr-align.rs?ref=5d24760245567ccf9f938a063c2f13ea527bef9c", "patch": "@@ -1,4 +1,4 @@\n-// compile-flags: -Z print-type-sizes\n+// compile-flags: -Z print-type-sizes --crate-type=lib\n // build-pass\n // ignore-pass\n // ^-- needed because `--pass check` does not emit the output needed.\n@@ -11,7 +11,7 @@\n // It avoids using u64/i64 because on some targets that is only 4-byte\n // aligned (while on most it is 8-byte aligned) and so the resulting\n // padding and overall computed sizes can be quite different.\n-#![feature(start)]\n+\n #![allow(dead_code)]\n \n #[repr(align(16))]\n@@ -24,15 +24,9 @@ enum E {\n }\n \n #[derive(Default)]\n-struct S {\n+pub struct S {\n     a: i32,\n     b: i32,\n     c: A,\n     d: i8,\n }\n-\n-#[start]\n-fn start(_: isize, _: *const *const u8) -> isize {\n-    let _s: S = Default::default();\n-    0\n-}"}, {"sha": "6b103776a30d3c6c700a85cf3a242f4661edc8ee", "filename": "src/test/ui/print_type_sizes/repr_int_c.rs", "status": "modified", "additions": 1, "deletions": 7, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/5d24760245567ccf9f938a063c2f13ea527bef9c/src%2Ftest%2Fui%2Fprint_type_sizes%2Frepr_int_c.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5d24760245567ccf9f938a063c2f13ea527bef9c/src%2Ftest%2Fui%2Fprint_type_sizes%2Frepr_int_c.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fprint_type_sizes%2Frepr_int_c.rs?ref=5d24760245567ccf9f938a063c2f13ea527bef9c", "patch": "@@ -1,10 +1,9 @@\n-// compile-flags: -Z print-type-sizes\n+// compile-flags: -Z print-type-sizes --crate-type=lib\n // build-pass\n \n // This test makes sure that the tag is not grown for `repr(C)` or `repr(u8)`\n // variants (see https://github.com/rust-lang/rust/issues/50098 for the original bug).\n \n-#![feature(start)]\n #![allow(dead_code)]\n \n #[repr(C, u8)]\n@@ -18,8 +17,3 @@ enum Repru8 {\n     A(u16),\n     B,\n }\n-\n-#[start]\n-fn start(_: isize, _: *const *const u8) -> isize {\n-    0\n-}"}, {"sha": "86fab7b500af08030a7acca69d30b776a5724a3a", "filename": "src/test/ui/print_type_sizes/uninhabited.rs", "status": "modified", "additions": 2, "deletions": 4, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/5d24760245567ccf9f938a063c2f13ea527bef9c/src%2Ftest%2Fui%2Fprint_type_sizes%2Funinhabited.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5d24760245567ccf9f938a063c2f13ea527bef9c/src%2Ftest%2Fui%2Fprint_type_sizes%2Funinhabited.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fprint_type_sizes%2Funinhabited.rs?ref=5d24760245567ccf9f938a063c2f13ea527bef9c", "patch": "@@ -1,14 +1,12 @@\n-// compile-flags: -Z print-type-sizes\n+// compile-flags: -Z print-type-sizes --crate-type=lib\n // build-pass\n // ignore-pass\n // ^-- needed because `--pass check` does not emit the output needed.\n //     FIXME: consider using an attribute instead of side-effects.\n \n #![feature(never_type)]\n-#![feature(start)]\n \n-#[start]\n-fn start(_: isize, _: *const *const u8) -> isize {\n+pub fn test() {\n     let _x: Option<!> = None;\n     let _y: Result<u32, !> = Ok(42);\n     let _z: Result<!, !> = loop {};"}, {"sha": "5a3020520265db95a15f4857f10cfa2f0655e1ba", "filename": "src/test/ui/print_type_sizes/variants.rs", "status": "modified", "additions": 1, "deletions": 9, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/5d24760245567ccf9f938a063c2f13ea527bef9c/src%2Ftest%2Fui%2Fprint_type_sizes%2Fvariants.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5d24760245567ccf9f938a063c2f13ea527bef9c/src%2Ftest%2Fui%2Fprint_type_sizes%2Fvariants.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fprint_type_sizes%2Fvariants.rs?ref=5d24760245567ccf9f938a063c2f13ea527bef9c", "patch": "@@ -1,4 +1,4 @@\n-// compile-flags: -Z print-type-sizes\n+// compile-flags: -Z print-type-sizes --crate-type=lib\n // build-pass\n \n // This file illustrates two things:\n@@ -9,18 +9,10 @@\n // 2. For an enum, the print-type-sizes output will also include the\n //    size of each variant.\n \n-#![feature(start)]\n-\n pub struct SevenBytes([u8;  7]);\n pub struct FiftyBytes([u8; 50]);\n \n pub enum Enum {\n     Small(SevenBytes),\n     Large(FiftyBytes),\n }\n-\n-#[start]\n-fn start(_: isize, _: *const *const u8) -> isize {\n-    let _e: Enum;\n-    0\n-}"}, {"sha": "09415824d5df00835f9cda3dabbd4f5b9c4bc467", "filename": "src/test/ui/print_type_sizes/zero-sized-fields.rs", "status": "modified", "additions": 2, "deletions": 6, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/5d24760245567ccf9f938a063c2f13ea527bef9c/src%2Ftest%2Fui%2Fprint_type_sizes%2Fzero-sized-fields.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5d24760245567ccf9f938a063c2f13ea527bef9c/src%2Ftest%2Fui%2Fprint_type_sizes%2Fzero-sized-fields.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fprint_type_sizes%2Fzero-sized-fields.rs?ref=5d24760245567ccf9f938a063c2f13ea527bef9c", "patch": "@@ -1,12 +1,10 @@\n-// compile-flags: -Z print-type-sizes\n+// compile-flags: -Z print-type-sizes --crate-type=lib\n // build-pass\n // ignore-pass\n \n // At one point, zero-sized fields such as those in this file were causing\n // incorrect output from `-Z print-type-sizes`.\n \n-#![feature(start)]\n-\n struct S1 {\n     x: u32,\n     y: u32,\n@@ -28,8 +26,7 @@ struct S5<TagW, TagZ> {\n     tagz: TagZ,\n }\n \n-#[start]\n-fn start(_: isize, _: *const *const u8) -> isize {\n+pub fn test() {\n     let _s1: S1 = S1 { x: 0, y: 0, tag: () };\n \n     let _s5: S5<(), Empty> = S5 {\n@@ -43,5 +40,4 @@ fn start(_: isize, _: *const *const u8) -> isize {\n         z: 4,\n         tagz: Empty {},\n     };\n-    0\n }"}]}