{"sha": "ec2d0233831cdd1d88a0d0be43534a014c3e4899", "node_id": "C_kwDOAAsO6NoAKGVjMmQwMjMzODMxY2RkMWQ4OGEwZDBiZTQzNTM0YTAxNGMzZTQ4OTk", "commit": {"author": {"name": "Jonas Schievink", "email": "jonas.schievink@ferrous-systems.com", "date": "2022-03-31T12:50:33Z"}, "committer": {"name": "Jonas Schievink", "email": "jonas.schievink@ferrous-systems.com", "date": "2022-03-31T12:50:33Z"}, "message": "Add \"view file text\" command to debug sync issues", "tree": {"sha": "045d7021543058b40ecbf3b9ccd40928f63bf7c2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/045d7021543058b40ecbf3b9ccd40928f63bf7c2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ec2d0233831cdd1d88a0d0be43534a014c3e4899", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ec2d0233831cdd1d88a0d0be43534a014c3e4899", "html_url": "https://github.com/rust-lang/rust/commit/ec2d0233831cdd1d88a0d0be43534a014c3e4899", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ec2d0233831cdd1d88a0d0be43534a014c3e4899/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "259182b50b131647975926e8c94aad4c47d33747", "url": "https://api.github.com/repos/rust-lang/rust/commits/259182b50b131647975926e8c94aad4c47d33747", "html_url": "https://github.com/rust-lang/rust/commit/259182b50b131647975926e8c94aad4c47d33747"}], "stats": {"total": 90, "additions": 89, "deletions": 1}, "files": [{"sha": "15f497836783d8c05567671ea3c9baf16e226548", "filename": "crates/rust-analyzer/src/handlers.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ec2d0233831cdd1d88a0d0be43534a014c3e4899/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ec2d0233831cdd1d88a0d0be43534a014c3e4899/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs?ref=ec2d0233831cdd1d88a0d0be43534a014c3e4899", "patch": "@@ -123,6 +123,14 @@ pub(crate) fn handle_view_hir(\n     Ok(res)\n }\n \n+pub(crate) fn handle_view_file_text(\n+    snap: GlobalStateSnapshot,\n+    params: lsp_types::TextDocumentIdentifier,\n+) -> Result<String> {\n+    let file_id = from_proto::file_id(&snap, &params.uri)?;\n+    Ok(snap.analysis.file_text(file_id)?.to_string())\n+}\n+\n pub(crate) fn handle_view_item_tree(\n     snap: GlobalStateSnapshot,\n     params: lsp_ext::ViewItemTreeParams,"}, {"sha": "b638a571113e5bb9df0318c6c69f11969d07f5c4", "filename": "crates/rust-analyzer/src/lsp_ext.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ec2d0233831cdd1d88a0d0be43534a014c3e4899/crates%2Frust-analyzer%2Fsrc%2Flsp_ext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ec2d0233831cdd1d88a0d0be43534a014c3e4899/crates%2Frust-analyzer%2Fsrc%2Flsp_ext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Flsp_ext.rs?ref=ec2d0233831cdd1d88a0d0be43534a014c3e4899", "patch": "@@ -70,6 +70,14 @@ impl Request for ViewHir {\n     const METHOD: &'static str = \"rust-analyzer/viewHir\";\n }\n \n+pub enum ViewFileText {}\n+\n+impl Request for ViewFileText {\n+    type Params = lsp_types::TextDocumentIdentifier;\n+    type Result = String;\n+    const METHOD: &'static str = \"rust-analyzer/viewFileText\";\n+}\n+\n #[derive(Deserialize, Serialize, Debug)]\n #[serde(rename_all = \"camelCase\")]\n pub struct ViewCrateGraphParams {"}, {"sha": "2d898d76a6dd9667c4c23377c0ce4f399d4f30cb", "filename": "crates/rust-analyzer/src/main_loop.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/ec2d0233831cdd1d88a0d0be43534a014c3e4899/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ec2d0233831cdd1d88a0d0be43534a014c3e4899/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs?ref=ec2d0233831cdd1d88a0d0be43534a014c3e4899", "patch": "@@ -590,6 +590,7 @@ impl GlobalState {\n             .on::<lsp_ext::AnalyzerStatus>(handlers::handle_analyzer_status)\n             .on::<lsp_ext::SyntaxTree>(handlers::handle_syntax_tree)\n             .on::<lsp_ext::ViewHir>(handlers::handle_view_hir)\n+            .on::<lsp_ext::ViewFileText>(handlers::handle_view_file_text)\n             .on::<lsp_ext::ViewCrateGraph>(handlers::handle_view_crate_graph)\n             .on::<lsp_ext::ViewItemTree>(handlers::handle_view_item_tree)\n             .on::<lsp_ext::ExpandMacro>(handlers::handle_expand_macro)"}, {"sha": "516d1caccc354eb870e06983eca9975083941034", "filename": "docs/dev/lsp-extensions.md", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/ec2d0233831cdd1d88a0d0be43534a014c3e4899/docs%2Fdev%2Flsp-extensions.md", "raw_url": "https://github.com/rust-lang/rust/raw/ec2d0233831cdd1d88a0d0be43534a014c3e4899/docs%2Fdev%2Flsp-extensions.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/docs%2Fdev%2Flsp-extensions.md?ref=ec2d0233831cdd1d88a0d0be43534a014c3e4899", "patch": "@@ -1,5 +1,5 @@\n <!---\n-lsp_ext.rs hash: 854109e98d02a780\n+lsp_ext.rs hash: a61de7db4504a4d1\n \n If you need to change the above hash to make the test pass, please check if you\n need to adjust this doc as well and ping this issue:\n@@ -494,6 +494,17 @@ Primarily for debugging, but very useful for all people working on rust-analyzer\n Returns a textual representation of the HIR of the function containing the cursor.\n For debugging or when working on rust-analyzer itself.\n \n+## View File Text\n+\n+**Method:** `rust-analyzer/viewFileText`\n+\n+**Request:** `TextDocumentIdentifier`\n+\n+**Response:** `string`\n+\n+Returns the text of a file as seen by the server.\n+This is for debugging file sync problems.\n+\n ## View ItemTree\n \n **Method:** `rust-analyzer/viewItemTree`"}, {"sha": "7df00d2ef2c8bbbe64d985dd5eeb82f866906aea", "filename": "editors/code/package.json", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/ec2d0233831cdd1d88a0d0be43534a014c3e4899/editors%2Fcode%2Fpackage.json", "raw_url": "https://github.com/rust-lang/rust/raw/ec2d0233831cdd1d88a0d0be43534a014c3e4899/editors%2Fcode%2Fpackage.json", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fpackage.json?ref=ec2d0233831cdd1d88a0d0be43534a014c3e4899", "patch": "@@ -104,6 +104,11 @@\n                 \"title\": \"View Hir\",\n                 \"category\": \"Rust Analyzer\"\n             },\n+            {\n+                \"command\": \"rust-analyzer.viewFileText\",\n+                \"title\": \"View File Text (as seen by the server)\",\n+                \"category\": \"Rust Analyzer\"\n+            },\n             {\n                 \"command\": \"rust-analyzer.viewItemTree\",\n                 \"title\": \"Debug ItemTree\",\n@@ -1408,6 +1413,10 @@\n                     \"command\": \"rust-analyzer.viewHir\",\n                     \"when\": \"inRustProject\"\n                 },\n+                {\n+                    \"command\": \"rust-analyzer.viewFileText\",\n+                    \"when\": \"inRustProject\"\n+                },\n                 {\n                     \"command\": \"rust-analyzer.expandMacro\",\n                     \"when\": \"inRustProject\""}, {"sha": "2802668be301b50db4a1286575562d1f3fe214a8", "filename": "editors/code/src/commands.ts", "status": "modified", "additions": 48, "deletions": 0, "changes": 48, "blob_url": "https://github.com/rust-lang/rust/blob/ec2d0233831cdd1d88a0d0be43534a014c3e4899/editors%2Fcode%2Fsrc%2Fcommands.ts", "raw_url": "https://github.com/rust-lang/rust/raw/ec2d0233831cdd1d88a0d0be43534a014c3e4899/editors%2Fcode%2Fsrc%2Fcommands.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fcommands.ts?ref=ec2d0233831cdd1d88a0d0be43534a014c3e4899", "patch": "@@ -432,6 +432,54 @@ export function viewHir(ctx: Ctx): Cmd {\n     };\n }\n \n+export function viewFileText(ctx: Ctx): Cmd {\n+    const tdcp = new class implements vscode.TextDocumentContentProvider {\n+        readonly uri = vscode.Uri.parse('rust-analyzer://viewFileText/file.rs');\n+        readonly eventEmitter = new vscode.EventEmitter<vscode.Uri>();\n+        constructor() {\n+            vscode.workspace.onDidChangeTextDocument(this.onDidChangeTextDocument, this, ctx.subscriptions);\n+            vscode.window.onDidChangeActiveTextEditor(this.onDidChangeActiveTextEditor, this, ctx.subscriptions);\n+        }\n+\n+        private onDidChangeTextDocument(event: vscode.TextDocumentChangeEvent) {\n+            if (isRustDocument(event.document)) {\n+                // We need to order this after language server updates, but there's no API for that.\n+                // Hence, good old sleep().\n+                void sleep(10).then(() => this.eventEmitter.fire(this.uri));\n+            }\n+        }\n+        private onDidChangeActiveTextEditor(editor: vscode.TextEditor | undefined) {\n+            if (editor && isRustEditor(editor)) {\n+                this.eventEmitter.fire(this.uri);\n+            }\n+        }\n+\n+        provideTextDocumentContent(_uri: vscode.Uri, ct: vscode.CancellationToken): vscode.ProviderResult<string> {\n+            const rustEditor = ctx.activeRustEditor;\n+            const client = ctx.client;\n+            if (!rustEditor || !client) return '';\n+\n+            const params = client.code2ProtocolConverter.asTextDocumentIdentifier(rustEditor.document);\n+            return client.sendRequest(ra.viewFileText, params, ct);\n+        }\n+\n+        get onDidChange(): vscode.Event<vscode.Uri> {\n+            return this.eventEmitter.event;\n+        }\n+    };\n+\n+    ctx.pushCleanup(vscode.workspace.registerTextDocumentContentProvider('rust-analyzer', tdcp));\n+\n+    return async () => {\n+        const document = await vscode.workspace.openTextDocument(tdcp.uri);\n+        tdcp.eventEmitter.fire(tdcp.uri);\n+        void await vscode.window.showTextDocument(document, {\n+            viewColumn: vscode.ViewColumn.Two,\n+            preserveFocus: true\n+        });\n+    };\n+}\n+\n export function viewItemTree(ctx: Ctx): Cmd {\n     const tdcp = new class implements vscode.TextDocumentContentProvider {\n         readonly uri = vscode.Uri.parse('rust-analyzer://viewItemTree/itemtree.rs');"}, {"sha": "0ae5e93a73f47723dc8548f2848cce32f9e3eda8", "filename": "editors/code/src/lsp_ext.ts", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ec2d0233831cdd1d88a0d0be43534a014c3e4899/editors%2Fcode%2Fsrc%2Flsp_ext.ts", "raw_url": "https://github.com/rust-lang/rust/raw/ec2d0233831cdd1d88a0d0be43534a014c3e4899/editors%2Fcode%2Fsrc%2Flsp_ext.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Flsp_ext.ts?ref=ec2d0233831cdd1d88a0d0be43534a014c3e4899", "patch": "@@ -36,6 +36,8 @@ export const syntaxTree = new lc.RequestType<SyntaxTreeParams, string, void>(\"ru\n \n export const viewHir = new lc.RequestType<lc.TextDocumentPositionParams, string, void>(\"rust-analyzer/viewHir\");\n \n+export const viewFileText = new lc.RequestType<lc.TextDocumentIdentifier, string, void>(\"rust-analyzer/viewFileText\");\n+\n export interface ViewItemTreeParams {\n     textDocument: lc.TextDocumentIdentifier;\n }"}, {"sha": "36a095bdd367feb7df72f4a5e51c0256b4d9bcb4", "filename": "editors/code/src/main.ts", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/ec2d0233831cdd1d88a0d0be43534a014c3e4899/editors%2Fcode%2Fsrc%2Fmain.ts", "raw_url": "https://github.com/rust-lang/rust/raw/ec2d0233831cdd1d88a0d0be43534a014c3e4899/editors%2Fcode%2Fsrc%2Fmain.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fmain.ts?ref=ec2d0233831cdd1d88a0d0be43534a014c3e4899", "patch": "@@ -114,6 +114,7 @@ async function initCommonContext(context: vscode.ExtensionContext, ctx: Ctx) {\n     ctx.registerCommand('parentModule', commands.parentModule);\n     ctx.registerCommand('syntaxTree', commands.syntaxTree);\n     ctx.registerCommand('viewHir', commands.viewHir);\n+    ctx.registerCommand('viewFileText', commands.viewFileText);\n     ctx.registerCommand('viewItemTree', commands.viewItemTree);\n     ctx.registerCommand('viewCrateGraph', commands.viewCrateGraph);\n     ctx.registerCommand('viewFullCrateGraph', commands.viewFullCrateGraph);"}]}