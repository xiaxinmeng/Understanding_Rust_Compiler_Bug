{"sha": "370bf1543dc1033194403241fbb73d3b8c1d48b3", "node_id": "C_kwDOAAsO6NoAKDM3MGJmMTU0M2RjMTAzMzE5NDQwMzI0MWZiYjczZDNiOGMxZDQ4YjM", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-08-18T03:10:41Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-08-18T03:10:41Z"}, "message": "Rollup merge of #97962 - eholk:drop-tracking-must-not-suspend, r=cjgillot\n\nMake must_not_suspend lint see through references when drop tracking is enabled\n\nSee #97333.\n\nWith drop tracking enabled, sometimes values that were previously linted are now considered dropped and not linted. This change makes must_not_suspend traverse through references to still catch these values.\n\nUnfortunately, this leads to duplicate warnings in some cases (e.g. [dedup.rs](https://cs.github.com/rust-lang/rust/blob/9a74608543d499bcc7dd505e195e8bfab9447315/src/test/ui/lint/must_not_suspend/dedup.rs#L4)), so we only use the new behavior when drop tracking is enabled.\n\ncc ``@guswynn``", "tree": {"sha": "d76d8728ba9503add4a3022454a550a4eb13b39d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d76d8728ba9503add4a3022454a550a4eb13b39d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/370bf1543dc1033194403241fbb73d3b8c1d48b3", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJi/a2xCRBK7hj4Ov3rIwAA4iYIALJzS6LEYubODHO5aUYLMuaZ\noa3wS/W5UVJugR2UZx0qj+g1WKxsTeIXFHYSotGTUPZ6wlIertzHyGrIKsQ4eOGo\nCzNvOcI1g8Pikh+s0VqNru3OxPzY2KYn1DgKnC8QRHHgIAAxgdVuypXMDyQHZ+e3\n/zRS6+KftMmJmo7DF8dW5rjwrMSGBy4d0h4jJaAGgF6Du94Xo95zamQjcOsWq/YJ\nEToy9g0AnrBn7170QOi8y3rGiwropuWuQXtpsCxff5r/OqWskWVrYTOr/rRyrD/X\nlUkQOduVyLKa3SdUF1Dr2Qr9MCuaY9WhSi41HjsTMC9YNcuaktSSTKYbJN3Cpw4=\n=AXVQ\n-----END PGP SIGNATURE-----\n", "payload": "tree d76d8728ba9503add4a3022454a550a4eb13b39d\nparent 9c20b2a8cc7588decb6de25ac6a7912dcef24d65\nparent 0da81997a2652b8a46506cf0a5e4d382ea1f3308\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1660792241 +0200\ncommitter GitHub <noreply@github.com> 1660792241 +0200\n\nRollup merge of #97962 - eholk:drop-tracking-must-not-suspend, r=cjgillot\n\nMake must_not_suspend lint see through references when drop tracking is enabled\n\nSee #97333.\n\nWith drop tracking enabled, sometimes values that were previously linted are now considered dropped and not linted. This change makes must_not_suspend traverse through references to still catch these values.\n\nUnfortunately, this leads to duplicate warnings in some cases (e.g. [dedup.rs](https://cs.github.com/rust-lang/rust/blob/9a74608543d499bcc7dd505e195e8bfab9447315/src/test/ui/lint/must_not_suspend/dedup.rs#L4)), so we only use the new behavior when drop tracking is enabled.\n\ncc ``@guswynn``\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/370bf1543dc1033194403241fbb73d3b8c1d48b3", "html_url": "https://github.com/rust-lang/rust/commit/370bf1543dc1033194403241fbb73d3b8c1d48b3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/370bf1543dc1033194403241fbb73d3b8c1d48b3/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9c20b2a8cc7588decb6de25ac6a7912dcef24d65", "url": "https://api.github.com/repos/rust-lang/rust/commits/9c20b2a8cc7588decb6de25ac6a7912dcef24d65", "html_url": "https://github.com/rust-lang/rust/commit/9c20b2a8cc7588decb6de25ac6a7912dcef24d65"}, {"sha": "0da81997a2652b8a46506cf0a5e4d382ea1f3308", "url": "https://api.github.com/repos/rust-lang/rust/commits/0da81997a2652b8a46506cf0a5e4d382ea1f3308", "html_url": "https://github.com/rust-lang/rust/commit/0da81997a2652b8a46506cf0a5e4d382ea1f3308"}], "stats": {"total": 69, "additions": 67, "deletions": 2}, "files": [{"sha": "85a0d4e44990602e6a6bcdb7172bf0057d0f685f", "filename": "compiler/rustc_typeck/src/check/generator_interior.rs", "status": "modified", "additions": 10, "deletions": 2, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/370bf1543dc1033194403241fbb73d3b8c1d48b3/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fgenerator_interior.rs", "raw_url": "https://github.com/rust-lang/rust/raw/370bf1543dc1033194403241fbb73d3b8c1d48b3/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fgenerator_interior.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fgenerator_interior.rs?ref=370bf1543dc1033194403241fbb73d3b8c1d48b3", "patch": "@@ -457,7 +457,7 @@ impl<'a, 'tcx> Visitor<'tcx> for InteriorVisitor<'a, 'tcx> {\n }\n \n #[derive(Default)]\n-pub struct SuspendCheckData<'a, 'tcx> {\n+struct SuspendCheckData<'a, 'tcx> {\n     expr: Option<&'tcx Expr<'tcx>>,\n     source_span: Span,\n     yield_span: Span,\n@@ -472,7 +472,7 @@ pub struct SuspendCheckData<'a, 'tcx> {\n //\n // Note that this technique was chosen over things like a `Suspend` marker trait\n // as it is simpler and has precedent in the compiler\n-pub fn check_must_not_suspend_ty<'tcx>(\n+fn check_must_not_suspend_ty<'tcx>(\n     fcx: &FnCtxt<'_, 'tcx>,\n     ty: Ty<'tcx>,\n     hir_id: HirId,\n@@ -489,6 +489,8 @@ pub fn check_must_not_suspend_ty<'tcx>(\n \n     let plural_suffix = pluralize!(data.plural_len);\n \n+    debug!(\"Checking must_not_suspend for {}\", ty);\n+\n     match *ty.kind() {\n         ty::Adt(..) if ty.is_box() => {\n             let boxed_ty = ty.boxed_ty();\n@@ -580,6 +582,12 @@ pub fn check_must_not_suspend_ty<'tcx>(\n                 },\n             )\n         }\n+        // If drop tracking is enabled, we want to look through references, since the referrent\n+        // may not be considered live across the await point.\n+        ty::Ref(_region, ty, _mutability) if fcx.sess().opts.unstable_opts.drop_tracking => {\n+            let descr_pre = &format!(\"{}reference{} to \", data.descr_pre, plural_suffix);\n+            check_must_not_suspend_ty(fcx, ty, hir_id, SuspendCheckData { descr_pre, ..data })\n+        }\n         _ => false,\n     }\n }"}, {"sha": "1bc4a381257532b8ec646c42df6041bd2a693d05", "filename": "src/test/ui/lint/must_not_suspend/ref-drop-tracking.rs", "status": "added", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/370bf1543dc1033194403241fbb73d3b8c1d48b3/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Fref-drop-tracking.rs", "raw_url": "https://github.com/rust-lang/rust/raw/370bf1543dc1033194403241fbb73d3b8c1d48b3/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Fref-drop-tracking.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Fref-drop-tracking.rs?ref=370bf1543dc1033194403241fbb73d3b8c1d48b3", "patch": "@@ -0,0 +1,30 @@\n+// edition:2018\n+// compile-flags: -Zdrop-tracking\n+#![feature(must_not_suspend)]\n+#![deny(must_not_suspend)]\n+\n+#[must_not_suspend = \"You gotta use Umm's, ya know?\"]\n+struct Umm {\n+    i: i64\n+}\n+\n+struct Bar {\n+    u: Umm,\n+}\n+\n+async fn other() {}\n+\n+impl Bar {\n+    async fn uhoh(&mut self) {\n+        let guard = &mut self.u; //~ ERROR `Umm` held across\n+\n+        other().await;\n+\n+        *guard = Umm {\n+            i: 2\n+        }\n+    }\n+}\n+\n+fn main() {\n+}"}, {"sha": "c49d27128537155c497ece58431a6814fcea9bdc", "filename": "src/test/ui/lint/must_not_suspend/ref-drop-tracking.stderr", "status": "added", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/370bf1543dc1033194403241fbb73d3b8c1d48b3/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Fref-drop-tracking.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/370bf1543dc1033194403241fbb73d3b8c1d48b3/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Fref-drop-tracking.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Fref-drop-tracking.stderr?ref=370bf1543dc1033194403241fbb73d3b8c1d48b3", "patch": "@@ -0,0 +1,27 @@\n+error: reference to `Umm` held across a suspend point, but should not be\n+  --> $DIR/ref-drop-tracking.rs:19:13\n+   |\n+LL |         let guard = &mut self.u;\n+   |             ^^^^^\n+LL |\n+LL |         other().await;\n+   |                ------ the value is held across this suspend point\n+   |\n+note: the lint level is defined here\n+  --> $DIR/ref-drop-tracking.rs:4:9\n+   |\n+LL | #![deny(must_not_suspend)]\n+   |         ^^^^^^^^^^^^^^^^\n+note: You gotta use Umm's, ya know?\n+  --> $DIR/ref-drop-tracking.rs:19:13\n+   |\n+LL |         let guard = &mut self.u;\n+   |             ^^^^^\n+help: consider using a block (`{ ... }`) to shrink the value's scope, ending before the suspend point\n+  --> $DIR/ref-drop-tracking.rs:19:13\n+   |\n+LL |         let guard = &mut self.u;\n+   |             ^^^^^\n+\n+error: aborting due to previous error\n+"}]}