{"sha": "6cee78c4f052f2189e5598d21e8bbfcfe5df6896", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZjZWU3OGM0ZjA1MmYyMTg5ZTU1OThkMjFlOGJiZmNmZTVkZjY4OTY=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-10-31T01:54:04Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-10-31T01:54:04Z"}, "message": "Rollup merge of #65274 - pietroalbini:ci-upload-toolstate, r=alexcrichton\n\nUpload toolstates.json to rust-lang-ci2\n\nThis PR does two things:\n\n* Following up with https://github.com/rust-lang/rust/pull/65202, it migrates deploying artifacts to CI in a script. Both uploading release artifacts and CPU stats were merged into the same script, designing it to be easily extended.\n* Uploads the toolstate JSON to `rust-lang-ci2` along with the release artifacts, both for Linux and Windows. This is needed because @RalfJung wants to stop shipping MIRI when its tests are failing, and the toolstate repo doesn't have entries for each commit. Having the toolstate data (just for that specific commit) on `rust-lang-ci2` will simplify the code a lot.\n\nr? @alexcrichton\ncc @RalfJung", "tree": {"sha": "e325fa0e49c9e5d5f25f903ee9a115997686c282", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e325fa0e49c9e5d5f25f903ee9a115997686c282"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6cee78c4f052f2189e5598d21e8bbfcfe5df6896", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJduj68CRBK7hj4Ov3rIwAAdHIIACybpfolWVr0pln2cQf5Ojx6\nhbG8/WRkQ35x3yWzOPkFh76elKX41sQ7DclO81Frna8wK5CnEQc1bzjSIiV4o4t1\ngbtVpk9JvyBK+5C5zCUzY0+YS7xLaecQGY4/7JTJ47OHZCGY277Z4Yn9JL3w5+/K\n3OcOWQ4Ick1jnv5RSXhMA6A1acH4+9tueTN+KodET3C4pMyY+1Uadvmfch78Ag26\n7VnittbMr+XYg2YI58DBZ9VzVhlTT9k5j7XU4/wnmhs805bxeFnRhcITGWItaJ1e\n9BRF1XceOE6zKJv1x+QR2SDCp1fqh+KynSHUu4DuwN8VKss70ek/wtgypl8ecpg=\n=RqeO\n-----END PGP SIGNATURE-----\n", "payload": "tree e325fa0e49c9e5d5f25f903ee9a115997686c282\nparent c553e8e8812c19809e70523064989e66c5cfd3f1\nparent ca3468768d234af5de4fe7b578b701e3404a6dac\nauthor Mazdak Farrokhzad <twingoow@gmail.com> 1572486844 +0100\ncommitter GitHub <noreply@github.com> 1572486844 +0100\n\nRollup merge of #65274 - pietroalbini:ci-upload-toolstate, r=alexcrichton\n\nUpload toolstates.json to rust-lang-ci2\n\nThis PR does two things:\n\n* Following up with https://github.com/rust-lang/rust/pull/65202, it migrates deploying artifacts to CI in a script. Both uploading release artifacts and CPU stats were merged into the same script, designing it to be easily extended.\n* Uploads the toolstate JSON to `rust-lang-ci2` along with the release artifacts, both for Linux and Windows. This is needed because @RalfJung wants to stop shipping MIRI when its tests are failing, and the toolstate repo doesn't have entries for each commit. Having the toolstate data (just for that specific commit) on `rust-lang-ci2` will simplify the code a lot.\n\nr? @alexcrichton\ncc @RalfJung\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6cee78c4f052f2189e5598d21e8bbfcfe5df6896", "html_url": "https://github.com/rust-lang/rust/commit/6cee78c4f052f2189e5598d21e8bbfcfe5df6896", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6cee78c4f052f2189e5598d21e8bbfcfe5df6896/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c553e8e8812c19809e70523064989e66c5cfd3f1", "url": "https://api.github.com/repos/rust-lang/rust/commits/c553e8e8812c19809e70523064989e66c5cfd3f1", "html_url": "https://github.com/rust-lang/rust/commit/c553e8e8812c19809e70523064989e66c5cfd3f1"}, {"sha": "ca3468768d234af5de4fe7b578b701e3404a6dac", "url": "https://api.github.com/repos/rust-lang/rust/commits/ca3468768d234af5de4fe7b578b701e3404a6dac", "html_url": "https://github.com/rust-lang/rust/commit/ca3468768d234af5de4fe7b578b701e3404a6dac"}], "stats": {"total": 108, "additions": 73, "deletions": 35}, "files": [{"sha": "39d7ea922bceda50770772869345adc83364b440", "filename": "src/bootstrap/lib.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/6cee78c4f052f2189e5598d21e8bbfcfe5df6896/src%2Fbootstrap%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6cee78c4f052f2189e5598d21e8bbfcfe5df6896/src%2Fbootstrap%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Flib.rs?ref=6cee78c4f052f2189e5598d21e8bbfcfe5df6896", "patch": "@@ -1080,6 +1080,10 @@ impl Build {\n     /// done. The file is updated immediately after this function completes.\n     pub fn save_toolstate(&self, tool: &str, state: ToolState) {\n         if let Some(ref path) = self.config.save_toolstates {\n+            if let Some(parent) = path.parent() {\n+                // Ensure the parent directory always exists\n+                t!(std::fs::create_dir_all(parent));\n+            }\n             let mut file = t!(fs::OpenOptions::new()\n                 .create(true)\n                 .read(true)"}, {"sha": "271c32585449ec295495a2882fb480de246af258", "filename": "src/ci/azure-pipelines/auto.yml", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/6cee78c4f052f2189e5598d21e8bbfcfe5df6896/src%2Fci%2Fazure-pipelines%2Fauto.yml", "raw_url": "https://github.com/rust-lang/rust/raw/6cee78c4f052f2189e5598d21e8bbfcfe5df6896/src%2Fci%2Fazure-pipelines%2Fauto.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fazure-pipelines%2Fauto.yml?ref=6cee78c4f052f2189e5598d21e8bbfcfe5df6896", "patch": "@@ -140,6 +140,7 @@ jobs:\n         IMAGE: x86_64-gnu-aux\n       x86_64-gnu-tools:\n         IMAGE: x86_64-gnu-tools\n+        DEPLOY_TOOLSTATES_JSON: toolstates-linux.json\n       x86_64-gnu-debug:\n         IMAGE: x86_64-gnu-debug\n       x86_64-gnu-nopt:\n@@ -262,8 +263,9 @@ jobs:\n       # MSVC tools tests\n       x86_64-msvc-tools:\n         MSYS_BITS: 64\n-        SCRIPT: src/ci/docker/x86_64-gnu-tools/checktools.sh x.py /tmp/toolstates.json windows\n-        RUST_CONFIGURE_ARGS: --build=x86_64-pc-windows-msvc --save-toolstates=/tmp/toolstates.json\n+        SCRIPT: src/ci/docker/x86_64-gnu-tools/checktools.sh x.py /tmp/toolstate/toolstates.json windows\n+        RUST_CONFIGURE_ARGS: --build=x86_64-pc-windows-msvc --save-toolstates=/tmp/toolstate/toolstates.json\n+        DEPLOY_TOOLSTATES_JSON: toolstates-windows.json\n \n       # 32/64-bit MinGW builds.\n       #"}, {"sha": "cef2d235602f19c32325bedea47b3cf23eb8aab0", "filename": "src/ci/azure-pipelines/steps/run.yml", "status": "modified", "additions": 14, "deletions": 30, "changes": 44, "blob_url": "https://github.com/rust-lang/rust/blob/6cee78c4f052f2189e5598d21e8bbfcfe5df6896/src%2Fci%2Fazure-pipelines%2Fsteps%2Frun.yml", "raw_url": "https://github.com/rust-lang/rust/raw/6cee78c4f052f2189e5598d21e8bbfcfe5df6896/src%2Fci%2Fazure-pipelines%2Fsteps%2Frun.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fazure-pipelines%2Fsteps%2Frun.yml?ref=6cee78c4f052f2189e5598d21e8bbfcfe5df6896", "patch": "@@ -183,37 +183,21 @@ steps:\n   condition: and(succeeded(), not(variables.SKIP_JOB))\n   displayName: Run build\n \n-# If we're a deploy builder, use the `aws` command to publish everything to our\n-# bucket.\n-- bash: |\n-    set -e\n-    source src/ci/shared.sh\n-    if [ \"$AGENT_OS\" = \"Linux\" ]; then\n-        rm -rf obj/build/dist/doc\n-        upload_dir=obj/build/dist\n-    else\n-        rm -rf build/dist/doc\n-        upload_dir=build/dist\n-    fi\n-    ls -la $upload_dir\n-    deploy_dir=rustc-builds\n-    if [ \"$DEPLOY_ALT\" == \"1\" ]; then\n-        deploy_dir=rustc-builds-alt\n-    fi\n-    retry aws s3 cp --no-progress --recursive --acl public-read ./$upload_dir s3://$DEPLOY_BUCKET/$deploy_dir/$BUILD_SOURCEVERSION\n+- bash: src/ci/scripts/upload-artifacts.sh\n   env:\n     AWS_ACCESS_KEY_ID: $(UPLOAD_AWS_ACCESS_KEY_ID)\n     AWS_SECRET_ACCESS_KEY: $(UPLOAD_AWS_SECRET_ACCESS_KEY)\n-  condition: and(succeeded(), not(variables.SKIP_JOB), or(eq(variables.DEPLOY, '1'), eq(variables.DEPLOY_ALT, '1')))\n   displayName: Upload artifacts\n-\n-# Upload CPU usage statistics that we've been gathering this whole time. Always\n-# execute this step in case we want to inspect failed builds, but don't let\n-# errors here ever fail the build since this is just informational.\n-- bash: aws s3 cp --acl public-read cpu-usage.csv s3://$DEPLOY_BUCKET/rustc-builds/$BUILD_SOURCEVERSION/cpu-$CI_JOB_NAME.csv\n-  env:\n-    AWS_ACCESS_KEY_ID: $(UPLOAD_AWS_ACCESS_KEY_ID)\n-    AWS_SECRET_ACCESS_KEY: $(UPLOAD_AWS_SECRET_ACCESS_KEY)\n-  condition: variables['UPLOAD_AWS_SECRET_ACCESS_KEY']\n-  continueOnError: true\n-  displayName: Upload CPU usage statistics\n+  # Adding a condition on DEPLOY=1 or DEPLOY_ALT=1 is not needed as all deploy\n+  # builders *should* have the AWS credentials available. Still, explicitly\n+  # adding the condition is helpful as this way CI will not silently skip\n+  # deploying artifacts from a dist builder if the variables are misconfigured,\n+  # erroring about invalid credentials instead.\n+  condition: |\n+    and(\n+      succeeded(), not(variables.SKIP_JOB),\n+      or(\n+        variables.UPLOAD_AWS_SECRET_ACCESS_KEY,\n+        eq(variables.DEPLOY, '1'), eq(variables.DEPLOY_ALT, '1')\n+      )\n+    )"}, {"sha": "cdafcbadc9ec768bc9c044cfc2369c7ac51f3a82", "filename": "src/ci/docker/run.sh", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/6cee78c4f052f2189e5598d21e8bbfcfe5df6896/src%2Fci%2Fdocker%2Frun.sh", "raw_url": "https://github.com/rust-lang/rust/raw/6cee78c4f052f2189e5598d21e8bbfcfe5df6896/src%2Fci%2Fdocker%2Frun.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Frun.sh?ref=6cee78c4f052f2189e5598d21e8bbfcfe5df6896", "patch": "@@ -106,6 +106,7 @@ fi\n mkdir -p $HOME/.cargo\n mkdir -p $objdir/tmp\n mkdir -p $objdir/cores\n+mkdir -p /tmp/toolstate\n \n args=\n if [ \"$SCCACHE_BUCKET\" != \"\" ]; then\n@@ -156,6 +157,7 @@ else\n   args=\"$args --volume $objdir:/checkout/obj\"\n   args=\"$args --volume $HOME/.cargo:/cargo\"\n   args=\"$args --volume $HOME/rustsrc:$HOME/rustsrc\"\n+  args=\"$args --volume /tmp/toolstate:/tmp/toolstate\"\n   args=\"$args --env LOCAL_USER_ID=`id -u`\"\n fi\n "}, {"sha": "7687a6ca23e180fb386ac2446fd169d239c21a45", "filename": "src/ci/docker/x86_64-gnu-tools/Dockerfile", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/6cee78c4f052f2189e5598d21e8bbfcfe5df6896/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/6cee78c4f052f2189e5598d21e8bbfcfe5df6896/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2FDockerfile?ref=6cee78c4f052f2189e5598d21e8bbfcfe5df6896", "patch": "@@ -26,5 +26,5 @@ ENV CHECK_LINKS 1\n \n ENV RUST_CONFIGURE_ARGS \\\n   --build=x86_64-unknown-linux-gnu \\\n-  --save-toolstates=/tmp/toolstates.json\n-ENV SCRIPT /tmp/checktools.sh ../x.py /tmp/toolstates.json linux\n+  --save-toolstates=/tmp/toolstate/toolstates.json\n+ENV SCRIPT /tmp/checktools.sh ../x.py /tmp/toolstate/toolstates.json linux"}, {"sha": "ebb8c0bda53ee2ae3654a1d9e28388b2eeafcb07", "filename": "src/ci/docker/x86_64-gnu-tools/checktools.sh", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/6cee78c4f052f2189e5598d21e8bbfcfe5df6896/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2Fchecktools.sh", "raw_url": "https://github.com/rust-lang/rust/raw/6cee78c4f052f2189e5598d21e8bbfcfe5df6896/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2Fchecktools.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2Fchecktools.sh?ref=6cee78c4f052f2189e5598d21e8bbfcfe5df6896", "patch": "@@ -3,7 +3,7 @@\n set -eu\n \n X_PY=\"$1\"\n-TOOLSTATE_FILE=\"$(realpath $2)\"\n+TOOLSTATE_FILE=\"$(realpath -m $2)\"\n OS=\"$3\"\n COMMIT=\"$(git rev-parse HEAD)\"\n CHANGED_FILES=\"$(git diff --name-status HEAD HEAD^)\"\n@@ -13,6 +13,7 @@ SIX_WEEK_CYCLE=\"$(( ($(date +%s) / 86400 - 20) % 42 ))\"\n #   The Wednesday after this has value 0.\n #   We track this value to prevent regressing tools in the last week of the 6-week cycle.\n \n+mkdir -p \"$(dirname $TOOLSTATE_FILE)\"\n touch \"$TOOLSTATE_FILE\"\n \n # Try to test all the tools and store the build/test success in the TOOLSTATE_FILE"}, {"sha": "312ec9d805012c7433fc54b7643bf2cb9926a6d2", "filename": "src/ci/scripts/upload-artifacts.sh", "status": "added", "additions": 41, "deletions": 0, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/6cee78c4f052f2189e5598d21e8bbfcfe5df6896/src%2Fci%2Fscripts%2Fupload-artifacts.sh", "raw_url": "https://github.com/rust-lang/rust/raw/6cee78c4f052f2189e5598d21e8bbfcfe5df6896/src%2Fci%2Fscripts%2Fupload-artifacts.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fscripts%2Fupload-artifacts.sh?ref=6cee78c4f052f2189e5598d21e8bbfcfe5df6896", "patch": "@@ -0,0 +1,41 @@\n+#!/bin/bash\n+# Upload all the artifacts to our S3 bucket. All the files inside ${upload_dir}\n+# will be uploaded to the deploy bucket and eventually signed and released in\n+# static.rust-lang.org.\n+\n+set -euo pipefail\n+IFS=$'\\n\\t'\n+\n+source \"$(cd \"$(dirname \"$0\")\" && pwd)/../shared.sh\"\n+\n+upload_dir=\"$(mktemp -d)\"\n+\n+# Release tarballs produced by a dist builder.\n+if [[ \"${DEPLOY-0}\" -eq \"1\" ]] || [[ \"${DEPLOY_ALT-0}\" -eq \"1\" ]]; then\n+    dist_dir=build/dist\n+    if isLinux; then\n+        dist_dir=obj/build/dist\n+    fi\n+    rm -rf \"${dist_dir}/doc\"\n+    cp -r \"${dist_dir}\"/* \"${upload_dir}\"\n+fi\n+\n+# CPU usage statistics.\n+cp cpu-usage.csv \"${upload_dir}/cpu-${CI_JOB_NAME}.csv\"\n+\n+# Toolstate data.\n+if [[ -n \"${DEPLOY_TOOLSTATES_JSON+x}\" ]]; then\n+    cp /tmp/toolstate/toolstates.json \"${upload_dir}/${DEPLOY_TOOLSTATES_JSON}\"\n+fi\n+\n+echo \"Files that will be uploaded:\"\n+ls -lah \"${upload_dir}\"\n+echo\n+\n+deploy_dir=\"rustc-builds\"\n+if [[ \"${DEPLOY_ALT-0}\" -eq \"1\" ]]; then\n+    deploy_dir=\"rustc-builds-alt\"\n+fi\n+deploy_url=\"s3://${DEPLOY_BUCKET}/${deploy_dir}/$(ciCommit)\"\n+\n+retry aws s3 cp --no-progress --recursive --acl public-read \"${upload_dir}\" \"${deploy_url}\""}, {"sha": "718a5379ae558c44aac11ac160163b71eb19225a", "filename": "src/ci/shared.sh", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/6cee78c4f052f2189e5598d21e8bbfcfe5df6896/src%2Fci%2Fshared.sh", "raw_url": "https://github.com/rust-lang/rust/raw/6cee78c4f052f2189e5598d21e8bbfcfe5df6896/src%2Fci%2Fshared.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fshared.sh?ref=6cee78c4f052f2189e5598d21e8bbfcfe5df6896", "patch": "@@ -46,6 +46,10 @@ function getCIBranch {\n   echo \"$BUILD_SOURCEBRANCHNAME\"\n }\n \n+function ciCommit {\n+  echo \"${BUILD_SOURCEVERSION}\"\n+}\n+\n function ciCommandAddPath {\n     if [[ $# -ne 1 ]]; then\n         echo \"usage: $0 <path>\""}]}