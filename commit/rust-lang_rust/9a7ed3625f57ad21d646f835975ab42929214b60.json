{"sha": "9a7ed3625f57ad21d646f835975ab42929214b60", "node_id": "C_kwDOAAsO6NoAKDlhN2VkMzYyNWY1N2FkMjFkNjQ2ZjgzNTk3NWFiNDI5MjkyMTRiNjA", "commit": {"author": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2023-04-09T08:09:43Z"}, "committer": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2023-05-24T19:16:07Z"}, "message": "Emit diagnostic for privately uninhabited uncovered witnesses.", "tree": {"sha": "20e1e872db704783d3dd27a92eb15b51efb08abf", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/20e1e872db704783d3dd27a92eb15b51efb08abf"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9a7ed3625f57ad21d646f835975ab42929214b60", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9a7ed3625f57ad21d646f835975ab42929214b60", "html_url": "https://github.com/rust-lang/rust/commit/9a7ed3625f57ad21d646f835975ab42929214b60", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9a7ed3625f57ad21d646f835975ab42929214b60/comments", "author": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b3cbf7c8351dd48dc2e07a1cdc69620f8e40dd2f", "url": "https://api.github.com/repos/rust-lang/rust/commits/b3cbf7c8351dd48dc2e07a1cdc69620f8e40dd2f", "html_url": "https://github.com/rust-lang/rust/commit/b3cbf7c8351dd48dc2e07a1cdc69620f8e40dd2f"}], "stats": {"total": 34, "additions": 33, "deletions": 1}, "files": [{"sha": "0282492a261c85dfbaa25f8c41037f333165bb3b", "filename": "compiler/rustc_mir_build/messages.ftl", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/9a7ed3625f57ad21d646f835975ab42929214b60/compiler%2Frustc_mir_build%2Fmessages.ftl", "raw_url": "https://github.com/rust-lang/rust/raw/9a7ed3625f57ad21d646f835975ab42929214b60/compiler%2Frustc_mir_build%2Fmessages.ftl", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fmessages.ftl?ref=9a7ed3625f57ad21d646f835975ab42929214b60", "patch": "@@ -340,6 +340,8 @@ mir_build_uncovered = {$count ->\n         *[other] patterns `{$witness_1}`, `{$witness_2}`, `{$witness_3}` and {$remainder} more\n     } not covered\n \n+mir_build_privately_uninhabited = pattern `{$witness_1}` is currently uninhabited, but this variant contains private fields which may become inhabited in the future\n+\n mir_build_pattern_not_covered = refutable pattern in {$origin}\n     .pattern_ty = the matched value is of type `{$pattern_ty}`\n "}, {"sha": "7c0df201bc25e96f6f1f43f09c0ba69d6e863c0d", "filename": "compiler/rustc_mir_build/src/errors.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/9a7ed3625f57ad21d646f835975ab42929214b60/compiler%2Frustc_mir_build%2Fsrc%2Ferrors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9a7ed3625f57ad21d646f835975ab42929214b60/compiler%2Frustc_mir_build%2Fsrc%2Ferrors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Ferrors.rs?ref=9a7ed3625f57ad21d646f835975ab42929214b60", "patch": "@@ -781,6 +781,8 @@ pub(crate) struct PatternNotCovered<'s, 'tcx> {\n     pub interpreted_as_const: Option<InterpretedAsConst>,\n     #[subdiagnostic]\n     pub adt_defined_here: Option<AdtDefinedHere<'tcx>>,\n+    #[note(mir_build_privately_uninhabited)]\n+    pub witness_1_is_privately_uninhabited: Option<()>,\n     #[note(mir_build_pattern_ty)]\n     pub _p: (),\n     pub pattern_ty: Ty<'tcx>,"}, {"sha": "5559e8b3940aeb5634685c7fdea98885d0e3e23b", "filename": "compiler/rustc_mir_build/src/thir/pattern/check_match.rs", "status": "modified", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/9a7ed3625f57ad21d646f835975ab42929214b60/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fpattern%2Fcheck_match.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9a7ed3625f57ad21d646f835975ab42929214b60/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fpattern%2Fcheck_match.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fpattern%2Fcheck_match.rs?ref=9a7ed3625f57ad21d646f835975ab42929214b60", "patch": "@@ -479,12 +479,30 @@ impl<'p, 'tcx> MatchVisitor<'_, 'p, 'tcx> {\n             AdtDefinedHere { adt_def_span, ty, variants }\n         };\n \n+        // Emit an extra note if the first uncovered witness is\n+        // visibly uninhabited anywhere in the current crate.\n+        let witness_1_is_privately_uninhabited =\n+            if cx.tcx.features().exhaustive_patterns\n+                && let Some(witness_1) = witnesses.get(0)\n+                && let ty::Adt(adt, substs) = witness_1.ty().kind()\n+                && adt.is_enum()\n+                && let Constructor::Variant(variant_index) = witness_1.ctor()\n+            {\n+                let variant = adt.variant(*variant_index);\n+                let inhabited = variant.inhabited_predicate(cx.tcx, *adt).subst(cx.tcx, substs);\n+                assert!(inhabited.apply(cx.tcx, cx.param_env, cx.module));\n+                !inhabited.apply_ignore_module(cx.tcx, cx.param_env)\n+            } else {\n+                false\n+            };\n+\n         self.error = Err(self.tcx.sess.emit_err(PatternNotCovered {\n             span: pat.span,\n             origin,\n             uncovered: Uncovered::new(pat.span, &cx, witnesses),\n             inform,\n             interpreted_as_const,\n+            witness_1_is_privately_uninhabited: witness_1_is_privately_uninhabited.then_some(()),\n             _p: (),\n             pattern_ty,\n             let_suggestion,"}, {"sha": "f7bf8581582316884971f4439c0007fd5b04dbf8", "filename": "tests/ui/never_type/exhaustive_patterns.stderr", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/9a7ed3625f57ad21d646f835975ab42929214b60/tests%2Fui%2Fnever_type%2Fexhaustive_patterns.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/9a7ed3625f57ad21d646f835975ab42929214b60/tests%2Fui%2Fnever_type%2Fexhaustive_patterns.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fnever_type%2Fexhaustive_patterns.stderr?ref=9a7ed3625f57ad21d646f835975ab42929214b60", "patch": "@@ -14,6 +14,7 @@ LL | enum Either<A, B> {\n LL |     A(A),\n LL |     B(inner::Wrapper<B>),\n    |     - not covered\n+   = note: pattern `Either::B(_)` is currently uninhabited, but this variant contains private fields which may become inhabited in the future\n    = note: the matched value is of type `Either<(), !>`\n help: you might want to use `if let` to ignore the variant that isn't matched\n    |"}, {"sha": "cfd60a8d903fa0c1945668caf61e3be4893eba3f", "filename": "tests/ui/uninhabited/uninhabited-irrefutable.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/9a7ed3625f57ad21d646f835975ab42929214b60/tests%2Fui%2Funinhabited%2Funinhabited-irrefutable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9a7ed3625f57ad21d646f835975ab42929214b60/tests%2Fui%2Funinhabited%2Funinhabited-irrefutable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Funinhabited%2Funinhabited-irrefutable.rs?ref=9a7ed3625f57ad21d646f835975ab42929214b60", "patch": "@@ -16,7 +16,9 @@ struct NotSoSecretlyEmpty {\n }\n \n enum Foo {\n+    //~^ NOTE `Foo` defined here\n     A(foo::SecretlyEmpty),\n+    //~^ NOTE not covered\n     B(foo::NotSoSecretlyEmpty),\n     C(NotSoSecretlyEmpty),\n     D(u32, u32),\n@@ -27,4 +29,9 @@ fn main() {\n     let Foo::D(_y, _z) = x;\n     //~^ ERROR refutable pattern in local binding\n     //~| `Foo::A(_)` not covered\n+    //~| NOTE `let` bindings require an \"irrefutable pattern\"\n+    //~| NOTE for more information\n+    //~| NOTE pattern `Foo::A(_)` is currently uninhabited\n+    //~| NOTE the matched value is of type `Foo`\n+    //~| HELP you might want to use `let else`\n }"}, {"sha": "daf75f51b5a110a5d8f416ea7a583cec9d388cf7", "filename": "tests/ui/uninhabited/uninhabited-irrefutable.stderr", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/9a7ed3625f57ad21d646f835975ab42929214b60/tests%2Fui%2Funinhabited%2Funinhabited-irrefutable.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/9a7ed3625f57ad21d646f835975ab42929214b60/tests%2Fui%2Funinhabited%2Funinhabited-irrefutable.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Funinhabited%2Funinhabited-irrefutable.stderr?ref=9a7ed3625f57ad21d646f835975ab42929214b60", "patch": "@@ -1,5 +1,5 @@\n error[E0005]: refutable pattern in local binding\n-  --> $DIR/uninhabited-irrefutable.rs:27:9\n+  --> $DIR/uninhabited-irrefutable.rs:29:9\n    |\n LL |     let Foo::D(_y, _z) = x;\n    |         ^^^^^^^^^^^^^^ pattern `Foo::A(_)` not covered\n@@ -11,8 +11,10 @@ note: `Foo` defined here\n    |\n LL | enum Foo {\n    |      ^^^\n+LL |\n LL |     A(foo::SecretlyEmpty),\n    |     - not covered\n+   = note: pattern `Foo::A(_)` is currently uninhabited, but this variant contains private fields which may become inhabited in the future\n    = note: the matched value is of type `Foo`\n help: you might want to use `let else` to handle the variant that isn't matched\n    |"}]}