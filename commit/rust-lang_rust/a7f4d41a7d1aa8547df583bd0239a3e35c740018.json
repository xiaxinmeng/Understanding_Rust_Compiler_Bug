{"sha": "a7f4d41a7d1aa8547df583bd0239a3e35c740018", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE3ZjRkNDFhN2QxYWE4NTQ3ZGY1ODNiZDAyMzlhM2UzNWM3NDAwMTg=", "commit": {"author": {"name": "Grzegorz", "email": "grzegorz.bartoszek@thaumatec.com", "date": "2019-02-26T11:12:27Z"}, "committer": {"name": "Grzegorz", "email": "grzegorz.bartoszek@thaumatec.com", "date": "2019-02-26T11:12:27Z"}, "message": "do not trigger redundant_closure when there is a difference in borrow level between closure parameter and \"self\"", "tree": {"sha": "82e7e937e303024c41ccbb0c809ab97d5dc8a49a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/82e7e937e303024c41ccbb0c809ab97d5dc8a49a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a7f4d41a7d1aa8547df583bd0239a3e35c740018", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a7f4d41a7d1aa8547df583bd0239a3e35c740018", "html_url": "https://github.com/rust-lang/rust/commit/a7f4d41a7d1aa8547df583bd0239a3e35c740018", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a7f4d41a7d1aa8547df583bd0239a3e35c740018/comments", "author": null, "committer": null, "parents": [{"sha": "d0717d1f9531a03d154aaeb0cad94c243915a146", "url": "https://api.github.com/repos/rust-lang/rust/commits/d0717d1f9531a03d154aaeb0cad94c243915a146", "html_url": "https://github.com/rust-lang/rust/commit/d0717d1f9531a03d154aaeb0cad94c243915a146"}], "stats": {"total": 31, "additions": 22, "deletions": 9}, "files": [{"sha": "331d1a0ec1dcffc8499c93d184a194cf685e2648", "filename": "clippy_lints/src/eta_reduction.rs", "status": "modified", "additions": 14, "deletions": 9, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/a7f4d41a7d1aa8547df583bd0239a3e35c740018/clippy_lints%2Fsrc%2Feta_reduction.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a7f4d41a7d1aa8547df583bd0239a3e35c740018/clippy_lints%2Fsrc%2Feta_reduction.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Feta_reduction.rs?ref=a7f4d41a7d1aa8547df583bd0239a3e35c740018", "patch": "@@ -133,25 +133,30 @@ fn get_ufcs_type_name(\n     let actual_type_of_self = &cx.tables.node_type(self_arg.hir_id).sty;\n \n     if let Some(trait_id) = cx.tcx.trait_of_item(method_def_id) {\n-        //if the method expectes &self, ufcs requires explicit borrowing so closure can't be removed\n-        return match (expected_type_of_self, actual_type_of_self) {\n-            (ty::Ref(_, _, _), ty::Ref(_, _, _)) => Some(cx.tcx.item_path_str(trait_id)),\n-            (l, r) => match (l, r) {\n-                (ty::Ref(_, _, _), _) | (_, ty::Ref(_, _, _)) => None,\n-                (_, _) => Some(cx.tcx.item_path_str(trait_id)),\n-            },\n-        };\n+        if match_borrow_depth(expected_type_of_self, actual_type_of_self) {\n+            return Some(cx.tcx.item_path_str(trait_id));\n+        }\n     }\n \n     cx.tcx.impl_of_method(method_def_id).and_then(|_| {\n-        //a type may implicitly implement other types methods (e.g. Deref)\n+        //a type may implicitly implement other type's methods (e.g. Deref)\n         if match_types(expected_type_of_self, actual_type_of_self) {\n             return Some(get_type_name(cx, &actual_type_of_self));\n         }\n         None\n     })\n }\n \n+fn match_borrow_depth(lhs: &ty::TyKind<'_>, rhs: &ty::TyKind<'_>) -> bool {\n+    match (lhs, rhs) {\n+        (ty::Ref(_, t1, _), ty::Ref(_, t2, _)) => match_borrow_depth(&t1.sty, &t2.sty),\n+        (l, r) => match (l, r) {\n+            (ty::Ref(_, _, _), _) | (_, ty::Ref(_, _, _)) => false,\n+            (_, _) => true,\n+        },\n+    }\n+}\n+\n fn match_types(lhs: &ty::TyKind<'_>, rhs: &ty::TyKind<'_>) -> bool {\n     match (lhs, rhs) {\n         (ty::Bool, ty::Bool)"}, {"sha": "f777939c67d2f11261f32ebbafa88c6f1f061920", "filename": "tests/ui/eta.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/a7f4d41a7d1aa8547df583bd0239a3e35c740018/tests%2Fui%2Feta.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a7f4d41a7d1aa8547df583bd0239a3e35c740018/tests%2Fui%2Feta.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Feta.rs?ref=a7f4d41a7d1aa8547df583bd0239a3e35c740018", "patch": "@@ -88,6 +88,14 @@ fn test_redundant_closures_containing_method_calls() {\n     let c = Some(TestStruct { some_ref: &i })\n         .as_ref()\n         .map(|c| c.to_ascii_uppercase());\n+\n+    fn test_different_borrow_levels<T>(t: &[&T])\n+    where\n+        T: TestTrait,\n+    {\n+        t.iter().filter(|x| x.trait_foo_ref());\n+        t.iter().map(|x| x.trait_foo_ref());\n+    }\n }\n \n fn meta<F>(f: F)"}]}