{"sha": "2050812cad7905c33870c36362593360f7216310", "node_id": "MDY6Q29tbWl0NzI0NzEyOjIwNTA4MTJjYWQ3OTA1YzMzODcwYzM2MzYyNTkzMzYwZjcyMTYzMTA=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2018-11-01T10:15:11Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2018-11-01T10:15:11Z"}, "message": "remove SyntaxPtrDatabase", "tree": {"sha": "e329f4ca8a75790442dc5aa67bfa6e2599aedfe3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e329f4ca8a75790442dc5aa67bfa6e2599aedfe3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2050812cad7905c33870c36362593360f7216310", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2050812cad7905c33870c36362593360f7216310", "html_url": "https://github.com/rust-lang/rust/commit/2050812cad7905c33870c36362593360f7216310", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2050812cad7905c33870c36362593360f7216310/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2b210d98b8807e0dfd6762a2974388fca7ee1ee9", "url": "https://api.github.com/repos/rust-lang/rust/commits/2b210d98b8807e0dfd6762a2974388fca7ee1ee9", "html_url": "https://github.com/rust-lang/rust/commit/2b210d98b8807e0dfd6762a2974388fca7ee1ee9"}], "stats": {"total": 31, "additions": 12, "deletions": 19}, "files": [{"sha": "94fdd36a4ed6aa15bac41be92a70df41586590a5", "filename": "crates/ra_analysis/src/db.rs", "status": "modified", "additions": 9, "deletions": 5, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/2050812cad7905c33870c36362593360f7216310/crates%2Fra_analysis%2Fsrc%2Fdb.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2050812cad7905c33870c36362593360f7216310/crates%2Fra_analysis%2Fsrc%2Fdb.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_analysis%2Fsrc%2Fdb.rs?ref=2050812cad7905c33870c36362593360f7216310", "patch": "@@ -1,7 +1,7 @@\n use std::sync::Arc;\n \n use ra_editor::LineIndex;\n-use ra_syntax::File;\n+use ra_syntax::{File, SyntaxNode};\n use salsa;\n \n use crate::{\n@@ -11,7 +11,7 @@ use crate::{\n         SubmodulesQuery,\n     },\n     symbol_index::SymbolIndex,\n-    syntax_ptr::{ResolveSyntaxPtrQuery, SyntaxPtrDatabase},\n+    syntax_ptr::SyntaxPtr,\n     Cancelable, Canceled, FileId,\n };\n \n@@ -62,6 +62,7 @@ salsa::database_storage! {\n             fn file_syntax() for FileSyntaxQuery;\n             fn file_lines() for FileLinesQuery;\n             fn file_symbols() for FileSymbolsQuery;\n+            fn resolve_syntax_ptr() for ResolveSyntaxPtrQuery;\n         }\n         impl DescriptorDatabase {\n             fn module_tree() for ModuleTreeQuery;\n@@ -70,9 +71,6 @@ salsa::database_storage! {\n             fn fn_syntax() for FnSyntaxQuery;\n             fn fn_scopes() for FnScopesQuery;\n         }\n-        impl SyntaxPtrDatabase {\n-            fn resolve_syntax_ptr() for ResolveSyntaxPtrQuery;\n-        }\n     }\n }\n \n@@ -87,6 +85,12 @@ salsa::query_group! {\n         fn file_symbols(file_id: FileId) -> Cancelable<Arc<SymbolIndex>> {\n             type FileSymbolsQuery;\n         }\n+        fn resolve_syntax_ptr(ptr: SyntaxPtr) -> SyntaxNode {\n+            type ResolveSyntaxPtrQuery;\n+            // Don't retain syntax trees in memory\n+            storage volatile;\n+            use fn crate::syntax_ptr::resolve_syntax_ptr;\n+        }\n     }\n }\n "}, {"sha": "eaeef54c1e63dc11e5dbd45d4eb86adf28265ec9", "filename": "crates/ra_analysis/src/descriptors/mod.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/2050812cad7905c33870c36362593360f7216310/crates%2Fra_analysis%2Fsrc%2Fdescriptors%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2050812cad7905c33870c36362593360f7216310/crates%2Fra_analysis%2Fsrc%2Fdescriptors%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_analysis%2Fsrc%2Fdescriptors%2Fmod.rs?ref=2050812cad7905c33870c36362593360f7216310", "patch": "@@ -13,12 +13,12 @@ use crate::{\n     descriptors::function::{resolve_local_name, FnId, FnScopes},\n     descriptors::module::{ModuleId, ModuleScope, ModuleTree},\n     input::SourceRootId,\n-    syntax_ptr::{LocalSyntaxPtr, SyntaxPtrDatabase},\n+    syntax_ptr::LocalSyntaxPtr,\n     Cancelable, FileId,\n };\n \n salsa::query_group! {\n-    pub(crate) trait DescriptorDatabase: SyntaxDatabase + SyntaxPtrDatabase {\n+    pub(crate) trait DescriptorDatabase: SyntaxDatabase {\n         fn module_tree(source_root_id: SourceRootId) -> Cancelable<Arc<ModuleTree>> {\n             type ModuleTreeQuery;\n             use fn module::imp::module_tree;"}, {"sha": "0744ea9c8dae43ae73b6b22eeb7ca1c573e55f18", "filename": "crates/ra_analysis/src/imp.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/2050812cad7905c33870c36362593360f7216310/crates%2Fra_analysis%2Fsrc%2Fimp.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2050812cad7905c33870c36362593360f7216310/crates%2Fra_analysis%2Fsrc%2Fimp.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_analysis%2Fsrc%2Fimp.rs?ref=2050812cad7905c33870c36362593360f7216310", "patch": "@@ -25,7 +25,6 @@ use crate::{\n     },\n     input::{FilesDatabase, SourceRoot, SourceRootId, WORKSPACE},\n     symbol_index::SymbolIndex,\n-    syntax_ptr::SyntaxPtrDatabase,\n     AnalysisChange, Cancelable, CrateGraph, CrateId, Diagnostic, FileId, FileResolver,\n     FileSystemEdit, Position, Query, SourceChange, SourceFileEdit,\n };"}, {"sha": "4db1529c2c47604a26237cdf7c36f9ed881dfdaf", "filename": "crates/ra_analysis/src/syntax_ptr.rs", "status": "modified", "additions": 1, "deletions": 11, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/2050812cad7905c33870c36362593360f7216310/crates%2Fra_analysis%2Fsrc%2Fsyntax_ptr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2050812cad7905c33870c36362593360f7216310/crates%2Fra_analysis%2Fsrc%2Fsyntax_ptr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_analysis%2Fsrc%2Fsyntax_ptr.rs?ref=2050812cad7905c33870c36362593360f7216310", "patch": "@@ -3,17 +3,7 @@ use ra_syntax::{File, SyntaxKind, SyntaxNode, SyntaxNodeRef, TextRange};\n use crate::db::SyntaxDatabase;\n use crate::FileId;\n \n-salsa::query_group! {\n-    pub(crate) trait SyntaxPtrDatabase: SyntaxDatabase {\n-        fn resolve_syntax_ptr(ptr: SyntaxPtr) -> SyntaxNode {\n-            type ResolveSyntaxPtrQuery;\n-            // Don't retain syntax trees in memory\n-            storage volatile;\n-        }\n-    }\n-}\n-\n-fn resolve_syntax_ptr(db: &impl SyntaxDatabase, ptr: SyntaxPtr) -> SyntaxNode {\n+pub(crate) fn resolve_syntax_ptr(db: &impl SyntaxDatabase, ptr: SyntaxPtr) -> SyntaxNode {\n     let syntax = db.file_syntax(ptr.file_id);\n     ptr.local.resolve(&syntax)\n }"}]}