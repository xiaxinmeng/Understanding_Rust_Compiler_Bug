{"sha": "857c03df079f919ddc0ea1c7c0a24313a66f2e2f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg1N2MwM2RmMDc5ZjkxOWRkYzBlYTFjN2MwYTI0MzEzYTY2ZjJlMmY=", "commit": {"author": {"name": "Edwin Cheng", "email": "edwin0cheng@gmail.com", "date": "2020-04-09T20:09:11Z"}, "committer": {"name": "Edwin Cheng", "email": "edwin0cheng@gmail.com", "date": "2020-04-09T20:09:11Z"}, "message": "Fix macos symbol name bug", "tree": {"sha": "426229baf4ec6e26567c3892a97d04f376ac4330", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/426229baf4ec6e26567c3892a97d04f376ac4330"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/857c03df079f919ddc0ea1c7c0a24313a66f2e2f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/857c03df079f919ddc0ea1c7c0a24313a66f2e2f", "html_url": "https://github.com/rust-lang/rust/commit/857c03df079f919ddc0ea1c7c0a24313a66f2e2f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/857c03df079f919ddc0ea1c7c0a24313a66f2e2f/comments", "author": {"login": "edwin0cheng", "id": 11014119, "node_id": "MDQ6VXNlcjExMDE0MTE5", "avatar_url": "https://avatars.githubusercontent.com/u/11014119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/edwin0cheng", "html_url": "https://github.com/edwin0cheng", "followers_url": "https://api.github.com/users/edwin0cheng/followers", "following_url": "https://api.github.com/users/edwin0cheng/following{/other_user}", "gists_url": "https://api.github.com/users/edwin0cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/edwin0cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/edwin0cheng/subscriptions", "organizations_url": "https://api.github.com/users/edwin0cheng/orgs", "repos_url": "https://api.github.com/users/edwin0cheng/repos", "events_url": "https://api.github.com/users/edwin0cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/edwin0cheng/received_events", "type": "User", "site_admin": false}, "committer": {"login": "edwin0cheng", "id": 11014119, "node_id": "MDQ6VXNlcjExMDE0MTE5", "avatar_url": "https://avatars.githubusercontent.com/u/11014119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/edwin0cheng", "html_url": "https://github.com/edwin0cheng", "followers_url": "https://api.github.com/users/edwin0cheng/followers", "following_url": "https://api.github.com/users/edwin0cheng/following{/other_user}", "gists_url": "https://api.github.com/users/edwin0cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/edwin0cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/edwin0cheng/subscriptions", "organizations_url": "https://api.github.com/users/edwin0cheng/orgs", "repos_url": "https://api.github.com/users/edwin0cheng/repos", "events_url": "https://api.github.com/users/edwin0cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/edwin0cheng/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "197039b9fe2b14fbaa81cae18fff855625f07def", "url": "https://api.github.com/repos/rust-lang/rust/commits/197039b9fe2b14fbaa81cae18fff855625f07def", "html_url": "https://github.com/rust-lang/rust/commit/197039b9fe2b14fbaa81cae18fff855625f07def"}], "stats": {"total": 20, "additions": 19, "deletions": 1}, "files": [{"sha": "eca9c85763789753a7fecfa611367d0438a55ab2", "filename": "crates/ra_proc_macro_srv/src/dylib.rs", "status": "modified", "additions": 19, "deletions": 1, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/857c03df079f919ddc0ea1c7c0a24313a66f2e2f/crates%2Fra_proc_macro_srv%2Fsrc%2Fdylib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/857c03df079f919ddc0ea1c7c0a24313a66f2e2f/crates%2Fra_proc_macro_srv%2Fsrc%2Fdylib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_proc_macro_srv%2Fsrc%2Fdylib.rs?ref=857c03df079f919ddc0ea1c7c0a24313a66f2e2f", "patch": "@@ -57,10 +57,28 @@ fn is_derive_registrar_symbol(symbol: &str) -> bool {\n     symbol.contains(NEW_REGISTRAR_SYMBOL)\n }\n \n+#[cfg(not(target_os = \"macos\"))]\n+fn adjust_symbol_name(name: &str) -> String {\n+    name.to_string()\n+}\n+\n+#[cfg(target_os = \"macos\")]\n+fn adjust_symbol_name(s: &str) -> String {\n+    // In macos doc:\n+    // https://developer.apple.com/library/archive/documentation/System/Conceptual/ManPages_iPhoneOS/man3/dlsym.3.html\n+    // Unlike other dyld API's, the symbol name passed to dlsym() must NOT be\n+    // prepended with an underscore.\n+    if s.starts_with(\"_\") {\n+        s[1..s.len()].to_string()\n+    } else {\n+        s.to_string()\n+    }\n+}\n+\n fn find_registrar_symbol(file: &Path) -> Option<String> {\n     let symbols = get_symbols_from_lib(file)?;\n \n-    symbols.iter().find(|s| is_derive_registrar_symbol(s)).map(|s| s.to_string())\n+    symbols.iter().find(|s| is_derive_registrar_symbol(s)).map(|s| adjust_symbol_name(&s))\n }\n \n /// Loads dynamic library in platform dependent manner."}]}