{"sha": "6a88311373bf18b272aed98d3032852cfcec4455", "node_id": "C_kwDOAAsO6NoAKDZhODgzMTEzNzNiZjE4YjI3MmFlZDk4ZDMwMzI4NTJjZmNlYzQ0NTU", "commit": {"author": {"name": "Andy Caldwell", "email": "andrew.caldwell@metaswitch.com", "date": "2021-11-01T18:38:11Z"}, "committer": {"name": "Andy Caldwell", "email": "andrew.caldwell@metaswitch.com", "date": "2021-11-01T18:38:11Z"}, "message": "Check for -static-pie support before testing support", "tree": {"sha": "7555506ea1a720800d87b1f47b7d50b9a05e07e8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7555506ea1a720800d87b1f47b7d50b9a05e07e8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6a88311373bf18b272aed98d3032852cfcec4455", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEELWwNBns7iQWuaaaA1CBFQawdIo0FAmGANF4ACgkQ1CBFQawd\nIo3XshAAnzB3LEjshJNKbWXpZaqBoVNCHouCngP3O9c1VYO43pB4JEN6tkLgBmeh\nen1be3717k1lDdTzhwN7MWkK0+VpK9eVNSouCf3TD6GG5jLIAn0uk2hIkWuKRlA6\nT3jmPKmilw5rnh+hOeMliThbyov+xa8hrDHwstRBbqy4e32lnJ+8mi9z6xIMBMIf\nWSta27ssKoIOm3cp43YUbOG7/SnsljgEMaivRJs0cspbGMdZlU0Xbb5WZY3RtS6Z\nybVjwnxGHN1V7WpWojHEMj9SWfN+4iuzBJlld1t+by5I4/fd5K3E3fLHuNzFdR4s\n+w57U2v2qeePCQ2o941hzbMlok/LyT4thNYDMVoum7/I6AgB9FpcKqJmIideqLz9\nqVC3oho33NHxQWNAH6+utCqI75PufdGjnUgOaqr2xyXU06BsqDtrc63zUt+30AmR\ndGYJVhUnA5QbejDTNFWLQ6RaGj6XlPV1VwYii1/h0NPx228jSAF0Q5Ku4wEF/UTn\nDVHG/N3w1fS+pexGySps8S4zN/rot39XGwJsJuMwtLvPkXWuxYjUwo1socu04uNL\nJ0x9P1pw/zlfFP9KSQTwAUz47+pORroRgixC8IjQyS5oF4RDv+MRZwR9jr+wlmbe\nDEDHmYpTfDcrjgA10vvkYE/MiQLkPx1BLLN0EpjZSZbyrMJm1LU=\n=Btf5\n-----END PGP SIGNATURE-----", "payload": "tree 7555506ea1a720800d87b1f47b7d50b9a05e07e8\nparent b94da2bace66b4ba5485363ac7ba4fe85ad41578\nauthor Andy Caldwell <andrew.caldwell@metaswitch.com> 1635791891 +0000\ncommitter Andy Caldwell <andrew.caldwell@metaswitch.com> 1635791891 +0000\n\nCheck for -static-pie support before testing support\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6a88311373bf18b272aed98d3032852cfcec4455", "html_url": "https://github.com/rust-lang/rust/commit/6a88311373bf18b272aed98d3032852cfcec4455", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6a88311373bf18b272aed98d3032852cfcec4455/comments", "author": {"login": "bossmc", "id": 1073983, "node_id": "MDQ6VXNlcjEwNzM5ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1073983?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bossmc", "html_url": "https://github.com/bossmc", "followers_url": "https://api.github.com/users/bossmc/followers", "following_url": "https://api.github.com/users/bossmc/following{/other_user}", "gists_url": "https://api.github.com/users/bossmc/gists{/gist_id}", "starred_url": "https://api.github.com/users/bossmc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bossmc/subscriptions", "organizations_url": "https://api.github.com/users/bossmc/orgs", "repos_url": "https://api.github.com/users/bossmc/repos", "events_url": "https://api.github.com/users/bossmc/events{/privacy}", "received_events_url": "https://api.github.com/users/bossmc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bossmc", "id": 1073983, "node_id": "MDQ6VXNlcjEwNzM5ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1073983?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bossmc", "html_url": "https://github.com/bossmc", "followers_url": "https://api.github.com/users/bossmc/followers", "following_url": "https://api.github.com/users/bossmc/following{/other_user}", "gists_url": "https://api.github.com/users/bossmc/gists{/gist_id}", "starred_url": "https://api.github.com/users/bossmc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bossmc/subscriptions", "organizations_url": "https://api.github.com/users/bossmc/orgs", "repos_url": "https://api.github.com/users/bossmc/repos", "events_url": "https://api.github.com/users/bossmc/events{/privacy}", "received_events_url": "https://api.github.com/users/bossmc/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b94da2bace66b4ba5485363ac7ba4fe85ad41578", "url": "https://api.github.com/repos/rust-lang/rust/commits/b94da2bace66b4ba5485363ac7ba4fe85ad41578", "html_url": "https://github.com/rust-lang/rust/commit/b94da2bace66b4ba5485363ac7ba4fe85ad41578"}], "stats": {"total": 57, "additions": 49, "deletions": 8}, "files": [{"sha": "945ec1724ac041b4d1b16b585fe3df2509c01715", "filename": "src/test/run-make/static-pie/Makefile", "status": "modified", "additions": 9, "deletions": 8, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/6a88311373bf18b272aed98d3032852cfcec4455/src%2Ftest%2Frun-make%2Fstatic-pie%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/6a88311373bf18b272aed98d3032852cfcec4455/src%2Ftest%2Frun-make%2Fstatic-pie%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fstatic-pie%2FMakefile?ref=6a88311373bf18b272aed98d3032852cfcec4455", "patch": "@@ -7,11 +7,12 @@\n # How to manually run this\n # $ ./x.py test --target x86_64-unknown-linux-[musl,gnu] src/test/run-make/static-pie\n \n-all:\n-\t$(RUSTC) --target $(TARGET) -C target-feature=+crt-static test-aslr.rs\n-\t# Check that no dynamic interpreter is set\n-\t! readelf -l $(call RUN_BINFILE,test-aslr) | $(CGREP) INTERP\n-\t# Check that we have a dynamic executable\n-\treadelf -l $(call RUN_BINFILE,test-aslr) | $(CGREP) DYNAMIC\n-\t# Check for address space layout randomization\n-\t$(call RUN,test-aslr) --test-aslr\n+all: test-clang test-gcc\n+\n+test-%:\n+\tif ./check_$*_version.sh; then\\\n+\t\t${RUSTC} -Clinker=$* -Clinker-flavor=gcc --target ${TARGET} -C target-feature=+crt-static test-aslr.rs; \\\n+\t\t! readelf -l $(call RUN_BINFILE,test-aslr) | $(CGREP) INTERP; \\\n+\t\treadelf -l $(call RUN_BINFILE,test-aslr) | $(CGREP) DYNAMIC; \\\n+\t\t$(call RUN,test-aslr) --test-aslr; \\\n+\tfi"}, {"sha": "b8e97c3da7d77b5ed4356702951eda5614a3fa35", "filename": "src/test/run-make/static-pie/check_clang_version.sh", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/6a88311373bf18b272aed98d3032852cfcec4455/src%2Ftest%2Frun-make%2Fstatic-pie%2Fcheck_clang_version.sh", "raw_url": "https://github.com/rust-lang/rust/raw/6a88311373bf18b272aed98d3032852cfcec4455/src%2Ftest%2Frun-make%2Fstatic-pie%2Fcheck_clang_version.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fstatic-pie%2Fcheck_clang_version.sh?ref=6a88311373bf18b272aed98d3032852cfcec4455", "patch": "@@ -0,0 +1,20 @@\n+#!/bin/bash\n+\n+set -euo pipefail\n+\n+if command -v clang > /dev/null\n+then\n+  CLANG_VERSION=$(echo __clang_major__ | clang -E -x c - | grep -v -e '^#' )\n+  echo \"clang version $CLANG_VERSION detected\"\n+  if (( $CLANG_VERSION >= 9 ))\n+  then\n+    echo \"clang supports -static-pie\"\n+    exit 0\n+  else\n+    echo \"clang too old to support -static-pie, skipping test\"\n+    exit 1\n+  fi\n+else\n+  echo \"No clang version detected\"\n+  exit 2\n+fi"}, {"sha": "d07e1d151dfb8b91804cf5084a0f688a2f3c5208", "filename": "src/test/run-make/static-pie/check_gcc_version.sh", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/6a88311373bf18b272aed98d3032852cfcec4455/src%2Ftest%2Frun-make%2Fstatic-pie%2Fcheck_gcc_version.sh", "raw_url": "https://github.com/rust-lang/rust/raw/6a88311373bf18b272aed98d3032852cfcec4455/src%2Ftest%2Frun-make%2Fstatic-pie%2Fcheck_gcc_version.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fstatic-pie%2Fcheck_gcc_version.sh?ref=6a88311373bf18b272aed98d3032852cfcec4455", "patch": "@@ -0,0 +1,20 @@\n+#!/bin/bash\n+\n+set -euo pipefail\n+\n+if command -v gcc > /dev/null\n+then\n+  GCC_VERSION=$(echo __GNUC__ | gcc -E -x c - | grep -v -e '^#' )\n+  echo \"gcc version $GCC_VERSION detected\"\n+  if (( $GCC_VERSION >= 8 ))\n+  then\n+    echo \"gcc supports -static-pie\"\n+    exit 0\n+  else\n+    echo \"gcc too old to support -static-pie, skipping test\"\n+    exit 1\n+  fi\n+else\n+  echo \"No gcc version detected\"\n+  exit 2\n+fi"}]}