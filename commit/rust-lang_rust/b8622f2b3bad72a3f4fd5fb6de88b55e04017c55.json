{"sha": "b8622f2b3bad72a3f4fd5fb6de88b55e04017c55", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI4NjIyZjJiM2JhZDcyYTNmNGZkNWZiNmRlODhiNTVlMDQwMTdjNTU=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2021-03-15T15:22:51Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-03-15T15:22:51Z"}, "message": "Rollup merge of #83054 - tmiasko:rustc_layout_scalar_valid_range, r=davidtwco\n\nValidate rustc_layout_scalar_valid_range_{start,end} attributes\n\nFixes #82251, fixes #82981.", "tree": {"sha": "3bfab8a217e34363add6ca7ed2b6b86d4f0e2f68", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3bfab8a217e34363add6ca7ed2b6b86d4f0e2f68"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b8622f2b3bad72a3f4fd5fb6de88b55e04017c55", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgT3vLCRBK7hj4Ov3rIwAAdHIIALF1t2nIlMMlQ5UC5WX+lUly\nYFo6CH0SPzLG2oDWO4B7+//GWY353KLcOHgQvy3d+sPLB0ZUplGnSaLBL2yJiDaY\nWvgOYgVzF2DPcNdihbS0cTVIF7TyhVyTfrIjdlwsfGGs8ZX6kniUP5hCD61SEk4q\nqM9blH90F4R3XEei6XtytxIvdC9iqpHUUPs0lxl9w6ppJq0BF9pU8ge8EYTMpsZV\n7x96tknfSrZT3i7qnqfk9FatsZpbCFnLClV7nWXUrL9xXkAlksayicT/PsvMSA/h\noB34ErJCp6fTZOdnjyPbvBHtZ/tgrutq1oDlQBKT82q8jxVnF2sS/yw8ul+K7Qk=\n=h2lp\n-----END PGP SIGNATURE-----\n", "payload": "tree 3bfab8a217e34363add6ca7ed2b6b86d4f0e2f68\nparent 4eca4929ec77b34a274a3090310247a1ec485953\nparent 49431909a6a8ccb915302d57c869e86d2a576af6\nauthor Dylan DPC <dylan.dpc@gmail.com> 1615821771 +0100\ncommitter GitHub <noreply@github.com> 1615821771 +0100\n\nRollup merge of #83054 - tmiasko:rustc_layout_scalar_valid_range, r=davidtwco\n\nValidate rustc_layout_scalar_valid_range_{start,end} attributes\n\nFixes #82251, fixes #82981.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b8622f2b3bad72a3f4fd5fb6de88b55e04017c55", "html_url": "https://github.com/rust-lang/rust/commit/b8622f2b3bad72a3f4fd5fb6de88b55e04017c55", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b8622f2b3bad72a3f4fd5fb6de88b55e04017c55/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4eca4929ec77b34a274a3090310247a1ec485953", "url": "https://api.github.com/repos/rust-lang/rust/commits/4eca4929ec77b34a274a3090310247a1ec485953", "html_url": "https://github.com/rust-lang/rust/commit/4eca4929ec77b34a274a3090310247a1ec485953"}, {"sha": "49431909a6a8ccb915302d57c869e86d2a576af6", "url": "https://api.github.com/repos/rust-lang/rust/commits/49431909a6a8ccb915302d57c869e86d2a576af6", "html_url": "https://github.com/rust-lang/rust/commit/49431909a6a8ccb915302d57c869e86d2a576af6"}], "stats": {"total": 92, "additions": 91, "deletions": 1}, "files": [{"sha": "40b0cefd83aa6eed57093418bbf46d659cb49361", "filename": "compiler/rustc_ast/src/attr/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/b8622f2b3bad72a3f4fd5fb6de88b55e04017c55/compiler%2Frustc_ast%2Fsrc%2Fattr%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b8622f2b3bad72a3f4fd5fb6de88b55e04017c55/compiler%2Frustc_ast%2Fsrc%2Fattr%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast%2Fsrc%2Fattr%2Fmod.rs?ref=b8622f2b3bad72a3f4fd5fb6de88b55e04017c55", "patch": "@@ -120,6 +120,7 @@ impl NestedMetaItem {\n }\n \n impl Attribute {\n+    #[inline]\n     pub fn has_name(&self, name: Symbol) -> bool {\n         match self.kind {\n             AttrKind::Normal(ref item, _) => item.path == name,"}, {"sha": "ae8883754d6f2465163785c74c1791dd6749a87d", "filename": "compiler/rustc_passes/src/check_attr.rs", "status": "modified", "additions": 36, "deletions": 1, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/b8622f2b3bad72a3f4fd5fb6de88b55e04017c55/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b8622f2b3bad72a3f4fd5fb6de88b55e04017c55/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs?ref=b8622f2b3bad72a3f4fd5fb6de88b55e04017c55", "patch": "@@ -8,7 +8,7 @@ use rustc_middle::hir::map::Map;\n use rustc_middle::ty::query::Providers;\n use rustc_middle::ty::TyCtxt;\n \n-use rustc_ast::{Attribute, LitKind, NestedMetaItem};\n+use rustc_ast::{Attribute, Lit, LitKind, NestedMetaItem};\n use rustc_errors::{pluralize, struct_span_err};\n use rustc_hir as hir;\n use rustc_hir::def_id::LocalDefId;\n@@ -87,6 +87,10 @@ impl CheckAttrVisitor<'tcx> {\n                 self.check_export_name(hir_id, &attr, span, target)\n             } else if self.tcx.sess.check_name(attr, sym::rustc_args_required_const) {\n                 self.check_rustc_args_required_const(&attr, span, target, item)\n+            } else if self.tcx.sess.check_name(attr, sym::rustc_layout_scalar_valid_range_start) {\n+                self.check_rustc_layout_scalar_valid_range(&attr, span, target)\n+            } else if self.tcx.sess.check_name(attr, sym::rustc_layout_scalar_valid_range_end) {\n+                self.check_rustc_layout_scalar_valid_range(&attr, span, target)\n             } else if self.tcx.sess.check_name(attr, sym::allow_internal_unstable) {\n                 self.check_allow_internal_unstable(hir_id, &attr, span, target, &attrs)\n             } else if self.tcx.sess.check_name(attr, sym::rustc_allow_const_fn_unstable) {\n@@ -807,6 +811,37 @@ impl CheckAttrVisitor<'tcx> {\n         }\n     }\n \n+    fn check_rustc_layout_scalar_valid_range(\n+        &self,\n+        attr: &Attribute,\n+        span: &Span,\n+        target: Target,\n+    ) -> bool {\n+        if target != Target::Struct {\n+            self.tcx\n+                .sess\n+                .struct_span_err(attr.span, \"attribute should be applied to a struct\")\n+                .span_label(*span, \"not a struct\")\n+                .emit();\n+            return false;\n+        }\n+\n+        let list = match attr.meta_item_list() {\n+            None => return false,\n+            Some(it) => it,\n+        };\n+\n+        if matches!(&list[..], &[NestedMetaItem::Literal(Lit { kind: LitKind::Int(..), .. })]) {\n+            true\n+        } else {\n+            self.tcx\n+                .sess\n+                .struct_span_err(attr.span, \"expected exactly one integer literal argument\")\n+                .emit();\n+            false\n+        }\n+    }\n+\n     /// Checks if `#[rustc_legacy_const_generics]` is applied to a function and has a valid argument.\n     fn check_rustc_legacy_const_generics(\n         &self,"}, {"sha": "25fe4be660b2428d2a408fe80ef8952415d72f75", "filename": "src/test/ui/invalid/invalid_rustc_layout_scalar_valid_range.rs", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/b8622f2b3bad72a3f4fd5fb6de88b55e04017c55/src%2Ftest%2Fui%2Finvalid%2Finvalid_rustc_layout_scalar_valid_range.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b8622f2b3bad72a3f4fd5fb6de88b55e04017c55/src%2Ftest%2Fui%2Finvalid%2Finvalid_rustc_layout_scalar_valid_range.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Finvalid%2Finvalid_rustc_layout_scalar_valid_range.rs?ref=b8622f2b3bad72a3f4fd5fb6de88b55e04017c55", "patch": "@@ -0,0 +1,23 @@\n+#![feature(rustc_attrs)]\n+\n+#[rustc_layout_scalar_valid_range_start(u32::MAX)] //~ ERROR\n+pub struct A(u32);\n+\n+#[rustc_layout_scalar_valid_range_end(1, 2)] //~ ERROR\n+pub struct B(u8);\n+\n+#[rustc_layout_scalar_valid_range_end(a = \"a\")] //~ ERROR\n+pub struct C(i32);\n+\n+#[rustc_layout_scalar_valid_range_end(1)] //~ ERROR\n+enum E {\n+    X = 1,\n+    Y = 14,\n+}\n+\n+fn main() {\n+    let _ = A(0);\n+    let _ = B(0);\n+    let _ = C(0);\n+    let _ = E::X;\n+}"}, {"sha": "7e95fedebdfc6bae872f1a4aadd9cfadd46c466a", "filename": "src/test/ui/invalid/invalid_rustc_layout_scalar_valid_range.stderr", "status": "added", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/b8622f2b3bad72a3f4fd5fb6de88b55e04017c55/src%2Ftest%2Fui%2Finvalid%2Finvalid_rustc_layout_scalar_valid_range.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b8622f2b3bad72a3f4fd5fb6de88b55e04017c55/src%2Ftest%2Fui%2Finvalid%2Finvalid_rustc_layout_scalar_valid_range.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Finvalid%2Finvalid_rustc_layout_scalar_valid_range.stderr?ref=b8622f2b3bad72a3f4fd5fb6de88b55e04017c55", "patch": "@@ -0,0 +1,31 @@\n+error: expected exactly one integer literal argument\n+  --> $DIR/invalid_rustc_layout_scalar_valid_range.rs:3:1\n+   |\n+LL | #[rustc_layout_scalar_valid_range_start(u32::MAX)]\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: expected exactly one integer literal argument\n+  --> $DIR/invalid_rustc_layout_scalar_valid_range.rs:6:1\n+   |\n+LL | #[rustc_layout_scalar_valid_range_end(1, 2)]\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: expected exactly one integer literal argument\n+  --> $DIR/invalid_rustc_layout_scalar_valid_range.rs:9:1\n+   |\n+LL | #[rustc_layout_scalar_valid_range_end(a = \"a\")]\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: attribute should be applied to a struct\n+  --> $DIR/invalid_rustc_layout_scalar_valid_range.rs:12:1\n+   |\n+LL |   #[rustc_layout_scalar_valid_range_end(1)]\n+   |   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+LL | / enum E {\n+LL | |     X = 1,\n+LL | |     Y = 14,\n+LL | | }\n+   | |_- not a struct\n+\n+error: aborting due to 4 previous errors\n+"}]}