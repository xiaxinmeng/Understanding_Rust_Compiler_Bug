{"sha": "291385b3e0765308ec9f9faf9796e6b534a4224b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI5MTM4NWIzZTA3NjUzMDhlYzlmOWZhZjk3OTZlNmI1MzRhNDIyNGI=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-05-26T15:10:35Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-05-26T15:10:35Z"}, "message": "Auto merge of #5609 - phansch:empty-line-after-outer-attr-fix, r=flip1995\n\nMake empty_line_after_outer_attr an early lint\n\nFixes #5567\n\nUnfortunately I couldn't find a way to reproduce the issue without syn/quote. Considering that most real-world macros use syn and/or quote, I think it's okay to pull them in anyway.\n\nchangelog: Fix false positive in [`empty_line_after_outer_attr`]", "tree": {"sha": "16cb68fcff8100b333e5c9f8f4e696d62ff7950d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/16cb68fcff8100b333e5c9f8f4e696d62ff7950d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/291385b3e0765308ec9f9faf9796e6b534a4224b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/291385b3e0765308ec9f9faf9796e6b534a4224b", "html_url": "https://github.com/rust-lang/rust/commit/291385b3e0765308ec9f9faf9796e6b534a4224b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/291385b3e0765308ec9f9faf9796e6b534a4224b/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a00025ab210f62949048b35db40cab924bcc1f91", "url": "https://api.github.com/repos/rust-lang/rust/commits/a00025ab210f62949048b35db40cab924bcc1f91", "html_url": "https://github.com/rust-lang/rust/commit/a00025ab210f62949048b35db40cab924bcc1f91"}, {"sha": "fd86b3150e21df8eb6fee2f0c8b69f323146ffad", "url": "https://api.github.com/repos/rust-lang/rust/commits/fd86b3150e21df8eb6fee2f0c8b69f323146ffad", "html_url": "https://github.com/rust-lang/rust/commit/fd86b3150e21df8eb6fee2f0c8b69f323146ffad"}], "stats": {"total": 147, "additions": 107, "deletions": 40}, "files": [{"sha": "76baf27fb2dbfad8f5ab38416e93c4eb6faaf09d", "filename": "clippy_lints/Cargo.toml", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/291385b3e0765308ec9f9faf9796e6b534a4224b/clippy_lints%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/291385b3e0765308ec9f9faf9796e6b534a4224b/clippy_lints%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2FCargo.toml?ref=291385b3e0765308ec9f9faf9796e6b534a4224b", "patch": "@@ -32,6 +32,8 @@ semver = \"0.9.0\"\n # NOTE: cargo requires serde feat in its url dep\n # see <https://github.com/rust-lang/rust/pull/63587#issuecomment-522343864>\n url = { version =  \"2.1.0\", features = [\"serde\"] }\n+quote = \"1\"\n+syn = { version = \"1\", features = [\"full\"] }\n \n [features]\n deny-warnings = []"}, {"sha": "41f125d48398fd4aba769e031d601631215715b3", "filename": "clippy_lints/src/attrs.rs", "status": "modified", "additions": 43, "deletions": 32, "changes": 75, "blob_url": "https://github.com/rust-lang/rust/blob/291385b3e0765308ec9f9faf9796e6b534a4224b/clippy_lints%2Fsrc%2Fattrs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/291385b3e0765308ec9f9faf9796e6b534a4224b/clippy_lints%2Fsrc%2Fattrs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fattrs.rs?ref=291385b3e0765308ec9f9faf9796e6b534a4224b", "patch": "@@ -248,7 +248,6 @@ declare_lint_pass!(Attributes => [\n     INLINE_ALWAYS,\n     DEPRECATED_SEMVER,\n     USELESS_ATTRIBUTE,\n-    EMPTY_LINE_AFTER_OUTER_ATTR,\n     UNKNOWN_CLIPPY_LINTS,\n ]);\n \n@@ -480,36 +479,6 @@ fn check_attrs(cx: &LateContext<'_, '_>, span: Span, name: Name, attrs: &[Attrib\n     }\n \n     for attr in attrs {\n-        let attr_item = if let AttrKind::Normal(ref attr) = attr.kind {\n-            attr\n-        } else {\n-            continue;\n-        };\n-\n-        if attr.style == AttrStyle::Outer {\n-            if attr_item.args.inner_tokens().is_empty() || !is_present_in_source(cx, attr.span) {\n-                return;\n-            }\n-\n-            let begin_of_attr_to_item = Span::new(attr.span.lo(), span.lo(), span.ctxt());\n-            let end_of_attr_to_item = Span::new(attr.span.hi(), span.lo(), span.ctxt());\n-\n-            if let Some(snippet) = snippet_opt(cx, end_of_attr_to_item) {\n-                let lines = snippet.split('\\n').collect::<Vec<_>>();\n-                let lines = without_block_comments(lines);\n-\n-                if lines.iter().filter(|l| l.trim().is_empty()).count() > 2 {\n-                    span_lint(\n-                        cx,\n-                        EMPTY_LINE_AFTER_OUTER_ATTR,\n-                        begin_of_attr_to_item,\n-                        \"Found an empty line after an outer attribute. \\\n-                         Perhaps you forgot to add a `!` to make it an inner attribute?\",\n-                    );\n-                }\n-            }\n-        }\n-\n         if let Some(values) = attr.meta_item_list() {\n             if values.len() != 1 || !attr.check_name(sym!(inline)) {\n                 continue;\n@@ -551,15 +520,57 @@ fn is_word(nmi: &NestedMetaItem, expected: Symbol) -> bool {\n     }\n }\n \n-declare_lint_pass!(EarlyAttributes => [DEPRECATED_CFG_ATTR, MISMATCHED_TARGET_OS]);\n+declare_lint_pass!(EarlyAttributes => [\n+    DEPRECATED_CFG_ATTR,\n+    MISMATCHED_TARGET_OS,\n+    EMPTY_LINE_AFTER_OUTER_ATTR,\n+]);\n \n impl EarlyLintPass for EarlyAttributes {\n+    fn check_item(&mut self, cx: &EarlyContext<'_>, item: &rustc_ast::ast::Item) {\n+        check_empty_line_after_outer_attr(cx, item);\n+    }\n+\n     fn check_attribute(&mut self, cx: &EarlyContext<'_>, attr: &Attribute) {\n         check_deprecated_cfg_attr(cx, attr);\n         check_mismatched_target_os(cx, attr);\n     }\n }\n \n+fn check_empty_line_after_outer_attr(cx: &EarlyContext<'_>, item: &rustc_ast::ast::Item) {\n+    for attr in &item.attrs {\n+        let attr_item = if let AttrKind::Normal(ref attr) = attr.kind {\n+            attr\n+        } else {\n+            return;\n+        };\n+\n+        if attr.style == AttrStyle::Outer {\n+            if attr_item.args.inner_tokens().is_empty() || !is_present_in_source(cx, attr.span) {\n+                return;\n+            }\n+\n+            let begin_of_attr_to_item = Span::new(attr.span.lo(), item.span.lo(), item.span.ctxt());\n+            let end_of_attr_to_item = Span::new(attr.span.hi(), item.span.lo(), item.span.ctxt());\n+\n+            if let Some(snippet) = snippet_opt(cx, end_of_attr_to_item) {\n+                let lines = snippet.split('\\n').collect::<Vec<_>>();\n+                let lines = without_block_comments(lines);\n+\n+                if lines.iter().filter(|l| l.trim().is_empty()).count() > 2 {\n+                    span_lint(\n+                        cx,\n+                        EMPTY_LINE_AFTER_OUTER_ATTR,\n+                        begin_of_attr_to_item,\n+                        \"Found an empty line after an outer attribute. \\\n+                        Perhaps you forgot to add a `!` to make it an inner attribute?\",\n+                    );\n+                }\n+            }\n+        }\n+    }\n+}\n+\n fn check_deprecated_cfg_attr(cx: &EarlyContext<'_>, attr: &Attribute) {\n     if_chain! {\n         // check cfg_attr"}, {"sha": "2758b9a7e760439433abd5011244713d2b9c75c8", "filename": "tests/compile-test.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/291385b3e0765308ec9f9faf9796e6b534a4224b/tests%2Fcompile-test.rs", "raw_url": "https://github.com/rust-lang/rust/raw/291385b3e0765308ec9f9faf9796e6b534a4224b/tests%2Fcompile-test.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-test.rs?ref=291385b3e0765308ec9f9faf9796e6b534a4224b", "patch": "@@ -38,7 +38,7 @@ fn clippy_driver_path() -> PathBuf {\n //        as what we manually pass to `cargo` invocation\n fn third_party_crates() -> String {\n     use std::collections::HashMap;\n-    static CRATES: &[&str] = &[\"serde\", \"serde_derive\", \"regex\", \"clippy_lints\"];\n+    static CRATES: &[&str] = &[\"serde\", \"serde_derive\", \"regex\", \"clippy_lints\", \"syn\", \"quote\"];\n     let dep_dir = cargo::TARGET_LIB.join(\"deps\");\n     let mut crates: HashMap<&str, PathBuf> = HashMap::with_capacity(CRATES.len());\n     for entry in fs::read_dir(dep_dir).unwrap() {"}, {"sha": "e6626d57a772253f7db6def1ce4c17e99e25562a", "filename": "tests/ui/auxiliary/proc_macro_attr.rs", "status": "added", "additions": 37, "deletions": 0, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/291385b3e0765308ec9f9faf9796e6b534a4224b/tests%2Fui%2Fauxiliary%2Fproc_macro_attr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/291385b3e0765308ec9f9faf9796e6b534a4224b/tests%2Fui%2Fauxiliary%2Fproc_macro_attr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fauxiliary%2Fproc_macro_attr.rs?ref=291385b3e0765308ec9f9faf9796e6b534a4224b", "patch": "@@ -0,0 +1,37 @@\n+// no-prefer-dynamic\n+\n+#![crate_type = \"proc-macro\"]\n+#![feature(repr128, proc_macro_hygiene, proc_macro_quote)]\n+#![allow(clippy::useless_conversion)]\n+\n+extern crate proc_macro;\n+extern crate quote;\n+extern crate syn;\n+\n+use proc_macro::TokenStream;\n+use quote::{quote, quote_spanned};\n+use syn::parse_macro_input;\n+use syn::{parse_quote, ItemTrait, TraitItem};\n+\n+#[proc_macro_attribute]\n+pub fn fake_async_trait(_args: TokenStream, input: TokenStream) -> TokenStream {\n+    let mut item = parse_macro_input!(input as ItemTrait);\n+    for inner in &mut item.items {\n+        if let TraitItem::Method(method) = inner {\n+            let sig = &method.sig;\n+            let block = &mut method.default;\n+            if let Some(block) = block {\n+                let brace = block.brace_token;\n+\n+                let my_block = quote_spanned!( brace.span => {\n+                    // Should not trigger `empty_line_after_outer_attr`\n+                    #[crate_type = \"lib\"]\n+                    #sig #block\n+                    Vec::new()\n+                });\n+                *block = parse_quote!(#my_block);\n+            }\n+        }\n+    }\n+    TokenStream::from(quote!(#item))\n+}"}, {"sha": "3e92bca986ab55b4990a8d32e4f3f64a89f65289", "filename": "tests/ui/empty_line_after_outer_attribute.rs", "status": "modified", "additions": 18, "deletions": 1, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/291385b3e0765308ec9f9faf9796e6b534a4224b/tests%2Fui%2Fempty_line_after_outer_attribute.rs", "raw_url": "https://github.com/rust-lang/rust/raw/291385b3e0765308ec9f9faf9796e6b534a4224b/tests%2Fui%2Fempty_line_after_outer_attribute.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fempty_line_after_outer_attribute.rs?ref=291385b3e0765308ec9f9faf9796e6b534a4224b", "patch": "@@ -1,8 +1,12 @@\n+// aux-build:proc_macro_attr.rs\n #![warn(clippy::empty_line_after_outer_attr)]\n #![allow(clippy::assertions_on_constants)]\n #![feature(custom_inner_attributes)]\n #![rustfmt::skip]\n \n+#[macro_use]\n+extern crate proc_macro_attr;\n+\n // This should produce a warning\n #[crate_type = \"lib\"]\n \n@@ -93,4 +97,17 @@ pub struct S;\n /* test */\n pub struct T;\n \n-fn main() { }\n+// This should not produce a warning\n+// See https://github.com/rust-lang/rust-clippy/issues/5567\n+#[fake_async_trait]\n+pub trait Bazz {\n+    fn foo() -> Vec<u8> {\n+        let _i = \"\";\n+\n+\n+\n+        vec![]\n+    }\n+}\n+\n+fn main() {}"}, {"sha": "bf753a732f000f78c956833f7ea3f7f25bed7286", "filename": "tests/ui/empty_line_after_outer_attribute.stderr", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/291385b3e0765308ec9f9faf9796e6b534a4224b/tests%2Fui%2Fempty_line_after_outer_attribute.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/291385b3e0765308ec9f9faf9796e6b534a4224b/tests%2Fui%2Fempty_line_after_outer_attribute.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fempty_line_after_outer_attribute.stderr?ref=291385b3e0765308ec9f9faf9796e6b534a4224b", "patch": "@@ -1,5 +1,5 @@\n error: Found an empty line after an outer attribute. Perhaps you forgot to add a `!` to make it an inner attribute?\n-  --> $DIR/empty_line_after_outer_attribute.rs:7:1\n+  --> $DIR/empty_line_after_outer_attribute.rs:11:1\n    |\n LL | / #[crate_type = \"lib\"]\n LL | |\n@@ -10,15 +10,15 @@ LL | | fn with_one_newline_and_comment() { assert!(true) }\n    = note: `-D clippy::empty-line-after-outer-attr` implied by `-D warnings`\n \n error: Found an empty line after an outer attribute. Perhaps you forgot to add a `!` to make it an inner attribute?\n-  --> $DIR/empty_line_after_outer_attribute.rs:19:1\n+  --> $DIR/empty_line_after_outer_attribute.rs:23:1\n    |\n LL | / #[crate_type = \"lib\"]\n LL | |\n LL | | fn with_one_newline() { assert!(true) }\n    | |_\n \n error: Found an empty line after an outer attribute. Perhaps you forgot to add a `!` to make it an inner attribute?\n-  --> $DIR/empty_line_after_outer_attribute.rs:24:1\n+  --> $DIR/empty_line_after_outer_attribute.rs:28:1\n    |\n LL | / #[crate_type = \"lib\"]\n LL | |\n@@ -27,23 +27,23 @@ LL | | fn with_two_newlines() { assert!(true) }\n    | |_\n \n error: Found an empty line after an outer attribute. Perhaps you forgot to add a `!` to make it an inner attribute?\n-  --> $DIR/empty_line_after_outer_attribute.rs:31:1\n+  --> $DIR/empty_line_after_outer_attribute.rs:35:1\n    |\n LL | / #[crate_type = \"lib\"]\n LL | |\n LL | | enum Baz {\n    | |_\n \n error: Found an empty line after an outer attribute. Perhaps you forgot to add a `!` to make it an inner attribute?\n-  --> $DIR/empty_line_after_outer_attribute.rs:39:1\n+  --> $DIR/empty_line_after_outer_attribute.rs:43:1\n    |\n LL | / #[crate_type = \"lib\"]\n LL | |\n LL | | struct Foo {\n    | |_\n \n error: Found an empty line after an outer attribute. Perhaps you forgot to add a `!` to make it an inner attribute?\n-  --> $DIR/empty_line_after_outer_attribute.rs:47:1\n+  --> $DIR/empty_line_after_outer_attribute.rs:51:1\n    |\n LL | / #[crate_type = \"lib\"]\n LL | |"}]}