{"sha": "499afcdfcf1ad9e819b0fae35aac7f8e8730f045", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQ5OWFmY2RmY2YxYWQ5ZTgxOWIwZmFlMzVhYWM3ZjhlODczMGYwNDU=", "commit": {"author": {"name": "Fabian Wolff", "email": "fabian.wolff@alumni.ethz.ch", "date": "2021-06-25T13:36:38Z"}, "committer": {"name": "Fabian Wolff", "email": "fabian.wolff@alumni.ethz.ch", "date": "2021-06-25T15:49:41Z"}, "message": "Check that `#[cmse_nonsecure_entry]` is applied to a function definition", "tree": {"sha": "096ba5aff7a37f9066f9fa808069597b00b2ad27", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/096ba5aff7a37f9066f9fa808069597b00b2ad27"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/499afcdfcf1ad9e819b0fae35aac7f8e8730f045", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/499afcdfcf1ad9e819b0fae35aac7f8e8730f045", "html_url": "https://github.com/rust-lang/rust/commit/499afcdfcf1ad9e819b0fae35aac7f8e8730f045", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/499afcdfcf1ad9e819b0fae35aac7f8e8730f045/comments", "author": {"login": "FabianWolff", "id": 16052130, "node_id": "MDQ6VXNlcjE2MDUyMTMw", "avatar_url": "https://avatars.githubusercontent.com/u/16052130?v=4", "gravatar_id": "", "url": "https://api.github.com/users/FabianWolff", "html_url": "https://github.com/FabianWolff", "followers_url": "https://api.github.com/users/FabianWolff/followers", "following_url": "https://api.github.com/users/FabianWolff/following{/other_user}", "gists_url": "https://api.github.com/users/FabianWolff/gists{/gist_id}", "starred_url": "https://api.github.com/users/FabianWolff/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/FabianWolff/subscriptions", "organizations_url": "https://api.github.com/users/FabianWolff/orgs", "repos_url": "https://api.github.com/users/FabianWolff/repos", "events_url": "https://api.github.com/users/FabianWolff/events{/privacy}", "received_events_url": "https://api.github.com/users/FabianWolff/received_events", "type": "User", "site_admin": false}, "committer": {"login": "FabianWolff", "id": 16052130, "node_id": "MDQ6VXNlcjE2MDUyMTMw", "avatar_url": "https://avatars.githubusercontent.com/u/16052130?v=4", "gravatar_id": "", "url": "https://api.github.com/users/FabianWolff", "html_url": "https://github.com/FabianWolff", "followers_url": "https://api.github.com/users/FabianWolff/followers", "following_url": "https://api.github.com/users/FabianWolff/following{/other_user}", "gists_url": "https://api.github.com/users/FabianWolff/gists{/gist_id}", "starred_url": "https://api.github.com/users/FabianWolff/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/FabianWolff/subscriptions", "organizations_url": "https://api.github.com/users/FabianWolff/orgs", "repos_url": "https://api.github.com/users/FabianWolff/repos", "events_url": "https://api.github.com/users/FabianWolff/events{/privacy}", "received_events_url": "https://api.github.com/users/FabianWolff/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "117799b73ccf434f588528d97596392062535e3f", "url": "https://api.github.com/repos/rust-lang/rust/commits/117799b73ccf434f588528d97596392062535e3f", "html_url": "https://github.com/rust-lang/rust/commit/117799b73ccf434f588528d97596392062535e3f"}], "stats": {"total": 40, "additions": 40, "deletions": 0}, "files": [{"sha": "d0795841c5359b30f382f27ab27fbaffb3c0ab62", "filename": "compiler/rustc_passes/src/check_attr.rs", "status": "modified", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/499afcdfcf1ad9e819b0fae35aac7f8e8730f045/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/499afcdfcf1ad9e819b0fae35aac7f8e8730f045/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs?ref=499afcdfcf1ad9e819b0fae35aac7f8e8730f045", "patch": "@@ -97,6 +97,7 @@ impl CheckAttrVisitor<'tcx> {\n                 | sym::rustc_dirty\n                 | sym::rustc_if_this_changed\n                 | sym::rustc_then_this_would_need => self.check_rustc_dirty_clean(&attr),\n+                sym::cmse_nonsecure_entry => self.check_cmse_nonsecure_entry(attr, span, target),\n                 _ => true,\n             };\n             // lint-only checks\n@@ -234,6 +235,25 @@ impl CheckAttrVisitor<'tcx> {\n         }\n     }\n \n+    /// Checks if `#[cmse_nonsecure_entry]` is applied to a function definition.\n+    fn check_cmse_nonsecure_entry(&self, attr: &Attribute, span: &Span, target: Target) -> bool {\n+        match target {\n+            Target::Fn\n+            | Target::Method(MethodKind::Trait { body: true } | MethodKind::Inherent) => true,\n+            _ => {\n+                self.tcx\n+                    .sess\n+                    .struct_span_err(\n+                        attr.span,\n+                        \"attribute should be applied to a function definition\",\n+                    )\n+                    .span_label(*span, \"not a function definition\")\n+                    .emit();\n+                false\n+            }\n+        }\n+    }\n+\n     /// Checks if a `#[track_caller]` is applied to a non-naked function. Returns `true` if valid.\n     fn check_track_caller(\n         &self,"}, {"sha": "a839406cd0aaf9103cf57c0a0d2961ed7eb44f45", "filename": "src/test/ui/cmse-nonsecure/cmse-nonsecure-entry/issue-83475.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/499afcdfcf1ad9e819b0fae35aac7f8e8730f045/src%2Ftest%2Fui%2Fcmse-nonsecure%2Fcmse-nonsecure-entry%2Fissue-83475.rs", "raw_url": "https://github.com/rust-lang/rust/raw/499afcdfcf1ad9e819b0fae35aac7f8e8730f045/src%2Ftest%2Fui%2Fcmse-nonsecure%2Fcmse-nonsecure-entry%2Fissue-83475.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcmse-nonsecure%2Fcmse-nonsecure-entry%2Fissue-83475.rs?ref=499afcdfcf1ad9e819b0fae35aac7f8e8730f045", "patch": "@@ -0,0 +1,9 @@\n+// Regression test for the ICE described in #83475.\n+\n+#![crate_type=\"lib\"]\n+\n+#![feature(cmse_nonsecure_entry)]\n+#[cmse_nonsecure_entry]\n+//~^ ERROR: attribute should be applied to a function definition\n+struct XEmpty2;\n+//~^ NOTE: not a function definition"}, {"sha": "426d82d8d0753226ca67108cb41303bffac4d662", "filename": "src/test/ui/cmse-nonsecure/cmse-nonsecure-entry/issue-83475.stderr", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/499afcdfcf1ad9e819b0fae35aac7f8e8730f045/src%2Ftest%2Fui%2Fcmse-nonsecure%2Fcmse-nonsecure-entry%2Fissue-83475.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/499afcdfcf1ad9e819b0fae35aac7f8e8730f045/src%2Ftest%2Fui%2Fcmse-nonsecure%2Fcmse-nonsecure-entry%2Fissue-83475.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcmse-nonsecure%2Fcmse-nonsecure-entry%2Fissue-83475.stderr?ref=499afcdfcf1ad9e819b0fae35aac7f8e8730f045", "patch": "@@ -0,0 +1,11 @@\n+error: attribute should be applied to a function definition\n+  --> $DIR/issue-83475.rs:6:1\n+   |\n+LL | #[cmse_nonsecure_entry]\n+   | ^^^^^^^^^^^^^^^^^^^^^^^\n+LL |\n+LL | struct XEmpty2;\n+   | --------------- not a function definition\n+\n+error: aborting due to previous error\n+"}]}