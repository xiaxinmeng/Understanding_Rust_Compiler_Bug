{"sha": "4d7a6484852603749f765479ee7288e6ae7186f4", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRkN2E2NDg0ODUyNjAzNzQ5Zjc2NTQ3OWVlNzI4OGU2YWU3MTg2ZjQ=", "commit": {"author": {"name": "Joshua Nelson", "email": "jyn514@gmail.com", "date": "2021-02-12T02:29:22Z"}, "committer": {"name": "Joshua Nelson", "email": "jyn514@gmail.com", "date": "2021-03-01T05:30:30Z"}, "message": "Remove the dummy cache in `DocContext`\n\nThe same information is available everywhere; the only reason the dummy\ncache was needed is because it waas previously stored in three different\nplaces. This consolidates the info a bit so the cache in `DocContext` is\nused throughout. As a bonus, it means `renderinfo` is used much much\nless.\n\n- Return a `Cache` from `run_global_ctxt`, not `RenderInfo`\n- Remove the unused `render_info` from `run_renderer`\n- Remove RefCell around `inlined`\n- Add intra-doc links", "tree": {"sha": "36a87ee306a7f98da252ca2b5e0b74fe58e0f2d3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/36a87ee306a7f98da252ca2b5e0b74fe58e0f2d3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4d7a6484852603749f765479ee7288e6ae7186f4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4d7a6484852603749f765479ee7288e6ae7186f4", "html_url": "https://github.com/rust-lang/rust/commit/4d7a6484852603749f765479ee7288e6ae7186f4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4d7a6484852603749f765479ee7288e6ae7186f4/comments", "author": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e37a13cc3594004663738bd18d8100e6db9666cf", "url": "https://api.github.com/repos/rust-lang/rust/commits/e37a13cc3594004663738bd18d8100e6db9666cf", "html_url": "https://github.com/rust-lang/rust/commit/e37a13cc3594004663738bd18d8100e6db9666cf"}], "stats": {"total": 161, "additions": 79, "deletions": 82}, "files": [{"sha": "4e4e1e5cbce2f3111e3e1c3c9061ecfb2d353be5", "filename": "src/librustdoc/clean/blanket_impl.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/4d7a6484852603749f765479ee7288e6ae7186f4/src%2Flibrustdoc%2Fclean%2Fblanket_impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4d7a6484852603749f765479ee7288e6ae7186f4/src%2Flibrustdoc%2Fclean%2Fblanket_impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Fblanket_impl.rs?ref=4d7a6484852603749f765479ee7288e6ae7186f4", "patch": "@@ -21,7 +21,7 @@ impl<'a, 'tcx> BlanketImplFinder<'a, 'tcx> {\n         debug!(\"get_blanket_impls({:?})\", ty);\n         let mut impls = Vec::new();\n         for &trait_def_id in self.cx.tcx.all_traits(LOCAL_CRATE).iter() {\n-            if !self.cx.renderinfo.access_levels.is_public(trait_def_id)\n+            if !self.cx.cache.access_levels.is_public(trait_def_id)\n                 || self.cx.generated_synthetics.get(&(ty, trait_def_id)).is_some()\n             {\n                 continue;"}, {"sha": "47a74238a7a3de4971cf996d4b539efd4801f0b3", "filename": "src/librustdoc/clean/inline.rs", "status": "modified", "additions": 7, "deletions": 6, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/4d7a6484852603749f765479ee7288e6ae7186f4/src%2Flibrustdoc%2Fclean%2Finline.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4d7a6484852603749f765479ee7288e6ae7186f4/src%2Flibrustdoc%2Fclean%2Finline.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Finline.rs?ref=4d7a6484852603749f765479ee7288e6ae7186f4", "patch": "@@ -17,6 +17,7 @@ use rustc_span::Span;\n \n use crate::clean::{self, Attributes, GetDefId, ToSource, TypeKind};\n use crate::core::DocContext;\n+use crate::formats::item_type::ItemType;\n \n use super::Clean;\n \n@@ -122,7 +123,7 @@ crate fn try_inline(\n     let target_attrs = load_attrs(cx, did);\n     let attrs = box merge_attrs(cx, Some(parent_module), target_attrs, attrs_clone);\n \n-    cx.renderinfo.inlined.insert(did);\n+    cx.inlined.insert(did);\n     let what_rustc_thinks = clean::Item::from_def_id_and_parts(did, Some(name), kind, cx);\n     ret.push(clean::Item { attrs, ..what_rustc_thinks });\n     Some(ret)\n@@ -181,9 +182,9 @@ crate fn record_extern_fqn(cx: &mut DocContext<'_>, did: DefId, kind: clean::Typ\n     };\n \n     if did.is_local() {\n-        cx.renderinfo.exact_paths.insert(did, fqn);\n+        cx.cache.exact_paths.insert(did, fqn);\n     } else {\n-        cx.renderinfo.external_paths.insert(did, (fqn, kind));\n+        cx.cache.external_paths.insert(did, (fqn, ItemType::from(kind)));\n     }\n }\n \n@@ -315,7 +316,7 @@ crate fn build_impl(\n     attrs: Option<Attrs<'_>>,\n     ret: &mut Vec<clean::Item>,\n ) {\n-    if !cx.renderinfo.inlined.insert(did) {\n+    if !cx.inlined.insert(did) {\n         return;\n     }\n \n@@ -327,7 +328,7 @@ crate fn build_impl(\n     if !did.is_local() {\n         if let Some(traitref) = associated_trait {\n             let did = traitref.def_id;\n-            if !cx.renderinfo.access_levels.is_public(did) {\n+            if !cx.cache.access_levels.is_public(did) {\n                 return;\n             }\n \n@@ -359,7 +360,7 @@ crate fn build_impl(\n     // reachable in rustdoc generated documentation\n     if !did.is_local() {\n         if let Some(did) = for_.def_id() {\n-            if !cx.renderinfo.access_levels.is_public(did) {\n+            if !cx.cache.access_levels.is_public(did) {\n                 return;\n             }\n "}, {"sha": "5d81498f8d210d546ab9c747788c47f547d79445", "filename": "src/librustdoc/clean/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/4d7a6484852603749f765479ee7288e6ae7186f4/src%2Flibrustdoc%2Fclean%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4d7a6484852603749f765479ee7288e6ae7186f4/src%2Flibrustdoc%2Fclean%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Fmod.rs?ref=4d7a6484852603749f765479ee7288e6ae7186f4", "patch": "@@ -1304,7 +1304,7 @@ fn clean_qpath(hir_ty: &hir::Ty<'_>, cx: &mut DocContext<'_>) -> Type {\n                 // Substitute private type aliases\n                 if let Some(def_id) = def_id.as_local() {\n                     let hir_id = cx.tcx.hir().local_def_id_to_hir_id(def_id);\n-                    if !cx.renderinfo.access_levels.is_exported(def_id.to_def_id()) {\n+                    if !cx.cache.access_levels.is_exported(def_id.to_def_id()) {\n                         alias = Some(&cx.tcx.hir().expect_item(hir_id).kind);\n                     }\n                 }"}, {"sha": "40f6c084a71780ce256ffec00d61e8176f68b37b", "filename": "src/librustdoc/clean/utils.rs", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/4d7a6484852603749f765479ee7288e6ae7186f4/src%2Flibrustdoc%2Fclean%2Futils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4d7a6484852603749f765479ee7288e6ae7186f4/src%2Flibrustdoc%2Fclean%2Futils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Futils.rs?ref=4d7a6484852603749f765479ee7288e6ae7186f4", "patch": "@@ -17,21 +17,21 @@ use rustc_middle::ty::{self, DefIdTree, TyCtxt};\n use rustc_span::symbol::{kw, sym, Symbol};\n use std::mem;\n \n-crate fn krate(mut cx: &mut DocContext<'_>) -> Crate {\n+crate fn krate(cx: &mut DocContext<'_>) -> Crate {\n     use crate::visit_lib::LibEmbargoVisitor;\n \n     let krate = cx.tcx.hir().krate();\n-    let module = crate::visit_ast::RustdocVisitor::new(&mut cx).visit(krate);\n+    let module = crate::visit_ast::RustdocVisitor::new(cx).visit(krate);\n \n-    cx.renderinfo.deref_trait_did = cx.tcx.lang_items().deref_trait();\n-    cx.renderinfo.deref_mut_trait_did = cx.tcx.lang_items().deref_mut_trait();\n-    cx.renderinfo.owned_box_did = cx.tcx.lang_items().owned_box();\n+    cx.cache.deref_trait_did = cx.tcx.lang_items().deref_trait();\n+    cx.cache.deref_mut_trait_did = cx.tcx.lang_items().deref_mut_trait();\n+    cx.cache.owned_box_did = cx.tcx.lang_items().owned_box();\n \n     let mut externs = Vec::new();\n     for &cnum in cx.tcx.crates().iter() {\n         externs.push((cnum, cnum.clean(cx)));\n         // Analyze doc-reachability for extern items\n-        LibEmbargoVisitor::new(&mut cx).visit_lib(cnum);\n+        LibEmbargoVisitor::new(cx).visit_lib(cnum);\n     }\n     externs.sort_by(|&(a, _), &(b, _)| a.cmp(&b));\n "}, {"sha": "727b79d4e3b5af888db251b1eed0016360d2655e", "filename": "src/librustdoc/core.rs", "status": "modified", "additions": 17, "deletions": 8, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/4d7a6484852603749f765479ee7288e6ae7186f4/src%2Flibrustdoc%2Fcore.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4d7a6484852603749f765479ee7288e6ae7186f4/src%2Flibrustdoc%2Fcore.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fcore.rs?ref=4d7a6484852603749f765479ee7288e6ae7186f4", "patch": "@@ -52,8 +52,6 @@ crate struct DocContext<'tcx> {\n     ///\n     /// Most of this logic is copied from rustc_lint::late.\n     crate param_env: ParamEnv<'tcx>,\n-    /// Later on moved into `cache`\n-    crate renderinfo: RenderInfo,\n     /// Later on moved through `clean::Crate` into `cache`\n     crate external_traits: Rc<RefCell<FxHashMap<DefId, clean::TraitWithExtraInfo>>>,\n     /// Used while populating `external_traits` to ensure we don't process the same trait twice at\n@@ -81,8 +79,12 @@ crate struct DocContext<'tcx> {\n     /// See `collect_intra_doc_links::traits_implemented_by` for more details.\n     /// `map<module, set<trait>>`\n     crate module_trait_cache: RefCell<FxHashMap<DefId, FxHashSet<DefId>>>,\n-    /// Fake empty cache used when cache is required as parameter.\n+    /// This same cache is used throughout rustdoc, including in [`crate::html::render`].\n     crate cache: Cache,\n+    /// Used by [`clean::inline`] to tell if an item has already been inlined.\n+    crate inlined: FxHashSet<DefId>,\n+    /// Used by `calculate_doc_coverage`.\n+    crate output_format: OutputFormat,\n }\n \n impl<'tcx> DocContext<'tcx> {\n@@ -465,7 +467,7 @@ crate fn run_global_ctxt(\n     mut manual_passes: Vec<String>,\n     render_options: RenderOptions,\n     output_format: OutputFormat,\n-) -> (clean::Crate, RenderInfo, RenderOptions) {\n+) -> (clean::Crate, RenderOptions, Cache) {\n     // Certain queries assume that some checks were run elsewhere\n     // (see https://github.com/rust-lang/rust/pull/73566#issuecomment-656954425),\n     // so type-check everything other than function bodies in this crate before running lints.\n@@ -514,7 +516,6 @@ crate fn run_global_ctxt(\n         param_env: ParamEnv::empty(),\n         external_traits: Default::default(),\n         active_extern_traits: Default::default(),\n-        renderinfo,\n         ty_substs: Default::default(),\n         lt_substs: Default::default(),\n         ct_substs: Default::default(),\n@@ -527,9 +528,11 @@ crate fn run_global_ctxt(\n             .cloned()\n             .filter(|trait_def_id| tcx.trait_is_auto(*trait_def_id))\n             .collect(),\n-        render_options,\n         module_trait_cache: RefCell::new(FxHashMap::default()),\n-        cache: Cache::default(),\n+        cache: Cache::new(renderinfo, render_options.document_private),\n+        inlined: FxHashSet::default(),\n+        output_format,\n+        render_options,\n     };\n \n     // Small hack to force the Sized trait to be present.\n@@ -647,10 +650,16 @@ crate fn run_global_ctxt(\n \n     ctxt.sess().abort_if_errors();\n \n+    let render_options = ctxt.render_options;\n+    let mut cache = ctxt.cache;\n+    krate = tcx.sess.time(\"create_format_cache\", || {\n+        cache.populate(krate, tcx, &render_options.extern_html_root_urls, &render_options.output)\n+    });\n+\n     // The main crate doc comments are always collapsed.\n     krate.collapsed = true;\n \n-    (krate, ctxt.renderinfo, ctxt.render_options)\n+    (krate, render_options, cache)\n }\n \n /// Due to <https://github.com/rust-lang/rust/pull/73566>,"}, {"sha": "3b2ede577aa3eebb46bb54cdf23d8b2be670917a", "filename": "src/librustdoc/formats/cache.rs", "status": "modified", "additions": 28, "deletions": 27, "changes": 55, "blob_url": "https://github.com/rust-lang/rust/blob/4d7a6484852603749f765479ee7288e6ae7186f4/src%2Flibrustdoc%2Fformats%2Fcache.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4d7a6484852603749f765479ee7288e6ae7186f4/src%2Flibrustdoc%2Fformats%2Fcache.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fformats%2Fcache.rs?ref=4d7a6484852603749f765479ee7288e6ae7186f4", "patch": "@@ -131,14 +131,7 @@ struct CacheBuilder<'a, 'tcx> {\n }\n \n impl Cache {\n-    crate fn from_krate<'tcx>(\n-        render_info: RenderInfo,\n-        document_private: bool,\n-        extern_html_root_urls: &BTreeMap<String, String>,\n-        dst: &Path,\n-        mut krate: clean::Crate,\n-        tcx: TyCtxt<'tcx>,\n-    ) -> (clean::Crate, Cache) {\n+    crate fn new(render_info: RenderInfo, document_private: bool) -> Self {\n         // Crawl the crate to build various caches used for the output\n         let RenderInfo {\n             inlined: _,\n@@ -154,21 +147,31 @@ impl Cache {\n         let external_paths =\n             external_paths.into_iter().map(|(k, (v, t))| (k, (v, ItemType::from(t)))).collect();\n \n-        let mut cache = Cache {\n+        Cache {\n             external_paths,\n             exact_paths,\n-            parent_is_trait_impl: false,\n-            stripped_mod: false,\n             access_levels,\n-            crate_version: krate.version.take(),\n             document_private,\n-            traits: krate.external_traits.replace(Default::default()),\n             deref_trait_did,\n             deref_mut_trait_did,\n             owned_box_did,\n-            masked_crates: mem::take(&mut krate.masked_crates),\n             ..Cache::default()\n-        };\n+        }\n+    }\n+\n+    /// Populates the `Cache` with more data. The returned `Crate` will be missing some data that was\n+    /// in `krate` due to the data being moved into the `Cache`.\n+    crate fn populate(\n+        &mut self,\n+        mut krate: clean::Crate,\n+        tcx: TyCtxt<'_>,\n+        extern_html_root_urls: &BTreeMap<String, String>,\n+        dst: &Path,\n+    ) -> clean::Crate {\n+        self.crate_version = krate.version.take();\n+        debug!(?self.crate_version);\n+        self.traits = krate.external_traits.take();\n+        self.masked_crates = mem::take(&mut krate.masked_crates);\n \n         // Cache where all our extern crates are located\n         // FIXME: this part is specific to HTML so it'd be nice to remove it from the common code\n@@ -181,12 +184,11 @@ impl Cache {\n                 _ => PathBuf::new(),\n             };\n             let extern_url = extern_html_root_urls.get(&*e.name.as_str()).map(|u| &**u);\n-            cache\n-                .extern_locations\n+            self.extern_locations\n                 .insert(n, (e.name, src_root, extern_location(e, extern_url, &dst)));\n \n             let did = DefId { krate: n, index: CRATE_DEF_INDEX };\n-            cache.external_paths.insert(did, (vec![e.name.to_string()], ItemType::Module));\n+            self.external_paths.insert(did, (vec![e.name.to_string()], ItemType::Module));\n         }\n \n         // Cache where all known primitives have their documentation located.\n@@ -195,27 +197,26 @@ impl Cache {\n         // reverse topological order.\n         for &(_, ref e) in krate.externs.iter().rev() {\n             for &(def_id, prim) in &e.primitives {\n-                cache.primitive_locations.insert(prim, def_id);\n+                self.primitive_locations.insert(prim, def_id);\n             }\n         }\n         for &(def_id, prim) in &krate.primitives {\n-            cache.primitive_locations.insert(prim, def_id);\n+            self.primitive_locations.insert(prim, def_id);\n         }\n \n-        cache.stack.push(krate.name.to_string());\n+        self.stack.push(krate.name.to_string());\n \n-        krate = CacheBuilder { tcx, cache: &mut cache, empty_cache: Cache::default() }\n-            .fold_crate(krate);\n+        krate = CacheBuilder { tcx, cache: self, empty_cache: Cache::default() }.fold_crate(krate);\n \n-        for (trait_did, dids, impl_) in cache.orphan_trait_impls.drain(..) {\n-            if cache.traits.contains_key(&trait_did) {\n+        for (trait_did, dids, impl_) in self.orphan_trait_impls.drain(..) {\n+            if self.traits.contains_key(&trait_did) {\n                 for did in dids {\n-                    cache.impls.entry(did).or_default().push(impl_.clone());\n+                    self.impls.entry(did).or_default().push(impl_.clone());\n                 }\n             }\n         }\n \n-        (krate, cache)\n+        krate\n     }\n }\n "}, {"sha": "b779363e5c701d7bfca255794be71f86175d8eb3", "filename": "src/librustdoc/formats/renderer.rs", "status": "modified", "additions": 3, "deletions": 14, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/4d7a6484852603749f765479ee7288e6ae7186f4/src%2Flibrustdoc%2Fformats%2Frenderer.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4d7a6484852603749f765479ee7288e6ae7186f4/src%2Flibrustdoc%2Fformats%2Frenderer.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fformats%2Frenderer.rs?ref=4d7a6484852603749f765479ee7288e6ae7186f4", "patch": "@@ -2,7 +2,7 @@ use rustc_middle::ty::TyCtxt;\n use rustc_span::edition::Edition;\n \n use crate::clean;\n-use crate::config::{RenderInfo, RenderOptions};\n+use crate::config::RenderOptions;\n use crate::error::Error;\n use crate::formats::cache::Cache;\n \n@@ -18,7 +18,6 @@ crate trait FormatRenderer<'tcx>: Clone {\n     fn init(\n         krate: clean::Crate,\n         options: RenderOptions,\n-        render_info: RenderInfo,\n         edition: Edition,\n         cache: Cache,\n         tcx: TyCtxt<'tcx>,\n@@ -49,26 +48,16 @@ crate trait FormatRenderer<'tcx>: Clone {\n crate fn run_format<'tcx, T: FormatRenderer<'tcx>>(\n     krate: clean::Crate,\n     options: RenderOptions,\n-    render_info: RenderInfo,\n+    cache: Cache,\n     diag: &rustc_errors::Handler,\n     edition: Edition,\n     tcx: TyCtxt<'tcx>,\n ) -> Result<(), Error> {\n-    let (krate, cache) = tcx.sess.time(\"create_format_cache\", || {\n-        Cache::from_krate(\n-            render_info.clone(),\n-            options.document_private,\n-            &options.extern_html_root_urls,\n-            &options.output,\n-            krate,\n-            tcx,\n-        )\n-    });\n     let prof = &tcx.sess.prof;\n \n     let (mut format_renderer, mut krate) = prof\n         .extra_verbose_generic_activity(\"create_renderer\", T::descr())\n-        .run(|| T::init(krate, options, render_info, edition, cache, tcx))?;\n+        .run(|| T::init(krate, options, edition, cache, tcx))?;\n \n     let mut item = match krate.module.take() {\n         Some(i) => i,"}, {"sha": "4e762a40f08491849d63c514d63a738ba4fb2680", "filename": "src/librustdoc/html/render/mod.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/4d7a6484852603749f765479ee7288e6ae7186f4/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4d7a6484852603749f765479ee7288e6ae7186f4/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs?ref=4d7a6484852603749f765479ee7288e6ae7186f4", "patch": "@@ -66,7 +66,7 @@ use serde::ser::SerializeSeq;\n use serde::{Serialize, Serializer};\n \n use crate::clean::{self, AttributesExt, GetDefId, RenderedLink, SelfTy, TypeKind};\n-use crate::config::{RenderInfo, RenderOptions};\n+use crate::config::RenderOptions;\n use crate::docfs::{DocFS, PathError};\n use crate::error::Error;\n use crate::formats::cache::Cache;\n@@ -385,7 +385,6 @@ impl<'tcx> FormatRenderer<'tcx> for Context<'tcx> {\n     fn init(\n         mut krate: clean::Crate,\n         options: RenderOptions,\n-        _render_info: RenderInfo,\n         edition: Edition,\n         mut cache: Cache,\n         tcx: TyCtxt<'tcx>,"}, {"sha": "bd5802a99dda2c2f9c919fec7a1dce69ea52d551", "filename": "src/librustdoc/json/mod.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/4d7a6484852603749f765479ee7288e6ae7186f4/src%2Flibrustdoc%2Fjson%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4d7a6484852603749f765479ee7288e6ae7186f4/src%2Flibrustdoc%2Fjson%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fjson%2Fmod.rs?ref=4d7a6484852603749f765479ee7288e6ae7186f4", "patch": "@@ -19,7 +19,7 @@ use rustc_span::edition::Edition;\n use rustdoc_json_types as types;\n \n use crate::clean;\n-use crate::config::{RenderInfo, RenderOptions};\n+use crate::config::RenderOptions;\n use crate::error::Error;\n use crate::formats::cache::Cache;\n use crate::formats::FormatRenderer;\n@@ -133,7 +133,6 @@ impl<'tcx> FormatRenderer<'tcx> for JsonRenderer<'tcx> {\n     fn init(\n         krate: clean::Crate,\n         options: RenderOptions,\n-        _render_info: RenderInfo,\n         _edition: Edition,\n         cache: Cache,\n         tcx: TyCtxt<'tcx>,"}, {"sha": "be7e25925e7338b1fdc4b6303954ed53e0135127", "filename": "src/librustdoc/lib.rs", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/4d7a6484852603749f765479ee7288e6ae7186f4/src%2Flibrustdoc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4d7a6484852603749f765479ee7288e6ae7186f4/src%2Flibrustdoc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Flib.rs?ref=4d7a6484852603749f765479ee7288e6ae7186f4", "patch": "@@ -479,12 +479,12 @@ fn wrap_return(diag: &rustc_errors::Handler, res: Result<(), String>) -> MainRes\n fn run_renderer<'tcx, T: formats::FormatRenderer<'tcx>>(\n     krate: clean::Crate,\n     renderopts: config::RenderOptions,\n-    render_info: config::RenderInfo,\n+    cache: formats::cache::Cache,\n     diag: &rustc_errors::Handler,\n     edition: rustc_span::edition::Edition,\n     tcx: TyCtxt<'tcx>,\n ) -> MainResult {\n-    match formats::run_format::<T>(krate, renderopts, render_info, &diag, edition, tcx) {\n+    match formats::run_format::<T>(krate, renderopts, cache, &diag, edition, tcx) {\n         Ok(_) => Ok(()),\n         Err(e) => {\n             let mut msg = diag.struct_err(&format!(\"couldn't generate documentation: {}\", e.error));\n@@ -553,7 +553,7 @@ fn main_options(options: config::Options) -> MainResult {\n             let mut global_ctxt = abort_on_err(queries.global_ctxt(), sess).peek_mut();\n \n             global_ctxt.enter(|tcx| {\n-                let (mut krate, render_info, render_opts) = sess.time(\"run_global_ctxt\", || {\n+                let (krate, render_opts, mut cache) = sess.time(\"run_global_ctxt\", || {\n                     core::run_global_ctxt(\n                         tcx,\n                         resolver,\n@@ -565,7 +565,7 @@ fn main_options(options: config::Options) -> MainResult {\n                 });\n                 info!(\"finished with rustc\");\n \n-                krate.version = crate_version;\n+                cache.crate_version = crate_version;\n \n                 if show_coverage {\n                     // if we ran coverage, bail early, we don't need to also generate docs at this point\n@@ -584,7 +584,7 @@ fn main_options(options: config::Options) -> MainResult {\n                         run_renderer::<html::render::Context<'_>>(\n                             krate,\n                             render_opts,\n-                            render_info,\n+                            cache,\n                             &diag,\n                             edition,\n                             tcx,\n@@ -594,7 +594,7 @@ fn main_options(options: config::Options) -> MainResult {\n                         run_renderer::<json::JsonRenderer<'_>>(\n                             krate,\n                             render_opts,\n-                            render_info,\n+                            cache,\n                             &diag,\n                             edition,\n                             tcx,"}, {"sha": "bb54523871c3ec99d70fcd09d565d2cf7eba142a", "filename": "src/librustdoc/passes/calculate_doc_coverage.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/4d7a6484852603749f765479ee7288e6ae7186f4/src%2Flibrustdoc%2Fpasses%2Fcalculate_doc_coverage.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4d7a6484852603749f765479ee7288e6ae7186f4/src%2Flibrustdoc%2Fpasses%2Fcalculate_doc_coverage.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fcalculate_doc_coverage.rs?ref=4d7a6484852603749f765479ee7288e6ae7186f4", "patch": "@@ -127,7 +127,7 @@ impl<'a, 'b> CoverageCalculator<'a, 'b> {\n     }\n \n     fn print_results(&self) {\n-        let output_format = self.ctx.renderinfo.output_format;\n+        let output_format = self.ctx.output_format;\n         if output_format.is_json() {\n             println!(\"{}\", self.to_json());\n             return;"}, {"sha": "685451b87eda99f528eda378a4039599d09a2da3", "filename": "src/librustdoc/passes/collect_trait_impls.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/4d7a6484852603749f765479ee7288e6ae7186f4/src%2Flibrustdoc%2Fpasses%2Fcollect_trait_impls.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4d7a6484852603749f765479ee7288e6ae7186f4/src%2Flibrustdoc%2Fpasses%2Fcollect_trait_impls.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fcollect_trait_impls.rs?ref=4d7a6484852603749f765479ee7288e6ae7186f4", "patch": "@@ -47,7 +47,7 @@ crate fn collect_trait_impls(krate: Crate, cx: &mut DocContext<'_>) -> Crate {\n                 // FIXME(eddyb) is this `doc(hidden)` check needed?\n                 if !cx.tcx.get_attrs(def_id).lists(sym::doc).has_word(sym::hidden) {\n                     let impls = get_auto_trait_and_blanket_impls(cx, def_id);\n-                    new_items.extend(impls.filter(|i| cx.renderinfo.inlined.insert(i.def_id)));\n+                    new_items.extend(impls.filter(|i| cx.inlined.insert(i.def_id)));\n                 }\n             });\n         }"}, {"sha": "3b1508c1348578b077426f30e58b4fe7793e1676", "filename": "src/librustdoc/passes/doc_test_lints.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/4d7a6484852603749f765479ee7288e6ae7186f4/src%2Flibrustdoc%2Fpasses%2Fdoc_test_lints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4d7a6484852603749f765479ee7288e6ae7186f4/src%2Flibrustdoc%2Fpasses%2Fdoc_test_lints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fdoc_test_lints.rs?ref=4d7a6484852603749f765479ee7288e6ae7186f4", "patch": "@@ -97,7 +97,7 @@ crate fn look_for_tests<'tcx>(cx: &DocContext<'tcx>, dox: &str, item: &Item) {\n                 |lint| lint.build(\"missing code example in this documentation\").emit(),\n             );\n         }\n-    } else if tests.found_tests > 0 && !cx.renderinfo.access_levels.is_public(item.def_id) {\n+    } else if tests.found_tests > 0 && !cx.cache.access_levels.is_public(item.def_id) {\n         cx.tcx.struct_span_lint_hir(\n             lint::builtin::PRIVATE_DOC_TESTS,\n             hir_id,"}, {"sha": "fc8bbc97150298a3524e8dcd52622a810833f0f3", "filename": "src/librustdoc/passes/strip_private.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/4d7a6484852603749f765479ee7288e6ae7186f4/src%2Flibrustdoc%2Fpasses%2Fstrip_private.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4d7a6484852603749f765479ee7288e6ae7186f4/src%2Flibrustdoc%2Fpasses%2Fstrip_private.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fstrip_private.rs?ref=4d7a6484852603749f765479ee7288e6ae7186f4", "patch": "@@ -17,13 +17,12 @@ crate const STRIP_PRIVATE: Pass = Pass {\n crate fn strip_private(mut krate: clean::Crate, cx: &mut DocContext<'_>) -> clean::Crate {\n     // This stripper collects all *retained* nodes.\n     let mut retained = DefIdSet::default();\n-    let access_levels = cx.renderinfo.access_levels.clone();\n \n     // strip all private items\n     {\n         let mut stripper = Stripper {\n             retained: &mut retained,\n-            access_levels: &access_levels,\n+            access_levels: &cx.cache.access_levels,\n             update_retained: true,\n         };\n         krate = ImportStripper.fold_crate(stripper.fold_crate(krate));"}, {"sha": "5da7d2f1e9b843d22c3bae695a451b9ca9d7c66a", "filename": "src/librustdoc/visit_ast.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/4d7a6484852603749f765479ee7288e6ae7186f4/src%2Flibrustdoc%2Fvisit_ast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4d7a6484852603749f765479ee7288e6ae7186f4/src%2Flibrustdoc%2Fvisit_ast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fvisit_ast.rs?ref=4d7a6484852603749f765479ee7288e6ae7186f4", "patch": "@@ -113,7 +113,7 @@ impl<'a, 'tcx> RustdocVisitor<'a, 'tcx> {\n             assert_eq!(cur_mod_def_id, macro_parent_def_id);\n             cur_mod.macros.push((def, None));\n         }\n-        self.cx.renderinfo.exact_paths = self.exact_paths;\n+        self.cx.cache.exact_paths = self.exact_paths;\n         top_level_module\n     }\n \n@@ -199,7 +199,7 @@ impl<'a, 'tcx> RustdocVisitor<'a, 'tcx> {\n                     } else {\n                         // All items need to be handled here in case someone wishes to link\n                         // to them with intra-doc links\n-                        self.cx.renderinfo.access_levels.map.insert(did, AccessLevel::Public);\n+                        self.cx.cache.access_levels.map.insert(did, AccessLevel::Public);\n                     }\n                 }\n             }\n@@ -211,7 +211,7 @@ impl<'a, 'tcx> RustdocVisitor<'a, 'tcx> {\n             None => return false,\n         };\n \n-        let is_private = !self.cx.renderinfo.access_levels.is_public(res_did);\n+        let is_private = !self.cx.cache.access_levels.is_public(res_did);\n         let is_hidden = inherits_doc_hidden(self.cx, res_hir_id);\n \n         // Only inline if requested or if the item would otherwise be stripped."}, {"sha": "3e06b4173144ca4a26d5a7831d5e8f680c21c3aa", "filename": "src/librustdoc/visit_lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/4d7a6484852603749f765479ee7288e6ae7186f4/src%2Flibrustdoc%2Fvisit_lib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4d7a6484852603749f765479ee7288e6ae7186f4/src%2Flibrustdoc%2Fvisit_lib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fvisit_lib.rs?ref=4d7a6484852603749f765479ee7288e6ae7186f4", "patch": "@@ -25,7 +25,7 @@ impl<'a, 'tcx> LibEmbargoVisitor<'a, 'tcx> {\n     crate fn new(cx: &'a mut crate::core::DocContext<'tcx>) -> LibEmbargoVisitor<'a, 'tcx> {\n         LibEmbargoVisitor {\n             tcx: cx.tcx,\n-            access_levels: &mut cx.renderinfo.access_levels,\n+            access_levels: &mut cx.cache.access_levels,\n             prev_level: Some(AccessLevel::Public),\n             visited_mods: FxHashSet::default(),\n         }"}]}