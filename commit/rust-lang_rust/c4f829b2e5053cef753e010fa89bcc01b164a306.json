{"sha": "c4f829b2e5053cef753e010fa89bcc01b164a306", "node_id": "C_kwDOAAsO6NoAKGM0ZjgyOWIyZTUwNTNjZWY3NTNlMDEwZmE4OWJjYzAxYjE2NGEzMDY", "commit": {"author": {"name": "Mara Bos", "email": "m-ou.se@m-ou.se", "date": "2022-10-19T11:33:45Z"}, "committer": {"name": "Mara Bos", "email": "m-ou.se@m-ou.se", "date": "2022-10-19T11:34:18Z"}, "message": "Allow #[unstable] impl for fn() -> UnstableType.\n\n(But not fn() -> !, which is stable.)", "tree": {"sha": "fd9bf8f2f71ec14eb2d391d12dc0dff8506a1546", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fd9bf8f2f71ec14eb2d391d12dc0dff8506a1546"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c4f829b2e5053cef753e010fa89bcc01b164a306", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c4f829b2e5053cef753e010fa89bcc01b164a306", "html_url": "https://github.com/rust-lang/rust/commit/c4f829b2e5053cef753e010fa89bcc01b164a306", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c4f829b2e5053cef753e010fa89bcc01b164a306/comments", "author": {"login": "m-ou-se", "id": 783247, "node_id": "MDQ6VXNlcjc4MzI0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/783247?v=4", "gravatar_id": "", "url": "https://api.github.com/users/m-ou-se", "html_url": "https://github.com/m-ou-se", "followers_url": "https://api.github.com/users/m-ou-se/followers", "following_url": "https://api.github.com/users/m-ou-se/following{/other_user}", "gists_url": "https://api.github.com/users/m-ou-se/gists{/gist_id}", "starred_url": "https://api.github.com/users/m-ou-se/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/m-ou-se/subscriptions", "organizations_url": "https://api.github.com/users/m-ou-se/orgs", "repos_url": "https://api.github.com/users/m-ou-se/repos", "events_url": "https://api.github.com/users/m-ou-se/events{/privacy}", "received_events_url": "https://api.github.com/users/m-ou-se/received_events", "type": "User", "site_admin": false}, "committer": {"login": "m-ou-se", "id": 783247, "node_id": "MDQ6VXNlcjc4MzI0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/783247?v=4", "gravatar_id": "", "url": "https://api.github.com/users/m-ou-se", "html_url": "https://github.com/m-ou-se", "followers_url": "https://api.github.com/users/m-ou-se/followers", "following_url": "https://api.github.com/users/m-ou-se/following{/other_user}", "gists_url": "https://api.github.com/users/m-ou-se/gists{/gist_id}", "starred_url": "https://api.github.com/users/m-ou-se/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/m-ou-se/subscriptions", "organizations_url": "https://api.github.com/users/m-ou-se/orgs", "repos_url": "https://api.github.com/users/m-ou-se/repos", "events_url": "https://api.github.com/users/m-ou-se/events{/privacy}", "received_events_url": "https://api.github.com/users/m-ou-se/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5420fa388197ee61fc799ea22ea9bb820306dbb9", "url": "https://api.github.com/repos/rust-lang/rust/commits/5420fa388197ee61fc799ea22ea9bb820306dbb9", "html_url": "https://github.com/rust-lang/rust/commit/5420fa388197ee61fc799ea22ea9bb820306dbb9"}], "stats": {"total": 29, "additions": 22, "deletions": 7}, "files": [{"sha": "9591aeb881f3d58c8e4790e0120ff7e7f5381b9d", "filename": "compiler/rustc_passes/src/stability.rs", "status": "modified", "additions": 19, "deletions": 7, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/c4f829b2e5053cef753e010fa89bcc01b164a306/compiler%2Frustc_passes%2Fsrc%2Fstability.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c4f829b2e5053cef753e010fa89bcc01b164a306/compiler%2Frustc_passes%2Fsrc%2Fstability.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fstability.rs?ref=c4f829b2e5053cef753e010fa89bcc01b164a306", "patch": "@@ -888,14 +888,26 @@ impl<'tcx> Visitor<'tcx> for CheckTraitImplStable<'tcx> {\n     }\n \n     fn visit_ty(&mut self, t: &'tcx Ty<'tcx>) {\n-        match t.kind {\n-            TyKind::Never => self.fully_stable = false,\n-            TyKind::BareFn(f) => {\n-                if rustc_target::spec::abi::is_stable(f.abi.name()).is_err() {\n-                    self.fully_stable = false;\n-                }\n+        if let TyKind::Never = t.kind {\n+            self.fully_stable = false;\n+        }\n+        if let TyKind::BareFn(f) = t.kind {\n+            if rustc_target::spec::abi::is_stable(f.abi.name()).is_err() {\n+                self.fully_stable = false;\n+            }\n+        }\n+        intravisit::walk_ty(self, t)\n+    }\n+\n+    fn visit_fn_decl(&mut self, fd: &'tcx hir::FnDecl<'tcx>) {\n+        for ty in fd.inputs {\n+            self.visit_ty(ty)\n+        }\n+        if let hir::FnRetTy::Return(output_ty) = fd.output {\n+            match output_ty.kind {\n+                TyKind::Never => {} // `-> !` is stable\n+                _ => self.visit_ty(output_ty),\n             }\n-            _ => intravisit::walk_ty(self, t),\n         }\n     }\n }"}, {"sha": "0c771ae87953c4ef24f9135430681def9f7937ac", "filename": "src/test/ui/stability-attribute/stability-attribute-trait-impl.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/c4f829b2e5053cef753e010fa89bcc01b164a306/src%2Ftest%2Fui%2Fstability-attribute%2Fstability-attribute-trait-impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c4f829b2e5053cef753e010fa89bcc01b164a306/src%2Ftest%2Fui%2Fstability-attribute%2Fstability-attribute-trait-impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fstability-attribute%2Fstability-attribute-trait-impl.rs?ref=c4f829b2e5053cef753e010fa89bcc01b164a306", "patch": "@@ -37,4 +37,7 @@ impl StableTrait for StableType {}\n //~^ ERROR an `#[unstable]` annotation here has no effect [ineffective_unstable_trait_impl]\n impl StableTrait for fn() -> ! {}\n \n+#[unstable(feature = \"l\", issue = \"none\")]\n+impl StableTrait for fn() -> UnstableType {}\n+\n fn main() {}"}]}