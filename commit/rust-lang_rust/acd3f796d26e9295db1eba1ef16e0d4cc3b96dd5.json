{"sha": "acd3f796d26e9295db1eba1ef16e0d4cc3b96dd5", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFjZDNmNzk2ZDI2ZTkyOTVkYjFlYmExZWYxNmUwZDRjYzNiOTZkZDU=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-08-28T23:13:16Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2016-08-28T23:13:16Z"}, "message": "Auto merge of #36059 - CryZe:improved-demangling, r=alexcrichton\n\nImprove Demangling of Rust Symbols\n\nThis turns `..` into `::`, handles some more escapes and gets rid of unwanted underscores at the beginning of path elements.\n\n![Image of Diff](http://puu.sh/qQIN3.png)", "tree": {"sha": "ed14b4c39929032cad2a4fd068c7e823ac882b88", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ed14b4c39929032cad2a4fd068c7e823ac882b88"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/acd3f796d26e9295db1eba1ef16e0d4cc3b96dd5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/acd3f796d26e9295db1eba1ef16e0d4cc3b96dd5", "html_url": "https://github.com/rust-lang/rust/commit/acd3f796d26e9295db1eba1ef16e0d4cc3b96dd5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/acd3f796d26e9295db1eba1ef16e0d4cc3b96dd5/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "312734ca4295f6fa95c70d190ef297f926657155", "url": "https://api.github.com/repos/rust-lang/rust/commits/312734ca4295f6fa95c70d190ef297f926657155", "html_url": "https://github.com/rust-lang/rust/commit/312734ca4295f6fa95c70d190ef297f926657155"}, {"sha": "121b2fe988f47996933af699d6223de8e9262df0", "url": "https://api.github.com/repos/rust-lang/rust/commits/121b2fe988f47996933af699d6223de8e9262df0", "html_url": "https://github.com/rust-lang/rust/commit/121b2fe988f47996933af699d6223de8e9262df0"}], "stats": {"total": 66, "additions": 47, "deletions": 19}, "files": [{"sha": "a509b80eaca9143eb33bc218b2efbce111637cb2", "filename": "src/libstd/sys/common/backtrace.rs", "status": "modified", "additions": 47, "deletions": 19, "changes": 66, "blob_url": "https://github.com/rust-lang/rust/blob/acd3f796d26e9295db1eba1ef16e0d4cc3b96dd5/src%2Flibstd%2Fsys%2Fcommon%2Fbacktrace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/acd3f796d26e9295db1eba1ef16e0d4cc3b96dd5/src%2Flibstd%2Fsys%2Fcommon%2Fbacktrace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Fcommon%2Fbacktrace.rs?ref=acd3f796d26e9295db1eba1ef16e0d4cc3b96dd5", "patch": "@@ -137,10 +137,21 @@ pub fn demangle(writer: &mut Write, s: &str) -> io::Result<()> {\n             let i: usize = inner[.. (inner.len() - rest.len())].parse().unwrap();\n             inner = &rest[i..];\n             rest = &rest[..i];\n+            if rest.starts_with(\"_$\") {\n+                rest = &rest[1..];\n+            }\n             while !rest.is_empty() {\n-                if rest.starts_with(\"$\") {\n+                if rest.starts_with(\".\") {\n+                    if let Some('.') = rest[1..].chars().next() {\n+                        writer.write_all(b\"::\")?;\n+                        rest = &rest[2..];\n+                    } else {\n+                        writer.write_all(b\".\")?;\n+                        rest = &rest[1..];\n+                    }\n+                } else if rest.starts_with(\"$\") {\n                     macro_rules! demangle {\n-                        ($($pat:expr, => $demangled:expr),*) => ({\n+                        ($($pat:expr => $demangled:expr),*) => ({\n                             $(if rest.starts_with($pat) {\n                                 try!(writer.write_all($demangled));\n                                 rest = &rest[$pat.len()..];\n@@ -155,29 +166,32 @@ pub fn demangle(writer: &mut Write, s: &str) -> io::Result<()> {\n \n                     // see src/librustc/back/link.rs for these mappings\n                     demangle! (\n-                        \"$SP$\", => b\"@\",\n-                        \"$BP$\", => b\"*\",\n-                        \"$RF$\", => b\"&\",\n-                        \"$LT$\", => b\"<\",\n-                        \"$GT$\", => b\">\",\n-                        \"$LP$\", => b\"(\",\n-                        \"$RP$\", => b\")\",\n-                        \"$C$\", => b\",\",\n+                        \"$SP$\" => b\"@\",\n+                        \"$BP$\" => b\"*\",\n+                        \"$RF$\" => b\"&\",\n+                        \"$LT$\" => b\"<\",\n+                        \"$GT$\" => b\">\",\n+                        \"$LP$\" => b\"(\",\n+                        \"$RP$\" => b\")\",\n+                        \"$C$\" => b\",\",\n \n                         // in theory we can demangle any Unicode code point, but\n                         // for simplicity we just catch the common ones.\n-                        \"$u7e$\", => b\"~\",\n-                        \"$u20$\", => b\" \",\n-                        \"$u27$\", => b\"'\",\n-                        \"$u5b$\", => b\"[\",\n-                        \"$u5d$\", => b\"]\",\n-                        \"$u7b$\", => b\"{\",\n-                        \"$u7d$\", => b\"}\"\n+                        \"$u7e$\" => b\"~\",\n+                        \"$u20$\" => b\" \",\n+                        \"$u27$\" => b\"'\",\n+                        \"$u5b$\" => b\"[\",\n+                        \"$u5d$\" => b\"]\",\n+                        \"$u7b$\" => b\"{\",\n+                        \"$u7d$\" => b\"}\",\n+                        \"$u3b$\" => b\";\",\n+                        \"$u2b$\" => b\"+\",\n+                        \"$u22$\" => b\"\\\"\"\n                     )\n                 } else {\n-                    let idx = match rest.find('$') {\n+                    let idx = match rest.char_indices().find(|&(_, c)| c == '$' || c == '.') {\n                         None => rest.len(),\n-                        Some(i) => i,\n+                        Some((i, _)) => i,\n                     };\n                     writer.write_all(rest[..idx].as_bytes())?;\n                     rest = &rest[idx..];\n@@ -212,6 +226,7 @@ mod tests {\n         t!(\"_ZN8$RF$testE\", \"&test\");\n         t!(\"_ZN8$BP$test4foobE\", \"*test::foob\");\n         t!(\"_ZN9$u20$test4foobE\", \" test::foob\");\n+        t!(\"_ZN35Bar$LT$$u5b$u32$u3b$$u20$4$u5d$$GT$E\", \"Bar<[u32; 4]>\");\n     }\n \n     #[test]\n@@ -226,4 +241,17 @@ mod tests {\n         t!(\"ZN13test$u20$test4foobE\", \"test test::foob\");\n         t!(\"ZN12test$RF$test4foobE\", \"test&test::foob\");\n     }\n+\n+    #[test]\n+    fn demangle_elements_beginning_with_underscore() {\n+        t!(\"_ZN13_$LT$test$GT$E\", \"<test>\");\n+        t!(\"_ZN28_$u7b$$u7b$closure$u7d$$u7d$E\", \"{{closure}}\");\n+        t!(\"_ZN15__STATIC_FMTSTRE\", \"__STATIC_FMTSTR\");\n+    }\n+\n+    #[test]\n+    fn demangle_trait_impls() {\n+        t!(\"_ZN71_$LT$Test$u20$$u2b$$u20$$u27$static$u20$as$u20$foo..Bar$LT$Test$GT$$GT$3barE\",\n+           \"<Test + 'static as foo::Bar<Test>>::bar\");\n+    }\n }"}]}