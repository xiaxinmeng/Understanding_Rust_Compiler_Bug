{"sha": "d2f2f2546358f60c22da98918535cd932589de5c", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQyZjJmMjU0NjM1OGY2MGMyMmRhOTg5MTg1MzVjZDkzMjU4OWRlNWM=", "commit": {"author": {"name": "clippered", "email": "clarke_overkill@yahoo.com", "date": "2017-11-09T20:23:12Z"}, "committer": {"name": "clippered", "email": "clarke_overkill@yahoo.com", "date": "2017-11-13T09:18:03Z"}, "message": "add cli option for color", "tree": {"sha": "4b78598b640665a878dd7f7489a5a61b2f722133", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4b78598b640665a878dd7f7489a5a61b2f722133"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d2f2f2546358f60c22da98918535cd932589de5c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d2f2f2546358f60c22da98918535cd932589de5c", "html_url": "https://github.com/rust-lang/rust/commit/d2f2f2546358f60c22da98918535cd932589de5c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d2f2f2546358f60c22da98918535cd932589de5c/comments", "author": {"login": "clippered", "id": 5051900, "node_id": "MDQ6VXNlcjUwNTE5MDA=", "avatar_url": "https://avatars.githubusercontent.com/u/5051900?v=4", "gravatar_id": "", "url": "https://api.github.com/users/clippered", "html_url": "https://github.com/clippered", "followers_url": "https://api.github.com/users/clippered/followers", "following_url": "https://api.github.com/users/clippered/following{/other_user}", "gists_url": "https://api.github.com/users/clippered/gists{/gist_id}", "starred_url": "https://api.github.com/users/clippered/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/clippered/subscriptions", "organizations_url": "https://api.github.com/users/clippered/orgs", "repos_url": "https://api.github.com/users/clippered/repos", "events_url": "https://api.github.com/users/clippered/events{/privacy}", "received_events_url": "https://api.github.com/users/clippered/received_events", "type": "User", "site_admin": false}, "committer": {"login": "clippered", "id": 5051900, "node_id": "MDQ6VXNlcjUwNTE5MDA=", "avatar_url": "https://avatars.githubusercontent.com/u/5051900?v=4", "gravatar_id": "", "url": "https://api.github.com/users/clippered", "html_url": "https://github.com/clippered", "followers_url": "https://api.github.com/users/clippered/followers", "following_url": "https://api.github.com/users/clippered/following{/other_user}", "gists_url": "https://api.github.com/users/clippered/gists{/gist_id}", "starred_url": "https://api.github.com/users/clippered/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/clippered/subscriptions", "organizations_url": "https://api.github.com/users/clippered/orgs", "repos_url": "https://api.github.com/users/clippered/repos", "events_url": "https://api.github.com/users/clippered/events{/privacy}", "received_events_url": "https://api.github.com/users/clippered/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8a27a2da622dc51d4cea7378bf95c79ce99ba21e", "url": "https://api.github.com/repos/rust-lang/rust/commits/8a27a2da622dc51d4cea7378bf95c79ce99ba21e", "html_url": "https://github.com/rust-lang/rust/commit/8a27a2da622dc51d4cea7378bf95c79ce99ba21e"}], "stats": {"total": 70, "additions": 57, "deletions": 13}, "files": [{"sha": "fd9f9021484802bc52682681d4c2ae4901371036", "filename": "src/bin/rustfmt.rs", "status": "modified", "additions": 19, "deletions": 1, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/d2f2f2546358f60c22da98918535cd932589de5c/src%2Fbin%2Frustfmt.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d2f2f2546358f60c22da98918535cd932589de5c/src%2Fbin%2Frustfmt.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbin%2Frustfmt.rs?ref=d2f2f2546358f60c22da98918535cd932589de5c", "patch": "@@ -25,7 +25,7 @@ use getopts::{HasArg, Matches, Occur, Options};\n \n use rustfmt::{run, Input, Summary};\n use rustfmt::file_lines::FileLines;\n-use rustfmt::config::{get_toml_path, Config, WriteMode};\n+use rustfmt::config::{get_toml_path, Color, Config, WriteMode};\n \n type FmtError = Box<error::Error + Send + Sync>;\n type FmtResult<T> = std::result::Result<T, FmtError>;\n@@ -59,6 +59,7 @@ struct CliOptions {\n     skip_children: bool,\n     verbose: bool,\n     write_mode: Option<WriteMode>,\n+    color: Option<Color>,\n     file_lines: FileLines, // Default is all lines in all files.\n     unstable_features: bool,\n }\n@@ -90,6 +91,14 @@ impl CliOptions {\n             }\n         }\n \n+        if let Some(ref color) = matches.opt_str(\"color\") {\n+            if let Ok(color) = Color::from_str(color) {\n+                options.color = Some(color);\n+            } else {\n+                return Err(FmtError::from(format!(\"Invalid color: {}\", color)));\n+            }\n+        }\n+\n         if let Some(ref file_lines) = matches.opt_str(\"file-lines\") {\n             options.file_lines = file_lines.parse()?;\n         }\n@@ -105,6 +114,9 @@ impl CliOptions {\n         if let Some(write_mode) = self.write_mode {\n             config.set().write_mode(write_mode);\n         }\n+        if let Some(color) = self.color {\n+            config.set().color(color);\n+        }\n     }\n }\n \n@@ -131,6 +143,12 @@ fn make_opts() -> Options {\n         \"how to write output (not usable when piping from stdin)\",\n         \"[replace|overwrite|display|plain|diff|coverage|checkstyle]\",\n     );\n+    opts.optopt(\n+        \"\",\n+        \"color\",\n+        \"use colored output (if supported)\",\n+        \"[always|never|auto]\",\n+    );\n     opts.optflag(\"\", \"skip-children\", \"don't reformat child modules\");\n \n     opts.optflag("}, {"sha": "430402d27848f3583c4dd6f1100be6e67e92282c", "filename": "src/config.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/d2f2f2546358f60c22da98918535cd932589de5c/src%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d2f2f2546358f60c22da98918535cd932589de5c/src%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fconfig.rs?ref=d2f2f2546358f60c22da98918535cd932589de5c", "patch": "@@ -152,6 +152,15 @@ configuration_option_enum! { WriteMode:\n     Checkstyle,\n }\n \n+configuration_option_enum! { Color:\n+    // Always use color, whether it is a piped or terminal output\n+    Always,\n+    // Never use color\n+    Never,\n+    // Automatically use color, if supported by terminal\n+    Auto,\n+}\n+\n /// Trait for types that can be used in `Config`.\n pub trait ConfigType: Sized {\n     /// Returns hint text for use in `Config::print_docs()`. For enum types, this is a\n@@ -643,6 +652,8 @@ create_config! {\n     write_mode: WriteMode, WriteMode::Overwrite, false,\n         \"What Write Mode to use when none is supplied: \\\n          Replace, Overwrite, Display, Plain, Diff, Coverage\";\n+    color: Color, Color::Auto, false,\n+        \"What Color option to use when none is supplied: Always, Never, Auto\";\n     condense_wildcard_suffixes: bool, false, false, \"Replace strings of _ wildcards by a single .. \\\n                                               in tuple patterns\";\n     combine_control_expr: bool, true, false, \"Combine control expressions with function calls.\";"}, {"sha": "5942934d877f1e33e1c7415e763ddb394bf2bbf0", "filename": "src/filemap.rs", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/d2f2f2546358f60c22da98918535cd932589de5c/src%2Ffilemap.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d2f2f2546358f60c22da98918535cd932589de5c/src%2Ffilemap.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ffilemap.rs?ref=d2f2f2546358f60c22da98918535cd932589de5c", "patch": "@@ -152,9 +152,11 @@ where\n             if let Ok((ori, fmt)) = source_and_formatted_text(text, filename, config) {\n                 let mismatch = make_diff(&ori, &fmt, 3);\n                 let has_diff = !mismatch.is_empty();\n-                print_diff(mismatch, |line_num| {\n-                    format!(\"Diff in {} at line {}:\", filename, line_num)\n-                });\n+                print_diff(\n+                    mismatch,\n+                    |line_num| format!(\"Diff in {} at line {}:\", filename, line_num),\n+                    config.color(),\n+                );\n                 return Ok(has_diff);\n             }\n         }"}, {"sha": "dfdf4b5143f4ecac094b72475bd0c1c773e79dd5", "filename": "src/lib.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/d2f2f2546358f60c22da98918535cd932589de5c/src%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d2f2f2546358f60c22da98918535cd932589de5c/src%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flib.rs?ref=d2f2f2546358f60c22da98918535cd932589de5c", "patch": "@@ -44,7 +44,7 @@ use checkstyle::{output_footer, output_header};\n use config::Config;\n use filemap::FileMap;\n use issues::{BadIssueSeeker, Issue};\n-use utils::isatty;\n+use utils::iscolored;\n use visitor::FmtVisitor;\n \n pub use self::summary::Summary;\n@@ -581,7 +581,8 @@ pub fn run(input: Input, config: &Config) -> Summary {\n             if report.has_warnings() {\n                 match term::stderr() {\n                     Some(ref t)\n-                        if isatty() && t.supports_color() && t.supports_attr(term::Attr::Bold) =>\n+                        if iscolored(config.color()) && t.supports_color()\n+                            && t.supports_attr(term::Attr::Bold) =>\n                     {\n                         match report.print_warnings_fancy(term::stderr().unwrap()) {\n                             Ok(..) => (),"}, {"sha": "858fb876f6e2aa3a693d6dde9a3125bde1dc2551", "filename": "src/rustfmt_diff.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/d2f2f2546358f60c22da98918535cd932589de5c/src%2Frustfmt_diff.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d2f2f2546358f60c22da98918535cd932589de5c/src%2Frustfmt_diff.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustfmt_diff.rs?ref=d2f2f2546358f60c22da98918535cd932589de5c", "patch": "@@ -8,11 +8,12 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n+use config::Color;\n use diff;\n use std::collections::VecDeque;\n use std::io;\n use term;\n-use utils::isatty;\n+use utils::iscolored;\n \n #[derive(Debug, PartialEq)]\n pub enum DiffLine {\n@@ -96,12 +97,12 @@ pub fn make_diff(expected: &str, actual: &str, context_size: usize) -> Vec<Misma\n     results\n }\n \n-pub fn print_diff<F>(diff: Vec<Mismatch>, get_section_title: F)\n+pub fn print_diff<F>(diff: Vec<Mismatch>, get_section_title: F, color: Color)\n where\n     F: Fn(u32) -> String,\n {\n     match term::stdout() {\n-        Some(ref t) if isatty() && t.supports_color() => {\n+        Some(ref t) if iscolored(color) && t.supports_color() => {\n             print_diff_fancy(diff, get_section_title, term::stdout().unwrap())\n         }\n         _ => print_diff_basic(diff, get_section_title),"}, {"sha": "68fca8789d3c5e34ca101a07b0c39dd8746ab67a", "filename": "src/utils.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/d2f2f2546358f60c22da98918535cd932589de5c/src%2Futils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d2f2f2546358f60c22da98918535cd932589de5c/src%2Futils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Futils.rs?ref=d2f2f2546358f60c22da98918535cd932589de5c", "patch": "@@ -15,6 +15,7 @@ use syntax::ast::{self, Attribute, CrateSugar, MetaItem, MetaItemKind, NestedMet\n                   NestedMetaItemKind, Path, Visibility};\n use syntax::codemap::{BytePos, Span, NO_EXPANSION};\n \n+use config::Color;\n use rewrite::RewriteContext;\n use shape::Shape;\n \n@@ -484,6 +485,14 @@ pub fn isatty() -> bool {\n     }\n }\n \n+pub fn iscolored(color: Color) -> bool {\n+    match color {\n+        Color::Always => true,\n+        Color::Never => false,\n+        Color::Auto => isatty(),\n+    }\n+}\n+\n pub fn starts_with_newline(s: &str) -> bool {\n     s.starts_with('\\n') || s.starts_with(\"\\r\\n\")\n }"}, {"sha": "aaf287ea7aae4f8bebc9ce4890b6de87e8e4b568", "filename": "tests/system.rs", "status": "modified", "additions": 6, "deletions": 4, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/d2f2f2546358f60c22da98918535cd932589de5c/tests%2Fsystem.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d2f2f2546358f60c22da98918535cd932589de5c/tests%2Fsystem.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsystem.rs?ref=d2f2f2546358f60c22da98918535cd932589de5c", "patch": "@@ -23,7 +23,7 @@ use std::str::Chars;\n \n use rustfmt::*;\n use rustfmt::filemap::{write_system_newlines, FileMap};\n-use rustfmt::config::{Config, ReportTactic};\n+use rustfmt::config::{Color, Config, ReportTactic};\n use rustfmt::rustfmt_diff::*;\n \n const DIFF_CONTEXT_SIZE: usize = 3;\n@@ -229,9 +229,11 @@ fn print_mismatches(result: HashMap<String, Vec<Mismatch>>) {\n     let mut t = term::stdout().unwrap();\n \n     for (file_name, diff) in result {\n-        print_diff(diff, |line_num| {\n-            format!(\"\\nMismatch at {}:{}:\", file_name, line_num)\n-        });\n+        print_diff(\n+            diff,\n+            |line_num| format!(\"\\nMismatch at {}:{}:\", file_name, line_num),\n+            Color::Auto,\n+        );\n     }\n \n     t.reset().unwrap();"}]}