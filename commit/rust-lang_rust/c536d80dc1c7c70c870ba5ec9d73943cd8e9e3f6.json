{"sha": "c536d80dc1c7c70c870ba5ec9d73943cd8e9e3f6", "node_id": "MDY6Q29tbWl0NzI0NzEyOmM1MzZkODBkYzFjN2M3MGM4NzBiYTVlYzlkNzM5NDNjZDhlOWUzZjY=", "commit": {"author": {"name": "St\u00e9phane Campinas", "email": "stephane.campinas@gmail.com", "date": "2020-12-07T12:08:45Z"}, "committer": {"name": "Caleb Cartwright", "email": "calebcartwright@users.noreply.github.com", "date": "2020-12-20T18:05:05Z"}, "message": "Fix rewrite of closures with a return type\n\nIf the closure's body fits in a line, the block is removed but it is\nnecessary if the closure has a return type.", "tree": {"sha": "a72317b2cfc7ea810bbb22994c1e8971b70337f3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a72317b2cfc7ea810bbb22994c1e8971b70337f3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c536d80dc1c7c70c870ba5ec9d73943cd8e9e3f6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c536d80dc1c7c70c870ba5ec9d73943cd8e9e3f6", "html_url": "https://github.com/rust-lang/rust/commit/c536d80dc1c7c70c870ba5ec9d73943cd8e9e3f6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c536d80dc1c7c70c870ba5ec9d73943cd8e9e3f6/comments", "author": {"login": "scampi", "id": 795879, "node_id": "MDQ6VXNlcjc5NTg3OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/795879?v=4", "gravatar_id": "", "url": "https://api.github.com/users/scampi", "html_url": "https://github.com/scampi", "followers_url": "https://api.github.com/users/scampi/followers", "following_url": "https://api.github.com/users/scampi/following{/other_user}", "gists_url": "https://api.github.com/users/scampi/gists{/gist_id}", "starred_url": "https://api.github.com/users/scampi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/scampi/subscriptions", "organizations_url": "https://api.github.com/users/scampi/orgs", "repos_url": "https://api.github.com/users/scampi/repos", "events_url": "https://api.github.com/users/scampi/events{/privacy}", "received_events_url": "https://api.github.com/users/scampi/received_events", "type": "User", "site_admin": false}, "committer": {"login": "calebcartwright", "id": 13042488, "node_id": "MDQ6VXNlcjEzMDQyNDg4", "avatar_url": "https://avatars.githubusercontent.com/u/13042488?v=4", "gravatar_id": "", "url": "https://api.github.com/users/calebcartwright", "html_url": "https://github.com/calebcartwright", "followers_url": "https://api.github.com/users/calebcartwright/followers", "following_url": "https://api.github.com/users/calebcartwright/following{/other_user}", "gists_url": "https://api.github.com/users/calebcartwright/gists{/gist_id}", "starred_url": "https://api.github.com/users/calebcartwright/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/calebcartwright/subscriptions", "organizations_url": "https://api.github.com/users/calebcartwright/orgs", "repos_url": "https://api.github.com/users/calebcartwright/repos", "events_url": "https://api.github.com/users/calebcartwright/events{/privacy}", "received_events_url": "https://api.github.com/users/calebcartwright/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4cfb9ef8f4436cb1150022897f900c461c9f581c", "url": "https://api.github.com/repos/rust-lang/rust/commits/4cfb9ef8f4436cb1150022897f900c461c9f581c", "html_url": "https://github.com/rust-lang/rust/commit/4cfb9ef8f4436cb1150022897f900c461c9f581c"}], "stats": {"total": 58, "additions": 48, "deletions": 10}, "files": [{"sha": "71b07e4b9ee2aefeafd375835af9a491b6610ee1", "filename": "src/closures.rs", "status": "modified", "additions": 13, "deletions": 10, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/c536d80dc1c7c70c870ba5ec9d73943cd8e9e3f6/src%2Fclosures.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c536d80dc1c7c70c870ba5ec9d73943cd8e9e3f6/src%2Fclosures.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fclosures.rs?ref=c536d80dc1c7c70c870ba5ec9d73943cd8e9e3f6", "patch": "@@ -339,18 +339,21 @@ pub(crate) fn rewrite_last_closure(\n         if is_block_closure_forced(context, body) {\n             return rewrite_closure_with_block(body, &prefix, context, body_shape).and_then(\n                 |body_str| {\n-                    // If the expression can fit in a single line, we need not force block closure.\n-                    if body_str.lines().count() <= 7 {\n-                        match rewrite_closure_expr(body, &prefix, context, shape) {\n-                            Some(ref single_line_body_str)\n-                                if !single_line_body_str.contains('\\n') =>\n-                            {\n-                                Some(single_line_body_str.clone())\n+                    match fn_decl.output {\n+                        ast::FnRetTy::Default(..) if body_str.lines().count() <= 7 => {\n+                            // If the expression can fit in a single line, we need not force block\n+                            // closure.  However, if the closure has a return type, then we must\n+                            // keep the blocks.\n+                            match rewrite_closure_expr(body, &prefix, context, shape) {\n+                                Some(ref single_line_body_str)\n+                                    if !single_line_body_str.contains('\\n') =>\n+                                {\n+                                    Some(single_line_body_str.clone())\n+                                }\n+                                _ => Some(body_str),\n                             }\n-                            _ => Some(body_str),\n                         }\n-                    } else {\n-                        Some(body_str)\n+                        _ => Some(body_str),\n                     }\n                 },\n             );"}, {"sha": "79975dd73ffc4302fcb3fa0169fd2b65fb306351", "filename": "tests/source/issue-4577.rs", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/c536d80dc1c7c70c870ba5ec9d73943cd8e9e3f6/tests%2Fsource%2Fissue-4577.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c536d80dc1c7c70c870ba5ec9d73943cd8e9e3f6/tests%2Fsource%2Fissue-4577.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fissue-4577.rs?ref=c536d80dc1c7c70c870ba5ec9d73943cd8e9e3f6", "patch": "@@ -0,0 +1,20 @@\n+fn main() {\n+    let s: String = \"ABAABBAA\".chars()\n+        .filter(|c| {\n+            if *c == 'A' {\n+                true\n+            }\n+            else {\n+                false\n+            }\n+        })\n+        .map(|c| -> char {\n+        if c == 'A' {\n+            '0'\n+        } else {\n+            '1'\n+        }\n+    }).collect();\n+    \n+    println!(\"{}\", s);\n+}"}, {"sha": "1bd9eb6b806083808c7a07627057cce94ea7ea2a", "filename": "tests/target/issue-4577.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/c536d80dc1c7c70c870ba5ec9d73943cd8e9e3f6/tests%2Ftarget%2Fissue-4577.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c536d80dc1c7c70c870ba5ec9d73943cd8e9e3f6/tests%2Ftarget%2Fissue-4577.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fissue-4577.rs?ref=c536d80dc1c7c70c870ba5ec9d73943cd8e9e3f6", "patch": "@@ -0,0 +1,15 @@\n+fn main() {\n+    let s: String = \"ABAABBAA\"\n+        .chars()\n+        .filter(|c| if *c == 'A' { true } else { false })\n+        .map(|c| -> char {\n+            if c == 'A' {\n+                '0'\n+            } else {\n+                '1'\n+            }\n+        })\n+        .collect();\n+\n+    println!(\"{}\", s);\n+}"}]}