{"sha": "e78df83e2fb89b475187f7d4b631a68619b590b5", "node_id": "C_kwDOAAsO6NoAKGU3OGRmODNlMmZiODliNDc1MTg3ZjdkNGI2MzFhNjg2MTliNTkwYjU", "commit": {"author": {"name": "Sebastian Ziebell", "email": "sebastian.ziebell@ferrous-systems.com", "date": "2023-05-26T11:43:12Z"}, "committer": {"name": "Sebastian Ziebell", "email": "sebastian.ziebell@ferrous-systems.com", "date": "2023-05-26T11:43:12Z"}, "message": "Integrate feedback\n\n* pass in existing `Semantics` object to function\n* pass in `Definition` for param type\n* refactor iterator to use `flatten`", "tree": {"sha": "a90e8d997ecd89e3c312cbadc31988518c80abfa", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a90e8d997ecd89e3c312cbadc31988518c80abfa"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e78df83e2fb89b475187f7d4b631a68619b590b5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e78df83e2fb89b475187f7d4b631a68619b590b5", "html_url": "https://github.com/rust-lang/rust/commit/e78df83e2fb89b475187f7d4b631a68619b590b5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e78df83e2fb89b475187f7d4b631a68619b590b5/comments", "author": {"login": "justahero", "id": 1305185, "node_id": "MDQ6VXNlcjEzMDUxODU=", "avatar_url": "https://avatars.githubusercontent.com/u/1305185?v=4", "gravatar_id": "", "url": "https://api.github.com/users/justahero", "html_url": "https://github.com/justahero", "followers_url": "https://api.github.com/users/justahero/followers", "following_url": "https://api.github.com/users/justahero/following{/other_user}", "gists_url": "https://api.github.com/users/justahero/gists{/gist_id}", "starred_url": "https://api.github.com/users/justahero/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/justahero/subscriptions", "organizations_url": "https://api.github.com/users/justahero/orgs", "repos_url": "https://api.github.com/users/justahero/repos", "events_url": "https://api.github.com/users/justahero/events{/privacy}", "received_events_url": "https://api.github.com/users/justahero/received_events", "type": "User", "site_admin": false}, "committer": {"login": "justahero", "id": 1305185, "node_id": "MDQ6VXNlcjEzMDUxODU=", "avatar_url": "https://avatars.githubusercontent.com/u/1305185?v=4", "gravatar_id": "", "url": "https://api.github.com/users/justahero", "html_url": "https://github.com/justahero", "followers_url": "https://api.github.com/users/justahero/followers", "following_url": "https://api.github.com/users/justahero/following{/other_user}", "gists_url": "https://api.github.com/users/justahero/gists{/gist_id}", "starred_url": "https://api.github.com/users/justahero/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/justahero/subscriptions", "organizations_url": "https://api.github.com/users/justahero/orgs", "repos_url": "https://api.github.com/users/justahero/repos", "events_url": "https://api.github.com/users/justahero/events{/privacy}", "received_events_url": "https://api.github.com/users/justahero/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ce1c85317f80b96b5fdc65fa2e76d4150f26abfa", "url": "https://api.github.com/repos/rust-lang/rust/commits/ce1c85317f80b96b5fdc65fa2e76d4150f26abfa", "html_url": "https://github.com/rust-lang/rust/commit/ce1c85317f80b96b5fdc65fa2e76d4150f26abfa"}], "stats": {"total": 21, "additions": 8, "deletions": 13}, "files": [{"sha": "f32ceb42654bb6a48a64a2f53b36813fbb5d5f28", "filename": "crates/ide-assists/src/handlers/replace_named_generic_with_impl.rs", "status": "modified", "additions": 8, "deletions": 13, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/e78df83e2fb89b475187f7d4b631a68619b590b5/crates%2Fide-assists%2Fsrc%2Fhandlers%2Freplace_named_generic_with_impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e78df83e2fb89b475187f7d4b631a68619b590b5/crates%2Fide-assists%2Fsrc%2Fhandlers%2Freplace_named_generic_with_impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-assists%2Fsrc%2Fhandlers%2Freplace_named_generic_with_impl.rs?ref=e78df83e2fb89b475187f7d4b631a68619b590b5", "patch": "@@ -1,4 +1,4 @@\n-use hir::{Semantics, TypeParam};\n+use hir::Semantics;\n use ide_db::{\n     base_db::{FileId, FileRange},\n     defs::Definition,\n@@ -60,7 +60,9 @@ pub(crate) fn replace_named_generic_with_impl(\n     }\n \n     let type_param_hir_def = ctx.sema.to_def(&type_param)?;\n-    if is_referenced_outside(ctx.db(), type_param_hir_def, &fn_, ctx.file_id()) {\n+    let type_param_def = Definition::GenericParam(hir::GenericParam::TypeParam(type_param_hir_def));\n+\n+    if is_referenced_outside(&ctx.sema, type_param_def, &fn_, ctx.file_id()) {\n         return None;\n     }\n \n@@ -100,27 +102,20 @@ pub(crate) fn replace_named_generic_with_impl(\n }\n \n fn is_referenced_outside(\n-    db: &RootDatabase,\n-    type_param: TypeParam,\n+    sema: &Semantics<'_, RootDatabase>,\n+    type_param_def: Definition,\n     fn_: &ast::Fn,\n     file_id: FileId,\n ) -> bool {\n-    let semantics = Semantics::new(db);\n-    let type_param_def = Definition::GenericParam(hir::GenericParam::TypeParam(type_param));\n-\n     // limit search scope to function body & return type\n     let search_ranges = vec![\n         fn_.body().map(|body| body.syntax().text_range()),\n         fn_.ret_type().map(|ret_type| ret_type.syntax().text_range()),\n     ];\n \n-    search_ranges.into_iter().filter_map(|search_range| search_range).any(|search_range| {\n+    search_ranges.into_iter().flatten().any(|search_range| {\n         let file_range = FileRange { file_id, range: search_range };\n-        !type_param_def\n-            .usages(&semantics)\n-            .in_scope(SearchScope::file_range(file_range))\n-            .all()\n-            .is_empty()\n+        !type_param_def.usages(sema).in_scope(SearchScope::file_range(file_range)).all().is_empty()\n     })\n }\n "}]}