{"sha": "69515819b625292f0c175a92d93339b2f231b947", "node_id": "MDY6Q29tbWl0NzI0NzEyOjY5NTE1ODE5YjYyNTI5MmYwYzE3NWE5MmQ5MzMzOWIyZjIzMWI5NDc=", "commit": {"author": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2020-08-01T16:30:14Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-08-01T16:30:14Z"}, "message": "Rollup merge of #74983 - oli-obk:mir_opt_goto_chain, r=ecstatic-morse\n\nReplace a recursive algorithm with an iterative one and a stack.\n\nfixes #74931", "tree": {"sha": "f799a02a1f4ca9c81d4970e499961641b538d850", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f799a02a1f4ca9c81d4970e499961641b538d850"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/69515819b625292f0c175a92d93339b2f231b947", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfJZiXCRBK7hj4Ov3rIwAAdHIIALK+LyiLrOhsObupOx2tn4oi\nzRjoCUC+F9LzVwGzqjDQQ6Hy/exAxMwNLmunV2KuHADTNp+zEGsPTZ1dreFT3ZgK\nWvcHg4/bZpajf6ynP6nFAiyY8xX/JThpypINezCtiZ0hATzwUgjI25DOzrdkE95C\ngL2YZbz3OciA5cOTY5oj6c/AWjBT0tcFjZS5a1s3SUryYN1Xpf5E2OsD3JnZI3nY\nLuuQvyMNh+VvSIqU3B0mjtyWIBtTRtL2XDzMRk64KsMjdL37kLDeBUquJ5iUtFJe\nllsUXjE1My2cnveJobo014tyLADghuNLL8uU+WqEqxh9InbgfAJWSuV6nu+cQ3E=\n=8i1X\n-----END PGP SIGNATURE-----\n", "payload": "tree f799a02a1f4ca9c81d4970e499961641b538d850\nparent e65d6ed80ff1b0f1f5bab3e210f8f2cd165d4f14\nparent aba0251c78f88b12c499ba956beb8a9734ffdc1a\nauthor Manish Goregaokar <manishsmail@gmail.com> 1596299414 -0700\ncommitter GitHub <noreply@github.com> 1596299414 -0700\n\nRollup merge of #74983 - oli-obk:mir_opt_goto_chain, r=ecstatic-morse\n\nReplace a recursive algorithm with an iterative one and a stack.\n\nfixes #74931\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/69515819b625292f0c175a92d93339b2f231b947", "html_url": "https://github.com/rust-lang/rust/commit/69515819b625292f0c175a92d93339b2f231b947", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/69515819b625292f0c175a92d93339b2f231b947/comments", "author": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e65d6ed80ff1b0f1f5bab3e210f8f2cd165d4f14", "url": "https://api.github.com/repos/rust-lang/rust/commits/e65d6ed80ff1b0f1f5bab3e210f8f2cd165d4f14", "html_url": "https://github.com/rust-lang/rust/commit/e65d6ed80ff1b0f1f5bab3e210f8f2cd165d4f14"}, {"sha": "aba0251c78f88b12c499ba956beb8a9734ffdc1a", "url": "https://api.github.com/repos/rust-lang/rust/commits/aba0251c78f88b12c499ba956beb8a9734ffdc1a", "html_url": "https://github.com/rust-lang/rust/commit/aba0251c78f88b12c499ba956beb8a9734ffdc1a"}], "stats": {"total": 69, "additions": 43, "deletions": 26}, "files": [{"sha": "9288d6e16f5e079e8937a78c521102d1944bb91e", "filename": "src/librustc_mir/transform/simplify.rs", "status": "modified", "additions": 43, "deletions": 26, "changes": 69, "blob_url": "https://github.com/rust-lang/rust/blob/69515819b625292f0c175a92d93339b2f231b947/src%2Flibrustc_mir%2Ftransform%2Fsimplify.rs", "raw_url": "https://github.com/rust-lang/rust/raw/69515819b625292f0c175a92d93339b2f231b947/src%2Flibrustc_mir%2Ftransform%2Fsimplify.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fsimplify.rs?ref=69515819b625292f0c175a92d93339b2f231b947", "patch": "@@ -33,6 +33,7 @@ use rustc_index::vec::{Idx, IndexVec};\n use rustc_middle::mir::visit::{MutVisitor, MutatingUseContext, PlaceContext, Visitor};\n use rustc_middle::mir::*;\n use rustc_middle::ty::TyCtxt;\n+use smallvec::SmallVec;\n use std::borrow::Cow;\n \n pub struct SimplifyCfg {\n@@ -172,9 +173,12 @@ impl<'a, 'tcx> CfgSimplifier<'a, 'tcx> {\n         }\n     }\n \n-    // Collapse a goto chain starting from `start`\n-    fn collapse_goto_chain(&mut self, start: &mut BasicBlock, changed: &mut bool) {\n-        let mut terminator = match self.basic_blocks[*start] {\n+    /// This function will return `None` if\n+    /// * the block has statements\n+    /// * the block has a terminator other than `goto`\n+    /// * the block has no terminator (meaning some other part of the current optimization stole it)\n+    fn take_terminator_if_simple_goto(&mut self, bb: BasicBlock) -> Option<Terminator<'tcx>> {\n+        match self.basic_blocks[bb] {\n             BasicBlockData {\n                 ref statements,\n                 terminator:\n@@ -183,32 +187,45 @@ impl<'a, 'tcx> CfgSimplifier<'a, 'tcx> {\n             } if statements.is_empty() => terminator.take(),\n             // if `terminator` is None, this means we are in a loop. In that\n             // case, let all the loop collapse to its entry.\n-            _ => return,\n-        };\n-\n-        let target = match terminator {\n-            Some(Terminator { kind: TerminatorKind::Goto { ref mut target }, .. }) => {\n-                self.collapse_goto_chain(target, changed);\n-                *target\n-            }\n-            _ => unreachable!(),\n-        };\n-        self.basic_blocks[*start].terminator = terminator;\n-\n-        debug!(\"collapsing goto chain from {:?} to {:?}\", *start, target);\n-\n-        *changed |= *start != target;\n+            _ => None,\n+        }\n+    }\n \n-        if self.pred_count[*start] == 1 {\n-            // This is the last reference to *start, so the pred-count to\n-            // to target is moved into the current block.\n-            self.pred_count[*start] = 0;\n-        } else {\n-            self.pred_count[target] += 1;\n-            self.pred_count[*start] -= 1;\n+    /// Collapse a goto chain starting from `start`\n+    fn collapse_goto_chain(&mut self, start: &mut BasicBlock, changed: &mut bool) {\n+        // Using `SmallVec` here, because in some logs on libcore oli-obk saw many single-element\n+        // goto chains. We should probably benchmark different sizes.\n+        let mut terminators: SmallVec<[_; 1]> = Default::default();\n+        let mut current = *start;\n+        while let Some(terminator) = self.take_terminator_if_simple_goto(current) {\n+            let target = match terminator {\n+                Terminator { kind: TerminatorKind::Goto { target }, .. } => target,\n+                _ => unreachable!(),\n+            };\n+            terminators.push((current, terminator));\n+            current = target;\n         }\n+        let last = current;\n+        *start = last;\n+        while let Some((current, mut terminator)) = terminators.pop() {\n+            let target = match terminator {\n+                Terminator { kind: TerminatorKind::Goto { ref mut target }, .. } => target,\n+                _ => unreachable!(),\n+            };\n+            *target = last;\n+            debug!(\"collapsing goto chain from {:?} to {:?}\", current, target);\n \n-        *start = target;\n+            if self.pred_count[current] == 1 {\n+                // This is the last reference to current, so the pred-count to\n+                // to target is moved into the current block.\n+                self.pred_count[current] = 0;\n+            } else {\n+                self.pred_count[*target] += 1;\n+                self.pred_count[current] -= 1;\n+            }\n+            *changed = true;\n+            self.basic_blocks[current].terminator = Some(terminator);\n+        }\n     }\n \n     // merge a block with 1 `goto` predecessor to its parent"}]}