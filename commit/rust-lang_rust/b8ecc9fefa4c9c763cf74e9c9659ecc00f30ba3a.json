{"sha": "b8ecc9fefa4c9c763cf74e9c9659ecc00f30ba3a", "node_id": "C_kwDOAAsO6NoAKGI4ZWNjOWZlZmE0YzljNzYzY2Y3NGU5Yzk2NTllY2MwMGYzMGJhM2E", "commit": {"author": {"name": "Will Crichton", "email": "wcrichto@cs.stanford.edu", "date": "2021-10-29T20:21:50Z"}, "committer": {"name": "Will Crichton", "email": "wcrichto@cs.stanford.edu", "date": "2021-10-29T20:21:50Z"}, "message": "Fix rare ICE during typeck in rustdoc scrape_examples", "tree": {"sha": "16cd23569e2eff56aee692ee68fcac6dd8be35b4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/16cd23569e2eff56aee692ee68fcac6dd8be35b4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b8ecc9fefa4c9c763cf74e9c9659ecc00f30ba3a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b8ecc9fefa4c9c763cf74e9c9659ecc00f30ba3a", "html_url": "https://github.com/rust-lang/rust/commit/b8ecc9fefa4c9c763cf74e9c9659ecc00f30ba3a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b8ecc9fefa4c9c763cf74e9c9659ecc00f30ba3a/comments", "author": {"login": "willcrichton", "id": 663326, "node_id": "MDQ6VXNlcjY2MzMyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/663326?v=4", "gravatar_id": "", "url": "https://api.github.com/users/willcrichton", "html_url": "https://github.com/willcrichton", "followers_url": "https://api.github.com/users/willcrichton/followers", "following_url": "https://api.github.com/users/willcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/willcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/willcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/willcrichton/subscriptions", "organizations_url": "https://api.github.com/users/willcrichton/orgs", "repos_url": "https://api.github.com/users/willcrichton/repos", "events_url": "https://api.github.com/users/willcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/willcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "willcrichton", "id": 663326, "node_id": "MDQ6VXNlcjY2MzMyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/663326?v=4", "gravatar_id": "", "url": "https://api.github.com/users/willcrichton", "html_url": "https://github.com/willcrichton", "followers_url": "https://api.github.com/users/willcrichton/followers", "following_url": "https://api.github.com/users/willcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/willcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/willcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/willcrichton/subscriptions", "organizations_url": "https://api.github.com/users/willcrichton/orgs", "repos_url": "https://api.github.com/users/willcrichton/repos", "events_url": "https://api.github.com/users/willcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/willcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fd5d614b7708c2bbd0a7c796af3c3b63f31a19ac", "url": "https://api.github.com/repos/rust-lang/rust/commits/fd5d614b7708c2bbd0a7c796af3c3b63f31a19ac", "html_url": "https://github.com/rust-lang/rust/commit/fd5d614b7708c2bbd0a7c796af3c3b63f31a19ac"}], "stats": {"total": 30, "additions": 28, "deletions": 2}, "files": [{"sha": "05e746573f47989f19da6f5a963214726f1b8ff9", "filename": "src/librustdoc/scrape_examples.rs", "status": "modified", "additions": 18, "deletions": 2, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/b8ecc9fefa4c9c763cf74e9c9659ecc00f30ba3a/src%2Flibrustdoc%2Fscrape_examples.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b8ecc9fefa4c9c763cf74e9c9659ecc00f30ba3a/src%2Flibrustdoc%2Fscrape_examples.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fscrape_examples.rs?ref=b8ecc9fefa4c9c763cf74e9c9659ecc00f30ba3a", "patch": "@@ -132,12 +132,28 @@ where\n     fn visit_expr(&mut self, ex: &'tcx hir::Expr<'tcx>) {\n         intravisit::walk_expr(self, ex);\n \n-        // Get type of function if expression is a function call\n         let tcx = self.tcx;\n+\n+        // If we visit an item that contains an expression outside a function body,\n+        // then we need to exit before calling typeck (which will panic). See\n+        // test/run-make/rustdoc-scrape-examples-invalid-expr for an example.\n+        let hir = tcx.hir();\n+        let owner = hir.local_def_id_to_hir_id(ex.hir_id.owner);\n+        if hir.maybe_body_owned_by(owner).is_none() {\n+            return;\n+        }\n+\n+        // Get type of function if expression is a function call\n         let (ty, span) = match ex.kind {\n             hir::ExprKind::Call(f, _) => {\n                 let types = tcx.typeck(ex.hir_id.owner);\n-                (types.node_type(f.hir_id), ex.span)\n+\n+                match types.node_type_opt(f.hir_id) {\n+                    Some(ty) => (ty, ex.span),\n+                    None => {\n+                        return;\n+                    }\n+                }\n             }\n             hir::ExprKind::MethodCall(_, _, _, span) => {\n                 let types = tcx.typeck(ex.hir_id.owner);"}, {"sha": "dce8b83eefe4efd68139f03ed800a171f42f9303", "filename": "src/test/run-make/rustdoc-scrape-examples-invalid-expr/Makefile", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/b8ecc9fefa4c9c763cf74e9c9659ecc00f30ba3a/src%2Ftest%2Frun-make%2Frustdoc-scrape-examples-invalid-expr%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/b8ecc9fefa4c9c763cf74e9c9659ecc00f30ba3a/src%2Ftest%2Frun-make%2Frustdoc-scrape-examples-invalid-expr%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Frustdoc-scrape-examples-invalid-expr%2FMakefile?ref=b8ecc9fefa4c9c763cf74e9c9659ecc00f30ba3a", "patch": "@@ -0,0 +1,5 @@\n+deps := ex\n+\n+-include ../rustdoc-scrape-examples-multiple/scrape.mk\n+\n+all: scrape"}, {"sha": "b342b5b0aaece9fb228d72dbe53570c417348408", "filename": "src/test/run-make/rustdoc-scrape-examples-invalid-expr/examples/ex.rs", "status": "added", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b8ecc9fefa4c9c763cf74e9c9659ecc00f30ba3a/src%2Ftest%2Frun-make%2Frustdoc-scrape-examples-invalid-expr%2Fexamples%2Fex.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b8ecc9fefa4c9c763cf74e9c9659ecc00f30ba3a/src%2Ftest%2Frun-make%2Frustdoc-scrape-examples-invalid-expr%2Fexamples%2Fex.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Frustdoc-scrape-examples-invalid-expr%2Fexamples%2Fex.rs?ref=b8ecc9fefa4c9c763cf74e9c9659ecc00f30ba3a", "patch": "@@ -0,0 +1,2 @@\n+pub struct Foo([usize; foobar::f()]);\n+fn main() {}"}, {"sha": "c30c99dec6038208b769ddb69b13073e7b7b164c", "filename": "src/test/run-make/rustdoc-scrape-examples-invalid-expr/src/lib.rs", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/b8ecc9fefa4c9c763cf74e9c9659ecc00f30ba3a/src%2Ftest%2Frun-make%2Frustdoc-scrape-examples-invalid-expr%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b8ecc9fefa4c9c763cf74e9c9659ecc00f30ba3a/src%2Ftest%2Frun-make%2Frustdoc-scrape-examples-invalid-expr%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Frustdoc-scrape-examples-invalid-expr%2Fsrc%2Flib.rs?ref=b8ecc9fefa4c9c763cf74e9c9659ecc00f30ba3a", "patch": "@@ -0,0 +1 @@\n+pub const fn f() -> usize { 5 }"}, {"sha": "bdfeda92d79a0684e6adf2a5e46a27f518b61575", "filename": "src/test/run-make/rustdoc-scrape-examples-multiple/src/lib.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b8ecc9fefa4c9c763cf74e9c9659ecc00f30ba3a/src%2Ftest%2Frun-make%2Frustdoc-scrape-examples-multiple%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b8ecc9fefa4c9c763cf74e9c9659ecc00f30ba3a/src%2Ftest%2Frun-make%2Frustdoc-scrape-examples-multiple%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Frustdoc-scrape-examples-multiple%2Fsrc%2Flib.rs?ref=b8ecc9fefa4c9c763cf74e9c9659ecc00f30ba3a", "patch": "@@ -1,4 +1,6 @@\n // @has foobar/fn.ok.html '//*[@class=\"docblock scraped-example-list\"]//*[@class=\"prev\"]' ''\n // @has foobar/fn.ok.html '//*[@class=\"more-scraped-examples\"]' ''\n+// @has src/ex/ex.rs.html\n+// @has foobar/fn.ok.html '//a[@href=\"../src/ex/ex.rs.html#2\"]' ''\n \n pub fn ok() {}"}]}