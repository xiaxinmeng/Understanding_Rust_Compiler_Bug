{"sha": "2fadb0a16c8737a45746e95df9138912590ed8ad", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJmYWRiMGExNmM4NzM3YTQ1NzQ2ZTk1ZGY5MTM4OTEyNTkwZWQ4YWQ=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-01-13T19:43:46Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-01-13T19:43:46Z"}, "message": "Auto merge of #51487 - Zoxc:incr-passes, r=michaelwoerister\n\nMake more passes incremental\n\nr? @michaelwoerister", "tree": {"sha": "5ad3501dd728d486069331c64eb2ed4b633cdec1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5ad3501dd728d486069331c64eb2ed4b633cdec1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2fadb0a16c8737a45746e95df9138912590ed8ad", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2fadb0a16c8737a45746e95df9138912590ed8ad", "html_url": "https://github.com/rust-lang/rust/commit/2fadb0a16c8737a45746e95df9138912590ed8ad", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2fadb0a16c8737a45746e95df9138912590ed8ad/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2cf736f76563f054aecd84207b39114c6fceb8ed", "url": "https://api.github.com/repos/rust-lang/rust/commits/2cf736f76563f054aecd84207b39114c6fceb8ed", "html_url": "https://github.com/rust-lang/rust/commit/2cf736f76563f054aecd84207b39114c6fceb8ed"}, {"sha": "e69c2c75d6d279ffd636634b0cde2529bbf8b6f5", "url": "https://api.github.com/repos/rust-lang/rust/commits/e69c2c75d6d279ffd636634b0cde2529bbf8b6f5", "html_url": "https://github.com/rust-lang/rust/commit/e69c2c75d6d279ffd636634b0cde2529bbf8b6f5"}], "stats": {"total": 491, "additions": 421, "deletions": 70}, "files": [{"sha": "427fe51e6ff9cc6ccfc48586f3d026ad311b8532", "filename": "src/librustc/dep_graph/dep_node.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Flibrustc%2Fdep_graph%2Fdep_node.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Flibrustc%2Fdep_graph%2Fdep_node.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fdep_graph%2Fdep_node.rs?ref=2fadb0a16c8737a45746e95df9138912590ed8ad", "patch": "@@ -472,6 +472,12 @@ define_dep_nodes!( <'tcx>\n     [] UnsafetyCheckResult(DefId),\n     [] UnsafeDeriveOnReprPacked(DefId),\n \n+    [] CheckModAttrs(DefId),\n+    [] CheckModLoops(DefId),\n+    [] CheckModUnstableApiUsage(DefId),\n+    [] CheckModItemTypes(DefId),\n+    [] CollectModItemTypes(DefId),\n+\n     [] Reachability,\n     [] MirKeys,\n     [eval_always] CrateVariances,"}, {"sha": "a214ec88c66549fb48067244d57394a7d9b80faf", "filename": "src/librustc/hir/check_attr.rs", "status": "modified", "additions": 23, "deletions": 3, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Flibrustc%2Fhir%2Fcheck_attr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Flibrustc%2Fhir%2Fcheck_attr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Fcheck_attr.rs?ref=2fadb0a16c8737a45746e95df9138912590ed8ad", "patch": "@@ -4,9 +4,14 @@\n //! conflicts between multiple such attributes attached to the same\n //! item.\n \n+\n+use ty::TyCtxt;\n+use ty::query::Providers;\n+use ty::query::queries;\n+\n use hir;\n+use hir::def_id::DefId;\n use hir::intravisit::{self, Visitor, NestedVisitorMap};\n-use ty::TyCtxt;\n use std::fmt::{self, Display};\n use syntax_pos::Span;\n \n@@ -364,8 +369,9 @@ impl<'a, 'tcx> Visitor<'tcx> for CheckAttrVisitor<'a, 'tcx> {\n }\n \n pub fn check_crate<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>) {\n-    let mut checker = CheckAttrVisitor { tcx };\n-    tcx.hir().krate().visit_all_item_likes(&mut checker.as_deep_visitor());\n+    for &module in tcx.hir().krate().modules.keys() {\n+        queries::check_mod_attrs::ensure(tcx, tcx.hir().local_def_id(module));\n+    }\n }\n \n fn is_c_like_enum(item: &hir::Item) -> bool {\n@@ -381,3 +387,17 @@ fn is_c_like_enum(item: &hir::Item) -> bool {\n         false\n     }\n }\n+\n+fn check_mod_attrs<'tcx>(tcx: TyCtxt<'_, 'tcx, 'tcx>, module_def_id: DefId) {\n+    tcx.hir().visit_item_likes_in_module(\n+        module_def_id,\n+        &mut CheckAttrVisitor { tcx }.as_deep_visitor()\n+    );\n+}\n+\n+pub(crate) fn provide(providers: &mut Providers<'_>) {\n+    *providers = Providers {\n+        check_mod_attrs,\n+        ..*providers\n+    };\n+}"}, {"sha": "9181076740ba077011b01562a1b6078e31d25cd2", "filename": "src/librustc/hir/def_id.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Flibrustc%2Fhir%2Fdef_id.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Flibrustc%2Fhir%2Fdef_id.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Fdef_id.rs?ref=2fadb0a16c8737a45746e95df9138912590ed8ad", "patch": "@@ -1,4 +1,5 @@\n use ty;\n+use ty::TyCtxt;\n use hir::map::definitions::FIRST_FREE_HIGH_DEF_INDEX;\n use rustc_data_structures::indexed_vec::Idx;\n use serialize;\n@@ -243,6 +244,14 @@ impl DefId {\n     pub fn to_local(self) -> LocalDefId {\n         LocalDefId::from_def_id(self)\n     }\n+\n+    pub fn describe_as_module(&self, tcx: TyCtxt<'_, '_, '_>) -> String {\n+        if self.is_local() && self.index == CRATE_DEF_INDEX {\n+            format!(\"top-level module\")\n+        } else {\n+            format!(\"module `{}`\", tcx.item_path_str(*self))\n+        }\n+    }\n }\n \n impl serialize::UseSpecializedEncodable for DefId {}"}, {"sha": "8badcbfc1b3017b4cd4d77797570239f2617346f", "filename": "src/librustc/hir/lowering.rs", "status": "modified", "additions": 32, "deletions": 5, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Flibrustc%2Fhir%2Flowering.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Flibrustc%2Fhir%2Flowering.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Flowering.rs?ref=2fadb0a16c8737a45746e95df9138912590ed8ad", "patch": "@@ -48,7 +48,7 @@ use session::config::nightly_options;\n use util::common::FN_OUTPUT_NAME;\n use util::nodemap::{DefIdMap, NodeMap};\n \n-use std::collections::BTreeMap;\n+use std::collections::{BTreeSet, BTreeMap};\n use std::fmt::Debug;\n use std::mem;\n use smallvec::SmallVec;\n@@ -90,6 +90,8 @@ pub struct LoweringContext<'a> {\n     trait_impls: BTreeMap<DefId, Vec<NodeId>>,\n     trait_auto_impl: BTreeMap<DefId, NodeId>,\n \n+    modules: BTreeMap<NodeId, hir::ModuleItems>,\n+\n     is_generator: bool,\n \n     catch_scopes: Vec<NodeId>,\n@@ -124,6 +126,8 @@ pub struct LoweringContext<'a> {\n     // needs to be created for it.\n     in_scope_lifetimes: Vec<Ident>,\n \n+    current_module: NodeId,\n+\n     type_def_lifetime_params: DefIdMap<usize>,\n \n     current_hir_id_owner: Vec<(DefIndex, u32)>,\n@@ -228,12 +232,14 @@ pub fn lower_crate(\n         bodies: BTreeMap::new(),\n         trait_impls: BTreeMap::new(),\n         trait_auto_impl: BTreeMap::new(),\n+        modules: BTreeMap::new(),\n         exported_macros: Vec::new(),\n         catch_scopes: Vec::new(),\n         loop_scopes: Vec::new(),\n         is_in_loop_condition: false,\n         anonymous_lifetime_mode: AnonymousLifetimeMode::PassThrough,\n         type_def_lifetime_params: Default::default(),\n+        current_module: CRATE_NODE_ID,\n         current_hir_id_owner: vec![(CRATE_DEF_INDEX, 0)],\n         item_local_id_counters: Default::default(),\n         node_id_to_hir_id: IndexVec::new(),\n@@ -414,11 +420,24 @@ impl<'a> LoweringContext<'a> {\n         }\n \n         impl<'lcx, 'interner> Visitor<'lcx> for ItemLowerer<'lcx, 'interner> {\n+            fn visit_mod(&mut self, m: &'lcx Mod, _s: Span, _attrs: &[Attribute], n: NodeId) {\n+                self.lctx.modules.insert(n, hir::ModuleItems {\n+                    items: BTreeSet::new(),\n+                    trait_items: BTreeSet::new(),\n+                    impl_items: BTreeSet::new(),\n+                });\n+\n+                let old = self.lctx.current_module;\n+                self.lctx.current_module = n;\n+                visit::walk_mod(self, m);\n+                self.lctx.current_module = old;\n+            }\n+\n             fn visit_item(&mut self, item: &'lcx Item) {\n                 let mut item_lowered = true;\n                 self.lctx.with_hir_id_owner(item.id, |lctx| {\n                     if let Some(hir_item) = lctx.lower_item(item) {\n-                        lctx.items.insert(item.id, hir_item);\n+                        lctx.insert_item(item.id, hir_item);\n                     } else {\n                         item_lowered = false;\n                     }\n@@ -451,6 +470,7 @@ impl<'a> LoweringContext<'a> {\n                     let id = hir::TraitItemId { node_id: item.id };\n                     let hir_item = lctx.lower_trait_item(item);\n                     lctx.trait_items.insert(id, hir_item);\n+                    lctx.modules.get_mut(&lctx.current_module).unwrap().trait_items.insert(id);\n                 });\n \n                 visit::walk_trait_item(self, item);\n@@ -461,6 +481,7 @@ impl<'a> LoweringContext<'a> {\n                     let id = hir::ImplItemId { node_id: item.id };\n                     let hir_item = lctx.lower_impl_item(item);\n                     lctx.impl_items.insert(id, hir_item);\n+                    lctx.modules.get_mut(&lctx.current_module).unwrap().impl_items.insert(id);\n                 });\n                 visit::walk_impl_item(self, item);\n             }\n@@ -492,9 +513,15 @@ impl<'a> LoweringContext<'a> {\n             body_ids,\n             trait_impls: self.trait_impls,\n             trait_auto_impl: self.trait_auto_impl,\n+            modules: self.modules,\n         }\n     }\n \n+    fn insert_item(&mut self, id: NodeId, item: hir::Item) {\n+        self.items.insert(id, item);\n+        self.modules.get_mut(&self.current_module).unwrap().items.insert(id);\n+    }\n+\n     fn allocate_hir_id_counter<T: Debug>(&mut self, owner: NodeId, debug: &T) -> LoweredNodeId {\n         if self.item_local_id_counters.insert(owner, 0).is_some() {\n             bug!(\n@@ -1370,7 +1397,7 @@ impl<'a> LoweringContext<'a> {\n             // Insert the item into the global list. This usually happens\n             // automatically for all AST items. But this existential type item\n             // does not actually exist in the AST.\n-            lctx.items.insert(exist_ty_id.node_id, exist_ty_item);\n+            lctx.insert_item(exist_ty_id.node_id, exist_ty_item);\n \n             // `impl Trait` now just becomes `Foo<'a, 'b, ..>`.\n             hir::TyKind::Def(hir::ItemId { id: exist_ty_id.node_id }, lifetimes)\n@@ -3026,7 +3053,7 @@ impl<'a> LoweringContext<'a> {\n                         };\n                         let vis = respan(vis.span, vis_kind);\n \n-                        this.items.insert(\n+                        this.insert_item(\n                             new_id.node_id,\n                             hir::Item {\n                                 id: new_id.node_id,\n@@ -3133,7 +3160,7 @@ impl<'a> LoweringContext<'a> {\n                         };\n                         let vis = respan(vis.span, vis_kind);\n \n-                        this.items.insert(\n+                        this.insert_item(\n                             new_id,\n                             hir::Item {\n                                 id: new_id,"}, {"sha": "925a5fb85b81b2a5e9f35f59243148756ee878db", "filename": "src/librustc/hir/map/collector.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Flibrustc%2Fhir%2Fmap%2Fcollector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Flibrustc%2Fhir%2Fmap%2Fcollector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Fmap%2Fcollector.rs?ref=2fadb0a16c8737a45746e95df9138912590ed8ad", "patch": "@@ -119,6 +119,7 @@ impl<'a, 'hir> NodeCollector<'a, 'hir> {\n                 trait_impls: _,\n                 trait_auto_impl: _,\n                 body_ids: _,\n+                modules: _,\n             } = *krate;\n \n             alloc_hir_dep_nodes("}, {"sha": "513e18b137371e02ecca239ef917547bc996681a", "filename": "src/librustc/hir/map/mod.rs", "status": "modified", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Flibrustc%2Fhir%2Fmap%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Flibrustc%2Fhir%2Fmap%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Fmap%2Fmod.rs?ref=2fadb0a16c8737a45746e95df9138912590ed8ad", "patch": "@@ -17,6 +17,7 @@ use syntax::ext::base::MacroKind;\n use syntax_pos::{Span, DUMMY_SP};\n \n use hir::*;\n+use hir::itemlikevisit::ItemLikeVisitor;\n use hir::print::Nested;\n use util::nodemap::FxHashMap;\n \n@@ -506,6 +507,32 @@ impl<'hir> Map<'hir> {\n         &self.forest.krate.attrs\n     }\n \n+    pub fn visit_item_likes_in_module<V>(&self, module: DefId, visitor: &mut V)\n+        where V: ItemLikeVisitor<'hir>\n+    {\n+        let node_id = self.as_local_node_id(module).unwrap();\n+\n+        // Read the module so we'll be re-executed if new items\n+        // appear immediately under in the module. If some new item appears\n+        // in some nested item in the module, we'll be re-executed due to reads\n+        // in the expect_* calls the loops below\n+        self.read(node_id);\n+\n+        let module = &self.forest.krate.modules[&node_id];\n+\n+        for id in &module.items {\n+            visitor.visit_item(self.expect_item(*id));\n+        }\n+\n+        for id in &module.trait_items {\n+            visitor.visit_trait_item(self.expect_trait_item(id.node_id));\n+        }\n+\n+        for id in &module.impl_items {\n+            visitor.visit_impl_item(self.expect_impl_item(id.node_id));\n+        }\n+    }\n+\n     /// Retrieve the Node corresponding to `id`, panicking if it cannot\n     /// be found.\n     pub fn get(&self, id: NodeId) -> Node<'hir> {"}, {"sha": "fc4bd05476f6ceb4662949ca44111a491411eb71", "filename": "src/librustc/hir/mod.rs", "status": "modified", "additions": 15, "deletions": 1, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Flibrustc%2Fhir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Flibrustc%2Fhir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Fmod.rs?ref=2fadb0a16c8737a45746e95df9138912590ed8ad", "patch": "@@ -33,7 +33,7 @@ use rustc_data_structures::sync::{ParallelIterator, par_iter, Send, Sync, scope}\n use rustc_data_structures::thin_vec::ThinVec;\n \n use serialize::{self, Encoder, Encodable, Decoder, Decodable};\n-use std::collections::BTreeMap;\n+use std::collections::{BTreeSet, BTreeMap};\n use std::fmt;\n \n /// HIR doesn't commit to a concrete storage type and has its own alias for a vector.\n@@ -676,6 +676,15 @@ pub struct WhereEqPredicate {\n     pub rhs_ty: P<Ty>,\n }\n \n+#[derive(Clone, RustcEncodable, RustcDecodable, Debug)]\n+pub struct ModuleItems {\n+    // Use BTreeSets here so items are in the same order as in the\n+    // list of all items in Crate\n+    pub items: BTreeSet<NodeId>,\n+    pub trait_items: BTreeSet<TraitItemId>,\n+    pub impl_items: BTreeSet<ImplItemId>,\n+}\n+\n /// The top-level data structure that stores the entire contents of\n /// the crate currently being compiled.\n ///\n@@ -708,6 +717,10 @@ pub struct Crate {\n     /// in the crate, you should iterate over this list rather than the keys\n     /// of bodies.\n     pub body_ids: Vec<BodyId>,\n+\n+    /// A list of modules written out in the order in which they\n+    /// appear in the crate. This includes the main crate module.\n+    pub modules: BTreeMap<NodeId, ModuleItems>,\n }\n \n impl Crate {\n@@ -2408,6 +2421,7 @@ pub type GlobMap = NodeMap<FxHashSet<Name>>;\n \n \n pub fn provide(providers: &mut Providers<'_>) {\n+    check_attr::provide(providers);\n     providers.describe_def = map::describe_def;\n }\n "}, {"sha": "918e286c435bc2ba183f36c1d3024208cdf1c880", "filename": "src/librustc/middle/stability.rs", "status": "modified", "additions": 17, "deletions": 3, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Flibrustc%2Fmiddle%2Fstability.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Flibrustc%2Fmiddle%2Fstability.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fstability.rs?ref=2fadb0a16c8737a45746e95df9138912590ed8ad", "patch": "@@ -8,6 +8,8 @@ use hir::{self, Item, Generics, StructField, Variant, HirId};\n use hir::def::Def;\n use hir::def_id::{CrateNum, CRATE_DEF_INDEX, DefId, LOCAL_CRATE};\n use hir::intravisit::{self, Visitor, NestedVisitorMap};\n+use ty::query::Providers;\n+use ty::query::queries;\n use middle::privacy::AccessLevels;\n use session::{DiagnosticMessageId, Session};\n use syntax::symbol::Symbol;\n@@ -454,11 +456,23 @@ impl<'a, 'tcx> Index<'tcx> {\n     }\n }\n \n+pub fn check_unstable_api_usage<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>) {\n+    for &module in tcx.hir().krate().modules.keys() {\n+        queries::check_mod_unstable_api_usage::ensure(tcx, tcx.hir().local_def_id(module));\n+    }\n+}\n+\n /// Cross-references the feature names of unstable APIs with enabled\n /// features and possibly prints errors.\n-pub fn check_unstable_api_usage<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>) {\n-    let mut checker = Checker { tcx };\n-    tcx.hir().krate().visit_all_item_likes(&mut checker.as_deep_visitor());\n+fn check_mod_unstable_api_usage<'tcx>(tcx: TyCtxt<'_, 'tcx, 'tcx>, module_def_id: DefId) {\n+    tcx.hir().visit_item_likes_in_module(module_def_id, &mut Checker { tcx }.as_deep_visitor());\n+}\n+\n+pub fn provide(providers: &mut Providers<'_>) {\n+    *providers = Providers {\n+        check_mod_unstable_api_usage,\n+        ..*providers\n+    };\n }\n \n /// Check whether an item marked with `deprecated(since=\"X\")` is currently"}, {"sha": "ca5d1f6bd32036525e1d8fce04381f751a366bfe", "filename": "src/librustc/ty/query/config.rs", "status": "modified", "additions": 46, "deletions": 1, "changes": 47, "blob_url": "https://github.com/rust-lang/rust/blob/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Flibrustc%2Fty%2Fquery%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Flibrustc%2Fty%2Fquery%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fquery%2Fconfig.rs?ref=2fadb0a16c8737a45746e95df9138912590ed8ad", "patch": "@@ -68,11 +68,56 @@ impl<'tcx, M: QueryAccessors<'tcx, Key=DefId>> QueryDescription<'tcx> for M {\n             format!(\"processing `{}`\", tcx.item_path_str(def_id)).into()\n         } else {\n             let name = unsafe { ::std::intrinsics::type_name::<M>() };\n-            format!(\"processing `{}` applied to `{:?}`\", name, def_id).into()\n+            format!(\"processing {:?} with query `{}`\", def_id, name).into()\n         }\n     }\n }\n \n+impl<'tcx> QueryDescription<'tcx> for queries::check_mod_attrs<'tcx> {\n+    fn describe(\n+        tcx: TyCtxt<'_, '_, '_>,\n+        key: DefId,\n+    ) -> Cow<'static, str> {\n+        format!(\"checking attributes in {}\", key.describe_as_module(tcx)).into()\n+    }\n+}\n+\n+impl<'tcx> QueryDescription<'tcx> for queries::check_mod_unstable_api_usage<'tcx> {\n+    fn describe(\n+        tcx: TyCtxt<'_, '_, '_>,\n+        key: DefId,\n+    ) -> Cow<'static, str> {\n+        format!(\"checking for unstable API usage in {}\", key.describe_as_module(tcx)).into()\n+    }\n+}\n+\n+impl<'tcx> QueryDescription<'tcx> for queries::check_mod_loops<'tcx> {\n+    fn describe(\n+        tcx: TyCtxt<'_, '_, '_>,\n+        key: DefId,\n+    ) -> Cow<'static, str> {\n+        format!(\"checking loops in {}\", key.describe_as_module(tcx)).into()\n+    }\n+}\n+\n+impl<'tcx> QueryDescription<'tcx> for queries::check_mod_item_types<'tcx> {\n+    fn describe(\n+        tcx: TyCtxt<'_, '_, '_>,\n+        key: DefId,\n+    ) -> Cow<'static, str> {\n+        format!(\"checking item types in {}\", key.describe_as_module(tcx)).into()\n+    }\n+}\n+\n+impl<'tcx> QueryDescription<'tcx> for queries::collect_mod_item_types<'tcx> {\n+    fn describe(\n+        tcx: TyCtxt<'_, '_, '_>,\n+        key: DefId,\n+    ) -> Cow<'static, str> {\n+        format!(\"collecting item types in {}\", key.describe_as_module(tcx)).into()\n+    }\n+}\n+\n impl<'tcx> QueryDescription<'tcx> for queries::normalize_projection_ty<'tcx> {\n     fn describe(\n         _tcx: TyCtxt<'_, '_, '_>,"}, {"sha": "39d76ceed9507fc7930e038193562438b40197a0", "filename": "src/librustc/ty/query/mod.rs", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Flibrustc%2Fty%2Fquery%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Flibrustc%2Fty%2Fquery%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fquery%2Fmod.rs?ref=2fadb0a16c8737a45746e95df9138912590ed8ad", "patch": "@@ -254,6 +254,18 @@ define_queries! { <'tcx>\n     },\n \n     Other {\n+        /// Checks the attributes in the module\n+        [] fn check_mod_attrs: CheckModAttrs(DefId) -> (),\n+\n+        [] fn check_mod_unstable_api_usage: CheckModUnstableApiUsage(DefId) -> (),\n+\n+        /// Checks the loops in the module\n+        [] fn check_mod_loops: CheckModLoops(DefId) -> (),\n+\n+        [] fn check_mod_item_types: CheckModItemTypes(DefId) -> (),\n+\n+        [] fn collect_mod_item_types: CollectModItemTypes(DefId) -> (),\n+\n         /// Caches CoerceUnsized kinds for impls on custom types.\n         [] fn coerce_unsized_info: CoerceUnsizedInfo(DefId)\n             -> ty::adjustment::CoerceUnsizedInfo,"}, {"sha": "af23bf3c5901f1fd2ae6210a26e7224530bd7c8e", "filename": "src/librustc/ty/query/plumbing.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Flibrustc%2Fty%2Fquery%2Fplumbing.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Flibrustc%2Fty%2Fquery%2Fplumbing.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fquery%2Fplumbing.rs?ref=2fadb0a16c8737a45746e95df9138912590ed8ad", "patch": "@@ -1262,6 +1262,11 @@ pub fn force_from_dep_node<'a, 'gcx, 'lcx>(tcx: TyCtxt<'a, 'gcx, 'lcx>,\n         DepKind::MirBorrowCheck => { force!(mir_borrowck, def_id!()); }\n         DepKind::UnsafetyCheckResult => { force!(unsafety_check_result, def_id!()); }\n         DepKind::UnsafeDeriveOnReprPacked => { force!(unsafe_derive_on_repr_packed, def_id!()); }\n+        DepKind::CheckModAttrs => { force!(check_mod_attrs, def_id!()); }\n+        DepKind::CheckModLoops => { force!(check_mod_loops, def_id!()); }\n+        DepKind::CheckModUnstableApiUsage => { force!(check_mod_unstable_api_usage, def_id!()); }\n+        DepKind::CheckModItemTypes => { force!(check_mod_item_types, def_id!()); }\n+        DepKind::CollectModItemTypes => { force!(collect_mod_item_types, def_id!()); }\n         DepKind::Reachability => { force!(reachable_set, LOCAL_CRATE); }\n         DepKind::MirKeys => { force!(mir_keys, LOCAL_CRATE); }\n         DepKind::CrateVariances => { force!(crate_variances, LOCAL_CRATE); }"}, {"sha": "380f9afd68de6d2c2ff7c12cc7a95047aa2a719f", "filename": "src/librustc_driver/driver.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Flibrustc_driver%2Fdriver.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Flibrustc_driver%2Fdriver.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Fdriver.rs?ref=2fadb0a16c8737a45746e95df9138912590ed8ad", "patch": "@@ -1167,6 +1167,7 @@ pub fn default_provide(providers: &mut ty::query::Providers) {\n     typeck::provide(providers);\n     ty::provide(providers);\n     traits::provide(providers);\n+    stability::provide(providers);\n     reachable::provide(providers);\n     rustc_passes::provide(providers);\n     rustc_traits::provide(providers);\n@@ -1218,8 +1219,6 @@ where\n     sess.proc_macro_decls_static\n         .set(proc_macro_decls::find(&hir_map));\n \n-    time(sess, \"loop checking\", || loops::check_crate(sess, &hir_map));\n-\n     let mut local_providers = ty::query::Providers::default();\n     default_provide(&mut local_providers);\n     codegen_backend.provide(&mut local_providers);\n@@ -1247,7 +1246,9 @@ where\n         |tcx| {\n             // Do some initialization of the DepGraph that can only be done with the\n             // tcx available.\n-            rustc_incremental::dep_graph_tcx_init(tcx);\n+            time(sess, \"dep graph tcx init\", || rustc_incremental::dep_graph_tcx_init(tcx));\n+\n+            time(sess, \"loop checking\", || loops::check_crate(tcx));\n \n             time(sess, \"attribute checking\", || {\n                 hir::check_attr::check_crate(tcx)"}, {"sha": "829d4b34cf77922cf55acb7127ea71f55905ab7d", "filename": "src/librustc_passes/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Flibrustc_passes%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Flibrustc_passes%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_passes%2Flib.rs?ref=2fadb0a16c8737a45746e95df9138912590ed8ad", "patch": "@@ -38,4 +38,5 @@ __build_diagnostic_array! { librustc_passes, DIAGNOSTICS }\n \n pub fn provide(providers: &mut Providers) {\n     rvalue_promotion::provide(providers);\n+    loops::provide(providers);\n }"}, {"sha": "7d9165a82bc8fb52869a0a048ee00f0994ea48c4", "filename": "src/librustc_passes/loops.rs", "status": "modified", "additions": 21, "deletions": 13, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Flibrustc_passes%2Floops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Flibrustc_passes%2Floops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_passes%2Floops.rs?ref=2fadb0a16c8737a45746e95df9138912590ed8ad", "patch": "@@ -2,6 +2,10 @@ use self::Context::*;\n \n use rustc::session::Session;\n \n+use rustc::ty::query::Providers;\n+use rustc::ty::query::queries;\n+use rustc::ty::TyCtxt;\n+use rustc::hir::def_id::DefId;\n use rustc::hir::map::Map;\n use rustc::hir::intravisit::{self, Visitor, NestedVisitorMap};\n use rustc::hir::{self, Node, Destination};\n@@ -42,28 +46,32 @@ struct CheckLoopVisitor<'a, 'hir: 'a> {\n     cx: Context,\n }\n \n-pub fn check_crate(sess: &Session, map: &Map) {\n-    let krate = map.krate();\n-    krate.visit_all_item_likes(&mut CheckLoopVisitor {\n-        sess,\n-        hir_map: map,\n+pub fn check_crate<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>) {\n+    for &module in tcx.hir().krate().modules.keys() {\n+        queries::check_mod_loops::ensure(tcx, tcx.hir().local_def_id(module));\n+    }\n+}\n+\n+fn check_mod_loops<'tcx>(tcx: TyCtxt<'_, 'tcx, 'tcx>, module_def_id: DefId) {\n+    tcx.hir().visit_item_likes_in_module(module_def_id, &mut CheckLoopVisitor {\n+        sess: &tcx.sess,\n+        hir_map: &tcx.hir(),\n         cx: Normal,\n     }.as_deep_visitor());\n }\n \n+pub(crate) fn provide(providers: &mut Providers) {\n+    *providers = Providers {\n+        check_mod_loops,\n+        ..*providers\n+    };\n+}\n+\n impl<'a, 'hir> Visitor<'hir> for CheckLoopVisitor<'a, 'hir> {\n     fn nested_visit_map<'this>(&'this mut self) -> NestedVisitorMap<'this, 'hir> {\n         NestedVisitorMap::OnlyBodies(&self.hir_map)\n     }\n \n-    fn visit_item(&mut self, i: &'hir hir::Item) {\n-        self.with_context(Normal, |v| intravisit::walk_item(v, i));\n-    }\n-\n-    fn visit_impl_item(&mut self, i: &'hir hir::ImplItem) {\n-        self.with_context(Normal, |v| intravisit::walk_impl_item(v, i));\n-    }\n-\n     fn visit_anon_const(&mut self, c: &'hir hir::AnonConst) {\n         self.with_context(AnonConst, |v| intravisit::walk_anon_const(v, c));\n     }"}, {"sha": "8790d718f53f0bf2b4e95679ade753c94c272d1c", "filename": "src/librustc_typeck/check/mod.rs", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs?ref=2fadb0a16c8737a45746e95df9138912590ed8ad", "patch": "@@ -109,6 +109,7 @@ use rustc::ty::{\n use rustc::ty::adjustment::{Adjust, Adjustment, AllowTwoPhase, AutoBorrow, AutoBorrowMutability};\n use rustc::ty::fold::TypeFoldable;\n use rustc::ty::query::Providers;\n+use rustc::ty::query::queries;\n use rustc::ty::subst::{UnpackedKind, Subst, Substs, UserSelfTy, UserSubsts};\n use rustc::ty::util::{Representability, IntTypeExt, Discr};\n use rustc::ty::layout::VariantIdx;\n@@ -700,10 +701,16 @@ pub fn check_wf_new<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>) -> Result<(), ErrorRe\n \n pub fn check_item_types<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>) -> Result<(), ErrorReported> {\n     tcx.sess.track_errors(|| {\n-        tcx.hir().krate().visit_all_item_likes(&mut CheckItemTypesVisitor { tcx });\n+        for &module in tcx.hir().krate().modules.keys() {\n+            queries::check_mod_item_types::ensure(tcx, tcx.hir().local_def_id(module));\n+        }\n     })\n }\n \n+fn check_mod_item_types<'tcx>(tcx: TyCtxt<'_, 'tcx, 'tcx>, module_def_id: DefId) {\n+    tcx.hir().visit_item_likes_in_module(module_def_id, &mut CheckItemTypesVisitor { tcx });\n+}\n+\n pub fn check_item_bodies<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>) -> Result<(), CompileIncomplete> {\n     tcx.typeck_item_bodies(LOCAL_CRATE)\n }\n@@ -742,6 +749,7 @@ pub fn provide(providers: &mut Providers) {\n         check_item_well_formed,\n         check_trait_item_well_formed,\n         check_impl_item_well_formed,\n+        check_mod_item_types,\n         ..*providers\n     };\n }"}, {"sha": "67e3d1278022009402908f513da4fa928ab3035d", "filename": "src/librustc_typeck/collect.rs", "status": "modified", "additions": 12, "deletions": 4, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Flibrustc_typeck%2Fcollect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Flibrustc_typeck%2Fcollect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcollect.rs?ref=2fadb0a16c8737a45746e95df9138912590ed8ad", "patch": "@@ -23,6 +23,7 @@ use middle::resolve_lifetime as rl;\n use middle::weak_lang_items;\n use rustc::mir::mono::Linkage;\n use rustc::ty::query::Providers;\n+use rustc::ty::query::queries;\n use rustc::ty::subst::Substs;\n use rustc::ty::util::Discr;\n use rustc::ty::util::IntTypeExt;\n@@ -56,10 +57,16 @@ struct OnlySelfBounds(bool);\n // Main entry point\n \n pub fn collect_item_types<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>) {\n-    let mut visitor = CollectItemTypesVisitor { tcx };\n-    tcx.hir()\n-       .krate()\n-       .visit_all_item_likes(&mut visitor.as_deep_visitor());\n+    for &module in tcx.hir().krate().modules.keys() {\n+        queries::collect_mod_item_types::ensure(tcx, tcx.hir().local_def_id(module));\n+    }\n+}\n+\n+fn collect_mod_item_types<'tcx>(tcx: TyCtxt<'_, 'tcx, 'tcx>, module_def_id: DefId) {\n+    tcx.hir().visit_item_likes_in_module(\n+        module_def_id,\n+        &mut CollectItemTypesVisitor { tcx }.as_deep_visitor()\n+    );\n }\n \n pub fn provide(providers: &mut Providers) {\n@@ -78,6 +85,7 @@ pub fn provide(providers: &mut Providers) {\n         impl_polarity,\n         is_foreign_item,\n         codegen_fn_attrs,\n+        collect_mod_item_types,\n         ..*providers\n     };\n }"}, {"sha": "aa45462a52e41e702cd06b07e042e81355297a46", "filename": "src/test/ui/cycle-trait/cycle-trait-default-type-trait.stderr", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Ftest%2Fui%2Fcycle-trait%2Fcycle-trait-default-type-trait.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Ftest%2Fui%2Fcycle-trait%2Fcycle-trait-default-type-trait.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcycle-trait%2Fcycle-trait-default-type-trait.stderr?ref=2fadb0a16c8737a45746e95df9138912590ed8ad", "patch": "@@ -5,6 +5,11 @@ LL | trait Foo<X = Box<Foo>> {\n    |                   ^^^\n    |\n    = note: ...which again requires processing `Foo::X`, completing the cycle\n+note: cycle used when collecting item types in top-level module\n+  --> $DIR/cycle-trait-default-type-trait.rs:4:1\n+   |\n+LL | trait Foo<X = Box<Foo>> {\n+   | ^^^^^^^^^^^^^^^^^^^^^^^\n \n error: aborting due to previous error\n "}, {"sha": "8aa3ac8abf52c5eaa658bc0955a17c059e57f77a", "filename": "src/test/ui/cycle-trait/cycle-trait-supertrait-direct.stderr", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Ftest%2Fui%2Fcycle-trait%2Fcycle-trait-supertrait-direct.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Ftest%2Fui%2Fcycle-trait%2Fcycle-trait-supertrait-direct.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcycle-trait%2Fcycle-trait-supertrait-direct.stderr?ref=2fadb0a16c8737a45746e95df9138912590ed8ad", "patch": "@@ -5,6 +5,11 @@ LL | trait Chromosome: Chromosome {\n    |                   ^^^^^^^^^^\n    |\n    = note: ...which again requires computing the supertraits of `Chromosome`, completing the cycle\n+note: cycle used when collecting item types in top-level module\n+  --> $DIR/cycle-trait-supertrait-direct.rs:3:1\n+   |\n+LL | trait Chromosome: Chromosome {\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n error: aborting due to previous error\n "}, {"sha": "fab61bd9ed06504261475531ae84bba7e47cf759", "filename": "src/test/ui/existential_types/no_inferrable_concrete_type.stderr", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Ftest%2Fui%2Fexistential_types%2Fno_inferrable_concrete_type.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Ftest%2Fui%2Fexistential_types%2Fno_inferrable_concrete_type.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fexistential_types%2Fno_inferrable_concrete_type.stderr?ref=2fadb0a16c8737a45746e95df9138912590ed8ad", "patch": "@@ -10,6 +10,17 @@ note: ...which requires processing `bar`...\n LL | fn bar(x: Foo) -> Foo { x }\n    |                       ^^^^^\n    = note: ...which again requires processing `Foo`, completing the cycle\n+note: cycle used when collecting item types in top-level module\n+  --> $DIR/no_inferrable_concrete_type.rs:4:1\n+   |\n+LL | / #![feature(existential_type)]\n+LL | |\n+LL | | existential type Foo: Copy; //~ cycle detected\n+LL | |\n+...  |\n+LL | |     let _: Foo = std::mem::transmute(0u8);\n+LL | | }\n+   | |_^\n \n error: aborting due to previous error\n "}, {"sha": "4acc400f8e79982f9d710d1457f842fcc7a33ea2", "filename": "src/test/ui/impl-trait/auto-trait-leak.stderr", "status": "modified", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Ftest%2Fui%2Fimpl-trait%2Fauto-trait-leak.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Ftest%2Fui%2Fimpl-trait%2Fauto-trait-leak.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fimpl-trait%2Fauto-trait-leak.stderr?ref=2fadb0a16c8737a45746e95df9138912590ed8ad", "patch": "@@ -22,6 +22,17 @@ LL | fn cycle2() -> impl Clone {\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^\n note: ...which requires evaluating trait selection obligation `impl std::clone::Clone: std::marker::Send`...\n    = note: ...which again requires processing `cycle1::{{impl-Trait}}`, completing the cycle\n+note: cycle used when checking item types in top-level module\n+  --> $DIR/auto-trait-leak.rs:3:1\n+   |\n+LL | / use std::cell::Cell;\n+LL | | use std::rc::Rc;\n+LL | |\n+LL | | fn send<T: Send>(_: T) {}\n+...  |\n+LL | |     Rc::new(String::from(\"foo\"))\n+LL | | }\n+   | |_^\n \n error[E0391]: cycle detected when processing `cycle1::{{impl-Trait}}`\n   --> $DIR/auto-trait-leak.rs:14:16\n@@ -46,6 +57,17 @@ note: ...which requires processing `cycle2`...\n LL | fn cycle2() -> impl Clone {\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^\n    = note: ...which again requires processing `cycle1::{{impl-Trait}}`, completing the cycle\n+note: cycle used when checking item types in top-level module\n+  --> $DIR/auto-trait-leak.rs:3:1\n+   |\n+LL | / use std::cell::Cell;\n+LL | | use std::rc::Rc;\n+LL | |\n+LL | | fn send<T: Send>(_: T) {}\n+...  |\n+LL | |     Rc::new(String::from(\"foo\"))\n+LL | | }\n+   | |_^\n \n error[E0277]: `std::rc::Rc<std::string::String>` cannot be sent between threads safely\n   --> $DIR/auto-trait-leak.rs:17:5"}, {"sha": "daa18a7e9b1ce1928a3b3ace0808756a8247acba", "filename": "src/test/ui/infinite/infinite-vec-type-recursion.stderr", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Ftest%2Fui%2Finfinite%2Finfinite-vec-type-recursion.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Ftest%2Fui%2Finfinite%2Finfinite-vec-type-recursion.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Finfinite%2Finfinite-vec-type-recursion.stderr?ref=2fadb0a16c8737a45746e95df9138912590ed8ad", "patch": "@@ -5,6 +5,14 @@ LL | type X = Vec<X>;\n    |              ^\n    |\n    = note: ...which again requires processing `X`, completing the cycle\n+note: cycle used when collecting item types in top-level module\n+  --> $DIR/infinite-vec-type-recursion.rs:1:1\n+   |\n+LL | / type X = Vec<X>;\n+LL | | //~^ ERROR cycle detected\n+LL | |\n+LL | | fn main() { let b: X = Vec::new(); }\n+   | |____________________________________^\n \n error: aborting due to previous error\n "}, {"sha": "37e38ff60ae4bd55bf2eea482ed5babc3fcb3b45", "filename": "src/test/ui/issues/issue-12511.stderr", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Ftest%2Fui%2Fissues%2Fissue-12511.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Ftest%2Fui%2Fissues%2Fissue-12511.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-12511.stderr?ref=2fadb0a16c8737a45746e95df9138912590ed8ad", "patch": "@@ -10,6 +10,11 @@ note: ...which requires computing the supertraits of `T2`...\n LL | trait T2 : T1 {\n    |            ^^\n    = note: ...which again requires computing the supertraits of `T1`, completing the cycle\n+note: cycle used when collecting item types in top-level module\n+  --> $DIR/issue-12511.rs:1:1\n+   |\n+LL | trait T1 : T2 {\n+   | ^^^^^^^^^^^^^\n \n error: aborting due to previous error\n "}, {"sha": "7dc4e43fd573db65af75d8a03a307babd9ee46f3", "filename": "src/test/ui/issues/issue-20772.stderr", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Ftest%2Fui%2Fissues%2Fissue-20772.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Ftest%2Fui%2Fissues%2Fissue-20772.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-20772.stderr?ref=2fadb0a16c8737a45746e95df9138912590ed8ad", "patch": "@@ -8,6 +8,14 @@ LL | | {}\n    | |__^\n    |\n    = note: ...which again requires computing the supertraits of `T`, completing the cycle\n+note: cycle used when collecting item types in top-level module\n+  --> $DIR/issue-20772.rs:1:1\n+   |\n+LL | / trait T : Iterator<Item=Self::Item>\n+LL | | //~^ ERROR cycle detected\n+LL | | //~| ERROR associated type `Item` not found for `Self`\n+LL | | {}\n+   | |__^\n \n error[E0220]: associated type `Item` not found for `Self`\n   --> $DIR/issue-20772.rs:1:25"}, {"sha": "5f9709d1c649badb26b724e024d9ecda38bf9e78", "filename": "src/test/ui/issues/issue-20825.stderr", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Ftest%2Fui%2Fissues%2Fissue-20825.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Ftest%2Fui%2Fissues%2Fissue-20825.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-20825.stderr?ref=2fadb0a16c8737a45746e95df9138912590ed8ad", "patch": "@@ -5,6 +5,11 @@ LL | pub trait Processor: Subscriber<Input = Self::Input> {\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |\n    = note: ...which again requires computing the supertraits of `Processor`, completing the cycle\n+note: cycle used when collecting item types in top-level module\n+  --> $DIR/issue-20825.rs:5:1\n+   |\n+LL | pub trait Processor: Subscriber<Input = Self::Input> {\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n error: aborting due to previous error\n "}, {"sha": "9e7e4b218b1c668cdba6e31068cc2af5c05316b2", "filename": "src/test/ui/issues/issue-22673.stderr", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Ftest%2Fui%2Fissues%2Fissue-22673.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Ftest%2Fui%2Fissues%2Fissue-22673.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-22673.stderr?ref=2fadb0a16c8737a45746e95df9138912590ed8ad", "patch": "@@ -5,6 +5,11 @@ LL | trait Expr : PartialEq<Self::Item> {\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |\n    = note: ...which again requires computing the supertraits of `Expr`, completing the cycle\n+note: cycle used when collecting item types in top-level module\n+  --> $DIR/issue-22673.rs:1:1\n+   |\n+LL | trait Expr : PartialEq<Self::Item> {\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n error: aborting due to previous error\n "}, {"sha": "07ac421455cf6e02cae79ac7d9d2dfa15a78e943", "filename": "src/test/ui/issues/issue-34373.stderr", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Ftest%2Fui%2Fissues%2Fissue-34373.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Ftest%2Fui%2Fissues%2Fissue-34373.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-34373.stderr?ref=2fadb0a16c8737a45746e95df9138912590ed8ad", "patch": "@@ -10,6 +10,17 @@ note: ...which requires processing `DefaultFoo`...\n LL | type DefaultFoo = Foo;\n    |                   ^^^\n    = note: ...which again requires processing `Foo::T`, completing the cycle\n+note: cycle used when collecting item types in top-level module\n+  --> $DIR/issue-34373.rs:1:1\n+   |\n+LL | / #![allow(warnings)]\n+LL | |\n+LL | | trait Trait<T> {\n+LL | |     fn foo(_: T) {}\n+...  |\n+LL | | fn main() {\n+LL | | }\n+   | |_^\n \n error: aborting due to previous error\n "}, {"sha": "1da56ad05d28c11b3fd12e5a4cbb045a20d74904", "filename": "src/test/ui/resolve/issue-23305.stderr", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Ftest%2Fui%2Fresolve%2Fissue-23305.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Ftest%2Fui%2Fresolve%2Fissue-23305.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fresolve%2Fissue-23305.stderr?ref=2fadb0a16c8737a45746e95df9138912590ed8ad", "patch": "@@ -5,6 +5,11 @@ LL | impl ToNbt<Self> {}\n    |            ^^^^\n    |\n    = note: ...which again requires processing `<impl at $DIR/issue-23305.rs:5:1: 5:20>`, completing the cycle\n+note: cycle used when collecting item types in top-level module\n+  --> $DIR/issue-23305.rs:1:1\n+   |\n+LL | pub trait ToNbt<T> {\n+   | ^^^^^^^^^^^^^^^^^^\n \n error: aborting due to previous error\n "}, {"sha": "1940c0cd2a4b7e163aff228de447f1c56e5b2e7e", "filename": "src/test/ui/resolve/resolve-self-in-impl.stderr", "status": "modified", "additions": 55, "deletions": 0, "changes": 55, "blob_url": "https://github.com/rust-lang/rust/blob/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Ftest%2Fui%2Fresolve%2Fresolve-self-in-impl.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Ftest%2Fui%2Fresolve%2Fresolve-self-in-impl.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fresolve%2Fresolve-self-in-impl.stderr?ref=2fadb0a16c8737a45746e95df9138912590ed8ad", "patch": "@@ -5,6 +5,17 @@ LL | impl Tr for Self {} //~ ERROR cycle detected\n    |             ^^^^\n    |\n    = note: ...which again requires processing `<impl at $DIR/resolve-self-in-impl.rs:14:1: 14:20>`, completing the cycle\n+note: cycle used when collecting item types in top-level module\n+  --> $DIR/resolve-self-in-impl.rs:1:1\n+   |\n+LL | / #![feature(associated_type_defaults)]\n+LL | |\n+LL | | struct S<T = u8>(T);\n+LL | | trait Tr<T = u8> {\n+...  |\n+LL | |\n+LL | | fn main() {}\n+   | |____________^\n \n error[E0391]: cycle detected when processing `<impl at $DIR/resolve-self-in-impl.rs:15:1: 15:23>`\n   --> $DIR/resolve-self-in-impl.rs:15:15\n@@ -13,6 +24,17 @@ LL | impl Tr for S<Self> {} //~ ERROR cycle detected\n    |               ^^^^\n    |\n    = note: ...which again requires processing `<impl at $DIR/resolve-self-in-impl.rs:15:1: 15:23>`, completing the cycle\n+note: cycle used when collecting item types in top-level module\n+  --> $DIR/resolve-self-in-impl.rs:1:1\n+   |\n+LL | / #![feature(associated_type_defaults)]\n+LL | |\n+LL | | struct S<T = u8>(T);\n+LL | | trait Tr<T = u8> {\n+...  |\n+LL | |\n+LL | | fn main() {}\n+   | |____________^\n \n error[E0391]: cycle detected when processing `<impl at $DIR/resolve-self-in-impl.rs:16:1: 16:13>`\n   --> $DIR/resolve-self-in-impl.rs:16:6\n@@ -21,6 +43,17 @@ LL | impl Self {} //~ ERROR cycle detected\n    |      ^^^^\n    |\n    = note: ...which again requires processing `<impl at $DIR/resolve-self-in-impl.rs:16:1: 16:13>`, completing the cycle\n+note: cycle used when collecting item types in top-level module\n+  --> $DIR/resolve-self-in-impl.rs:1:1\n+   |\n+LL | / #![feature(associated_type_defaults)]\n+LL | |\n+LL | | struct S<T = u8>(T);\n+LL | | trait Tr<T = u8> {\n+...  |\n+LL | |\n+LL | | fn main() {}\n+   | |____________^\n \n error[E0391]: cycle detected when processing `<impl at $DIR/resolve-self-in-impl.rs:17:1: 17:16>`\n   --> $DIR/resolve-self-in-impl.rs:17:8\n@@ -29,6 +62,17 @@ LL | impl S<Self> {} //~ ERROR cycle detected\n    |        ^^^^\n    |\n    = note: ...which again requires processing `<impl at $DIR/resolve-self-in-impl.rs:17:1: 17:16>`, completing the cycle\n+note: cycle used when collecting item types in top-level module\n+  --> $DIR/resolve-self-in-impl.rs:1:1\n+   |\n+LL | / #![feature(associated_type_defaults)]\n+LL | |\n+LL | | struct S<T = u8>(T);\n+LL | | trait Tr<T = u8> {\n+...  |\n+LL | |\n+LL | | fn main() {}\n+   | |____________^\n \n error[E0391]: cycle detected when processing `<impl at $DIR/resolve-self-in-impl.rs:18:1: 18:26>`\n   --> $DIR/resolve-self-in-impl.rs:18:1\n@@ -37,6 +81,17 @@ LL | impl Tr<Self::A> for S {} //~ ERROR cycle detected\n    | ^^^^^^^^^^^^^^^^^^^^^^\n    |\n    = note: ...which again requires processing `<impl at $DIR/resolve-self-in-impl.rs:18:1: 18:26>`, completing the cycle\n+note: cycle used when collecting item types in top-level module\n+  --> $DIR/resolve-self-in-impl.rs:1:1\n+   |\n+LL | / #![feature(associated_type_defaults)]\n+LL | |\n+LL | | struct S<T = u8>(T);\n+LL | | trait Tr<T = u8> {\n+...  |\n+LL | |\n+LL | | fn main() {}\n+   | |____________^\n \n error: aborting due to 5 previous errors\n "}, {"sha": "22df5e42d2607d57ef4c57954938dfee2ed8811b", "filename": "src/test/ui/simd-intrinsic/simd-intrinsic-declaration-type.stderr", "status": "modified", "additions": 36, "deletions": 36, "changes": 72, "blob_url": "https://github.com/rust-lang/rust/blob/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Ftest%2Fui%2Fsimd-intrinsic%2Fsimd-intrinsic-declaration-type.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2fadb0a16c8737a45746e95df9138912590ed8ad/src%2Ftest%2Fui%2Fsimd-intrinsic%2Fsimd-intrinsic-declaration-type.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsimd-intrinsic%2Fsimd-intrinsic-declaration-type.stderr?ref=2fadb0a16c8737a45746e95df9138912590ed8ad", "patch": "@@ -1,39 +1,3 @@\n-error[E0442]: intrinsic argument 1 has wrong type: found `u16`, expected `i16`\n-  --> $DIR/simd-intrinsic-declaration-type.rs:33:9\n-   |\n-LL |         fn x86_mm_adds_epi16(x: u16x8, y: u16x8) -> u16x8;\n-   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n-\n-error[E0442]: intrinsic argument 2 has wrong type: found `u16`, expected `i16`\n-  --> $DIR/simd-intrinsic-declaration-type.rs:33:9\n-   |\n-LL |         fn x86_mm_adds_epi16(x: u16x8, y: u16x8) -> u16x8;\n-   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n-\n-error[E0442]: intrinsic return value has wrong type: found `u16`, expected `i16`\n-  --> $DIR/simd-intrinsic-declaration-type.rs:33:9\n-   |\n-LL |         fn x86_mm_adds_epi16(x: u16x8, y: u16x8) -> u16x8;\n-   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n-\n-error[E0442]: intrinsic argument 1 has wrong type: found `i16`, expected `u16`\n-  --> $DIR/simd-intrinsic-declaration-type.rs:37:9\n-   |\n-LL |         fn x86_mm_adds_epu16(x: i16x8, y: i16x8) -> i16x8;\n-   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n-\n-error[E0442]: intrinsic argument 2 has wrong type: found `i16`, expected `u16`\n-  --> $DIR/simd-intrinsic-declaration-type.rs:37:9\n-   |\n-LL |         fn x86_mm_adds_epu16(x: i16x8, y: i16x8) -> i16x8;\n-   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n-\n-error[E0442]: intrinsic return value has wrong type: found `i16`, expected `u16`\n-  --> $DIR/simd-intrinsic-declaration-type.rs:37:9\n-   |\n-LL |         fn x86_mm_adds_epu16(x: i16x8, y: i16x8) -> i16x8;\n-   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n-\n error[E0442]: intrinsic argument 1 has wrong type: found vector with length 16, expected length 8\n   --> $DIR/simd-intrinsic-declaration-type.rs:45:5\n    |\n@@ -70,6 +34,42 @@ error[E0442]: intrinsic return value has wrong type: found `i32`, expected `f32`\n LL |     fn x86_mm_max_ps(x: i32x4, y: i32x4) -> i32x4;\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n+error[E0442]: intrinsic argument 1 has wrong type: found `u16`, expected `i16`\n+  --> $DIR/simd-intrinsic-declaration-type.rs:33:9\n+   |\n+LL |         fn x86_mm_adds_epi16(x: u16x8, y: u16x8) -> u16x8;\n+   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error[E0442]: intrinsic argument 2 has wrong type: found `u16`, expected `i16`\n+  --> $DIR/simd-intrinsic-declaration-type.rs:33:9\n+   |\n+LL |         fn x86_mm_adds_epi16(x: u16x8, y: u16x8) -> u16x8;\n+   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error[E0442]: intrinsic return value has wrong type: found `u16`, expected `i16`\n+  --> $DIR/simd-intrinsic-declaration-type.rs:33:9\n+   |\n+LL |         fn x86_mm_adds_epi16(x: u16x8, y: u16x8) -> u16x8;\n+   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error[E0442]: intrinsic argument 1 has wrong type: found `i16`, expected `u16`\n+  --> $DIR/simd-intrinsic-declaration-type.rs:37:9\n+   |\n+LL |         fn x86_mm_adds_epu16(x: i16x8, y: i16x8) -> i16x8;\n+   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error[E0442]: intrinsic argument 2 has wrong type: found `i16`, expected `u16`\n+  --> $DIR/simd-intrinsic-declaration-type.rs:37:9\n+   |\n+LL |         fn x86_mm_adds_epu16(x: i16x8, y: i16x8) -> i16x8;\n+   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error[E0442]: intrinsic return value has wrong type: found `i16`, expected `u16`\n+  --> $DIR/simd-intrinsic-declaration-type.rs:37:9\n+   |\n+LL |         fn x86_mm_adds_epu16(x: i16x8, y: i16x8) -> i16x8;\n+   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n error: aborting due to 12 previous errors\n \n For more information about this error, try `rustc --explain E0442`."}]}