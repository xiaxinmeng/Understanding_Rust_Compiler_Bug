{"sha": "8e1b5d897a277e9e25685e9acac7333b9a0f8bf4", "node_id": "MDY6Q29tbWl0NzI0NzEyOjhlMWI1ZDg5N2EyNzdlOWUyNTY4NWU5YWNhYzczMzNiOWEwZjhiZjQ=", "commit": {"author": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2019-01-03T23:57:11Z"}, "committer": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2019-02-25T19:40:38Z"}, "message": "Restrict value in key-value attributes to literals", "tree": {"sha": "2603383e712ba796ad04858a48c095073d26130a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2603383e712ba796ad04858a48c095073d26130a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8e1b5d897a277e9e25685e9acac7333b9a0f8bf4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8e1b5d897a277e9e25685e9acac7333b9a0f8bf4", "html_url": "https://github.com/rust-lang/rust/commit/8e1b5d897a277e9e25685e9acac7333b9a0f8bf4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8e1b5d897a277e9e25685e9acac7333b9a0f8bf4/comments", "author": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "committer": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b57fe74a27590289fd657614b8ad1f3eac8a7ad2", "url": "https://api.github.com/repos/rust-lang/rust/commits/b57fe74a27590289fd657614b8ad1f3eac8a7ad2", "html_url": "https://github.com/rust-lang/rust/commit/b57fe74a27590289fd657614b8ad1f3eac8a7ad2"}], "stats": {"total": 105, "additions": 87, "deletions": 18}, "files": [{"sha": "e7937f57002f3f8cfd4efd61f663c0ce0f805f5f", "filename": "src/libsyntax/parse/attr.rs", "status": "modified", "additions": 14, "deletions": 4, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/8e1b5d897a277e9e25685e9acac7333b9a0f8bf4/src%2Flibsyntax%2Fparse%2Fattr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8e1b5d897a277e9e25685e9acac7333b9a0f8bf4/src%2Flibsyntax%2Fparse%2Fattr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fparse%2Fattr.rs?ref=8e1b5d897a277e9e25685e9acac7333b9a0f8bf4", "patch": "@@ -158,11 +158,21 @@ impl<'a> Parser<'a> {\n                    self.parse_token_tree().into()\n             } else if self.eat(&token::Eq) {\n                 let eq = TokenTree::Token(self.prev_span, token::Eq);\n-                let tree = match self.token {\n-                    token::CloseDelim(_) | token::Eof => self.unexpected()?,\n-                    _ => self.parse_token_tree(),\n+                let mut is_interpolated_expr = false;\n+                if let token::Interpolated(nt) = &self.token {\n+                    if let token::NtExpr(..) = **nt {\n+                        is_interpolated_expr = true;\n+                    }\n+                }\n+                let tokens = if is_interpolated_expr {\n+                    // We need to accept arbitrary interpolated expressions to continue\n+                    // supporting things like `doc = $expr` that work on stable.\n+                    // Non-literal interpolated expressions are rejected after expansion.\n+                    self.parse_token_tree().into()\n+                } else {\n+                    self.parse_unsuffixed_lit()?.tokens()\n                 };\n-                TokenStream::new(vec![eq.into(), tree.into()])\n+                TokenStream::from_streams(vec![eq.into(), tokens])\n             } else {\n                 TokenStream::empty()\n             };"}, {"sha": "4ce308d015c00284589b467376fe3c3ce9737a61", "filename": "src/libsyntax/tokenstream.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/8e1b5d897a277e9e25685e9acac7333b9a0f8bf4/src%2Flibsyntax%2Ftokenstream.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8e1b5d897a277e9e25685e9acac7333b9a0f8bf4/src%2Flibsyntax%2Ftokenstream.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Ftokenstream.rs?ref=8e1b5d897a277e9e25685e9acac7333b9a0f8bf4", "patch": "@@ -254,7 +254,7 @@ impl TokenStream {\n         }\n     }\n \n-    fn from_streams(mut streams: Vec<TokenStream>) -> TokenStream {\n+    pub(crate) fn from_streams(mut streams: Vec<TokenStream>) -> TokenStream {\n         match streams.len() {\n             0 => TokenStream::empty(),\n             1 => streams.pop().unwrap(),"}, {"sha": "b8dfafc446e91082a7f8f34931b58a8c11689fa1", "filename": "src/test/ui/attr-eq-token-tree.rs", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/8e1b5d897a277e9e25685e9acac7333b9a0f8bf4/src%2Ftest%2Fui%2Fattr-eq-token-tree.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8e1b5d897a277e9e25685e9acac7333b9a0f8bf4/src%2Ftest%2Fui%2Fattr-eq-token-tree.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fattr-eq-token-tree.rs?ref=8e1b5d897a277e9e25685e9acac7333b9a0f8bf4", "patch": "@@ -1,6 +1,4 @@\n-// compile-pass\n-\n #![feature(custom_attribute, unrestricted_attribute_tokens)]\n \n-#[my_attr = !] // OK under feature gate\n+#[my_attr = !] //~ ERROR unexpected token: `!`\n fn main() {}"}, {"sha": "57d6a4e0f16a27d07b3a6aca3d6a6038785f4767", "filename": "src/test/ui/attr-eq-token-tree.stderr", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/8e1b5d897a277e9e25685e9acac7333b9a0f8bf4/src%2Ftest%2Fui%2Fattr-eq-token-tree.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/8e1b5d897a277e9e25685e9acac7333b9a0f8bf4/src%2Ftest%2Fui%2Fattr-eq-token-tree.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fattr-eq-token-tree.stderr?ref=8e1b5d897a277e9e25685e9acac7333b9a0f8bf4", "patch": "@@ -0,0 +1,8 @@\n+error: unexpected token: `!`\n+  --> $DIR/attr-eq-token-tree.rs:3:11\n+   |\n+LL | #[my_attr = !] //~ ERROR unexpected token: `!`\n+   |           ^\n+\n+error: aborting due to previous error\n+"}, {"sha": "332246fd1cf9b83db93a92c353a20837c420c0ec", "filename": "src/test/ui/macros/macro-attribute.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/8e1b5d897a277e9e25685e9acac7333b9a0f8bf4/src%2Ftest%2Fui%2Fmacros%2Fmacro-attribute.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8e1b5d897a277e9e25685e9acac7333b9a0f8bf4/src%2Ftest%2Fui%2Fmacros%2Fmacro-attribute.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacros%2Fmacro-attribute.rs?ref=8e1b5d897a277e9e25685e9acac7333b9a0f8bf4", "patch": "@@ -1,4 +1,4 @@\n #![feature(unrestricted_attribute_tokens)]\n \n-#[doc = $not_there] //~ ERROR expected `]`, found `not_there`\n+#[doc = $not_there] //~ ERROR unexpected token: `$`\n fn main() { }"}, {"sha": "55f8e09b7e3e5d39af0c0b786bd6e75b9257a580", "filename": "src/test/ui/macros/macro-attribute.stderr", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/8e1b5d897a277e9e25685e9acac7333b9a0f8bf4/src%2Ftest%2Fui%2Fmacros%2Fmacro-attribute.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/8e1b5d897a277e9e25685e9acac7333b9a0f8bf4/src%2Ftest%2Fui%2Fmacros%2Fmacro-attribute.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacros%2Fmacro-attribute.stderr?ref=8e1b5d897a277e9e25685e9acac7333b9a0f8bf4", "patch": "@@ -1,8 +1,8 @@\n-error: expected `]`, found `not_there`\n-  --> $DIR/macro-attribute.rs:3:10\n+error: unexpected token: `$`\n+  --> $DIR/macro-attribute.rs:3:7\n    |\n-LL | #[doc = $not_there] //~ ERROR expected `]`, found `not_there`\n-   |          ^^^^^^^^^ expected `]`\n+LL | #[doc = $not_there] //~ ERROR unexpected token: `$`\n+   |       ^\n \n error: aborting due to previous error\n "}, {"sha": "e452435968baca28a15b1c4ec1e705da02c8a4cc", "filename": "src/test/ui/malformed/malformed-interpolated.rs", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/8e1b5d897a277e9e25685e9acac7333b9a0f8bf4/src%2Ftest%2Fui%2Fmalformed%2Fmalformed-interpolated.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8e1b5d897a277e9e25685e9acac7333b9a0f8bf4/src%2Ftest%2Fui%2Fmalformed%2Fmalformed-interpolated.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmalformed%2Fmalformed-interpolated.rs?ref=8e1b5d897a277e9e25685e9acac7333b9a0f8bf4", "patch": "@@ -0,0 +1,18 @@\n+#![feature(custom_attribute)]\n+\n+macro_rules! check {\n+    ($expr: expr) => (\n+        #[my_attr = $expr] //~ ERROR suffixed literals are not allowed in attributes\n+                           //~| ERROR unexpected token: `-0`\n+                           //~| ERROR unexpected token: `0 + 0`\n+        use main as _;\n+    );\n+}\n+\n+check!(\"0\"); // OK\n+check!(0); // OK\n+check!(0u8); // ERROR, see above\n+check!(-0); // ERROR, see above\n+check!(0 + 0); // ERROR, see above\n+\n+fn main() {}"}, {"sha": "f9c89316fcd14680c31cde0aafeccdd515560415", "filename": "src/test/ui/malformed/malformed-interpolated.stderr", "status": "added", "additions": 35, "deletions": 0, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/8e1b5d897a277e9e25685e9acac7333b9a0f8bf4/src%2Ftest%2Fui%2Fmalformed%2Fmalformed-interpolated.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/8e1b5d897a277e9e25685e9acac7333b9a0f8bf4/src%2Ftest%2Fui%2Fmalformed%2Fmalformed-interpolated.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmalformed%2Fmalformed-interpolated.stderr?ref=8e1b5d897a277e9e25685e9acac7333b9a0f8bf4", "patch": "@@ -0,0 +1,35 @@\n+error: suffixed literals are not allowed in attributes\n+  --> $DIR/malformed-interpolated.rs:5:21\n+   |\n+LL |         #[my_attr = $expr] //~ ERROR suffixed literals are not allowed in attributes\n+   |                     ^^^^^\n+...\n+LL | check!(0u8); // ERROR, see above\n+   | ------------ in this macro invocation\n+   |\n+   = help: instead of using a suffixed literal (1u8, 1.0f32, etc.), use an unsuffixed version (1, 1.0, etc.).\n+\n+error: unexpected token: `-0`\n+  --> $DIR/malformed-interpolated.rs:5:19\n+   |\n+LL |         #[my_attr = $expr] //~ ERROR suffixed literals are not allowed in attributes\n+   |                   ^\n+...\n+LL | check!(-0); // ERROR, see above\n+   | ----------- in this macro invocation\n+   |\n+   = help: try enabling `#![feature(unrestricted_attribute_tokens)]`\n+\n+error: unexpected token: `0 + 0`\n+  --> $DIR/malformed-interpolated.rs:5:19\n+   |\n+LL |         #[my_attr = $expr] //~ ERROR suffixed literals are not allowed in attributes\n+   |                   ^\n+...\n+LL | check!(0 + 0); // ERROR, see above\n+   | -------------- in this macro invocation\n+   |\n+   = help: try enabling `#![feature(unrestricted_attribute_tokens)]`\n+\n+error: aborting due to 3 previous errors\n+"}, {"sha": "36e566b5aa41a10b3192595b384090e4b7e252d7", "filename": "src/test/ui/parser/attr-bad-meta-2.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/8e1b5d897a277e9e25685e9acac7333b9a0f8bf4/src%2Ftest%2Fui%2Fparser%2Fattr-bad-meta-2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/8e1b5d897a277e9e25685e9acac7333b9a0f8bf4/src%2Ftest%2Fui%2Fparser%2Fattr-bad-meta-2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fattr-bad-meta-2.stderr?ref=8e1b5d897a277e9e25685e9acac7333b9a0f8bf4", "patch": "@@ -1,8 +1,8 @@\n error: unexpected token: `]`\n-  --> $DIR/attr-bad-meta-2.rs:1:9\n+  --> $DIR/attr-bad-meta-2.rs:1:8\n    |\n LL | #[path =] //~ ERROR unexpected token: `]`\n-   |         ^ unexpected token after this\n+   |        ^\n \n error: aborting due to previous error\n "}, {"sha": "af6bfa08aaa942816d021297a60dc1ae334c9ebe", "filename": "src/test/ui/proc-macro/proc-macro-gates.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/8e1b5d897a277e9e25685e9acac7333b9a0f8bf4/src%2Ftest%2Fui%2Fproc-macro%2Fproc-macro-gates.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8e1b5d897a277e9e25685e9acac7333b9a0f8bf4/src%2Ftest%2Fui%2Fproc-macro%2Fproc-macro-gates.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Fproc-macro-gates.rs?ref=8e1b5d897a277e9e25685e9acac7333b9a0f8bf4", "patch": "@@ -19,7 +19,7 @@ mod _test2_inner {\n           //~| ERROR: non-builtin inner attributes are unstable\n }\n \n-#[a = y] //~ ERROR: must only be followed by a delimiter token\n+#[a = \"y\"] //~ ERROR: must only be followed by a delimiter token\n fn _test3() {}\n \n fn attrs() {"}, {"sha": "abfcf09bfaf6c54ab31adea54b1a636d0f074630", "filename": "src/test/ui/proc-macro/proc-macro-gates.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/8e1b5d897a277e9e25685e9acac7333b9a0f8bf4/src%2Ftest%2Fui%2Fproc-macro%2Fproc-macro-gates.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/8e1b5d897a277e9e25685e9acac7333b9a0f8bf4/src%2Ftest%2Fui%2Fproc-macro%2Fproc-macro-gates.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Fproc-macro-gates.stderr?ref=8e1b5d897a277e9e25685e9acac7333b9a0f8bf4", "patch": "@@ -33,8 +33,8 @@ LL |     #![a] //~ ERROR: custom attributes cannot be applied to modules\n error: custom attribute invocations must be of the form #[foo] or #[foo(..)], the macro name must only be followed by a delimiter token\n   --> $DIR/proc-macro-gates.rs:22:1\n    |\n-LL | #[a = y] //~ ERROR: must only be followed by a delimiter token\n-   | ^^^^^^^^\n+LL | #[a = \"y\"] //~ ERROR: must only be followed by a delimiter token\n+   | ^^^^^^^^^^\n \n error[E0658]: custom attributes cannot be applied to statements (see issue #54727)\n   --> $DIR/proc-macro-gates.rs:31:5"}]}