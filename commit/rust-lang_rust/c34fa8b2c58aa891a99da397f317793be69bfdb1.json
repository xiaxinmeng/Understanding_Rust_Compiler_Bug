{"sha": "c34fa8b2c58aa891a99da397f317793be69bfdb1", "node_id": "MDY6Q29tbWl0NzI0NzEyOmMzNGZhOGIyYzU4YWE4OTFhOTlkYTM5N2YzMTc3OTNiZTY5YmZkYjE=", "commit": {"author": {"name": "Felix S. Klock II", "email": "pnkfelix@pnkfx.org", "date": "2015-04-15T00:19:52Z"}, "committer": {"name": "Felix S. Klock II", "email": "pnkfelix@pnkfx.org", "date": "2015-04-17T12:45:14Z"}, "message": "Add conditional overflow-checking to signed negate operator.", "tree": {"sha": "abbf05d0413b77213afacef8d5954e2464b0abb8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/abbf05d0413b77213afacef8d5954e2464b0abb8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c34fa8b2c58aa891a99da397f317793be69bfdb1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c34fa8b2c58aa891a99da397f317793be69bfdb1", "html_url": "https://github.com/rust-lang/rust/commit/c34fa8b2c58aa891a99da397f317793be69bfdb1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c34fa8b2c58aa891a99da397f317793be69bfdb1/comments", "author": {"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9a6d7fb9b068a0c35e469975d4b00992e0f9b8a8", "url": "https://api.github.com/repos/rust-lang/rust/commits/9a6d7fb9b068a0c35e469975d4b00992e0f9b8a8", "html_url": "https://github.com/rust-lang/rust/commit/9a6d7fb9b068a0c35e469975d4b00992e0f9b8a8"}], "stats": {"total": 21, "additions": 18, "deletions": 3}, "files": [{"sha": "27919d645b695fa39a259ba786c80f5680d536b9", "filename": "src/librustc_trans/trans/expr.rs", "status": "modified", "additions": 18, "deletions": 3, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/c34fa8b2c58aa891a99da397f317793be69bfdb1/src%2Flibrustc_trans%2Ftrans%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c34fa8b2c58aa891a99da397f317793be69bfdb1/src%2Flibrustc_trans%2Ftrans%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Ftrans%2Fexpr.rs?ref=c34fa8b2c58aa891a99da397f317793be69bfdb1", "patch": "@@ -1530,11 +1530,26 @@ fn trans_unary<'blk, 'tcx>(bcx: Block<'blk, 'tcx>,\n         ast::UnNeg => {\n             let datum = unpack_datum!(bcx, trans(bcx, sub_expr));\n             let val = datum.to_llscalarish(bcx);\n-            let llneg = {\n+            let (bcx, llneg) = {\n                 if ty::type_is_fp(un_ty) {\n-                    FNeg(bcx, val, debug_loc)\n+                    let result = FNeg(bcx, val, debug_loc);\n+                    (bcx, result)\n                 } else {\n-                    Neg(bcx, val, debug_loc)\n+                    let is_signed = ty::type_is_signed(un_ty);\n+                    let result = Neg(bcx, val, debug_loc);\n+                    let bcx = if bcx.ccx().check_overflow() && is_signed {\n+                        let (llty, min) = base::llty_and_min_for_signed_ty(bcx, un_ty);\n+                        let is_min = ICmp(bcx, llvm::IntEQ, val,\n+                                          C_integral(llty, min, true), debug_loc);\n+                        with_cond(bcx, is_min, |bcx| {\n+                            let msg = InternedString::new(\n+                                \"attempted to negate with overflow\");\n+                            controlflow::trans_fail(bcx, expr_info(expr), msg)\n+                        })\n+                    } else {\n+                        bcx\n+                    };\n+                    (bcx, result)\n                 }\n             };\n             immediate_rvalue_bcx(bcx, llneg, un_ty).to_expr_datumblock()"}]}