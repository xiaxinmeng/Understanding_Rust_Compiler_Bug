{"sha": "4ce1ce1f7672c52ce32cd429bb21a12653e2b605", "node_id": "C_kwDOAAsO6NoAKDRjZTFjZTFmNzY3MmM1MmNlMzJjZDQyOWJiMjFhMTI2NTNlMmI2MDU", "commit": {"author": {"name": "the8472", "email": "the8472@users.noreply.github.com", "date": "2021-10-12T12:53:09Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-10-12T12:53:09Z"}, "message": "Rollup merge of #89784 - Mark-Simulacrum:delete-cache-hit-tracking, r=petrochenkov\n\nRemove built-in query cache_hit tracking\n\nThis was already only enabled in debug_assertions builds. Generally, it seems\nlike most use cases that would use this could also use the -Zself-profile flag\nwhich also tracks cache hits (in all builds), and so the extra cfg's and such\nare not really necessary.\n\nThis is largely just a small cleanup though, which primarily is intended to make\nother changes easier by avoiding the need to deal with this field.", "tree": {"sha": "85b60eaa063e4958f6b1f057b92a724447d10e61", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/85b60eaa063e4958f6b1f057b92a724447d10e61"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4ce1ce1f7672c52ce32cd429bb21a12653e2b605", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhZYU1CRBK7hj4Ov3rIwAAUlwIABRlMOopPlfznovbWUV28FMQ\nWxopHzJ5EYNlCq6OylzpCpCfashEDA6t5VYYEdoYM5NwDGkxkpTnYQWblCdrewsw\nV3ixyPWXoVv3Hypy1+G6wyBWQhFeb1gsIg3p8ktAyXcdH9rah1FiovNjWWIVq4+k\nbR9hFNMSEZKZZDEdFdgxbcwEFmK4opwjUIWd/Hk2Mh7OsERjnFJfbHh3Sz5Jfhxe\nt/fAWLsKnVA6IGS4CHWZOjYzoOlG/tn1pt1Y3TJK5V+UngdgfsFIW3DDPYW9kK/I\nmc/FXolEIAHOS3liBi+Zx1ZroiY+3ijJ1/OV9SN+qvl6i7wIQxSy7U1ZFyKu9xw=\n=9kJG\n-----END PGP SIGNATURE-----\n", "payload": "tree 85b60eaa063e4958f6b1f057b92a724447d10e61\nparent b55a3c5d150b64fbd878109d9428ac8edc9cd68b\nparent 127373822e9d602bc4c9564fd8957a1b0a114835\nauthor the8472 <the8472@users.noreply.github.com> 1634043189 +0200\ncommitter GitHub <noreply@github.com> 1634043189 +0200\n\nRollup merge of #89784 - Mark-Simulacrum:delete-cache-hit-tracking, r=petrochenkov\n\nRemove built-in query cache_hit tracking\n\nThis was already only enabled in debug_assertions builds. Generally, it seems\nlike most use cases that would use this could also use the -Zself-profile flag\nwhich also tracks cache hits (in all builds), and so the extra cfg's and such\nare not really necessary.\n\nThis is largely just a small cleanup though, which primarily is intended to make\nother changes easier by avoiding the need to deal with this field.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4ce1ce1f7672c52ce32cd429bb21a12653e2b605", "html_url": "https://github.com/rust-lang/rust/commit/4ce1ce1f7672c52ce32cd429bb21a12653e2b605", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4ce1ce1f7672c52ce32cd429bb21a12653e2b605/comments", "author": {"login": "the8472", "id": 1065730, "node_id": "MDQ6VXNlcjEwNjU3MzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1065730?v=4", "gravatar_id": "", "url": "https://api.github.com/users/the8472", "html_url": "https://github.com/the8472", "followers_url": "https://api.github.com/users/the8472/followers", "following_url": "https://api.github.com/users/the8472/following{/other_user}", "gists_url": "https://api.github.com/users/the8472/gists{/gist_id}", "starred_url": "https://api.github.com/users/the8472/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/the8472/subscriptions", "organizations_url": "https://api.github.com/users/the8472/orgs", "repos_url": "https://api.github.com/users/the8472/repos", "events_url": "https://api.github.com/users/the8472/events{/privacy}", "received_events_url": "https://api.github.com/users/the8472/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b55a3c5d150b64fbd878109d9428ac8edc9cd68b", "url": "https://api.github.com/repos/rust-lang/rust/commits/b55a3c5d150b64fbd878109d9428ac8edc9cd68b", "html_url": "https://github.com/rust-lang/rust/commit/b55a3c5d150b64fbd878109d9428ac8edc9cd68b"}, {"sha": "127373822e9d602bc4c9564fd8957a1b0a114835", "url": "https://api.github.com/repos/rust-lang/rust/commits/127373822e9d602bc4c9564fd8957a1b0a114835", "html_url": "https://github.com/rust-lang/rust/commit/127373822e9d602bc4c9564fd8957a1b0a114835"}], "stats": {"total": 50, "additions": 1, "deletions": 49}, "files": [{"sha": "c3bbd51f3d3cc13140b6f943247ef39a814b1585", "filename": "compiler/rustc_query_impl/src/stats.rs", "status": "modified", "additions": 0, "deletions": 27, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/4ce1ce1f7672c52ce32cd429bb21a12653e2b605/compiler%2Frustc_query_impl%2Fsrc%2Fstats.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4ce1ce1f7672c52ce32cd429bb21a12653e2b605/compiler%2Frustc_query_impl%2Fsrc%2Fstats.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_query_impl%2Fsrc%2Fstats.rs?ref=4ce1ce1f7672c52ce32cd429bb21a12653e2b605", "patch": "@@ -5,8 +5,6 @@ use rustc_query_system::query::{QueryCache, QueryCacheStore};\n \n use std::any::type_name;\n use std::mem;\n-#[cfg(debug_assertions)]\n-use std::sync::atomic::Ordering;\n \n trait KeyStats {\n     fn key_stats(&self, stats: &mut QueryStats);\n@@ -27,7 +25,6 @@ impl KeyStats for DefId {\n #[derive(Clone)]\n struct QueryStats {\n     name: &'static str,\n-    cache_hits: usize,\n     key_size: usize,\n     key_type: &'static str,\n     value_size: usize,\n@@ -42,10 +39,6 @@ where\n {\n     let mut stats = QueryStats {\n         name,\n-        #[cfg(debug_assertions)]\n-        cache_hits: map.cache_hits.load(Ordering::Relaxed),\n-        #[cfg(not(debug_assertions))]\n-        cache_hits: 0,\n         key_size: mem::size_of::<C::Key>(),\n         key_type: type_name::<C::Key>(),\n         value_size: mem::size_of::<C::Value>(),\n@@ -63,12 +56,6 @@ where\n pub fn print_stats(tcx: TyCtxt<'_>) {\n     let queries = query_stats(tcx);\n \n-    if cfg!(debug_assertions) {\n-        let hits: usize = queries.iter().map(|s| s.cache_hits).sum();\n-        let results: usize = queries.iter().map(|s| s.entry_count).sum();\n-        eprintln!(\"\\nQuery cache hit rate: {}\", hits as f64 / (hits + results) as f64);\n-    }\n-\n     let mut query_key_sizes = queries.clone();\n     query_key_sizes.sort_by_key(|q| q.key_size);\n     eprintln!(\"\\nLarge query keys:\");\n@@ -83,20 +70,6 @@ pub fn print_stats(tcx: TyCtxt<'_>) {\n         eprintln!(\"   {} - {} x {} - {}\", q.name, q.value_size, q.entry_count, q.value_type);\n     }\n \n-    if cfg!(debug_assertions) {\n-        let mut query_cache_hits = queries.clone();\n-        query_cache_hits.sort_by_key(|q| q.cache_hits);\n-        eprintln!(\"\\nQuery cache hits:\");\n-        for q in query_cache_hits.iter().rev() {\n-            eprintln!(\n-                \"   {} - {} ({}%)\",\n-                q.name,\n-                q.cache_hits,\n-                q.cache_hits as f64 / (q.cache_hits + q.entry_count) as f64\n-            );\n-        }\n-    }\n-\n     let mut query_value_count = queries.clone();\n     query_value_count.sort_by_key(|q| q.entry_count);\n     eprintln!(\"\\nQuery value count:\");"}, {"sha": "07d720599759607a25ee5f4c68df663f00c6fc39", "filename": "compiler/rustc_query_system/src/query/plumbing.rs", "status": "modified", "additions": 1, "deletions": 22, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/4ce1ce1f7672c52ce32cd429bb21a12653e2b605/compiler%2Frustc_query_system%2Fsrc%2Fquery%2Fplumbing.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4ce1ce1f7672c52ce32cd429bb21a12653e2b605/compiler%2Frustc_query_system%2Fsrc%2Fquery%2Fplumbing.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_query_system%2Fsrc%2Fquery%2Fplumbing.rs?ref=4ce1ce1f7672c52ce32cd429bb21a12653e2b605", "patch": "@@ -26,24 +26,15 @@ use std::hash::{Hash, Hasher};\n use std::mem;\n use std::num::NonZeroU32;\n use std::ptr;\n-#[cfg(debug_assertions)]\n-use std::sync::atomic::{AtomicUsize, Ordering};\n \n pub struct QueryCacheStore<C: QueryCache> {\n     cache: C,\n     shards: Sharded<C::Sharded>,\n-    #[cfg(debug_assertions)]\n-    pub cache_hits: AtomicUsize,\n }\n \n impl<C: QueryCache + Default> Default for QueryCacheStore<C> {\n     fn default() -> Self {\n-        Self {\n-            cache: C::default(),\n-            shards: Default::default(),\n-            #[cfg(debug_assertions)]\n-            cache_hits: AtomicUsize::new(0),\n-        }\n+        Self { cache: C::default(), shards: Default::default() }\n     }\n }\n \n@@ -377,10 +368,6 @@ where\n         if unlikely!(tcx.profiler().enabled()) {\n             tcx.profiler().query_cache_hit(index.into());\n         }\n-        #[cfg(debug_assertions)]\n-        {\n-            cache.cache_hits.fetch_add(1, Ordering::Relaxed);\n-        }\n         tcx.dep_graph().read_index(index);\n         on_hit(value)\n     })\n@@ -429,10 +416,6 @@ where\n             if unlikely!(tcx.dep_context().profiler().enabled()) {\n                 tcx.dep_context().profiler().query_cache_hit(index.into());\n             }\n-            #[cfg(debug_assertions)]\n-            {\n-                cache.cache_hits.fetch_add(1, Ordering::Relaxed);\n-            }\n             query_blocked_prof_timer.finish_with_query_invocation_id(index.into());\n \n             (v, Some(index))\n@@ -705,10 +688,6 @@ where\n         if unlikely!(tcx.dep_context().profiler().enabled()) {\n             tcx.dep_context().profiler().query_cache_hit(index.into());\n         }\n-        #[cfg(debug_assertions)]\n-        {\n-            cache.cache_hits.fetch_add(1, Ordering::Relaxed);\n-        }\n     });\n \n     let lookup = match cached {"}]}