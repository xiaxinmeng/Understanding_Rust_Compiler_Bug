{"sha": "75b67c2d5e12d98b70323bd7874886dd650c5499", "node_id": "MDY6Q29tbWl0NzI0NzEyOjc1YjY3YzJkNWUxMmQ5OGI3MDMyM2JkNzg3NDg4NmRkNjUwYzU0OTk=", "commit": {"author": {"name": "Nicholas Nethercote", "email": "nnethercote@mozilla.com", "date": "2020-08-05T07:29:13Z"}, "committer": {"name": "Nicholas Nethercote", "email": "nnethercote@mozilla.com", "date": "2020-08-09T21:12:59Z"}, "message": "Fix symbol ordering for confusable idents detection.\n\nConfusable idents detection uses a type `BTreeMap<Symbol, Span>`. This is\nhighly dubious given that `Symbol` doesn't guarantee a meaningful order. (In\npractice, it currently gives an order that mostly matches source code order.)\n\nAs a result, changes in `Symbol` representation make the\n`lint-confusable-idents.rs` test fail, because this error message:\n\n> identifier pair considered confusable between `\uff53` and `s`\n\nis changed to this:\n\n> identifier pair considered confusable between `s` and `\uff53`\n\nand the corresponding span pointers get swapped erroneously, leading to\nan incorrect \"previous identifier\" label.\n\nThis commit sorts the relevant symbols by span before doing the checking,\nwhich ensures that the ident that appears first in the code will be mentioned\nfirst in the message. The commit also extends the test slightly to be more\nthorough.", "tree": {"sha": "62febac00e5ee2d4e9b0928d64333f54cae36cab", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/62febac00e5ee2d4e9b0928d64333f54cae36cab"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/75b67c2d5e12d98b70323bd7874886dd650c5499", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/75b67c2d5e12d98b70323bd7874886dd650c5499", "html_url": "https://github.com/rust-lang/rust/commit/75b67c2d5e12d98b70323bd7874886dd650c5499", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/75b67c2d5e12d98b70323bd7874886dd650c5499/comments", "author": {"login": "nnethercote", "id": 1940286, "node_id": "MDQ6VXNlcjE5NDAyODY=", "avatar_url": "https://avatars.githubusercontent.com/u/1940286?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nnethercote", "html_url": "https://github.com/nnethercote", "followers_url": "https://api.github.com/users/nnethercote/followers", "following_url": "https://api.github.com/users/nnethercote/following{/other_user}", "gists_url": "https://api.github.com/users/nnethercote/gists{/gist_id}", "starred_url": "https://api.github.com/users/nnethercote/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nnethercote/subscriptions", "organizations_url": "https://api.github.com/users/nnethercote/orgs", "repos_url": "https://api.github.com/users/nnethercote/repos", "events_url": "https://api.github.com/users/nnethercote/events{/privacy}", "received_events_url": "https://api.github.com/users/nnethercote/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nnethercote", "id": 1940286, "node_id": "MDQ6VXNlcjE5NDAyODY=", "avatar_url": "https://avatars.githubusercontent.com/u/1940286?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nnethercote", "html_url": "https://github.com/nnethercote", "followers_url": "https://api.github.com/users/nnethercote/followers", "following_url": "https://api.github.com/users/nnethercote/following{/other_user}", "gists_url": "https://api.github.com/users/nnethercote/gists{/gist_id}", "starred_url": "https://api.github.com/users/nnethercote/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nnethercote/subscriptions", "organizations_url": "https://api.github.com/users/nnethercote/orgs", "repos_url": "https://api.github.com/users/nnethercote/repos", "events_url": "https://api.github.com/users/nnethercote/events{/privacy}", "received_events_url": "https://api.github.com/users/nnethercote/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "39e593ab14c53fda63c3f2756716c5ad3cbb6465", "url": "https://api.github.com/repos/rust-lang/rust/commits/39e593ab14c53fda63c3f2756716c5ad3cbb6465", "html_url": "https://github.com/rust-lang/rust/commit/39e593ab14c53fda63c3f2756716c5ad3cbb6465"}], "stats": {"total": 24, "additions": 20, "deletions": 4}, "files": [{"sha": "7c45d826473b8df537a6513006ba4c85d896c28c", "filename": "src/librustc_lint/non_ascii_idents.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/75b67c2d5e12d98b70323bd7874886dd650c5499/src%2Flibrustc_lint%2Fnon_ascii_idents.rs", "raw_url": "https://github.com/rust-lang/rust/raw/75b67c2d5e12d98b70323bd7874886dd650c5499/src%2Flibrustc_lint%2Fnon_ascii_idents.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_lint%2Fnon_ascii_idents.rs?ref=75b67c2d5e12d98b70323bd7874886dd650c5499", "patch": "@@ -58,6 +58,12 @@ impl EarlyLintPass for NonAsciiIdents {\n \n         let mut has_non_ascii_idents = false;\n         let symbols = cx.sess.parse_sess.symbol_gallery.symbols.lock();\n+\n+        // Sort by `Span` so that error messages make sense with respect to the\n+        // order of identifier locations in the code.\n+        let mut symbols: Vec<_> = symbols.iter().collect();\n+        symbols.sort_by_key(|k| k.1);\n+\n         for (symbol, &sp) in symbols.iter() {\n             let symbol_str = symbol.as_str();\n             if symbol_str.is_ascii() {"}, {"sha": "a2bb8c4f91ff4d3ccf76dfa1f14567ee95580654", "filename": "src/librustc_session/parse.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/75b67c2d5e12d98b70323bd7874886dd650c5499/src%2Flibrustc_session%2Fparse.rs", "raw_url": "https://github.com/rust-lang/rust/raw/75b67c2d5e12d98b70323bd7874886dd650c5499/src%2Flibrustc_session%2Fparse.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_session%2Fparse.rs?ref=75b67c2d5e12d98b70323bd7874886dd650c5499", "patch": "@@ -13,7 +13,6 @@ use rustc_span::hygiene::ExpnId;\n use rustc_span::source_map::{FilePathMapping, SourceMap};\n use rustc_span::{MultiSpan, Span, Symbol};\n \n-use std::collections::BTreeMap;\n use std::path::PathBuf;\n use std::str;\n \n@@ -64,7 +63,7 @@ impl GatedSpans {\n #[derive(Default)]\n pub struct SymbolGallery {\n     /// All symbols occurred and their first occurrence span.\n-    pub symbols: Lock<BTreeMap<Symbol, Span>>,\n+    pub symbols: Lock<FxHashMap<Symbol, Span>>,\n }\n \n impl SymbolGallery {"}, {"sha": "2c711f994043f6f0b6a7e5814cdd6ce46d770b20", "filename": "src/test/ui/lint/rfc-2457-non-ascii-idents/lint-confusable-idents.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/75b67c2d5e12d98b70323bd7874886dd650c5499/src%2Ftest%2Fui%2Flint%2Frfc-2457-non-ascii-idents%2Flint-confusable-idents.rs", "raw_url": "https://github.com/rust-lang/rust/raw/75b67c2d5e12d98b70323bd7874886dd650c5499/src%2Ftest%2Fui%2Flint%2Frfc-2457-non-ascii-idents%2Flint-confusable-idents.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Frfc-2457-non-ascii-idents%2Flint-confusable-idents.rs?ref=75b67c2d5e12d98b70323bd7874886dd650c5499", "patch": "@@ -3,9 +3,11 @@\n #![allow(uncommon_codepoints, non_upper_case_globals)]\n \n const \uff53: usize = 42;\n+const s_s: usize = 42;\n \n fn main() {\n     let s = \"rust\"; //~ ERROR identifier pair considered confusable\n+    let \uff53_\uff53 = \"rust2\"; //~ ERROR identifier pair considered confusable\n     not_affected();\n }\n "}, {"sha": "b9af60963adf6893c65f558a11dfc6b69a117fc6", "filename": "src/test/ui/lint/rfc-2457-non-ascii-idents/lint-confusable-idents.stderr", "status": "modified", "additions": 11, "deletions": 2, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/75b67c2d5e12d98b70323bd7874886dd650c5499/src%2Ftest%2Fui%2Flint%2Frfc-2457-non-ascii-idents%2Flint-confusable-idents.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/75b67c2d5e12d98b70323bd7874886dd650c5499/src%2Ftest%2Fui%2Flint%2Frfc-2457-non-ascii-idents%2Flint-confusable-idents.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Frfc-2457-non-ascii-idents%2Flint-confusable-idents.stderr?ref=75b67c2d5e12d98b70323bd7874886dd650c5499", "patch": "@@ -1,5 +1,5 @@\n error: identifier pair considered confusable between `\uff53` and `s`\n-  --> $DIR/lint-confusable-idents.rs:8:9\n+  --> $DIR/lint-confusable-idents.rs:9:9\n    |\n LL | const \uff53: usize = 42;\n    |       -- this is where the previous identifier occurred\n@@ -13,5 +13,14 @@ note: the lint level is defined here\n LL | #![deny(confusable_idents)]\n    |         ^^^^^^^^^^^^^^^^^\n \n-error: aborting due to previous error\n+error: identifier pair considered confusable between `s_s` and `\uff53_\uff53`\n+  --> $DIR/lint-confusable-idents.rs:10:9\n+   |\n+LL | const s_s: usize = 42;\n+   |       --- this is where the previous identifier occurred\n+...\n+LL |     let \uff53_\uff53 = \"rust2\";\n+   |         ^^^^^\n+\n+error: aborting due to 2 previous errors\n "}]}