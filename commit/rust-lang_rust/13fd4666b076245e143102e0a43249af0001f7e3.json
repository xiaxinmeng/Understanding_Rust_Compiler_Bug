{"sha": "13fd4666b076245e143102e0a43249af0001f7e3", "node_id": "MDY6Q29tbWl0NzI0NzEyOjEzZmQ0NjY2YjA3NjI0NWUxNDMxMDJlMGE0MzI0OWFmMDAwMWY3ZTM=", "commit": {"author": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2019-08-13T06:56:13Z"}, "committer": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2019-08-13T07:52:07Z"}, "message": "Point at the right enclosing scope when using `await` in non-async fn", "tree": {"sha": "9b576f39b000c5c0e35872c4364b30b01c288184", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9b576f39b000c5c0e35872c4364b30b01c288184"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/13fd4666b076245e143102e0a43249af0001f7e3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/13fd4666b076245e143102e0a43249af0001f7e3", "html_url": "https://github.com/rust-lang/rust/commit/13fd4666b076245e143102e0a43249af0001f7e3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/13fd4666b076245e143102e0a43249af0001f7e3/comments", "author": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "committer": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "60960a260f7b5c695fd0717311d72ce62dd4eb43", "url": "https://api.github.com/repos/rust-lang/rust/commits/60960a260f7b5c695fd0717311d72ce62dd4eb43", "html_url": "https://github.com/rust-lang/rust/commit/60960a260f7b5c695fd0717311d72ce62dd4eb43"}], "stats": {"total": 27, "additions": 26, "deletions": 1}, "files": [{"sha": "e3a5400942d1a625363e06698b7654f77d340c1c", "filename": "src/librustc/hir/lowering/expr.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/13fd4666b076245e143102e0a43249af0001f7e3/src%2Flibrustc%2Fhir%2Flowering%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/13fd4666b076245e143102e0a43249af0001f7e3/src%2Flibrustc%2Fhir%2Flowering%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Flowering%2Fexpr.rs?ref=13fd4666b076245e143102e0a43249af0001f7e3", "patch": "@@ -677,6 +677,7 @@ impl LoweringContext<'_> {\n         let fn_decl = self.lower_fn_decl(decl, None, false, None);\n \n         self.with_new_scopes(|this| {\n+            let prev = this.current_item;\n             this.current_item = Some(fn_decl_span);\n             let mut generator_kind = None;\n             let body_id = this.lower_fn_body(decl, |this| {\n@@ -690,8 +691,10 @@ impl LoweringContext<'_> {\n                 generator_kind,\n                 movability,\n             );\n+            let capture_clause = this.lower_capture_clause(capture_clause);\n+            this.current_item = prev;\n             hir::ExprKind::Closure(\n-                this.lower_capture_clause(capture_clause),\n+                capture_clause,\n                 fn_decl,\n                 body_id,\n                 fn_decl_span,"}, {"sha": "a03168784565245edd0e5198b54cdf66e022e14e", "filename": "src/test/ui/issues/issue-63398.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/13fd4666b076245e143102e0a43249af0001f7e3/src%2Ftest%2Fui%2Fissues%2Fissue-63398.rs", "raw_url": "https://github.com/rust-lang/rust/raw/13fd4666b076245e143102e0a43249af0001f7e3/src%2Ftest%2Fui%2Fissues%2Fissue-63398.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-63398.rs?ref=13fd4666b076245e143102e0a43249af0001f7e3", "patch": "@@ -0,0 +1,11 @@\n+// edition:2018\n+#![feature(async_await)]\n+\n+async fn do_the_thing() -> u8 {\n+    8\n+}\n+\n+fn main() {\n+    let x = move || {};\n+    let y = do_the_thing().await; //~ ERROR `await` is only allowed inside `async` functions\n+}"}, {"sha": "b2ba46ce317cdb0bbbbb1fd10a34539fe567f64d", "filename": "src/test/ui/issues/issue-63398.stderr", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/13fd4666b076245e143102e0a43249af0001f7e3/src%2Ftest%2Fui%2Fissues%2Fissue-63398.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/13fd4666b076245e143102e0a43249af0001f7e3/src%2Ftest%2Fui%2Fissues%2Fissue-63398.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-63398.stderr?ref=13fd4666b076245e143102e0a43249af0001f7e3", "patch": "@@ -0,0 +1,11 @@\n+error[E0728]: `await` is only allowed inside `async` functions and blocks\n+  --> $DIR/issue-63398.rs:10:13\n+   |\n+LL | fn main() {\n+   |    ---- this is not `async`\n+LL |     let x = move || {};\n+LL |     let y = do_the_thing().await;\n+   |             ^^^^^^^^^^^^^^^^^^^^ only allowed inside `async` functions and blocks\n+\n+error: aborting due to previous error\n+"}]}