{"sha": "7a14f9ed4fa60f4d8fc042fc678c80c14a850dc0", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdhMTRmOWVkNGZhNjBmNGQ4ZmMwNDJmYzY3OGM4MGMxNGE4NTBkYzA=", "commit": {"author": {"name": "Nikita Popov", "email": "nikita.ppv@gmail.com", "date": "2020-01-18T22:00:30Z"}, "committer": {"name": "Nikita Popov", "email": "nikita.ppv@gmail.com", "date": "2020-03-19T19:09:57Z"}, "message": "Fix LLVM version handling in compiletest\n\nConvert version string to integer before comparing. Otherwise\nwe get into trouble with double digit versions ;)", "tree": {"sha": "167ad14db1fee03118f10be69ad87f96b8271d97", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/167ad14db1fee03118f10be69ad87f96b8271d97"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7a14f9ed4fa60f4d8fc042fc678c80c14a850dc0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7a14f9ed4fa60f4d8fc042fc678c80c14a850dc0", "html_url": "https://github.com/rust-lang/rust/commit/7a14f9ed4fa60f4d8fc042fc678c80c14a850dc0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7a14f9ed4fa60f4d8fc042fc678c80c14a850dc0/comments", "author": {"login": "nikic", "id": 216080, "node_id": "MDQ6VXNlcjIxNjA4MA==", "avatar_url": "https://avatars.githubusercontent.com/u/216080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikic", "html_url": "https://github.com/nikic", "followers_url": "https://api.github.com/users/nikic/followers", "following_url": "https://api.github.com/users/nikic/following{/other_user}", "gists_url": "https://api.github.com/users/nikic/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikic/subscriptions", "organizations_url": "https://api.github.com/users/nikic/orgs", "repos_url": "https://api.github.com/users/nikic/repos", "events_url": "https://api.github.com/users/nikic/events{/privacy}", "received_events_url": "https://api.github.com/users/nikic/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nikic", "id": 216080, "node_id": "MDQ6VXNlcjIxNjA4MA==", "avatar_url": "https://avatars.githubusercontent.com/u/216080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikic", "html_url": "https://github.com/nikic", "followers_url": "https://api.github.com/users/nikic/followers", "following_url": "https://api.github.com/users/nikic/following{/other_user}", "gists_url": "https://api.github.com/users/nikic/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikic/subscriptions", "organizations_url": "https://api.github.com/users/nikic/orgs", "repos_url": "https://api.github.com/users/nikic/repos", "events_url": "https://api.github.com/users/nikic/events{/privacy}", "received_events_url": "https://api.github.com/users/nikic/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "841558d3bdc9c9510b841c438838196378741021", "url": "https://api.github.com/repos/rust-lang/rust/commits/841558d3bdc9c9510b841c438838196378741021", "html_url": "https://github.com/rust-lang/rust/commit/841558d3bdc9c9510b841c438838196378741021"}], "stats": {"total": 32, "additions": 23, "deletions": 9}, "files": [{"sha": "cb648db8830ef3fbd06bfd5081d161dcca7a05db", "filename": "src/tools/compiletest/src/header.rs", "status": "modified", "additions": 21, "deletions": 6, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/7a14f9ed4fa60f4d8fc042fc678c80c14a850dc0/src%2Ftools%2Fcompiletest%2Fsrc%2Fheader.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7a14f9ed4fa60f4d8fc042fc678c80c14a850dc0/src%2Ftools%2Fcompiletest%2Fsrc%2Fheader.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fheader.rs?ref=7a14f9ed4fa60f4d8fc042fc678c80c14a850dc0", "patch": "@@ -191,6 +191,7 @@ impl EarlyProps {\n                 return true;\n             }\n             if let Some(ref actual_version) = config.llvm_version {\n+                let actual_version = version_to_int(actual_version);\n                 if line.starts_with(\"min-llvm-version\") {\n                     let min_version = line\n                         .trim_end()\n@@ -199,7 +200,7 @@ impl EarlyProps {\n                         .expect(\"Malformed llvm version directive\");\n                     // Ignore if actual version is smaller the minimum required\n                     // version\n-                    &actual_version[..] < min_version\n+                    actual_version < version_to_int(min_version)\n                 } else if line.starts_with(\"min-system-llvm-version\") {\n                     let min_version = line\n                         .trim_end()\n@@ -208,7 +209,7 @@ impl EarlyProps {\n                         .expect(\"Malformed llvm version directive\");\n                     // Ignore if using system LLVM and actual version\n                     // is smaller the minimum required version\n-                    config.system_llvm && &actual_version[..] < min_version\n+                    config.system_llvm && actual_version < version_to_int(min_version)\n                 } else if line.starts_with(\"ignore-llvm-version\") {\n                     // Syntax is: \"ignore-llvm-version <version1> [- <version2>]\"\n                     let range_components = line\n@@ -219,15 +220,15 @@ impl EarlyProps {\n                         .take(3) // 3 or more = invalid, so take at most 3.\n                         .collect::<Vec<&str>>();\n                     match range_components.len() {\n-                        1 => &actual_version[..] == range_components[0],\n+                        1 => actual_version == version_to_int(range_components[0]),\n                         2 => {\n-                            let v_min = range_components[0];\n-                            let v_max = range_components[1];\n+                            let v_min = version_to_int(range_components[0]);\n+                            let v_max = version_to_int(range_components[1]);\n                             if v_max < v_min {\n                                 panic!(\"Malformed LLVM version range: max < min\")\n                             }\n                             // Ignore if version lies inside of range.\n-                            &actual_version[..] >= v_min && &actual_version[..] <= v_max\n+                            actual_version >= v_min && actual_version <= v_max\n                         }\n                         _ => panic!(\"Malformed LLVM version directive\"),\n                     }\n@@ -238,6 +239,20 @@ impl EarlyProps {\n                 false\n             }\n         }\n+\n+        fn version_to_int(version: &str) -> u32 {\n+            let version_without_suffix = version.split('-').next().unwrap();\n+            let components: Vec<u32> = version_without_suffix\n+                .split('.')\n+                .map(|s| s.parse().expect(\"Malformed version component\"))\n+                .collect();\n+            match components.len() {\n+                1 => components[0] * 10000,\n+                2 => components[0] * 10000 + components[1] * 100,\n+                3 => components[0] * 10000 + components[1] * 100 + components[2],\n+                _ => panic!(\"Malformed version\"),\n+            }\n+        }\n     }\n }\n "}, {"sha": "31d991e0c2f87c9ad0a2e3efe40c3f7bda103ca3", "filename": "src/tools/compiletest/src/header/tests.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/7a14f9ed4fa60f4d8fc042fc678c80c14a850dc0/src%2Ftools%2Fcompiletest%2Fsrc%2Fheader%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7a14f9ed4fa60f4d8fc042fc678c80c14a850dc0/src%2Ftools%2Fcompiletest%2Fsrc%2Fheader%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fheader%2Ftests.rs?ref=7a14f9ed4fa60f4d8fc042fc678c80c14a850dc0", "patch": "@@ -122,9 +122,8 @@ fn llvm_version() {\n     config.llvm_version = Some(\"9.3.1-rust-1.43.0-dev\".to_owned());\n     assert!(!parse_rs(&config, \"// min-llvm-version 9.2\").ignore);\n \n-    // FIXME.\n-    // config.llvm_version = Some(\"10.0.0-rust\".to_owned());\n-    // assert!(!parse_rs(&config, \"// min-llvm-version 9.0\").ignore);\n+    config.llvm_version = Some(\"10.0.0-rust\".to_owned());\n+    assert!(!parse_rs(&config, \"// min-llvm-version 9.0\").ignore);\n }\n \n #[test]"}]}