{"sha": "50a02b43ba17bf1547b7124dff909604e967a7f6", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUwYTAyYjQzYmExN2JmMTU0N2I3MTI0ZGZmOTA5NjA0ZTk2N2E3ZjY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-12-14T13:48:41Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-12-14T13:48:41Z"}, "message": "Auto merge of #29735 - Amanieu:asm_indirect_constraint, r=pnkfelix\n\nThis PR reverts #29543 and instead implements proper support for \"=*m\" and \"+*m\" indirect output operands. This provides a framework on top of which support for plain memory operands (\"m\", \"=m\" and \"+m\") can be implemented.\n\nThis also fixes the liveness analysis pass not handling read/write operands correctly.", "tree": {"sha": "04c161e2e0556bca5bc5e4508847f2bbbae5b480", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/04c161e2e0556bca5bc5e4508847f2bbbae5b480"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/50a02b43ba17bf1547b7124dff909604e967a7f6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/50a02b43ba17bf1547b7124dff909604e967a7f6", "html_url": "https://github.com/rust-lang/rust/commit/50a02b43ba17bf1547b7124dff909604e967a7f6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/50a02b43ba17bf1547b7124dff909604e967a7f6/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6b3a3f270219819f8f98c2b6807ff70b92a941ac", "url": "https://api.github.com/repos/rust-lang/rust/commits/6b3a3f270219819f8f98c2b6807ff70b92a941ac", "html_url": "https://github.com/rust-lang/rust/commit/6b3a3f270219819f8f98c2b6807ff70b92a941ac"}, {"sha": "65707dfc001b4dea745a040c2ecc61847ccba608", "url": "https://api.github.com/repos/rust-lang/rust/commits/65707dfc001b4dea745a040c2ecc61847ccba608", "html_url": "https://github.com/rust-lang/rust/commit/65707dfc001b4dea745a040c2ecc61847ccba608"}], "stats": {"total": 189, "additions": 132, "deletions": 57}, "files": [{"sha": "8baae99c2f24b57e492bbf6dca2f583a1a7af2bf", "filename": "src/librustc/middle/cfg/construct.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/50a02b43ba17bf1547b7124dff909604e967a7f6/src%2Flibrustc%2Fmiddle%2Fcfg%2Fconstruct.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50a02b43ba17bf1547b7124dff909604e967a7f6/src%2Flibrustc%2Fmiddle%2Fcfg%2Fconstruct.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fcfg%2Fconstruct.rs?ref=50a02b43ba17bf1547b7124dff909604e967a7f6", "patch": "@@ -368,8 +368,7 @@ impl<'a, 'tcx> CFGBuilder<'a, 'tcx> {\n                 }), pred);\n                 let post_outputs = self.exprs(outputs.map(|a| {\n                     debug!(\"cfg::construct InlineAsm id:{} output:{:?}\", expr.id, a);\n-                    let &(_, ref expr, _) = a;\n-                    &**expr\n+                    &*a.expr\n                 }), post_inputs);\n                 self.add_ast_node(expr.id, &[post_outputs])\n             }"}, {"sha": "4861f0a6b643641aa8d5ed13b29242732480a4fe", "filename": "src/librustc/middle/expr_use_visitor.rs", "status": "modified", "additions": 7, "deletions": 3, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/50a02b43ba17bf1547b7124dff909604e967a7f6/src%2Flibrustc%2Fmiddle%2Fexpr_use_visitor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50a02b43ba17bf1547b7124dff909604e967a7f6/src%2Flibrustc%2Fmiddle%2Fexpr_use_visitor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fexpr_use_visitor.rs?ref=50a02b43ba17bf1547b7124dff909604e967a7f6", "patch": "@@ -458,9 +458,13 @@ impl<'d,'t,'a,'tcx> ExprUseVisitor<'d,'t,'a,'tcx> {\n                     self.consume_expr(&**input);\n                 }\n \n-                for &(_, ref output, is_rw) in &ia.outputs {\n-                    self.mutate_expr(expr, &**output,\n-                                           if is_rw { WriteAndRead } else { JustWrite });\n+                for output in &ia.outputs {\n+                    if output.is_indirect {\n+                        self.consume_expr(&*output.expr);\n+                    } else {\n+                        self.mutate_expr(expr, &*output.expr,\n+                                         if output.is_rw { WriteAndRead } else { JustWrite });\n+                    }\n                 }\n             }\n "}, {"sha": "627df102b937ad5ecdc3bacd888a76b82c2c3559", "filename": "src/librustc/middle/liveness.rs", "status": "modified", "additions": 18, "deletions": 9, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/50a02b43ba17bf1547b7124dff909604e967a7f6/src%2Flibrustc%2Fmiddle%2Fliveness.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50a02b43ba17bf1547b7124dff909604e967a7f6/src%2Flibrustc%2Fmiddle%2Fliveness.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fliveness.rs?ref=50a02b43ba17bf1547b7124dff909604e967a7f6", "patch": "@@ -1166,12 +1166,19 @@ impl<'a, 'tcx> Liveness<'a, 'tcx> {\n \n           hir::ExprInlineAsm(ref ia) => {\n \n-            let succ = ia.outputs.iter().rev().fold(succ, |succ, &(_, ref expr, _)| {\n-                // see comment on lvalues\n-                // in propagate_through_lvalue_components()\n-                let succ = self.write_lvalue(&**expr, succ, ACC_WRITE);\n-                self.propagate_through_lvalue_components(&**expr, succ)\n-            });\n+            let succ = ia.outputs.iter().rev().fold(succ,\n+                |succ, out| {\n+                    // see comment on lvalues\n+                    // in propagate_through_lvalue_components()\n+                    if out.is_indirect {\n+                        self.propagate_through_expr(&*out.expr, succ)\n+                    } else {\n+                        let acc = if out.is_rw { ACC_WRITE|ACC_READ } else { ACC_WRITE };\n+                        let succ = self.write_lvalue(&*out.expr, succ, acc);\n+                        self.propagate_through_lvalue_components(&*out.expr, succ)\n+                    }\n+                }\n+            );\n             // Inputs are executed first. Propagate last because of rev order\n             ia.inputs.iter().rev().fold(succ, |succ, &(_, ref expr)| {\n                 self.propagate_through_expr(&**expr, succ)\n@@ -1416,9 +1423,11 @@ fn check_expr(this: &mut Liveness, expr: &Expr) {\n         }\n \n         // Output operands must be lvalues\n-        for &(_, ref out, _) in &ia.outputs {\n-          this.check_lvalue(&**out);\n-          this.visit_expr(&**out);\n+        for out in &ia.outputs {\n+          if !out.is_indirect {\n+            this.check_lvalue(&*out.expr);\n+          }\n+          this.visit_expr(&*out.expr);\n         }\n \n         intravisit::walk_expr(this, expr);"}, {"sha": "88a34b27c31897ed7eefce630dee12376a035bee", "filename": "src/librustc_front/fold.rs", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/50a02b43ba17bf1547b7124dff909604e967a7f6/src%2Flibrustc_front%2Ffold.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50a02b43ba17bf1547b7124dff909604e967a7f6/src%2Flibrustc_front%2Ffold.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_front%2Ffold.rs?ref=50a02b43ba17bf1547b7124dff909604e967a7f6", "patch": "@@ -1117,7 +1117,14 @@ pub fn noop_fold_expr<T: Folder>(Expr { id, node, span, attrs }: Expr, folder: &\n                 expn_id,\n             }) => ExprInlineAsm(InlineAsm {\n                 inputs: inputs.move_map(|(c, input)| (c, folder.fold_expr(input))),\n-                outputs: outputs.move_map(|(c, out, is_rw)| (c, folder.fold_expr(out), is_rw)),\n+                outputs: outputs.move_map(|out| {\n+                    InlineAsmOutput {\n+                        constraint: out.constraint,\n+                        expr: folder.fold_expr(out.expr),\n+                        is_rw: out.is_rw,\n+                        is_indirect: out.is_indirect,\n+                    }\n+                }),\n                 asm: asm,\n                 asm_str_style: asm_str_style,\n                 clobbers: clobbers,"}, {"sha": "d1cb82dbeccbc76ca0c1f6e4ddf6e686f08ecdbf", "filename": "src/librustc_front/hir.rs", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/50a02b43ba17bf1547b7124dff909604e967a7f6/src%2Flibrustc_front%2Fhir.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50a02b43ba17bf1547b7124dff909604e967a7f6/src%2Flibrustc_front%2Fhir.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_front%2Fhir.rs?ref=50a02b43ba17bf1547b7124dff909604e967a7f6", "patch": "@@ -953,11 +953,19 @@ pub enum Ty_ {\n     TyInfer,\n }\n \n+#[derive(Clone, PartialEq, Eq, RustcEncodable, RustcDecodable, Hash, Debug)]\n+pub struct InlineAsmOutput {\n+    pub constraint: InternedString,\n+    pub expr: P<Expr>,\n+    pub is_rw: bool,\n+    pub is_indirect: bool,\n+}\n+\n #[derive(Clone, PartialEq, Eq, RustcEncodable, RustcDecodable, Hash, Debug)]\n pub struct InlineAsm {\n     pub asm: InternedString,\n     pub asm_str_style: StrStyle,\n-    pub outputs: Vec<(InternedString, P<Expr>, bool)>,\n+    pub outputs: Vec<InlineAsmOutput>,\n     pub inputs: Vec<(InternedString, P<Expr>)>,\n     pub clobbers: Vec<InternedString>,\n     pub volatile: bool,"}, {"sha": "13d7e81cc6e0126f1bb7578e79434edb05d0b930", "filename": "src/librustc_front/intravisit.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/50a02b43ba17bf1547b7124dff909604e967a7f6/src%2Flibrustc_front%2Fintravisit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50a02b43ba17bf1547b7124dff909604e967a7f6/src%2Flibrustc_front%2Fintravisit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_front%2Fintravisit.rs?ref=50a02b43ba17bf1547b7124dff909604e967a7f6", "patch": "@@ -803,8 +803,8 @@ pub fn walk_expr<'v, V: Visitor<'v>>(visitor: &mut V, expression: &'v Expr) {\n             for &(_, ref input) in &ia.inputs {\n                 visitor.visit_expr(&input)\n             }\n-            for &(_, ref output, _) in &ia.outputs {\n-                visitor.visit_expr(&output)\n+            for output in &ia.outputs {\n+                visitor.visit_expr(&output.expr)\n             }\n         }\n     }"}, {"sha": "c0b10fb89124a9ba07a173a3ff8c80548f3afb8e", "filename": "src/librustc_front/lowering.rs", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/50a02b43ba17bf1547b7124dff909604e967a7f6/src%2Flibrustc_front%2Flowering.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50a02b43ba17bf1547b7124dff909604e967a7f6/src%2Flibrustc_front%2Flowering.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_front%2Flowering.rs?ref=50a02b43ba17bf1547b7124dff909604e967a7f6", "patch": "@@ -1228,8 +1228,13 @@ pub fn lower_expr(lctx: &LoweringContext, e: &Expr) -> P<hir::Expr> {\n                               .map(|&(ref c, ref input)| (c.clone(), lower_expr(lctx, input)))\n                               .collect(),\n                 outputs: outputs.iter()\n-                                .map(|&(ref c, ref out, ref is_rw)| {\n-                                    (c.clone(), lower_expr(lctx, out), *is_rw)\n+                                .map(|out| {\n+                                    hir::InlineAsmOutput {\n+                                        constraint: out.constraint.clone(),\n+                                        expr: lower_expr(lctx, &out.expr),\n+                                        is_rw: out.is_rw,\n+                                        is_indirect: out.is_indirect,\n+                                    }\n                                 })\n                                 .collect(),\n                 asm: asm.clone(),"}, {"sha": "81076b6e4027698e033c80549efdfae96217ca6f", "filename": "src/librustc_front/print/pprust.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/50a02b43ba17bf1547b7124dff909604e967a7f6/src%2Flibrustc_front%2Fprint%2Fpprust.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50a02b43ba17bf1547b7124dff909604e967a7f6/src%2Flibrustc_front%2Fprint%2Fpprust.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_front%2Fprint%2Fpprust.rs?ref=50a02b43ba17bf1547b7124dff909604e967a7f6", "patch": "@@ -1502,15 +1502,15 @@ impl<'a> State<'a> {\n                 try!(self.print_string(&a.asm, a.asm_str_style));\n                 try!(self.word_space(\":\"));\n \n-                try!(self.commasep(Inconsistent, &a.outputs, |s, &(ref co, ref o, is_rw)| {\n-                    match co.slice_shift_char() {\n-                        Some(('=', operand)) if is_rw => {\n+                try!(self.commasep(Inconsistent, &a.outputs, |s, out| {\n+                    match out.constraint.slice_shift_char() {\n+                        Some(('=', operand)) if out.is_rw => {\n                             try!(s.print_string(&format!(\"+{}\", operand), ast::CookedStr))\n                         }\n-                        _ => try!(s.print_string(&co, ast::CookedStr)),\n+                        _ => try!(s.print_string(&out.constraint, ast::CookedStr)),\n                     }\n                     try!(s.popen());\n-                    try!(s.print_expr(&**o));\n+                    try!(s.print_expr(&*out.expr));\n                     try!(s.pclose());\n                     Ok(())\n                 }));"}, {"sha": "69a8a84229d4740c9d6f0f01d965fa88237a10f2", "filename": "src/librustc_trans/trans/asm.rs", "status": "modified", "additions": 25, "deletions": 13, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/50a02b43ba17bf1547b7124dff909604e967a7f6/src%2Flibrustc_trans%2Ftrans%2Fasm.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50a02b43ba17bf1547b7124dff909604e967a7f6/src%2Flibrustc_trans%2Ftrans%2Fasm.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Ftrans%2Fasm.rs?ref=50a02b43ba17bf1547b7124dff909604e967a7f6", "patch": "@@ -39,27 +39,39 @@ pub fn trans_inline_asm<'blk, 'tcx>(bcx: Block<'blk, 'tcx>, ia: &ast::InlineAsm)\n     let mut ext_constraints = Vec::new();\n \n     // Prepare the output operands\n-    let outputs = ia.outputs.iter().enumerate().map(|(i, &(ref c, ref out, is_rw))| {\n-        constraints.push((*c).clone());\n+    let mut outputs = Vec::new();\n+    let mut inputs = Vec::new();\n+    for (i, out) in ia.outputs.iter().enumerate() {\n+        constraints.push(out.constraint.clone());\n \n-        let out_datum = unpack_datum!(bcx, expr::trans(bcx, &**out));\n-        output_types.push(type_of::type_of(bcx.ccx(), out_datum.ty));\n-        let val = out_datum.val;\n-        if is_rw {\n+        let out_datum = unpack_datum!(bcx, expr::trans(bcx, &*out.expr));\n+        if out.is_indirect {\n             bcx = callee::trans_arg_datum(bcx,\n-                                          expr_ty(bcx, &**out),\n+                                          expr_ty(bcx, &*out.expr),\n                                           out_datum,\n                                           cleanup::CustomScope(temp_scope),\n                                           callee::DontAutorefArg,\n-                                          &mut ext_inputs);\n-            ext_constraints.push(i.to_string());\n+                                          &mut inputs);\n+            if out.is_rw {\n+                ext_inputs.push(*inputs.last().unwrap());\n+                ext_constraints.push(i.to_string());\n+            }\n+        } else {\n+            output_types.push(type_of::type_of(bcx.ccx(), out_datum.ty));\n+            outputs.push(out_datum.val);\n+            if out.is_rw {\n+                bcx = callee::trans_arg_datum(bcx,\n+                                              expr_ty(bcx, &*out.expr),\n+                                              out_datum,\n+                                              cleanup::CustomScope(temp_scope),\n+                                              callee::DontAutorefArg,\n+                                              &mut ext_inputs);\n+                ext_constraints.push(i.to_string());\n+            }\n         }\n-        val\n-\n-    }).collect::<Vec<_>>();\n+    }\n \n     // Now the input operands\n-    let mut inputs = Vec::new();\n     for &(ref c, ref input) in &ia.inputs {\n         constraints.push((*c).clone());\n "}, {"sha": "231dec276d99cdc1705384fb00b34d02b87f4e89", "filename": "src/librustc_trans/trans/debuginfo/create_scope_map.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/50a02b43ba17bf1547b7124dff909604e967a7f6/src%2Flibrustc_trans%2Ftrans%2Fdebuginfo%2Fcreate_scope_map.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50a02b43ba17bf1547b7124dff909604e967a7f6/src%2Flibrustc_trans%2Ftrans%2Fdebuginfo%2Fcreate_scope_map.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Ftrans%2Fdebuginfo%2Fcreate_scope_map.rs?ref=50a02b43ba17bf1547b7124dff909604e967a7f6", "patch": "@@ -480,8 +480,8 @@ fn walk_expr(cx: &CrateContext,\n                 walk_expr(cx, &**exp, scope_stack, scope_map);\n             }\n \n-            for &(_, ref exp, _) in outputs {\n-                walk_expr(cx, &**exp, scope_stack, scope_map);\n+            for out in outputs {\n+                walk_expr(cx, &*out.expr, scope_stack, scope_map);\n             }\n         }\n     }"}, {"sha": "f348d5411c3479135fa9ef2af1d0d2bb92126fb9", "filename": "src/librustc_typeck/check/mod.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/50a02b43ba17bf1547b7124dff909604e967a7f6/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50a02b43ba17bf1547b7124dff909604e967a7f6/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs?ref=50a02b43ba17bf1547b7124dff909604e967a7f6", "patch": "@@ -3394,8 +3394,8 @@ fn check_expr_with_unifier<'a, 'tcx, F>(fcx: &FnCtxt<'a, 'tcx>,\n           for &(_, ref input) in &ia.inputs {\n               check_expr(fcx, &**input);\n           }\n-          for &(_, ref out, _) in &ia.outputs {\n-              check_expr(fcx, &**out);\n+          for out in &ia.outputs {\n+              check_expr(fcx, &*out.expr);\n           }\n           fcx.write_nil(id);\n       }"}, {"sha": "46110a3bee9b1a5263b19d9090337eb646a1df84", "filename": "src/libsyntax/ast.rs", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/50a02b43ba17bf1547b7124dff909604e967a7f6/src%2Flibsyntax%2Fast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50a02b43ba17bf1547b7124dff909604e967a7f6/src%2Flibsyntax%2Fast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fast.rs?ref=50a02b43ba17bf1547b7124dff909604e967a7f6", "patch": "@@ -1458,11 +1458,19 @@ pub enum AsmDialect {\n     Intel,\n }\n \n+#[derive(Clone, PartialEq, Eq, RustcEncodable, RustcDecodable, Hash, Debug)]\n+pub struct InlineAsmOutput {\n+    pub constraint: InternedString,\n+    pub expr: P<Expr>,\n+    pub is_rw: bool,\n+    pub is_indirect: bool,\n+}\n+\n #[derive(Clone, PartialEq, Eq, RustcEncodable, RustcDecodable, Hash, Debug)]\n pub struct InlineAsm {\n     pub asm: InternedString,\n     pub asm_str_style: StrStyle,\n-    pub outputs: Vec<(InternedString, P<Expr>, bool)>,\n+    pub outputs: Vec<InlineAsmOutput>,\n     pub inputs: Vec<(InternedString, P<Expr>)>,\n     pub clobbers: Vec<InternedString>,\n     pub volatile: bool,"}, {"sha": "b4f29f837263fdcef85b80945e45a5d57e7ab653", "filename": "src/libsyntax/ext/asm.rs", "status": "modified", "additions": 9, "deletions": 3, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/50a02b43ba17bf1547b7124dff909604e967a7f6/src%2Flibsyntax%2Fext%2Fasm.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50a02b43ba17bf1547b7124dff909604e967a7f6/src%2Flibsyntax%2Fext%2Fasm.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fasm.rs?ref=50a02b43ba17bf1547b7124dff909604e967a7f6", "patch": "@@ -125,7 +125,13 @@ pub fn expand_asm<'cx>(cx: &'cx mut ExtCtxt, sp: Span, tts: &[ast::TokenTree])\n                     };\n \n                     let is_rw = output.is_some();\n-                    outputs.push((output.unwrap_or(constraint), out, is_rw));\n+                    let is_indirect = constraint.contains(\"*\");\n+                    outputs.push(ast::InlineAsmOutput {\n+                        constraint: output.unwrap_or(constraint),\n+                        expr: out,\n+                        is_rw: is_rw,\n+                        is_indirect: is_indirect,\n+                    });\n                 }\n             }\n             Inputs => {\n@@ -139,9 +145,9 @@ pub fn expand_asm<'cx>(cx: &'cx mut ExtCtxt, sp: Span, tts: &[ast::TokenTree])\n \n                     let (constraint, _str_style) = panictry!(p.parse_str());\n \n-                    if constraint.starts_with(\"=\") && !constraint.contains(\"*\") {\n+                    if constraint.starts_with(\"=\") {\n                         cx.span_err(p.last_span, \"input operand constraint contains '='\");\n-                    } else if constraint.starts_with(\"+\") && !constraint.contains(\"*\") {\n+                    } else if constraint.starts_with(\"+\") {\n                         cx.span_err(p.last_span, \"input operand constraint contains '+'\");\n                     }\n "}, {"sha": "c637813f07e5b1270496e086c64b750ce386f95f", "filename": "src/libsyntax/fold.rs", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/50a02b43ba17bf1547b7124dff909604e967a7f6/src%2Flibsyntax%2Ffold.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50a02b43ba17bf1547b7124dff909604e967a7f6/src%2Flibsyntax%2Ffold.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Ffold.rs?ref=50a02b43ba17bf1547b7124dff909604e967a7f6", "patch": "@@ -1303,8 +1303,13 @@ pub fn noop_fold_expr<T: Folder>(Expr {id, node, span, attrs}: Expr, folder: &mu\n                 inputs: inputs.move_map(|(c, input)| {\n                     (c, folder.fold_expr(input))\n                 }),\n-                outputs: outputs.move_map(|(c, out, is_rw)| {\n-                    (c, folder.fold_expr(out), is_rw)\n+                outputs: outputs.move_map(|out| {\n+                    InlineAsmOutput {\n+                        constraint: out.constraint,\n+                        expr: folder.fold_expr(out.expr),\n+                        is_rw: out.is_rw,\n+                        is_indirect: out.is_indirect,\n+                    }\n                 }),\n                 asm: asm,\n                 asm_str_style: asm_str_style,"}, {"sha": "475bacbc886425f8310740669a3e40e934861290", "filename": "src/libsyntax/print/pprust.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/50a02b43ba17bf1547b7124dff909604e967a7f6/src%2Flibsyntax%2Fprint%2Fpprust.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50a02b43ba17bf1547b7124dff909604e967a7f6/src%2Flibsyntax%2Fprint%2Fpprust.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fprint%2Fpprust.rs?ref=50a02b43ba17bf1547b7124dff909604e967a7f6", "patch": "@@ -2219,16 +2219,16 @@ impl<'a> State<'a> {\n                 try!(self.word_space(\":\"));\n \n                 try!(self.commasep(Inconsistent, &a.outputs,\n-                                   |s, &(ref co, ref o, is_rw)| {\n-                    match co.slice_shift_char() {\n-                        Some(('=', operand)) if is_rw => {\n+                                   |s, out| {\n+                    match out.constraint.slice_shift_char() {\n+                        Some(('=', operand)) if out.is_rw => {\n                             try!(s.print_string(&format!(\"+{}\", operand),\n                                                 ast::CookedStr))\n                         }\n-                        _ => try!(s.print_string(&co, ast::CookedStr))\n+                        _ => try!(s.print_string(&out.constraint, ast::CookedStr))\n                     }\n                     try!(s.popen());\n-                    try!(s.print_expr(&**o));\n+                    try!(s.print_expr(&*out.expr));\n                     try!(s.pclose());\n                     Ok(())\n                 }));"}, {"sha": "22bf135f4f9779750e136ac6c5e6b8a2d96ad66e", "filename": "src/libsyntax/visit.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/50a02b43ba17bf1547b7124dff909604e967a7f6/src%2Flibsyntax%2Fvisit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50a02b43ba17bf1547b7124dff909604e967a7f6/src%2Flibsyntax%2Fvisit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fvisit.rs?ref=50a02b43ba17bf1547b7124dff909604e967a7f6", "patch": "@@ -786,8 +786,8 @@ pub fn walk_expr<'v, V: Visitor<'v>>(visitor: &mut V, expression: &'v Expr) {\n             for &(_, ref input) in &ia.inputs {\n                 visitor.visit_expr(&input)\n             }\n-            for &(_, ref output, _) in &ia.outputs {\n-                visitor.visit_expr(&output)\n+            for output in &ia.outputs {\n+                visitor.visit_expr(&output.expr)\n             }\n         }\n     }"}, {"sha": "d1873afb3a9b76fb842d40e61cfcd204d742cfc9", "filename": "src/test/run-pass/asm-indirect-memory.rs", "status": "modified", "additions": 14, "deletions": 2, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/50a02b43ba17bf1547b7124dff909604e967a7f6/src%2Ftest%2Frun-pass%2Fasm-indirect-memory.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50a02b43ba17bf1547b7124dff909604e967a7f6/src%2Ftest%2Frun-pass%2Fasm-indirect-memory.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fasm-indirect-memory.rs?ref=50a02b43ba17bf1547b7124dff909604e967a7f6", "patch": "@@ -22,17 +22,29 @@ fn read(ptr: &u32) -> u32 {\n #[cfg(any(target_arch = \"x86\", target_arch = \"x86_64\"))]\n fn write(ptr: &mut u32, val: u32) {\n     unsafe {\n-        asm!(\"mov $1, $0\" :: \"=*m\" (ptr), \"r\" (val));\n+        asm!(\"mov $1, $0\" : \"=*m\" (ptr) : \"r\" (val));\n     }\n }\n \n+#[cfg(any(target_arch = \"x86\", target_arch = \"x86_64\"))]\n+fn replace(ptr: &mut u32, val: u32) -> u32 {\n+    let out: u32;\n+    unsafe {\n+        asm!(\"mov $0, $1; mov $2, $0\" : \"+*m\" (ptr), \"=&r\" (out) : \"r\" (val));\n+    }\n+    out\n+}\n+\n #[cfg(any(target_arch = \"x86\", target_arch = \"x86_64\"))]\n pub fn main() {\n     let a = 1;\n-    let mut b = 2;\n     assert_eq!(read(&a), 1);\n+    let mut b = 2;\n     write(&mut b, 3);\n     assert_eq!(b, 3);\n+    let mut c = 4;\n+    assert_eq!(replace(&mut c, 5), 4);\n+    assert_eq!(c, 5);\n }\n \n #[cfg(not(any(target_arch = \"x86\", target_arch = \"x86_64\")))]"}]}