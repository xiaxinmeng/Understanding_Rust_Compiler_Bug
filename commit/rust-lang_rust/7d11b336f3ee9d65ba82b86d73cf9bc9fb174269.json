{"sha": "7d11b336f3ee9d65ba82b86d73cf9bc9fb174269", "node_id": "C_kwDOAAsO6NoAKDdkMTFiMzM2ZjNlZTlkNjViYTgyYjg2ZDczY2Y5YmM5ZmIxNzQyNjk", "commit": {"author": {"name": "Eric Holk", "email": "ericholk@microsoft.com", "date": "2021-12-16T23:46:56Z"}, "committer": {"name": "Eric Holk", "email": "ericholk@microsoft.com", "date": "2022-01-18T22:25:29Z"}, "message": "Remove clones and most allocations from propagate_to_fixpoint", "tree": {"sha": "57cd1c3c99f7cf318d57897ee8bb8bee9899457c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/57cd1c3c99f7cf318d57897ee8bb8bee9899457c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7d11b336f3ee9d65ba82b86d73cf9bc9fb174269", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7d11b336f3ee9d65ba82b86d73cf9bc9fb174269", "html_url": "https://github.com/rust-lang/rust/commit/7d11b336f3ee9d65ba82b86d73cf9bc9fb174269", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7d11b336f3ee9d65ba82b86d73cf9bc9fb174269/comments", "author": {"login": "eholk", "id": 105766, "node_id": "MDQ6VXNlcjEwNTc2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/105766?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eholk", "html_url": "https://github.com/eholk", "followers_url": "https://api.github.com/users/eholk/followers", "following_url": "https://api.github.com/users/eholk/following{/other_user}", "gists_url": "https://api.github.com/users/eholk/gists{/gist_id}", "starred_url": "https://api.github.com/users/eholk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eholk/subscriptions", "organizations_url": "https://api.github.com/users/eholk/orgs", "repos_url": "https://api.github.com/users/eholk/repos", "events_url": "https://api.github.com/users/eholk/events{/privacy}", "received_events_url": "https://api.github.com/users/eholk/received_events", "type": "User", "site_admin": false}, "committer": {"login": "eholk", "id": 105766, "node_id": "MDQ6VXNlcjEwNTc2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/105766?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eholk", "html_url": "https://github.com/eholk", "followers_url": "https://api.github.com/users/eholk/followers", "following_url": "https://api.github.com/users/eholk/following{/other_user}", "gists_url": "https://api.github.com/users/eholk/gists{/gist_id}", "starred_url": "https://api.github.com/users/eholk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eholk/subscriptions", "organizations_url": "https://api.github.com/users/eholk/orgs", "repos_url": "https://api.github.com/users/eholk/repos", "events_url": "https://api.github.com/users/eholk/events{/privacy}", "received_events_url": "https://api.github.com/users/eholk/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a7df4e8d2f89379fb0b620cb0267f97c05bc1598", "url": "https://api.github.com/repos/rust-lang/rust/commits/a7df4e8d2f89379fb0b620cb0267f97c05bc1598", "html_url": "https://github.com/rust-lang/rust/commit/a7df4e8d2f89379fb0b620cb0267f97c05bc1598"}], "stats": {"total": 12, "additions": 6, "deletions": 6}, "files": [{"sha": "a540812f4a3296df3c72f414371a647016d089e2", "filename": "compiler/rustc_typeck/src/check/generator_interior/drop_ranges/cfg_propagate.rs", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/7d11b336f3ee9d65ba82b86d73cf9bc9fb174269/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fgenerator_interior%2Fdrop_ranges%2Fcfg_propagate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7d11b336f3ee9d65ba82b86d73cf9bc9fb174269/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fgenerator_interior%2Fdrop_ranges%2Fcfg_propagate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fgenerator_interior%2Fdrop_ranges%2Fcfg_propagate.rs?ref=7d11b336f3ee9d65ba82b86d73cf9bc9fb174269", "patch": "@@ -9,16 +9,17 @@ impl DropRangesBuilder {\n \n         trace!(\"predecessors: {:#?}\", preds.iter_enumerated().collect::<BTreeMap<_, _>>());\n \n+        let mut new_state = BitSet::new_empty(self.num_values());\n+\n         let mut propagate = || {\n             let mut changed = false;\n             for id in self.nodes.indices() {\n-                let old_state = self.nodes[id].drop_state.clone();\n-                let mut new_state = if id.index() == 0 {\n-                    BitSet::new_empty(self.num_values())\n+                if id.index() == 0 {\n+                    new_state.clear();\n                 } else {\n                     // If we are not the start node and we have no predecessors, treat\n                     // everything as dropped because there's no way to get here anyway.\n-                    BitSet::new_filled(self.num_values())\n+                    new_state.insert_all();\n                 };\n \n                 for pred in &preds[id] {\n@@ -34,8 +35,7 @@ impl DropRangesBuilder {\n                     new_state.remove(*reinit);\n                 }\n \n-                changed |= old_state != new_state;\n-                self.nodes[id].drop_state = new_state;\n+                changed |= self.nodes[id].drop_state.intersect(&new_state);\n             }\n \n             changed"}]}