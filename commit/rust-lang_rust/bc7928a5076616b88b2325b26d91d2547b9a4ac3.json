{"sha": "bc7928a5076616b88b2325b26d91d2547b9a4ac3", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJjNzkyOGE1MDc2NjE2Yjg4YjIzMjViMjZkOTFkMjU0N2I5YTRhYzM=", "commit": {"author": {"name": "Dylan MacKenzie", "email": "ecstaticmorse@gmail.com", "date": "2019-09-24T04:33:58Z"}, "committer": {"name": "Dylan MacKenzie", "email": "ecstaticmorse@gmail.com", "date": "2019-09-28T14:06:52Z"}, "message": "Trigger ICE on nightly if validators disagree\n\nAlso adds an unstable flag to disable the ICE\n(`-Zsuppress-const-validation-back-compat-ice`) so that nightly users do\nnot have to revert to a previous nightly if their code causes\ndisagreement between the validators.", "tree": {"sha": "64bf5cf45bb890d796608ccda870ef25967bce72", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/64bf5cf45bb890d796608ccda870ef25967bce72"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bc7928a5076616b88b2325b26d91d2547b9a4ac3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bc7928a5076616b88b2325b26d91d2547b9a4ac3", "html_url": "https://github.com/rust-lang/rust/commit/bc7928a5076616b88b2325b26d91d2547b9a4ac3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bc7928a5076616b88b2325b26d91d2547b9a4ac3/comments", "author": {"login": "ecstatic-morse", "id": 29463364, "node_id": "MDQ6VXNlcjI5NDYzMzY0", "avatar_url": "https://avatars.githubusercontent.com/u/29463364?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ecstatic-morse", "html_url": "https://github.com/ecstatic-morse", "followers_url": "https://api.github.com/users/ecstatic-morse/followers", "following_url": "https://api.github.com/users/ecstatic-morse/following{/other_user}", "gists_url": "https://api.github.com/users/ecstatic-morse/gists{/gist_id}", "starred_url": "https://api.github.com/users/ecstatic-morse/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ecstatic-morse/subscriptions", "organizations_url": "https://api.github.com/users/ecstatic-morse/orgs", "repos_url": "https://api.github.com/users/ecstatic-morse/repos", "events_url": "https://api.github.com/users/ecstatic-morse/events{/privacy}", "received_events_url": "https://api.github.com/users/ecstatic-morse/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ecstatic-morse", "id": 29463364, "node_id": "MDQ6VXNlcjI5NDYzMzY0", "avatar_url": "https://avatars.githubusercontent.com/u/29463364?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ecstatic-morse", "html_url": "https://github.com/ecstatic-morse", "followers_url": "https://api.github.com/users/ecstatic-morse/followers", "following_url": "https://api.github.com/users/ecstatic-morse/following{/other_user}", "gists_url": "https://api.github.com/users/ecstatic-morse/gists{/gist_id}", "starred_url": "https://api.github.com/users/ecstatic-morse/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ecstatic-morse/subscriptions", "organizations_url": "https://api.github.com/users/ecstatic-morse/orgs", "repos_url": "https://api.github.com/users/ecstatic-morse/repos", "events_url": "https://api.github.com/users/ecstatic-morse/events{/privacy}", "received_events_url": "https://api.github.com/users/ecstatic-morse/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "93ee7791b60937b3dd163509c5ed631e1698e99b", "url": "https://api.github.com/repos/rust-lang/rust/commits/93ee7791b60937b3dd163509c5ed631e1698e99b", "html_url": "https://github.com/rust-lang/rust/commit/93ee7791b60937b3dd163509c5ed631e1698e99b"}], "stats": {"total": 23, "additions": 21, "deletions": 2}, "files": [{"sha": "7c97fd11af2a534eb0b0d48cf3e8e6f185d3bbdb", "filename": "src/librustc/session/config.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/bc7928a5076616b88b2325b26d91d2547b9a4ac3/src%2Flibrustc%2Fsession%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bc7928a5076616b88b2325b26d91d2547b9a4ac3/src%2Flibrustc%2Fsession%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fsession%2Fconfig.rs?ref=bc7928a5076616b88b2325b26d91d2547b9a4ac3", "patch": "@@ -1359,6 +1359,8 @@ options! {DebuggingOptions, DebuggingSetter, basic_debugging_options,\n         \"describes how to render the `rendered` field of json diagnostics\"),\n     unleash_the_miri_inside_of_you: bool = (false, parse_bool, [TRACKED],\n         \"take the breaks off const evaluation. NOTE: this is unsound\"),\n+    suppress_const_validation_back_compat_ice: bool = (false, parse_bool, [TRACKED],\n+        \"silence ICE triggered when the new const validator disagrees with the old\"),\n     osx_rpath_install_name: bool = (false, parse_bool, [TRACKED],\n         \"pass `-install_name @rpath/...` to the macOS linker\"),\n     sanitizer: Option<Sanitizer> = (None, parse_sanitizer, [TRACKED],"}, {"sha": "fef918b3298e0766f2ded081e6295d40d809a899", "filename": "src/librustc_mir/transform/qualify_consts.rs", "status": "modified", "additions": 19, "deletions": 2, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/bc7928a5076616b88b2325b26d91d2547b9a4ac3/src%2Flibrustc_mir%2Ftransform%2Fqualify_consts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bc7928a5076616b88b2325b26d91d2547b9a4ac3/src%2Flibrustc_mir%2Ftransform%2Fqualify_consts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fqualify_consts.rs?ref=bc7928a5076616b88b2325b26d91d2547b9a4ac3", "patch": "@@ -1022,11 +1022,24 @@ impl<'a, 'tcx> Checker<'a, 'tcx> {\n             self.errors.dedup();\n             new_errors.dedup();\n \n-            // FIXME: Downgrade this to a warning.\n             if self.errors != new_errors {\n                 error!(\"old validator: {:?}\", self.errors);\n                 error!(\"new validator: {:?}\", new_errors);\n-                panic!(\"disagreement between validators.\");\n+\n+                // ICE on nightly if the validators do not emit exactly the same errors.\n+                // Users can supress this panic with an unstable compiler flag (hopefully after\n+                // filing an issue).\n+                let opts = &self.tcx.sess.opts;\n+                let trigger_ice = opts.unstable_features.is_nightly_build()\n+                    && !opts.debugging_opts.suppress_const_validation_back_compat_ice;\n+\n+                if trigger_ice {\n+                    span_bug!(\n+                        body.span,\n+                        \"{}\",\n+                        VALIDATOR_MISMATCH_ERR,\n+                    );\n+                }\n             }\n         }\n \n@@ -1850,3 +1863,7 @@ fn args_required_const(tcx: TyCtxt<'_>, def_id: DefId) -> Option<FxHashSet<usize\n     }\n     Some(ret)\n }\n+\n+const VALIDATOR_MISMATCH_ERR: &str =\n+    r\"Disagreement between legacy and dataflow-based const validators.\n+    After filing an issue, use `-Zsuppress-const-validation-back-compat-ice` to compile your code.\";"}]}