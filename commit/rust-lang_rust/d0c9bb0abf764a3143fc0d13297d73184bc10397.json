{"sha": "d0c9bb0abf764a3143fc0d13297d73184bc10397", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQwYzliYjBhYmY3NjRhMzE0M2ZjMGQxMzI5N2Q3MzE4NGJjMTAzOTc=", "commit": {"author": {"name": "Florian Diebold", "email": "flodiebold@gmail.com", "date": "2019-12-08T10:23:05Z"}, "committer": {"name": "Florian Diebold", "email": "flodiebold@gmail.com", "date": "2019-12-08T12:06:59Z"}, "message": "Fix coercion from &Foo to an inference variable in a reference\n\nWe didn't try to unify within the reference, but we should.", "tree": {"sha": "34e392bae6422cec8d8ef8ab975fbb48db4b808d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/34e392bae6422cec8d8ef8ab975fbb48db4b808d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d0c9bb0abf764a3143fc0d13297d73184bc10397", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d0c9bb0abf764a3143fc0d13297d73184bc10397", "html_url": "https://github.com/rust-lang/rust/commit/d0c9bb0abf764a3143fc0d13297d73184bc10397", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d0c9bb0abf764a3143fc0d13297d73184bc10397/comments", "author": {"login": "flodiebold", "id": 906069, "node_id": "MDQ6VXNlcjkwNjA2OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/906069?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flodiebold", "html_url": "https://github.com/flodiebold", "followers_url": "https://api.github.com/users/flodiebold/followers", "following_url": "https://api.github.com/users/flodiebold/following{/other_user}", "gists_url": "https://api.github.com/users/flodiebold/gists{/gist_id}", "starred_url": "https://api.github.com/users/flodiebold/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flodiebold/subscriptions", "organizations_url": "https://api.github.com/users/flodiebold/orgs", "repos_url": "https://api.github.com/users/flodiebold/repos", "events_url": "https://api.github.com/users/flodiebold/events{/privacy}", "received_events_url": "https://api.github.com/users/flodiebold/received_events", "type": "User", "site_admin": false}, "committer": {"login": "flodiebold", "id": 906069, "node_id": "MDQ6VXNlcjkwNjA2OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/906069?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flodiebold", "html_url": "https://github.com/flodiebold", "followers_url": "https://api.github.com/users/flodiebold/followers", "following_url": "https://api.github.com/users/flodiebold/following{/other_user}", "gists_url": "https://api.github.com/users/flodiebold/gists{/gist_id}", "starred_url": "https://api.github.com/users/flodiebold/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flodiebold/subscriptions", "organizations_url": "https://api.github.com/users/flodiebold/orgs", "repos_url": "https://api.github.com/users/flodiebold/repos", "events_url": "https://api.github.com/users/flodiebold/events{/privacy}", "received_events_url": "https://api.github.com/users/flodiebold/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "596e6db46c9c79b2b2be20a4b5461dca35d44b0f", "url": "https://api.github.com/repos/rust-lang/rust/commits/596e6db46c9c79b2b2be20a4b5461dca35d44b0f", "html_url": "https://github.com/rust-lang/rust/commit/596e6db46c9c79b2b2be20a4b5461dca35d44b0f"}], "stats": {"total": 43, "additions": 42, "deletions": 1}, "files": [{"sha": "0f4dac45edf2b454117bc9ed96af9e133815205e", "filename": "crates/ra_hir_ty/src/infer/coerce.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/d0c9bb0abf764a3143fc0d13297d73184bc10397/crates%2Fra_hir_ty%2Fsrc%2Finfer%2Fcoerce.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d0c9bb0abf764a3143fc0d13297d73184bc10397/crates%2Fra_hir_ty%2Fsrc%2Finfer%2Fcoerce.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_ty%2Fsrc%2Finfer%2Fcoerce.rs?ref=d0c9bb0abf764a3143fc0d13297d73184bc10397", "patch": "@@ -332,7 +332,11 @@ impl<'a, D: HirDatabase> InferenceContext<'a, D> {\n                     // It will not recurse to `coerce`.\n                     return self.table.unify_substs(st1, st2, 0);\n                 }\n-                _ => {}\n+                _ => {\n+                    if self.table.unify_inner_trivial(&derefed_ty, &to_ty) {\n+                        return true;\n+                    }\n+                }\n             }\n         }\n "}, {"sha": "ac9e3872a5bdcc672e9481b800dca2c06093cf7c", "filename": "crates/ra_hir_ty/src/tests/coercion.rs", "status": "modified", "additions": 37, "deletions": 0, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/d0c9bb0abf764a3143fc0d13297d73184bc10397/crates%2Fra_hir_ty%2Fsrc%2Ftests%2Fcoercion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d0c9bb0abf764a3143fc0d13297d73184bc10397/crates%2Fra_hir_ty%2Fsrc%2Ftests%2Fcoercion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_ty%2Fsrc%2Ftests%2Fcoercion.rs?ref=d0c9bb0abf764a3143fc0d13297d73184bc10397", "patch": "@@ -403,3 +403,40 @@ fn test() {\n     \"###\n     );\n }\n+\n+#[test]\n+fn coerce_autoderef_generic() {\n+    assert_snapshot!(\n+        infer_with_mismatches(r#\"\n+struct Foo;\n+fn takes_ref<T>(x: &T) -> T { *x }\n+fn test() {\n+    takes_ref(&Foo);\n+    takes_ref(&&Foo);\n+    takes_ref(&&&Foo);\n+}\n+\"#, true),\n+        @r###\"\n+    [29; 30) 'x': &T\n+    [41; 47) '{ *x }': T\n+    [43; 45) '*x': T\n+    [44; 45) 'x': &T\n+    [58; 127) '{     ...oo); }': ()\n+    [64; 73) 'takes_ref': fn takes_ref<Foo>(&T) -> T\n+    [64; 79) 'takes_ref(&Foo)': Foo\n+    [74; 78) '&Foo': &Foo\n+    [75; 78) 'Foo': Foo\n+    [85; 94) 'takes_ref': fn takes_ref<&Foo>(&T) -> T\n+    [85; 101) 'takes_...&&Foo)': &Foo\n+    [95; 100) '&&Foo': &&Foo\n+    [96; 100) '&Foo': &Foo\n+    [97; 100) 'Foo': Foo\n+    [107; 116) 'takes_ref': fn takes_ref<&&Foo>(&T) -> T\n+    [107; 124) 'takes_...&&Foo)': &&Foo\n+    [117; 123) '&&&Foo': &&&Foo\n+    [118; 123) '&&Foo': &&Foo\n+    [119; 123) '&Foo': &Foo\n+    [120; 123) 'Foo': Foo\n+    \"###\n+    );\n+}"}]}