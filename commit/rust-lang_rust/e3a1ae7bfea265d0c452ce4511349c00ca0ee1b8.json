{"sha": "e3a1ae7bfea265d0c452ce4511349c00ca0ee1b8", "node_id": "MDY6Q29tbWl0NzI0NzEyOmUzYTFhZTdiZmVhMjY1ZDBjNDUyY2U0NTExMzQ5YzAwY2EwZWUxYjg=", "commit": {"author": {"name": "xFrednet", "email": "xFrednet@gmail.com", "date": "2021-05-20T20:29:09Z"}, "committer": {"name": "xFrednet", "email": "xFrednet@gmail.com", "date": "2021-05-20T20:30:49Z"}, "message": "Adding the ability to invalidate caches to force metadata collection", "tree": {"sha": "f10b4dd96bcf8923801036fee65d68067af15da9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f10b4dd96bcf8923801036fee65d68067af15da9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e3a1ae7bfea265d0c452ce4511349c00ca0ee1b8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e3a1ae7bfea265d0c452ce4511349c00ca0ee1b8", "html_url": "https://github.com/rust-lang/rust/commit/e3a1ae7bfea265d0c452ce4511349c00ca0ee1b8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e3a1ae7bfea265d0c452ce4511349c00ca0ee1b8/comments", "author": {"login": "xFrednet", "id": 17087237, "node_id": "MDQ6VXNlcjE3MDg3MjM3", "avatar_url": "https://avatars.githubusercontent.com/u/17087237?v=4", "gravatar_id": "", "url": "https://api.github.com/users/xFrednet", "html_url": "https://github.com/xFrednet", "followers_url": "https://api.github.com/users/xFrednet/followers", "following_url": "https://api.github.com/users/xFrednet/following{/other_user}", "gists_url": "https://api.github.com/users/xFrednet/gists{/gist_id}", "starred_url": "https://api.github.com/users/xFrednet/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/xFrednet/subscriptions", "organizations_url": "https://api.github.com/users/xFrednet/orgs", "repos_url": "https://api.github.com/users/xFrednet/repos", "events_url": "https://api.github.com/users/xFrednet/events{/privacy}", "received_events_url": "https://api.github.com/users/xFrednet/received_events", "type": "User", "site_admin": false}, "committer": {"login": "xFrednet", "id": 17087237, "node_id": "MDQ6VXNlcjE3MDg3MjM3", "avatar_url": "https://avatars.githubusercontent.com/u/17087237?v=4", "gravatar_id": "", "url": "https://api.github.com/users/xFrednet", "html_url": "https://github.com/xFrednet", "followers_url": "https://api.github.com/users/xFrednet/followers", "following_url": "https://api.github.com/users/xFrednet/following{/other_user}", "gists_url": "https://api.github.com/users/xFrednet/gists{/gist_id}", "starred_url": "https://api.github.com/users/xFrednet/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/xFrednet/subscriptions", "organizations_url": "https://api.github.com/users/xFrednet/orgs", "repos_url": "https://api.github.com/users/xFrednet/repos", "events_url": "https://api.github.com/users/xFrednet/events{/privacy}", "received_events_url": "https://api.github.com/users/xFrednet/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "60826e77c3753e2d9d4b37228d2395dc7c171baf", "url": "https://api.github.com/repos/rust-lang/rust/commits/60826e77c3753e2d9d4b37228d2395dc7c171baf", "html_url": "https://github.com/rust-lang/rust/commit/60826e77c3753e2d9d4b37228d2395dc7c171baf"}], "stats": {"total": 33, "additions": 33, "deletions": 0}, "files": [{"sha": "458c28c2748393013c14ad089e9c4bad602c1fb2", "filename": "Cargo.toml", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e3a1ae7bfea265d0c452ce4511349c00ca0ee1b8/Cargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/e3a1ae7bfea265d0c452ce4511349c00ca0ee1b8/Cargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.toml?ref=e3a1ae7bfea265d0c452ce4511349c00ca0ee1b8", "patch": "@@ -39,6 +39,8 @@ derive-new = \"0.5\"\n regex = \"1.4\"\n quote = \"1\"\n syn = { version = \"1\", features = [\"full\"] }\n+# This is used by the `collect-metadata` alias.\n+filetime = \"0.2\"\n \n # A noop dependency that changes in the Rust repository, it's a bit of a hack.\n # See the `src/tools/rustc-workspace-hack/README.md` file in `rust-lang/rust`"}, {"sha": "7de130c7dbefa6e3b7f3a0d7300289f1d7cc62b3", "filename": "tests/dogfood.rs", "status": "modified", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/e3a1ae7bfea265d0c452ce4511349c00ca0ee1b8/tests%2Fdogfood.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e3a1ae7bfea265d0c452ce4511349c00ca0ee1b8/tests%2Fdogfood.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fdogfood.rs?ref=e3a1ae7bfea265d0c452ce4511349c00ca0ee1b8", "patch": "@@ -179,8 +179,39 @@ fn dogfood_subprojects() {\n #[ignore]\n #[cfg(feature = \"metadata-collector-lint\")]\n fn run_metadata_collection_lint() {\n+    use std::fs::File;\n+    use std::time::SystemTime;\n+\n+    // Setup for validation\n+    let metadata_output_path = PathBuf::from(env!(\"CARGO_MANIFEST_DIR\")).join(\"util/gh-pages/metadata_collection.json\");\n+    let start_time = SystemTime::now();\n+\n+    // Run collection as is\n     std::env::set_var(\"ENABLE_METADATA_COLLECTION\", \"1\");\n     run_clippy_for_project(\"clippy_lints\");\n+\n+    // Check if cargo caching got in the way\n+    if let Ok(file) = File::open(metadata_output_path) {\n+        if let Ok(metadata) = file.metadata() {\n+            if let Ok(last_modification) = metadata.modified() {\n+                if last_modification > start_time {\n+                    // The output file has been modified. Most likely by a hungry\n+                    // metadata collection monster. So We'll return.\n+                    return;\n+                }\n+            }\n+        }\n+    }\n+\n+    // Force cargo to invalidate the caches\n+    filetime::set_file_mtime(\n+        PathBuf::from(env!(\"CARGO_MANIFEST_DIR\")).join(\"clippy_lints/src/lib.rs\"),\n+        filetime::FileTime::now(),\n+    )\n+    .unwrap();\n+\n+    // Running the collection again\n+    run_clippy_for_project(\"clippy_lints\");\n }\n \n fn run_clippy_for_project(project: &str) {"}]}