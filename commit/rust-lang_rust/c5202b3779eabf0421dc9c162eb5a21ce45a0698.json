{"sha": "c5202b3779eabf0421dc9c162eb5a21ce45a0698", "node_id": "MDY6Q29tbWl0NzI0NzEyOmM1MjAyYjM3NzllYWJmMDQyMWRjOWMxNjJlYjVhMjFjZTQ1YTA2OTg=", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2021-08-06T16:46:35Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-08-06T16:46:35Z"}, "message": "Rollup merge of #87787 - hyd-dev:c-unwind, r=RalfJung\n\nUse `C-unwind` ABI for `__rust_start_panic` in `panic_abort`\n\nThe function originally has `C` ABI but is called using `C-unwind` ABI in `std`:\nhttps://github.com/rust-lang/rust/blob/d4ad1cfc63ba5824196bfb2370451ddb5af2e020/library/std/src/panicking.rs#L49-L54\nWhich might be [problematic](https://github.com/rust-lang/miri/pull/1745#discussion_r596096876) and triggers this [Miri error](https://github.com/rust-lang/rust/issues/87778#issuecomment-893306222):\n```\nerror: Undefined Behavior: calling a function with ABI C using caller ABI C-unwind\n   --> /home/hyd-dev/.rustup/toolchains/miri/lib/rustlib/src/rust/library/std/src/panicking.rs:672:9\n    |\n672 |         __rust_start_panic(obj)\n    |         ^^^^^^^^^^^^^^^^^^^^^^^ calling a function with ABI C using caller ABI C-unwind\n    |\n    = help: this indicates a bug in the program: it performed an invalid operation, and caused Undefined Behavior\n    = help: see https://doc.rust-lang.org/nightly/reference/behavior-considered-undefined.html for further information\n```\nChanging the ABI of the function to `C-unwind` fixes the error above.", "tree": {"sha": "a4cbcc14386d994f48a319c1f9f99c133e39ed95", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a4cbcc14386d994f48a319c1f9f99c133e39ed95"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c5202b3779eabf0421dc9c162eb5a21ce45a0698", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhDWdrCRBK7hj4Ov3rIwAApA4IAGUhucFD+52w2RGRsaol7hRj\nRzxpMDytoHu/Gku268oH4wT5MbqGAUpLwcyb7gvKLoL/sbQz+zGdUvVAPRxiPKpC\n6ZhL+23rS67jEgt1gqGxQEqjPGv0myGzU15uIAziE61Y7f8od8q9oY/KIwIMlEXL\nUjWKAqQkV+rkQhSHxohjLrOZzuT8UY5tfFq6Ly0SljuLhHDndxMDs3/IdoJSxNUn\nvlKbRK2xvmn+98yuoXkG6VuNBztps2SEE4WkAAbgU2ogXzZ4CQKv3wW/6JkxRBG8\nlusBiVBcbwMi6+DcymfIhQM12MUSQgkqZtkLuZtD9MvxqAUnrBKLryM6ubRuzuM=\n=qeg7\n-----END PGP SIGNATURE-----\n", "payload": "tree a4cbcc14386d994f48a319c1f9f99c133e39ed95\nparent a4262cc9841d91d48ef994b36eab323e615a7083\nparent 7520ea9046de23d04829db40687a7fdde5034530\nauthor Yuki Okushi <jtitor@2k36.org> 1628268395 +0900\ncommitter GitHub <noreply@github.com> 1628268395 +0900\n\nRollup merge of #87787 - hyd-dev:c-unwind, r=RalfJung\n\nUse `C-unwind` ABI for `__rust_start_panic` in `panic_abort`\n\nThe function originally has `C` ABI but is called using `C-unwind` ABI in `std`:\nhttps://github.com/rust-lang/rust/blob/d4ad1cfc63ba5824196bfb2370451ddb5af2e020/library/std/src/panicking.rs#L49-L54\nWhich might be [problematic](https://github.com/rust-lang/miri/pull/1745#discussion_r596096876) and triggers this [Miri error](https://github.com/rust-lang/rust/issues/87778#issuecomment-893306222):\n```\nerror: Undefined Behavior: calling a function with ABI C using caller ABI C-unwind\n   --> /home/hyd-dev/.rustup/toolchains/miri/lib/rustlib/src/rust/library/std/src/panicking.rs:672:9\n    |\n672 |         __rust_start_panic(obj)\n    |         ^^^^^^^^^^^^^^^^^^^^^^^ calling a function with ABI C using caller ABI C-unwind\n    |\n    = help: this indicates a bug in the program: it performed an invalid operation, and caused Undefined Behavior\n    = help: see https://doc.rust-lang.org/nightly/reference/behavior-considered-undefined.html for further information\n```\nChanging the ABI of the function to `C-unwind` fixes the error above.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c5202b3779eabf0421dc9c162eb5a21ce45a0698", "html_url": "https://github.com/rust-lang/rust/commit/c5202b3779eabf0421dc9c162eb5a21ce45a0698", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c5202b3779eabf0421dc9c162eb5a21ce45a0698/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a4262cc9841d91d48ef994b36eab323e615a7083", "url": "https://api.github.com/repos/rust-lang/rust/commits/a4262cc9841d91d48ef994b36eab323e615a7083", "html_url": "https://github.com/rust-lang/rust/commit/a4262cc9841d91d48ef994b36eab323e615a7083"}, {"sha": "7520ea9046de23d04829db40687a7fdde5034530", "url": "https://api.github.com/repos/rust-lang/rust/commits/7520ea9046de23d04829db40687a7fdde5034530", "html_url": "https://github.com/rust-lang/rust/commit/7520ea9046de23d04829db40687a7fdde5034530"}], "stats": {"total": 3, "additions": 2, "deletions": 1}, "files": [{"sha": "4580f9a7758f33351da3a1ca24706121c13982e1", "filename": "library/panic_abort/src/lib.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/c5202b3779eabf0421dc9c162eb5a21ce45a0698/library%2Fpanic_abort%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c5202b3779eabf0421dc9c162eb5a21ce45a0698/library%2Fpanic_abort%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fpanic_abort%2Fsrc%2Flib.rs?ref=c5202b3779eabf0421dc9c162eb5a21ce45a0698", "patch": "@@ -15,6 +15,7 @@\n #![feature(staged_api)]\n #![feature(rustc_attrs)]\n #![feature(asm)]\n+#![feature(c_unwind)]\n \n #[cfg(target_os = \"android\")]\n mod android;\n@@ -30,7 +31,7 @@ pub unsafe extern \"C\" fn __rust_panic_cleanup(_: *mut u8) -> *mut (dyn Any + Sen\n \n // \"Leak\" the payload and shim to the relevant abort on the platform in question.\n #[rustc_std_internal_symbol]\n-pub unsafe extern \"C\" fn __rust_start_panic(_payload: *mut &mut dyn BoxMeUp) -> u32 {\n+pub unsafe extern \"C-unwind\" fn __rust_start_panic(_payload: *mut &mut dyn BoxMeUp) -> u32 {\n     // Android has the ability to attach a message as part of the abort.\n     #[cfg(target_os = \"android\")]\n     android::android_set_abort_message(_payload);"}]}