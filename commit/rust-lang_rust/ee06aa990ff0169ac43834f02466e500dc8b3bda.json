{"sha": "ee06aa990ff0169ac43834f02466e500dc8b3bda", "node_id": "MDY6Q29tbWl0NzI0NzEyOmVlMDZhYTk5MGZmMDE2OWFjNDM4MzRmMDI0NjZlNTAwZGM4YjNiZGE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-01-18T16:58:30Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-01-18T16:58:30Z"}, "message": "Auto merge of #5063 - JohnTitor:allow-correctly, r=flip1995\n\nAllow `unused_self` lint at the function level\n\nAnother approach of #5062.\nFixes #5053\n\nchangelog: Allow `unused_self` lint at the function level", "tree": {"sha": "742a3c6ba2ffef6fd682896ebdc7ed6f3ba3adea", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/742a3c6ba2ffef6fd682896ebdc7ed6f3ba3adea"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ee06aa990ff0169ac43834f02466e500dc8b3bda", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ee06aa990ff0169ac43834f02466e500dc8b3bda", "html_url": "https://github.com/rust-lang/rust/commit/ee06aa990ff0169ac43834f02466e500dc8b3bda", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ee06aa990ff0169ac43834f02466e500dc8b3bda/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7ae24429ab6f04e34c6a3d46e5148f416f682398", "url": "https://api.github.com/repos/rust-lang/rust/commits/7ae24429ab6f04e34c6a3d46e5148f416f682398", "html_url": "https://github.com/rust-lang/rust/commit/7ae24429ab6f04e34c6a3d46e5148f416f682398"}, {"sha": "ff0a22d99ff9dfbaa849db2cd9d23a77fa2b97a1", "url": "https://api.github.com/repos/rust-lang/rust/commits/ff0a22d99ff9dfbaa849db2cd9d23a77fa2b97a1", "html_url": "https://github.com/rust-lang/rust/commit/ff0a22d99ff9dfbaa849db2cd9d23a77fa2b97a1"}], "stats": {"total": 33, "additions": 27, "deletions": 6}, "files": [{"sha": "247da580f45143f25a98b4f1ee527f69b0e56fa1", "filename": "clippy_lints/src/unused_self.rs", "status": "modified", "additions": 9, "deletions": 6, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/ee06aa990ff0169ac43834f02466e500dc8b3bda/clippy_lints%2Fsrc%2Funused_self.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee06aa990ff0169ac43834f02466e500dc8b3bda/clippy_lints%2Fsrc%2Funused_self.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Funused_self.rs?ref=ee06aa990ff0169ac43834f02466e500dc8b3bda", "patch": "@@ -2,7 +2,7 @@ use if_chain::if_chain;\n use rustc::hir::map::Map;\n use rustc_hir::def::Res;\n use rustc_hir::intravisit::{walk_path, NestedVisitorMap, Visitor};\n-use rustc_hir::{AssocItemKind, HirId, ImplItemKind, ImplItemRef, Item, ItemKind, Path};\n+use rustc_hir::{AssocItemKind, HirId, ImplItem, ImplItemKind, ImplItemRef, ItemKind, Path};\n use rustc_lint::{LateContext, LateLintPass};\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n \n@@ -40,10 +40,12 @@ declare_clippy_lint! {\n declare_lint_pass!(UnusedSelf => [UNUSED_SELF]);\n \n impl<'a, 'tcx> LateLintPass<'a, 'tcx> for UnusedSelf {\n-    fn check_item(&mut self, cx: &LateContext<'a, 'tcx>, item: &Item<'_>) {\n-        if item.span.from_expansion() {\n+    fn check_impl_item(&mut self, cx: &LateContext<'a, 'tcx>, impl_item: &ImplItem<'_>) {\n+        if impl_item.span.from_expansion() {\n             return;\n         }\n+        let parent = cx.tcx.hir().get_parent_item(impl_item.hir_id);\n+        let item = cx.tcx.hir().expect_item(parent);\n         if let ItemKind::Impl {\n             of_trait: None,\n             items: impl_item_refs,\n@@ -56,10 +58,10 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for UnusedSelf {\n                         kind: AssocItemKind::Method { has_self: true },\n                         ..\n                     } = impl_item_ref;\n-                    let impl_item = cx.tcx.hir().impl_item(impl_item_ref.id);\n                     if let ImplItemKind::Method(_, body_id) = &impl_item.kind;\n+                    let body = cx.tcx.hir().body(*body_id);\n+                    if !body.params.is_empty();\n                     then {\n-                        let body = cx.tcx.hir().body(*body_id);\n                         let self_param = &body.params[0];\n                         let self_hir_id = self_param.pat.hir_id;\n                         let mut visitor = UnusedSelfVisitor {\n@@ -75,7 +77,8 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for UnusedSelf {\n                                 self_param.span,\n                                 \"unused `self` argument\",\n                                 \"consider refactoring to a associated function\",\n-                            )\n+                            );\n+                            return;\n                         }\n                     }\n                 }"}, {"sha": "711c1cd9d6c09b2609dad90735df1f044f97654b", "filename": "tests/ui/unused_self.rs", "status": "modified", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/ee06aa990ff0169ac43834f02466e500dc8b3bda/tests%2Fui%2Funused_self.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee06aa990ff0169ac43834f02466e500dc8b3bda/tests%2Fui%2Funused_self.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Funused_self.rs?ref=ee06aa990ff0169ac43834f02466e500dc8b3bda", "patch": "@@ -26,6 +26,24 @@ mod unused_self {\n     }\n }\n \n+mod unused_self_allow {\n+    struct A {}\n+\n+    impl A {\n+        // shouldn't trigger\n+        #[allow(clippy::unused_self)]\n+        fn unused_self_move(self) {}\n+    }\n+\n+    struct B {}\n+\n+    // shouldn't trigger\n+    #[allow(clippy::unused_self)]\n+    impl B {\n+        fn unused_self_move(self) {}\n+    }\n+}\n+\n mod used_self {\n     use std::pin::Pin;\n "}]}