{"sha": "ce1020fc55d901838477ed5626c332c48ca16fd4", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNlMTAyMGZjNTVkOTAxODM4NDc3ZWQ1NjI2YzMzMmM0OGNhMTZmZDQ=", "commit": {"author": {"name": "Mara Bos", "email": "m-ou.se@m-ou.se", "date": "2021-02-05T11:26:00Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-02-05T11:26:00Z"}, "message": "Rollup merge of #81542 - RReverser:wasi-symlink, r=alexcrichton\n\nExpose correct symlink API on WASI\n\nAs described in https://github.com/rust-lang/rust/issues/68574, the currently exposed API for symlinks is, in fact, a thin wrapper around the corresponding syscall, and not suitable for public usage.\n\nThe reason is that the 2nd param in the call is expected to be a handle of a \"preopened directory\" (a WASI concept for exposing dirs), and the only way to retrieve such handle right now is by tinkering with a private `__wasilibc_find_relpath` API, which is an implementation detail and definitely not something we want users to call directly.\n\nMaking matters worse, the semantics of this param aren't obvious from its name (`fd`), and easy to misinterpret, resulting in people trying to pass a handle of the target file itself (as in https://github.com/vitiral/path_abs/pull/50), which doesn't work as expected.\n\nI did a [codesearch among open-source repos](https://sourcegraph.com/search?q=std%3A%3Aos%3A%3Awasi%3A%3Afs%3A%3Asymlink&patternType=literal), and the usage above is so far the only usage of this API at all, but we should fix it before more people start using it incorrectly.\n\nWhile this is technically a breaking API change, I believe it's a justified one, as 1) it's OS-specific and 2) there was strictly no way to correctly use the previous form of the API, and if someone does use it, they're likely doing it wrong like in the example above.\n\nThe new API does not lead to the same confusion, as it mirrors `std::os::unix::fs::symlink` and `std::os::windows::fs::symlink_{file,dir}` variants by accepting source/target paths.\n\nFixes #68574.\n\nr? ``@alexcrichton``", "tree": {"sha": "d773fed5e2e5b15d6f4567ca1a7e338aa6adb6a2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d773fed5e2e5b15d6f4567ca1a7e338aa6adb6a2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ce1020fc55d901838477ed5626c332c48ca16fd4", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgHStJCRBK7hj4Ov3rIwAAdHIIAGdOK8kqDXGqnEbOWBYFiilX\nFLfbWRUQFcV70U2hL6ie3rwjWpcSOL5x58WBotokNj6R2jPuGa5mOjm/tidS661Q\nndkiEuPuSufUBHlSH5CM2l81ZOzxjNcbL2Zcka2hF4NQQklPxmP15yzRctCDec4C\ntNDBgQTLIQud1yC/kti0jRaahTikHUbmFW3Z1y6Hvg88ctEx8/4zgIUTdYxThS7p\nrMj4/AyoysIBPovsMxV+JZw+9oWY4Ek0aMbKjJR/APBLCC2grygdzssT/4SGIg5o\nCL5RvDEIjsl9MICrbIgABTKvSb0jVMv3WlgoDqQ5ToE613WQhiXA87oACiy3hCM=\n=/8Ug\n-----END PGP SIGNATURE-----\n", "payload": "tree d773fed5e2e5b15d6f4567ca1a7e338aa6adb6a2\nparent e98e42b881227113979092fb48a3096a115d2217\nparent f4b1bef542b209ba92187b06d19f84374e51a746\nauthor Mara Bos <m-ou.se@m-ou.se> 1612524360 +0100\ncommitter GitHub <noreply@github.com> 1612524360 +0100\n\nRollup merge of #81542 - RReverser:wasi-symlink, r=alexcrichton\n\nExpose correct symlink API on WASI\n\nAs described in https://github.com/rust-lang/rust/issues/68574, the currently exposed API for symlinks is, in fact, a thin wrapper around the corresponding syscall, and not suitable for public usage.\n\nThe reason is that the 2nd param in the call is expected to be a handle of a \"preopened directory\" (a WASI concept for exposing dirs), and the only way to retrieve such handle right now is by tinkering with a private `__wasilibc_find_relpath` API, which is an implementation detail and definitely not something we want users to call directly.\n\nMaking matters worse, the semantics of this param aren't obvious from its name (`fd`), and easy to misinterpret, resulting in people trying to pass a handle of the target file itself (as in https://github.com/vitiral/path_abs/pull/50), which doesn't work as expected.\n\nI did a [codesearch among open-source repos](https://sourcegraph.com/search?q=std%3A%3Aos%3A%3Awasi%3A%3Afs%3A%3Asymlink&patternType=literal), and the usage above is so far the only usage of this API at all, but we should fix it before more people start using it incorrectly.\n\nWhile this is technically a breaking API change, I believe it's a justified one, as 1) it's OS-specific and 2) there was strictly no way to correctly use the previous form of the API, and if someone does use it, they're likely doing it wrong like in the example above.\n\nThe new API does not lead to the same confusion, as it mirrors `std::os::unix::fs::symlink` and `std::os::windows::fs::symlink_{file,dir}` variants by accepting source/target paths.\n\nFixes #68574.\n\nr? ``@alexcrichton``\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ce1020fc55d901838477ed5626c332c48ca16fd4", "html_url": "https://github.com/rust-lang/rust/commit/ce1020fc55d901838477ed5626c332c48ca16fd4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ce1020fc55d901838477ed5626c332c48ca16fd4/comments", "author": {"login": "m-ou-se", "id": 783247, "node_id": "MDQ6VXNlcjc4MzI0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/783247?v=4", "gravatar_id": "", "url": "https://api.github.com/users/m-ou-se", "html_url": "https://github.com/m-ou-se", "followers_url": "https://api.github.com/users/m-ou-se/followers", "following_url": "https://api.github.com/users/m-ou-se/following{/other_user}", "gists_url": "https://api.github.com/users/m-ou-se/gists{/gist_id}", "starred_url": "https://api.github.com/users/m-ou-se/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/m-ou-se/subscriptions", "organizations_url": "https://api.github.com/users/m-ou-se/orgs", "repos_url": "https://api.github.com/users/m-ou-se/repos", "events_url": "https://api.github.com/users/m-ou-se/events{/privacy}", "received_events_url": "https://api.github.com/users/m-ou-se/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e98e42b881227113979092fb48a3096a115d2217", "url": "https://api.github.com/repos/rust-lang/rust/commits/e98e42b881227113979092fb48a3096a115d2217", "html_url": "https://github.com/rust-lang/rust/commit/e98e42b881227113979092fb48a3096a115d2217"}, {"sha": "f4b1bef542b209ba92187b06d19f84374e51a746", "url": "https://api.github.com/repos/rust-lang/rust/commits/f4b1bef542b209ba92187b06d19f84374e51a746", "html_url": "https://github.com/rust-lang/rust/commit/f4b1bef542b209ba92187b06d19f84374e51a746"}], "stats": {"total": 8, "additions": 8, "deletions": 0}, "files": [{"sha": "a8da003d550acb04510c3aadc7e257fc9be60550", "filename": "library/std/src/sys/wasi/ext/fs.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ce1020fc55d901838477ed5626c332c48ca16fd4/library%2Fstd%2Fsrc%2Fsys%2Fwasi%2Fext%2Ffs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ce1020fc55d901838477ed5626c332c48ca16fd4/library%2Fstd%2Fsrc%2Fsys%2Fwasi%2Fext%2Ffs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Fwasi%2Fext%2Ffs.rs?ref=ce1020fc55d901838477ed5626c332c48ca16fd4", "patch": "@@ -514,3 +514,11 @@ pub fn symlink<P: AsRef<Path>, U: AsRef<Path>>(\n         .fd()\n         .symlink(osstr2str(old_path.as_ref().as_ref())?, osstr2str(new_path.as_ref().as_ref())?)\n }\n+\n+/// Create a symbolic link.\n+///\n+/// This is a convenience API similar to [`std::os::unix::fs::symlink`] and\n+/// [`std::os::windows::fs::symlink_file`] and [`symlink_dir`](std::os::windows::fs::symlink_dir).\n+pub fn symlink_path<P: AsRef<Path>, U: AsRef<Path>>(old_path: P, new_path: U) -> io::Result<()> {\n+    crate::sys::fs::symlink(old_path.as_ref(), new_path.as_ref())\n+}"}]}