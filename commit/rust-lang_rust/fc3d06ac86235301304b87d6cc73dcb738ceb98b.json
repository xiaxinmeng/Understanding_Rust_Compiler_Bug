{"sha": "fc3d06ac86235301304b87d6cc73dcb738ceb98b", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZjM2QwNmFjODYyMzUzMDEzMDRiODdkNmNjNzNkY2I3MzhjZWI5OGI=", "commit": {"author": {"name": "Mark Simulacrum", "email": "mark.simulacrum@gmail.com", "date": "2017-07-14T15:28:06Z"}, "committer": {"name": "Mark Simulacrum", "email": "mark.simulacrum@gmail.com", "date": "2017-07-20T17:24:36Z"}, "message": "Implement keep-stage support", "tree": {"sha": "d325a658a7f6142a3073df19228d128b837c1375", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d325a658a7f6142a3073df19228d128b837c1375"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fc3d06ac86235301304b87d6cc73dcb738ceb98b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fc3d06ac86235301304b87d6cc73dcb738ceb98b", "html_url": "https://github.com/rust-lang/rust/commit/fc3d06ac86235301304b87d6cc73dcb738ceb98b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fc3d06ac86235301304b87d6cc73dcb738ceb98b/comments", "author": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "681b12316c16911dc95eb9923de5486b142c745a", "url": "https://api.github.com/repos/rust-lang/rust/commits/681b12316c16911dc95eb9923de5486b142c745a", "html_url": "https://github.com/rust-lang/rust/commit/681b12316c16911dc95eb9923de5486b142c745a"}], "stats": {"total": 14, "additions": 13, "deletions": 1}, "files": [{"sha": "722bbda13a44c8c7577f6c22fc6cb7d9d78fbf59", "filename": "src/bootstrap/compile.rs", "status": "modified", "additions": 13, "deletions": 1, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/fc3d06ac86235301304b87d6cc73dcb738ceb98b/src%2Fbootstrap%2Fcompile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fc3d06ac86235301304b87d6cc73dcb738ceb98b/src%2Fbootstrap%2Fcompile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcompile.rs?ref=fc3d06ac86235301304b87d6cc73dcb738ceb98b", "patch": "@@ -23,6 +23,7 @@ use std::io::prelude::*;\n use std::path::{Path, PathBuf};\n use std::process::{Command, Stdio};\n use std::str;\n+use std::cmp::min;\n \n use build_helper::{output, mtime, up_to_date};\n use filetime::FileTime;\n@@ -846,7 +847,18 @@ impl Step for Assemble {\n         // link to these. (FIXME: Is that correct? It seems to be correct most\n         // of the time but I think we do link to these for stage2/bin compilers\n         // when not performing a full bootstrap).\n-        builder.ensure(Rustc { compiler: build_compiler, target: target_compiler.host });\n+        if builder.build.flags.keep_stage.map_or(false, |s| target_compiler.stage <= s) {\n+            builder.verbose(\"skipping compilation of compiler due to --keep-stage\");\n+            let compiler = build_compiler;\n+            for stage in 0..min(target_compiler.stage, builder.flags.keep_stage.unwrap()) {\n+                let target_compiler = builder.compiler(stage, target_compiler.host);\n+                builder.ensure(StdLink { compiler, target_compiler, target: target_compiler.host });\n+                builder.ensure(TestLink { compiler, target_compiler, target: target_compiler.host });\n+                builder.ensure(RustcLink { compiler, target_compiler, target: target_compiler.host });\n+            }\n+        } else {\n+            builder.ensure(Rustc { compiler: build_compiler, target: target_compiler.host });\n+        }\n \n         let stage = target_compiler.stage;\n         let host = target_compiler.host;"}]}