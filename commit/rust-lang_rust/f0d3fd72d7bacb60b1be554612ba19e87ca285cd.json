{"sha": "f0d3fd72d7bacb60b1be554612ba19e87ca285cd", "node_id": "MDY6Q29tbWl0NzI0NzEyOmYwZDNmZDcyZDdiYWNiNjBiMWJlNTU0NjEyYmExOWU4N2NhMjg1Y2Q=", "commit": {"author": {"name": "daxpedda", "email": "daxpedda@gmail.com", "date": "2021-02-03T18:19:30Z"}, "committer": {"name": "daxpedda", "email": "daxpedda@gmail.com", "date": "2021-02-06T16:39:18Z"}, "message": "Implement `_cargo_ignore_publish`.", "tree": {"sha": "9118157b8edd11bb6458c69edc40e870352acbfb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9118157b8edd11bb6458c69edc40e870352acbfb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f0d3fd72d7bacb60b1be554612ba19e87ca285cd", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEE3qx/rJh59vdc2+v9Q9YqPqOI5G8FAmAexjYACgkQQ9YqPqOI\n5G9JDw/+NwsdSIpTVfXdT3DAOvdEfr1nDjgK5td/WV49unF5aKZXfHccpt0fzWZb\ngccsRGFXPf5eTIdN0n6CY3dYL7qPbfcWe2L01+iOes5jhCfEbofaJE6OhGgdCisA\nSvFI4JjhUkW1B1yqFWAEF5Kj/sO04VZw0GEFzE5lAlSOmaS8huUfCav95CX7tj1k\nVPyO/gYBZfxk6cBeyHkFfKpvH6eFfjlYeEhtqH/0KiUEYbBM7pRVLdWLHvlhwYU+\n3H13nB/YUG+Yg4os1RTO1xFiRJQNL6KwIiMSDfpVngQ7YKaGwbeUYlwjrkBsJJf3\nMySW/VHQApzNmqmf1qByCc4Abrpo7TnO/NDdZgRrv787Hd1TpHkjya/eed5wtNqM\ndqbdZQdUCnMR4Q2l3GJWVHopLqQyFv0HwscoJpaMjzJGVsn598xLe9c8e5VVucKe\ndOi3qdFRDWUESAY+cvQkobfaNUBfIAcTXgvOOoafui/JH+5c4Cn5SCkx6BKuAXmi\nTDUMlX7LnRPMmurFk4bAMrG/gUUtLbi151XsQoSv07BjVjxEQaoWEsnKJTsdInxQ\n5118dwv9mP2ODl0QFFAf4towN1LjupSgPFxJOj2yMkyp7I5Gn3KzPtS0byP9HNpJ\nvf1P65ueDANkWe9W5HcfbkkA2ANH4PD+EIqMtxFCGP3M+YjEK0U=\n=5+/2\n-----END PGP SIGNATURE-----", "payload": "tree 9118157b8edd11bb6458c69edc40e870352acbfb\nparent d4bc7d2c06dcfaf87fc88dd4e1fbc9ad8d289462\nauthor daxpedda <daxpedda@gmail.com> 1612376370 +0100\ncommitter daxpedda <daxpedda@gmail.com> 1612629558 +0100\n\nImplement `_cargo_ignore_publish`.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f0d3fd72d7bacb60b1be554612ba19e87ca285cd", "html_url": "https://github.com/rust-lang/rust/commit/f0d3fd72d7bacb60b1be554612ba19e87ca285cd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f0d3fd72d7bacb60b1be554612ba19e87ca285cd/comments", "author": {"login": "daxpedda", "id": 1645124, "node_id": "MDQ6VXNlcjE2NDUxMjQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1645124?v=4", "gravatar_id": "", "url": "https://api.github.com/users/daxpedda", "html_url": "https://github.com/daxpedda", "followers_url": "https://api.github.com/users/daxpedda/followers", "following_url": "https://api.github.com/users/daxpedda/following{/other_user}", "gists_url": "https://api.github.com/users/daxpedda/gists{/gist_id}", "starred_url": "https://api.github.com/users/daxpedda/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/daxpedda/subscriptions", "organizations_url": "https://api.github.com/users/daxpedda/orgs", "repos_url": "https://api.github.com/users/daxpedda/repos", "events_url": "https://api.github.com/users/daxpedda/events{/privacy}", "received_events_url": "https://api.github.com/users/daxpedda/received_events", "type": "User", "site_admin": false}, "committer": {"login": "daxpedda", "id": 1645124, "node_id": "MDQ6VXNlcjE2NDUxMjQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1645124?v=4", "gravatar_id": "", "url": "https://api.github.com/users/daxpedda", "html_url": "https://github.com/daxpedda", "followers_url": "https://api.github.com/users/daxpedda/followers", "following_url": "https://api.github.com/users/daxpedda/following{/other_user}", "gists_url": "https://api.github.com/users/daxpedda/gists{/gist_id}", "starred_url": "https://api.github.com/users/daxpedda/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/daxpedda/subscriptions", "organizations_url": "https://api.github.com/users/daxpedda/orgs", "repos_url": "https://api.github.com/users/daxpedda/repos", "events_url": "https://api.github.com/users/daxpedda/events{/privacy}", "received_events_url": "https://api.github.com/users/daxpedda/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d4bc7d2c06dcfaf87fc88dd4e1fbc9ad8d289462", "url": "https://api.github.com/repos/rust-lang/rust/commits/d4bc7d2c06dcfaf87fc88dd4e1fbc9ad8d289462", "html_url": "https://github.com/rust-lang/rust/commit/d4bc7d2c06dcfaf87fc88dd4e1fbc9ad8d289462"}], "stats": {"total": 28, "additions": 23, "deletions": 5}, "files": [{"sha": "f499345636c8b3436e4f8b44afa4bf45cf409581", "filename": "clippy_lints/src/cargo_common_metadata.rs", "status": "modified", "additions": 17, "deletions": 4, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/f0d3fd72d7bacb60b1be554612ba19e87ca285cd/clippy_lints%2Fsrc%2Fcargo_common_metadata.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f0d3fd72d7bacb60b1be554612ba19e87ca285cd/clippy_lints%2Fsrc%2Fcargo_common_metadata.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fcargo_common_metadata.rs?ref=f0d3fd72d7bacb60b1be554612ba19e87ca285cd", "patch": "@@ -5,7 +5,7 @@ use std::path::PathBuf;\n use crate::utils::{run_lints, span_lint};\n use rustc_hir::{hir_id::CRATE_HIR_ID, Crate};\n use rustc_lint::{LateContext, LateLintPass};\n-use rustc_session::{declare_lint_pass, declare_tool_lint};\n+use rustc_session::{declare_tool_lint, impl_lint_pass};\n use rustc_span::source_map::DUMMY_SP;\n \n declare_clippy_lint! {\n@@ -51,6 +51,21 @@ declare_clippy_lint! {\n     \"common metadata is defined in `Cargo.toml`\"\n }\n \n+#[derive(Copy, Clone, Debug)]\n+pub struct CargoCommonMetadata {\n+    ignore_publish: bool,\n+}\n+\n+impl CargoCommonMetadata {\n+    pub fn new(ignore_publish: bool) -> Self {\n+        Self { ignore_publish }\n+    }\n+}\n+\n+impl_lint_pass!(CargoCommonMetadata => [\n+    CARGO_COMMON_METADATA\n+]);\n+\n fn missing_warning(cx: &LateContext<'_>, package: &cargo_metadata::Package, field: &str) {\n     let message = format!(\"package `{}` is missing `{}` metadata\", package.name, field);\n     span_lint(cx, CARGO_COMMON_METADATA, DUMMY_SP, &message);\n@@ -69,8 +84,6 @@ fn is_empty_vec(value: &[String]) -> bool {\n     value.iter().all(String::is_empty)\n }\n \n-declare_lint_pass!(CargoCommonMetadata => [CARGO_COMMON_METADATA]);\n-\n impl LateLintPass<'_> for CargoCommonMetadata {\n     fn check_crate(&mut self, cx: &LateContext<'_>, _: &Crate<'_>) {\n         if !run_lints(cx, &[CARGO_COMMON_METADATA], CRATE_HIR_ID) {\n@@ -80,7 +93,7 @@ impl LateLintPass<'_> for CargoCommonMetadata {\n         let metadata = unwrap_cargo_metadata!(cx, CARGO_COMMON_METADATA, false);\n \n         for package in metadata.packages {\n-            if package.publish.as_ref().filter(|publish| publish.is_empty()).is_none() {\n+            if package.publish.as_ref().filter(|publish| publish.is_empty()).is_none() || self.ignore_publish {\n                 if is_empty_vec(&package.authors) {\n                     missing_warning(cx, &package, \"package.authors\");\n                 }"}, {"sha": "e8e8229915bc569091884c2c2d8dc0205ed04e80", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/f0d3fd72d7bacb60b1be554612ba19e87ca285cd/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f0d3fd72d7bacb60b1be554612ba19e87ca285cd/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=f0d3fd72d7bacb60b1be554612ba19e87ca285cd", "patch": "@@ -1180,7 +1180,8 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n     store.register_early_pass(|| box redundant_else::RedundantElse);\n     store.register_late_pass(|| box create_dir::CreateDir);\n     store.register_early_pass(|| box needless_arbitrary_self_type::NeedlessArbitrarySelfType);\n-    store.register_late_pass(|| box cargo_common_metadata::CargoCommonMetadata);\n+    let cargo_ignore_publish = conf._cargo_ignore_publish;\n+    store.register_late_pass(move || box cargo_common_metadata::CargoCommonMetadata::new(cargo_ignore_publish));\n     store.register_late_pass(|| box multiple_crate_versions::MultipleCrateVersions);\n     store.register_late_pass(|| box wildcard_dependencies::WildcardDependencies);\n     let literal_representation_lint_fraction_readability = conf.unreadable_literal_lint_fractions;"}, {"sha": "0b0d31c8603652735eece6de866424ab7813d4f5", "filename": "clippy_lints/src/utils/conf.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f0d3fd72d7bacb60b1be554612ba19e87ca285cd/clippy_lints%2Fsrc%2Futils%2Fconf.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f0d3fd72d7bacb60b1be554612ba19e87ca285cd/clippy_lints%2Fsrc%2Futils%2Fconf.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Futils%2Fconf.rs?ref=f0d3fd72d7bacb60b1be554612ba19e87ca285cd", "patch": "@@ -173,6 +173,8 @@ define_Conf! {\n     (disallowed_methods, \"disallowed_methods\": Vec<String>, Vec::<String>::new()),\n     /// Lint: UNREADABLE_LITERAL. Should the fraction of a decimal be linted to include separators.\n     (unreadable_literal_lint_fractions, \"unreadable_literal_lint_fractions\": bool, true),\n+    /// Lint: CARGO_COMMON_METADATA. For internal testing only, ignores the current `publish` settings in the Cargo manifest.\n+    (_cargo_ignore_publish, \"_cargo_ignore_publish\": bool, false),\n }\n \n impl Default for Conf {"}, {"sha": "737e84e963c9512d85d69acd1171854fb3dc1257", "filename": "tests/ui-cargo/cargo_common_metadata/pass/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/f0d3fd72d7bacb60b1be554612ba19e87ca285cd/tests%2Fui-cargo%2Fcargo_common_metadata%2Fpass%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/f0d3fd72d7bacb60b1be554612ba19e87ca285cd/tests%2Fui-cargo%2Fcargo_common_metadata%2Fpass%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-cargo%2Fcargo_common_metadata%2Fpass%2FCargo.toml?ref=f0d3fd72d7bacb60b1be554612ba19e87ca285cd", "patch": "@@ -1,6 +1,7 @@\n [package]\n name = \"cargo_common_metadata\"\n version = \"0.1.0\"\n+publish = false\n authors = [\"Random person from the Internet <someone@someplace.org>\"]\n description = \"A test package for the cargo_common_metadata lint\"\n repository = \"https://github.com/someone/cargo_common_metadata\""}, {"sha": "866c4f3c35e8a805c3d88f2199f10b2bab8a22eb", "filename": "tests/ui-cargo/cargo_common_metadata/pass/clippy.toml", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/f0d3fd72d7bacb60b1be554612ba19e87ca285cd/tests%2Fui-cargo%2Fcargo_common_metadata%2Fpass%2Fclippy.toml", "raw_url": "https://github.com/rust-lang/rust/raw/f0d3fd72d7bacb60b1be554612ba19e87ca285cd/tests%2Fui-cargo%2Fcargo_common_metadata%2Fpass%2Fclippy.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-cargo%2Fcargo_common_metadata%2Fpass%2Fclippy.toml?ref=f0d3fd72d7bacb60b1be554612ba19e87ca285cd", "patch": "@@ -0,0 +1 @@\n+_cargo_ignore_publish = true"}]}