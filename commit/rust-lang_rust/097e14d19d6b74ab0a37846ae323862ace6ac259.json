{"sha": "097e14d19d6b74ab0a37846ae323862ace6ac259", "node_id": "MDY6Q29tbWl0NzI0NzEyOjA5N2UxNGQxOWQ2Yjc0YWIwYTM3ODQ2YWUzMjM4NjJhY2U2YWMyNTk=", "commit": {"author": {"name": "Oliver Scherer", "email": "github35764891676564198441@oli-obk.de", "date": "2019-12-26T13:50:40Z"}, "committer": {"name": "Oliver Scherer", "email": "github35764891676564198441@oli-obk.de", "date": "2019-12-26T13:50:40Z"}, "message": "Treat extern statics just like statics in the \"const pointer to static\" representation", "tree": {"sha": "8f0e0e45a5fa0a9c83c46d44659a12153e6f17a9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8f0e0e45a5fa0a9c83c46d44659a12153e6f17a9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/097e14d19d6b74ab0a37846ae323862ace6ac259", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/097e14d19d6b74ab0a37846ae323862ace6ac259", "html_url": "https://github.com/rust-lang/rust/commit/097e14d19d6b74ab0a37846ae323862ace6ac259", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/097e14d19d6b74ab0a37846ae323862ace6ac259/comments", "author": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "committer": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c0b16b4e6aa94cd83fd2c029356ba537dc4502c6", "url": "https://api.github.com/repos/rust-lang/rust/commits/c0b16b4e6aa94cd83fd2c029356ba537dc4502c6", "html_url": "https://github.com/rust-lang/rust/commit/c0b16b4e6aa94cd83fd2c029356ba537dc4502c6"}], "stats": {"total": 73, "additions": 71, "deletions": 2}, "files": [{"sha": "bbc635366230370f53b4b715802e480ed658d547", "filename": "src/librustc/ty/util.rs", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/097e14d19d6b74ab0a37846ae323862ace6ac259/src%2Flibrustc%2Fty%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/097e14d19d6b74ab0a37846ae323862ace6ac259/src%2Flibrustc%2Fty%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Futil.rs?ref=097e14d19d6b74ab0a37846ae323862ace6ac259", "patch": "@@ -665,8 +665,6 @@ impl<'tcx> TyCtxt<'tcx> {\n \n         if self.is_mutable_static(def_id) {\n             self.mk_mut_ptr(static_ty)\n-        } else if self.is_foreign_item(def_id) {\n-            self.mk_imm_ptr(static_ty)\n         } else {\n             self.mk_imm_ref(self.lifetimes.re_erased, static_ty)\n         }"}, {"sha": "d611ec22c38ec09f4452663a47c16c88af7b91d6", "filename": "src/test/mir-opt/const-promotion-extern-static.rs", "status": "added", "additions": 71, "deletions": 0, "changes": 71, "blob_url": "https://github.com/rust-lang/rust/blob/097e14d19d6b74ab0a37846ae323862ace6ac259/src%2Ftest%2Fmir-opt%2Fconst-promotion-extern-static.rs", "raw_url": "https://github.com/rust-lang/rust/raw/097e14d19d6b74ab0a37846ae323862ace6ac259/src%2Ftest%2Fmir-opt%2Fconst-promotion-extern-static.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fconst-promotion-extern-static.rs?ref=097e14d19d6b74ab0a37846ae323862ace6ac259", "patch": "@@ -0,0 +1,71 @@\n+extern \"C\" {\n+    static X: i32;\n+}\n+\n+static Y: i32 = 42;\n+\n+static mut BAR: *const &'static i32 = [&Y].as_ptr();\n+\n+static mut FOO: *const &'static i32 = [unsafe { &X }].as_ptr();\n+\n+fn main() {}\n+\n+// END RUST SOURCE\n+// START rustc.FOO.PromoteTemps.before.mir\n+// bb0: {\n+// ...\n+//     _5 = const Scalar(AllocId(1).0x0) : &i32;\n+//     _4 = &(*_5);\n+//     _3 = [move _4];\n+//     _2 = &_3;\n+//     _1 = move _2 as &[&'static i32] (Pointer(Unsize));\n+//     _0 = const core::slice::<impl [&'static i32]>::as_ptr(move _1) -> [return: bb2, unwind: bb1];\n+// }\n+// ...\n+// bb2: {\n+//     StorageDead(_5);\n+//     StorageDead(_3);\n+//     return;\n+// }\n+// END rustc.FOO.PromoteTemps.before.mir\n+// START rustc.BAR.PromoteTemps.before.mir\n+// bb0: {\n+// ...\n+//     _5 = const Scalar(AllocId(0).0x0) : &i32;\n+//     _4 = &(*_5);\n+//     _3 = [move _4];\n+//     _2 = &_3;\n+//     _1 = move _2 as &[&'static i32] (Pointer(Unsize));\n+//     _0 = const core::slice::<impl [&'static i32]>::as_ptr(move _1) -> [return: bb2, unwind: bb1];\n+// }\n+// ...\n+// bb2: {\n+//     StorageDead(_5);\n+//     StorageDead(_3);\n+//     return;\n+// }\n+// END rustc.BAR.PromoteTemps.before.mir\n+// START rustc.BAR.PromoteTemps.after.mir\n+// bb0: {\n+// ...\n+//     _2 = &(promoted[0]: [&'static i32; 1]);\n+//     _1 = move _2 as &[&'static i32] (Pointer(Unsize));\n+//     _0 = const core::slice::<impl [&'static i32]>::as_ptr(move _1) -> [return: bb2, unwind: bb1];\n+// }\n+// ...\n+// bb2: {\n+//     return;\n+// }\n+// END rustc.BAR.PromoteTemps.after.mir\n+// START rustc.FOO.PromoteTemps.after.mir\n+// bb0: {\n+// ...\n+//     _2 = &(promoted[0]: [&'static i32; 1]);\n+//     _1 = move _2 as &[&'static i32] (Pointer(Unsize));\n+//     _0 = const core::slice::<impl [&'static i32]>::as_ptr(move _1) -> [return: bb2, unwind: bb1];\n+// }\n+// ...\n+// bb2: {\n+//     return;\n+// }\n+// END rustc.FOO.PromoteTemps.after.mir"}]}