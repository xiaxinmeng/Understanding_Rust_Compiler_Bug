{"sha": "44a527a27a7fdeb14a208ca195a62b58df4b960d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQ0YTUyN2EyN2E3ZmRlYjE0YTIwOGNhMTk1YTYyYjU4ZGY0Yjk2MGQ=", "commit": {"author": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-10-12T14:04:03Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2018-10-12T14:04:03Z"}, "message": "Rollup merge of #54825 - davidtwco:issue-52663-deref-raw-pointer, r=pnkfelix\n\nNLL says \"borrowed content\" instead of more precise \"dereference of raw pointer\"\n\nPart of #52663.\n\nPreviously, move errors involving the dereference of a raw pointer would\nsay \"borrowed content\". This commit changes it to say \"dereference of\nraw pointer\".\n\nr? @nikomatsakis\ncc @pnkfelix", "tree": {"sha": "124da401c287532d60bb4e61be282ad93706c81e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/124da401c287532d60bb4e61be282ad93706c81e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/44a527a27a7fdeb14a208ca195a62b58df4b960d", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJbwKnTCRBK7hj4Ov3rIwAAdHIIAKPAQso/KUEeaLbHtuKPMCZT\n2zLwI1p3JXL+aja9ntYClOc9BezRGG/geyr6rsoXEPEidzN4tmgQSRRwQ1Y+ui4L\nW7uRoalr+CWkm4kCuCWYpMEKaJkSSWEb1cFoJ5kgizNobHR4RStVQNdpm64q/guv\n64ovPQLESfdemEx80XJ9Orbr4oYlXsMOqTyyKGZe9qtL4ofAdp4yJvEbBj4jT5h1\nterO5bhE3WsuNDYSAFlSx6H45KIwuPXQgsWbWgoxT7GVRi+kbmlobfA1q5+IkYt7\ntQ+aeFWIt9s+XvBe+mq926LU49wuvwzHqW/FByAeI76/iv9pa/66semFPyhjN6w=\n=P6Nk\n-----END PGP SIGNATURE-----\n", "payload": "tree 124da401c287532d60bb4e61be282ad93706c81e\nparent e03db2301e823be6371464228f7d8b10b3189abd\nparent fe8ace8da3e2dba750fe09587628b2c36d303267\nauthor kennytm <kennytm@gmail.com> 1539353043 +0800\ncommitter GitHub <noreply@github.com> 1539353043 +0800\n\nRollup merge of #54825 - davidtwco:issue-52663-deref-raw-pointer, r=pnkfelix\n\nNLL says \"borrowed content\" instead of more precise \"dereference of raw pointer\"\n\nPart of #52663.\n\nPreviously, move errors involving the dereference of a raw pointer would\nsay \"borrowed content\". This commit changes it to say \"dereference of\nraw pointer\".\n\nr? @nikomatsakis\ncc @pnkfelix\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/44a527a27a7fdeb14a208ca195a62b58df4b960d", "html_url": "https://github.com/rust-lang/rust/commit/44a527a27a7fdeb14a208ca195a62b58df4b960d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/44a527a27a7fdeb14a208ca195a62b58df4b960d/comments", "author": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e03db2301e823be6371464228f7d8b10b3189abd", "url": "https://api.github.com/repos/rust-lang/rust/commits/e03db2301e823be6371464228f7d8b10b3189abd", "html_url": "https://github.com/rust-lang/rust/commit/e03db2301e823be6371464228f7d8b10b3189abd"}, {"sha": "fe8ace8da3e2dba750fe09587628b2c36d303267", "url": "https://api.github.com/repos/rust-lang/rust/commits/fe8ace8da3e2dba750fe09587628b2c36d303267", "html_url": "https://github.com/rust-lang/rust/commit/fe8ace8da3e2dba750fe09587628b2c36d303267"}], "stats": {"total": 27, "additions": 21, "deletions": 6}, "files": [{"sha": "ea62694f8be753c7c52e6b1c71fd8127b0af5282", "filename": "src/librustc_mir/borrow_check/move_errors.rs", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/44a527a27a7fdeb14a208ca195a62b58df4b960d/src%2Flibrustc_mir%2Fborrow_check%2Fmove_errors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/44a527a27a7fdeb14a208ca195a62b58df4b960d/src%2Flibrustc_mir%2Fborrow_check%2Fmove_errors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Fmove_errors.rs?ref=44a527a27a7fdeb14a208ca195a62b58df4b960d", "patch": "@@ -68,6 +68,7 @@ enum GroupedMoveError<'tcx> {\n enum BorrowedContentSource {\n     Arc,\n     Rc,\n+    DerefRawPointer,\n     Other,\n }\n \n@@ -76,6 +77,7 @@ impl Display for BorrowedContentSource {\n         match *self {\n             BorrowedContentSource::Arc => write!(f, \"an `Arc`\"),\n             BorrowedContentSource::Rc => write!(f, \"an `Rc`\"),\n+            BorrowedContentSource::DerefRawPointer => write!(f, \"dereference of raw pointer\"),\n             BorrowedContentSource::Other => write!(f, \"borrowed content\"),\n         }\n     }\n@@ -279,6 +281,7 @@ impl<'a, 'gcx, 'tcx> MirBorrowckCtxt<'a, 'gcx, 'tcx> {\n                             self.prefixes(&original_path, PrefixSet::All)\n                             .any(|p| p.is_upvar_field_projection(self.mir, &self.infcx.tcx)\n                                  .is_some());\n+                        debug!(\"report: ty={:?}\", ty);\n                         match ty.sty {\n                             ty::Array(..) | ty::Slice(..) =>\n                                 self.infcx.tcx.cannot_move_out_of_interior_noncopy(\n@@ -582,6 +585,18 @@ impl<'a, 'gcx, 'tcx> MirBorrowckCtxt<'a, 'gcx, 'tcx> {\n             }\n         }\n \n+        // If we didn't find an `Arc` or an `Rc`, then check specifically for\n+        // a dereference of a place that has the type of a raw pointer.\n+        // We can't use `place.ty(..).to_ty(..)` here as that strips away the raw pointer.\n+        if let Place::Projection(box Projection {\n+            base,\n+            elem: ProjectionElem::Deref,\n+        }) = place {\n+            if base.ty(self.mir, self.infcx.tcx).to_ty(self.infcx.tcx).is_unsafe_ptr() {\n+                return BorrowedContentSource::DerefRawPointer;\n+            }\n+        }\n+\n         BorrowedContentSource::Other\n     }\n }"}, {"sha": "c3a2180b9f082e062f9afab0ede465a7511ac8f3", "filename": "src/test/ui/borrowck/borrowck-move-from-unsafe-ptr.nll.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/44a527a27a7fdeb14a208ca195a62b58df4b960d/src%2Ftest%2Fui%2Fborrowck%2Fborrowck-move-from-unsafe-ptr.nll.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/44a527a27a7fdeb14a208ca195a62b58df4b960d/src%2Ftest%2Fui%2Fborrowck%2Fborrowck-move-from-unsafe-ptr.nll.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fborrowck%2Fborrowck-move-from-unsafe-ptr.nll.stderr?ref=44a527a27a7fdeb14a208ca195a62b58df4b960d", "patch": "@@ -1,10 +1,10 @@\n-error[E0507]: cannot move out of borrowed content\n+error[E0507]: cannot move out of dereference of raw pointer\n   --> $DIR/borrowck-move-from-unsafe-ptr.rs:13:13\n    |\n LL |     let y = *x; //~ ERROR cannot move out of dereference of raw pointer\n    |             ^^\n    |             |\n-   |             cannot move out of borrowed content\n+   |             cannot move out of dereference of raw pointer\n    |             help: consider removing the `*`: `x`\n \n error: aborting due to previous error"}, {"sha": "362778b26c861911d2624046c87cd15c65d575ea", "filename": "src/test/ui/issues/issue-20801.nll.stderr", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/44a527a27a7fdeb14a208ca195a62b58df4b960d/src%2Ftest%2Fui%2Fissues%2Fissue-20801.nll.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/44a527a27a7fdeb14a208ca195a62b58df4b960d/src%2Ftest%2Fui%2Fissues%2Fissue-20801.nll.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-20801.nll.stderr?ref=44a527a27a7fdeb14a208ca195a62b58df4b960d", "patch": "@@ -16,22 +16,22 @@ LL |     let b = unsafe { *imm_ref() };\n    |                      cannot move out of borrowed content\n    |                      help: consider removing the `*`: `imm_ref()`\n \n-error[E0507]: cannot move out of borrowed content\n+error[E0507]: cannot move out of dereference of raw pointer\n   --> $DIR/issue-20801.rs:42:22\n    |\n LL |     let c = unsafe { *mut_ptr() };\n    |                      ^^^^^^^^^^\n    |                      |\n-   |                      cannot move out of borrowed content\n+   |                      cannot move out of dereference of raw pointer\n    |                      help: consider removing the `*`: `mut_ptr()`\n \n-error[E0507]: cannot move out of borrowed content\n+error[E0507]: cannot move out of dereference of raw pointer\n   --> $DIR/issue-20801.rs:45:22\n    |\n LL |     let d = unsafe { *const_ptr() };\n    |                      ^^^^^^^^^^^^\n    |                      |\n-   |                      cannot move out of borrowed content\n+   |                      cannot move out of dereference of raw pointer\n    |                      help: consider removing the `*`: `const_ptr()`\n \n error: aborting due to 4 previous errors"}]}