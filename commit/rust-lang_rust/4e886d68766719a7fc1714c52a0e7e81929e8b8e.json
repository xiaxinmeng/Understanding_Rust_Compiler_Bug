{"sha": "4e886d68766719a7fc1714c52a0e7e81929e8b8e", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRlODg2ZDY4NzY2NzE5YTdmYzE3MTRjNTJhMGU3ZTgxOTI5ZThiOGU=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-08-08T13:11:09Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-08-08T13:11:09Z"}, "message": "Auto merge of #87827 - eddyb:wrapperless-mem-replace, r=m-ou-se\n\nAvoid using the `copy_nonoverlapping` wrapper through `mem::replace`.\n\nThis is a much simpler way to achieve the pre-#86003 behavior of `mem::replace` not needing dynamically-sized `memcpy`s (at least before inlining), than re-doing #81238 (which needs #86699 or something similar).\n\nI didn't notice it until recently, but `ptr::write` already explicitly avoided using the wrapper, while `ptr::read` just called the wrapper (and was the reason for us observing any behavior change from #86003 in Rust-GPU).\n\n<hr/>\n\nThe codegen test I've added fails without the change to `core::ptr::read` like this (ignore the `v0` mangling, I was using a worktree with it turned on by default, for this):\n```llvm\n       13: ; core::intrinsics::copy_nonoverlapping::<u8>\n       14: ; Function Attrs: inlinehint nonlazybind uwtable\n       15: define internal void `@_RINvNtCscK5tvALCJol_4core10intrinsics19copy_nonoverlappinghECsaS4X3EinRE8_25mem_replace_direct_memcpy(i8*` %src, i8* %dst, i64 %count) unnamed_addr #0 {\n       16: start:\n       17:  %0 = mul i64 %count, 1\n       18:  call void `@llvm.memcpy.p0i8.p0i8.i64(i8*` align 1 %dst, i8* align 1 %src, i64 %0, i1 false)\nnot:17      !~~~~~~~~~~~~~~~~~~~~~                                                                     error: no match expected\n       19:  ret void\n       20: }\n```\nWith the `core::ptr::read` change, `core::intrinsics::copy_nonoverlapping` doesn't get instantiated and the test passes.\n\n<hr/>\n\nr? `@m-ou-se` cc `@nagisa` (codegen test) `@oli-obk` / `@RalfJung` (miri diagnostic changes)", "tree": {"sha": "050ac0b5b0833c9f9218f882a5ff63fc11c7b976", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/050ac0b5b0833c9f9218f882a5ff63fc11c7b976"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4e886d68766719a7fc1714c52a0e7e81929e8b8e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4e886d68766719a7fc1714c52a0e7e81929e8b8e", "html_url": "https://github.com/rust-lang/rust/commit/4e886d68766719a7fc1714c52a0e7e81929e8b8e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4e886d68766719a7fc1714c52a0e7e81929e8b8e/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e8c25f266349a68faa8c4fb68f5c1d5e4512790f", "url": "https://api.github.com/repos/rust-lang/rust/commits/e8c25f266349a68faa8c4fb68f5c1d5e4512790f", "html_url": "https://github.com/rust-lang/rust/commit/e8c25f266349a68faa8c4fb68f5c1d5e4512790f"}, {"sha": "a1d014bdbc0159c6ed60e29dc0c3ef3110ff9776", "url": "https://api.github.com/repos/rust-lang/rust/commits/a1d014bdbc0159c6ed60e29dc0c3ef3110ff9776", "html_url": "https://github.com/rust-lang/rust/commit/a1d014bdbc0159c6ed60e29dc0c3ef3110ff9776"}], "stats": {"total": 77, "additions": 47, "deletions": 30}, "files": [{"sha": "47fad15e333570d74dbab05ecf887b330803c986", "filename": "library/core/src/ptr/mod.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/4e886d68766719a7fc1714c52a0e7e81929e8b8e/library%2Fcore%2Fsrc%2Fptr%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4e886d68766719a7fc1714c52a0e7e81929e8b8e/library%2Fcore%2Fsrc%2Fptr%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fptr%2Fmod.rs?ref=4e886d68766719a7fc1714c52a0e7e81929e8b8e", "patch": "@@ -685,6 +685,13 @@ pub const unsafe fn replace<T>(dst: *mut T, mut src: T) -> T {\n #[stable(feature = \"rust1\", since = \"1.0.0\")]\n #[rustc_const_unstable(feature = \"const_ptr_read\", issue = \"80377\")]\n pub const unsafe fn read<T>(src: *const T) -> T {\n+    // We are calling the intrinsics directly to avoid function calls in the generated code\n+    // as `intrinsics::copy_nonoverlapping` is a wrapper function.\n+    extern \"rust-intrinsic\" {\n+        #[rustc_const_unstable(feature = \"const_intrinsic_copy\", issue = \"80697\")]\n+        fn copy_nonoverlapping<T>(src: *const T, dst: *mut T, count: usize);\n+    }\n+\n     let mut tmp = MaybeUninit::<T>::uninit();\n     // SAFETY: the caller must guarantee that `src` is valid for reads.\n     // `src` cannot overlap `tmp` because `tmp` was just allocated on"}, {"sha": "47f4fc27fd85a68e1dbaec7c45dcbcad168ca5a5", "filename": "src/test/codegen/mem-replace-direct-memcpy.rs", "status": "added", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/4e886d68766719a7fc1714c52a0e7e81929e8b8e/src%2Ftest%2Fcodegen%2Fmem-replace-direct-memcpy.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4e886d68766719a7fc1714c52a0e7e81929e8b8e/src%2Ftest%2Fcodegen%2Fmem-replace-direct-memcpy.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fmem-replace-direct-memcpy.rs?ref=4e886d68766719a7fc1714c52a0e7e81929e8b8e", "patch": "@@ -0,0 +1,25 @@\n+// This test ensures that `mem::replace::<T>` only ever calls `@llvm.memcpy`\n+// with `size_of::<T>()` as the size, and never goes through any wrapper that\n+// may e.g. multiply `size_of::<T>()` with a variable \"count\" (which is only\n+// known to be `1` after inlining).\n+\n+// compile-flags: -C no-prepopulate-passes\n+\n+#![crate_type = \"lib\"]\n+\n+pub fn replace_byte(dst: &mut u8, src: u8) -> u8 {\n+    std::mem::replace(dst, src)\n+}\n+\n+// NOTE(eddyb) the `CHECK-NOT`s ensure that the only calls of `@llvm.memcpy` in\n+// the entire output, are the two direct calls we want, from `ptr::{read,write}`.\n+\n+// CHECK-NOT: call void @llvm.memcpy\n+// CHECK: ; core::ptr::read\n+// CHECK-NOT: call void @llvm.memcpy\n+// CHECK: call void @llvm.memcpy.p0i8.p0i8.i{{.*}}(i8* align 1 %{{.*}}, i8* align 1 %src, i{{.*}} 1, i1 false)\n+// CHECK-NOT: call void @llvm.memcpy\n+// CHECK: ; core::ptr::write\n+// CHECK-NOT: call void @llvm.memcpy\n+// CHECK: call void @llvm.memcpy.p0i8.p0i8.i{{.*}}(i8* align 1 %dst, i8* align 1 %src, i{{.*}} 1, i1 false)\n+// CHECK-NOT: call void @llvm.memcpy"}, {"sha": "62af6a6adb64478441e7e25df9bbc1c1a24ed86f", "filename": "src/test/ui/const-ptr/out_of_bounds_read.stderr", "status": "modified", "additions": 15, "deletions": 30, "changes": 45, "blob_url": "https://github.com/rust-lang/rust/blob/4e886d68766719a7fc1714c52a0e7e81929e8b8e/src%2Ftest%2Fui%2Fconst-ptr%2Fout_of_bounds_read.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/4e886d68766719a7fc1714c52a0e7e81929e8b8e/src%2Ftest%2Fui%2Fconst-ptr%2Fout_of_bounds_read.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconst-ptr%2Fout_of_bounds_read.stderr?ref=4e886d68766719a7fc1714c52a0e7e81929e8b8e", "patch": "@@ -1,35 +1,25 @@\n error[E0080]: evaluation of constant value failed\n-  --> $SRC_DIR/core/src/intrinsics.rs:LL:COL\n-   |\n-LL |     unsafe { copy_nonoverlapping(src, dst, count) }\n-   |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n-   |              |\n-   |              memory access failed: alloc7 has size 4, so pointer to 4 bytes starting at offset 4 is out-of-bounds\n-   |              inside `copy_nonoverlapping::<u32>` at $SRC_DIR/core/src/intrinsics.rs:LL:COL\n-   |\n-  ::: $SRC_DIR/core/src/ptr/mod.rs:LL:COL\n+  --> $SRC_DIR/core/src/ptr/mod.rs:LL:COL\n    |\n LL |         copy_nonoverlapping(src, tmp.as_mut_ptr(), 1);\n-   |         --------------------------------------------- inside `std::ptr::read::<u32>` at $SRC_DIR/core/src/ptr/mod.rs:LL:COL\n+   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |         |\n+   |         memory access failed: alloc7 has size 4, so pointer to 4 bytes starting at offset 4 is out-of-bounds\n+   |         inside `std::ptr::read::<u32>` at $SRC_DIR/core/src/ptr/mod.rs:LL:COL\n    |\n   ::: $DIR/out_of_bounds_read.rs:13:33\n    |\n LL |     const _READ: u32 = unsafe { ptr::read(PAST_END_PTR) };\n    |                                 ----------------------- inside `_READ` at $DIR/out_of_bounds_read.rs:13:33\n \n error[E0080]: evaluation of constant value failed\n-  --> $SRC_DIR/core/src/intrinsics.rs:LL:COL\n-   |\n-LL |     unsafe { copy_nonoverlapping(src, dst, count) }\n-   |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n-   |              |\n-   |              memory access failed: alloc7 has size 4, so pointer to 4 bytes starting at offset 4 is out-of-bounds\n-   |              inside `copy_nonoverlapping::<u32>` at $SRC_DIR/core/src/intrinsics.rs:LL:COL\n-   |\n-  ::: $SRC_DIR/core/src/ptr/mod.rs:LL:COL\n+  --> $SRC_DIR/core/src/ptr/mod.rs:LL:COL\n    |\n LL |         copy_nonoverlapping(src, tmp.as_mut_ptr(), 1);\n-   |         --------------------------------------------- inside `std::ptr::read::<u32>` at $SRC_DIR/core/src/ptr/mod.rs:LL:COL\n+   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |         |\n+   |         memory access failed: alloc7 has size 4, so pointer to 4 bytes starting at offset 4 is out-of-bounds\n+   |         inside `std::ptr::read::<u32>` at $SRC_DIR/core/src/ptr/mod.rs:LL:COL\n    |\n   ::: $SRC_DIR/core/src/ptr/const_ptr.rs:LL:COL\n    |\n@@ -42,18 +32,13 @@ LL |     const _CONST_READ: u32 = unsafe { PAST_END_PTR.read() };\n    |                                       ------------------- inside `_CONST_READ` at $DIR/out_of_bounds_read.rs:14:39\n \n error[E0080]: evaluation of constant value failed\n-  --> $SRC_DIR/core/src/intrinsics.rs:LL:COL\n-   |\n-LL |     unsafe { copy_nonoverlapping(src, dst, count) }\n-   |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n-   |              |\n-   |              memory access failed: alloc7 has size 4, so pointer to 4 bytes starting at offset 4 is out-of-bounds\n-   |              inside `copy_nonoverlapping::<u32>` at $SRC_DIR/core/src/intrinsics.rs:LL:COL\n-   |\n-  ::: $SRC_DIR/core/src/ptr/mod.rs:LL:COL\n+  --> $SRC_DIR/core/src/ptr/mod.rs:LL:COL\n    |\n LL |         copy_nonoverlapping(src, tmp.as_mut_ptr(), 1);\n-   |         --------------------------------------------- inside `std::ptr::read::<u32>` at $SRC_DIR/core/src/ptr/mod.rs:LL:COL\n+   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |         |\n+   |         memory access failed: alloc7 has size 4, so pointer to 4 bytes starting at offset 4 is out-of-bounds\n+   |         inside `std::ptr::read::<u32>` at $SRC_DIR/core/src/ptr/mod.rs:LL:COL\n    |\n   ::: $SRC_DIR/core/src/ptr/mut_ptr.rs:LL:COL\n    |"}]}