{"sha": "faf003763516074c619cee7e43ca8bc365540c92", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZhZjAwMzc2MzUxNjA3NGM2MTljZWU3ZTQzY2E4YmMzNjU1NDBjOTI=", "commit": {"author": {"name": "Jeremy A. Kolb", "email": "jkolb@ara.com", "date": "2019-01-11T20:16:55Z"}, "committer": {"name": "Jeremy A. Kolb", "email": "jkolb@ara.com", "date": "2019-01-11T20:16:55Z"}, "message": "Code lens support for running tests", "tree": {"sha": "54407f422a1a5b969b659f74fe4608be622ec596", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/54407f422a1a5b969b659f74fe4608be622ec596"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/faf003763516074c619cee7e43ca8bc365540c92", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/faf003763516074c619cee7e43ca8bc365540c92", "html_url": "https://github.com/rust-lang/rust/commit/faf003763516074c619cee7e43ca8bc365540c92", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/faf003763516074c619cee7e43ca8bc365540c92/comments", "author": {"login": "kjeremy", "id": 4325700, "node_id": "MDQ6VXNlcjQzMjU3MDA=", "avatar_url": "https://avatars.githubusercontent.com/u/4325700?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kjeremy", "html_url": "https://github.com/kjeremy", "followers_url": "https://api.github.com/users/kjeremy/followers", "following_url": "https://api.github.com/users/kjeremy/following{/other_user}", "gists_url": "https://api.github.com/users/kjeremy/gists{/gist_id}", "starred_url": "https://api.github.com/users/kjeremy/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kjeremy/subscriptions", "organizations_url": "https://api.github.com/users/kjeremy/orgs", "repos_url": "https://api.github.com/users/kjeremy/repos", "events_url": "https://api.github.com/users/kjeremy/events{/privacy}", "received_events_url": "https://api.github.com/users/kjeremy/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kjeremy", "id": 4325700, "node_id": "MDQ6VXNlcjQzMjU3MDA=", "avatar_url": "https://avatars.githubusercontent.com/u/4325700?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kjeremy", "html_url": "https://github.com/kjeremy", "followers_url": "https://api.github.com/users/kjeremy/followers", "following_url": "https://api.github.com/users/kjeremy/following{/other_user}", "gists_url": "https://api.github.com/users/kjeremy/gists{/gist_id}", "starred_url": "https://api.github.com/users/kjeremy/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kjeremy/subscriptions", "organizations_url": "https://api.github.com/users/kjeremy/orgs", "repos_url": "https://api.github.com/users/kjeremy/repos", "events_url": "https://api.github.com/users/kjeremy/events{/privacy}", "received_events_url": "https://api.github.com/users/kjeremy/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "738c958a044361dc84a0f27e57b40f66a5815990", "url": "https://api.github.com/repos/rust-lang/rust/commits/738c958a044361dc84a0f27e57b40f66a5815990", "html_url": "https://github.com/rust-lang/rust/commit/738c958a044361dc84a0f27e57b40f66a5815990"}], "stats": {"total": 281, "additions": 196, "deletions": 85}, "files": [{"sha": "be6a6ead6dd6a2c96f984c0679f860270c393701", "filename": "crates/ra_lsp_server/src/caps.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/faf003763516074c619cee7e43ca8bc365540c92/crates%2Fra_lsp_server%2Fsrc%2Fcaps.rs", "raw_url": "https://github.com/rust-lang/rust/raw/faf003763516074c619cee7e43ca8bc365540c92/crates%2Fra_lsp_server%2Fsrc%2Fcaps.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Fsrc%2Fcaps.rs?ref=faf003763516074c619cee7e43ca8bc365540c92", "patch": "@@ -1,5 +1,5 @@\n use languageserver_types::{\n-    CodeActionProviderCapability, CompletionOptions, DocumentOnTypeFormattingOptions,\n+    CodeActionProviderCapability, CodeLensOptions, CompletionOptions, DocumentOnTypeFormattingOptions,\n     ExecuteCommandOptions, FoldingRangeProviderCapability, RenameOptions, RenameProviderCapability,\n     ServerCapabilities, SignatureHelpOptions, TextDocumentSyncCapability, TextDocumentSyncKind,\n     TextDocumentSyncOptions,\n@@ -32,7 +32,9 @@ pub fn server_capabilities() -> ServerCapabilities {\n         document_symbol_provider: Some(true),\n         workspace_symbol_provider: Some(true),\n         code_action_provider: Some(CodeActionProviderCapability::Simple(true)),\n-        code_lens_provider: None,\n+        code_lens_provider: Some(CodeLensOptions {\n+            resolve_provider: None,\n+        }),\n         document_formatting_provider: Some(true),\n         document_range_formatting_provider: None,\n         document_on_type_formatting_provider: Some(DocumentOnTypeFormattingOptions {"}, {"sha": "726c758aa347a247a194fb09a03817588424e8b8", "filename": "crates/ra_lsp_server/src/main_loop.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/faf003763516074c619cee7e43ca8bc365540c92/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/faf003763516074c619cee7e43ca8bc365540c92/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop.rs?ref=faf003763516074c619cee7e43ca8bc365540c92", "patch": "@@ -300,6 +300,7 @@ fn on_request(\n         .on::<req::DecorationsRequest>(handlers::handle_decorations)?\n         .on::<req::Completion>(handlers::handle_completion)?\n         .on::<req::CodeActionRequest>(handlers::handle_code_action)?\n+        .on::<req::CodeLensRequest>(handlers::handle_code_lens)?\n         .on::<req::FoldingRangeRequest>(handlers::handle_folding_range)?\n         .on::<req::SignatureHelpRequest>(handlers::handle_signature_help)?\n         .on::<req::HoverRequest>(handlers::handle_hover)?"}, {"sha": "f881bd703abecf4ac6f3a21f2b7a940af528df60", "filename": "crates/ra_lsp_server/src/main_loop/handlers.rs", "status": "modified", "additions": 121, "deletions": 81, "changes": 202, "blob_url": "https://github.com/rust-lang/rust/blob/faf003763516074c619cee7e43ca8bc365540c92/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop%2Fhandlers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/faf003763516074c619cee7e43ca8bc365540c92/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop%2Fhandlers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop%2Fhandlers.rs?ref=faf003763516074c619cee7e43ca8bc365540c92", "patch": "@@ -2,7 +2,7 @@ use std::collections::HashMap;\n \n use gen_lsp_server::ErrorCode;\n use languageserver_types::{\n-    CodeActionResponse, Command, Diagnostic, DiagnosticSeverity, DocumentFormattingParams,\n+    CodeActionResponse, Command, CodeLens, Diagnostic, DiagnosticSeverity, DocumentFormattingParams,\n     DocumentHighlight, DocumentSymbol, Documentation, FoldingRange, FoldingRangeKind,\n     FoldingRangeParams, Hover, HoverContents, Location, MarkedString, MarkupContent, MarkupKind,\n     ParameterInformation, ParameterLabel, Position, PrepareRenameResponse, Range, RenameParams,\n@@ -291,97 +291,93 @@ pub fn handle_runnables(\n         env: FxHashMap::default(),\n     });\n     return Ok(res);\n+}\n \n-    fn runnable_args(\n-        world: &ServerWorld,\n-        file_id: FileId,\n-        kind: &RunnableKind,\n-    ) -> Result<Vec<String>> {\n-        let spec = CargoTargetSpec::for_file(world, file_id)?;\n-        let mut res = Vec::new();\n-        match kind {\n-            RunnableKind::Test { name } => {\n-                res.push(\"test\".to_string());\n-                if let Some(spec) = spec {\n-                    spec.push_to(&mut res);\n-                }\n-                res.push(\"--\".to_string());\n-                res.push(name.to_string());\n-                res.push(\"--nocapture\".to_string());\n+fn runnable_args(world: &ServerWorld, file_id: FileId, kind: &RunnableKind) -> Result<Vec<String>> {\n+    let spec = CargoTargetSpec::for_file(world, file_id)?;\n+    let mut res = Vec::new();\n+    match kind {\n+        RunnableKind::Test { name } => {\n+            res.push(\"test\".to_string());\n+            if let Some(spec) = spec {\n+                spec.push_to(&mut res);\n             }\n-            RunnableKind::TestMod { path } => {\n-                res.push(\"test\".to_string());\n-                if let Some(spec) = spec {\n-                    spec.push_to(&mut res);\n-                }\n-                res.push(\"--\".to_string());\n-                res.push(path.to_string());\n-                res.push(\"--nocapture\".to_string());\n+            res.push(\"--\".to_string());\n+            res.push(name.to_string());\n+            res.push(\"--nocapture\".to_string());\n+        }\n+        RunnableKind::TestMod { path } => {\n+            res.push(\"test\".to_string());\n+            if let Some(spec) = spec {\n+                spec.push_to(&mut res);\n             }\n-            RunnableKind::Bin => {\n-                res.push(\"run\".to_string());\n-                if let Some(spec) = spec {\n-                    spec.push_to(&mut res);\n-                }\n+            res.push(\"--\".to_string());\n+            res.push(path.to_string());\n+            res.push(\"--nocapture\".to_string());\n+        }\n+        RunnableKind::Bin => {\n+            res.push(\"run\".to_string());\n+            if let Some(spec) = spec {\n+                spec.push_to(&mut res);\n             }\n         }\n-        Ok(res)\n     }\n+    Ok(res)\n+}\n \n-    struct CargoTargetSpec {\n-        package: String,\n-        target: String,\n-        target_kind: TargetKind,\n-    }\n+struct CargoTargetSpec {\n+    package: String,\n+    target: String,\n+    target_kind: TargetKind,\n+}\n \n-    impl CargoTargetSpec {\n-        fn for_file(world: &ServerWorld, file_id: FileId) -> Result<Option<CargoTargetSpec>> {\n-            let &crate_id = match world.analysis().crate_for(file_id)?.first() {\n-                Some(crate_id) => crate_id,\n-                None => return Ok(None),\n+impl CargoTargetSpec {\n+    fn for_file(world: &ServerWorld, file_id: FileId) -> Result<Option<CargoTargetSpec>> {\n+        let &crate_id = match world.analysis().crate_for(file_id)?.first() {\n+            Some(crate_id) => crate_id,\n+            None => return Ok(None),\n+        };\n+        let file_id = world.analysis().crate_root(crate_id)?;\n+        let path = world\n+            .vfs\n+            .read()\n+            .file2path(ra_vfs::VfsFile(file_id.0.into()));\n+        let res = world.workspaces.iter().find_map(|ws| {\n+            let tgt = ws.cargo.target_by_root(&path)?;\n+            let res = CargoTargetSpec {\n+                package: tgt.package(&ws.cargo).name(&ws.cargo).to_string(),\n+                target: tgt.name(&ws.cargo).to_string(),\n+                target_kind: tgt.kind(&ws.cargo),\n             };\n-            let file_id = world.analysis().crate_root(crate_id)?;\n-            let path = world\n-                .vfs\n-                .read()\n-                .file2path(ra_vfs::VfsFile(file_id.0.into()));\n-            let res = world.workspaces.iter().find_map(|ws| {\n-                let tgt = ws.cargo.target_by_root(&path)?;\n-                let res = CargoTargetSpec {\n-                    package: tgt.package(&ws.cargo).name(&ws.cargo).to_string(),\n-                    target: tgt.name(&ws.cargo).to_string(),\n-                    target_kind: tgt.kind(&ws.cargo),\n-                };\n-                Some(res)\n-            });\n-            Ok(res)\n-        }\n+            Some(res)\n+        });\n+        Ok(res)\n+    }\n \n-        fn push_to(self, buf: &mut Vec<String>) {\n-            buf.push(\"--package\".to_string());\n-            buf.push(self.package);\n-            match self.target_kind {\n-                TargetKind::Bin => {\n-                    buf.push(\"--bin\".to_string());\n-                    buf.push(self.target);\n-                }\n-                TargetKind::Test => {\n-                    buf.push(\"--test\".to_string());\n-                    buf.push(self.target);\n-                }\n-                TargetKind::Bench => {\n-                    buf.push(\"--bench\".to_string());\n-                    buf.push(self.target);\n-                }\n-                TargetKind::Example => {\n-                    buf.push(\"--example\".to_string());\n-                    buf.push(self.target);\n-                }\n-                TargetKind::Lib => {\n-                    buf.push(\"--lib\".to_string());\n-                }\n-                TargetKind::Other => (),\n+    fn push_to(self, buf: &mut Vec<String>) {\n+        buf.push(\"--package\".to_string());\n+        buf.push(self.package);\n+        match self.target_kind {\n+            TargetKind::Bin => {\n+                buf.push(\"--bin\".to_string());\n+                buf.push(self.target);\n+            }\n+            TargetKind::Test => {\n+                buf.push(\"--test\".to_string());\n+                buf.push(self.target);\n+            }\n+            TargetKind::Bench => {\n+                buf.push(\"--bench\".to_string());\n+                buf.push(self.target);\n+            }\n+            TargetKind::Example => {\n+                buf.push(\"--example\".to_string());\n+                buf.push(self.target);\n+            }\n+            TargetKind::Lib => {\n+                buf.push(\"--lib\".to_string());\n             }\n+            TargetKind::Other => (),\n         }\n     }\n }\n@@ -666,6 +662,50 @@ pub fn handle_code_action(\n     Ok(Some(CodeActionResponse::Commands(res)))\n }\n \n+pub fn handle_code_lens(\n+    world: ServerWorld,\n+    params: req::CodeLensParams,\n+) -> Result<Option<Vec<CodeLens>>> {\n+    let file_id = params.text_document.try_conv_with(&world)?;\n+    let line_index = world.analysis().file_line_index(file_id);\n+\n+    let mut lenses: Vec<CodeLens> = Default::default();\n+\n+    for runnable in world.analysis().runnables(file_id)? {\n+        match &runnable.kind {\n+            RunnableKind::Test { name: _ } | RunnableKind::TestMod { path: _ } => {\n+                let args = runnable_args(&world, file_id, &runnable.kind)?;\n+\n+                let range = runnable.range.conv_with(&line_index);\n+\n+                // This represents the actual command that will be run.\n+                let r: req::Runnable = req::Runnable {\n+                    range,\n+                    label: Default::default(),\n+                    bin: \"cargo\".into(),\n+                    args,\n+                    env: Default::default(),\n+                };\n+\n+                let lens = CodeLens {\n+                    range,\n+                    command: Some(Command {\n+                        title: \"Run Test\".into(),\n+                        command: \"ra-lsp.run-single\".into(),\n+                        arguments: Some(vec![to_value(r).unwrap()]),\n+                    }),\n+                    data: None,\n+                };\n+\n+                lenses.push(lens);\n+            }\n+            _ => continue,\n+        };\n+    }\n+\n+    return Ok(Some(lenses));\n+}\n+\n pub fn handle_document_highlight(\n     world: ServerWorld,\n     params: req::TextDocumentPositionParams,"}, {"sha": "c2b16725b73dd10b98e4d5e8ba80edede708ebd5", "filename": "crates/ra_lsp_server/src/req.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/faf003763516074c619cee7e43ca8bc365540c92/crates%2Fra_lsp_server%2Fsrc%2Freq.rs", "raw_url": "https://github.com/rust-lang/rust/raw/faf003763516074c619cee7e43ca8bc365540c92/crates%2Fra_lsp_server%2Fsrc%2Freq.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Fsrc%2Freq.rs?ref=faf003763516074c619cee7e43ca8bc365540c92", "patch": "@@ -4,8 +4,8 @@ use serde::{Deserialize, Serialize};\n use url_serde;\n \n pub use languageserver_types::{\n-    notification::*, request::*, ApplyWorkspaceEditParams, CodeActionParams, CompletionParams,\n-    CompletionResponse, DocumentOnTypeFormattingParams, DocumentSymbolParams,\n+    notification::*, request::*, ApplyWorkspaceEditParams, CodeActionParams, CodeLens, CodeLensParams,\n+    CompletionParams, CompletionResponse, DocumentOnTypeFormattingParams, DocumentSymbolParams,\n     DocumentSymbolResponse, ExecuteCommandParams, Hover, InitializeResult,\n     PublishDiagnosticsParams, ReferenceParams, SignatureHelp, TextDocumentEdit,\n     TextDocumentPositionParams, TextEdit, WorkspaceEdit, WorkspaceSymbolParams,"}, {"sha": "c8bb5559194434cbca5cf5e5950728032e5ba6bd", "filename": "editors/code/src/commands/index.ts", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/faf003763516074c619cee7e43ca8bc365540c92/editors%2Fcode%2Fsrc%2Fcommands%2Findex.ts", "raw_url": "https://github.com/rust-lang/rust/raw/faf003763516074c619cee7e43ca8bc365540c92/editors%2Fcode%2Fsrc%2Fcommands%2Findex.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fcommands%2Findex.ts?ref=faf003763516074c619cee7e43ca8bc365540c92", "patch": "@@ -4,6 +4,7 @@ import * as joinLines from './join_lines';\n import * as matchingBrace from './matching_brace';\n import * as onEnter from './on_enter';\n import * as parentModule from './parent_module';\n+import * as runSingle from './run_single';\n import * as runnables from './runnables';\n import * as syntaxTree from './syntaxTree';\n \n@@ -13,6 +14,7 @@ export {\n     joinLines,\n     matchingBrace,\n     parentModule,\n+    runSingle,\n     runnables,\n     syntaxTree,\n     onEnter"}, {"sha": "855bcdb068930ff55ebbd01abb80a636a662b8ce", "filename": "editors/code/src/commands/run_single.ts", "status": "added", "additions": 63, "deletions": 0, "changes": 63, "blob_url": "https://github.com/rust-lang/rust/blob/faf003763516074c619cee7e43ca8bc365540c92/editors%2Fcode%2Fsrc%2Fcommands%2Frun_single.ts", "raw_url": "https://github.com/rust-lang/rust/raw/faf003763516074c619cee7e43ca8bc365540c92/editors%2Fcode%2Fsrc%2Fcommands%2Frun_single.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fcommands%2Frun_single.ts?ref=faf003763516074c619cee7e43ca8bc365540c92", "patch": "@@ -0,0 +1,63 @@\n+import * as vscode from 'vscode';\n+import * as lc from 'vscode-languageclient';\n+\n+interface Runnable {\n+    range: lc.Range;\n+    label: string;\n+    bin: string;\n+    args: string[];\n+    env: { [index: string]: string };\n+}\n+\n+interface CargoTaskDefinition extends vscode.TaskDefinition {\n+    type: 'cargo';\n+    label: string;\n+    command: string;\n+    args: string[];\n+    env?: { [key: string]: string };\n+}\n+\n+function createTask(spec: Runnable): vscode.Task {\n+    const TASK_SOURCE = 'Rust';\n+    const definition: CargoTaskDefinition = {\n+        type: 'cargo',\n+        label: 'cargo',\n+        command: spec.bin,\n+        args: spec.args,\n+        env: spec.env\n+    };\n+\n+    const execOption: vscode.ShellExecutionOptions = {\n+        cwd: '.',\n+        env: definition.env\n+    };\n+    const exec = new vscode.ShellExecution(definition.command, definition.args, execOption);\n+\n+    const f = vscode.workspace.workspaceFolders![0];\n+    const t = new vscode.Task(\n+        definition,\n+        f,\n+        definition.label,\n+        TASK_SOURCE,\n+        exec,\n+        ['$rustc']\n+    );\n+    t.presentationOptions.clear = true\n+    return t;\n+}\n+\n+export async function handle(runnable: Runnable) {\n+    const editor = vscode.window.activeTextEditor;\n+    if (editor == null || editor.document.languageId !== 'rust') {\n+        return;\n+    }\n+\n+    const task = createTask(runnable);\n+    task.group = vscode.TaskGroup.Build;\n+    task.presentationOptions = {\n+        reveal: vscode.TaskRevealKind.Always,\n+        panel: vscode.TaskPanelKind.Dedicated,\n+    };\n+    \n+    return vscode.tasks.executeTask(task);\n+}\n\\ No newline at end of file"}, {"sha": "acbb1f734e4f8c33c3693ba9adb552405f79c99b", "filename": "editors/code/src/extension.ts", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/faf003763516074c619cee7e43ca8bc365540c92/editors%2Fcode%2Fsrc%2Fextension.ts", "raw_url": "https://github.com/rust-lang/rust/raw/faf003763516074c619cee7e43ca8bc365540c92/editors%2Fcode%2Fsrc%2Fextension.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fextension.ts?ref=faf003763516074c619cee7e43ca8bc365540c92", "patch": "@@ -55,6 +55,9 @@ export function activate(context: vscode.ExtensionContext) {\n     );\n     overrideCommand('type', commands.onEnter.handle);\n \n+    // Unlike the above this does not send requests to the language server\n+    registerCommand('ra-lsp.run-single', commands.runSingle.handle);\n+\n     // Notifications are events triggered by the language server\n     const allNotifications: Iterable<\n         [string, lc.GenericNotificationHandler]"}]}