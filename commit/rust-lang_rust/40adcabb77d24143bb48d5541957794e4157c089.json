{"sha": "40adcabb77d24143bb48d5541957794e4157c089", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQwYWRjYWJiNzdkMjQxNDNiYjQ4ZDU1NDE5NTc3OTRlNDE1N2MwODk=", "commit": {"author": {"name": "Yuki Okushi", "email": "huyuumi.dev@gmail.com", "date": "2020-08-04T00:27:08Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-08-04T00:27:08Z"}, "message": "Rollup merge of #75103 - Mark-Simulacrum:no-ra-for-riscv64, r=matklad\n\nDisable building rust-analyzer on riscv64\n\nriscv64 has an LLVM bug that makes rust-analyzer not build. Should permit future rust-analyzer ups (e.g., https://github.com/rust-lang/rust/pull/74813) to land.", "tree": {"sha": "30a24f3040b2b1af28cea593d4d13faa1c0c3753", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/30a24f3040b2b1af28cea593d4d13faa1c0c3753"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/40adcabb77d24143bb48d5541957794e4157c089", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfKKtcCRBK7hj4Ov3rIwAAdHIIAFRXYyX2tZBkKAeT+ko600f+\nzKKyWVzutZC3jV70Hu1/gLgNIjPEjymzU45wrMpFFlClv+AuEbCHrxwMa1VqsCUR\n3yjyC4vafUh4vEYM6f19Fxh6ctNPxKjssi833nNxWxMyH6OZSqopdfKmgIxyxSyq\nmIR4Pwj4uhl9RF5+ISJIFkPX+988ws7D1iR6Vd80/HLWXt7AoLmAU9UqC1yd3Rgy\n79CLjvmBgvHAPVEQQsQepvkWRnz6bMI4nXR95XI5Yr1a1StnIsouRo0uaDEXDcoN\n/QAdJorOnjD9DGnnHnKp62TsJQZef/T4On1vfaGwocOwqgZtaUL9JXu+EHmPItM=\n=ZQac\n-----END PGP SIGNATURE-----\n", "payload": "tree 30a24f3040b2b1af28cea593d4d13faa1c0c3753\nparent 622759d129e7acad53cf4d54415254db7018568c\nparent d2fc809fdb2e92581a0ecd70dec3e179dbd3439a\nauthor Yuki Okushi <huyuumi.dev@gmail.com> 1596500828 +0900\ncommitter GitHub <noreply@github.com> 1596500828 +0900\n\nRollup merge of #75103 - Mark-Simulacrum:no-ra-for-riscv64, r=matklad\n\nDisable building rust-analyzer on riscv64\n\nriscv64 has an LLVM bug that makes rust-analyzer not build. Should permit future rust-analyzer ups (e.g., https://github.com/rust-lang/rust/pull/74813) to land.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/40adcabb77d24143bb48d5541957794e4157c089", "html_url": "https://github.com/rust-lang/rust/commit/40adcabb77d24143bb48d5541957794e4157c089", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/40adcabb77d24143bb48d5541957794e4157c089/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "622759d129e7acad53cf4d54415254db7018568c", "url": "https://api.github.com/repos/rust-lang/rust/commits/622759d129e7acad53cf4d54415254db7018568c", "html_url": "https://github.com/rust-lang/rust/commit/622759d129e7acad53cf4d54415254db7018568c"}, {"sha": "d2fc809fdb2e92581a0ecd70dec3e179dbd3439a", "url": "https://api.github.com/repos/rust-lang/rust/commits/d2fc809fdb2e92581a0ecd70dec3e179dbd3439a", "html_url": "https://github.com/rust-lang/rust/commit/d2fc809fdb2e92581a0ecd70dec3e179dbd3439a"}], "stats": {"total": 74, "additions": 47, "deletions": 27}, "files": [{"sha": "98b6be29c073b80d337744658f75f50ad74e2ced", "filename": "src/bootstrap/dist.rs", "status": "modified", "additions": 47, "deletions": 27, "changes": 74, "blob_url": "https://github.com/rust-lang/rust/blob/40adcabb77d24143bb48d5541957794e4157c089/src%2Fbootstrap%2Fdist.rs", "raw_url": "https://github.com/rust-lang/rust/raw/40adcabb77d24143bb48d5541957794e4157c089/src%2Fbootstrap%2Fdist.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fdist.rs?ref=40adcabb77d24143bb48d5541957794e4157c089", "patch": "@@ -1355,7 +1355,7 @@ pub struct RustAnalyzer {\n }\n \n impl Step for RustAnalyzer {\n-    type Output = PathBuf;\n+    type Output = Option<PathBuf>;\n     const ONLY_HOSTS: bool = true;\n \n     fn should_run(run: ShouldRun<'_>) -> ShouldRun<'_> {\n@@ -1373,11 +1373,17 @@ impl Step for RustAnalyzer {\n         });\n     }\n \n-    fn run(self, builder: &Builder<'_>) -> PathBuf {\n+    fn run(self, builder: &Builder<'_>) -> Option<PathBuf> {\n         let compiler = self.compiler;\n         let target = self.target;\n         assert!(builder.config.extended);\n \n+        if target.contains(\"riscv64\") {\n+            // riscv64 currently has an LLVM bug that makes rust-analyzer unable\n+            // to build. See #74813 for details.\n+            return None;\n+        }\n+\n         let src = builder.src.join(\"src/tools/rust-analyzer\");\n         let release_num = builder.release_num(\"rust-analyzer/crates/rust-analyzer\");\n         let name = pkgname(builder, \"rust-analyzer\");\n@@ -1431,7 +1437,7 @@ impl Step for RustAnalyzer {\n         builder.info(&format!(\"Dist rust-analyzer stage{} ({})\", compiler.stage, target));\n         let _time = timeit(builder);\n         builder.run(&mut cmd);\n-        distdir(builder).join(format!(\"{}-{}.tar.gz\", name, target.triple))\n+        Some(distdir(builder).join(format!(\"{}-{}.tar.gz\", name, target.triple)))\n     }\n }\n \n@@ -1789,7 +1795,7 @@ impl Step for Extended {\n         tarballs.push(rustc_installer);\n         tarballs.push(cargo_installer);\n         tarballs.extend(rls_installer.clone());\n-        tarballs.push(rust_analyzer_installer.clone());\n+        tarballs.extend(rust_analyzer_installer.clone());\n         tarballs.push(clippy_installer);\n         tarballs.extend(miri_installer.clone());\n         tarballs.extend(rustfmt_installer.clone());\n@@ -1867,7 +1873,9 @@ impl Step for Extended {\n             if rls_installer.is_none() {\n                 contents = filter(&contents, \"rls\");\n             }\n-            contents = filter(&contents, \"rust-analyzer\");\n+            if rust_analyzer_installer.is_none() {\n+                contents = filter(&contents, \"rust-analyzer\");\n+            }\n             if miri_installer.is_none() {\n                 contents = filter(&contents, \"miri\");\n             }\n@@ -1914,7 +1922,9 @@ impl Step for Extended {\n             if rls_installer.is_some() {\n                 prepare(\"rls\");\n             }\n-            prepare(\"rust-analyzer\");\n+            if rust_analyzer_installer.is_some() {\n+                prepare(\"rust-analyzer\");\n+            }\n             if miri_installer.is_some() {\n                 prepare(\"miri\");\n             }\n@@ -1976,7 +1986,9 @@ impl Step for Extended {\n             if rls_installer.is_some() {\n                 prepare(\"rls\");\n             }\n-            prepare(\"rust-analyzer\");\n+            if rust_analyzer_installer.is_some() {\n+                prepare(\"rust-analyzer\");\n+            }\n             if miri_installer.is_some() {\n                 prepare(\"miri\");\n             }\n@@ -2076,23 +2088,25 @@ impl Step for Extended {\n                         .arg(etc.join(\"msi/remove-duplicates.xsl\")),\n                 );\n             }\n-            builder.run(\n-                Command::new(&heat)\n-                    .current_dir(&exe)\n-                    .arg(\"dir\")\n-                    .arg(\"rust-analyzer\")\n-                    .args(&heat_flags)\n-                    .arg(\"-cg\")\n-                    .arg(\"RustAnalyzerGroup\")\n-                    .arg(\"-dr\")\n-                    .arg(\"RustAnalyzer\")\n-                    .arg(\"-var\")\n-                    .arg(\"var.RustAnalyzerDir\")\n-                    .arg(\"-out\")\n-                    .arg(exe.join(\"RustAnalyzerGroup.wxs\"))\n-                    .arg(\"-t\")\n-                    .arg(etc.join(\"msi/remove-duplicates.xsl\")),\n-            );\n+            if rust_analyzer_installer.is_some() {\n+                builder.run(\n+                    Command::new(&heat)\n+                        .current_dir(&exe)\n+                        .arg(\"dir\")\n+                        .arg(\"rust-analyzer\")\n+                        .args(&heat_flags)\n+                        .arg(\"-cg\")\n+                        .arg(\"RustAnalyzerGroup\")\n+                        .arg(\"-dr\")\n+                        .arg(\"RustAnalyzer\")\n+                        .arg(\"-var\")\n+                        .arg(\"var.RustAnalyzerDir\")\n+                        .arg(\"-out\")\n+                        .arg(exe.join(\"RustAnalyzerGroup.wxs\"))\n+                        .arg(\"-t\")\n+                        .arg(etc.join(\"msi/remove-duplicates.xsl\")),\n+                );\n+            }\n             builder.run(\n                 Command::new(&heat)\n                     .current_dir(&exe)\n@@ -2186,7 +2200,9 @@ impl Step for Extended {\n                 if rls_installer.is_some() {\n                     cmd.arg(\"-dRlsDir=rls\");\n                 }\n-                cmd.arg(\"-dRustAnalyzerDir=rust-analyzer\");\n+                if rust_analyzer_installer.is_some() {\n+                    cmd.arg(\"-dRustAnalyzerDir=rust-analyzer\");\n+                }\n                 if miri_installer.is_some() {\n                     cmd.arg(\"-dMiriDir=miri\");\n                 }\n@@ -2206,7 +2222,9 @@ impl Step for Extended {\n             if rls_installer.is_some() {\n                 candle(\"RlsGroup.wxs\".as_ref());\n             }\n-            candle(\"RustAnalyzerGroup.wxs\".as_ref());\n+            if rust_analyzer_installer.is_some() {\n+                candle(\"RustAnalyzerGroup.wxs\".as_ref());\n+            }\n             if miri_installer.is_some() {\n                 candle(\"MiriGroup.wxs\".as_ref());\n             }\n@@ -2244,7 +2262,9 @@ impl Step for Extended {\n             if rls_installer.is_some() {\n                 cmd.arg(\"RlsGroup.wixobj\");\n             }\n-            cmd.arg(\"RustAnalyzerGroup.wixobj\");\n+            if rust_analyzer_installer.is_some() {\n+                cmd.arg(\"RustAnalyzerGroup.wixobj\");\n+            }\n             if miri_installer.is_some() {\n                 cmd.arg(\"MiriGroup.wixobj\");\n             }"}]}