{"sha": "23f177d86d05c8076c692e1c07e325b2161ae893", "node_id": "C_kwDOAAsO6NoAKDIzZjE3N2Q4NmQwNWM4MDc2YzY5MmUxYzA3ZTMyNWIyMTYxYWU4OTM", "commit": {"author": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2023-05-22T21:00:35Z"}, "committer": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2023-05-29T16:58:11Z"}, "message": "rustc_session: Feature gate linker flavors for tier 3 targets", "tree": {"sha": "56c888eda6a47c942b4e01a91878d1a33e19e50a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/56c888eda6a47c942b4e01a91878d1a33e19e50a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/23f177d86d05c8076c692e1c07e325b2161ae893", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/23f177d86d05c8076c692e1c07e325b2161ae893", "html_url": "https://github.com/rust-lang/rust/commit/23f177d86d05c8076c692e1c07e325b2161ae893", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/23f177d86d05c8076c692e1c07e325b2161ae893/comments", "author": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "committer": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b0ce4164f09be1221d004c4b84e49bdcbf973194", "url": "https://api.github.com/repos/rust-lang/rust/commits/b0ce4164f09be1221d004c4b84e49bdcbf973194", "html_url": "https://github.com/rust-lang/rust/commit/b0ce4164f09be1221d004c4b84e49bdcbf973194"}], "stats": {"total": 29, "additions": 28, "deletions": 1}, "files": [{"sha": "0ce83e7909771ebcac9b8e19e782777cf2a94d75", "filename": "compiler/rustc_session/src/config.rs", "status": "modified", "additions": 14, "deletions": 1, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/23f177d86d05c8076c692e1c07e325b2161ae893/compiler%2Frustc_session%2Fsrc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/23f177d86d05c8076c692e1c07e325b2161ae893/compiler%2Frustc_session%2Fsrc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Fconfig.rs?ref=23f177d86d05c8076c692e1c07e325b2161ae893", "patch": "@@ -12,7 +12,7 @@ use rustc_data_structures::fx::{FxHashMap, FxHashSet};\n \n use rustc_data_structures::stable_hasher::{StableOrd, ToStableHashKey};\n use rustc_target::abi::Align;\n-use rustc_target::spec::{PanicStrategy, SanitizerSet, SplitDebuginfo};\n+use rustc_target::spec::{LinkerFlavorCli, PanicStrategy, SanitizerSet, SplitDebuginfo};\n use rustc_target::spec::{Target, TargetTriple, TargetWarnings, TARGETS};\n \n use crate::parse::{CrateCheckConfig, CrateConfig};\n@@ -2525,6 +2525,19 @@ pub fn build_session_options(matches: &getopts::Matches) -> Options {\n         }\n     }\n \n+    if let Some(flavor) = cg.linker_flavor {\n+        if matches!(flavor, LinkerFlavorCli::BpfLinker | LinkerFlavorCli::PtxLinker)\n+            && !nightly_options::is_unstable_enabled(matches)\n+        {\n+            let msg = format!(\n+                \"linker flavor `{}` is unstable, `-Z unstable-options` \\\n+                 flag must also be passed to explicitly use it\",\n+                flavor.desc()\n+            );\n+            early_error(error_format, msg);\n+        }\n+    }\n+\n     let prints = collect_print_requests(&mut cg, &mut unstable_opts, matches, error_format);\n \n     let cg = cg;"}, {"sha": "3346d12c20e8067fb50ca327881b121e59265ca5", "filename": "tests/ui/linkage-attr/unstable-flavor.bpf.stderr", "status": "added", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/23f177d86d05c8076c692e1c07e325b2161ae893/tests%2Fui%2Flinkage-attr%2Funstable-flavor.bpf.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/23f177d86d05c8076c692e1c07e325b2161ae893/tests%2Fui%2Flinkage-attr%2Funstable-flavor.bpf.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Flinkage-attr%2Funstable-flavor.bpf.stderr?ref=23f177d86d05c8076c692e1c07e325b2161ae893", "patch": "@@ -0,0 +1,2 @@\n+error: linker flavor `bpf-linker` is unstable, `-Z unstable-options` flag must also be passed to explicitly use it\n+"}, {"sha": "03ca2a012460cb2b74b62b69216932101441aaf6", "filename": "tests/ui/linkage-attr/unstable-flavor.ptx.stderr", "status": "added", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/23f177d86d05c8076c692e1c07e325b2161ae893/tests%2Fui%2Flinkage-attr%2Funstable-flavor.ptx.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/23f177d86d05c8076c692e1c07e325b2161ae893/tests%2Fui%2Flinkage-attr%2Funstable-flavor.ptx.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Flinkage-attr%2Funstable-flavor.ptx.stderr?ref=23f177d86d05c8076c692e1c07e325b2161ae893", "patch": "@@ -0,0 +1,2 @@\n+error: linker flavor `ptx-linker` is unstable, `-Z unstable-options` flag must also be passed to explicitly use it\n+"}, {"sha": "5487882dc24dcb8fc476f324198b57508a10a940", "filename": "tests/ui/linkage-attr/unstable-flavor.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/23f177d86d05c8076c692e1c07e325b2161ae893/tests%2Fui%2Flinkage-attr%2Funstable-flavor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/23f177d86d05c8076c692e1c07e325b2161ae893/tests%2Fui%2Flinkage-attr%2Funstable-flavor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Flinkage-attr%2Funstable-flavor.rs?ref=23f177d86d05c8076c692e1c07e325b2161ae893", "patch": "@@ -0,0 +1,10 @@\n+// revisions: bpf ptx\n+// [bpf] compile-flags: --target=bpfel-unknown-none -C linker-flavor=bpf-linker --crate-type=rlib\n+// [bpf] error-pattern: linker flavor `bpf-linker` is unstable, `-Z unstable-options` flag\n+// [bpf] needs-llvm-components:\n+// [ptx] compile-flags: --target=nvptx64-nvidia-cuda -C linker-flavor=ptx-linker --crate-type=rlib\n+// [ptx] error-pattern: linker flavor `ptx-linker` is unstable, `-Z unstable-options` flag\n+// [ptx] needs-llvm-components:\n+\n+#![feature(no_core)]\n+#![no_core]"}]}