{"sha": "c6bd05303c37d354e08278fcdebd95ca7fec9fd9", "node_id": "MDY6Q29tbWl0NzI0NzEyOmM2YmQwNTMwM2MzN2QzNTRlMDgyNzhmY2RlYmQ5NWNhN2ZlYzlmZDk=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-01-28T20:01:44Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-01-28T20:01:44Z"}, "message": "auto merge of #11845 : xales/rust/libnative, r=alexcrichton\n\nFixes std::net test error when re-running too quickly.\r\n\r\nSuggested by @cmr", "tree": {"sha": "8c37176e48710e36989df2aff1be76f5974fa291", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8c37176e48710e36989df2aff1be76f5974fa291"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c6bd05303c37d354e08278fcdebd95ca7fec9fd9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c6bd05303c37d354e08278fcdebd95ca7fec9fd9", "html_url": "https://github.com/rust-lang/rust/commit/c6bd05303c37d354e08278fcdebd95ca7fec9fd9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c6bd05303c37d354e08278fcdebd95ca7fec9fd9/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b3d10f43833f065ec0e635ce6cdb2332f4ee5049", "url": "https://api.github.com/repos/rust-lang/rust/commits/b3d10f43833f065ec0e635ce6cdb2332f4ee5049", "html_url": "https://github.com/rust-lang/rust/commit/b3d10f43833f065ec0e635ce6cdb2332f4ee5049"}, {"sha": "e901c4caf30353f6adf12e6b10a46a4de517ec9d", "url": "https://api.github.com/repos/rust-lang/rust/commits/e901c4caf30353f6adf12e6b10a46a4de517ec9d", "html_url": "https://github.com/rust-lang/rust/commit/e901c4caf30353f6adf12e6b10a46a4de517ec9d"}], "stats": {"total": 55, "additions": 55, "deletions": 0}, "files": [{"sha": "2f4bec22755f6621d0d26902b09eb727a6cccd59", "filename": "src/libnative/io/net.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/c6bd05303c37d354e08278fcdebd95ca7fec9fd9/src%2Flibnative%2Fio%2Fnet.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c6bd05303c37d354e08278fcdebd95ca7fec9fd9/src%2Flibnative%2Fio%2Fnet.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibnative%2Fio%2Fnet.rs?ref=c6bd05303c37d354e08278fcdebd95ca7fec9fd9", "patch": "@@ -348,6 +348,17 @@ impl TcpListener {\n                 let (addr, len) = addr_to_sockaddr(addr);\n                 let addrp = &addr as *libc::sockaddr_storage;\n                 let ret = TcpListener { fd: fd };\n+                // On platforms with Berkeley-derived sockets, this allows\n+                // to quickly rebind a socket, without needing to wait for\n+                // the OS to clean up the previous one.\n+                if cfg!(unix) {\n+                    match setsockopt(fd, libc::SOL_SOCKET,\n+                                     libc::SO_REUSEADDR,\n+                                     1 as libc::c_int) {\n+                        Err(n) => { return Err(n); },\n+                        Ok(..) => { }\n+                    }\n+                }\n                 match libc::bind(fd, addrp as *libc::sockaddr,\n                                  len as libc::socklen_t) {\n                     -1 => Err(super::last_error()),"}, {"sha": "92efc4e9306f3cf102863f772f7899c99ae19d12", "filename": "src/libstd/io/net/tcp.rs", "status": "modified", "additions": 40, "deletions": 0, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/c6bd05303c37d354e08278fcdebd95ca7fec9fd9/src%2Flibstd%2Fio%2Fnet%2Ftcp.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c6bd05303c37d354e08278fcdebd95ca7fec9fd9/src%2Flibstd%2Fio%2Fnet%2Ftcp.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fio%2Fnet%2Ftcp.rs?ref=c6bd05303c37d354e08278fcdebd95ca7fec9fd9", "patch": "@@ -609,4 +609,44 @@ mod test {\n         c.write([1]);\n         p.recv();\n     })\n+\n+    iotest!(fn double_bind() {\n+        let mut called = false;\n+        io_error::cond.trap(|e| {\n+            assert!(e.kind == ConnectionRefused || e.kind == OtherIoError);\n+            called = true;\n+        }).inside(|| {\n+            let addr = next_test_ip4();\n+            let listener = TcpListener::bind(addr).unwrap().listen();\n+            assert!(listener.is_some());\n+            let listener2 = TcpListener::bind(addr).and_then(|l|\n+                                                    l.listen());\n+            assert!(listener2.is_none());\n+        });\n+        assert!(called);\n+    })\n+\n+    iotest!(fn fast_rebind() {\n+        let addr = next_test_ip4();\n+        let (port, chan) = Chan::new();\n+\n+        do spawn {\n+            port.recv();\n+            let stream = TcpStream::connect(addr);\n+            // Close\n+            port.recv();\n+        }\n+\n+        {\n+            let mut acceptor = TcpListener::bind(addr).listen();\n+            chan.send(());\n+            {\n+                let stream = acceptor.accept();\n+                // Close client\n+                chan.send(());\n+            }\n+            // Close listener\n+        }\n+        let listener = TcpListener::bind(addr);\n+    })\n }"}, {"sha": "dccadf2e00b70c0ea9328cc0618dc90e3e3ab685", "filename": "src/libstd/libc.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/c6bd05303c37d354e08278fcdebd95ca7fec9fd9/src%2Flibstd%2Flibc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c6bd05303c37d354e08278fcdebd95ca7fec9fd9/src%2Flibstd%2Flibc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Flibc.rs?ref=c6bd05303c37d354e08278fcdebd95ca7fec9fd9", "patch": "@@ -1547,6 +1547,7 @@ pub mod consts {\n             pub static SOL_SOCKET: c_int = 0xffff;\n             pub static SO_KEEPALIVE: c_int = 8;\n             pub static SO_BROADCAST: c_int = 32;\n+            pub static SO_REUSEADDR: c_int = 4;\n         }\n         pub mod extra {\n             use libc::types::os::arch::c95::c_int;\n@@ -2266,6 +2267,7 @@ pub mod consts {\n             pub static SOL_SOCKET: c_int = 1;\n             pub static SO_KEEPALIVE: c_int = 9;\n             pub static SO_BROADCAST: c_int = 6;\n+            pub static SO_REUSEADDR: c_int = 2;\n         }\n         #[cfg(target_arch = \"x86\")]\n         #[cfg(target_arch = \"x86_64\")]\n@@ -2707,6 +2709,7 @@ pub mod consts {\n             pub static SOL_SOCKET: c_int = 0xffff;\n             pub static SO_KEEPALIVE: c_int = 0x0008;\n             pub static SO_BROADCAST: c_int = 0x0020;\n+            pub static SO_REUSEADDR: c_int = 0x0004;\n         }\n         pub mod extra {\n             use libc::types::os::arch::c95::c_int;\n@@ -3083,6 +3086,7 @@ pub mod consts {\n             pub static SOL_SOCKET: c_int = 0xffff;\n             pub static SO_KEEPALIVE: c_int = 0x0008;\n             pub static SO_BROADCAST: c_int = 0x0020;\n+            pub static SO_REUSEADDR: c_int = 0x0004;\n         }\n         pub mod extra {\n             use libc::types::os::arch::c95::c_int;"}]}