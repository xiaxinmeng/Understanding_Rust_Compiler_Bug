{"sha": "06286ee90b24dcd999513fac86fd1db760f85b15", "node_id": "C_kwDOAAsO6NoAKDA2Mjg2ZWU5MGIyNGRjZDk5OTUxM2ZhYzg2ZmQxZGI3NjBmODViMTU", "commit": {"author": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2021-10-14T19:49:46Z"}, "committer": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2021-10-14T19:49:46Z"}, "message": "Implement promotoe_local_to_const assist", "tree": {"sha": "1f290dee6e453d372ff1827bdaa663ff2c841312", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1f290dee6e453d372ff1827bdaa663ff2c841312"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/06286ee90b24dcd999513fac86fd1db760f85b15", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/06286ee90b24dcd999513fac86fd1db760f85b15", "html_url": "https://github.com/rust-lang/rust/commit/06286ee90b24dcd999513fac86fd1db760f85b15", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/06286ee90b24dcd999513fac86fd1db760f85b15/comments", "author": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f87debcf87c16690e8d5e185a35d03a402a2d5bf", "url": "https://api.github.com/repos/rust-lang/rust/commits/f87debcf87c16690e8d5e185a35d03a402a2d5bf", "html_url": "https://github.com/rust-lang/rust/commit/f87debcf87c16690e8d5e185a35d03a402a2d5bf"}], "stats": {"total": 291, "additions": 280, "deletions": 11}, "files": [{"sha": "f4778054ee6e6bc9fd93a2b0779b5dc1d343babb", "filename": "crates/hir/src/lib.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/06286ee90b24dcd999513fac86fd1db760f85b15/crates%2Fhir%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/06286ee90b24dcd999513fac86fd1db760f85b15/crates%2Fhir%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Flib.rs?ref=06286ee90b24dcd999513fac86fd1db760f85b15", "patch": "@@ -1307,6 +1307,10 @@ impl Function {\n         db.function_data(self.id).is_unsafe()\n     }\n \n+    pub fn is_const(self, db: &dyn HirDatabase) -> bool {\n+        db.function_data(self.id).is_const()\n+    }\n+\n     pub fn is_async(self, db: &dyn HirDatabase) -> bool {\n         db.function_data(self.id).is_async()\n     }"}, {"sha": "879247d37ee2fd3e8bb0337739df9ac959596b8b", "filename": "crates/ide_assists/src/handlers/promote_local_to_const.rs", "status": "added", "additions": 221, "deletions": 0, "changes": 221, "blob_url": "https://github.com/rust-lang/rust/blob/06286ee90b24dcd999513fac86fd1db760f85b15/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fpromote_local_to_const.rs", "raw_url": "https://github.com/rust-lang/rust/raw/06286ee90b24dcd999513fac86fd1db760f85b15/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fpromote_local_to_const.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fpromote_local_to_const.rs?ref=06286ee90b24dcd999513fac86fd1db760f85b15", "patch": "@@ -0,0 +1,221 @@\n+use hir::{HirDisplay, ModuleDef, PathResolution, Semantics};\n+use ide_db::{\n+    assists::{AssistId, AssistKind},\n+    defs::Definition,\n+    helpers::node_ext::preorder_expr,\n+    RootDatabase,\n+};\n+use stdx::to_upper_snake_case;\n+use syntax::{\n+    ast::{self, make, HasName},\n+    AstNode, WalkEvent,\n+};\n+\n+use crate::{\n+    assist_context::{AssistContext, Assists},\n+    utils::{render_snippet, Cursor},\n+};\n+\n+// Assist: promote_local_to_const\n+//\n+// Promotes a local variable to a const item changing its name to a `SCREAMING_SNAKE_CASE` variant\n+// if the local uses no non-const expressions.\n+//\n+// ```\n+// fn main() {\n+//     let foo$0 = true;\n+//\n+//     if foo {\n+//         println!(\"It's true\");\n+//     } else {\n+//         println!(\"It's false\");\n+//     }\n+// }\n+// ```\n+// ->\n+// ```\n+// fn main() {\n+//     const $0FOO: bool = true;\n+//\n+//     if FOO {\n+//         println!(\"It's true\");\n+//     } else {\n+//         println!(\"It's false\");\n+//     }\n+// }\n+// ```\n+pub(crate) fn promote_local_to_const(acc: &mut Assists, ctx: &AssistContext) -> Option<()> {\n+    let pat = ctx.find_node_at_offset::<ast::IdentPat>()?;\n+    let name = pat.name()?;\n+    if !pat.is_simple_ident() {\n+        cov_mark::hit!(promote_local_non_simple_ident);\n+        return None;\n+    }\n+    let let_stmt = pat.syntax().parent().and_then(ast::LetStmt::cast)?;\n+\n+    let module = ctx.sema.scope(pat.syntax()).module()?;\n+    let local = ctx.sema.to_def(&pat)?;\n+    let ty = ctx.sema.type_of_pat(&pat.into())?.original;\n+\n+    if ty.contains_unknown() || ty.is_closure() {\n+        cov_mark::hit!(promote_lcoal_not_applicable_if_ty_not_inferred);\n+        return None;\n+    }\n+    let ty = ty.display_source_code(ctx.db(), module.into()).ok()?;\n+\n+    let initializer = let_stmt.initializer()?;\n+    if !is_body_const(&ctx.sema, &initializer) {\n+        cov_mark::hit!(promote_local_non_const);\n+        return None;\n+    }\n+    let target = let_stmt.syntax().text_range();\n+    acc.add(\n+        AssistId(\"promote_local_to_const\", AssistKind::Refactor),\n+        \"Promote local to constant\",\n+        target,\n+        |builder| {\n+            let name = to_upper_snake_case(&name.to_string());\n+            let usages = Definition::Local(local).usages(&ctx.sema).all();\n+            if let Some(usages) = usages.references.get(&ctx.file_id()) {\n+                for usage in usages {\n+                    builder.replace(usage.range, &name);\n+                }\n+            }\n+\n+            let item = make::item_const(None, make::name(&name), make::ty(&ty), initializer);\n+            match ctx.config.snippet_cap.zip(item.name()) {\n+                Some((cap, name)) => builder.replace_snippet(\n+                    cap,\n+                    target,\n+                    render_snippet(cap, item.syntax(), Cursor::Before(name.syntax())),\n+                ),\n+                None => builder.replace(target, item.to_string()),\n+            }\n+        },\n+    )\n+}\n+\n+fn is_body_const(sema: &Semantics<RootDatabase>, expr: &ast::Expr) -> bool {\n+    let mut is_const = true;\n+    preorder_expr(expr, &mut |ev| {\n+        let expr = match ev {\n+            WalkEvent::Enter(_) if !is_const => return true,\n+            WalkEvent::Enter(expr) => expr,\n+            WalkEvent::Leave(_) => return false,\n+        };\n+        match expr {\n+            ast::Expr::CallExpr(call) => {\n+                if let Some(ast::Expr::PathExpr(path_expr)) = call.expr() {\n+                    if let Some(PathResolution::Def(ModuleDef::Function(func))) =\n+                        path_expr.path().and_then(|path| sema.resolve_path(&path))\n+                    {\n+                        is_const &= func.is_const(sema.db);\n+                    }\n+                }\n+            }\n+            ast::Expr::MethodCallExpr(call) => {\n+                is_const &=\n+                    sema.resolve_method_call(&call).map(|it| it.is_const(sema.db)).unwrap_or(true)\n+            }\n+            ast::Expr::BoxExpr(_)\n+            | ast::Expr::ForExpr(_)\n+            | ast::Expr::ReturnExpr(_)\n+            | ast::Expr::TryExpr(_)\n+            | ast::Expr::YieldExpr(_)\n+            | ast::Expr::AwaitExpr(_) => is_const = false,\n+            _ => (),\n+        }\n+        !is_const\n+    });\n+    is_const\n+}\n+\n+#[cfg(test)]\n+mod tests {\n+    use crate::tests::{check_assist, check_assist_not_applicable};\n+\n+    use super::*;\n+\n+    #[test]\n+    fn simple() {\n+        check_assist(\n+            promote_local_to_const,\n+            r\"\n+fn foo() {\n+    let x$0 = 0;\n+    let y = x;\n+}\n+\",\n+            r\"\n+fn foo() {\n+    const $0X: i32 = 0;\n+    let y = X;\n+}\n+\",\n+        );\n+    }\n+\n+    #[test]\n+    fn not_applicable_non_const_meth_call() {\n+        cov_mark::check!(promote_local_non_const);\n+        check_assist_not_applicable(\n+            promote_local_to_const,\n+            r\"\n+struct Foo;\n+impl Foo {\n+    fn foo(self) {}\n+}\n+fn foo() {\n+    let x$0 = Foo.foo();\n+}\n+\",\n+        );\n+    }\n+\n+    #[test]\n+    fn not_applicable_non_const_call() {\n+        check_assist_not_applicable(\n+            promote_local_to_const,\n+            r\"\n+fn bar(self) {}\n+fn foo() {\n+    let x$0 = bar();\n+}\n+\",\n+        );\n+    }\n+\n+    #[test]\n+    fn not_applicable_unknown_ty() {\n+        cov_mark::check!(promote_lcoal_not_applicable_if_ty_not_inferred);\n+        check_assist_not_applicable(\n+            promote_local_to_const,\n+            r\"\n+fn foo() {\n+    let x$0 = bar();\n+}\n+\",\n+        );\n+    }\n+\n+    #[test]\n+    fn not_applicable_non_simple_ident() {\n+        cov_mark::check!(promote_local_non_simple_ident);\n+        check_assist_not_applicable(\n+            promote_local_to_const,\n+            r\"\n+fn foo() {\n+    let ref x$0 = ();\n+}\n+\",\n+        );\n+        check_assist_not_applicable(\n+            promote_local_to_const,\n+            r\"\n+fn foo() {\n+    let mut x$0 = ();\n+}\n+\",\n+        );\n+    }\n+}"}, {"sha": "41f768c3175d01ed64d0b03dd144a2bda364e4ff", "filename": "crates/ide_assists/src/handlers/raw_string.rs", "status": "modified", "additions": 11, "deletions": 11, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/06286ee90b24dcd999513fac86fd1db760f85b15/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fraw_string.rs", "raw_url": "https://github.com/rust-lang/rust/raw/06286ee90b24dcd999513fac86fd1db760f85b15/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fraw_string.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fraw_string.rs?ref=06286ee90b24dcd999513fac86fd1db760f85b15", "patch": "@@ -168,23 +168,23 @@ fn required_hashes(s: &str) -> usize {\n     res\n }\n \n-#[test]\n-fn test_required_hashes() {\n-    assert_eq!(0, required_hashes(\"abc\"));\n-    assert_eq!(0, required_hashes(\"###\"));\n-    assert_eq!(1, required_hashes(\"\\\"\"));\n-    assert_eq!(2, required_hashes(\"\\\"#abc\"));\n-    assert_eq!(0, required_hashes(\"#abc\"));\n-    assert_eq!(3, required_hashes(\"#ab\\\"##c\"));\n-    assert_eq!(5, required_hashes(\"#ab\\\"##\\\"####c\"));\n-}\n-\n #[cfg(test)]\n mod tests {\n     use crate::tests::{check_assist, check_assist_not_applicable, check_assist_target};\n \n     use super::*;\n \n+    #[test]\n+    fn test_required_hashes() {\n+        assert_eq!(0, required_hashes(\"abc\"));\n+        assert_eq!(0, required_hashes(\"###\"));\n+        assert_eq!(1, required_hashes(\"\\\"\"));\n+        assert_eq!(2, required_hashes(\"\\\"#abc\"));\n+        assert_eq!(0, required_hashes(\"#abc\"));\n+        assert_eq!(3, required_hashes(\"#ab\\\"##c\"));\n+        assert_eq!(5, required_hashes(\"#ab\\\"##\\\"####c\"));\n+    }\n+\n     #[test]\n     fn make_raw_string_target() {\n         check_assist_target("}, {"sha": "55ab6470ea3fed59b2cb2beed1e300c11e897f31", "filename": "crates/ide_assists/src/lib.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/06286ee90b24dcd999513fac86fd1db760f85b15/crates%2Fide_assists%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/06286ee90b24dcd999513fac86fd1db760f85b15/crates%2Fide_assists%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_assists%2Fsrc%2Flib.rs?ref=06286ee90b24dcd999513fac86fd1db760f85b15", "patch": "@@ -156,6 +156,7 @@ mod handlers {\n     mod move_module_to_file;\n     mod move_to_mod_rs;\n     mod move_from_mod_rs;\n+    mod promote_local_to_const;\n     mod pull_assignment_up;\n     mod qualify_path;\n     mod raw_string;\n@@ -235,6 +236,7 @@ mod handlers {\n             move_to_mod_rs::move_to_mod_rs,\n             move_from_mod_rs::move_from_mod_rs,\n             pull_assignment_up::pull_assignment_up,\n+            promote_local_to_const::promote_local_to_const,\n             qualify_path::qualify_path,\n             raw_string::add_hash,\n             raw_string::make_usual_string,"}, {"sha": "3ada169dea53e962d416c4ac02aacfa1dd643812", "filename": "crates/ide_assists/src/tests/generated.rs", "status": "modified", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/06286ee90b24dcd999513fac86fd1db760f85b15/crates%2Fide_assists%2Fsrc%2Ftests%2Fgenerated.rs", "raw_url": "https://github.com/rust-lang/rust/raw/06286ee90b24dcd999513fac86fd1db760f85b15/crates%2Fide_assists%2Fsrc%2Ftests%2Fgenerated.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_assists%2Fsrc%2Ftests%2Fgenerated.rs?ref=06286ee90b24dcd999513fac86fd1db760f85b15", "patch": "@@ -1394,6 +1394,35 @@ fn t() {}\n     )\n }\n \n+#[test]\n+fn doctest_promote_local_to_const() {\n+    check_doc_test(\n+        \"promote_local_to_const\",\n+        r#####\"\n+fn main() {\n+    let foo$0 = true;\n+\n+    if foo {\n+        println!(\"It's true\");\n+    } else {\n+        println!(\"It's false\");\n+    }\n+}\n+\"#####,\n+        r#####\"\n+fn main() {\n+    const $0FOO: bool = true;\n+\n+    if FOO {\n+        println!(\"It's true\");\n+    } else {\n+        println!(\"It's false\");\n+    }\n+}\n+\"#####,\n+    )\n+}\n+\n #[test]\n fn doctest_pull_assignment_up() {\n     check_doc_test("}, {"sha": "f5fcf19a23d77346ae3f7e9d3566fcc8388c5a64", "filename": "crates/syntax/src/ast/make.rs", "status": "modified", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/06286ee90b24dcd999513fac86fd1db760f85b15/crates%2Fsyntax%2Fsrc%2Fast%2Fmake.rs", "raw_url": "https://github.com/rust-lang/rust/raw/06286ee90b24dcd999513fac86fd1db760f85b15/crates%2Fsyntax%2Fsrc%2Fast%2Fmake.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fsyntax%2Fsrc%2Fast%2Fmake.rs?ref=06286ee90b24dcd999513fac86fd1db760f85b15", "patch": "@@ -555,6 +555,19 @@ pub fn expr_stmt(expr: ast::Expr) -> ast::ExprStmt {\n     ast_from_text(&format!(\"fn f() {{ {}{} (); }}\", expr, semi))\n }\n \n+pub fn item_const(\n+    visibility: Option<ast::Visibility>,\n+    name: ast::Name,\n+    ty: ast::Type,\n+    expr: ast::Expr,\n+) -> ast::Const {\n+    let visibility = match visibility {\n+        None => String::new(),\n+        Some(it) => format!(\"{} \", it),\n+    };\n+    ast_from_text(&format!(\"{} const {}: {} = {};\", visibility, name, ty, expr))\n+}\n+\n pub fn param(pat: ast::Pat, ty: ast::Type) -> ast::Param {\n     ast_from_text(&format!(\"fn f({}: {}) {{ }}\", pat, ty))\n }"}]}