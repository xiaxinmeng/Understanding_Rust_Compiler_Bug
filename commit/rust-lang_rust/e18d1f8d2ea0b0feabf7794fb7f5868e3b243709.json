{"sha": "e18d1f8d2ea0b0feabf7794fb7f5868e3b243709", "node_id": "C_kwDOAAsO6NoAKGUxOGQxZjhkMmVhMGIwZmVhYmY3Nzk0ZmI3ZjU4NjhlM2IyNDM3MDk", "commit": {"author": {"name": "Oli Scherer", "email": "git-spam-no-reply9815368754983@oli-obk.de", "date": "2023-02-16T15:28:29Z"}, "committer": {"name": "Oli Scherer", "email": "git-spam-no-reply9815368754983@oli-obk.de", "date": "2023-04-21T22:12:45Z"}, "message": "Leave it to the query system to invoke the typeck query instead of invoking it eagerly.\n\nLater queries that are run on all body owners will invoke typeck as they need information from its result to perform their own logic", "tree": {"sha": "dc74e887e740c042081050ffbee08a84103cdea4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/dc74e887e740c042081050ffbee08a84103cdea4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e18d1f8d2ea0b0feabf7794fb7f5868e3b243709", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e18d1f8d2ea0b0feabf7794fb7f5868e3b243709", "html_url": "https://github.com/rust-lang/rust/commit/e18d1f8d2ea0b0feabf7794fb7f5868e3b243709", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e18d1f8d2ea0b0feabf7794fb7f5868e3b243709/comments", "author": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "committer": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "409661936f929b254ffc8adb644cf35d1f9765c4", "url": "https://api.github.com/repos/rust-lang/rust/commits/409661936f929b254ffc8adb644cf35d1f9765c4", "html_url": "https://github.com/rust-lang/rust/commit/409661936f929b254ffc8adb644cf35d1f9765c4"}], "stats": {"total": 31, "additions": 3, "deletions": 28}, "files": [{"sha": "a4b797f77f7fe59d7b63f10f8ecaf120fd59b6f1", "filename": "compiler/rustc_hir_analysis/src/lib.rs", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e18d1f8d2ea0b0feabf7794fb7f5868e3b243709/compiler%2Frustc_hir_analysis%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e18d1f8d2ea0b0feabf7794fb7f5868e3b243709/compiler%2Frustc_hir_analysis%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_analysis%2Fsrc%2Flib.rs?ref=e18d1f8d2ea0b0feabf7794fb7f5868e3b243709", "patch": "@@ -496,8 +496,6 @@ pub fn check_crate(tcx: TyCtxt<'_>) -> Result<(), ErrorGuaranteed> {\n         tcx.hir().for_each_module(|module| tcx.ensure().check_mod_item_types(module))\n     });\n \n-    tcx.sess.time(\"item_bodies_checking\", || tcx.typeck_item_bodies(()));\n-\n     check_unused::check_crate(tcx);\n     check_for_entry_fn(tcx);\n "}, {"sha": "5ccac9a69252da9b32473d1ebbc4ff8ac3422fbe", "filename": "compiler/rustc_hir_typeck/src/lib.rs", "status": "modified", "additions": 0, "deletions": 5, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/e18d1f8d2ea0b0feabf7794fb7f5868e3b243709/compiler%2Frustc_hir_typeck%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e18d1f8d2ea0b0feabf7794fb7f5868e3b243709/compiler%2Frustc_hir_typeck%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Flib.rs?ref=e18d1f8d2ea0b0feabf7794fb7f5868e3b243709", "patch": "@@ -152,10 +152,6 @@ fn used_trait_imports(tcx: TyCtxt<'_>, def_id: LocalDefId) -> &UnordSet<LocalDef\n     &*tcx.typeck(def_id).used_trait_imports\n }\n \n-fn typeck_item_bodies(tcx: TyCtxt<'_>, (): ()) {\n-    tcx.hir().par_body_owners(|body_owner_def_id| tcx.ensure().typeck(body_owner_def_id));\n-}\n-\n fn typeck<'tcx>(tcx: TyCtxt<'tcx>, def_id: LocalDefId) -> &ty::TypeckResults<'tcx> {\n     let fallback = move || tcx.type_of(def_id.to_def_id()).subst_identity();\n     typeck_with_fallback(tcx, def_id, fallback)\n@@ -479,7 +475,6 @@ fn has_expected_num_generic_args(\n pub fn provide(providers: &mut Providers) {\n     method::provide(providers);\n     *providers = Providers {\n-        typeck_item_bodies,\n         typeck,\n         diagnostic_only_typeck,\n         has_typeck_results,"}, {"sha": "3b8f833a9bd6a304ce998b0f7fad9de6aff5b203", "filename": "compiler/rustc_middle/src/query/mod.rs", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/e18d1f8d2ea0b0feabf7794fb7f5868e3b243709/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e18d1f8d2ea0b0feabf7794fb7f5868e3b243709/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs?ref=e18d1f8d2ea0b0feabf7794fb7f5868e3b243709", "patch": "@@ -871,10 +871,6 @@ rustc_queries! {\n         separate_provide_extern\n     }\n \n-    query typeck_item_bodies(_: ()) -> () {\n-        desc { \"type-checking all item bodies\" }\n-    }\n-\n     query typeck(key: LocalDefId) -> &'tcx ty::TypeckResults<'tcx> {\n         desc { |tcx| \"type-checking `{}`\", tcx.def_path_str(key.to_def_id()) }\n         cache_on_disk_if { true }"}, {"sha": "46834a1d7f4e9b949f3c35f7f0897058b93fcbc8", "filename": "src/librustdoc/core.rs", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e18d1f8d2ea0b0feabf7794fb7f5868e3b243709/src%2Flibrustdoc%2Fcore.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e18d1f8d2ea0b0feabf7794fb7f5868e3b243709/src%2Flibrustdoc%2Fcore.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fcore.rs?ref=e18d1f8d2ea0b0feabf7794fb7f5868e3b243709", "patch": "@@ -258,8 +258,6 @@ pub(crate) fn create_config(\n         override_queries: Some(|_sess, providers, _external_providers| {\n             // Most lints will require typechecking, so just don't run them.\n             providers.lint_mod = |_, _| {};\n-            // Prevent `rustc_hir_analysis::check_crate` from calling `typeck` on all bodies.\n-            providers.typeck_item_bodies = |_, _| {};\n             // hack so that `used_trait_imports` won't try to call typeck\n             providers.used_trait_imports = |_, _| {\n                 static EMPTY_SET: LazyLock<UnordSet<LocalDefId>> = LazyLock::new(UnordSet::default);"}, {"sha": "1648cfb266b5652fc23c0e125b92378215f854c8", "filename": "tests/ui/associated-inherent-types/bugs/ice-substitution.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e18d1f8d2ea0b0feabf7794fb7f5868e3b243709/tests%2Fui%2Fassociated-inherent-types%2Fbugs%2Fice-substitution.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e18d1f8d2ea0b0feabf7794fb7f5868e3b243709/tests%2Fui%2Fassociated-inherent-types%2Fbugs%2Fice-substitution.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fassociated-inherent-types%2Fbugs%2Fice-substitution.stderr?ref=e18d1f8d2ea0b0feabf7794fb7f5868e3b243709", "patch": "@@ -2,5 +2,5 @@ error: the compiler unexpectedly panicked. this is a bug.\n \n query stack during panic:\n #0 [typeck] type-checking `weird`\n-#1 [typeck_item_bodies] type-checking all item bodies\n+#1 [used_trait_imports] finding used_trait_imports `weird`\n end of query stack"}, {"sha": "c2a33ce1f59b38549e5fd6196863f26ff25481ea", "filename": "tests/ui/privacy/privacy2.stderr", "status": "modified", "additions": 1, "deletions": 7, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/e18d1f8d2ea0b0feabf7794fb7f5868e3b243709/tests%2Fui%2Fprivacy%2Fprivacy2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e18d1f8d2ea0b0feabf7794fb7f5868e3b243709/tests%2Fui%2Fprivacy%2Fprivacy2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fprivacy%2Fprivacy2.stderr?ref=e18d1f8d2ea0b0feabf7794fb7f5868e3b243709", "patch": "@@ -23,13 +23,7 @@ LL | pub fn foo() {}\n \n error: requires `sized` lang_item\n \n-error: requires `sized` lang_item\n-\n-error: requires `sized` lang_item\n-\n-error: requires `sized` lang_item\n-\n-error: aborting due to 6 previous errors\n+error: aborting due to 3 previous errors\n \n Some errors have detailed explanations: E0432, E0603.\n For more information about an error, try `rustc --explain E0432`."}, {"sha": "22c1e48b07d947391692d0596ed413658362a724", "filename": "tests/ui/privacy/privacy3.stderr", "status": "modified", "additions": 1, "deletions": 7, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/e18d1f8d2ea0b0feabf7794fb7f5868e3b243709/tests%2Fui%2Fprivacy%2Fprivacy3.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e18d1f8d2ea0b0feabf7794fb7f5868e3b243709/tests%2Fui%2Fprivacy%2Fprivacy3.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fprivacy%2Fprivacy3.stderr?ref=e18d1f8d2ea0b0feabf7794fb7f5868e3b243709", "patch": "@@ -6,12 +6,6 @@ LL |     use bar::gpriv;\n \n error: requires `sized` lang_item\n \n-error: requires `sized` lang_item\n-\n-error: requires `sized` lang_item\n-\n-error: requires `sized` lang_item\n-\n-error: aborting due to 5 previous errors\n+error: aborting due to 2 previous errors\n \n For more information about this error, try `rustc --explain E0432`."}]}