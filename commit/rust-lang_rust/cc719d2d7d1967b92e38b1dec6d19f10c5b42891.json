{"sha": "cc719d2d7d1967b92e38b1dec6d19f10c5b42891", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNjNzE5ZDJkN2QxOTY3YjkyZTM4YjFkZWM2ZDE5ZjEwYzViNDI4OTE=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2016-02-11T19:06:31Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2016-02-14T19:45:59Z"}, "message": "trans: Don't link whole rlibs to executables\n\nBack in 9bc8e6d14 the linking of rlibs changed to using the `link_whole_rlib`\nfunction. This change, however was only intended to affect dylibs, not\nexecutables. For executables we don't actually want to link entire rlibs because\nwe want the linker to strip out as much as possible.\n\nThis commit adds a conditional to this logic to only link entire rlibs if we're\ncreating a dylib, and otherwise an executable just links an rlib as usual. A\ntest is included which will fail to link if this behavior is reverted.", "tree": {"sha": "be6e36c82df4d0a9449bba55002136ef9c9044ca", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/be6e36c82df4d0a9449bba55002136ef9c9044ca"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cc719d2d7d1967b92e38b1dec6d19f10c5b42891", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cc719d2d7d1967b92e38b1dec6d19f10c5b42891", "html_url": "https://github.com/rust-lang/rust/commit/cc719d2d7d1967b92e38b1dec6d19f10c5b42891", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cc719d2d7d1967b92e38b1dec6d19f10c5b42891/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "12a68e6af31a32c52785298f036543caa96d24d3", "url": "https://api.github.com/repos/rust-lang/rust/commits/12a68e6af31a32c52785298f036543caa96d24d3", "html_url": "https://github.com/rust-lang/rust/commit/12a68e6af31a32c52785298f036543caa96d24d3"}], "stats": {"total": 110, "additions": 109, "deletions": 1}, "files": [{"sha": "33734d615a621fd16375e1bd70718daf8e0fbf39", "filename": "src/librustc_trans/back/link.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/cc719d2d7d1967b92e38b1dec6d19f10c5b42891/src%2Flibrustc_trans%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cc719d2d7d1967b92e38b1dec6d19f10c5b42891/src%2Flibrustc_trans%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fback%2Flink.rs?ref=cc719d2d7d1967b92e38b1dec6d19f10c5b42891", "patch": "@@ -1253,7 +1253,11 @@ fn add_upstream_rust_crates(cmd: &mut Linker, sess: &Session,\n \n             if any_objects {\n                 archive.build();\n-                cmd.link_whole_rlib(&fix_windows_verbatim_for_gcc(&dst));\n+                if dylib {\n+                    cmd.link_whole_rlib(&fix_windows_verbatim_for_gcc(&dst));\n+                } else {\n+                    cmd.link_rlib(&fix_windows_verbatim_for_gcc(&dst));\n+                }\n             }\n         });\n     }"}, {"sha": "1d45cb413c5770e0d750a60050dd3d3e278d8799", "filename": "src/test/run-make/lto-no-link-whole-rlib/Makefile", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/cc719d2d7d1967b92e38b1dec6d19f10c5b42891/src%2Ftest%2Frun-make%2Flto-no-link-whole-rlib%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/cc719d2d7d1967b92e38b1dec6d19f10c5b42891/src%2Ftest%2Frun-make%2Flto-no-link-whole-rlib%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Flto-no-link-whole-rlib%2FMakefile?ref=cc719d2d7d1967b92e38b1dec6d19f10c5b42891", "patch": "@@ -0,0 +1,18 @@\n+# Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n+# file at the top-level directory of this distribution and at\n+# http://rust-lang.org/COPYRIGHT.\n+#\n+# Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+# http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+# <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+# option. This file may not be copied, modified, or distributed\n+# except according to those terms.\n+\n+-include ../tools.mk\n+\n+all: $(call NATIVE_STATICLIB,foo) $(call NATIVE_STATICLIB,bar)\n+\t$(RUSTC) lib1.rs\n+\t$(RUSTC) lib2.rs\n+\t$(RUSTC) main.rs -Clto\n+\t$(call RUN,main)\n+"}, {"sha": "716d1abcf347f482ea5adc6162686fc5fa527395", "filename": "src/test/run-make/lto-no-link-whole-rlib/bar.c", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/cc719d2d7d1967b92e38b1dec6d19f10c5b42891/src%2Ftest%2Frun-make%2Flto-no-link-whole-rlib%2Fbar.c", "raw_url": "https://github.com/rust-lang/rust/raw/cc719d2d7d1967b92e38b1dec6d19f10c5b42891/src%2Ftest%2Frun-make%2Flto-no-link-whole-rlib%2Fbar.c", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Flto-no-link-whole-rlib%2Fbar.c?ref=cc719d2d7d1967b92e38b1dec6d19f10c5b42891", "patch": "@@ -0,0 +1,13 @@\n+// Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+int foo() {\n+  return 2;\n+}"}, {"sha": "1b36874581a99299ddcb821913dce5ab9723e214", "filename": "src/test/run-make/lto-no-link-whole-rlib/foo.c", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/cc719d2d7d1967b92e38b1dec6d19f10c5b42891/src%2Ftest%2Frun-make%2Flto-no-link-whole-rlib%2Ffoo.c", "raw_url": "https://github.com/rust-lang/rust/raw/cc719d2d7d1967b92e38b1dec6d19f10c5b42891/src%2Ftest%2Frun-make%2Flto-no-link-whole-rlib%2Ffoo.c", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Flto-no-link-whole-rlib%2Ffoo.c?ref=cc719d2d7d1967b92e38b1dec6d19f10c5b42891", "patch": "@@ -0,0 +1,13 @@\n+// Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+int foo() {\n+  return 1;\n+}"}, {"sha": "0a87c8e47255849a924b6c9bcc10495278b1fdcb", "filename": "src/test/run-make/lto-no-link-whole-rlib/lib1.rs", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/cc719d2d7d1967b92e38b1dec6d19f10c5b42891/src%2Ftest%2Frun-make%2Flto-no-link-whole-rlib%2Flib1.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cc719d2d7d1967b92e38b1dec6d19f10c5b42891/src%2Ftest%2Frun-make%2Flto-no-link-whole-rlib%2Flib1.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Flto-no-link-whole-rlib%2Flib1.rs?ref=cc719d2d7d1967b92e38b1dec6d19f10c5b42891", "patch": "@@ -0,0 +1,20 @@\n+// Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![crate_type = \"rlib\"]\n+\n+#[link(name = \"foo\", kind = \"static\")]\n+extern {\n+    fn foo() -> i32;\n+}\n+\n+pub fn foo1() -> i32 {\n+    unsafe { foo() }\n+}"}, {"sha": "6e3f382b3fd92cabc06e49c31ad99d6ed311d2f1", "filename": "src/test/run-make/lto-no-link-whole-rlib/lib2.rs", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/cc719d2d7d1967b92e38b1dec6d19f10c5b42891/src%2Ftest%2Frun-make%2Flto-no-link-whole-rlib%2Flib2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cc719d2d7d1967b92e38b1dec6d19f10c5b42891/src%2Ftest%2Frun-make%2Flto-no-link-whole-rlib%2Flib2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Flto-no-link-whole-rlib%2Flib2.rs?ref=cc719d2d7d1967b92e38b1dec6d19f10c5b42891", "patch": "@@ -0,0 +1,23 @@\n+// Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![crate_type = \"rlib\"]\n+\n+extern crate lib1;\n+\n+#[link(name = \"bar\", kind = \"static\")]\n+extern {\n+    fn foo() -> i32;\n+}\n+\n+pub fn foo2() -> i32 {\n+    unsafe { foo() }\n+}\n+"}, {"sha": "8417af63be9d9a560aaf5519fd7856cfb6975e8f", "filename": "src/test/run-make/lto-no-link-whole-rlib/main.rs", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/cc719d2d7d1967b92e38b1dec6d19f10c5b42891/src%2Ftest%2Frun-make%2Flto-no-link-whole-rlib%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cc719d2d7d1967b92e38b1dec6d19f10c5b42891/src%2Ftest%2Frun-make%2Flto-no-link-whole-rlib%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Flto-no-link-whole-rlib%2Fmain.rs?ref=cc719d2d7d1967b92e38b1dec6d19f10c5b42891", "patch": "@@ -0,0 +1,17 @@\n+// Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+extern crate lib1;\n+extern crate lib2;\n+\n+fn main() {\n+    assert_eq!(lib1::foo1(), 2);\n+    assert_eq!(lib2::foo2(), 2);\n+}"}]}