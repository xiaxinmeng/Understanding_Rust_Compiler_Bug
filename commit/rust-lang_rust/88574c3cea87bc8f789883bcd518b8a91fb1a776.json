{"sha": "88574c3cea87bc8f789883bcd518b8a91fb1a776", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg4NTc0YzNjZWE4N2JjOGY3ODk4ODNiY2Q1MThiOGE5MWZiMWE3NzY=", "commit": {"author": {"name": "Patrick Walton", "email": "pcwalton@mimiga.net", "date": "2011-07-16T01:37:57Z"}, "committer": {"name": "Patrick Walton", "email": "pcwalton@mimiga.net", "date": "2011-07-16T01:37:57Z"}, "message": "rustc: Implement interior string logging in DPS", "tree": {"sha": "f2dcff20295f232fa00932383d9bfd3d3e83911d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f2dcff20295f232fa00932383d9bfd3d3e83911d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/88574c3cea87bc8f789883bcd518b8a91fb1a776", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/88574c3cea87bc8f789883bcd518b8a91fb1a776", "html_url": "https://github.com/rust-lang/rust/commit/88574c3cea87bc8f789883bcd518b8a91fb1a776", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/88574c3cea87bc8f789883bcd518b8a91fb1a776/comments", "author": {"login": "pcwalton", "id": 157897, "node_id": "MDQ6VXNlcjE1Nzg5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/157897?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pcwalton", "html_url": "https://github.com/pcwalton", "followers_url": "https://api.github.com/users/pcwalton/followers", "following_url": "https://api.github.com/users/pcwalton/following{/other_user}", "gists_url": "https://api.github.com/users/pcwalton/gists{/gist_id}", "starred_url": "https://api.github.com/users/pcwalton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pcwalton/subscriptions", "organizations_url": "https://api.github.com/users/pcwalton/orgs", "repos_url": "https://api.github.com/users/pcwalton/repos", "events_url": "https://api.github.com/users/pcwalton/events{/privacy}", "received_events_url": "https://api.github.com/users/pcwalton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pcwalton", "id": 157897, "node_id": "MDQ6VXNlcjE1Nzg5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/157897?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pcwalton", "html_url": "https://github.com/pcwalton", "followers_url": "https://api.github.com/users/pcwalton/followers", "following_url": "https://api.github.com/users/pcwalton/following{/other_user}", "gists_url": "https://api.github.com/users/pcwalton/gists{/gist_id}", "starred_url": "https://api.github.com/users/pcwalton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pcwalton/subscriptions", "organizations_url": "https://api.github.com/users/pcwalton/orgs", "repos_url": "https://api.github.com/users/pcwalton/repos", "events_url": "https://api.github.com/users/pcwalton/events{/privacy}", "received_events_url": "https://api.github.com/users/pcwalton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f6f7f6190809d698f39f5f3dde9a10cb28661795", "url": "https://api.github.com/repos/rust-lang/rust/commits/f6f7f6190809d698f39f5f3dde9a10cb28661795", "html_url": "https://github.com/rust-lang/rust/commit/f6f7f6190809d698f39f5f3dde9a10cb28661795"}], "stats": {"total": 24, "additions": 21, "deletions": 3}, "files": [{"sha": "4c6b051b9a8549f66f24a6777d28a6c23f1b97b2", "filename": "src/comp/back/upcall.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/88574c3cea87bc8f789883bcd518b8a91fb1a776/src%2Fcomp%2Fback%2Fupcall.rs", "raw_url": "https://github.com/rust-lang/rust/raw/88574c3cea87bc8f789883bcd518b8a91fb1a776/src%2Fcomp%2Fback%2Fupcall.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomp%2Fback%2Fupcall.rs?ref=88574c3cea87bc8f789883bcd518b8a91fb1a776", "patch": "@@ -8,6 +8,7 @@ import middle::trans_common::T_bool;\n import middle::trans_common::T_i8;\n import middle::trans_common::T_i32;\n import middle::trans_common::T_int;\n+import middle::trans_common::T_ivec;\n import middle::trans_common::T_nil;\n import middle::trans_common::T_opaque_chan_ptr;\n import middle::trans_common::T_opaque_ivec;\n@@ -28,6 +29,7 @@ type upcalls =\n         ValueRef log_float,\n         ValueRef log_double,\n         ValueRef log_str,\n+        ValueRef log_istr,\n         ValueRef trace_word,\n         ValueRef trace_str,\n         ValueRef new_port,\n@@ -82,6 +84,7 @@ fn declare_upcalls(type_names tn, TypeRef tydesc_type, TypeRef taskptr_type,\n              log_float=dv(\"log_float\", ~[T_i32(), T_f32()]),\n              log_double=dv(\"log_double\", ~[T_i32(), T_ptr(T_f64())]),\n              log_str=dv(\"log_str\", ~[T_i32(), T_ptr(T_str())]),\n+             log_istr=dv(\"log_istr\", ~[T_i32(), T_ptr(T_ivec(T_i8()))]),\n              trace_word=dv(\"trace_word\", ~[T_int()]),\n              trace_str=dv(\"trace_str\", ~[T_ptr(T_i8())]),\n              new_port=d(\"new_port\", ~[T_size_t()], T_opaque_port_ptr()),"}, {"sha": "6aecf83bd695ebbcdadc90d194006687a3434f1c", "filename": "src/comp/middle/trans_dps.rs", "status": "modified", "additions": 7, "deletions": 3, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/88574c3cea87bc8f789883bcd518b8a91fb1a776/src%2Fcomp%2Fmiddle%2Ftrans_dps.rs", "raw_url": "https://github.com/rust-lang/rust/raw/88574c3cea87bc8f789883bcd518b8a91fb1a776/src%2Fcomp%2Fmiddle%2Ftrans_dps.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomp%2Fmiddle%2Ftrans_dps.rs?ref=88574c3cea87bc8f789883bcd518b8a91fb1a776", "patch": "@@ -222,6 +222,9 @@ fn trans_log(&@block_ctxt cx, &span sp, int level, &@ast::expr expr)\n                 ty::ty_machine(ast::ty_u32) {\n             by_val = true; llupcall = bcx_ccx(bcx).upcalls.log_int;\n           }\n+          ty::ty_istr {\n+            by_val = false; llupcall = bcx_ccx(bcx).upcalls.log_istr;\n+          }\n           _ {\n             bcx_ccx(bcx).sess.span_unimpl(sp, \"logging for values of type \" +\n                 ppaux::ty_to_str(bcx_tcx(bcx), t));\n@@ -322,11 +325,12 @@ fn trans_lit_str_common(&@crate_ctxt ccx, &str s)\n                 none);\n     }\n \n-    auto llarray = tc::C_array(tc::T_i8(), array);\n+    auto llheappart = tc::C_struct(~[tc::C_uint(len),\n+                                     tc::C_array(tc::T_i8(), array)]);\n     ret tup(tc::C_struct(~[tc::C_uint(0u),\n                            tc::C_uint(abi::ivec_default_length),\n-                           tc::C_null(tc::T_ptr(lltype_of(llarray)))]),\n-            some(llarray));\n+                           tc::C_null(tc::T_ptr(lltype_of(llheappart)))]),\n+            some(llheappart));\n }\n \n // As above, we don't use destination-passing style here."}, {"sha": "d734625fa30f1394ce68b3e21606499ea3bf2478", "filename": "src/rt/rust_upcall.cpp", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/88574c3cea87bc8f789883bcd518b8a91fb1a776/src%2Frt%2Frust_upcall.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/88574c3cea87bc8f789883bcd518b8a91fb1a776/src%2Frt%2Frust_upcall.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_upcall.cpp?ref=88574c3cea87bc8f789883bcd518b8a91fb1a776", "patch": "@@ -75,6 +75,16 @@ upcall_log_str(rust_task *task, uint32_t level, rust_str *str) {\n     }\n }\n \n+extern \"C\" CDECL void\n+upcall_log_istr(rust_task *task, uint32_t level, rust_ivec *str) {\n+    LOG_UPCALL_ENTRY(task);\n+    if (task->sched->log_lvl < level)\n+        return;\n+    const char *buf = (const char *)\n+        (str->fill ? str->payload.data : str->payload.ptr->data);\n+    task->sched->log(task, level, \"rust: %s\", buf);\n+}\n+\n extern \"C\" CDECL void\n upcall_trace_word(rust_task *task, uintptr_t i) {\n     LOG_UPCALL_ENTRY(task);"}, {"sha": "f762f4a9be3c98401105d77edfc5bb912ccabfcd", "filename": "src/rt/rustrt.def.in", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/88574c3cea87bc8f789883bcd518b8a91fb1a776/src%2Frt%2Frustrt.def.in", "raw_url": "https://github.com/rust-lang/rust/raw/88574c3cea87bc8f789883bcd518b8a91fb1a776/src%2Frt%2Frustrt.def.in", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frustrt.def.in?ref=88574c3cea87bc8f789883bcd518b8a91fb1a776", "patch": "@@ -68,6 +68,7 @@ upcall_kill\n upcall_log_double\n upcall_log_float\n upcall_log_int\n+upcall_log_istr\n upcall_log_str\n upcall_malloc\n upcall_mark"}]}