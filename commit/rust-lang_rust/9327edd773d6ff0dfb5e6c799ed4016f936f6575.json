{"sha": "9327edd773d6ff0dfb5e6c799ed4016f936f6575", "node_id": "MDY6Q29tbWl0NzI0NzEyOjkzMjdlZGQ3NzNkNmZmMGRmYjVlNmM3OTllZDQwMTZmOTM2ZjY1NzU=", "commit": {"author": {"name": "Jonathan Turner", "email": "jonathandturner@users.noreply.github.com", "date": "2016-09-02T22:28:51Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2016-09-02T22:28:51Z"}, "message": "Rollup merge of #36160 - Aatch:normalize-closure-sig, r=eddyb\n\nNormalize the function signature of closures\n\nPreviously we didn't normalize the function signatures used for\nclosures. This didn't cause a problem in most cases, but caused an ICE\nin during MIR type checking.\n\nFixes #36139\n\nr? @eddyb", "tree": {"sha": "fd0d83a5df5efc21d89d22f2fed000fe8593214f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fd0d83a5df5efc21d89d22f2fed000fe8593214f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9327edd773d6ff0dfb5e6c799ed4016f936f6575", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9327edd773d6ff0dfb5e6c799ed4016f936f6575", "html_url": "https://github.com/rust-lang/rust/commit/9327edd773d6ff0dfb5e6c799ed4016f936f6575", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9327edd773d6ff0dfb5e6c799ed4016f936f6575/comments", "author": {"login": "jonathandturner", "id": 111457284, "node_id": "O_kgDOBqS0BA", "avatar_url": "https://avatars.githubusercontent.com/u/111457284?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonathandturner", "html_url": "https://github.com/jonathandturner", "followers_url": "https://api.github.com/users/jonathandturner/followers", "following_url": "https://api.github.com/users/jonathandturner/following{/other_user}", "gists_url": "https://api.github.com/users/jonathandturner/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonathandturner/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonathandturner/subscriptions", "organizations_url": "https://api.github.com/users/jonathandturner/orgs", "repos_url": "https://api.github.com/users/jonathandturner/repos", "events_url": "https://api.github.com/users/jonathandturner/events{/privacy}", "received_events_url": "https://api.github.com/users/jonathandturner/received_events", "type": "Organization", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "445fe52b7212d10fb6fb9df035ff0fe951c81af5", "url": "https://api.github.com/repos/rust-lang/rust/commits/445fe52b7212d10fb6fb9df035ff0fe951c81af5", "html_url": "https://github.com/rust-lang/rust/commit/445fe52b7212d10fb6fb9df035ff0fe951c81af5"}, {"sha": "e0279d71926d0fd7925f55f600bc9947dd070e68", "url": "https://api.github.com/repos/rust-lang/rust/commits/e0279d71926d0fd7925f55f600bc9947dd070e68", "html_url": "https://github.com/rust-lang/rust/commit/e0279d71926d0fd7925f55f600bc9947dd070e68"}], "stats": {"total": 37, "additions": 36, "deletions": 1}, "files": [{"sha": "6c9cc5f5e132ac7e32730c1174a0d1decfbf7371", "filename": "src/librustc_typeck/astconv.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/9327edd773d6ff0dfb5e6c799ed4016f936f6575/src%2Flibrustc_typeck%2Fastconv.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9327edd773d6ff0dfb5e6c799ed4016f936f6575/src%2Flibrustc_typeck%2Fastconv.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fastconv.rs?ref=9327edd773d6ff0dfb5e6c799ed4016f936f6575", "patch": "@@ -1878,11 +1878,16 @@ impl<'o, 'gcx: 'tcx, 'tcx> AstConv<'gcx, 'tcx>+'o {\n             hir::DefaultReturn(..) => self.tcx().mk_nil(),\n         };\n \n+        let input_tys = self_ty.into_iter().chain(arg_tys).collect();\n+\n+        debug!(\"ty_of_method_or_bare_fn: input_tys={:?}\", input_tys);\n+        debug!(\"ty_of_method_or_bare_fn: output_ty={:?}\", output_ty);\n+\n         (self.tcx().mk_bare_fn(ty::BareFnTy {\n             unsafety: unsafety,\n             abi: abi,\n             sig: ty::Binder(ty::FnSig {\n-                inputs: self_ty.into_iter().chain(arg_tys).collect(),\n+                inputs: input_tys,\n                 output: output_ty,\n                 variadic: decl.variadic\n             }),"}, {"sha": "8980cb9076027aa5d7cf3693f3c313d12d7649ee", "filename": "src/librustc_typeck/check/closure.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/9327edd773d6ff0dfb5e6c799ed4016f936f6575/src%2Flibrustc_typeck%2Fcheck%2Fclosure.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9327edd773d6ff0dfb5e6c799ed4016f936f6575/src%2Flibrustc_typeck%2Fcheck%2Fclosure.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fclosure.rs?ref=9327edd773d6ff0dfb5e6c799ed4016f936f6575", "patch": "@@ -74,6 +74,8 @@ impl<'a, 'gcx, 'tcx> FnCtxt<'a, 'gcx, 'tcx> {\n \n         let fn_sig = self.tcx.liberate_late_bound_regions(\n             self.tcx.region_maps.call_site_extent(expr.id, body.id), &fn_ty.sig);\n+        let fn_sig =\n+            (**self).normalize_associated_types_in(body.span, body.id, &fn_sig);\n \n         check_fn(self, hir::Unsafety::Normal, expr.id, &fn_sig, decl, expr.id, &body);\n "}, {"sha": "adde0ed30667491c96813607b8b4c04bab3d80b1", "filename": "src/test/run-pass/issue-36139-normalize-closure-sig.rs", "status": "added", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/9327edd773d6ff0dfb5e6c799ed4016f936f6575/src%2Ftest%2Frun-pass%2Fissue-36139-normalize-closure-sig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9327edd773d6ff0dfb5e6c799ed4016f936f6575/src%2Ftest%2Frun-pass%2Fissue-36139-normalize-closure-sig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fissue-36139-normalize-closure-sig.rs?ref=9327edd773d6ff0dfb5e6c799ed4016f936f6575", "patch": "@@ -0,0 +1,28 @@\n+// Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// Previously the closure's argument would be inferred to\n+// <S as ITrait<'a>>::Item, causing an error in MIR type\n+// checking\n+\n+trait ITrait<'a> {type Item;}\n+\n+struct S {}\n+\n+impl<'a> ITrait<'a> for S { type Item = &'a mut usize; }\n+\n+fn m<T, I, F>(_: F)\n+    where I: for<'a> ITrait<'a>,\n+          F: for<'a> FnMut(<I as ITrait<'a>>::Item) { }\n+\n+\n+fn main() {\n+    m::<usize,S,_>(|x| { *x += 1; });\n+}"}]}