{"sha": "41d73d131266c864495ce592749b74f580b17b23", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQxZDczZDEzMTI2NmM4NjQ0OTVjZTU5Mjc0OWI3NGY1ODBiMTdiMjM=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2020-12-10T17:51:39Z"}, "committer": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2020-12-10T17:51:39Z"}, "message": "Replicate Cargo environment variables", "tree": {"sha": "da7d2a43957a3d81ba2e25c097196daf48d20406", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/da7d2a43957a3d81ba2e25c097196daf48d20406"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/41d73d131266c864495ce592749b74f580b17b23", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/41d73d131266c864495ce592749b74f580b17b23", "html_url": "https://github.com/rust-lang/rust/commit/41d73d131266c864495ce592749b74f580b17b23", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/41d73d131266c864495ce592749b74f580b17b23/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6095debda842a84904398e410589669dda51cf14", "url": "https://api.github.com/repos/rust-lang/rust/commits/6095debda842a84904398e410589669dda51cf14", "html_url": "https://github.com/rust-lang/rust/commit/6095debda842a84904398e410589669dda51cf14"}], "stats": {"total": 39, "additions": 39, "deletions": 0}, "files": [{"sha": "4c1ba5e759150d389c27ec830f55b0854b2081e5", "filename": "crates/project_model/src/cargo_workspace.rs", "status": "modified", "additions": 39, "deletions": 0, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/41d73d131266c864495ce592749b74f580b17b23/crates%2Fproject_model%2Fsrc%2Fcargo_workspace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/41d73d131266c864495ce592749b74f580b17b23/crates%2Fproject_model%2Fsrc%2Fcargo_workspace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproject_model%2Fsrc%2Fcargo_workspace.rs?ref=41d73d131266c864495ce592749b74f580b17b23", "patch": "@@ -192,6 +192,9 @@ impl CargoWorkspace {\n \n         meta.packages.sort_by(|a, b| a.id.cmp(&b.id));\n         for meta_pkg in meta.packages {\n+            let id = meta_pkg.id.clone();\n+            inject_cargo_env(&meta_pkg, envs.entry(id).or_default());\n+\n             let cargo_metadata::Package { id, edition, name, manifest_path, version, .. } =\n                 meta_pkg;\n             let is_member = ws_members.contains(&id);\n@@ -385,3 +388,39 @@ fn is_dylib(path: &Path) -> bool {\n         Some(ext) => matches!(ext.as_str(), \"dll\" | \"dylib\" | \"so\"),\n     }\n }\n+\n+/// Recreates the compile-time environment variables that Cargo sets.\n+///\n+/// Should be synced with <https://doc.rust-lang.org/cargo/reference/environment-variables.html#environment-variables-cargo-sets-for-crates>\n+fn inject_cargo_env(package: &cargo_metadata::Package, env: &mut Vec<(String, String)>) {\n+    // FIXME: Missing variables:\n+    // CARGO, CARGO_PKG_HOMEPAGE, CARGO_CRATE_NAME, CARGO_BIN_NAME, CARGO_BIN_EXE_<name>\n+\n+    let mut manifest_dir = package.manifest_path.clone();\n+    manifest_dir.pop();\n+    if let Some(cargo_manifest_dir) = manifest_dir.to_str() {\n+        env.push((\"CARGO_MANIFEST_DIR\".into(), cargo_manifest_dir.into()));\n+    }\n+\n+    env.push((\"CARGO_PKG_VERSION\".into(), package.version.to_string()));\n+    env.push((\"CARGO_PKG_VERSION_MAJOR\".into(), package.version.major.to_string()));\n+    env.push((\"CARGO_PKG_VERSION_MINOR\".into(), package.version.minor.to_string()));\n+    env.push((\"CARGO_PKG_VERSION_PATCH\".into(), package.version.patch.to_string()));\n+\n+    let pre = package.version.pre.iter().map(|id| id.to_string()).collect::<Vec<_>>();\n+    let pre = pre.join(\".\");\n+    env.push((\"CARGO_PKG_VERSION_PRE\".into(), pre));\n+\n+    let authors = package.authors.join(\";\");\n+    env.push((\"CARGO_PKG_AUTHORS\".into(), authors));\n+\n+    env.push((\"CARGO_PKG_NAME\".into(), package.name.clone()));\n+    env.push((\"CARGO_PKG_DESCRIPTION\".into(), package.description.clone().unwrap_or_default()));\n+    //env.push((\"CARGO_PKG_HOMEPAGE\".into(), package.homepage.clone().unwrap_or_default()));\n+    env.push((\"CARGO_PKG_REPOSITORY\".into(), package.repository.clone().unwrap_or_default()));\n+    env.push((\"CARGO_PKG_LICENSE\".into(), package.license.clone().unwrap_or_default()));\n+\n+    let license_file =\n+        package.license_file.as_ref().map(|buf| buf.display().to_string()).unwrap_or_default();\n+    env.push((\"CARGO_PKG_LICENSE_FILE\".into(), license_file));\n+}"}]}