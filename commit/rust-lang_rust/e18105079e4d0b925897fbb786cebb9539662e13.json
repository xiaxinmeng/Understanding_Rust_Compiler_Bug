{"sha": "e18105079e4d0b925897fbb786cebb9539662e13", "node_id": "MDY6Q29tbWl0NzI0NzEyOmUxODEwNTA3OWU0ZDBiOTI1ODk3ZmJiNzg2Y2ViYjk1Mzk2NjJlMTM=", "commit": {"author": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-02-21T14:58:06Z"}, "committer": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-02-22T19:30:10Z"}, "message": "Submit a comment to the PR in additional to pushing a commit.\n\nFix rust-lang-nursery/rust-toolstate#2.", "tree": {"sha": "67e97a097958a62d227a33035fb83b13a0c7fc80", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/67e97a097958a62d227a33035fb83b13a0c7fc80"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e18105079e4d0b925897fbb786cebb9539662e13", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEZ1R8CLMp8f2GxWoQ/vbIBR0OATwFAlqPGkIACgkQ/vbIBR0O\nATyOIg//Wy7ecOknoGk4PMV1L+pwZL41S0Qmwp9IoRcKzqo51IByWlV842XGQxLj\nEkHI7JXTUNvexc7ZmsAGcg1uzr90htqECAI2NFgkhlQhUrwa+X4tbFFZUjW6FNlm\nyJ4A60ATqbssxJp6wNP7RU4NDwQ1QcCJnBVFczyOrVezirh4ZbldhQSK9IR5jUlq\nQHDp+fuBEcgB6qO0EsNcTqUukqoBdorC4VO3ZZvhgyv/6PgZLbUUtdkPJIXID4RB\nlLbTYtV38PXH6BdUjkTMk17JYTTi14Hm71P/HzWycX91+0IgYY1xaT7iJ7MeAG9y\nxLLfDl1N54TcEeM4iqZs+MnvggYiEifHSSpfUjEoyvlB8YLqqQu4M/CupluIjV/S\nmndZpTlHKL1p+EUNXCL6+OHwey7frolg6FfPiEll8F2YVpVcnyOmCedqngt+L8UY\ntthNenKjck9vKTK1J+Be6H8yXxcLnnUBREcfF/t7xSTfcE9tKV5XY3kbdCUaxAZz\nabHwdp6DSfleJ7jH7kETDGrjUechHqoNKI5opn3QxBXIcyWLvoGXkrtqELnJ6qJy\nWOlTf9JxqExtclgTTwxkYT5nTb3LSYcmuCJrfm8cT5qEu+0bE5OXv1AIlkluM9BD\nIWLXB5OtxAbFu21VSScXxFhYdBnui39TWg53P6Lwp/D1wwJXJDU=\n=fFXb\n-----END PGP SIGNATURE-----", "payload": "tree 67e97a097958a62d227a33035fb83b13a0c7fc80\nparent 1acd3789bb70c39f23c8fb13f0db50402ebb146a\nauthor kennytm <kennytm@gmail.com> 1519225086 +0800\ncommitter kennytm <kennytm@gmail.com> 1519327810 +0800\n\nSubmit a comment to the PR in additional to pushing a commit.\n\nFix rust-lang-nursery/rust-toolstate#2.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e18105079e4d0b925897fbb786cebb9539662e13", "html_url": "https://github.com/rust-lang/rust/commit/e18105079e4d0b925897fbb786cebb9539662e13", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e18105079e4d0b925897fbb786cebb9539662e13/comments", "author": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1acd3789bb70c39f23c8fb13f0db50402ebb146a", "url": "https://api.github.com/repos/rust-lang/rust/commits/1acd3789bb70c39f23c8fb13f0db50402ebb146a", "html_url": "https://github.com/rust-lang/rust/commit/1acd3789bb70c39f23c8fb13f0db50402ebb146a"}], "stats": {"total": 32, "additions": 26, "deletions": 6}, "files": [{"sha": "0d8641e45ed157b90b56fb3dd940ad611b89da99", "filename": ".travis.yml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e18105079e4d0b925897fbb786cebb9539662e13/.travis.yml", "raw_url": "https://github.com/rust-lang/rust/raw/e18105079e4d0b925897fbb786cebb9539662e13/.travis.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.travis.yml?ref=e18105079e4d0b925897fbb786cebb9539662e13", "patch": "@@ -188,7 +188,7 @@ matrix:\n       script:\n         MESSAGE_FILE=$(mktemp -t msg.XXXXXX);\n         . src/ci/docker/x86_64-gnu-tools/repo.sh;\n-        commit_toolstate_change \"$MESSAGE_FILE\" \"$TRAVIS_BUILD_DIR/src/tools/publish_toolstate.py\" \"$(git rev-parse HEAD)\" \"$(git log --format=%s -n1 HEAD)\" \"$MESSAGE_FILE\"\n+        commit_toolstate_change \"$MESSAGE_FILE\" \"$TRAVIS_BUILD_DIR/src/tools/publish_toolstate.py\" \"$(git rev-parse HEAD)\" \"$(git log --format=%s -n1 HEAD)\" \"$MESSAGE_FILE\" \"$TOOLSTATE_REPO_ACCESS_TOKEN\";\n \n env:\n   global:"}, {"sha": "40abe81c449efa4d8209e9f8bc465c9ebdf5128d", "filename": "src/tools/publish_toolstate.py", "status": "modified", "additions": 25, "deletions": 5, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/e18105079e4d0b925897fbb786cebb9539662e13/src%2Ftools%2Fpublish_toolstate.py", "raw_url": "https://github.com/rust-lang/rust/raw/e18105079e4d0b925897fbb786cebb9539662e13/src%2Ftools%2Fpublish_toolstate.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fpublish_toolstate.py?ref=e18105079e4d0b925897fbb786cebb9539662e13", "patch": "@@ -18,6 +18,10 @@\n import datetime\n import collections\n import textwrap\n+try:\n+    import urllib2\n+except ImportError:\n+    import urllib.request as urllib2\n \n # List of people to ping when the status of a tool changed.\n MAINTAINERS = {\n@@ -100,13 +104,15 @@ def update_latest(\n     cur_datetime = datetime.datetime.utcnow().strftime('%Y-%m-%dT%H:%M:%SZ')\n     cur_commit_msg = sys.argv[2]\n     save_message_to_path = sys.argv[3]\n+    github_token = sys.argv[4]\n \n     relevant_pr_match = re.search('#([0-9]+)', cur_commit_msg)\n     if relevant_pr_match:\n         number = relevant_pr_match.group(1)\n         relevant_pr_number = 'rust-lang/rust#' + number\n         relevant_pr_url = 'https://github.com/rust-lang/rust/pull/' + number\n     else:\n+        number = '-1'\n         relevant_pr_number = '<unknown PR>'\n         relevant_pr_url = '<unknown>'\n \n@@ -116,9 +122,23 @@ def update_latest(\n         relevant_pr_url,\n         cur_datetime\n     )\n-    if message:\n-        print(message)\n-        with open(save_message_to_path, 'w') as f:\n-            f.write(message)\n-    else:\n+    if not message:\n         print('<Nothing changed>')\n+        sys.exit(0)\n+\n+    print(message)\n+    with open(save_message_to_path, 'w') as f:\n+        f.write(message)\n+\n+    # Write the toolstate comment on the PR as well.\n+    gh_url = 'https://api.github.com/repos/rust-lang/rust/issues/{}/comments' \\\n+        .format(number)\n+    response = urllib2.urlopen(urllib2.Request(\n+        gh_url,\n+        json.dumps({'body': message}),\n+        {\n+            'Authorization': 'token ' + github_token,\n+            'Content-Type': 'application/json',\n+        }\n+    ))\n+    response.read()"}]}