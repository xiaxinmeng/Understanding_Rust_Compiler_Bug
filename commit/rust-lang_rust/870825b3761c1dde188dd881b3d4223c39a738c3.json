{"sha": "870825b3761c1dde188dd881b3d4223c39a738c3", "node_id": "C_kwDOAAsO6NoAKDg3MDgyNWIzNzYxYzFkZGUxODhkZDg4MWIzZDQyMjNjMzlhNzM4YzM", "commit": {"author": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2022-10-01T19:29:14Z"}, "committer": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2022-10-01T19:29:14Z"}, "message": "Add proc-macro dependency to rustc crates", "tree": {"sha": "e89934019b7decbe2bb7ff37e00604bebfbd3c91", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e89934019b7decbe2bb7ff37e00604bebfbd3c91"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/870825b3761c1dde188dd881b3d4223c39a738c3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/870825b3761c1dde188dd881b3d4223c39a738c3", "html_url": "https://github.com/rust-lang/rust/commit/870825b3761c1dde188dd881b3d4223c39a738c3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/870825b3761c1dde188dd881b3d4223c39a738c3/comments", "author": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cdc5493901b23a3e768216e062e557ed724b27e1", "url": "https://api.github.com/repos/rust-lang/rust/commits/cdc5493901b23a3e768216e062e557ed724b27e1", "html_url": "https://github.com/rust-lang/rust/commit/cdc5493901b23a3e768216e062e557ed724b27e1"}], "stats": {"total": 15, "additions": 15, "deletions": 0}, "files": [{"sha": "8c3e8681d9894f9df8705e16d4342e998dabd9c9", "filename": "crates/project-model/src/workspace.rs", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/870825b3761c1dde188dd881b3d4223c39a738c3/crates%2Fproject-model%2Fsrc%2Fworkspace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/870825b3761c1dde188dd881b3d4223c39a738c3/crates%2Fproject-model%2Fsrc%2Fworkspace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproject-model%2Fsrc%2Fworkspace.rs?ref=870825b3761c1dde188dd881b3d4223c39a738c3", "patch": "@@ -717,6 +717,7 @@ fn cargo_to_crate_graph(\n                 load_proc_macro,\n                 &mut pkg_to_lib_crate,\n                 &public_deps,\n+                libproc_macro,\n                 cargo,\n                 &pkg_crates,\n                 build_scripts,\n@@ -782,6 +783,7 @@ fn handle_rustc_crates(\n     load_proc_macro: &mut dyn FnMut(&str, &AbsPath) -> ProcMacroLoadResult,\n     pkg_to_lib_crate: &mut FxHashMap<Package, CrateId>,\n     public_deps: &SysrootPublicDeps,\n+    libproc_macro: Option<CrateId>,\n     cargo: &CargoWorkspace,\n     pkg_crates: &FxHashMap<Package, Vec<(CrateId, TargetKind)>>,\n     build_scripts: &WorkspaceBuildScripts,\n@@ -843,6 +845,19 @@ fn handle_rustc_crates(\n                         rustc_workspace[tgt].is_proc_macro,\n                     );\n                     pkg_to_lib_crate.insert(pkg, crate_id);\n+\n+                    // Even crates that don't set proc-macro = true are allowed to depend on proc_macro\n+                    // (just none of the APIs work when called outside of a proc macro).\n+                    if let Some(proc_macro) = libproc_macro {\n+                        add_dep_with_prelude(\n+                            crate_graph,\n+                            crate_id,\n+                            CrateName::new(\"proc_macro\").unwrap(),\n+                            proc_macro,\n+                            cargo[tgt].is_proc_macro,\n+                        );\n+                    }\n+\n                     // Add dependencies on core / std / alloc for this crate\n                     public_deps.add(crate_id, crate_graph);\n                     rustc_pkg_crates.entry(pkg).or_insert_with(Vec::new).push(crate_id);"}]}