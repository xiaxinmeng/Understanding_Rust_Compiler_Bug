{"sha": "49f3c0b73689eed49df9ef822f9fd437db93ce9e", "node_id": "C_kwDOAAsO6NoAKDQ5ZjNjMGI3MzY4OWVlZDQ5ZGY5ZWY4MjJmOWZkNDM3ZGI5M2NlOWU", "commit": {"author": {"name": "Jacob Bramley", "email": "jacob.bramley@arm.com", "date": "2022-11-21T16:05:51Z"}, "committer": {"name": "Jacob Bramley", "email": "jacob.bramley@arm.com", "date": "2022-12-06T15:51:57Z"}, "message": "Check AArch64 branch-protection earlier in the pipeline.\n\nAs suggested in #93516.", "tree": {"sha": "2d0f6319ecfa15ba1b4de2d805dc7c8920fcef0f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2d0f6319ecfa15ba1b4de2d805dc7c8920fcef0f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/49f3c0b73689eed49df9ef822f9fd437db93ce9e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/49f3c0b73689eed49df9ef822f9fd437db93ce9e", "html_url": "https://github.com/rust-lang/rust/commit/49f3c0b73689eed49df9ef822f9fd437db93ce9e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/49f3c0b73689eed49df9ef822f9fd437db93ce9e/comments", "author": {"login": "jacobbramley", "id": 5206553, "node_id": "MDQ6VXNlcjUyMDY1NTM=", "avatar_url": "https://avatars.githubusercontent.com/u/5206553?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jacobbramley", "html_url": "https://github.com/jacobbramley", "followers_url": "https://api.github.com/users/jacobbramley/followers", "following_url": "https://api.github.com/users/jacobbramley/following{/other_user}", "gists_url": "https://api.github.com/users/jacobbramley/gists{/gist_id}", "starred_url": "https://api.github.com/users/jacobbramley/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jacobbramley/subscriptions", "organizations_url": "https://api.github.com/users/jacobbramley/orgs", "repos_url": "https://api.github.com/users/jacobbramley/repos", "events_url": "https://api.github.com/users/jacobbramley/events{/privacy}", "received_events_url": "https://api.github.com/users/jacobbramley/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jacobbramley", "id": 5206553, "node_id": "MDQ6VXNlcjUyMDY1NTM=", "avatar_url": "https://avatars.githubusercontent.com/u/5206553?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jacobbramley", "html_url": "https://github.com/jacobbramley", "followers_url": "https://api.github.com/users/jacobbramley/followers", "following_url": "https://api.github.com/users/jacobbramley/following{/other_user}", "gists_url": "https://api.github.com/users/jacobbramley/gists{/gist_id}", "starred_url": "https://api.github.com/users/jacobbramley/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jacobbramley/subscriptions", "organizations_url": "https://api.github.com/users/jacobbramley/orgs", "repos_url": "https://api.github.com/users/jacobbramley/repos", "events_url": "https://api.github.com/users/jacobbramley/events{/privacy}", "received_events_url": "https://api.github.com/users/jacobbramley/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "203c8765ea33c65d888febe0e8219c4bb11b0d89", "url": "https://api.github.com/repos/rust-lang/rust/commits/203c8765ea33c65d888febe0e8219c4bb11b0d89", "html_url": "https://github.com/rust-lang/rust/commit/203c8765ea33c65d888febe0e8219c4bb11b0d89"}], "stats": {"total": 37, "additions": 19, "deletions": 18}, "files": [{"sha": "a22a67ad7d34f7dc6a88270fb5f4cfc9ca50ef11", "filename": "compiler/rustc_codegen_llvm/src/context.rs", "status": "modified", "additions": 3, "deletions": 5, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/49f3c0b73689eed49df9ef822f9fd437db93ce9e/compiler%2Frustc_codegen_llvm%2Fsrc%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/49f3c0b73689eed49df9ef822f9fd437db93ce9e/compiler%2Frustc_codegen_llvm%2Fsrc%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fcontext.rs?ref=49f3c0b73689eed49df9ef822f9fd437db93ce9e", "patch": "@@ -3,7 +3,6 @@ use crate::back::write::to_llvm_code_model;\n use crate::callee::get_fn;\n use crate::coverageinfo;\n use crate::debuginfo;\n-use crate::errors::BranchProtectionRequiresAArch64;\n use crate::llvm;\n use crate::llvm_util;\n use crate::type_::Type;\n@@ -275,10 +274,9 @@ pub unsafe fn create_module<'ll>(\n         }\n     }\n \n-    if let Some(BranchProtection { bti, pac_ret }) = sess.opts.unstable_opts.branch_protection {\n-        if sess.target.arch != \"aarch64\" {\n-            sess.emit_err(BranchProtectionRequiresAArch64);\n-        } else {\n+    // AArch64-only options (checked in rustc_session).\n+    if sess.target.arch == \"aarch64\" {\n+        if let Some(BranchProtection { bti, pac_ret }) = sess.opts.unstable_opts.branch_protection {\n             llvm::LLVMRustAddModuleFlag(\n                 llmod,\n                 llvm::LLVMModFlagBehavior::Error,"}, {"sha": "de508f917f33eb2c97c93e277c7dc549ecb26b36", "filename": "compiler/rustc_codegen_llvm/src/errors.rs", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/49f3c0b73689eed49df9ef822f9fd437db93ce9e/compiler%2Frustc_codegen_llvm%2Fsrc%2Ferrors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/49f3c0b73689eed49df9ef822f9fd437db93ce9e/compiler%2Frustc_codegen_llvm%2Fsrc%2Ferrors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Ferrors.rs?ref=49f3c0b73689eed49df9ef822f9fd437db93ce9e", "patch": "@@ -51,10 +51,6 @@ pub(crate) struct SymbolAlreadyDefined<'a> {\n     pub symbol_name: &'a str,\n }\n \n-#[derive(Diagnostic)]\n-#[diag(codegen_llvm_branch_protection_requires_aarch64)]\n-pub(crate) struct BranchProtectionRequiresAArch64;\n-\n #[derive(Diagnostic)]\n #[diag(codegen_llvm_invalid_minimum_alignment)]\n pub(crate) struct InvalidMinimumAlignment {"}, {"sha": "86f71a611ab0c16e1ef47c12e37487ffea1f01cc", "filename": "compiler/rustc_error_messages/locales/en-US/codegen_llvm.ftl", "status": "modified", "additions": 0, "deletions": 3, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/49f3c0b73689eed49df9ef822f9fd437db93ce9e/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fcodegen_llvm.ftl", "raw_url": "https://github.com/rust-lang/rust/raw/49f3c0b73689eed49df9ef822f9fd437db93ce9e/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fcodegen_llvm.ftl", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fcodegen_llvm.ftl?ref=49f3c0b73689eed49df9ef822f9fd437db93ce9e", "patch": "@@ -17,9 +17,6 @@ codegen_llvm_instrument_coverage_requires_llvm_12 =\n codegen_llvm_symbol_already_defined =\n     symbol `{$symbol_name}` is already defined\n \n-codegen_llvm_branch_protection_requires_aarch64 =\n-    -Zbranch-protection is only supported on aarch64\n-\n codegen_llvm_invalid_minimum_alignment =\n     invalid minimum global alignment: {$err}\n "}, {"sha": "ab9e8b6baae6ad4a3e30bbd92ff4bafe18e66e4c", "filename": "compiler/rustc_error_messages/locales/en-US/session.ftl", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/49f3c0b73689eed49df9ef822f9fd437db93ce9e/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fsession.ftl", "raw_url": "https://github.com/rust-lang/rust/raw/49f3c0b73689eed49df9ef822f9fd437db93ce9e/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fsession.ftl", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fsession.ftl?ref=49f3c0b73689eed49df9ef822f9fd437db93ce9e", "patch": "@@ -41,6 +41,8 @@ session_unsupported_dwarf_version = requested DWARF version {$dwarf_version} is\n \n session_target_stack_protector_not_supported = `-Z stack-protector={$stack_protector}` is not supported for target {$target_triple} and will be ignored\n \n+session_branch_protection_requires_aarch64 = `-Zbranch-protection` is only supported on aarch64\n+\n session_split_debuginfo_unstable_platform = `-Csplit-debuginfo={$debuginfo}` is unstable on this platform\n \n session_file_is_not_writeable = output file {$file} is not writeable -- check its permissions"}, {"sha": "fd7dabf75ef20556cdcd401254c7b2822db79913", "filename": "compiler/rustc_session/src/errors.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/49f3c0b73689eed49df9ef822f9fd437db93ce9e/compiler%2Frustc_session%2Fsrc%2Ferrors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/49f3c0b73689eed49df9ef822f9fd437db93ce9e/compiler%2Frustc_session%2Fsrc%2Ferrors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Ferrors.rs?ref=49f3c0b73689eed49df9ef822f9fd437db93ce9e", "patch": "@@ -115,6 +115,10 @@ pub struct StackProtectorNotSupportedForTarget<'a> {\n     pub target_triple: &'a TargetTriple,\n }\n \n+#[derive(Diagnostic)]\n+#[diag(session_branch_protection_requires_aarch64)]\n+pub(crate) struct BranchProtectionRequiresAArch64;\n+\n #[derive(Diagnostic)]\n #[diag(session_split_debuginfo_unstable_platform)]\n pub struct SplitDebugInfoUnstablePlatform {"}, {"sha": "ce4a2e3d82d899ff53b3e3b37e716fa4cf8cc281", "filename": "compiler/rustc_session/src/session.rs", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/49f3c0b73689eed49df9ef822f9fd437db93ce9e/compiler%2Frustc_session%2Fsrc%2Fsession.rs", "raw_url": "https://github.com/rust-lang/rust/raw/49f3c0b73689eed49df9ef822f9fd437db93ce9e/compiler%2Frustc_session%2Fsrc%2Fsession.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Fsession.rs?ref=49f3c0b73689eed49df9ef822f9fd437db93ce9e", "patch": "@@ -3,10 +3,10 @@ use crate::code_stats::CodeStats;\n pub use crate::code_stats::{DataTypeKind, FieldInfo, SizeKind, VariantInfo};\n use crate::config::{self, CrateType, InstrumentCoverage, OptLevel, OutputType, SwitchWithOptPath};\n use crate::errors::{\n-    CannotEnableCrtStaticLinux, CannotMixAndMatchSanitizers, LinkerPluginToWindowsNotSupported,\n-    NotCircumventFeature, ProfileSampleUseFileDoesNotExist, ProfileUseFileDoesNotExist,\n-    SanitizerCfiEnabled, SanitizerNotSupported, SanitizersNotSupported, SkippingConstChecks,\n-    SplitDebugInfoUnstablePlatform, StackProtectorNotSupportedForTarget,\n+    BranchProtectionRequiresAArch64, CannotEnableCrtStaticLinux, CannotMixAndMatchSanitizers,\n+    LinkerPluginToWindowsNotSupported, NotCircumventFeature, ProfileSampleUseFileDoesNotExist,\n+    ProfileUseFileDoesNotExist, SanitizerCfiEnabled, SanitizerNotSupported, SanitizersNotSupported,\n+    SkippingConstChecks, SplitDebugInfoUnstablePlatform, StackProtectorNotSupportedForTarget,\n     TargetRequiresUnwindTables, UnleashedFeatureHelp, UnstableVirtualFunctionElimination,\n     UnsupportedDwarfVersion,\n };\n@@ -1542,6 +1542,10 @@ fn validate_commandline_args_with_session_available(sess: &Session) {\n         }\n     }\n \n+    if sess.opts.unstable_opts.branch_protection.is_some() && sess.target.arch != \"aarch64\" {\n+        sess.emit_err(BranchProtectionRequiresAArch64);\n+    }\n+\n     if let Some(dwarf_version) = sess.opts.unstable_opts.dwarf_version {\n         if dwarf_version > 5 {\n             sess.emit_err(UnsupportedDwarfVersion { dwarf_version });"}, {"sha": "52a5919026463074199f87a216e1f8fc98723f15", "filename": "src/test/ui/invalid-compile-flags/branch-protection-missing-pac-ret.BADTARGET.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/49f3c0b73689eed49df9ef822f9fd437db93ce9e/src%2Ftest%2Fui%2Finvalid-compile-flags%2Fbranch-protection-missing-pac-ret.BADTARGET.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/49f3c0b73689eed49df9ef822f9fd437db93ce9e/src%2Ftest%2Fui%2Finvalid-compile-flags%2Fbranch-protection-missing-pac-ret.BADTARGET.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Finvalid-compile-flags%2Fbranch-protection-missing-pac-ret.BADTARGET.stderr?ref=49f3c0b73689eed49df9ef822f9fd437db93ce9e", "patch": "@@ -1,4 +1,4 @@\n-error: -Zbranch-protection is only supported on aarch64\n+error: `-Zbranch-protection` is only supported on aarch64\n \n error: aborting due to previous error\n "}, {"sha": "1d7ec5cba17ca71ebf37a4478771d1836918e2a8", "filename": "src/test/ui/invalid-compile-flags/branch-protection-missing-pac-ret.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/49f3c0b73689eed49df9ef822f9fd437db93ce9e/src%2Ftest%2Fui%2Finvalid-compile-flags%2Fbranch-protection-missing-pac-ret.rs", "raw_url": "https://github.com/rust-lang/rust/raw/49f3c0b73689eed49df9ef822f9fd437db93ce9e/src%2Ftest%2Fui%2Finvalid-compile-flags%2Fbranch-protection-missing-pac-ret.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Finvalid-compile-flags%2Fbranch-protection-missing-pac-ret.rs?ref=49f3c0b73689eed49df9ef822f9fd437db93ce9e", "patch": "@@ -3,7 +3,7 @@\n // [BADFLAGS] check-fail\n // [BADFLAGS] needs-llvm-components: aarch64\n // [BADTARGET] compile-flags: --target=x86_64-unknown-linux-gnu -Zbranch-protection=bti\n-// [BADTARGET] build-fail\n+// [BADTARGET] check-fail\n // [BADTARGET] needs-llvm-components: x86\n \n #![crate_type = \"lib\"]"}]}