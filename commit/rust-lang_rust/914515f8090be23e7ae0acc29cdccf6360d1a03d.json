{"sha": "914515f8090be23e7ae0acc29cdccf6360d1a03d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjkxNDUxNWY4MDkwYmUyM2U3YWUwYWNjMjljZGNjZjYzNjBkMWEwM2Q=", "commit": {"author": {"name": "Matthew Jasper", "email": "mjjasper1@gmail.com", "date": "2018-11-18T14:49:24Z"}, "committer": {"name": "Matthew Jasper", "email": "mjjasper1@gmail.com", "date": "2018-11-30T19:43:41Z"}, "message": "Drop function parameters in expected order\n\nGiven the function\n\nfn foo((_x, _): (LogDrop, LogDrop), (_, _y): (LogDrop, LogDrop)) {}\n\nPrior to 1.12 we dropped both `_x` and `_y` before the rest of their\nrespective parameters, since then we dropped `_x` and `_y` after. The\noriginal order appears to be the correct order, as the value created\nlater is dropped first, so we revert to that order and add a test for\nit.", "tree": {"sha": "b55bebdede2a8c35830d1e265cd8c498ca87086a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b55bebdede2a8c35830d1e265cd8c498ca87086a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/914515f8090be23e7ae0acc29cdccf6360d1a03d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/914515f8090be23e7ae0acc29cdccf6360d1a03d", "html_url": "https://github.com/rust-lang/rust/commit/914515f8090be23e7ae0acc29cdccf6360d1a03d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/914515f8090be23e7ae0acc29cdccf6360d1a03d/comments", "author": {"login": "matthewjasper", "id": 20113453, "node_id": "MDQ6VXNlcjIwMTEzNDUz", "avatar_url": "https://avatars.githubusercontent.com/u/20113453?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthewjasper", "html_url": "https://github.com/matthewjasper", "followers_url": "https://api.github.com/users/matthewjasper/followers", "following_url": "https://api.github.com/users/matthewjasper/following{/other_user}", "gists_url": "https://api.github.com/users/matthewjasper/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthewjasper/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthewjasper/subscriptions", "organizations_url": "https://api.github.com/users/matthewjasper/orgs", "repos_url": "https://api.github.com/users/matthewjasper/repos", "events_url": "https://api.github.com/users/matthewjasper/events{/privacy}", "received_events_url": "https://api.github.com/users/matthewjasper/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matthewjasper", "id": 20113453, "node_id": "MDQ6VXNlcjIwMTEzNDUz", "avatar_url": "https://avatars.githubusercontent.com/u/20113453?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthewjasper", "html_url": "https://github.com/matthewjasper", "followers_url": "https://api.github.com/users/matthewjasper/followers", "following_url": "https://api.github.com/users/matthewjasper/following{/other_user}", "gists_url": "https://api.github.com/users/matthewjasper/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthewjasper/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthewjasper/subscriptions", "organizations_url": "https://api.github.com/users/matthewjasper/orgs", "repos_url": "https://api.github.com/users/matthewjasper/repos", "events_url": "https://api.github.com/users/matthewjasper/events{/privacy}", "received_events_url": "https://api.github.com/users/matthewjasper/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3dde9e132207b5a40e12f8d5a1a363ebea60e0b0", "url": "https://api.github.com/repos/rust-lang/rust/commits/3dde9e132207b5a40e12f8d5a1a363ebea60e0b0", "html_url": "https://github.com/rust-lang/rust/commit/3dde9e132207b5a40e12f8d5a1a363ebea60e0b0"}], "stats": {"total": 82, "additions": 75, "deletions": 7}, "files": [{"sha": "bc12c262716e6d294eaeacf70420a3a281d1f077", "filename": "src/librustc_mir/build/mod.rs", "status": "modified", "additions": 7, "deletions": 7, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/914515f8090be23e7ae0acc29cdccf6360d1a03d/src%2Flibrustc_mir%2Fbuild%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/914515f8090be23e7ae0acc29cdccf6360d1a03d/src%2Flibrustc_mir%2Fbuild%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fbuild%2Fmod.rs?ref=914515f8090be23e7ae0acc29cdccf6360d1a03d", "patch": "@@ -915,6 +915,13 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n             let place = Place::Local(local);\n             let &ArgInfo(ty, opt_ty_info, pattern, ref self_binding) = arg_info;\n \n+            // Make sure we drop (parts of) the argument even when not matched on.\n+            self.schedule_drop(\n+                pattern.as_ref().map_or(ast_body.span, |pat| pat.span),\n+                argument_scope, &place, ty,\n+                DropKind::Value { cached_block: CachedBlock::default() },\n+            );\n+\n             if let Some(pattern) = pattern {\n                 let pattern = self.hir.pattern_from_hir(pattern);\n                 let span = pattern.span;\n@@ -946,13 +953,6 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n                     }\n                 }\n             }\n-\n-            // Make sure we drop (parts of) the argument even when not matched on.\n-            self.schedule_drop(\n-                pattern.as_ref().map_or(ast_body.span, |pat| pat.span),\n-                argument_scope, &place, ty,\n-                DropKind::Value { cached_block: CachedBlock::default() },\n-            );\n         }\n \n         // Enter the argument pattern bindings source scope, if it exists."}, {"sha": "4d5a6fbba28575eb0926315c8a5ec9cd1db01ca4", "filename": "src/test/run-pass/binding/fn-arg-incomplete-pattern-drop-order.rs", "status": "added", "additions": 68, "deletions": 0, "changes": 68, "blob_url": "https://github.com/rust-lang/rust/blob/914515f8090be23e7ae0acc29cdccf6360d1a03d/src%2Ftest%2Frun-pass%2Fbinding%2Ffn-arg-incomplete-pattern-drop-order.rs", "raw_url": "https://github.com/rust-lang/rust/raw/914515f8090be23e7ae0acc29cdccf6360d1a03d/src%2Ftest%2Frun-pass%2Fbinding%2Ffn-arg-incomplete-pattern-drop-order.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fbinding%2Ffn-arg-incomplete-pattern-drop-order.rs?ref=914515f8090be23e7ae0acc29cdccf6360d1a03d", "patch": "@@ -0,0 +1,68 @@\n+// Check that partially moved from function parameters are dropped after the\n+// named bindings that move from them.\n+\n+// ignore-wasm32-bare compiled with panic=abort by default\n+\n+use std::{panic, cell::RefCell};\n+\n+struct LogDrop<'a>(i32, Context<'a>);\n+\n+#[derive(Copy, Clone)]\n+struct Context<'a> {\n+    panic_on: i32,\n+    drops: &'a RefCell<Vec<i32>>,\n+}\n+\n+impl<'a> Context<'a> {\n+    fn record_drop(self, index: i32) {\n+        self.drops.borrow_mut().push(index);\n+        if index == self.panic_on {\n+            panic!();\n+        }\n+    }\n+}\n+\n+impl<'a> Drop for LogDrop<'a> {\n+    fn drop(&mut self) {\n+        self.1.record_drop(self.0);\n+    }\n+}\n+\n+fn bindings_in_params((_x, _): (LogDrop, LogDrop), (_, _y): (LogDrop, LogDrop)) {}\n+fn bindings_with_let(a: (LogDrop, LogDrop), b: (LogDrop, LogDrop)) {\n+    // Drop order in foo is the same as the following bindings.\n+    // _temp2 is declared after _x to avoid a difference between `_: T` and\n+    // `x: T` in function parameters.\n+    let _temp1 = a;\n+    let (_x, _) = _temp1;\n+\n+    let _temp2 = b;\n+    let (_, _y) = _temp2;\n+}\n+\n+fn test_drop_order(panic_on: i32, fun: fn((LogDrop, LogDrop), (LogDrop, LogDrop))) {\n+    let context = Context {\n+        panic_on,\n+        drops: &RefCell::new(Vec::new()),\n+    };\n+    let one = LogDrop(1, context);\n+    let two = LogDrop(2, context);\n+    let three = LogDrop(3, context);\n+    let four = LogDrop(4, context);\n+\n+    let res = panic::catch_unwind(panic::AssertUnwindSafe(|| {\n+        fun((three, four), (two, one));\n+    }));\n+    if panic_on == 0 {\n+        assert!(res.is_ok(), \"should not have panicked\");\n+    } else {\n+        assert!(res.is_err(), \"should have panicked\");\n+    }\n+    assert_eq!(*context.drops.borrow(), [1, 2, 3, 4], \"incorrect drop order\");\n+}\n+\n+fn main() {\n+    (0..=4).for_each(|i| test_drop_order(i, bindings_in_params));\n+    (0..=4).for_each(|i| test_drop_order(i, bindings_with_let));\n+    (0..=4).for_each(|i| test_drop_order(i, |(_x, _), (_, _y)| {}));\n+}"}]}