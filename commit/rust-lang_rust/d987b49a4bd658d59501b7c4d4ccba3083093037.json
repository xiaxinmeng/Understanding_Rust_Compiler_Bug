{"sha": "d987b49a4bd658d59501b7c4d4ccba3083093037", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ5ODdiNDlhNGJkNjU4ZDU5NTAxYjdjNGQ0Y2NiYTMwODMwOTMwMzc=", "commit": {"author": {"name": "Graydon Hoare", "email": "graydon@mozilla.com", "date": "2011-05-03T06:37:52Z"}, "committer": {"name": "Graydon Hoare", "email": "graydon@mozilla.com", "date": "2011-05-03T06:37:52Z"}, "message": "More hacking on the snapshot system.", "tree": {"sha": "1584e6fa8e986c1660952d26ea0840be86418d62", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1584e6fa8e986c1660952d26ea0840be86418d62"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d987b49a4bd658d59501b7c4d4ccba3083093037", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d987b49a4bd658d59501b7c4d4ccba3083093037", "html_url": "https://github.com/rust-lang/rust/commit/d987b49a4bd658d59501b7c4d4ccba3083093037", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d987b49a4bd658d59501b7c4d4ccba3083093037/comments", "author": {"login": "graydon", "id": 14097, "node_id": "MDQ6VXNlcjE0MDk3", "avatar_url": "https://avatars.githubusercontent.com/u/14097?v=4", "gravatar_id": "", "url": "https://api.github.com/users/graydon", "html_url": "https://github.com/graydon", "followers_url": "https://api.github.com/users/graydon/followers", "following_url": "https://api.github.com/users/graydon/following{/other_user}", "gists_url": "https://api.github.com/users/graydon/gists{/gist_id}", "starred_url": "https://api.github.com/users/graydon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/graydon/subscriptions", "organizations_url": "https://api.github.com/users/graydon/orgs", "repos_url": "https://api.github.com/users/graydon/repos", "events_url": "https://api.github.com/users/graydon/events{/privacy}", "received_events_url": "https://api.github.com/users/graydon/received_events", "type": "User", "site_admin": false}, "committer": {"login": "graydon", "id": 14097, "node_id": "MDQ6VXNlcjE0MDk3", "avatar_url": "https://avatars.githubusercontent.com/u/14097?v=4", "gravatar_id": "", "url": "https://api.github.com/users/graydon", "html_url": "https://github.com/graydon", "followers_url": "https://api.github.com/users/graydon/followers", "following_url": "https://api.github.com/users/graydon/following{/other_user}", "gists_url": "https://api.github.com/users/graydon/gists{/gist_id}", "starred_url": "https://api.github.com/users/graydon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/graydon/subscriptions", "organizations_url": "https://api.github.com/users/graydon/orgs", "repos_url": "https://api.github.com/users/graydon/repos", "events_url": "https://api.github.com/users/graydon/events{/privacy}", "received_events_url": "https://api.github.com/users/graydon/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ed40c85af5c6eec82746696d3ce2d0e7ae22c1d4", "url": "https://api.github.com/repos/rust-lang/rust/commits/ed40c85af5c6eec82746696d3ce2d0e7ae22c1d4", "html_url": "https://github.com/rust-lang/rust/commit/ed40c85af5c6eec82746696d3ce2d0e7ae22c1d4"}], "stats": {"total": 76, "additions": 39, "deletions": 37}, "files": [{"sha": "4edfc7387de71b4d4c11f176a56ffc1af6d79662", "filename": "Makefile.in", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/d987b49a4bd658d59501b7c4d4ccba3083093037/Makefile.in", "raw_url": "https://github.com/rust-lang/rust/raw/d987b49a4bd658d59501b7c4d4ccba3083093037/Makefile.in", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Makefile.in?ref=d987b49a4bd658d59501b7c4d4ccba3083093037", "patch": "@@ -108,7 +108,6 @@ GENERATED :=\n %:: s.%\n %:: SCCS/s.%\n \n-\n ######################################################################\n # Standard library variables\n ######################################################################\n@@ -135,6 +134,13 @@ SREQ1 := stage1/rustc$(X) $(LREQ) stage2/glue.o stage2/$(CFG_STDLIB)\n SREQ2 := stage2/rustc$(X) $(LREQ) stage3/glue.o stage3/$(CFG_STDLIB)\n \n \n+######################################################################\n+# Exports for sub-utilities\n+######################################################################\n+\n+export CFG_SRC_DIR\n+\n+\n ######################################################################\n # Single-target rules\n ######################################################################\n@@ -179,5 +185,6 @@ include $(CFG_SRC_DIR)/mk/rustllvm.mk\n include $(CFG_SRC_DIR)/mk/docs.mk\n include $(CFG_SRC_DIR)/mk/tests.mk\n include $(CFG_SRC_DIR)/mk/dist.mk\n+include $(CFG_SRC_DIR)/mk/snap.mk\n include $(CFG_SRC_DIR)/mk/clean.mk\n include $(CFG_SRC_DIR)/mk/autodep.mk"}, {"sha": "475bb316330a3d5940801766fcb1ab9bf6406ecf", "filename": "src/etc/get-snapshot.py", "status": "modified", "additions": 11, "deletions": 30, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/d987b49a4bd658d59501b7c4d4ccba3083093037/src%2Fetc%2Fget-snapshot.py", "raw_url": "https://github.com/rust-lang/rust/raw/d987b49a4bd658d59501b7c4d4ccba3083093037/src%2Fetc%2Fget-snapshot.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fetc%2Fget-snapshot.py?ref=d987b49a4bd658d59501b7c4d4ccba3083093037", "patch": "@@ -9,34 +9,15 @@ def snap_filename_hash_part(snap):\n     raise Exception(\"unable to find hash in filename: \" + snap)\n   return match.group(1)\n \n-def get_snapshot_and_check_hash(snap):\n-\n-  hsh = snap_filename_hash_part(snap)\n-\n-  h = hashlib.sha1()\n-  url = download_url_base + \"/\" + snap\n-  print \"downloading \" + url\n-  u = urllib2.urlopen(url)\n-  print \"checking hash on download\"\n-  data = u.read()\n-  h.update(data)\n-  if h.hexdigest() != hsh:\n-    raise Exception(\"hash check failed on \" + snap)\n-\n-  print \"hash ok\"\n-  with open(os.path.join(download_dir_base, snap), \"w+b\") as f:\n-    f.write(data)\n-  return True\n-\n def unpack_snapshot(snap):\n   dl_path = os.path.join(download_dir_base, snap)\n-  print \"opening snapshot \" + dl_path\n+  print(\"opening snapshot \" + dl_path)\n   tar = tarfile.open(dl_path)\n   kernel = get_kernel()\n   for name in snapshot_files[kernel]:\n     p = os.path.join(\"rust-stage0\", name)\n     fp = os.path.join(\"stage0\", name)\n-    print \"extracting \" + fp\n+    print(\"extracting \" + fp)\n     tar.extract(p, download_unpack_base)\n     tp = os.path.join(download_unpack_base, p)\n     shutil.move(tp, fp)\n@@ -80,16 +61,16 @@ def determine_last_snapshot_for_platform():\n # Main\n \n snap = determine_last_snapshot_for_platform()\n-print \"determined most recent snapshot: \" + snap\n dl = os.path.join(download_dir_base, snap)\n-if (os.path.exists(dl)):\n-  if (snap_filename_hash_part(snap) == hash_file(dl)):\n-    print \"found existing download with ok hash\"\n-  else:\n-    print \"bad hash on existing download, re-fetching\"\n-    get_snapshot_and_check_hash(snap)\n+url = download_url_base + \"/\" + snap\n+print(\"determined most recent snapshot: \" + snap)\n+\n+if (not os.path.exists(dl)):\n+  get_url_to_file(url, dl)\n+\n+if (snap_filename_hash_part(snap) == hash_file(dl)):\n+  print(\"got download with ok hash\")\n else:\n-  print \"no cached download, fetching\"\n-  get_snapshot_and_check_hash(snap)\n+  raise Exception(\"bad hash on download\")\n \n unpack_snapshot(snap)"}, {"sha": "11209b4cf4a4cae4c43acc7e5678eaa7348c6b35", "filename": "src/etc/make-snapshot.py", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d987b49a4bd658d59501b7c4d4ccba3083093037/src%2Fetc%2Fmake-snapshot.py", "raw_url": "https://github.com/rust-lang/rust/raw/d987b49a4bd658d59501b7c4d4ccba3083093037/src%2Fetc%2Fmake-snapshot.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fetc%2Fmake-snapshot.py?ref=d987b49a4bd658d59501b7c4d4ccba3083093037", "patch": "@@ -21,4 +21,4 @@\n \n shutil.move(file0, file1)\n \n-print file1\n+print(file1)"}, {"sha": "788b5b627c3574588fd7d35ce7d985c54faeed03", "filename": "src/etc/snapshot.py", "status": "modified", "additions": 16, "deletions": 5, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/d987b49a4bd658d59501b7c4d4ccba3083093037/src%2Fetc%2Fsnapshot.py", "raw_url": "https://github.com/rust-lang/rust/raw/d987b49a4bd658d59501b7c4d4ccba3083093037/src%2Fetc%2Fsnapshot.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fetc%2Fsnapshot.py?ref=d987b49a4bd658d59501b7c4d4ccba3083093037", "patch": "@@ -1,6 +1,10 @@\n-import re, os, sys, hashlib, tarfile, shutil, subprocess, urllib2, tempfile\n+import re, os, sys, hashlib, tarfile, shutil, subprocess, tempfile\n \n-snapshotfile = \"snapshots.txt\"\n+src_dir = os.getenv(\"CFG_SRC_DIR\")\n+if not src_dir:\n+  raise Exception(\"missing env var CFG_SRC_DIR\")\n+\n+snapshotfile = os.path.join(src_dir, \"snapshots.txt\")\n download_url_base = \"http://dl.rust-lang.org/stage0-snapshots\"\n download_dir_base = \"dl\"\n download_unpack_base = os.path.join(download_dir_base, \"unpack\")\n@@ -59,11 +63,16 @@ def get_cpu():\n def get_platform():\n   return \"%s-%s\" % (get_kernel(), get_cpu())\n \n+def scrub(b):\n+  if sys.version_info >= (3,) and type(b) == bytes:\n+    return b.decode('ascii')\n+  else:\n+    return b\n \n def cmd_out(cmdline):\n     p = subprocess.Popen(cmdline,\n                          stdout=subprocess.PIPE)\n-    return p.communicate()[0].strip()\n+    return scrub(p.communicate()[0].strip())\n \n \n def local_rev_info(field):\n@@ -82,8 +91,10 @@ def local_rev_short_sha():\n def local_rev_committer_date():\n     return local_rev_info(\"ci\")\n \n+def get_url_to_file(u,f):\n+  subprocess.check_call([\"curl\", \"-o\", f, u])\n \n def hash_file(x):\n     h = hashlib.sha1()\n-    h.update(open(x).read())\n-    return h.hexdigest()\n+    h.update(open(x, \"rb\").read())\n+    return scrub(h.hexdigest())"}, {"sha": "c70c1aef4ddbf8c178b853ff562109fba0ca81b4", "filename": "src/snapshots.txt", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/d987b49a4bd658d59501b7c4d4ccba3083093037/src%2Fsnapshots.txt", "raw_url": "https://github.com/rust-lang/rust/raw/d987b49a4bd658d59501b7c4d4ccba3083093037/src%2Fsnapshots.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fsnapshots.txt?ref=d987b49a4bd658d59501b7c4d4ccba3083093037", "patch": "@@ -1,3 +1,6 @@\n+S 2011-05-02 ed40c85\n+  winnt-i386 e69c11fbc62639ac3a3eef7ea36c9ad77209e2b1\n+\n S 2011-04-29 7b95b5c\n   linux-i386 f0e166816ce34adc9f7202bd3cfbd80623505f28\n   macos-i386 abf2ee279da63676ca17c9dc9e54d04d8f752b00"}]}