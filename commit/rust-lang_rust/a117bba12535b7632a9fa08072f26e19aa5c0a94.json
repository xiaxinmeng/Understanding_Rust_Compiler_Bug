{"sha": "a117bba12535b7632a9fa08072f26e19aa5c0a94", "node_id": "MDY6Q29tbWl0NzI0NzEyOmExMTdiYmExMjUzNWI3NjMyYTlmYTA4MDcyZjI2ZTE5YWE1YzBhOTQ=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-10-22T20:09:24Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2016-10-22T20:09:24Z"}, "message": "Auto merge of #37318 - nnethercote:html5ever-more, r=nrc,eddyb\n\nAvoid some allocations in the macro parser\n\nThese three commits reduce the number of heap allocations done when compiling rustc-benchmarks/html5ever-2016-08-25 by 20%, from 16.5M to 13.3M. This speeds up (debug) compilation of it with a stage1 compiler by about 7%.", "tree": {"sha": "8a4127eef23b35daf1f76256257cacde94ef792a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8a4127eef23b35daf1f76256257cacde94ef792a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a117bba12535b7632a9fa08072f26e19aa5c0a94", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a117bba12535b7632a9fa08072f26e19aa5c0a94", "html_url": "https://github.com/rust-lang/rust/commit/a117bba12535b7632a9fa08072f26e19aa5c0a94", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a117bba12535b7632a9fa08072f26e19aa5c0a94/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0eb4d46d03ce486a98c3ed24f9aa0406ff0b2a43", "url": "https://api.github.com/repos/rust-lang/rust/commits/0eb4d46d03ce486a98c3ed24f9aa0406ff0b2a43", "html_url": "https://github.com/rust-lang/rust/commit/0eb4d46d03ce486a98c3ed24f9aa0406ff0b2a43"}, {"sha": "b817cf8b5730912c558aff811cd34fc3d3fa8637", "url": "https://api.github.com/repos/rust-lang/rust/commits/b817cf8b5730912c558aff811cd34fc3d3fa8637", "html_url": "https://github.com/rust-lang/rust/commit/b817cf8b5730912c558aff811cd34fc3d3fa8637"}], "stats": {"total": 48, "additions": 32, "deletions": 16}, "files": [{"sha": "74def68b18504909a6da9d805cc600c9ca65a0e6", "filename": "src/libsyntax/ext/tt/macro_parser.rs", "status": "modified", "additions": 14, "deletions": 7, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/a117bba12535b7632a9fa08072f26e19aa5c0a94/src%2Flibsyntax%2Fext%2Ftt%2Fmacro_parser.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a117bba12535b7632a9fa08072f26e19aa5c0a94/src%2Flibsyntax%2Fext%2Ftt%2Fmacro_parser.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Ftt%2Fmacro_parser.rs?ref=a117bba12535b7632a9fa08072f26e19aa5c0a94", "patch": "@@ -251,14 +251,22 @@ pub fn nameize(p_s: &ParseSess, ms: &[TokenTree], res: &[Rc<NamedMatch>])\n \n pub enum ParseResult<T> {\n     Success(T),\n-    /// Arm failed to match\n-    Failure(syntax_pos::Span, String),\n+    /// Arm failed to match. If the second parameter is `token::Eof`, it\n+    /// indicates an unexpected end of macro invocation. Otherwise, it\n+    /// indicates that no rules expected the given token.\n+    Failure(syntax_pos::Span, Token),\n     /// Fatal error (malformed macro?). Abort compilation.\n     Error(syntax_pos::Span, String)\n }\n \n+pub fn parse_failure_msg(tok: Token) -> String {\n+    match tok {\n+        token::Eof => \"unexpected end of macro invocation\".to_string(),\n+        _ => format!(\"no rules expected the token `{}`\", pprust::token_to_string(&tok)),\n+    }\n+}\n+\n pub type NamedParseResult = ParseResult<HashMap<Ident, Rc<NamedMatch>>>;\n-pub type PositionalParseResult = ParseResult<Vec<Rc<NamedMatch>>>;\n \n /// Perform a token equality check, ignoring syntax context (that is, an\n /// unhygienic comparison)\n@@ -425,8 +433,8 @@ pub fn parse(sess: &ParseSess,\n                         cur_eis.push(ei);\n                     }\n                     TokenTree::Token(_, ref t) => {\n-                        let mut ei_t = ei.clone();\n                         if token_name_eq(t,&tok) {\n+                            let mut ei_t = ei.clone();\n                             ei_t.idx += 1;\n                             next_eis.push(ei_t);\n                         }\n@@ -446,7 +454,7 @@ pub fn parse(sess: &ParseSess,\n             } else if eof_eis.len() > 1 {\n                 return Error(sp, \"ambiguity: multiple successful parses\".to_string());\n             } else {\n-                return Failure(sp, \"unexpected end of macro invocation\".to_string());\n+                return Failure(sp, token::Eof);\n             }\n         } else {\n             if (!bb_eis.is_empty() && !next_eis.is_empty())\n@@ -467,8 +475,7 @@ pub fn parse(sess: &ParseSess,\n                     }\n                 ))\n             } else if bb_eis.is_empty() && next_eis.is_empty() {\n-                return Failure(sp, format!(\"no rules expected the token `{}`\",\n-                            pprust::token_to_string(&tok)));\n+                return Failure(sp, tok);\n             } else if !next_eis.is_empty() {\n                 /* Now process the next token */\n                 while !next_eis.is_empty() {"}, {"sha": "61911e0d3b3d504d4e8bef46b0490948b8143be6", "filename": "src/libsyntax/ext/tt/macro_rules.rs", "status": "modified", "additions": 12, "deletions": 7, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/a117bba12535b7632a9fa08072f26e19aa5c0a94/src%2Flibsyntax%2Fext%2Ftt%2Fmacro_rules.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a117bba12535b7632a9fa08072f26e19aa5c0a94/src%2Flibsyntax%2Fext%2Ftt%2Fmacro_rules.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Ftt%2Fmacro_rules.rs?ref=a117bba12535b7632a9fa08072f26e19aa5c0a94", "patch": "@@ -16,7 +16,7 @@ use ext::expand::{Expansion, ExpansionKind};\n use ext::placeholders;\n use ext::tt::macro_parser::{Success, Error, Failure};\n use ext::tt::macro_parser::{MatchedSeq, MatchedNonterminal};\n-use ext::tt::macro_parser::parse;\n+use ext::tt::macro_parser::{parse, parse_failure_msg};\n use parse::ParseSess;\n use parse::lexer::new_tt_reader;\n use parse::parser::{Parser, Restrictions};\n@@ -97,7 +97,7 @@ fn generic_extension<'cx>(cx: &'cx ExtCtxt,\n \n     // Which arm's failure should we report? (the one furthest along)\n     let mut best_fail_spot = DUMMY_SP;\n-    let mut best_fail_msg = \"internal error: ran no matchers\".to_string();\n+    let mut best_fail_tok = None;\n \n     for (i, lhs) in lhses.iter().enumerate() { // try each arm's matchers\n         let lhs_tt = match *lhs {\n@@ -134,17 +134,18 @@ fn generic_extension<'cx>(cx: &'cx ExtCtxt,\n                     macro_ident: name\n                 })\n             }\n-            Failure(sp, ref msg) => if sp.lo >= best_fail_spot.lo {\n+            Failure(sp, tok) => if sp.lo >= best_fail_spot.lo {\n                 best_fail_spot = sp;\n-                best_fail_msg = (*msg).clone();\n+                best_fail_tok = Some(tok);\n             },\n             Error(err_sp, ref msg) => {\n                 cx.span_fatal(err_sp.substitute_dummy(sp), &msg[..])\n             }\n         }\n     }\n \n-     cx.span_fatal(best_fail_spot.substitute_dummy(sp), &best_fail_msg[..]);\n+    let best_fail_msg = parse_failure_msg(best_fail_tok.expect(\"ran no matchers\"));\n+    cx.span_fatal(best_fail_spot.substitute_dummy(sp), &best_fail_msg);\n }\n \n pub struct MacroRulesExpander;\n@@ -222,8 +223,12 @@ pub fn compile(sess: &ParseSess, def: &ast::MacroDef) -> SyntaxExtension {\n \n     let argument_map = match parse(sess, &Vec::new(), arg_reader, &argument_gram) {\n         Success(m) => m,\n-        Failure(sp, str) | Error(sp, str) => {\n-            panic!(sess.span_diagnostic.span_fatal(sp.substitute_dummy(def.span), &str));\n+        Failure(sp, tok) => {\n+            let s = parse_failure_msg(tok);\n+            panic!(sess.span_diagnostic.span_fatal(sp.substitute_dummy(def.span), &s));\n+        }\n+        Error(sp, s) => {\n+            panic!(sess.span_diagnostic.span_fatal(sp.substitute_dummy(def.span), &s));\n         }\n     };\n "}, {"sha": "5229d42f1fdd4100acfdcb7c782b16aff8839af1", "filename": "src/test/run-pass-fulldeps/auxiliary/procedural_mbe_matching.rs", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/a117bba12535b7632a9fa08072f26e19aa5c0a94/src%2Ftest%2Frun-pass-fulldeps%2Fauxiliary%2Fprocedural_mbe_matching.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a117bba12535b7632a9fa08072f26e19aa5c0a94/src%2Ftest%2Frun-pass-fulldeps%2Fauxiliary%2Fprocedural_mbe_matching.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass-fulldeps%2Fauxiliary%2Fprocedural_mbe_matching.rs?ref=a117bba12535b7632a9fa08072f26e19aa5c0a94", "patch": "@@ -25,6 +25,7 @@ use syntax::ext::base::{ExtCtxt, MacResult, DummyResult, MacEager};\n use syntax::ext::build::AstBuilder;\n use syntax::ext::tt::macro_parser::{MatchedSeq, MatchedNonterminal};\n use syntax::ext::tt::macro_parser::{Success, Failure, Error};\n+use syntax::ext::tt::macro_parser::parse_failure_msg;\n use syntax::ptr::P;\n use syntax_pos::Span;\n use rustc_plugin::Registry;\n@@ -58,8 +59,11 @@ fn expand_mbe_matches(cx: &mut ExtCtxt, sp: Span, args: &[TokenTree])\n                 _ => unreachable!()\n             }\n         }\n-        Failure(_, s) | Error(_, s) => {\n-            panic!(\"expected Success, but got Error/Failure: {}\", s);\n+        Failure(_, tok) => {\n+            panic!(\"expected Success, but got Failure: {}\", parse_failure_msg(tok));\n+        }\n+        Error(_, s) => {\n+            panic!(\"expected Success, but got Error: {}\", s);\n         }\n     };\n "}]}