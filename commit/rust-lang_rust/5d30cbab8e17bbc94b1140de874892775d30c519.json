{"sha": "5d30cbab8e17bbc94b1140de874892775d30c519", "node_id": "MDY6Q29tbWl0NzI0NzEyOjVkMzBjYmFiOGUxN2JiYzk0YjExNDBkZTg3NDg5Mjc3NWQzMGM1MTk=", "commit": {"author": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2018-02-23T18:24:51Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2018-02-23T18:24:51Z"}, "message": "Rollup merge of #48219 - andjo403:export_symbol, r=michaelwoerister\n\nlookup exported symbols only when needed.\n\nreduces the time to compile small file with no optimization by half.", "tree": {"sha": "ff191bb298a29a91b5d3ae0c4407e93e047d92ae", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ff191bb298a29a91b5d3ae0c4407e93e047d92ae"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5d30cbab8e17bbc94b1140de874892775d30c519", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJakFxzCRBK7hj4Ov3rIwAAdHIIAIzuU594oNMVJZJ9UZX70xUT\n49DBGdEMxl98QNXX/CzTXmdRZ1lwRUmVT4IbSl5PCVkMFb4P+oOIcnJ5nNoUvupM\n9Agx3LeqnZ9bKdtwq66Ri6pFoGbnLvA9wadB4gW9V7VPlvWFTpPlNreFtBsebxG+\nKLa4nFYFy4VIYxvA/EgYl6M8GqmiK6y/z0AtS1XORzcPlKJfxrL2p3PvSPzPTmNd\n0Xh8TF/nmVmrsvR9366h7za1LwFrMgbnUGJ42d0cr7b69rKVrCeIqtJ5jnhD6S58\npQFsWW+YCVqrSwMLJ/Ftq5oqe6Fb8muYfnWjetXOAQzDFzDR5oYg/twYTtV5JP4=\n=E1DG\n-----END PGP SIGNATURE-----\n", "payload": "tree ff191bb298a29a91b5d3ae0c4407e93e047d92ae\nparent 5fd8d180977feaf6f1141fb6a992303b2c817b14\nparent 7041ef3cf437acd39262eed4cec0d4aa3c1ff1f9\nauthor Manish Goregaokar <manishsmail@gmail.com> 1519410291 -0800\ncommitter GitHub <noreply@github.com> 1519410291 -0800\n\nRollup merge of #48219 - andjo403:export_symbol, r=michaelwoerister\n\nlookup exported symbols only when needed.\n\nreduces the time to compile small file with no optimization by half.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5d30cbab8e17bbc94b1140de874892775d30c519", "html_url": "https://github.com/rust-lang/rust/commit/5d30cbab8e17bbc94b1140de874892775d30c519", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5d30cbab8e17bbc94b1140de874892775d30c519/comments", "author": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5fd8d180977feaf6f1141fb6a992303b2c817b14", "url": "https://api.github.com/repos/rust-lang/rust/commits/5fd8d180977feaf6f1141fb6a992303b2c817b14", "html_url": "https://github.com/rust-lang/rust/commit/5fd8d180977feaf6f1141fb6a992303b2c817b14"}, {"sha": "7041ef3cf437acd39262eed4cec0d4aa3c1ff1f9", "url": "https://api.github.com/repos/rust-lang/rust/commits/7041ef3cf437acd39262eed4cec0d4aa3c1ff1f9", "html_url": "https://github.com/rust-lang/rust/commit/7041ef3cf437acd39262eed4cec0d4aa3c1ff1f9"}], "stats": {"total": 34, "additions": 24, "deletions": 10}, "files": [{"sha": "3f9e9191cf0332b25fa877126477696572a7ec24", "filename": "src/librustc_trans/back/lto.rs", "status": "modified", "additions": 6, "deletions": 3, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/5d30cbab8e17bbc94b1140de874892775d30c519/src%2Flibrustc_trans%2Fback%2Flto.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5d30cbab8e17bbc94b1140de874892775d30c519/src%2Flibrustc_trans%2Fback%2Flto.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fback%2Flto.rs?ref=5d30cbab8e17bbc94b1140de874892775d30c519", "patch": "@@ -122,8 +122,9 @@ pub(crate) fn run(cgcx: &CodegenContext,\n             None\n         }\n     };\n-\n-    let mut symbol_white_list = cgcx.exported_symbols[&LOCAL_CRATE]\n+    let exported_symbols = cgcx.exported_symbols\n+        .as_ref().expect(\"needs exported symbols for LTO\");\n+    let mut symbol_white_list = exported_symbols[&LOCAL_CRATE]\n         .iter()\n         .filter_map(symbol_filter)\n         .collect::<Vec<CString>>();\n@@ -156,8 +157,10 @@ pub(crate) fn run(cgcx: &CodegenContext,\n         }\n \n         for &(cnum, ref path) in cgcx.each_linked_rlib_for_lto.iter() {\n+            let exported_symbols = cgcx.exported_symbols\n+                .as_ref().expect(\"needs exported symbols for LTO\");\n             symbol_white_list.extend(\n-                cgcx.exported_symbols[&cnum]\n+                exported_symbols[&cnum]\n                     .iter()\n                     .filter_map(symbol_filter));\n "}, {"sha": "af5178eb565dbdd658d88520f766def7c50afbe2", "filename": "src/librustc_trans/back/write.rs", "status": "modified", "additions": 18, "deletions": 7, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/5d30cbab8e17bbc94b1140de874892775d30c519/src%2Flibrustc_trans%2Fback%2Fwrite.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5d30cbab8e17bbc94b1140de874892775d30c519/src%2Flibrustc_trans%2Fback%2Fwrite.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fback%2Fwrite.rs?ref=5d30cbab8e17bbc94b1140de874892775d30c519", "patch": "@@ -333,7 +333,7 @@ pub struct CodegenContext {\n     pub no_landing_pads: bool,\n     pub save_temps: bool,\n     pub fewer_names: bool,\n-    pub exported_symbols: Arc<ExportedSymbols>,\n+    pub exported_symbols: Option<Arc<ExportedSymbols>>,\n     pub opts: Arc<config::Options>,\n     pub crate_types: Vec<config::CrateType>,\n     pub each_linked_rlib_for_lto: Vec<(CrateNum, PathBuf)>,\n@@ -1394,14 +1394,25 @@ fn start_executing_work(tcx: TyCtxt,\n                         allocator_config: Arc<ModuleConfig>)\n                         -> thread::JoinHandle<Result<CompiledModules, ()>> {\n     let coordinator_send = tcx.tx_to_llvm_workers.clone();\n-    let mut exported_symbols = FxHashMap();\n-    exported_symbols.insert(LOCAL_CRATE, tcx.exported_symbols(LOCAL_CRATE));\n-    for &cnum in tcx.crates().iter() {\n-        exported_symbols.insert(cnum, tcx.exported_symbols(cnum));\n-    }\n-    let exported_symbols = Arc::new(exported_symbols);\n     let sess = tcx.sess;\n \n+    let exported_symbols = match sess.lto() {\n+        Lto::No => None,\n+        Lto::ThinLocal => {\n+            let mut exported_symbols = FxHashMap();\n+            exported_symbols.insert(LOCAL_CRATE, tcx.exported_symbols(LOCAL_CRATE));\n+            Some(Arc::new(exported_symbols))\n+        }\n+        Lto::Yes | Lto::Fat | Lto::Thin => {\n+            let mut exported_symbols = FxHashMap();\n+            exported_symbols.insert(LOCAL_CRATE, tcx.exported_symbols(LOCAL_CRATE));\n+            for &cnum in tcx.crates().iter() {\n+                exported_symbols.insert(cnum, tcx.exported_symbols(cnum));\n+            }\n+            Some(Arc::new(exported_symbols))\n+        }\n+    };\n+\n     // First up, convert our jobserver into a helper thread so we can use normal\n     // mpsc channels to manage our messages and such.\n     // After we've requested tokens then we'll, when we can,"}]}