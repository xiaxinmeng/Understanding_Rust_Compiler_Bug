{"sha": "79a664d8b00505a76b53cfe017b9c80bcee7e080", "node_id": "C_kwDOAAsO6NoAKDc5YTY2NGQ4YjAwNTA1YTc2YjUzY2ZlMDE3YjljODBiY2VlN2UwODA", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-10-09T11:33:02Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-10-09T11:33:02Z"}, "message": "Auto merge of #102332 - chriswailes:ndk-update, r=chriswailes\n\nUpdate CI to use Android NDK r25b\n\nThis commit updates the CI definitions to use the most recent Android LTS NDK release: r25b.  Changes since the last NDK used by Rust negate the need to generate \"standalone toolchains\" and newer NDKs can be used in-place.\n\nSee https://developer.android.com/ndk/guides/other_build_systems#overview", "tree": {"sha": "d803d3c49bcf74865391c128ddf7a77e42ad7798", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d803d3c49bcf74865391c128ddf7a77e42ad7798"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/79a664d8b00505a76b53cfe017b9c80bcee7e080", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/79a664d8b00505a76b53cfe017b9c80bcee7e080", "html_url": "https://github.com/rust-lang/rust/commit/79a664d8b00505a76b53cfe017b9c80bcee7e080", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/79a664d8b00505a76b53cfe017b9c80bcee7e080/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c0784109daa00f2e43c1b55becc2169bc5b3bf6f", "url": "https://api.github.com/repos/rust-lang/rust/commits/c0784109daa00f2e43c1b55becc2169bc5b3bf6f", "html_url": "https://github.com/rust-lang/rust/commit/c0784109daa00f2e43c1b55becc2169bc5b3bf6f"}, {"sha": "bf7f1ca316a249cf99d722d79a0db12fef687142", "url": "https://api.github.com/repos/rust-lang/rust/commits/bf7f1ca316a249cf99d722d79a0db12fef687142", "html_url": "https://github.com/rust-lang/rust/commit/bf7f1ca316a249cf99d722d79a0db12fef687142"}], "stats": {"total": 72, "additions": 29, "deletions": 43}, "files": [{"sha": "7795bebaed55f34506d2fe467729296c33983658", "filename": "src/bootstrap/cc_detect.rs", "status": "modified", "additions": 18, "deletions": 7, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/79a664d8b00505a76b53cfe017b9c80bcee7e080/src%2Fbootstrap%2Fcc_detect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/79a664d8b00505a76b53cfe017b9c80bcee7e080/src%2Fbootstrap%2Fcc_detect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcc_detect.rs?ref=79a664d8b00505a76b53cfe017b9c80bcee7e080", "patch": "@@ -47,6 +47,8 @@ fn cc2ar(cc: &Path, target: TargetSelection) -> Option<PathBuf> {\n         Some(PathBuf::from(\"ar\"))\n     } else if target.contains(\"vxworks\") {\n         Some(PathBuf::from(\"wr-ar\"))\n+    } else if target.contains(\"android\") {\n+        Some(cc.parent().unwrap().join(PathBuf::from(\"llvm-ar\")))\n     } else {\n         let parent = cc.parent().unwrap();\n         let file = cc.file_name().unwrap().to_str().unwrap();\n@@ -166,13 +168,22 @@ fn set_compiler(\n         // compiler already takes into account the triple in question.\n         t if t.contains(\"android\") => {\n             if let Some(ndk) = config.and_then(|c| c.ndk.as_ref()) {\n-                let target = target\n-                    .triple\n-                    .replace(\"armv7neon\", \"arm\")\n-                    .replace(\"armv7\", \"arm\")\n-                    .replace(\"thumbv7neon\", \"arm\")\n-                    .replace(\"thumbv7\", \"arm\");\n-                let compiler = format!(\"{}-{}\", target, compiler.clang());\n+                let mut triple_iter = target.triple.split(\"-\");\n+                let triple_translated = if let Some(arch) = triple_iter.next() {\n+                    let arch_new = match arch {\n+                        \"arm\" | \"armv7\" | \"armv7neon\" | \"thumbv7\" | \"thumbv7neon\" => \"armv7a\",\n+                        other => other,\n+                    };\n+                    std::iter::once(arch_new).chain(triple_iter).collect::<Vec<&str>>().join(\"-\")\n+                } else {\n+                    target.triple.to_string()\n+                };\n+\n+                // API 19 is the earliest API level supported by NDK r25b but AArch64 and x86_64 support\n+                // begins at API level 21.\n+                let api_level =\n+                    if t.contains(\"aarch64\") || t.contains(\"x86_64\") { \"21\" } else { \"19\" };\n+                let compiler = format!(\"{}{}-{}\", triple_translated, api_level, compiler.clang());\n                 cfg.compiler(ndk.join(\"bin\").join(compiler));\n             }\n         }"}, {"sha": "72ab167d9249baae1631e922c776bfdcc95a6b77", "filename": "src/ci/docker/host-x86_64/arm-android/Dockerfile", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/79a664d8b00505a76b53cfe017b9c80bcee7e080/src%2Fci%2Fdocker%2Fhost-x86_64%2Farm-android%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/79a664d8b00505a76b53cfe017b9c80bcee7e080/src%2Fci%2Fdocker%2Fhost-x86_64%2Farm-android%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Farm-android%2FDockerfile?ref=79a664d8b00505a76b53cfe017b9c80bcee7e080", "patch": "@@ -6,7 +6,7 @@ RUN sh /scripts/android-base-apt-get.sh\n \n COPY scripts/android-ndk.sh /scripts/\n RUN . /scripts/android-ndk.sh && \\\n-    download_and_make_toolchain android-ndk-r15c-linux-x86_64.zip arm 14\n+    download_ndk android-ndk-r25b-linux.zip\n \n RUN dpkg --add-architecture i386 && \\\n     apt-get update && \\\n@@ -30,7 +30,7 @@ ENV PATH=$PATH:/android/sdk/platform-tools\n \n ENV TARGETS=arm-linux-androideabi\n \n-ENV RUST_CONFIGURE_ARGS --arm-linux-androideabi-ndk=/android/ndk/arm-14\n+ENV RUST_CONFIGURE_ARGS --arm-linux-androideabi-ndk=/android/ndk/toolchains/llvm/prebuilt/linux-x86_64/\n \n ENV SCRIPT python3 ../x.py --stage 2 test --host='' --target $TARGETS\n "}, {"sha": "95ed1b859bb579f11cd9f7bfe776c3e2d2dfd52e", "filename": "src/ci/docker/host-x86_64/dist-android/Dockerfile", "status": "modified", "additions": 7, "deletions": 14, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/79a664d8b00505a76b53cfe017b9c80bcee7e080/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-android%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/79a664d8b00505a76b53cfe017b9c80bcee7e080/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-android%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-android%2FDockerfile?ref=79a664d8b00505a76b53cfe017b9c80bcee7e080", "patch": "@@ -6,14 +6,7 @@ RUN sh /scripts/android-base-apt-get.sh\n # ndk\n COPY scripts/android-ndk.sh /scripts/\n RUN . /scripts/android-ndk.sh && \\\n-    download_ndk android-ndk-r15c-linux-x86_64.zip && \\\n-    make_standalone_toolchain arm 14 && \\\n-    make_standalone_toolchain x86 14 && \\\n-    make_standalone_toolchain arm 21 && \\\n-    make_standalone_toolchain x86 21 && \\\n-    make_standalone_toolchain arm64 21 && \\\n-    make_standalone_toolchain x86_64 21 && \\\n-    remove_ndk\n+    download_ndk android-ndk-r25b-linux.zip\n \n # env\n ENV TARGETS=arm-linux-androideabi\n@@ -26,12 +19,12 @@ ENV TARGETS=$TARGETS,x86_64-linux-android\n ENV RUST_CONFIGURE_ARGS \\\n       --enable-extended \\\n       --enable-profiler \\\n-      --arm-linux-androideabi-ndk=/android/ndk/arm-14 \\\n-      --armv7-linux-androideabi-ndk=/android/ndk/arm-14 \\\n-      --thumbv7neon-linux-androideabi-ndk=/android/ndk/arm-14 \\\n-      --i686-linux-android-ndk=/android/ndk/x86-14 \\\n-      --aarch64-linux-android-ndk=/android/ndk/arm64-21 \\\n-      --x86_64-linux-android-ndk=/android/ndk/x86_64-21 \\\n+      --arm-linux-androideabi-ndk=/android/ndk/toolchains/llvm/prebuilt/linux-x86_64/ \\\n+      --armv7-linux-androideabi-ndk=/android/ndk/toolchains/llvm/prebuilt/linux-x86_64/ \\\n+      --thumbv7neon-linux-androideabi-ndk=/android/ndk/toolchains/llvm/prebuilt/linux-x86_64/ \\\n+      --i686-linux-android-ndk=/android/ndk/toolchains/llvm/prebuilt/linux-x86_64/ \\\n+      --aarch64-linux-android-ndk=/android/ndk/toolchains/llvm/prebuilt/linux-x86_64/ \\\n+      --x86_64-linux-android-ndk=/android/ndk/toolchains/llvm/prebuilt/linux-x86_64/ \\\n       --disable-docs\n \n ENV SCRIPT python3 ../x.py dist --host='' --target $TARGETS"}, {"sha": "4dd6ac274fd5b96dfa24873a8c4e0aea6c262cbc", "filename": "src/ci/docker/scripts/android-ndk.sh", "status": "modified", "additions": 2, "deletions": 20, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/79a664d8b00505a76b53cfe017b9c80bcee7e080/src%2Fci%2Fdocker%2Fscripts%2Fandroid-ndk.sh", "raw_url": "https://github.com/rust-lang/rust/raw/79a664d8b00505a76b53cfe017b9c80bcee7e080/src%2Fci%2Fdocker%2Fscripts%2Fandroid-ndk.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fscripts%2Fandroid-ndk.sh?ref=79a664d8b00505a76b53cfe017b9c80bcee7e080", "patch": "@@ -4,28 +4,10 @@ set -ex\n URL=https://dl.google.com/android/repository\n \n download_ndk() {\n-    mkdir -p /android/ndk\n-    cd /android/ndk\n+    mkdir /android/\n+    cd /android\n     curl -fO $URL/$1\n     unzip -q $1\n     rm $1\n     mv android-ndk-* ndk\n }\n-\n-make_standalone_toolchain() {\n-    # See https://developer.android.com/ndk/guides/standalone_toolchain.htm\n-    python3 /android/ndk/ndk/build/tools/make_standalone_toolchain.py \\\n-        --install-dir /android/ndk/$1-$2 \\\n-        --arch $1 \\\n-        --api $2\n-}\n-\n-remove_ndk() {\n-    rm -rf /android/ndk/ndk\n-}\n-\n-download_and_make_toolchain() {\n-    download_ndk $1 && \\\n-    make_standalone_toolchain $2 $3 && \\\n-    remove_ndk\n-}"}]}