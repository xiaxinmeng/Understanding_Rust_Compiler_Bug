{"sha": "3b8a354c21cec6204a268cfd1e2946744c28ed0e", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNiOGEzNTRjMjFjZWM2MjA0YTI2OGNmZDFlMjk0Njc0NGMyOGVkMGU=", "commit": {"author": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2013-04-15T22:25:29Z"}, "committer": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2013-04-15T22:25:29Z"}, "message": "core::rt: A little bit of cleanup to thread-local scheduler", "tree": {"sha": "414cc0734d748f44263ea040f183f02b9944e4fd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/414cc0734d748f44263ea040f183f02b9944e4fd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3b8a354c21cec6204a268cfd1e2946744c28ed0e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3b8a354c21cec6204a268cfd1e2946744c28ed0e", "html_url": "https://github.com/rust-lang/rust/commit/3b8a354c21cec6204a268cfd1e2946744c28ed0e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3b8a354c21cec6204a268cfd1e2946744c28ed0e/comments", "author": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1f8ebb6a8ebc5ee490158d3f4264f8aefd509045", "url": "https://api.github.com/repos/rust-lang/rust/commits/1f8ebb6a8ebc5ee490158d3f4264f8aefd509045", "html_url": "https://github.com/rust-lang/rust/commit/1f8ebb6a8ebc5ee490158d3f4264f8aefd509045"}], "stats": {"total": 33, "additions": 13, "deletions": 20}, "files": [{"sha": "020d581546aa11238b9d39ff981a90d00ba2239a", "filename": "src/libcore/rt/sched/local.rs", "status": "modified", "additions": 6, "deletions": 11, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/3b8a354c21cec6204a268cfd1e2946744c28ed0e/src%2Flibcore%2Frt%2Fsched%2Flocal.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3b8a354c21cec6204a268cfd1e2946744c28ed0e/src%2Flibcore%2Frt%2Fsched%2Flocal.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Frt%2Fsched%2Flocal.rs?ref=3b8a354c21cec6204a268cfd1e2946744c28ed0e", "patch": "@@ -39,18 +39,11 @@ pub fn take() -> ~Scheduler {\n     }\n }\n \n-/// Give the Scheduler to thread-local storage for the duration of the block\n-pub fn install(sched: ~Scheduler, f: &fn()) -> ~Scheduler {\n-    put(sched);\n-    f();\n-    return take();\n-}\n-\n /// Borrow a mutable reference to the thread-local Scheduler\n /// # Safety Note\n /// Because this leaves the Scheduler in thread-local storage it is possible\n /// For the Scheduler pointer to be aliased\n-pub fn borrow(f: &fn(&mut Scheduler)) {\n+pub unsafe fn borrow(f: &fn(&mut Scheduler)) {\n     unsafe {\n         let key = tls_key();\n         let mut void_sched: *mut c_void = tls::get(key);\n@@ -96,11 +89,13 @@ fn thread_local_scheduler_two_instances() {\n }\n \n #[test]\n-fn install_borrow_smoke_test() {\n+fn borrow_smoke_test() {\n     let scheduler = ~UvEventLoop::new_scheduler();\n-    let _scheduler = do install(scheduler) {\n+    put(scheduler);\n+    unsafe {\n         do borrow |_sched| {\n         }\n-    };\n+    }\n+    let _scheduler = take();\n }\n "}, {"sha": "2cdaf9573fb04167ca0ff91186406a65a4a4eb94", "filename": "src/libcore/rt/sched/mod.rs", "status": "modified", "additions": 7, "deletions": 9, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/3b8a354c21cec6204a268cfd1e2946744c28ed0e/src%2Flibcore%2Frt%2Fsched%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3b8a354c21cec6204a268cfd1e2946744c28ed0e/src%2Flibcore%2Frt%2Fsched%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Frt%2Fsched%2Fmod.rs?ref=3b8a354c21cec6204a268cfd1e2946744c28ed0e", "patch": "@@ -93,7 +93,9 @@ pub impl Scheduler {\n         assert!(!self.in_task_context());\n \n         // Give ownership of the scheduler (self) to the thread\n-        do self.install |scheduler| {\n+        local::put(self);\n+\n+        do Scheduler::local |scheduler| {\n             fn run_scheduler_once() {\n                 do Scheduler::local |scheduler| {\n                     if scheduler.resume_task_from_queue() {\n@@ -106,16 +108,12 @@ pub impl Scheduler {\n             scheduler.event_loop.callback(run_scheduler_once);\n             scheduler.event_loop.run();\n         }\n-    }\n \n-    fn install(~self, f: &fn(&mut Scheduler)) -> ~Scheduler {\n-        do local::install(self) {\n-            local::borrow(f)\n-        }\n+        return local::take();\n     }\n \n     fn local(f: &fn(&mut Scheduler)) {\n-        local::borrow(f)\n+        unsafe { local::borrow(f) }\n     }\n \n     // * Scheduler-context operations\n@@ -206,7 +204,7 @@ pub impl Scheduler {\n         }\n \n         // We could be executing in a different thread now\n-        do local::borrow |sched| {\n+        do Scheduler::local |sched| {\n             sched.run_cleanup_job();\n         }\n     }\n@@ -230,7 +228,7 @@ pub impl Scheduler {\n         }\n \n         // We could be executing in a different thread now\n-        do local::borrow |sched| {\n+        do Scheduler::local |sched| {\n             sched.run_cleanup_job();\n         }\n     }"}]}