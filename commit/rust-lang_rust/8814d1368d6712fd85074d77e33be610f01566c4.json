{"sha": "8814d1368d6712fd85074d77e33be610f01566c4", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg4MTRkMTM2OGQ2NzEyZmQ4NTA3NGQ3N2UzM2JlNjEwZjAxNTY2YzQ=", "commit": {"author": {"name": "Lauren\u021biu Nicola", "email": "lnicola@dend.ro", "date": "2021-02-12T17:52:51Z"}, "committer": {"name": "Lauren\u021biu Nicola", "email": "lnicola@dend.ro", "date": "2021-02-12T17:53:58Z"}, "message": "Include a commit log summary in the changelog", "tree": {"sha": "1e3a4e4bdb9adfcdf2b8ee6883f213f68e6e2894", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1e3a4e4bdb9adfcdf2b8ee6883f213f68e6e2894"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8814d1368d6712fd85074d77e33be610f01566c4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8814d1368d6712fd85074d77e33be610f01566c4", "html_url": "https://github.com/rust-lang/rust/commit/8814d1368d6712fd85074d77e33be610f01566c4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8814d1368d6712fd85074d77e33be610f01566c4/comments", "author": {"login": "lnicola", "id": 308347, "node_id": "MDQ6VXNlcjMwODM0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/308347?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lnicola", "html_url": "https://github.com/lnicola", "followers_url": "https://api.github.com/users/lnicola/followers", "following_url": "https://api.github.com/users/lnicola/following{/other_user}", "gists_url": "https://api.github.com/users/lnicola/gists{/gist_id}", "starred_url": "https://api.github.com/users/lnicola/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lnicola/subscriptions", "organizations_url": "https://api.github.com/users/lnicola/orgs", "repos_url": "https://api.github.com/users/lnicola/repos", "events_url": "https://api.github.com/users/lnicola/events{/privacy}", "received_events_url": "https://api.github.com/users/lnicola/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lnicola", "id": 308347, "node_id": "MDQ6VXNlcjMwODM0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/308347?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lnicola", "html_url": "https://github.com/lnicola", "followers_url": "https://api.github.com/users/lnicola/followers", "following_url": "https://api.github.com/users/lnicola/following{/other_user}", "gists_url": "https://api.github.com/users/lnicola/gists{/gist_id}", "starred_url": "https://api.github.com/users/lnicola/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lnicola/subscriptions", "organizations_url": "https://api.github.com/users/lnicola/orgs", "repos_url": "https://api.github.com/users/lnicola/repos", "events_url": "https://api.github.com/users/lnicola/events{/privacy}", "received_events_url": "https://api.github.com/users/lnicola/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cf44953210cbfe189043417690fabd0037a6e74e", "url": "https://api.github.com/repos/rust-lang/rust/commits/cf44953210cbfe189043417690fabd0037a6e74e", "html_url": "https://github.com/rust-lang/rust/commit/cf44953210cbfe189043417690fabd0037a6e74e"}], "stats": {"total": 58, "additions": 33, "deletions": 25}, "files": [{"sha": "d6fae52959aaa5638bc46ccca51d0075cbd398b3", "filename": "docs/dev/README.md", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/8814d1368d6712fd85074d77e33be610f01566c4/docs%2Fdev%2FREADME.md", "raw_url": "https://github.com/rust-lang/rust/raw/8814d1368d6712fd85074d77e33be610f01566c4/docs%2Fdev%2FREADME.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/docs%2Fdev%2FREADME.md?ref=8814d1368d6712fd85074d77e33be610f01566c4", "patch": "@@ -218,8 +218,7 @@ Release steps:\n      * makes a GitHub release\n      * pushes VS Code extension to the marketplace\n    * create new changelog in `rust-analyzer.github.io`\n-   * create `rust-analyzer.github.io/git.log` file with the log of merge commits since last release\n-2. While the release is in progress, fill-in the changelog using `git.log`\n+2. While the release is in progress, fill in the changelog\n 3. Commit & push the changelog\n 4. Tweet\n 5. Inside `rust-analyzer`, run `cargo xtask promote` -- this will create a PR to rust-lang/rust updating rust-analyzer's submodule."}, {"sha": "63556476ddfab346a66035ff35edfb6d9b26f146", "filename": "xtask/src/release.rs", "status": "modified", "additions": 32, "deletions": 23, "changes": 55, "blob_url": "https://github.com/rust-lang/rust/blob/8814d1368d6712fd85074d77e33be610f01566c4/xtask%2Fsrc%2Frelease.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8814d1368d6712fd85074d77e33be610f01566c4/xtask%2Fsrc%2Frelease.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/xtask%2Fsrc%2Frelease.rs?ref=8814d1368d6712fd85074d77e33be610f01566c4", "patch": "@@ -1,3 +1,5 @@\n+use std::fmt::Write;\n+\n use xshell::{cmd, cp, pushd, read_dir, write_file};\n \n use crate::{codegen, date_iso, is_release_tag, project_root, Mode, Result};\n@@ -24,6 +26,34 @@ impl ReleaseCmd {\n         let commit = cmd!(\"git rev-parse HEAD\").read()?;\n         let changelog_n = read_dir(changelog_dir.as_path())?.len();\n \n+        for &adoc in [\n+            \"manual.adoc\",\n+            \"generated_assists.adoc\",\n+            \"generated_config.adoc\",\n+            \"generated_diagnostic.adoc\",\n+            \"generated_features.adoc\",\n+        ]\n+        .iter()\n+        {\n+            let src = project_root().join(\"./docs/user/\").join(adoc);\n+            let dst = website_root.join(adoc);\n+            cp(src, dst)?;\n+        }\n+\n+        let tags = cmd!(\"git tag --list\").read()?;\n+        let prev_tag = tags.lines().filter(|line| is_release_tag(line)).last().unwrap();\n+\n+        let git_log = cmd!(\"git log {prev_tag}..HEAD --merges --reverse\").read()?;\n+        let mut git_log_summary = String::new();\n+        for line in git_log.lines() {\n+            let line = line.trim_start();\n+            if let Some(p) = line.find(':') {\n+                if let Ok(pr) = line[..p].parse::<u32>() {\n+                    writeln!(git_log_summary, \"* pr:{}[]{}\", pr, &line[p + 1..]).unwrap();\n+                }\n+            }\n+        }\n+\n         let contents = format!(\n             \"\\\n = Changelog #{}\n@@ -40,39 +70,18 @@ https://github.com/sponsors/rust-analyzer[GitHub Sponsors].\n \n == New Features\n \n-* pr:[] .\n+{}\n \n == Fixes\n \n == Internal Improvements\n \",\n-            changelog_n, commit, today\n+            changelog_n, commit, today, git_log_summary\n         );\n \n         let path = changelog_dir.join(format!(\"{}-changelog-{}.adoc\", today, changelog_n));\n         write_file(&path, &contents)?;\n \n-        for &adoc in [\n-            \"manual.adoc\",\n-            \"generated_assists.adoc\",\n-            \"generated_config.adoc\",\n-            \"generated_diagnostic.adoc\",\n-            \"generated_features.adoc\",\n-        ]\n-        .iter()\n-        {\n-            let src = project_root().join(\"./docs/user/\").join(adoc);\n-            let dst = website_root.join(adoc);\n-            cp(src, dst)?;\n-        }\n-\n-        let tags = cmd!(\"git tag --list\").read()?;\n-        let prev_tag = tags.lines().filter(|line| is_release_tag(line)).last().unwrap();\n-\n-        let git_log = cmd!(\"git log {prev_tag}..HEAD --merges --reverse\").read()?;\n-        let git_log_dst = website_root.join(\"git.log\");\n-        write_file(git_log_dst, &git_log)?;\n-\n         Ok(())\n     }\n }"}]}