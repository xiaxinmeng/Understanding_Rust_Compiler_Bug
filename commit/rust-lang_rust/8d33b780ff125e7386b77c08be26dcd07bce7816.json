{"sha": "8d33b780ff125e7386b77c08be26dcd07bce7816", "node_id": "C_kwDOAAsO6NoAKDhkMzNiNzgwZmYxMjVlNzM4NmI3N2MwOGJlMjZkY2QwN2JjZTc4MTY", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2023-02-22T09:35:10Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-02-22T09:35:10Z"}, "message": "Rollup merge of #108310 - GuillaumeGomez:fix-reexports-duplicated-attributes, r=notriddle\n\nrustdoc: Fix duplicated attributes for first reexport\n\nFixes #108281.\n\nr? ``@notriddle``", "tree": {"sha": "ed34e8a5e35a618380cf97e8391f87acdafb8276", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ed34e8a5e35a618380cf97e8391f87acdafb8276"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8d33b780ff125e7386b77c08be26dcd07bce7816", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJj9eHOCRBK7hj4Ov3rIwAAlEsIAFAJxrOi649qAclzdalj/s0R\n/8sdf6SYSUwwuz08i6ZUgDHm8Q5R5jN9n9nnA6S/dL9h5CI8u7+YgmrdczEoICaw\n+xqnxTFF5fTrjMznhnKyVg0mZjTTbF7Dvjcj6ZGgRQEoZh8tKRx6m+NspLVnD421\nR4vIgJ/mRbc9fLQHH8WqNjlLy7+0OQygEHuiXYijdIYCKVAdcV3PRDoKhqt8M1+n\nfhbpMhrWkJ16MPIfy4DQW0QIpzzyd044fNE6iOenxIn89FbsiyQMlK84rvtiQ63t\nUgIHXAgOtef+k1oYnzJhlYLoYVQlMn+84hB2k+b8h5IvQOsRfzb1mdQBpnPHmGY=\n=nGEZ\n-----END PGP SIGNATURE-----\n", "payload": "tree ed34e8a5e35a618380cf97e8391f87acdafb8276\nparent 8fd47a614b34faca40d2b5b70165831e2a8b8593\nparent fec6ad60589c4c4bd2535190bf756345a9bb3bbc\nauthor Guillaume Gomez <guillaume1.gomez@gmail.com> 1677058510 +0100\ncommitter GitHub <noreply@github.com> 1677058510 +0100\n\nRollup merge of #108310 - GuillaumeGomez:fix-reexports-duplicated-attributes, r=notriddle\n\nrustdoc: Fix duplicated attributes for first reexport\n\nFixes #108281.\n\nr? ``@notriddle``\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8d33b780ff125e7386b77c08be26dcd07bce7816", "html_url": "https://github.com/rust-lang/rust/commit/8d33b780ff125e7386b77c08be26dcd07bce7816", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8d33b780ff125e7386b77c08be26dcd07bce7816/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8fd47a614b34faca40d2b5b70165831e2a8b8593", "url": "https://api.github.com/repos/rust-lang/rust/commits/8fd47a614b34faca40d2b5b70165831e2a8b8593", "html_url": "https://github.com/rust-lang/rust/commit/8fd47a614b34faca40d2b5b70165831e2a8b8593"}, {"sha": "fec6ad60589c4c4bd2535190bf756345a9bb3bbc", "url": "https://api.github.com/repos/rust-lang/rust/commits/fec6ad60589c4c4bd2535190bf756345a9bb3bbc", "html_url": "https://github.com/rust-lang/rust/commit/fec6ad60589c4c4bd2535190bf756345a9bb3bbc"}], "stats": {"total": 49, "additions": 42, "deletions": 7}, "files": [{"sha": "5541136ef490d8f9192c414e25f9a8dbf559f5d4", "filename": "src/librustdoc/clean/mod.rs", "status": "modified", "additions": 17, "deletions": 7, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/8d33b780ff125e7386b77c08be26dcd07bce7816/src%2Flibrustdoc%2Fclean%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8d33b780ff125e7386b77c08be26dcd07bce7816/src%2Flibrustdoc%2Fclean%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Fmod.rs?ref=8d33b780ff125e7386b77c08be26dcd07bce7816", "patch": "@@ -2114,17 +2114,29 @@ fn get_all_import_attributes<'hir>(\n     attributes: &mut Vec<ast::Attribute>,\n     is_inline: bool,\n ) {\n+    let mut first = true;\n     let hir_map = tcx.hir();\n     let mut visitor = OneLevelVisitor::new(hir_map, target_def_id);\n     let mut visited = FxHashSet::default();\n+\n     // If the item is an import and has at least a path with two parts, we go into it.\n     while let hir::ItemKind::Use(path, _) = item.kind && visited.insert(item.hir_id()) {\n-        // We add the attributes from this import into the list.\n-        add_without_unwanted_attributes(attributes, hir_map.attrs(item.hir_id()), is_inline);\n+        if first {\n+            // This is the \"original\" reexport so we get all its attributes without filtering them.\n+            attributes.extend_from_slice(hir_map.attrs(item.hir_id()));\n+            first = false;\n+        } else {\n+            add_without_unwanted_attributes(attributes, hir_map.attrs(item.hir_id()), is_inline);\n+        }\n \n-        let def_id = if path.segments.len() > 1 {\n-            match path.segments[path.segments.len() - 2].res {\n+        let def_id = if let [.., parent_segment, _] = &path.segments {\n+            match parent_segment.res {\n                 hir::def::Res::Def(_, def_id) => def_id,\n+                _ if parent_segment.ident.name == kw::Crate => {\n+                    // In case the \"parent\" is the crate, it'll give `Res::Err` so we need to\n+                    // circumvent it this way.\n+                    tcx.parent(item.owner_id.def_id.to_def_id())\n+                }\n                 _ => break,\n             }\n         } else {\n@@ -2341,9 +2353,7 @@ fn clean_maybe_renamed_item<'tcx>(\n         if let Some(import_id) = import_id &&\n             let Some(hir::Node::Item(use_node)) = cx.tcx.hir().find_by_def_id(import_id)\n         {\n-            // First, we add the attributes from the current import.\n-            extra_attrs.extend_from_slice(inline::load_attrs(cx, import_id.to_def_id()));\n-            let is_inline = extra_attrs.lists(sym::doc).get_word_attr(sym::inline).is_some();\n+            let is_inline = inline::load_attrs(cx, import_id.to_def_id()).lists(sym::doc).get_word_attr(sym::inline).is_some();\n             // Then we get all the various imports' attributes.\n             get_all_import_attributes(use_node, cx.tcx, item.owner_id.def_id, &mut extra_attrs, is_inline);\n             add_without_unwanted_attributes(&mut extra_attrs, inline::load_attrs(cx, def_id), is_inline);"}, {"sha": "8e1b6ba88a692a912c3ce474642d32c9cf31bcef", "filename": "tests/rustdoc/issue-108281.rs", "status": "added", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/8d33b780ff125e7386b77c08be26dcd07bce7816/tests%2Frustdoc%2Fissue-108281.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8d33b780ff125e7386b77c08be26dcd07bce7816/tests%2Frustdoc%2Fissue-108281.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frustdoc%2Fissue-108281.rs?ref=8d33b780ff125e7386b77c08be26dcd07bce7816", "patch": "@@ -0,0 +1,25 @@\n+// Regression test for <https://github.com/rust-lang/rust/issues/108281>.\n+// It ensures that the attributes on the first reexport are not duplicated.\n+\n+#![crate_name = \"foo\"]\n+\n+// @has 'foo/index.html'\n+\n+#[doc(hidden)]\n+pub fn bar() {}\n+mod sub {\n+    pub fn public() {}\n+}\n+\n+// @matches - '//*[@class=\"desc docblock-short\"]' '^Displayed$'\n+/// Displayed\n+#[doc(inline)]\n+pub use crate::bar as Bar;\n+// @matches - '//*[@class=\"desc docblock-short\"]' '^Hello\\sDisplayed$'\n+#[doc(inline)]\n+/// Hello\n+pub use crate::Bar as Bar2;\n+\n+// @matches - '//*[@class=\"desc docblock-short\"]' '^Public$'\n+/// Public\n+pub use crate::sub::public as Public;"}]}