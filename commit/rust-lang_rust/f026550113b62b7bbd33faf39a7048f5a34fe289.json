{"sha": "f026550113b62b7bbd33faf39a7048f5a34fe289", "node_id": "C_kwDOAAsO6NoAKGYwMjY1NTAxMTNiNjJiN2JiZDMzZmFmMzlhNzA0OGY1YTM0ZmUyODk", "commit": {"author": {"name": "Joshua Nelson", "email": "jnelson@cloudflare.com", "date": "2022-02-07T00:39:42Z"}, "committer": {"name": "Joshua Nelson", "email": "jnelson@cloudflare.com", "date": "2022-02-07T01:29:31Z"}, "message": "rustdoc: Special-case macro lookups less\n\nPreviously, rustdoc had 3 fallbacks it used:\n1. `resolve_macro_path`\n2. `all_macros`\n3. `resolve_str_path_error`\n\nIdeally, it would only use `resolve_str_path_error`, to be consistent with other namespaces.\nUnfortunately, that doesn't consider macros that aren't defined at module scope;\nconsider for instance\n```rust\n{\n    struct S;\n\n    macro_rules! mac { () => {} }\n    // `mac`'s scope starts here\n\n    /// `mac` <- `resolve_str_path_error` won't see this\n   struct Z;\n\n    //`mac`'s scope ends here\n}\n```\n\nThis changes it to only use `all_macros` and `resolve_str_path_error`, and gives\n`resolve_str_path_error` precedence over `all_macros` in case there are two macros with the same\nname in the same module.\n\nThis also adds a failing test case which will catch trying to remove `all_macros`.", "tree": {"sha": "10418785cdd036c26338d4fdd9fffe8e5a210850", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/10418785cdd036c26338d4fdd9fffe8e5a210850"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f026550113b62b7bbd33faf39a7048f5a34fe289", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f026550113b62b7bbd33faf39a7048f5a34fe289", "html_url": "https://github.com/rust-lang/rust/commit/f026550113b62b7bbd33faf39a7048f5a34fe289", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f026550113b62b7bbd33faf39a7048f5a34fe289/comments", "author": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7b43cfc9b25ac4a906bd56d32d3111085dd9e6a1", "url": "https://api.github.com/repos/rust-lang/rust/commits/7b43cfc9b25ac4a906bd56d32d3111085dd9e6a1", "html_url": "https://github.com/rust-lang/rust/commit/7b43cfc9b25ac4a906bd56d32d3111085dd9e6a1"}], "stats": {"total": 33, "additions": 14, "deletions": 19}, "files": [{"sha": "8621fe6ba1b93a0a19a5bd90ff8edf4791e56d54", "filename": "src/librustdoc/passes/collect_intra_doc_links.rs", "status": "modified", "additions": 5, "deletions": 19, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/f026550113b62b7bbd33faf39a7048f5a34fe289/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f026550113b62b7bbd33faf39a7048f5a34fe289/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs?ref=f026550113b62b7bbd33faf39a7048f5a34fe289", "patch": "@@ -2,10 +2,8 @@\n //!\n //! [RFC 1946]: https://github.com/rust-lang/rfcs/blob/master/text/1946-intra-rustdoc-links.md\n \n-use rustc_ast as ast;\n use rustc_data_structures::{fx::FxHashMap, stable_set::FxHashSet};\n use rustc_errors::{Applicability, DiagnosticBuilder};\n-use rustc_expand::base::SyntaxExtensionKind;\n use rustc_hir::def::{\n     DefKind,\n     Namespace::{self, *},\n@@ -14,7 +12,6 @@ use rustc_hir::def::{\n use rustc_hir::def_id::{CrateNum, DefId, CRATE_DEF_ID};\n use rustc_middle::ty::{DefIdTree, Ty, TyCtxt};\n use rustc_middle::{bug, span_bug, ty};\n-use rustc_resolve::ParentScope;\n use rustc_session::lint::Lint;\n use rustc_span::hygiene::MacroKind;\n use rustc_span::symbol::{sym, Ident, Symbol};\n@@ -486,23 +483,9 @@ impl<'a, 'tcx> LinkCollector<'a, 'tcx> {\n         path_str: &'a str,\n         module_id: DefId,\n     ) -> Result<Res, ResolutionFailure<'a>> {\n-        let path = ast::Path::from_ident(Ident::from_str(path_str));\n         self.cx.enter_resolver(|resolver| {\n-            // FIXME(jynelson): does this really need 3 separate lookups?\n-            if let Ok((Some(ext), res)) = resolver.resolve_macro_path(\n-                &path,\n-                None,\n-                &ParentScope::module(resolver.graph_root(), resolver),\n-                false,\n-                false,\n-            ) {\n-                if let SyntaxExtensionKind::LegacyBang { .. } = ext.kind {\n-                    return Ok(res.try_into().unwrap());\n-                }\n-            }\n-            if let Some(&res) = resolver.all_macros().get(&Symbol::intern(path_str)) {\n-                return Ok(res.try_into().unwrap());\n-            }\n+            // NOTE: this needs 2 separate lookups because `resolve_str_path_error` doesn't take\n+            // lexical scope into account (it ignores all macros not defined at the mod-level)\n             debug!(\"resolving {} as a macro in the module {:?}\", path_str, module_id);\n             if let Ok((_, res)) =\n                 resolver.resolve_str_path_error(DUMMY_SP, path_str, MacroNS, module_id)\n@@ -512,6 +495,9 @@ impl<'a, 'tcx> LinkCollector<'a, 'tcx> {\n                     return Ok(res);\n                 }\n             }\n+            if let Some(&res) = resolver.all_macros().get(&Symbol::intern(path_str)) {\n+                return Ok(res.try_into().unwrap());\n+            }\n             Err(ResolutionFailure::NotResolved {\n                 module_id,\n                 partial_res: None,"}, {"sha": "a14e4bdf1d706195de9551a46c704051349072e8", "filename": "src/test/rustdoc-ui/intra-doc/macro-rules.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/f026550113b62b7bbd33faf39a7048f5a34fe289/src%2Ftest%2Frustdoc-ui%2Fintra-doc%2Fmacro-rules.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f026550113b62b7bbd33faf39a7048f5a34fe289/src%2Ftest%2Frustdoc-ui%2Fintra-doc%2Fmacro-rules.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fintra-doc%2Fmacro-rules.rs?ref=f026550113b62b7bbd33faf39a7048f5a34fe289", "patch": "@@ -0,0 +1,9 @@\n+// check-pass\n+#![allow(rustdoc::private_intra_doc_links)]\n+\n+macro_rules! foo {\n+    () => {};\n+}\n+\n+/// [foo!]\n+pub fn baz() {}"}]}