{"sha": "7ce4afbddaa2e58378d8a61a4f6f96dc53acd956", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdjZTRhZmJkZGFhMmU1ODM3OGQ4YTYxYTRmNmY5NmRjNTNhY2Q5NTY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-02-15T14:57:44Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-02-15T14:57:44Z"}, "message": "Auto merge of #31656 - jonas-schievink:mirdump, r=nrc\n\nThis allows obtaining a textual MIR dump for individual items or all items in the crate.\n\nI haven't added any tests since ~~I'm too lazy~~ this is an unstable debugging option, but I'll add one if required.\n\nMIR for a single function can now be dumped using `rustc -Zunstable-options --unpretty mir=my_function` and no longer requires the use of in-source `#[rustc_mir]` attributes.\n\nBlocks rust-lang/rust-playpen#154 (if MIR dump support from the playpen is even wanted).\n\nExample output:\n```rust\nfn main() {\n    let x = Some(0);\n    x.unwrap_or_else(|| 1);\n}\n```\n\n```\nMIR for expr || 1 (id=16)\nfn(arg0: [closure@test.rs:3:22: 3:26]) -> i32 {\n    let mut tmp0: ();\n\n    bb0: {\n        return = const 1;\n        goto -> bb1;\n    }\n\n    bb1: {\n        return;\n    }\n}\nMIR for fn main::main (id=4)\nfn() -> () {\n    let var0: core::option::Option<i32>; // x\n    let mut tmp0: ();\n    let mut tmp1: i32;\n    let mut tmp2: core::option::Option<i32>;\n    let mut tmp3: [closure@test.rs:3:22: 3:26];\n\n    bb0: {\n        var0 = core::option::Option::Some(const 0);\n        tmp2 = var0;\n        tmp3 = [closure@test.rs:3:22: 3:26];\n        tmp1 = core::option::Option<T>::unwrap_or_else(tmp2, tmp3) -> bb2;\n    }\n\n    bb1: {\n        return;\n    }\n\n    bb2: {\n        drop(tmp1) -> bb3;\n    }\n\n    bb3: {\n        return = ();\n        goto -> bb1;\n    }\n}\n```", "tree": {"sha": "1826a0c33403e19f9f1909019ece1d2c34a0c4fa", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1826a0c33403e19f9f1909019ece1d2c34a0c4fa"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7ce4afbddaa2e58378d8a61a4f6f96dc53acd956", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7ce4afbddaa2e58378d8a61a4f6f96dc53acd956", "html_url": "https://github.com/rust-lang/rust/commit/7ce4afbddaa2e58378d8a61a4f6f96dc53acd956", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7ce4afbddaa2e58378d8a61a4f6f96dc53acd956/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3a254fe4bd10f630da76e89cbdc1275413a189d8", "url": "https://api.github.com/repos/rust-lang/rust/commits/3a254fe4bd10f630da76e89cbdc1275413a189d8", "html_url": "https://github.com/rust-lang/rust/commit/3a254fe4bd10f630da76e89cbdc1275413a189d8"}, {"sha": "67aa7b2389a6dcea97d3d5f05fe3be8ece3acc6c", "url": "https://api.github.com/repos/rust-lang/rust/commits/67aa7b2389a6dcea97d3d5f05fe3be8ece3acc6c", "html_url": "https://github.com/rust-lang/rust/commit/67aa7b2389a6dcea97d3d5f05fe3be8ece3acc6c"}], "stats": {"total": 50, "additions": 49, "deletions": 1}, "files": [{"sha": "0517357892161c6ffdb1da1bbeb460841292f88d", "filename": "src/librustc_driver/pretty.rs", "status": "modified", "additions": 49, "deletions": 1, "changes": 50, "blob_url": "https://github.com/rust-lang/rust/blob/7ce4afbddaa2e58378d8a61a4f6f96dc53acd956/src%2Flibrustc_driver%2Fpretty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7ce4afbddaa2e58378d8a61a4f6f96dc53acd956/src%2Flibrustc_driver%2Fpretty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Fpretty.rs?ref=7ce4afbddaa2e58378d8a61a4f6f96dc53acd956", "patch": "@@ -30,6 +30,8 @@ use rustc_borrowck::graphviz as borrowck_dot;\n use rustc_resolve as resolve;\n use rustc_metadata::cstore::CStore;\n \n+use rustc_mir::pretty::write_mir_pretty;\n+\n use syntax::ast::{self, BlockCheckMode};\n use syntax::codemap;\n use syntax::fold::{self, Folder};\n@@ -77,6 +79,7 @@ pub enum PpMode {\n     PpmSource(PpSourceMode),\n     PpmHir(PpSourceMode),\n     PpmFlowGraph(PpFlowGraphMode),\n+    PpmMir,\n }\n \n pub fn parse_pretty(sess: &Session,\n@@ -96,14 +99,15 @@ pub fn parse_pretty(sess: &Session,\n         (\"hir\", true) => PpmHir(PpmNormal),\n         (\"hir,identified\", true) => PpmHir(PpmIdentified),\n         (\"hir,typed\", true) => PpmHir(PpmTyped),\n+        (\"mir\", true) => PpmMir,\n         (\"flowgraph\", true) => PpmFlowGraph(PpFlowGraphMode::Default),\n         (\"flowgraph,unlabelled\", true) => PpmFlowGraph(PpFlowGraphMode::UnlabelledEdges),\n         _ => {\n             if extended {\n                 sess.fatal(&format!(\"argument to `unpretty` must be one of `normal`, \\\n                                      `expanded`, `flowgraph[,unlabelled]=<nodeid>`, \\\n                                      `identified`, `expanded,identified`, `everybody_loops`, \\\n-                                     `hir`, `hir,identified`, or `hir,typed`; got {}\",\n+                                     `hir`, `hir,identified`, `hir,typed`, or `mir`; got {}\",\n                                     name));\n             } else {\n                 sess.fatal(&format!(\"argument to `pretty` must be one of `normal`, `expanded`, \\\n@@ -569,6 +573,7 @@ fn needs_ast_map(ppm: &PpMode, opt_uii: &Option<UserIdentifiedItem>) -> bool {\n         PpmSource(PpmExpandedIdentified) |\n         PpmSource(PpmExpandedHygiene) |\n         PpmHir(_) |\n+        PpmMir |\n         PpmFlowGraph(_) => true,\n         PpmSource(PpmTyped) => panic!(\"invalid state\"),\n     }\n@@ -584,6 +589,7 @@ fn needs_expansion(ppm: &PpMode) -> bool {\n         PpmSource(PpmExpandedIdentified) |\n         PpmSource(PpmExpandedHygiene) |\n         PpmHir(_) |\n+        PpmMir |\n         PpmFlowGraph(_) => true,\n         PpmSource(PpmTyped) => panic!(\"invalid state\"),\n     }\n@@ -801,6 +807,48 @@ pub fn pretty_print_input(sess: Session,\n             })\n         }\n \n+        (PpmMir, None) => {\n+            debug!(\"pretty printing MIR for whole crate\");\n+            let ast_map = ast_map.expect(\"--unpretty mir missing ast_map\");\n+            abort_on_err(driver::phase_3_run_analysis_passes(&sess,\n+                                                             &cstore,\n+                                                             ast_map,\n+                                                             &arenas,\n+                                                             &id,\n+                                                             resolve::MakeGlobMap::No,\n+                                                             |tcx, mir_map, _, _| {\n+                let mir_map = mir_map.unwrap();\n+\n+                for (nodeid, mir) in &mir_map.map {\n+                    try!(writeln!(out, \"MIR for {}\", tcx.map.node_to_string(*nodeid)));\n+                    try!(write_mir_pretty(mir, &mut out));\n+                }\n+\n+                Ok(())\n+            }), &sess)\n+        }\n+\n+        (PpmMir, Some(uii)) => {\n+            debug!(\"pretty printing MIR for {:?}\", uii);\n+            let ast_map = ast_map.expect(\"--unpretty mir missing ast_map\");\n+            let nodeid = uii.to_one_node_id(\"--unpretty\", &sess, &ast_map);\n+\n+            abort_on_err(driver::phase_3_run_analysis_passes(&sess,\n+                                                             &cstore,\n+                                                             ast_map,\n+                                                             &arenas,\n+                                                             &id,\n+                                                             resolve::MakeGlobMap::No,\n+                                                             |tcx, mir_map, _, _| {\n+                let mir_map = mir_map.unwrap();\n+                try!(writeln!(out, \"MIR for {}\", tcx.map.node_to_string(nodeid)));\n+                let mir = mir_map.map.get(&nodeid).unwrap_or_else(|| {\n+                    sess.fatal(&format!(\"no MIR map entry for node {}\", nodeid))\n+                });\n+                write_mir_pretty(mir, &mut out)\n+            }), &sess)\n+        }\n+\n         (PpmFlowGraph(mode), opt_uii) => {\n             debug!(\"pretty printing flow graph for {:?}\", opt_uii);\n             let uii = opt_uii.unwrap_or_else(|| {"}]}