{"sha": "59c0ff6314f4b47bbb4b92f17e34d6886b8c0cba", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU5YzBmZjYzMTRmNGI0N2JiYjRiOTJmMTdlMzRkNjg4NmI4YzBjYmE=", "commit": {"author": {"name": "Jonathan Turner", "email": "jonathandturner@users.noreply.github.com", "date": "2016-09-02T22:28:51Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2016-09-02T22:28:51Z"}, "message": "Rollup merge of #36171 - jonathandturner:temporary_value, r=nikomatsakis\n\nUpdate lifetime errors to specifically note temporaries\n\nThis PR updates the error message we give in the case of a temporary value not living long enough.\n\nBefore:\n\n<img width=\"497\" alt=\"screen shot 2016-08-31 at 10 02 47 am\" src=\"https://cloud.githubusercontent.com/assets/547158/18138551/27a06794-6f62-11e6-9ee2-bdf8bed75ca7.png\">\n\nNow:\n\n<img width=\"488\" alt=\"screen shot 2016-08-31 at 10 03 01 am\" src=\"https://cloud.githubusercontent.com/assets/547158/18138557/2e5cf322-6f62-11e6-9047-4a78abf3d78c.png\">\n\nSpecifically, it makes the following changes:\n\n* Detects if a temporary is being used.  If so, it changes the labels to mention that a temporary value specifically is in question\n* Simplifies wording of the existing labels to focus on lifetimes rather than values being valid\n* Changes the help to a note, since the help+span wasn't as helpful (and sometimes more confusing) than just a note.\n\nr? @nikomatsakis", "tree": {"sha": "6a934fd10f7ac6b000eb4c17bbcdcfe1ac4ab5fc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6a934fd10f7ac6b000eb4c17bbcdcfe1ac4ab5fc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/59c0ff6314f4b47bbb4b92f17e34d6886b8c0cba", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/59c0ff6314f4b47bbb4b92f17e34d6886b8c0cba", "html_url": "https://github.com/rust-lang/rust/commit/59c0ff6314f4b47bbb4b92f17e34d6886b8c0cba", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/59c0ff6314f4b47bbb4b92f17e34d6886b8c0cba/comments", "author": {"login": "jonathandturner", "id": 111457284, "node_id": "O_kgDOBqS0BA", "avatar_url": "https://avatars.githubusercontent.com/u/111457284?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonathandturner", "html_url": "https://github.com/jonathandturner", "followers_url": "https://api.github.com/users/jonathandturner/followers", "following_url": "https://api.github.com/users/jonathandturner/following{/other_user}", "gists_url": "https://api.github.com/users/jonathandturner/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonathandturner/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonathandturner/subscriptions", "organizations_url": "https://api.github.com/users/jonathandturner/orgs", "repos_url": "https://api.github.com/users/jonathandturner/repos", "events_url": "https://api.github.com/users/jonathandturner/events{/privacy}", "received_events_url": "https://api.github.com/users/jonathandturner/received_events", "type": "Organization", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9327edd773d6ff0dfb5e6c799ed4016f936f6575", "url": "https://api.github.com/repos/rust-lang/rust/commits/9327edd773d6ff0dfb5e6c799ed4016f936f6575", "html_url": "https://github.com/rust-lang/rust/commit/9327edd773d6ff0dfb5e6c799ed4016f936f6575"}, {"sha": "439afcd9747808fb187b0676d63af5375a677e3d", "url": "https://api.github.com/repos/rust-lang/rust/commits/439afcd9747808fb187b0676d63af5375a677e3d", "html_url": "https://github.com/rust-lang/rust/commit/439afcd9747808fb187b0676d63af5375a677e3d"}], "stats": {"total": 73, "additions": 44, "deletions": 29}, "files": [{"sha": "67152ed04ec1def340185f8d902b0ae1cf3c5ead", "filename": "src/librustc_borrowck/borrowck/mod.rs", "status": "modified", "additions": 14, "deletions": 8, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/59c0ff6314f4b47bbb4b92f17e34d6886b8c0cba/src%2Flibrustc_borrowck%2Fborrowck%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/59c0ff6314f4b47bbb4b92f17e34d6886b8c0cba/src%2Flibrustc_borrowck%2Fborrowck%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_borrowck%2Fborrowck%2Fmod.rs?ref=59c0ff6314f4b47bbb4b92f17e34d6886b8c0cba", "patch": "@@ -1028,6 +1028,12 @@ impl<'a, 'tcx> BorrowckCtxt<'a, 'tcx> {\n             }\n \n             err_out_of_scope(super_scope, sub_scope, cause) => {\n+                let (value_kind, value_msg) = match err.cmt.cat {\n+                    mc::Categorization::Rvalue(_) =>\n+                        (\"temporary value\", \"temporary value created here\"),\n+                    _ =>\n+                        (\"borrowed value\", \"does not live long enough\")\n+                };\n                 match cause {\n                     euv::ClosureCapture(s) => {\n                         // The primary span starts out as the closure creation point.\n@@ -1038,13 +1044,13 @@ impl<'a, 'tcx> BorrowckCtxt<'a, 'tcx> {\n                             Some(primary) => {\n                                 db.span = MultiSpan::from_span(s);\n                                 db.span_label(primary, &format!(\"capture occurs here\"));\n-                                db.span_label(s, &format!(\"does not live long enough\"));\n+                                db.span_label(s, &value_msg);\n                             }\n                             None => ()\n                         }\n                     }\n                     _ => {\n-                        db.span_label(error_span, &format!(\"does not live long enough\"));\n+                        db.span_label(error_span, &value_msg);\n                     }\n                 }\n \n@@ -1053,14 +1059,15 @@ impl<'a, 'tcx> BorrowckCtxt<'a, 'tcx> {\n \n                 match (sub_span, super_span) {\n                     (Some(s1), Some(s2)) if s1 == s2 => {\n-                        db.span_label(s1, &\"borrowed value dropped before borrower\");\n+                        db.span_label(s1, &format!(\"{} dropped before borrower\", value_kind));\n                         db.note(\"values in a scope are dropped in the opposite order \\\n                                 they are created\");\n                     }\n                     _ => {\n                         match sub_span {\n                             Some(s) => {\n-                                db.span_label(s, &\"borrowed value must be valid until here\");\n+                                db.span_label(s, &format!(\"{} needs to live until here\",\n+                                                          value_kind));\n                             }\n                             None => {\n                                 self.tcx.note_and_explain_region(\n@@ -1072,7 +1079,7 @@ impl<'a, 'tcx> BorrowckCtxt<'a, 'tcx> {\n                         }\n                         match super_span {\n                             Some(s) => {\n-                                db.span_label(s, &\"borrowed value only valid until here\");\n+                                db.span_label(s, &format!(\"{} only lives until here\", value_kind));\n                             }\n                             None => {\n                                 self.tcx.note_and_explain_region(\n@@ -1085,9 +1092,8 @@ impl<'a, 'tcx> BorrowckCtxt<'a, 'tcx> {\n                     }\n                 }\n \n-                if let Some(span) = statement_scope_span(self.tcx, super_scope) {\n-                    db.span_help(span,\n-                                 \"consider using a `let` binding to increase its lifetime\");\n+                if let Some(_) = statement_scope_span(self.tcx, super_scope) {\n+                    db.note(\"consider using a `let` binding to increase its lifetime\");\n                 }\n             }\n "}, {"sha": "95c74348e788bd1c7bebe746c21038d24347fdc2", "filename": "src/test/compile-fail/borrowck/borrowck-let-suggestion-suffixes.rs", "status": "modified", "additions": 12, "deletions": 12, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/59c0ff6314f4b47bbb4b92f17e34d6886b8c0cba/src%2Ftest%2Fcompile-fail%2Fborrowck%2Fborrowck-let-suggestion-suffixes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/59c0ff6314f4b47bbb4b92f17e34d6886b8c0cba/src%2Ftest%2Fcompile-fail%2Fborrowck%2Fborrowck-let-suggestion-suffixes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fborrowck%2Fborrowck-let-suggestion-suffixes.rs?ref=59c0ff6314f4b47bbb4b92f17e34d6886b8c0cba", "patch": "@@ -25,36 +25,36 @@ fn f() {\n \n     v3.push(&'x');           // statement 6\n     //~^ ERROR borrowed value does not live long enough\n-    //~| NOTE does not live long enough\n-    //~| NOTE borrowed value only valid until here\n-    //~| HELP consider using a `let` binding to increase its lifetime\n+    //~| NOTE temporary value created here\n+    //~| NOTE temporary value only lives until here\n+    //~| NOTE consider using a `let` binding to increase its lifetime\n \n     {\n \n         let mut v4 = Vec::new(); // (sub) statement 0\n \n         v4.push(&'y');\n         //~^ ERROR borrowed value does not live long enough\n-        //~| NOTE does not live long enough\n-        //~| NOTE borrowed value only valid until here\n-        //~| HELP consider using a `let` binding to increase its lifetime\n+        //~| NOTE temporary value created here\n+        //~| NOTE temporary value only lives until here\n+        //~| NOTE consider using a `let` binding to increase its lifetime\n \n     }                       // (statement 7)\n-    //~^ NOTE borrowed value must be valid until here\n+    //~^ NOTE temporary value needs to live until here\n \n     let mut v5 = Vec::new(); // statement 8\n \n     v5.push(&'z');\n     //~^ ERROR borrowed value does not live long enough\n-    //~| NOTE does not live long enough\n-    //~| NOTE borrowed value only valid until here\n-    //~| HELP consider using a `let` binding to increase its lifetime\n+    //~| NOTE temporary value created here\n+    //~| NOTE temporary value only lives until here\n+    //~| NOTE consider using a `let` binding to increase its lifetime\n \n     v1.push(&old[0]);\n }\n //~^ NOTE borrowed value dropped before borrower\n-//~| NOTE borrowed value must be valid until here\n-//~| NOTE borrowed value must be valid until here\n+//~| NOTE temporary value needs to live until here\n+//~| NOTE temporary value needs to live until here\n \n fn main() {\n     f();"}, {"sha": "f5ea7a2108e79b207539a967dea677fdcea92b9a", "filename": "src/test/compile-fail/regions-escape-loop-via-vec.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/59c0ff6314f4b47bbb4b92f17e34d6886b8c0cba/src%2Ftest%2Fcompile-fail%2Fregions-escape-loop-via-vec.rs", "raw_url": "https://github.com/rust-lang/rust/raw/59c0ff6314f4b47bbb4b92f17e34d6886b8c0cba/src%2Ftest%2Fcompile-fail%2Fregions-escape-loop-via-vec.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fregions-escape-loop-via-vec.rs?ref=59c0ff6314f4b47bbb4b92f17e34d6886b8c0cba", "patch": "@@ -24,8 +24,8 @@ fn broken() {\n         x += 1; //~ ERROR cannot assign\n         //~^ NOTE assignment to borrowed `x` occurs here\n     }\n-    //~^ NOTE borrowed value only valid until here\n+    //~^ NOTE borrowed value only lives until here\n }\n-//~^ NOTE borrowed value must be valid until here\n+//~^ NOTE borrowed value needs to live until here\n \n fn main() { }"}, {"sha": "eeafaab44c62007efc8ba12c1114f1d50e9d00fb", "filename": "src/test/ui/lifetimes/borrowck-let-suggestion.rs", "status": "renamed", "additions": 0, "deletions": 5, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/59c0ff6314f4b47bbb4b92f17e34d6886b8c0cba/src%2Ftest%2Fui%2Flifetimes%2Fborrowck-let-suggestion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/59c0ff6314f4b47bbb4b92f17e34d6886b8c0cba/src%2Ftest%2Fui%2Flifetimes%2Fborrowck-let-suggestion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flifetimes%2Fborrowck-let-suggestion.rs?ref=59c0ff6314f4b47bbb4b92f17e34d6886b8c0cba", "patch": "@@ -10,12 +10,7 @@\n \n fn f() {\n     let x = [1].iter();\n-    //~^ ERROR borrowed value does not live long enough\n-    //~| NOTE does not live long enough\n-    //~| NOTE borrowed value only valid until here\n-    //~| HELP consider using a `let` binding to increase its lifetime\n }\n-//~^ borrowed value must be valid until here\n \n fn main() {\n     f();", "previous_filename": "src/test/compile-fail/borrowck/borrowck-let-suggestion.rs"}, {"sha": "91600340019c3c0c9c5758986173fbbb7802f1f9", "filename": "src/test/ui/lifetimes/borrowck-let-suggestion.stderr", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/59c0ff6314f4b47bbb4b92f17e34d6886b8c0cba/src%2Ftest%2Fui%2Flifetimes%2Fborrowck-let-suggestion.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/59c0ff6314f4b47bbb4b92f17e34d6886b8c0cba/src%2Ftest%2Fui%2Flifetimes%2Fborrowck-let-suggestion.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flifetimes%2Fborrowck-let-suggestion.stderr?ref=59c0ff6314f4b47bbb4b92f17e34d6886b8c0cba", "patch": "@@ -0,0 +1,14 @@\n+error: borrowed value does not live long enough\n+  --> $DIR/borrowck-let-suggestion.rs:12:13\n+   |\n+12 |     let x = [1].iter();\n+   |             ^^^       - temporary value only lives until here\n+   |             |\n+   |             temporary value created here\n+13 | }\n+   | - temporary value needs to live until here\n+   |\n+   = note: consider using a `let` binding to increase its lifetime\n+\n+error: aborting due to previous error\n+"}, {"sha": "3fedb2884bc58c8cd3c52f469c3f19f3cdf5d224", "filename": "src/test/ui/span/issue-11925.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/59c0ff6314f4b47bbb4b92f17e34d6886b8c0cba/src%2Ftest%2Fui%2Fspan%2Fissue-11925.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/59c0ff6314f4b47bbb4b92f17e34d6886b8c0cba/src%2Ftest%2Fui%2Fspan%2Fissue-11925.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fspan%2Fissue-11925.stderr?ref=59c0ff6314f4b47bbb4b92f17e34d6886b8c0cba", "patch": "@@ -5,10 +5,10 @@ error: `x` does not live long enough\n    |                                    ^\n    |                                    |\n    |                                    does not live long enough\n-   |                                    borrowed value only valid until here\n+   |                                    borrowed value only lives until here\n ...\n 23 | }\n-   | - borrowed value must be valid until here\n+   | - borrowed value needs to live until here\n \n error: aborting due to previous error\n "}]}