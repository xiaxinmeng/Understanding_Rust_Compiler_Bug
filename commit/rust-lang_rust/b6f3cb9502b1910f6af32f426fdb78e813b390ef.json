{"sha": "b6f3cb9502b1910f6af32f426fdb78e813b390ef", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI2ZjNjYjk1MDJiMTkxMGY2YWYzMmY0MjZmZGI3OGU4MTNiMzkwZWY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-06-23T08:45:17Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-06-23T08:45:17Z"}, "message": "Auto merge of #86548 - GuillaumeGomez:fix-crate-filter-search-reset, r=jsha\n\nFix crate filter search reset\n\nI found a fun bug when using rustdoc recently: I made a search, cut the search input content, changed the crate filter, pasted back the input content. To my surprise, the crate filter wasn't applied. It's because that our search input was empty when receiving the `<select>` \"onchange\" event. To fix this issue, I reset the `currentResults` variable to `null`.\n\nIt's using the first commit from #86542 so it needs to wait for it before getting merged.\n\nr? `@jsha`", "tree": {"sha": "34f10212da90a5ff0c7a33e479ff200da4c08a63", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/34f10212da90a5ff0c7a33e479ff200da4c08a63"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b6f3cb9502b1910f6af32f426fdb78e813b390ef", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b6f3cb9502b1910f6af32f426fdb78e813b390ef", "html_url": "https://github.com/rust-lang/rust/commit/b6f3cb9502b1910f6af32f426fdb78e813b390ef", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b6f3cb9502b1910f6af32f426fdb78e813b390ef/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2ce052bb8d8e4b421f08541ffa1f4c7fc5ea7a72", "url": "https://api.github.com/repos/rust-lang/rust/commits/2ce052bb8d8e4b421f08541ffa1f4c7fc5ea7a72", "html_url": "https://github.com/rust-lang/rust/commit/2ce052bb8d8e4b421f08541ffa1f4c7fc5ea7a72"}, {"sha": "c4023c6ca31f80cb7fa3cbebc9f0095d5f649d53", "url": "https://api.github.com/repos/rust-lang/rust/commits/c4023c6ca31f80cb7fa3cbebc9f0095d5f649d53", "html_url": "https://github.com/rust-lang/rust/commit/c4023c6ca31f80cb7fa3cbebc9f0095d5f649d53"}], "stats": {"total": 21, "additions": 21, "deletions": 0}, "files": [{"sha": "617c79a45795af28356a9bde6f7b746b7fceb488", "filename": "src/librustdoc/html/static/search.js", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b6f3cb9502b1910f6af32f426fdb78e813b390ef/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fsearch.js", "raw_url": "https://github.com/rust-lang/rust/raw/b6f3cb9502b1910f6af32f426fdb78e813b390ef/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fsearch.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fsearch.js?ref=b6f3cb9502b1910f6af32f426fdb78e813b390ef", "patch": "@@ -1442,6 +1442,10 @@ window.initSearch = function(rawSearchIndex) {\n         if (selectCrate) {\n             selectCrate.onchange = function() {\n                 updateLocalStorage(\"rustdoc-saved-filter-crate\", selectCrate.value);\n+                // In case you \"cut\" the entry from the search input, then change the crate filter\n+                // before paste back the previous search, you get the old search results without\n+                // the filter. To prevent this, we need to remove the previous results.\n+                currentResults = null;\n                 search(undefined, true);\n             };\n         }"}, {"sha": "a098dbd9f129bf8f5dd0dedaaf718ba4a49f0fa1", "filename": "src/test/rustdoc-gui/search-filter.goml", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/b6f3cb9502b1910f6af32f426fdb78e813b390ef/src%2Ftest%2Frustdoc-gui%2Fsearch-filter.goml", "raw_url": "https://github.com/rust-lang/rust/raw/b6f3cb9502b1910f6af32f426fdb78e813b390ef/src%2Ftest%2Frustdoc-gui%2Fsearch-filter.goml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-gui%2Fsearch-filter.goml?ref=b6f3cb9502b1910f6af32f426fdb78e813b390ef", "patch": "@@ -0,0 +1,17 @@\n+goto: file://|DOC_PATH|/test_docs/index.html\n+write: (\".search-input\", \"test\")\n+// Waiting for the search results to appear...\n+wait-for: \"#titles\"\n+assert-text: (\"#results .externcrate\", \"test_docs\")\n+text: (\".search-input\", \"\")\n+// We now want to change the crate filter.\n+click: \"#crate-search\"\n+// We select \"lib2\" option then press enter to change the filter.\n+press-key: \"ArrowDown\"\n+press-key: \"Enter\"\n+// We now make the search again.\n+write: (\".search-input\", \"test\")\n+// Waiting for the search results to appear...\n+wait-for: \"#titles\"\n+// We check that there is no more \"test_docs\" appearing.\n+assert-false: \"#results .externcrate\""}]}