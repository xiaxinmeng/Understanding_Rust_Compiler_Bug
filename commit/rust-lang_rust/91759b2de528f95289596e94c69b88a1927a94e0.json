{"sha": "91759b2de528f95289596e94c69b88a1927a94e0", "node_id": "MDY6Q29tbWl0NzI0NzEyOjkxNzU5YjJkZTUyOGY5NTI4OTU5NmU5NGM2OWI4OGExOTI3YTk0ZTA=", "commit": {"author": {"name": "Mara Bos", "email": "m-ou.se@m-ou.se", "date": "2020-11-08T12:36:33Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-11-08T12:36:33Z"}, "message": "Rollup merge of #78865 - Aaron1011:fix/const-item-mut-reborrow, r=varkor\n\nDon't fire `CONST_ITEM_MUTATION` lint when borrowing a deref\n\nFixes #78819\n\nThis extends the check for dereferences added in PR #77324\nto cover mutable borrows, as well as direct writes. If we're operating\non a dereference of a `const` item, we shouldn't be firing the lint.", "tree": {"sha": "543bc6807689dcf1da90dc4d25e5f3ddb1e7a32a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/543bc6807689dcf1da90dc4d25e5f3ddb1e7a32a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/91759b2de528f95289596e94c69b88a1927a94e0", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfp+ZSCRBK7hj4Ov3rIwAAdHIIAE46jULZV+UOPVaBG7Eyk5Iv\nhPlZFjLvSZcXMtXPV2IoeWe30QOz47E3JTwlz9GW+Rvs/1BBxUfZLKSZP3x0TjuH\nE+2cDedcShZh0NREvJRYzJMuYgBjEz0Jbxi8bO07mkuOTJvu2ci9j7mhmLh5sHuy\nXYghb9J72D7SIg4DNW3kYIDyvYrsUtCXGUEuRQOiTLxprnj83ptmhRDPo9Z8+6fw\nbgjWHK3jET6+OE89t7hfVw/VFXwYM3VWN9D7gctyE0nPPffMoxzDKZc+NxYYWbnT\nRm7dKGlHJbU9OTxG6lKfPuCVhpuc6E3YLVYBOzTOqKlK8o0i7DZX0GDThAavGNA=\n=mJ27\n-----END PGP SIGNATURE-----\n", "payload": "tree 543bc6807689dcf1da90dc4d25e5f3ddb1e7a32a\nparent c4e262ee6f35ac8d501eedc4a52d3b7c779b21fe\nparent bd3f3fa32a7ffe30b47625edc4c6bf814aed4964\nauthor Mara Bos <m-ou.se@m-ou.se> 1604838993 +0100\ncommitter GitHub <noreply@github.com> 1604838993 +0100\n\nRollup merge of #78865 - Aaron1011:fix/const-item-mut-reborrow, r=varkor\n\nDon't fire `CONST_ITEM_MUTATION` lint when borrowing a deref\n\nFixes #78819\n\nThis extends the check for dereferences added in PR #77324\nto cover mutable borrows, as well as direct writes. If we're operating\non a dereference of a `const` item, we shouldn't be firing the lint.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/91759b2de528f95289596e94c69b88a1927a94e0", "html_url": "https://github.com/rust-lang/rust/commit/91759b2de528f95289596e94c69b88a1927a94e0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/91759b2de528f95289596e94c69b88a1927a94e0/comments", "author": {"login": "m-ou-se", "id": 783247, "node_id": "MDQ6VXNlcjc4MzI0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/783247?v=4", "gravatar_id": "", "url": "https://api.github.com/users/m-ou-se", "html_url": "https://github.com/m-ou-se", "followers_url": "https://api.github.com/users/m-ou-se/followers", "following_url": "https://api.github.com/users/m-ou-se/following{/other_user}", "gists_url": "https://api.github.com/users/m-ou-se/gists{/gist_id}", "starred_url": "https://api.github.com/users/m-ou-se/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/m-ou-se/subscriptions", "organizations_url": "https://api.github.com/users/m-ou-se/orgs", "repos_url": "https://api.github.com/users/m-ou-se/repos", "events_url": "https://api.github.com/users/m-ou-se/events{/privacy}", "received_events_url": "https://api.github.com/users/m-ou-se/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c4e262ee6f35ac8d501eedc4a52d3b7c779b21fe", "url": "https://api.github.com/repos/rust-lang/rust/commits/c4e262ee6f35ac8d501eedc4a52d3b7c779b21fe", "html_url": "https://github.com/rust-lang/rust/commit/c4e262ee6f35ac8d501eedc4a52d3b7c779b21fe"}, {"sha": "bd3f3fa32a7ffe30b47625edc4c6bf814aed4964", "url": "https://api.github.com/repos/rust-lang/rust/commits/bd3f3fa32a7ffe30b47625edc4c6bf814aed4964", "html_url": "https://github.com/rust-lang/rust/commit/bd3f3fa32a7ffe30b47625edc4c6bf814aed4964"}], "stats": {"total": 80, "additions": 47, "deletions": 33}, "files": [{"sha": "a84570432786e7a8a5912ca8092162bbd9643989", "filename": "compiler/rustc_mir/src/transform/check_const_item_mutation.rs", "status": "modified", "additions": 30, "deletions": 21, "changes": 51, "blob_url": "https://github.com/rust-lang/rust/blob/91759b2de528f95289596e94c69b88a1927a94e0/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcheck_const_item_mutation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/91759b2de528f95289596e94c69b88a1927a94e0/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcheck_const_item_mutation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcheck_const_item_mutation.rs?ref=91759b2de528f95289596e94c69b88a1927a94e0", "patch": "@@ -61,22 +61,35 @@ impl<'a, 'tcx> ConstMutationChecker<'a, 'tcx> {\n \n     fn lint_const_item_usage(\n         &self,\n+        place: &Place<'tcx>,\n         const_item: DefId,\n         location: Location,\n         decorate: impl for<'b> FnOnce(LintDiagnosticBuilder<'b>) -> DiagnosticBuilder<'b>,\n     ) {\n-        let source_info = self.body.source_info(location);\n-        let lint_root = self.body.source_scopes[source_info.scope]\n-            .local_data\n-            .as_ref()\n-            .assert_crate_local()\n-            .lint_root;\n+        // Don't lint on borrowing/assigning to a dereference\n+        // e.g:\n+        //\n+        // `unsafe { *FOO = 0; *BAR.field = 1; }`\n+        // `unsafe { &mut *FOO }`\n+        if !matches!(place.projection.last(), Some(PlaceElem::Deref)) {\n+            let source_info = self.body.source_info(location);\n+            let lint_root = self.body.source_scopes[source_info.scope]\n+                .local_data\n+                .as_ref()\n+                .assert_crate_local()\n+                .lint_root;\n \n-        self.tcx.struct_span_lint_hir(CONST_ITEM_MUTATION, lint_root, source_info.span, |lint| {\n-            decorate(lint)\n-                .span_note(self.tcx.def_span(const_item), \"`const` item defined here\")\n-                .emit()\n-        });\n+            self.tcx.struct_span_lint_hir(\n+                CONST_ITEM_MUTATION,\n+                lint_root,\n+                source_info.span,\n+                |lint| {\n+                    decorate(lint)\n+                        .span_note(self.tcx.def_span(const_item), \"`const` item defined here\")\n+                        .emit()\n+                },\n+            );\n+        }\n     }\n }\n \n@@ -88,15 +101,11 @@ impl<'a, 'tcx> Visitor<'tcx> for ConstMutationChecker<'a, 'tcx> {\n             // so emitting a lint would be redundant.\n             if !lhs.projection.is_empty() {\n                 if let Some(def_id) = self.is_const_item_without_destructor(lhs.local) {\n-                    // Don't lint on writes through a pointer\n-                    // (e.g. `unsafe { *FOO = 0; *BAR.field = 1; }`)\n-                    if !matches!(lhs.projection.last(), Some(PlaceElem::Deref)) {\n-                        self.lint_const_item_usage(def_id, loc, |lint| {\n-                            let mut lint = lint.build(\"attempting to modify a `const` item\");\n-                            lint.note(\"each usage of a `const` item creates a new temporary - the original `const` item will not be modified\");\n-                            lint\n-                        })\n-                    }\n+                    self.lint_const_item_usage(&lhs, def_id, loc, |lint| {\n+                        let mut lint = lint.build(\"attempting to modify a `const` item\");\n+                        lint.note(\"each usage of a `const` item creates a new temporary; the original `const` item will not be modified\");\n+                        lint\n+                    })\n                 }\n             }\n             // We are looking for MIR of the form:\n@@ -127,7 +136,7 @@ impl<'a, 'tcx> Visitor<'tcx> for ConstMutationChecker<'a, 'tcx> {\n                 });\n                 let lint_loc =\n                     if method_did.is_some() { self.body.terminator_loc(loc.block) } else { loc };\n-                self.lint_const_item_usage(def_id, lint_loc, |lint| {\n+                self.lint_const_item_usage(place, def_id, lint_loc, |lint| {\n                     let mut lint = lint.build(\"taking a mutable reference to a `const` item\");\n                     lint\n                         .note(\"each usage of a `const` item creates a new temporary\")"}, {"sha": "ef55f31593b63150ac65cbef8dbbccd83e4bb9b0", "filename": "src/test/ui/lint/lint-const-item-mutation.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/91759b2de528f95289596e94c69b88a1927a94e0/src%2Ftest%2Fui%2Flint%2Flint-const-item-mutation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/91759b2de528f95289596e94c69b88a1927a94e0/src%2Ftest%2Fui%2Flint%2Flint-const-item-mutation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Flint-const-item-mutation.rs?ref=91759b2de528f95289596e94c69b88a1927a94e0", "patch": "@@ -29,6 +29,7 @@ const RAW_PTR: *mut u8 = 1 as *mut u8;\n const MUTABLE: Mutable = Mutable { msg: \"\" };\n const MUTABLE2: Mutable2 = Mutable2 { msg: \"\", other: String::new() };\n const VEC: Vec<i32> = Vec::new();\n+const PTR: *mut () = 1 as *mut _;\n \n fn main() {\n     ARRAY[0] = 5; //~ WARN attempting to modify\n@@ -50,4 +51,8 @@ fn main() {\n     MUTABLE.msg = \"wow\"; // no warning, because Drop observes the mutation\n     MUTABLE2.msg = \"wow\"; //~ WARN attempting to modify\n     VEC.push(0); //~ WARN taking a mutable reference to a `const` item\n+\n+    // Test that we don't warn when converting a raw pointer\n+    // into a mutable reference\n+    unsafe { &mut *PTR };\n }"}, {"sha": "ae95abc72f39acddb389bfe1f93cf2884e487ec2", "filename": "src/test/ui/lint/lint-const-item-mutation.stderr", "status": "modified", "additions": 12, "deletions": 12, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/91759b2de528f95289596e94c69b88a1927a94e0/src%2Ftest%2Fui%2Flint%2Flint-const-item-mutation.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/91759b2de528f95289596e94c69b88a1927a94e0/src%2Ftest%2Fui%2Flint%2Flint-const-item-mutation.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Flint-const-item-mutation.stderr?ref=91759b2de528f95289596e94c69b88a1927a94e0", "patch": "@@ -1,45 +1,45 @@\n warning: attempting to modify a `const` item\n-  --> $DIR/lint-const-item-mutation.rs:34:5\n+  --> $DIR/lint-const-item-mutation.rs:35:5\n    |\n LL |     ARRAY[0] = 5;\n    |     ^^^^^^^^^^^^\n    |\n    = note: `#[warn(const_item_mutation)]` on by default\n-   = note: each usage of a `const` item creates a new temporary - the original `const` item will not be modified\n+   = note: each usage of a `const` item creates a new temporary; the original `const` item will not be modified\n note: `const` item defined here\n   --> $DIR/lint-const-item-mutation.rs:26:1\n    |\n LL | const ARRAY: [u8; 1] = [25];\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n warning: attempting to modify a `const` item\n-  --> $DIR/lint-const-item-mutation.rs:35:5\n+  --> $DIR/lint-const-item-mutation.rs:36:5\n    |\n LL |     MY_STRUCT.field = false;\n    |     ^^^^^^^^^^^^^^^^^^^^^^^\n    |\n-   = note: each usage of a `const` item creates a new temporary - the original `const` item will not be modified\n+   = note: each usage of a `const` item creates a new temporary; the original `const` item will not be modified\n note: `const` item defined here\n   --> $DIR/lint-const-item-mutation.rs:27:1\n    |\n LL | const MY_STRUCT: MyStruct = MyStruct { field: true, inner_array: ['a'], raw_ptr: 2 as *mut u8 };\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n warning: attempting to modify a `const` item\n-  --> $DIR/lint-const-item-mutation.rs:36:5\n+  --> $DIR/lint-const-item-mutation.rs:37:5\n    |\n LL |     MY_STRUCT.inner_array[0] = 'b';\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |\n-   = note: each usage of a `const` item creates a new temporary - the original `const` item will not be modified\n+   = note: each usage of a `const` item creates a new temporary; the original `const` item will not be modified\n note: `const` item defined here\n   --> $DIR/lint-const-item-mutation.rs:27:1\n    |\n LL | const MY_STRUCT: MyStruct = MyStruct { field: true, inner_array: ['a'], raw_ptr: 2 as *mut u8 };\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n warning: taking a mutable reference to a `const` item\n-  --> $DIR/lint-const-item-mutation.rs:37:5\n+  --> $DIR/lint-const-item-mutation.rs:38:5\n    |\n LL |     MY_STRUCT.use_mut();\n    |     ^^^^^^^^^^^^^^^^^^^\n@@ -58,7 +58,7 @@ LL | const MY_STRUCT: MyStruct = MyStruct { field: true, inner_array: ['a'], raw\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n warning: taking a mutable reference to a `const` item\n-  --> $DIR/lint-const-item-mutation.rs:38:5\n+  --> $DIR/lint-const-item-mutation.rs:39:5\n    |\n LL |     &mut MY_STRUCT;\n    |     ^^^^^^^^^^^^^^\n@@ -72,7 +72,7 @@ LL | const MY_STRUCT: MyStruct = MyStruct { field: true, inner_array: ['a'], raw\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n warning: taking a mutable reference to a `const` item\n-  --> $DIR/lint-const-item-mutation.rs:39:5\n+  --> $DIR/lint-const-item-mutation.rs:40:5\n    |\n LL |     (&mut MY_STRUCT).use_mut();\n    |     ^^^^^^^^^^^^^^^^\n@@ -86,20 +86,20 @@ LL | const MY_STRUCT: MyStruct = MyStruct { field: true, inner_array: ['a'], raw\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n warning: attempting to modify a `const` item\n-  --> $DIR/lint-const-item-mutation.rs:51:5\n+  --> $DIR/lint-const-item-mutation.rs:52:5\n    |\n LL |     MUTABLE2.msg = \"wow\";\n    |     ^^^^^^^^^^^^^^^^^^^^\n    |\n-   = note: each usage of a `const` item creates a new temporary - the original `const` item will not be modified\n+   = note: each usage of a `const` item creates a new temporary; the original `const` item will not be modified\n note: `const` item defined here\n   --> $DIR/lint-const-item-mutation.rs:30:1\n    |\n LL | const MUTABLE2: Mutable2 = Mutable2 { msg: \"\", other: String::new() };\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n warning: taking a mutable reference to a `const` item\n-  --> $DIR/lint-const-item-mutation.rs:52:5\n+  --> $DIR/lint-const-item-mutation.rs:53:5\n    |\n LL |     VEC.push(0);\n    |     ^^^^^^^^^^^"}]}