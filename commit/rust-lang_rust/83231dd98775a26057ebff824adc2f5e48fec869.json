{"sha": "83231dd98775a26057ebff824adc2f5e48fec869", "node_id": "MDY6Q29tbWl0NzI0NzEyOjgzMjMxZGQ5ODc3NWEyNjA1N2ViZmY4MjRhZGMyZjVlNDhmZWM4Njk=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-01-25T11:18:58Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-01-25T11:18:58Z"}, "message": "Merge #7409 #7421\n\n7409: Add References CodeLens. r=matklad a=vsrs\n\nCloses #5836\n\n7421: Fix RA_LOG example in dev docs r=lnicola a=lnicola\n\nbors r+\n\nCo-authored-by: vsrs <vit@conrlab.com>\nCo-authored-by: Lauren\u021biu Nicola <lnicola@dend.ro>", "tree": {"sha": "10cca0bb75fcecc5460c1ea5df488c7cb61bcef7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/10cca0bb75fcecc5460c1ea5df488c7cb61bcef7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/83231dd98775a26057ebff824adc2f5e48fec869", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgDqkiCRBK7hj4Ov3rIwAAdHIIAKdUDEARiyV6JPUJVZFfrV7l\nyVEeprHihSDgtNFd4Hltxw53DsVgQoXbjwRGsE7wgmopAB+tfOun4GuHFfDpXsnL\nIDnHAlmG+4hu68Bgnnz2DLpxgyvZIPSzqjqUdQy+5/nGrhS5IDED4WmPRv6MLJed\nM9O4vJiJCvm3JrzUCqFO0HegiCSAh6YySVlYKeNx3yOcFR7Mn3mdKxx1apqIppgJ\nltigDiycf76JiT0iFLLJKH2Cn60V2YVKkg0hhYu4hbGzaqx/gAvR3vtMrJtXllG/\nWRnRT1IPdsjxms3t2YBlIucKrkCOablD5sutTAl3IwHW1yjOEjrC9lO6Kp7gqwo=\n=Q2rg\n-----END PGP SIGNATURE-----\n", "payload": "tree 10cca0bb75fcecc5460c1ea5df488c7cb61bcef7\nparent 6362b399ad321d8bece357b703e5455de3850e76\nparent 3618c4e0d3127e6d6eab1b55fd88c353b8d3f6d7\nparent 83fd63982999a043fca13259afea1e7f7793bf80\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1611573538 +0000\ncommitter GitHub <noreply@github.com> 1611573538 +0000\n\nMerge #7409 #7421\n\n7409: Add References CodeLens. r=matklad a=vsrs\n\nCloses #5836\n\n7421: Fix RA_LOG example in dev docs r=lnicola a=lnicola\n\nbors r+\n\nCo-authored-by: vsrs <vit@conrlab.com>\nCo-authored-by: Lauren\u021biu Nicola <lnicola@dend.ro>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/83231dd98775a26057ebff824adc2f5e48fec869", "html_url": "https://github.com/rust-lang/rust/commit/83231dd98775a26057ebff824adc2f5e48fec869", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/83231dd98775a26057ebff824adc2f5e48fec869/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6362b399ad321d8bece357b703e5455de3850e76", "url": "https://api.github.com/repos/rust-lang/rust/commits/6362b399ad321d8bece357b703e5455de3850e76", "html_url": "https://github.com/rust-lang/rust/commit/6362b399ad321d8bece357b703e5455de3850e76"}, {"sha": "3618c4e0d3127e6d6eab1b55fd88c353b8d3f6d7", "url": "https://api.github.com/repos/rust-lang/rust/commits/3618c4e0d3127e6d6eab1b55fd88c353b8d3f6d7", "html_url": "https://github.com/rust-lang/rust/commit/3618c4e0d3127e6d6eab1b55fd88c353b8d3f6d7"}, {"sha": "83fd63982999a043fca13259afea1e7f7793bf80", "url": "https://api.github.com/repos/rust-lang/rust/commits/83fd63982999a043fca13259afea1e7f7793bf80", "html_url": "https://github.com/rust-lang/rust/commit/83fd63982999a043fca13259afea1e7f7793bf80"}], "stats": {"total": 87, "additions": 53, "deletions": 34}, "files": [{"sha": "247bfe71ef34fa2bb52c14a745b7ce317b2101a3", "filename": "crates/rust-analyzer/src/config.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/83231dd98775a26057ebff824adc2f5e48fec869/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/83231dd98775a26057ebff824adc2f5e48fec869/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs?ref=83231dd98775a26057ebff824adc2f5e48fec869", "patch": "@@ -147,6 +147,9 @@ config_data! {\n         /// Whether to show `Method References` lens. Only applies when\n         /// `#rust-analyzer.lens.enable#` is set.\n         lens_methodReferences: bool = \"false\",\n+        /// Whether to show `References` lens. Only applies when\n+        /// `#rust-analyzer.lens.enable#` is set.\n+        lens_references: bool = \"false\",\n \n         /// Disable project auto-discovery in favor of explicitly specified set\n         /// of projects.\\n\\nElements must be paths pointing to `Cargo.toml`,\n@@ -221,6 +224,7 @@ pub struct LensConfig {\n     pub debug: bool,\n     pub implementations: bool,\n     pub method_refs: bool,\n+    pub refs: bool, // for Struct, Enum, Union and Trait\n }\n \n impl LensConfig {\n@@ -237,7 +241,7 @@ impl LensConfig {\n     }\n \n     pub fn references(&self) -> bool {\n-        self.method_refs\n+        self.method_refs || self.refs\n     }\n }\n \n@@ -593,6 +597,7 @@ impl Config {\n             debug: self.data.lens_enable && self.data.lens_debug,\n             implementations: self.data.lens_enable && self.data.lens_implementations,\n             method_refs: self.data.lens_enable && self.data.lens_methodReferences,\n+            refs: self.data.lens_enable && self.data.lens_references,\n         }\n     }\n     pub fn hover(&self) -> HoverConfig {"}, {"sha": "07204436c5b3e8d99d9abbcfae4d8ed0631bf915", "filename": "crates/rust-analyzer/src/handlers.rs", "status": "modified", "additions": 38, "deletions": 32, "changes": 70, "blob_url": "https://github.com/rust-lang/rust/blob/83231dd98775a26057ebff824adc2f5e48fec869/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/83231dd98775a26057ebff824adc2f5e48fec869/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs?ref=83231dd98775a26057ebff824adc2f5e48fec869", "patch": "@@ -1112,42 +1112,48 @@ pub(crate) fn handle_code_lens(\n         }\n     }\n \n-    if lens_config.implementations {\n-        // Handle impls\n-        lenses.extend(\n-            snap.analysis\n-                .file_structure(file_id)?\n-                .into_iter()\n-                .filter(|it| {\n-                    matches!(\n-                        it.kind,\n-                        SymbolKind::Trait\n-                            | SymbolKind::Struct\n-                            | SymbolKind::Enum\n-                            | SymbolKind::Union\n-                    )\n-                })\n-                .map(|it| {\n-                    let range = to_proto::range(&line_index, it.node_range);\n-                    let pos = range.start;\n-                    let lens_params = lsp_types::request::GotoImplementationParams {\n-                        text_document_position_params: lsp_types::TextDocumentPositionParams::new(\n-                            params.text_document.clone(),\n-                            pos,\n-                        ),\n-                        work_done_progress_params: Default::default(),\n-                        partial_result_params: Default::default(),\n-                    };\n-                    CodeLens {\n+    if lens_config.implementations || lens_config.refs {\n+        snap.analysis\n+            .file_structure(file_id)?\n+            .into_iter()\n+            .filter(|it| {\n+                matches!(\n+                    it.kind,\n+                    SymbolKind::Trait | SymbolKind::Struct | SymbolKind::Enum | SymbolKind::Union\n+                )\n+            })\n+            .for_each(|it| {\n+                let range = to_proto::range(&line_index, it.node_range);\n+                let position = to_proto::position(&line_index, it.navigation_range.start());\n+                let doc_pos = lsp_types::TextDocumentPositionParams::new(\n+                    params.text_document.clone(),\n+                    position,\n+                );\n+                let goto_params = lsp_types::request::GotoImplementationParams {\n+                    text_document_position_params: doc_pos.clone(),\n+                    work_done_progress_params: Default::default(),\n+                    partial_result_params: Default::default(),\n+                };\n+\n+                if lens_config.implementations {\n+                    lenses.push(CodeLens {\n                         range,\n                         command: None,\n-                        data: Some(to_value(CodeLensResolveData::Impls(lens_params)).unwrap()),\n-                    }\n-                }),\n-        );\n+                        data: Some(to_value(CodeLensResolveData::Impls(goto_params)).unwrap()),\n+                    })\n+                }\n+\n+                if lens_config.refs {\n+                    lenses.push(CodeLens {\n+                        range,\n+                        command: None,\n+                        data: Some(to_value(CodeLensResolveData::References(doc_pos)).unwrap()),\n+                    })\n+                }\n+            });\n     }\n \n-    if lens_config.references() {\n+    if lens_config.method_refs {\n         lenses.extend(snap.analysis.find_all_methods(file_id)?.into_iter().map(|it| {\n             let range = to_proto::range(&line_index, it.range);\n             let position = to_proto::position(&line_index, it.range.start());"}, {"sha": "6a6ba1443d1e08261f94622d549c5f57d00ea2c2", "filename": "docs/dev/README.md", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/83231dd98775a26057ebff824adc2f5e48fec869/docs%2Fdev%2FREADME.md", "raw_url": "https://github.com/rust-lang/rust/raw/83231dd98775a26057ebff824adc2f5e48fec869/docs%2Fdev%2FREADME.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/docs%2Fdev%2FREADME.md?ref=83231dd98775a26057ebff824adc2f5e48fec869", "patch": "@@ -212,7 +212,7 @@ To log all communication between the server and the client, there are two choice\n \n * you can log on the server side, by running something like\n   ```\n-  env RA_LOG=gen_lsp_server=trace code .\n+  env RA_LOG=lsp_server=debug code .\n   ```\n \n * you can log on the client side, by enabling `\"rust-analyzer.trace.server\":"}, {"sha": "2f681b01aa8e1df48654e7524dabc1b13d54816e", "filename": "docs/user/generated_config.adoc", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/83231dd98775a26057ebff824adc2f5e48fec869/docs%2Fuser%2Fgenerated_config.adoc", "raw_url": "https://github.com/rust-lang/rust/raw/83231dd98775a26057ebff824adc2f5e48fec869/docs%2Fuser%2Fgenerated_config.adoc", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/docs%2Fuser%2Fgenerated_config.adoc?ref=83231dd98775a26057ebff824adc2f5e48fec869", "patch": "@@ -86,6 +86,8 @@\n  Whether to show `Run` lens. Only applies when  `#rust-analyzer.lens.enable#` is set.\n [[rust-analyzer.lens.methodReferences]]rust-analyzer.lens.methodReferences (default: `false`)::\n  Whether to show `Method References` lens. Only applies when  `#rust-analyzer.lens.enable#` is set.\n+[[rust-analyzer.lens.references]]rust-analyzer.lens.references (default: `false`)::\n+ Whether to show `References` lens. Only applies when  `#rust-analyzer.lens.enable#` is set.\n [[rust-analyzer.linkedProjects]]rust-analyzer.linkedProjects (default: `[]`)::\n  Disable project auto-discovery in favor of explicitly specified set  of projects.\\n\\nElements must be paths pointing to `Cargo.toml`,  `rust-project.json`, or JSON objects in `rust-project.json` format.\n [[rust-analyzer.lruCapacity]]rust-analyzer.lruCapacity (default: `null`)::"}, {"sha": "2225cf1ddb07a2029b5038b55369daa7c38dc03a", "filename": "editors/code/package.json", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/83231dd98775a26057ebff824adc2f5e48fec869/editors%2Fcode%2Fpackage.json", "raw_url": "https://github.com/rust-lang/rust/raw/83231dd98775a26057ebff824adc2f5e48fec869/editors%2Fcode%2Fpackage.json", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fpackage.json?ref=83231dd98775a26057ebff824adc2f5e48fec869", "patch": "@@ -633,6 +633,11 @@\n                     \"default\": false,\n                     \"type\": \"boolean\"\n                 },\n+                \"rust-analyzer.lens.references\": {\n+                    \"markdownDescription\": \"Whether to show `References` lens. Only applies when `#rust-analyzer.lens.enable#` is set.\",\n+                    \"default\": false,\n+                    \"type\": \"boolean\"\n+                },\n                 \"rust-analyzer.linkedProjects\": {\n                     \"markdownDescription\": \"Disable project auto-discovery in favor of explicitly specified set of projects.\\\\n\\\\nElements must be paths pointing to `Cargo.toml`, `rust-project.json`, or JSON objects in `rust-project.json` format.\",\n                     \"default\": [],"}, {"sha": "ddb5cfbd330e1a560d9fc4cbf5083fffc9bbc943", "filename": "editors/code/src/config.ts", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/83231dd98775a26057ebff824adc2f5e48fec869/editors%2Fcode%2Fsrc%2Fconfig.ts", "raw_url": "https://github.com/rust-lang/rust/raw/83231dd98775a26057ebff824adc2f5e48fec869/editors%2Fcode%2Fsrc%2Fconfig.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fconfig.ts?ref=83231dd98775a26057ebff824adc2f5e48fec869", "patch": "@@ -144,6 +144,7 @@ export class Config {\n             debug: this.get<boolean>(\"lens.debug\"),\n             implementations: this.get<boolean>(\"lens.implementations\"),\n             methodReferences: this.get<boolean>(\"lens.methodReferences\"),\n+            references: this.get<boolean>(\"lens.references\"),\n         };\n     }\n "}]}