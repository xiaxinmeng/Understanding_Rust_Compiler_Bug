{"sha": "adf3b013c8b51e7d6ceea33ef3005896cc2cd030", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFkZjNiMDEzYzhiNTFlN2Q2Y2VlYTMzZWYzMDA1ODk2Y2MyY2QwMzA=", "commit": {"author": {"name": "Erik Desjardins", "email": "erikdesjardins@users.noreply.github.com", "date": "2021-08-25T21:44:27Z"}, "committer": {"name": "Erik Desjardins", "email": "erikdesjardins@users.noreply.github.com", "date": "2021-08-25T21:49:29Z"}, "message": "use a peekable iterator to check the first chunk", "tree": {"sha": "8607ffcb8bc0995f8ffabb3bca27148e5a39b95a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8607ffcb8bc0995f8ffabb3bca27148e5a39b95a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/adf3b013c8b51e7d6ceea33ef3005896cc2cd030", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/adf3b013c8b51e7d6ceea33ef3005896cc2cd030", "html_url": "https://github.com/rust-lang/rust/commit/adf3b013c8b51e7d6ceea33ef3005896cc2cd030", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/adf3b013c8b51e7d6ceea33ef3005896cc2cd030/comments", "author": {"login": "erikdesjardins", "id": 7673145, "node_id": "MDQ6VXNlcjc2NzMxNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/7673145?v=4", "gravatar_id": "", "url": "https://api.github.com/users/erikdesjardins", "html_url": "https://github.com/erikdesjardins", "followers_url": "https://api.github.com/users/erikdesjardins/followers", "following_url": "https://api.github.com/users/erikdesjardins/following{/other_user}", "gists_url": "https://api.github.com/users/erikdesjardins/gists{/gist_id}", "starred_url": "https://api.github.com/users/erikdesjardins/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/erikdesjardins/subscriptions", "organizations_url": "https://api.github.com/users/erikdesjardins/orgs", "repos_url": "https://api.github.com/users/erikdesjardins/repos", "events_url": "https://api.github.com/users/erikdesjardins/events{/privacy}", "received_events_url": "https://api.github.com/users/erikdesjardins/received_events", "type": "User", "site_admin": false}, "committer": {"login": "erikdesjardins", "id": 7673145, "node_id": "MDQ6VXNlcjc2NzMxNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/7673145?v=4", "gravatar_id": "", "url": "https://api.github.com/users/erikdesjardins", "html_url": "https://github.com/erikdesjardins", "followers_url": "https://api.github.com/users/erikdesjardins/followers", "following_url": "https://api.github.com/users/erikdesjardins/following{/other_user}", "gists_url": "https://api.github.com/users/erikdesjardins/gists{/gist_id}", "starred_url": "https://api.github.com/users/erikdesjardins/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/erikdesjardins/subscriptions", "organizations_url": "https://api.github.com/users/erikdesjardins/orgs", "repos_url": "https://api.github.com/users/erikdesjardins/repos", "events_url": "https://api.github.com/users/erikdesjardins/events{/privacy}", "received_events_url": "https://api.github.com/users/erikdesjardins/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c07a2eb5b417b72583e6331e8eeca1d505f9bac8", "url": "https://api.github.com/repos/rust-lang/rust/commits/c07a2eb5b417b72583e6331e8eeca1d505f9bac8", "html_url": "https://github.com/rust-lang/rust/commit/c07a2eb5b417b72583e6331e8eeca1d505f9bac8"}], "stats": {"total": 17, "additions": 14, "deletions": 3}, "files": [{"sha": "b6358f9929448cc22b1baa98ec7123d2da0f6617", "filename": "compiler/rustc_middle/src/mir/interpret/allocation.rs", "status": "modified", "additions": 14, "deletions": 3, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/adf3b013c8b51e7d6ceea33ef3005896cc2cd030/compiler%2Frustc_middle%2Fsrc%2Fmir%2Finterpret%2Fallocation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/adf3b013c8b51e7d6ceea33ef3005896cc2cd030/compiler%2Frustc_middle%2Fsrc%2Fmir%2Finterpret%2Fallocation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fmir%2Finterpret%2Fallocation.rs?ref=adf3b013c8b51e7d6ceea33ef3005896cc2cd030", "patch": "@@ -894,6 +894,14 @@ pub enum InitChunk {\n }\n \n impl InitChunk {\n+    #[inline]\n+    pub fn is_init(&self) -> bool {\n+        match self {\n+            Self::Init(_) => true,\n+            Self::Uninit(_) => false,\n+        }\n+    }\n+\n     #[inline]\n     pub fn range(&self) -> Range<Size> {\n         match self {\n@@ -1035,7 +1043,7 @@ impl InitMaskCompressed {\n \n /// Transferring the initialization mask to other allocations.\n impl<Tag, Extra> Allocation<Tag, Extra> {\n-    /// Creates a run-length encoding of the initialization mask.\n+    /// Creates a run-length encoding of the initialization mask; panics if range is empty.\n     ///\n     /// This is essentially a more space-efficient version of\n     /// `InitMask::range_as_init_chunks(...).collect::<Vec<_>>()`.\n@@ -1053,10 +1061,13 @@ impl<Tag, Extra> Allocation<Tag, Extra> {\n         // where each element toggles the state.\n \n         let mut ranges = smallvec::SmallVec::<[u64; 1]>::new();\n-        let initial = self.init_mask.get(range.start);\n+\n+        let mut chunks = self.init_mask.range_as_init_chunks(range.start, range.end()).peekable();\n+\n+        let initial = chunks.peek().expect(\"range should be nonempty\").is_init();\n \n         // Here we rely on `range_as_init_chunks` to yield alternating init/uninit chunks.\n-        for chunk in self.init_mask.range_as_init_chunks(range.start, range.end()) {\n+        for chunk in chunks {\n             let len = chunk.range().end.bytes() - chunk.range().start.bytes();\n             ranges.push(len);\n         }"}]}