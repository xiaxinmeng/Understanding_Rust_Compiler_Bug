{"sha": "9ead47151e22f68fcbd0fe5194cbd09cd2482680", "node_id": "MDY6Q29tbWl0NzI0NzEyOjllYWQ0NzE1MWUyMmY2OGZjYmQwZmU1MTk0Y2JkMDljZDI0ODI2ODA=", "commit": {"author": {"name": "Simon Bernier St-Pierre", "email": "sbernierstpierre@gmail.com", "date": "2015-07-31T23:21:44Z"}, "committer": {"name": "Simon Bernier St-Pierre", "email": "sbernierstpierre@gmail.com", "date": "2015-08-25T23:05:30Z"}, "message": "Add project-specific configuration file support", "tree": {"sha": "0a551f4015a778ba4793467382f29f85ff5d77d6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0a551f4015a778ba4793467382f29f85ff5d77d6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9ead47151e22f68fcbd0fe5194cbd09cd2482680", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9ead47151e22f68fcbd0fe5194cbd09cd2482680", "html_url": "https://github.com/rust-lang/rust/commit/9ead47151e22f68fcbd0fe5194cbd09cd2482680", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9ead47151e22f68fcbd0fe5194cbd09cd2482680/comments", "author": {"login": "sbstp", "id": 862368, "node_id": "MDQ6VXNlcjg2MjM2OA==", "avatar_url": "https://avatars.githubusercontent.com/u/862368?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sbstp", "html_url": "https://github.com/sbstp", "followers_url": "https://api.github.com/users/sbstp/followers", "following_url": "https://api.github.com/users/sbstp/following{/other_user}", "gists_url": "https://api.github.com/users/sbstp/gists{/gist_id}", "starred_url": "https://api.github.com/users/sbstp/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sbstp/subscriptions", "organizations_url": "https://api.github.com/users/sbstp/orgs", "repos_url": "https://api.github.com/users/sbstp/repos", "events_url": "https://api.github.com/users/sbstp/events{/privacy}", "received_events_url": "https://api.github.com/users/sbstp/received_events", "type": "User", "site_admin": false}, "committer": {"login": "sbstp", "id": 862368, "node_id": "MDQ6VXNlcjg2MjM2OA==", "avatar_url": "https://avatars.githubusercontent.com/u/862368?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sbstp", "html_url": "https://github.com/sbstp", "followers_url": "https://api.github.com/users/sbstp/followers", "following_url": "https://api.github.com/users/sbstp/following{/other_user}", "gists_url": "https://api.github.com/users/sbstp/gists{/gist_id}", "starred_url": "https://api.github.com/users/sbstp/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sbstp/subscriptions", "organizations_url": "https://api.github.com/users/sbstp/orgs", "repos_url": "https://api.github.com/users/sbstp/repos", "events_url": "https://api.github.com/users/sbstp/events{/privacy}", "received_events_url": "https://api.github.com/users/sbstp/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6adb6a1d1ace57b10864b845d38f16b12387e2f9", "url": "https://api.github.com/repos/rust-lang/rust/commits/6adb6a1d1ace57b10864b845d38f16b12387e2f9", "html_url": "https://github.com/rust-lang/rust/commit/6adb6a1d1ace57b10864b845d38f16b12387e2f9"}], "stats": {"total": 120, "additions": 78, "deletions": 42}, "files": [{"sha": "a71d4abae86828a0d4b026da1f6cc144d373e072", "filename": "Cargo.toml", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/9ead47151e22f68fcbd0fe5194cbd09cd2482680/Cargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/9ead47151e22f68fcbd0fe5194cbd09cd2482680/Cargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.toml?ref=9ead47151e22f68fcbd0fe5194cbd09cd2482680", "patch": "@@ -7,7 +7,6 @@ description = \"Tool to find and fix Rust formatting issues\"\n repository = \"https://github.com/nick29581/rustfmt\"\n readme = \"README.md\"\n license = \"Apache-2.0/MIT\"\n-build = \"build.rs\"\n \n [dependencies.strings]\n strings = \"0.0.1\""}, {"sha": "3e6d051d9b1d67eda791b4bd418f290954105074", "filename": "build.rs", "status": "removed", "additions": 0, "deletions": 25, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/6adb6a1d1ace57b10864b845d38f16b12387e2f9/build.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6adb6a1d1ace57b10864b845d38f16b12387e2f9/build.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/build.rs?ref=6adb6a1d1ace57b10864b845d38f16b12387e2f9", "patch": "@@ -1,25 +0,0 @@\n-// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n-// file at the top-level directory of this distribution and at\n-// http://rust-lang.org/COPYRIGHT.\n-//\n-// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n-// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n-// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n-// option. This file may not be copied, modified, or distributed\n-// except according to those terms.\n-\n-// Build script. Just copies default.toml from the src to the target dir.\n-\n-use std::env;\n-use std::path::{Path, PathBuf};\n-\n-fn main() {\n-    let in_file = Path::new(\"src/default.toml\");\n-\n-    let manifest_dir = env::var(\"CARGO_MANIFEST_DIR\").unwrap();\n-    let mut out_file = PathBuf::new();\n-    out_file.push(manifest_dir);\n-    out_file.push(\"default.toml\");\n-\n-    std::fs::copy(in_file, out_file).unwrap();\n-}"}, {"sha": "2f61e788ed22c1f1f92a6ba4dbab4eb7d5c7360a", "filename": "src/bin/rustfmt.rs", "status": "modified", "additions": 43, "deletions": 10, "changes": 53, "blob_url": "https://github.com/rust-lang/rust/blob/9ead47151e22f68fcbd0fe5194cbd09cd2482680/src%2Fbin%2Frustfmt.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9ead47151e22f68fcbd0fe5194cbd09cd2482680/src%2Fbin%2Frustfmt.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbin%2Frustfmt.rs?ref=9ead47151e22f68fcbd0fe5194cbd09cd2482680", "patch": "@@ -7,30 +7,63 @@\n // <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n-\n+#![feature(path_ext)]\n+#![feature(rustc_private)]\n #![cfg(not(test))]\n #![feature(result_expect)]\n \n+#[macro_use]\n+extern crate log;\n extern crate rustfmt;\n+extern crate toml;\n \n use rustfmt::{WriteMode, run};\n use rustfmt::config::Config;\n \n-use std::fs::File;\n-use std::io::Read;\n+use std::env;\n+use std::fs::{File, PathExt};\n+use std::io::{self, Read};\n+use std::path::PathBuf;\n use std::str::FromStr;\n \n+// Try to find a project file in the current directory and its parents.\n+fn lookup_project_file() -> io::Result<PathBuf> {\n+    let mut current = try!(env::current_dir());\n+    loop {\n+        let config_file = current.join(\"rustfmt.toml\");\n+        if config_file.exists() {\n+            return Ok(config_file);\n+        } else {\n+            current = match current.parent() {\n+                // if the current directory has no parent, we're done searching\n+                None => return Err(io::Error::new(io::ErrorKind::NotFound, \"config not found\")),\n+                Some(path) => path.to_path_buf(),\n+            };\n+        }\n+    }\n+}\n+\n+// Try to find a project file. If it's found, read it.\n+fn lookup_and_read_project_file() -> io::Result<(PathBuf, String)> {\n+    let path = try!(lookup_project_file());\n+    let mut file = try!(File::open(&path));\n+    let mut toml = String::new();\n+    try!(file.read_to_string(&mut toml));\n+    Ok((path, toml))\n+}\n+\n fn main() {\n-    let mut def_config_file = File::open(\"default.toml\").unwrap_or_else(|e| {\n-        panic!(\"Unable to open configuration file [default.toml] {}\",e)\n-    });\n-    let mut def_config = String::new();\n-    def_config_file.read_to_string(&mut def_config).unwrap();\n-    let config = Box::new(Config::from_toml(&def_config));\n     let (args, write_mode) = determine_params(std::env::args());\n \n-    run(args, write_mode, config);\n+    let config = match lookup_and_read_project_file() {\n+        Ok((path, toml)) => {\n+            println!(\"Project config file: {}\", path.display());\n+            Config::from_toml(&toml)\n+        }\n+        Err(_) => Default::default(),\n+    };\n \n+    run(args, write_mode, Box::new(config));\n     std::process::exit(0);\n }\n "}, {"sha": "02ee8e637893e06b92212d55803efed7115eb5d5", "filename": "src/config.rs", "status": "modified", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/9ead47151e22f68fcbd0fe5194cbd09cd2482680/src%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9ead47151e22f68fcbd0fe5194cbd09cd2482680/src%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fconfig.rs?ref=9ead47151e22f68fcbd0fe5194cbd09cd2482680", "patch": "@@ -81,3 +81,30 @@ create_config! {\n     closure_indent_style: BlockIndentStyle,\n     single_line_if_else: bool,\n }\n+\n+impl Default for Config {\n+\n+    fn default() -> Config {\n+        Config {\n+            max_width: 100,\n+            ideal_width: 80,\n+            leeway: 5,\n+            tab_spaces: 4,\n+            newline_style: NewlineStyle::Unix,\n+            fn_brace_style: BraceStyle::SameLineWhere,\n+            fn_return_indent: ReturnIndent::WithArgs,\n+            fn_args_paren_newline: true,\n+            struct_trailing_comma: SeparatorTactic::Vertical,\n+            struct_lit_trailing_comma: SeparatorTactic::Vertical,\n+            struct_lit_style: StructLitStyle::BlockIndent,\n+            enum_trailing_comma: true,\n+            report_todo: ReportTactic::Always,\n+            report_fixme: ReportTactic::Never,\n+            reorder_imports: false,\n+            expr_indent_style: BlockIndentStyle::Tabbed,\n+            closure_indent_style: BlockIndentStyle::Visual,\n+            single_line_if_else: false,\n+        }\n+    }\n+\n+}"}, {"sha": "19e98a648892991646b692b13bccf13355e20495", "filename": "tests/system.rs", "status": "modified", "additions": 8, "deletions": 6, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/9ead47151e22f68fcbd0fe5194cbd09cd2482680/tests%2Fsystem.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9ead47151e22f68fcbd0fe5194cbd09cd2482680/tests%2Fsystem.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsystem.rs?ref=9ead47151e22f68fcbd0fe5194cbd09cd2482680", "patch": "@@ -121,12 +121,14 @@ pub fn idempotent_check(filename: String) -> Result<(), HashMap<String, String>>\n \n // Reads test config file from comments and reads its contents.\n fn get_config(config_file: Option<&str>) -> Box<Config> {\n-    let config_file_name = config_file.map(|file_name| {\n-                                           let mut full_path = \"tests/config/\".to_owned();\n-                                           full_path.push_str(&file_name);\n-                                           full_path\n-                                       })\n-                                       .unwrap_or(\"default.toml\".to_owned());\n+    let config_file_name = match config_file {\n+        None => return Box::new(Default::default()),\n+        Some(file_name) => {\n+            let mut full_path = \"tests/config/\".to_owned();\n+            full_path.push_str(&file_name);\n+            full_path\n+        }\n+    };\n \n     let mut def_config_file = fs::File::open(config_file_name).ok().expect(\"Couldn't open config.\");\n     let mut def_config = String::new();"}]}