{"sha": "76b69a604ee0d70be1edfa2828c769dc1b148d13", "node_id": "MDY6Q29tbWl0NzI0NzEyOjc2YjY5YTYwNGVlMGQ3MGJlMWVkZmEyODI4Yzc2OWRjMWIxNDhkMTM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-08-09T01:38:13Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-08-09T01:38:13Z"}, "message": "Auto merge of #53100 - VPashkov:issue-52456-improper_ctypes, r=eddyb\n\nFix improper_ctypes lint for individual foreign items\n\nFixes #52456.\n\nr? @eddyb", "tree": {"sha": "2693a589676758c1ff15b3741be2964ee95f35e5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2693a589676758c1ff15b3741be2964ee95f35e5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/76b69a604ee0d70be1edfa2828c769dc1b148d13", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/76b69a604ee0d70be1edfa2828c769dc1b148d13", "html_url": "https://github.com/rust-lang/rust/commit/76b69a604ee0d70be1edfa2828c769dc1b148d13", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/76b69a604ee0d70be1edfa2828c769dc1b148d13/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "80caa7f9f46097d5442d525aea29a435d5daa328", "url": "https://api.github.com/repos/rust-lang/rust/commits/80caa7f9f46097d5442d525aea29a435d5daa328", "html_url": "https://github.com/rust-lang/rust/commit/80caa7f9f46097d5442d525aea29a435d5daa328"}, {"sha": "70cafecaba233037bd5df5259140c3167941e70c", "url": "https://api.github.com/repos/rust-lang/rust/commits/70cafecaba233037bd5df5259140c3167941e70c", "html_url": "https://github.com/rust-lang/rust/commit/70cafecaba233037bd5df5259140c3167941e70c"}], "stats": {"total": 30, "additions": 17, "deletions": 13}, "files": [{"sha": "f1636c4dcb08afce27807f76dcd05e7a21a4b0bb", "filename": "src/librustc_lint/types.rs", "status": "modified", "additions": 10, "deletions": 13, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/76b69a604ee0d70be1edfa2828c769dc1b148d13/src%2Flibrustc_lint%2Ftypes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/76b69a604ee0d70be1edfa2828c769dc1b148d13/src%2Flibrustc_lint%2Ftypes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_lint%2Ftypes.rs?ref=76b69a604ee0d70be1edfa2828c769dc1b148d13", "patch": "@@ -790,21 +790,18 @@ impl LintPass for ImproperCTypes {\n }\n \n impl<'a, 'tcx> LateLintPass<'a, 'tcx> for ImproperCTypes {\n-    fn check_item(&mut self, cx: &LateContext, it: &hir::Item) {\n+    fn check_foreign_item(&mut self, cx: &LateContext, it: &hir::ForeignItem) {\n         let mut vis = ImproperCTypesVisitor { cx: cx };\n-        if let hir::ItemKind::ForeignMod(ref nmod) = it.node {\n-            if nmod.abi != Abi::RustIntrinsic && nmod.abi != Abi::PlatformIntrinsic {\n-                for ni in &nmod.items {\n-                    match ni.node {\n-                        hir::ForeignItemKind::Fn(ref decl, _, _) => {\n-                            vis.check_foreign_fn(ni.id, decl);\n-                        }\n-                        hir::ForeignItemKind::Static(ref ty, _) => {\n-                            vis.check_foreign_static(ni.id, ty.span);\n-                        }\n-                        hir::ForeignItemKind::Type => ()\n-                    }\n+        let abi = cx.tcx.hir.get_foreign_abi(it.id);\n+        if abi != Abi::RustIntrinsic && abi != Abi::PlatformIntrinsic {\n+            match it.node {\n+                hir::ForeignItemKind::Fn(ref decl, _, _) => {\n+                    vis.check_foreign_fn(it.id, decl);\n+                }\n+                hir::ForeignItemKind::Static(ref ty, _) => {\n+                    vis.check_foreign_static(it.id, ty.span);\n                 }\n+                hir::ForeignItemKind::Type => ()\n             }\n         }\n     }"}, {"sha": "b8b1a675c5f6dbef301f694c8c6d52f2b46a2938", "filename": "src/test/ui/lint-ctypes.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/76b69a604ee0d70be1edfa2828c769dc1b148d13/src%2Ftest%2Fui%2Flint-ctypes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/76b69a604ee0d70be1edfa2828c769dc1b148d13/src%2Ftest%2Fui%2Flint-ctypes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint-ctypes.rs?ref=76b69a604ee0d70be1edfa2828c769dc1b148d13", "patch": "@@ -88,6 +88,13 @@ extern {\n     pub fn good15(p: TransparentLifetime);\n     pub fn good16(p: TransparentUnit<ZeroSize>);\n     pub fn good17(p: TransparentCustomZst);\n+    #[allow(improper_ctypes)]\n+    pub fn good18(_: &String);\n+}\n+\n+#[allow(improper_ctypes)]\n+extern {\n+    pub fn good19(_: &String);\n }\n \n #[cfg(not(target_arch = \"wasm32\"))]"}]}