{"sha": "fe9271af22f4a24a3fb06336c2e38fa124158bc6", "node_id": "C_kwDOAAsO6NoAKGZlOTI3MWFmMjJmNGEyNGEzZmIwNjMzNmMyZTM4ZmExMjQxNThiYzY", "commit": {"author": {"name": "Arpad Borsos", "email": "swatinem@swatinem.de", "date": "2022-01-09T17:14:01Z"}, "committer": {"name": "Arpad Borsos", "email": "swatinem@swatinem.de", "date": "2022-02-07T11:29:34Z"}, "message": "Add `#[no_coverage]` tests for nested functions", "tree": {"sha": "6fa3e02d8938b2080cc9b49cff1c2a1c5c5ba34e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6fa3e02d8938b2080cc9b49cff1c2a1c5c5ba34e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fe9271af22f4a24a3fb06336c2e38fa124158bc6", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEZNNjbpmzULCa7LeL/HvKd4JLMpgFAmIBAqMACgkQ/HvKd4JL\nMpj0yw//cTCtLdYoVZze0sHdyjJtPBnOxH0C7arQdy28Sz4YS5KsY4U7nnDsF3Uy\npKJCo4+B6iYWpY6fHJh3HdUTx7oFRfM4B8UQye/d7H0fLeK662w6KqCs/biQqtnT\nkNgmAaRWwIPnlDYda6N9kCMHFjxBp7K6kNEMg+o9/8MK3/6fgLGCxGRYgcrYUGZD\nUnVQHVjh1VoCi5w9zgIJ3wu0t010noFFMn0Z+JzG3WhiSCwlWYC8ODb9dAK1kPU4\npPmZqt2J3UJ+CW7/VHYR9tksQkeBxPpSVHRfJhWNVP3o+oUQpVTyer0S8dGfHs56\nB1JiColyPvKPFAoxVZw4AMCD+BeW6KtXhd1GvdGaTisujwRKzneNksk43cgnVqV0\nc0tKxQIfDI5mTM/sFcxKMKxsXObhK9elwiLpeL8MDxJXHS2jseLIJUUS1cBiacQH\nPCni8k8tx761mCDcXBdet+79iQokoC9XZ/LTkfbP+/vzclZ2afcIOygeBSCtriBd\nye4ei96nsh0/HHaeUq80zePYUmYF9VcD5xyLcM93KKYPO1cj4jY55+YZLelHciIe\n1nACYWYeVitBTC6kLLjKhXDt7uNL6RU3lU2TVLDRlP5XvRfW/HAOMN9p1KLmVnwq\n2Yv+TAJm5BXog1ArqadMNp879KrGhUL4SNUanSS0DH3cR7hMS0Y=\n=k91t\n-----END PGP SIGNATURE-----", "payload": "tree 6fa3e02d8938b2080cc9b49cff1c2a1c5c5ba34e\nparent 926e7843eaa1794f15948395588eddedfb74a0d8\nauthor Arpad Borsos <swatinem@swatinem.de> 1641748441 +0100\ncommitter Arpad Borsos <swatinem@swatinem.de> 1644233374 +0100\n\nAdd `#[no_coverage]` tests for nested functions\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fe9271af22f4a24a3fb06336c2e38fa124158bc6", "html_url": "https://github.com/rust-lang/rust/commit/fe9271af22f4a24a3fb06336c2e38fa124158bc6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fe9271af22f4a24a3fb06336c2e38fa124158bc6/comments", "author": {"login": "Swatinem", "id": 580492, "node_id": "MDQ6VXNlcjU4MDQ5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/580492?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Swatinem", "html_url": "https://github.com/Swatinem", "followers_url": "https://api.github.com/users/Swatinem/followers", "following_url": "https://api.github.com/users/Swatinem/following{/other_user}", "gists_url": "https://api.github.com/users/Swatinem/gists{/gist_id}", "starred_url": "https://api.github.com/users/Swatinem/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Swatinem/subscriptions", "organizations_url": "https://api.github.com/users/Swatinem/orgs", "repos_url": "https://api.github.com/users/Swatinem/repos", "events_url": "https://api.github.com/users/Swatinem/events{/privacy}", "received_events_url": "https://api.github.com/users/Swatinem/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Swatinem", "id": 580492, "node_id": "MDQ6VXNlcjU4MDQ5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/580492?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Swatinem", "html_url": "https://github.com/Swatinem", "followers_url": "https://api.github.com/users/Swatinem/followers", "following_url": "https://api.github.com/users/Swatinem/following{/other_user}", "gists_url": "https://api.github.com/users/Swatinem/gists{/gist_id}", "starred_url": "https://api.github.com/users/Swatinem/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Swatinem/subscriptions", "organizations_url": "https://api.github.com/users/Swatinem/orgs", "repos_url": "https://api.github.com/users/Swatinem/repos", "events_url": "https://api.github.com/users/Swatinem/events{/privacy}", "received_events_url": "https://api.github.com/users/Swatinem/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "926e7843eaa1794f15948395588eddedfb74a0d8", "url": "https://api.github.com/repos/rust-lang/rust/commits/926e7843eaa1794f15948395588eddedfb74a0d8", "html_url": "https://github.com/rust-lang/rust/commit/926e7843eaa1794f15948395588eddedfb74a0d8"}], "stats": {"total": 118, "additions": 109, "deletions": 9}, "files": [{"sha": "83a9204136f7c15d82a676c84c9c461e55e297db", "filename": "src/test/run-make-fulldeps/coverage-reports/expected_show_coverage.no_cov_crate.txt", "status": "modified", "additions": 58, "deletions": 8, "changes": 66, "blob_url": "https://github.com/rust-lang/rust/blob/fe9271af22f4a24a3fb06336c2e38fa124158bc6/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.no_cov_crate.txt", "raw_url": "https://github.com/rust-lang/rust/raw/fe9271af22f4a24a3fb06336c2e38fa124158bc6/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.no_cov_crate.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.no_cov_crate.txt?ref=fe9271af22f4a24a3fb06336c2e38fa124158bc6", "patch": "@@ -6,8 +6,8 @@\n     6|       |    println!(\"called but not covered\");\n     7|       |}\n     8|       |\n-    9|       |#[no_coverage]\n-   10|       |fn do_not_add_coverage_2() {\n+    9|       |fn do_not_add_coverage_2() {\n+   10|       |    #![no_coverage]\n    11|       |    println!(\"called but not covered\");\n    12|       |}\n    13|       |\n@@ -28,10 +28,60 @@\n    28|      0|    println!(\"not called but covered\");\n    29|      0|}\n    30|       |\n-   31|      1|fn main() {\n-   32|      1|    do_not_add_coverage_1();\n-   33|      1|    do_not_add_coverage_2();\n-   34|      1|    add_coverage_1();\n-   35|      1|    add_coverage_2();\n-   36|      1|}\n+   31|       |// FIXME: These test-cases illustrate confusing results of nested functions.\n+   32|       |// See https://github.com/rust-lang/rust/issues/93319\n+   33|       |mod nested_fns {\n+   34|       |    #[no_coverage]\n+   35|       |    pub fn outer_not_covered(is_true: bool) {\n+   36|      1|        fn inner(is_true: bool) {\n+   37|      1|            if is_true {\n+   38|      1|                println!(\"called and covered\");\n+   39|      1|            } else {\n+   40|      0|                println!(\"absolutely not covered\");\n+   41|      0|            }\n+   42|      1|        }\n+   43|       |        println!(\"called but not covered\");\n+   44|       |        inner(is_true);\n+   45|       |    }\n+   46|       |\n+   47|      1|    pub fn outer(is_true: bool) {\n+   48|      1|        println!(\"called and covered\");\n+   49|      1|        inner_not_covered(is_true);\n+   50|      1|\n+   51|      1|        #[no_coverage]\n+   52|      1|        fn inner_not_covered(is_true: bool) {\n+   53|      1|            if is_true {\n+   54|      1|                println!(\"called but not covered\");\n+   55|      1|            } else {\n+   56|      1|                println!(\"absolutely not covered\");\n+   57|      1|            }\n+   58|      1|        }\n+   59|      1|    }\n+   60|       |\n+   61|      1|    pub fn outer_both_covered(is_true: bool) {\n+   62|      1|        println!(\"called and covered\");\n+   63|      1|        inner(is_true);\n+   64|      1|\n+   65|      1|        fn inner(is_true: bool) {\n+   66|      1|            if is_true {\n+   67|      1|                println!(\"called and covered\");\n+   68|      1|            } else {\n+   69|      0|                println!(\"absolutely not covered\");\n+   70|      0|            }\n+   71|      1|        }\n+   72|      1|    }\n+   73|       |}\n+   74|       |\n+   75|      1|fn main() {\n+   76|      1|    let is_true = std::env::args().len() == 1;\n+   77|      1|\n+   78|      1|    do_not_add_coverage_1();\n+   79|      1|    do_not_add_coverage_2();\n+   80|      1|    add_coverage_1();\n+   81|      1|    add_coverage_2();\n+   82|      1|\n+   83|      1|    nested_fns::outer_not_covered(is_true);\n+   84|      1|    nested_fns::outer(is_true);\n+   85|      1|    nested_fns::outer_both_covered(is_true);\n+   86|      1|}\n "}, {"sha": "0bfbdda2cab037cd1d748d9cb7b063710db15c10", "filename": "src/test/run-make-fulldeps/coverage/no_cov_crate.rs", "status": "modified", "additions": 51, "deletions": 1, "changes": 52, "blob_url": "https://github.com/rust-lang/rust/blob/fe9271af22f4a24a3fb06336c2e38fa124158bc6/src%2Ftest%2Frun-make-fulldeps%2Fcoverage%2Fno_cov_crate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fe9271af22f4a24a3fb06336c2e38fa124158bc6/src%2Ftest%2Frun-make-fulldeps%2Fcoverage%2Fno_cov_crate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fcoverage%2Fno_cov_crate.rs?ref=fe9271af22f4a24a3fb06336c2e38fa124158bc6", "patch": "@@ -6,8 +6,8 @@ fn do_not_add_coverage_1() {\n     println!(\"called but not covered\");\n }\n \n-#[no_coverage]\n fn do_not_add_coverage_2() {\n+    #![no_coverage]\n     println!(\"called but not covered\");\n }\n \n@@ -28,9 +28,59 @@ fn add_coverage_not_called() {\n     println!(\"not called but covered\");\n }\n \n+// FIXME: These test-cases illustrate confusing results of nested functions.\n+// See https://github.com/rust-lang/rust/issues/93319\n+mod nested_fns {\n+    #[no_coverage]\n+    pub fn outer_not_covered(is_true: bool) {\n+        fn inner(is_true: bool) {\n+            if is_true {\n+                println!(\"called and covered\");\n+            } else {\n+                println!(\"absolutely not covered\");\n+            }\n+        }\n+        println!(\"called but not covered\");\n+        inner(is_true);\n+    }\n+\n+    pub fn outer(is_true: bool) {\n+        println!(\"called and covered\");\n+        inner_not_covered(is_true);\n+\n+        #[no_coverage]\n+        fn inner_not_covered(is_true: bool) {\n+            if is_true {\n+                println!(\"called but not covered\");\n+            } else {\n+                println!(\"absolutely not covered\");\n+            }\n+        }\n+    }\n+\n+    pub fn outer_both_covered(is_true: bool) {\n+        println!(\"called and covered\");\n+        inner(is_true);\n+\n+        fn inner(is_true: bool) {\n+            if is_true {\n+                println!(\"called and covered\");\n+            } else {\n+                println!(\"absolutely not covered\");\n+            }\n+        }\n+    }\n+}\n+\n fn main() {\n+    let is_true = std::env::args().len() == 1;\n+\n     do_not_add_coverage_1();\n     do_not_add_coverage_2();\n     add_coverage_1();\n     add_coverage_2();\n+\n+    nested_fns::outer_not_covered(is_true);\n+    nested_fns::outer(is_true);\n+    nested_fns::outer_both_covered(is_true);\n }"}]}