{"sha": "ff5522fc1ae2c1d66fb2a465f48e03732fa8570b", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZmNTUyMmZjMWFlMmMxZDY2ZmIyYTQ2NWY0OGUwMzczMmZhODU3MGI=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-05-29T16:27:14Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-05-29T16:27:14Z"}, "message": "Auto merge of #85540 - GuillaumeGomez:better-result-dom-generation, r=jsha\n\nBetter result dom generation\n\nFirst commit is from https://github.com/rust-lang/rust/pull/85506.\n\nWe realized in https://github.com/rust-lang/rust/pull/85506#issuecomment-844984162 thanks to `@dns2utf8` that in some cases, the generated search result DOM was invalid. This was not strict enough and the DOM was inserted as a big string, which wasn't great.\n\nr? `@jsha`", "tree": {"sha": "1f53d9eb1b4a1e27035ff8624ab05f9aae1b2e29", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1f53d9eb1b4a1e27035ff8624ab05f9aae1b2e29"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ff5522fc1ae2c1d66fb2a465f48e03732fa8570b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ff5522fc1ae2c1d66fb2a465f48e03732fa8570b", "html_url": "https://github.com/rust-lang/rust/commit/ff5522fc1ae2c1d66fb2a465f48e03732fa8570b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ff5522fc1ae2c1d66fb2a465f48e03732fa8570b/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9f75dbfa69ba8508fa7765305f75cd96dff06078", "url": "https://api.github.com/repos/rust-lang/rust/commits/9f75dbfa69ba8508fa7765305f75cd96dff06078", "html_url": "https://github.com/rust-lang/rust/commit/9f75dbfa69ba8508fa7765305f75cd96dff06078"}, {"sha": "0fae87a24ce432a4b8a1a1530324246cc2345a5b", "url": "https://api.github.com/repos/rust-lang/rust/commits/0fae87a24ce432a4b8a1a1530324246cc2345a5b", "html_url": "https://github.com/rust-lang/rust/commit/0fae87a24ce432a4b8a1a1530324246cc2345a5b"}], "stats": {"total": 92, "additions": 70, "deletions": 22}, "files": [{"sha": "b3242bf4df923aa3b1df32a830f3eae4a055d0e3", "filename": "src/librustdoc/html/static/search.js", "status": "modified", "additions": 49, "deletions": 16, "changes": 65, "blob_url": "https://github.com/rust-lang/rust/blob/ff5522fc1ae2c1d66fb2a465f48e03732fa8570b/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fsearch.js", "raw_url": "https://github.com/rust-lang/rust/raw/ff5522fc1ae2c1d66fb2a465f48e03732fa8570b/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fsearch.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fsearch.js?ref=ff5522fc1ae2c1d66fb2a465f48e03732fa8570b", "patch": "@@ -968,11 +968,11 @@ window.initSearch = function(rawSearchIndex) {\n             extraClass = \" active\";\n         }\n \n-        var output = \"\";\n+        var output = document.createElement(\"div\");\n         var duplicates = {};\n         var length = 0;\n         if (array.length > 0) {\n-            output = \"<div class=\\\"search-results \" + extraClass + \"\\\">\";\n+            output.className = \"search-results \" + extraClass;\n \n             array.forEach(function(item) {\n                 if (item.is_alias !== true) {\n@@ -994,19 +994,46 @@ window.initSearch = function(rawSearchIndex) {\n                     extra = \" <i>(keyword)</i>\";\n                 }\n \n-                output += \"<a class=\\\"result-\" + type + \"\\\" href=\\\"\" + item.href + \"\\\">\" +\n-                          \"<div><div class=\\\"result-name\\\">\" +\n-                          (item.is_alias === true ?\n-                           (\"<span class=\\\"alias\\\"><b>\" + item.alias + \" </b></span><span \" +\n-                              \"class=\\\"grey\\\"><i>&nbsp;- see&nbsp;</i></span>\") : \"\") +\n-                          item.displayPath + \"<span class=\\\"\" + type + \"\\\">\" +\n-                          name + extra + \"</span></div><div class=\\\"desc\\\">\" +\n-                          \"<span>\" + item.desc +\n-                          \"&nbsp;</span></div></div></a>\";\n+                var link = document.createElement(\"a\");\n+                link.className = \"result-\" + type;\n+                link.href = item.href;\n+\n+                var wrapper = document.createElement(\"div\");\n+                var resultName = document.createElement(\"div\");\n+                resultName.className = \"result-name\";\n+\n+                if (item.is_alias) {\n+                    var alias = document.createElement(\"span\");\n+                    alias.className = \"alias\";\n+\n+                    var bold = document.createElement(\"b\");\n+                    bold.innerText = item.alias;\n+                    alias.appendChild(bold);\n+\n+                    alias.insertAdjacentHTML(\n+                        \"beforeend\",\n+                        \"<span class=\\\"grey\\\"><i>&nbsp;- see&nbsp;</i></span>\");\n+\n+                    resultName.appendChild(alias);\n+                }\n+                resultName.insertAdjacentHTML(\n+                    \"beforeend\",\n+                    item.displayPath + \"<span class=\\\"\" + type + \"\\\">\" + name + extra + \"</span>\");\n+                wrapper.appendChild(resultName);\n+\n+                var description = document.createElement(\"div\");\n+                description.className = \"desc\";\n+                var spanDesc = document.createElement(\"span\");\n+                spanDesc.innerText = item.desc + \"\\u00A0\";\n+\n+                description.appendChild(spanDesc);\n+                wrapper.appendChild(description);\n+                link.appendChild(wrapper);\n+                output.appendChild(link);\n             });\n-            output += \"</div>\";\n         } else {\n-            output = \"<div class=\\\"search-failed\\\"\" + extraClass + \">No results :(<br/>\" +\n+            output.className = \"search-failed\" + extraClass;\n+            output.innerHTML = \"No results :(<br/>\" +\n                 \"Try on <a href=\\\"https://duckduckgo.com/?q=\" +\n                 encodeURIComponent(\"rust \" + query.query) +\n                 \"\\\">DuckDuckGo</a>?<br/><br/>\" +\n@@ -1018,7 +1045,7 @@ window.initSearch = function(rawSearchIndex) {\n                 \"href=\\\"https://doc.rust-lang.org/book/index.html\\\">Rust Book</a> for \" +\n                 \"introductions to language features and the language itself.</li><li><a \" +\n                 \"href=\\\"https://docs.rs\\\">Docs.rs</a> for documentation of crates released on\" +\n-                \" <a href=\\\"https://crates.io/\\\">crates.io</a>.</li></ul></div>\";\n+                \" <a href=\\\"https://crates.io/\\\">crates.io</a>.</li></ul>\";\n         }\n         return [output, length];\n     }\n@@ -1078,10 +1105,16 @@ window.initSearch = function(rawSearchIndex) {\n             makeTabHeader(0, \"In Names\", ret_others[1]) +\n             makeTabHeader(1, \"In Parameters\", ret_in_args[1]) +\n             makeTabHeader(2, \"In Return Types\", ret_returned[1]) +\n-            \"</div><div id=\\\"results\\\">\" +\n-            ret_others[0] + ret_in_args[0] + ret_returned[0] + \"</div>\";\n+            \"</div>\";\n+\n+        var resultsElem = document.createElement(\"div\");\n+        resultsElem.id = \"results\";\n+        resultsElem.appendChild(ret_others[0]);\n+        resultsElem.appendChild(ret_in_args[0]);\n+        resultsElem.appendChild(ret_returned[0]);\n \n         search.innerHTML = output;\n+        search.appendChild(resultsElem);\n         // Reset focused elements.\n         searchState.focusedByTab = [null, null, null];\n         searchState.showResults(search);"}, {"sha": "fd47c085b844e0c21c1cd07983c578a54496b55f", "filename": "src/librustdoc/html/static/themes/ayu.css", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/ff5522fc1ae2c1d66fb2a465f48e03732fa8570b/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fthemes%2Fayu.css", "raw_url": "https://github.com/rust-lang/rust/raw/ff5522fc1ae2c1d66fb2a465f48e03732fa8570b/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fthemes%2Fayu.css", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fthemes%2Fayu.css?ref=ff5522fc1ae2c1d66fb2a465f48e03732fa8570b", "patch": "@@ -565,10 +565,10 @@ kbd {\n \tbackground-color: rgba(70, 70, 70, 0.33);\n }\n \n-.search-results td span.alias {\n+.search-results .result-name span.alias {\n \tcolor: #c5c5c5;\n }\n-.search-results td span.grey {\n+.search-results .result-name span.grey {\n \tcolor: #999;\n }\n "}, {"sha": "d6e1a880a4e1706d86365109a7e3faebd90fd9dc", "filename": "src/librustdoc/html/static/themes/dark.css", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/ff5522fc1ae2c1d66fb2a465f48e03732fa8570b/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fthemes%2Fdark.css", "raw_url": "https://github.com/rust-lang/rust/raw/ff5522fc1ae2c1d66fb2a465f48e03732fa8570b/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fthemes%2Fdark.css", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fthemes%2Fdark.css?ref=ff5522fc1ae2c1d66fb2a465f48e03732fa8570b", "patch": "@@ -444,10 +444,10 @@ kbd {\n \tbackground-color: #606060;\n }\n \n-.search-results td span.alias {\n+.search-results .result-name span.alias {\n \tcolor: #fff;\n }\n-.search-results td span.grey {\n+.search-results .result-name span.grey {\n \tcolor: #ccc;\n }\n "}, {"sha": "c8151f1cf977ed75562876f922c767cad0a5e565", "filename": "src/librustdoc/html/static/themes/light.css", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/ff5522fc1ae2c1d66fb2a465f48e03732fa8570b/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fthemes%2Flight.css", "raw_url": "https://github.com/rust-lang/rust/raw/ff5522fc1ae2c1d66fb2a465f48e03732fa8570b/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fthemes%2Flight.css", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fthemes%2Flight.css?ref=ff5522fc1ae2c1d66fb2a465f48e03732fa8570b", "patch": "@@ -435,10 +435,10 @@ kbd {\n \tbackground-color: #f9f9f9;\n }\n \n-.search-results td span.alias {\n+.search-results .result-name span.alias {\n \tcolor: #000;\n }\n-.search-results td span.grey {\n+.search-results .result-name span.grey {\n \tcolor: #999;\n }\n "}, {"sha": "25a015121592c3c0b003d560f3e5126c56c5d32b", "filename": "src/test/rustdoc-gui/search-result-colors.goml", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/ff5522fc1ae2c1d66fb2a465f48e03732fa8570b/src%2Ftest%2Frustdoc-gui%2Fsearch-result-colors.goml", "raw_url": "https://github.com/rust-lang/rust/raw/ff5522fc1ae2c1d66fb2a465f48e03732fa8570b/src%2Ftest%2Frustdoc-gui%2Fsearch-result-colors.goml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-gui%2Fsearch-result-colors.goml?ref=ff5522fc1ae2c1d66fb2a465f48e03732fa8570b", "patch": "@@ -0,0 +1,14 @@\n+goto: file://|DOC_PATH|/test_docs/index.html\n+// We set the theme so we're sure that the corect values will be used, whatever the computer\n+// this test is running on.\n+local-storage: {\"rustdoc-theme\": \"dark\", \"rustdoc-preferred-dark-theme\": \"dark\", \"rustdoc-use-system-theme\": \"false\"}\n+// If the text isn't displayed, the browser doesn't compute color style correctly...\n+show-text: true\n+// We reload the page so the local storage settings are being used.\n+reload:\n+write: (\".search-input\", \"thisisanalias\")\n+// Waiting for the search results to appear...\n+wait-for: \"#titles\"\n+// Checking that the colors for the alias element are the ones expected.\n+assert: (\".result-name > .alias\", {\"color\": \"rgb(255, 255, 255)\"})\n+assert: (\".result-name > .alias > .grey\", {\"color\": \"rgb(204, 204, 204)\"})"}, {"sha": "272b1d05452e382b9bd95f4cbeb0a668dfbdb826", "filename": "src/test/rustdoc-gui/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/ff5522fc1ae2c1d66fb2a465f48e03732fa8570b/src%2Ftest%2Frustdoc-gui%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ff5522fc1ae2c1d66fb2a465f48e03732fa8570b/src%2Ftest%2Frustdoc-gui%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-gui%2Fsrc%2Flib.rs?ref=ff5522fc1ae2c1d66fb2a465f48e03732fa8570b", "patch": "@@ -36,6 +36,7 @@ impl Foo {\n }\n \n /// Just a normal enum.\n+#[doc(alias = \"ThisIsAnAlias\")]\n pub enum WhoLetTheDogOut {\n     /// Woof!\n     Woof,"}]}