{"sha": "b792e4abbde2c8a5d664aaac22f8418f1ee09b79", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI3OTJlNGFiYmRlMmM4YTVkNjY0YWFhYzIyZjg0MThmMWVlMDliNzk=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2020-03-19T08:38:08Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-03-19T08:38:08Z"}, "message": "Merge pull request #3635 from matklad/tags\n\nSimplify extension tag sniffing", "tree": {"sha": "6fd47ffb498891ca24b2972dabfdd58a3f737644", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6fd47ffb498891ca24b2972dabfdd58a3f737644"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b792e4abbde2c8a5d664aaac22f8418f1ee09b79", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJecy9wCRBK7hj4Ov3rIwAAdHIIAGIQEqjXgH5rTdrIrq5Fk5jM\nBIu2uZZDO8VK4ort+ZZoW0T0zkUBfA+pF2Tkb3KExv19vjUgrAbJ4Ld7mGjcF2Nb\n+pRechM8ConmxI7n/KXhaBf7KmULDDE5+SCBeNDEwkzjfYHGo9KzgJPw4rqf1bsO\n2SRwhAKifed3AZ5ueDJ4CgVS8Z+DzgpR6i2NoDDVQmos41nkplLRVL2sQbkscj1r\nFvo5UuTIuKZkUMTGoEg5NxKZtYOu1ZV48LbqKtiaSPjfGEIzqM+D3poXFmn2MPcQ\nTenU+YsTib4Tx/7WKZoYEoOgTPhNgsnz7HvmzpGioyyJGnyPo8fd+kRmdBfwOIA=\n=FlZ1\n-----END PGP SIGNATURE-----\n", "payload": "tree 6fd47ffb498891ca24b2972dabfdd58a3f737644\nparent aca3c3086ee99f5770a60970e20af640c895d42a\nparent 3d1cb5e20f7a05314f6fd4261076b0a85546cfe4\nauthor Aleksey Kladov <aleksey.kladov@gmail.com> 1584607088 +0100\ncommitter GitHub <noreply@github.com> 1584607088 +0100\n\nMerge pull request #3635 from matklad/tags\n\nSimplify extension tag sniffing"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b792e4abbde2c8a5d664aaac22f8418f1ee09b79", "html_url": "https://github.com/rust-lang/rust/commit/b792e4abbde2c8a5d664aaac22f8418f1ee09b79", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b792e4abbde2c8a5d664aaac22f8418f1ee09b79/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "aca3c3086ee99f5770a60970e20af640c895d42a", "url": "https://api.github.com/repos/rust-lang/rust/commits/aca3c3086ee99f5770a60970e20af640c895d42a", "html_url": "https://github.com/rust-lang/rust/commit/aca3c3086ee99f5770a60970e20af640c895d42a"}, {"sha": "3d1cb5e20f7a05314f6fd4261076b0a85546cfe4", "url": "https://api.github.com/repos/rust-lang/rust/commits/3d1cb5e20f7a05314f6fd4261076b0a85546cfe4", "html_url": "https://github.com/rust-lang/rust/commit/3d1cb5e20f7a05314f6fd4261076b0a85546cfe4"}], "stats": {"total": 61, "additions": 27, "deletions": 34}, "files": [{"sha": "13bc172ba868fe08559cbeec6eaf13905eb09696", "filename": ".github/workflows/release.yaml", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/b792e4abbde2c8a5d664aaac22f8418f1ee09b79/.github%2Fworkflows%2Frelease.yaml", "raw_url": "https://github.com/rust-lang/rust/raw/b792e4abbde2c8a5d664aaac22f8418f1ee09b79/.github%2Fworkflows%2Frelease.yaml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.github%2Fworkflows%2Frelease.yaml?ref=b792e4abbde2c8a5d664aaac22f8418f1ee09b79", "patch": "@@ -6,6 +6,7 @@ on:\n   push:\n     branches:\n     - release\n+    - nightly\n \n jobs:\n   dist:\n@@ -49,11 +50,11 @@ jobs:\n \n     - name: Dist\n       if: github.event_name == 'push'\n-      run: cargo xtask dist\n+      run: cargo xtask dist --version 0.2.$GITHUB_RUN_NUMBER         --tag $(date --iso --utc)\n \n     - name: Dist\n       if: github.event_name != 'push'\n-      run: cargo xtask dist --nightly\n+      run: cargo xtask dist --version 0.3.$GITHUB_RUN_NUMBER-nightly --tag nightly\n \n     - name: Upload artifacts\n       uses: actions/upload-artifact@v1"}, {"sha": "9f2fe06f3de4f08cba0d2521cc32e1a5bdedabe5", "filename": "editors/code/package.json", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b792e4abbde2c8a5d664aaac22f8418f1ee09b79/editors%2Fcode%2Fpackage.json", "raw_url": "https://github.com/rust-lang/rust/raw/b792e4abbde2c8a5d664aaac22f8418f1ee09b79/editors%2Fcode%2Fpackage.json", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fpackage.json?ref=b792e4abbde2c8a5d664aaac22f8418f1ee09b79", "patch": "@@ -5,8 +5,8 @@\n     \"preview\": true,\n     \"private\": true,\n     \"icon\": \"icon.png\",\n-    \"//\": \"The real version is in release.yaml, this one just needs to be bigger\",\n-    \"version\": \"0.2.20200309-nightly\",\n+    \"version\": \"0.4.0-dev\",\n+    \"releaseTag\": \"nightly\",\n     \"publisher\": \"matklad\",\n     \"repository\": {\n         \"url\": \"https://github.com/rust-analyzer/rust-analyzer.git\","}, {"sha": "54b9053039fe4fa89a9467225bb79ef864772e30", "filename": "editors/code/src/config.ts", "status": "modified", "additions": 7, "deletions": 13, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/b792e4abbde2c8a5d664aaac22f8418f1ee09b79/editors%2Fcode%2Fsrc%2Fconfig.ts", "raw_url": "https://github.com/rust-lang/rust/raw/b792e4abbde2c8a5d664aaac22f8418f1ee09b79/editors%2Fcode%2Fsrc%2Fconfig.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fconfig.ts?ref=b792e4abbde2c8a5d664aaac22f8418f1ee09b79", "patch": "@@ -38,23 +38,17 @@ export class Config {\n     ]\n         .map(opt => `${this.rootSection}.${opt}`);\n \n-    readonly packageJsonVersion = vscode\n+    readonly packageJsonVersion: string = vscode\n         .extensions\n         .getExtension(this.extensionId)!\n         .packageJSON\n-        .version as string; // n.n.YYYYMMDD[-nightly]\n+        .version;\n \n-    /**\n-     * Either `nightly` or `YYYY-MM-DD` (i.e. `stable` release)\n-     */\n-    readonly extensionReleaseTag: string = (() => {\n-        if (this.packageJsonVersion.endsWith(NIGHTLY_TAG)) return NIGHTLY_TAG;\n-\n-        const realVersionRegexp = /^\\d+\\.\\d+\\.(\\d{4})(\\d{2})(\\d{2})/;\n-        const [, yyyy, mm, dd] = this.packageJsonVersion.match(realVersionRegexp)!;\n-\n-        return `${yyyy}-${mm}-${dd}`;\n-    })();\n+    readonly releaseTag: string = vscode\n+        .extensions\n+        .getExtension(this.extensionId)!\n+        .packageJSON\n+        .releaseTag;\n \n     private cfg!: vscode.WorkspaceConfiguration;\n "}, {"sha": "5297614a96341f5cea636fc5f9c32a0d5b2a3c1c", "filename": "editors/code/src/main.ts", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b792e4abbde2c8a5d664aaac22f8418f1ee09b79/editors%2Fcode%2Fsrc%2Fmain.ts", "raw_url": "https://github.com/rust-lang/rust/raw/b792e4abbde2c8a5d664aaac22f8418f1ee09b79/editors%2Fcode%2Fsrc%2Fmain.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fmain.ts?ref=b792e4abbde2c8a5d664aaac22f8418f1ee09b79", "patch": "@@ -111,7 +111,7 @@ async function bootstrap(config: Config, state: PersistentState): Promise<string\n \n async function bootstrapExtension(config: Config, state: PersistentState): Promise<void> {\n     if (config.channel === \"stable\") {\n-        if (config.extensionReleaseTag === NIGHTLY_TAG) {\n+        if (config.releaseTag === NIGHTLY_TAG) {\n             vscode.window.showWarningMessage(`You are running a nightly version of rust-analyzer extension.\n To switch to stable, uninstall the extension and re-install it from the marketplace`);\n         }\n@@ -219,7 +219,7 @@ async function getServer(config: Config, state: PersistentState): Promise<string\n         if (userResponse !== \"Download now\") return dest;\n     }\n \n-    const release = await fetchRelease(config.extensionReleaseTag);\n+    const release = await fetchRelease(config.releaseTag);\n     const artifact = release.assets.find(artifact => artifact.name === binaryName);\n     assert(!!artifact, `Bad release: ${JSON.stringify(release)}`);\n "}, {"sha": "3a14f8a63c4e445070bc28ec481ef190396aa1fa", "filename": "xtask/src/dist.rs", "status": "modified", "additions": 10, "deletions": 13, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/b792e4abbde2c8a5d664aaac22f8418f1ee09b79/xtask%2Fsrc%2Fdist.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b792e4abbde2c8a5d664aaac22f8418f1ee09b79/xtask%2Fsrc%2Fdist.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/xtask%2Fsrc%2Fdist.rs?ref=b792e4abbde2c8a5d664aaac22f8418f1ee09b79", "patch": "@@ -7,31 +7,27 @@ use crate::{\n     project_root,\n };\n \n-pub fn run_dist(nightly: bool) -> Result<()> {\n+pub fn run_dist(version: &str, release_tag: &str) -> Result<()> {\n     let dist = project_root().join(\"dist\");\n     rm_rf(&dist)?;\n     fs2::create_dir_all(&dist)?;\n \n     if cfg!(target_os = \"linux\") {\n-        dist_client(nightly)?;\n+        dist_client(version, release_tag)?;\n     }\n     dist_server()?;\n     Ok(())\n }\n \n-fn dist_client(nightly: bool) -> Result<()> {\n+fn dist_client(version: &str, release_tag: &str) -> Result<()> {\n     let _d = pushd(\"./editors/code\");\n+    let nightly = release_tag == \"nightly\";\n \n-    let package_json_path = PathBuf::from(\"./package.json\");\n-    let mut patch = Patch::new(package_json_path.clone())?;\n+    let mut patch = Patch::new(\"./package.json\")?;\n \n-    let date = run!(\"date --utc +%Y%m%d\")?;\n-    let version_suffix = if nightly { \"-nightly\" } else { \"\" };\n-\n-    patch.replace(\n-        r#\"\"version\": \"0.2.20200309-nightly\"\"#,\n-        &format!(r#\"\"version\": \"0.1.{}{}\"\"#, date, version_suffix),\n-    );\n+    patch\n+        .replace(r#\"\"version\": \"0.4.0-dev\"\"#, &format!(r#\"\"version\": \"{}\"\"#, version))\n+        .replace(r#\"\"releaseTag\": \"nightly\"\"#, &format!(r#\"\"releaseTag\": \"{}\"\"#, release_tag));\n \n     if nightly {\n         patch.replace(\n@@ -86,7 +82,8 @@ struct Patch {\n }\n \n impl Patch {\n-    fn new(path: PathBuf) -> Result<Patch> {\n+    fn new(path: impl Into<PathBuf>) -> Result<Patch> {\n+        let path = path.into();\n         let contents = fs2::read_to_string(&path)?;\n         Ok(Patch { path, original_contents: contents.clone(), contents })\n     }"}, {"sha": "aafa7361026148905c528cd43cc3b84fdab91319", "filename": "xtask/src/main.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/b792e4abbde2c8a5d664aaac22f8418f1ee09b79/xtask%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b792e4abbde2c8a5d664aaac22f8418f1ee09b79/xtask%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/xtask%2Fsrc%2Fmain.rs?ref=b792e4abbde2c8a5d664aaac22f8418f1ee09b79", "patch": "@@ -103,9 +103,10 @@ FLAGS:\n             run_release(dry_run)\n         }\n         \"dist\" => {\n-            let nightly = args.contains(\"--nightly\");\n+            let version: String = args.value_from_str(\"--version\")?;\n+            let release_tag: String = args.value_from_str(\"--tag\")?;\n             args.finish()?;\n-            run_dist(nightly)\n+            run_dist(&version, &release_tag)\n         }\n         _ => {\n             eprintln!("}]}