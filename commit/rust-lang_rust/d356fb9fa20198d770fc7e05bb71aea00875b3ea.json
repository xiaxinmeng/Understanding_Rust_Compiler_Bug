{"sha": "d356fb9fa20198d770fc7e05bb71aea00875b3ea", "node_id": "C_kwDOAAsO6NoAKGQzNTZmYjlmYTIwMTk4ZDc3MGZjN2UwNWJiNzFhZWEwMDg3NWIzZWE", "commit": {"author": {"name": "Cameron Steffen", "email": "cam.steffen94@gmail.com", "date": "2022-01-10T19:53:02Z"}, "committer": {"name": "Cameron Steffen", "email": "cam.steffen94@gmail.com", "date": "2022-01-10T23:04:38Z"}, "message": "Use `rustup which rustfmt`", "tree": {"sha": "6ee9dd331a1d140e3d94dd424a85e4a0a40a9f13", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6ee9dd331a1d140e3d94dd424a85e4a0a40a9f13"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d356fb9fa20198d770fc7e05bb71aea00875b3ea", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d356fb9fa20198d770fc7e05bb71aea00875b3ea", "html_url": "https://github.com/rust-lang/rust/commit/d356fb9fa20198d770fc7e05bb71aea00875b3ea", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d356fb9fa20198d770fc7e05bb71aea00875b3ea/comments", "author": {"login": "camsteffen", "id": 5565418, "node_id": "MDQ6VXNlcjU1NjU0MTg=", "avatar_url": "https://avatars.githubusercontent.com/u/5565418?v=4", "gravatar_id": "", "url": "https://api.github.com/users/camsteffen", "html_url": "https://github.com/camsteffen", "followers_url": "https://api.github.com/users/camsteffen/followers", "following_url": "https://api.github.com/users/camsteffen/following{/other_user}", "gists_url": "https://api.github.com/users/camsteffen/gists{/gist_id}", "starred_url": "https://api.github.com/users/camsteffen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/camsteffen/subscriptions", "organizations_url": "https://api.github.com/users/camsteffen/orgs", "repos_url": "https://api.github.com/users/camsteffen/repos", "events_url": "https://api.github.com/users/camsteffen/events{/privacy}", "received_events_url": "https://api.github.com/users/camsteffen/received_events", "type": "User", "site_admin": false}, "committer": {"login": "camsteffen", "id": 5565418, "node_id": "MDQ6VXNlcjU1NjU0MTg=", "avatar_url": "https://avatars.githubusercontent.com/u/5565418?v=4", "gravatar_id": "", "url": "https://api.github.com/users/camsteffen", "html_url": "https://github.com/camsteffen", "followers_url": "https://api.github.com/users/camsteffen/followers", "following_url": "https://api.github.com/users/camsteffen/following{/other_user}", "gists_url": "https://api.github.com/users/camsteffen/gists{/gist_id}", "starred_url": "https://api.github.com/users/camsteffen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/camsteffen/subscriptions", "organizations_url": "https://api.github.com/users/camsteffen/orgs", "repos_url": "https://api.github.com/users/camsteffen/repos", "events_url": "https://api.github.com/users/camsteffen/events{/privacy}", "received_events_url": "https://api.github.com/users/camsteffen/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7cf4f44e561acd2c69b9a4fd1b5e97ff59a6bbbe", "url": "https://api.github.com/repos/rust-lang/rust/commits/7cf4f44e561acd2c69b9a4fd1b5e97ff59a6bbbe", "html_url": "https://github.com/rust-lang/rust/commit/7cf4f44e561acd2c69b9a4fd1b5e97ff59a6bbbe"}], "stats": {"total": 25, "additions": 21, "deletions": 4}, "files": [{"sha": "d513a229b7e386d3178c7055a2140f8d263c8a8a", "filename": "clippy_dev/src/fmt.rs", "status": "modified", "additions": 21, "deletions": 4, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/d356fb9fa20198d770fc7e05bb71aea00875b3ea/clippy_dev%2Fsrc%2Ffmt.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d356fb9fa20198d770fc7e05bb71aea00875b3ea/clippy_dev%2Fsrc%2Ffmt.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_dev%2Fsrc%2Ffmt.rs?ref=d356fb9fa20198d770fc7e05bb71aea00875b3ea", "patch": "@@ -3,7 +3,7 @@ use itertools::Itertools;\n use shell_escape::escape;\n use std::ffi::{OsStr, OsString};\n use std::path::Path;\n-use std::process::{self, Command};\n+use std::process::{self, Command, Stdio};\n use std::{fs, io};\n use walkdir::WalkDir;\n \n@@ -31,6 +31,7 @@ impl From<walkdir::Error> for CliError {\n struct FmtContext {\n     check: bool,\n     verbose: bool,\n+    rustfmt_path: String,\n }\n \n // the \"main\" function of cargo dev fmt\n@@ -102,7 +103,23 @@ Please revert the changes to Cargo.tomls first.\"\n         }\n     }\n \n-    let context = FmtContext { check, verbose };\n+    let output = Command::new(\"rustup\")\n+        .args([\"which\", \"rustfmt\"])\n+        .stderr(Stdio::inherit())\n+        .output()\n+        .expect(\"error running `rustup which rustfmt`\");\n+    if !output.status.success() {\n+        eprintln!(\"`rustup which rustfmt` did not execute successfully\");\n+        process::exit(1);\n+    }\n+    let mut rustfmt_path = String::from_utf8(output.stdout).expect(\"invalid rustfmt path\");\n+    rustfmt_path.truncate(rustfmt_path.trim_end().len());\n+\n+    let context = FmtContext {\n+        check,\n+        verbose,\n+        rustfmt_path,\n+    };\n     let result = try_run(&context);\n     let code = match result {\n         Ok(true) => 0,\n@@ -142,6 +159,7 @@ fn exec(\n     }\n \n     let output = Command::new(&program)\n+        .env(\"RUSTFMT\", &context.rustfmt_path)\n         .current_dir(&dir)\n         .args(args.iter())\n         .output()\n@@ -162,7 +180,6 @@ fn exec(\n fn cargo_fmt(context: &FmtContext, path: &Path) -> Result<bool, CliError> {\n     let mut args = vec![\"fmt\", \"--all\"];\n     if context.check {\n-        args.push(\"--\");\n         args.push(\"--check\");\n     }\n     let success = exec(context, \"cargo\", path, &args)?;\n@@ -203,7 +220,7 @@ fn rustfmt(context: &FmtContext, paths: impl Iterator<Item = OsString>) -> Resul\n     }\n     args.extend(paths);\n \n-    let success = exec(context, \"rustfmt\", std::env::current_dir()?, &args)?;\n+    let success = exec(context, &context.rustfmt_path, std::env::current_dir()?, &args)?;\n \n     Ok(success)\n }"}]}