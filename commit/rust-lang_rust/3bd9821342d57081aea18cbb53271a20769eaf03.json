{"sha": "3bd9821342d57081aea18cbb53271a20769eaf03", "node_id": "C_kwDOAAsO6NoAKDNiZDk4MjEzNDJkNTcwODFhZWExOGNiYjUzMjcxYTIwNzY5ZWFmMDM", "commit": {"author": {"name": "Afonso Bordado", "email": "afonsobordado@az8.co", "date": "2022-08-06T12:34:55Z"}, "committer": {"name": "Afonso Bordado", "email": "afonsobordado@az8.co", "date": "2022-08-06T14:56:37Z"}, "message": "Initial ABI Checker support", "tree": {"sha": "70827a58bfa6570e86f558ce03affcc964b60656", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/70827a58bfa6570e86f558ce03affcc964b60656"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3bd9821342d57081aea18cbb53271a20769eaf03", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3bd9821342d57081aea18cbb53271a20769eaf03", "html_url": "https://github.com/rust-lang/rust/commit/3bd9821342d57081aea18cbb53271a20769eaf03", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3bd9821342d57081aea18cbb53271a20769eaf03/comments", "author": {"login": "afonso360", "id": 1357143, "node_id": "MDQ6VXNlcjEzNTcxNDM=", "avatar_url": "https://avatars.githubusercontent.com/u/1357143?v=4", "gravatar_id": "", "url": "https://api.github.com/users/afonso360", "html_url": "https://github.com/afonso360", "followers_url": "https://api.github.com/users/afonso360/followers", "following_url": "https://api.github.com/users/afonso360/following{/other_user}", "gists_url": "https://api.github.com/users/afonso360/gists{/gist_id}", "starred_url": "https://api.github.com/users/afonso360/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/afonso360/subscriptions", "organizations_url": "https://api.github.com/users/afonso360/orgs", "repos_url": "https://api.github.com/users/afonso360/repos", "events_url": "https://api.github.com/users/afonso360/events{/privacy}", "received_events_url": "https://api.github.com/users/afonso360/received_events", "type": "User", "site_admin": false}, "committer": {"login": "afonso360", "id": 1357143, "node_id": "MDQ6VXNlcjEzNTcxNDM=", "avatar_url": "https://avatars.githubusercontent.com/u/1357143?v=4", "gravatar_id": "", "url": "https://api.github.com/users/afonso360", "html_url": "https://github.com/afonso360", "followers_url": "https://api.github.com/users/afonso360/followers", "following_url": "https://api.github.com/users/afonso360/following{/other_user}", "gists_url": "https://api.github.com/users/afonso360/gists{/gist_id}", "starred_url": "https://api.github.com/users/afonso360/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/afonso360/subscriptions", "organizations_url": "https://api.github.com/users/afonso360/orgs", "repos_url": "https://api.github.com/users/afonso360/repos", "events_url": "https://api.github.com/users/afonso360/events{/privacy}", "received_events_url": "https://api.github.com/users/afonso360/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3c97227a433c244f34fb8bb23afe41f259431d9b", "url": "https://api.github.com/repos/rust-lang/rust/commits/3c97227a433c244f34fb8bb23afe41f259431d9b", "html_url": "https://github.com/rust-lang/rust/commit/3c97227a433c244f34fb8bb23afe41f259431d9b"}], "stats": {"total": 91, "additions": 91, "deletions": 0}, "files": [{"sha": "6fd3e4443de5c29a78797daa438342723ce3468b", "filename": ".gitignore", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/3bd9821342d57081aea18cbb53271a20769eaf03/.gitignore", "raw_url": "https://github.com/rust-lang/rust/raw/3bd9821342d57081aea18cbb53271a20769eaf03/.gitignore", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.gitignore?ref=3bd9821342d57081aea18cbb53271a20769eaf03", "patch": "@@ -19,3 +19,4 @@ perf.data.old\n /regex\n /simple-raytracer\n /portable-simd\n+/abi-checker"}, {"sha": "1aff4acc21b3d8bfc1cc02e214645c15d7e77e53", "filename": "build_system/abi_checker.rs", "status": "added", "additions": 67, "deletions": 0, "changes": 67, "blob_url": "https://github.com/rust-lang/rust/blob/3bd9821342d57081aea18cbb53271a20769eaf03/build_system%2Fabi_checker.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3bd9821342d57081aea18cbb53271a20769eaf03/build_system%2Fabi_checker.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/build_system%2Fabi_checker.rs?ref=3bd9821342d57081aea18cbb53271a20769eaf03", "patch": "@@ -0,0 +1,67 @@\n+use super::build_sysroot;\n+use super::utils::spawn_and_wait_with_input;\n+use build_system::SysrootKind;\n+use std::env;\n+use std::path::Path;\n+use std::process::Command;\n+\n+pub(crate) fn run(\n+    channel: &str,\n+    sysroot_kind: SysrootKind,\n+    target_dir: &Path,\n+    cg_clif_build_dir: &Path,\n+    host_triple: &str,\n+    target_triple: &str,\n+) {\n+    assert_eq!(\n+        host_triple, target_triple,\n+        \"abi-checker not supported on cross-compilation scenarios\"\n+    );\n+\n+    eprintln!(\"Building sysroot for abi-checker\");\n+    build_sysroot::build_sysroot(\n+        channel,\n+        sysroot_kind,\n+        target_dir,\n+        cg_clif_build_dir,\n+        host_triple,\n+        target_triple,\n+    );\n+\n+    eprintln!(\"Running abi-checker\");\n+    let mut abi_checker_path = env::current_dir().unwrap();\n+    abi_checker_path.push(\"abi-checker\");\n+    env::set_current_dir(abi_checker_path.clone()).unwrap();\n+\n+    let build_dir = abi_checker_path.parent().unwrap().join(\"build\");\n+    let cg_clif_dylib_path = build_dir.join(if cfg!(windows) { \"bin\" } else { \"lib\" }).join(\n+        env::consts::DLL_PREFIX.to_string() + \"rustc_codegen_cranelift\" + env::consts::DLL_SUFFIX,\n+    );\n+    println!(\"cg_clif_dylib_path: {}\", cg_clif_dylib_path.display());\n+\n+    let pairs = [\"rustc_calls_cgclif\", \"cgclif_calls_rustc\", \"cgclif_calls_cc\", \"cc_calls_cgclif\"];\n+\n+    for pair in pairs {\n+        eprintln!(\"[ABI-CHECKER] Running pair {pair}\");\n+\n+        let mut cmd = Command::new(\"cargo\");\n+        cmd.arg(\"run\");\n+        cmd.arg(\"--target\");\n+        cmd.arg(target_triple);\n+        cmd.arg(\"--\");\n+        cmd.arg(\"--pairs\");\n+        cmd.arg(pair);\n+        cmd.arg(\"--add-rustc-codegen-backend\");\n+        cmd.arg(format!(\"cgclif:{}\", cg_clif_dylib_path.display()));\n+\n+        let output = spawn_and_wait_with_input(cmd, \"\".to_string());\n+\n+        // TODO: The correct thing to do here is to check the exit code, but abi-checker\n+        // currently doesn't return 0 on success, so check for the test fail count.\n+        // See: https://github.com/Gankra/abi-checker/issues/10\n+        let failed = !(output.contains(\"0 failed\") && output.contains(\"0 completely failed\"));\n+        if failed {\n+            panic!(\"abi-checker for pair {} failed!\", pair);\n+        }\n+    }\n+}"}, {"sha": "c5b3e6619b770f105dfd344217a9931dd0691a38", "filename": "build_system/mod.rs", "status": "modified", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/3bd9821342d57081aea18cbb53271a20769eaf03/build_system%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3bd9821342d57081aea18cbb53271a20769eaf03/build_system%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/build_system%2Fmod.rs?ref=3bd9821342d57081aea18cbb53271a20769eaf03", "patch": "@@ -4,6 +4,7 @@ use std::process;\n \n use self::utils::is_ci;\n \n+mod abi_checker;\n mod build_backend;\n mod build_sysroot;\n mod config;\n@@ -21,6 +22,9 @@ fn usage() {\n     eprintln!(\n         \"  ./y.rs test [--debug] [--sysroot none|clif|llvm] [--target-dir DIR] [--no-unstable-features]\"\n     );\n+    eprintln!(\n+        \"  ./y.rs abi-checker [--debug] [--sysroot none|clif|llvm] [--target-dir DIR] [--no-unstable-features]\"\n+    );\n }\n \n macro_rules! arg_error {\n@@ -35,6 +39,7 @@ macro_rules! arg_error {\n enum Command {\n     Build,\n     Test,\n+    AbiChecker,\n }\n \n #[derive(Copy, Clone, Debug)]\n@@ -66,6 +71,7 @@ pub fn main() {\n         }\n         Some(\"build\") => Command::Build,\n         Some(\"test\") => Command::Test,\n+        Some(\"abi-checker\") => Command::AbiChecker,\n         Some(flag) if flag.starts_with('-') => arg_error!(\"Expected command found flag {}\", flag),\n         Some(command) => arg_error!(\"Unknown command {}\", command),\n         None => {\n@@ -152,5 +158,15 @@ pub fn main() {\n                 &target_triple,\n             );\n         }\n+        Command::AbiChecker => {\n+            abi_checker::run(\n+                channel,\n+                sysroot_kind,\n+                &target_dir,\n+                &cg_clif_build_dir,\n+                &host_triple,\n+                &target_triple,\n+            );\n+        }\n     }\n }"}, {"sha": "12aafdc1fb3ee5676a5cabbdbabf4b243d3048bd", "filename": "build_system/prepare.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/3bd9821342d57081aea18cbb53271a20769eaf03/build_system%2Fprepare.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3bd9821342d57081aea18cbb53271a20769eaf03/build_system%2Fprepare.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/build_system%2Fprepare.rs?ref=3bd9821342d57081aea18cbb53271a20769eaf03", "patch": "@@ -14,6 +14,13 @@ pub(crate) fn prepare() {\n     eprintln!(\"[INSTALL] hyperfine\");\n     Command::new(\"cargo\").arg(\"install\").arg(\"hyperfine\").spawn().unwrap().wait().unwrap();\n \n+    clone_repo_shallow_github(\n+        \"abi-checker\",\n+        \"Gankra\",\n+        \"abi-checker\",\n+        \"7c1571da6e43f9a37347623e7d5c7d51be664a7b\",\n+    );\n+\n     clone_repo_shallow_github(\n         \"rand\",\n         \"rust-random\","}]}