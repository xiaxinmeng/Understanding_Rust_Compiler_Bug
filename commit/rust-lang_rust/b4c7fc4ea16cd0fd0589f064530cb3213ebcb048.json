{"sha": "b4c7fc4ea16cd0fd0589f064530cb3213ebcb048", "node_id": "C_kwDOAAsO6NoAKGI0YzdmYzRlYTE2Y2QwZmQwNTg5ZjA2NDUzMGNiMzIxM2ViY2IwNDg", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-03-13T20:55:36Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-03-13T20:55:36Z"}, "message": "Rollup merge of #108607 - psumbera:solaris-no-flock-bootstrap, r=albertlarsan68\n\nDon't use fd-lock on Solaris in bootstrap\n\n...as Solaris is missing flock()\n\nfixes #103630", "tree": {"sha": "3411c7488bf4dd810cbdc3ee26a01bf878079b85", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3411c7488bf4dd810cbdc3ee26a01bf878079b85"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b4c7fc4ea16cd0fd0589f064530cb3213ebcb048", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkD43ICRBK7hj4Ov3rIwAAsGQIADxq0Cg+kd14zCK75Ro8wY1J\n4Wmp2X0vTNI1dZC2+XfbyKsTnCQITvphvaVlnAtPfknJrDpnqhOpT39yim3qEDva\nYbLJOUPHMWI0EK4tuhS4MfsMcFcIhPbwIONiB7EJwjJJXrYT+Dz0eZhqqbK1ZsYW\nGK8IpHGJW/z8nz7nIaHO6JWGTfhAkmv0vER5akzUCwUgT56kGee6BDJinHdAG1tt\nMZykvn3l4NiIYdCba5eISkMly39cjdTnLHj5ZlTQQwhAO32Khz2Ks42S/zb8JVV2\niUGQBTLCh7qZIqSTkUqXTg5vTLDKc6r1hFi3qmx5BwaBldBHwDCz65BPUhXOP9w=\n=WHbC\n-----END PGP SIGNATURE-----\n", "payload": "tree 3411c7488bf4dd810cbdc3ee26a01bf878079b85\nparent 96f4497f464b8aafa672b7954f908c262f6f39f1\nparent 04dfedb3e9d11710594aca52f874892cbbbd50ad\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1678740936 +0100\ncommitter GitHub <noreply@github.com> 1678740936 +0100\n\nRollup merge of #108607 - psumbera:solaris-no-flock-bootstrap, r=albertlarsan68\n\nDon't use fd-lock on Solaris in bootstrap\n\n...as Solaris is missing flock()\n\nfixes #103630\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b4c7fc4ea16cd0fd0589f064530cb3213ebcb048", "html_url": "https://github.com/rust-lang/rust/commit/b4c7fc4ea16cd0fd0589f064530cb3213ebcb048", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b4c7fc4ea16cd0fd0589f064530cb3213ebcb048/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "96f4497f464b8aafa672b7954f908c262f6f39f1", "url": "https://api.github.com/repos/rust-lang/rust/commits/96f4497f464b8aafa672b7954f908c262f6f39f1", "html_url": "https://github.com/rust-lang/rust/commit/96f4497f464b8aafa672b7954f908c262f6f39f1"}, {"sha": "04dfedb3e9d11710594aca52f874892cbbbd50ad", "url": "https://api.github.com/repos/rust-lang/rust/commits/04dfedb3e9d11710594aca52f874892cbbbd50ad", "html_url": "https://github.com/rust-lang/rust/commit/04dfedb3e9d11710594aca52f874892cbbbd50ad"}], "stats": {"total": 23, "additions": 15, "deletions": 8}, "files": [{"sha": "54d0d8a8ec25ec6d97b31ba82b184df89bf12af5", "filename": "src/bootstrap/CHANGELOG.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/b4c7fc4ea16cd0fd0589f064530cb3213ebcb048/src%2Fbootstrap%2FCHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/b4c7fc4ea16cd0fd0589f064530cb3213ebcb048/src%2Fbootstrap%2FCHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2FCHANGELOG.md?ref=b4c7fc4ea16cd0fd0589f064530cb3213ebcb048", "patch": "@@ -47,6 +47,7 @@ The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/).\n - Add `--keep-stage-std`, which behaves like `keep-stage` but allows the stage\n   0 compiler artifacts (i.e., stage1/bin/rustc) to be rebuilt if changed\n   [#77120](https://github.com/rust-lang/rust/pull/77120).\n+- File locking is now used to avoid collisions between multiple running instances of `x.py` (e.g. when using `rust-analyzer` and `x.py` at the same time). Note that Solaris and possibly other non Unix and non Windows systems don't support it [#108607](https://github.com/rust-lang/rust/pull/108607). This might possibly lead to build data corruption.\n \n \n ## [Version 1] - 2020-09-11"}, {"sha": "afe3fc1741b30e91d7b36a3f82b80aa157e53fef", "filename": "src/bootstrap/Cargo.toml", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/b4c7fc4ea16cd0fd0589f064530cb3213ebcb048/src%2Fbootstrap%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/b4c7fc4ea16cd0fd0589f064530cb3213ebcb048/src%2Fbootstrap%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2FCargo.toml?ref=b4c7fc4ea16cd0fd0589f064530cb3213ebcb048", "patch": "@@ -32,7 +32,6 @@ test = false\n [dependencies]\n build_helper = { path = \"../tools/build_helper\" }\n cmake = \"0.1.38\"\n-fd-lock = \"3.0.8\"\n filetime = \"0.2\"\n getopts = \"0.2.19\"\n cc = \"1.0.69\"\n@@ -56,6 +55,10 @@ walkdir = \"2\"\n # Dependencies needed by the build-metrics feature\n sysinfo = { version = \"0.26.0\", optional = true }\n \n+# Solaris doesn't support flock() and thus fd-lock is not option now\n+[target.'cfg(not(target_os = \"solaris\"))'.dependencies]\n+fd-lock = \"3.0.8\"\n+\n [target.'cfg(windows)'.dependencies.winapi]\n version = \"0.3\"\n features = ["}, {"sha": "912d875e445ea2e3bd1e90a44f67dac8f8760b3d", "filename": "src/bootstrap/bin/main.rs", "status": "modified", "additions": 10, "deletions": 7, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/b4c7fc4ea16cd0fd0589f064530cb3213ebcb048/src%2Fbootstrap%2Fbin%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b4c7fc4ea16cd0fd0589f064530cb3213ebcb048/src%2Fbootstrap%2Fbin%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbin%2Fmain.rs?ref=b4c7fc4ea16cd0fd0589f064530cb3213ebcb048", "patch": "@@ -7,15 +7,18 @@\n \n use std::env;\n \n-use bootstrap::{t, Build, Config, Subcommand, VERSION};\n+#[cfg(all(any(unix, windows), not(target_os = \"solaris\")))]\n+use bootstrap::t;\n+use bootstrap::{Build, Config, Subcommand, VERSION};\n \n fn main() {\n     let args = env::args().skip(1).collect::<Vec<_>>();\n     let config = Config::parse(&args);\n \n-    let mut build_lock;\n-    let _build_lock_guard;\n-    if cfg!(any(unix, windows)) {\n+    #[cfg(all(any(unix, windows), not(target_os = \"solaris\")))]\n+    {\n+        let mut build_lock;\n+        let _build_lock_guard;\n         let path = config.out.join(\"lock\");\n         build_lock = fd_lock::RwLock::new(t!(std::fs::File::create(&path)));\n         _build_lock_guard = match build_lock.try_write() {\n@@ -30,9 +33,9 @@ fn main() {\n                 t!(build_lock.write())\n             }\n         };\n-    } else {\n-        println!(\"warning: file locking not supported for target, not locking build directory\");\n     }\n+    #[cfg(any(not(any(unix, windows)), target_os = \"solaris\"))]\n+    println!(\"warning: file locking not supported for target, not locking build directory\");\n \n     // check_version warnings are not printed during setup\n     let changelog_suggestion =\n@@ -125,7 +128,7 @@ fn get_lock_owner(f: &std::path::Path) -> Option<u64> {\n     })\n }\n \n-#[cfg(not(target_os = \"linux\"))]\n+#[cfg(not(any(target_os = \"linux\", target_os = \"solaris\")))]\n fn get_lock_owner(_: &std::path::Path) -> Option<u64> {\n     // FIXME: Implement on other OS's\n     None"}]}