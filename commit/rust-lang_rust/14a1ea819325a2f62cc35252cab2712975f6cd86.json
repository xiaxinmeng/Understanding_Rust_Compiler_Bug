{"sha": "14a1ea819325a2f62cc35252cab2712975f6cd86", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE0YTFlYTgxOTMyNWEyZjYyY2MzNTI1MmNhYjI3MTI5NzVmNmNkODY=", "commit": {"author": {"name": "Nick Cameron", "email": "nrc@ncameron.org", "date": "2017-06-04T23:37:21Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2017-06-04T23:37:21Z"}, "message": "Merge pull request #1629 from topecongiro/issue-982\n\nUse recover_comment_removed in rewrite_static", "tree": {"sha": "d1e210351e47b1de4b5747cb8294c1e3b993458b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d1e210351e47b1de4b5747cb8294c1e3b993458b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/14a1ea819325a2f62cc35252cab2712975f6cd86", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/14a1ea819325a2f62cc35252cab2712975f6cd86", "html_url": "https://github.com/rust-lang/rust/commit/14a1ea819325a2f62cc35252cab2712975f6cd86", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/14a1ea819325a2f62cc35252cab2712975f6cd86/comments", "author": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3e25e628a152bb78cd42b0b81852a63d6e0ab204", "url": "https://api.github.com/repos/rust-lang/rust/commits/3e25e628a152bb78cd42b0b81852a63d6e0ab204", "html_url": "https://github.com/rust-lang/rust/commit/3e25e628a152bb78cd42b0b81852a63d6e0ab204"}, {"sha": "d54634bd7cde07b276e431fc167119e13a8aef81", "url": "https://api.github.com/repos/rust-lang/rust/commits/d54634bd7cde07b276e431fc167119e13a8aef81", "html_url": "https://github.com/rust-lang/rust/commit/d54634bd7cde07b276e431fc167119e13a8aef81"}], "stats": {"total": 28, "additions": 26, "deletions": 2}, "files": [{"sha": "10359f53bdd69c7f82f6ecd509f37907fb1e6e9b", "filename": "src/items.rs", "status": "modified", "additions": 13, "deletions": 2, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/14a1ea819325a2f62cc35252cab2712975f6cd86/src%2Fitems.rs", "raw_url": "https://github.com/rust-lang/rust/raw/14a1ea819325a2f62cc35252cab2712975f6cd86/src%2Fitems.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fitems.rs?ref=14a1ea819325a2f62cc35252cab2712975f6cd86", "patch": "@@ -18,7 +18,7 @@ use utils::{format_mutability, format_visibility, contains_skip, end_typaram, wr\n use lists::{write_list, itemize_list, ListItem, ListFormatting, SeparatorTactic, list_helper,\n             DefinitiveListTactic, ListTactic, definitive_tactic, format_item_list};\n use expr::{is_empty_block, is_simple_block_stmt, rewrite_assign_rhs, type_annotation_separator};\n-use comment::{FindUncommented, contains_comment, rewrite_comment};\n+use comment::{FindUncommented, contains_comment, rewrite_comment, recover_comment_removed};\n use visitor::FmtVisitor;\n use rewrite::{Rewrite, RewriteContext};\n use config::{Config, IndentStyle, Density, ReturnIndent, BraceStyle, Style, TypeDensity};\n@@ -1299,6 +1299,7 @@ pub fn rewrite_static(prefix: &str,\n                       mutability: ast::Mutability,\n                       expr_opt: Option<&ptr::P<ast::Expr>>,\n                       offset: Indent,\n+                      span: Span,\n                       context: &RewriteContext)\n                       -> Option<String> {\n     let type_annotation_spacing = type_annotation_spacing(context.config);\n@@ -1325,7 +1326,17 @@ pub fn rewrite_static(prefix: &str,\n                            lhs,\n                            expr,\n                            Shape::legacy(remaining_width, offset.block_only()))\n-            .map(|s| s + \";\")\n+            .and_then(|res| {\n+                recover_comment_removed(res,\n+                                        span,\n+                                        context,\n+                                        Shape {\n+                                            width: context.config.max_width(),\n+                                            indent: offset,\n+                                            offset: offset.alignment,\n+                                        })\n+            })\n+            .map(|s| if s.ends_with(';') { s } else { s + \";\" })\n     } else {\n         let lhs = format!(\"{}{};\", prefix, ty_str);\n         Some(lhs)"}, {"sha": "a75b60a7bd782d6211b13b25190395b7354193a0", "filename": "src/visitor.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/14a1ea819325a2f62cc35252cab2712975f6cd86/src%2Fvisitor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/14a1ea819325a2f62cc35252cab2712975f6cd86/src%2Fvisitor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fvisitor.rs?ref=14a1ea819325a2f62cc35252cab2712975f6cd86", "patch": "@@ -338,6 +338,7 @@ impl<'a> FmtVisitor<'a> {\n                                              mutability,\n                                              Some(expr),\n                                              self.block_indent,\n+                                             item.span,\n                                              &self.get_context());\n                 self.push_rewrite(item.span, rewrite);\n             }\n@@ -349,6 +350,7 @@ impl<'a> FmtVisitor<'a> {\n                                              ast::Mutability::Immutable,\n                                              Some(expr),\n                                              self.block_indent,\n+                                             item.span,\n                                              &self.get_context());\n                 self.push_rewrite(item.span, rewrite);\n             }\n@@ -399,6 +401,7 @@ impl<'a> FmtVisitor<'a> {\n                                              ast::Mutability::Immutable,\n                                              expr_opt.as_ref(),\n                                              self.block_indent,\n+                                             ti.span,\n                                              &self.get_context());\n                 self.push_rewrite(ti.span, rewrite);\n             }\n@@ -450,6 +453,7 @@ impl<'a> FmtVisitor<'a> {\n                                              ast::Mutability::Immutable,\n                                              Some(expr),\n                                              self.block_indent,\n+                                             ii.span,\n                                              &self.get_context());\n                 self.push_rewrite(ii.span, rewrite);\n             }"}, {"sha": "f847f2c69def4f9f40d1d48d8b3b4b70ed1e6cd7", "filename": "tests/target/comment-inside-const.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/14a1ea819325a2f62cc35252cab2712975f6cd86/tests%2Ftarget%2Fcomment-inside-const.rs", "raw_url": "https://github.com/rust-lang/rust/raw/14a1ea819325a2f62cc35252cab2712975f6cd86/tests%2Ftarget%2Fcomment-inside-const.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fcomment-inside-const.rs?ref=14a1ea819325a2f62cc35252cab2712975f6cd86", "patch": "@@ -0,0 +1,9 @@\n+fn issue982() {\n+    const SOME_CONSTANT: u32 =\n+        // Explanation why SOME_CONSTANT needs FLAG_A to be set.\n+        FLAG_A |\n+        // Explanation why SOME_CONSTANT needs FLAG_B to be set.\n+        FLAG_B |\n+        // Explanation why SOME_CONSTANT needs FLAG_C to be set.\n+        FLAG_C;\n+}"}]}