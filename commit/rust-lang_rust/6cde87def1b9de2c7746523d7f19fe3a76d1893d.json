{"sha": "6cde87def1b9de2c7746523d7f19fe3a76d1893d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZjZGU4N2RlZjFiOWRlMmM3NzQ2NTIzZDdmMTlmZTNhNzZkMTg5M2Q=", "commit": {"author": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2020-05-01T09:32:20Z"}, "committer": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2020-05-01T15:45:30Z"}, "message": "Mark query function as must_use.", "tree": {"sha": "901c68daa5f8692653751c1e59fec6743bf85a27", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/901c68daa5f8692653751c1e59fec6743bf85a27"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6cde87def1b9de2c7746523d7f19fe3a76d1893d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6cde87def1b9de2c7746523d7f19fe3a76d1893d", "html_url": "https://github.com/rust-lang/rust/commit/6cde87def1b9de2c7746523d7f19fe3a76d1893d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6cde87def1b9de2c7746523d7f19fe3a76d1893d/comments", "author": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bd0bacc694d7d8175804bb6f690cb846bfa4a9ee", "url": "https://api.github.com/repos/rust-lang/rust/commits/bd0bacc694d7d8175804bb6f690cb846bfa4a9ee", "html_url": "https://github.com/rust-lang/rust/commit/bd0bacc694d7d8175804bb6f690cb846bfa4a9ee"}], "stats": {"total": 113, "additions": 57, "deletions": 56}, "files": [{"sha": "c5b95905ea01246616986b52582e442668ba1622", "filename": "src/librustc_codegen_ssa/base.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/6cde87def1b9de2c7746523d7f19fe3a76d1893d/src%2Flibrustc_codegen_ssa%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6cde87def1b9de2c7746523d7f19fe3a76d1893d/src%2Flibrustc_codegen_ssa%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fbase.rs?ref=6cde87def1b9de2c7746523d7f19fe3a76d1893d", "patch": "@@ -539,7 +539,7 @@ pub fn codegen_crate<B: ExtraBackendMethods>(\n     // unnecessarily.\n     if tcx.dep_graph.is_fully_enabled() {\n         for cgu in codegen_units {\n-            tcx.codegen_unit(cgu.name());\n+            tcx.ensure().codegen_unit(cgu.name());\n         }\n     }\n "}, {"sha": "952d3a01e3057c27a8d077ff6efde382e8ffa3f9", "filename": "src/librustc_metadata/rmeta/encoder.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/6cde87def1b9de2c7746523d7f19fe3a76d1893d/src%2Flibrustc_metadata%2Frmeta%2Fencoder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6cde87def1b9de2c7746523d7f19fe3a76d1893d/src%2Flibrustc_metadata%2Frmeta%2Fencoder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Frmeta%2Fencoder.rs?ref=6cde87def1b9de2c7746523d7f19fe3a76d1893d", "patch": "@@ -1729,8 +1729,8 @@ struct PrefetchVisitor<'tcx> {\n impl<'tcx> PrefetchVisitor<'tcx> {\n     fn prefetch_mir(&self, def_id: LocalDefId) {\n         if self.mir_keys.contains(&def_id) {\n-            self.tcx.optimized_mir(def_id);\n-            self.tcx.promoted_mir(def_id);\n+            self.tcx.ensure().optimized_mir(def_id);\n+            self.tcx.ensure().promoted_mir(def_id);\n         }\n     }\n }"}, {"sha": "6a671c042aed36c9fa4edb09c306cc94a340353f", "filename": "src/librustc_middle/ty/query/plumbing.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/6cde87def1b9de2c7746523d7f19fe3a76d1893d/src%2Flibrustc_middle%2Fty%2Fquery%2Fplumbing.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6cde87def1b9de2c7746523d7f19fe3a76d1893d/src%2Flibrustc_middle%2Fty%2Fquery%2Fplumbing.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_middle%2Fty%2Fquery%2Fplumbing.rs?ref=6cde87def1b9de2c7746523d7f19fe3a76d1893d", "patch": "@@ -430,6 +430,7 @@ macro_rules! define_queries_inner {\n \n             $($(#[$attr])*\n             #[inline(always)]\n+            #[must_use]\n             pub fn $name(self, key: query_helper_param_ty!($($K)*))\n                 -> <queries::$name<$tcx> as QueryConfig<TyCtxt<$tcx>>>::Stored\n             {"}, {"sha": "af47721b311ffcf1a13567b48c53085a0437cd06", "filename": "src/librustc_mir/transform/check_unsafety.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/6cde87def1b9de2c7746523d7f19fe3a76d1893d/src%2Flibrustc_mir%2Ftransform%2Fcheck_unsafety.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6cde87def1b9de2c7746523d7f19fe3a76d1893d/src%2Flibrustc_mir%2Ftransform%2Fcheck_unsafety.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fcheck_unsafety.rs?ref=6cde87def1b9de2c7746523d7f19fe3a76d1893d", "patch": "@@ -617,7 +617,7 @@ pub fn check_unsafety(tcx: TyCtxt<'_>, def_id: DefId) {\n             }\n             UnsafetyViolationKind::BorrowPacked(lint_hir_id) => {\n                 if let Some(impl_def_id) = builtin_derive_def_id(tcx, def_id) {\n-                    tcx.unsafe_derive_on_repr_packed(impl_def_id);\n+                    tcx.ensure().unsafe_derive_on_repr_packed(impl_def_id);\n                 } else {\n                     tcx.struct_span_lint_hir(\n                         SAFE_PACKED_BORROWS,"}, {"sha": "b54731d8881d190cf2d39d0ec596e6231948223e", "filename": "src/librustc_passes/check_attr.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/6cde87def1b9de2c7746523d7f19fe3a76d1893d/src%2Flibrustc_passes%2Fcheck_attr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6cde87def1b9de2c7746523d7f19fe3a76d1893d/src%2Flibrustc_passes%2Fcheck_attr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_passes%2Fcheck_attr.rs?ref=6cde87def1b9de2c7746523d7f19fe3a76d1893d", "patch": "@@ -77,7 +77,7 @@ impl CheckAttrVisitor<'tcx> {\n         }\n \n         if matches!(target, Target::Fn | Target::Method(_) | Target::ForeignFn) {\n-            self.tcx.codegen_fn_attrs(self.tcx.hir().local_def_id(hir_id));\n+            self.tcx.ensure().codegen_fn_attrs(self.tcx.hir().local_def_id(hir_id));\n         }\n \n         self.check_repr(attrs, span, target, item, hir_id);\n@@ -390,7 +390,7 @@ impl CheckAttrVisitor<'tcx> {\n             }\n         }\n         if target == Target::Closure {\n-            self.tcx.codegen_fn_attrs(self.tcx.hir().local_def_id(expr.hir_id));\n+            self.tcx.ensure().codegen_fn_attrs(self.tcx.hir().local_def_id(expr.hir_id));\n         }\n     }\n "}, {"sha": "c431745198822e260226322ae40002c9c92ee5da", "filename": "src/librustc_typeck/check/mod.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/6cde87def1b9de2c7746523d7f19fe3a76d1893d/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6cde87def1b9de2c7746523d7f19fe3a76d1893d/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs?ref=6cde87def1b9de2c7746523d7f19fe3a76d1893d", "patch": "@@ -1748,11 +1748,11 @@ pub fn check_item_type<'tcx>(tcx: TyCtxt<'tcx>, it: &'tcx hir::Item<'tcx>) {\n         // Consts can play a role in type-checking, so they are included here.\n         hir::ItemKind::Static(..) => {\n             let def_id = tcx.hir().local_def_id(it.hir_id);\n-            tcx.typeck_tables_of(def_id);\n+            tcx.ensure().typeck_tables_of(def_id);\n             maybe_check_static_with_link_section(tcx, def_id, it.span);\n         }\n         hir::ItemKind::Const(..) => {\n-            tcx.typeck_tables_of(tcx.hir().local_def_id(it.hir_id));\n+            tcx.ensure().typeck_tables_of(tcx.hir().local_def_id(it.hir_id));\n         }\n         hir::ItemKind::Enum(ref enum_definition, _) => {\n             check_enum(tcx, it.span, &enum_definition.variants, it.hir_id);\n@@ -2670,7 +2670,7 @@ pub fn check_enum<'tcx>(\n \n     for v in vs {\n         if let Some(ref e) = v.disr_expr {\n-            tcx.typeck_tables_of(tcx.hir().local_def_id(e.hir_id));\n+            tcx.ensure().typeck_tables_of(tcx.hir().local_def_id(e.hir_id));\n         }\n     }\n "}, {"sha": "05d5a81217ce12d9fd8f33351c7f5196cd9eb751", "filename": "src/librustc_typeck/coherence/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/6cde87def1b9de2c7746523d7f19fe3a76d1893d/src%2Flibrustc_typeck%2Fcoherence%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6cde87def1b9de2c7746523d7f19fe3a76d1893d/src%2Flibrustc_typeck%2Fcoherence%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcoherence%2Fmod.rs?ref=6cde87def1b9de2c7746523d7f19fe3a76d1893d", "patch": "@@ -156,7 +156,7 @@ pub fn provide(providers: &mut Providers<'_>) {\n fn coherent_trait(tcx: TyCtxt<'_>, def_id: DefId) {\n     // Trigger building the specialization graph for the trait. This will detect and report any\n     // overlap errors.\n-    tcx.specialization_graph_of(def_id);\n+    tcx.ensure().specialization_graph_of(def_id);\n \n     let impls = tcx.hir().trait_impls(def_id);\n     for &hir_id in impls {"}, {"sha": "df77024210193941f1c589112fbfcbae561d8d6d", "filename": "src/librustc_typeck/collect.rs", "status": "modified", "additions": 46, "deletions": 46, "changes": 92, "blob_url": "https://github.com/rust-lang/rust/blob/6cde87def1b9de2c7746523d7f19fe3a76d1893d/src%2Flibrustc_typeck%2Fcollect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6cde87def1b9de2c7746523d7f19fe3a76d1893d/src%2Flibrustc_typeck%2Fcollect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcollect.rs?ref=6cde87def1b9de2c7746523d7f19fe3a76d1893d", "patch": "@@ -207,12 +207,12 @@ impl Visitor<'tcx> for CollectItemTypesVisitor<'tcx> {\n                 hir::GenericParamKind::Lifetime { .. } => {}\n                 hir::GenericParamKind::Type { default: Some(_), .. } => {\n                     let def_id = self.tcx.hir().local_def_id(param.hir_id);\n-                    self.tcx.type_of(def_id);\n+                    self.tcx.ensure().type_of(def_id);\n                 }\n                 hir::GenericParamKind::Type { .. } => {}\n                 hir::GenericParamKind::Const { .. } => {\n                     let def_id = self.tcx.hir().local_def_id(param.hir_id);\n-                    self.tcx.type_of(def_id);\n+                    self.tcx.ensure().type_of(def_id);\n                 }\n             }\n         }\n@@ -222,8 +222,8 @@ impl Visitor<'tcx> for CollectItemTypesVisitor<'tcx> {\n     fn visit_expr(&mut self, expr: &'tcx hir::Expr<'tcx>) {\n         if let hir::ExprKind::Closure(..) = expr.kind {\n             let def_id = self.tcx.hir().local_def_id(expr.hir_id);\n-            self.tcx.generics_of(def_id);\n-            self.tcx.type_of(def_id);\n+            self.tcx.ensure().generics_of(def_id);\n+            self.tcx.ensure().type_of(def_id);\n         }\n         intravisit::walk_expr(self, expr);\n     }\n@@ -635,47 +635,47 @@ fn convert_item(tcx: TyCtxt<'_>, item_id: hir::HirId) {\n         hir::ItemKind::ForeignMod(ref foreign_mod) => {\n             for item in foreign_mod.items {\n                 let def_id = tcx.hir().local_def_id(item.hir_id);\n-                tcx.generics_of(def_id);\n-                tcx.type_of(def_id);\n-                tcx.predicates_of(def_id);\n+                tcx.ensure().generics_of(def_id);\n+                tcx.ensure().type_of(def_id);\n+                tcx.ensure().predicates_of(def_id);\n                 if let hir::ForeignItemKind::Fn(..) = item.kind {\n-                    tcx.fn_sig(def_id);\n+                    tcx.ensure().fn_sig(def_id);\n                 }\n             }\n         }\n         hir::ItemKind::Enum(ref enum_definition, _) => {\n-            tcx.generics_of(def_id);\n-            tcx.type_of(def_id);\n-            tcx.predicates_of(def_id);\n+            tcx.ensure().generics_of(def_id);\n+            tcx.ensure().type_of(def_id);\n+            tcx.ensure().predicates_of(def_id);\n             convert_enum_variant_types(tcx, def_id.to_def_id(), &enum_definition.variants);\n         }\n         hir::ItemKind::Impl { .. } => {\n-            tcx.generics_of(def_id);\n-            tcx.type_of(def_id);\n-            tcx.impl_trait_ref(def_id);\n-            tcx.predicates_of(def_id);\n+            tcx.ensure().generics_of(def_id);\n+            tcx.ensure().type_of(def_id);\n+            tcx.ensure().impl_trait_ref(def_id);\n+            tcx.ensure().predicates_of(def_id);\n         }\n         hir::ItemKind::Trait(..) => {\n-            tcx.generics_of(def_id);\n-            tcx.trait_def(def_id);\n+            tcx.ensure().generics_of(def_id);\n+            tcx.ensure().trait_def(def_id);\n             tcx.at(it.span).super_predicates_of(def_id);\n-            tcx.predicates_of(def_id);\n+            tcx.ensure().predicates_of(def_id);\n         }\n         hir::ItemKind::TraitAlias(..) => {\n-            tcx.generics_of(def_id);\n+            tcx.ensure().generics_of(def_id);\n             tcx.at(it.span).super_predicates_of(def_id);\n-            tcx.predicates_of(def_id);\n+            tcx.ensure().predicates_of(def_id);\n         }\n         hir::ItemKind::Struct(ref struct_def, _) | hir::ItemKind::Union(ref struct_def, _) => {\n-            tcx.generics_of(def_id);\n-            tcx.type_of(def_id);\n-            tcx.predicates_of(def_id);\n+            tcx.ensure().generics_of(def_id);\n+            tcx.ensure().type_of(def_id);\n+            tcx.ensure().predicates_of(def_id);\n \n             for f in struct_def.fields() {\n                 let def_id = tcx.hir().local_def_id(f.hir_id);\n-                tcx.generics_of(def_id);\n-                tcx.type_of(def_id);\n-                tcx.predicates_of(def_id);\n+                tcx.ensure().generics_of(def_id);\n+                tcx.ensure().type_of(def_id);\n+                tcx.ensure().predicates_of(def_id);\n             }\n \n             if let Some(ctor_hir_id) = struct_def.ctor_hir_id() {\n@@ -691,11 +691,11 @@ fn convert_item(tcx: TyCtxt<'_>, item_id: hir::HirId) {\n         | hir::ItemKind::Static(..)\n         | hir::ItemKind::Const(..)\n         | hir::ItemKind::Fn(..) => {\n-            tcx.generics_of(def_id);\n-            tcx.type_of(def_id);\n-            tcx.predicates_of(def_id);\n+            tcx.ensure().generics_of(def_id);\n+            tcx.ensure().type_of(def_id);\n+            tcx.ensure().predicates_of(def_id);\n             if let hir::ItemKind::Fn(..) = it.kind {\n-                tcx.fn_sig(def_id);\n+                tcx.ensure().fn_sig(def_id);\n             }\n         }\n     }\n@@ -704,20 +704,20 @@ fn convert_item(tcx: TyCtxt<'_>, item_id: hir::HirId) {\n fn convert_trait_item(tcx: TyCtxt<'_>, trait_item_id: hir::HirId) {\n     let trait_item = tcx.hir().expect_trait_item(trait_item_id);\n     let def_id = tcx.hir().local_def_id(trait_item.hir_id);\n-    tcx.generics_of(def_id);\n+    tcx.ensure().generics_of(def_id);\n \n     match trait_item.kind {\n         hir::TraitItemKind::Fn(..) => {\n-            tcx.type_of(def_id);\n-            tcx.fn_sig(def_id);\n+            tcx.ensure().type_of(def_id);\n+            tcx.ensure().fn_sig(def_id);\n         }\n \n         hir::TraitItemKind::Const(.., Some(_)) => {\n-            tcx.type_of(def_id);\n+            tcx.ensure().type_of(def_id);\n         }\n \n         hir::TraitItemKind::Const(..) | hir::TraitItemKind::Type(_, Some(_)) => {\n-            tcx.type_of(def_id);\n+            tcx.ensure().type_of(def_id);\n             // Account for `const C: _;` and `type T = _;`.\n             let mut visitor = PlaceholderHirTyCollector::default();\n             visitor.visit_trait_item(trait_item);\n@@ -727,18 +727,18 @@ fn convert_trait_item(tcx: TyCtxt<'_>, trait_item_id: hir::HirId) {\n         hir::TraitItemKind::Type(_, None) => {}\n     };\n \n-    tcx.predicates_of(def_id);\n+    tcx.ensure().predicates_of(def_id);\n }\n \n fn convert_impl_item(tcx: TyCtxt<'_>, impl_item_id: hir::HirId) {\n     let def_id = tcx.hir().local_def_id(impl_item_id);\n-    tcx.generics_of(def_id);\n-    tcx.type_of(def_id);\n-    tcx.predicates_of(def_id);\n+    tcx.ensure().generics_of(def_id);\n+    tcx.ensure().type_of(def_id);\n+    tcx.ensure().predicates_of(def_id);\n     let impl_item = tcx.hir().expect_impl_item(impl_item_id);\n     match impl_item.kind {\n         hir::ImplItemKind::Fn(..) => {\n-            tcx.fn_sig(def_id);\n+            tcx.ensure().fn_sig(def_id);\n         }\n         hir::ImplItemKind::TyAlias(_) | hir::ImplItemKind::OpaqueTy(_) => {\n             // Account for `type T = _;`\n@@ -752,9 +752,9 @@ fn convert_impl_item(tcx: TyCtxt<'_>, impl_item_id: hir::HirId) {\n \n fn convert_variant_ctor(tcx: TyCtxt<'_>, ctor_id: hir::HirId) {\n     let def_id = tcx.hir().local_def_id(ctor_id);\n-    tcx.generics_of(def_id);\n-    tcx.type_of(def_id);\n-    tcx.predicates_of(def_id);\n+    tcx.ensure().generics_of(def_id);\n+    tcx.ensure().type_of(def_id);\n+    tcx.ensure().predicates_of(def_id);\n }\n \n fn convert_enum_variant_types(tcx: TyCtxt<'_>, def_id: DefId, variants: &[hir::Variant<'_>]) {\n@@ -790,9 +790,9 @@ fn convert_enum_variant_types(tcx: TyCtxt<'_>, def_id: DefId, variants: &[hir::V\n \n         for f in variant.data.fields() {\n             let def_id = tcx.hir().local_def_id(f.hir_id);\n-            tcx.generics_of(def_id);\n-            tcx.type_of(def_id);\n-            tcx.predicates_of(def_id);\n+            tcx.ensure().generics_of(def_id);\n+            tcx.ensure().type_of(def_id);\n+            tcx.ensure().predicates_of(def_id);\n         }\n \n         // Convert the ctor, if any. This also registers the variant as"}]}