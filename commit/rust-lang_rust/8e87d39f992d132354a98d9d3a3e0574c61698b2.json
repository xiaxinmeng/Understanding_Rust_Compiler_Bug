{"sha": "8e87d39f992d132354a98d9d3a3e0574c61698b2", "node_id": "C_kwDOAAsO6NoAKDhlODdkMzlmOTkyZDEzMjM1NGE5OGQ5ZDNhM2UwNTc0YzYxNjk4YjI", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-10-11T08:08:17Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-10-11T08:08:17Z"}, "message": "Auto merge of #9572 - Nilstrieb:as-ptr-cast-mut, r=dswij\n\nAdd `as_ptr_cast_mut` lint\n\nThis lint detects calls to a `&self`-taking `as_ptr` method, where the result is then immediately cast to a `*mut T`. Code like this is probably invalid, as that pointer will not have write permissions, and `*mut T` is usually used to write through.\n\nExamples of broken code with this pattern:\nhttps://miri.saethlin.dev/ub?crate=lol_alloc&version=0.1.3\nhttps://miri.saethlin.dev/ub?crate=sophon-wasm&version=0.19.0\nhttps://miri.saethlin.dev/ub?crate=polars-core&version=0.24.2\nhttps://miri.saethlin.dev/ub?crate=ach-cell&version=0.1.17\n\nchangelog: Add [`as_ptr_cast_mut`]", "tree": {"sha": "78bb38afa762cc3aefea1d0690ece2d2553e19d3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/78bb38afa762cc3aefea1d0690ece2d2553e19d3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8e87d39f992d132354a98d9d3a3e0574c61698b2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8e87d39f992d132354a98d9d3a3e0574c61698b2", "html_url": "https://github.com/rust-lang/rust/commit/8e87d39f992d132354a98d9d3a3e0574c61698b2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8e87d39f992d132354a98d9d3a3e0574c61698b2/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cf72565a12c982f577ca4394c3b80edb89f6c6d3", "url": "https://api.github.com/repos/rust-lang/rust/commits/cf72565a12c982f577ca4394c3b80edb89f6c6d3", "html_url": "https://github.com/rust-lang/rust/commit/cf72565a12c982f577ca4394c3b80edb89f6c6d3"}, {"sha": "2b944d0c38ebfb99252ccfcb6200db28a217ee07", "url": "https://api.github.com/repos/rust-lang/rust/commits/2b944d0c38ebfb99252ccfcb6200db28a217ee07", "html_url": "https://github.com/rust-lang/rust/commit/2b944d0c38ebfb99252ccfcb6200db28a217ee07"}], "stats": {"total": 145, "additions": 144, "deletions": 1}, "files": [{"sha": "8babfc8d63c499d8977ad157fd686d816dfa8893", "filename": "CHANGELOG.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/8e87d39f992d132354a98d9d3a3e0574c61698b2/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/8e87d39f992d132354a98d9d3a3e0574c61698b2/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=8e87d39f992d132354a98d9d3a3e0574c61698b2", "patch": "@@ -3735,6 +3735,7 @@ Released 2018-09-13\n [`approx_constant`]: https://rust-lang.github.io/rust-clippy/master/index.html#approx_constant\n [`arithmetic_side_effects`]: https://rust-lang.github.io/rust-clippy/master/index.html#arithmetic_side_effects\n [`as_conversions`]: https://rust-lang.github.io/rust-clippy/master/index.html#as_conversions\n+[`as_ptr_cast_mut`]: https://rust-lang.github.io/rust-clippy/master/index.html#as_ptr_cast_mut\n [`as_underscore`]: https://rust-lang.github.io/rust-clippy/master/index.html#as_underscore\n [`assertions_on_constants`]: https://rust-lang.github.io/rust-clippy/master/index.html#assertions_on_constants\n [`assertions_on_result_states`]: https://rust-lang.github.io/rust-clippy/master/index.html#assertions_on_result_states"}, {"sha": "9409f4844f54b4140217260c97d1f9f09e32f8e4", "filename": "clippy_lints/src/casts/as_ptr_cast_mut.rs", "status": "added", "additions": 38, "deletions": 0, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/8e87d39f992d132354a98d9d3a3e0574c61698b2/clippy_lints%2Fsrc%2Fcasts%2Fas_ptr_cast_mut.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8e87d39f992d132354a98d9d3a3e0574c61698b2/clippy_lints%2Fsrc%2Fcasts%2Fas_ptr_cast_mut.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fcasts%2Fas_ptr_cast_mut.rs?ref=8e87d39f992d132354a98d9d3a3e0574c61698b2", "patch": "@@ -0,0 +1,38 @@\n+use clippy_utils::diagnostics::span_lint_and_sugg;\n+use clippy_utils::source::snippet_opt;\n+use rustc_errors::Applicability;\n+use rustc_hir::{Expr, ExprKind};\n+use rustc_lint::LateContext;\n+use rustc_middle::{\n+    mir::Mutability,\n+    ty::{self, Ty, TypeAndMut},\n+};\n+\n+use super::AS_PTR_CAST_MUT;\n+\n+pub(super) fn check(cx: &LateContext<'_>, expr: &Expr<'_>, cast_expr: &Expr<'_>, cast_to: Ty<'_>) {\n+    if let ty::RawPtr(ptrty @ TypeAndMut { mutbl: Mutability::Mut, .. }) = cast_to.kind()\n+        && let ty::RawPtr(TypeAndMut { mutbl: Mutability::Not, .. }) =\n+            cx.typeck_results().node_type(cast_expr.hir_id).kind()\n+        && let ExprKind::MethodCall(method_name, receiver, [], _) = cast_expr.peel_blocks().kind\n+        && method_name.ident.name == rustc_span::sym::as_ptr\n+        && let Some(as_ptr_did) = cx.typeck_results().type_dependent_def_id(cast_expr.peel_blocks().hir_id)\n+        && let as_ptr_sig = cx.tcx.fn_sig(as_ptr_did)\n+        && let Some(first_param_ty) = as_ptr_sig.skip_binder().inputs().iter().next()\n+        && let ty::Ref(_, _, Mutability::Not) = first_param_ty.kind()\n+        && let Some(recv) = snippet_opt(cx, receiver.span)\n+    {\n+        // `as_mut_ptr` might not exist\n+        let applicability = Applicability::MaybeIncorrect;\n+\n+        span_lint_and_sugg(\n+            cx,\n+            AS_PTR_CAST_MUT,\n+            expr.span,\n+            &format!(\"casting the result of `as_ptr` to *{ptrty}\"),\n+            \"replace with\",\n+            format!(\"{recv}.as_mut_ptr()\"),\n+            applicability\n+        );\n+    }\n+}"}, {"sha": "b8f0dedf5ed910b3c6539658bdba153ed6110a53", "filename": "clippy_lints/src/casts/mod.rs", "status": "modified", "additions": 30, "deletions": 1, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/8e87d39f992d132354a98d9d3a3e0574c61698b2/clippy_lints%2Fsrc%2Fcasts%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8e87d39f992d132354a98d9d3a3e0574c61698b2/clippy_lints%2Fsrc%2Fcasts%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fcasts%2Fmod.rs?ref=8e87d39f992d132354a98d9d3a3e0574c61698b2", "patch": "@@ -1,3 +1,4 @@\n+mod as_ptr_cast_mut;\n mod as_underscore;\n mod borrow_as_ptr;\n mod cast_abs_to_unsigned;\n@@ -596,6 +597,32 @@ declare_clippy_lint! {\n     \"casting a slice created from a pointer and length to a slice pointer\"\n }\n \n+declare_clippy_lint! {\n+    /// ### What it does\n+    /// Checks for the result of a `&self`-taking `as_ptr` being cast to a mutable pointer\n+    ///\n+    /// ### Why is this bad?\n+    /// Since `as_ptr` takes a `&self`, the pointer won't have write permissions unless interior\n+    /// mutability is used, making it unlikely that having it as a mutable pointer is correct.\n+    ///\n+    /// ### Example\n+    /// ```rust\n+    /// let string = String::with_capacity(1);\n+    /// let ptr = string.as_ptr() as *mut u8;\n+    /// unsafe { ptr.write(4) }; // UNDEFINED BEHAVIOUR\n+    /// ```\n+    /// Use instead:\n+    /// ```rust\n+    /// let mut string = String::with_capacity(1);\n+    /// let ptr = string.as_mut_ptr();\n+    /// unsafe { ptr.write(4) };\n+    /// ```\n+    #[clippy::version = \"1.66.0\"]\n+    pub AS_PTR_CAST_MUT,\n+    nursery,\n+    \"casting the result of the `&self`-taking `as_ptr` to a mutabe pointer\"\n+}\n+\n pub struct Casts {\n     msrv: Option<RustcVersion>,\n }\n@@ -627,7 +654,8 @@ impl_lint_pass!(Casts => [\n     CAST_ABS_TO_UNSIGNED,\n     AS_UNDERSCORE,\n     BORROW_AS_PTR,\n-    CAST_SLICE_FROM_RAW_PARTS\n+    CAST_SLICE_FROM_RAW_PARTS,\n+    AS_PTR_CAST_MUT,\n ]);\n \n impl<'tcx> LateLintPass<'tcx> for Casts {\n@@ -653,6 +681,7 @@ impl<'tcx> LateLintPass<'tcx> for Casts {\n                 return;\n             }\n             cast_slice_from_raw_parts::check(cx, expr, cast_expr, cast_to, self.msrv);\n+            as_ptr_cast_mut::check(cx, expr, cast_expr, cast_to);\n             fn_to_numeric_cast_any::check(cx, expr, cast_expr, cast_from, cast_to);\n             fn_to_numeric_cast::check(cx, expr, cast_expr, cast_from, cast_to);\n             fn_to_numeric_cast_with_truncation::check(cx, expr, cast_expr, cast_from, cast_to);"}, {"sha": "546685c8175f977f76addb1e6e75442d0a5a4b1b", "filename": "clippy_lints/src/lib.register_lints.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/8e87d39f992d132354a98d9d3a3e0574c61698b2/clippy_lints%2Fsrc%2Flib.register_lints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8e87d39f992d132354a98d9d3a3e0574c61698b2/clippy_lints%2Fsrc%2Flib.register_lints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.register_lints.rs?ref=8e87d39f992d132354a98d9d3a3e0574c61698b2", "patch": "@@ -66,6 +66,7 @@ store.register_lints(&[\n     cargo::NEGATIVE_FEATURE_NAMES,\n     cargo::REDUNDANT_FEATURE_NAMES,\n     cargo::WILDCARD_DEPENDENCIES,\n+    casts::AS_PTR_CAST_MUT,\n     casts::AS_UNDERSCORE,\n     casts::BORROW_AS_PTR,\n     casts::CAST_ABS_TO_UNSIGNED,"}, {"sha": "a75bc81b2222c0d9685f4c9eff42b8f51ed077a8", "filename": "clippy_lints/src/lib.register_nursery.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/8e87d39f992d132354a98d9d3a3e0574c61698b2/clippy_lints%2Fsrc%2Flib.register_nursery.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8e87d39f992d132354a98d9d3a3e0574c61698b2/clippy_lints%2Fsrc%2Flib.register_nursery.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.register_nursery.rs?ref=8e87d39f992d132354a98d9d3a3e0574c61698b2", "patch": "@@ -4,6 +4,7 @@\n \n store.register_group(true, \"clippy::nursery\", Some(\"clippy_nursery\"), vec![\n     LintId::of(attrs::EMPTY_LINE_AFTER_OUTER_ATTR),\n+    LintId::of(casts::AS_PTR_CAST_MUT),\n     LintId::of(cognitive_complexity::COGNITIVE_COMPLEXITY),\n     LintId::of(copies::BRANCHES_SHARING_CODE),\n     LintId::of(derive::DERIVE_PARTIAL_EQ_WITHOUT_EQ),"}, {"sha": "971d57ccb6fb672c409e48ac30570f007fd73ad1", "filename": "src/docs.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/8e87d39f992d132354a98d9d3a3e0574c61698b2/src%2Fdocs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8e87d39f992d132354a98d9d3a3e0574c61698b2/src%2Fdocs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdocs.rs?ref=8e87d39f992d132354a98d9d3a3e0574c61698b2", "patch": "@@ -28,6 +28,7 @@ docs! {\n     \"approx_constant\",\n     \"arithmetic_side_effects\",\n     \"as_conversions\",\n+    \"as_ptr_cast_mut\",\n     \"as_underscore\",\n     \"assertions_on_constants\",\n     \"assertions_on_result_states\","}, {"sha": "228dde996bb2f41f5985bc3ebe984fcc25031af4", "filename": "src/docs/as_ptr_cast_mut.txt", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/8e87d39f992d132354a98d9d3a3e0574c61698b2/src%2Fdocs%2Fas_ptr_cast_mut.txt", "raw_url": "https://github.com/rust-lang/rust/raw/8e87d39f992d132354a98d9d3a3e0574c61698b2/src%2Fdocs%2Fas_ptr_cast_mut.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdocs%2Fas_ptr_cast_mut.txt?ref=8e87d39f992d132354a98d9d3a3e0574c61698b2", "patch": "@@ -0,0 +1,19 @@\n+### What it does\n+Checks for the result of a `&self`-taking `as_ptr` being cast to a mutable pointer\n+\n+### Why is this bad?\n+Since `as_ptr` takes a `&self`, the pointer won't have write permissions unless interior\n+mutability is used, making it unlikely that having it as a mutable pointer is correct.\n+\n+### Example\n+```\n+let string = String::with_capacity(1);\n+let ptr = string.as_ptr() as *mut u8;\n+unsafe { ptr.write(4) }; // UNDEFINED BEHAVIOUR\n+```\n+Use instead:\n+```\n+let mut string = String::with_capacity(1);\n+let ptr = string.as_mut_ptr();\n+unsafe { ptr.write(4) };\n+```\n\\ No newline at end of file"}, {"sha": "0d1d9258433b215589e77f03437e3578f3631c2f", "filename": "tests/ui/as_ptr_cast_mut.rs", "status": "added", "additions": 37, "deletions": 0, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/8e87d39f992d132354a98d9d3a3e0574c61698b2/tests%2Fui%2Fas_ptr_cast_mut.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8e87d39f992d132354a98d9d3a3e0574c61698b2/tests%2Fui%2Fas_ptr_cast_mut.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fas_ptr_cast_mut.rs?ref=8e87d39f992d132354a98d9d3a3e0574c61698b2", "patch": "@@ -0,0 +1,37 @@\n+#![allow(unused)]\n+#![warn(clippy::as_ptr_cast_mut)]\n+#![allow(clippy::wrong_self_convention)]\n+\n+struct MutPtrWrapper(Vec<u8>);\n+impl MutPtrWrapper {\n+    fn as_ptr(&mut self) -> *const u8 {\n+        self.0.as_mut_ptr() as *const u8\n+    }\n+}\n+\n+struct Covariant<T>(*const T);\n+impl<T> Covariant<T> {\n+    fn as_ptr(self) -> *const T {\n+        self.0\n+    }\n+}\n+\n+fn main() {\n+    let mut string = String::new();\n+    let _ = string.as_ptr() as *mut u8;\n+    let _: *mut i8 = string.as_ptr() as *mut _;\n+    let _ = string.as_ptr() as *const i8;\n+    let _ = string.as_mut_ptr();\n+    let _ = string.as_mut_ptr() as *mut u8;\n+    let _ = string.as_mut_ptr() as *const u8;\n+\n+    let nn = std::ptr::NonNull::new(4 as *mut u8).unwrap();\n+    let _ = nn.as_ptr() as *mut u8;\n+\n+    let mut wrap = MutPtrWrapper(Vec::new());\n+    let _ = wrap.as_ptr() as *mut u8;\n+\n+    let mut local = 4;\n+    let ref_with_write_perm = Covariant(std::ptr::addr_of_mut!(local) as *const _);\n+    let _ = ref_with_write_perm.as_ptr() as *mut u8;\n+}"}, {"sha": "2189c3d2f8556d702b708d94f64957390d18369a", "filename": "tests/ui/as_ptr_cast_mut.stderr", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/8e87d39f992d132354a98d9d3a3e0574c61698b2/tests%2Fui%2Fas_ptr_cast_mut.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/8e87d39f992d132354a98d9d3a3e0574c61698b2/tests%2Fui%2Fas_ptr_cast_mut.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fas_ptr_cast_mut.stderr?ref=8e87d39f992d132354a98d9d3a3e0574c61698b2", "patch": "@@ -0,0 +1,16 @@\n+error: casting the result of `as_ptr` to *mut u8\n+  --> $DIR/as_ptr_cast_mut.rs:21:13\n+   |\n+LL |     let _ = string.as_ptr() as *mut u8;\n+   |             ^^^^^^^^^^^^^^^^^^^^^^^^^^ help: replace with: `string.as_mut_ptr()`\n+   |\n+   = note: `-D clippy::as-ptr-cast-mut` implied by `-D warnings`\n+\n+error: casting the result of `as_ptr` to *mut i8\n+  --> $DIR/as_ptr_cast_mut.rs:22:22\n+   |\n+LL |     let _: *mut i8 = string.as_ptr() as *mut _;\n+   |                      ^^^^^^^^^^^^^^^^^^^^^^^^^ help: replace with: `string.as_mut_ptr()`\n+\n+error: aborting due to 2 previous errors\n+"}]}