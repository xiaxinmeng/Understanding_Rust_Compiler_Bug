{"sha": "6ae46a8c4dc6904c1359c823316c02d254fa6f96", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZhZTQ2YThjNGRjNjkwNGMxMzU5YzgyMzMxNmMwMmQyNTRmYTZmOTY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-04-23T08:37:44Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-04-23T08:37:44Z"}, "message": "Auto merge of #4017 - Xanewok:wip-disambiguate-extern, r=oli-obk\n\ncompiletest: Disambiguate extern crate deps shared with the compiler\n\nFixes #4015.\n\nchangelog: Handle deps shared with the compiler in the internal compiletest suite\n\nAttempts to fix the multiple matching crates error using the `--extern dep=path` disambiguation. This only includes `serde` at the moment because it's the only problematic dep right now (is inside Rust sysroot and pulled via `extern crate` in the test suite).\n\nI'm not exactly sure this is the right approach (FWIW it fixes the issue locally), please do tell if this should be done differently.", "tree": {"sha": "d42e23f7cd6273a5ef96e79642338130900bc911", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d42e23f7cd6273a5ef96e79642338130900bc911"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6ae46a8c4dc6904c1359c823316c02d254fa6f96", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6ae46a8c4dc6904c1359c823316c02d254fa6f96", "html_url": "https://github.com/rust-lang/rust/commit/6ae46a8c4dc6904c1359c823316c02d254fa6f96", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6ae46a8c4dc6904c1359c823316c02d254fa6f96/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d420589e1a8208c85368d07c1644c6725367650b", "url": "https://api.github.com/repos/rust-lang/rust/commits/d420589e1a8208c85368d07c1644c6725367650b", "html_url": "https://github.com/rust-lang/rust/commit/d420589e1a8208c85368d07c1644c6725367650b"}, {"sha": "56389f36a3e99d374684c74c8dbddd7691023968", "url": "https://api.github.com/repos/rust-lang/rust/commits/56389f36a3e99d374684c74c8dbddd7691023968", "html_url": "https://github.com/rust-lang/rust/commit/56389f36a3e99d374684c74c8dbddd7691023968"}], "stats": {"total": 27, "additions": 25, "deletions": 2}, "files": [{"sha": "65561b7fbd76facc87edfa649d73211ed806f2b3", "filename": "tests/compile-test.rs", "status": "modified", "additions": 25, "deletions": 2, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/6ae46a8c4dc6904c1359c823316c02d254fa6f96/tests%2Fcompile-test.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6ae46a8c4dc6904c1359c823316c02d254fa6f96/tests%2Fcompile-test.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-test.rs?ref=6ae46a8c4dc6904c1359c823316c02d254fa6f96", "patch": "@@ -46,9 +46,32 @@ fn config(mode: &str, dir: PathBuf) -> compiletest::Config {\n         config.run_lib_path = rustc_lib_path();\n         config.compile_lib_path = rustc_lib_path();\n     }\n+\n+    // When we'll want to use `extern crate ..` for a dependency that is used\n+    // both by the crate and the compiler itself, we can't simply pass -L flags\n+    // as we'll get a duplicate matching versions. Instead, disambiguate with\n+    // `--extern dep=path`.\n+    // See https://github.com/rust-lang/rust-clippy/issues/4015.\n+    let needs_disambiguation = [\"serde\"];\n+    // This assumes that deps are compiled (they are for Cargo integration tests).\n+    let deps = std::fs::read_dir(host_libs().join(\"deps\")).unwrap();\n+    let disambiguated = deps\n+        .filter_map(|dep| {\n+            let path = dep.ok()?.path();\n+            let name = path.file_name()?.to_string_lossy();\n+            // NOTE: This only handles a single dep\n+            // https://github.com/laumann/compiletest-rs/issues/101\n+            needs_disambiguation\n+                .iter()\n+                .find(|dep| name.starts_with(&format!(\"lib{}-\", dep)))\n+                .map(|dep| format!(\"--extern {}={}\", dep, path.display()))\n+        })\n+        .collect::<Vec<_>>();\n+\n     config.target_rustcflags = Some(format!(\n-        \"-L {0} -L {0}/deps -Dwarnings -Zui-testing\",\n-        host_libs().display()\n+        \"-L {0} -L {0}/deps -Dwarnings -Zui-testing {1}\",\n+        host_libs().display(),\n+        disambiguated.join(\" \")\n     ));\n \n     config.mode = cfg_mode;"}]}