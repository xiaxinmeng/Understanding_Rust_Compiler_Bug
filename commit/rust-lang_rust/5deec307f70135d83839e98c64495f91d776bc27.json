{"sha": "5deec307f70135d83839e98c64495f91d776bc27", "node_id": "MDY6Q29tbWl0NzI0NzEyOjVkZWVjMzA3ZjcwMTM1ZDgzODM5ZTk4YzY0NDk1ZjkxZDc3NmJjMjc=", "commit": {"author": {"name": "Jesper Steen M\u00f8ller", "email": "jesper@selskabet.org", "date": "2019-04-30T13:59:29Z"}, "committer": {"name": "Jesper Steen M\u00f8ller", "email": "jesper@selskabet.org", "date": "2019-05-04T18:29:33Z"}, "message": "Fix #45268 by saving all NodeId's for resolved traits.", "tree": {"sha": "af00548b1b55a5d6c4f44a51211f1f0eaad240c7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/af00548b1b55a5d6c4f44a51211f1f0eaad240c7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5deec307f70135d83839e98c64495f91d776bc27", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5deec307f70135d83839e98c64495f91d776bc27", "html_url": "https://github.com/rust-lang/rust/commit/5deec307f70135d83839e98c64495f91d776bc27", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5deec307f70135d83839e98c64495f91d776bc27/comments", "author": {"login": "jespersm", "id": 664940, "node_id": "MDQ6VXNlcjY2NDk0MA==", "avatar_url": "https://avatars.githubusercontent.com/u/664940?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jespersm", "html_url": "https://github.com/jespersm", "followers_url": "https://api.github.com/users/jespersm/followers", "following_url": "https://api.github.com/users/jespersm/following{/other_user}", "gists_url": "https://api.github.com/users/jespersm/gists{/gist_id}", "starred_url": "https://api.github.com/users/jespersm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jespersm/subscriptions", "organizations_url": "https://api.github.com/users/jespersm/orgs", "repos_url": "https://api.github.com/users/jespersm/repos", "events_url": "https://api.github.com/users/jespersm/events{/privacy}", "received_events_url": "https://api.github.com/users/jespersm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jespersm", "id": 664940, "node_id": "MDQ6VXNlcjY2NDk0MA==", "avatar_url": "https://avatars.githubusercontent.com/u/664940?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jespersm", "html_url": "https://github.com/jespersm", "followers_url": "https://api.github.com/users/jespersm/followers", "following_url": "https://api.github.com/users/jespersm/following{/other_user}", "gists_url": "https://api.github.com/users/jespersm/gists{/gist_id}", "starred_url": "https://api.github.com/users/jespersm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jespersm/subscriptions", "organizations_url": "https://api.github.com/users/jespersm/orgs", "repos_url": "https://api.github.com/users/jespersm/repos", "events_url": "https://api.github.com/users/jespersm/events{/privacy}", "received_events_url": "https://api.github.com/users/jespersm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8dd4aae9a83964cc08505da92d07ec68a3a2341d", "url": "https://api.github.com/repos/rust-lang/rust/commits/8dd4aae9a83964cc08505da92d07ec68a3a2341d", "html_url": "https://github.com/rust-lang/rust/commit/8dd4aae9a83964cc08505da92d07ec68a3a2341d"}], "stats": {"total": 187, "additions": 137, "deletions": 50}, "files": [{"sha": "f8dd4c91773beb73e1cc057f9f383a09623e7f35", "filename": "Cargo.lock", "status": "modified", "additions": 15, "deletions": 1, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/5deec307f70135d83839e98c64495f91d776bc27/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/5deec307f70135d83839e98c64495f91d776bc27/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=5deec307f70135d83839e98c64495f91d776bc27", "patch": "@@ -296,6 +296,18 @@ dependencies = [\n  \"winapi 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)\",\n ]\n \n+[[package]]\n+name = \"cargo_metadata\"\n+version = \"0.6.4\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+dependencies = [\n+ \"error-chain 0.12.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"semver 0.9.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"serde 1.0.82 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"serde_derive 1.0.81 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"serde_json 1.0.33 (registry+https://github.com/rust-lang/crates.io-index)\",\n+]\n+\n [[package]]\n name = \"cargo_metadata\"\n version = \"0.7.1\"\n@@ -1612,7 +1624,7 @@ name = \"miri\"\n version = \"0.1.0\"\n dependencies = [\n  \"byteorder 1.2.7 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"cargo_metadata 0.7.1 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"cargo_metadata 0.6.4 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"colored 1.6.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"compiletest_rs 0.3.22 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"directories 1.0.2 (registry+https://github.com/rust-lang/crates.io-index)\",\n@@ -2957,6 +2969,7 @@ dependencies = [\n  \"rustc_data_structures 0.0.0\",\n  \"rustc_errors 0.0.0\",\n  \"rustc_metadata 0.0.0\",\n+ \"smallvec 0.6.7 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"syntax 0.0.0\",\n  \"syntax_pos 0.0.0\",\n ]\n@@ -4066,6 +4079,7 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n \"checksum byteorder 1.2.7 (registry+https://github.com/rust-lang/crates.io-index)\" = \"94f88df23a25417badc922ab0f5716cc1330e87f71ddd9203b3a3ccd9cedf75d\"\n \"checksum bytes 0.4.11 (registry+https://github.com/rust-lang/crates.io-index)\" = \"40ade3d27603c2cb345eb0912aec461a6dec7e06a4ae48589904e808335c7afa\"\n \"checksum bytesize 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"716960a18f978640f25101b5cbf1c6f6b0d3192fab36a2d98ca96f0ecbe41010\"\n+\"checksum cargo_metadata 0.6.4 (registry+https://github.com/rust-lang/crates.io-index)\" = \"e5d1b4d380e1bab994591a24c2bdd1b054f64b60bef483a8c598c7c345bc3bbe\"\n \"checksum cargo_metadata 0.7.1 (registry+https://github.com/rust-lang/crates.io-index)\" = \"585784cac9b05c93a53b17a0b24a5cdd1dfdda5256f030e089b549d2390cc720\"\n \"checksum cc 1.0.35 (registry+https://github.com/rust-lang/crates.io-index)\" = \"5e5f3fee5eeb60324c2781f1e41286bdee933850fff9b3c672587fed5ec58c83\"\n \"checksum cfg-if 0.1.6 (registry+https://github.com/rust-lang/crates.io-index)\" = \"082bb9b28e00d3c9d39cc03e64ce4cea0f1bb9b3fde493f0cbc008472d22bdf4\""}, {"sha": "8ef5b24a9f279582fd0030c45357b44c96e496d9", "filename": "src/librustc/hir/mod.rs", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/5deec307f70135d83839e98c64495f91d776bc27/src%2Flibrustc%2Fhir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5deec307f70135d83839e98c64495f91d776bc27/src%2Flibrustc%2Fhir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Fmod.rs?ref=5deec307f70135d83839e98c64495f91d776bc27", "patch": "@@ -37,6 +37,7 @@ use rustc_macros::HashStable;\n use serialize::{self, Encoder, Encodable, Decoder, Decodable};\n use std::collections::{BTreeSet, BTreeMap};\n use std::fmt;\n+use smallvec::SmallVec;\n \n /// HIR doesn't commit to a concrete storage type and has its own alias for a vector.\n /// It can be `Vec`, `P<[T]>` or potentially `Box<[T]>`, or some other container with similar\n@@ -2505,10 +2506,16 @@ pub type FreevarMap = NodeMap<Vec<Freevar<ast::NodeId>>>;\n \n pub type CaptureModeMap = NodeMap<CaptureClause>;\n \n+pub type SmallHirIdVec = SmallVec<[HirId;1]>;\n+pub type SmallNodeIdVec = SmallVec<[NodeId;1]>;\n+\n+ // The TraitCandidate's import_ids is empty if the trait is defined in the same module, and\n+ // has length > 0 if the trait is found through an chain of imports, starting with the\n+ // import/use statement in the scope where the trait is used.\n #[derive(Clone, Debug)]\n pub struct TraitCandidate {\n     pub def_id: DefId,\n-    pub import_id: Option<NodeId>,\n+    pub import_ids: SmallNodeIdVec,\n }\n \n // Trait method resolution"}, {"sha": "eb57f08003cedc10c09c52022162a2f6d95cb94e", "filename": "src/librustc/ich/impls_hir.rs", "status": "modified", "additions": 11, "deletions": 10, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/5deec307f70135d83839e98c64495f91d776bc27/src%2Flibrustc%2Fich%2Fimpls_hir.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5deec307f70135d83839e98c64495f91d776bc27/src%2Flibrustc%2Fich%2Fimpls_hir.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fich%2Fimpls_hir.rs?ref=5deec307f70135d83839e98c64495f91d776bc27", "patch": "@@ -391,13 +391,14 @@ impl<'a> HashStable<StableHashingContext<'a>> for hir::TraitCandidate {\n                                           hcx: &mut StableHashingContext<'a>,\n                                           hasher: &mut StableHasher<W>) {\n         hcx.with_node_id_hashing_mode(NodeIdHashingMode::HashDefPath, |hcx| {\n-            let hir::TraitCandidate {\n+            let &hir::TraitCandidate {\n                 def_id,\n-                import_id,\n-            } = *self;\n+                import_ids,\n+            } = &self;\n \n             def_id.hash_stable(hcx, hasher);\n-            import_id.hash_stable(hcx, hasher);\n+            // We only use the outermost import NodeId as key\n+            import_ids.first().hash_stable(hcx, hasher);\n         });\n     }\n }\n@@ -410,13 +411,13 @@ impl<'a> ToStableHashKey<StableHashingContext<'a>> for hir::TraitCandidate {\n                           -> Self::KeyType {\n         let hir::TraitCandidate {\n             def_id,\n-            import_id,\n-        } = *self;\n+            import_ids,\n+        } = self;\n \n-        let import_id = import_id.map(|node_id| hcx.node_to_hir_id(node_id))\n-                                 .map(|hir_id| (hcx.local_def_path_hash(hir_id.owner),\n-                                                hir_id.local_id));\n-        (hcx.def_path_hash(def_id), import_id)\n+        let import_ids = import_ids.first().map(|node_id| hcx.node_to_hir_id(*node_id))\n+                                           .map(|hir_id| (hcx.local_def_path_hash(hir_id.owner),\n+                                                          hir_id.local_id));\n+        (hcx.def_path_hash(*def_id), import_ids)\n     }\n }\n "}, {"sha": "968a45e241e84b4b860a14845bde74819ee28d33", "filename": "src/librustc_resolve/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/5deec307f70135d83839e98c64495f91d776bc27/src%2Flibrustc_resolve%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/5deec307f70135d83839e98c64495f91d776bc27/src%2Flibrustc_resolve%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2FCargo.toml?ref=5deec307f70135d83839e98c64495f91d776bc27", "patch": "@@ -20,3 +20,4 @@ errors = { path = \"../librustc_errors\", package = \"rustc_errors\" }\n syntax_pos = { path = \"../libsyntax_pos\" }\n rustc_data_structures = { path = \"../librustc_data_structures\" }\n rustc_metadata = { path = \"../librustc_metadata\" }\n+smallvec = { version = \"0.6.7\", features = [\"union\", \"may_dangle\"] }"}, {"sha": "71721504d5addca3a33a7ab04d4f7a2d94c260e4", "filename": "src/librustc_resolve/lib.rs", "status": "modified", "additions": 20, "deletions": 21, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/5deec307f70135d83839e98c64495f91d776bc27/src%2Flibrustc_resolve%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5deec307f70135d83839e98c64495f91d776bc27/src%2Flibrustc_resolve%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Flib.rs?ref=5deec307f70135d83839e98c64495f91d776bc27", "patch": "@@ -17,6 +17,7 @@ pub use rustc::hir::def::{Namespace, PerNS};\n \n use GenericParameters::*;\n use RibKind::*;\n+use smallvec::smallvec;\n \n use rustc::hir::map::{Definitions, DefCollector};\n use rustc::hir::{self, PrimTy, Bool, Char, Float, Int, Uint, Str};\n@@ -28,7 +29,7 @@ use rustc::hir::def::{\n };\n use rustc::hir::def::Namespace::*;\n use rustc::hir::def_id::{CRATE_DEF_INDEX, LOCAL_CRATE, DefId};\n-use rustc::hir::{Freevar, FreevarMap, TraitCandidate, TraitMap, GlobMap};\n+use rustc::hir::{Freevar, FreevarMap, TraitCandidate, TraitMap, GlobMap, SmallNodeIdVec};\n use rustc::ty::{self, DefIdTree};\n use rustc::util::nodemap::{NodeMap, NodeSet, FxHashMap, FxHashSet, DefIdMap};\n use rustc::{bug, span_bug};\n@@ -4582,7 +4583,7 @@ impl<'a> Resolver<'a> {\n                 module.span,\n             ).is_ok() {\n                 let def_id = module.def_id().unwrap();\n-                found_traits.push(TraitCandidate { def_id: def_id, import_id: None });\n+                found_traits.push(TraitCandidate { def_id: def_id, import_ids: smallvec![] });\n             }\n         }\n \n@@ -4641,37 +4642,35 @@ impl<'a> Resolver<'a> {\n                     false,\n                     module.span,\n                 ).is_ok() {\n-                    let import_id = match binding.kind {\n-                        NameBindingKind::Import { directive, .. } => {\n-                            self.maybe_unused_trait_imports.insert(directive.id);\n-                            self.add_to_glob_map(&directive, trait_name);\n-                            Some(directive.id)\n-                        }\n-                        _ => None,\n-                    };\n+                    let import_ids = self.find_transitive_imports(&binding.kind, &trait_name);\n                     let trait_def_id = module.def_id().unwrap();\n-                    found_traits.push(TraitCandidate { def_id: trait_def_id, import_id });\n+                    found_traits.push(TraitCandidate { def_id: trait_def_id, import_ids });\n                 }\n             } else if let Res::Def(DefKind::TraitAlias, _) = binding.res() {\n                 // For now, just treat all trait aliases as possible candidates, since we don't\n                 // know if the ident is somewhere in the transitive bounds.\n-\n-                let import_id = match binding.kind {\n-                    NameBindingKind::Import { directive, .. } => {\n-                        self.maybe_unused_trait_imports.insert(directive.id);\n-                        self.add_to_glob_map(&directive, trait_name);\n-                        Some(directive.id)\n-                    }\n-                    _ => None,\n-                };\n+                let import_ids = self.find_transitive_imports(&binding.kind, &trait_name);\n                 let trait_def_id = binding.res().def_id();\n-                found_traits.push(TraitCandidate { def_id: trait_def_id, import_id });\n+                found_traits.push(TraitCandidate { def_id: trait_def_id, import_ids });\n             } else {\n                 bug!(\"candidate is not trait or trait alias?\")\n             }\n         }\n     }\n \n+    fn find_transitive_imports(&mut self, kind: &NameBindingKind<'_>,\n+                               trait_name: &Ident) -> SmallNodeIdVec {\n+        let mut import_ids = smallvec![];\n+        let mut kind = kind;\n+        while let NameBindingKind::Import { directive, binding, .. } = *kind {\n+            self.maybe_unused_trait_imports.insert(directive.id);\n+            self.add_to_glob_map(&directive, *trait_name);\n+            import_ids.push(directive.id);\n+            kind = &binding.kind;\n+        };\n+        import_ids\n+    }\n+\n     fn lookup_import_candidates_from_module<FilterFn>(&mut self,\n                                           lookup_ident: Ident,\n                                           namespace: Namespace,"}, {"sha": "a4b1687ea53012e7f2aed116b495e0e85dca8dc4", "filename": "src/librustc_typeck/check/method/mod.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/5deec307f70135d83839e98c64495f91d776bc27/src%2Flibrustc_typeck%2Fcheck%2Fmethod%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5deec307f70135d83839e98c64495f91d776bc27/src%2Flibrustc_typeck%2Fcheck%2Fmethod%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fmethod%2Fmod.rs?ref=5deec307f70135d83839e98c64495f91d776bc27", "patch": "@@ -195,8 +195,8 @@ impl<'a, 'gcx, 'tcx> FnCtxt<'a, 'gcx, 'tcx> {\n             ProbeScope::TraitsInScope\n         )?;\n \n-        if let Some(import_id) = pick.import_id {\n-            let import_def_id = self.tcx.hir().local_def_id_from_hir_id(import_id);\n+        for import_id in &pick.import_ids {\n+            let import_def_id = self.tcx.hir().local_def_id_from_hir_id(*import_id);\n             debug!(\"used_trait_import: {:?}\", import_def_id);\n             Lrc::get_mut(&mut self.tables.borrow_mut().used_trait_imports)\n                 .unwrap().insert(import_def_id);\n@@ -434,7 +434,7 @@ impl<'a, 'gcx, 'tcx> FnCtxt<'a, 'gcx, 'tcx> {\n         let pick = self.probe_for_name(span, probe::Mode::Path, method_name, IsSuggestion(false),\n                                        self_ty, expr_id, ProbeScope::TraitsInScope)?;\n         debug!(\"resolve_ufcs: pick={:?}\", pick);\n-        if let Some(import_id) = pick.import_id {\n+        for import_id in pick.import_ids {\n             let import_def_id = tcx.hir().local_def_id_from_hir_id(import_id);\n             debug!(\"resolve_ufcs: used_trait_import: {:?}\", import_def_id);\n             Lrc::get_mut(&mut self.tables.borrow_mut().used_trait_imports)"}, {"sha": "148b7d5edb570f8c7feeaca880a1c3735a0cc24d", "filename": "src/librustc_typeck/check/method/probe.rs", "status": "modified", "additions": 18, "deletions": 14, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/5deec307f70135d83839e98c64495f91d776bc27/src%2Flibrustc_typeck%2Fcheck%2Fmethod%2Fprobe.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5deec307f70135d83839e98c64495f91d776bc27/src%2Flibrustc_typeck%2Fcheck%2Fmethod%2Fprobe.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fmethod%2Fprobe.rs?ref=5deec307f70135d83839e98c64495f91d776bc27", "patch": "@@ -7,6 +7,7 @@ use crate::check::autoderef::{self, Autoderef};\n use crate::check::FnCtxt;\n use crate::hir::def_id::DefId;\n use crate::hir::def::DefKind;\n+use crate::hir::SmallHirIdVec;\n use crate::namespace::Namespace;\n \n use rustc_data_structures::sync::Lrc;\n@@ -35,6 +36,8 @@ use std::mem;\n use std::ops::Deref;\n use std::cmp::max;\n \n+use smallvec::smallvec;\n+\n use self::CandidateKind::*;\n pub use self::PickKind::*;\n \n@@ -121,7 +124,7 @@ struct Candidate<'tcx> {\n     xform_ret_ty: Option<Ty<'tcx>>,\n     item: ty::AssociatedItem,\n     kind: CandidateKind<'tcx>,\n-    import_id: Option<hir::HirId>,\n+    import_ids: SmallHirIdVec,\n }\n \n #[derive(Debug)]\n@@ -146,7 +149,7 @@ enum ProbeResult {\n pub struct Pick<'tcx> {\n     pub item: ty::AssociatedItem,\n     pub kind: PickKind<'tcx>,\n-    pub import_id: Option<hir::HirId>,\n+    pub import_ids: hir::SmallHirIdVec,\n \n     // Indicates that the source expression should be autoderef'd N times\n     //\n@@ -716,7 +719,7 @@ impl<'a, 'gcx, 'tcx> ProbeContext<'a, 'gcx, 'tcx> {\n             self.push_candidate(Candidate {\n                 xform_self_ty, xform_ret_ty, item,\n                 kind: InherentImplCandidate(impl_substs, obligations),\n-                import_id: None\n+                import_ids: smallvec![]\n             }, true);\n         }\n     }\n@@ -750,7 +753,7 @@ impl<'a, 'gcx, 'tcx> ProbeContext<'a, 'gcx, 'tcx> {\n             this.push_candidate(Candidate {\n                 xform_self_ty, xform_ret_ty, item,\n                 kind: ObjectCandidate,\n-                import_id: None\n+                import_ids: smallvec![]\n             }, true);\n         });\n     }\n@@ -799,7 +802,7 @@ impl<'a, 'gcx, 'tcx> ProbeContext<'a, 'gcx, 'tcx> {\n             this.push_candidate(Candidate {\n                 xform_self_ty, xform_ret_ty, item,\n                 kind: WhereClauseCandidate(poly_trait_ref),\n-                import_id: None\n+                import_ids: smallvec![]\n             }, true);\n         });\n     }\n@@ -838,9 +841,10 @@ impl<'a, 'gcx, 'tcx> ProbeContext<'a, 'gcx, 'tcx> {\n             for trait_candidate in applicable_traits.iter() {\n                 let trait_did = trait_candidate.def_id;\n                 if duplicates.insert(trait_did) {\n-                    let import_id = trait_candidate.import_id.map(|node_id|\n-                        self.fcx.tcx.hir().node_to_hir_id(node_id));\n-                    let result = self.assemble_extension_candidates_for_trait(import_id, trait_did);\n+                    let import_ids = trait_candidate.import_ids.iter().map(|node_id|\n+                        self.fcx.tcx.hir().node_to_hir_id(*node_id)).collect();\n+                    let result = self.assemble_extension_candidates_for_trait(import_ids,\n+                                                                              trait_did);\n                     result?;\n                 }\n             }\n@@ -852,7 +856,7 @@ impl<'a, 'gcx, 'tcx> ProbeContext<'a, 'gcx, 'tcx> {\n         let mut duplicates = FxHashSet::default();\n         for trait_info in suggest::all_traits(self.tcx) {\n             if duplicates.insert(trait_info.def_id) {\n-                self.assemble_extension_candidates_for_trait(None, trait_info.def_id)?;\n+                self.assemble_extension_candidates_for_trait(smallvec![], trait_info.def_id)?;\n             }\n         }\n         Ok(())\n@@ -890,7 +894,7 @@ impl<'a, 'gcx, 'tcx> ProbeContext<'a, 'gcx, 'tcx> {\n     }\n \n     fn assemble_extension_candidates_for_trait(&mut self,\n-                                               import_id: Option<hir::HirId>,\n+                                               import_ids: SmallHirIdVec,\n                                                trait_def_id: DefId)\n                                                -> Result<(), MethodError<'tcx>> {\n         debug!(\"assemble_extension_candidates_for_trait(trait_def_id={:?})\",\n@@ -907,7 +911,7 @@ impl<'a, 'gcx, 'tcx> ProbeContext<'a, 'gcx, 'tcx> {\n                 let (xform_self_ty, xform_ret_ty) =\n                     this.xform_self_ty(&item, new_trait_ref.self_ty(), new_trait_ref.substs);\n                 this.push_candidate(Candidate {\n-                    xform_self_ty, xform_ret_ty, item, import_id,\n+                    xform_self_ty, xform_ret_ty, item, import_ids: import_ids.clone(),\n                     kind: TraitCandidate(new_trait_ref),\n                 }, true);\n             });\n@@ -924,7 +928,7 @@ impl<'a, 'gcx, 'tcx> ProbeContext<'a, 'gcx, 'tcx> {\n                 let (xform_self_ty, xform_ret_ty) =\n                     self.xform_self_ty(&item, trait_ref.self_ty(), trait_substs);\n                 self.push_candidate(Candidate {\n-                    xform_self_ty, xform_ret_ty, item, import_id,\n+                    xform_self_ty, xform_ret_ty, item, import_ids: import_ids.clone(),\n                     kind: TraitCandidate(trait_ref),\n                 }, false);\n             }\n@@ -1413,7 +1417,7 @@ impl<'a, 'gcx, 'tcx> ProbeContext<'a, 'gcx, 'tcx> {\n         Some(Pick {\n             item: probes[0].0.item.clone(),\n             kind: TraitPick,\n-            import_id: probes[0].0.import_id,\n+            import_ids: probes[0].0.import_ids.clone(),\n             autoderefs: 0,\n             autoref: None,\n             unsize: None,\n@@ -1652,7 +1656,7 @@ impl<'tcx> Candidate<'tcx> {\n                     WhereClausePick(trait_ref.clone())\n                 }\n             },\n-            import_id: self.import_id,\n+            import_ids: self.import_ids.clone(),\n             autoderefs: 0,\n             autoref: None,\n             unsize: None,"}, {"sha": "9f3f5573a15d1a920eab97612bdbef636d5899bd", "filename": "src/test/ui/lint/unused_import_warning_issue_45268.rs", "status": "added", "additions": 49, "deletions": 0, "changes": 49, "blob_url": "https://github.com/rust-lang/rust/blob/5deec307f70135d83839e98c64495f91d776bc27/src%2Ftest%2Fui%2Flint%2Funused_import_warning_issue_45268.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5deec307f70135d83839e98c64495f91d776bc27/src%2Ftest%2Fui%2Flint%2Funused_import_warning_issue_45268.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Funused_import_warning_issue_45268.rs?ref=5deec307f70135d83839e98c64495f91d776bc27", "patch": "@@ -0,0 +1,49 @@\n+// compile-pass\n+\n+#![warn(unused_imports)] // Warning explanation here, it's OK\n+\n+mod test {\n+    pub trait A {\n+        fn a();\n+    }\n+\n+    impl A for () {\n+        fn a() { }\n+    }\n+\n+    pub trait B {\n+        fn b(self);\n+    }\n+\n+    impl B for () {\n+        fn b(self) { }\n+    }\n+\n+    pub trait Unused {\n+    }\n+}\n+\n+use test::Unused;   // This is really unused, so warning is OK\n+use test::A;        // This is used by the test2::func() through import of super::*\n+use test::B;        // This is used by the test2::func() through import of super::*\n+\n+mod test2 {\n+    use super::*;\n+    pub fn func() {\n+        let _ = <()>::a();\n+        let _ = ().b();\n+        test3::inner_func();\n+    }\n+    mod test3 {\n+    use super::*;\n+    pub fn inner_func() {\n+        let _ = <()>::a();\n+        let _ = ().b();\n+    }\n+}\n+\n+}\n+\n+fn main() {\n+    test2::func();\n+}"}, {"sha": "7392e99f7aef3298468dc2d3a4c9092eca29f389", "filename": "src/test/ui/lint/unused_import_warning_issue_45268.stderr", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/5deec307f70135d83839e98c64495f91d776bc27/src%2Ftest%2Fui%2Flint%2Funused_import_warning_issue_45268.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/5deec307f70135d83839e98c64495f91d776bc27/src%2Ftest%2Fui%2Flint%2Funused_import_warning_issue_45268.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Funused_import_warning_issue_45268.stderr?ref=5deec307f70135d83839e98c64495f91d776bc27", "patch": "@@ -0,0 +1,12 @@\n+warning: unused import: `test::Unused`\n+  --> $DIR/unused_import_warning_issue_45268.rs:26:5\n+   |\n+LL | use test::Unused;   // This is really unused, so warning is OK\n+   |     ^^^^^^^^^^^^\n+   |\n+note: lint level defined here\n+  --> $DIR/unused_import_warning_issue_45268.rs:3:9\n+   |\n+LL | #![warn(unused_imports)] // Warning explanation here, it's OK\n+   |         ^^^^^^^^^^^^^^\n+"}]}