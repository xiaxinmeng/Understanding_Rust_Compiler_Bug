{"sha": "6f67a46a6a264ac7985a10ee19fbf9bbaef924bc", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZmNjdhNDZhNmEyNjRhYzc5ODVhMTBlZTE5ZmJmOWJiYWVmOTI0YmM=", "commit": {"author": {"name": "Florian Diebold", "email": "florian.diebold@freiheit.com", "date": "2020-05-29T15:35:57Z"}, "committer": {"name": "Florian Diebold", "email": "florian.diebold@freiheit.com", "date": "2020-05-29T15:36:43Z"}, "message": "Fix match ergonomics in closure parameters\n\nFixes #4476.", "tree": {"sha": "579439709de055f029c109f6679887416bf4e1f9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/579439709de055f029c109f6679887416bf4e1f9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6f67a46a6a264ac7985a10ee19fbf9bbaef924bc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6f67a46a6a264ac7985a10ee19fbf9bbaef924bc", "html_url": "https://github.com/rust-lang/rust/commit/6f67a46a6a264ac7985a10ee19fbf9bbaef924bc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6f67a46a6a264ac7985a10ee19fbf9bbaef924bc/comments", "author": {"login": "flodiebold", "id": 906069, "node_id": "MDQ6VXNlcjkwNjA2OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/906069?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flodiebold", "html_url": "https://github.com/flodiebold", "followers_url": "https://api.github.com/users/flodiebold/followers", "following_url": "https://api.github.com/users/flodiebold/following{/other_user}", "gists_url": "https://api.github.com/users/flodiebold/gists{/gist_id}", "starred_url": "https://api.github.com/users/flodiebold/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flodiebold/subscriptions", "organizations_url": "https://api.github.com/users/flodiebold/orgs", "repos_url": "https://api.github.com/users/flodiebold/repos", "events_url": "https://api.github.com/users/flodiebold/events{/privacy}", "received_events_url": "https://api.github.com/users/flodiebold/received_events", "type": "User", "site_admin": false}, "committer": {"login": "flodiebold", "id": 906069, "node_id": "MDQ6VXNlcjkwNjA2OQ==", "avatar_url": "https://avatars.githubusercontent.com/u/906069?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flodiebold", "html_url": "https://github.com/flodiebold", "followers_url": "https://api.github.com/users/flodiebold/followers", "following_url": "https://api.github.com/users/flodiebold/following{/other_user}", "gists_url": "https://api.github.com/users/flodiebold/gists{/gist_id}", "starred_url": "https://api.github.com/users/flodiebold/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flodiebold/subscriptions", "organizations_url": "https://api.github.com/users/flodiebold/orgs", "repos_url": "https://api.github.com/users/flodiebold/repos", "events_url": "https://api.github.com/users/flodiebold/events{/privacy}", "received_events_url": "https://api.github.com/users/flodiebold/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "30658b25d2bb00ec495e0f3396de772141482081", "url": "https://api.github.com/repos/rust-lang/rust/commits/30658b25d2bb00ec495e0f3396de772141482081", "html_url": "https://github.com/rust-lang/rust/commit/30658b25d2bb00ec495e0f3396de772141482081"}], "stats": {"total": 66, "additions": 61, "deletions": 5}, "files": [{"sha": "78084cb573cb844af10fe56b844573302a901b85", "filename": "crates/ra_hir_ty/src/infer/expr.rs", "status": "modified", "additions": 11, "deletions": 5, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/6f67a46a6a264ac7985a10ee19fbf9bbaef924bc/crates%2Fra_hir_ty%2Fsrc%2Finfer%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6f67a46a6a264ac7985a10ee19fbf9bbaef924bc/crates%2Fra_hir_ty%2Fsrc%2Finfer%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_ty%2Fsrc%2Finfer%2Fexpr.rs?ref=6f67a46a6a264ac7985a10ee19fbf9bbaef924bc", "patch": "@@ -140,13 +140,13 @@ impl<'a> InferenceContext<'a> {\n \n                 let mut sig_tys = Vec::new();\n \n-                for (arg_pat, arg_type) in args.iter().zip(arg_types.iter()) {\n-                    let expected = if let Some(type_ref) = arg_type {\n+                // collect explicitly written argument types\n+                for arg_type in arg_types.iter() {\n+                    let arg_ty = if let Some(type_ref) = arg_type {\n                         self.make_ty(type_ref)\n                     } else {\n-                        Ty::Unknown\n+                        self.table.new_type_var()\n                     };\n-                    let arg_ty = self.infer_pat(*arg_pat, &expected, BindingMode::default());\n                     sig_tys.push(arg_ty);\n                 }\n \n@@ -158,7 +158,7 @@ impl<'a> InferenceContext<'a> {\n                 sig_tys.push(ret_ty.clone());\n                 let sig_ty = Ty::apply(\n                     TypeCtor::FnPtr { num_args: sig_tys.len() as u16 - 1 },\n-                    Substs(sig_tys.into()),\n+                    Substs(sig_tys.clone().into()),\n                 );\n                 let closure_ty =\n                     Ty::apply_one(TypeCtor::Closure { def: self.owner, expr: tgt_expr }, sig_ty);\n@@ -168,6 +168,12 @@ impl<'a> InferenceContext<'a> {\n                 // infer the body.\n                 self.coerce(&closure_ty, &expected.ty);\n \n+                // Now go through the argument patterns\n+                for (arg_pat, arg_ty) in args.iter().zip(sig_tys) {\n+                    let resolved = self.resolve_ty_as_possible(arg_ty);\n+                    self.infer_pat(*arg_pat, &resolved, BindingMode::default());\n+                }\n+\n                 let prev_diverges = mem::replace(&mut self.diverges, Diverges::Maybe);\n                 let prev_ret_ty = mem::replace(&mut self.return_ty, ret_ty.clone());\n "}, {"sha": "fe62587c0d7014595bb83b5f4dc9df81faecd7f3", "filename": "crates/ra_hir_ty/src/tests/patterns.rs", "status": "modified", "additions": 50, "deletions": 0, "changes": 50, "blob_url": "https://github.com/rust-lang/rust/blob/6f67a46a6a264ac7985a10ee19fbf9bbaef924bc/crates%2Fra_hir_ty%2Fsrc%2Ftests%2Fpatterns.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6f67a46a6a264ac7985a10ee19fbf9bbaef924bc/crates%2Fra_hir_ty%2Fsrc%2Ftests%2Fpatterns.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_ty%2Fsrc%2Ftests%2Fpatterns.rs?ref=6f67a46a6a264ac7985a10ee19fbf9bbaef924bc", "patch": "@@ -520,3 +520,53 @@ fn main() {\n         105..107 '()': ()\n     \")\n }\n+\n+#[test]\n+fn match_ergonomics_in_closure_params() {\n+    assert_snapshot!(\n+        infer(r#\"\n+#[lang = \"fn_once\"]\n+trait FnOnce<Args> {\n+    type Output;\n+}\n+\n+fn foo<T, U, F: FnOnce(T) -> U>(t: T, f: F) -> U { loop {} }\n+\n+fn test() {\n+    foo(&(1, \"a\"), |&(x, y)| x); // normal, no match ergonomics\n+    foo(&(1, \"a\"), |(x, y)| x);\n+}\n+\"#),\n+        @r###\"\n+    94..95 't': T\n+    100..101 'f': F\n+    111..122 '{ loop {} }': U\n+    113..120 'loop {}': !\n+    118..120 '{}': ()\n+    134..233 '{     ... x); }': ()\n+    140..143 'foo': fn foo<&(i32, &str), i32, |&(i32, &str)| -> i32>(&(i32, &str), |&(i32, &str)| -> i32) -> i32\n+    140..167 'foo(&(...y)| x)': i32\n+    144..153 '&(1, \"a\")': &(i32, &str)\n+    145..153 '(1, \"a\")': (i32, &str)\n+    146..147 '1': i32\n+    149..152 '\"a\"': &str\n+    155..166 '|&(x, y)| x': |&(i32, &str)| -> i32\n+    156..163 '&(x, y)': &(i32, &str)\n+    157..163 '(x, y)': (i32, &str)\n+    158..159 'x': i32\n+    161..162 'y': &str\n+    165..166 'x': i32\n+    204..207 'foo': fn foo<&(i32, &str), &i32, |&(i32, &str)| -> &i32>(&(i32, &str), |&(i32, &str)| -> &i32) -> &i32\n+    204..230 'foo(&(...y)| x)': &i32\n+    208..217 '&(1, \"a\")': &(i32, &str)\n+    209..217 '(1, \"a\")': (i32, &str)\n+    210..211 '1': i32\n+    213..216 '\"a\"': &str\n+    219..229 '|(x, y)| x': |&(i32, &str)| -> &i32\n+    220..226 '(x, y)': (i32, &str)\n+    221..222 'x': &i32\n+    224..225 'y': &&str\n+    228..229 'x': &i32\n+    \"###\n+    );\n+}"}]}