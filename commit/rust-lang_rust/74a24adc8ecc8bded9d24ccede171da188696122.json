{"sha": "74a24adc8ecc8bded9d24ccede171da188696122", "node_id": "MDY6Q29tbWl0NzI0NzEyOjc0YTI0YWRjOGVjYzhiZGVkOWQyNGNjZWRlMTcxZGExODg2OTYxMjI=", "commit": {"author": {"name": "Edwin Cheng", "email": "edwin0cheng@gmail.com", "date": "2021-01-08T06:00:16Z"}, "committer": {"name": "Edwin Cheng", "email": "edwin0cheng@gmail.com", "date": "2021-01-08T06:00:16Z"}, "message": "Fix bug when $crate in LHS in mbe", "tree": {"sha": "7c03a87334ba6be2a7adc5d311c6f0adddb09dae", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7c03a87334ba6be2a7adc5d311c6f0adddb09dae"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/74a24adc8ecc8bded9d24ccede171da188696122", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/74a24adc8ecc8bded9d24ccede171da188696122", "html_url": "https://github.com/rust-lang/rust/commit/74a24adc8ecc8bded9d24ccede171da188696122", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/74a24adc8ecc8bded9d24ccede171da188696122/comments", "author": {"login": "edwin0cheng", "id": 11014119, "node_id": "MDQ6VXNlcjExMDE0MTE5", "avatar_url": "https://avatars.githubusercontent.com/u/11014119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/edwin0cheng", "html_url": "https://github.com/edwin0cheng", "followers_url": "https://api.github.com/users/edwin0cheng/followers", "following_url": "https://api.github.com/users/edwin0cheng/following{/other_user}", "gists_url": "https://api.github.com/users/edwin0cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/edwin0cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/edwin0cheng/subscriptions", "organizations_url": "https://api.github.com/users/edwin0cheng/orgs", "repos_url": "https://api.github.com/users/edwin0cheng/repos", "events_url": "https://api.github.com/users/edwin0cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/edwin0cheng/received_events", "type": "User", "site_admin": false}, "committer": {"login": "edwin0cheng", "id": 11014119, "node_id": "MDQ6VXNlcjExMDE0MTE5", "avatar_url": "https://avatars.githubusercontent.com/u/11014119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/edwin0cheng", "html_url": "https://github.com/edwin0cheng", "followers_url": "https://api.github.com/users/edwin0cheng/followers", "following_url": "https://api.github.com/users/edwin0cheng/following{/other_user}", "gists_url": "https://api.github.com/users/edwin0cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/edwin0cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/edwin0cheng/subscriptions", "organizations_url": "https://api.github.com/users/edwin0cheng/orgs", "repos_url": "https://api.github.com/users/edwin0cheng/repos", "events_url": "https://api.github.com/users/edwin0cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/edwin0cheng/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1a29934c37cf4ffa2b269c39a25245e58d3916d5", "url": "https://api.github.com/repos/rust-lang/rust/commits/1a29934c37cf4ffa2b269c39a25245e58d3916d5", "html_url": "https://github.com/rust-lang/rust/commit/1a29934c37cf4ffa2b269c39a25245e58d3916d5"}], "stats": {"total": 13, "additions": 8, "deletions": 5}, "files": [{"sha": "27b2ac777aefb79c4df6b3504a95d55ab05ceacc", "filename": "crates/mbe/src/mbe_expander/transcriber.rs", "status": "modified", "additions": 4, "deletions": 5, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/74a24adc8ecc8bded9d24ccede171da188696122/crates%2Fmbe%2Fsrc%2Fmbe_expander%2Ftranscriber.rs", "raw_url": "https://github.com/rust-lang/rust/raw/74a24adc8ecc8bded9d24ccede171da188696122/crates%2Fmbe%2Fsrc%2Fmbe_expander%2Ftranscriber.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fmbe%2Fsrc%2Fmbe_expander%2Ftranscriber.rs?ref=74a24adc8ecc8bded9d24ccede171da188696122", "patch": "@@ -119,11 +119,10 @@ fn expand_subtree(\n }\n \n fn expand_var(ctx: &mut ExpandCtx, v: &SmolStr, id: tt::TokenId) -> ExpandResult<Fragment> {\n-    if v == \"crate\" {\n-        // We simply produce identifier `$crate` here. And it will be resolved when lowering ast to Path.\n-        let tt = tt::Leaf::from(tt::Ident { text: \"$crate\".into(), id }).into();\n-        ExpandResult::ok(Fragment::Tokens(tt))\n-    } else if !ctx.bindings.contains(v) {\n+    // We already handle $crate case in mbe parser\n+    debug_assert!(v != \"crate\");\n+\n+    if !ctx.bindings.contains(v) {\n         // Note that it is possible to have a `$var` inside a macro which is not bound.\n         // For example:\n         // ```"}, {"sha": "f3047972dd2dfddab938839431fb932076138b33", "filename": "crates/mbe/src/parser.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/74a24adc8ecc8bded9d24ccede171da188696122/crates%2Fmbe%2Fsrc%2Fparser.rs", "raw_url": "https://github.com/rust-lang/rust/raw/74a24adc8ecc8bded9d24ccede171da188696122/crates%2Fmbe%2Fsrc%2Fparser.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fmbe%2Fsrc%2Fparser.rs?ref=74a24adc8ecc8bded9d24ccede171da188696122", "patch": "@@ -109,6 +109,10 @@ fn next_op<'a>(first: &tt::TokenTree, src: &mut TtIter<'a>, mode: Mode) -> Resul\n                         let id = punct.id;\n                         Op::Var { name, kind, id }\n                     }\n+                    tt::Leaf::Ident(ident) if ident.text == \"crate\" => {\n+                        // We simply produce identifier `$crate` here. And it will be resolved when lowering ast to Path.\n+                        Op::Leaf(tt::Leaf::from(tt::Ident { text: \"$crate\".into(), id: ident.id }))\n+                    }\n                     tt::Leaf::Ident(ident) => {\n                         let name = ident.text.clone();\n                         let kind = eat_fragment_kind(src, mode)?;"}]}