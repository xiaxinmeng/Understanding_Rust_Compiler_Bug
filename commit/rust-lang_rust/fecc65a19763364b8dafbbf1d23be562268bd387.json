{"sha": "fecc65a19763364b8dafbbf1d23be562268bd387", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZlY2M2NWExOTc2MzM2NGI4ZGFmYmJmMWQyM2JlNTYyMjY4YmQzODc=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-06-29T02:48:08Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-06-29T02:48:08Z"}, "message": "Auto merge of #86446 - Smittyvb:rustc_insignificant_dtor-ice, r=Mark-Simulacrum\n\nDon't make `rustc_insignificant_dtor` feature gate\n\nThis isn't a feature gate, it's an attribute that is feature gated behind the `rustc_attrs` attribute. Closes #85680.", "tree": {"sha": "e9fe3e3dc3f6361c311e3fd7ad79dc5c7a39fa08", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e9fe3e3dc3f6361c311e3fd7ad79dc5c7a39fa08"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fecc65a19763364b8dafbbf1d23be562268bd387", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fecc65a19763364b8dafbbf1d23be562268bd387", "html_url": "https://github.com/rust-lang/rust/commit/fecc65a19763364b8dafbbf1d23be562268bd387", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fecc65a19763364b8dafbbf1d23be562268bd387/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1ea0e283b4949a9a600824813f8b934d6d7c4cf5", "url": "https://api.github.com/repos/rust-lang/rust/commits/1ea0e283b4949a9a600824813f8b934d6d7c4cf5", "html_url": "https://github.com/rust-lang/rust/commit/1ea0e283b4949a9a600824813f8b934d6d7c4cf5"}, {"sha": "7a51cf118650aa737e7aa20aeab1377aac4866c4", "url": "https://api.github.com/repos/rust-lang/rust/commits/7a51cf118650aa737e7aa20aeab1377aac4866c4", "html_url": "https://github.com/rust-lang/rust/commit/7a51cf118650aa737e7aa20aeab1377aac4866c4"}], "stats": {"total": 89, "additions": 43, "deletions": 46}, "files": [{"sha": "f045a75cdc890a8c98184819597e878742f00e37", "filename": "compiler/rustc_feature/src/active.rs", "status": "modified", "additions": 40, "deletions": 44, "changes": 84, "blob_url": "https://github.com/rust-lang/rust/blob/fecc65a19763364b8dafbbf1d23be562268bd387/compiler%2Frustc_feature%2Fsrc%2Factive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fecc65a19763364b8dafbbf1d23be562268bd387/compiler%2Frustc_feature%2Fsrc%2Factive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_feature%2Fsrc%2Factive.rs?ref=fecc65a19763364b8dafbbf1d23be562268bd387", "patch": "@@ -16,8 +16,14 @@ macro_rules! set {\n }\n \n macro_rules! declare_features {\n+    (__status_to_bool active) => {\n+        false\n+    };\n+    (__status_to_bool incomplete) => {\n+        true\n+    };\n     ($(\n-        $(#[doc = $doc:tt])* (active, $feature:ident, $ver:expr, $issue:expr, $edition:expr),\n+        $(#[doc = $doc:tt])* ($status:ident, $feature:ident, $ver:expr, $issue:expr, $edition:expr),\n     )+) => {\n         /// Represents active features that are currently being implemented or\n         /// currently being considered for addition/removal.\n@@ -67,6 +73,21 @@ macro_rules! declare_features {\n             pub fn unordered_const_ty_params(&self) -> bool {\n                 self.const_generics || self.const_generics_defaults\n             }\n+\n+            /// Some features are known to be incomplete and using them is likely to have\n+            /// unanticipated results, such as compiler crashes. We warn the user about these\n+            /// to alert them.\n+            pub fn incomplete(&self, feature: Symbol) -> bool {\n+                match feature {\n+                    $(\n+                        sym::$feature => declare_features!(__status_to_bool $status),\n+                    )*\n+                    // accepted and removed features aren't in this file but are never incomplete\n+                    _ if self.declared_lang_features.iter().any(|f| f.0 == feature) => false,\n+                    _ if self.declared_lib_features.iter().any(|f| f.0 == feature) => false,\n+                    _ => panic!(\"`{}` was not listed in `declare_features`\", feature),\n+                }\n+            }\n         }\n     };\n }\n@@ -305,7 +326,7 @@ declare_features! (\n     (active, cfg_target_thread_local, \"1.7.0\", Some(29594), None),\n \n     /// Allows specialization of implementations (RFC 1210).\n-    (active, specialization, \"1.7.0\", Some(31844), None),\n+    (incomplete, specialization, \"1.7.0\", Some(31844), None),\n \n     /// A minimal, sound subset of specialization intended to be used by the\n     /// standard library until the soundness issues with specialization\n@@ -342,7 +363,7 @@ declare_features! (\n     (active, abi_ptx, \"1.15.0\", Some(38788), None),\n \n     /// Allows the `#[repr(i128)]` attribute for enums.\n-    (active, repr128, \"1.16.0\", Some(56071), None),\n+    (incomplete, repr128, \"1.16.0\", Some(56071), None),\n \n     /// Allows `#[link(kind=\"static-nobundle\"...)]`.\n     (active, static_nobundle, \"1.16.0\", Some(37403), None),\n@@ -384,7 +405,7 @@ declare_features! (\n     (active, in_band_lifetimes, \"1.23.0\", Some(44524), None),\n \n     /// Allows associated types to be generic, e.g., `type Foo<T>;` (RFC 1598).\n-    (active, generic_associated_types, \"1.23.0\", Some(44265), None),\n+    (incomplete, generic_associated_types, \"1.23.0\", Some(44265), None),\n \n     /// Allows defining `trait X = A + B;` alias items.\n     (active, trait_alias, \"1.24.0\", Some(41517), None),\n@@ -429,7 +450,7 @@ declare_features! (\n     (active, proc_macro_hygiene, \"1.30.0\", Some(54727), None),\n \n     /// Allows unsized rvalues at arguments and parameters.\n-    (active, unsized_locals, \"1.30.0\", Some(48055), None),\n+    (incomplete, unsized_locals, \"1.30.0\", Some(48055), None),\n \n     /// Allows custom test frameworks with `#![test_runner]` and `#[test_case]`.\n     (active, custom_test_frameworks, \"1.30.0\", Some(50297), None),\n@@ -438,7 +459,7 @@ declare_features! (\n     (active, custom_inner_attributes, \"1.30.0\", Some(54726), None),\n \n     /// Allows `impl Trait` in bindings (`let`, `const`, `static`).\n-    (active, impl_trait_in_bindings, \"1.30.0\", Some(63065), None),\n+    (incomplete, impl_trait_in_bindings, \"1.30.0\", Some(63065), None),\n \n     /// Allows using `reason` in lint attributes and the `#[expect(lint)]` lint check.\n     (active, lint_reasons, \"1.31.0\", Some(54503), None),\n@@ -450,7 +471,7 @@ declare_features! (\n     (active, ffi_returns_twice, \"1.34.0\", Some(58314), None),\n \n     /// Allows const generic types (e.g. `struct Foo<const N: usize>(...);`).\n-    (active, const_generics, \"1.34.0\", Some(44580), None),\n+    (incomplete, const_generics, \"1.34.0\", Some(44580), None),\n \n     /// Allows using `#[optimize(X)]`.\n     (active, optimize_attribute, \"1.34.0\", Some(54882), None),\n@@ -462,7 +483,7 @@ declare_features! (\n     (active, associated_type_bounds, \"1.34.0\", Some(52662), None),\n \n     /// Allows `if/while p && let q = r && ...` chains.\n-    (active, let_chains, \"1.37.0\", Some(53667), None),\n+    (incomplete, let_chains, \"1.37.0\", Some(53667), None),\n \n     /// Allows #[repr(transparent)] on unions (RFC 2645).\n     (active, transparent_unions, \"1.37.0\", Some(60405), None),\n@@ -474,13 +495,13 @@ declare_features! (\n     (active, async_closure, \"1.37.0\", Some(62290), None),\n \n     /// Allows `impl Trait` to be used inside type aliases (RFC 2515).\n-    (active, type_alias_impl_trait, \"1.38.0\", Some(63063), None),\n+    (incomplete, type_alias_impl_trait, \"1.38.0\", Some(63063), None),\n \n     /// Allows the definition of `const extern fn` and `const unsafe extern fn`.\n     (active, const_extern_fn, \"1.40.0\", Some(64926), None),\n \n     /// Allows the use of raw-dylibs (RFC 2627).\n-    (active, raw_dylib, \"1.40.0\", Some(58713), None),\n+    (incomplete, raw_dylib, \"1.40.0\", Some(58713), None),\n \n     /// Allows making `dyn Trait` well-formed even if `Trait` is not object safe.\n     /// In that case, `dyn Trait: Trait` does not hold. Moreover, coercions and\n@@ -516,10 +537,10 @@ declare_features! (\n     (active, bindings_after_at, \"1.41.0\", Some(65490), None),\n \n     /// Allows `impl const Trait for T` syntax.\n-    (active, const_trait_impl, \"1.42.0\", Some(67792), None),\n+    (incomplete, const_trait_impl, \"1.42.0\", Some(67792), None),\n \n     /// Allows `T: ?const Trait` syntax in bounds.\n-    (active, const_trait_bound_opt_out, \"1.42.0\", Some(67794), None),\n+    (incomplete, const_trait_bound_opt_out, \"1.42.0\", Some(67794), None),\n \n     /// Allows the use of `no_sanitize` attribute.\n     (active, no_sanitize, \"1.42.0\", Some(39699), None),\n@@ -552,16 +573,16 @@ declare_features! (\n     (active, format_args_capture, \"1.46.0\", Some(67984), None),\n \n     /// Lazily evaluate constants. This allows constants to depend on type parameters.\n-    (active, lazy_normalization_consts, \"1.46.0\", Some(72219), None),\n+    (incomplete, lazy_normalization_consts, \"1.46.0\", Some(72219), None),\n \n     /// Allows calling `transmute` in const fn\n     (active, const_fn_transmute, \"1.46.0\", Some(53605), None),\n \n     /// Allows `if let` guard in match arms.\n-    (active, if_let_guard, \"1.47.0\", Some(51114), None),\n+    (incomplete, if_let_guard, \"1.47.0\", Some(51114), None),\n \n     /// Allows non-trivial generic constants which have to be manually propagated upwards.\n-    (active, const_evaluatable_checked, \"1.48.0\", Some(76560), None),\n+    (incomplete, const_evaluatable_checked, \"1.48.0\", Some(76560), None),\n \n     /// Allows basic arithmetic on floating point types in a `const fn`.\n     (active, const_fn_floating_point_arithmetic, \"1.48.0\", Some(57241), None),\n@@ -582,7 +603,7 @@ declare_features! (\n     (active, isa_attribute, \"1.48.0\", Some(74727), None),\n \n     /// Allow anonymous constants from an inline `const` block\n-    (active, inline_const, \"1.49.0\", Some(76001), None),\n+    (incomplete, inline_const, \"1.49.0\", Some(76001), None),\n \n     /// Allows unsized fn parameters.\n     (active, unsized_fn_params, \"1.49.0\", Some(48055), None),\n@@ -594,7 +615,7 @@ declare_features! (\n     (active, cfg_panic, \"1.49.0\", Some(77443), None),\n \n     /// Allows capturing disjoint fields in a closure/generator (RFC 2229).\n-    (active, capture_disjoint_fields, \"1.49.0\", Some(53488), None),\n+    (incomplete, capture_disjoint_fields, \"1.49.0\", Some(53488), None),\n \n     /// Allows const generics to have default values (e.g. `struct Foo<const N: usize = 3>(...);`).\n     (active, const_generics_defaults, \"1.51.0\", Some(44580), None),\n@@ -618,7 +639,7 @@ declare_features! (\n     (active, min_type_alias_impl_trait, \"1.52.0\", Some(63063), None),\n \n     /// Allows associated types in inherent impls.\n-    (active, inherent_associated_types, \"1.52.0\", Some(8995), None),\n+    (incomplete, inherent_associated_types, \"1.52.0\", Some(8995), None),\n \n     // Allows setting the threshold for the `large_assignments` lint.\n     (active, large_assignments, \"1.52.0\", Some(83518), None),\n@@ -661,7 +682,7 @@ declare_features! (\n     (active, native_link_modifiers_as_needed, \"1.53.0\", Some(81490), None),\n \n     /// Allows unnamed fields of struct and union type\n-    (active, unnamed_fields, \"1.53.0\", Some(49804), None),\n+    (incomplete, unnamed_fields, \"1.53.0\", Some(49804), None),\n \n     /// Allows qualified paths in struct expressions, struct patterns and tuple struct patterns.\n     (active, more_qualified_paths, \"1.54.0\", Some(80080), None),\n@@ -671,31 +692,6 @@ declare_features! (\n     // -------------------------------------------------------------------------\n );\n \n-/// Some features are known to be incomplete and using them is likely to have\n-/// unanticipated results, such as compiler crashes. We warn the user about these\n-/// to alert them.\n-pub const INCOMPLETE_FEATURES: &[Symbol] = &[\n-    sym::if_let_guard,\n-    sym::impl_trait_in_bindings,\n-    sym::generic_associated_types,\n-    sym::const_generics,\n-    sym::let_chains,\n-    sym::raw_dylib,\n-    sym::const_evaluatable_checked,\n-    sym::const_trait_impl,\n-    sym::const_trait_bound_opt_out,\n-    sym::lazy_normalization_consts,\n-    sym::specialization,\n-    sym::inline_const,\n-    sym::repr128,\n-    sym::unsized_locals,\n-    sym::capture_disjoint_fields,\n-    sym::inherent_associated_types,\n-    sym::type_alias_impl_trait,\n-    sym::rustc_insignificant_dtor,\n-    sym::unnamed_fields,\n-];\n-\n /// Some features are not allowed to be used together at the same time, if\n /// the two are present, produce an error.\n ///"}, {"sha": "cf102aa16e0571ffbf89dbbb64ced39c99282ebf", "filename": "compiler/rustc_feature/src/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/fecc65a19763364b8dafbbf1d23be562268bd387/compiler%2Frustc_feature%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fecc65a19763364b8dafbbf1d23be562268bd387/compiler%2Frustc_feature%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_feature%2Fsrc%2Flib.rs?ref=fecc65a19763364b8dafbbf1d23be562268bd387", "patch": "@@ -146,7 +146,7 @@ pub fn find_feature_issue(feature: Symbol, issue: GateIssue) -> Option<NonZeroU3\n }\n \n pub use accepted::ACCEPTED_FEATURES;\n-pub use active::{Features, ACTIVE_FEATURES, INCOMPATIBLE_FEATURES, INCOMPLETE_FEATURES};\n+pub use active::{Features, ACTIVE_FEATURES, INCOMPATIBLE_FEATURES};\n pub use builtin_attrs::{\n     deprecated_attributes, find_gated_cfg, is_builtin_attr_name, AttributeGate, AttributeTemplate,\n     AttributeType, BuiltinAttribute, GatedCfg, BUILTIN_ATTRIBUTES, BUILTIN_ATTRIBUTE_MAP,"}, {"sha": "d7d0c978ca42d61cea5e61be400bfe7a898765c1", "filename": "compiler/rustc_lint/src/builtin.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/fecc65a19763364b8dafbbf1d23be562268bd387/compiler%2Frustc_lint%2Fsrc%2Fbuiltin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fecc65a19763364b8dafbbf1d23be562268bd387/compiler%2Frustc_lint%2Fsrc%2Fbuiltin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_lint%2Fsrc%2Fbuiltin.rs?ref=fecc65a19763364b8dafbbf1d23be562268bd387", "patch": "@@ -2327,7 +2327,7 @@ impl EarlyLintPass for IncompleteFeatures {\n             .iter()\n             .map(|(name, span, _)| (name, span))\n             .chain(features.declared_lib_features.iter().map(|(name, span)| (name, span)))\n-            .filter(|(name, _)| rustc_feature::INCOMPLETE_FEATURES.iter().any(|f| name == &f))\n+            .filter(|(&name, _)| features.incomplete(name))\n             .for_each(|(&name, &span)| {\n                 cx.struct_span_lint(INCOMPLETE_FEATURES, span, |lint| {\n                     let mut builder = lint.build(&format!("}, {"sha": "338dfd11310aaa0e17d14ac63ef5b115dc00ceff", "filename": "src/tools/tidy/src/features.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/fecc65a19763364b8dafbbf1d23be562268bd387/src%2Ftools%2Ftidy%2Fsrc%2Ffeatures.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fecc65a19763364b8dafbbf1d23be562268bd387/src%2Ftools%2Ftidy%2Fsrc%2Ffeatures.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Ffeatures.rs?ref=fecc65a19763364b8dafbbf1d23be562268bd387", "patch": "@@ -301,6 +301,7 @@ fn collect_lang_features_in(base: &Path, file: &str, bad: &mut bool) -> Features\n             let mut parts = line.split(',');\n             let level = match parts.next().map(|l| l.trim().trim_start_matches('(')) {\n                 Some(\"active\") => Status::Unstable,\n+                Some(\"incomplete\") => Status::Unstable,\n                 Some(\"removed\") => Status::Removed,\n                 Some(\"accepted\") => Status::Stable,\n                 _ => return None,"}]}