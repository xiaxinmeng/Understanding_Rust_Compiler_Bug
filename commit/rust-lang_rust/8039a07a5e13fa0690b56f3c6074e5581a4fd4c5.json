{"sha": "8039a07a5e13fa0690b56f3c6074e5581a4fd4c5", "node_id": "C_kwDOAAsO6NoAKDgwMzlhMDdhNWUxM2ZhMDY5MGI1NmYzYzYwNzRlNTU4MWE0ZmQ0YzU", "commit": {"author": {"name": "Emilio Cobos \u00c1lvarez", "email": "emilio@crisal.io", "date": "2022-10-22T13:10:03Z"}, "committer": {"name": "Emilio Cobos \u00c1lvarez", "email": "emilio@crisal.io", "date": "2022-10-22T17:33:47Z"}, "message": "ide: Generate monikers for local crates.", "tree": {"sha": "213a3f1b9352192f395f45f91d397ef398934275", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/213a3f1b9352192f395f45f91d397ef398934275"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8039a07a5e13fa0690b56f3c6074e5581a4fd4c5", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE53alAzPAxlP8it4A4RUtCZTkv4oFAmNUKXsACgkQ4RUtCZTk\nv4o1qg//VA/EP635gfajNit6hYwjVGcFfapl3ibLmA9lwyy6zr4r9hb2hopzOqTa\nSH89eL0y1jq+D8jHdpOOsNxOqke7SeoxJte6h8izX5L38vGCybi3PcnNZ4vGHu1G\nqlHQkqefokqg9rcXlo00iC77jZJ6N2UusYjSTjabFlFZIPi/8ay/B7y28YLlETwc\nQ2itKfNqD+Wv5FcKRZQOlmtcqb9tcUyYXhTHr29hcqiE6IUg3YkTqvWTbiFk4CBt\nrxt2wgzq4lTOqwJ2F6ptGhWG1PbT5vAcyN3H2yyUTe0YWWRj8sktFzMYQf0mx5cA\nOIkyNNPl0Z6z9J92wQqtAJP2RrmaEDV7bhiqFQmLoUERZKNFB5Mi0FM/7cd7L1Ks\nitkzxC6u5vItaWgpZCnNI64CiMkHzcMtlLJh1SUDf0/IfVzgQVMr0JovcE8qhPuF\nUAcLdQrCFRy82ShUZ7GFrXIqvb55tY8wgwbe7zp6kv/c9EQyPdr/dde/pXmdXS7S\nUcwaqQnE8zkToNh6hJe/Ft0HnNRMO/3WqlhGBNd/tovDZ/RPG5oG5tVp01Vo25vW\nhAbfuIiXoZoYm/egsLXwhHK9Yzvx2JQCTyuq+IGqYhxWCm6/R0w34zaCo+yRvQxV\nE+nYhqmT1DE6D/xVNPkcJ/KRSPSqt/pwe0Agbsalfmou0w0Oazs=\n=PQNU\n-----END PGP SIGNATURE-----", "payload": "tree 213a3f1b9352192f395f45f91d397ef398934275\nparent 19efa0b1103287ad521c0036c065ea2ebbe5939d\nauthor Emilio Cobos \u00c1lvarez <emilio@crisal.io> 1666444203 +0200\ncommitter Emilio Cobos \u00c1lvarez <emilio@crisal.io> 1666460027 +0200\n\nide: Generate monikers for local crates.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8039a07a5e13fa0690b56f3c6074e5581a4fd4c5", "html_url": "https://github.com/rust-lang/rust/commit/8039a07a5e13fa0690b56f3c6074e5581a4fd4c5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8039a07a5e13fa0690b56f3c6074e5581a4fd4c5/comments", "author": {"login": "emilio", "id": 1323194, "node_id": "MDQ6VXNlcjEzMjMxOTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1323194?v=4", "gravatar_id": "", "url": "https://api.github.com/users/emilio", "html_url": "https://github.com/emilio", "followers_url": "https://api.github.com/users/emilio/followers", "following_url": "https://api.github.com/users/emilio/following{/other_user}", "gists_url": "https://api.github.com/users/emilio/gists{/gist_id}", "starred_url": "https://api.github.com/users/emilio/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/emilio/subscriptions", "organizations_url": "https://api.github.com/users/emilio/orgs", "repos_url": "https://api.github.com/users/emilio/repos", "events_url": "https://api.github.com/users/emilio/events{/privacy}", "received_events_url": "https://api.github.com/users/emilio/received_events", "type": "User", "site_admin": false}, "committer": {"login": "emilio", "id": 1323194, "node_id": "MDQ6VXNlcjEzMjMxOTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1323194?v=4", "gravatar_id": "", "url": "https://api.github.com/users/emilio", "html_url": "https://github.com/emilio", "followers_url": "https://api.github.com/users/emilio/followers", "following_url": "https://api.github.com/users/emilio/following{/other_user}", "gists_url": "https://api.github.com/users/emilio/gists{/gist_id}", "starred_url": "https://api.github.com/users/emilio/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/emilio/subscriptions", "organizations_url": "https://api.github.com/users/emilio/orgs", "repos_url": "https://api.github.com/users/emilio/repos", "events_url": "https://api.github.com/users/emilio/events{/privacy}", "received_events_url": "https://api.github.com/users/emilio/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "19efa0b1103287ad521c0036c065ea2ebbe5939d", "url": "https://api.github.com/repos/rust-lang/rust/commits/19efa0b1103287ad521c0036c065ea2ebbe5939d", "html_url": "https://github.com/rust-lang/rust/commit/19efa0b1103287ad521c0036c065ea2ebbe5939d"}], "stats": {"total": 74, "additions": 56, "deletions": 18}, "files": [{"sha": "07d117aff10bd8fa9bbdc3dff5ee5aaed8e38153", "filename": "crates/ide/src/moniker.rs", "status": "modified", "additions": 14, "deletions": 14, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/8039a07a5e13fa0690b56f3c6074e5581a4fd4c5/crates%2Fide%2Fsrc%2Fmoniker.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8039a07a5e13fa0690b56f3c6074e5581a4fd4c5/crates%2Fide%2Fsrc%2Fmoniker.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fmoniker.rs?ref=8039a07a5e13fa0690b56f3c6074e5581a4fd4c5", "patch": "@@ -73,8 +73,8 @@ impl MonikerResult {\n #[derive(Debug, Clone, PartialEq, Eq, Hash)]\n pub struct PackageInformation {\n     pub name: String,\n-    pub repo: String,\n-    pub version: String,\n+    pub repo: Option<String>,\n+    pub version: Option<String>,\n }\n \n pub(crate) fn crate_for_file(db: &RootDatabase, file_id: FileId) -> Option<Crate> {\n@@ -256,18 +256,18 @@ pub(crate) fn def_to_moniker(\n             let (name, repo, version) = match krate.origin(db) {\n                 CrateOrigin::CratesIo { repo, name } => (\n                     name.unwrap_or(krate.display_name(db)?.canonical_name().to_string()),\n-                    repo?,\n-                    krate.version(db)?,\n+                    repo,\n+                    krate.version(db),\n                 ),\n                 CrateOrigin::Lang(lang) => (\n                     krate.display_name(db)?.canonical_name().to_string(),\n-                    \"https://github.com/rust-lang/rust/\".to_string(),\n-                    match lang {\n+                    Some(\"https://github.com/rust-lang/rust/\".to_string()),\n+                    Some(match lang {\n                         LangCrateOrigin::Other => {\n                             \"https://github.com/rust-lang/rust/library/\".into()\n                         }\n                         lang => format!(\"https://github.com/rust-lang/rust/library/{lang}\",),\n-                    },\n+                    }),\n                 ),\n             };\n             PackageInformation { name, repo, version }\n@@ -315,7 +315,7 @@ pub mod module {\n }\n \"#,\n             \"foo::module::func\",\n-            r#\"PackageInformation { name: \"foo\", repo: \"https://a.b/foo.git\", version: \"0.1.0\" }\"#,\n+            r#\"PackageInformation { name: \"foo\", repo: Some(\"https://a.b/foo.git\"), version: Some(\"0.1.0\") }\"#,\n             MonikerKind::Import,\n         );\n         check_moniker(\n@@ -331,7 +331,7 @@ pub mod module {\n }\n \"#,\n             \"foo::module::func\",\n-            r#\"PackageInformation { name: \"foo\", repo: \"https://a.b/foo.git\", version: \"0.1.0\" }\"#,\n+            r#\"PackageInformation { name: \"foo\", repo: Some(\"https://a.b/foo.git\"), version: Some(\"0.1.0\") }\"#,\n             MonikerKind::Export,\n         );\n     }\n@@ -348,7 +348,7 @@ pub mod module {\n }\n \"#,\n             \"foo::module::MyTrait::func\",\n-            r#\"PackageInformation { name: \"foo\", repo: \"https://a.b/foo.git\", version: \"0.1.0\" }\"#,\n+            r#\"PackageInformation { name: \"foo\", repo: Some(\"https://a.b/foo.git\"), version: Some(\"0.1.0\") }\"#,\n             MonikerKind::Export,\n         );\n     }\n@@ -365,7 +365,7 @@ pub mod module {\n }\n \"#,\n             \"foo::module::MyTrait::MY_CONST\",\n-            r#\"PackageInformation { name: \"foo\", repo: \"https://a.b/foo.git\", version: \"0.1.0\" }\"#,\n+            r#\"PackageInformation { name: \"foo\", repo: Some(\"https://a.b/foo.git\"), version: Some(\"0.1.0\") }\"#,\n             MonikerKind::Export,\n         );\n     }\n@@ -382,7 +382,7 @@ pub mod module {\n }\n \"#,\n             \"foo::module::MyTrait::MyType\",\n-            r#\"PackageInformation { name: \"foo\", repo: \"https://a.b/foo.git\", version: \"0.1.0\" }\"#,\n+            r#\"PackageInformation { name: \"foo\", repo: Some(\"https://a.b/foo.git\"), version: Some(\"0.1.0\") }\"#,\n             MonikerKind::Export,\n         );\n     }\n@@ -405,7 +405,7 @@ pub mod module {\n }\n \"#,\n             \"foo::module::MyStruct::MyTrait::func\",\n-            r#\"PackageInformation { name: \"foo\", repo: \"https://a.b/foo.git\", version: \"0.1.0\" }\"#,\n+            r#\"PackageInformation { name: \"foo\", repo: Some(\"https://a.b/foo.git\"), version: Some(\"0.1.0\") }\"#,\n             MonikerKind::Export,\n         );\n     }\n@@ -425,7 +425,7 @@ pub struct St {\n }\n \"#,\n             \"foo::St::a\",\n-            r#\"PackageInformation { name: \"foo\", repo: \"https://a.b/foo.git\", version: \"0.1.0\" }\"#,\n+            r#\"PackageInformation { name: \"foo\", repo: Some(\"https://a.b/foo.git\"), version: Some(\"0.1.0\") }\"#,\n             MonikerKind::Import,\n         );\n     }"}, {"sha": "76abe6589807544d2af1244cb47770e8825996cc", "filename": "crates/rust-analyzer/src/cli/lsif.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/8039a07a5e13fa0690b56f3c6074e5581a4fd4c5/crates%2Frust-analyzer%2Fsrc%2Fcli%2Flsif.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8039a07a5e13fa0690b56f3c6074e5581a4fd4c5/crates%2Frust-analyzer%2Fsrc%2Fcli%2Flsif.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fcli%2Flsif.rs?ref=8039a07a5e13fa0690b56f3c6074e5581a4fd4c5", "patch": "@@ -106,12 +106,12 @@ impl LsifManager<'_> {\n                 manager: \"cargo\".to_string(),\n                 uri: None,\n                 content: None,\n-                repository: Some(lsif::Repository {\n-                    url: pi.repo,\n+                repository: pi.repo.map(|url| lsif::Repository {\n+                    url,\n                     r#type: \"git\".to_string(),\n                     commit_id: None,\n                 }),\n-                version: Some(pi.version),\n+                version: pi.version,\n             }));\n         self.package_map.insert(package_information, result_set_id);\n         result_set_id"}, {"sha": "b03f085d692e6ebd58614897164945c805baebc6", "filename": "crates/rust-analyzer/src/cli/scip.rs", "status": "modified", "additions": 39, "deletions": 1, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/8039a07a5e13fa0690b56f3c6074e5581a4fd4c5/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fscip.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8039a07a5e13fa0690b56f3c6074e5581a4fd4c5/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fscip.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fscip.rs?ref=8039a07a5e13fa0690b56f3c6074e5581a4fd4c5", "patch": "@@ -231,7 +231,7 @@ fn token_to_symbol(token: &TokenStaticData) -> Option<scip_types::Symbol> {\n         package: Some(scip_types::Package {\n             manager: \"cargo\".to_string(),\n             name: package_name,\n-            version,\n+            version: version.unwrap_or_else(|| \".\".to_string()),\n             ..Default::default()\n         })\n         .into(),\n@@ -415,4 +415,42 @@ pub mod module {\n             \"\",\n         );\n     }\n+\n+    #[test]\n+    fn global_symbol_for_pub_struct() {\n+        check_symbol(\n+            r#\"\n+    //- /lib.rs crate:main\n+    mod foo;\n+\n+    fn main() {\n+        let _bar = foo::Bar { i: 0 };\n+    }\n+    //- /foo.rs\n+    pub struct Bar$0 {\n+        pub i: i32,\n+    }\n+    \"#,\n+            \"rust-analyzer cargo main . foo/Bar#\",\n+        );\n+    }\n+\n+    #[test]\n+    fn global_symbol_for_pub_struct_reference() {\n+        check_symbol(\n+            r#\"\n+    //- /lib.rs crate:main\n+    mod foo;\n+\n+    fn main() {\n+        let _bar = foo::Bar$0 { i: 0 };\n+    }\n+    //- /foo.rs\n+    pub struct Bar {\n+        pub i: i32,\n+    }\n+    \"#,\n+            \"rust-analyzer cargo main . foo/Bar#\",\n+        );\n+    }\n }"}]}