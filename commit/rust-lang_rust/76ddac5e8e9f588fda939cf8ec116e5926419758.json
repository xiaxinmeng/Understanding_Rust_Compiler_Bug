{"sha": "76ddac5e8e9f588fda939cf8ec116e5926419758", "node_id": "MDY6Q29tbWl0NzI0NzEyOjc2ZGRhYzVlOGU5ZjU4OGZkYTkzOWNmOGVjMTE2ZTU5MjY0MTk3NTg=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-05-02T16:13:02Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-05-02T16:13:02Z"}, "message": "Auto merge of #5560 - CrazyRoka:fix-match-on-vector-full-range, r=phansch,flip1995\n\nFix match on vec items: match on vec[..]\n\n- Added new tests\n- Fixed false positive when matching on full range, which will never panic\n\nCloses #5551\nchangelog: fix match_on_vec_items when matching full range", "tree": {"sha": "d0ec8c063f1d4e1d8edce03847324d6510395f4d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d0ec8c063f1d4e1d8edce03847324d6510395f4d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/76ddac5e8e9f588fda939cf8ec116e5926419758", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/76ddac5e8e9f588fda939cf8ec116e5926419758", "html_url": "https://github.com/rust-lang/rust/commit/76ddac5e8e9f588fda939cf8ec116e5926419758", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/76ddac5e8e9f588fda939cf8ec116e5926419758/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "75a717159d33037915f16932967b997f4fbd1dcc", "url": "https://api.github.com/repos/rust-lang/rust/commits/75a717159d33037915f16932967b997f4fbd1dcc", "html_url": "https://github.com/rust-lang/rust/commit/75a717159d33037915f16932967b997f4fbd1dcc"}, {"sha": "de58c5644de0d9ffe46e7e2923d2301eaf4dd347", "url": "https://api.github.com/repos/rust-lang/rust/commits/de58c5644de0d9ffe46e7e2923d2301eaf4dd347", "html_url": "https://github.com/rust-lang/rust/commit/de58c5644de0d9ffe46e7e2923d2301eaf4dd347"}], "stats": {"total": 45, "additions": 39, "deletions": 6}, "files": [{"sha": "ee69628e9f05224953a8e9d3680f83c263efe6ef", "filename": "clippy_lints/src/match_on_vec_items.rs", "status": "modified", "additions": 16, "deletions": 5, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/76ddac5e8e9f588fda939cf8ec116e5926419758/clippy_lints%2Fsrc%2Fmatch_on_vec_items.rs", "raw_url": "https://github.com/rust-lang/rust/raw/76ddac5e8e9f588fda939cf8ec116e5926419758/clippy_lints%2Fsrc%2Fmatch_on_vec_items.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmatch_on_vec_items.rs?ref=76ddac5e8e9f588fda939cf8ec116e5926419758", "patch": "@@ -1,4 +1,4 @@\n-use crate::utils::{is_type_diagnostic_item, snippet, span_lint_and_sugg, walk_ptrs_ty};\n+use crate::utils::{self, is_type_diagnostic_item, match_type, snippet, span_lint_and_sugg, walk_ptrs_ty};\n use if_chain::if_chain;\n use rustc_errors::Applicability;\n use rustc_hir::{Expr, ExprKind, MatchSource};\n@@ -75,10 +75,9 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for MatchOnVecItems {\n \n fn is_vec_indexing<'a, 'tcx>(cx: &LateContext<'a, 'tcx>, expr: &'tcx Expr<'tcx>) -> Option<&'tcx Expr<'tcx>> {\n     if_chain! {\n-        if let ExprKind::Index(ref array, _) = expr.kind;\n-        let ty = cx.tables.expr_ty(array);\n-        let ty = walk_ptrs_ty(ty);\n-        if is_type_diagnostic_item(cx, ty, sym!(vec_type));\n+        if let ExprKind::Index(ref array, ref index) = expr.kind;\n+        if is_vector(cx, array);\n+        if !is_full_range(cx, index);\n \n         then {\n             return Some(expr);\n@@ -87,3 +86,15 @@ fn is_vec_indexing<'a, 'tcx>(cx: &LateContext<'a, 'tcx>, expr: &'tcx Expr<'tcx>)\n \n     None\n }\n+\n+fn is_vector(cx: &LateContext<'_, '_>, expr: &Expr<'_>) -> bool {\n+    let ty = cx.tables.expr_ty(expr);\n+    let ty = walk_ptrs_ty(ty);\n+    is_type_diagnostic_item(cx, ty, sym!(vec_type))\n+}\n+\n+fn is_full_range(cx: &LateContext<'_, '_>, expr: &Expr<'_>) -> bool {\n+    let ty = cx.tables.expr_ty(expr);\n+    let ty = walk_ptrs_ty(ty);\n+    match_type(cx, ty, &utils::paths::RANGE_FULL)\n+}"}, {"sha": "79ca6845c6f2e8845169be7f7be569e3897b1870", "filename": "clippy_lints/src/utils/paths.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/76ddac5e8e9f588fda939cf8ec116e5926419758/clippy_lints%2Fsrc%2Futils%2Fpaths.rs", "raw_url": "https://github.com/rust-lang/rust/raw/76ddac5e8e9f588fda939cf8ec116e5926419758/clippy_lints%2Fsrc%2Futils%2Fpaths.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Futils%2Fpaths.rs?ref=76ddac5e8e9f588fda939cf8ec116e5926419758", "patch": "@@ -85,7 +85,7 @@ pub const RANGE: [&str; 3] = [\"core\", \"ops\", \"Range\"];\n pub const RANGE_ARGUMENT_TRAIT: [&str; 3] = [\"core\", \"ops\", \"RangeBounds\"];\n pub const RANGE_FROM: [&str; 3] = [\"core\", \"ops\", \"RangeFrom\"];\n pub const RANGE_FROM_STD: [&str; 3] = [\"std\", \"ops\", \"RangeFrom\"];\n-pub const RANGE_FULL: [&str; 3] = [\"core\", \"ops\", \"RangeFull\"];\n+pub const RANGE_FULL: [&str; 4] = [\"core\", \"ops\", \"range\", \"RangeFull\"];\n pub const RANGE_FULL_STD: [&str; 3] = [\"std\", \"ops\", \"RangeFull\"];\n pub const RANGE_INCLUSIVE_NEW: [&str; 4] = [\"core\", \"ops\", \"RangeInclusive\", \"new\"];\n pub const RANGE_INCLUSIVE_STD_NEW: [&str; 4] = [\"std\", \"ops\", \"RangeInclusive\", \"new\"];"}, {"sha": "30415e3b94dc4b1e95458eba5473d2cc8f4f7da1", "filename": "tests/ui/match_on_vec_items.rs", "status": "modified", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/76ddac5e8e9f588fda939cf8ec116e5926419758/tests%2Fui%2Fmatch_on_vec_items.rs", "raw_url": "https://github.com/rust-lang/rust/raw/76ddac5e8e9f588fda939cf8ec116e5926419758/tests%2Fui%2Fmatch_on_vec_items.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmatch_on_vec_items.rs?ref=76ddac5e8e9f588fda939cf8ec116e5926419758", "patch": "@@ -120,11 +120,33 @@ fn match_with_array() {\n     }\n }\n \n+fn match_with_endless_range() {\n+    let arr = vec![0, 1, 2, 3];\n+    let range = ..;\n+\n+    // Ok\n+    match arr[range] {\n+        [0, 1] => println!(\"0 1\"),\n+        [1, 2] => println!(\"1 2\"),\n+        [0, 1, 2, 3] => println!(\"0, 1, 2, 3\"),\n+        _ => {},\n+    }\n+\n+    // Ok\n+    match arr[..] {\n+        [0, 1] => println!(\"0 1\"),\n+        [1, 2] => println!(\"1 2\"),\n+        [0, 1, 2, 3] => println!(\"0, 1, 2, 3\"),\n+        _ => {},\n+    }\n+}\n+\n fn main() {\n     match_with_wildcard();\n     match_without_wildcard();\n     match_wildcard_and_action();\n     match_vec_ref();\n     match_with_get();\n     match_with_array();\n+    match_with_endless_range();\n }"}]}