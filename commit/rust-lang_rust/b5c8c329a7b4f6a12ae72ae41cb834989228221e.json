{"sha": "b5c8c329a7b4f6a12ae72ae41cb834989228221e", "node_id": "C_kwDOAAsO6NoAKGI1YzhjMzI5YTdiNGY2YTEyYWU3MmFlNDFjYjgzNDk4OTIyODIyMWU", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-02-17T08:23:53Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-02-17T08:23:53Z"}, "message": "Auto merge of #108058 - Zoxc:query-ctxtx-byval, r=cjgillot\n\nPass `DepContext` and `QueryContext` by value when practical\n\nThis removes some indirections for a minor performance improvement.\n\n<table><tr><td rowspan=\"2\">Benchmark</td><td colspan=\"1\"><b>Before</b></th><td colspan=\"2\"><b>After</b></th></tr><tr><td align=\"right\">Time</td><td align=\"right\">Time</td><td align=\"right\">%</th></tr><tr><td>\ud83d\udfe3 <b>clap</b>:check</td><td align=\"right\">1.8294s</td><td align=\"right\">1.8255s</td><td align=\"right\"> -0.21%</td></tr><tr><td>\ud83d\udfe3 <b>hyper</b>:check</td><td align=\"right\">0.2667s</td><td align=\"right\">0.2669s</td><td align=\"right\"> 0.07%</td></tr><tr><td>\ud83d\udfe3 <b>regex</b>:check</td><td align=\"right\">1.0080s</td><td align=\"right\">1.0063s</td><td align=\"right\"> -0.17%</td></tr><tr><td>\ud83d\udfe3 <b>syn</b>:check</td><td align=\"right\">1.6335s</td><td align=\"right\">1.6295s</td><td align=\"right\"> -0.24%</td></tr><tr><td>\ud83d\udfe3 <b>syntex_syntax</b>:check</td><td align=\"right\">6.3633s</td><td align=\"right\">6.3344s</td><td align=\"right\"> -0.45%</td></tr><tr><td>Total</td><td align=\"right\">11.1009s</td><td align=\"right\">11.0627s</td><td align=\"right\"> -0.34%</td></tr><tr><td>Summary</td><td align=\"right\">1.0000s</td><td align=\"right\">0.9980s</td><td align=\"right\"> -0.20%</td></tr></table>", "tree": {"sha": "429198cc4648d1b6bf6e671f1524bc5bb15a94ff", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/429198cc4648d1b6bf6e671f1524bc5bb15a94ff"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b5c8c329a7b4f6a12ae72ae41cb834989228221e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b5c8c329a7b4f6a12ae72ae41cb834989228221e", "html_url": "https://github.com/rust-lang/rust/commit/b5c8c329a7b4f6a12ae72ae41cb834989228221e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b5c8c329a7b4f6a12ae72ae41cb834989228221e/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9556b56dbdbd4238f0051e7230004b0aa488fa14", "url": "https://api.github.com/repos/rust-lang/rust/commits/9556b56dbdbd4238f0051e7230004b0aa488fa14", "html_url": "https://github.com/rust-lang/rust/commit/9556b56dbdbd4238f0051e7230004b0aa488fa14"}, {"sha": "b3a4fe7d4ebf58cccd43d536992cefbee5dc2988", "url": "https://api.github.com/repos/rust-lang/rust/commits/b3a4fe7d4ebf58cccd43d536992cefbee5dc2988", "html_url": "https://github.com/rust-lang/rust/commit/b3a4fe7d4ebf58cccd43d536992cefbee5dc2988"}], "stats": {"total": 52, "additions": 26, "deletions": 26}, "files": [{"sha": "84510fe218cf5a4ba2171d28a55b9bfc29b35fcc", "filename": "compiler/rustc_middle/src/dep_graph/mod.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b5c8c329a7b4f6a12ae72ae41cb834989228221e/compiler%2Frustc_middle%2Fsrc%2Fdep_graph%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b5c8c329a7b4f6a12ae72ae41cb834989228221e/compiler%2Frustc_middle%2Fsrc%2Fdep_graph%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fdep_graph%2Fmod.rs?ref=b5c8c329a7b4f6a12ae72ae41cb834989228221e", "patch": "@@ -74,8 +74,8 @@ impl<'tcx> DepContext for TyCtxt<'tcx> {\n     type DepKind = DepKind;\n \n     #[inline]\n-    fn with_stable_hashing_context<R>(&self, f: impl FnOnce(StableHashingContext<'_>) -> R) -> R {\n-        TyCtxt::with_stable_hashing_context(*self, f)\n+    fn with_stable_hashing_context<R>(self, f: impl FnOnce(StableHashingContext<'_>) -> R) -> R {\n+        TyCtxt::with_stable_hashing_context(self, f)\n     }\n \n     #[inline]"}, {"sha": "e2884f2026eb0c1fd36edd0c3cd5fa7521a867a9", "filename": "compiler/rustc_query_impl/src/plumbing.rs", "status": "modified", "additions": 13, "deletions": 13, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/b5c8c329a7b4f6a12ae72ae41cb834989228221e/compiler%2Frustc_query_impl%2Fsrc%2Fplumbing.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b5c8c329a7b4f6a12ae72ae41cb834989228221e/compiler%2Frustc_query_impl%2Fsrc%2Fplumbing.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_query_impl%2Fsrc%2Fplumbing.rs?ref=b5c8c329a7b4f6a12ae72ae41cb834989228221e", "patch": "@@ -53,7 +53,7 @@ impl<'tcx> HasDepContext for QueryCtxt<'tcx> {\n }\n \n impl QueryContext for QueryCtxt<'_> {\n-    fn next_job_id(&self) -> QueryJobId {\n+    fn next_job_id(self) -> QueryJobId {\n         QueryJobId(\n             NonZeroU64::new(\n                 self.queries.jobs.fetch_add(1, rustc_data_structures::sync::Ordering::Relaxed),\n@@ -62,31 +62,31 @@ impl QueryContext for QueryCtxt<'_> {\n         )\n     }\n \n-    fn current_query_job(&self) -> Option<QueryJobId> {\n-        tls::with_related_context(**self, |icx| icx.query)\n+    fn current_query_job(self) -> Option<QueryJobId> {\n+        tls::with_related_context(*self, |icx| icx.query)\n     }\n \n-    fn try_collect_active_jobs(&self) -> Option<QueryMap<DepKind>> {\n-        self.queries.try_collect_active_jobs(**self)\n+    fn try_collect_active_jobs(self) -> Option<QueryMap<DepKind>> {\n+        self.queries.try_collect_active_jobs(*self)\n     }\n \n     // Interactions with on_disk_cache\n-    fn load_side_effects(&self, prev_dep_node_index: SerializedDepNodeIndex) -> QuerySideEffects {\n+    fn load_side_effects(self, prev_dep_node_index: SerializedDepNodeIndex) -> QuerySideEffects {\n         self.queries\n             .on_disk_cache\n             .as_ref()\n-            .map(|c| c.load_side_effects(**self, prev_dep_node_index))\n+            .map(|c| c.load_side_effects(*self, prev_dep_node_index))\n             .unwrap_or_default()\n     }\n \n-    fn store_side_effects(&self, dep_node_index: DepNodeIndex, side_effects: QuerySideEffects) {\n+    fn store_side_effects(self, dep_node_index: DepNodeIndex, side_effects: QuerySideEffects) {\n         if let Some(c) = self.queries.on_disk_cache.as_ref() {\n             c.store_side_effects(dep_node_index, side_effects)\n         }\n     }\n \n     fn store_side_effects_for_anon_node(\n-        &self,\n+        self,\n         dep_node_index: DepNodeIndex,\n         side_effects: QuerySideEffects,\n     ) {\n@@ -100,7 +100,7 @@ impl QueryContext for QueryCtxt<'_> {\n     /// captured during execution and the actual result.\n     #[inline(always)]\n     fn start_query<R>(\n-        &self,\n+        self,\n         token: QueryJobId,\n         depth_limit: bool,\n         diagnostics: Option<&Lock<ThinVec<Diagnostic>>>,\n@@ -109,14 +109,14 @@ impl QueryContext for QueryCtxt<'_> {\n         // The `TyCtxt` stored in TLS has the same global interner lifetime\n         // as `self`, so we use `with_related_context` to relate the 'tcx lifetimes\n         // when accessing the `ImplicitCtxt`.\n-        tls::with_related_context(**self, move |current_icx| {\n+        tls::with_related_context(*self, move |current_icx| {\n             if depth_limit && !self.recursion_limit().value_within_limit(current_icx.query_depth) {\n                 self.depth_limit_error(token);\n             }\n \n             // Update the `ImplicitCtxt` to point to our new query job.\n             let new_icx = ImplicitCtxt {\n-                tcx: **self,\n+                tcx: *self,\n                 query: Some(token),\n                 diagnostics,\n                 query_depth: current_icx.query_depth + depth_limit as usize,\n@@ -130,7 +130,7 @@ impl QueryContext for QueryCtxt<'_> {\n         })\n     }\n \n-    fn depth_limit_error(&self, job: QueryJobId) {\n+    fn depth_limit_error(self, job: QueryJobId) {\n         let mut span = None;\n         let mut layout_of_depth = None;\n         if let Some(map) = self.try_collect_active_jobs() {"}, {"sha": "6969f2dbef8b821a125c88fea022029d900a28b8", "filename": "compiler/rustc_query_system/src/dep_graph/mod.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/b5c8c329a7b4f6a12ae72ae41cb834989228221e/compiler%2Frustc_query_system%2Fsrc%2Fdep_graph%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b5c8c329a7b4f6a12ae72ae41cb834989228221e/compiler%2Frustc_query_system%2Fsrc%2Fdep_graph%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_query_system%2Fsrc%2Fdep_graph%2Fmod.rs?ref=b5c8c329a7b4f6a12ae72ae41cb834989228221e", "patch": "@@ -23,7 +23,7 @@ pub trait DepContext: Copy {\n     type DepKind: self::DepKind;\n \n     /// Create a hashing context for hashing new results.\n-    fn with_stable_hashing_context<R>(&self, f: impl FnOnce(StableHashingContext<'_>) -> R) -> R;\n+    fn with_stable_hashing_context<R>(self, f: impl FnOnce(StableHashingContext<'_>) -> R) -> R;\n \n     /// Access the DepGraph.\n     fn dep_graph(&self) -> &DepGraph<Self::DepKind>;\n@@ -37,7 +37,7 @@ pub trait DepContext: Copy {\n     fn dep_kind_info(&self, dep_node: Self::DepKind) -> &DepKindStruct<Self>;\n \n     #[inline(always)]\n-    fn fingerprint_style(&self, kind: Self::DepKind) -> FingerprintStyle {\n+    fn fingerprint_style(self, kind: Self::DepKind) -> FingerprintStyle {\n         let data = self.dep_kind_info(kind);\n         if data.is_anon {\n             return FingerprintStyle::Opaque;\n@@ -47,7 +47,7 @@ pub trait DepContext: Copy {\n \n     #[inline(always)]\n     /// Return whether this kind always require evaluation.\n-    fn is_eval_always(&self, kind: Self::DepKind) -> bool {\n+    fn is_eval_always(self, kind: Self::DepKind) -> bool {\n         self.dep_kind_info(kind).is_eval_always\n     }\n "}, {"sha": "383c63cd2f8a75b500247eead1a9714524d4e52e", "filename": "compiler/rustc_query_system/src/query/mod.rs", "status": "modified", "additions": 8, "deletions": 8, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/b5c8c329a7b4f6a12ae72ae41cb834989228221e/compiler%2Frustc_query_system%2Fsrc%2Fquery%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b5c8c329a7b4f6a12ae72ae41cb834989228221e/compiler%2Frustc_query_system%2Fsrc%2Fquery%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_query_system%2Fsrc%2Fquery%2Fmod.rs?ref=b5c8c329a7b4f6a12ae72ae41cb834989228221e", "patch": "@@ -101,22 +101,22 @@ impl QuerySideEffects {\n }\n \n pub trait QueryContext: HasDepContext {\n-    fn next_job_id(&self) -> QueryJobId;\n+    fn next_job_id(self) -> QueryJobId;\n \n     /// Get the query information from the TLS context.\n-    fn current_query_job(&self) -> Option<QueryJobId>;\n+    fn current_query_job(self) -> Option<QueryJobId>;\n \n-    fn try_collect_active_jobs(&self) -> Option<QueryMap<Self::DepKind>>;\n+    fn try_collect_active_jobs(self) -> Option<QueryMap<Self::DepKind>>;\n \n     /// Load side effects associated to the node in the previous session.\n-    fn load_side_effects(&self, prev_dep_node_index: SerializedDepNodeIndex) -> QuerySideEffects;\n+    fn load_side_effects(self, prev_dep_node_index: SerializedDepNodeIndex) -> QuerySideEffects;\n \n     /// Register diagnostics for the given node, for use in next session.\n-    fn store_side_effects(&self, dep_node_index: DepNodeIndex, side_effects: QuerySideEffects);\n+    fn store_side_effects(self, dep_node_index: DepNodeIndex, side_effects: QuerySideEffects);\n \n     /// Register diagnostics for the given node, for use in next session.\n     fn store_side_effects_for_anon_node(\n-        &self,\n+        self,\n         dep_node_index: DepNodeIndex,\n         side_effects: QuerySideEffects,\n     );\n@@ -125,12 +125,12 @@ pub trait QueryContext: HasDepContext {\n     /// new query job while it executes. It returns the diagnostics\n     /// captured during execution and the actual result.\n     fn start_query<R>(\n-        &self,\n+        self,\n         token: QueryJobId,\n         depth_limit: bool,\n         diagnostics: Option<&Lock<ThinVec<Diagnostic>>>,\n         compute: impl FnOnce() -> R,\n     ) -> R;\n \n-    fn depth_limit_error(&self, job: QueryJobId);\n+    fn depth_limit_error(self, job: QueryJobId);\n }"}]}