{"sha": "6b05b80690fe6548b49da46f85b9ec7b1ea95e7e", "node_id": "C_kwDOAAsO6NoAKDZiMDViODA2OTBmZTY1NDhiNDlkYTQ2Zjg1YjllYzdiMWVhOTVlN2U", "commit": {"author": {"name": "\u8bb8\u6770\u53cb Jieyou Xu (Joe)", "email": "jieyouxu@outlook.com", "date": "2023-02-05T06:22:41Z"}, "committer": {"name": "\u8bb8\u6770\u53cb Jieyou Xu (Joe)", "email": "jieyouxu@outlook.com", "date": "2023-02-06T05:02:04Z"}, "message": "Suggest return type for async function without return type", "tree": {"sha": "69b0a84b7212e8c46dfdc23844306bd3fa14db1d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/69b0a84b7212e8c46dfdc23844306bd3fa14db1d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6b05b80690fe6548b49da46f85b9ec7b1ea95e7e", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEze4qXcfh0ileWqZTxf1dMgFP20cFAmPgidMACgkQxf1dMgFP\n20eaeA/+MU7Fs4DKCMN6inQ3d3oosAcIc6aLEXoop0qta44aSaqvrTqJkaymuJXn\nYncJ6bwOSrilgKZQYxG3eJq/8hIznSKIqO+mPGHPYrkXjeiajoP7zdLtlpo42ho2\njVlJzpA/JQ/0WGscii8W32qakemrmwRO1svo4bsWQGeP7f/rM89syZtcPlb9gHX0\noy0AWahzOOBMin6PMC+7Ag0Qh6HTehHkKqu/sMt4c33UiPHxrk6ICJ6YiYbeETAy\njti4ADxNFMcvIqr/vqoCbWXZXcJrdphKr9SfD0aodHDpnt0MFWMOBjug40qcqqZz\nFjhWjtmCAOW3c+NZthPXI48SHVumopoGentb4i3wBvf/5Zcq5iwnlKxnEuAjnBUm\nz1SH94vM8aP0YTO0xcg9zP9wwWwtHImvrSGoWBeML48bMc5I7g9zqVyNUSMKafDZ\nutIS22fz5fS5bZ3D9yoz2syoxw3UqMfUl79YGyw7HS+sL8zp07hVgHAltMZHHT8+\n8te1HC1tequ9Bic1tF356frzpk0HllKa1juooZRCxBW2QJDZkb5rO950YeYnq4KL\ndRRsec356QKwAr765E468yFSG0K+C7Wfn+pOoFz1keQJMEg+G/1BF0xTrLSxxUuG\nxFqGNEs43kUFAT9fCzfLoGZFiNEB4zeO/lFkrM5PQme4IujY6Ko=\n=Ohi5\n-----END PGP SIGNATURE-----", "payload": "tree 69b0a84b7212e8c46dfdc23844306bd3fa14db1d\nparent 50d3ba5bcbf5c7e13d4ce068d3339710701dd603\nauthor \u8bb8\u6770\u53cb Jieyou Xu (Joe) <jieyouxu@outlook.com> 1675578161 +0800\ncommitter \u8bb8\u6770\u53cb Jieyou Xu (Joe) <jieyouxu@outlook.com> 1675659724 +0800\n\nSuggest return type for async function without return type\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6b05b80690fe6548b49da46f85b9ec7b1ea95e7e", "html_url": "https://github.com/rust-lang/rust/commit/6b05b80690fe6548b49da46f85b9ec7b1ea95e7e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6b05b80690fe6548b49da46f85b9ec7b1ea95e7e/comments", "author": {"login": "jieyouxu", "id": 39484203, "node_id": "MDQ6VXNlcjM5NDg0MjAz", "avatar_url": "https://avatars.githubusercontent.com/u/39484203?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jieyouxu", "html_url": "https://github.com/jieyouxu", "followers_url": "https://api.github.com/users/jieyouxu/followers", "following_url": "https://api.github.com/users/jieyouxu/following{/other_user}", "gists_url": "https://api.github.com/users/jieyouxu/gists{/gist_id}", "starred_url": "https://api.github.com/users/jieyouxu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jieyouxu/subscriptions", "organizations_url": "https://api.github.com/users/jieyouxu/orgs", "repos_url": "https://api.github.com/users/jieyouxu/repos", "events_url": "https://api.github.com/users/jieyouxu/events{/privacy}", "received_events_url": "https://api.github.com/users/jieyouxu/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jieyouxu", "id": 39484203, "node_id": "MDQ6VXNlcjM5NDg0MjAz", "avatar_url": "https://avatars.githubusercontent.com/u/39484203?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jieyouxu", "html_url": "https://github.com/jieyouxu", "followers_url": "https://api.github.com/users/jieyouxu/followers", "following_url": "https://api.github.com/users/jieyouxu/following{/other_user}", "gists_url": "https://api.github.com/users/jieyouxu/gists{/gist_id}", "starred_url": "https://api.github.com/users/jieyouxu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jieyouxu/subscriptions", "organizations_url": "https://api.github.com/users/jieyouxu/orgs", "repos_url": "https://api.github.com/users/jieyouxu/repos", "events_url": "https://api.github.com/users/jieyouxu/events{/privacy}", "received_events_url": "https://api.github.com/users/jieyouxu/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "50d3ba5bcbf5c7e13d4ce068d3339710701dd603", "url": "https://api.github.com/repos/rust-lang/rust/commits/50d3ba5bcbf5c7e13d4ce068d3339710701dd603", "html_url": "https://github.com/rust-lang/rust/commit/50d3ba5bcbf5c7e13d4ce068d3339710701dd603"}], "stats": {"total": 103, "additions": 102, "deletions": 1}, "files": [{"sha": "e84b3de124c58070388d3b741de2630569a215ff", "filename": "compiler/rustc_hir_typeck/src/fn_ctxt/_impl.rs", "status": "modified", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/6b05b80690fe6548b49da46f85b9ec7b1ea95e7e/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2F_impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6b05b80690fe6548b49da46f85b9ec7b1ea95e7e/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2F_impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2F_impl.rs?ref=6b05b80690fe6548b49da46f85b9ec7b1ea95e7e", "patch": "@@ -921,6 +921,22 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                 kind: hir::ImplItemKind::Fn(ref sig, ..),\n                 ..\n             }) => Some((&sig.decl, ident, false)),\n+            Node::Expr(&hir::Expr {\n+                hir_id,\n+                kind: hir::ExprKind::Closure(..),\n+                ..\n+            }) if let Some(Node::Expr(&hir::Expr {\n+                hir_id,\n+                kind: hir::ExprKind::Call(..),\n+                ..\n+            })) = self.tcx.hir().find_parent(hir_id) &&\n+            let Some(Node::Item(&hir::Item {\n+                ident,\n+                kind: hir::ItemKind::Fn(ref sig, ..),\n+                ..\n+            })) = self.tcx.hir().find_parent(hir_id) => {\n+                Some((&sig.decl, ident, ident.name != sym::main))\n+            },\n             _ => None,\n         }\n     }"}, {"sha": "84341e6803312c874196a46507e884682ba0bd72", "filename": "compiler/rustc_hir_typeck/src/fn_ctxt/suggestions.rs", "status": "modified", "additions": 29, "deletions": 1, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/6b05b80690fe6548b49da46f85b9ec7b1ea95e7e/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2Fsuggestions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6b05b80690fe6548b49da46f85b9ec7b1ea95e7e/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2Fsuggestions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2Fsuggestions.rs?ref=6b05b80690fe6548b49da46f85b9ec7b1ea95e7e", "patch": "@@ -704,10 +704,38 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                 }\n             }\n             hir::FnRetTy::Return(ty) => {\n+                let span = ty.span;\n+\n+                if let hir::TyKind::OpaqueDef(item_id, ..) = ty.kind\n+                && let hir::Node::Item(hir::Item {\n+                    kind: hir::ItemKind::OpaqueTy(op_ty),\n+                    ..\n+                }) = self.tcx.hir().get(item_id.hir_id())\n+                && let hir::OpaqueTy {\n+                    bounds: [bound], ..\n+                } = op_ty\n+                && let hir::GenericBound::LangItemTrait(\n+                    hir::LangItem::Future, _, _, generic_args) = bound\n+                && let hir::GenericArgs { bindings: [ty_binding], .. } = generic_args\n+                && let hir::TypeBinding { kind, .. } = ty_binding\n+                && let hir::TypeBindingKind::Equality { term } = kind\n+                && let hir::Term::Ty(term_ty) = term {\n+                    // Check if async function's return type was omitted.\n+                    // Don't emit suggestions if the found type is `impl Future<...>`.\n+                    debug!(\"suggest_missing_return_type: found = {:?}\", found);\n+                    if found.is_suggestable(self.tcx, false) {\n+                        if term_ty.span.is_empty() {\n+                            err.subdiagnostic(AddReturnTypeSuggestion::Add { span, found: found.to_string() });\n+                            return true;\n+                        } else {\n+                            err.subdiagnostic(ExpectedReturnTypeLabel::Other { span, expected });\n+                        }\n+                    }\n+                }\n+\n                 // Only point to return type if the expected type is the return type, as if they\n                 // are not, the expectation must have been caused by something else.\n                 debug!(\"suggest_missing_return_type: return type {:?} node {:?}\", ty, ty.kind);\n-                let span = ty.span;\n                 let ty = self.astconv().ast_ty_to_ty(ty);\n                 debug!(\"suggest_missing_return_type: return type {:?}\", ty);\n                 debug!(\"suggest_missing_return_type: expected type {:?}\", ty);"}, {"sha": "8ccb15ca48a4fc8777a50d9c0d66e63c0de626b7", "filename": "tests/ui/typeck/issue-90027-async-fn-return-suggestion.rs", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/6b05b80690fe6548b49da46f85b9ec7b1ea95e7e/tests%2Fui%2Ftypeck%2Fissue-90027-async-fn-return-suggestion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6b05b80690fe6548b49da46f85b9ec7b1ea95e7e/tests%2Fui%2Ftypeck%2Fissue-90027-async-fn-return-suggestion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ftypeck%2Fissue-90027-async-fn-return-suggestion.rs?ref=6b05b80690fe6548b49da46f85b9ec7b1ea95e7e", "patch": "@@ -0,0 +1,21 @@\n+// edition:2018\n+\n+async fn hello() { //~ HELP try adding a return type\n+    0\n+    //~^ ERROR [E0308]\n+}\n+\n+async fn world() -> () {\n+    0\n+    //~^ ERROR [E0308]\n+}\n+\n+async fn suggest_await_in_async_fn_return() {\n+    hello()\n+    //~^ ERROR mismatched types [E0308]\n+    //~| HELP consider `await`ing on the `Future`\n+    //~| HELP consider using a semicolon here\n+    //~| SUGGESTION .await\n+}\n+\n+fn main() {}"}, {"sha": "6a1a9f45bc62b1846dffc5b74e0eaf7a19e7d0cb", "filename": "tests/ui/typeck/issue-90027-async-fn-return-suggestion.stderr", "status": "added", "additions": 36, "deletions": 0, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/6b05b80690fe6548b49da46f85b9ec7b1ea95e7e/tests%2Fui%2Ftypeck%2Fissue-90027-async-fn-return-suggestion.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/6b05b80690fe6548b49da46f85b9ec7b1ea95e7e/tests%2Fui%2Ftypeck%2Fissue-90027-async-fn-return-suggestion.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ftypeck%2Fissue-90027-async-fn-return-suggestion.stderr?ref=6b05b80690fe6548b49da46f85b9ec7b1ea95e7e", "patch": "@@ -0,0 +1,36 @@\n+error[E0308]: mismatched types\n+  --> $DIR/issue-90027-async-fn-return-suggestion.rs:4:5\n+   |\n+LL | async fn hello() {\n+   |                  - help: try adding a return type: `-> i32`\n+LL |     0\n+   |     ^ expected `()`, found integer\n+\n+error[E0308]: mismatched types\n+  --> $DIR/issue-90027-async-fn-return-suggestion.rs:9:5\n+   |\n+LL | async fn world() -> () {\n+   |                     -- expected `()` because of return type\n+LL |     0\n+   |     ^ expected `()`, found integer\n+\n+error[E0308]: mismatched types\n+  --> $DIR/issue-90027-async-fn-return-suggestion.rs:14:5\n+   |\n+LL |     hello()\n+   |     ^^^^^^^ expected `()`, found opaque type\n+   |\n+   = note: expected unit type `()`\n+            found opaque type `impl Future<Output = ()>`\n+help: consider `await`ing on the `Future`\n+   |\n+LL |     hello().await\n+   |            ++++++\n+help: consider using a semicolon here\n+   |\n+LL |     hello();\n+   |            +\n+\n+error: aborting due to 3 previous errors\n+\n+For more information about this error, try `rustc --explain E0308`."}]}