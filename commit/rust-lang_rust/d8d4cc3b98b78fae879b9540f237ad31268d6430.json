{"sha": "d8d4cc3b98b78fae879b9540f237ad31268d6430", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ4ZDRjYzNiOThiNzhmYWU4NzliOTU0MGYyMzdhZDMxMjY4ZDY0MzA=", "commit": {"author": {"name": "Deadbeef", "email": "ent3rm4n@gmail.com", "date": "2021-07-06T05:05:24Z"}, "committer": {"name": "Deadbeef", "email": "ent3rm4n@gmail.com", "date": "2021-07-10T12:54:48Z"}, "message": "Treat trait fns marked with the attr as const", "tree": {"sha": "577458c82caa58fd62ae092f9538df4fa65a20f3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/577458c82caa58fd62ae092f9538df4fa65a20f3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d8d4cc3b98b78fae879b9540f237ad31268d6430", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEjbeLZzPb62/vY3smZSV3NIU3bZIFAmDpmJgACgkQZSV3NIU3\nbZIooBAAvCMOV/rF/aAHHUc33aYC61/thSvFaZRdNmvKurZyHr9LsGWwFfvAGigg\n2SpOZV1Jmt3PCcMb4Kfmxw8aUt1lDotoySJg/Ho5nVZxuPsrclQdfWRZcHLJyfCZ\nT6bVTY+T3lV3xl6ehyheUmLjmSsrVxj+MKPDyx7FbkrhzIclZTYmNaIPbUKI+/tu\nzk1oylbHED1acjF3ARoDAzt61j7/RTb3Mx26GCQnElL8DQIqp/whFykgM6t9oS1T\n9+qtNzVTwV46lKBkcPnp/bl9dUZOFMF+xCdpfjnJFqXxNlthJW9Jed/lmkcNv3nk\n86a15KTQpyEjlg5Ouhmry6STTAkyWgof904JqqOwVh/FYrFTbmn1Pz5pT4y+AGCi\nzTHuXShZj5LkPxW8dBszyB8NcALdlQ+0HbqzzfBU49m3weNPaFFKHWlQOPw0Yca5\nQQJmTFqtlqFCghX7aI6SLiweX5yU6Nc6aFGWXpsZb9Xkh2ozHcdEUmiskAG14UYQ\naOUuzDxNmcsY4AnZ+s+PHWbq6/C3RBr9rOoFLO8IuGawbBqf5nWmQfygjqRKj1n+\nZLY9q3zDqfv+0d0nQB32hlU0BqTk/srsP+n8a9Lqa2sbWkzrz2d9P3zY3QmYUaNZ\njN+kX8MGLa57fWcon4QGEEnoMb3ul7pWw7NjkzK+b/BwppRNBnY=\n=yONd\n-----END PGP SIGNATURE-----", "payload": "tree 577458c82caa58fd62ae092f9538df4fa65a20f3\nparent 3660a4e97259a23b9a24c30aa097932ae6f0eb18\nauthor Deadbeef <ent3rm4n@gmail.com> 1625547924 +0800\ncommitter Deadbeef <ent3rm4n@gmail.com> 1625921688 +0800\n\nTreat trait fns marked with the attr as const\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d8d4cc3b98b78fae879b9540f237ad31268d6430", "html_url": "https://github.com/rust-lang/rust/commit/d8d4cc3b98b78fae879b9540f237ad31268d6430", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d8d4cc3b98b78fae879b9540f237ad31268d6430/comments", "author": {"login": "fee1-dead", "id": 43851243, "node_id": "MDQ6VXNlcjQzODUxMjQz", "avatar_url": "https://avatars.githubusercontent.com/u/43851243?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fee1-dead", "html_url": "https://github.com/fee1-dead", "followers_url": "https://api.github.com/users/fee1-dead/followers", "following_url": "https://api.github.com/users/fee1-dead/following{/other_user}", "gists_url": "https://api.github.com/users/fee1-dead/gists{/gist_id}", "starred_url": "https://api.github.com/users/fee1-dead/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fee1-dead/subscriptions", "organizations_url": "https://api.github.com/users/fee1-dead/orgs", "repos_url": "https://api.github.com/users/fee1-dead/repos", "events_url": "https://api.github.com/users/fee1-dead/events{/privacy}", "received_events_url": "https://api.github.com/users/fee1-dead/received_events", "type": "User", "site_admin": false}, "committer": {"login": "fee1-dead", "id": 43851243, "node_id": "MDQ6VXNlcjQzODUxMjQz", "avatar_url": "https://avatars.githubusercontent.com/u/43851243?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fee1-dead", "html_url": "https://github.com/fee1-dead", "followers_url": "https://api.github.com/users/fee1-dead/followers", "following_url": "https://api.github.com/users/fee1-dead/following{/other_user}", "gists_url": "https://api.github.com/users/fee1-dead/gists{/gist_id}", "starred_url": "https://api.github.com/users/fee1-dead/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fee1-dead/subscriptions", "organizations_url": "https://api.github.com/users/fee1-dead/orgs", "repos_url": "https://api.github.com/users/fee1-dead/repos", "events_url": "https://api.github.com/users/fee1-dead/events{/privacy}", "received_events_url": "https://api.github.com/users/fee1-dead/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3660a4e97259a23b9a24c30aa097932ae6f0eb18", "url": "https://api.github.com/repos/rust-lang/rust/commits/3660a4e97259a23b9a24c30aa097932ae6f0eb18", "html_url": "https://github.com/rust-lang/rust/commit/3660a4e97259a23b9a24c30aa097932ae6f0eb18"}], "stats": {"total": 37, "additions": 36, "deletions": 1}, "files": [{"sha": "fc7877b0a0b8e90c313649ed5f508991c7036aa3", "filename": "compiler/rustc_mir/src/const_eval/fn_queries.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/d8d4cc3b98b78fae879b9540f237ad31268d6430/compiler%2Frustc_mir%2Fsrc%2Fconst_eval%2Ffn_queries.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d8d4cc3b98b78fae879b9540f237ad31268d6430/compiler%2Frustc_mir%2Fsrc%2Fconst_eval%2Ffn_queries.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Fconst_eval%2Ffn_queries.rs?ref=d8d4cc3b98b78fae879b9540f237ad31268d6430", "patch": "@@ -3,7 +3,7 @@ use rustc_hir::def_id::{DefId, LocalDefId};\n use rustc_middle::hir::map::blocks::FnLikeNode;\n use rustc_middle::ty::query::Providers;\n use rustc_middle::ty::TyCtxt;\n-use rustc_span::symbol::Symbol;\n+use rustc_span::symbol::{sym, Symbol};\n use rustc_target::spec::abi::Abi;\n \n /// Whether the `def_id` counts as const fn in your current crate, considering all active\n@@ -60,6 +60,9 @@ fn is_const_fn_raw(tcx: TyCtxt<'_>, def_id: DefId) -> bool {\n             return true;\n         }\n \n+        if tcx.has_attr(def_id, sym::default_method_body_is_const) {\n+            return true;\n+        }\n         // If the function itself is not annotated with `const`, it may still be a `const fn`\n         // if it resides in a const trait impl.\n         is_parent_const_impl_raw(tcx, hir_id)"}, {"sha": "bc2fcf81c63e3aec327c20cf1a7a4aa6e53aa538", "filename": "src/test/ui/rfc-2632-const-trait-impl/const-default-method-bodies.rs", "status": "added", "additions": 32, "deletions": 0, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/d8d4cc3b98b78fae879b9540f237ad31268d6430/src%2Ftest%2Fui%2Frfc-2632-const-trait-impl%2Fconst-default-method-bodies.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d8d4cc3b98b78fae879b9540f237ad31268d6430/src%2Ftest%2Fui%2Frfc-2632-const-trait-impl%2Fconst-default-method-bodies.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frfc-2632-const-trait-impl%2Fconst-default-method-bodies.rs?ref=d8d4cc3b98b78fae879b9540f237ad31268d6430", "patch": "@@ -0,0 +1,32 @@\n+// TODO fix this test\n+\n+#![feature(const_trait_impl)]\n+#![allow(incomplete_features)]\n+\n+trait ConstDefaultFn: Sized {\n+    fn b(self);\n+\n+    #[default_method_body_is_const]\n+    fn a(self) {\n+        self.b();\n+    }\n+}\n+\n+struct NonConstImpl;\n+struct ConstImpl;\n+\n+impl ConstDefaultFn for NonConstImpl {\n+    fn b(self) {}\n+}\n+\n+impl const ConstDefaultFn for ConstImpl {\n+    fn b(self) {}\n+}\n+\n+const fn test() {\n+    NonConstImpl.a();\n+    //~^ ERROR calls in constant functions are limited to constant functions, tuple structs and tuple variants\n+    ConstImpl.a();\n+}\n+\n+fn main() {}"}]}