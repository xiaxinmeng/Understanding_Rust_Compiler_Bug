{"sha": "85c749266d1e9a38a9fd9c45ef417d0d464ef634", "node_id": "C_kwDOAAsO6NoAKDg1Yzc0OTI2NmQxZTlhMzhhOWZkOWM0NWVmNDE3ZDBkNDY0ZWY2MzQ", "commit": {"author": {"name": "Nicholas Nethercote", "email": "n.nethercote@gmail.com", "date": "2022-08-11T03:46:26Z"}, "committer": {"name": "Nicholas Nethercote", "email": "n.nethercote@gmail.com", "date": "2022-08-11T03:46:26Z"}, "message": "Add percentages to `-Zhir-stats` output.", "tree": {"sha": "b6fa98852b25b2edb144276feeba6ad3ec1296be", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b6fa98852b25b2edb144276feeba6ad3ec1296be"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/85c749266d1e9a38a9fd9c45ef417d0d464ef634", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/85c749266d1e9a38a9fd9c45ef417d0d464ef634", "html_url": "https://github.com/rust-lang/rust/commit/85c749266d1e9a38a9fd9c45ef417d0d464ef634", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/85c749266d1e9a38a9fd9c45ef417d0d464ef634/comments", "author": {"login": "nnethercote", "id": 1940286, "node_id": "MDQ6VXNlcjE5NDAyODY=", "avatar_url": "https://avatars.githubusercontent.com/u/1940286?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nnethercote", "html_url": "https://github.com/nnethercote", "followers_url": "https://api.github.com/users/nnethercote/followers", "following_url": "https://api.github.com/users/nnethercote/following{/other_user}", "gists_url": "https://api.github.com/users/nnethercote/gists{/gist_id}", "starred_url": "https://api.github.com/users/nnethercote/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nnethercote/subscriptions", "organizations_url": "https://api.github.com/users/nnethercote/orgs", "repos_url": "https://api.github.com/users/nnethercote/repos", "events_url": "https://api.github.com/users/nnethercote/events{/privacy}", "received_events_url": "https://api.github.com/users/nnethercote/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nnethercote", "id": 1940286, "node_id": "MDQ6VXNlcjE5NDAyODY=", "avatar_url": "https://avatars.githubusercontent.com/u/1940286?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nnethercote", "html_url": "https://github.com/nnethercote", "followers_url": "https://api.github.com/users/nnethercote/followers", "following_url": "https://api.github.com/users/nnethercote/following{/other_user}", "gists_url": "https://api.github.com/users/nnethercote/gists{/gist_id}", "starred_url": "https://api.github.com/users/nnethercote/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nnethercote/subscriptions", "organizations_url": "https://api.github.com/users/nnethercote/orgs", "repos_url": "https://api.github.com/users/nnethercote/repos", "events_url": "https://api.github.com/users/nnethercote/events{/privacy}", "received_events_url": "https://api.github.com/users/nnethercote/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6a3c663cbb65b08c7a7356cc3745eb9b75493bc6", "url": "https://api.github.com/repos/rust-lang/rust/commits/6a3c663cbb65b08c7a7356cc3745eb9b75493bc6", "html_url": "https://github.com/rust-lang/rust/commit/6a3c663cbb65b08c7a7356cc3745eb9b75493bc6"}], "stats": {"total": 154, "additions": 78, "deletions": 76}, "files": [{"sha": "0c6c1d1aa2b8eb608496a6244695fd1715edd03d", "filename": "compiler/rustc_passes/src/hir_stats.rs", "status": "modified", "additions": 8, "deletions": 6, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/85c749266d1e9a38a9fd9c45ef417d0d464ef634/compiler%2Frustc_passes%2Fsrc%2Fhir_stats.rs", "raw_url": "https://github.com/rust-lang/rust/raw/85c749266d1e9a38a9fd9c45ef417d0d464ef634/compiler%2Frustc_passes%2Fsrc%2Fhir_stats.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fhir_stats.rs?ref=85c749266d1e9a38a9fd9c45ef417d0d464ef634", "patch": "@@ -86,26 +86,28 @@ impl<'k> StatCollector<'k> {\n \n         stats.sort_by_key(|&(_, ref d)| d.count * d.size);\n \n-        let mut total_size = 0;\n+        let total_size = stats.iter().map(|(_, data)| data.count * data.size).sum();\n \n         eprintln!(\"\\n{}\\n\", title);\n \n         eprintln!(\"{:<18}{:>18}{:>14}{:>14}\", \"Name\", \"Accumulated Size\", \"Count\", \"Item Size\");\n         eprintln!(\"----------------------------------------------------------------\");\n \n+        let percent = |m, n| { (m * 100) as f64 / n as f64 };\n+\n         for (label, data) in stats {\n+            let size = data.count * data.size;\n             eprintln!(\n-                \"{:<18}{:>18}{:>14}{:>14}\",\n+                \"{:<18}{:>10} ({:4.1}%){:>14}{:>14}\",\n                 label,\n-                to_readable_str(data.count * data.size),\n+                to_readable_str(size),\n+                percent(size, total_size),\n                 to_readable_str(data.count),\n                 to_readable_str(data.size)\n             );\n-\n-            total_size += data.count * data.size;\n         }\n         eprintln!(\"----------------------------------------------------------------\");\n-        eprintln!(\"{:<18}{:>18}\\n\", \"Total\", to_readable_str(total_size));\n+        eprintln!(\"{:<18}{:>10}\\n\", \"Total\", to_readable_str(total_size));\n     }\n }\n "}, {"sha": "132fff1972f4f64ac9722c8fc93b9642498d9b3e", "filename": "src/test/ui/stats/hir-stats.stderr", "status": "modified", "additions": 70, "deletions": 70, "changes": 140, "blob_url": "https://github.com/rust-lang/rust/blob/85c749266d1e9a38a9fd9c45ef417d0d464ef634/src%2Ftest%2Fui%2Fstats%2Fhir-stats.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/85c749266d1e9a38a9fd9c45ef417d0d464ef634/src%2Ftest%2Fui%2Fstats%2Fhir-stats.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fstats%2Fhir-stats.stderr?ref=85c749266d1e9a38a9fd9c45ef417d0d464ef634", "patch": "@@ -3,89 +3,89 @@ PRE EXPANSION AST STATS\n \n Name                Accumulated Size         Count     Item Size\n ----------------------------------------------------------------\n-ExprField                         48             1            48\n-GenericArgs                       64             1            64\n-Local                             72             1            72\n-WherePredicate                    72             1            72\n-Crate                             72             1            72\n-Arm                               96             2            48\n-FieldDef                         160             2            80\n-ForeignItem                      160             1           160\n-Stmt                             160             5            32\n-Param                            160             4            40\n-FnDecl                           200             5            40\n-Variant                          240             2           120\n-Block                            288             6            48\n-Attribute                        304             2           152\n-GenericBound                     352             4            88\n-GenericParam                     520             5           104\n-AssocItem                        640             4           160\n-PathSegment                      720            30            24\n-Expr                             832             8           104\n-Pat                              840             7           120\n-Ty                             1_344            14            96\n-Item                           1_800             9           200\n+ExprField                 48 ( 0.5%)             1            48\n+GenericArgs               64 ( 0.7%)             1            64\n+Local                     72 ( 0.8%)             1            72\n+WherePredicate            72 ( 0.8%)             1            72\n+Crate                     72 ( 0.8%)             1            72\n+Arm                       96 ( 1.0%)             2            48\n+FieldDef                 160 ( 1.7%)             2            80\n+ForeignItem              160 ( 1.7%)             1           160\n+Stmt                     160 ( 1.7%)             5            32\n+Param                    160 ( 1.7%)             4            40\n+FnDecl                   200 ( 2.2%)             5            40\n+Variant                  240 ( 2.6%)             2           120\n+Block                    288 ( 3.1%)             6            48\n+Attribute                304 ( 3.3%)             2           152\n+GenericBound             352 ( 3.8%)             4            88\n+GenericParam             520 ( 5.7%)             5           104\n+AssocItem                640 ( 7.0%)             4           160\n+PathSegment              720 ( 7.9%)            30            24\n+Expr                     832 ( 9.1%)             8           104\n+Pat                      840 ( 9.2%)             7           120\n+Ty                     1_344 (14.7%)            14            96\n+Item                   1_800 (19.7%)             9           200\n ----------------------------------------------------------------\n-Total                          9_144\n+Total                  9_144\n \n \n POST EXPANSION AST STATS\n \n Name                Accumulated Size         Count     Item Size\n ----------------------------------------------------------------\n-ExprField                         48             1            48\n-GenericArgs                       64             1            64\n-Local                             72             1            72\n-WherePredicate                    72             1            72\n-Crate                             72             1            72\n-Arm                               96             2            48\n-InlineAsm                        120             1           120\n-FieldDef                         160             2            80\n-ForeignItem                      160             1           160\n-Stmt                             160             5            32\n-Param                            160             4            40\n-FnDecl                           200             5            40\n-Variant                          240             2           120\n-Block                            288             6            48\n-GenericBound                     352             4            88\n-GenericParam                     520             5           104\n-Attribute                        608             4           152\n-AssocItem                        640             4           160\n-PathSegment                      792            33            24\n-Pat                              840             7           120\n-Expr                             936             9           104\n-Ty                             1_344            14            96\n-Item                           2_200            11           200\n+ExprField                 48 ( 0.5%)             1            48\n+GenericArgs               64 ( 0.6%)             1            64\n+Local                     72 ( 0.7%)             1            72\n+WherePredicate            72 ( 0.7%)             1            72\n+Crate                     72 ( 0.7%)             1            72\n+Arm                       96 ( 0.9%)             2            48\n+InlineAsm                120 ( 1.2%)             1           120\n+FieldDef                 160 ( 1.6%)             2            80\n+ForeignItem              160 ( 1.6%)             1           160\n+Stmt                     160 ( 1.6%)             5            32\n+Param                    160 ( 1.6%)             4            40\n+FnDecl                   200 ( 2.0%)             5            40\n+Variant                  240 ( 2.4%)             2           120\n+Block                    288 ( 2.8%)             6            48\n+GenericBound             352 ( 3.5%)             4            88\n+GenericParam             520 ( 5.1%)             5           104\n+Attribute                608 ( 6.0%)             4           152\n+AssocItem                640 ( 6.3%)             4           160\n+PathSegment              792 ( 7.8%)            33            24\n+Pat                      840 ( 8.3%)             7           120\n+Expr                     936 ( 9.2%)             9           104\n+Ty                     1_344 (13.2%)            14            96\n+Item                   2_200 (21.7%)            11           200\n ----------------------------------------------------------------\n-Total                         10_144\n+Total                 10_144\n \n \n HIR STATS\n \n Name                Accumulated Size         Count     Item Size\n ----------------------------------------------------------------\n-Param                             64             2            32\n-Local                             64             1            64\n-ForeignItem                       72             1            72\n-FieldDef                          96             2            48\n-Arm                               96             2            48\n-Stmt                              96             3            32\n-FnDecl                           120             3            40\n-Lifetime                         128             4            32\n-Variant                          160             2            80\n-ImplItem                         176             2            88\n-GenericBound                     192             4            48\n-TraitItem                        192             2            96\n-WherePredicate                   216             3            72\n-Block                            288             6            48\n-QPath                            408            17            24\n-Pat                              440             5            88\n-Attribute                        608             4           152\n-Expr                             672            12            56\n-Item                             960            12            80\n-Ty                             1_152            16            72\n-Path                           1_296            27            48\n-PathSegment                    2_240            40            56\n+Param                     64 ( 0.7%)             2            32\n+Local                     64 ( 0.7%)             1            64\n+ForeignItem               72 ( 0.7%)             1            72\n+FieldDef                  96 ( 1.0%)             2            48\n+Arm                       96 ( 1.0%)             2            48\n+Stmt                      96 ( 1.0%)             3            32\n+FnDecl                   120 ( 1.2%)             3            40\n+Lifetime                 128 ( 1.3%)             4            32\n+Variant                  160 ( 1.6%)             2            80\n+ImplItem                 176 ( 1.8%)             2            88\n+GenericBound             192 ( 2.0%)             4            48\n+TraitItem                192 ( 2.0%)             2            96\n+WherePredicate           216 ( 2.2%)             3            72\n+Block                    288 ( 3.0%)             6            48\n+QPath                    408 ( 4.2%)            17            24\n+Pat                      440 ( 4.5%)             5            88\n+Attribute                608 ( 6.2%)             4           152\n+Expr                     672 ( 6.9%)            12            56\n+Item                     960 ( 9.9%)            12            80\n+Ty                     1_152 (11.8%)            16            72\n+Path                   1_296 (13.3%)            27            48\n+PathSegment            2_240 (23.0%)            40            56\n ----------------------------------------------------------------\n-Total                          9_736\n+Total                  9_736\n "}]}