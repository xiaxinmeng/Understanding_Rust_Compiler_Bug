{"sha": "1b659d69bc0ba7fe534cc26bda8544a558a7d2b2", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFiNjU5ZDY5YmMwYmE3ZmU1MzRjYzI2YmRhODU0NGE1NThhN2QyYjI=", "commit": {"author": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2019-01-25T21:36:50Z"}, "committer": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2019-01-25T22:49:55Z"}, "message": "Address review comments and cleanup code", "tree": {"sha": "c702f5a45edc951a503130163b89f4f1f1fcb0ad", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c702f5a45edc951a503130163b89f4f1f1fcb0ad"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1b659d69bc0ba7fe534cc26bda8544a558a7d2b2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1b659d69bc0ba7fe534cc26bda8544a558a7d2b2", "html_url": "https://github.com/rust-lang/rust/commit/1b659d69bc0ba7fe534cc26bda8544a558a7d2b2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1b659d69bc0ba7fe534cc26bda8544a558a7d2b2/comments", "author": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "committer": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ac4b685650d1ba0a38806ce8f7cbf12e7a00f573", "url": "https://api.github.com/repos/rust-lang/rust/commits/ac4b685650d1ba0a38806ce8f7cbf12e7a00f573", "html_url": "https://github.com/rust-lang/rust/commit/ac4b685650d1ba0a38806ce8f7cbf12e7a00f573"}], "stats": {"total": 121, "additions": 59, "deletions": 62}, "files": [{"sha": "873ace90172602f93b294b5ad075a4e4c4a500b8", "filename": "src/librustc_resolve/lib.rs", "status": "modified", "additions": 45, "deletions": 48, "changes": 93, "blob_url": "https://github.com/rust-lang/rust/blob/1b659d69bc0ba7fe534cc26bda8544a558a7d2b2/src%2Flibrustc_resolve%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1b659d69bc0ba7fe534cc26bda8544a558a7d2b2/src%2Flibrustc_resolve%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Flib.rs?ref=1b659d69bc0ba7fe534cc26bda8544a558a7d2b2", "patch": "@@ -5134,62 +5134,59 @@ impl<'a> Resolver<'a> {\n         );\n \n         // See https://github.com/rust-lang/rust/issues/32354\n-        if old_binding.is_import() || new_binding.is_import() {\n-            let binding = if new_binding.is_import() && !new_binding.span.is_dummy() {\n-                new_binding\n+        let directive = match (&new_binding.kind, &old_binding.kind) {\n+            (NameBindingKind::Import { directive, .. }, _) if !new_binding.span.is_dummy() =>\n+                Some((directive, new_binding.span)),\n+            (_, NameBindingKind::Import { directive, .. }) if !old_binding.span.is_dummy() =>\n+                Some((directive, old_binding.span)),\n+            _ => None,\n+        };\n+        if let Some((directive, binding_span)) = directive {\n+            let suggested_name = if name.as_str().chars().next().unwrap().is_uppercase() {\n+                format!(\"Other{}\", name)\n             } else {\n-                old_binding\n+                format!(\"other_{}\", name)\n             };\n \n-            let cm = self.session.source_map();\n-            let rename_msg = \"you can use `as` to change the binding name of the import\";\n-\n-            if let (\n-                Ok(snippet),\n-                NameBindingKind::Import { directive, ..},\n-                false,\n-                false,\n-            ) = (\n-                cm.span_to_snippet(binding.span),\n-                binding.kind.clone(),\n-                binding.span.is_dummy(),\n-                binding.span.ctxt().outer().expn_info().is_some(),\n-            ) {\n-                let suggested_name = if name.as_str().chars().next().unwrap().is_uppercase() {\n-                    format!(\"Other{}\", name)\n-                } else {\n-                    format!(\"other_{}\", name)\n-                };\n+            let mut suggestion = None;\n+            match directive.subclass {\n+                ImportDirectiveSubclass::SingleImport { type_ns_only: true, .. } =>\n+                    suggestion = Some(format!(\"self as {}\", suggested_name)),\n+                ImportDirectiveSubclass::SingleImport { source, .. } => {\n+                    if let Some(pos) = source.span.hi().0.checked_sub(binding_span.lo().0)\n+                                                         .map(|pos| pos as usize) {\n+                        if let Ok(snippet) = self.session.source_map()\n+                                                         .span_to_snippet(binding_span) {\n+                            if pos <= snippet.len() {\n+                                suggestion = Some(format!(\n+                                    \"{} as {}{}\",\n+                                    &snippet[..pos],\n+                                    suggested_name,\n+                                    if snippet.ends_with(\";\") { \";\" } else { \"\" }\n+                                ))\n+                            }\n+                        }\n+                    }\n+                }\n+                ImportDirectiveSubclass::ExternCrate { source, target, .. } =>\n+                    suggestion = Some(format!(\n+                        \"extern crate {} as {};\",\n+                        source.unwrap_or(target.name),\n+                        suggested_name,\n+                    )),\n+                _ => unreachable!(),\n+            }\n \n+            let rename_msg = \"you can use `as` to change the binding name of the import\";\n+            if let Some(suggestion) = suggestion {\n                 err.span_suggestion_with_applicability(\n-                    binding.span,\n-                    &rename_msg,\n-                    match directive.subclass {\n-                        ImportDirectiveSubclass::SingleImport { type_ns_only: true, .. } =>\n-                            format!(\"self as {}\", suggested_name),\n-                        ImportDirectiveSubclass::SingleImport { source, .. } =>\n-                            format!(\n-                                \"{} as {}{}\",\n-                                &snippet[..((source.span.hi().0 - binding.span.lo().0) as usize)],\n-                                suggested_name,\n-                                if snippet.ends_with(\";\") {\n-                                    \";\"\n-                                } else {\n-                                    \"\"\n-                                }\n-                            ),\n-                        ImportDirectiveSubclass::ExternCrate { source, target, .. } =>\n-                            format!(\n-                                \"extern crate {} as {};\",\n-                                source.unwrap_or(target.name),\n-                                suggested_name,\n-                            ),\n-                        _ => unreachable!(),\n-                    },\n+                    binding_span,\n+                    rename_msg,\n+                    suggestion,\n                     Applicability::MaybeIncorrect,\n                 );\n             } else {\n-                err.span_label(binding.span, rename_msg);\n+                err.span_label(binding_span, rename_msg);\n             }\n         }\n "}, {"sha": "3561c21cc7ee34d4ebc8759d80d88d68691d9a2f", "filename": "src/test/ui/issues/issue-56411.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/1b659d69bc0ba7fe534cc26bda8544a558a7d2b2/src%2Ftest%2Fui%2Fissues%2Fissue-56411.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1b659d69bc0ba7fe534cc26bda8544a558a7d2b2/src%2Ftest%2Fui%2Fissues%2Fissue-56411.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-56411.rs?ref=1b659d69bc0ba7fe534cc26bda8544a558a7d2b2", "patch": "@@ -3,14 +3,14 @@ macro_rules! import {\n         $(\n             mod $name;\n             pub use self::$name;\n-            //~^ ERROR the name `issue_56411` is defined multiple times\n-            //~| ERROR `issue_56411` is private, and cannot be re-exported\n+            //~^ ERROR the name `issue_56411_aux` is defined multiple times\n+            //~| ERROR `issue_56411_aux` is private, and cannot be re-exported\n \n         )*\n     }\n }\n \n-import!(issue_56411);\n+import!(issue_56411_aux);\n \n fn main() {\n     println!(\"Hello, world!\");"}, {"sha": "dd05852c091599c3521e9648677bd9fdab44336b", "filename": "src/test/ui/issues/issue-56411.stderr", "status": "modified", "additions": 11, "deletions": 11, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/1b659d69bc0ba7fe534cc26bda8544a558a7d2b2/src%2Ftest%2Fui%2Fissues%2Fissue-56411.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/1b659d69bc0ba7fe534cc26bda8544a558a7d2b2/src%2Ftest%2Fui%2Fissues%2Fissue-56411.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-56411.stderr?ref=1b659d69bc0ba7fe534cc26bda8544a558a7d2b2", "patch": "@@ -1,29 +1,29 @@\n-error[E0255]: the name `issue_56411` is defined multiple times\n+error[E0255]: the name `issue_56411_aux` is defined multiple times\n   --> $DIR/issue-56411.rs:5:21\n    |\n LL |             mod $name;\n-   |             ---------- previous definition of the module `issue_56411` here\n+   |             ---------- previous definition of the module `issue_56411_aux` here\n LL |             pub use self::$name;\n    |                     ^^^^^^^^^^^\n    |                     |\n-   |                     `issue_56411` reimported here\n+   |                     `issue_56411_aux` reimported here\n    |                     you can use `as` to change the binding name of the import\n ...\n-LL | import!(issue_56411);\n-   | --------------------- in this macro invocation\n+LL | import!(issue_56411_aux);\n+   | ------------------------- in this macro invocation\n    |\n-   = note: `issue_56411` must be defined only once in the type namespace of this module\n+   = note: `issue_56411_aux` must be defined only once in the type namespace of this module\n \n-error[E0365]: `issue_56411` is private, and cannot be re-exported\n+error[E0365]: `issue_56411_aux` is private, and cannot be re-exported\n   --> $DIR/issue-56411.rs:5:21\n    |\n LL |             pub use self::$name;\n-   |                     ^^^^^^^^^^^ re-export of private `issue_56411`\n+   |                     ^^^^^^^^^^^ re-export of private `issue_56411_aux`\n ...\n-LL | import!(issue_56411);\n-   | --------------------- in this macro invocation\n+LL | import!(issue_56411_aux);\n+   | ------------------------- in this macro invocation\n    |\n-   = note: consider declaring type or module `issue_56411` with `pub`\n+   = note: consider declaring type or module `issue_56411_aux` with `pub`\n \n error: aborting due to 2 previous errors\n "}, {"sha": "bd689e913aba6e1367357ebb6478abe16bf54302", "filename": "src/test/ui/issues/issue_56411_aux.rs", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/1b659d69bc0ba7fe534cc26bda8544a558a7d2b2/src%2Ftest%2Fui%2Fissues%2Fissue_56411_aux.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1b659d69bc0ba7fe534cc26bda8544a558a7d2b2/src%2Ftest%2Fui%2Fissues%2Fissue_56411_aux.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue_56411_aux.rs?ref=1b659d69bc0ba7fe534cc26bda8544a558a7d2b2", "previous_filename": "src/test/ui/issues/issue_56411.rs"}]}