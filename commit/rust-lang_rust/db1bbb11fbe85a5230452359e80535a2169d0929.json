{"sha": "db1bbb11fbe85a5230452359e80535a2169d0929", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRiMWJiYjExZmJlODVhNTIzMDQ1MjM1OWU4MDUzNWEyMTY5ZDA5Mjk=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-02-21T10:34:58Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-02-21T10:34:58Z"}, "message": "Merge #3247\n\n3247: Improve RA version display r=matklad a=edwin0cheng\n\nThere are 2 problems of current implementation for displaying current version of RA binary:\r\n\r\n1. If that binary is coming from built by source, the `REV` may not be updated somehow. (See discussion in [Zuilp](https://rust-lang.zulipchat.com/#narrow/stream/185405-t-compiler.2Fwg-rls-2.2E0/topic/vscode.20version.20in.20console))\r\n\r\n2. We must go through the VSCode debugger console to see the output of `console.log`.\r\n\r\nThis PR implemented a new VSCode command \"Show RA Version\" to display the version, which  fixed the first problem.  And added some `rerun-if` flags in `build.rs` to fix the second one.\n\nCo-authored-by: Edwin Cheng <edwin0cheng@gmail.com>", "tree": {"sha": "a6570ab4e6691853804a71598135f5541723f691", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a6570ab4e6691853804a71598135f5541723f691"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/db1bbb11fbe85a5230452359e80535a2169d0929", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJeT7JSCRBK7hj4Ov3rIwAAdHIIADCsslR8WBxvNU4MjgGh0/aL\n0p6GRvCQhjmuAu4+GuScQI+gncMAyuskFqMEweDTLTQoyk4Bo4zWsQ4OvdBMDdeJ\nxNCUuaiU95sqnNzkA8as7f4C2dnw60h5CdUp0LuWIbDtgwXByL5TJfwFQHZzg9QI\nc1WsdOg/s6DPNMOXFJaO2VgukI+CuHwdeFOMLUaUjSsf7/Nz92Cb1PA/XDNOZiw9\noguUQ/98M08rmUHemyceJ1DrMzNW/pEg3sZ9xIZQmwx7KU8JVn9ow4Qekh8M30zj\nDy1V4uz9CH30jujX2M73ftDbwFo4xC6TGumS3yM407EY3fI7B+tjhL8/Q0w9v1s=\n=yphg\n-----END PGP SIGNATURE-----\n", "payload": "tree a6570ab4e6691853804a71598135f5541723f691\nparent 88014fcec04721350abc156efb1e18889fca5255\nparent 319a09847b47086b73ea7184ee39b3be0b924c60\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1582281298 +0000\ncommitter GitHub <noreply@github.com> 1582281298 +0000\n\nMerge #3247\n\n3247: Improve RA version display r=matklad a=edwin0cheng\n\nThere are 2 problems of current implementation for displaying current version of RA binary:\r\n\r\n1. If that binary is coming from built by source, the `REV` may not be updated somehow. (See discussion in [Zuilp](https://rust-lang.zulipchat.com/#narrow/stream/185405-t-compiler.2Fwg-rls-2.2E0/topic/vscode.20version.20in.20console))\r\n\r\n2. We must go through the VSCode debugger console to see the output of `console.log`.\r\n\r\nThis PR implemented a new VSCode command \"Show RA Version\" to display the version, which  fixed the first problem.  And added some `rerun-if` flags in `build.rs` to fix the second one.\n\nCo-authored-by: Edwin Cheng <edwin0cheng@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/db1bbb11fbe85a5230452359e80535a2169d0929", "html_url": "https://github.com/rust-lang/rust/commit/db1bbb11fbe85a5230452359e80535a2169d0929", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/db1bbb11fbe85a5230452359e80535a2169d0929/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "88014fcec04721350abc156efb1e18889fca5255", "url": "https://api.github.com/repos/rust-lang/rust/commits/88014fcec04721350abc156efb1e18889fca5255", "html_url": "https://github.com/rust-lang/rust/commit/88014fcec04721350abc156efb1e18889fca5255"}, {"sha": "319a09847b47086b73ea7184ee39b3be0b924c60", "url": "https://api.github.com/repos/rust-lang/rust/commits/319a09847b47086b73ea7184ee39b3be0b924c60", "html_url": "https://github.com/rust-lang/rust/commit/319a09847b47086b73ea7184ee39b3be0b924c60"}], "stats": {"total": 62, "additions": 61, "deletions": 1}, "files": [{"sha": "d4b010c04e9bea558614c8c89652890e1d425d88", "filename": "crates/rust-analyzer/build.rs", "status": "modified", "additions": 29, "deletions": 1, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/db1bbb11fbe85a5230452359e80535a2169d0929/crates%2Frust-analyzer%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/db1bbb11fbe85a5230452359e80535a2169d0929/crates%2Frust-analyzer%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fbuild.rs?ref=db1bbb11fbe85a5230452359e80535a2169d0929", "patch": "@@ -1,12 +1,40 @@\n //! Just embed git-hash to `--version`\n \n-use std::process::Command;\n+use std::{env, path::PathBuf, process::Command};\n \n fn main() {\n+    set_rerun();\n+\n     let rev = rev().unwrap_or_else(|| \"???????\".to_string());\n     println!(\"cargo:rustc-env=REV={}\", rev)\n }\n \n+fn set_rerun() {\n+    let mut manifest_dir = PathBuf::from(\n+        env::var(\"CARGO_MANIFEST_DIR\").expect(\"`CARGO_MANIFEST_DIR` is always set by cargo.\"),\n+    );\n+\n+    while manifest_dir.parent().is_some() {\n+        if manifest_dir.join(\".git/HEAD\").exists() {\n+            let git_dir = manifest_dir.join(\".git\");\n+\n+            println!(\"cargo:rerun-if-changed={}\", git_dir.join(\"HEAD\").display());\n+            // current branch ref\n+            if let Ok(output) =\n+                Command::new(\"git\").args(&[\"rev-parse\", \"--symbolic-full-name\", \"HEAD\"]).output()\n+            {\n+                if let Ok(ref_link) = String::from_utf8(output.stdout) {\n+                    println!(\"cargo:rerun-if-changed={}\", git_dir.join(ref_link).display());\n+                }\n+            }\n+            return;\n+        }\n+\n+        manifest_dir.pop();\n+    }\n+    println!(\"cargo:warning=Could not find `.git/HEAD` from manifest dir!\");\n+}\n+\n fn rev() -> Option<String> {\n     let output = Command::new(\"git\").args(&[\"rev-parse\", \"HEAD\"]).output().ok()?;\n     let stdout = String::from_utf8(output.stdout).ok()?;"}, {"sha": "a00fa35da0c06617f4b1606fa7989f04ef17fa24", "filename": "docs/user/features.md", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/db1bbb11fbe85a5230452359e80535a2169d0929/docs%2Fuser%2Ffeatures.md", "raw_url": "https://github.com/rust-lang/rust/raw/db1bbb11fbe85a5230452359e80535a2169d0929/docs%2Fuser%2Ffeatures.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/docs%2Fuser%2Ffeatures.md?ref=db1bbb11fbe85a5230452359e80535a2169d0929", "patch": "@@ -89,6 +89,10 @@ Shows the full macro expansion of the macro at current cursor.\n \n Shows internal statistic about memory usage of rust-analyzer\n \n+#### Show RA Version\n+\n+Show current rust-analyzer version\n+\n #### Run garbage collection\n \n Manually triggers GC"}, {"sha": "72befe2b63a3431c7e0272a8b27a15a53d2762d9", "filename": "editors/code/package.json", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/db1bbb11fbe85a5230452359e80535a2169d0929/editors%2Fcode%2Fpackage.json", "raw_url": "https://github.com/rust-lang/rust/raw/db1bbb11fbe85a5230452359e80535a2169d0929/editors%2Fcode%2Fpackage.json", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fpackage.json?ref=db1bbb11fbe85a5230452359e80535a2169d0929", "patch": "@@ -131,6 +131,11 @@\n                 \"command\": \"rust-analyzer.ssr\",\n                 \"title\": \"Structural Search Replace\",\n                 \"category\": \"Rust Analyzer\"\n+            },\n+            {\n+                \"command\": \"rust-analyzer.serverVersion\",\n+                \"title\": \"Show RA Version\",\n+                \"category\": \"Rust Analyzer\"\n             }\n         ],\n         \"keybindings\": ["}, {"sha": "839245f48756462063e5d07004dd1950805f695b", "filename": "editors/code/src/commands/index.ts", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/db1bbb11fbe85a5230452359e80535a2169d0929/editors%2Fcode%2Fsrc%2Fcommands%2Findex.ts", "raw_url": "https://github.com/rust-lang/rust/raw/db1bbb11fbe85a5230452359e80535a2169d0929/editors%2Fcode%2Fsrc%2Fcommands%2Findex.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fcommands%2Findex.ts?ref=db1bbb11fbe85a5230452359e80535a2169d0929", "patch": "@@ -13,6 +13,7 @@ export * from './syntax_tree';\n export * from './expand_macro';\n export * from './runnables';\n export * from './ssr';\n+export * from './server_version';\n \n export function collectGarbage(ctx: Ctx): Cmd {\n     return async () => {"}, {"sha": "421301b42cdfcd570cd83f0a587e7370d0aa8621", "filename": "editors/code/src/commands/server_version.ts", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/db1bbb11fbe85a5230452359e80535a2169d0929/editors%2Fcode%2Fsrc%2Fcommands%2Fserver_version.ts", "raw_url": "https://github.com/rust-lang/rust/raw/db1bbb11fbe85a5230452359e80535a2169d0929/editors%2Fcode%2Fsrc%2Fcommands%2Fserver_version.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fcommands%2Fserver_version.ts?ref=db1bbb11fbe85a5230452359e80535a2169d0929", "patch": "@@ -0,0 +1,21 @@\n+import * as vscode from 'vscode';\n+import { ensureServerBinary } from '../installation/server';\n+import { Ctx, Cmd } from '../ctx';\n+import { spawnSync } from 'child_process';\n+\n+export function serverVersion(ctx: Ctx): Cmd {\n+    return async () => {\n+        const binaryPath = await ensureServerBinary(ctx.config.serverSource);\n+\n+        if (binaryPath == null) {\n+            throw new Error(\n+                \"Rust Analyzer Language Server is not available. \" +\n+                \"Please, ensure its [proper installation](https://rust-analyzer.github.io/manual.html#installation).\"\n+            );\n+        }\n+\n+        const version = spawnSync(binaryPath, [\"--version\"], { encoding: \"utf8\" }).stdout;\n+        vscode.window.showInformationMessage('rust-analyzer version : ' + version);\n+    };\n+}\n+"}, {"sha": "de19a44e517d6127321a050887d55b23660e35a5", "filename": "editors/code/src/main.ts", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/db1bbb11fbe85a5230452359e80535a2169d0929/editors%2Fcode%2Fsrc%2Fmain.ts", "raw_url": "https://github.com/rust-lang/rust/raw/db1bbb11fbe85a5230452359e80535a2169d0929/editors%2Fcode%2Fsrc%2Fmain.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fmain.ts?ref=db1bbb11fbe85a5230452359e80535a2169d0929", "patch": "@@ -55,6 +55,7 @@ export async function activate(context: vscode.ExtensionContext) {\n     ctx.registerCommand('run', commands.run);\n     ctx.registerCommand('onEnter', commands.onEnter);\n     ctx.registerCommand('ssr', commands.ssr);\n+    ctx.registerCommand('serverVersion', commands.serverVersion);\n \n     // Internal commands which are invoked by the server.\n     ctx.registerCommand('runSingle', commands.runSingle);"}]}