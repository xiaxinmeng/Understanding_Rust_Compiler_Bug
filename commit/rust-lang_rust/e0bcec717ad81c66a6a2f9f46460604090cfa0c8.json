{"sha": "e0bcec717ad81c66a6a2f9f46460604090cfa0c8", "node_id": "MDY6Q29tbWl0NzI0NzEyOmUwYmNlYzcxN2FkODFjNjZhNmEyZjlmNDY0NjA2MDQwOTBjZmEwYzg=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-01-21T12:25:45Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-01-21T12:25:45Z"}, "message": "Auto merge of #3676 - daxpedda:implicit_return, r=oli-obk\n\nFix `implicit_return` false positives.\n\nFixes the following false positives:\n- linting on `if let` without `else` in a `loop` even with a present `return`\n- linting on `unreachable!()`", "tree": {"sha": "deafb7680dc6efc20403b2f49ddab6520e173148", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/deafb7680dc6efc20403b2f49ddab6520e173148"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e0bcec717ad81c66a6a2f9f46460604090cfa0c8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e0bcec717ad81c66a6a2f9f46460604090cfa0c8", "html_url": "https://github.com/rust-lang/rust/commit/e0bcec717ad81c66a6a2f9f46460604090cfa0c8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e0bcec717ad81c66a6a2f9f46460604090cfa0c8/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "54978a571c78856df200f842683069efcbe10074", "url": "https://api.github.com/repos/rust-lang/rust/commits/54978a571c78856df200f842683069efcbe10074", "html_url": "https://github.com/rust-lang/rust/commit/54978a571c78856df200f842683069efcbe10074"}, {"sha": "2183cfcc13c12f21571879dcc8ef40c4dfc9d8a7", "url": "https://api.github.com/repos/rust-lang/rust/commits/2183cfcc13c12f21571879dcc8ef40c4dfc9d8a7", "html_url": "https://github.com/rust-lang/rust/commit/2183cfcc13c12f21571879dcc8ef40c4dfc9d8a7"}], "stats": {"total": 57, "additions": 46, "deletions": 11}, "files": [{"sha": "073c37eefc5a969cf4d32bf5c24ae2b3f9e4b891", "filename": "clippy_lints/src/implicit_return.rs", "status": "modified", "additions": 22, "deletions": 6, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/e0bcec717ad81c66a6a2f9f46460604090cfa0c8/clippy_lints%2Fsrc%2Fimplicit_return.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e0bcec717ad81c66a6a2f9f46460604090cfa0c8/clippy_lints%2Fsrc%2Fimplicit_return.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fimplicit_return.rs?ref=e0bcec717ad81c66a6a2f9f46460604090cfa0c8", "patch": "@@ -1,5 +1,5 @@\n-use crate::utils::{in_macro, snippet_opt, span_lint_and_then};\n-use rustc::hir::{intravisit::FnKind, Body, ExprKind, FnDecl};\n+use crate::utils::{in_macro, is_expn_of, snippet_opt, span_lint_and_then};\n+use rustc::hir::{intravisit::FnKind, Body, ExprKind, FnDecl, MatchSource};\n use rustc::lint::{LateContext, LateLintPass, LintArray, LintPass};\n use rustc::{declare_tool_lint, lint_array};\n use rustc_errors::Applicability;\n@@ -81,15 +81,31 @@ impl Pass {\n                     Self::expr_match(cx, else_expr);\n                 }\n             },\n-            ExprKind::Match(_, arms, ..) => {\n-                for arm in arms {\n-                    Self::expr_match(cx, &arm.body);\n+            ExprKind::Match(.., arms, source) => {\n+                let check_all_arms = match source {\n+                    MatchSource::IfLetDesugar {\n+                        contains_else_clause: has_else,\n+                    } => *has_else,\n+                    _ => true,\n+                };\n+\n+                if check_all_arms {\n+                    for arm in arms {\n+                        Self::expr_match(cx, &arm.body);\n+                    }\n+                } else {\n+                    Self::expr_match(cx, &arms.first().expect(\"if let doesn't have a single arm\").body);\n                 }\n             },\n             // skip if it already has a return statement\n             ExprKind::Ret(..) => (),\n             // everything else is missing `return`\n-            _ => Self::lint(cx, expr.span, expr.span, \"add `return` as shown\"),\n+            _ => {\n+                // make sure it's not just an unreachable expression\n+                if is_expn_of(expr.span, \"unreachable\").is_none() {\n+                    Self::lint(cx, expr.span, expr.span, \"add `return` as shown\")\n+                }\n+            },\n         }\n     }\n }"}, {"sha": "d1c63ca1697c3f9e1a4a2b2b1a5a9d29df1ec91d", "filename": "tests/ui/implicit_return.rs", "status": "modified", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/e0bcec717ad81c66a6a2f9f46460604090cfa0c8/tests%2Fui%2Fimplicit_return.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e0bcec717ad81c66a6a2f9f46460604090cfa0c8/tests%2Fui%2Fimplicit_return.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fimplicit_return.rs?ref=e0bcec717ad81c66a6a2f9f46460604090cfa0c8", "patch": "@@ -26,6 +26,14 @@ fn test_match(x: bool) -> bool {\n     }\n }\n \n+#[allow(clippy::match_bool, clippy::needless_return)]\n+fn test_match_with_unreachable(x: bool) -> bool {\n+    match x {\n+        true => return false,\n+        false => unreachable!(),\n+    }\n+}\n+\n #[allow(clippy::never_loop)]\n fn test_loop() -> bool {\n     loop {\n@@ -53,6 +61,15 @@ fn test_loop_with_nests() -> bool {\n     }\n }\n \n+#[allow(clippy::redundant_pattern_matching)]\n+fn test_loop_with_if_let() -> bool {\n+    loop {\n+        if let Some(x) = Some(true) {\n+            return x;\n+        }\n+    }\n+}\n+\n fn test_closure() {\n     #[rustfmt::skip]\n     let _ = || { true };\n@@ -63,8 +80,10 @@ fn main() {\n     let _ = test_end_of_fn();\n     let _ = test_if_block();\n     let _ = test_match(true);\n+    let _ = test_match_with_unreachable(true);\n     let _ = test_loop();\n     let _ = test_loop_with_block();\n     let _ = test_loop_with_nests();\n+    let _ = test_loop_with_if_let();\n     test_closure();\n }"}, {"sha": "98b588f1a74a72fb10c35817f4538d6449666e97", "filename": "tests/ui/implicit_return.stderr", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/e0bcec717ad81c66a6a2f9f46460604090cfa0c8/tests%2Fui%2Fimplicit_return.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e0bcec717ad81c66a6a2f9f46460604090cfa0c8/tests%2Fui%2Fimplicit_return.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fimplicit_return.stderr?ref=e0bcec717ad81c66a6a2f9f46460604090cfa0c8", "patch": "@@ -31,31 +31,31 @@ LL |         false => { true },\n    |                    ^^^^ help: add `return` as shown: `return true`\n \n error: missing return statement\n-  --> $DIR/implicit_return.rs:32:9\n+  --> $DIR/implicit_return.rs:40:9\n    |\n LL |         break true;\n    |         ^^^^^^^^^^ help: change `break` to `return` as shown: `return true`\n \n error: missing return statement\n-  --> $DIR/implicit_return.rs:40:13\n+  --> $DIR/implicit_return.rs:48:13\n    |\n LL |             break true;\n    |             ^^^^^^^^^^ help: change `break` to `return` as shown: `return true`\n \n error: missing return statement\n-  --> $DIR/implicit_return.rs:49:13\n+  --> $DIR/implicit_return.rs:57:13\n    |\n LL |             break true;\n    |             ^^^^^^^^^^ help: change `break` to `return` as shown: `return true`\n \n error: missing return statement\n-  --> $DIR/implicit_return.rs:58:18\n+  --> $DIR/implicit_return.rs:75:18\n    |\n LL |     let _ = || { true };\n    |                  ^^^^ help: add `return` as shown: `return true`\n \n error: missing return statement\n-  --> $DIR/implicit_return.rs:59:16\n+  --> $DIR/implicit_return.rs:76:16\n    |\n LL |     let _ = || true;\n    |                ^^^^ help: add `return` as shown: `return true`"}]}