{"sha": "e30b68353fe22b00f40d021e7914eeb78473b3c1", "node_id": "MDY6Q29tbWl0NzI0NzEyOmUzMGI2ODM1M2ZlMjJiMDBmNDBkMDIxZTc5MTRlZWI3ODQ3M2IzYzE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-09-05T18:55:32Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-09-05T18:55:32Z"}, "message": "Auto merge of #88552 - nbdd0121:vtable, r=nagisa\n\nStop allocating vtable entries for non-object-safe methods\n\nCurrent a vtable entry is allocated for all associated fns, even if the method is not object-safe: https://godbolt.org/z/h7vx6f35T\n\nAs a result, each vtable for `Iterator`' currently consumes 74 `usize`s. This PR stops allocating vtable entries for those methods, reducing vtable size of each `Iterator` vtable to 7 `usize`s.\n\nNote that this PR introduces will cause more invocations of `is_vtable_safe_method`. So a perf run might be needed. If result isn't favorable then we might need to query-ify `is_vtable_safe_method`.", "tree": {"sha": "b0c5e0a269e05fe4ad021b7770f1a2de0a0648db", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b0c5e0a269e05fe4ad021b7770f1a2de0a0648db"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e30b68353fe22b00f40d021e7914eeb78473b3c1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e30b68353fe22b00f40d021e7914eeb78473b3c1", "html_url": "https://github.com/rust-lang/rust/commit/e30b68353fe22b00f40d021e7914eeb78473b3c1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e30b68353fe22b00f40d021e7914eeb78473b3c1/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e2750baf53aaa60db95f10759f6cf9463dc5a6bd", "url": "https://api.github.com/repos/rust-lang/rust/commits/e2750baf53aaa60db95f10759f6cf9463dc5a6bd", "html_url": "https://github.com/rust-lang/rust/commit/e2750baf53aaa60db95f10759f6cf9463dc5a6bd"}, {"sha": "97214eecc5a6c35c6cd8d9798207175cc2e15812", "url": "https://api.github.com/repos/rust-lang/rust/commits/97214eecc5a6c35c6cd8d9798207175cc2e15812", "html_url": "https://github.com/rust-lang/rust/commit/97214eecc5a6c35c6cd8d9798207175cc2e15812"}], "stats": {"total": 151, "additions": 109, "deletions": 42}, "files": [{"sha": "c93996162e3e372b491ce58f55d3927a39fe67d2", "filename": "compiler/rustc_middle/src/query/mod.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/e30b68353fe22b00f40d021e7914eeb78473b3c1/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e30b68353fe22b00f40d021e7914eeb78473b3c1/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs?ref=e30b68353fe22b00f40d021e7914eeb78473b3c1", "patch": "@@ -996,6 +996,12 @@ rustc_queries! {\n         desc { |tcx| \"checking if item has mir available: `{}`\", tcx.def_path_str(key) }\n     }\n \n+    query own_existential_vtable_entries(\n+        key: ty::PolyExistentialTraitRef<'tcx>\n+    ) -> &'tcx [DefId] {\n+        desc { |tcx| \"finding all existential vtable entries for trait {}\", tcx.def_path_str(key.def_id()) }\n+    }\n+\n     query vtable_entries(key: ty::PolyTraitRef<'tcx>)\n                         -> &'tcx [ty::VtblEntry<'tcx>] {\n         desc { |tcx| \"finding all vtable entries for trait {}\", tcx.def_path_str(key.def_id()) }"}, {"sha": "42e8b4023cfad489c219d106031baaf804cfdc79", "filename": "compiler/rustc_query_impl/src/keys.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/e30b68353fe22b00f40d021e7914eeb78473b3c1/compiler%2Frustc_query_impl%2Fsrc%2Fkeys.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e30b68353fe22b00f40d021e7914eeb78473b3c1/compiler%2Frustc_query_impl%2Fsrc%2Fkeys.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_query_impl%2Fsrc%2Fkeys.rs?ref=e30b68353fe22b00f40d021e7914eeb78473b3c1", "patch": "@@ -294,6 +294,16 @@ impl<'tcx> Key for ty::PolyTraitRef<'tcx> {\n     }\n }\n \n+impl<'tcx> Key for ty::PolyExistentialTraitRef<'tcx> {\n+    #[inline(always)]\n+    fn query_crate_is_local(&self) -> bool {\n+        self.def_id().krate == LOCAL_CRATE\n+    }\n+    fn default_span(&self, tcx: TyCtxt<'_>) -> Span {\n+        tcx.def_span(self.def_id())\n+    }\n+}\n+\n impl<'tcx> Key for (ty::PolyTraitRef<'tcx>, ty::PolyTraitRef<'tcx>) {\n     #[inline(always)]\n     fn query_crate_is_local(&self) -> bool {"}, {"sha": "44c675243838a11e1213f6f5131af5edc5803db0", "filename": "compiler/rustc_trait_selection/src/traits/mod.rs", "status": "modified", "additions": 35, "deletions": 15, "changes": 50, "blob_url": "https://github.com/rust-lang/rust/blob/e30b68353fe22b00f40d021e7914eeb78473b3c1/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e30b68353fe22b00f40d021e7914eeb78473b3c1/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fmod.rs?ref=e30b68353fe22b00f40d021e7914eeb78473b3c1", "patch": "@@ -625,6 +625,31 @@ fn dump_vtable_entries<'tcx>(\n     tcx.sess.struct_span_err(sp, &msg).emit();\n }\n \n+fn own_existential_vtable_entries<'tcx>(\n+    tcx: TyCtxt<'tcx>,\n+    trait_ref: ty::PolyExistentialTraitRef<'tcx>,\n+) -> &'tcx [DefId] {\n+    let trait_methods = tcx\n+        .associated_items(trait_ref.def_id())\n+        .in_definition_order()\n+        .filter(|item| item.kind == ty::AssocKind::Fn);\n+    // Now list each method's DefId (for within its trait).\n+    let own_entries = trait_methods.filter_map(move |trait_method| {\n+        debug!(\"own_existential_vtable_entry: trait_method={:?}\", trait_method);\n+        let def_id = trait_method.def_id;\n+\n+        // Some methods cannot be called on an object; skip those.\n+        if !is_vtable_safe_method(tcx, trait_ref.def_id(), &trait_method) {\n+            debug!(\"own_existential_vtable_entry: not vtable safe\");\n+            return None;\n+        }\n+\n+        Some(def_id)\n+    });\n+\n+    tcx.arena.alloc_from_iter(own_entries.into_iter())\n+}\n+\n /// Given a trait `trait_ref`, iterates the vtable entries\n /// that come from `trait_ref`, including its supertraits.\n fn vtable_entries<'tcx>(\n@@ -641,21 +666,15 @@ fn vtable_entries<'tcx>(\n                 entries.extend(COMMON_VTABLE_ENTRIES);\n             }\n             VtblSegment::TraitOwnEntries { trait_ref, emit_vptr } => {\n-                let trait_methods = tcx\n-                    .associated_items(trait_ref.def_id())\n-                    .in_definition_order()\n-                    .filter(|item| item.kind == ty::AssocKind::Fn);\n-                // Now list each method's DefId and InternalSubsts (for within its trait).\n-                // If the method can never be called from this object, produce `Vacant`.\n-                let own_entries = trait_methods.map(move |trait_method| {\n-                    debug!(\"vtable_entries: trait_method={:?}\", trait_method);\n-                    let def_id = trait_method.def_id;\n-\n-                    // Some methods cannot be called on an object; skip those.\n-                    if !is_vtable_safe_method(tcx, trait_ref.def_id(), &trait_method) {\n-                        debug!(\"vtable_entries: not vtable safe\");\n-                        return VtblEntry::Vacant;\n-                    }\n+                let existential_trait_ref = trait_ref\n+                    .map_bound(|trait_ref| ty::ExistentialTraitRef::erase_self_ty(tcx, trait_ref));\n+\n+                // Lookup the shape of vtable for the trait.\n+                let own_existential_entries =\n+                    tcx.own_existential_vtable_entries(existential_trait_ref);\n+\n+                let own_entries = own_existential_entries.iter().copied().map(|def_id| {\n+                    debug!(\"vtable_entries: trait_method={:?}\", def_id);\n \n                     // The method may have some early-bound lifetimes; add regions for those.\n                     let substs = trait_ref.map_bound(|trait_ref| {\n@@ -804,6 +823,7 @@ pub fn provide(providers: &mut ty::query::Providers) {\n         specialization_graph_of: specialize::specialization_graph_provider,\n         specializes: specialize::specializes,\n         codegen_fulfill_obligation: codegen::codegen_fulfill_obligation,\n+        own_existential_vtable_entries,\n         vtable_entries,\n         vtable_trait_upcasting_coercion_new_vptr_slot,\n         subst_and_check_impossible_predicates,"}, {"sha": "b108d85bb20c9afc2184fab8be73133fc8d05289", "filename": "compiler/rustc_trait_selection/src/traits/util.rs", "status": "modified", "additions": 17, "deletions": 23, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/e30b68353fe22b00f40d021e7914eeb78473b3c1/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e30b68353fe22b00f40d021e7914eeb78473b3c1/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Futil.rs?ref=e30b68353fe22b00f40d021e7914eeb78473b3c1", "patch": "@@ -285,15 +285,10 @@ pub fn upcast_choices(\n /// that come from `trait_ref`, excluding its supertraits. Used in\n /// computing the vtable base for an upcast trait of a trait object.\n pub fn count_own_vtable_entries(tcx: TyCtxt<'tcx>, trait_ref: ty::PolyTraitRef<'tcx>) -> usize {\n-    let mut entries = 0;\n-    // Count number of methods and add them to the total offset.\n-    // Skip over associated types and constants.\n-    for trait_item in tcx.associated_items(trait_ref.def_id()).in_definition_order() {\n-        if trait_item.kind == ty::AssocKind::Fn {\n-            entries += 1;\n-        }\n-    }\n-    entries\n+    let existential_trait_ref =\n+        trait_ref.map_bound(|trait_ref| ty::ExistentialTraitRef::erase_self_ty(tcx, trait_ref));\n+    let existential_trait_ref = tcx.erase_regions(existential_trait_ref);\n+    tcx.own_existential_vtable_entries(existential_trait_ref).len()\n }\n \n /// Given an upcast trait object described by `object`, returns the\n@@ -304,22 +299,21 @@ pub fn get_vtable_index_of_object_method<N>(\n     object: &super::ImplSourceObjectData<'tcx, N>,\n     method_def_id: DefId,\n ) -> usize {\n+    let existential_trait_ref = object\n+        .upcast_trait_ref\n+        .map_bound(|trait_ref| ty::ExistentialTraitRef::erase_self_ty(tcx, trait_ref));\n+    let existential_trait_ref = tcx.erase_regions(existential_trait_ref);\n     // Count number of methods preceding the one we are selecting and\n     // add them to the total offset.\n-    // Skip over associated types and constants, as those aren't stored in the vtable.\n-    let mut entries = object.vtable_base;\n-    for trait_item in tcx.associated_items(object.upcast_trait_ref.def_id()).in_definition_order() {\n-        if trait_item.def_id == method_def_id {\n-            // The item with the ID we were given really ought to be a method.\n-            assert_eq!(trait_item.kind, ty::AssocKind::Fn);\n-            return entries;\n-        }\n-        if trait_item.kind == ty::AssocKind::Fn {\n-            entries += 1;\n-        }\n-    }\n-\n-    bug!(\"get_vtable_index_of_object_method: {:?} was not found\", method_def_id);\n+    let index = tcx\n+        .own_existential_vtable_entries(existential_trait_ref)\n+        .iter()\n+        .copied()\n+        .position(|def_id| def_id == method_def_id)\n+        .unwrap_or_else(|| {\n+            bug!(\"get_vtable_index_of_object_method: {:?} was not found\", method_def_id);\n+        });\n+    object.vtable_base + index\n }\n \n pub fn closure_trait_ref_and_return_type("}, {"sha": "45b6a8a98a79f9e6204975f95850458d252ab25e", "filename": "src/test/ui/traits/vtable/vtable-non-object-safe.rs", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/e30b68353fe22b00f40d021e7914eeb78473b3c1/src%2Ftest%2Fui%2Ftraits%2Fvtable%2Fvtable-non-object-safe.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e30b68353fe22b00f40d021e7914eeb78473b3c1/src%2Ftest%2Fui%2Ftraits%2Fvtable%2Fvtable-non-object-safe.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftraits%2Fvtable%2Fvtable-non-object-safe.rs?ref=e30b68353fe22b00f40d021e7914eeb78473b3c1", "patch": "@@ -0,0 +1,18 @@\n+// build-fail\n+#![feature(rustc_attrs)]\n+\n+// Ensure that non-object-safe methods in Iterator does not generate\n+// vtable entries.\n+\n+#[rustc_dump_vtable]\n+trait A: Iterator {}\n+//~^ error Vtable\n+\n+impl<T> A for T where T: Iterator {}\n+\n+fn foo(_a: &mut dyn A<Item=u8>) {\n+}\n+\n+fn main() {\n+    foo(&mut vec![0, 1, 2, 3].into_iter());\n+}"}, {"sha": "f3175b805d1b6606bdaa5deff8e6e512ab69de25", "filename": "src/test/ui/traits/vtable/vtable-non-object-safe.stderr", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/e30b68353fe22b00f40d021e7914eeb78473b3c1/src%2Ftest%2Fui%2Ftraits%2Fvtable%2Fvtable-non-object-safe.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e30b68353fe22b00f40d021e7914eeb78473b3c1/src%2Ftest%2Fui%2Ftraits%2Fvtable%2Fvtable-non-object-safe.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftraits%2Fvtable%2Fvtable-non-object-safe.stderr?ref=e30b68353fe22b00f40d021e7914eeb78473b3c1", "patch": "@@ -0,0 +1,16 @@\n+error: Vtable entries for `<std::vec::IntoIter<u8> as A>`: [\n+    MetadataDropInPlace,\n+    MetadataSize,\n+    MetadataAlign,\n+    Method(<std::vec::IntoIter<u8> as Iterator>::next),\n+    Method(<std::vec::IntoIter<u8> as Iterator>::size_hint),\n+    Method(<std::vec::IntoIter<u8> as Iterator>::advance_by),\n+    Method(<std::vec::IntoIter<u8> as Iterator>::nth),\n+]\n+  --> $DIR/vtable-non-object-safe.rs:8:1\n+   |\n+LL | trait A: Iterator {}\n+   | ^^^^^^^^^^^^^^^^^^^^\n+\n+error: aborting due to previous error\n+"}, {"sha": "429ce523799f3e0faa4bd1d93ac4956884ab2132", "filename": "src/test/ui/traits/vtable/vtable-vacant.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/e30b68353fe22b00f40d021e7914eeb78473b3c1/src%2Ftest%2Fui%2Ftraits%2Fvtable%2Fvtable-vacant.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e30b68353fe22b00f40d021e7914eeb78473b3c1/src%2Ftest%2Fui%2Ftraits%2Fvtable%2Fvtable-vacant.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftraits%2Fvtable%2Fvtable-vacant.rs?ref=e30b68353fe22b00f40d021e7914eeb78473b3c1", "patch": "@@ -1,22 +1,25 @@\n // build-fail\n #![feature(rustc_attrs)]\n+#![feature(negative_impls)]\n+#![allow(where_clauses_object_safety)]\n \n // B --> A\n \n #[rustc_dump_vtable]\n trait A {\n     fn foo_a1(&self) {}\n-    fn foo_a2(&self) where Self: Sized {}\n+    fn foo_a2(&self) where Self: Send {}\n }\n \n #[rustc_dump_vtable]\n trait B: A {\n     //~^ error Vtable\n     fn foo_b1(&self) {}\n-    fn foo_b2() where Self: Sized {}\n+    fn foo_b2(&self) where Self: Send {}\n }\n \n struct S;\n+impl !Send for S {}\n \n impl A for S {}\n impl B for S {}"}, {"sha": "f5cd36264fcff94e5a17668c667412e3c23dc376", "filename": "src/test/ui/traits/vtable/vtable-vacant.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/e30b68353fe22b00f40d021e7914eeb78473b3c1/src%2Ftest%2Fui%2Ftraits%2Fvtable%2Fvtable-vacant.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e30b68353fe22b00f40d021e7914eeb78473b3c1/src%2Ftest%2Fui%2Ftraits%2Fvtable%2Fvtable-vacant.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftraits%2Fvtable%2Fvtable-vacant.stderr?ref=e30b68353fe22b00f40d021e7914eeb78473b3c1", "patch": "@@ -7,12 +7,12 @@ error: Vtable entries for `<S as B>`: [\n     Method(<S as B>::foo_b1),\n     Vacant,\n ]\n-  --> $DIR/vtable-vacant.rs:13:1\n+  --> $DIR/vtable-vacant.rs:15:1\n    |\n LL | / trait B: A {\n LL | |\n LL | |     fn foo_b1(&self) {}\n-LL | |     fn foo_b2() where Self: Sized {}\n+LL | |     fn foo_b2(&self) where Self: Send {}\n LL | | }\n    | |_^\n "}]}