{"sha": "370084860aa36805c9b0662ba52b5d06630d671a", "node_id": "C_kwDOAAsO6NoAKDM3MDA4NDg2MGFhMzY4MDVjOWIwNjYyYmE1MmI1ZDA2NjMwZDY3MWE", "commit": {"author": {"name": "Nilstrieb", "email": "48135649+Nilstrieb@users.noreply.github.com", "date": "2023-04-08T08:26:14Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-04-08T08:26:14Z"}, "message": "Rollup merge of #110037 - notriddle:notriddle/theme-default, r=GuillaumeGomez\n\nrustdoc: add test and bug fix for theme defaults\n\nPart of https://github.com/rust-lang/rust/issues/66181", "tree": {"sha": "1ad969ed7c9c8a12f1b2f09fdae43a3dfba13263", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1ad969ed7c9c8a12f1b2f09fdae43a3dfba13263"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/370084860aa36805c9b0662ba52b5d06630d671a", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkMSUmCRBK7hj4Ov3rIwAA5jMIAHSV6Cltz/fOeTXdroAAF7ks\nt52EKsfLOHGX53HoAWPVPYNw9dOc8L/JPO5qcL9bRr+Gw67EbDBwuXlQwDYuwqaJ\nzD/bHGD1dFra0K6skjGxGW1+zaHJZDGnBsc3mx9b8oe4Mjvddwbmd+KXsFWmFZTT\nvDFAnN4q0xp/rdoMXakRpHBL/rdEpO8sBQuATmVmerS91BOxYiIpBXbCW9nApJw9\n/1E3eGssvNbG/LPEe73TDe9i4IkBfaALvL7igPXUr5PDpy9v07EinEpmPUhAloCi\n+1v0OWfAksaUhmSKuBOv7Ltak1S9++qyGx+eBjsNeFllw6D3xjYwj2oJZnAzjIg=\n=qpq8\n-----END PGP SIGNATURE-----\n", "payload": "tree 1ad969ed7c9c8a12f1b2f09fdae43a3dfba13263\nparent 77639c094724af6eb3f861c90ac2338e02764148\nparent 5cad51c0c5a21c94bb119277131ac4b60576041a\nauthor Nilstrieb <48135649+Nilstrieb@users.noreply.github.com> 1680942374 +0200\ncommitter GitHub <noreply@github.com> 1680942374 +0200\n\nRollup merge of #110037 - notriddle:notriddle/theme-default, r=GuillaumeGomez\n\nrustdoc: add test and bug fix for theme defaults\n\nPart of https://github.com/rust-lang/rust/issues/66181\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/370084860aa36805c9b0662ba52b5d06630d671a", "html_url": "https://github.com/rust-lang/rust/commit/370084860aa36805c9b0662ba52b5d06630d671a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/370084860aa36805c9b0662ba52b5d06630d671a/comments", "author": {"login": "Nilstrieb", "id": 48135649, "node_id": "MDQ6VXNlcjQ4MTM1NjQ5", "avatar_url": "https://avatars.githubusercontent.com/u/48135649?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Nilstrieb", "html_url": "https://github.com/Nilstrieb", "followers_url": "https://api.github.com/users/Nilstrieb/followers", "following_url": "https://api.github.com/users/Nilstrieb/following{/other_user}", "gists_url": "https://api.github.com/users/Nilstrieb/gists{/gist_id}", "starred_url": "https://api.github.com/users/Nilstrieb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Nilstrieb/subscriptions", "organizations_url": "https://api.github.com/users/Nilstrieb/orgs", "repos_url": "https://api.github.com/users/Nilstrieb/repos", "events_url": "https://api.github.com/users/Nilstrieb/events{/privacy}", "received_events_url": "https://api.github.com/users/Nilstrieb/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "77639c094724af6eb3f861c90ac2338e02764148", "url": "https://api.github.com/repos/rust-lang/rust/commits/77639c094724af6eb3f861c90ac2338e02764148", "html_url": "https://github.com/rust-lang/rust/commit/77639c094724af6eb3f861c90ac2338e02764148"}, {"sha": "5cad51c0c5a21c94bb119277131ac4b60576041a", "url": "https://api.github.com/repos/rust-lang/rust/commits/5cad51c0c5a21c94bb119277131ac4b60576041a", "html_url": "https://github.com/rust-lang/rust/commit/5cad51c0c5a21c94bb119277131ac4b60576041a"}], "stats": {"total": 25, "additions": 25, "deletions": 0}, "files": [{"sha": "93979a944183b80d2a2318d8058bb6e2b76c0c1b", "filename": "src/librustdoc/html/static/js/storage.js", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/370084860aa36805c9b0662ba52b5d06630d671a/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fstorage.js", "raw_url": "https://github.com/rust-lang/rust/raw/370084860aa36805c9b0662ba52b5d06630d671a/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fstorage.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fstorage.js?ref=370084860aa36805c9b0662ba52b5d06630d671a", "patch": "@@ -153,6 +153,7 @@ const updateTheme = (function() {\n         if (getSettingValue(\"use-system-theme\") !== \"false\") {\n             const lightTheme = getSettingValue(\"preferred-light-theme\") || \"light\";\n             const darkTheme = getSettingValue(\"preferred-dark-theme\") || \"dark\";\n+            updateLocalStorage(\"use-system-theme\", \"true\");\n \n             // use light theme if user prefers it, or has no preference\n             switchTheme(mql.matches ? darkTheme : lightTheme, true);"}, {"sha": "d5ed536b1a9621a52ae25e9157890927a4db74c8", "filename": "tests/rustdoc-gui/theme-defaults.goml", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/370084860aa36805c9b0662ba52b5d06630d671a/tests%2Frustdoc-gui%2Ftheme-defaults.goml", "raw_url": "https://github.com/rust-lang/rust/raw/370084860aa36805c9b0662ba52b5d06630d671a/tests%2Frustdoc-gui%2Ftheme-defaults.goml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frustdoc-gui%2Ftheme-defaults.goml?ref=370084860aa36805c9b0662ba52b5d06630d671a", "patch": "@@ -0,0 +1,24 @@\n+// Ensure that the theme picker always starts with the actual defaults.\n+goto: \"file://\" + |DOC_PATH| + \"/test_docs/index.html\"\n+click: \"#settings-menu\"\n+wait-for: \"#theme-system-preference\"\n+assert: \"#theme-system-preference:checked\"\n+assert: \"#preferred-light-theme-light:checked\"\n+assert: \"#preferred-dark-theme-dark:checked\"\n+assert-false: \"#preferred-dark-theme-ayu:checked\"\n+\n+// Test legacy migration from old theme setup without system-preference matching.\n+// See https://github.com/rust-lang/rust/pull/77809#issuecomment-707875732\n+local-storage: {\n+    \"rustdoc-preferred-light-theme\": null,\n+    \"rustdoc-preferred-dark-theme\": null,\n+    \"rustdoc-use-system-theme\": null,\n+    \"rustdoc-theme\": \"ayu\"\n+}\n+goto: \"file://\" + |DOC_PATH| + \"/test_docs/index.html\"\n+click: \"#settings-menu\"\n+wait-for: \"#theme-system-preference\"\n+assert: \"#theme-system-preference:checked\"\n+assert: \"#preferred-light-theme-light:checked\"\n+assert-false: \"#preferred-dark-theme-dark:checked\"\n+assert: \"#preferred-dark-theme-ayu:checked\""}]}