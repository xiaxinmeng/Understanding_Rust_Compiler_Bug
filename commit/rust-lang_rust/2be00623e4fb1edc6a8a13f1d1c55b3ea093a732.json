{"sha": "2be00623e4fb1edc6a8a13f1d1c55b3ea093a732", "node_id": "C_kwDOAAsO6NoAKDJiZTAwNjIzZTRmYjFlZGM2YThhMTNmMWQxYzU1YjNlYTA5M2E3MzI", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-07-23T17:42:59Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-07-23T17:42:59Z"}, "message": "Auto merge of #12851 - DorianListens:dscheidt/if-completion-match-guard, r=Veykril\n\nfix: Don't add braces to 'if' completion in match guard position\n\nfixes #12823\n\nIs this what you were thinking of here, `@Veykril` ? I haven't done any work on completions before, so I could definitely be misunderstanding the issue.", "tree": {"sha": "950c64347e5706dd194f1d56eac53a394f8e845e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/950c64347e5706dd194f1d56eac53a394f8e845e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2be00623e4fb1edc6a8a13f1d1c55b3ea093a732", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2be00623e4fb1edc6a8a13f1d1c55b3ea093a732", "html_url": "https://github.com/rust-lang/rust/commit/2be00623e4fb1edc6a8a13f1d1c55b3ea093a732", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2be00623e4fb1edc6a8a13f1d1c55b3ea093a732/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f3a46f689c2f6f62193263c6eef0b04e93ae90f7", "url": "https://api.github.com/repos/rust-lang/rust/commits/f3a46f689c2f6f62193263c6eef0b04e93ae90f7", "html_url": "https://github.com/rust-lang/rust/commit/f3a46f689c2f6f62193263c6eef0b04e93ae90f7"}, {"sha": "13c83f90ac0031b71bea8aa14d967b47647498bb", "url": "https://api.github.com/repos/rust-lang/rust/commits/13c83f90ac0031b71bea8aa14d967b47647498bb", "html_url": "https://github.com/rust-lang/rust/commit/13c83f90ac0031b71bea8aa14d967b47647498bb"}], "stats": {"total": 89, "additions": 88, "deletions": 1}, "files": [{"sha": "bdf6e64f09696d27660409743a8d42842e8f7751", "filename": "crates/ide-completion/src/completions/expr.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/2be00623e4fb1edc6a8a13f1d1c55b3ea093a732/crates%2Fide-completion%2Fsrc%2Fcompletions%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2be00623e4fb1edc6a8a13f1d1c55b3ea093a732/crates%2Fide-completion%2Fsrc%2Fcompletions%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Fcompletions%2Fexpr.rs?ref=2be00623e4fb1edc6a8a13f1d1c55b3ea093a732", "patch": "@@ -21,6 +21,7 @@ pub(crate) fn complete_expr_path(\n         ref is_func_update,\n         ref innermost_ret_ty,\n         ref impl_,\n+        in_match_guard,\n         ..\n     }: &ExprCtx,\n ) {\n@@ -195,7 +196,11 @@ pub(crate) fn complete_expr_path(\n                 add_keyword(\"while\", \"while $1 {\\n    $0\\n}\");\n                 add_keyword(\"while let\", \"while let $1 = $2 {\\n    $0\\n}\");\n                 add_keyword(\"loop\", \"loop {\\n    $0\\n}\");\n-                add_keyword(\"if\", \"if $1 {\\n    $0\\n}\");\n+                if in_match_guard {\n+                    add_keyword(\"if\", \"if $0\");\n+                } else {\n+                    add_keyword(\"if\", \"if $1 {\\n    $0\\n}\");\n+                }\n                 add_keyword(\"if let\", \"if let $1 = $2 {\\n    $0\\n}\");\n                 add_keyword(\"for\", \"for $1 in $2 {\\n    $0\\n}\");\n                 add_keyword(\"true\", \"true\");"}, {"sha": "3989a451bde42a150f8cdb9910df50fe9de245cc", "filename": "crates/ide-completion/src/completions/keyword.rs", "status": "modified", "additions": 71, "deletions": 0, "changes": 71, "blob_url": "https://github.com/rust-lang/rust/blob/2be00623e4fb1edc6a8a13f1d1c55b3ea093a732/crates%2Fide-completion%2Fsrc%2Fcompletions%2Fkeyword.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2be00623e4fb1edc6a8a13f1d1c55b3ea093a732/crates%2Fide-completion%2Fsrc%2Fcompletions%2Fkeyword.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Fcompletions%2Fkeyword.rs?ref=2be00623e4fb1edc6a8a13f1d1c55b3ea093a732", "patch": "@@ -163,4 +163,75 @@ fn main() {\n \"#,\n         );\n     }\n+\n+    #[test]\n+    fn if_completion_in_match_guard() {\n+        check_edit(\n+            \"if\",\n+            r\"\n+fn main() {\n+    match () {\n+        () $0\n+    }\n+}\n+\",\n+            r\"\n+fn main() {\n+    match () {\n+        () if $0\n+    }\n+}\n+\",\n+        )\n+    }\n+\n+    #[test]\n+    fn if_completion_in_match_arm_expr() {\n+        check_edit(\n+            \"if\",\n+            r\"\n+fn main() {\n+    match () {\n+        () => $0\n+    }\n+}\n+\",\n+            r\"\n+fn main() {\n+    match () {\n+        () => if $1 {\n+    $0\n+}\n+    }\n+}\n+\",\n+        )\n+    }\n+\n+    #[test]\n+    fn if_completion_in_match_arm_expr_block() {\n+        check_edit(\n+            \"if\",\n+            r\"\n+fn main() {\n+    match () {\n+        () => {\n+            $0\n+        }\n+    }\n+}\n+\",\n+            r\"\n+fn main() {\n+    match () {\n+        () => {\n+            if $1 {\n+    $0\n+}\n+        }\n+    }\n+}\n+\",\n+        )\n+    }\n }"}, {"sha": "93b6ad5d145dff545f979c2aad0d9f06ad96179d", "filename": "crates/ide-completion/src/context.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/2be00623e4fb1edc6a8a13f1d1c55b3ea093a732/crates%2Fide-completion%2Fsrc%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2be00623e4fb1edc6a8a13f1d1c55b3ea093a732/crates%2Fide-completion%2Fsrc%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Fcontext.rs?ref=2be00623e4fb1edc6a8a13f1d1c55b3ea093a732", "patch": "@@ -138,6 +138,9 @@ pub(crate) struct ExprCtx {\n     pub(crate) self_param: Option<hir::SelfParam>,\n     pub(crate) innermost_ret_ty: Option<hir::Type>,\n     pub(crate) impl_: Option<ast::Impl>,\n+    /// Whether this expression occurs in match arm guard position: before the\n+    /// fat arrow token\n+    pub(crate) in_match_guard: bool,\n }\n \n /// Original file ast nodes"}, {"sha": "c71ffa0ed86fd754c4d7a0ab6cd29041998d444b", "filename": "crates/ide-completion/src/context/analysis.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/2be00623e4fb1edc6a8a13f1d1c55b3ea093a732/crates%2Fide-completion%2Fsrc%2Fcontext%2Fanalysis.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2be00623e4fb1edc6a8a13f1d1c55b3ea093a732/crates%2Fide-completion%2Fsrc%2Fcontext%2Fanalysis.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Fcontext%2Fanalysis.rs?ref=2be00623e4fb1edc6a8a13f1d1c55b3ea093a732", "patch": "@@ -763,6 +763,13 @@ impl<'a> CompletionContext<'a> {\n                 .map_or(false, |it| it.semicolon_token().is_none());\n             let impl_ = fetch_immediate_impl(sema, original_file, expr.syntax());\n \n+            let in_match_guard = match it.parent().and_then(ast::MatchArm::cast) {\n+                Some(arm) => arm\n+                    .fat_arrow_token()\n+                    .map_or(true, |arrow| it.text_range().start() < arrow.text_range().start()),\n+                None => false,\n+            };\n+\n             PathKind::Expr {\n                 expr_ctx: ExprCtx {\n                     in_block_expr,\n@@ -775,6 +782,7 @@ impl<'a> CompletionContext<'a> {\n                     self_param,\n                     incomplete_let,\n                     impl_,\n+                    in_match_guard,\n                 },\n             }\n         };"}]}