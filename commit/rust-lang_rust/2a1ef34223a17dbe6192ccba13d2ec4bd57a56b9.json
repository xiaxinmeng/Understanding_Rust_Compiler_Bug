{"sha": "2a1ef34223a17dbe6192ccba13d2ec4bd57a56b9", "node_id": "C_kwDOAAsO6NoAKDJhMWVmMzQyMjNhMTdkYmU2MTkyY2NiYTEzZDJlYzRiZDU3YTU2Yjk", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2023-05-06T05:58:00Z"}, "committer": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2023-05-06T05:58:04Z"}, "message": "More robust debug assertions for `Instance::resolve` on built-in traits with custom items", "tree": {"sha": "a77fc180a6ad94a71a401ef59d19e8d6dbb6476c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a77fc180a6ad94a71a401ef59d19e8d6dbb6476c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2a1ef34223a17dbe6192ccba13d2ec4bd57a56b9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2a1ef34223a17dbe6192ccba13d2ec4bd57a56b9", "html_url": "https://github.com/rust-lang/rust/commit/2a1ef34223a17dbe6192ccba13d2ec4bd57a56b9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2a1ef34223a17dbe6192ccba13d2ec4bd57a56b9/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "82cd953c7c43e64dae6f705ce2f07b291f0e22e3", "url": "https://api.github.com/repos/rust-lang/rust/commits/82cd953c7c43e64dae6f705ce2f07b291f0e22e3", "html_url": "https://github.com/rust-lang/rust/commit/82cd953c7c43e64dae6f705ce2f07b291f0e22e3"}], "stats": {"total": 87, "additions": 73, "deletions": 14}, "files": [{"sha": "6c8f4af7594349904aa07aae527ecc493b44adab", "filename": "compiler/rustc_middle/src/ty/instance.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/2a1ef34223a17dbe6192ccba13d2ec4bd57a56b9/compiler%2Frustc_middle%2Fsrc%2Fty%2Finstance.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2a1ef34223a17dbe6192ccba13d2ec4bd57a56b9/compiler%2Frustc_middle%2Fsrc%2Fty%2Finstance.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Finstance.rs?ref=2a1ef34223a17dbe6192ccba13d2ec4bd57a56b9", "patch": "@@ -385,7 +385,7 @@ impl<'tcx> Instance<'tcx> {\n     /// couldn't complete due to errors elsewhere - this is distinct\n     /// from `Ok(None)` to avoid misleading diagnostics when an error\n     /// has already been/will be emitted, for the original cause\n-    #[instrument(level = \"debug\", skip(tcx))]\n+    #[instrument(level = \"debug\", skip(tcx), ret)]\n     pub fn resolve(\n         tcx: TyCtxt<'tcx>,\n         param_env: ty::ParamEnv<'tcx>,"}, {"sha": "413a958fa2eedb6415c053e42ffb2ae3c99ecf97", "filename": "compiler/rustc_span/src/symbol.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/2a1ef34223a17dbe6192ccba13d2ec4bd57a56b9/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2a1ef34223a17dbe6192ccba13d2ec4bd57a56b9/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs?ref=2a1ef34223a17dbe6192ccba13d2ec4bd57a56b9", "patch": "@@ -1203,6 +1203,7 @@ symbols! {\n         require,\n         residual,\n         result,\n+        resume,\n         return_position_impl_trait_in_trait,\n         return_type_notation,\n         rhs,"}, {"sha": "b10aaad5f2af41fdc5a5e38ce2db87c639b6c091", "filename": "compiler/rustc_ty_utils/src/instance.rs", "status": "modified", "additions": 71, "deletions": 13, "changes": 84, "blob_url": "https://github.com/rust-lang/rust/blob/2a1ef34223a17dbe6192ccba13d2ec4bd57a56b9/compiler%2Frustc_ty_utils%2Fsrc%2Finstance.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2a1ef34223a17dbe6192ccba13d2ec4bd57a56b9/compiler%2Frustc_ty_utils%2Fsrc%2Finstance.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ty_utils%2Fsrc%2Finstance.rs?ref=2a1ef34223a17dbe6192ccba13d2ec4bd57a56b9", "patch": "@@ -177,15 +177,55 @@ fn resolve_associated_item<'tcx>(\n \n             Some(ty::Instance::new(leaf_def.item.def_id, substs))\n         }\n-        traits::ImplSource::Generator(generator_data) => Some(Instance {\n-            def: ty::InstanceDef::Item(generator_data.generator_def_id),\n-            substs: generator_data.substs,\n-        }),\n-        traits::ImplSource::Future(future_data) => Some(Instance {\n-            def: ty::InstanceDef::Item(future_data.generator_def_id),\n-            substs: future_data.substs,\n-        }),\n+        traits::ImplSource::Generator(generator_data) => {\n+            if cfg!(debug_assertions) && tcx.item_name(trait_item_id) != sym::resume {\n+                // For compiler developers who'd like to add new items to `Generator`,\n+                // you either need to generate a shim body, or perhaps return\n+                // `InstanceDef::Item` pointing to a trait default method body if\n+                // it is given a default implementation by the trait.\n+                span_bug!(\n+                    tcx.def_span(generator_data.generator_def_id),\n+                    \"no definition for `{trait_ref}::{}` for built-in generator type\",\n+                    tcx.item_name(trait_item_id)\n+                )\n+            }\n+            Some(Instance {\n+                def: ty::InstanceDef::Item(generator_data.generator_def_id),\n+                substs: generator_data.substs,\n+            })\n+        }\n+        traits::ImplSource::Future(future_data) => {\n+            if cfg!(debug_assertions) && tcx.item_name(trait_item_id) != sym::poll {\n+                // For compiler developers who'd like to add new items to `Future`,\n+                // you either need to generate a shim body, or perhaps return\n+                // `InstanceDef::Item` pointing to a trait default method body if\n+                // it is given a default implementation by the trait.\n+                span_bug!(\n+                    tcx.def_span(future_data.generator_def_id),\n+                    \"no definition for `{trait_ref}::{}` for built-in async generator type\",\n+                    tcx.item_name(trait_item_id)\n+                )\n+            }\n+            Some(Instance {\n+                def: ty::InstanceDef::Item(future_data.generator_def_id),\n+                substs: future_data.substs,\n+            })\n+        }\n         traits::ImplSource::Closure(closure_data) => {\n+            if cfg!(debug_assertions)\n+                && ![sym::call, sym::call_mut, sym::call_once]\n+                    .contains(&tcx.item_name(trait_item_id))\n+            {\n+                // For compiler developers who'd like to add new items to `Fn`/`FnMut`/`FnOnce`,\n+                // you either need to generate a shim body, or perhaps return\n+                // `InstanceDef::Item` pointing to a trait default method body if\n+                // it is given a default implementation by the trait.\n+                span_bug!(\n+                    tcx.def_span(closure_data.closure_def_id),\n+                    \"no definition for `{trait_ref}::{}` for built-in closure type\",\n+                    tcx.item_name(trait_item_id)\n+                )\n+            }\n             let trait_closure_kind = tcx.fn_trait_kind_from_def_id(trait_id).unwrap();\n             Instance::resolve_closure(\n                 tcx,\n@@ -195,11 +235,29 @@ fn resolve_associated_item<'tcx>(\n             )\n         }\n         traits::ImplSource::FnPointer(ref data) => match data.fn_ty.kind() {\n-            ty::FnDef(..) | ty::FnPtr(..) => Some(Instance {\n-                def: ty::InstanceDef::FnPtrShim(trait_item_id, data.fn_ty),\n-                substs: rcvr_substs,\n-            }),\n-            _ => None,\n+            ty::FnDef(..) | ty::FnPtr(..) => {\n+                if cfg!(debug_assertions)\n+                    && ![sym::call, sym::call_mut, sym::call_once]\n+                        .contains(&tcx.item_name(trait_item_id))\n+                {\n+                    // For compiler developers who'd like to add new items to `Fn`/`FnMut`/`FnOnce`,\n+                    // you either need to generate a shim body, or perhaps return\n+                    // `InstanceDef::Item` pointing to a trait default method body if\n+                    // it is given a default implementation by the trait.\n+                    bug!(\n+                        \"no definition for `{trait_ref}::{}` for built-in fn type\",\n+                        tcx.item_name(trait_item_id)\n+                    )\n+                }\n+                Some(Instance {\n+                    def: ty::InstanceDef::FnPtrShim(trait_item_id, data.fn_ty),\n+                    substs: rcvr_substs,\n+                })\n+            }\n+            _ => bug!(\n+                \"no built-in definition for `{trait_ref}::{}` for non-fn type\",\n+                tcx.item_name(trait_item_id)\n+            ),\n         },\n         traits::ImplSource::Object(ref data) => {\n             traits::get_vtable_index_of_object_method(tcx, data, trait_item_id).map(|index| {"}]}