{"sha": "6a4cf48bffb739c3657443ae308fc0c91215d4d3", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZhNGNmNDhiZmZiNzM5YzM2NTc0NDNhZTMwOGZjMGM5MTIxNWQ0ZDM=", "commit": {"author": {"name": "gfreezy", "email": "gfreezy@gmail.com", "date": "2019-09-20T15:20:43Z"}, "committer": {"name": "gfreezy", "email": "gfreezy@gmail.com", "date": "2019-09-20T15:20:43Z"}, "message": "fix module attr path", "tree": {"sha": "e299a39410eb38b740c5b1cc432f9b2d8577c2f6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e299a39410eb38b740c5b1cc432f9b2d8577c2f6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6a4cf48bffb739c3657443ae308fc0c91215d4d3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6a4cf48bffb739c3657443ae308fc0c91215d4d3", "html_url": "https://github.com/rust-lang/rust/commit/6a4cf48bffb739c3657443ae308fc0c91215d4d3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6a4cf48bffb739c3657443ae308fc0c91215d4d3/comments", "author": {"login": "gfreezy", "id": 510012, "node_id": "MDQ6VXNlcjUxMDAxMg==", "avatar_url": "https://avatars.githubusercontent.com/u/510012?v=4", "gravatar_id": "", "url": "https://api.github.com/users/gfreezy", "html_url": "https://github.com/gfreezy", "followers_url": "https://api.github.com/users/gfreezy/followers", "following_url": "https://api.github.com/users/gfreezy/following{/other_user}", "gists_url": "https://api.github.com/users/gfreezy/gists{/gist_id}", "starred_url": "https://api.github.com/users/gfreezy/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/gfreezy/subscriptions", "organizations_url": "https://api.github.com/users/gfreezy/orgs", "repos_url": "https://api.github.com/users/gfreezy/repos", "events_url": "https://api.github.com/users/gfreezy/events{/privacy}", "received_events_url": "https://api.github.com/users/gfreezy/received_events", "type": "User", "site_admin": false}, "committer": {"login": "gfreezy", "id": 510012, "node_id": "MDQ6VXNlcjUxMDAxMg==", "avatar_url": "https://avatars.githubusercontent.com/u/510012?v=4", "gravatar_id": "", "url": "https://api.github.com/users/gfreezy", "html_url": "https://github.com/gfreezy", "followers_url": "https://api.github.com/users/gfreezy/followers", "following_url": "https://api.github.com/users/gfreezy/following{/other_user}", "gists_url": "https://api.github.com/users/gfreezy/gists{/gist_id}", "starred_url": "https://api.github.com/users/gfreezy/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/gfreezy/subscriptions", "organizations_url": "https://api.github.com/users/gfreezy/orgs", "repos_url": "https://api.github.com/users/gfreezy/repos", "events_url": "https://api.github.com/users/gfreezy/events{/privacy}", "received_events_url": "https://api.github.com/users/gfreezy/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b19da133eec13ac8943b708d17410e3a8a6b6193", "url": "https://api.github.com/repos/rust-lang/rust/commits/b19da133eec13ac8943b708d17410e3a8a6b6193", "html_url": "https://github.com/rust-lang/rust/commit/b19da133eec13ac8943b708d17410e3a8a6b6193"}], "stats": {"total": 42, "additions": 40, "deletions": 2}, "files": [{"sha": "6b253ac409e0863bfa7c56dc913b615b572c72a9", "filename": "crates/ra_hir/src/nameres/collector.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/6a4cf48bffb739c3657443ae308fc0c91215d4d3/crates%2Fra_hir%2Fsrc%2Fnameres%2Fcollector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6a4cf48bffb739c3657443ae308fc0c91215d4d3/crates%2Fra_hir%2Fsrc%2Fnameres%2Fcollector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fnameres%2Fcollector.rs?ref=6a4cf48bffb739c3657443ae308fc0c91215d4d3", "patch": "@@ -1,5 +1,5 @@\n use ra_db::FileId;\n-use ra_syntax::ast;\n+use ra_syntax::{ast, SmolStr};\n use rustc_hash::FxHashMap;\n use test_utils::tested_by;\n \n@@ -98,6 +98,7 @@ where\n         self.def_map.modules[module_id].definition = Some(file_id);\n         ModCollector {\n             def_collector: &mut *self,\n+            attr_path: None,\n             module_id,\n             file_id: file_id.into(),\n             raw_items: &raw_items,\n@@ -474,6 +475,7 @@ where\n             ModCollector {\n                 def_collector: &mut *self,\n                 file_id,\n+                attr_path: None,\n                 module_id,\n                 raw_items: &raw_items,\n                 parent_module: None,\n@@ -497,6 +499,7 @@ struct ModCollector<'a, D> {\n     def_collector: D,\n     module_id: CrateModuleId,\n     file_id: HirFileId,\n+    attr_path: Option<&'a SmolStr>,\n     raw_items: &'a raw::RawItems,\n     parent_module: Option<ParentModule<'a>>,\n }\n@@ -551,6 +554,7 @@ where\n                 ModCollector {\n                     def_collector: &mut *self.def_collector,\n                     module_id,\n+                    attr_path: attr_path.as_ref(),\n                     file_id: self.file_id,\n                     raw_items: self.raw_items,\n                     parent_module: Some(parent_module),\n@@ -567,6 +571,7 @@ where\n                 match resolve_submodule(\n                     self.def_collector.db,\n                     self.file_id,\n+                    self.attr_path,\n                     name,\n                     is_root,\n                     attr_path.as_ref(),\n@@ -578,6 +583,7 @@ where\n                         ModCollector {\n                             def_collector: &mut *self.def_collector,\n                             module_id,\n+                            attr_path: attr_path.as_ref(),\n                             file_id: file_id.into(),\n                             raw_items: &raw_items,\n                             parent_module: None,"}, {"sha": "3aa32bd66c0f138a4c88ffbbe0dc96a2cde0f8b9", "filename": "crates/ra_hir/src/nameres/mod_resolution.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/6a4cf48bffb739c3657443ae308fc0c91215d4d3/crates%2Fra_hir%2Fsrc%2Fnameres%2Fmod_resolution.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6a4cf48bffb739c3657443ae308fc0c91215d4d3/crates%2Fra_hir%2Fsrc%2Fnameres%2Fmod_resolution.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fnameres%2Fmod_resolution.rs?ref=6a4cf48bffb739c3657443ae308fc0c91215d4d3", "patch": "@@ -23,6 +23,7 @@ impl<'a> ParentModule<'a> {\n pub(super) fn resolve_submodule(\n     db: &impl DefDatabase,\n     file_id: HirFileId,\n+    mod_attr_path: Option<&SmolStr>,\n     name: &Name,\n     is_root: bool,\n     attr_path: Option<&SmolStr>,\n@@ -80,7 +81,7 @@ pub(super) fn resolve_submodule(\n             ResolutionMode::OutOfLine(OutOfLineMode::WithAttributePath(path))\n         }\n         (None, None) => {\n-            let is_dir_owner = is_root || mod_name == \"mod\";\n+            let is_dir_owner = is_root || mod_name == \"mod\" || mod_attr_path.is_some();\n             if is_dir_owner {\n                 let file_mod = dir_path.join(format!(\"{}.rs\", name));\n                 let dir_mod = dir_path.join(format!(\"{}/mod.rs\", name));"}, {"sha": "e3e6f1e959bbb30696ed752b2d439041c93d38be", "filename": "crates/ra_hir/src/nameres/tests/mod_resolution.rs", "status": "modified", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/6a4cf48bffb739c3657443ae308fc0c91215d4d3/crates%2Fra_hir%2Fsrc%2Fnameres%2Ftests%2Fmod_resolution.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6a4cf48bffb739c3657443ae308fc0c91215d4d3/crates%2Fra_hir%2Fsrc%2Fnameres%2Ftests%2Fmod_resolution.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fnameres%2Ftests%2Fmod_resolution.rs?ref=6a4cf48bffb739c3657443ae308fc0c91215d4d3", "patch": "@@ -706,3 +706,34 @@ fn unresolved_module_diagnostics() {\n     \"###\n     );\n }\n+\n+#[test]\n+fn module_resolution_decl_inside_module_in_non_crate_root_2() {\n+    let map = def_map_with_crate_graph(\n+        r###\"\n+        //- /main.rs\n+        #[path=\"module/m2.rs\"]\n+        mod module;\n+\n+        //- /module/m2.rs\n+        pub mod submod;\n+\n+        //- /module/submod.rs\n+        pub struct Baz;\n+        \"###,\n+        crate_graph! {\n+            \"main\": (\"/main.rs\", []),\n+        },\n+    );\n+\n+    assert_snapshot!(map, @r###\"\n+        \u22eecrate\n+        \u22eemodule: t\n+        \u22ee\n+        \u22eecrate::module\n+        \u22eesubmod: t\n+        \u22ee\n+        \u22eecrate::module::submod\n+        \u22eeBaz: t v\n+    \"###);\n+}"}]}