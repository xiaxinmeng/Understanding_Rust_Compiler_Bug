{"sha": "e63ffc1d1677e31c8978d13a87811c9ee19e5927", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU2M2ZmYzFkMTY3N2UzMWM4OTc4ZDEzYTg3ODExYzllZTE5ZTU5Mjc=", "commit": {"author": {"name": "klutzy", "email": "klutzytheklutzy@gmail.com", "date": "2013-11-05T04:20:04Z"}, "committer": {"name": "klutzy", "email": "klutzytheklutzy@gmail.com", "date": "2013-11-05T04:54:09Z"}, "message": "rt: Convert timezone to utf-8 on Windows\n\nPreviously #9418 fixed utf-8 assertion issue by wcsftime,\nbut the function didn't work as expected: it follows the locale\nset by setlocale(), not the system code page.\nThis patch fixes it by manual multibyte-to-unicode conversion.", "tree": {"sha": "7bba77e8d513bdd5d343e0bdc90ef3397e5ce700", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7bba77e8d513bdd5d343e0bdc90ef3397e5ce700"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e63ffc1d1677e31c8978d13a87811c9ee19e5927", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e63ffc1d1677e31c8978d13a87811c9ee19e5927", "html_url": "https://github.com/rust-lang/rust/commit/e63ffc1d1677e31c8978d13a87811c9ee19e5927", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e63ffc1d1677e31c8978d13a87811c9ee19e5927/comments", "author": {"login": "klutzy", "id": 1589355, "node_id": "MDQ6VXNlcjE1ODkzNTU=", "avatar_url": "https://avatars.githubusercontent.com/u/1589355?v=4", "gravatar_id": "", "url": "https://api.github.com/users/klutzy", "html_url": "https://github.com/klutzy", "followers_url": "https://api.github.com/users/klutzy/followers", "following_url": "https://api.github.com/users/klutzy/following{/other_user}", "gists_url": "https://api.github.com/users/klutzy/gists{/gist_id}", "starred_url": "https://api.github.com/users/klutzy/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/klutzy/subscriptions", "organizations_url": "https://api.github.com/users/klutzy/orgs", "repos_url": "https://api.github.com/users/klutzy/repos", "events_url": "https://api.github.com/users/klutzy/events{/privacy}", "received_events_url": "https://api.github.com/users/klutzy/received_events", "type": "User", "site_admin": false}, "committer": {"login": "klutzy", "id": 1589355, "node_id": "MDQ6VXNlcjE1ODkzNTU=", "avatar_url": "https://avatars.githubusercontent.com/u/1589355?v=4", "gravatar_id": "", "url": "https://api.github.com/users/klutzy", "html_url": "https://github.com/klutzy", "followers_url": "https://api.github.com/users/klutzy/followers", "following_url": "https://api.github.com/users/klutzy/following{/other_user}", "gists_url": "https://api.github.com/users/klutzy/gists{/gist_id}", "starred_url": "https://api.github.com/users/klutzy/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/klutzy/subscriptions", "organizations_url": "https://api.github.com/users/klutzy/orgs", "repos_url": "https://api.github.com/users/klutzy/repos", "events_url": "https://api.github.com/users/klutzy/events{/privacy}", "received_events_url": "https://api.github.com/users/klutzy/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "72e432df9dc5f546d522654336a38213af69cac8", "url": "https://api.github.com/repos/rust-lang/rust/commits/72e432df9dc5f546d522654336a38213af69cac8", "html_url": "https://github.com/rust-lang/rust/commit/72e432df9dc5f546d522654336a38213af69cac8"}], "stats": {"total": 13, "additions": 9, "deletions": 4}, "files": [{"sha": "c1a1eefb841c47c940b3878b425e88be461364ce", "filename": "src/rt/rust_builtin.cpp", "status": "modified", "additions": 9, "deletions": 4, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/e63ffc1d1677e31c8978d13a87811c9ee19e5927/src%2Frt%2Frust_builtin.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/e63ffc1d1677e31c8978d13a87811c9ee19e5927/src%2Frt%2Frust_builtin.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_builtin.cpp?ref=e63ffc1d1677e31c8978d13a87811c9ee19e5927", "patch": "@@ -325,11 +325,16 @@ rust_localtime(int64_t sec, int32_t nsec, rust_tm *timeptr) {\n     const char* zone = NULL;\n #if defined(__WIN32__)\n     int32_t gmtoff = -timezone;\n-    wchar_t wbuffer[64];\n-    char buffer[256];\n+    wchar_t wbuffer[64] = {0};\n+    char buffer[256] = {0};\n     // strftime(\"%Z\") can contain non-UTF-8 characters on non-English locale (issue #9418),\n-    // so time zone should be converted from UTF-16 string set by wcsftime.\n-    if (wcsftime(wbuffer, sizeof(wbuffer) / sizeof(wchar_t), L\"%Z\", &tm) > 0) {\n+    // so time zone should be converted from UTF-16 string.\n+    // Since wcsftime depends on setlocale() result,\n+    // instead we convert it using MultiByteToWideChar.\n+    if (strftime(buffer, sizeof(buffer) / sizeof(char), \"%Z\", &tm) > 0) {\n+        // ANSI -> UTF-16\n+        MultiByteToWideChar(CP_ACP, 0, buffer, -1, wbuffer, sizeof(wbuffer) / sizeof(wchar_t));\n+        // UTF-16 -> UTF-8\n         WideCharToMultiByte(CP_UTF8, 0, wbuffer, -1, buffer, sizeof(buffer), NULL, NULL);\n         zone = buffer;\n     }"}]}