{"sha": "7e67f447ced3229595cebe6b85f8687a9bf394bc", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdlNjdmNDQ3Y2VkMzIyOTU5NWNlYmU2Yjg1Zjg2ODdhOWJmMzk0YmM=", "commit": {"author": {"name": "Oliver Schneider", "email": "git-spam-no-reply9815368754983@oli-obk.de", "date": "2016-08-08T14:43:45Z"}, "committer": {"name": "Oliver Schneider", "email": "git-spam-no-reply9815368754983@oli-obk.de", "date": "2016-08-08T14:43:45Z"}, "message": "add suggestions to clone_on_copy\n\nalso:\n\n* don't report clone_on_copy when reporting clone_on_double_ref\n* don't suggest `((x))`", "tree": {"sha": "f44d7deeb76718f75a601a87092bb32f8f881735", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f44d7deeb76718f75a601a87092bb32f8f881735"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7e67f447ced3229595cebe6b85f8687a9bf394bc", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\nVersion: GnuPG v1\n\niQIcBAABAgAGBQJXqJqhAAoJEFbW7qD8Z6xGJxsP/1/yWcZIEI65mY0YxLVSNaHK\nBnkll0wL9M7FfU/HAfO78kNQfqGMUdZxlbvY9IZWYSPwXwnQJzJv5bzAo6IiUCem\ncKD9nd1L1kRrapNoxylhNWLPchj+gsrXQt8p4VqJypwb/YDWCEaUD9UcMhE74XDw\nFN+r4gD9zNEiD/sM7tzyY6asaLrov/zIwRcO+Y5VA4/V8AmKaJtaFODvDMdgB8LU\nsN9moNYXWh3Cc4m9yKyhsQoayBYKBAqvMDquIAImgGf8dOOZUyBX9IM3Y4tih4By\nFdUD311/amR8B17yi5isQl0rheyk0m8ROARX5uWBMAiBGiZI5pUSPEmFJHpn1yZt\noBouiFml8veZl6fDgU2Rr1rPmxP4zlN7jCiZpHO9S8gQsIs2QzmY70CdKyZm7alb\nQiOOupv2pjzJyAsK9+n/5jQPotd0jh5BmvUWcR24VizENh1/9pdTnjO3r6PEcX5Q\nuQnqDRY13/be+Lm05W4J+XTOwfKTYPo+15JNAFJGeQ8ThYOhMlDF+qYayT470iqs\nqs7YWG0dR+2h0Wv6p9eZsy6vLxdcuyK2txNmVFSrS5lp/wkfCHuSq/oxofYqM8I+\nGFDEU0zpgtkd7RVscYBrgB23BkTLAEKBTzh1l3vwAq4Yxmt01V9MJLu7t/My6K+H\nX7ZJnMiFBDHSXgY97cNr\n=7Pxv\n-----END PGP SIGNATURE-----", "payload": "tree f44d7deeb76718f75a601a87092bb32f8f881735\nparent ac5abcf5930ea59f13a4da3ff579cc4b3ed88bd1\nauthor Oliver Schneider <git-spam-no-reply9815368754983@oli-obk.de> 1470667425 +0200\ncommitter Oliver Schneider <git-spam-no-reply9815368754983@oli-obk.de> 1470667425 +0200\n\nadd suggestions to clone_on_copy\n\nalso:\n\n* don't report clone_on_copy when reporting clone_on_double_ref\n* don't suggest `((x))`"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7e67f447ced3229595cebe6b85f8687a9bf394bc", "html_url": "https://github.com/rust-lang/rust/commit/7e67f447ced3229595cebe6b85f8687a9bf394bc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7e67f447ced3229595cebe6b85f8687a9bf394bc/comments", "author": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "committer": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ac5abcf5930ea59f13a4da3ff579cc4b3ed88bd1", "url": "https://api.github.com/repos/rust-lang/rust/commits/ac5abcf5930ea59f13a4da3ff579cc4b3ed88bd1", "html_url": "https://github.com/rust-lang/rust/commit/ac5abcf5930ea59f13a4da3ff579cc4b3ed88bd1"}], "stats": {"total": 48, "additions": 34, "deletions": 14}, "files": [{"sha": "f99dd335fd206ea7f6f748cd9a60e3603f55409f", "filename": "clippy_lints/src/methods.rs", "status": "modified", "additions": 18, "deletions": 12, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/7e67f447ced3229595cebe6b85f8687a9bf394bc/clippy_lints%2Fsrc%2Fmethods.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7e67f447ced3229595cebe6b85f8687a9bf394bc/clippy_lints%2Fsrc%2Fmethods.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmethods.rs?ref=7e67f447ced3229595cebe6b85f8687a9bf394bc", "patch": "@@ -514,8 +514,7 @@ impl LateLintPass for Pass {\n \n                 let self_ty = cx.tcx.expr_ty_adjusted(&args[0]);\n                 if args.len() == 1 && name.node.as_str() == \"clone\" {\n-                    lint_clone_on_copy(cx, expr);\n-                    lint_clone_double_ref(cx, expr, &args[0], self_ty);\n+                    lint_clone_on_copy(cx, expr, &args[0], self_ty);\n                 }\n \n                 match self_ty.sty {\n@@ -703,19 +702,11 @@ fn lint_or_fun_call(cx: &LateContext, expr: &hir::Expr, name: &str, args: &[P<hi\n }\n \n /// Checks for the `CLONE_ON_COPY` lint.\n-fn lint_clone_on_copy(cx: &LateContext, expr: &hir::Expr) {\n+fn lint_clone_on_copy(cx: &LateContext, expr: &hir::Expr, arg: &hir::Expr, arg_ty: ty::Ty) {\n     let ty = cx.tcx.expr_ty(expr);\n     let parent = cx.tcx.map.get_parent(expr.id);\n     let parameter_environment = ty::ParameterEnvironment::for_item(cx.tcx, parent);\n-\n-    if !ty.moves_by_default(cx.tcx.global_tcx(), &parameter_environment, expr.span) {\n-        span_lint(cx, CLONE_ON_COPY, expr.span, \"using `clone` on a `Copy` type\");\n-    }\n-}\n-\n-/// Checks for the `CLONE_DOUBLE_REF` lint.\n-fn lint_clone_double_ref(cx: &LateContext, expr: &hir::Expr, arg: &hir::Expr, ty: ty::Ty) {\n-    if let ty::TyRef(_, ty::TypeAndMut { ty: inner, .. }) = ty.sty {\n+    if let ty::TyRef(_, ty::TypeAndMut { ty: inner, .. }) = arg_ty.sty {\n         if let ty::TyRef(..) = inner.sty {\n             span_lint_and_then(cx,\n                                CLONE_DOUBLE_REF,\n@@ -725,8 +716,23 @@ fn lint_clone_double_ref(cx: &LateContext, expr: &hir::Expr, arg: &hir::Expr, ty\n                                |db| if let Some(snip) = sugg::Sugg::hir_opt(cx, arg) {\n                                    db.span_suggestion(expr.span, \"try dereferencing it\", format!(\"({}).clone()\", snip.deref()));\n                                });\n+            return; // don't report clone_on_copy\n         }\n     }\n+\n+    if !ty.moves_by_default(cx.tcx.global_tcx(), &parameter_environment, expr.span) {\n+        span_lint_and_then(cx,\n+                           CLONE_ON_COPY,\n+                           expr.span,\n+                           \"using `clone` on a `Copy` type\",\n+                           |db| if let Some(snip) = sugg::Sugg::hir_opt(cx, arg) {\n+                               if let ty::TyRef(..) = cx.tcx.expr_ty(arg).sty {\n+                                   db.span_suggestion(expr.span, \"try dereferencing it\", format!(\"{}\", snip.deref()));\n+                               } else {\n+                                   db.span_suggestion(expr.span, \"try removing the `clone` call\", format!(\"{}\", snip));\n+                               }\n+                           });\n+    }\n }\n \n fn lint_extend(cx: &LateContext, expr: &hir::Expr, args: &MethodArgs) {"}, {"sha": "0bd356721c9ae61de72b4778ebbb1161eb5ec3ca", "filename": "clippy_lints/src/utils/sugg.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/7e67f447ced3229595cebe6b85f8687a9bf394bc/clippy_lints%2Fsrc%2Futils%2Fsugg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7e67f447ced3229595cebe6b85f8687a9bf394bc/clippy_lints%2Fsrc%2Futils%2Fsugg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Futils%2Fsugg.rs?ref=7e67f447ced3229595cebe6b85f8687a9bf394bc", "patch": "@@ -161,7 +161,13 @@ impl<'a> Sugg<'a> {\n     pub fn maybe_par(self) -> Self {\n         match self {\n             Sugg::NonParen(..) => self,\n-            Sugg::MaybeParen(sugg) | Sugg::BinOp(_, sugg) => Sugg::NonParen(format!(\"({})\", sugg).into()),\n+            // (x) and (x).y() both don't need additional parens\n+            Sugg::MaybeParen(sugg) => if sugg.starts_with('(') && sugg.ends_with(')') {\n+                Sugg::MaybeParen(sugg)\n+            } else {\n+                Sugg::NonParen(format!(\"({})\", sugg).into())\n+            },\n+            Sugg::BinOp(_, sugg) => Sugg::NonParen(format!(\"({})\", sugg).into()),\n         }\n     }\n }"}, {"sha": "7235bad11bf2fe296f3ac94f77b8927291aa4d29", "filename": "tests/compile-fail/methods.rs", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/7e67f447ced3229595cebe6b85f8687a9bf394bc/tests%2Fcompile-fail%2Fmethods.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7e67f447ced3229595cebe6b85f8687a9bf394bc/tests%2Fcompile-fail%2Fmethods.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Fmethods.rs?ref=7e67f447ced3229595cebe6b85f8687a9bf394bc", "patch": "@@ -435,13 +435,22 @@ fn use_extend_from_slice() {\n \n fn clone_on_copy() {\n     42.clone(); //~ERROR using `clone` on a `Copy` type\n+                //~| HELP try removing the `clone` call\n+                //~| SUGGESTION 42\n     vec![1].clone(); // ok, not a Copy type\n     Some(vec![1]).clone(); // ok, not a Copy type\n+    (&42).clone(); //~ERROR using `clone` on a `Copy` type\n+                   //~| HELP try dereferencing it\n+                   //~| SUGGESTION *(&42)\n }\n \n fn clone_on_copy_generic<T: Copy>(t: T) {\n     t.clone(); //~ERROR using `clone` on a `Copy` type\n+               //~| HELP try removing the `clone` call\n+               //~| SUGGESTION t\n     Some(t).clone(); //~ERROR using `clone` on a `Copy` type\n+                     //~| HELP try removing the `clone` call\n+                     //~| SUGGESTION Some(t)\n }\n \n fn clone_on_double_ref() {\n@@ -450,7 +459,6 @@ fn clone_on_double_ref() {\n     let z: &Vec<_> = y.clone(); //~ERROR using `clone` on a double\n                                 //~| HELP try dereferencing it\n                                 //~| SUGGESTION let z: &Vec<_> = (*y).clone();\n-                                //~^^^ERROR using `clone` on a `Copy` type\n     println!(\"{:p} {:p}\",*y, z);\n }\n "}]}