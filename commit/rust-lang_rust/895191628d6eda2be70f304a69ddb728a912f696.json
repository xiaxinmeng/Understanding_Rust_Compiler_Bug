{"sha": "895191628d6eda2be70f304a69ddb728a912f696", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg5NTE5MTYyOGQ2ZWRhMmJlNzBmMzA0YTY5ZGRiNzI4YTkxMmY2OTY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-01-04T09:23:01Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-01-04T09:23:01Z"}, "message": "Auto merge of #6525 - phansch:fix-bless-in-subdirs, r=flip1995\n\nFix blessing of test output in subdirectories\n\nThe core issue was the usage of `reference_file_path.file_name()`, which\nprovided a non-existent path if the file to be updated was in a\nsubdirectory.\n\nInstead we have to provide the whole path after 'tests/ui/' as the\n'filename'. This part of the path is called `test_name` in the code now.\n\nchangelog: none", "tree": {"sha": "f24dcc34a73b4302d048dda8088e734867b978ab", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f24dcc34a73b4302d048dda8088e734867b978ab"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/895191628d6eda2be70f304a69ddb728a912f696", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/895191628d6eda2be70f304a69ddb728a912f696", "html_url": "https://github.com/rust-lang/rust/commit/895191628d6eda2be70f304a69ddb728a912f696", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/895191628d6eda2be70f304a69ddb728a912f696/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a02806e00d24f0fcb3e1f285ad9c25ed52ed7c8c", "url": "https://api.github.com/repos/rust-lang/rust/commits/a02806e00d24f0fcb3e1f285ad9c25ed52ed7c8c", "html_url": "https://github.com/rust-lang/rust/commit/a02806e00d24f0fcb3e1f285ad9c25ed52ed7c8c"}, {"sha": "69090550cb4e46d75506a200b990e9edf2485fd8", "url": "https://api.github.com/repos/rust-lang/rust/commits/69090550cb4e46d75506a200b990e9edf2485fd8", "html_url": "https://github.com/rust-lang/rust/commit/69090550cb4e46d75506a200b990e9edf2485fd8"}], "stats": {"total": 18, "additions": 10, "deletions": 8}, "files": [{"sha": "5f66ff4f30eab432c6862edf108d5b5fb44ee8fe", "filename": "clippy_dev/src/bless.rs", "status": "modified", "additions": 10, "deletions": 8, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/895191628d6eda2be70f304a69ddb728a912f696/clippy_dev%2Fsrc%2Fbless.rs", "raw_url": "https://github.com/rust-lang/rust/raw/895191628d6eda2be70f304a69ddb728a912f696/clippy_dev%2Fsrc%2Fbless.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_dev%2Fsrc%2Fbless.rs?ref=895191628d6eda2be70f304a69ddb728a912f696", "patch": "@@ -17,26 +17,28 @@ pub static CARGO_TARGET_DIR: SyncLazy<PathBuf> = SyncLazy::new(|| match env::var\n });\n \n pub fn bless() {\n-    let test_dirs = [\n+    let test_suite_dirs = [\n         clippy_project_root().join(\"tests\").join(\"ui\"),\n         clippy_project_root().join(\"tests\").join(\"ui-toml\"),\n         clippy_project_root().join(\"tests\").join(\"ui-cargo\"),\n     ];\n-    for test_dir in &test_dirs {\n-        WalkDir::new(test_dir)\n+    for test_suite_dir in &test_suite_dirs {\n+        WalkDir::new(test_suite_dir)\n             .into_iter()\n             .filter_map(Result::ok)\n             .filter(|f| f.path().extension() == Some(OsStr::new(\"rs\")))\n             .for_each(|f| {\n-                update_reference_file(f.path().with_extension(\"stdout\"));\n-                update_reference_file(f.path().with_extension(\"stderr\"));\n-                update_reference_file(f.path().with_extension(\"fixed\"));\n+                let test_name = f.path().strip_prefix(test_suite_dir).unwrap();\n+\n+                update_reference_file(f.path().with_extension(\"stdout\"), test_name.with_extension(\"stdout\"));\n+                update_reference_file(f.path().with_extension(\"stderr\"), test_name.with_extension(\"stderr\"));\n+                update_reference_file(f.path().with_extension(\"fixed\"), test_name.with_extension(\"fixed\"));\n             });\n     }\n }\n \n-fn update_reference_file(reference_file_path: PathBuf) {\n-    let test_output_path = build_dir().join(PathBuf::from(reference_file_path.file_name().unwrap()));\n+fn update_reference_file(reference_file_path: PathBuf, test_name: PathBuf) {\n+    let test_output_path = build_dir().join(test_name);\n     let relative_reference_file_path = reference_file_path.strip_prefix(clippy_project_root()).unwrap();\n \n     // If compiletest did not write any changes during the test run,"}]}