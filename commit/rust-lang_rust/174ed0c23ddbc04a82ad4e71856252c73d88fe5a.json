{"sha": "174ed0c23ddbc04a82ad4e71856252c73d88fe5a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE3NGVkMGMyM2RkYmMwNGE4MmFkNGU3MTg1NjI1MmM3M2Q4OGZlNWE=", "commit": {"author": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2020-10-26T19:06:54Z"}, "committer": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2020-10-26T19:06:54Z"}, "message": "Remove tokens from foreign items in `TokenStripper`\n\nFixes #78398\n\nI forgot to handle this case in #77255", "tree": {"sha": "d884ecb85a74f646a75b2609f08bc5bc72f2b65a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d884ecb85a74f646a75b2609f08bc5bc72f2b65a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/174ed0c23ddbc04a82ad4e71856252c73d88fe5a", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE7J9Gc3TfBwj2K399tAh+UQ6YsWQFAl+XHrUACgkQtAh+UQ6Y\nsWTnqg/6Aro4gqDijtPuJ7FkEOyV5hE4PSO9497Vvjz9vwwHeTuNbXmngS6TeCMI\nwi5GU96KklZzpNR5qZFuxzP5BuxDzjRv5BiXm+4M9W8lLQ9oQXdyk0F2yjajEXut\ntICTdyi2EX8iG0HABZlFsV/nHjd6gm4jPyclaC97BBoQwtR/8K4GUAg2ZFrQA7/Y\n5xisuKlLmwnEx1hz+M3AvjLVllAkJR74pvJWj7fVptIoBIMGax8pJN5AtaJNVw8A\nEnxMkoCXgBMph+unmbp/XnF5vQEa8nVCorKasuTRneunYH5V5EN0lpdIvtranG+e\neeFrm7S8KGzy3Xjvum0iTvdBrw45/7+a65uzkC6cUJ+EZXxm8zxUyFlL3+5iU/6b\nyHF4iyrbIhkSEWFAq0ukt8e3WJ4LI48K/QmANscALvnS56wuPVjtpus2mNKFUUWf\nfmJd4qJhssHJ2MJ8MiRwS9JkVBXuYKNVpbTaoPOHK/jINymYLQ9LNA0UcEo2UB59\n8qqzEHWXVqKvRNuy5dAUY0EusiwSedcoB2u2wnIr0VHcEfhbIAs0XG5AuThMOXQ5\nJ5x9lLOaeRJiJRbQYJuxkmBNIPjpUKeUlvtvzB0ki+b+a+FEHFBIKf3p1xtOUgb6\nr+qSyDhygZxiXNfgpDusKu2/3ahF6L4LJ8frkRbySZ1mHoUVsK8=\n=lOFf\n-----END PGP SIGNATURE-----", "payload": "tree d884ecb85a74f646a75b2609f08bc5bc72f2b65a\nparent c96e11c781af319199af77347d55f08085e15453\nauthor Aaron Hill <aa1ronham@gmail.com> 1603739214 -0400\ncommitter Aaron Hill <aa1ronham@gmail.com> 1603739214 -0400\n\nRemove tokens from foreign items in `TokenStripper`\n\nFixes #78398\n\nI forgot to handle this case in #77255\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/174ed0c23ddbc04a82ad4e71856252c73d88fe5a", "html_url": "https://github.com/rust-lang/rust/commit/174ed0c23ddbc04a82ad4e71856252c73d88fe5a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/174ed0c23ddbc04a82ad4e71856252c73d88fe5a/comments", "author": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c96e11c781af319199af77347d55f08085e15453", "url": "https://api.github.com/repos/rust-lang/rust/commits/c96e11c781af319199af77347d55f08085e15453", "html_url": "https://github.com/rust-lang/rust/commit/c96e11c781af319199af77347d55f08085e15453"}], "stats": {"total": 26, "additions": 26, "deletions": 0}, "files": [{"sha": "9dbd59506b1883cdbf28066a96bb020eccfd10b0", "filename": "compiler/rustc_interface/src/passes.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/174ed0c23ddbc04a82ad4e71856252c73d88fe5a/compiler%2Frustc_interface%2Fsrc%2Fpasses.rs", "raw_url": "https://github.com/rust-lang/rust/raw/174ed0c23ddbc04a82ad4e71856252c73d88fe5a/compiler%2Frustc_interface%2Fsrc%2Fpasses.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2Fsrc%2Fpasses.rs?ref=174ed0c23ddbc04a82ad4e71856252c73d88fe5a", "patch": "@@ -63,6 +63,13 @@ impl mut_visit::MutVisitor for TokenStripper {\n         i.tokens = None;\n         mut_visit::noop_flat_map_item(i, self)\n     }\n+    fn flat_map_foreign_item(\n+        &mut self,\n+        mut i: P<ast::ForeignItem>,\n+    ) -> SmallVec<[P<ast::ForeignItem>; 1]> {\n+        i.tokens = None;\n+        mut_visit::noop_flat_map_foreign_item(i, self)\n+    }\n     fn visit_block(&mut self, b: &mut P<ast::Block>) {\n         b.tokens = None;\n         mut_visit::noop_visit_block(b, self);"}, {"sha": "a1a20f9568178f968799ebfc0c2936bf0f6b86fb", "filename": "src/test/ui/ast-json/issue-78398-foreign-ice.rs", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/174ed0c23ddbc04a82ad4e71856252c73d88fe5a/src%2Ftest%2Fui%2Fast-json%2Fissue-78398-foreign-ice.rs", "raw_url": "https://github.com/rust-lang/rust/raw/174ed0c23ddbc04a82ad4e71856252c73d88fe5a/src%2Ftest%2Fui%2Fast-json%2Fissue-78398-foreign-ice.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fast-json%2Fissue-78398-foreign-ice.rs?ref=174ed0c23ddbc04a82ad4e71856252c73d88fe5a", "patch": "@@ -0,0 +1,18 @@\n+// Regression test for issue #78398\n+// Tests that we don't ICE when trying to print the AST json\n+// when we have capturd tokens for a foreign item\n+\n+// check-pass\n+// compile-flags: -Zast-json\n+\n+fn main() {}\n+\n+macro_rules! mac_extern {\n+    ($i:item) => {\n+        extern \"C\" { $i }\n+    }\n+}\n+\n+mac_extern! {\n+    fn foo();\n+}"}, {"sha": "f1d0e44e9fc8c784254510e2ad3c72924a4f29b3", "filename": "src/test/ui/ast-json/issue-78398-foreign-ice.stdout", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/174ed0c23ddbc04a82ad4e71856252c73d88fe5a/src%2Ftest%2Fui%2Fast-json%2Fissue-78398-foreign-ice.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/174ed0c23ddbc04a82ad4e71856252c73d88fe5a/src%2Ftest%2Fui%2Fast-json%2Fissue-78398-foreign-ice.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fast-json%2Fissue-78398-foreign-ice.stdout?ref=174ed0c23ddbc04a82ad4e71856252c73d88fe5a", "patch": "@@ -0,0 +1 @@\n+{\"module\":{\"inner\":{\"lo\":192,\"hi\":315},\"unsafety\":\"No\",\"items\":[{\"attrs\":[{\"kind\":{\"variant\":\"Normal\",\"fields\":[{\"path\":{\"span\":{\"lo\":0,\"hi\":0},\"segments\":[{\"ident\":{\"name\":\"prelude_import\",\"span\":{\"lo\":0,\"hi\":0}},\"id\":3,\"args\":null}],\"tokens\":null},\"args\":\"Empty\",\"tokens\":null}]},\"id\":null,\"style\":\"Outer\",\"span\":{\"lo\":0,\"hi\":0},\"tokens\":null}],\"id\":4,\"span\":{\"lo\":0,\"hi\":0},\"vis\":{\"kind\":\"Inherited\",\"span\":{\"lo\":0,\"hi\":0},\"tokens\":null},\"ident\":{\"name\":\"\",\"span\":{\"lo\":0,\"hi\":0}},\"kind\":{\"variant\":\"Use\",\"fields\":[{\"prefix\":{\"span\":{\"lo\":0,\"hi\":0},\"segments\":[{\"ident\":{\"name\":\"{{root}}\",\"span\":{\"lo\":0,\"hi\":0}},\"id\":5,\"args\":null},{\"ident\":{\"name\":\"std\",\"span\":{\"lo\":0,\"hi\":0}},\"id\":6,\"args\":null},{\"ident\":{\"name\":\"prelude\",\"span\":{\"lo\":0,\"hi\":0}},\"id\":7,\"args\":null},{\"ident\":{\"name\":\"v1\",\"span\":{\"lo\":0,\"hi\":0}},\"id\":8,\"args\":null}],\"tokens\":null},\"kind\":\"Glob\",\"span\":{\"lo\":0,\"hi\":0}}]},\"tokens\":null},{\"attrs\":[{\"kind\":{\"variant\":\"Normal\",\"fields\":[{\"path\":{\"span\":{\"lo\":0,\"hi\":0},\"segments\":[{\"ident\":{\"name\":\"macro_use\",\"span\":{\"lo\":0,\"hi\":0}},\"id\":9,\"args\":null}],\"tokens\":null},\"args\":\"Empty\",\"tokens\":null}]},\"id\":null,\"style\":\"Outer\",\"span\":{\"lo\":0,\"hi\":0},\"tokens\":null}],\"id\":10,\"span\":{\"lo\":0,\"hi\":0},\"vis\":{\"kind\":\"Inherited\",\"span\":{\"lo\":0,\"hi\":0},\"tokens\":null},\"ident\":{\"name\":\"std\",\"span\":{\"lo\":0,\"hi\":0}},\"kind\":{\"variant\":\"ExternCrate\",\"fields\":[null]},\"tokens\":null},{\"attrs\":[],\"id\":11,\"span\":{\"lo\":192,\"hi\":204},\"vis\":{\"kind\":\"Inherited\",\"span\":{\"lo\":192,\"hi\":192},\"tokens\":null},\"ident\":{\"name\":\"main\",\"span\":{\"lo\":195,\"hi\":199}},\"kind\":{\"variant\":\"Fn\",\"fields\":[\"Final\",{\"header\":{\"unsafety\":\"No\",\"asyncness\":\"No\",\"constness\":\"No\",\"ext\":\"None\"},\"decl\":{\"inputs\":[],\"output\":{\"variant\":\"Default\",\"fields\":[{\"lo\":202,\"hi\":202}]}},\"span\":{\"lo\":192,\"hi\":201}},{\"params\":[],\"where_clause\":{\"has_where_token\":false,\"predicates\":[],\"span\":{\"lo\":201,\"hi\":201}},\"span\":{\"lo\":199,\"hi\":199}},{\"stmts\":[],\"id\":12,\"rules\":\"Default\",\"span\":{\"lo\":202,\"hi\":204},\"tokens\":null}]},\"tokens\":null},{\"attrs\":[],\"id\":13,\"span\":{\"lo\":206,\"hi\":284},\"vis\":{\"kind\":\"Inherited\",\"span\":{\"lo\":206,\"hi\":206},\"tokens\":null},\"ident\":{\"name\":\"mac_extern\",\"span\":{\"lo\":219,\"hi\":229}},\"kind\":{\"variant\":\"MacroDef\",\"fields\":[{\"body\":{\"variant\":\"Delimited\",\"fields\":[{\"open\":{\"lo\":230,\"hi\":231},\"close\":{\"lo\":283,\"hi\":284}},\"Brace\",{\"0\":[[{\"variant\":\"Delimited\",\"fields\":[{\"open\":{\"lo\":236,\"hi\":237},\"close\":{\"lo\":244,\"hi\":245}},\"Paren\",{\"0\":[[{\"variant\":\"Token\",\"fields\":[{\"kind\":\"Dollar\",\"span\":{\"lo\":237,\"hi\":238}}]},\"Alone\"],[{\"variant\":\"Token\",\"fields\":[{\"kind\":{\"variant\":\"Ident\",\"fields\":[\"i\",false]},\"span\":{\"lo\":238,\"hi\":239}}]},\"Joint\"],[{\"variant\":\"Token\",\"fields\":[{\"kind\":\"Colon\",\"span\":{\"lo\":239,\"hi\":240}}]},\"Alone\"],[{\"variant\":\"Token\",\"fields\":[{\"kind\":{\"variant\":\"Ident\",\"fields\":[\"item\",false]},\"span\":{\"lo\":240,\"hi\":244}}]},\"Alone\"]]}]},\"Alone\"],[{\"variant\":\"Token\",\"fields\":[{\"kind\":\"FatArrow\",\"span\":{\"lo\":246,\"hi\":248}}]},\"Alone\"],[{\"variant\":\"Delimited\",\"fields\":[{\"open\":{\"lo\":249,\"hi\":250},\"close\":{\"lo\":281,\"hi\":282}},\"Brace\",{\"0\":[[{\"variant\":\"Token\",\"fields\":[{\"kind\":{\"variant\":\"Ident\",\"fields\":[\"extern\",false]},\"span\":{\"lo\":259,\"hi\":265}}]},\"Alone\"],[{\"variant\":\"Token\",\"fields\":[{\"kind\":{\"variant\":\"Literal\",\"fields\":[{\"kind\":\"Str\",\"symbol\":\"C\",\"suffix\":null}]},\"span\":{\"lo\":266,\"hi\":269}}]},\"Alone\"],[{\"variant\":\"Delimited\",\"fields\":[{\"open\":{\"lo\":270,\"hi\":271},\"close\":{\"lo\":275,\"hi\":276}},\"Brace\",{\"0\":[[{\"variant\":\"Token\",\"fields\":[{\"kind\":\"Dollar\",\"span\":{\"lo\":272,\"hi\":273}}]},\"Alone\"],[{\"variant\":\"Token\",\"fields\":[{\"kind\":{\"variant\":\"Ident\",\"fields\":[\"i\",false]},\"span\":{\"lo\":273,\"hi\":274}}]},\"Alone\"]]}]},\"Alone\"]]}]},\"Alone\"]]}]},\"macro_rules\":true}]},\"tokens\":null},{\"attrs\":[],\"id\":14,\"span\":{\"lo\":259,\"hi\":276},\"vis\":{\"kind\":\"Inherited\",\"span\":{\"lo\":259,\"hi\":259},\"tokens\":null},\"ident\":{\"name\":\"\",\"span\":{\"lo\":0,\"hi\":0}},\"kind\":{\"variant\":\"ForeignMod\",\"fields\":[{\"unsafety\":\"No\",\"abi\":{\"style\":\"Cooked\",\"symbol\":\"C\",\"suffix\":null,\"span\":{\"lo\":266,\"hi\":269},\"symbol_unescaped\":\"C\"},\"items\":[{\"attrs\":[],\"id\":15,\"span\":{\"lo\":304,\"hi\":313},\"vis\":{\"kind\":\"Inherited\",\"span\":{\"lo\":304,\"hi\":304},\"tokens\":null},\"ident\":{\"name\":\"foo\",\"span\":{\"lo\":307,\"hi\":310}},\"kind\":{\"variant\":\"Fn\",\"fields\":[\"Final\",{\"header\":{\"unsafety\":\"No\",\"asyncness\":\"No\",\"constness\":\"No\",\"ext\":\"None\"},\"decl\":{\"inputs\":[],\"output\":{\"variant\":\"Default\",\"fields\":[{\"lo\":312,\"hi\":312}]}},\"span\":{\"lo\":304,\"hi\":313}},{\"params\":[],\"where_clause\":{\"has_where_token\":false,\"predicates\":[],\"span\":{\"lo\":312,\"hi\":312}},\"span\":{\"lo\":310,\"hi\":310}},null]},\"tokens\":null}]}]},\"tokens\":null}],\"inline\":true},\"attrs\":[],\"span\":{\"lo\":192,\"hi\":315},\"proc_macros\":[]}"}]}