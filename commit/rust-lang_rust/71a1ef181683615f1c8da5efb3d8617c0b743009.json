{"sha": "71a1ef181683615f1c8da5efb3d8617c0b743009", "node_id": "MDY6Q29tbWl0NzI0NzEyOjcxYTFlZjE4MTY4MzYxNWYxYzhkYTVlZmIzZDg2MTdjMGI3NDMwMDk=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-08-22T09:03:25Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-08-22T09:03:25Z"}, "message": "Auto merge of #53516 - petrochenkov:derregr, r=estebank\n\nresolve: Continue search in outer scopes after applying derive resolution fallback\n\nFixes https://github.com/rust-lang/rust/issues/53263", "tree": {"sha": "8b8a6e8fd5ae5369aebd810b4004505352e3427b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8b8a6e8fd5ae5369aebd810b4004505352e3427b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/71a1ef181683615f1c8da5efb3d8617c0b743009", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/71a1ef181683615f1c8da5efb3d8617c0b743009", "html_url": "https://github.com/rust-lang/rust/commit/71a1ef181683615f1c8da5efb3d8617c0b743009", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/71a1ef181683615f1c8da5efb3d8617c0b743009/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "24bc544db4238a8248be7d6e7eae893cf945f1f2", "url": "https://api.github.com/repos/rust-lang/rust/commits/24bc544db4238a8248be7d6e7eae893cf945f1f2", "html_url": "https://github.com/rust-lang/rust/commit/24bc544db4238a8248be7d6e7eae893cf945f1f2"}, {"sha": "7e8825b4ecdc0540dd3008eb9ff6c520bc88799d", "url": "https://api.github.com/repos/rust-lang/rust/commits/7e8825b4ecdc0540dd3008eb9ff6c520bc88799d", "html_url": "https://github.com/rust-lang/rust/commit/7e8825b4ecdc0540dd3008eb9ff6c520bc88799d"}], "stats": {"total": 49, "additions": 38, "deletions": 11}, "files": [{"sha": "004a9a77dd98f61b42069de49724a6a6d9643615", "filename": "src/librustc_resolve/lib.rs", "status": "modified", "additions": 12, "deletions": 11, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/71a1ef181683615f1c8da5efb3d8617c0b743009/src%2Flibrustc_resolve%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/71a1ef181683615f1c8da5efb3d8617c0b743009/src%2Flibrustc_resolve%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Flib.rs?ref=71a1ef181683615f1c8da5efb3d8617c0b743009", "patch": "@@ -1901,12 +1901,13 @@ impl<'a, 'crateloader: 'a> Resolver<'a, 'crateloader> {\n         }\n \n         ident.span = ident.span.modern();\n+        let mut poisoned = None;\n         loop {\n-            let (opt_module, poisoned) = if let Some(node_id) = record_used_id {\n+            let opt_module = if let Some(node_id) = record_used_id {\n                 self.hygienic_lexical_parent_with_compatibility_fallback(module, &mut ident.span,\n-                                                                         node_id)\n+                                                                         node_id, &mut poisoned)\n             } else {\n-                (self.hygienic_lexical_parent(module, &mut ident.span), None)\n+                self.hygienic_lexical_parent(module, &mut ident.span)\n             };\n             module = unwrap_or!(opt_module, break);\n             let orig_current_module = self.current_module;\n@@ -1934,7 +1935,6 @@ impl<'a, 'crateloader: 'a> Resolver<'a, 'crateloader> {\n                     }\n                     return Some(LexicalScopeBinding::Item(binding))\n                 }\n-                _ if poisoned.is_some() => break,\n                 Err(Determined) => continue,\n                 Err(Undetermined) =>\n                     span_bug!(ident.span, \"undetermined resolution during main resolution pass\"),\n@@ -1994,12 +1994,12 @@ impl<'a, 'crateloader: 'a> Resolver<'a, 'crateloader> {\n         None\n     }\n \n-    fn hygienic_lexical_parent_with_compatibility_fallback(\n-        &mut self, module: Module<'a>, span: &mut Span, node_id: NodeId\n-    ) -> (Option<Module<'a>>, /* poisoned */ Option<NodeId>)\n-    {\n+    fn hygienic_lexical_parent_with_compatibility_fallback(&mut self, module: Module<'a>,\n+                                                           span: &mut Span, node_id: NodeId,\n+                                                           poisoned: &mut Option<NodeId>)\n+                                                           -> Option<Module<'a>> {\n         if let module @ Some(..) = self.hygienic_lexical_parent(module, span) {\n-            return (module, None);\n+            return module;\n         }\n \n         // We need to support the next case under a deprecation warning\n@@ -2020,13 +2020,14 @@ impl<'a, 'crateloader: 'a> Resolver<'a, 'crateloader> {\n                 // The macro is a proc macro derive\n                 if module.expansion.looks_like_proc_macro_derive() {\n                     if parent.expansion.is_descendant_of(span.ctxt().outer()) {\n-                        return (module.parent, Some(node_id));\n+                        *poisoned = Some(node_id);\n+                        return module.parent;\n                     }\n                 }\n             }\n         }\n \n-        (None, None)\n+        None\n     }\n \n     fn resolve_ident_in_module(&mut self,"}, {"sha": "6ac6e4f6def5c60a0ac2c1d958be79472db4199a", "filename": "src/test/ui-fulldeps/proc-macro/generate-mod.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/71a1ef181683615f1c8da5efb3d8617c0b743009/src%2Ftest%2Fui-fulldeps%2Fproc-macro%2Fgenerate-mod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/71a1ef181683615f1c8da5efb3d8617c0b743009/src%2Ftest%2Fui-fulldeps%2Fproc-macro%2Fgenerate-mod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui-fulldeps%2Fproc-macro%2Fgenerate-mod.rs?ref=71a1ef181683615f1c8da5efb3d8617c0b743009", "patch": "@@ -31,6 +31,14 @@ struct S;\n                                      //~| WARN this was previously accepted\n struct Z;\n \n+fn inner_block() {\n+    #[derive(generate_mod::CheckDerive)] //~ WARN cannot find type `FromOutside` in this scope\n+                                        //~| WARN cannot find type `OuterDerive` in this scope\n+                                        //~| WARN this was previously accepted\n+                                        //~| WARN this was previously accepted\n+    struct InnerZ;\n+}\n+\n #[derive(generate_mod::CheckDeriveLint)] // OK, lint is suppressed\n struct W;\n "}, {"sha": "87e5fe2554264014ea6da2c7164f4754b72f405c", "filename": "src/test/ui-fulldeps/proc-macro/generate-mod.stderr", "status": "modified", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/71a1ef181683615f1c8da5efb3d8617c0b743009/src%2Ftest%2Fui-fulldeps%2Fproc-macro%2Fgenerate-mod.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/71a1ef181683615f1c8da5efb3d8617c0b743009/src%2Ftest%2Fui-fulldeps%2Fproc-macro%2Fgenerate-mod.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui-fulldeps%2Fproc-macro%2Fgenerate-mod.stderr?ref=71a1ef181683615f1c8da5efb3d8617c0b743009", "patch": "@@ -41,6 +41,24 @@ LL | #[derive(generate_mod::CheckDerive)] //~ WARN cannot find type `FromOutside\n    = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n    = note: for more information, see issue #50504 <https://github.com/rust-lang/rust/issues/50504>\n \n+warning: cannot find type `FromOutside` in this scope\n+  --> $DIR/generate-mod.rs:35:14\n+   |\n+LL |     #[derive(generate_mod::CheckDerive)] //~ WARN cannot find type `FromOutside` in this scope\n+   |              ^^^^^^^^^^^^^^^^^^^^^^^^^ names from parent modules are not accessible without an explicit import\n+   |\n+   = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n+   = note: for more information, see issue #50504 <https://github.com/rust-lang/rust/issues/50504>\n+\n+warning: cannot find type `OuterDerive` in this scope\n+  --> $DIR/generate-mod.rs:35:14\n+   |\n+LL |     #[derive(generate_mod::CheckDerive)] //~ WARN cannot find type `FromOutside` in this scope\n+   |              ^^^^^^^^^^^^^^^^^^^^^^^^^ names from parent modules are not accessible without an explicit import\n+   |\n+   = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n+   = note: for more information, see issue #50504 <https://github.com/rust-lang/rust/issues/50504>\n+\n error: aborting due to 4 previous errors\n \n For more information about this error, try `rustc --explain E0412`."}]}