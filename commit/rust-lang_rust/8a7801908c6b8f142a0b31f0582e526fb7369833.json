{"sha": "8a7801908c6b8f142a0b31f0582e526fb7369833", "node_id": "MDY6Q29tbWl0NzI0NzEyOjhhNzgwMTkwOGM2YjhmMTQyYTBiMzFmMDU4MmU1MjZmYjczNjk4MzM=", "commit": {"author": {"name": "Matthew Jasper", "email": "mjjasper1@gmail.com", "date": "2019-03-03T19:27:41Z"}, "committer": {"name": "Matthew Jasper", "email": "mjjasper1@gmail.com", "date": "2019-03-03T20:34:26Z"}, "message": "Don't incorrectly mark blocks in generator drop shims as cleanup\n\nThis also ensure that dropping a generator won't leak upvars if dropping\none of them panics", "tree": {"sha": "2f0e5032a79cdbe7672342ff76327b72a4721faa", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2f0e5032a79cdbe7672342ff76327b72a4721faa"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8a7801908c6b8f142a0b31f0582e526fb7369833", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8a7801908c6b8f142a0b31f0582e526fb7369833", "html_url": "https://github.com/rust-lang/rust/commit/8a7801908c6b8f142a0b31f0582e526fb7369833", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8a7801908c6b8f142a0b31f0582e526fb7369833/comments", "author": {"login": "matthewjasper", "id": 20113453, "node_id": "MDQ6VXNlcjIwMTEzNDUz", "avatar_url": "https://avatars.githubusercontent.com/u/20113453?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthewjasper", "html_url": "https://github.com/matthewjasper", "followers_url": "https://api.github.com/users/matthewjasper/followers", "following_url": "https://api.github.com/users/matthewjasper/following{/other_user}", "gists_url": "https://api.github.com/users/matthewjasper/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthewjasper/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthewjasper/subscriptions", "organizations_url": "https://api.github.com/users/matthewjasper/orgs", "repos_url": "https://api.github.com/users/matthewjasper/repos", "events_url": "https://api.github.com/users/matthewjasper/events{/privacy}", "received_events_url": "https://api.github.com/users/matthewjasper/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matthewjasper", "id": 20113453, "node_id": "MDQ6VXNlcjIwMTEzNDUz", "avatar_url": "https://avatars.githubusercontent.com/u/20113453?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthewjasper", "html_url": "https://github.com/matthewjasper", "followers_url": "https://api.github.com/users/matthewjasper/followers", "following_url": "https://api.github.com/users/matthewjasper/following{/other_user}", "gists_url": "https://api.github.com/users/matthewjasper/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthewjasper/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthewjasper/subscriptions", "organizations_url": "https://api.github.com/users/matthewjasper/orgs", "repos_url": "https://api.github.com/users/matthewjasper/repos", "events_url": "https://api.github.com/users/matthewjasper/events{/privacy}", "received_events_url": "https://api.github.com/users/matthewjasper/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2131b153b33f7ba2dc0a7cd3ea4efd1bc4a03ba2", "url": "https://api.github.com/repos/rust-lang/rust/commits/2131b153b33f7ba2dc0a7cd3ea4efd1bc4a03ba2", "html_url": "https://github.com/rust-lang/rust/commit/2131b153b33f7ba2dc0a7cd3ea4efd1bc4a03ba2"}], "stats": {"total": 89, "additions": 65, "deletions": 24}, "files": [{"sha": "9c212e36761c09daced79c527fe2f34cdb474479", "filename": "src/librustc_mir/transform/generator.rs", "status": "modified", "additions": 22, "deletions": 24, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/8a7801908c6b8f142a0b31f0582e526fb7369833/src%2Flibrustc_mir%2Ftransform%2Fgenerator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8a7801908c6b8f142a0b31f0582e526fb7369833/src%2Flibrustc_mir%2Ftransform%2Fgenerator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fgenerator.rs?ref=8a7801908c6b8f142a0b31f0582e526fb7369833", "patch": "@@ -592,8 +592,15 @@ fn elaborate_generator_drops<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>,\n     let param_env = tcx.param_env(def_id);\n     let gen = self_arg();\n \n-    for block in mir.basic_blocks().indices() {\n-        let (target, unwind, source_info) = match mir.basic_blocks()[block].terminator() {\n+    let mut elaborator = DropShimElaborator {\n+        mir: mir,\n+        patch: MirPatch::new(mir),\n+        tcx,\n+        param_env\n+    };\n+\n+    for (block, block_data) in mir.basic_blocks().iter_enumerated() {\n+        let (target, unwind, source_info) = match block_data.terminator() {\n             &Terminator {\n                 source_info,\n                 kind: TerminatorKind::Drop {\n@@ -604,31 +611,22 @@ fn elaborate_generator_drops<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>,\n             } if local == gen => (target, unwind, source_info),\n             _ => continue,\n         };\n-        let unwind = if let Some(unwind) = unwind {\n-            Unwind::To(unwind)\n-        } else {\n+        let unwind = if block_data.is_cleanup {\n             Unwind::InCleanup\n+        } else {\n+            Unwind::To(unwind.unwrap_or_else(|| elaborator.patch.resume_block()))\n         };\n-        let patch = {\n-            let mut elaborator = DropShimElaborator {\n-                mir: &mir,\n-                patch: MirPatch::new(mir),\n-                tcx,\n-                param_env\n-            };\n-            elaborate_drop(\n-                &mut elaborator,\n-                source_info,\n-                &Place::Base(PlaceBase::Local(gen)),\n-                (),\n-                target,\n-                unwind,\n-                block\n-            );\n-            elaborator.patch\n-        };\n-        patch.apply(mir);\n+        elaborate_drop(\n+            &mut elaborator,\n+            source_info,\n+            &Place::Base(PlaceBase::Local(gen)),\n+            (),\n+            target,\n+            unwind,\n+            block,\n+        );\n     }\n+    elaborator.patch.apply(mir);\n }\n \n fn create_generator_drop_shim<'a, 'tcx>("}, {"sha": "48398691271baa69536ebd6e3d5eae3fd636318a", "filename": "src/test/mir-opt/generator-drop-cleanup.rs", "status": "added", "additions": 43, "deletions": 0, "changes": 43, "blob_url": "https://github.com/rust-lang/rust/blob/8a7801908c6b8f142a0b31f0582e526fb7369833/src%2Ftest%2Fmir-opt%2Fgenerator-drop-cleanup.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8a7801908c6b8f142a0b31f0582e526fb7369833/src%2Ftest%2Fmir-opt%2Fgenerator-drop-cleanup.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fgenerator-drop-cleanup.rs?ref=8a7801908c6b8f142a0b31f0582e526fb7369833", "patch": "@@ -0,0 +1,43 @@\n+#![feature(generators, generator_trait)]\n+\n+// Regression test for #58892, generator drop shims should not have blocks\n+// spuriously marked as cleanup\n+\n+fn main() {\n+    let gen = || {\n+        yield;\n+    };\n+}\n+\n+// END RUST SOURCE\n+\n+// START rustc.main-{{closure}}.generator_drop.0.mir\n+// bb0: {\n+//     switchInt(((*_1).0: u32)) -> [0u32: bb4, 3u32: bb7, otherwise: bb8];\n+// }\n+// bb1: {\n+//     goto -> bb5;\n+// }\n+// bb2: {\n+//     return;\n+// }\n+// bb3: {\n+//     return;\n+// }\n+// bb4: {\n+//     goto -> bb6;\n+// }\n+// bb5: {\n+//     goto -> bb2;\n+// }\n+// bb6: {\n+//     goto -> bb3;\n+// }\n+// bb7: {\n+//     StorageLive(_3);\n+//     goto -> bb1;\n+// }\n+// bb8: {\n+//     return;\n+// }\n+// END rustc.main-{{closure}}.generator_drop.0.mir"}]}