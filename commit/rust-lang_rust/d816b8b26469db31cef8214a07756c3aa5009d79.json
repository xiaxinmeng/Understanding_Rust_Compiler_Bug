{"sha": "d816b8b26469db31cef8214a07756c3aa5009d79", "node_id": "C_kwDOAAsO6NoAKGQ4MTZiOGIyNjQ2OWRiMzFjZWY4MjE0YTA3NzU2YzNhYTUwMDlkNzk", "commit": {"author": {"name": "Brian M", "email": "bmisiak@me.com", "date": "2023-05-09T07:14:14Z"}, "committer": {"name": "Brian M", "email": "bmisiak@me.com", "date": "2023-05-25T07:02:13Z"}, "message": "Fix Mac Catalyst linking by adding build version\nIssue #106021\nApple LD requires build versions in object files for Catalyst", "tree": {"sha": "e234b75c167c84b35e2b7a10b0b72fc9097cd338", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e234b75c167c84b35e2b7a10b0b72fc9097cd338"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d816b8b26469db31cef8214a07756c3aa5009d79", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d816b8b26469db31cef8214a07756c3aa5009d79", "html_url": "https://github.com/rust-lang/rust/commit/d816b8b26469db31cef8214a07756c3aa5009d79", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d816b8b26469db31cef8214a07756c3aa5009d79/comments", "author": {"login": "bmisiak", "id": 2332213, "node_id": "MDQ6VXNlcjIzMzIyMTM=", "avatar_url": "https://avatars.githubusercontent.com/u/2332213?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bmisiak", "html_url": "https://github.com/bmisiak", "followers_url": "https://api.github.com/users/bmisiak/followers", "following_url": "https://api.github.com/users/bmisiak/following{/other_user}", "gists_url": "https://api.github.com/users/bmisiak/gists{/gist_id}", "starred_url": "https://api.github.com/users/bmisiak/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bmisiak/subscriptions", "organizations_url": "https://api.github.com/users/bmisiak/orgs", "repos_url": "https://api.github.com/users/bmisiak/repos", "events_url": "https://api.github.com/users/bmisiak/events{/privacy}", "received_events_url": "https://api.github.com/users/bmisiak/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bmisiak", "id": 2332213, "node_id": "MDQ6VXNlcjIzMzIyMTM=", "avatar_url": "https://avatars.githubusercontent.com/u/2332213?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bmisiak", "html_url": "https://github.com/bmisiak", "followers_url": "https://api.github.com/users/bmisiak/followers", "following_url": "https://api.github.com/users/bmisiak/following{/other_user}", "gists_url": "https://api.github.com/users/bmisiak/gists{/gist_id}", "starred_url": "https://api.github.com/users/bmisiak/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bmisiak/subscriptions", "organizations_url": "https://api.github.com/users/bmisiak/orgs", "repos_url": "https://api.github.com/users/bmisiak/repos", "events_url": "https://api.github.com/users/bmisiak/events{/privacy}", "received_events_url": "https://api.github.com/users/bmisiak/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7664dfe4331265d0b2b1ffb89c92d443886bec0b", "url": "https://api.github.com/repos/rust-lang/rust/commits/7664dfe4331265d0b2b1ffb89c92d443886bec0b", "html_url": "https://github.com/rust-lang/rust/commit/7664dfe4331265d0b2b1ffb89c92d443886bec0b"}], "stats": {"total": 32, "additions": 32, "deletions": 0}, "files": [{"sha": "ad27b854d59a2553f240cc1ed00b3a93d5162a99", "filename": "compiler/rustc_codegen_ssa/src/back/metadata.rs", "status": "modified", "additions": 32, "deletions": 0, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/d816b8b26469db31cef8214a07756c3aa5009d79/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Fmetadata.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d816b8b26469db31cef8214a07756c3aa5009d79/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Fmetadata.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Fmetadata.rs?ref=d816b8b26469db31cef8214a07756c3aa5009d79", "patch": "@@ -188,6 +188,11 @@ pub(crate) fn create_object_file(sess: &Session) -> Option<write::Object<'static\n     };\n \n     let mut file = write::Object::new(binary_format, architecture, endianness);\n+    if sess.target.is_like_osx {\n+        if let Some(build_version) = macho_object_build_version_for_target(&sess.target) {\n+            file.set_macho_build_version(build_version)\n+        }\n+    }\n     let e_flags = match architecture {\n         Architecture::Mips => {\n             let arch = match sess.target.options.cpu.as_ref() {\n@@ -258,6 +263,33 @@ pub(crate) fn create_object_file(sess: &Session) -> Option<write::Object<'static\n     Some(file)\n }\n \n+/// Apple's LD, when linking for Mac Catalyst, requires object files to\n+/// contain information about what they were built for (LC_BUILD_VERSION):\n+/// the platform (macOS/watchOS etc), minimum OS version, and SDK version.\n+/// This returns a `MachOBuildVersion` if necessary for the target.\n+fn macho_object_build_version_for_target(\n+    target: &Target,\n+) -> Option<object::write::MachOBuildVersion> {\n+    if !target.llvm_target.ends_with(\"-macabi\") {\n+        return None;\n+    }\n+    /// The `object` crate demands \"X.Y.Z encoded in nibbles as xxxx.yy.zz\"\n+    /// e.g. minOS 14.0 = 0x000E0000, or SDK 16.2 = 0x00100200\n+    fn pack_version((major, minor): (u32, u32)) -> u32 {\n+        (major << 16) | (minor << 8)\n+    }\n+\n+    let platform = object::macho::PLATFORM_MACCATALYST;\n+    let min_os = (14, 0);\n+    let sdk = (16, 2);\n+\n+    let mut build_version = object::write::MachOBuildVersion::default();\n+    build_version.platform = platform;\n+    build_version.minos = pack_version(min_os);\n+    build_version.sdk = pack_version(sdk);\n+    Some(build_version)\n+}\n+\n pub enum MetadataPosition {\n     First,\n     Last,"}]}