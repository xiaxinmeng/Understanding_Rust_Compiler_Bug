{"sha": "72308b1c23c3c0a00ab68d50f544e3761fbca024", "node_id": "MDY6Q29tbWl0NzI0NzEyOjcyMzA4YjFjMjNjM2MwYTAwYWI2OGQ1MGY1NDRlMzc2MWZiY2EwMjQ=", "commit": {"author": {"name": "Corey Farwell", "email": "coreyf@rwell.org", "date": "2017-04-07T13:20:10Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2017-04-07T13:20:10Z"}, "message": "Rollup merge of #41130 - petrhosek:fuchsia-ci-upstream, r=alexcrichton\n\ntravis: Use upstream LLVM repositories for Fuchsia\n\nThe Fuchsia copies of LLVM repositories contain additional patches\nfor work-in-progress features and there is some amount of churn that\nmay break Rust. Use upstream LLVM repositories instead for building\nthe toolchain used by the Fuchsia builder.", "tree": {"sha": "133aa5d1b8e0483fd01e92c73c9b086889aadf5f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/133aa5d1b8e0483fd01e92c73c9b086889aadf5f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/72308b1c23c3c0a00ab68d50f544e3761fbca024", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/72308b1c23c3c0a00ab68d50f544e3761fbca024", "html_url": "https://github.com/rust-lang/rust/commit/72308b1c23c3c0a00ab68d50f544e3761fbca024", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/72308b1c23c3c0a00ab68d50f544e3761fbca024/comments", "author": {"login": "frewsxcv", "id": 416575, "node_id": "MDQ6VXNlcjQxNjU3NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/416575?v=4", "gravatar_id": "", "url": "https://api.github.com/users/frewsxcv", "html_url": "https://github.com/frewsxcv", "followers_url": "https://api.github.com/users/frewsxcv/followers", "following_url": "https://api.github.com/users/frewsxcv/following{/other_user}", "gists_url": "https://api.github.com/users/frewsxcv/gists{/gist_id}", "starred_url": "https://api.github.com/users/frewsxcv/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/frewsxcv/subscriptions", "organizations_url": "https://api.github.com/users/frewsxcv/orgs", "repos_url": "https://api.github.com/users/frewsxcv/repos", "events_url": "https://api.github.com/users/frewsxcv/events{/privacy}", "received_events_url": "https://api.github.com/users/frewsxcv/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "25518db1dcba45c411eeb98cd6d455470bfb3794", "url": "https://api.github.com/repos/rust-lang/rust/commits/25518db1dcba45c411eeb98cd6d455470bfb3794", "html_url": "https://github.com/rust-lang/rust/commit/25518db1dcba45c411eeb98cd6d455470bfb3794"}, {"sha": "b135c1291d8cc186647092765c5d94955a311410", "url": "https://api.github.com/repos/rust-lang/rust/commits/b135c1291d8cc186647092765c5d94955a311410", "html_url": "https://github.com/rust-lang/rust/commit/b135c1291d8cc186647092765c5d94955a311410"}], "stats": {"total": 76, "additions": 64, "deletions": 12}, "files": [{"sha": "4a401bbb3031fd1aa8240ee1f5e1ab84cd105c1c", "filename": "src/ci/docker/dist-fuchsia/Dockerfile", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/72308b1c23c3c0a00ab68d50f544e3761fbca024/src%2Fci%2Fdocker%2Fdist-fuchsia%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/72308b1c23c3c0a00ab68d50f544e3761fbca024/src%2Fci%2Fdocker%2Fdist-fuchsia%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-fuchsia%2FDockerfile?ref=72308b1c23c3c0a00ab68d50f544e3761fbca024", "patch": "@@ -14,13 +14,14 @@ RUN apt-get update && apt-get install -y --no-install-recommends \\\n   xz-utils \\\n   swig \\\n   libedit-dev \\\n-  libncurses5-dev\n+  libncurses5-dev \\\n+  patch\n \n RUN curl -L https://cmake.org/files/v3.8/cmake-3.8.0-rc1-Linux-x86_64.tar.gz | \\\n       tar xzf - -C /usr/local --strip-components=1\n \n WORKDIR /tmp\n-COPY shared.sh build-toolchain.sh /tmp/\n+COPY shared.sh build-toolchain.sh compiler-rt-dso-handle.patch /tmp/\n RUN /tmp/build-toolchain.sh\n \n RUN curl -OL https://github.com/Yelp/dumb-init/releases/download/v1.2.0/dumb-init_1.2.0_amd64.deb && \\"}, {"sha": "10b285a546655a8ba9c99b154d95f5e17c11f838", "filename": "src/ci/docker/dist-fuchsia/build-toolchain.sh", "status": "modified", "additions": 20, "deletions": 10, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/72308b1c23c3c0a00ab68d50f544e3761fbca024/src%2Fci%2Fdocker%2Fdist-fuchsia%2Fbuild-toolchain.sh", "raw_url": "https://github.com/rust-lang/rust/raw/72308b1c23c3c0a00ab68d50f544e3761fbca024/src%2Fci%2Fdocker%2Fdist-fuchsia%2Fbuild-toolchain.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-fuchsia%2Fbuild-toolchain.sh?ref=72308b1c23c3c0a00ab68d50f544e3761fbca024", "patch": "@@ -9,33 +9,43 @@\n # option. This file may not be copied, modified, or distributed\n # except according to those terms.\n \n+# ignore-tidy-linelength\n+\n set -ex\n source shared.sh\n \n # Download sources\n SRCS=(\n-  \"https://fuchsia.googlesource.com/magenta magenta ac69119\"\n-  \"https://fuchsia.googlesource.com/third_party/llvm llvm 5463083\"\n-  \"https://fuchsia.googlesource.com/third_party/clang llvm/tools/clang 4ff7b4b\"\n-  \"https://fuchsia.googlesource.com/third_party/lld llvm/tools/lld fd465a3\"\n-  \"https://fuchsia.googlesource.com/third_party/lldb llvm/tools/lldb 6bb11f8\"\n-  \"https://fuchsia.googlesource.com/third_party/compiler-rt llvm/runtimes/compiler-rt 52d4ecc\"\n-  \"https://fuchsia.googlesource.com/third_party/libcxx llvm/runtimes/libcxx e891cc8\"\n-  \"https://fuchsia.googlesource.com/third_party/libcxxabi llvm/runtimes/libcxxabi f0f0257\"\n-  \"https://fuchsia.googlesource.com/third_party/libunwind llvm/runtimes/libunwind 50bddc1\"\n+  \"https://fuchsia.googlesource.com/magenta magenta d17073dc8de344ead3b65e8cc6a12280dec38c84\"\n+  \"https://llvm.googlesource.com/llvm llvm 3f58a16d8eec385e2b3ebdfbb84ff9d3bf27e025\"\n+  \"https://llvm.googlesource.com/clang llvm/tools/clang 727ea63e6e82677f6e10e05e08bc7d6bdbae3111\"\n+  \"https://llvm.googlesource.com/lld llvm/tools/lld a31286c1366e5e89b8872803fded13805a1a084b\"\n+  \"https://llvm.googlesource.com/lldb llvm/tools/lldb 0b2384abec4cb99ad66687712e07dee4dd9d187e\"\n+  \"https://llvm.googlesource.com/compiler-rt llvm/runtimes/compiler-rt 9093a35c599fe41278606a20b51095ea8bd5a081\"\n+  \"https://llvm.googlesource.com/libcxx llvm/runtimes/libcxx 607e0c71ec4f7fd377ad3f6c47b08dbe89f66eaa\"\n+  \"https://llvm.googlesource.com/libcxxabi llvm/runtimes/libcxxabi 0a3a1a8a5ca5ef69e0f6b7d5b9d13e63e6fd2c19\"\n+  \"https://llvm.googlesource.com/libunwind llvm/runtimes/libunwind e128003563d99d9ee62247c4cee40f07d21c03e3\"\n )\n \n fetch() {\n   mkdir -p $2\n   pushd $2 > /dev/null\n-  curl -sL $1/+archive/$3.tar.gz | tar xzf -\n+  git init\n+  git remote add origin $1\n+  git fetch --depth=1 origin $3\n+  git reset --hard FETCH_HEAD\n   popd > /dev/null\n }\n \n for i in \"${SRCS[@]}\"; do\n   fetch $i\n done\n \n+# Remove this once https://reviews.llvm.org/D28791 is resolved\n+cd llvm/runtimes/compiler-rt\n+patch -Np1 < /tmp/compiler-rt-dso-handle.patch\n+cd ../../..\n+\n # Build toolchain\n cd llvm\n mkdir build"}, {"sha": "0b702894bb216481125219d51de73ce4fb69cf4d", "filename": "src/ci/docker/dist-fuchsia/compiler-rt-dso-handle.patch", "status": "added", "additions": 41, "deletions": 0, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/72308b1c23c3c0a00ab68d50f544e3761fbca024/src%2Fci%2Fdocker%2Fdist-fuchsia%2Fcompiler-rt-dso-handle.patch", "raw_url": "https://github.com/rust-lang/rust/raw/72308b1c23c3c0a00ab68d50f544e3761fbca024/src%2Fci%2Fdocker%2Fdist-fuchsia%2Fcompiler-rt-dso-handle.patch", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-fuchsia%2Fcompiler-rt-dso-handle.patch?ref=72308b1c23c3c0a00ab68d50f544e3761fbca024", "patch": "@@ -0,0 +1,41 @@\n+diff --git a/lib/builtins/CMakeLists.txt b/lib/builtins/CMakeLists.txt\n+index fc4384af2..b442264c0 100644\n+--- a/lib/builtins/CMakeLists.txt\n++++ b/lib/builtins/CMakeLists.txt\n+@@ -194,6 +194,12 @@ if(APPLE)\n+     atomic_thread_fence.c)\n+ endif()\n+ \n++if(FUCHSIA)\n++  set(GENERIC_SOURCES\n++    ${GENERIC_SOURCES}\n++    dso_handle.c)\n++endif()\n++\n+ if(NOT WIN32 OR MINGW)\n+   set(GENERIC_SOURCES\n+       ${GENERIC_SOURCES}\n+diff --git a/lib/builtins/dso_handle.c b/lib/builtins/dso_handle.c\n+new file mode 100644\n+index 000000000..7766cd0aa\n+--- /dev/null\n++++ b/lib/builtins/dso_handle.c\n+@@ -0,0 +1,18 @@\n++/* ===-- dso_handle.c - Provide __dso_handle -------------------------------===\n++ *\n++ *               The LLVM Compiler Infrastructure\n++ *\n++ * This file is dual licensed under the MIT and the University of Illinois Open\n++ * Source Licenses. See LICENSE.TXT for details.\n++ *\n++ * ===----------------------------------------------------------------------===\n++ */\n++\n++/* __dso_handle symbol is mandated by C++ ABI with a value which is an address\n++ * in one of the object's segments, and as such this symbol has to be included\n++ * statically and cannot be a part of a shared library. Traditionally, it has\n++ * been defined in crtbegin.o but there's no principled reason for it to be\n++ * there. We defined this symbol in the builtin library which is built as a\n++ * static library and always included in the final link.\n++ */\n++__attribute__((visibility(\"hidden\"))) void *const __dso_handle;"}]}