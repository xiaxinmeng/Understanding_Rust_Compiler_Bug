{"sha": "d6fc3e176eb0a015e9911a60fc1a5e0b6103416a", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ2ZmMzZTE3NmViMGEwMTVlOTkxMWE2MGZjMWE1ZTBiNjEwMzQxNmE=", "commit": {"author": {"name": "Oliver Schneider", "email": "github35764891676564198441@oli-obk.de", "date": "2018-05-18T13:16:57Z"}, "committer": {"name": "Oliver Schneider", "email": "github35764891676564198441@oli-obk.de", "date": "2018-05-21T16:59:09Z"}, "message": "Make `[T]::len` and `str::len` const fn", "tree": {"sha": "fd491d2b2a899778d6fc1f6dd0c7a1a560dceb2c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fd491d2b2a899778d6fc1f6dd0c7a1a560dceb2c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d6fc3e176eb0a015e9911a60fc1a5e0b6103416a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d6fc3e176eb0a015e9911a60fc1a5e0b6103416a", "html_url": "https://github.com/rust-lang/rust/commit/d6fc3e176eb0a015e9911a60fc1a5e0b6103416a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d6fc3e176eb0a015e9911a60fc1a5e0b6103416a/comments", "author": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "committer": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ba1363ffe12ac1ac796a620aef2008e4ae6c0477", "url": "https://api.github.com/repos/rust-lang/rust/commits/ba1363ffe12ac1ac796a620aef2008e4ae6c0477", "html_url": "https://github.com/rust-lang/rust/commit/ba1363ffe12ac1ac796a620aef2008e4ae6c0477"}], "stats": {"total": 81, "additions": 65, "deletions": 16}, "files": [{"sha": "d37629ced11dbfa0175fe9d6108388a362b50a23", "filename": "src/libcore/lib.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/d6fc3e176eb0a015e9911a60fc1a5e0b6103416a/src%2Flibcore%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d6fc3e176eb0a015e9911a60fc1a5e0b6103416a/src%2Flibcore%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Flib.rs?ref=d6fc3e176eb0a015e9911a60fc1a5e0b6103416a", "patch": "@@ -119,6 +119,9 @@\n #![feature(powerpc_target_feature)]\n #![feature(mips_target_feature)]\n #![feature(aarch64_target_feature)]\n+#![feature(const_slice_len)]\n+#![feature(const_str_as_bytes)]\n+#![feature(const_str_len)]\n \n #[prelude_import]\n #[allow(unused)]"}, {"sha": "b453edcb4e193ed29191fb2ccf7c10611aab4275", "filename": "src/libcore/slice/mod.rs", "status": "modified", "additions": 21, "deletions": 11, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/d6fc3e176eb0a015e9911a60fc1a5e0b6103416a/src%2Flibcore%2Fslice%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d6fc3e176eb0a015e9911a60fc1a5e0b6103416a/src%2Flibcore%2Fslice%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fslice%2Fmod.rs?ref=d6fc3e176eb0a015e9911a60fc1a5e0b6103416a", "patch": "@@ -59,9 +59,16 @@ mod rotate;\n mod sort;\n \n #[repr(C)]\n-struct Repr<T> {\n-    pub data: *const T,\n-    pub len: usize,\n+union Repr<'a, T: 'a> {\n+    rust: &'a [T],\n+    rust_mut: &'a mut [T],\n+    raw: FatPtr<T>,\n+}\n+\n+#[repr(C)]\n+struct FatPtr<T> {\n+    data: *const T,\n+    len: usize,\n }\n \n //\n@@ -119,9 +126,10 @@ impl<T> [T] {\n     /// ```\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n     #[inline]\n-    pub fn len(&self) -> usize {\n+    #[rustc_const_unstable(feature = \"const_slice_len\")]\n+    pub const fn len(&self) -> usize {\n         unsafe {\n-            mem::transmute::<&[T], Repr<T>>(self).len\n+            Repr { rust: self }.raw.len\n         }\n     }\n \n@@ -135,7 +143,8 @@ impl<T> [T] {\n     /// ```\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n     #[inline]\n-    pub fn is_empty(&self) -> bool {\n+    #[rustc_const_unstable(feature = \"const_slice_len\")]\n+    pub const fn is_empty(&self) -> bool {\n         self.len() == 0\n     }\n \n@@ -418,7 +427,8 @@ impl<T> [T] {\n     /// ```\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n     #[inline]\n-    pub fn as_ptr(&self) -> *const T {\n+    #[rustc_const_unstable(feature = \"const_slice_as_ptr\")]\n+    pub const fn as_ptr(&self) -> *const T {\n         self as *const [T] as *const T\n     }\n \n@@ -3856,8 +3866,8 @@ unsafe impl<'a, T> TrustedRandomAccess for ExactChunksMut<'a, T> {\n /// ```\n #[inline]\n #[stable(feature = \"rust1\", since = \"1.0.0\")]\n-pub unsafe fn from_raw_parts<'a, T>(p: *const T, len: usize) -> &'a [T] {\n-    mem::transmute(Repr { data: p, len: len })\n+pub unsafe fn from_raw_parts<'a, T>(data: *const T, len: usize) -> &'a [T] {\n+    Repr { raw: FatPtr { data, len } }.rust\n }\n \n /// Performs the same functionality as `from_raw_parts`, except that a mutable\n@@ -3869,8 +3879,8 @@ pub unsafe fn from_raw_parts<'a, T>(p: *const T, len: usize) -> &'a [T] {\n /// `from_raw_parts`.\n #[inline]\n #[stable(feature = \"rust1\", since = \"1.0.0\")]\n-pub unsafe fn from_raw_parts_mut<'a, T>(p: *mut T, len: usize) -> &'a mut [T] {\n-    mem::transmute(Repr { data: p, len: len })\n+pub unsafe fn from_raw_parts_mut<'a, T>(data: *mut T, len: usize) -> &'a mut [T] {\n+    Repr { raw: FatPtr { data, len} }.rust_mut\n }\n \n /// Converts a reference to T into a slice of length 1 (without copying)."}, {"sha": "70aaf10f4213e95b613cc6d3da727a9ccf6df007", "filename": "src/libcore/str/mod.rs", "status": "modified", "additions": 15, "deletions": 5, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/d6fc3e176eb0a015e9911a60fc1a5e0b6103416a/src%2Flibcore%2Fstr%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d6fc3e176eb0a015e9911a60fc1a5e0b6103416a/src%2Flibcore%2Fstr%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fstr%2Fmod.rs?ref=d6fc3e176eb0a015e9911a60fc1a5e0b6103416a", "patch": "@@ -2166,7 +2166,8 @@ impl str {\n     /// ```\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n     #[inline]\n-    pub fn len(&self) -> usize {\n+    #[rustc_const_unstable(feature = \"const_str_len\")]\n+    pub const fn len(&self) -> usize {\n         self.as_bytes().len()\n     }\n \n@@ -2185,7 +2186,8 @@ impl str {\n     /// ```\n     #[inline]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n-    pub fn is_empty(&self) -> bool {\n+    #[rustc_const_unstable(feature = \"const_str_len\")]\n+    pub const fn is_empty(&self) -> bool {\n         self.len() == 0\n     }\n \n@@ -2242,8 +2244,15 @@ impl str {\n     /// ```\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n     #[inline(always)]\n-    pub fn as_bytes(&self) -> &[u8] {\n-        unsafe { &*(self as *const str as *const [u8]) }\n+    #[rustc_const_unstable(feature=\"const_str_as_bytes\")]\n+    pub const fn as_bytes(&self) -> &[u8] {\n+        unsafe {\n+            union Slices<'a> {\n+                str: &'a str,\n+                slice: &'a [u8],\n+            }\n+            Slices { str: self }.slice\n+        }\n     }\n \n     /// Converts a mutable string slice to a mutable byte slice. To convert the\n@@ -2303,7 +2312,8 @@ impl str {\n     /// ```\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n     #[inline]\n-    pub fn as_ptr(&self) -> *const u8 {\n+    #[rustc_const_unstable(feature = \"const_str_as_ptr\")]\n+    pub const fn as_ptr(&self) -> *const u8 {\n         self as *const str as *const u8\n     }\n "}, {"sha": "bdadf5dd5e14a1d8e24b04dc6acbee2f414f640f", "filename": "src/test/ui/const-eval/strlen.rs", "status": "added", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/d6fc3e176eb0a015e9911a60fc1a5e0b6103416a/src%2Ftest%2Fui%2Fconst-eval%2Fstrlen.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d6fc3e176eb0a015e9911a60fc1a5e0b6103416a/src%2Ftest%2Fui%2Fconst-eval%2Fstrlen.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconst-eval%2Fstrlen.rs?ref=d6fc3e176eb0a015e9911a60fc1a5e0b6103416a", "patch": "@@ -0,0 +1,26 @@\n+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// compile-pass\n+\n+#![feature(const_str_len, const_str_as_bytes)]\n+\n+#![crate_type = \"lib\"]\n+\n+const S: &str = \"foo\";\n+pub const B: &[u8] = S.as_bytes();\n+\n+pub fn foo() -> [u8; S.len()] {\n+    let mut buf = [0; S.len()];\n+    for (i, &c) in S.as_bytes().iter().enumerate() {\n+        buf[i] = c;\n+    }\n+    buf\n+}"}]}