{"sha": "2631aeef823a9e16d31f999d3f07001e5fcc4b3d", "node_id": "C_kwDOAAsO6NoAKDI2MzFhZWVmODIzYTllMTZkMzFmOTk5ZDNmMDcwMDFlNWZjYzRiM2Q", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-03-07T04:48:23Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-03-07T04:48:23Z"}, "message": "Auto merge of #94272 - tavianator:readdir-reclen-for-real, r=cuviper\n\nfs: Don't dereference a pointer to a too-small allocation\n\nptr::addr_of!((*ptr).field) still requires ptr to point to an\nappropriate allocation for its type.  Since the pointer returned by\nreaddir() can be smaller than sizeof(struct dirent), we need to entirely\navoid dereferencing it as that type.\n\nLink: https://github.com/rust-lang/miri/pull/1981#issuecomment-1048278492\nLink: https://github.com/rust-lang/rust/pull/93459#discussion_r795089971", "tree": {"sha": "179d71546b3d7d779dc697e4b65a9adac517cbb4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/179d71546b3d7d779dc697e4b65a9adac517cbb4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2631aeef823a9e16d31f999d3f07001e5fcc4b3d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2631aeef823a9e16d31f999d3f07001e5fcc4b3d", "html_url": "https://github.com/rust-lang/rust/commit/2631aeef823a9e16d31f999d3f07001e5fcc4b3d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2631aeef823a9e16d31f999d3f07001e5fcc4b3d/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3d1eaf4b6203ab0168da5b99049942385aa753e0", "url": "https://api.github.com/repos/rust-lang/rust/commits/3d1eaf4b6203ab0168da5b99049942385aa753e0", "html_url": "https://github.com/rust-lang/rust/commit/3d1eaf4b6203ab0168da5b99049942385aa753e0"}, {"sha": "478cf8b3a455db83473d89f8d856ae309974e4ee", "url": "https://api.github.com/repos/rust-lang/rust/commits/478cf8b3a455db83473d89f8d856ae309974e4ee", "html_url": "https://github.com/rust-lang/rust/commit/478cf8b3a455db83473d89f8d856ae309974e4ee"}], "stats": {"total": 14, "additions": 9, "deletions": 5}, "files": [{"sha": "03684608f75a62ed432d62ef55d49c796339fa3a", "filename": "library/std/src/sys/unix/fs.rs", "status": "modified", "additions": 9, "deletions": 5, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/2631aeef823a9e16d31f999d3f07001e5fcc4b3d/library%2Fstd%2Fsrc%2Fsys%2Funix%2Ffs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2631aeef823a9e16d31f999d3f07001e5fcc4b3d/library%2Fstd%2Fsrc%2Fsys%2Funix%2Ffs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Funix%2Ffs.rs?ref=2631aeef823a9e16d31f999d3f07001e5fcc4b3d", "patch": "@@ -491,14 +491,18 @@ impl Iterator for ReadDir {\n \n                 // Only d_reclen bytes of *entry_ptr are valid, so we can't just copy the\n                 // whole thing (#93384).  Instead, copy everything except the name.\n+                let mut copy: dirent64 = mem::zeroed();\n+                // Can't dereference entry_ptr, so use the local entry to get\n+                // offsetof(struct dirent, d_name)\n+                let copy_bytes = &mut copy as *mut _ as *mut u8;\n+                let copy_name = &mut copy.d_name as *mut _ as *mut u8;\n+                let name_offset = copy_name.offset_from(copy_bytes) as usize;\n                 let entry_bytes = entry_ptr as *const u8;\n-                let entry_name = ptr::addr_of!((*entry_ptr).d_name) as *const u8;\n-                let name_offset = entry_name.offset_from(entry_bytes) as usize;\n-                let mut entry: dirent64 = mem::zeroed();\n-                ptr::copy_nonoverlapping(entry_bytes, &mut entry as *mut _ as *mut u8, name_offset);\n+                let entry_name = entry_bytes.add(name_offset);\n+                ptr::copy_nonoverlapping(entry_bytes, copy_bytes, name_offset);\n \n                 let ret = DirEntry {\n-                    entry,\n+                    entry: copy,\n                     // d_name is guaranteed to be null-terminated.\n                     name: CStr::from_ptr(entry_name as *const _).to_owned(),\n                     dir: Arc::clone(&self.inner),"}]}