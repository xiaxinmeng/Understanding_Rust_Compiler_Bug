{"sha": "ffdf18d1447b57faafded06a887b6dae1f7293c7", "node_id": "C_kwDOAAsO6NoAKGZmZGYxOGQxNDQ3YjU3ZmFhZmRlZDA2YTg4N2I2ZGFlMWY3MjkzYzc", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-10-12T03:18:54Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-10-12T03:18:54Z"}, "message": "Auto merge of #88788 - falk-hueffner:speedup-int-log10-branchless, r=joshtriplett\n\nSpeedup int log10 branchless\n\nThis is achieved with a branchless bit-twiddling implementation of the case x < 100_000, and using this as building block.\n\nBenchmark on an Intel i7-8700K (Coffee Lake):\n\n```\nname                                   old ns/iter  new ns/iter  diff ns/iter   diff %  speedup\nnum::int_log::u8_log10_predictable     165          169                     4    2.42%   x 0.98\nnum::int_log::u8_log10_random          438          423                   -15   -3.42%   x 1.04\nnum::int_log::u8_log10_random_small    438          423                   -15   -3.42%   x 1.04\nnum::int_log::u16_log10_predictable    633          417                  -216  -34.12%   x 1.52\nnum::int_log::u16_log10_random         908          471                  -437  -48.13%   x 1.93\nnum::int_log::u16_log10_random_small   945          471                  -474  -50.16%   x 2.01\nnum::int_log::u32_log10_predictable    1,496        1,340                -156  -10.43%   x 1.12\nnum::int_log::u32_log10_random         1,076        873                  -203  -18.87%   x 1.23\nnum::int_log::u32_log10_random_small   1,145        874                  -271  -23.67%   x 1.31\nnum::int_log::u64_log10_predictable    4,005        3,171                -834  -20.82%   x 1.26\nnum::int_log::u64_log10_random         1,247        1,021                -226  -18.12%   x 1.22\nnum::int_log::u64_log10_random_small   1,265        921                  -344  -27.19%   x 1.37\nnum::int_log::u128_log10_predictable   39,667       39,579                -88   -0.22%   x 1.00\nnum::int_log::u128_log10_random        6,456        6,696                 240    3.72%   x 0.96\nnum::int_log::u128_log10_random_small  4,108        3,903                -205   -4.99%   x 1.05\n```\n\nBenchmark on an M1 Mac Mini:\n\n```\nname                                   old ns/iter  new ns/iter  diff ns/iter   diff %  speedup\nnum::int_log::u8_log10_predictable     143          130                   -13   -9.09%   x 1.10\nnum::int_log::u8_log10_random          375          325                   -50  -13.33%   x 1.15\nnum::int_log::u8_log10_random_small    376          325                   -51  -13.56%   x 1.16\nnum::int_log::u16_log10_predictable    500          322                  -178  -35.60%   x 1.55\nnum::int_log::u16_log10_random         794          405                  -389  -48.99%   x 1.96\nnum::int_log::u16_log10_random_small   1,035        405                  -630  -60.87%   x 2.56\nnum::int_log::u32_log10_predictable    1,144        894                  -250  -21.85%   x 1.28\nnum::int_log::u32_log10_random         832          786                   -46   -5.53%   x 1.06\nnum::int_log::u32_log10_random_small   832          787                   -45   -5.41%   x 1.06\nnum::int_log::u64_log10_predictable    2,681        2,057                -624  -23.27%   x 1.30\nnum::int_log::u64_log10_random         1,015        806                  -209  -20.59%   x 1.26\nnum::int_log::u64_log10_random_small   1,004        795                  -209  -20.82%   x 1.26\nnum::int_log::u128_log10_predictable   56,825       56,526               -299   -0.53%   x 1.01\nnum::int_log::u128_log10_random        9,056        8,861                -195   -2.15%   x 1.02\nnum::int_log::u128_log10_random_small  1,528        1,527                  -1   -0.07%   x 1.00\n```\n\nThe 128 bit case remains ridiculously slow because llvm fails to optimize division by a constant 128-bit value to multiplications. This could be worked around but it seems preferable to fix this in llvm.\n\nFrom u32 up, table lookup (like suggested [here](https://github.com/rust-lang/rust/issues/70887#issuecomment-881099813)) is still faster, but requires a hardware `leading_zeros` to be viable, and might clog up the cache.", "tree": {"sha": "c73ef89236e7d026ab35fb4b2ad723638e7fcfab", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c73ef89236e7d026ab35fb4b2ad723638e7fcfab"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ffdf18d1447b57faafded06a887b6dae1f7293c7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ffdf18d1447b57faafded06a887b6dae1f7293c7", "html_url": "https://github.com/rust-lang/rust/commit/ffdf18d1447b57faafded06a887b6dae1f7293c7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ffdf18d1447b57faafded06a887b6dae1f7293c7/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "97e3b30285af8526f8d21072a0c6d3f231e74876", "url": "https://api.github.com/repos/rust-lang/rust/commits/97e3b30285af8526f8d21072a0c6d3f231e74876", "html_url": "https://github.com/rust-lang/rust/commit/97e3b30285af8526f8d21072a0c6d3f231e74876"}, {"sha": "57c623570a16fd6d550627ee8fed1eb7882521f3", "url": "https://api.github.com/repos/rust-lang/rust/commits/57c623570a16fd6d550627ee8fed1eb7882521f3", "html_url": "https://github.com/rust-lang/rust/commit/57c623570a16fd6d550627ee8fed1eb7882521f3"}], "stats": {"total": 170, "additions": 114, "deletions": 56}, "files": [{"sha": "d5e1ec083f95d24488381be269ddb2191980063f", "filename": "library/core/benches/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/ffdf18d1447b57faafded06a887b6dae1f7293c7/library%2Fcore%2Fbenches%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ffdf18d1447b57faafded06a887b6dae1f7293c7/library%2Fcore%2Fbenches%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fbenches%2Flib.rs?ref=ffdf18d1447b57faafded06a887b6dae1f7293c7", "patch": "@@ -1,6 +1,7 @@\n // wasm32 does not support benches (no time).\n #![cfg(not(target_arch = \"wasm32\"))]\n #![feature(flt2dec)]\n+#![feature(int_log)]\n #![feature(test)]\n \n extern crate test;"}, {"sha": "6a219bcdd55aa3f6cee93da89a30f3ad6f915754", "filename": "library/core/benches/num/int_log/mod.rs", "status": "added", "additions": 58, "deletions": 0, "changes": 58, "blob_url": "https://github.com/rust-lang/rust/blob/ffdf18d1447b57faafded06a887b6dae1f7293c7/library%2Fcore%2Fbenches%2Fnum%2Fint_log%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ffdf18d1447b57faafded06a887b6dae1f7293c7/library%2Fcore%2Fbenches%2Fnum%2Fint_log%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fbenches%2Fnum%2Fint_log%2Fmod.rs?ref=ffdf18d1447b57faafded06a887b6dae1f7293c7", "patch": "@@ -0,0 +1,58 @@\n+use rand::Rng;\n+use test::{black_box, Bencher};\n+\n+macro_rules! int_log_bench {\n+    ($t:ty, $predictable:ident, $random:ident, $random_small:ident) => {\n+        #[bench]\n+        fn $predictable(bench: &mut Bencher) {\n+            bench.iter(|| {\n+                for n in 0..(<$t>::BITS / 8) {\n+                    for i in 1..=(100 as $t) {\n+                        let x = black_box(i << (n * 8));\n+                        black_box(x.log10());\n+                    }\n+                }\n+            });\n+        }\n+\n+        #[bench]\n+        fn $random(bench: &mut Bencher) {\n+            let mut rng = rand::thread_rng();\n+            /* Exponentially distributed random numbers from the whole range of the type.  */\n+            let numbers: Vec<$t> = (0..256)\n+                .map(|_| {\n+                    let x = rng.gen::<$t>() >> rng.gen_range(0, <$t>::BITS);\n+                    if x != 0 { x } else { 1 }\n+                })\n+                .collect();\n+            bench.iter(|| {\n+                for x in &numbers {\n+                    black_box(black_box(x).log10());\n+                }\n+            });\n+        }\n+\n+        #[bench]\n+        fn $random_small(bench: &mut Bencher) {\n+            let mut rng = rand::thread_rng();\n+            /* Exponentially distributed random numbers from the range 0..256.  */\n+            let numbers: Vec<$t> = (0..256)\n+                .map(|_| {\n+                    let x = (rng.gen::<u8>() >> rng.gen_range(0, u8::BITS)) as $t;\n+                    if x != 0 { x } else { 1 }\n+                })\n+                .collect();\n+            bench.iter(|| {\n+                for x in &numbers {\n+                    black_box(black_box(x).log10());\n+                }\n+            });\n+        }\n+    };\n+}\n+\n+int_log_bench! {u8, u8_log10_predictable, u8_log10_random, u8_log10_random_small}\n+int_log_bench! {u16, u16_log10_predictable, u16_log10_random, u16_log10_random_small}\n+int_log_bench! {u32, u32_log10_predictable, u32_log10_random, u32_log10_random_small}\n+int_log_bench! {u64, u64_log10_predictable, u64_log10_random, u64_log10_random_small}\n+int_log_bench! {u128, u128_log10_predictable, u128_log10_random, u128_log10_random_small}"}, {"sha": "2f9cad2725d7f093b1c8f8192730597853bed1df", "filename": "library/core/benches/num/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/ffdf18d1447b57faafded06a887b6dae1f7293c7/library%2Fcore%2Fbenches%2Fnum%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ffdf18d1447b57faafded06a887b6dae1f7293c7/library%2Fcore%2Fbenches%2Fnum%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fbenches%2Fnum%2Fmod.rs?ref=ffdf18d1447b57faafded06a887b6dae1f7293c7", "patch": "@@ -1,5 +1,6 @@\n mod dec2flt;\n mod flt2dec;\n+mod int_log;\n \n use std::str::FromStr;\n use test::Bencher;"}, {"sha": "398bb07a07e4c103e3ec81d3566daa5259b6dee0", "filename": "library/core/src/num/int_log10.rs", "status": "modified", "additions": 51, "deletions": 56, "changes": 107, "blob_url": "https://github.com/rust-lang/rust/blob/ffdf18d1447b57faafded06a887b6dae1f7293c7/library%2Fcore%2Fsrc%2Fnum%2Fint_log10.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ffdf18d1447b57faafded06a887b6dae1f7293c7/library%2Fcore%2Fsrc%2Fnum%2Fint_log10.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fnum%2Fint_log10.rs?ref=ffdf18d1447b57faafded06a887b6dae1f7293c7", "patch": "@@ -1,76 +1,71 @@\n mod unchecked {\n     // 0 < val <= u8::MAX\n     pub const fn u8(val: u8) -> u32 {\n-        if val >= 100 {\n-            2\n-        } else if val >= 10 {\n-            1\n-        } else {\n-            0\n-        }\n+        let val = val as u32;\n+\n+        // For better performance, avoid branches by assembling the solution\n+        // in the bits above the low 8 bits.\n+\n+        // Adding c1 to val gives 10 in the top bits for val < 10, 11 for val >= 10\n+        const C1: u32 = 0b11_00000000 - 10; // 758\n+        // Adding c2 to val gives 01 in the top bits for val < 100, 10 for val >= 100\n+        const C2: u32 = 0b10_00000000 - 100; // 412\n+\n+        // Value of top bits:\n+        //            +c1  +c2  1&2\n+        //     0..=9   10   01   00 = 0\n+        //   10..=99   11   01   01 = 1\n+        // 100..=255   11   10   10 = 2\n+        ((val + C1) & (val + C2)) >> 8\n     }\n \n-    // 0 < val <= u16::MAX\n-    pub const fn u16(val: u16) -> u32 {\n-        if val >= 10_000 {\n-            4\n-        } else if val >= 1000 {\n-            3\n-        } else if val >= 100 {\n-            2\n-        } else if val >= 10 {\n-            1\n-        } else {\n-            0\n-        }\n+    // 0 < val < 100_000\n+    const fn less_than_5(val: u32) -> u32 {\n+        // Similar to u8, when adding one of these constants to val,\n+        // we get two possible bit patterns above the low 17 bits,\n+        // depending on whether val is below or above the threshold.\n+        const C1: u32 = 0b011_00000000000000000 - 10; // 393206\n+        const C2: u32 = 0b100_00000000000000000 - 100; // 524188\n+        const C3: u32 = 0b111_00000000000000000 - 1000; // 916504\n+        const C4: u32 = 0b100_00000000000000000 - 10000; // 514288\n+\n+        // Value of top bits:\n+        //                +c1  +c2  1&2  +c3  +c4  3&4   ^\n+        //         0..=9  010  011  010  110  011  010  000 = 0\n+        //       10..=99  011  011  011  110  011  010  001 = 1\n+        //     100..=999  011  100  000  110  011  010  010 = 2\n+        //   1000..=9999  011  100  000  111  011  011  011 = 3\n+        // 10000..=99999  011  100  000  111  100  100  100 = 4\n+        (((val + C1) & (val + C2)) ^ ((val + C3) & (val + C4))) >> 17\n     }\n \n-    // 0 < val < 100_000_000\n-    const fn less_than_8(mut val: u32) -> u32 {\n-        let mut log = 0;\n-        if val >= 10_000 {\n-            val /= 10_000;\n-            log += 4;\n-        }\n-        log + if val >= 1000 {\n-            3\n-        } else if val >= 100 {\n-            2\n-        } else if val >= 10 {\n-            1\n-        } else {\n-            0\n-        }\n+    // 0 < val <= u16::MAX\n+    pub const fn u16(val: u16) -> u32 {\n+        less_than_5(val as u32)\n     }\n \n     // 0 < val <= u32::MAX\n     pub const fn u32(mut val: u32) -> u32 {\n         let mut log = 0;\n-        if val >= 100_000_000 {\n-            val /= 100_000_000;\n-            log += 8;\n-        }\n-        log + less_than_8(val)\n-    }\n-\n-    // 0 < val < 10_000_000_000_000_000\n-    const fn less_than_16(mut val: u64) -> u32 {\n-        let mut log = 0;\n-        if val >= 100_000_000 {\n-            val /= 100_000_000;\n-            log += 8;\n+        if val >= 100_000 {\n+            val /= 100_000;\n+            log += 5;\n         }\n-        log + less_than_8(val as u32)\n+        log + less_than_5(val)\n     }\n \n     // 0 < val <= u64::MAX\n     pub const fn u64(mut val: u64) -> u32 {\n         let mut log = 0;\n-        if val >= 10_000_000_000_000_000 {\n-            val /= 10_000_000_000_000_000;\n-            log += 16;\n+        if val >= 10_000_000_000 {\n+            val /= 10_000_000_000;\n+            log += 10;\n+        }\n+        if val >= 100_000 {\n+            val /= 100_000;\n+            log += 5;\n         }\n-        log + less_than_16(val)\n+        log + less_than_5(val as u32)\n     }\n \n     // 0 < val <= u128::MAX\n@@ -79,13 +74,13 @@ mod unchecked {\n         if val >= 100_000_000_000_000_000_000_000_000_000_000 {\n             val /= 100_000_000_000_000_000_000_000_000_000_000;\n             log += 32;\n-            return log + less_than_8(val as u32);\n+            return log + u32(val as u32);\n         }\n         if val >= 10_000_000_000_000_000 {\n             val /= 10_000_000_000_000_000;\n             log += 16;\n         }\n-        log + less_than_16(val as u64)\n+        log + u64(val as u64)\n     }\n \n     // 0 < val <= i8::MAX"}, {"sha": "3cd0073ddd8c24862770c7c2c783b8e6af02d9fb", "filename": "library/core/tests/num/int_log.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/ffdf18d1447b57faafded06a887b6dae1f7293c7/library%2Fcore%2Ftests%2Fnum%2Fint_log.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ffdf18d1447b57faafded06a887b6dae1f7293c7/library%2Fcore%2Ftests%2Fnum%2Fint_log.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Ftests%2Fnum%2Fint_log.rs?ref=ffdf18d1447b57faafded06a887b6dae1f7293c7", "patch": "@@ -96,6 +96,9 @@ fn checked_log10() {\n     for i in 1..=u16::MAX {\n         assert_eq!(i.checked_log10(), Some((i as f32).log10() as u32));\n     }\n+    for i in 1..=100_000u32 {\n+        assert_eq!(i.checked_log10(), Some((i as f32).log10() as u32));\n+    }\n }\n \n macro_rules! log10_loop {"}]}