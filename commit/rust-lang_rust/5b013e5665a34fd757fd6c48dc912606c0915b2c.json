{"sha": "5b013e5665a34fd757fd6c48dc912606c0915b2c", "node_id": "MDY6Q29tbWl0NzI0NzEyOjViMDEzZTU2NjVhMzRmZDc1N2ZkNmM0OGRjOTEyNjA2YzA5MTViMmM=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-06-15T13:44:46Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-06-15T13:44:46Z"}, "message": "Merge #4877\n\n4877: Fix syntax highlighting of recursive macros r=matklad a=ltentrup\n\nAdd syntax highlighting for the BANG (`!`) token if the parent is `MACRO_CALL`.\r\n\r\nBefore:\r\n<img width=\"514\" alt=\"before\" src=\"https://user-images.githubusercontent.com/201808/84595030-11f65c00-ae56-11ea-9bb2-b1abe2236990.png\">\r\n\r\nAfter:\r\n<img width=\"516\" alt=\"recursive-macro\" src=\"https://user-images.githubusercontent.com/201808/84594981-d196de00-ae55-11ea-8636-f877d5d795ff.png\">\r\n\r\n\r\nFixes #4694.\n\nCo-authored-by: Leander Tentrup <leander.tentrup@gmail.com>", "tree": {"sha": "413f268d2ba637089a84a91740d7599a0b611f49", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/413f268d2ba637089a84a91740d7599a0b611f49"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5b013e5665a34fd757fd6c48dc912606c0915b2c", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJe53tOCRBK7hj4Ov3rIwAAdHIIABzqNAHczaejp/3umuanssaE\nfasA2UQsGakEMB6o9C/1L9Q7pjbAFC1JxnX5719+IbN1+f4aXQKMgr7xN0opFKpK\nL8O8EubCnG/WtVXhiimH2SzRvbKCQsMm5D0k4tCxhyPV7BR1+7PcBqFx+1zbGr3o\ng0+76pODc3W8KHEcpiohhGy8ctVbrITV4EB2h75cz81RtCt78/9FX5CnQJzGOBog\nbZyJAw5BZ31wnY9WmavpgbhG9DEoSwAAyfsyWTAhPVc8feMYtefROGoeGpaBBAok\nxhvMzez7terdfozWp/vLZH/ocfI/WP3/yfrbs/gd5P3Tzq6QgXV4pm+pCEb54wg=\n=P8Oz\n-----END PGP SIGNATURE-----\n", "payload": "tree 413f268d2ba637089a84a91740d7599a0b611f49\nparent d0ac2f746a7cd2282b2f672cd0a6650a8339b907\nparent 06f89e5f3a00d91e84963745af989f1e9a906bb4\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1592228686 +0000\ncommitter GitHub <noreply@github.com> 1592228686 +0000\n\nMerge #4877\n\n4877: Fix syntax highlighting of recursive macros r=matklad a=ltentrup\n\nAdd syntax highlighting for the BANG (`!`) token if the parent is `MACRO_CALL`.\r\n\r\nBefore:\r\n<img width=\"514\" alt=\"before\" src=\"https://user-images.githubusercontent.com/201808/84595030-11f65c00-ae56-11ea-9bb2-b1abe2236990.png\">\r\n\r\nAfter:\r\n<img width=\"516\" alt=\"recursive-macro\" src=\"https://user-images.githubusercontent.com/201808/84594981-d196de00-ae55-11ea-8636-f877d5d795ff.png\">\r\n\r\n\r\nFixes #4694.\n\nCo-authored-by: Leander Tentrup <leander.tentrup@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5b013e5665a34fd757fd6c48dc912606c0915b2c", "html_url": "https://github.com/rust-lang/rust/commit/5b013e5665a34fd757fd6c48dc912606c0915b2c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5b013e5665a34fd757fd6c48dc912606c0915b2c/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d0ac2f746a7cd2282b2f672cd0a6650a8339b907", "url": "https://api.github.com/repos/rust-lang/rust/commits/d0ac2f746a7cd2282b2f672cd0a6650a8339b907", "html_url": "https://github.com/rust-lang/rust/commit/d0ac2f746a7cd2282b2f672cd0a6650a8339b907"}, {"sha": "06f89e5f3a00d91e84963745af989f1e9a906bb4", "url": "https://api.github.com/repos/rust-lang/rust/commits/06f89e5f3a00d91e84963745af989f1e9a906bb4", "html_url": "https://github.com/rust-lang/rust/commit/06f89e5f3a00d91e84963745af989f1e9a906bb4"}], "stats": {"total": 53, "additions": 37, "deletions": 16}, "files": [{"sha": "5c2ff6ab5a472b63bfadf9ddec1ca6bb29fe2a35", "filename": "crates/ra_ide/src/snapshots/highlighting.html", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/5b013e5665a34fd757fd6c48dc912606c0915b2c/crates%2Fra_ide%2Fsrc%2Fsnapshots%2Fhighlighting.html", "raw_url": "https://github.com/rust-lang/rust/raw/5b013e5665a34fd757fd6c48dc912606c0915b2c/crates%2Fra_ide%2Fsrc%2Fsnapshots%2Fhighlighting.html", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fsnapshots%2Fhighlighting.html?ref=5b013e5665a34fd757fd6c48dc912606c0915b2c", "patch": "@@ -62,6 +62,12 @@\n     }\n }\n \n+<span class=\"macro\">macro_rules!</span> <span class=\"macro declaration\">noop</span> {\n+    ($expr:expr) =&gt; {\n+        $expr\n+    }\n+}\n+\n <span class=\"comment\">// comment</span>\n <span class=\"keyword\">fn</span> <span class=\"function declaration\">main</span>() {\n     <span class=\"macro\">println!</span>(<span class=\"string_literal\">\"Hello, {}!\"</span>, <span class=\"numeric_literal\">92</span>);\n@@ -80,6 +86,8 @@\n         <span class=\"comment\">// Do nothing</span>\n     }\n \n+    <span class=\"macro\">noop!</span>(<span class=\"macro\">noop</span><span class=\"macro\">!</span>(<span class=\"numeric_literal\">1</span>));\n+\n     <span class=\"keyword\">let</span> <span class=\"keyword\">mut</span> <span class=\"variable declaration mutable\">x</span> = <span class=\"numeric_literal\">42</span>;\n     <span class=\"keyword\">let</span> <span class=\"variable declaration mutable\">y</span> = &<span class=\"keyword\">mut</span> <span class=\"variable mutable\">x</span>;\n     <span class=\"keyword\">let</span> <span class=\"variable declaration\">z</span> = &<span class=\"variable mutable\">y</span>;"}, {"sha": "bbcd52a1c1f8212d215f77234aa332e327660251", "filename": "crates/ra_ide/src/syntax_highlighting.rs", "status": "modified", "additions": 21, "deletions": 16, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/5b013e5665a34fd757fd6c48dc912606c0915b2c/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5b013e5665a34fd757fd6c48dc912606c0915b2c/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting.rs?ref=5b013e5665a34fd757fd6c48dc912606c0915b2c", "patch": "@@ -160,23 +160,25 @@ pub(crate) fn highlight(\n             // Check if macro takes a format string and remember it for highlighting later.\n             // The macros that accept a format string expand to a compiler builtin macros\n             // `format_args` and `format_args_nl`.\n-            if let Some(fmt_macro_call) = parent.parent().and_then(ast::MacroCall::cast) {\n-                if let Some(name) =\n-                    fmt_macro_call.path().and_then(|p| p.segment()).and_then(|s| s.name_ref())\n-                {\n-                    match name.text().as_str() {\n-                        \"format_args\" | \"format_args_nl\" => {\n-                            format_string = parent\n-                                .children_with_tokens()\n-                                .filter(|t| t.kind() != WHITESPACE)\n-                                .nth(1)\n-                                .filter(|e| {\n-                                    ast::String::can_cast(e.kind())\n-                                        || ast::RawString::can_cast(e.kind())\n-                                })\n-                        }\n-                        _ => {}\n+            if let Some(name) = parent\n+                .parent()\n+                .and_then(ast::MacroCall::cast)\n+                .and_then(|mc| mc.path())\n+                .and_then(|p| p.segment())\n+                .and_then(|s| s.name_ref())\n+            {\n+                match name.text().as_str() {\n+                    \"format_args\" | \"format_args_nl\" => {\n+                        format_string = parent\n+                            .children_with_tokens()\n+                            .filter(|t| t.kind() != WHITESPACE)\n+                            .nth(1)\n+                            .filter(|e| {\n+                                ast::String::can_cast(e.kind())\n+                                    || ast::RawString::can_cast(e.kind())\n+                            })\n                     }\n+                    _ => {}\n                 }\n             }\n \n@@ -493,6 +495,9 @@ fn highlight_element(\n             h |= HighlightModifier::Unsafe;\n             h\n         }\n+        T![!] if element.parent().and_then(ast::MacroCall::cast).is_some() => {\n+            Highlight::new(HighlightTag::Macro)\n+        }\n \n         k if k.is_keyword() => {\n             let h = Highlight::new(HighlightTag::Keyword);"}, {"sha": "070b24f4551b7da3668b0dfb6e2040562ac3ae00", "filename": "crates/ra_ide/src/syntax_highlighting/tests.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/5b013e5665a34fd757fd6c48dc912606c0915b2c/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5b013e5665a34fd757fd6c48dc912606c0915b2c/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fsyntax_highlighting%2Ftests.rs?ref=5b013e5665a34fd757fd6c48dc912606c0915b2c", "patch": "@@ -43,6 +43,12 @@ def_fn! {\n     }\n }\n \n+macro_rules! noop {\n+    ($expr:expr) => {\n+        $expr\n+    }\n+}\n+\n // comment\n fn main() {\n     println!(\"Hello, {}!\", 92);\n@@ -61,6 +67,8 @@ fn main() {\n         // Do nothing\n     }\n \n+    noop!(noop!(1));\n+\n     let mut x = 42;\n     let y = &mut x;\n     let z = &y;"}]}