{"sha": "654f56e086fad836da5931e1a3defad804d9cfe9", "node_id": "C_kwDOAAsO6NoAKDY1NGY1NmUwODZmYWQ4MzZkYTU5MzFlMWEzZGVmYWQ4MDRkOWNmZTk", "commit": {"author": {"name": "jyn", "email": "github@jyn.dev", "date": "2023-05-07T16:19:13Z"}, "committer": {"name": "jyn", "email": "github@jyn.dev", "date": "2023-05-07T16:20:16Z"}, "message": "Give a more helpful error when running the rustc shim directly\n\ncc https://rust-lang.zulipchat.com/#narrow/stream/326414-t-infra.2Fbootstrap/topic/Building.20.60coretests.60.20by.20hand", "tree": {"sha": "1f9ea2411554c2b96b4a65054b0ebf011a14742b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1f9ea2411554c2b96b4a65054b0ebf011a14742b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/654f56e086fad836da5931e1a3defad804d9cfe9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/654f56e086fad836da5931e1a3defad804d9cfe9", "html_url": "https://github.com/rust-lang/rust/commit/654f56e086fad836da5931e1a3defad804d9cfe9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/654f56e086fad836da5931e1a3defad804d9cfe9/comments", "author": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0dddad0dc5d614f799d7e04de4895e7a7418eccb", "url": "https://api.github.com/repos/rust-lang/rust/commits/0dddad0dc5d614f799d7e04de4895e7a7418eccb", "html_url": "https://github.com/rust-lang/rust/commit/0dddad0dc5d614f799d7e04de4895e7a7418eccb"}], "stats": {"total": 18, "additions": 14, "deletions": 4}, "files": [{"sha": "e87125a49a6a048a8d4270264472ec1b13f22ceb", "filename": "src/bootstrap/bin/rustc.rs", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/654f56e086fad836da5931e1a3defad804d9cfe9/src%2Fbootstrap%2Fbin%2Frustc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/654f56e086fad836da5931e1a3defad804d9cfe9/src%2Fbootstrap%2Fbin%2Frustc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbin%2Frustc.rs?ref=654f56e086fad836da5931e1a3defad804d9cfe9", "patch": "@@ -19,7 +19,7 @@ include!(\"../dylib_util.rs\");\n \n use std::env;\n use std::path::PathBuf;\n-use std::process::{Child, Command};\n+use std::process::{exit, Child, Command};\n use std::str::FromStr;\n use std::time::Instant;\n \n@@ -47,7 +47,12 @@ fn main() {\n     } else {\n         (\"RUSTC_REAL\", \"RUSTC_LIBDIR\")\n     };\n-    let stage = env::var(\"RUSTC_STAGE\").expect(\"RUSTC_STAGE was not set\");\n+    let stage = env::var(\"RUSTC_STAGE\").unwrap_or_else(|_| {\n+        // Don't panic here; it's reasonable to try and run these shims directly. Give a helpful error instead.\n+        eprintln!(\"rustc shim: fatal: RUSTC_STAGE was not set\");\n+        eprintln!(\"rustc shim: note: use `x.py build -vvv` to see all environment variables set by bootstrap\");\n+        exit(101);\n+    });\n     let sysroot = env::var_os(\"RUSTC_SYSROOT\").expect(\"RUSTC_SYSROOT was not set\");\n     let on_fail = env::var_os(\"RUSTC_ON_FAIL\").map(Command::new);\n "}, {"sha": "d2b85f7a6297b90caeb1e0c498600b3152e9dfac", "filename": "src/bootstrap/bin/rustdoc.rs", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/654f56e086fad836da5931e1a3defad804d9cfe9/src%2Fbootstrap%2Fbin%2Frustdoc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/654f56e086fad836da5931e1a3defad804d9cfe9/src%2Fbootstrap%2Fbin%2Frustdoc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbin%2Frustdoc.rs?ref=654f56e086fad836da5931e1a3defad804d9cfe9", "patch": "@@ -5,13 +5,18 @@\n use std::env;\n use std::ffi::OsString;\n use std::path::PathBuf;\n-use std::process::Command;\n+use std::process::{exit, Command};\n \n include!(\"../dylib_util.rs\");\n \n fn main() {\n     let args = env::args_os().skip(1).collect::<Vec<_>>();\n-    let stage = env::var(\"RUSTC_STAGE\").expect(\"RUSTC_STAGE was not set\");\n+    let stage = env::var(\"RUSTC_STAGE\").unwrap_or_else(|_| {\n+        // Don't panic here; it's reasonable to try and run these shims directly. Give a helpful error instead.\n+        eprintln!(\"rustc shim: fatal: RUSTC_STAGE was not set\");\n+        eprintln!(\"rustc shim: note: use `x.py build -vvv` to see all environment variables set by bootstrap\");\n+        exit(101);\n+    });\n     let rustdoc = env::var_os(\"RUSTDOC_REAL\").expect(\"RUSTDOC_REAL was not set\");\n     let libdir = env::var_os(\"RUSTDOC_LIBDIR\").expect(\"RUSTDOC_LIBDIR was not set\");\n     let sysroot = env::var_os(\"RUSTC_SYSROOT\").expect(\"RUSTC_SYSROOT was not set\");"}]}