{"sha": "ed7e50e08b67eee7a6d1f4da897f204e3e70c6a0", "node_id": "C_kwDOAAsO6NoAKGVkN2U1MGUwOGI2N2VlZTdhNmQxZjRkYTg5N2YyMDRlM2U3MGM2YTA", "commit": {"author": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2023-04-09T09:42:57Z"}, "committer": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2023-04-21T16:14:43Z"}, "message": "Ensure mir_drops_elaborated_and_const_checked when requiring codegen.", "tree": {"sha": "6beb52788d114b382b632145d37f4a3894f96666", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6beb52788d114b382b632145d37f4a3894f96666"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ed7e50e08b67eee7a6d1f4da897f204e3e70c6a0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ed7e50e08b67eee7a6d1f4da897f204e3e70c6a0", "html_url": "https://github.com/rust-lang/rust/commit/ed7e50e08b67eee7a6d1f4da897f204e3e70c6a0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ed7e50e08b67eee7a6d1f4da897f204e3e70c6a0/comments", "author": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "409661936f929b254ffc8adb644cf35d1f9765c4", "url": "https://api.github.com/repos/rust-lang/rust/commits/409661936f929b254ffc8adb644cf35d1f9765c4", "html_url": "https://github.com/rust-lang/rust/commit/409661936f929b254ffc8adb644cf35d1f9765c4"}], "stats": {"total": 85, "additions": 45, "deletions": 40}, "files": [{"sha": "de78f26eec6c9f8f9958299516afa2db5b56d1a9", "filename": "compiler/rustc_interface/src/passes.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ed7e50e08b67eee7a6d1f4da897f204e3e70c6a0/compiler%2Frustc_interface%2Fsrc%2Fpasses.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ed7e50e08b67eee7a6d1f4da897f204e3e70c6a0/compiler%2Frustc_interface%2Fsrc%2Fpasses.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2Fsrc%2Fpasses.rs?ref=ed7e50e08b67eee7a6d1f4da897f204e3e70c6a0", "patch": "@@ -794,8 +794,14 @@ fn analysis(tcx: TyCtxt<'_>, (): ()) -> Result<()> {\n             }\n             tcx.ensure().has_ffi_unwind_calls(def_id);\n \n-            if tcx.hir().body_const_context(def_id).is_some() {\n+            // If we need to codegen, ensure that we emit all errors from\n+            // `mir_drops_elaborated_and_const_checked` now, to avoid discovering\n+            // them later during codegen.\n+            if tcx.sess.opts.output_types.should_codegen()\n+                || tcx.hir().body_const_context(def_id).is_some()\n+            {\n                 tcx.ensure().mir_drops_elaborated_and_const_checked(def_id);\n+                tcx.ensure().unused_generic_params(ty::InstanceDef::Item(def_id.to_def_id()));\n             }\n         }\n     });"}, {"sha": "a9b4621ccbdcb6d6648adae0835d837fc4b73c94", "filename": "tests/run-make/const-prop-lint/Makefile", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/ed7e50e08b67eee7a6d1f4da897f204e3e70c6a0/tests%2Frun-make%2Fconst-prop-lint%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/ed7e50e08b67eee7a6d1f4da897f204e3e70c6a0/tests%2Frun-make%2Fconst-prop-lint%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-make%2Fconst-prop-lint%2FMakefile?ref=ed7e50e08b67eee7a6d1f4da897f204e3e70c6a0", "patch": "@@ -0,0 +1,9 @@\n+include ../tools.mk\n+\n+# Test that emitting an error because of arithmetic\n+# overflow lint does not leave .o files around\n+# because of interrupted codegen.\n+\n+all:\n+\t$(RUSTC) input.rs; test $$? -eq 1\n+\tls *.o; test $$? -eq 2"}, {"sha": "ccbdfb8d50b0ea33ef2f657a89b4cc46374ad8e4", "filename": "tests/run-make/const-prop-lint/input.rs", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/ed7e50e08b67eee7a6d1f4da897f204e3e70c6a0/tests%2Frun-make%2Fconst-prop-lint%2Finput.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ed7e50e08b67eee7a6d1f4da897f204e3e70c6a0/tests%2Frun-make%2Fconst-prop-lint%2Finput.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-make%2Fconst-prop-lint%2Finput.rs?ref=ed7e50e08b67eee7a6d1f4da897f204e3e70c6a0", "patch": "@@ -0,0 +1,5 @@\n+#![deny(arithmetic_overflow)]\n+\n+fn main() {\n+    let x = 255u8 + 1;\n+}"}, {"sha": "bd56f854c8b17b9eee005612ae3146717d8d880b", "filename": "tests/ui/consts/const-eval/issue-100878.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ed7e50e08b67eee7a6d1f4da897f204e3e70c6a0/tests%2Fui%2Fconsts%2Fconst-eval%2Fissue-100878.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ed7e50e08b67eee7a6d1f4da897f204e3e70c6a0/tests%2Fui%2Fconsts%2Fconst-eval%2Fissue-100878.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fconsts%2Fconst-eval%2Fissue-100878.rs?ref=ed7e50e08b67eee7a6d1f4da897f204e3e70c6a0", "patch": "@@ -1,6 +1,8 @@\n // This checks that the const-eval ICE in issue #100878 does not recur.\n //\n // build-pass\n+\n+#[allow(arithmetic_overflow)]\n pub fn bitshift_data(data: [u8; 1]) -> u8 {\n     data[0] << 8\n }"}, {"sha": "b3f87305781513b46c6c3a2d3cb2a942e92e03b0", "filename": "tests/ui/issues/issue-33287.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/ed7e50e08b67eee7a6d1f4da897f204e3e70c6a0/tests%2Fui%2Fissues%2Fissue-33287.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ed7e50e08b67eee7a6d1f4da897f204e3e70c6a0/tests%2Fui%2Fissues%2Fissue-33287.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fissues%2Fissue-33287.rs?ref=ed7e50e08b67eee7a6d1f4da897f204e3e70c6a0", "patch": "@@ -1,6 +1,7 @@\n // build-pass\n #![allow(dead_code)]\n #![allow(unused_variables)]\n+#![allow(unconditional_panic)]\n const A: [u32; 1] = [0];\n \n fn test() {"}, {"sha": "32d49d25f02ac4d1a74cde8fcce68e95ce66c8c1", "filename": "tests/ui/polymorphization/generators.stderr", "status": "modified", "additions": 0, "deletions": 12, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/ed7e50e08b67eee7a6d1f4da897f204e3e70c6a0/tests%2Fui%2Fpolymorphization%2Fgenerators.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/ed7e50e08b67eee7a6d1f4da897f204e3e70c6a0/tests%2Fui%2Fpolymorphization%2Fgenerators.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fpolymorphization%2Fgenerators.stderr?ref=ed7e50e08b67eee7a6d1f4da897f204e3e70c6a0", "patch": "@@ -15,12 +15,6 @@ LL | pub fn unused_type<T>() -> impl Generator<(), Yield = u32, Return = u32> +\n LL |     || {\n    |     ^^\n \n-note: the above error was encountered while instantiating `fn finish::<[generator@$DIR/generators.rs:35:5: 35:7], u32, u32>`\n-  --> $DIR/generators.rs:86:5\n-   |\n-LL |     finish(unused_type::<u32>());\n-   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n-\n error: item has unused generic parameters\n   --> $DIR/generators.rs:60:5\n    |\n@@ -29,11 +23,5 @@ LL | pub fn unused_const<const T: u32>() -> impl Generator<(), Yield = u32, Retu\n LL |     || {\n    |     ^^\n \n-note: the above error was encountered while instantiating `fn finish::<[generator@$DIR/generators.rs:60:5: 60:7], u32, u32>`\n-  --> $DIR/generators.rs:89:5\n-   |\n-LL |     finish(unused_const::<1u32>());\n-   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n-\n error: aborting due to 2 previous errors; 1 warning emitted\n "}, {"sha": "a3b2f75b12d4a7d01439793ceab18c7d984363fd", "filename": "tests/ui/polymorphization/predicates.stderr", "status": "modified", "additions": 6, "deletions": 12, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/ed7e50e08b67eee7a6d1f4da897f204e3e70c6a0/tests%2Fui%2Fpolymorphization%2Fpredicates.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/ed7e50e08b67eee7a6d1f4da897f204e3e70c6a0/tests%2Fui%2Fpolymorphization%2Fpredicates.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fpolymorphization%2Fpredicates.stderr?ref=ed7e50e08b67eee7a6d1f4da897f204e3e70c6a0", "patch": "@@ -1,3 +1,9 @@\n+error: item has unused generic parameters\n+  --> $DIR/predicates.rs:10:4\n+   |\n+LL | fn bar<I>() {\n+   |    ^^^ - generic parameter `I` is unused\n+\n error: item has unused generic parameters\n   --> $DIR/predicates.rs:15:4\n    |\n@@ -35,17 +41,5 @@ error: item has unused generic parameters\n LL | fn foobar<F, G>() -> usize\n    |    ^^^^^^ - generic parameter `F` is unused\n \n-error: item has unused generic parameters\n-  --> $DIR/predicates.rs:10:4\n-   |\n-LL | fn bar<I>() {\n-   |    ^^^ - generic parameter `I` is unused\n-\n-note: the above error was encountered while instantiating `fn foo::<std::slice::Iter<'_, u32>, T>`\n-  --> $DIR/predicates.rs:86:5\n-   |\n-LL |     foo(x.iter());\n-   |     ^^^^^^^^^^^^^\n-\n error: aborting due to 6 previous errors\n "}, {"sha": "5c3b46c6041b36823e1ea496c6abf623a446f38e", "filename": "tests/ui/polymorphization/type_parameters/closures.stderr", "status": "modified", "additions": 15, "deletions": 15, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/ed7e50e08b67eee7a6d1f4da897f204e3e70c6a0/tests%2Fui%2Fpolymorphization%2Ftype_parameters%2Fclosures.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/ed7e50e08b67eee7a6d1f4da897f204e3e70c6a0/tests%2Fui%2Fpolymorphization%2Ftype_parameters%2Fclosures.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fpolymorphization%2Ftype_parameters%2Fclosures.stderr?ref=ed7e50e08b67eee7a6d1f4da897f204e3e70c6a0", "patch": "@@ -43,21 +43,6 @@ LL | impl<F: Default> Foo<F> {\n LL |     pub fn unused_all<G: Default>() -> u32 {\n    |            ^^^^^^^^^^ - generic parameter `G` is unused\n \n-error: item has unused generic parameters\n-  --> $DIR/closures.rs:128:23\n-   |\n-LL |     pub fn used_impl<G: Default>() -> u32 {\n-   |                      - generic parameter `G` is unused\n-LL |\n-LL |         let add_one = |x: u32| {\n-   |                       ^^^^^^^^\n-\n-error: item has unused generic parameters\n-  --> $DIR/closures.rs:126:12\n-   |\n-LL |     pub fn used_impl<G: Default>() -> u32 {\n-   |            ^^^^^^^^^ - generic parameter `G` is unused\n-\n error: item has unused generic parameters\n   --> $DIR/closures.rs:115:23\n    |\n@@ -76,5 +61,20 @@ LL | impl<F: Default> Foo<F> {\n LL |     pub fn used_fn<G: Default>() -> u32 {\n    |            ^^^^^^^\n \n+error: item has unused generic parameters\n+  --> $DIR/closures.rs:128:23\n+   |\n+LL |     pub fn used_impl<G: Default>() -> u32 {\n+   |                      - generic parameter `G` is unused\n+LL |\n+LL |         let add_one = |x: u32| {\n+   |                       ^^^^^^^^\n+\n+error: item has unused generic parameters\n+  --> $DIR/closures.rs:126:12\n+   |\n+LL |     pub fn used_impl<G: Default>() -> u32 {\n+   |            ^^^^^^^^^ - generic parameter `G` is unused\n+\n error: aborting due to 9 previous errors\n "}]}