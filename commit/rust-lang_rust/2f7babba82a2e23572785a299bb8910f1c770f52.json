{"sha": "2f7babba82a2e23572785a299bb8910f1c770f52", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJmN2JhYmJhODJhMmUyMzU3Mjc4NWEyOTliYjg5MTBmMWM3NzBmNTI=", "commit": {"author": {"name": "Andre Bogus", "email": "bogusandre@gmail.com", "date": "2017-02-21T03:36:59Z"}, "committer": {"name": "Andre Bogus", "email": "bogusandre@gmail.com", "date": "2017-02-21T03:36:59Z"}, "message": "New zero_ptr lint.\n\nThis fixes #1047. I did not bother to add a full suggestion,\nbecause replacing with `std::ptr::null()` may still lead to\ninference failures.", "tree": {"sha": "2cbd4f7491a483cf73eb4947ddbc5cd34ebaa5e1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2cbd4f7491a483cf73eb4947ddbc5cd34ebaa5e1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2f7babba82a2e23572785a299bb8910f1c770f52", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2f7babba82a2e23572785a299bb8910f1c770f52", "html_url": "https://github.com/rust-lang/rust/commit/2f7babba82a2e23572785a299bb8910f1c770f52", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2f7babba82a2e23572785a299bb8910f1c770f52/comments", "author": {"login": "llogiq", "id": 4200835, "node_id": "MDQ6VXNlcjQyMDA4MzU=", "avatar_url": "https://avatars.githubusercontent.com/u/4200835?v=4", "gravatar_id": "", "url": "https://api.github.com/users/llogiq", "html_url": "https://github.com/llogiq", "followers_url": "https://api.github.com/users/llogiq/followers", "following_url": "https://api.github.com/users/llogiq/following{/other_user}", "gists_url": "https://api.github.com/users/llogiq/gists{/gist_id}", "starred_url": "https://api.github.com/users/llogiq/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/llogiq/subscriptions", "organizations_url": "https://api.github.com/users/llogiq/orgs", "repos_url": "https://api.github.com/users/llogiq/repos", "events_url": "https://api.github.com/users/llogiq/events{/privacy}", "received_events_url": "https://api.github.com/users/llogiq/received_events", "type": "User", "site_admin": false}, "committer": {"login": "llogiq", "id": 4200835, "node_id": "MDQ6VXNlcjQyMDA4MzU=", "avatar_url": "https://avatars.githubusercontent.com/u/4200835?v=4", "gravatar_id": "", "url": "https://api.github.com/users/llogiq", "html_url": "https://github.com/llogiq", "followers_url": "https://api.github.com/users/llogiq/followers", "following_url": "https://api.github.com/users/llogiq/following{/other_user}", "gists_url": "https://api.github.com/users/llogiq/gists{/gist_id}", "starred_url": "https://api.github.com/users/llogiq/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/llogiq/subscriptions", "organizations_url": "https://api.github.com/users/llogiq/orgs", "repos_url": "https://api.github.com/users/llogiq/repos", "events_url": "https://api.github.com/users/llogiq/events{/privacy}", "received_events_url": "https://api.github.com/users/llogiq/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8a227c75777bf154ac8fb1673d970133e9a02d56", "url": "https://api.github.com/repos/rust-lang/rust/commits/8a227c75777bf154ac8fb1673d970133e9a02d56", "html_url": "https://github.com/rust-lang/rust/commit/8a227c75777bf154ac8fb1673d970133e9a02d56"}], "stats": {"total": 75, "additions": 71, "deletions": 4}, "files": [{"sha": "51f9bf356da82983be104a5953680e9a16d85144", "filename": "CHANGELOG.md", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/2f7babba82a2e23572785a299bb8910f1c770f52/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/2f7babba82a2e23572785a299bb8910f1c770f52/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=2f7babba82a2e23572785a299bb8910f1c770f52", "patch": "@@ -1,6 +1,7 @@\n # Change Log\n All notable changes to this project will be documented in this file.\n \n+* New [`zero_ptr`] lint\n * New [`never_loop`] lint\n * New [`mut_from_ref`] lint\n \n@@ -472,5 +473,6 @@ All notable changes to this project will be documented in this file.\n [`wrong_transmute`]: https://github.com/Manishearth/rust-clippy/wiki#wrong_transmute\n [`zero_divided_by_zero`]: https://github.com/Manishearth/rust-clippy/wiki#zero_divided_by_zero\n [`zero_prefixed_literal`]: https://github.com/Manishearth/rust-clippy/wiki#zero_prefixed_literal\n+[`zero_ptr`]: https://github.com/Manishearth/rust-clippy/wiki#zero_ptr\n [`zero_width_space`]: https://github.com/Manishearth/rust-clippy/wiki#zero_width_space\n <!-- end autogenerated links to wiki -->"}, {"sha": "0444c067206720cadb39751d9ecc11953dc023d7", "filename": "README.md", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/2f7babba82a2e23572785a299bb8910f1c770f52/README.md", "raw_url": "https://github.com/rust-lang/rust/raw/2f7babba82a2e23572785a299bb8910f1c770f52/README.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/README.md?ref=2f7babba82a2e23572785a299bb8910f1c770f52", "patch": "@@ -180,7 +180,7 @@ transparently:\n \n ## Lints\n \n-There are 191 lints included in this crate:\n+There are 192 lints included in this crate:\n \n name                                                                                                                   | default | triggers on\n -----------------------------------------------------------------------------------------------------------------------|---------|----------------------------------------------------------------------------------------------------------------------------------\n@@ -374,6 +374,7 @@ name\n [wrong_transmute](https://github.com/Manishearth/rust-clippy/wiki#wrong_transmute)                                     | warn    | transmutes that are confusing at best, undefined behaviour at worst and always useless\n [zero_divided_by_zero](https://github.com/Manishearth/rust-clippy/wiki#zero_divided_by_zero)                           | warn    | usage of `0.0 / 0.0` to obtain NaN instead of std::f32::NaN or std::f64::NaN\n [zero_prefixed_literal](https://github.com/Manishearth/rust-clippy/wiki#zero_prefixed_literal)                         | warn    | integer literals starting with `0`\n+[zero_ptr](https://github.com/Manishearth/rust-clippy/wiki#zero_ptr)                                                   | warn    | using 0 as *{const, mut} T\n [zero_width_space](https://github.com/Manishearth/rust-clippy/wiki#zero_width_space)                                   | deny    | using a zero-width space in a string literal, which is confusing\n \n More to come, please [file an issue](https://github.com/Manishearth/rust-clippy/issues) if you have ideas!"}, {"sha": "1f950786eb2efdfc0b13efddbc01c7649cab23fc", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/2f7babba82a2e23572785a299bb8910f1c770f52/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f7babba82a2e23572785a299bb8910f1c770f52/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=2f7babba82a2e23572785a299bb8910f1c770f52", "patch": "@@ -450,6 +450,7 @@ pub fn register_plugins(reg: &mut rustc_plugin::Registry) {\n         misc_early::REDUNDANT_CLOSURE_CALL,\n         misc_early::UNNEEDED_FIELD_PATTERN,\n         misc_early::ZERO_PREFIXED_LITERAL,\n+        misc_early::ZERO_PTR,\n         mut_reference::UNNECESSARY_MUT_PASSED,\n         mutex_atomic::MUTEX_ATOMIC,\n         needless_bool::BOOL_COMPARISON,"}, {"sha": "c5c602accd0e14ddcc80490b4d405ce0403a2557", "filename": "clippy_lints/src/misc_early.rs", "status": "modified", "additions": 37, "deletions": 1, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/2f7babba82a2e23572785a299bb8910f1c770f52/clippy_lints%2Fsrc%2Fmisc_early.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f7babba82a2e23572785a299bb8910f1c770f52/clippy_lints%2Fsrc%2Fmisc_early.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmisc_early.rs?ref=2f7babba82a2e23572785a299bb8910f1c770f52", "patch": "@@ -162,6 +162,23 @@ declare_lint! {\n     \"shadowing a builtin type\"\n }\n \n+/// **What it does:** Catch casts from `0` to some pointer type\n+///\n+/// **Why is this bad?** This generally means `null` and is better expressed as\n+/// {`std`, `core`}`::ptr::`{`null`, `null_mut`}.\n+///\n+/// **Known problems:** None.\n+///\n+/// **Example:**\n+///\n+/// ```rust\n+/// \u00df as *const u32\n+/// ```\n+declare_lint! {\n+    pub ZERO_PTR,\n+    Warn,\n+    \"using 0 as *{const, mut} T\"\n+}\n \n #[derive(Copy, Clone)]\n pub struct MiscEarly;\n@@ -175,7 +192,8 @@ impl LintPass for MiscEarly {\n                     MIXED_CASE_HEX_LITERALS,\n                     UNSEPARATED_LITERAL_SUFFIX,\n                     ZERO_PREFIXED_LITERAL,\n-                    BUILTIN_TYPE_SHADOW)\n+                    BUILTIN_TYPE_SHADOW,\n+                    ZERO_PTR)\n     }\n }\n \n@@ -363,6 +381,9 @@ impl EarlyLintPass for MiscEarly {\n                     }\n                 }}\n             },\n+            ExprKind::Cast(ref e, ref ty) => {\n+                check_cast(cx, expr.span, e, ty);\n+            },\n             _ => (),\n         }\n     }\n@@ -391,3 +412,18 @@ impl EarlyLintPass for MiscEarly {\n         }\n     }\n }\n+\n+fn check_cast(cx: &EarlyContext, span: Span, e: &Expr, ty: &Ty) {\n+    if_let_chain! {[\n+        let TyKind::Ptr(MutTy { mutbl, .. }) = ty.node,\n+        let ExprKind::Lit(ref lit) = e.node,\n+        let LitKind::Int(value, ..) = lit.node,\n+        value == 0\n+    ], {\n+        let msg = match mutbl {\n+            Mutability::Mutable => \"`0 as *mut _` detected. Consider using `ptr::null_mut()`\",\n+            Mutability::Immutable => \"`0 as *const _` detected. Consider using `ptr::null()`\",\n+        };\n+        span_lint(cx, ZERO_PTR, span, msg);\n+    }}\n+}"}, {"sha": "6f0a831f5d5665972aff8c785b8e740e8bbd1356", "filename": "tests/ui/transmute.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/2f7babba82a2e23572785a299bb8910f1c770f52/tests%2Fui%2Ftransmute.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f7babba82a2e23572785a299bb8910f1c770f52/tests%2Fui%2Ftransmute.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ftransmute.rs?ref=2f7babba82a2e23572785a299bb8910f1c770f52", "patch": "@@ -91,7 +91,7 @@ fn issue1231() {\n         bar: &'a T,\n     }\n \n-    let raw = 0 as *const i32;\n+    let raw = 42 as *const i32;\n     let _: &Foo<u8> = unsafe { std::mem::transmute::<_, &Foo<_>>(raw) };\n \n \n@@ -103,7 +103,7 @@ fn issue1231() {\n \n \n     type Bar<'a> = &'a u8;\n-    let raw = 0 as *const i32;\n+    let raw = 42 as *const i32;\n     unsafe { std::mem::transmute::<_, Bar>(raw) };\n \n "}, {"sha": "a72223ef54c138e0548a4b2fa7d74b56d16a17dd", "filename": "tests/ui/zero_ptr.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/2f7babba82a2e23572785a299bb8910f1c770f52/tests%2Fui%2Fzero_ptr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f7babba82a2e23572785a299bb8910f1c770f52/tests%2Fui%2Fzero_ptr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fzero_ptr.rs?ref=2f7babba82a2e23572785a299bb8910f1c770f52", "patch": "@@ -0,0 +1,11 @@\n+#![feature(plugin)]\n+#![plugin(clippy)]\n+\n+#[allow(unused_variables)]\n+fn main() {\n+    let x = 0 as *const usize;\n+    let y = 0 as *mut f64;\n+\n+    let z = 0;\n+    let z = z as *const usize; // this is currently not caught\n+}"}, {"sha": "e17a3bfb2bdbcc45350638bc2b19c5ae215e62f8", "filename": "tests/ui/zero_ptr.stderr", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/2f7babba82a2e23572785a299bb8910f1c770f52/tests%2Fui%2Fzero_ptr.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2f7babba82a2e23572785a299bb8910f1c770f52/tests%2Fui%2Fzero_ptr.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fzero_ptr.stderr?ref=2f7babba82a2e23572785a299bb8910f1c770f52", "patch": "@@ -0,0 +1,16 @@\n+warning: `0 as *const _` detected. Consider using `ptr::null()`\n+ --> $DIR/zero_ptr.rs:6:13\n+  |\n+6 |     let x = 0 as *const usize;\n+  |             ^^^^^^^^^^^^^^^^^\n+  |\n+  = note: #[warn(zero_ptr)] on by default\n+\n+warning: `0 as *mut _` detected. Consider using `ptr::null_mut()`\n+ --> $DIR/zero_ptr.rs:7:13\n+  |\n+7 |     let y = 0 as *mut f64;\n+  |             ^^^^^^^^^^^^^\n+  |\n+  = note: #[warn(zero_ptr)] on by default\n+"}]}