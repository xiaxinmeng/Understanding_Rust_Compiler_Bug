{"sha": "d3e91918759a44372ea42afd11bbc2644a7883a7", "node_id": "C_kwDOAAsO6NoAKGQzZTkxOTE4NzU5YTQ0MzcyZWE0MmFmZDExYmJjMjY0NGE3ODgzYTc", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2022-11-23T15:02:36Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-11-23T15:02:36Z"}, "message": "Rollup merge of #104286 - ozkanonur:fix-doc-bootstrap-recompilation, r=jyn514\n\ncopy doc output files by format\n\nThis pr provides copying doc outputs by checking output format without removing output directory on each trigger.\n\nResolves #103785", "tree": {"sha": "ea27227f394b1fbaca403b072720afd4d071b3b2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ea27227f394b1fbaca403b072720afd4d071b3b2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d3e91918759a44372ea42afd11bbc2644a7883a7", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjfjYMCRBK7hj4Ov3rIwAAqnkIABUjgI01tKlOonXF5eZPlse9\nbyXhWrgf4ZLSaeBHvQ8eOglRcSqCwI2zboJw5XOO+NTFbn+aA391FZfcx9UhXgdo\nmnXOpzoUmLB3N5gn669h0LtDoLEH+xsmReYeUwxMmeQw4BS660sbpRBDZtHnR60R\nOSQDtfK49b3tFiF5hlQtEErjghFskdbhW35Zf3O0tCgdDXxV0lDzNbQNBE3SpPsc\nj1ampvyQ9z+Su4uA6EndGvQTN8Xe8A1wBAwRjkGSSqEdjJyAK1Kp5S3laS7+nAJ0\nsQ0a/j/Jo89vZ0qHvhUdjF4K1VzWsQhsYu5xGtpOGmVagPEL6X8Rb0ixSiIGZB8=\n=IKQm\n-----END PGP SIGNATURE-----\n", "payload": "tree ea27227f394b1fbaca403b072720afd4d071b3b2\nparent bd91c94a5d744e0f93aff073bdbb69d0f4e8d9f6\nparent 7e28df9561cbfb98c0b5a7f4868823709c1914c1\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1669215756 +0530\ncommitter GitHub <noreply@github.com> 1669215756 +0530\n\nRollup merge of #104286 - ozkanonur:fix-doc-bootstrap-recompilation, r=jyn514\n\ncopy doc output files by format\n\nThis pr provides copying doc outputs by checking output format without removing output directory on each trigger.\n\nResolves #103785\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d3e91918759a44372ea42afd11bbc2644a7883a7", "html_url": "https://github.com/rust-lang/rust/commit/d3e91918759a44372ea42afd11bbc2644a7883a7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d3e91918759a44372ea42afd11bbc2644a7883a7/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bd91c94a5d744e0f93aff073bdbb69d0f4e8d9f6", "url": "https://api.github.com/repos/rust-lang/rust/commits/bd91c94a5d744e0f93aff073bdbb69d0f4e8d9f6", "html_url": "https://github.com/rust-lang/rust/commit/bd91c94a5d744e0f93aff073bdbb69d0f4e8d9f6"}, {"sha": "7e28df9561cbfb98c0b5a7f4868823709c1914c1", "url": "https://api.github.com/repos/rust-lang/rust/commits/7e28df9561cbfb98c0b5a7f4868823709c1914c1", "html_url": "https://github.com/rust-lang/rust/commit/7e28df9561cbfb98c0b5a7f4868823709c1914c1"}], "stats": {"total": 66, "additions": 52, "deletions": 14}, "files": [{"sha": "251431a15eb89a19bcba27d867eff9f99f18365b", "filename": "src/bootstrap/builder.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/d3e91918759a44372ea42afd11bbc2644a7883a7/src%2Fbootstrap%2Fbuilder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d3e91918759a44372ea42afd11bbc2644a7883a7/src%2Fbootstrap%2Fbuilder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuilder.rs?ref=d3e91918759a44372ea42afd11bbc2644a7883a7", "patch": "@@ -1094,7 +1094,13 @@ impl<'a> Builder<'a> {\n             let my_out = match mode {\n                 // This is the intended out directory for compiler documentation.\n                 Mode::Rustc | Mode::ToolRustc => self.compiler_doc_out(target),\n-                Mode::Std => out_dir.join(target.triple).join(\"doc\"),\n+                Mode::Std => {\n+                    if self.config.cmd.json() {\n+                        out_dir.join(target.triple).join(\"json-doc\")\n+                    } else {\n+                        out_dir.join(target.triple).join(\"doc\")\n+                    }\n+                }\n                 _ => panic!(\"doc mode {:?} not expected\", mode),\n             };\n             let rustdoc = self.rustdoc(compiler);"}, {"sha": "571396eb835bff3e247dd03a8e895d552c7b7173", "filename": "src/bootstrap/doc.rs", "status": "modified", "additions": 8, "deletions": 13, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/d3e91918759a44372ea42afd11bbc2644a7883a7/src%2Fbootstrap%2Fdoc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d3e91918759a44372ea42afd11bbc2644a7883a7/src%2Fbootstrap%2Fdoc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fdoc.rs?ref=d3e91918759a44372ea42afd11bbc2644a7883a7", "patch": "@@ -564,27 +564,22 @@ fn doc_std(\n         );\n     }\n     let compiler = builder.compiler(stage, builder.config.build);\n+\n+    let target_doc_dir_name = if format == DocumentationFormat::JSON { \"json-doc\" } else { \"doc\" };\n+    let target_dir =\n+        builder.stage_out(compiler, Mode::Std).join(target.triple).join(target_doc_dir_name);\n+\n     // This is directory where the compiler will place the output of the command.\n     // We will then copy the files from this directory into the final `out` directory, the specified\n     // as a function parameter.\n-    let out_dir = builder.stage_out(compiler, Mode::Std).join(target.triple).join(\"doc\");\n-    // `cargo` uses the same directory for both JSON docs and HTML docs.\n-    // This could lead to cross-contamination when copying files into the specified `out` directory.\n-    // For example:\n-    // ```bash\n-    // x doc std\n-    // x doc std --json\n-    // ```\n-    // could lead to HTML docs being copied into the JSON docs output directory.\n-    // To avoid this issue, we clean the doc folder before invoking `cargo`.\n-    if out_dir.exists() {\n-        builder.remove_dir(&out_dir);\n-    }\n+    let out_dir = target_dir.join(target.triple).join(\"doc\");\n \n     let run_cargo_rustdoc_for = |package: &str| {\n         let mut cargo = builder.cargo(compiler, Mode::Std, SourceType::InTree, target, \"rustdoc\");\n         compile::std_cargo(builder, target, compiler.stage, &mut cargo);\n         cargo\n+            .arg(\"--target-dir\")\n+            .arg(&*target_dir.to_string_lossy())\n             .arg(\"-p\")\n             .arg(package)\n             .arg(\"-Zskip-rustdoc-fingerprint\")"}, {"sha": "bfabbbc65862fcb04d3190ebfd89713ddb7e38d2", "filename": "src/test/run-make/rustdoc-verify-output-files/Makefile", "status": "added", "additions": 36, "deletions": 0, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/d3e91918759a44372ea42afd11bbc2644a7883a7/src%2Ftest%2Frun-make%2Frustdoc-verify-output-files%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/d3e91918759a44372ea42afd11bbc2644a7883a7/src%2Ftest%2Frun-make%2Frustdoc-verify-output-files%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Frustdoc-verify-output-files%2FMakefile?ref=d3e91918759a44372ea42afd11bbc2644a7883a7", "patch": "@@ -0,0 +1,36 @@\n+include ../../run-make-fulldeps/tools.mk\n+\n+OUTPUT_DIR := \"$(TMPDIR)/rustdoc\"\n+TMP_OUTPUT_DIR := \"$(TMPDIR)/tmp-rustdoc\"\n+\n+all:\n+\t# Generate html docs\n+\t$(RUSTDOC) src/lib.rs --crate-name foobar --crate-type lib --out-dir $(OUTPUT_DIR)\n+\n+\t# Copy first output for to check if it's exactly same after second compilation\n+\tcp -R $(OUTPUT_DIR) $(TMP_OUTPUT_DIR)\n+\n+\t# Generate html docs once again on same output\n+\t$(RUSTDOC) src/lib.rs --crate-name foobar --crate-type lib --out-dir $(OUTPUT_DIR)\n+\n+\t# Check if everything exactly same\n+\t$(DIFF) -r -q $(OUTPUT_DIR) $(TMP_OUTPUT_DIR)\n+\n+\t# Generate json doc on the same output\n+\t$(RUSTDOC) src/lib.rs --crate-name foobar --crate-type lib --out-dir $(OUTPUT_DIR) -Z unstable-options --output-format json\n+\n+\t# Check if expected json file is generated\n+\t[ -e $(OUTPUT_DIR)/foobar.json ]\n+\n+\t# TODO\n+\t# We should re-generate json doc once again and compare the diff with previously\n+\t# generated one. Because layout of json docs changes in each compilation, we can't\n+\t# do that currently.\n+\t#\n+\t# See https://github.com/rust-lang/rust/issues/103785#issuecomment-1307425590 for details.\n+\n+\t# remove generated json doc\n+\trm $(OUTPUT_DIR)/foobar.json\n+\n+\t# Check if json doc compilation broke any of the html files generated previously\n+\t$(DIFF) -r -q $(OUTPUT_DIR) $(TMP_OUTPUT_DIR)"}, {"sha": "5df7576133a684ab8f887f442084e99062eb4886", "filename": "src/test/run-make/rustdoc-verify-output-files/src/lib.rs", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d3e91918759a44372ea42afd11bbc2644a7883a7/src%2Ftest%2Frun-make%2Frustdoc-verify-output-files%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d3e91918759a44372ea42afd11bbc2644a7883a7/src%2Ftest%2Frun-make%2Frustdoc-verify-output-files%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Frustdoc-verify-output-files%2Fsrc%2Flib.rs?ref=d3e91918759a44372ea42afd11bbc2644a7883a7", "patch": "@@ -0,0 +1 @@\n+// nothing to see here"}]}