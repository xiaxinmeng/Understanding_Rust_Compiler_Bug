{"sha": "3a4fdcf86cea75796ed947853ea9544f2d11afff", "node_id": "C_kwDOAAsO6NoAKDNhNGZkY2Y4NmNlYTc1Nzk2ZWQ5NDc4NTNlYTk1NDRmMmQxMWFmZmY", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2023-01-15T20:59:47Z"}, "committer": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2023-01-16T14:59:27Z"}, "message": "Encode const mir for closures if they're const", "tree": {"sha": "a8f03e107242c8cb7225383b07fb6ad64d4f2210", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a8f03e107242c8cb7225383b07fb6ad64d4f2210"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3a4fdcf86cea75796ed947853ea9544f2d11afff", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3a4fdcf86cea75796ed947853ea9544f2d11afff", "html_url": "https://github.com/rust-lang/rust/commit/3a4fdcf86cea75796ed947853ea9544f2d11afff", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3a4fdcf86cea75796ed947853ea9544f2d11afff/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a5bfc25c93d2549887848529382892f93c95207d", "url": "https://api.github.com/repos/rust-lang/rust/commits/a5bfc25c93d2549887848529382892f93c95207d", "html_url": "https://github.com/rust-lang/rust/commit/a5bfc25c93d2549887848529382892f93c95207d"}], "stats": {"total": 29, "additions": 18, "deletions": 11}, "files": [{"sha": "e8ae9712a6330386a1112a6c6f20abdfd13b246f", "filename": "compiler/rustc_metadata/src/rmeta/encoder.rs", "status": "modified", "additions": 2, "deletions": 11, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/3a4fdcf86cea75796ed947853ea9544f2d11afff/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fencoder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3a4fdcf86cea75796ed947853ea9544f2d11afff/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fencoder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fencoder.rs?ref=3a4fdcf86cea75796ed947853ea9544f2d11afff", "patch": "@@ -888,8 +888,8 @@ fn should_encode_mir(tcx: TyCtxt<'_>, def_id: LocalDefId) -> (bool, bool) {\n         | DefKind::AssocConst\n         | DefKind::Static(..)\n         | DefKind::Const => (true, false),\n-        // Full-fledged functions\n-        DefKind::AssocFn | DefKind::Fn => {\n+        // Full-fledged functions + closures\n+        DefKind::AssocFn | DefKind::Fn | DefKind::Closure => {\n             let generics = tcx.generics_of(def_id);\n             let needs_inline = (generics.requires_monomorphization(tcx)\n                 || tcx.codegen_fn_attrs(def_id).requests_inline())\n@@ -900,15 +900,6 @@ fn should_encode_mir(tcx: TyCtxt<'_>, def_id: LocalDefId) -> (bool, bool) {\n             let always_encode_mir = tcx.sess.opts.unstable_opts.always_encode_mir;\n             (is_const_fn, needs_inline || always_encode_mir)\n         }\n-        // Closures can't be const fn.\n-        DefKind::Closure => {\n-            let generics = tcx.generics_of(def_id);\n-            let needs_inline = (generics.requires_monomorphization(tcx)\n-                || tcx.codegen_fn_attrs(def_id).requests_inline())\n-                && tcx.sess.opts.output_types.should_codegen();\n-            let always_encode_mir = tcx.sess.opts.unstable_opts.always_encode_mir;\n-            (false, needs_inline || always_encode_mir)\n-        }\n         // Generators require optimized MIR to compute layout.\n         DefKind::Generator => (false, true),\n         // The others don't have MIR."}, {"sha": "edc7fa81abb4fc97269a88a857308b97548fd895", "filename": "tests/ui/consts/auxiliary/closure-in-foreign-crate.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/3a4fdcf86cea75796ed947853ea9544f2d11afff/tests%2Fui%2Fconsts%2Fauxiliary%2Fclosure-in-foreign-crate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3a4fdcf86cea75796ed947853ea9544f2d11afff/tests%2Fui%2Fconsts%2Fauxiliary%2Fclosure-in-foreign-crate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fconsts%2Fauxiliary%2Fclosure-in-foreign-crate.rs?ref=3a4fdcf86cea75796ed947853ea9544f2d11afff", "patch": "@@ -0,0 +1,8 @@\n+#![crate_type = \"lib\"]\n+#![feature(const_closures, const_trait_impl)]\n+#![allow(incomplete_features)]\n+\n+pub const fn test() {\n+    let cl = const || {};\n+    cl();\n+}"}, {"sha": "fc8f480e706bcd695f0e74057061991266fa672c", "filename": "tests/ui/consts/closure-in-foreign-crate.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/3a4fdcf86cea75796ed947853ea9544f2d11afff/tests%2Fui%2Fconsts%2Fclosure-in-foreign-crate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3a4fdcf86cea75796ed947853ea9544f2d11afff/tests%2Fui%2Fconsts%2Fclosure-in-foreign-crate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fconsts%2Fclosure-in-foreign-crate.rs?ref=3a4fdcf86cea75796ed947853ea9544f2d11afff", "patch": "@@ -0,0 +1,8 @@\n+// aux-build:closure-in-foreign-crate.rs\n+// build-pass\n+\n+extern crate closure_in_foreign_crate;\n+\n+const _: () = closure_in_foreign_crate::test();\n+\n+fn main() {}"}]}