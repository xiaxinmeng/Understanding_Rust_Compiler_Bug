{"sha": "08526c8a9de581fccbc5db9f8c4a6d9db301c1c1", "node_id": "MDY6Q29tbWl0NzI0NzEyOjA4NTI2YzhhOWRlNTgxZmNjYmM1ZGI5ZjhjNGE2ZDlkYjMwMWMxYzE=", "commit": {"author": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-03-22T09:51:22Z"}, "committer": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-03-22T14:43:35Z"}, "message": "Rollup merge of #49093 - Zoxc:speedup, r=aidanhs\n\nUpdate submodules in parallel", "tree": {"sha": "6c069a869d618ef68fd2e936a85ec6a1c53ffa16", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6c069a869d618ef68fd2e936a85ec6a1c53ffa16"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/08526c8a9de581fccbc5db9f8c4a6d9db301c1c1", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEZ1R8CLMp8f2GxWoQ/vbIBR0OATwFAlqzwRcACgkQ/vbIBR0O\nATyFnRAAmRVRpzZOhnElEQpVMT4onXoJRRdtbiKz0Nwo9kDM6OxshybQTYaowLJ6\nhYSZ7986F/vHC3OyBoausl3UCWemzl/5ZOASt+xVaHdr5yMmqQ/8SRRGJTZ3V1bh\nWOzEuxg2YLOOe9Hqe2BpkepO9OzCX8qhorAk5NMa4cbqTdfkZxskmNDPC4thzlGg\nOt3ON6i3P5AbwPWl+WrgY5XTxlCfsox0yei83bU845oEm74uGcnP9k58l41362be\nQ5sHrJHMmycs5d1Gzy/HaFjjnGhnSvyMKGgB2rUSCN1KGtfipONC+ZLAmuVxU6hw\nnbqnRkGf5oQWj9OQQrlXFFDTO5b6lkO0r2w2sowc5/01eVvlSZ0mV7JwIYhLE+SO\nBVpKQEcCmJ1rxX8W9qK/dCsv0Exrp+/VJsGf8n+6Ca+LWllasGOKDbSL9SxRWpl8\nnLZKowkgMYMOblBxOhvSPn/QgVnuHk3qbbwWYJZUU1yihgK0hib2dqHpekxxu5lA\n6aY5idIe+EIzKE0lXGFaCaDQHwwIaaqBZHYoGXidRROjdLIwtvQzdqemJd+1ZYHD\nm0sm+mBzle8I/7E7tyN4Fd7DUAbThQp4Qq2/3wC8TV2eIMwi4K+XOc2bTAoF62Ci\nVWp+yr6oSY3wG/Z3AjhulWsT8vu5bmtOPhYbnZjCFc0KNyBThPk=\n=oWSC\n-----END PGP SIGNATURE-----", "payload": "tree 6c069a869d618ef68fd2e936a85ec6a1c53ffa16\nparent 50850c62c51a1bf88845a59b3540315156bab5a2\nparent 1578b1edc0a1ac9dfa289d369d88bcd0a7db22e3\nauthor kennytm <kennytm@gmail.com> 1521712282 +0800\ncommitter kennytm <kennytm@gmail.com> 1521729815 +0800\n\nRollup merge of #49093 - Zoxc:speedup, r=aidanhs\n\nUpdate submodules in parallel\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/08526c8a9de581fccbc5db9f8c4a6d9db301c1c1", "html_url": "https://github.com/rust-lang/rust/commit/08526c8a9de581fccbc5db9f8c4a6d9db301c1c1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/08526c8a9de581fccbc5db9f8c4a6d9db301c1c1/comments", "author": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "50850c62c51a1bf88845a59b3540315156bab5a2", "url": "https://api.github.com/repos/rust-lang/rust/commits/50850c62c51a1bf88845a59b3540315156bab5a2", "html_url": "https://github.com/rust-lang/rust/commit/50850c62c51a1bf88845a59b3540315156bab5a2"}, {"sha": "1578b1edc0a1ac9dfa289d369d88bcd0a7db22e3", "url": "https://api.github.com/repos/rust-lang/rust/commits/1578b1edc0a1ac9dfa289d369d88bcd0a7db22e3", "html_url": "https://github.com/rust-lang/rust/commit/1578b1edc0a1ac9dfa289d369d88bcd0a7db22e3"}], "stats": {"total": 72, "additions": 29, "deletions": 43}, "files": [{"sha": "f2664e6d196c7afcab810ab0ee15f5e30b14eb64", "filename": "src/ci/init_repo.sh", "status": "modified", "additions": 29, "deletions": 43, "changes": 72, "blob_url": "https://github.com/rust-lang/rust/blob/08526c8a9de581fccbc5db9f8c4a6d9db301c1c1/src%2Fci%2Finit_repo.sh", "raw_url": "https://github.com/rust-lang/rust/raw/08526c8a9de581fccbc5db9f8c4a6d9db301c1c1/src%2Fci%2Finit_repo.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Finit_repo.sh?ref=08526c8a9de581fccbc5db9f8c4a6d9db301c1c1", "patch": "@@ -17,6 +17,7 @@ ci_dir=$(cd $(dirname $0) && pwd)\n . \"$ci_dir/shared.sh\"\n \n travis_fold start init_repo\n+travis_time_start\n \n REPO_DIR=\"$1\"\n CACHE_DIR=\"$2\"\n@@ -42,54 +43,39 @@ if grep -q RUST_RELEASE_CHANNEL=beta src/ci/run.sh; then\n   git fetch origin --unshallow beta master\n fi\n \n-travis_fold start update_cache\n-travis_time_start\n-\n-# Update the cache (a pristine copy of the rust source master)\n-retry sh -c \"rm -rf $cache_src_dir && mkdir -p $cache_src_dir && \\\n-    git clone --depth 1 https://github.com/rust-lang/rust.git $cache_src_dir\"\n-if [ -d $cache_src_dir/src/llvm ]; then\n-  (cd $cache_src_dir && git rm src/llvm)\n-fi\n-if [ -d $cache_src_dir/src/llvm-emscripten ]; then\n-  (cd $cache_src_dir && git rm src/llvm-emscripten)\n-fi\n-retry sh -c \"cd $cache_src_dir && \\\n-    git submodule deinit -f . && git submodule sync && git submodule update --init\"\n-\n-travis_fold end update_cache\n-travis_time_finish\n+function fetch_submodule {\n+    local module=$1\n+    local cached=\"download-${module//\\//-}.tar.gz\"\n+    retry sh -c \"rm -f $cached && \\\n+        curl -sSL -o $cached $2\"\n+    mkdir $module\n+    touch \"$module/.git\"\n+    tar -C $module --strip-components=1 -xf $cached\n+    rm $cached\n+}\n \n-travis_fold start update_submodules\n-travis_time_start\n-\n-# Update the submodules of the repo we're in, using the pristine repo as\n-# a cache for any object files\n-# No, `git submodule foreach` won't work:\n-# http://stackoverflow.com/questions/12641469/list-submodules-in-a-git-repository\n+included=\"src/llvm src/llvm-emscripten src/doc/book src/doc/rust-by-example\"\n modules=\"$(git config --file .gitmodules --get-regexp '\\.path$' | cut -d' ' -f2)\"\n-for module in $modules; do\n-    if [ \"$module\" = src/llvm ] || [ \"$module\" = src/llvm-emscripten ]; then\n+modules=($modules)\n+use_git=\"\"\n+urls=\"$(git config --file .gitmodules --get-regexp '\\.url$' | cut -d' ' -f2)\"\n+urls=($urls)\n+for i in ${!modules[@]}; do\n+    module=${modules[$i]}\n+    if [[ \" $included \" = *\" $module \"* ]]; then\n         commit=\"$(git ls-tree HEAD $module | awk '{print $3}')\"\n         git rm $module\n-        retry sh -c \"rm -f $commit.tar.gz && \\\n-            curl -sSL -O https://github.com/rust-lang/llvm/archive/$commit.tar.gz\"\n-        tar -C src/ -xf \"$commit.tar.gz\"\n-        rm \"$commit.tar.gz\"\n-        mv \"src/llvm-$commit\" $module\n-        continue\n-    fi\n-    if [ ! -e \"$cache_src_dir/$module/.git\" ]; then\n-        echo \"WARNING: $module not found in pristine repo\"\n-        retry sh -c \"git submodule deinit -f $module && \\\n-            git submodule update --init --recursive $module\"\n+        url=${urls[$i]}\n+        url=${url/\\.git/}\n+        fetch_submodule $module \"$url/archive/$commit.tar.gz\" &\n         continue\n+    else\n+        use_git=\"$use_git $module\"\n     fi\n-    retry sh -c \"git submodule deinit -f $module && \\\n-        git submodule update --init --recursive --reference $cache_src_dir/$module $module\"\n done\n-\n-travis_fold end update_submodules\n-travis_time_finish\n-\n+retry sh -c \"git submodule deinit -f $use_git && \\\n+    git submodule sync && \\\n+    git submodule update -j 16 --init --recursive $use_git\"\n+wait\n travis_fold end init_repo\n+travis_time_finish"}]}