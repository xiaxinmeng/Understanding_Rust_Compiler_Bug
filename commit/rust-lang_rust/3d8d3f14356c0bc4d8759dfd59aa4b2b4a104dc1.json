{"sha": "3d8d3f14356c0bc4d8759dfd59aa4b2b4a104dc1", "node_id": "C_kwDOAAsO6NoAKDNkOGQzZjE0MzU2YzBiYzRkODc1OWRmZDU5YWE0YjJiNGExMDRkYzE", "commit": {"author": {"name": "Jakub Ber\u00e1nek", "email": "berykubik@gmail.com", "date": "2021-12-31T10:10:27Z"}, "committer": {"name": "Jakub Ber\u00e1nek", "email": "berykubik@gmail.com", "date": "2022-01-01T10:29:14Z"}, "message": "Rustdoc: use ThinVec for GenericArgs bindings", "tree": {"sha": "5c83675e2444262c9826356ef8d920aa82422051", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5c83675e2444262c9826356ef8d920aa82422051"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3d8d3f14356c0bc4d8759dfd59aa4b2b4a104dc1", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQGzBAABCgAdFiEEg8FrwI85f934CWFa28VT5UDC9hkFAmHQLPoACgkQ28VT5UDC\n9hmQnwwAq0dwAKCSPhfspsiXtBSzMVaSdsqSvg5TEi4bAdAQflksoTwl/ppISSSr\na+stFrR3HDhstMR1tOnndcjVpvftxRlqL/8nzyLpp56DiQTRDlQLmkbbmAReu102\nmjQI6DvTkH6aS0DzMDewE74VkeywSdNlm4Js5hBgyB4tNocf4dDjozFgomsX57pj\nEUfhGCMCL3S/1lL+YlVVBKFQsGYaCFqNC1o9OhiDP6MISAGORAV5hUgASPftT/9A\n3d27Ja9L6owelbT9d5GmTV/e3Mq5lf1Q0/UCbvRTlSalx1UrykIho5Tq4e8/+SS1\n15/waEQck+zEYAECGylwWVcaRXcShlaWzf/1+3gGd1nEvLeHVPhAgD75VDIT8ipq\nma7CRmPprocqmJYCKdsCuWbJ9t9pBOe/G4UnAdRkdIyNdlxWar4alDHvUgaViP91\nH6XSWXWNrjhKfdwTL9ZtlQT/9z++9/qUYTV1GwJCaECzQTwWi2O2nbVcTeQOwMgw\ngg0MQhh5\n=ehry\n-----END PGP SIGNATURE-----", "payload": "tree 5c83675e2444262c9826356ef8d920aa82422051\nparent e91ad5fc62bdee4a29c18baa5fad2ca42fc91bf4\nauthor Jakub Ber\u00e1nek <berykubik@gmail.com> 1640945427 +0100\ncommitter Jakub Ber\u00e1nek <berykubik@gmail.com> 1641032954 +0100\n\nRustdoc: use ThinVec for GenericArgs bindings\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3d8d3f14356c0bc4d8759dfd59aa4b2b4a104dc1", "html_url": "https://github.com/rust-lang/rust/commit/3d8d3f14356c0bc4d8759dfd59aa4b2b4a104dc1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3d8d3f14356c0bc4d8759dfd59aa4b2b4a104dc1/comments", "author": {"login": "Kobzol", "id": 4539057, "node_id": "MDQ6VXNlcjQ1MzkwNTc=", "avatar_url": "https://avatars.githubusercontent.com/u/4539057?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Kobzol", "html_url": "https://github.com/Kobzol", "followers_url": "https://api.github.com/users/Kobzol/followers", "following_url": "https://api.github.com/users/Kobzol/following{/other_user}", "gists_url": "https://api.github.com/users/Kobzol/gists{/gist_id}", "starred_url": "https://api.github.com/users/Kobzol/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Kobzol/subscriptions", "organizations_url": "https://api.github.com/users/Kobzol/orgs", "repos_url": "https://api.github.com/users/Kobzol/repos", "events_url": "https://api.github.com/users/Kobzol/events{/privacy}", "received_events_url": "https://api.github.com/users/Kobzol/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Kobzol", "id": 4539057, "node_id": "MDQ6VXNlcjQ1MzkwNTc=", "avatar_url": "https://avatars.githubusercontent.com/u/4539057?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Kobzol", "html_url": "https://github.com/Kobzol", "followers_url": "https://api.github.com/users/Kobzol/followers", "following_url": "https://api.github.com/users/Kobzol/following{/other_user}", "gists_url": "https://api.github.com/users/Kobzol/gists{/gist_id}", "starred_url": "https://api.github.com/users/Kobzol/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Kobzol/subscriptions", "organizations_url": "https://api.github.com/users/Kobzol/orgs", "repos_url": "https://api.github.com/users/Kobzol/repos", "events_url": "https://api.github.com/users/Kobzol/events{/privacy}", "received_events_url": "https://api.github.com/users/Kobzol/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e91ad5fc62bdee4a29c18baa5fad2ca42fc91bf4", "url": "https://api.github.com/repos/rust-lang/rust/commits/e91ad5fc62bdee4a29c18baa5fad2ca42fc91bf4", "html_url": "https://github.com/rust-lang/rust/commit/e91ad5fc62bdee4a29c18baa5fad2ca42fc91bf4"}], "stats": {"total": 30, "additions": 18, "deletions": 12}, "files": [{"sha": "716259142d18b22062149c4faa2c58de3c0966b6", "filename": "compiler/rustc_data_structures/src/thin_vec.rs", "status": "modified", "additions": 9, "deletions": 5, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/3d8d3f14356c0bc4d8759dfd59aa4b2b4a104dc1/compiler%2Frustc_data_structures%2Fsrc%2Fthin_vec.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3d8d3f14356c0bc4d8759dfd59aa4b2b4a104dc1/compiler%2Frustc_data_structures%2Fsrc%2Fthin_vec.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_data_structures%2Fsrc%2Fthin_vec.rs?ref=3d8d3f14356c0bc4d8759dfd59aa4b2b4a104dc1", "patch": "@@ -5,7 +5,7 @@ use std::iter::FromIterator;\n /// A vector type optimized for cases where this size is usually 0 (cf. `SmallVec`).\n /// The `Option<Box<..>>` wrapping allows us to represent a zero sized vector with `None`,\n /// which uses only a single (null) pointer.\n-#[derive(Clone, Encodable, Decodable, Debug)]\n+#[derive(Clone, Encodable, Decodable, Debug, Hash, Eq, PartialEq)]\n pub struct ThinVec<T>(Option<Box<Vec<T>>>);\n \n impl<T> ThinVec<T> {\n@@ -20,6 +20,13 @@ impl<T> ThinVec<T> {\n     pub fn iter_mut(&mut self) -> std::slice::IterMut<'_, T> {\n         self.into_iter()\n     }\n+\n+    pub fn push(&mut self, item: T) {\n+        match *self {\n+            ThinVec(Some(ref mut vec)) => vec.push(item),\n+            ThinVec(None) => *self = vec![item].into(),\n+        }\n+    }\n }\n \n impl<T> From<Vec<T>> for ThinVec<T> {\n@@ -101,10 +108,7 @@ impl<T> Extend<T> for ThinVec<T> {\n     }\n \n     fn extend_one(&mut self, item: T) {\n-        match *self {\n-            ThinVec(Some(ref mut vec)) => vec.push(item),\n-            ThinVec(None) => *self = vec![item].into(),\n-        }\n+        self.push(item)\n     }\n \n     fn extend_reserve(&mut self, additional: usize) {"}, {"sha": "ce0ac322af914e87d69937853950faf7b9f9e9f4", "filename": "src/librustdoc/clean/inline.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/3d8d3f14356c0bc4d8759dfd59aa4b2b4a104dc1/src%2Flibrustdoc%2Fclean%2Finline.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3d8d3f14356c0bc4d8759dfd59aa4b2b4a104dc1/src%2Flibrustdoc%2Fclean%2Finline.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Finline.rs?ref=3d8d3f14356c0bc4d8759dfd59aa4b2b4a104dc1", "patch": "@@ -5,6 +5,7 @@ use std::sync::Arc;\n \n use rustc_ast as ast;\n use rustc_data_structures::fx::FxHashSet;\n+use rustc_data_structures::thin_vec::ThinVec;\n use rustc_hir as hir;\n use rustc_hir::def::{DefKind, Res};\n use rustc_hir::def_id::DefId;\n@@ -540,7 +541,7 @@ fn build_module(\n                                     name: prim_ty.as_sym(),\n                                     args: clean::GenericArgs::AngleBracketed {\n                                         args: Vec::new(),\n-                                        bindings: Vec::new(),\n+                                        bindings: ThinVec::new(),\n                                     },\n                                 }],\n                             },"}, {"sha": "5416eecf974254d86b612460ff1938566ff392e8", "filename": "src/librustdoc/clean/types.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/3d8d3f14356c0bc4d8759dfd59aa4b2b4a104dc1/src%2Flibrustdoc%2Fclean%2Ftypes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3d8d3f14356c0bc4d8759dfd59aa4b2b4a104dc1/src%2Flibrustdoc%2Fclean%2Ftypes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Ftypes.rs?ref=3d8d3f14356c0bc4d8759dfd59aa4b2b4a104dc1", "patch": "@@ -2051,14 +2051,14 @@ rustc_data_structures::static_assert_size!(GenericArg, 80);\n \n #[derive(Clone, PartialEq, Eq, Debug, Hash)]\n crate enum GenericArgs {\n-    AngleBracketed { args: Vec<GenericArg>, bindings: Vec<TypeBinding> },\n+    AngleBracketed { args: Vec<GenericArg>, bindings: ThinVec<TypeBinding> },\n     Parenthesized { inputs: Vec<Type>, output: Option<Box<Type>> },\n }\n \n // `GenericArgs` is in every `PathSegment`, so its size can significantly\n // affect rustdoc's memory usage.\n #[cfg(all(target_arch = \"x86_64\", target_pointer_width = \"64\"))]\n-rustc_data_structures::static_assert_size!(GenericArgs, 56);\n+rustc_data_structures::static_assert_size!(GenericArgs, 40);\n \n #[derive(Clone, PartialEq, Eq, Debug, Hash)]\n crate struct PathSegment {\n@@ -2069,7 +2069,7 @@ crate struct PathSegment {\n // `PathSegment` usually occurs multiple times in every `Path`, so its size can\n // significantly affect rustdoc's memory usage.\n #[cfg(all(target_arch = \"x86_64\", target_pointer_width = \"64\"))]\n-rustc_data_structures::static_assert_size!(PathSegment, 64);\n+rustc_data_structures::static_assert_size!(PathSegment, 48);\n \n #[derive(Clone, Debug)]\n crate struct Typedef {"}, {"sha": "25233cd71b4501c981901b5c45fcd7df7cc6f157", "filename": "src/librustdoc/clean/utils.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/3d8d3f14356c0bc4d8759dfd59aa4b2b4a104dc1/src%2Flibrustdoc%2Fclean%2Futils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3d8d3f14356c0bc4d8759dfd59aa4b2b4a104dc1/src%2Flibrustdoc%2Fclean%2Futils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Futils.rs?ref=3d8d3f14356c0bc4d8759dfd59aa4b2b4a104dc1", "patch": "@@ -10,6 +10,7 @@ use crate::visit_lib::LibEmbargoVisitor;\n \n use rustc_ast as ast;\n use rustc_ast::tokenstream::TokenTree;\n+use rustc_data_structures::thin_vec::ThinVec;\n use rustc_hir as hir;\n use rustc_hir::def::{DefKind, Res};\n use rustc_hir::def_id::{DefId, LOCAL_CRATE};\n@@ -108,7 +109,7 @@ fn external_generic_args(\n     if cx.tcx.fn_trait_kind_from_lang_item(did).is_some() {\n         let inputs = match ty_kind.unwrap() {\n             ty::Tuple(tys) => tys.iter().map(|t| t.expect_ty().clean(cx)).collect(),\n-            _ => return GenericArgs::AngleBracketed { args, bindings },\n+            _ => return GenericArgs::AngleBracketed { args, bindings: bindings.into() },\n         };\n         let output = None;\n         // FIXME(#20299) return type comes from a projection now\n@@ -118,7 +119,7 @@ fn external_generic_args(\n         // };\n         GenericArgs::Parenthesized { inputs, output }\n     } else {\n-        GenericArgs::AngleBracketed { args, bindings }\n+        GenericArgs::AngleBracketed { args, bindings: bindings.into() }\n     }\n }\n \n@@ -143,7 +144,7 @@ pub(super) fn external_path(\n /// Remove the generic arguments from a path.\n crate fn strip_path_generics(mut path: Path) -> Path {\n     for ps in path.segments.iter_mut() {\n-        ps.args = GenericArgs::AngleBracketed { args: vec![], bindings: vec![] }\n+        ps.args = GenericArgs::AngleBracketed { args: vec![], bindings: ThinVec::new() }\n     }\n \n     path"}]}