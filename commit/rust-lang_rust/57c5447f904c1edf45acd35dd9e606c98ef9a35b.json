{"sha": "57c5447f904c1edf45acd35dd9e606c98ef9a35b", "node_id": "C_kwDOAAsO6NoAKDU3YzU0NDdmOTA0YzFlZGY0NWFjZDM1ZGQ5ZTYwNmM5OGVmOWEzNWI", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-05-06T11:12:29Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-05-06T11:12:29Z"}, "message": "Auto merge of #12174 - Veykril:completion-rev, r=Veykril\n\ninternal: Improve completion tests by checking that the offset is included in the source_range of items", "tree": {"sha": "f90e627cf97bf788b80d15f41695a84e752c4c7b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f90e627cf97bf788b80d15f41695a84e752c4c7b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/57c5447f904c1edf45acd35dd9e606c98ef9a35b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/57c5447f904c1edf45acd35dd9e606c98ef9a35b", "html_url": "https://github.com/rust-lang/rust/commit/57c5447f904c1edf45acd35dd9e606c98ef9a35b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/57c5447f904c1edf45acd35dd9e606c98ef9a35b/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "db1434b34f0cf11c54207d2bcf420547fb319a25", "url": "https://api.github.com/repos/rust-lang/rust/commits/db1434b34f0cf11c54207d2bcf420547fb319a25", "html_url": "https://github.com/rust-lang/rust/commit/db1434b34f0cf11c54207d2bcf420547fb319a25"}, {"sha": "582f99d293359b6276813c4433db36c6e790152e", "url": "https://api.github.com/repos/rust-lang/rust/commits/582f99d293359b6276813c4433db36c6e790152e", "html_url": "https://github.com/rust-lang/rust/commit/582f99d293359b6276813c4433db36c6e790152e"}], "stats": {"total": 14, "additions": 12, "deletions": 2}, "files": [{"sha": "140e5b600b17d26b7c5194cb64e423ec78e69dd3", "filename": "crates/ide-completion/src/item.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/57c5447f904c1edf45acd35dd9e606c98ef9a35b/crates%2Fide-completion%2Fsrc%2Fitem.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57c5447f904c1edf45acd35dd9e606c98ef9a35b/crates%2Fide-completion%2Fsrc%2Fitem.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Fitem.rs?ref=57c5447f904c1edf45acd35dd9e606c98ef9a35b", "patch": "@@ -26,7 +26,7 @@ pub struct CompletionItem {\n     /// It should be used primarily for UI, but we also use this to convert\n     /// generic TextEdit into LSP's completion edit (see conv.rs).\n     ///\n-    /// `source_range` must contain the completion offset. `insert_text` should\n+    /// `source_range` must contain the completion offset. `text_edit` should\n     /// start with what `source_range` points to, or VSCode will filter out the\n     /// completion silently.\n     source_range: TextRange,"}, {"sha": "72b7a5584aa69ef1357bcc536539ac097020c831", "filename": "crates/ide-completion/src/tests.rs", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/57c5447f904c1edf45acd35dd9e606c98ef9a35b/crates%2Fide-completion%2Fsrc%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57c5447f904c1edf45acd35dd9e606c98ef9a35b/crates%2Fide-completion%2Fsrc%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Ftests.rs?ref=57c5447f904c1edf45acd35dd9e606c98ef9a35b", "patch": "@@ -214,7 +214,17 @@ pub(crate) fn check_pattern_is_applicable(code: &str, check: impl FnOnce(SyntaxE\n \n pub(crate) fn get_all_items(config: CompletionConfig, code: &str) -> Vec<CompletionItem> {\n     let (db, position) = position(code);\n-    crate::completions(&db, &config, position).map_or_else(Vec::default, Into::into)\n+    let res = crate::completions(&db, &config, position).map_or_else(Vec::default, Into::into);\n+    // validate\n+    res.iter().for_each(|it| {\n+        let sr = it.source_range();\n+        assert!(\n+            sr.contains_inclusive(position.offset),\n+            \"source range {sr:?} does not contain the offset {:?} of the completion request: {it:?}\",\n+            position.offset\n+        );\n+    });\n+    res\n }\n \n #[test]"}]}