{"sha": "ee82d09b6c8516b460432ebe5dd718c3353c3084", "node_id": "MDY6Q29tbWl0NzI0NzEyOmVlODJkMDliNmM4NTE2YjQ2MDQzMmViZTVkZDcxOGMzMzUzYzMwODQ=", "commit": {"author": {"name": "David Wood", "email": "david@davidtw.co", "date": "2019-02-11T11:18:40Z"}, "committer": {"name": "David Wood", "email": "david@davidtw.co", "date": "2019-02-12T18:37:54Z"}, "message": "Check user type annotations for range patterns.\n\nThis commit builds on the fix from #58161 (which fixed miscompilation\ncaused by the introduction of `AscribeUserType` patterns for associated\nconstants) to start checking these patterns are well-formed for ranges\n(previous fix just ignored them so that miscompilation wouldn't occur).", "tree": {"sha": "57b77382b11747341a31ae333de08ad3d68e265c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/57b77382b11747341a31ae333de08ad3d68e265c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ee82d09b6c8516b460432ebe5dd718c3353c3084", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEWwgxPGhT5b/6kagXAXYLT59T8VQFAlxjEoIACgkQAXYLT59T\n8VTTChAAkfzL831NJwOdwBBf0831kH0TNFCMl4eLEl7d4xv1kZwh+T2i/CwNgNFs\n2Kkmg32NW/Xhpu85KrtuNoBpZmE0E8jgP4Ot5AtwYj+NRffPkTqndewlqpNQYwRW\nivAuYKbh0KNYM+g8UPVaIfwZcaPE7KBlGh/tTCjjJAtTIQi+iFQvX/s0QIeSdyKV\nB3A8uax7vNVnnqnGdpt/+s+OEEQX3izADIXPxnFXZ3iZJDQDcVnlxwagPcJvZnSX\nrw/4wHdKgaUj2iMMrJbhBdnPa6PgPef6SbJc3mC2YAcq2Ppm7CjTO/dW3Pk0/K/x\noEnxvXWXGkhimPLVogMSAkw++oPK0Voo4M/dclw0CxeyDyrTDjJd8OtRyziIUzr4\nOz6nYJ0fnHXyWwVZFIS1xRavnglPrFe+5+0iQfVuEoc1Ad/Tf+YF9UXJFrRQT0Ph\nH1FP0sbzp/kBj4uOfAwMQYwDxBMQOq/SJuAC38xLiL2dVtT54gQ65zLmhk/DNDu+\n/T2pYWC8P/K50ZwyQx+jOICMuZVmBt16nHowsYYFk2EiX48Jxs02n6RJWvlNFUhE\nrAkR8p/uK/5yEBJLSwjn9vYO/0+OcCpJo0J6IeNPIj4rPGwiS3Uq4jWD8yonWLmS\nSa43vPqhDG+eSApzjwzHyYyLZoFh+xbpi7dR7LDZG+IZXQNsKyo=\n=zpD/\n-----END PGP SIGNATURE-----", "payload": "tree 57b77382b11747341a31ae333de08ad3d68e265c\nparent 2e08bb1dd2863b94943fdca5a57ff2188e87623f\nauthor David Wood <david@davidtw.co> 1549883920 +0100\ncommitter David Wood <david@davidtw.co> 1549996674 +0100\n\nCheck user type annotations for range patterns.\n\nThis commit builds on the fix from #58161 (which fixed miscompilation\ncaused by the introduction of `AscribeUserType` patterns for associated\nconstants) to start checking these patterns are well-formed for ranges\n(previous fix just ignored them so that miscompilation wouldn't occur).\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ee82d09b6c8516b460432ebe5dd718c3353c3084", "html_url": "https://github.com/rust-lang/rust/commit/ee82d09b6c8516b460432ebe5dd718c3353c3084", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ee82d09b6c8516b460432ebe5dd718c3353c3084/comments", "author": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "committer": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2e08bb1dd2863b94943fdca5a57ff2188e87623f", "url": "https://api.github.com/repos/rust-lang/rust/commits/2e08bb1dd2863b94943fdca5a57ff2188e87623f", "html_url": "https://github.com/rust-lang/rust/commit/2e08bb1dd2863b94943fdca5a57ff2188e87623f"}], "stats": {"total": 261, "additions": 176, "deletions": 85}, "files": [{"sha": "b8c1a1a8c45fd5e81ef303c837ce21ffc64024eb", "filename": "src/librustc_mir/build/matches/mod.rs", "status": "modified", "additions": 11, "deletions": 7, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/ee82d09b6c8516b460432ebe5dd718c3353c3084/src%2Flibrustc_mir%2Fbuild%2Fmatches%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee82d09b6c8516b460432ebe5dd718c3353c3084/src%2Flibrustc_mir%2Fbuild%2Fmatches%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fbuild%2Fmatches%2Fmod.rs?ref=ee82d09b6c8516b460432ebe5dd718c3353c3084", "patch": "@@ -7,7 +7,7 @@ use crate::build::scope::{CachedBlock, DropKind};\n use crate::build::ForGuard::{self, OutsideGuard, RefWithinGuard, ValWithinGuard};\n use crate::build::{BlockAnd, BlockAndExtension, Builder};\n use crate::build::{GuardFrame, GuardFrameLocal, LocalsForNode};\n-use crate::hair::*;\n+use crate::hair::{self, *};\n use rustc::mir::*;\n use rustc::ty::{self, CanonicalUserTypeAnnotation, Ty};\n use rustc::ty::layout::VariantIdx;\n@@ -283,9 +283,11 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n                     },\n                     ..\n                 },\n-                user_ty: pat_ascription_ty,\n-                variance: _,\n-                user_ty_span,\n+                ascription: hair::pattern::Ascription {\n+                    user_ty: pat_ascription_ty,\n+                    variance: _,\n+                    user_ty_span,\n+                },\n             } => {\n                 let place =\n                     self.storage_live_binding(block, var, irrefutable_pat.span, OutsideGuard);\n@@ -560,9 +562,11 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n             }\n             PatternKind::AscribeUserType {\n                 ref subpattern,\n-                ref user_ty,\n-                user_ty_span,\n-                variance: _,\n+                ascription: hair::pattern::Ascription {\n+                    ref user_ty,\n+                    user_ty_span,\n+                    variance: _,\n+                },\n             } => {\n                 // This corresponds to something like\n                 //"}, {"sha": "b8e38e40b63474f479024aa3cc7e650a85c117c7", "filename": "src/librustc_mir/build/matches/simplify.rs", "status": "modified", "additions": 6, "deletions": 4, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/ee82d09b6c8516b460432ebe5dd718c3353c3084/src%2Flibrustc_mir%2Fbuild%2Fmatches%2Fsimplify.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee82d09b6c8516b460432ebe5dd718c3353c3084/src%2Flibrustc_mir%2Fbuild%2Fmatches%2Fsimplify.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fbuild%2Fmatches%2Fsimplify.rs?ref=ee82d09b6c8516b460432ebe5dd718c3353c3084", "patch": "@@ -14,7 +14,7 @@\n \n use crate::build::Builder;\n use crate::build::matches::{Ascription, Binding, MatchPair, Candidate};\n-use crate::hair::*;\n+use crate::hair::{self, *};\n use rustc::ty;\n use rustc::ty::layout::{Integer, IntegerExt, Size};\n use syntax::attr::{SignedInt, UnsignedInt};\n@@ -58,9 +58,11 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n         match *match_pair.pattern.kind {\n             PatternKind::AscribeUserType {\n                 ref subpattern,\n-                variance,\n-                ref user_ty,\n-                user_ty_span\n+                ascription: hair::pattern::Ascription {\n+                    variance,\n+                    ref user_ty,\n+                    user_ty_span,\n+                },\n             } => {\n                 // Apply the type ascription to the value at `match_pair.place`, which is the\n                 // value being matched, taking the variance field into account."}, {"sha": "7c1dbb449c5f74b64226680fdb709055c8ea6358", "filename": "src/librustc_mir/hair/cx/block.rs", "status": "modified", "additions": 6, "deletions": 4, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/ee82d09b6c8516b460432ebe5dd718c3353c3084/src%2Flibrustc_mir%2Fhair%2Fcx%2Fblock.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee82d09b6c8516b460432ebe5dd718c3353c3084/src%2Flibrustc_mir%2Fhair%2Fcx%2Fblock.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fhair%2Fcx%2Fblock.rs?ref=ee82d09b6c8516b460432ebe5dd718c3353c3084", "patch": "@@ -1,4 +1,4 @@\n-use crate::hair::*;\n+use crate::hair::{self, *};\n use crate::hair::cx::Cx;\n use crate::hair::cx::to_ref::ToRef;\n use rustc::middle::region;\n@@ -83,10 +83,12 @@ fn mirror_stmts<'a, 'gcx, 'tcx>(cx: &mut Cx<'a, 'gcx, 'tcx>,\n                             ty: pattern.ty,\n                             span: pattern.span,\n                             kind: Box::new(PatternKind::AscribeUserType {\n-                                user_ty: PatternTypeProjection::from_user_type(user_ty),\n-                                user_ty_span: ty.span,\n+                                ascription: hair::pattern::Ascription {\n+                                    user_ty: PatternTypeProjection::from_user_type(user_ty),\n+                                    user_ty_span: ty.span,\n+                                    variance: ty::Variance::Covariant,\n+                                },\n                                 subpattern: pattern,\n-                                variance: ty::Variance::Covariant,\n                             })\n                         };\n                     }"}, {"sha": "3bdc10bcb06c8d7fbc6258af61c9184ff96c5d57", "filename": "src/librustc_mir/hair/pattern/_match.rs", "status": "modified", "additions": 17, "deletions": 11, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/ee82d09b6c8516b460432ebe5dd718c3353c3084/src%2Flibrustc_mir%2Fhair%2Fpattern%2F_match.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee82d09b6c8516b460432ebe5dd718c3353c3084/src%2Flibrustc_mir%2Fhair%2Fpattern%2F_match.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fhair%2Fpattern%2F_match.rs?ref=ee82d09b6c8516b460432ebe5dd718c3353c3084", "patch": "@@ -871,18 +871,24 @@ impl<'tcx> IntRange<'tcx> {\n     }\n \n     fn from_pat(tcx: TyCtxt<'_, 'tcx, 'tcx>,\n-                pat: &Pattern<'tcx>)\n+                mut pat: &Pattern<'tcx>)\n                 -> Option<IntRange<'tcx>> {\n-        Self::from_ctor(tcx, &match pat.kind {\n-            box PatternKind::Constant { value } => ConstantValue(value),\n-            box PatternKind::Range(PatternRange { lo, hi, ty, end }) => ConstantRange(\n-                lo.to_bits(tcx, ty::ParamEnv::empty().and(ty)).unwrap(),\n-                hi.to_bits(tcx, ty::ParamEnv::empty().and(ty)).unwrap(),\n-                ty,\n-                end,\n-            ),\n-            _ => return None,\n-        })\n+        let range = loop {\n+            match pat.kind {\n+                box PatternKind::Constant { value } => break ConstantValue(value),\n+                box PatternKind::Range(PatternRange { lo, hi, ty, end }) => break ConstantRange(\n+                    lo.to_bits(tcx, ty::ParamEnv::empty().and(ty)).unwrap(),\n+                    hi.to_bits(tcx, ty::ParamEnv::empty().and(ty)).unwrap(),\n+                    ty,\n+                    end,\n+                ),\n+                box PatternKind::AscribeUserType { ref subpattern, .. } => {\n+                    pat = subpattern;\n+                },\n+                _ => return None,\n+            }\n+        };\n+        Self::from_ctor(tcx, &range)\n     }\n \n     // The return value of `signed_bias` should be XORed with an endpoint to encode/decode it."}, {"sha": "84f1d979b481dec57e788a9c32088a1c7abc7d7e", "filename": "src/librustc_mir/hair/pattern/mod.rs", "status": "modified", "additions": 86, "deletions": 59, "changes": 145, "blob_url": "https://github.com/rust-lang/rust/blob/ee82d09b6c8516b460432ebe5dd718c3353c3084/src%2Flibrustc_mir%2Fhair%2Fpattern%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee82d09b6c8516b460432ebe5dd718c3353c3084/src%2Flibrustc_mir%2Fhair%2Fpattern%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fhair%2Fpattern%2Fmod.rs?ref=ee82d09b6c8516b460432ebe5dd718c3353c3084", "patch": "@@ -58,7 +58,7 @@ pub struct Pattern<'tcx> {\n }\n \n \n-#[derive(Clone, Debug)]\n+#[derive(Copy, Clone, Debug, PartialEq)]\n pub struct PatternTypeProjection<'tcx> {\n     pub user_ty: CanonicalUserType<'tcx>,\n }\n@@ -87,33 +87,38 @@ impl<'tcx> PatternTypeProjection<'tcx> {\n     }\n }\n \n+#[derive(Copy, Clone, Debug, PartialEq)]\n+pub struct Ascription<'tcx> {\n+    pub user_ty: PatternTypeProjection<'tcx>,\n+    /// Variance to use when relating the type `user_ty` to the **type of the value being\n+    /// matched**. Typically, this is `Variance::Covariant`, since the value being matched must\n+    /// have a type that is some subtype of the ascribed type.\n+    ///\n+    /// Note that this variance does not apply for any bindings within subpatterns. The type\n+    /// assigned to those bindings must be exactly equal to the `user_ty` given here.\n+    ///\n+    /// The only place where this field is not `Covariant` is when matching constants, where\n+    /// we currently use `Contravariant` -- this is because the constant type just needs to\n+    /// be \"comparable\" to the type of the input value. So, for example:\n+    ///\n+    /// ```text\n+    /// match x { \"foo\" => .. }\n+    /// ```\n+    ///\n+    /// requires that `&'static str <: T_x`, where `T_x` is the type of `x`. Really, we should\n+    /// probably be checking for a `PartialEq` impl instead, but this preserves the behavior\n+    /// of the old type-check for now. See #57280 for details.\n+    pub variance: ty::Variance,\n+    pub user_ty_span: Span,\n+}\n+\n #[derive(Clone, Debug)]\n pub enum PatternKind<'tcx> {\n     Wild,\n \n     AscribeUserType {\n-        user_ty: PatternTypeProjection<'tcx>,\n+        ascription: Ascription<'tcx>,\n         subpattern: Pattern<'tcx>,\n-        /// Variance to use when relating the type `user_ty` to the **type of the value being\n-        /// matched**. Typically, this is `Variance::Covariant`, since the value being matched must\n-        /// have a type that is some subtype of the ascribed type.\n-        ///\n-        /// Note that this variance does not apply for any bindings within subpatterns. The type\n-        /// assigned to those bindings must be exactly equal to the `user_ty` given here.\n-        ///\n-        /// The only place where this field is not `Covariant` is when matching constants, where\n-        /// we currently use `Contravariant` -- this is because the constant type just needs to\n-        /// be \"comparable\" to the type of the input value. So, for example:\n-        ///\n-        /// ```text\n-        /// match x { \"foo\" => .. }\n-        /// ```\n-        ///\n-        /// requires that `&'static str <: T_x`, where `T_x` is the type of `x`. Really, we should\n-        /// probably be checking for a `PartialEq` impl instead, but this preserves the behavior\n-        /// of the old type-check for now. See #57280 for details.\n-        variance: ty::Variance,\n-        user_ty_span: Span,\n     },\n \n     /// x, ref x, x @ P, etc\n@@ -167,18 +172,7 @@ pub enum PatternKind<'tcx> {\n     },\n }\n \n-impl<'tcx> PatternKind<'tcx> {\n-    /// If this is a `PatternKind::AscribeUserType` then return the subpattern kind, otherwise\n-    /// return this pattern kind.\n-    fn with_user_type_ascription_subpattern(self) -> Self {\n-        match self {\n-            PatternKind::AscribeUserType { subpattern: Pattern { box kind, ..  }, ..  } => kind,\n-            kind => kind,\n-        }\n-    }\n-}\n-\n-#[derive(Clone, Copy, Debug, PartialEq)]\n+#[derive(Copy, Clone, Debug, PartialEq)]\n pub struct PatternRange<'tcx> {\n     pub lo: ty::Const<'tcx>,\n     pub hi: ty::Const<'tcx>,\n@@ -405,6 +399,19 @@ impl<'a, 'tcx> PatternContext<'a, 'tcx> {\n             )\n     }\n \n+    fn lower_range_expr(\n+        &mut self,\n+        expr: &'tcx hir::Expr,\n+    ) -> (PatternKind<'tcx>, Option<Ascription<'tcx>>) {\n+        match self.lower_lit(expr) {\n+            PatternKind::AscribeUserType {\n+                ascription: lo_ascription,\n+                subpattern: Pattern { kind: box kind, .. },\n+            } => (kind, Some(lo_ascription)),\n+            kind => (kind, None),\n+        }\n+    }\n+\n     fn lower_pattern_unadjusted(&mut self, pat: &'tcx hir::Pat) -> Pattern<'tcx> {\n         let mut ty = self.tables.node_id_to_type(pat.hir_id);\n \n@@ -414,14 +421,10 @@ impl<'a, 'tcx> PatternContext<'a, 'tcx> {\n             PatKind::Lit(ref value) => self.lower_lit(value),\n \n             PatKind::Range(ref lo_expr, ref hi_expr, end) => {\n-                match (\n-                    // Look for `PatternKind::Constant` patterns inside of any\n-                    // `PatternKind::AscribeUserType` patterns. Type ascriptions can be safely\n-                    // ignored for the purposes of lowering a range correctly - these are checked\n-                    // elsewhere for well-formedness.\n-                    self.lower_lit(lo_expr).with_user_type_ascription_subpattern(),\n-                    self.lower_lit(hi_expr).with_user_type_ascription_subpattern(),\n-                ) {\n+                let (lo, lo_ascription) = self.lower_range_expr(lo_expr);\n+                let (hi, hi_ascription) = self.lower_range_expr(hi_expr);\n+\n+                let mut kind = match (lo, hi) {\n                     (PatternKind::Constant { value: lo }, PatternKind::Constant { value: hi }) => {\n                         use std::cmp::Ordering;\n                         let cmp = compare_const_vals(\n@@ -470,17 +473,33 @@ impl<'a, 'tcx> PatternContext<'a, 'tcx> {\n                                 PatternKind::Wild\n                             }\n                         }\n-                    }\n+                    },\n                     ref pats => {\n                         self.tcx.sess.delay_span_bug(\n                             pat.span,\n-                            &format!(\"found bad range pattern `{:?}` outside of error recovery\",\n-                                     pats),\n+                            &format!(\n+                                \"found bad range pattern `{:?}` outside of error recovery\",\n+                                pats,\n+                            ),\n                         );\n \n                         PatternKind::Wild\n+                    },\n+                };\n+\n+                // If we are handling a range with associated constants (e.g.\n+                // `Foo::<'a>::A..=Foo::B`), we need to put the ascriptions for the associated\n+                // constants somewhere. Have them on the range pattern.\n+                for ascription in &[lo_ascription, hi_ascription] {\n+                    if let Some(ascription) = ascription {\n+                        kind = PatternKind::AscribeUserType {\n+                            ascription: *ascription,\n+                            subpattern: Pattern { span: pat.span, ty, kind: Box::new(kind), },\n+                        };\n                     }\n                 }\n+\n+                kind\n             }\n \n             PatKind::Path(ref qpath) => {\n@@ -756,9 +775,11 @@ impl<'a, 'tcx> PatternContext<'a, 'tcx> {\n                     ty,\n                     kind: Box::new(kind),\n                 },\n-                user_ty: PatternTypeProjection::from_user_type(user_ty),\n-                user_ty_span: span,\n-                variance: ty::Variance::Covariant,\n+                ascription: Ascription {\n+                    user_ty: PatternTypeProjection::from_user_type(user_ty),\n+                    user_ty_span: span,\n+                    variance: ty::Variance::Covariant,\n+                },\n             };\n         }\n \n@@ -808,11 +829,13 @@ impl<'a, 'tcx> PatternContext<'a, 'tcx> {\n                                         kind: Box::new(\n                                             PatternKind::AscribeUserType {\n                                                 subpattern: pattern,\n-                                                /// Note that use `Contravariant` here. See the\n-                                                /// `variance` field documentation for details.\n-                                                variance: ty::Variance::Contravariant,\n-                                                user_ty,\n-                                                user_ty_span: span,\n+                                                ascription: Ascription {\n+                                                    /// Note that use `Contravariant` here. See the\n+                                                    /// `variance` field documentation for details.\n+                                                    variance: ty::Variance::Contravariant,\n+                                                    user_ty,\n+                                                    user_ty_span: span,\n+                                                },\n                                             }\n                                         ),\n                                         ty: value.ty,\n@@ -1105,14 +1128,18 @@ impl<'tcx> PatternFoldable<'tcx> for PatternKind<'tcx> {\n             PatternKind::Wild => PatternKind::Wild,\n             PatternKind::AscribeUserType {\n                 ref subpattern,\n-                variance,\n-                ref user_ty,\n-                user_ty_span,\n+                ascription: Ascription {\n+                    variance,\n+                    ref user_ty,\n+                    user_ty_span,\n+                },\n             } => PatternKind::AscribeUserType {\n                 subpattern: subpattern.fold_with(folder),\n-                user_ty: user_ty.fold_with(folder),\n-                variance,\n-                user_ty_span,\n+                ascription: Ascription {\n+                    user_ty: user_ty.fold_with(folder),\n+                    variance,\n+                    user_ty_span,\n+                },\n             },\n             PatternKind::Binding {\n                 mutability,"}, {"sha": "9267cac5dd3d75c559ee6d3c8beb45ce15259452", "filename": "src/test/ui/nll/issue-58299.rs", "status": "added", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/ee82d09b6c8516b460432ebe5dd718c3353c3084/src%2Ftest%2Fui%2Fnll%2Fissue-58299.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee82d09b6c8516b460432ebe5dd718c3353c3084/src%2Ftest%2Fui%2Fnll%2Fissue-58299.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fnll%2Fissue-58299.rs?ref=ee82d09b6c8516b460432ebe5dd718c3353c3084", "patch": "@@ -0,0 +1,30 @@\n+#![allow(dead_code)]\n+#![feature(nll)]\n+\n+struct A<'a>(&'a ());\n+\n+trait Y {\n+    const X: i32;\n+}\n+\n+impl Y for A<'static> {\n+    const X: i32 = 10;\n+}\n+\n+fn foo<'a>(x: i32) {\n+    match x {\n+        // This uses <A<'a> as Y>::X, but `A<'a>` does not implement `Y`.\n+        A::<'a>::X..=A::<'static>::X => (), //~ ERROR lifetime may not live long enough\n+        _ => (),\n+    }\n+}\n+\n+fn bar<'a>(x: i32) {\n+    match x {\n+        // This uses <A<'a> as Y>::X, but `A<'a>` does not implement `Y`.\n+        A::<'static>::X..=A::<'a>::X => (), //~ ERROR lifetime may not live long enough\n+        _ => (),\n+    }\n+}\n+\n+fn main() {}"}, {"sha": "b87d0de51a37e216ad5a8a2edc7991cdd31a456e", "filename": "src/test/ui/nll/issue-58299.stderr", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/ee82d09b6c8516b460432ebe5dd718c3353c3084/src%2Ftest%2Fui%2Fnll%2Fissue-58299.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/ee82d09b6c8516b460432ebe5dd718c3353c3084/src%2Ftest%2Fui%2Fnll%2Fissue-58299.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fnll%2Fissue-58299.stderr?ref=ee82d09b6c8516b460432ebe5dd718c3353c3084", "patch": "@@ -0,0 +1,20 @@\n+error: lifetime may not live long enough\n+  --> $DIR/issue-58299.rs:17:9\n+   |\n+LL | fn foo<'a>(x: i32) {\n+   |        -- lifetime `'a` defined here\n+...\n+LL |         A::<'a>::X..=A::<'static>::X => (), //~ ERROR lifetime may not live long enough\n+   |         ^^^^^^^^^^ requires that `'a` must outlive `'static`\n+\n+error: lifetime may not live long enough\n+  --> $DIR/issue-58299.rs:25:27\n+   |\n+LL | fn bar<'a>(x: i32) {\n+   |        -- lifetime `'a` defined here\n+...\n+LL |         A::<'static>::X..=A::<'a>::X => (), //~ ERROR lifetime may not live long enough\n+   |                           ^^^^^^^^^^ requires that `'a` must outlive `'static`\n+\n+error: aborting due to 2 previous errors\n+"}]}