{"sha": "e413c2e77072bbf2803dca63bea239c461159831", "node_id": "C_kwDOAAsO6NoAKGU0MTNjMmU3NzA3MmJiZjI4MDNkY2E2M2JlYTIzOWM0NjExNTk4MzE", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-04-13T19:58:37Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-04-13T19:58:37Z"}, "message": "Rollup merge of #110259 - ndrewxie:issue-109964-fix-gitstuff, r=cjgillot\n\nAdded diagnostic for pin! macro in addition to Box::pin if Unpin isn't implemented\n\nI made a PR earlier, but accidentally renamed a branch and that deleted the PR... sorry for the duplicate\n\nCurrently, if an operation on `Pin<T>` is performed that requires `T` to implement `Unpin`, the diagnostic suggestion is to use `Box::pin` (\"note: consider using `Box::pin`\").\n\nThis PR suggests pin! as well, as that's another valid way of pinning a value, and avoids a heap allocation. Appropriate diagnostic suggestions were included to highlight the difference in semantics (local pinning for pin! vs non-local for Box::pin).\n\nFixes #109964", "tree": {"sha": "f93d4e6b322601f8b9cb0246e3f0ae4b401639b8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f93d4e6b322601f8b9cb0246e3f0ae4b401639b8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e413c2e77072bbf2803dca63bea239c461159831", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkOF7tCRBK7hj4Ov3rIwAAQgQIAFM5010IPCJRi998j+lYNqGn\nyfs4R0DCwMSytfMalipR4lbnjk5F51yYUifAGrwcs6Q2EXJzEhdMEpy0XUzuOByQ\nP6HXx7p63a724OPu0ycsWB0NlszZD5YX7UPo+RlguVipni9T6Yu6gVkuGnY2iQ1Z\nkfeIw8ntUyAZKMGzKZ5nk8xIMB7kZJ8vnFhX1M4+flCcKP8SoDxZHXks2q8BWqjD\nZRdSJmC7NcJj+SxKbfcskqMoE+k1VA34u7L3A9aT7RbNL+5qIjaYkvTm158eAgNr\nCW1p76Rj2EQ6bX2EOT8eXEp/amo/1M73oXRKQfmopXyPnmbq2JT22luHTWefV7g=\n=+TK7\n-----END PGP SIGNATURE-----\n", "payload": "tree f93d4e6b322601f8b9cb0246e3f0ae4b401639b8\nparent e85ecbbcdcc577d47baae3c0c537c82056340ac9\nparent 9e0e4c31aa88e5d510fdd0742808ec95329470e4\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1681415917 +0200\ncommitter GitHub <noreply@github.com> 1681415917 +0200\n\nRollup merge of #110259 - ndrewxie:issue-109964-fix-gitstuff, r=cjgillot\n\nAdded diagnostic for pin! macro in addition to Box::pin if Unpin isn't implemented\n\nI made a PR earlier, but accidentally renamed a branch and that deleted the PR... sorry for the duplicate\n\nCurrently, if an operation on `Pin<T>` is performed that requires `T` to implement `Unpin`, the diagnostic suggestion is to use `Box::pin` (\"note: consider using `Box::pin`\").\n\nThis PR suggests pin! as well, as that's another valid way of pinning a value, and avoids a heap allocation. Appropriate diagnostic suggestions were included to highlight the difference in semantics (local pinning for pin! vs non-local for Box::pin).\n\nFixes #109964\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e413c2e77072bbf2803dca63bea239c461159831", "html_url": "https://github.com/rust-lang/rust/commit/e413c2e77072bbf2803dca63bea239c461159831", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e413c2e77072bbf2803dca63bea239c461159831/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e85ecbbcdcc577d47baae3c0c537c82056340ac9", "url": "https://api.github.com/repos/rust-lang/rust/commits/e85ecbbcdcc577d47baae3c0c537c82056340ac9", "html_url": "https://github.com/rust-lang/rust/commit/e85ecbbcdcc577d47baae3c0c537c82056340ac9"}, {"sha": "9e0e4c31aa88e5d510fdd0742808ec95329470e4", "url": "https://api.github.com/repos/rust-lang/rust/commits/9e0e4c31aa88e5d510fdd0742808ec95329470e4", "html_url": "https://github.com/rust-lang/rust/commit/9e0e4c31aa88e5d510fdd0742808ec95329470e4"}], "stats": {"total": 62, "additions": 55, "deletions": 7}, "files": [{"sha": "3cd4f5104ce71ce5bdbdfedbe2b158d4410b2bbf", "filename": "library/core/src/marker.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e413c2e77072bbf2803dca63bea239c461159831/library%2Fcore%2Fsrc%2Fmarker.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e413c2e77072bbf2803dca63bea239c461159831/library%2Fcore%2Fsrc%2Fmarker.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fmarker.rs?ref=e413c2e77072bbf2803dca63bea239c461159831", "patch": "@@ -823,7 +823,7 @@ unsafe impl<T: ?Sized> Freeze for &mut T {}\n /// [`pin` module]: crate::pin\n #[stable(feature = \"pin\", since = \"1.33.0\")]\n #[rustc_on_unimplemented(\n-    note = \"consider using `Box::pin`\",\n+    note = \"consider using the `pin!` macro\\nconsider using `Box::pin` if you need to access the pinned value outside of the current scope\",\n     message = \"`{Self}` cannot be unpinned\"\n )]\n #[lang = \"unpin\"]"}, {"sha": "61126faf899261e731d3328a3492e731d7ce4e6a", "filename": "tests/ui/async-await/pin-needed-to-poll-2.stderr", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/e413c2e77072bbf2803dca63bea239c461159831/tests%2Fui%2Fasync-await%2Fpin-needed-to-poll-2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e413c2e77072bbf2803dca63bea239c461159831/tests%2Fui%2Fasync-await%2Fpin-needed-to-poll-2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fasync-await%2Fpin-needed-to-poll-2.stderr?ref=e413c2e77072bbf2803dca63bea239c461159831", "patch": "@@ -6,7 +6,8 @@ LL |         Pin::new(&mut self.sleep).poll(cx)\n    |         |\n    |         required by a bound introduced by this call\n    |\n-   = note: consider using `Box::pin`\n+   = note: consider using the `pin!` macro\n+           consider using `Box::pin` if you need to access the pinned value outside of the current scope\n note: required because it appears within the type `Sleep`\n   --> $DIR/pin-needed-to-poll-2.rs:8:8\n    |"}, {"sha": "7376116b3380a1e025a82245d09dff9082658a42", "filename": "tests/ui/generator/static-not-unpin.stderr", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/e413c2e77072bbf2803dca63bea239c461159831/tests%2Fui%2Fgenerator%2Fstatic-not-unpin.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e413c2e77072bbf2803dca63bea239c461159831/tests%2Fui%2Fgenerator%2Fstatic-not-unpin.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fgenerator%2Fstatic-not-unpin.stderr?ref=e413c2e77072bbf2803dca63bea239c461159831", "patch": "@@ -6,7 +6,8 @@ LL |     assert_unpin(generator);\n    |     |\n    |     required by a bound introduced by this call\n    |\n-   = note: consider using `Box::pin`\n+   = note: consider using the `pin!` macro\n+           consider using `Box::pin` if you need to access the pinned value outside of the current scope\n note: required by a bound in `assert_unpin`\n   --> $DIR/static-not-unpin.rs:7:20\n    |"}, {"sha": "0232d4c8db694b8b32a1a6b9ca2d65ba5a497405", "filename": "tests/ui/suggestions/expected-boxed-future-isnt-pinned.stderr", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/e413c2e77072bbf2803dca63bea239c461159831/tests%2Fui%2Fsuggestions%2Fexpected-boxed-future-isnt-pinned.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e413c2e77072bbf2803dca63bea239c461159831/tests%2Fui%2Fsuggestions%2Fexpected-boxed-future-isnt-pinned.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fsuggestions%2Fexpected-boxed-future-isnt-pinned.stderr?ref=e413c2e77072bbf2803dca63bea239c461159831", "patch": "@@ -50,7 +50,8 @@ LL |     Pin::new(x)\n    |     |\n    |     required by a bound introduced by this call\n    |\n-   = note: consider using `Box::pin`\n+   = note: consider using the `pin!` macro\n+           consider using `Box::pin` if you need to access the pinned value outside of the current scope\n note: required by a bound in `Pin::<P>::new`\n   --> $SRC_DIR/core/src/pin.rs:LL:COL\n \n@@ -62,7 +63,8 @@ LL |     Pin::new(Box::new(x))\n    |     |\n    |     required by a bound introduced by this call\n    |\n-   = note: consider using `Box::pin`\n+   = note: consider using the `pin!` macro\n+           consider using `Box::pin` if you need to access the pinned value outside of the current scope\n note: required by a bound in `Pin::<P>::new`\n   --> $SRC_DIR/core/src/pin.rs:LL:COL\n "}, {"sha": "4de9da89c9bc67d90dce692008270ad2a4e11ebe", "filename": "tests/ui/suggestions/issue-84973-blacklist.stderr", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/e413c2e77072bbf2803dca63bea239c461159831/tests%2Fui%2Fsuggestions%2Fissue-84973-blacklist.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e413c2e77072bbf2803dca63bea239c461159831/tests%2Fui%2Fsuggestions%2Fissue-84973-blacklist.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fsuggestions%2Fissue-84973-blacklist.stderr?ref=e413c2e77072bbf2803dca63bea239c461159831", "patch": "@@ -39,7 +39,8 @@ LL |     f_unpin(static || { yield; });\n    |     |\n    |     required by a bound introduced by this call\n    |\n-   = note: consider using `Box::pin`\n+   = note: consider using the `pin!` macro\n+           consider using `Box::pin` if you need to access the pinned value outside of the current scope\n note: required by a bound in `f_unpin`\n   --> $DIR/issue-84973-blacklist.rs:8:15\n    |"}, {"sha": "f5b96215925b71d95eb2a20d264a5f0219bbefa3", "filename": "tests/ui/suggestions/suggest-pin-macro.rs", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/e413c2e77072bbf2803dca63bea239c461159831/tests%2Fui%2Fsuggestions%2Fsuggest-pin-macro.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e413c2e77072bbf2803dca63bea239c461159831/tests%2Fui%2Fsuggestions%2Fsuggest-pin-macro.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fsuggestions%2Fsuggest-pin-macro.rs?ref=e413c2e77072bbf2803dca63bea239c461159831", "patch": "@@ -0,0 +1,23 @@\n+use std::pin::Pin;\n+use std::marker::PhantomPinned;\n+\n+#[derive(Debug)]\n+struct Test {\n+    _marker: PhantomPinned,\n+}\n+impl Test {\n+    fn new() -> Self {\n+        Test {\n+            _marker: PhantomPinned, // This makes our type `!Unpin`\n+        }\n+    }\n+}\n+\n+fn dummy(_: &mut Test) {}\n+\n+pub fn main() {\n+    let mut test1 = Test::new();\n+    let mut test1 = unsafe { Pin::new_unchecked(&mut test1) };\n+\n+    dummy(test1.get_mut()); //~ ERROR E0277\n+}"}, {"sha": "1220cf650cc3e585e5bd6c6b189b62ab3c2f9506", "filename": "tests/ui/suggestions/suggest-pin-macro.stderr", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/e413c2e77072bbf2803dca63bea239c461159831/tests%2Fui%2Fsuggestions%2Fsuggest-pin-macro.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e413c2e77072bbf2803dca63bea239c461159831/tests%2Fui%2Fsuggestions%2Fsuggest-pin-macro.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fsuggestions%2Fsuggest-pin-macro.stderr?ref=e413c2e77072bbf2803dca63bea239c461159831", "patch": "@@ -0,0 +1,19 @@\n+error[E0277]: `PhantomPinned` cannot be unpinned\n+  --> $DIR/suggest-pin-macro.rs:22:17\n+   |\n+LL |     dummy(test1.get_mut());\n+   |                 ^^^^^^^ within `Test`, the trait `Unpin` is not implemented for `PhantomPinned`\n+   |\n+   = note: consider using the `pin!` macro\n+           consider using `Box::pin` if you need to access the pinned value outside of the current scope\n+note: required because it appears within the type `Test`\n+  --> $DIR/suggest-pin-macro.rs:5:8\n+   |\n+LL | struct Test {\n+   |        ^^^^\n+note: required by a bound in `Pin::<&'a mut T>::get_mut`\n+  --> $SRC_DIR/core/src/pin.rs:LL:COL\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0277`."}, {"sha": "8586f522291b7af93f75a4064de7b3fca124e514", "filename": "tests/ui/typeck/issue-90164.stderr", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/e413c2e77072bbf2803dca63bea239c461159831/tests%2Fui%2Ftypeck%2Fissue-90164.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e413c2e77072bbf2803dca63bea239c461159831/tests%2Fui%2Ftypeck%2Fissue-90164.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ftypeck%2Fissue-90164.stderr?ref=e413c2e77072bbf2803dca63bea239c461159831", "patch": "@@ -6,7 +6,8 @@ LL |     copy(r, w);\n    |     |\n    |     required by a bound introduced by this call\n    |\n-   = note: consider using `Box::pin`\n+   = note: consider using the `pin!` macro\n+           consider using `Box::pin` if you need to access the pinned value outside of the current scope\n note: required by a bound in `copy`\n   --> $DIR/issue-90164.rs:1:12\n    |"}]}