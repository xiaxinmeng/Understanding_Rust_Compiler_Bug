{"sha": "aa9adf457b85a4c75f3b0f791338395b1bd367e5", "node_id": "C_kwDOAAsO6NoAKGFhOWFkZjQ1N2I4NWE0Yzc1ZjNiMGY3OTEzMzgzOTViMWJkMzY3ZTU", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-05-11T05:05:27Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-05-11T05:05:27Z"}, "message": "Rollup merge of #111292 - Urgau:check-cfg-issue-111291, r=petrochenkov\n\nFix mishandled `--check-cfg` arguments order\n\nThis PR fixes a bug in `--check-cfg` where the order of `--check-cfg=names(a)` and `--check-cfg=values(a,\u2026)` would trip the compiler.\n\nFixes https://github.com/rust-lang/rust/issues/111291\ncc `@taiki-e` `@petrochenkov`", "tree": {"sha": "d0022f6b82b7ed60465acb7ff790b8a9ce45994a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d0022f6b82b7ed60465acb7ff790b8a9ce45994a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/aa9adf457b85a4c75f3b0f791338395b1bd367e5", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkXHeXCRBK7hj4Ov3rIwAAgMMIADh3ai7uSPB11Fj7urFqmpwC\nnTz1xlYW59mTnANjiYjNGIg/6QXeJlg99BTLCwEE0xUyB/N2LAFeXqlYH5xEZURL\niIT3Z9Wgm/9D+xb2L4eWiINwqte97rmE858orDPS/IxOmfZLN/fgOzUvJwg1skzz\nSM2DePIOJZERKoTvCxem4UsygwHPqHf2SVwlO9YPt+NroXc8kcujePJeqeHQUKFS\nHXwsXF67uaTnuE0Q1EEdofKuyg910cW9n+WkhS+RQpDfwRqSGCa2/HHUrVyKapI2\nye5roFRA8dnJV7qWnD20bMqGyhmulIMmkT5ocgQ3q/ah4J+IqXkAsYGZmgYt/JQ=\n=si7o\n-----END PGP SIGNATURE-----\n", "payload": "tree d0022f6b82b7ed60465acb7ff790b8a9ce45994a\nparent 40d933a19a9dd6718bbe59fd473372cde9515a3a\nparent f4ca42f573e3a8bd9bb5099efa0285855b77367f\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1683781527 +0200\ncommitter GitHub <noreply@github.com> 1683781527 +0200\n\nRollup merge of #111292 - Urgau:check-cfg-issue-111291, r=petrochenkov\n\nFix mishandled `--check-cfg` arguments order\n\nThis PR fixes a bug in `--check-cfg` where the order of `--check-cfg=names(a)` and `--check-cfg=values(a,\u2026)` would trip the compiler.\n\nFixes https://github.com/rust-lang/rust/issues/111291\ncc `@taiki-e` `@petrochenkov`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/aa9adf457b85a4c75f3b0f791338395b1bd367e5", "html_url": "https://github.com/rust-lang/rust/commit/aa9adf457b85a4c75f3b0f791338395b1bd367e5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/aa9adf457b85a4c75f3b0f791338395b1bd367e5/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "40d933a19a9dd6718bbe59fd473372cde9515a3a", "url": "https://api.github.com/repos/rust-lang/rust/commits/40d933a19a9dd6718bbe59fd473372cde9515a3a", "html_url": "https://github.com/rust-lang/rust/commit/40d933a19a9dd6718bbe59fd473372cde9515a3a"}, {"sha": "f4ca42f573e3a8bd9bb5099efa0285855b77367f", "url": "https://api.github.com/repos/rust-lang/rust/commits/f4ca42f573e3a8bd9bb5099efa0285855b77367f", "html_url": "https://github.com/rust-lang/rust/commit/f4ca42f573e3a8bd9bb5099efa0285855b77367f"}], "stats": {"total": 65, "additions": 64, "deletions": 1}, "files": [{"sha": "51354c2b127990f8329aa21a20d1712b5c843fe6", "filename": "compiler/rustc_interface/src/interface.rs", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/aa9adf457b85a4c75f3b0f791338395b1bd367e5/compiler%2Frustc_interface%2Fsrc%2Finterface.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa9adf457b85a4c75f3b0f791338395b1bd367e5/compiler%2Frustc_interface%2Fsrc%2Finterface.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2Fsrc%2Finterface.rs?ref=aa9adf457b85a4c75f3b0f791338395b1bd367e5", "patch": "@@ -173,12 +173,21 @@ pub fn parse_check_cfg(specs: Vec<String>) -> CheckCfg {\n                                         let expected_values = check_cfg\n                                             .expecteds\n                                             .entry(ident.name.to_string())\n+                                            .and_modify(|expected_values| match expected_values {\n+                                                ExpectedValues::Some(_) => {}\n+                                                ExpectedValues::Any => {\n+                                                    // handle the case where names(...) was done\n+                                                    // before values by changing to a list\n+                                                    *expected_values =\n+                                                        ExpectedValues::Some(FxHashSet::default());\n+                                                }\n+                                            })\n                                             .or_insert_with(|| {\n                                                 ExpectedValues::Some(FxHashSet::default())\n                                             });\n \n                                         let ExpectedValues::Some(expected_values) = expected_values else {\n-                                            bug!(\"shoudn't be possible\")\n+                                            bug!(\"`expected_values` should be a list a values\")\n                                         };\n \n                                         for val in values {"}, {"sha": "91b81428b38a4d4785c2a14382067c9029cd94c2", "filename": "tests/ui/check-cfg/order-independant.names_after.stderr", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/aa9adf457b85a4c75f3b0f791338395b1bd367e5/tests%2Fui%2Fcheck-cfg%2Forder-independant.names_after.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/aa9adf457b85a4c75f3b0f791338395b1bd367e5/tests%2Fui%2Fcheck-cfg%2Forder-independant.names_after.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcheck-cfg%2Forder-independant.names_after.stderr?ref=aa9adf457b85a4c75f3b0f791338395b1bd367e5", "patch": "@@ -0,0 +1,19 @@\n+warning: unexpected `cfg` condition value\n+  --> $DIR/order-independant.rs:8:7\n+   |\n+LL | #[cfg(a)]\n+   |       ^- help: specify a config value: `= \"b\"`\n+   |\n+   = note: expected values for `a` are: `b`\n+   = note: `#[warn(unexpected_cfgs)]` on by default\n+\n+warning: unexpected `cfg` condition value\n+  --> $DIR/order-independant.rs:12:7\n+   |\n+LL | #[cfg(a = \"unk\")]\n+   |       ^^^^^^^^^\n+   |\n+   = note: expected values for `a` are: `b`\n+\n+warning: 2 warnings emitted\n+"}, {"sha": "91b81428b38a4d4785c2a14382067c9029cd94c2", "filename": "tests/ui/check-cfg/order-independant.names_before.stderr", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/aa9adf457b85a4c75f3b0f791338395b1bd367e5/tests%2Fui%2Fcheck-cfg%2Forder-independant.names_before.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/aa9adf457b85a4c75f3b0f791338395b1bd367e5/tests%2Fui%2Fcheck-cfg%2Forder-independant.names_before.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcheck-cfg%2Forder-independant.names_before.stderr?ref=aa9adf457b85a4c75f3b0f791338395b1bd367e5", "patch": "@@ -0,0 +1,19 @@\n+warning: unexpected `cfg` condition value\n+  --> $DIR/order-independant.rs:8:7\n+   |\n+LL | #[cfg(a)]\n+   |       ^- help: specify a config value: `= \"b\"`\n+   |\n+   = note: expected values for `a` are: `b`\n+   = note: `#[warn(unexpected_cfgs)]` on by default\n+\n+warning: unexpected `cfg` condition value\n+  --> $DIR/order-independant.rs:12:7\n+   |\n+LL | #[cfg(a = \"unk\")]\n+   |       ^^^^^^^^^\n+   |\n+   = note: expected values for `a` are: `b`\n+\n+warning: 2 warnings emitted\n+"}, {"sha": "ce056b8dcd6f858c7159488ed47d4bc46399f41d", "filename": "tests/ui/check-cfg/order-independant.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/aa9adf457b85a4c75f3b0f791338395b1bd367e5/tests%2Fui%2Fcheck-cfg%2Forder-independant.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa9adf457b85a4c75f3b0f791338395b1bd367e5/tests%2Fui%2Fcheck-cfg%2Forder-independant.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcheck-cfg%2Forder-independant.rs?ref=aa9adf457b85a4c75f3b0f791338395b1bd367e5", "patch": "@@ -0,0 +1,16 @@\n+// check-pass\n+// revisions: names_before names_after\n+// compile-flags: -Z unstable-options\n+// compile-flags: --check-cfg=names(names_before,names_after)\n+// [names_before]compile-flags: --check-cfg=names(a) --check-cfg=values(a,\"b\")\n+// [names_after]compile-flags: --check-cfg=values(a,\"b\") --check-cfg=names(a)\n+\n+#[cfg(a)]\n+//~^ WARNING unexpected `cfg` condition value\n+fn my_cfg() {}\n+\n+#[cfg(a = \"unk\")]\n+//~^ WARNING unexpected `cfg` condition value\n+fn my_cfg() {}\n+\n+fn main() {}"}]}