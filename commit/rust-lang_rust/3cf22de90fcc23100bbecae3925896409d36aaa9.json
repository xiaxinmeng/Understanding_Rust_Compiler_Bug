{"sha": "3cf22de90fcc23100bbecae3925896409d36aaa9", "node_id": "C_kwDOAAsO6NoAKDNjZjIyZGU5MGZjYzIzMTAwYmJlY2FlMzkyNTg5NjQwOWQzNmFhYTk", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-12-17T23:20:16Z"}, "committer": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-12-27T17:14:45Z"}, "message": "Suggest rewriting a malformed hex literal if we expect a float", "tree": {"sha": "45d8d893bbc3e5bed389f6ffc403073b427f5b78", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/45d8d893bbc3e5bed389f6ffc403073b427f5b78"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3cf22de90fcc23100bbecae3925896409d36aaa9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3cf22de90fcc23100bbecae3925896409d36aaa9", "html_url": "https://github.com/rust-lang/rust/commit/3cf22de90fcc23100bbecae3925896409d36aaa9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3cf22de90fcc23100bbecae3925896409d36aaa9/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b38a6d373cb254697411147c0e49cd2e84864258", "url": "https://api.github.com/repos/rust-lang/rust/commits/b38a6d373cb254697411147c0e49cd2e84864258", "html_url": "https://github.com/rust-lang/rust/commit/b38a6d373cb254697411147c0e49cd2e84864258"}], "stats": {"total": 87, "additions": 87, "deletions": 0}, "files": [{"sha": "e38d1bccc10657199fcc4ff2515c2136867a19d2", "filename": "compiler/rustc_hir_typeck/src/fn_ctxt/suggestions.rs", "status": "modified", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/3cf22de90fcc23100bbecae3925896409d36aaa9/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2Fsuggestions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3cf22de90fcc23100bbecae3925896409d36aaa9/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2Fsuggestions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2Fsuggestions.rs?ref=3cf22de90fcc23100bbecae3925896409d36aaa9", "patch": "@@ -19,6 +19,7 @@ use rustc_middle::ty::{\n     TypeVisitable,\n };\n use rustc_session::errors::ExprParenthesesNeeded;\n+use rustc_span::source_map::Spanned;\n use rustc_span::symbol::{sym, Ident};\n use rustc_span::{Span, Symbol};\n use rustc_trait_selection::infer::InferCtxtExt;\n@@ -1259,6 +1260,31 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                 );\n                 true\n             }\n+            ExprKind::Lit(Spanned {\n+                node: rustc_ast::LitKind::Int(lit, rustc_ast::LitIntType::Unsuffixed),\n+                span,\n+            }) => {\n+                let Ok(snippet) = self.tcx.sess.source_map().span_to_snippet(span) else { return false; };\n+                if !(snippet.starts_with(\"0x\") || snippet.starts_with(\"0X\")) {\n+                    return false;\n+                }\n+                if snippet.len() <= 5 || !snippet.is_char_boundary(snippet.len() - 3) {\n+                    return false;\n+                }\n+                let (_, suffix) = snippet.split_at(snippet.len() - 3);\n+                let value = match suffix {\n+                    \"f32\" => (lit - 0xf32) / (16 * 16 * 16),\n+                    \"f64\" => (lit - 0xf64) / (16 * 16 * 16),\n+                    _ => return false,\n+                };\n+                err.span_suggestions(\n+                    expr.span,\n+                    \"rewrite this as a decimal floating point literal, or use `as` to turn a hex literal into a float\",\n+                    [format!(\"0x{value:X} as {suffix}\"), format!(\"{value}_{suffix}\")],\n+                    Applicability::MaybeIncorrect,\n+                );\n+                true\n+            }\n             _ => false,\n         }\n     }"}, {"sha": "cd6fdbde96c0c2d5519485a7d1dba7f7fc35457f", "filename": "src/test/ui/suggestions/bad-hex-float-lit.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/3cf22de90fcc23100bbecae3925896409d36aaa9/src%2Ftest%2Fui%2Fsuggestions%2Fbad-hex-float-lit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3cf22de90fcc23100bbecae3925896409d36aaa9/src%2Ftest%2Fui%2Fsuggestions%2Fbad-hex-float-lit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggestions%2Fbad-hex-float-lit.rs?ref=3cf22de90fcc23100bbecae3925896409d36aaa9", "patch": "@@ -0,0 +1,13 @@\n+fn main() {\n+    let _f: f32 = 0xAAf32;\n+    //~^ ERROR mismatched types\n+    //~| HELP rewrite this\n+\n+    let _f: f32 = 0xAB_f32;\n+    //~^ ERROR mismatched types\n+    //~| HELP rewrite this\n+\n+    let _f: f64 = 0xFF_f64;\n+    //~^ ERROR mismatched types\n+    //~| HELP rewrite this\n+}"}, {"sha": "bc09abb1a5671732978059f89b91e7fdf2c93d03", "filename": "src/test/ui/suggestions/bad-hex-float-lit.stderr", "status": "added", "additions": 48, "deletions": 0, "changes": 48, "blob_url": "https://github.com/rust-lang/rust/blob/3cf22de90fcc23100bbecae3925896409d36aaa9/src%2Ftest%2Fui%2Fsuggestions%2Fbad-hex-float-lit.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/3cf22de90fcc23100bbecae3925896409d36aaa9/src%2Ftest%2Fui%2Fsuggestions%2Fbad-hex-float-lit.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggestions%2Fbad-hex-float-lit.stderr?ref=3cf22de90fcc23100bbecae3925896409d36aaa9", "patch": "@@ -0,0 +1,48 @@\n+error[E0308]: mismatched types\n+  --> $DIR/bad-hex-float-lit.rs:2:19\n+   |\n+LL |     let _f: f32 = 0xAAf32;\n+   |             ---   ^^^^^^^ expected `f32`, found integer\n+   |             |\n+   |             expected due to this\n+   |\n+help: rewrite this as a decimal floating point literal, or use `as` to turn a hex literal into a float\n+   |\n+LL |     let _f: f32 = 0xAA as f32;\n+   |                   ~~~~~~~~~~~\n+LL |     let _f: f32 = 170_f32;\n+   |                   ~~~~~~~\n+\n+error[E0308]: mismatched types\n+  --> $DIR/bad-hex-float-lit.rs:6:19\n+   |\n+LL |     let _f: f32 = 0xAB_f32;\n+   |             ---   ^^^^^^^^ expected `f32`, found integer\n+   |             |\n+   |             expected due to this\n+   |\n+help: rewrite this as a decimal floating point literal, or use `as` to turn a hex literal into a float\n+   |\n+LL |     let _f: f32 = 0xAB as f32;\n+   |                   ~~~~~~~~~~~\n+LL |     let _f: f32 = 171_f32;\n+   |                   ~~~~~~~\n+\n+error[E0308]: mismatched types\n+  --> $DIR/bad-hex-float-lit.rs:10:19\n+   |\n+LL |     let _f: f64 = 0xFF_f64;\n+   |             ---   ^^^^^^^^ expected `f64`, found integer\n+   |             |\n+   |             expected due to this\n+   |\n+help: rewrite this as a decimal floating point literal, or use `as` to turn a hex literal into a float\n+   |\n+LL |     let _f: f64 = 0xFF as f64;\n+   |                   ~~~~~~~~~~~\n+LL |     let _f: f64 = 255_f64;\n+   |                   ~~~~~~~\n+\n+error: aborting due to 3 previous errors\n+\n+For more information about this error, try `rustc --explain E0308`."}]}