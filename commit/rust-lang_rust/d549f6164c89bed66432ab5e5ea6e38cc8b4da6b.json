{"sha": "d549f6164c89bed66432ab5e5ea6e38cc8b4da6b", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ1NDlmNjE2NGM4OWJlZDY2NDMyYWI1ZTVlYTZlMzhjYzhiNGRhNmI=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2020-07-30T15:10:44Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2020-07-30T15:10:44Z"}, "message": "Simplify codegen", "tree": {"sha": "2d9a5573f667fd15d27cffc471d98612a7343d1e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2d9a5573f667fd15d27cffc471d98612a7343d1e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d549f6164c89bed66432ab5e5ea6e38cc8b4da6b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d549f6164c89bed66432ab5e5ea6e38cc8b4da6b", "html_url": "https://github.com/rust-lang/rust/commit/d549f6164c89bed66432ab5e5ea6e38cc8b4da6b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d549f6164c89bed66432ab5e5ea6e38cc8b4da6b/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a257fd06b36d2e7310e5e38823f6636343a37331", "url": "https://api.github.com/repos/rust-lang/rust/commits/a257fd06b36d2e7310e5e38823f6636343a37331", "html_url": "https://github.com/rust-lang/rust/commit/a257fd06b36d2e7310e5e38823f6636343a37331"}], "stats": {"total": 51, "additions": 25, "deletions": 26}, "files": [{"sha": "0e3d89a07d8758d042d40ddecf915f0347b97678", "filename": "xtask/src/ast_src.rs", "status": "modified", "additions": 4, "deletions": 5, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/d549f6164c89bed66432ab5e5ea6e38cc8b4da6b/xtask%2Fsrc%2Fast_src.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d549f6164c89bed66432ab5e5ea6e38cc8b4da6b/xtask%2Fsrc%2Fast_src.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/xtask%2Fsrc%2Fast_src.rs?ref=d549f6164c89bed66432ab5e5ea6e38cc8b4da6b", "patch": "@@ -242,14 +242,13 @@ pub(crate) struct AstNodeSrc {\n #[derive(Debug, Eq, PartialEq)]\n pub(crate) enum Field {\n     Token(String),\n-    Node { name: String, src: FieldSrc },\n+    Node { name: String, ty: String, valence: Valence },\n }\n \n #[derive(Debug, Eq, PartialEq)]\n-pub(crate) enum FieldSrc {\n-    Shorthand,\n-    Optional(String),\n-    Many(String),\n+pub(crate) enum Valence {\n+    Optional,\n+    Many,\n }\n \n #[derive(Debug)]"}, {"sha": "b435d8a9c0ede011643959dad7ca28befbe291cd", "filename": "xtask/src/codegen/gen_syntax.rs", "status": "modified", "additions": 21, "deletions": 21, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/d549f6164c89bed66432ab5e5ea6e38cc8b4da6b/xtask%2Fsrc%2Fcodegen%2Fgen_syntax.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d549f6164c89bed66432ab5e5ea6e38cc8b4da6b/xtask%2Fsrc%2Fcodegen%2Fgen_syntax.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/xtask%2Fsrc%2Fcodegen%2Fgen_syntax.rs?ref=d549f6164c89bed66432ab5e5ea6e38cc8b4da6b", "patch": "@@ -13,7 +13,7 @@ use quote::{format_ident, quote};\n use ungrammar::{Grammar, Rule};\n \n use crate::{\n-    ast_src::{AstEnumSrc, AstNodeSrc, AstSrc, Field, FieldSrc, KindsSrc, KINDS_SRC},\n+    ast_src::{AstEnumSrc, AstNodeSrc, AstSrc, Field, KindsSrc, Valence, KINDS_SRC},\n     codegen::{self, update, Mode},\n     project_root, Result,\n };\n@@ -431,7 +431,7 @@ fn pluralize(s: &str) -> String {\n \n impl Field {\n     fn is_many(&self) -> bool {\n-        matches!(self, Field::Node { src: FieldSrc::Many(_), .. })\n+        matches!(self, Field::Node { valence: Valence::Many, .. })\n     }\n     fn token_kind(&self) -> Option<proc_macro2::TokenStream> {\n         match self {\n@@ -476,19 +476,13 @@ impl Field {\n                 };\n                 format_ident!(\"{}_token\", name)\n             }\n-            Field::Node { name, src } => match src {\n-                FieldSrc::Shorthand => format_ident!(\"{}\", to_lower_snake_case(name)),\n-                _ => format_ident!(\"{}\", name),\n-            },\n+            Field::Node { name, .. } => format_ident!(\"{}\", name),\n         }\n     }\n     fn ty(&self) -> proc_macro2::Ident {\n         match self {\n             Field::Token(_) => format_ident!(\"SyntaxToken\"),\n-            Field::Node { name, src } => match src {\n-                FieldSrc::Optional(ty) | FieldSrc::Many(ty) => format_ident!(\"{}\", ty),\n-                FieldSrc::Shorthand => format_ident!(\"{}\", name),\n-            },\n+            Field::Node { ty, .. } => format_ident!(\"{}\", ty),\n         }\n     }\n }\n@@ -550,7 +544,9 @@ fn lower_rule(acc: &mut Vec<Field>, grammar: &Grammar, rule: &Rule) {\n \n     match rule {\n         Rule::Node(node) => {\n-            let field = Field::Node { name: grammar[*node].name.clone(), src: FieldSrc::Shorthand };\n+            let ty = grammar[*node].name.clone();\n+            let name = to_lower_snake_case(&ty);\n+            let field = Field::Node { name, ty, valence: Valence::Optional };\n             acc.push(field);\n         }\n         Rule::Token(token) => {\n@@ -565,9 +561,9 @@ fn lower_rule(acc: &mut Vec<Field>, grammar: &Grammar, rule: &Rule) {\n         }\n         Rule::Rep(inner) => {\n             if let Rule::Node(node) = &**inner {\n-                let name = grammar[*node].name.clone();\n-                let label = pluralize(&to_lower_snake_case(&name));\n-                let field = Field::Node { name: label.clone(), src: FieldSrc::Many(name) };\n+                let ty = grammar[*node].name.clone();\n+                let name = pluralize(&to_lower_snake_case(&ty));\n+                let field = Field::Node { name, ty, valence: Valence::Many };\n                 acc.push(field);\n                 return;\n             }\n@@ -582,11 +578,13 @@ fn lower_rule(acc: &mut Vec<Field>, grammar: &Grammar, rule: &Rule) {\n                 Rule::Node(node) => node,\n                 _ => todo!(\"{:?}\", rule),\n             };\n+            let ty = grammar[*node].name.clone();\n             let field = Field::Node {\n                 name: label.clone(),\n-                src: match &**rule {\n-                    Rule::Rep(_) => FieldSrc::Many(grammar[*node].name.clone()),\n-                    _ => FieldSrc::Optional(grammar[*node].name.clone()),\n+                ty,\n+                valence: match &**rule {\n+                    Rule::Rep(_) => Valence::Many,\n+                    _ => Valence::Optional,\n                 },\n             };\n             acc.push(field);\n@@ -620,9 +618,9 @@ fn lower_comma_list(acc: &mut Vec<Field>, grammar: &Grammar, rule: &Rule) -> boo\n         [comma, Rule::Node(n)] if comma == &**trailing_comma && n == node => (),\n         _ => return false,\n     }\n-    let name = grammar[*node].name.clone();\n-    let label = pluralize(&to_lower_snake_case(&name));\n-    let field = Field::Node { name: label.clone(), src: FieldSrc::Many(name) };\n+    let ty = grammar[*node].name.clone();\n+    let name = pluralize(&to_lower_snake_case(&ty));\n+    let field = Field::Node { name, ty, valence: Valence::Many };\n     acc.push(field);\n     true\n }\n@@ -656,7 +654,9 @@ fn extract_enums(ast: &mut AstSrc) {\n             }\n             if to_remove.len() == enm.variants.len() {\n                 node.remove_field(to_remove);\n-                node.fields.push(Field::Node { name: enm.name.clone(), src: FieldSrc::Shorthand });\n+                let ty = enm.name.clone();\n+                let name = to_lower_snake_case(&ty);\n+                node.fields.push(Field::Node { name, ty, valence: Valence::Optional });\n             }\n         }\n     }"}]}