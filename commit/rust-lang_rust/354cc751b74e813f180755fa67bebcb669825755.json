{"sha": "354cc751b74e813f180755fa67bebcb669825755", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM1NGNjNzUxYjc0ZTgxM2YxODA3NTVmYTY3YmViY2I2Njk4MjU3NTU=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-04-06T07:16:19Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-04-06T07:16:19Z"}, "message": "Auto merge of #81641 - bjorn3:find_codegen_backend, r=davidtwco\n\nFind codegen backends in more locations\n\n* Search in the sysroot passed using `--sysroot` in addition to the default sysroot.\n* Search for `librustc_codegen_$name.so` in addition to `librustc_codegen_$name-$release.so`.\n\nThis combined would allow putting `librustc_codegen_cranelift.so` in the right location of a sysroot passed using `--sysroot`.", "tree": {"sha": "9656d507d8be6e008ddc95fe02a8e8236a0fc853", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9656d507d8be6e008ddc95fe02a8e8236a0fc853"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/354cc751b74e813f180755fa67bebcb669825755", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/354cc751b74e813f180755fa67bebcb669825755", "html_url": "https://github.com/rust-lang/rust/commit/354cc751b74e813f180755fa67bebcb669825755", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/354cc751b74e813f180755fa67bebcb669825755/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a6e7a5aa5dc842ddb64607040aefb6ec33e22b59", "url": "https://api.github.com/repos/rust-lang/rust/commits/a6e7a5aa5dc842ddb64607040aefb6ec33e22b59", "html_url": "https://github.com/rust-lang/rust/commit/a6e7a5aa5dc842ddb64607040aefb6ec33e22b59"}, {"sha": "7f19a2d2de32ea61a8c9b8bca44a13894954b3be", "url": "https://api.github.com/repos/rust-lang/rust/commits/7f19a2d2de32ea61a8c9b8bca44a13894954b3be", "html_url": "https://github.com/rust-lang/rust/commit/7f19a2d2de32ea61a8c9b8bca44a13894954b3be"}], "stats": {"total": 29, "additions": 19, "deletions": 10}, "files": [{"sha": "3d26c94ec77a26879d3e94979c2e48c599dddd47", "filename": "compiler/rustc_driver/src/lib.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/354cc751b74e813f180755fa67bebcb669825755/compiler%2Frustc_driver%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/354cc751b74e813f180755fa67bebcb669825755/compiler%2Frustc_driver%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_driver%2Fsrc%2Flib.rs?ref=354cc751b74e813f180755fa67bebcb669825755", "patch": "@@ -795,7 +795,7 @@ pub fn version(binary: &str, matches: &getopts::Matches) {\n         println!(\"host: {}\", config::host_triple());\n         println!(\"release: {}\", unw(util::release_str()));\n         if cfg!(feature = \"llvm\") {\n-            get_builtin_codegen_backend(\"llvm\")().print_version();\n+            get_builtin_codegen_backend(&None, \"llvm\")().print_version();\n         }\n     }\n }\n@@ -1089,7 +1089,7 @@ pub fn handle_options(args: &[String]) -> Option<getopts::Matches> {\n \n     if cg_flags.iter().any(|x| *x == \"passes=list\") {\n         if cfg!(feature = \"llvm\") {\n-            get_builtin_codegen_backend(\"llvm\")().print_passes();\n+            get_builtin_codegen_backend(&None, \"llvm\")().print_passes();\n         }\n         return None;\n     }"}, {"sha": "59488fc80a5e2e312b889bbe4b64926c11011ad5", "filename": "compiler/rustc_interface/src/util.rs", "status": "modified", "additions": 17, "deletions": 8, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/354cc751b74e813f180755fa67bebcb669825755/compiler%2Frustc_interface%2Fsrc%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/354cc751b74e813f180755fa67bebcb669825755/compiler%2Frustc_interface%2Fsrc%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2Fsrc%2Futil.rs?ref=354cc751b74e813f180755fa67bebcb669825755", "patch": "@@ -265,7 +265,7 @@ pub fn get_codegen_backend(sopts: &config::Options) -> Box<dyn CodegenBackend> {\n \n         let backend = match codegen_name {\n             filename if filename.contains('.') => load_backend_from_dylib(filename.as_ref()),\n-            codegen_name => get_builtin_codegen_backend(codegen_name),\n+            codegen_name => get_builtin_codegen_backend(&sopts.maybe_sysroot, codegen_name),\n         };\n \n         unsafe {\n@@ -390,15 +390,21 @@ fn sysroot_candidates() -> Vec<PathBuf> {\n     }\n }\n \n-pub fn get_builtin_codegen_backend(backend_name: &str) -> fn() -> Box<dyn CodegenBackend> {\n+pub fn get_builtin_codegen_backend(\n+    maybe_sysroot: &Option<PathBuf>,\n+    backend_name: &str,\n+) -> fn() -> Box<dyn CodegenBackend> {\n     match backend_name {\n         #[cfg(feature = \"llvm\")]\n         \"llvm\" => rustc_codegen_llvm::LlvmCodegenBackend::new,\n-        _ => get_codegen_sysroot(backend_name),\n+        _ => get_codegen_sysroot(maybe_sysroot, backend_name),\n     }\n }\n \n-pub fn get_codegen_sysroot(backend_name: &str) -> fn() -> Box<dyn CodegenBackend> {\n+pub fn get_codegen_sysroot(\n+    maybe_sysroot: &Option<PathBuf>,\n+    backend_name: &str,\n+) -> fn() -> Box<dyn CodegenBackend> {\n     // For now we only allow this function to be called once as it'll dlopen a\n     // few things, which seems to work best if we only do that once. In\n     // general this assertion never trips due to the once guard in `get_codegen_backend`,\n@@ -413,8 +419,9 @@ pub fn get_codegen_sysroot(backend_name: &str) -> fn() -> Box<dyn CodegenBackend\n     let target = session::config::host_triple();\n     let sysroot_candidates = sysroot_candidates();\n \n-    let sysroot = sysroot_candidates\n+    let sysroot = maybe_sysroot\n         .iter()\n+        .chain(sysroot_candidates.iter())\n         .map(|sysroot| {\n             let libdir = filesearch::relative_target_lib_path(&sysroot, &target);\n             sysroot.join(libdir).with_file_name(\"codegen-backends\")\n@@ -450,8 +457,10 @@ pub fn get_codegen_sysroot(backend_name: &str) -> fn() -> Box<dyn CodegenBackend\n \n     let mut file: Option<PathBuf> = None;\n \n-    let expected_name =\n-        format!(\"rustc_codegen_{}-{}\", backend_name, release_str().expect(\"CFG_RELEASE\"));\n+    let expected_names = &[\n+        format!(\"rustc_codegen_{}-{}\", backend_name, release_str().expect(\"CFG_RELEASE\")),\n+        format!(\"rustc_codegen_{}\", backend_name),\n+    ];\n     for entry in d.filter_map(|e| e.ok()) {\n         let path = entry.path();\n         let filename = match path.file_name().and_then(|s| s.to_str()) {\n@@ -462,7 +471,7 @@ pub fn get_codegen_sysroot(backend_name: &str) -> fn() -> Box<dyn CodegenBackend\n             continue;\n         }\n         let name = &filename[DLL_PREFIX.len()..filename.len() - DLL_SUFFIX.len()];\n-        if name != expected_name {\n+        if !expected_names.iter().any(|expected| expected == name) {\n             continue;\n         }\n         if let Some(ref prev) = file {"}]}