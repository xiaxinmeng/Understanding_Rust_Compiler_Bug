{"sha": "ce4f73a243de147c2c5b9b9822a71dafbca97a51", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNlNGY3M2EyNDNkZTE0N2MyYzViOWI5ODIyYTcxZGFmYmNhOTdhNTE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-04-20T06:03:52Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-04-20T06:03:52Z"}, "message": "auto merge of #5945 : graydon/rust/fix-unicode-tables, r=pcwalton\n\nThis switches the unicode functions in core to use static character-range tables and a binary search helper rather than open-coded switch statements. It adds about 50k of read only data to the libcore binary but cuts out a similar amount of compiled IR. Would have done it this way in the first place but we didn't have structured statics for a long time.", "tree": {"sha": "d1097cda04b3e4a4f40e673903ebd2200d98decc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d1097cda04b3e4a4f40e673903ebd2200d98decc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ce4f73a243de147c2c5b9b9822a71dafbca97a51", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ce4f73a243de147c2c5b9b9822a71dafbca97a51", "html_url": "https://github.com/rust-lang/rust/commit/ce4f73a243de147c2c5b9b9822a71dafbca97a51", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ce4f73a243de147c2c5b9b9822a71dafbca97a51/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e67f1c0fd229ab9f106c17f3b690dc6059eaeef0", "url": "https://api.github.com/repos/rust-lang/rust/commits/e67f1c0fd229ab9f106c17f3b690dc6059eaeef0", "html_url": "https://github.com/rust-lang/rust/commit/e67f1c0fd229ab9f106c17f3b690dc6059eaeef0"}, {"sha": "5a3d26f271a39212de90544e7394c29373dc5bab", "url": "https://api.github.com/repos/rust-lang/rust/commits/5a3d26f271a39212de90544e7394c29373dc5bab", "html_url": "https://github.com/rust-lang/rust/commit/5a3d26f271a39212de90544e7394c29373dc5bab"}], "stats": {"total": 7247, "additions": 2664, "deletions": 4583}, "files": [{"sha": "864cf3daee07ef114082d6fd29008acc79916b45", "filename": "src/etc/unicode.py", "status": "modified", "additions": 44, "deletions": 1, "changes": 45, "blob_url": "https://github.com/rust-lang/rust/blob/ce4f73a243de147c2c5b9b9822a71dafbca97a51/src%2Fetc%2Funicode.py", "raw_url": "https://github.com/rust-lang/rust/raw/ce4f73a243de147c2c5b9b9822a71dafbca97a51/src%2Fetc%2Funicode.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fetc%2Funicode.py?ref=ce4f73a243de147c2c5b9b9822a71dafbca97a51", "patch": "@@ -112,7 +112,49 @@ def escape_char(c):\n         return \"'\\\\u%4.4x'\" % c\n     return \"'\\\\U%8.8x'\" % c\n \n+def ch_prefix(ix):\n+    if ix == 0:\n+        return \"        \"\n+    if ix % 2 == 0:\n+        return \",\\n        \"\n+    else:\n+        return \", \"\n+\n+def emit_bsearch_range_table(f):\n+    f.write(\"\"\"\n+    pure fn bsearch_range_table(c: char, r: &[(char,char)]) -> bool {\n+        use cmp::{EQ, LT, GT};\n+        use vec::bsearch;\n+        use option::None;\n+        (do bsearch(r) |&(lo,hi)| {\n+            if lo <= c && c <= hi { EQ }\n+            else if hi < c { LT }\n+            else { GT }\n+        }) != None\n+    }\\n\\n\n+\"\"\");\n+\n def emit_property_module(f, mod, tbl):\n+    f.write(\"pub mod %s {\\n\" % mod)\n+    keys = tbl.keys()\n+    keys.sort()\n+    emit_bsearch_range_table(f);\n+    for cat in keys:\n+        f.write(\"    const %s_table : &[(char,char)] = &[\\n\" % cat)\n+        ix = 0\n+        for pair in tbl[cat]:\n+            f.write(ch_prefix(ix))\n+            f.write(\"(%s, %s)\" % (escape_char(pair[0]), escape_char(pair[1])))\n+            ix += 1\n+        f.write(\"\\n    ];\\n\\n\")\n+\n+        f.write(\"    pub pure fn %s(c: char) -> bool {\\n\" % cat)\n+        f.write(\"        bsearch_range_table(c, %s_table)\\n\" % cat)\n+        f.write(\"    }\\n\\n\")\n+    f.write(\"}\\n\")\n+\n+\n+def emit_property_module_old(f, mod, tbl):\n     f.write(\"mod %s {\\n\" % mod)\n     keys = tbl.keys()\n     keys.sort()\n@@ -193,8 +235,9 @@ def emit_decomp_module(f, canon, compat):\n rf = open(r, \"w\")\n \n (canon_decomp, compat_decomp, gencats) = load_unicode_data(\"UnicodeData.txt\")\n-emit_decomp_module(rf, canon_decomp, compat_decomp)\n emit_property_module(rf, \"general_category\", gencats)\n \n+#emit_decomp_module(rf, canon_decomp, compat_decomp)\n+\n derived = load_derived_core_properties(\"DerivedCoreProperties.txt\")\n emit_property_module(rf, \"derived_property\", derived)"}, {"sha": "a13d66c48ee0cf8e04cc5b519c1281c4bc6b6e20", "filename": "src/libcore/unicode.rs", "status": "modified", "additions": 2533, "deletions": 4580, "changes": 7113, "blob_url": "https://github.com/rust-lang/rust/blob/ce4f73a243de147c2c5b9b9822a71dafbca97a51/src%2Flibcore%2Funicode.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ce4f73a243de147c2c5b9b9822a71dafbca97a51/src%2Flibcore%2Funicode.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Funicode.rs?ref=ce4f73a243de147c2c5b9b9822a71dafbca97a51"}, {"sha": "04b15977665e18b9988615de989bcbf4390f0ce5", "filename": "src/libcore/vec.rs", "status": "modified", "additions": 85, "deletions": 0, "changes": 85, "blob_url": "https://github.com/rust-lang/rust/blob/ce4f73a243de147c2c5b9b9822a71dafbca97a51/src%2Flibcore%2Fvec.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ce4f73a243de147c2c5b9b9822a71dafbca97a51/src%2Flibcore%2Fvec.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fvec.rs?ref=ce4f73a243de147c2c5b9b9822a71dafbca97a51", "patch": "@@ -1227,6 +1227,46 @@ pub fn rposition_between<T>(v: &[T], start: uint, end: uint,\n     None\n }\n \n+\n+\n+/**\n+ * Binary search a sorted vector with a comparator function.\n+ *\n+ * The comparator should implement an order consistent with the sort\n+ * order of the underlying vector, returning an order code that indicates\n+ * whether its argument is `Less`, `Equal` or `Greater` the desired target.\n+ *\n+ * Returns the index where the comparator returned `Equal`, or `None` if\n+ * not found.\n+ */\n+pub fn bsearch<T>(v: &[T], f: &fn(&T) -> Ordering) -> Option<uint> {\n+    let mut base : uint = 0;\n+    let mut lim : uint = v.len();\n+\n+    while lim != 0 {\n+        let ix = base + (lim >> 1);\n+        match f(&v[ix]) {\n+            Equal => return Some(ix),\n+            Less => {\n+                base = ix + 1;\n+                lim -= 1;\n+            }\n+            Greater => ()\n+        }\n+        lim >>= 1;\n+    }\n+    return None;\n+}\n+\n+/**\n+ * Binary search a sorted vector for a given element.\n+ *\n+ * Returns the index of the element or None if not found.\n+ */\n+pub fn bsearch_elem<T:TotalOrd>(v: &[T], x: &T) -> Option<uint> {\n+    bsearch(v, |p| p.cmp(x))\n+}\n+\n // FIXME: if issue #586 gets implemented, could have a postcondition\n // saying the two result lists have the same length -- or, could\n // return a nominal record with a constraint saying that, instead of\n@@ -3789,6 +3829,51 @@ mod tests {\n         assert!(rfind_between(v, 4u, 4u, f).is_none());\n     }\n \n+    #[test]\n+    fn test_bsearch_elem() {\n+        assert!(bsearch_elem([1,2,3,4,5], &5) == Some(4));\n+        assert!(bsearch_elem([1,2,3,4,5], &4) == Some(3));\n+        assert!(bsearch_elem([1,2,3,4,5], &3) == Some(2));\n+        assert!(bsearch_elem([1,2,3,4,5], &2) == Some(1));\n+        assert!(bsearch_elem([1,2,3,4,5], &1) == Some(0));\n+\n+        assert!(bsearch_elem([2,4,6,8,10], &1) == None);\n+        assert!(bsearch_elem([2,4,6,8,10], &5) == None);\n+        assert!(bsearch_elem([2,4,6,8,10], &4) == Some(1));\n+        assert!(bsearch_elem([2,4,6,8,10], &10) == Some(4));\n+\n+        assert!(bsearch_elem([2,4,6,8], &1) == None);\n+        assert!(bsearch_elem([2,4,6,8], &5) == None);\n+        assert!(bsearch_elem([2,4,6,8], &4) == Some(1));\n+        assert!(bsearch_elem([2,4,6,8], &8) == Some(3));\n+\n+        assert!(bsearch_elem([2,4,6], &1) == None);\n+        assert!(bsearch_elem([2,4,6], &5) == None);\n+        assert!(bsearch_elem([2,4,6], &4) == Some(1));\n+        assert!(bsearch_elem([2,4,6], &6) == Some(2));\n+\n+        assert!(bsearch_elem([2,4], &1) == None);\n+        assert!(bsearch_elem([2,4], &5) == None);\n+        assert!(bsearch_elem([2,4], &2) == Some(0));\n+        assert!(bsearch_elem([2,4], &4) == Some(1));\n+\n+        assert!(bsearch_elem([2], &1) == None);\n+        assert!(bsearch_elem([2], &5) == None);\n+        assert!(bsearch_elem([2], &2) == Some(0));\n+\n+        assert!(bsearch_elem([], &1) == None);\n+        assert!(bsearch_elem([], &5) == None);\n+\n+        assert!(bsearch_elem([1,1,1,1,1], &1) != None);\n+        assert!(bsearch_elem([1,1,1,1,2], &1) != None);\n+        assert!(bsearch_elem([1,1,1,2,2], &1) != None);\n+        assert!(bsearch_elem([1,1,2,2,2], &1) != None);\n+        assert!(bsearch_elem([1,2,2,2,2], &1) == Some(0));\n+\n+        assert!(bsearch_elem([1,2,3,4,5], &6) == None);\n+        assert!(bsearch_elem([1,2,3,4,5], &0) == None);\n+    }\n+\n     #[test]\n     fn reverse_and_reversed() {\n         let mut v: ~[int] = ~[10, 20];"}, {"sha": "a9edf12f7fa820512fa998b894e3ef75b2e6df5b", "filename": "src/libsyntax/parse/lexer.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/ce4f73a243de147c2c5b9b9822a71dafbca97a51/src%2Flibsyntax%2Fparse%2Flexer.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ce4f73a243de147c2c5b9b9822a71dafbca97a51/src%2Flibsyntax%2Fparse%2Flexer.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fparse%2Flexer.rs?ref=ce4f73a243de147c2c5b9b9822a71dafbca97a51", "patch": "@@ -535,15 +535,15 @@ fn ident_start(c: char) -> bool {\n     (c >= 'a' && c <= 'z')\n         || (c >= 'A' && c <= 'Z')\n         || c == '_'\n-        || (c > 'z' && char::is_XID_start(c))\n+        || (c > '\\x7f' && char::is_XID_start(c))\n }\n \n fn ident_continue(c: char) -> bool {\n     (c >= 'a' && c <= 'z')\n         || (c >= 'A' && c <= 'Z')\n         || (c >= '0' && c <= '9')\n         || c == '_'\n-        || (c > 'z' && char::is_XID_continue(c))\n+        || (c > '\\x7f' && char::is_XID_continue(c))\n }\n \n // return the next token from the string"}]}