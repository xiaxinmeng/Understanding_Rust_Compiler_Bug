{"sha": "6e70849304f3f9d15edfdc1aaeb9d2ef9937ad79", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZlNzA4NDkzMDRmM2Y5ZDE1ZWRmZGMxYWFlYjlkMmVmOTkzN2FkNzk=", "commit": {"author": {"name": "Felix S. Klock II", "email": "pnkfelix@pnkfx.org", "date": "2020-02-29T03:56:37Z"}, "committer": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2020-04-10T16:07:56Z"}, "message": "tests encoding current behavior for various cases of \"binding\" to _.\n\nThe `_` binding form is special, in that it encodes a \"no-op\": nothing is\nactually bound, and thus nothing is moved or borrowed in this scenario. Usually\nwe do the \"right\" thing in all such cases. The exceptions are explicitly pointed\nout in this test case, so that we keep track of whether they are eventually\nfixed.", "tree": {"sha": "35baafb9792893dcbd022af1c19d2c4d6e3ff8aa", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/35baafb9792893dcbd022af1c19d2c4d6e3ff8aa"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6e70849304f3f9d15edfdc1aaeb9d2ef9937ad79", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6e70849304f3f9d15edfdc1aaeb9d2ef9937ad79", "html_url": "https://github.com/rust-lang/rust/commit/6e70849304f3f9d15edfdc1aaeb9d2ef9937ad79", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6e70849304f3f9d15edfdc1aaeb9d2ef9937ad79/comments", "author": {"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "167510f776891f2b0b18d1168ed42377a63493a7", "url": "https://api.github.com/repos/rust-lang/rust/commits/167510f776891f2b0b18d1168ed42377a63493a7", "html_url": "https://github.com/rust-lang/rust/commit/167510f776891f2b0b18d1168ed42377a63493a7"}], "stats": {"total": 243, "additions": 243, "deletions": 0}, "files": [{"sha": "6aee2699474df120fd41e8bad4e919d63ad96c9a", "filename": "src/test/ui/binding/issue-53114-borrow-checks.rs", "status": "added", "additions": 58, "deletions": 0, "changes": 58, "blob_url": "https://github.com/rust-lang/rust/blob/6e70849304f3f9d15edfdc1aaeb9d2ef9937ad79/src%2Ftest%2Fui%2Fbinding%2Fissue-53114-borrow-checks.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6e70849304f3f9d15edfdc1aaeb9d2ef9937ad79/src%2Ftest%2Fui%2Fbinding%2Fissue-53114-borrow-checks.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fbinding%2Fissue-53114-borrow-checks.rs?ref=6e70849304f3f9d15edfdc1aaeb9d2ef9937ad79", "patch": "@@ -0,0 +1,58 @@\n+// Issue #53114: NLL's borrow check had some deviations from the old borrow\n+// checker, and both had some deviations from our ideal state. This test\n+// captures the behavior of how `_` bindings are handled wiith respect to how we\n+// flag expressions that are meant to request unsafe blocks.\n+\n+struct M;\n+\n+fn let_wild_gets_moved_expr() {\n+    let m = M;\n+    drop(m);\n+    let _ = m; // accepted, and want it to continue to be\n+\n+    let mm = (M, M); // variation on above with `_` in substructure\n+    let (_x, _) = mm;\n+    let (_, _y) = mm;\n+    let (_, _) = mm;\n+}\n+\n+fn match_moved_expr_to_wild() {\n+    let m = M;\n+    drop(m);\n+    match m { _ => { } } // #53114: should eventually be accepted too\n+    //~^ ERROR [E0382]\n+\n+    let mm = (M, M); // variation on above with `_` in substructure\n+    match mm { (_x, _) => { } }\n+    match mm { (_, _y) => { } }\n+    //~^ ERROR [E0382]\n+    match mm { (_, _) => { } }\n+    //~^ ERROR [E0382]\n+}\n+\n+fn let_wild_gets_borrowed_expr() {\n+    let mut m = M;\n+    let r = &mut m;\n+    let _ = m; // accepted, and want it to continue to be\n+    // let _x = m; // (compare with this error.)\n+    drop(r);\n+\n+    let mut mm = (M, M); // variation on above with `_` in substructure\n+    let (r1, r2) = (&mut mm.0, &mut mm.1);\n+    let (_, _) = mm;\n+    drop((r1, r2));\n+}\n+\n+fn match_borrowed_expr_to_wild() {\n+    let mut m = M;\n+    let r = &mut m;\n+    match m { _ => {} } ; // accepted, and want it to continue to be\n+    drop(r);\n+\n+    let mut mm = (M, M); // variation on above with `_` in substructure\n+    let (r1, r2) = (&mut mm.0, &mut mm.1);\n+    match mm { (_, _) => { } }\n+    drop((r1, r2));\n+}\n+\n+fn main() { }"}, {"sha": "18114dc09cf528f5e31e861f76bb9ac114774c6e", "filename": "src/test/ui/binding/issue-53114-borrow-checks.stderr", "status": "added", "additions": 34, "deletions": 0, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/6e70849304f3f9d15edfdc1aaeb9d2ef9937ad79/src%2Ftest%2Fui%2Fbinding%2Fissue-53114-borrow-checks.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/6e70849304f3f9d15edfdc1aaeb9d2ef9937ad79/src%2Ftest%2Fui%2Fbinding%2Fissue-53114-borrow-checks.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fbinding%2Fissue-53114-borrow-checks.stderr?ref=6e70849304f3f9d15edfdc1aaeb9d2ef9937ad79", "patch": "@@ -0,0 +1,34 @@\n+error[E0382]: use of moved value: `m`\n+  --> $DIR/issue-53114-borrow-checks.rs:22:11\n+   |\n+LL |     let m = M;\n+   |         - move occurs because `m` has type `M`, which does not implement the `Copy` trait\n+LL |     drop(m);\n+   |          - value moved here\n+LL |     match m { _ => { } } // #53114: should eventually be accepted too\n+   |           ^ value used here after move\n+\n+error[E0382]: use of moved value: `mm`\n+  --> $DIR/issue-53114-borrow-checks.rs:27:11\n+   |\n+LL |     match mm { (_x, _) => { } }\n+   |                 -- value moved here\n+LL |     match mm { (_, _y) => { } }\n+   |           ^^ value used here after partial move\n+   |\n+   = note: move occurs because `mm.0` has type `M`, which does not implement the `Copy` trait\n+\n+error[E0382]: use of moved value: `mm`\n+  --> $DIR/issue-53114-borrow-checks.rs:29:11\n+   |\n+LL |     match mm { (_, _y) => { } }\n+   |                    -- value moved here\n+LL |\n+LL |     match mm { (_, _) => { } }\n+   |           ^^ value used here after partial move\n+   |\n+   = note: move occurs because `mm.1` has type `M`, which does not implement the `Copy` trait\n+\n+error: aborting due to 3 previous errors\n+\n+For more information about this error, try `rustc --explain E0382`."}, {"sha": "86c863bc9a843a5be88413f8821a21cb512fed13", "filename": "src/test/ui/binding/issue-53114-safety-checks.rs", "status": "added", "additions": 51, "deletions": 0, "changes": 51, "blob_url": "https://github.com/rust-lang/rust/blob/6e70849304f3f9d15edfdc1aaeb9d2ef9937ad79/src%2Ftest%2Fui%2Fbinding%2Fissue-53114-safety-checks.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6e70849304f3f9d15edfdc1aaeb9d2ef9937ad79/src%2Ftest%2Fui%2Fbinding%2Fissue-53114-safety-checks.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fbinding%2Fissue-53114-safety-checks.rs?ref=6e70849304f3f9d15edfdc1aaeb9d2ef9937ad79", "patch": "@@ -0,0 +1,51 @@\n+// Issue #53114: NLL's borrow check had some deviations from the old borrow\n+// checker, and both had some deviations from our ideal state. This test\n+// captures the behavior of how `_` bindings are handled wiith respect to how we\n+// flag expressions that are meant to request unsafe blocks.\n+\n+#![feature(untagged_unions)]\n+\n+struct I(i64);\n+struct F(f64);\n+\n+union U { a: I, b: F }\n+\n+#[repr(packed)]\n+struct P {\n+    a: &'static i8,\n+    b: &'static u32,\n+}\n+\n+fn let_wild_gets_unsafe_field() {\n+    let u1 = U { a: I(0) };\n+    let u2 = U { a: I(1) };\n+    let p = P { a: &2, b: &3 };\n+    let _ = &p.b;  //~ WARN    E0133\n+    //~^  WARN will become a hard error\n+    let _ = u1.a;  // #53114: should eventually signal error as well\n+    let _ = &u2.a; //~ ERROR  [E0133]\n+\n+    // variation on above with `_` in substructure\n+    let (_,) = (&p.b,);  //~ WARN     E0133\n+    //~^  WARN will become a hard error\n+    let (_,) = (u1.a,);  //~ ERROR   [E0133]\n+    let (_,) = (&u2.a,); //~ ERROR   [E0133]\n+}\n+\n+fn match_unsafe_field_to_wild() {\n+    let u1 = U { a: I(0) };\n+    let u2 = U { a: I(1) };\n+    let p = P { a: &2, b: &3 };\n+    match &p.b  { _ => { } } //~ WARN     E0133\n+    //~^  WARN will become a hard error\n+    match u1.a  { _ => { } } //~ ERROR   [E0133]\n+    match &u2.a { _ => { } } //~ ERROR   [E0133]\n+\n+    // variation on above with `_` in substructure\n+    match (&p.b,)  { (_,) => { } } //~ WARN     E0133\n+    //~^  WARN will become a hard error\n+    match (u1.a,)  { (_,) => { } } //~ ERROR   [E0133]\n+    match (&u2.a,) { (_,) => { } } //~ ERROR   [E0133]\n+}\n+\n+fn main() { }"}, {"sha": "fc714a78bf64815c96e214b4247f2b9abff50f23", "filename": "src/test/ui/binding/issue-53114-safety-checks.stderr", "status": "added", "additions": 100, "deletions": 0, "changes": 100, "blob_url": "https://github.com/rust-lang/rust/blob/6e70849304f3f9d15edfdc1aaeb9d2ef9937ad79/src%2Ftest%2Fui%2Fbinding%2Fissue-53114-safety-checks.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/6e70849304f3f9d15edfdc1aaeb9d2ef9937ad79/src%2Ftest%2Fui%2Fbinding%2Fissue-53114-safety-checks.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fbinding%2Fissue-53114-safety-checks.stderr?ref=6e70849304f3f9d15edfdc1aaeb9d2ef9937ad79", "patch": "@@ -0,0 +1,100 @@\n+warning: borrow of packed field is unsafe and requires unsafe function or block (error E0133)\n+  --> $DIR/issue-53114-safety-checks.rs:23:13\n+   |\n+LL |     let _ = &p.b;\n+   |             ^^^^\n+   |\n+   = note: `#[warn(safe_packed_borrows)]` on by default\n+   = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n+   = note: for more information, see issue #46043 <https://github.com/rust-lang/rust/issues/46043>\n+   = note: fields of packed structs might be misaligned: dereferencing a misaligned pointer or even just creating a misaligned reference is undefined behavior\n+\n+error[E0133]: access to union field is unsafe and requires unsafe function or block\n+  --> $DIR/issue-53114-safety-checks.rs:26:13\n+   |\n+LL |     let _ = &u2.a;\n+   |             ^^^^^ access to union field\n+   |\n+   = note: the field may not be properly initialized: using uninitialized data will cause undefined behavior\n+\n+warning: borrow of packed field is unsafe and requires unsafe function or block (error E0133)\n+  --> $DIR/issue-53114-safety-checks.rs:29:17\n+   |\n+LL |     let (_,) = (&p.b,);\n+   |                 ^^^^\n+   |\n+   = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n+   = note: for more information, see issue #46043 <https://github.com/rust-lang/rust/issues/46043>\n+   = note: fields of packed structs might be misaligned: dereferencing a misaligned pointer or even just creating a misaligned reference is undefined behavior\n+\n+error[E0133]: access to union field is unsafe and requires unsafe function or block\n+  --> $DIR/issue-53114-safety-checks.rs:31:17\n+   |\n+LL |     let (_,) = (u1.a,);\n+   |                 ^^^^ access to union field\n+   |\n+   = note: the field may not be properly initialized: using uninitialized data will cause undefined behavior\n+\n+error[E0133]: access to union field is unsafe and requires unsafe function or block\n+  --> $DIR/issue-53114-safety-checks.rs:32:17\n+   |\n+LL |     let (_,) = (&u2.a,);\n+   |                 ^^^^^ access to union field\n+   |\n+   = note: the field may not be properly initialized: using uninitialized data will cause undefined behavior\n+\n+warning: borrow of packed field is unsafe and requires unsafe function or block (error E0133)\n+  --> $DIR/issue-53114-safety-checks.rs:39:11\n+   |\n+LL |     match &p.b  { _ => { } }\n+   |           ^^^^\n+   |\n+   = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n+   = note: for more information, see issue #46043 <https://github.com/rust-lang/rust/issues/46043>\n+   = note: fields of packed structs might be misaligned: dereferencing a misaligned pointer or even just creating a misaligned reference is undefined behavior\n+\n+error[E0133]: access to union field is unsafe and requires unsafe function or block\n+  --> $DIR/issue-53114-safety-checks.rs:41:11\n+   |\n+LL |     match u1.a  { _ => { } }\n+   |           ^^^^ access to union field\n+   |\n+   = note: the field may not be properly initialized: using uninitialized data will cause undefined behavior\n+\n+error[E0133]: access to union field is unsafe and requires unsafe function or block\n+  --> $DIR/issue-53114-safety-checks.rs:42:11\n+   |\n+LL |     match &u2.a { _ => { } }\n+   |           ^^^^^ access to union field\n+   |\n+   = note: the field may not be properly initialized: using uninitialized data will cause undefined behavior\n+\n+warning: borrow of packed field is unsafe and requires unsafe function or block (error E0133)\n+  --> $DIR/issue-53114-safety-checks.rs:45:12\n+   |\n+LL |     match (&p.b,)  { (_,) => { } }\n+   |            ^^^^\n+   |\n+   = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n+   = note: for more information, see issue #46043 <https://github.com/rust-lang/rust/issues/46043>\n+   = note: fields of packed structs might be misaligned: dereferencing a misaligned pointer or even just creating a misaligned reference is undefined behavior\n+\n+error[E0133]: access to union field is unsafe and requires unsafe function or block\n+  --> $DIR/issue-53114-safety-checks.rs:47:12\n+   |\n+LL |     match (u1.a,)  { (_,) => { } }\n+   |            ^^^^ access to union field\n+   |\n+   = note: the field may not be properly initialized: using uninitialized data will cause undefined behavior\n+\n+error[E0133]: access to union field is unsafe and requires unsafe function or block\n+  --> $DIR/issue-53114-safety-checks.rs:48:12\n+   |\n+LL |     match (&u2.a,) { (_,) => { } }\n+   |            ^^^^^ access to union field\n+   |\n+   = note: the field may not be properly initialized: using uninitialized data will cause undefined behavior\n+\n+error: aborting due to 7 previous errors\n+\n+For more information about this error, try `rustc --explain E0133`."}]}