{"sha": "49a2b808774bdada1094c0035230361fc6d12680", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQ5YTJiODA4Nzc0YmRhZGExMDk0YzAwMzUyMzAzNjFmYzZkMTI2ODA=", "commit": {"author": {"name": "John K\u00e5re Alsaker", "email": "john.kare.alsaker@gmail.com", "date": "2018-04-01T06:14:25Z"}, "committer": {"name": "John K\u00e5re Alsaker", "email": "john.kare.alsaker@gmail.com", "date": "2018-04-10T12:39:33Z"}, "message": "Make sure the lint store is only used on one thread", "tree": {"sha": "c4cbd039b12eb32fb78b745c9d5dea25c24b66dd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c4cbd039b12eb32fb78b745c9d5dea25c24b66dd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/49a2b808774bdada1094c0035230361fc6d12680", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/49a2b808774bdada1094c0035230361fc6d12680", "html_url": "https://github.com/rust-lang/rust/commit/49a2b808774bdada1094c0035230361fc6d12680", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/49a2b808774bdada1094c0035230361fc6d12680/comments", "author": {"login": "Zoxc", "id": 25784, "node_id": "MDQ6VXNlcjI1Nzg0", "avatar_url": "https://avatars.githubusercontent.com/u/25784?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Zoxc", "html_url": "https://github.com/Zoxc", "followers_url": "https://api.github.com/users/Zoxc/followers", "following_url": "https://api.github.com/users/Zoxc/following{/other_user}", "gists_url": "https://api.github.com/users/Zoxc/gists{/gist_id}", "starred_url": "https://api.github.com/users/Zoxc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Zoxc/subscriptions", "organizations_url": "https://api.github.com/users/Zoxc/orgs", "repos_url": "https://api.github.com/users/Zoxc/repos", "events_url": "https://api.github.com/users/Zoxc/events{/privacy}", "received_events_url": "https://api.github.com/users/Zoxc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Zoxc", "id": 25784, "node_id": "MDQ6VXNlcjI1Nzg0", "avatar_url": "https://avatars.githubusercontent.com/u/25784?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Zoxc", "html_url": "https://github.com/Zoxc", "followers_url": "https://api.github.com/users/Zoxc/followers", "following_url": "https://api.github.com/users/Zoxc/following{/other_user}", "gists_url": "https://api.github.com/users/Zoxc/gists{/gist_id}", "starred_url": "https://api.github.com/users/Zoxc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Zoxc/subscriptions", "organizations_url": "https://api.github.com/users/Zoxc/orgs", "repos_url": "https://api.github.com/users/Zoxc/repos", "events_url": "https://api.github.com/users/Zoxc/events{/privacy}", "received_events_url": "https://api.github.com/users/Zoxc/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "26f16e85ffcc3ebcaf12029865dee257760901b5", "url": "https://api.github.com/repos/rust-lang/rust/commits/26f16e85ffcc3ebcaf12029865dee257760901b5", "html_url": "https://github.com/rust-lang/rust/commit/26f16e85ffcc3ebcaf12029865dee257760901b5"}], "stats": {"total": 14, "additions": 9, "deletions": 5}, "files": [{"sha": "79c835744a34f0646e3e671e42faf26695b4c59f", "filename": "src/librustc/session/mod.rs", "status": "modified", "additions": 9, "deletions": 5, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/49a2b808774bdada1094c0035230361fc6d12680/src%2Flibrustc%2Fsession%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/49a2b808774bdada1094c0035230361fc6d12680/src%2Flibrustc%2Fsession%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fsession%2Fmod.rs?ref=49a2b808774bdada1094c0035230361fc6d12680", "patch": "@@ -26,7 +26,7 @@ use util::nodemap::{FxHashMap, FxHashSet};\n use util::common::{duration_to_secs_str, ErrorReported};\n use util::common::ProfileQueriesMsg;\n \n-use rustc_data_structures::sync::{Lrc, Lock};\n+use rustc_data_structures::sync::{Lrc, Lock, OneThread};\n \n use syntax::ast::NodeId;\n use errors::{self, DiagnosticBuilder, DiagnosticId};\n@@ -80,8 +80,12 @@ pub struct Session {\n     /// The directory the compiler has been executed in plus a flag indicating\n     /// if the value stored here has been affected by path remapping.\n     pub working_dir: (PathBuf, bool),\n-    pub lint_store: RefCell<lint::LintStore>,\n-    pub buffered_lints: RefCell<Option<lint::LintBuffer>>,\n+\n+    // FIXME: lint_store and buffered_lints are not thread-safe,\n+    // but are only used in a single thread\n+    pub lint_store: OneThread<RefCell<lint::LintStore>>,\n+    pub buffered_lints: OneThread<RefCell<Option<lint::LintBuffer>>>,\n+\n     /// Set of (DiagnosticId, Option<Span>, message) tuples tracking\n     /// (sub)diagnostics that have been set once, but should not be set again,\n     /// in order to avoid redundantly verbose output (Issue #24690, #44953).\n@@ -1134,8 +1138,8 @@ pub fn build_session_(\n         default_sysroot,\n         local_crate_source_file,\n         working_dir,\n-        lint_store: RefCell::new(lint::LintStore::new()),\n-        buffered_lints: RefCell::new(Some(lint::LintBuffer::new())),\n+        lint_store: OneThread::new(RefCell::new(lint::LintStore::new())),\n+        buffered_lints: OneThread::new(RefCell::new(Some(lint::LintBuffer::new()))),\n         one_time_diagnostics: RefCell::new(FxHashSet()),\n         plugin_llvm_passes: RefCell::new(Vec::new()),\n         plugin_attributes: RefCell::new(Vec::new()),"}]}