{"sha": "b21f37c81804293168424697518d306542cdd798", "node_id": "MDY6Q29tbWl0NzI0NzEyOmIyMWYzN2M4MTgwNDI5MzE2ODQyNDY5NzUxOGQzMDY1NDJjZGQ3OTg=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-05-08T15:39:40Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-05-08T15:39:40Z"}, "message": "auto merge of #6323 : brson/rust/nullary, r=thestinger\n\nThere's no need to delegate to C to call the Rust main function.", "tree": {"sha": "e09109c9850741b5e4862964cef583ce50b1977c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e09109c9850741b5e4862964cef583ce50b1977c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b21f37c81804293168424697518d306542cdd798", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b21f37c81804293168424697518d306542cdd798", "html_url": "https://github.com/rust-lang/rust/commit/b21f37c81804293168424697518d306542cdd798", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b21f37c81804293168424697518d306542cdd798/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8f94ac6118a3ce97d3d1186b38217a6ca4803771", "url": "https://api.github.com/repos/rust-lang/rust/commits/8f94ac6118a3ce97d3d1186b38217a6ca4803771", "html_url": "https://github.com/rust-lang/rust/commit/8f94ac6118a3ce97d3d1186b38217a6ca4803771"}, {"sha": "80061ecb1d11afd7c450673676e7708f85b73f12", "url": "https://api.github.com/repos/rust-lang/rust/commits/80061ecb1d11afd7c450673676e7708f85b73f12", "html_url": "https://github.com/rust-lang/rust/commit/80061ecb1d11afd7c450673676e7708f85b73f12"}], "stats": {"total": 33, "additions": 19, "deletions": 14}, "files": [{"sha": "25f6c870654a63ea31be4f4aa7a29bf9c21b9847", "filename": "src/libcore/rt/mod.rs", "status": "modified", "additions": 19, "deletions": 6, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/b21f37c81804293168424697518d306542cdd798/src%2Flibcore%2Frt%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b21f37c81804293168424697518d306542cdd798/src%2Flibcore%2Frt%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Frt%2Fmod.rs?ref=b21f37c81804293168424697518d306542cdd798", "patch": "@@ -38,22 +38,35 @@ mod local_heap;\n pub mod test;\n \n pub fn start(main: *u8, _argc: int, _argv: **c_char, _crate_map: *u8) -> int {\n+\n     use self::sched::{Scheduler, Task};\n     use self::uvio::UvEventLoop;\n+    use sys::Closure;\n+    use ptr;\n+    use cast;\n \n     let loop_ = ~UvEventLoop::new();\n     let mut sched = ~Scheduler::new(loop_);\n+\n     let main_task = ~do Task::new(&mut sched.stack_pool) {\n-        // XXX: Can't call a C function pointer from Rust yet\n-        unsafe { rust_call_nullary_fn(main) };\n+\n+        unsafe {\n+            // `main` is an `fn() -> ()` that doesn't take an environment\n+            // XXX: Could also call this as an `extern \"Rust\" fn` once they work\n+            let main = Closure {\n+                code: main as *(),\n+                env: ptr::null(),\n+            };\n+            let mainfn: &fn() = cast::transmute(main);\n+\n+            mainfn();\n+        }\n     };\n+\n     sched.task_queue.push_back(main_task);\n     sched.run();\n-    return 0;\n \n-    extern {\n-        fn rust_call_nullary_fn(f: *u8);\n-    }\n+    return 0;\n }\n \n /// Possible contexts in which Rust code may be executing."}, {"sha": "903289281222b6653ce1da89456ae9558ca907bc", "filename": "src/rt/rust_builtin.cpp", "status": "modified", "additions": 0, "deletions": 7, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/b21f37c81804293168424697518d306542cdd798/src%2Frt%2Frust_builtin.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/b21f37c81804293168424697518d306542cdd798/src%2Frt%2Frust_builtin.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_builtin.cpp?ref=b21f37c81804293168424697518d306542cdd798", "patch": "@@ -829,13 +829,6 @@ rust_get_rt_env() {\n     return task->kernel->env;\n }\n \n-typedef void *(*nullary_fn)();\n-\n-extern \"C\" CDECL void\n-rust_call_nullary_fn(nullary_fn f) {\n-    f();\n-}\n-\n #ifndef _WIN32\n pthread_key_t sched_key;\n #else"}, {"sha": "6be41251f1bd986ecb6879d8a090abaa6b209bc8", "filename": "src/rt/rustrt.def.in", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/b21f37c81804293168424697518d306542cdd798/src%2Frt%2Frustrt.def.in", "raw_url": "https://github.com/rust-lang/rust/raw/b21f37c81804293168424697518d306542cdd798/src%2Frt%2Frustrt.def.in", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frustrt.def.in?ref=b21f37c81804293168424697518d306542cdd798", "patch": "@@ -222,7 +222,6 @@ rust_uv_ip4_addrp\n rust_uv_ip6_addrp\n rust_uv_free_ip4_addr\n rust_uv_free_ip6_addr\n-rust_call_nullary_fn\n rust_initialize_global_state\n rust_dbg_next_port\n rust_new_memory_region"}]}