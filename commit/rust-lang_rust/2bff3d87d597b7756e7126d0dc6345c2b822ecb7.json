{"sha": "2bff3d87d597b7756e7126d0dc6345c2b822ecb7", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJiZmYzZDg3ZDU5N2I3NzU2ZTcxMjZkMGRjNjM0NWMyYjgyMmVjYjc=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-08-30T06:07:41Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-08-30T06:07:41Z"}, "message": "Auto merge of #4446 - mikerite:fix-4437, r=phansch\n\nFix `match_as_ref` bad suggestion\n\nFixes #4437\n\nchangelog: Fix `match_as_ref` bad suggestion", "tree": {"sha": "3942487d18ff9d93dc4286de534a272b0dfb9d8a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3942487d18ff9d93dc4286de534a272b0dfb9d8a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2bff3d87d597b7756e7126d0dc6345c2b822ecb7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2bff3d87d597b7756e7126d0dc6345c2b822ecb7", "html_url": "https://github.com/rust-lang/rust/commit/2bff3d87d597b7756e7126d0dc6345c2b822ecb7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2bff3d87d597b7756e7126d0dc6345c2b822ecb7/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "28a8a6a4834db7b6869d3b645528b31002deba57", "url": "https://api.github.com/repos/rust-lang/rust/commits/28a8a6a4834db7b6869d3b645528b31002deba57", "html_url": "https://github.com/rust-lang/rust/commit/28a8a6a4834db7b6869d3b645528b31002deba57"}, {"sha": "0c8332558b25273ecc3df483044fa3bb8f31eeeb", "url": "https://api.github.com/repos/rust-lang/rust/commits/0c8332558b25273ecc3df483044fa3bb8f31eeeb", "html_url": "https://github.com/rust-lang/rust/commit/0c8332558b25273ecc3df483044fa3bb8f31eeeb"}], "stats": {"total": 79, "additions": 76, "deletions": 3}, "files": [{"sha": "2a65ea000db3de44b0f42f9863b652b31f96f477", "filename": "clippy_lints/src/matches.rs", "status": "modified", "additions": 21, "deletions": 2, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/2bff3d87d597b7756e7126d0dc6345c2b822ecb7/clippy_lints%2Fsrc%2Fmatches.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2bff3d87d597b7756e7126d0dc6345c2b822ecb7/clippy_lints%2Fsrc%2Fmatches.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmatches.rs?ref=2bff3d87d597b7756e7126d0dc6345c2b822ecb7", "patch": "@@ -624,6 +624,24 @@ fn check_match_as_ref(cx: &LateContext<'_, '_>, ex: &Expr, arms: &[Arm], expr: &\n             } else {\n                 \"as_mut\"\n             };\n+\n+            let output_ty = cx.tables.expr_ty(expr);\n+            let input_ty = cx.tables.expr_ty(ex);\n+\n+            let cast = if_chain! {\n+                if let ty::Adt(_, substs) = input_ty.sty;\n+                let input_ty = substs.type_at(0);\n+                if let ty::Adt(_, substs) = output_ty.sty;\n+                let output_ty = substs.type_at(0);\n+                if let ty::Ref(_, output_ty, _) = output_ty.sty;\n+                if input_ty != output_ty;\n+                then {\n+                    \".map(|x| x as _)\"\n+                } else {\n+                    \"\"\n+                }\n+            };\n+\n             let mut applicability = Applicability::MachineApplicable;\n             span_lint_and_sugg(\n                 cx,\n@@ -632,9 +650,10 @@ fn check_match_as_ref(cx: &LateContext<'_, '_>, ex: &Expr, arms: &[Arm], expr: &\n                 &format!(\"use {}() instead\", suggestion),\n                 \"try this\",\n                 format!(\n-                    \"{}.{}()\",\n+                    \"{}.{}(){}\",\n                     snippet_with_applicability(cx, ex.span, \"_\", &mut applicability),\n-                    suggestion\n+                    suggestion,\n+                    cast,\n                 ),\n                 applicability,\n             )"}, {"sha": "c61eb9216643e14159ca5d6fb26b93764b05e264", "filename": "tests/ui/match_as_ref.fixed", "status": "modified", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/2bff3d87d597b7756e7126d0dc6345c2b822ecb7/tests%2Fui%2Fmatch_as_ref.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/2bff3d87d597b7756e7126d0dc6345c2b822ecb7/tests%2Fui%2Fmatch_as_ref.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmatch_as_ref.fixed?ref=2bff3d87d597b7756e7126d0dc6345c2b822ecb7", "patch": "@@ -11,4 +11,25 @@ fn match_as_ref() {\n     let borrow_mut: Option<&mut ()> = mut_owned.as_mut();\n }\n \n+mod issue4437 {\n+    use std::{error::Error, fmt, num::ParseIntError};\n+\n+    #[derive(Debug)]\n+    struct E {\n+        source: Option<ParseIntError>,\n+    }\n+\n+    impl Error for E {\n+        fn source(&self) -> Option<&(dyn Error + 'static)> {\n+            self.source.as_ref().map(|x| x as _)\n+        }\n+    }\n+\n+    impl fmt::Display for E {\n+        fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {\n+            unimplemented!()\n+        }\n+    }\n+}\n+\n fn main() {}"}, {"sha": "2fbd0b255faae6d8c7f18a986620cef94aefdb49", "filename": "tests/ui/match_as_ref.rs", "status": "modified", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/2bff3d87d597b7756e7126d0dc6345c2b822ecb7/tests%2Fui%2Fmatch_as_ref.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2bff3d87d597b7756e7126d0dc6345c2b822ecb7/tests%2Fui%2Fmatch_as_ref.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmatch_as_ref.rs?ref=2bff3d87d597b7756e7126d0dc6345c2b822ecb7", "patch": "@@ -17,4 +17,28 @@ fn match_as_ref() {\n     };\n }\n \n+mod issue4437 {\n+    use std::{error::Error, fmt, num::ParseIntError};\n+\n+    #[derive(Debug)]\n+    struct E {\n+        source: Option<ParseIntError>,\n+    }\n+\n+    impl Error for E {\n+        fn source(&self) -> Option<&(dyn Error + 'static)> {\n+            match self.source {\n+                Some(ref s) => Some(s),\n+                None => None,\n+            }\n+        }\n+    }\n+\n+    impl fmt::Display for E {\n+        fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {\n+            unimplemented!()\n+        }\n+    }\n+}\n+\n fn main() {}"}, {"sha": "dd4739d1ff21d51038408c9e059f15c1347f6096", "filename": "tests/ui/match_as_ref.stderr", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/2bff3d87d597b7756e7126d0dc6345c2b822ecb7/tests%2Fui%2Fmatch_as_ref.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2bff3d87d597b7756e7126d0dc6345c2b822ecb7/tests%2Fui%2Fmatch_as_ref.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmatch_as_ref.stderr?ref=2bff3d87d597b7756e7126d0dc6345c2b822ecb7", "patch": "@@ -20,5 +20,14 @@ LL | |         Some(ref mut v) => Some(v),\n LL | |     };\n    | |_____^ help: try this: `mut_owned.as_mut()`\n \n-error: aborting due to 2 previous errors\n+error: use as_ref() instead\n+  --> $DIR/match_as_ref.rs:30:13\n+   |\n+LL | /             match self.source {\n+LL | |                 Some(ref s) => Some(s),\n+LL | |                 None => None,\n+LL | |             }\n+   | |_____________^ help: try this: `self.source.as_ref().map(|x| x as _)`\n+\n+error: aborting due to 3 previous errors\n "}]}