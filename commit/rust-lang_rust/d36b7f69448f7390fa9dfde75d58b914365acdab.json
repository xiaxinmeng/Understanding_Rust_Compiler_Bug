{"sha": "d36b7f69448f7390fa9dfde75d58b914365acdab", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQzNmI3ZjY5NDQ4ZjczOTBmYTlkZmRlNzVkNThiOTE0MzY1YWNkYWI=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-07-16T12:19:35Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-07-16T12:19:35Z"}, "message": "Auto merge of #62322 - wesleywiser:promoted_query, r=oli-obk\n\nAdd a query to get the `promoted`s for a `mir::Body`\n\nThis is a builidng block toward removing a lot of duplicated code\nbetween miri and the cosnt-propagator pass.\n\nSee this thread for more info:\nhttps://rust-lang.zulipchat.com/#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/Using.20.60InterpCx.60.20more/near/169030661\n\nr? @spastorino but feel free to hand it off to somebody else", "tree": {"sha": "777dfd3b160a9529f230dc7a5e0a6b117ecde730", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/777dfd3b160a9529f230dc7a5e0a6b117ecde730"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d36b7f69448f7390fa9dfde75d58b914365acdab", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d36b7f69448f7390fa9dfde75d58b914365acdab", "html_url": "https://github.com/rust-lang/rust/commit/d36b7f69448f7390fa9dfde75d58b914365acdab", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d36b7f69448f7390fa9dfde75d58b914365acdab/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "02785dabad07d19b8c76a7f86763801d5d3497ff", "url": "https://api.github.com/repos/rust-lang/rust/commits/02785dabad07d19b8c76a7f86763801d5d3497ff", "html_url": "https://github.com/rust-lang/rust/commit/02785dabad07d19b8c76a7f86763801d5d3497ff"}, {"sha": "57c98d3392405705e17cc87dee350c16aeb24b4f", "url": "https://api.github.com/repos/rust-lang/rust/commits/57c98d3392405705e17cc87dee350c16aeb24b4f", "html_url": "https://github.com/rust-lang/rust/commit/57c98d3392405705e17cc87dee350c16aeb24b4f"}], "stats": {"total": 13, "additions": 11, "deletions": 2}, "files": [{"sha": "fba3e22ab1b5471e93cc572c9b39bb668d08ae3c", "filename": "src/librustc/query/mod.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d36b7f69448f7390fa9dfde75d58b914365acdab/src%2Flibrustc%2Fquery%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d36b7f69448f7390fa9dfde75d58b914365acdab/src%2Flibrustc%2Fquery%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fquery%2Fmod.rs?ref=d36b7f69448f7390fa9dfde75d58b914365acdab", "patch": "@@ -124,6 +124,8 @@ rustc_queries! {\n                 mir.map(|x| &*tcx.arena.alloc(x))\n             }\n         }\n+\n+        query promoted_mir(key: DefId) -> &'tcx IndexVec<mir::Promoted, mir::Body<'tcx>> { }\n     }\n \n     TypeChecking {"}, {"sha": "37d4c5b2f09ce95fbf72e592127f5c6e8f54bf10", "filename": "src/librustc_mir/const_eval.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d36b7f69448f7390fa9dfde75d58b914365acdab/src%2Flibrustc_mir%2Fconst_eval.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d36b7f69448f7390fa9dfde75d58b914365acdab/src%2Flibrustc_mir%2Fconst_eval.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fconst_eval.rs?ref=d36b7f69448f7390fa9dfde75d58b914365acdab", "patch": "@@ -697,7 +697,7 @@ pub fn const_eval_raw_provider<'tcx>(\n                 // promoting runtime code is only allowed to error if it references broken constants\n                 // any other kind of error will be reported to the user as a deny-by-default lint\n                 _ => if let Some(p) = cid.promoted {\n-                    let span = tcx.optimized_mir(def_id).promoted[p].span;\n+                    let span = tcx.promoted_mir(def_id)[p].span;\n                     if let InterpError::ReferencedConstant = err.error {\n                         err.report_as_error(\n                             tcx.at(span),"}, {"sha": "9e23d06145330effae30c92858985f335bdac060", "filename": "src/librustc_mir/transform/mod.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/d36b7f69448f7390fa9dfde75d58b914365acdab/src%2Flibrustc_mir%2Ftransform%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d36b7f69448f7390fa9dfde75d58b914365acdab/src%2Flibrustc_mir%2Ftransform%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fmod.rs?ref=d36b7f69448f7390fa9dfde75d58b914365acdab", "patch": "@@ -1,4 +1,5 @@\n use crate::{build, shim};\n+use rustc_data_structures::indexed_vec::IndexVec;\n use rustc::hir::def_id::{CrateNum, DefId, LOCAL_CRATE};\n use rustc::mir::{Body, MirPhase, Promoted};\n use rustc::ty::{TyCtxt, InstanceDef};\n@@ -46,6 +47,7 @@ pub(crate) fn provide(providers: &mut Providers<'_>) {\n         mir_validated,\n         optimized_mir,\n         is_mir_available,\n+        promoted_mir,\n         ..*providers\n     };\n }\n@@ -296,3 +298,8 @@ fn optimized_mir(tcx: TyCtxt<'_>, def_id: DefId) -> &Body<'_> {\n     ]);\n     tcx.arena.alloc(body)\n }\n+\n+fn promoted_mir<'tcx>(tcx: TyCtxt<'tcx>, def_id: DefId) -> &'tcx IndexVec<Promoted, Body<'tcx>> {\n+    let body = tcx.optimized_mir(def_id);\n+    &body.promoted\n+}"}, {"sha": "68880fc345ae23e47de7b9b0c709f47be772a6bf", "filename": "src/librustc_mir/util/pretty.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d36b7f69448f7390fa9dfde75d58b914365acdab/src%2Flibrustc_mir%2Futil%2Fpretty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d36b7f69448f7390fa9dfde75d58b914365acdab/src%2Flibrustc_mir%2Futil%2Fpretty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Futil%2Fpretty.rs?ref=d36b7f69448f7390fa9dfde75d58b914365acdab", "patch": "@@ -263,7 +263,7 @@ pub fn write_mir_pretty<'tcx>(\n \n         write_mir_fn(tcx, MirSource::item(def_id), body, &mut |_, _| Ok(()), w)?;\n \n-        for (i, body) in body.promoted.iter_enumerated() {\n+        for (i, body) in tcx.promoted_mir(def_id).iter_enumerated() {\n             writeln!(w, \"\")?;\n             let src = MirSource {\n                 instance: ty::InstanceDef::Item(def_id),"}]}