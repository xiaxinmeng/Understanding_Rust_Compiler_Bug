{"sha": "d486bfcbff107e8a6769e00c59d02b13c664b6ee", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ0ODZiZmNiZmYxMDdlOGE2NzY5ZTAwYzU5ZDAyYjEzYzY2NGI2ZWU=", "commit": {"author": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2020-11-12T00:00:00Z"}, "committer": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2020-11-12T19:57:43Z"}, "message": "Normalize function type during validation\n\nDuring inlining, the callee body is normalized and has types revealed,\nbut some of locals corresponding to the arguments might come from the\ncaller body which is not. As a result the caller body does not pass\nvalidation without additional normalization.", "tree": {"sha": "267f50c0b37ece0f40806f460e59749f0cb50137", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/267f50c0b37ece0f40806f460e59749f0cb50137"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d486bfcbff107e8a6769e00c59d02b13c664b6ee", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d486bfcbff107e8a6769e00c59d02b13c664b6ee", "html_url": "https://github.com/rust-lang/rust/commit/d486bfcbff107e8a6769e00c59d02b13c664b6ee", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d486bfcbff107e8a6769e00c59d02b13c664b6ee/comments", "author": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9722952f0bed5815cb22cb4878be09fb39f92804", "url": "https://api.github.com/repos/rust-lang/rust/commits/9722952f0bed5815cb22cb4878be09fb39f92804", "html_url": "https://github.com/rust-lang/rust/commit/9722952f0bed5815cb22cb4878be09fb39f92804"}], "stats": {"total": 24, "additions": 16, "deletions": 8}, "files": [{"sha": "2fbfe13082f89613861c36e48a592e9ba6447fac", "filename": "compiler/rustc_mir/src/transform/validate.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d486bfcbff107e8a6769e00c59d02b13c664b6ee/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fvalidate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d486bfcbff107e8a6769e00c59d02b13c664b6ee/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fvalidate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fvalidate.rs?ref=d486bfcbff107e8a6769e00c59d02b13c664b6ee", "patch": "@@ -357,7 +357,9 @@ impl<'a, 'tcx> Visitor<'tcx> for TypeChecker<'a, 'tcx> {\n                 }\n             }\n             TerminatorKind::Call { func, args, destination, cleanup, .. } => {\n+                let param_env = self.param_env.with_reveal_all_normalized(self.tcx);\n                 let func_ty = func.ty(&self.body.local_decls, self.tcx);\n+                let func_ty = self.tcx.normalize_erasing_regions(param_env, func_ty);\n                 match func_ty.kind() {\n                     ty::FnPtr(..) | ty::FnDef(..) => {}\n                     _ => self.fail("}, {"sha": "f3a51b415facac0719b55f2e6f27f624def40e4b", "filename": "src/test/ui/issues/issue-50865-private-impl-trait/auxiliary/lib.rs", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d486bfcbff107e8a6769e00c59d02b13c664b6ee/src%2Ftest%2Fui%2Fissues%2Fissue-50865-private-impl-trait%2Fauxiliary%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d486bfcbff107e8a6769e00c59d02b13c664b6ee/src%2Ftest%2Fui%2Fissues%2Fissue-50865-private-impl-trait%2Fauxiliary%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-50865-private-impl-trait%2Fauxiliary%2Flib.rs?ref=d486bfcbff107e8a6769e00c59d02b13c664b6ee", "patch": "@@ -1,7 +1,3 @@\n-// revisions: default miropt\n-//[miropt]compile-flags: -Z mir-opt-level=2\n-// ~^ This flag is for #77668, it used to be ICE.\n-\n #![crate_type = \"lib\"]\n \n pub fn bar<P>( // Error won't happen if \"bar\" is not generic"}, {"sha": "ccb279f7fa212c076a65348238bba678d7bc94f7", "filename": "src/test/ui/mir/mir-inlining/ice-issue-77306-1.rs", "status": "modified", "additions": 14, "deletions": 4, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/d486bfcbff107e8a6769e00c59d02b13c664b6ee/src%2Ftest%2Fui%2Fmir%2Fmir-inlining%2Fice-issue-77306-1.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d486bfcbff107e8a6769e00c59d02b13c664b6ee/src%2Ftest%2Fui%2Fmir%2Fmir-inlining%2Fice-issue-77306-1.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmir%2Fmir-inlining%2Fice-issue-77306-1.rs?ref=d486bfcbff107e8a6769e00c59d02b13c664b6ee", "patch": "@@ -1,17 +1,27 @@\n-// run-pass\n+// Regression test for various issues related to normalization & inlining.\n+// * #68347, #77306, #77668 - missed normalization during inlining.\n+// * #78442 - missed normalization in validator after inlining.\n+//\n+// build-pass\n // compile-flags:-Zmir-opt-level=2\n \n-// Previously ICEd because we did not normalize during inlining,\n-// see https://github.com/rust-lang/rust/pull/77306 for more discussion.\n-\n pub fn write() {\n     create()()\n }\n \n+pub fn write_generic<T>(_t: T) {\n+    hide()();\n+}\n+\n pub fn create() -> impl FnOnce() {\n    || ()\n }\n \n+pub fn hide() -> impl Fn() {\n+    write\n+}\n+\n fn main() {\n     write();\n+    write_generic(());\n }"}]}