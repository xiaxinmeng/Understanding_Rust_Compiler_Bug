{"sha": "b9db927b68f4b2e9c3e648be35b412ac1839ec54", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI5ZGI5MjdiNjhmNGIyZTljM2U2NDhiZTM1YjQxMmFjMTgzOWVjNTQ=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-08-15T13:41:05Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-08-15T13:41:05Z"}, "message": "Auto merge of #75537 - tmiasko:match-branch-simplify, r=oli-obk\n\nMatchBranchSimplification: fix equal const bool assignments\n\nThe match branch simplification is applied when target blocks contain\nstatements that are either equal or perform a const bool assignment with\ndifferent values to the same place.\n\nPreviously, when constructing new statements, only statements from a\nsingle block had been examined. This lead to a misoptimization when\nstatements are equal because the assign the *same* const bool value to\nthe same place.\n\nFix the issue by examining statements from both blocks when deciding on\nreplacement.\n\nAdditionally:\n\n* Copy discriminant instead of moving it since it might be necessary to use its\n  value more than once.\n* Optimize when switching on copy operand\n\nBased on #75508.\n\nr? @oli-obk  / @JulianKnodt", "tree": {"sha": "b24c1420b4906c19a153d85e436029d31478ace5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b24c1420b4906c19a153d85e436029d31478ace5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b9db927b68f4b2e9c3e648be35b412ac1839ec54", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b9db927b68f4b2e9c3e648be35b412ac1839ec54", "html_url": "https://github.com/rust-lang/rust/commit/b9db927b68f4b2e9c3e648be35b412ac1839ec54", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b9db927b68f4b2e9c3e648be35b412ac1839ec54/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "80fb3f3139c7dee7f211964c6a0b3ccb04b83d5e", "url": "https://api.github.com/repos/rust-lang/rust/commits/80fb3f3139c7dee7f211964c6a0b3ccb04b83d5e", "html_url": "https://github.com/rust-lang/rust/commit/80fb3f3139c7dee7f211964c6a0b3ccb04b83d5e"}, {"sha": "af9b9e4ec874c4bc5c771841d491e02d02d5636a", "url": "https://api.github.com/repos/rust-lang/rust/commits/af9b9e4ec874c4bc5c771841d491e02d02d5636a", "html_url": "https://github.com/rust-lang/rust/commit/af9b9e4ec874c4bc5c771841d491e02d02d5636a"}], "stats": {"total": 712, "additions": 649, "deletions": 63}, "files": [{"sha": "2420f82c0418d57be4a3c916b34420f6886ec8fd", "filename": "src/librustc_index/vec.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/b9db927b68f4b2e9c3e648be35b412ac1839ec54/src%2Flibrustc_index%2Fvec.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b9db927b68f4b2e9c3e648be35b412ac1839ec54/src%2Flibrustc_index%2Fvec.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_index%2Fvec.rs?ref=b9db927b68f4b2e9c3e648be35b412ac1839ec54", "patch": "@@ -680,6 +680,17 @@ impl<I: Idx, T> IndexVec<I, T> {\n         }\n     }\n \n+    /// Returns mutable references to three distinct elements or panics otherwise.\n+    #[inline]\n+    pub fn pick3_mut(&mut self, a: I, b: I, c: I) -> (&mut T, &mut T, &mut T) {\n+        let (ai, bi, ci) = (a.index(), b.index(), c.index());\n+        assert!(ai != bi && bi != ci && ci != ai);\n+        let len = self.raw.len();\n+        assert!(ai < len && bi < len && ci < len);\n+        let ptr = self.raw.as_mut_ptr();\n+        unsafe { (&mut *ptr.add(ai), &mut *ptr.add(bi), &mut *ptr.add(ci)) }\n+    }\n+\n     pub fn convert_index_type<Ix: Idx>(self) -> IndexVec<Ix, T> {\n         IndexVec { raw: self.raw, _marker: PhantomData }\n     }"}, {"sha": "c1d574d6ef290fbfb24c1ee779fba7af69657028", "filename": "src/librustc_mir/transform/match_branches.rs", "status": "modified", "additions": 79, "deletions": 37, "changes": 116, "blob_url": "https://github.com/rust-lang/rust/blob/b9db927b68f4b2e9c3e648be35b412ac1839ec54/src%2Flibrustc_mir%2Ftransform%2Fmatch_branches.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b9db927b68f4b2e9c3e648be35b412ac1839ec54/src%2Flibrustc_mir%2Ftransform%2Fmatch_branches.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fmatch_branches.rs?ref=b9db927b68f4b2e9c3e648be35b412ac1839ec54", "patch": "@@ -4,10 +4,37 @@ use rustc_middle::ty::TyCtxt;\n \n pub struct MatchBranchSimplification;\n \n-// What's the intent of this pass?\n-// If one block is found that switches between blocks which both go to the same place\n-// AND both of these blocks set a similar const in their ->\n-// condense into 1 block based on discriminant AND goto the destination afterwards\n+/// If a source block is found that switches between two blocks that are exactly\n+/// the same modulo const bool assignments (e.g., one assigns true another false\n+/// to the same place), merge a target block statements into the source block,\n+/// using Eq / Ne comparison with switch value where const bools value differ.\n+///\n+/// For example:\n+///\n+/// ```rust\n+/// bb0: {\n+///     switchInt(move _3) -> [42_isize: bb1, otherwise: bb2];\n+/// }\n+///\n+/// bb1: {\n+///     _2 = const true;\n+///     goto -> bb3;\n+/// }\n+///\n+/// bb2: {\n+///     _2 = const false;\n+///     goto -> bb3;\n+/// }\n+/// ```\n+///\n+/// into:\n+///\n+/// ```rust\n+/// bb0: {\n+///    _2 = Eq(move _3, const 42_isize);\n+///    goto -> bb3;\n+/// }\n+/// ```\n \n impl<'tcx> MirPass<'tcx> for MatchBranchSimplification {\n     fn run_pass(&self, tcx: TyCtxt<'tcx>, src: MirSource<'tcx>, body: &mut Body<'tcx>) {\n@@ -16,12 +43,12 @@ impl<'tcx> MirPass<'tcx> for MatchBranchSimplification {\n         'outer: for bb_idx in bbs.indices() {\n             let (discr, val, switch_ty, first, second) = match bbs[bb_idx].terminator().kind {\n                 TerminatorKind::SwitchInt {\n-                    discr: Operand::Move(ref place),\n+                    discr: Operand::Copy(ref place) | Operand::Move(ref place),\n                     switch_ty,\n                     ref targets,\n                     ref values,\n                     ..\n-                } if targets.len() == 2 && values.len() == 1 => {\n+                } if targets.len() == 2 && values.len() == 1 && targets[0] != targets[1] => {\n                     (place, values[0], switch_ty, targets[0], targets[1])\n                 }\n                 // Only optimize switch int statements\n@@ -42,49 +69,64 @@ impl<'tcx> MirPass<'tcx> for MatchBranchSimplification {\n             }\n             for (f, s) in first_stmts.iter().zip(scnd_stmts.iter()) {\n                 match (&f.kind, &s.kind) {\n-                    // If two statements are exactly the same just ignore them.\n-                    (f_s, s_s) if f_s == s_s => (),\n+                    // If two statements are exactly the same, we can optimize.\n+                    (f_s, s_s) if f_s == s_s => {}\n \n+                    // If two statements are const bool assignments to the same place, we can optimize.\n                     (\n                         StatementKind::Assign(box (lhs_f, Rvalue::Use(Operand::Constant(f_c)))),\n                         StatementKind::Assign(box (lhs_s, Rvalue::Use(Operand::Constant(s_c)))),\n-                    ) if lhs_f == lhs_s => {\n-                        if let Some(f_c) = f_c.literal.try_eval_bool(tcx, param_env) {\n-                            // This should also be a bool because it's writing to the same place\n-                            let s_c = s_c.literal.try_eval_bool(tcx, param_env).unwrap();\n-                            if f_c != s_c {\n-                                // have to check this here because f_c & s_c might have\n-                                // different spans.\n-                                continue;\n-                            }\n-                        }\n-                        continue 'outer;\n-                    }\n-                    // If there are not exclusively assignments, then ignore this\n+                    ) if lhs_f == lhs_s\n+                        && f_c.literal.ty.is_bool()\n+                        && s_c.literal.ty.is_bool()\n+                        && f_c.literal.try_eval_bool(tcx, param_env).is_some()\n+                        && s_c.literal.try_eval_bool(tcx, param_env).is_some() => {}\n+\n+                    // Otherwise we cannot optimize. Try another block.\n                     _ => continue 'outer,\n                 }\n             }\n-            // Take owenership of items now that we know we can optimize.\n+            // Take ownership of items now that we know we can optimize.\n             let discr = discr.clone();\n-            let (from, first) = bbs.pick2_mut(bb_idx, first);\n \n-            let new_stmts = first.statements.iter().cloned().map(|mut s| {\n-                if let StatementKind::Assign(box (_, ref mut rhs)) = s.kind {\n-                    if let Rvalue::Use(Operand::Constant(c)) = rhs {\n-                        let size = tcx.layout_of(param_env.and(switch_ty)).unwrap().size;\n-                        let const_cmp = Operand::const_from_scalar(\n-                            tcx,\n-                            switch_ty,\n-                            crate::interpret::Scalar::from_uint(val, size),\n-                            rustc_span::DUMMY_SP,\n-                        );\n-                        if let Some(c) = c.literal.try_eval_bool(tcx, param_env) {\n-                            let op = if c { BinOp::Eq } else { BinOp::Ne };\n-                            *rhs = Rvalue::BinaryOp(op, Operand::Move(discr), const_cmp);\n+            // We already checked that first and second are different blocks,\n+            // and bb_idx has a different terminator from both of them.\n+            let (from, first, second) = bbs.pick3_mut(bb_idx, first, second);\n+\n+            let new_stmts = first.statements.iter().zip(second.statements.iter()).map(|(f, s)| {\n+                match (&f.kind, &s.kind) {\n+                    (f_s, s_s) if f_s == s_s => (*f).clone(),\n+\n+                    (\n+                        StatementKind::Assign(box (lhs, Rvalue::Use(Operand::Constant(f_c)))),\n+                        StatementKind::Assign(box (_, Rvalue::Use(Operand::Constant(s_c)))),\n+                    ) => {\n+                        // From earlier loop we know that we are dealing with bool constants only:\n+                        let f_b = f_c.literal.try_eval_bool(tcx, param_env).unwrap();\n+                        let s_b = s_c.literal.try_eval_bool(tcx, param_env).unwrap();\n+                        if f_b == s_b {\n+                            // Same value in both blocks. Use statement as is.\n+                            (*f).clone()\n+                        } else {\n+                            // Different value between blocks. Make value conditional on switch condition.\n+                            let size = tcx.layout_of(param_env.and(switch_ty)).unwrap().size;\n+                            let const_cmp = Operand::const_from_scalar(\n+                                tcx,\n+                                switch_ty,\n+                                crate::interpret::Scalar::from_uint(val, size),\n+                                rustc_span::DUMMY_SP,\n+                            );\n+                            let op = if f_b { BinOp::Eq } else { BinOp::Ne };\n+                            let rhs = Rvalue::BinaryOp(op, Operand::Copy(discr.clone()), const_cmp);\n+                            Statement {\n+                                source_info: f.source_info,\n+                                kind: StatementKind::Assign(box (*lhs, rhs)),\n+                            }\n                         }\n                     }\n+\n+                    _ => unreachable!(),\n                 }\n-                s\n             });\n             from.statements.extend(new_stmts);\n             from.terminator_mut().kind = first.terminator().kind.clone();"}, {"sha": "968890e3a298c2ab0578145afb5a55ea2b19de3c", "filename": "src/test/mir-opt/matches_reduce_branches.bar.MatchBranchSimplification.diff.32bit", "status": "added", "additions": 156, "deletions": 0, "changes": 156, "blob_url": "https://github.com/rust-lang/rust/blob/b9db927b68f4b2e9c3e648be35b412ac1839ec54/src%2Ftest%2Fmir-opt%2Fmatches_reduce_branches.bar.MatchBranchSimplification.diff.32bit", "raw_url": "https://github.com/rust-lang/rust/raw/b9db927b68f4b2e9c3e648be35b412ac1839ec54/src%2Ftest%2Fmir-opt%2Fmatches_reduce_branches.bar.MatchBranchSimplification.diff.32bit", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fmatches_reduce_branches.bar.MatchBranchSimplification.diff.32bit?ref=b9db927b68f4b2e9c3e648be35b412ac1839ec54", "patch": "@@ -0,0 +1,156 @@\n+- // MIR for `bar` before MatchBranchSimplification\n++ // MIR for `bar` after MatchBranchSimplification\n+  \n+  fn bar(_1: i32) -> (bool, bool, bool, bool) {\n+      debug i => _1;                       // in scope 0 at $DIR/matches_reduce_branches.rs:11:8: 11:9\n+      let mut _0: (bool, bool, bool, bool); // return place in scope 0 at $DIR/matches_reduce_branches.rs:11:19: 11:43\n+      let _2: bool;                        // in scope 0 at $DIR/matches_reduce_branches.rs:12:9: 12:10\n+      let _6: ();                          // in scope 0 at $DIR/matches_reduce_branches.rs:17:5: 32:6\n+      let mut _7: bool;                    // in scope 0 at $DIR/matches_reduce_branches.rs:34:6: 34:7\n+      let mut _8: bool;                    // in scope 0 at $DIR/matches_reduce_branches.rs:34:9: 34:10\n+      let mut _9: bool;                    // in scope 0 at $DIR/matches_reduce_branches.rs:34:12: 34:13\n+      let mut _10: bool;                   // in scope 0 at $DIR/matches_reduce_branches.rs:34:15: 34:16\n+      scope 1 {\n+          debug a => _2;                   // in scope 1 at $DIR/matches_reduce_branches.rs:12:9: 12:10\n+          let _3: bool;                    // in scope 1 at $DIR/matches_reduce_branches.rs:13:9: 13:10\n+          scope 2 {\n+              debug b => _3;               // in scope 2 at $DIR/matches_reduce_branches.rs:13:9: 13:10\n+              let _4: bool;                // in scope 2 at $DIR/matches_reduce_branches.rs:14:9: 14:10\n+              scope 3 {\n+                  debug c => _4;           // in scope 3 at $DIR/matches_reduce_branches.rs:14:9: 14:10\n+                  let _5: bool;            // in scope 3 at $DIR/matches_reduce_branches.rs:15:9: 15:10\n+                  scope 4 {\n+                      debug d => _5;       // in scope 4 at $DIR/matches_reduce_branches.rs:15:9: 15:10\n+                  }\n+              }\n+          }\n+      }\n+  \n+      bb0: {\n+          StorageLive(_2);                 // scope 0 at $DIR/matches_reduce_branches.rs:12:9: 12:10\n+          StorageLive(_3);                 // scope 1 at $DIR/matches_reduce_branches.rs:13:9: 13:10\n+          StorageLive(_4);                 // scope 2 at $DIR/matches_reduce_branches.rs:14:9: 14:10\n+          StorageLive(_5);                 // scope 3 at $DIR/matches_reduce_branches.rs:15:9: 15:10\n+          StorageLive(_6);                 // scope 4 at $DIR/matches_reduce_branches.rs:17:5: 32:6\n+-         switchInt(_1) -> [7_i32: bb2, otherwise: bb1]; // scope 4 at $DIR/matches_reduce_branches.rs:18:9: 18:10\n++         _2 = Ne(_1, const 7_i32);        // scope 4 at $DIR/matches_reduce_branches.rs:19:13: 19:22\n++                                          // ty::Const\n++                                          // + ty: i32\n++                                          // + val: Value(Scalar(0x00000007))\n++                                          // mir::Constant\n++                                          // + span: $DIR/matches_reduce_branches.rs:1:1: 1:1\n++                                          // + literal: Const { ty: i32, val: Value(Scalar(0x00000007)) }\n++         _3 = Eq(_1, const 7_i32);        // scope 4 at $DIR/matches_reduce_branches.rs:20:13: 20:21\n++                                          // ty::Const\n++                                          // + ty: i32\n++                                          // + val: Value(Scalar(0x00000007))\n++                                          // mir::Constant\n++                                          // + span: $DIR/matches_reduce_branches.rs:1:1: 1:1\n++                                          // + literal: Const { ty: i32, val: Value(Scalar(0x00000007)) }\n++         _4 = const false;                // scope 4 at $DIR/matches_reduce_branches.rs:21:13: 21:22\n++                                          // ty::Const\n++                                          // + ty: bool\n++                                          // + val: Value(Scalar(0x00))\n++                                          // mir::Constant\n++                                          // + span: $DIR/matches_reduce_branches.rs:21:17: 21:22\n++                                          // + literal: Const { ty: bool, val: Value(Scalar(0x00)) }\n++         _5 = const true;                 // scope 4 at $DIR/matches_reduce_branches.rs:22:13: 22:21\n++                                          // ty::Const\n++                                          // + ty: bool\n++                                          // + val: Value(Scalar(0x01))\n++                                          // mir::Constant\n++                                          // + span: $DIR/matches_reduce_branches.rs:22:17: 22:21\n++                                          // + literal: Const { ty: bool, val: Value(Scalar(0x01)) }\n++         goto -> bb3;                     // scope 4 at $DIR/matches_reduce_branches.rs:18:9: 18:10\n+      }\n+  \n+      bb1: {\n+          _2 = const true;                 // scope 4 at $DIR/matches_reduce_branches.rs:26:13: 26:21\n+                                           // ty::Const\n+                                           // + ty: bool\n+                                           // + val: Value(Scalar(0x01))\n+                                           // mir::Constant\n+                                           // + span: $DIR/matches_reduce_branches.rs:26:17: 26:21\n+                                           // + literal: Const { ty: bool, val: Value(Scalar(0x01)) }\n+          _3 = const false;                // scope 4 at $DIR/matches_reduce_branches.rs:27:13: 27:22\n+                                           // ty::Const\n+                                           // + ty: bool\n+                                           // + val: Value(Scalar(0x00))\n+                                           // mir::Constant\n+                                           // + span: $DIR/matches_reduce_branches.rs:27:17: 27:22\n+                                           // + literal: Const { ty: bool, val: Value(Scalar(0x00)) }\n+          _4 = const false;                // scope 4 at $DIR/matches_reduce_branches.rs:28:13: 28:22\n+                                           // ty::Const\n+                                           // + ty: bool\n+                                           // + val: Value(Scalar(0x00))\n+                                           // mir::Constant\n+                                           // + span: $DIR/matches_reduce_branches.rs:28:17: 28:22\n+                                           // + literal: Const { ty: bool, val: Value(Scalar(0x00)) }\n+          _5 = const true;                 // scope 4 at $DIR/matches_reduce_branches.rs:29:13: 29:21\n+                                           // ty::Const\n+                                           // + ty: bool\n+                                           // + val: Value(Scalar(0x01))\n+                                           // mir::Constant\n+                                           // + span: $DIR/matches_reduce_branches.rs:29:17: 29:21\n+                                           // + literal: Const { ty: bool, val: Value(Scalar(0x01)) }\n+          goto -> bb3;                     // scope 4 at $DIR/matches_reduce_branches.rs:17:5: 32:6\n+      }\n+  \n+      bb2: {\n+          _2 = const false;                // scope 4 at $DIR/matches_reduce_branches.rs:19:13: 19:22\n+                                           // ty::Const\n+                                           // + ty: bool\n+                                           // + val: Value(Scalar(0x00))\n+                                           // mir::Constant\n+                                           // + span: $DIR/matches_reduce_branches.rs:19:17: 19:22\n+                                           // + literal: Const { ty: bool, val: Value(Scalar(0x00)) }\n+          _3 = const true;                 // scope 4 at $DIR/matches_reduce_branches.rs:20:13: 20:21\n+                                           // ty::Const\n+                                           // + ty: bool\n+                                           // + val: Value(Scalar(0x01))\n+                                           // mir::Constant\n+                                           // + span: $DIR/matches_reduce_branches.rs:20:17: 20:21\n+                                           // + literal: Const { ty: bool, val: Value(Scalar(0x01)) }\n+          _4 = const false;                // scope 4 at $DIR/matches_reduce_branches.rs:21:13: 21:22\n+                                           // ty::Const\n+                                           // + ty: bool\n+                                           // + val: Value(Scalar(0x00))\n+                                           // mir::Constant\n+                                           // + span: $DIR/matches_reduce_branches.rs:21:17: 21:22\n+                                           // + literal: Const { ty: bool, val: Value(Scalar(0x00)) }\n+          _5 = const true;                 // scope 4 at $DIR/matches_reduce_branches.rs:22:13: 22:21\n+                                           // ty::Const\n+                                           // + ty: bool\n+                                           // + val: Value(Scalar(0x01))\n+                                           // mir::Constant\n+                                           // + span: $DIR/matches_reduce_branches.rs:22:17: 22:21\n+                                           // + literal: Const { ty: bool, val: Value(Scalar(0x01)) }\n+          goto -> bb3;                     // scope 4 at $DIR/matches_reduce_branches.rs:17:5: 32:6\n+      }\n+  \n+      bb3: {\n+          StorageDead(_6);                 // scope 4 at $DIR/matches_reduce_branches.rs:32:6: 32:7\n+          StorageLive(_7);                 // scope 4 at $DIR/matches_reduce_branches.rs:34:6: 34:7\n+          _7 = _2;                         // scope 4 at $DIR/matches_reduce_branches.rs:34:6: 34:7\n+          StorageLive(_8);                 // scope 4 at $DIR/matches_reduce_branches.rs:34:9: 34:10\n+          _8 = _3;                         // scope 4 at $DIR/matches_reduce_branches.rs:34:9: 34:10\n+          StorageLive(_9);                 // scope 4 at $DIR/matches_reduce_branches.rs:34:12: 34:13\n+          _9 = _4;                         // scope 4 at $DIR/matches_reduce_branches.rs:34:12: 34:13\n+          StorageLive(_10);                // scope 4 at $DIR/matches_reduce_branches.rs:34:15: 34:16\n+          _10 = _5;                        // scope 4 at $DIR/matches_reduce_branches.rs:34:15: 34:16\n+          (_0.0: bool) = move _7;          // scope 4 at $DIR/matches_reduce_branches.rs:34:5: 34:17\n+          (_0.1: bool) = move _8;          // scope 4 at $DIR/matches_reduce_branches.rs:34:5: 34:17\n+          (_0.2: bool) = move _9;          // scope 4 at $DIR/matches_reduce_branches.rs:34:5: 34:17\n+          (_0.3: bool) = move _10;         // scope 4 at $DIR/matches_reduce_branches.rs:34:5: 34:17\n+          StorageDead(_10);                // scope 4 at $DIR/matches_reduce_branches.rs:34:16: 34:17\n+          StorageDead(_9);                 // scope 4 at $DIR/matches_reduce_branches.rs:34:16: 34:17\n+          StorageDead(_8);                 // scope 4 at $DIR/matches_reduce_branches.rs:34:16: 34:17\n+          StorageDead(_7);                 // scope 4 at $DIR/matches_reduce_branches.rs:34:16: 34:17\n+          StorageDead(_5);                 // scope 3 at $DIR/matches_reduce_branches.rs:35:1: 35:2\n+          StorageDead(_4);                 // scope 2 at $DIR/matches_reduce_branches.rs:35:1: 35:2\n+          StorageDead(_3);                 // scope 1 at $DIR/matches_reduce_branches.rs:35:1: 35:2\n+          StorageDead(_2);                 // scope 0 at $DIR/matches_reduce_branches.rs:35:1: 35:2\n+          return;                          // scope 0 at $DIR/matches_reduce_branches.rs:35:2: 35:2\n+      }\n+  }\n+  "}, {"sha": "968890e3a298c2ab0578145afb5a55ea2b19de3c", "filename": "src/test/mir-opt/matches_reduce_branches.bar.MatchBranchSimplification.diff.64bit", "status": "added", "additions": 156, "deletions": 0, "changes": 156, "blob_url": "https://github.com/rust-lang/rust/blob/b9db927b68f4b2e9c3e648be35b412ac1839ec54/src%2Ftest%2Fmir-opt%2Fmatches_reduce_branches.bar.MatchBranchSimplification.diff.64bit", "raw_url": "https://github.com/rust-lang/rust/raw/b9db927b68f4b2e9c3e648be35b412ac1839ec54/src%2Ftest%2Fmir-opt%2Fmatches_reduce_branches.bar.MatchBranchSimplification.diff.64bit", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fmatches_reduce_branches.bar.MatchBranchSimplification.diff.64bit?ref=b9db927b68f4b2e9c3e648be35b412ac1839ec54", "patch": "@@ -0,0 +1,156 @@\n+- // MIR for `bar` before MatchBranchSimplification\n++ // MIR for `bar` after MatchBranchSimplification\n+  \n+  fn bar(_1: i32) -> (bool, bool, bool, bool) {\n+      debug i => _1;                       // in scope 0 at $DIR/matches_reduce_branches.rs:11:8: 11:9\n+      let mut _0: (bool, bool, bool, bool); // return place in scope 0 at $DIR/matches_reduce_branches.rs:11:19: 11:43\n+      let _2: bool;                        // in scope 0 at $DIR/matches_reduce_branches.rs:12:9: 12:10\n+      let _6: ();                          // in scope 0 at $DIR/matches_reduce_branches.rs:17:5: 32:6\n+      let mut _7: bool;                    // in scope 0 at $DIR/matches_reduce_branches.rs:34:6: 34:7\n+      let mut _8: bool;                    // in scope 0 at $DIR/matches_reduce_branches.rs:34:9: 34:10\n+      let mut _9: bool;                    // in scope 0 at $DIR/matches_reduce_branches.rs:34:12: 34:13\n+      let mut _10: bool;                   // in scope 0 at $DIR/matches_reduce_branches.rs:34:15: 34:16\n+      scope 1 {\n+          debug a => _2;                   // in scope 1 at $DIR/matches_reduce_branches.rs:12:9: 12:10\n+          let _3: bool;                    // in scope 1 at $DIR/matches_reduce_branches.rs:13:9: 13:10\n+          scope 2 {\n+              debug b => _3;               // in scope 2 at $DIR/matches_reduce_branches.rs:13:9: 13:10\n+              let _4: bool;                // in scope 2 at $DIR/matches_reduce_branches.rs:14:9: 14:10\n+              scope 3 {\n+                  debug c => _4;           // in scope 3 at $DIR/matches_reduce_branches.rs:14:9: 14:10\n+                  let _5: bool;            // in scope 3 at $DIR/matches_reduce_branches.rs:15:9: 15:10\n+                  scope 4 {\n+                      debug d => _5;       // in scope 4 at $DIR/matches_reduce_branches.rs:15:9: 15:10\n+                  }\n+              }\n+          }\n+      }\n+  \n+      bb0: {\n+          StorageLive(_2);                 // scope 0 at $DIR/matches_reduce_branches.rs:12:9: 12:10\n+          StorageLive(_3);                 // scope 1 at $DIR/matches_reduce_branches.rs:13:9: 13:10\n+          StorageLive(_4);                 // scope 2 at $DIR/matches_reduce_branches.rs:14:9: 14:10\n+          StorageLive(_5);                 // scope 3 at $DIR/matches_reduce_branches.rs:15:9: 15:10\n+          StorageLive(_6);                 // scope 4 at $DIR/matches_reduce_branches.rs:17:5: 32:6\n+-         switchInt(_1) -> [7_i32: bb2, otherwise: bb1]; // scope 4 at $DIR/matches_reduce_branches.rs:18:9: 18:10\n++         _2 = Ne(_1, const 7_i32);        // scope 4 at $DIR/matches_reduce_branches.rs:19:13: 19:22\n++                                          // ty::Const\n++                                          // + ty: i32\n++                                          // + val: Value(Scalar(0x00000007))\n++                                          // mir::Constant\n++                                          // + span: $DIR/matches_reduce_branches.rs:1:1: 1:1\n++                                          // + literal: Const { ty: i32, val: Value(Scalar(0x00000007)) }\n++         _3 = Eq(_1, const 7_i32);        // scope 4 at $DIR/matches_reduce_branches.rs:20:13: 20:21\n++                                          // ty::Const\n++                                          // + ty: i32\n++                                          // + val: Value(Scalar(0x00000007))\n++                                          // mir::Constant\n++                                          // + span: $DIR/matches_reduce_branches.rs:1:1: 1:1\n++                                          // + literal: Const { ty: i32, val: Value(Scalar(0x00000007)) }\n++         _4 = const false;                // scope 4 at $DIR/matches_reduce_branches.rs:21:13: 21:22\n++                                          // ty::Const\n++                                          // + ty: bool\n++                                          // + val: Value(Scalar(0x00))\n++                                          // mir::Constant\n++                                          // + span: $DIR/matches_reduce_branches.rs:21:17: 21:22\n++                                          // + literal: Const { ty: bool, val: Value(Scalar(0x00)) }\n++         _5 = const true;                 // scope 4 at $DIR/matches_reduce_branches.rs:22:13: 22:21\n++                                          // ty::Const\n++                                          // + ty: bool\n++                                          // + val: Value(Scalar(0x01))\n++                                          // mir::Constant\n++                                          // + span: $DIR/matches_reduce_branches.rs:22:17: 22:21\n++                                          // + literal: Const { ty: bool, val: Value(Scalar(0x01)) }\n++         goto -> bb3;                     // scope 4 at $DIR/matches_reduce_branches.rs:18:9: 18:10\n+      }\n+  \n+      bb1: {\n+          _2 = const true;                 // scope 4 at $DIR/matches_reduce_branches.rs:26:13: 26:21\n+                                           // ty::Const\n+                                           // + ty: bool\n+                                           // + val: Value(Scalar(0x01))\n+                                           // mir::Constant\n+                                           // + span: $DIR/matches_reduce_branches.rs:26:17: 26:21\n+                                           // + literal: Const { ty: bool, val: Value(Scalar(0x01)) }\n+          _3 = const false;                // scope 4 at $DIR/matches_reduce_branches.rs:27:13: 27:22\n+                                           // ty::Const\n+                                           // + ty: bool\n+                                           // + val: Value(Scalar(0x00))\n+                                           // mir::Constant\n+                                           // + span: $DIR/matches_reduce_branches.rs:27:17: 27:22\n+                                           // + literal: Const { ty: bool, val: Value(Scalar(0x00)) }\n+          _4 = const false;                // scope 4 at $DIR/matches_reduce_branches.rs:28:13: 28:22\n+                                           // ty::Const\n+                                           // + ty: bool\n+                                           // + val: Value(Scalar(0x00))\n+                                           // mir::Constant\n+                                           // + span: $DIR/matches_reduce_branches.rs:28:17: 28:22\n+                                           // + literal: Const { ty: bool, val: Value(Scalar(0x00)) }\n+          _5 = const true;                 // scope 4 at $DIR/matches_reduce_branches.rs:29:13: 29:21\n+                                           // ty::Const\n+                                           // + ty: bool\n+                                           // + val: Value(Scalar(0x01))\n+                                           // mir::Constant\n+                                           // + span: $DIR/matches_reduce_branches.rs:29:17: 29:21\n+                                           // + literal: Const { ty: bool, val: Value(Scalar(0x01)) }\n+          goto -> bb3;                     // scope 4 at $DIR/matches_reduce_branches.rs:17:5: 32:6\n+      }\n+  \n+      bb2: {\n+          _2 = const false;                // scope 4 at $DIR/matches_reduce_branches.rs:19:13: 19:22\n+                                           // ty::Const\n+                                           // + ty: bool\n+                                           // + val: Value(Scalar(0x00))\n+                                           // mir::Constant\n+                                           // + span: $DIR/matches_reduce_branches.rs:19:17: 19:22\n+                                           // + literal: Const { ty: bool, val: Value(Scalar(0x00)) }\n+          _3 = const true;                 // scope 4 at $DIR/matches_reduce_branches.rs:20:13: 20:21\n+                                           // ty::Const\n+                                           // + ty: bool\n+                                           // + val: Value(Scalar(0x01))\n+                                           // mir::Constant\n+                                           // + span: $DIR/matches_reduce_branches.rs:20:17: 20:21\n+                                           // + literal: Const { ty: bool, val: Value(Scalar(0x01)) }\n+          _4 = const false;                // scope 4 at $DIR/matches_reduce_branches.rs:21:13: 21:22\n+                                           // ty::Const\n+                                           // + ty: bool\n+                                           // + val: Value(Scalar(0x00))\n+                                           // mir::Constant\n+                                           // + span: $DIR/matches_reduce_branches.rs:21:17: 21:22\n+                                           // + literal: Const { ty: bool, val: Value(Scalar(0x00)) }\n+          _5 = const true;                 // scope 4 at $DIR/matches_reduce_branches.rs:22:13: 22:21\n+                                           // ty::Const\n+                                           // + ty: bool\n+                                           // + val: Value(Scalar(0x01))\n+                                           // mir::Constant\n+                                           // + span: $DIR/matches_reduce_branches.rs:22:17: 22:21\n+                                           // + literal: Const { ty: bool, val: Value(Scalar(0x01)) }\n+          goto -> bb3;                     // scope 4 at $DIR/matches_reduce_branches.rs:17:5: 32:6\n+      }\n+  \n+      bb3: {\n+          StorageDead(_6);                 // scope 4 at $DIR/matches_reduce_branches.rs:32:6: 32:7\n+          StorageLive(_7);                 // scope 4 at $DIR/matches_reduce_branches.rs:34:6: 34:7\n+          _7 = _2;                         // scope 4 at $DIR/matches_reduce_branches.rs:34:6: 34:7\n+          StorageLive(_8);                 // scope 4 at $DIR/matches_reduce_branches.rs:34:9: 34:10\n+          _8 = _3;                         // scope 4 at $DIR/matches_reduce_branches.rs:34:9: 34:10\n+          StorageLive(_9);                 // scope 4 at $DIR/matches_reduce_branches.rs:34:12: 34:13\n+          _9 = _4;                         // scope 4 at $DIR/matches_reduce_branches.rs:34:12: 34:13\n+          StorageLive(_10);                // scope 4 at $DIR/matches_reduce_branches.rs:34:15: 34:16\n+          _10 = _5;                        // scope 4 at $DIR/matches_reduce_branches.rs:34:15: 34:16\n+          (_0.0: bool) = move _7;          // scope 4 at $DIR/matches_reduce_branches.rs:34:5: 34:17\n+          (_0.1: bool) = move _8;          // scope 4 at $DIR/matches_reduce_branches.rs:34:5: 34:17\n+          (_0.2: bool) = move _9;          // scope 4 at $DIR/matches_reduce_branches.rs:34:5: 34:17\n+          (_0.3: bool) = move _10;         // scope 4 at $DIR/matches_reduce_branches.rs:34:5: 34:17\n+          StorageDead(_10);                // scope 4 at $DIR/matches_reduce_branches.rs:34:16: 34:17\n+          StorageDead(_9);                 // scope 4 at $DIR/matches_reduce_branches.rs:34:16: 34:17\n+          StorageDead(_8);                 // scope 4 at $DIR/matches_reduce_branches.rs:34:16: 34:17\n+          StorageDead(_7);                 // scope 4 at $DIR/matches_reduce_branches.rs:34:16: 34:17\n+          StorageDead(_5);                 // scope 3 at $DIR/matches_reduce_branches.rs:35:1: 35:2\n+          StorageDead(_4);                 // scope 2 at $DIR/matches_reduce_branches.rs:35:1: 35:2\n+          StorageDead(_3);                 // scope 1 at $DIR/matches_reduce_branches.rs:35:1: 35:2\n+          StorageDead(_2);                 // scope 0 at $DIR/matches_reduce_branches.rs:35:1: 35:2\n+          return;                          // scope 0 at $DIR/matches_reduce_branches.rs:35:2: 35:2\n+      }\n+  }\n+  "}, {"sha": "a33db001f443825afa04d428fb934cc71d27b2e3", "filename": "src/test/mir-opt/matches_reduce_branches.foo.MatchBranchSimplification.diff.32bit", "status": "modified", "additions": 13, "deletions": 13, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/b9db927b68f4b2e9c3e648be35b412ac1839ec54/src%2Ftest%2Fmir-opt%2Fmatches_reduce_branches.foo.MatchBranchSimplification.diff.32bit", "raw_url": "https://github.com/rust-lang/rust/raw/b9db927b68f4b2e9c3e648be35b412ac1839ec54/src%2Ftest%2Fmir-opt%2Fmatches_reduce_branches.foo.MatchBranchSimplification.diff.32bit", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fmatches_reduce_branches.foo.MatchBranchSimplification.diff.32bit?ref=b9db927b68f4b2e9c3e648be35b412ac1839ec54", "patch": "@@ -2,23 +2,23 @@\n + // MIR for `foo` after MatchBranchSimplification\n   \n   fn foo(_1: std::option::Option<()>) -> () {\n-      debug bar => _1;                     // in scope 0 at $DIR/matches_reduce_branches.rs:4:8: 4:11\n-      let mut _0: ();                      // return place in scope 0 at $DIR/matches_reduce_branches.rs:4:25: 4:25\n+      debug bar => _1;                     // in scope 0 at $DIR/matches_reduce_branches.rs:5:8: 5:11\n+      let mut _0: ();                      // return place in scope 0 at $DIR/matches_reduce_branches.rs:5:25: 5:25\n       let mut _2: bool;                    // in scope 0 at $SRC_DIR/core/src/macros/mod.rs:LL:COL\n-      let mut _3: isize;                   // in scope 0 at $DIR/matches_reduce_branches.rs:5:22: 5:26\n+      let mut _3: isize;                   // in scope 0 at $DIR/matches_reduce_branches.rs:6:22: 6:26\n   \n       bb0: {\n           StorageLive(_2);                 // scope 0 at $SRC_DIR/core/src/macros/mod.rs:LL:COL\n-          _3 = discriminant(_1);           // scope 0 at $DIR/matches_reduce_branches.rs:5:22: 5:26\n--         switchInt(move _3) -> [0_isize: bb2, otherwise: bb1]; // scope 0 at $DIR/matches_reduce_branches.rs:5:22: 5:26\n-+         _2 = Eq(move _3, const 0_isize); // scope 0 at $SRC_DIR/core/src/macros/mod.rs:LL:COL\n+          _3 = discriminant(_1);           // scope 0 at $DIR/matches_reduce_branches.rs:6:22: 6:26\n+-         switchInt(move _3) -> [0_isize: bb2, otherwise: bb1]; // scope 0 at $DIR/matches_reduce_branches.rs:6:22: 6:26\n++         _2 = Eq(_3, const 0_isize);      // scope 0 at $SRC_DIR/core/src/macros/mod.rs:LL:COL\n +                                          // ty::Const\n +                                          // + ty: isize\n +                                          // + val: Value(Scalar(0x00000000))\n +                                          // mir::Constant\n +                                          // + span: $DIR/matches_reduce_branches.rs:1:1: 1:1\n +                                          // + literal: Const { ty: isize, val: Value(Scalar(0x00000000)) }\n-+         goto -> bb3;                     // scope 0 at $DIR/matches_reduce_branches.rs:5:22: 5:26\n++         goto -> bb3;                     // scope 0 at $DIR/matches_reduce_branches.rs:6:22: 6:26\n       }\n   \n       bb1: {\n@@ -44,23 +44,23 @@\n       }\n   \n       bb3: {\n-          switchInt(_2) -> [false: bb4, otherwise: bb5]; // scope 0 at $DIR/matches_reduce_branches.rs:5:5: 7:6\n+          switchInt(_2) -> [false: bb4, otherwise: bb5]; // scope 0 at $DIR/matches_reduce_branches.rs:6:5: 8:6\n       }\n   \n       bb4: {\n-          _0 = const ();                   // scope 0 at $DIR/matches_reduce_branches.rs:5:5: 7:6\n+          _0 = const ();                   // scope 0 at $DIR/matches_reduce_branches.rs:6:5: 8:6\n                                            // ty::Const\n                                            // + ty: ()\n                                            // + val: Value(Scalar(<ZST>))\n                                            // mir::Constant\n-                                           // + span: $DIR/matches_reduce_branches.rs:5:5: 7:6\n+                                           // + span: $DIR/matches_reduce_branches.rs:6:5: 8:6\n                                            // + literal: Const { ty: (), val: Value(Scalar(<ZST>)) }\n-          goto -> bb5;                     // scope 0 at $DIR/matches_reduce_branches.rs:5:5: 7:6\n+          goto -> bb5;                     // scope 0 at $DIR/matches_reduce_branches.rs:6:5: 8:6\n       }\n   \n       bb5: {\n-          StorageDead(_2);                 // scope 0 at $DIR/matches_reduce_branches.rs:8:1: 8:2\n-          return;                          // scope 0 at $DIR/matches_reduce_branches.rs:8:2: 8:2\n+          StorageDead(_2);                 // scope 0 at $DIR/matches_reduce_branches.rs:9:1: 9:2\n+          return;                          // scope 0 at $DIR/matches_reduce_branches.rs:9:2: 9:2\n       }\n   }\n   "}, {"sha": "3eb5b01fbf4960034dc09ef2ce9ff34e9a9394f5", "filename": "src/test/mir-opt/matches_reduce_branches.foo.MatchBranchSimplification.diff.64bit", "status": "modified", "additions": 13, "deletions": 13, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/b9db927b68f4b2e9c3e648be35b412ac1839ec54/src%2Ftest%2Fmir-opt%2Fmatches_reduce_branches.foo.MatchBranchSimplification.diff.64bit", "raw_url": "https://github.com/rust-lang/rust/raw/b9db927b68f4b2e9c3e648be35b412ac1839ec54/src%2Ftest%2Fmir-opt%2Fmatches_reduce_branches.foo.MatchBranchSimplification.diff.64bit", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fmatches_reduce_branches.foo.MatchBranchSimplification.diff.64bit?ref=b9db927b68f4b2e9c3e648be35b412ac1839ec54", "patch": "@@ -2,23 +2,23 @@\n + // MIR for `foo` after MatchBranchSimplification\n   \n   fn foo(_1: std::option::Option<()>) -> () {\n-      debug bar => _1;                     // in scope 0 at $DIR/matches_reduce_branches.rs:4:8: 4:11\n-      let mut _0: ();                      // return place in scope 0 at $DIR/matches_reduce_branches.rs:4:25: 4:25\n+      debug bar => _1;                     // in scope 0 at $DIR/matches_reduce_branches.rs:5:8: 5:11\n+      let mut _0: ();                      // return place in scope 0 at $DIR/matches_reduce_branches.rs:5:25: 5:25\n       let mut _2: bool;                    // in scope 0 at $SRC_DIR/core/src/macros/mod.rs:LL:COL\n-      let mut _3: isize;                   // in scope 0 at $DIR/matches_reduce_branches.rs:5:22: 5:26\n+      let mut _3: isize;                   // in scope 0 at $DIR/matches_reduce_branches.rs:6:22: 6:26\n   \n       bb0: {\n           StorageLive(_2);                 // scope 0 at $SRC_DIR/core/src/macros/mod.rs:LL:COL\n-          _3 = discriminant(_1);           // scope 0 at $DIR/matches_reduce_branches.rs:5:22: 5:26\n--         switchInt(move _3) -> [0_isize: bb2, otherwise: bb1]; // scope 0 at $DIR/matches_reduce_branches.rs:5:22: 5:26\n-+         _2 = Eq(move _3, const 0_isize); // scope 0 at $SRC_DIR/core/src/macros/mod.rs:LL:COL\n+          _3 = discriminant(_1);           // scope 0 at $DIR/matches_reduce_branches.rs:6:22: 6:26\n+-         switchInt(move _3) -> [0_isize: bb2, otherwise: bb1]; // scope 0 at $DIR/matches_reduce_branches.rs:6:22: 6:26\n++         _2 = Eq(_3, const 0_isize);      // scope 0 at $SRC_DIR/core/src/macros/mod.rs:LL:COL\n +                                          // ty::Const\n +                                          // + ty: isize\n +                                          // + val: Value(Scalar(0x0000000000000000))\n +                                          // mir::Constant\n +                                          // + span: $DIR/matches_reduce_branches.rs:1:1: 1:1\n +                                          // + literal: Const { ty: isize, val: Value(Scalar(0x0000000000000000)) }\n-+         goto -> bb3;                     // scope 0 at $DIR/matches_reduce_branches.rs:5:22: 5:26\n++         goto -> bb3;                     // scope 0 at $DIR/matches_reduce_branches.rs:6:22: 6:26\n       }\n   \n       bb1: {\n@@ -44,23 +44,23 @@\n       }\n   \n       bb3: {\n-          switchInt(_2) -> [false: bb4, otherwise: bb5]; // scope 0 at $DIR/matches_reduce_branches.rs:5:5: 7:6\n+          switchInt(_2) -> [false: bb4, otherwise: bb5]; // scope 0 at $DIR/matches_reduce_branches.rs:6:5: 8:6\n       }\n   \n       bb4: {\n-          _0 = const ();                   // scope 0 at $DIR/matches_reduce_branches.rs:5:5: 7:6\n+          _0 = const ();                   // scope 0 at $DIR/matches_reduce_branches.rs:6:5: 8:6\n                                            // ty::Const\n                                            // + ty: ()\n                                            // + val: Value(Scalar(<ZST>))\n                                            // mir::Constant\n-                                           // + span: $DIR/matches_reduce_branches.rs:5:5: 7:6\n+                                           // + span: $DIR/matches_reduce_branches.rs:6:5: 8:6\n                                            // + literal: Const { ty: (), val: Value(Scalar(<ZST>)) }\n-          goto -> bb5;                     // scope 0 at $DIR/matches_reduce_branches.rs:5:5: 7:6\n+          goto -> bb5;                     // scope 0 at $DIR/matches_reduce_branches.rs:6:5: 8:6\n       }\n   \n       bb5: {\n-          StorageDead(_2);                 // scope 0 at $DIR/matches_reduce_branches.rs:8:1: 8:2\n-          return;                          // scope 0 at $DIR/matches_reduce_branches.rs:8:2: 8:2\n+          StorageDead(_2);                 // scope 0 at $DIR/matches_reduce_branches.rs:9:1: 9:2\n+          return;                          // scope 0 at $DIR/matches_reduce_branches.rs:9:2: 9:2\n       }\n   }\n   "}, {"sha": "ebc88d2fbd1dacb113957cd4ddc1309766cde654", "filename": "src/test/mir-opt/matches_reduce_branches.rs", "status": "modified", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/b9db927b68f4b2e9c3e648be35b412ac1839ec54/src%2Ftest%2Fmir-opt%2Fmatches_reduce_branches.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b9db927b68f4b2e9c3e648be35b412ac1839ec54/src%2Ftest%2Fmir-opt%2Fmatches_reduce_branches.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fmatches_reduce_branches.rs?ref=b9db927b68f4b2e9c3e648be35b412ac1839ec54", "patch": "@@ -1,13 +1,42 @@\n // EMIT_MIR_FOR_EACH_BIT_WIDTH\n // EMIT_MIR matches_reduce_branches.foo.MatchBranchSimplification.diff\n+// EMIT_MIR matches_reduce_branches.bar.MatchBranchSimplification.diff\n \n fn foo(bar: Option<()>) {\n     if matches!(bar, None) {\n       ()\n     }\n }\n \n+fn bar(i: i32) -> (bool, bool, bool, bool) {\n+    let a;\n+    let b;\n+    let c;\n+    let d;\n+\n+    match i {\n+        7 => {\n+            a = false;\n+            b = true;\n+            c = false;\n+            d = true;\n+            ()\n+        }\n+        _ => {\n+            a = true;\n+            b = false;\n+            c = false;\n+            d = true;\n+            ()\n+        }\n+    };\n+\n+    (a, b, c, d)\n+}\n+\n+\n fn main() {\n   let _ = foo(None);\n   let _ = foo(Some(()));\n+  let _ = bar(0);\n }"}, {"sha": "c41bd999dc9fc0cec5afe931891a62ead8f1389c", "filename": "src/test/mir-opt/matches_u8.exhaustive_match.MatchBranchSimplification.diff.32bit", "status": "added", "additions": 40, "deletions": 0, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/b9db927b68f4b2e9c3e648be35b412ac1839ec54/src%2Ftest%2Fmir-opt%2Fmatches_u8.exhaustive_match.MatchBranchSimplification.diff.32bit", "raw_url": "https://github.com/rust-lang/rust/raw/b9db927b68f4b2e9c3e648be35b412ac1839ec54/src%2Ftest%2Fmir-opt%2Fmatches_u8.exhaustive_match.MatchBranchSimplification.diff.32bit", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fmatches_u8.exhaustive_match.MatchBranchSimplification.diff.32bit?ref=b9db927b68f4b2e9c3e648be35b412ac1839ec54", "patch": "@@ -0,0 +1,40 @@\n+- // MIR for `exhaustive_match` before MatchBranchSimplification\n++ // MIR for `exhaustive_match` after MatchBranchSimplification\n+  \n+  fn exhaustive_match(_1: E) -> u8 {\n+      debug e => _1;                       // in scope 0 at $DIR/matches_u8.rs:11:25: 11:26\n+      let mut _0: u8;                      // return place in scope 0 at $DIR/matches_u8.rs:11:34: 11:36\n+      let mut _2: isize;                   // in scope 0 at $DIR/matches_u8.rs:13:9: 13:13\n+  \n+      bb0: {\n+          _2 = discriminant(_1);           // scope 0 at $DIR/matches_u8.rs:13:9: 13:13\n+          switchInt(move _2) -> [0_isize: bb2, otherwise: bb1]; // scope 0 at $DIR/matches_u8.rs:13:9: 13:13\n+      }\n+  \n+      bb1: {\n+          _0 = const 1_u8;                 // scope 0 at $DIR/matches_u8.rs:14:17: 14:18\n+                                           // ty::Const\n+                                           // + ty: u8\n+                                           // + val: Value(Scalar(0x01))\n+                                           // mir::Constant\n+                                           // + span: $DIR/matches_u8.rs:14:17: 14:18\n+                                           // + literal: Const { ty: u8, val: Value(Scalar(0x01)) }\n+          goto -> bb3;                     // scope 0 at $DIR/matches_u8.rs:12:5: 15:6\n+      }\n+  \n+      bb2: {\n+          _0 = const 0_u8;                 // scope 0 at $DIR/matches_u8.rs:13:17: 13:18\n+                                           // ty::Const\n+                                           // + ty: u8\n+                                           // + val: Value(Scalar(0x00))\n+                                           // mir::Constant\n+                                           // + span: $DIR/matches_u8.rs:13:17: 13:18\n+                                           // + literal: Const { ty: u8, val: Value(Scalar(0x00)) }\n+          goto -> bb3;                     // scope 0 at $DIR/matches_u8.rs:12:5: 15:6\n+      }\n+  \n+      bb3: {\n+          return;                          // scope 0 at $DIR/matches_u8.rs:16:2: 16:2\n+      }\n+  }\n+  "}, {"sha": "c41bd999dc9fc0cec5afe931891a62ead8f1389c", "filename": "src/test/mir-opt/matches_u8.exhaustive_match.MatchBranchSimplification.diff.64bit", "status": "added", "additions": 40, "deletions": 0, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/b9db927b68f4b2e9c3e648be35b412ac1839ec54/src%2Ftest%2Fmir-opt%2Fmatches_u8.exhaustive_match.MatchBranchSimplification.diff.64bit", "raw_url": "https://github.com/rust-lang/rust/raw/b9db927b68f4b2e9c3e648be35b412ac1839ec54/src%2Ftest%2Fmir-opt%2Fmatches_u8.exhaustive_match.MatchBranchSimplification.diff.64bit", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fmatches_u8.exhaustive_match.MatchBranchSimplification.diff.64bit?ref=b9db927b68f4b2e9c3e648be35b412ac1839ec54", "patch": "@@ -0,0 +1,40 @@\n+- // MIR for `exhaustive_match` before MatchBranchSimplification\n++ // MIR for `exhaustive_match` after MatchBranchSimplification\n+  \n+  fn exhaustive_match(_1: E) -> u8 {\n+      debug e => _1;                       // in scope 0 at $DIR/matches_u8.rs:11:25: 11:26\n+      let mut _0: u8;                      // return place in scope 0 at $DIR/matches_u8.rs:11:34: 11:36\n+      let mut _2: isize;                   // in scope 0 at $DIR/matches_u8.rs:13:9: 13:13\n+  \n+      bb0: {\n+          _2 = discriminant(_1);           // scope 0 at $DIR/matches_u8.rs:13:9: 13:13\n+          switchInt(move _2) -> [0_isize: bb2, otherwise: bb1]; // scope 0 at $DIR/matches_u8.rs:13:9: 13:13\n+      }\n+  \n+      bb1: {\n+          _0 = const 1_u8;                 // scope 0 at $DIR/matches_u8.rs:14:17: 14:18\n+                                           // ty::Const\n+                                           // + ty: u8\n+                                           // + val: Value(Scalar(0x01))\n+                                           // mir::Constant\n+                                           // + span: $DIR/matches_u8.rs:14:17: 14:18\n+                                           // + literal: Const { ty: u8, val: Value(Scalar(0x01)) }\n+          goto -> bb3;                     // scope 0 at $DIR/matches_u8.rs:12:5: 15:6\n+      }\n+  \n+      bb2: {\n+          _0 = const 0_u8;                 // scope 0 at $DIR/matches_u8.rs:13:17: 13:18\n+                                           // ty::Const\n+                                           // + ty: u8\n+                                           // + val: Value(Scalar(0x00))\n+                                           // mir::Constant\n+                                           // + span: $DIR/matches_u8.rs:13:17: 13:18\n+                                           // + literal: Const { ty: u8, val: Value(Scalar(0x00)) }\n+          goto -> bb3;                     // scope 0 at $DIR/matches_u8.rs:12:5: 15:6\n+      }\n+  \n+      bb3: {\n+          return;                          // scope 0 at $DIR/matches_u8.rs:16:2: 16:2\n+      }\n+  }\n+  "}, {"sha": "2c4bbc8095e9af7fbc1762ff4692aae9131f7dce", "filename": "src/test/mir-opt/matches_u8.exhaustive_match_i8.MatchBranchSimplification.diff.32bit", "status": "added", "additions": 40, "deletions": 0, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/b9db927b68f4b2e9c3e648be35b412ac1839ec54/src%2Ftest%2Fmir-opt%2Fmatches_u8.exhaustive_match_i8.MatchBranchSimplification.diff.32bit", "raw_url": "https://github.com/rust-lang/rust/raw/b9db927b68f4b2e9c3e648be35b412ac1839ec54/src%2Ftest%2Fmir-opt%2Fmatches_u8.exhaustive_match_i8.MatchBranchSimplification.diff.32bit", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fmatches_u8.exhaustive_match_i8.MatchBranchSimplification.diff.32bit?ref=b9db927b68f4b2e9c3e648be35b412ac1839ec54", "patch": "@@ -0,0 +1,40 @@\n+- // MIR for `exhaustive_match_i8` before MatchBranchSimplification\n++ // MIR for `exhaustive_match_i8` after MatchBranchSimplification\n+  \n+  fn exhaustive_match_i8(_1: E) -> i8 {\n+      debug e => _1;                       // in scope 0 at $DIR/matches_u8.rs:19:28: 19:29\n+      let mut _0: i8;                      // return place in scope 0 at $DIR/matches_u8.rs:19:37: 19:39\n+      let mut _2: isize;                   // in scope 0 at $DIR/matches_u8.rs:21:9: 21:13\n+  \n+      bb0: {\n+          _2 = discriminant(_1);           // scope 0 at $DIR/matches_u8.rs:21:9: 21:13\n+          switchInt(move _2) -> [0_isize: bb2, otherwise: bb1]; // scope 0 at $DIR/matches_u8.rs:21:9: 21:13\n+      }\n+  \n+      bb1: {\n+          _0 = const 1_i8;                 // scope 0 at $DIR/matches_u8.rs:22:17: 22:18\n+                                           // ty::Const\n+                                           // + ty: i8\n+                                           // + val: Value(Scalar(0x01))\n+                                           // mir::Constant\n+                                           // + span: $DIR/matches_u8.rs:22:17: 22:18\n+                                           // + literal: Const { ty: i8, val: Value(Scalar(0x01)) }\n+          goto -> bb3;                     // scope 0 at $DIR/matches_u8.rs:20:5: 23:6\n+      }\n+  \n+      bb2: {\n+          _0 = const 0_i8;                 // scope 0 at $DIR/matches_u8.rs:21:17: 21:18\n+                                           // ty::Const\n+                                           // + ty: i8\n+                                           // + val: Value(Scalar(0x00))\n+                                           // mir::Constant\n+                                           // + span: $DIR/matches_u8.rs:21:17: 21:18\n+                                           // + literal: Const { ty: i8, val: Value(Scalar(0x00)) }\n+          goto -> bb3;                     // scope 0 at $DIR/matches_u8.rs:20:5: 23:6\n+      }\n+  \n+      bb3: {\n+          return;                          // scope 0 at $DIR/matches_u8.rs:24:2: 24:2\n+      }\n+  }\n+  "}, {"sha": "2c4bbc8095e9af7fbc1762ff4692aae9131f7dce", "filename": "src/test/mir-opt/matches_u8.exhaustive_match_i8.MatchBranchSimplification.diff.64bit", "status": "added", "additions": 40, "deletions": 0, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/b9db927b68f4b2e9c3e648be35b412ac1839ec54/src%2Ftest%2Fmir-opt%2Fmatches_u8.exhaustive_match_i8.MatchBranchSimplification.diff.64bit", "raw_url": "https://github.com/rust-lang/rust/raw/b9db927b68f4b2e9c3e648be35b412ac1839ec54/src%2Ftest%2Fmir-opt%2Fmatches_u8.exhaustive_match_i8.MatchBranchSimplification.diff.64bit", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fmatches_u8.exhaustive_match_i8.MatchBranchSimplification.diff.64bit?ref=b9db927b68f4b2e9c3e648be35b412ac1839ec54", "patch": "@@ -0,0 +1,40 @@\n+- // MIR for `exhaustive_match_i8` before MatchBranchSimplification\n++ // MIR for `exhaustive_match_i8` after MatchBranchSimplification\n+  \n+  fn exhaustive_match_i8(_1: E) -> i8 {\n+      debug e => _1;                       // in scope 0 at $DIR/matches_u8.rs:19:28: 19:29\n+      let mut _0: i8;                      // return place in scope 0 at $DIR/matches_u8.rs:19:37: 19:39\n+      let mut _2: isize;                   // in scope 0 at $DIR/matches_u8.rs:21:9: 21:13\n+  \n+      bb0: {\n+          _2 = discriminant(_1);           // scope 0 at $DIR/matches_u8.rs:21:9: 21:13\n+          switchInt(move _2) -> [0_isize: bb2, otherwise: bb1]; // scope 0 at $DIR/matches_u8.rs:21:9: 21:13\n+      }\n+  \n+      bb1: {\n+          _0 = const 1_i8;                 // scope 0 at $DIR/matches_u8.rs:22:17: 22:18\n+                                           // ty::Const\n+                                           // + ty: i8\n+                                           // + val: Value(Scalar(0x01))\n+                                           // mir::Constant\n+                                           // + span: $DIR/matches_u8.rs:22:17: 22:18\n+                                           // + literal: Const { ty: i8, val: Value(Scalar(0x01)) }\n+          goto -> bb3;                     // scope 0 at $DIR/matches_u8.rs:20:5: 23:6\n+      }\n+  \n+      bb2: {\n+          _0 = const 0_i8;                 // scope 0 at $DIR/matches_u8.rs:21:17: 21:18\n+                                           // ty::Const\n+                                           // + ty: i8\n+                                           // + val: Value(Scalar(0x00))\n+                                           // mir::Constant\n+                                           // + span: $DIR/matches_u8.rs:21:17: 21:18\n+                                           // + literal: Const { ty: i8, val: Value(Scalar(0x00)) }\n+          goto -> bb3;                     // scope 0 at $DIR/matches_u8.rs:20:5: 23:6\n+      }\n+  \n+      bb3: {\n+          return;                          // scope 0 at $DIR/matches_u8.rs:24:2: 24:2\n+      }\n+  }\n+  "}, {"sha": "78373be48b6854d5efdbb6cf5ef0c85881eb677d", "filename": "src/test/mir-opt/matches_u8.rs", "status": "added", "additions": 32, "deletions": 0, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/b9db927b68f4b2e9c3e648be35b412ac1839ec54/src%2Ftest%2Fmir-opt%2Fmatches_u8.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b9db927b68f4b2e9c3e648be35b412ac1839ec54/src%2Ftest%2Fmir-opt%2Fmatches_u8.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fmatches_u8.rs?ref=b9db927b68f4b2e9c3e648be35b412ac1839ec54", "patch": "@@ -0,0 +1,32 @@\n+// EMIT_MIR_FOR_EACH_BIT_WIDTH\n+// EMIT_MIR matches_u8.exhaustive_match.MatchBranchSimplification.diff\n+// EMIT_MIR matches_u8.exhaustive_match_i8.MatchBranchSimplification.diff\n+\n+pub enum E {\n+    A,\n+    B,\n+}\n+\n+#[no_mangle]\n+pub fn exhaustive_match(e: E) -> u8 {\n+    match e {\n+        E::A => 0,\n+        E::B => 1,\n+    }\n+}\n+\n+#[no_mangle]\n+pub fn exhaustive_match_i8(e: E) -> i8 {\n+    match e {\n+        E::A => 0,\n+        E::B => 1,\n+    }\n+}\n+\n+fn main() {\n+  assert_eq!(exhaustive_match(E::A), 0);\n+  assert_eq!(exhaustive_match(E::B), 1);\n+\n+  assert_eq!(exhaustive_match_i8(E::A), 0);\n+  assert_eq!(exhaustive_match_i8(E::B), 1);\n+}"}]}