{"sha": "ead2c4f1222c7c9023f02bf6dceaa49eb987c716", "node_id": "C_kwDOAAsO6NoAKGVhZDJjNGYxMjIyYzdjOTAyM2YwMmJmNmRjZWFhNDllYjk4N2M3MTY", "commit": {"author": {"name": "Marcel Hellwig", "email": "github@cookiesoft.de", "date": "2022-07-07T10:24:17Z"}, "committer": {"name": "Marcel Hellwig", "email": "github@cookiesoft.de", "date": "2022-07-07T10:43:16Z"}, "message": "fix incorrect suggestion for maybe trait bounds", "tree": {"sha": "f8c3b15386e215d627e085afe5e96272f9ea3a36", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f8c3b15386e215d627e085afe5e96272f9ea3a36"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ead2c4f1222c7c9023f02bf6dceaa49eb987c716", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ead2c4f1222c7c9023f02bf6dceaa49eb987c716", "html_url": "https://github.com/rust-lang/rust/commit/ead2c4f1222c7c9023f02bf6dceaa49eb987c716", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ead2c4f1222c7c9023f02bf6dceaa49eb987c716/comments", "author": {"login": "hellow554", "id": 921462, "node_id": "MDQ6VXNlcjkyMTQ2Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/921462?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hellow554", "html_url": "https://github.com/hellow554", "followers_url": "https://api.github.com/users/hellow554/followers", "following_url": "https://api.github.com/users/hellow554/following{/other_user}", "gists_url": "https://api.github.com/users/hellow554/gists{/gist_id}", "starred_url": "https://api.github.com/users/hellow554/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hellow554/subscriptions", "organizations_url": "https://api.github.com/users/hellow554/orgs", "repos_url": "https://api.github.com/users/hellow554/repos", "events_url": "https://api.github.com/users/hellow554/events{/privacy}", "received_events_url": "https://api.github.com/users/hellow554/received_events", "type": "User", "site_admin": false}, "committer": {"login": "hellow554", "id": 921462, "node_id": "MDQ6VXNlcjkyMTQ2Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/921462?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hellow554", "html_url": "https://github.com/hellow554", "followers_url": "https://api.github.com/users/hellow554/followers", "following_url": "https://api.github.com/users/hellow554/following{/other_user}", "gists_url": "https://api.github.com/users/hellow554/gists{/gist_id}", "starred_url": "https://api.github.com/users/hellow554/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hellow554/subscriptions", "organizations_url": "https://api.github.com/users/hellow554/orgs", "repos_url": "https://api.github.com/users/hellow554/repos", "events_url": "https://api.github.com/users/hellow554/events{/privacy}", "received_events_url": "https://api.github.com/users/hellow554/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f2bef55389e3e053cab50d91a674739d8a1ca036", "url": "https://api.github.com/repos/rust-lang/rust/commits/f2bef55389e3e053cab50d91a674739d8a1ca036", "html_url": "https://github.com/rust-lang/rust/commit/f2bef55389e3e053cab50d91a674739d8a1ca036"}], "stats": {"total": 49, "additions": 43, "deletions": 6}, "files": [{"sha": "2741179074bd5c50d60fdfc9a840579892aa6577", "filename": "clippy_lints/src/trait_bounds.rs", "status": "modified", "additions": 14, "deletions": 5, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/ead2c4f1222c7c9023f02bf6dceaa49eb987c716/clippy_lints%2Fsrc%2Ftrait_bounds.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ead2c4f1222c7c9023f02bf6dceaa49eb987c716/clippy_lints%2Fsrc%2Ftrait_bounds.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Ftrait_bounds.rs?ref=ead2c4f1222c7c9023f02bf6dceaa49eb987c716", "patch": "@@ -9,12 +9,12 @@ use rustc_data_structures::unhash::UnhashMap;\n use rustc_errors::Applicability;\n use rustc_hir::def::Res;\n use rustc_hir::{\n-    GenericBound, Generics, Item, ItemKind, Node, Path, PathSegment, PredicateOrigin, QPath, TraitItem, Ty, TyKind,\n-    WherePredicate,\n+    GenericBound, Generics, Item, ItemKind, Node, Path, PathSegment, PredicateOrigin, QPath, TraitBoundModifier,\n+    TraitItem, Ty, TyKind, WherePredicate,\n };\n use rustc_lint::{LateContext, LateLintPass};\n use rustc_session::{declare_tool_lint, impl_lint_pass};\n-use rustc_span::Span;\n+use rustc_span::{BytePos, Span};\n \n declare_clippy_lint! {\n     /// ### What it does\n@@ -242,8 +242,17 @@ fn check_trait_bound_duplication(cx: &LateContext<'_>, gen: &'_ Generics<'_>) {\n }\n \n fn get_trait_info_from_bound<'a>(bound: &'a GenericBound<'_>) -> Option<(Res, &'a [PathSegment<'a>], Span)> {\n-    if let GenericBound::Trait(t, _) = bound {\n-        Some((t.trait_ref.path.res, t.trait_ref.path.segments, t.span))\n+    if let GenericBound::Trait(t, tbm) = bound {\n+        let trait_path = t.trait_ref.path;\n+        let trait_span = {\n+            let path_span = trait_path.span;\n+            if let TraitBoundModifier::Maybe = tbm {\n+                path_span.with_lo(path_span.lo() - BytePos(1)) // include the `?`\n+            } else {\n+                path_span\n+            }\n+        };\n+        Some((trait_path.res, trait_path.segments, trait_span))\n     } else {\n         None\n     }"}, {"sha": "2eca1f4701c9fdaeccb0da0160b67bea538f4da1", "filename": "tests/ui/type_repetition_in_bounds.rs", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/ead2c4f1222c7c9023f02bf6dceaa49eb987c716/tests%2Fui%2Ftype_repetition_in_bounds.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ead2c4f1222c7c9023f02bf6dceaa49eb987c716/tests%2Fui%2Ftype_repetition_in_bounds.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ftype_repetition_in_bounds.rs?ref=ead2c4f1222c7c9023f02bf6dceaa49eb987c716", "patch": "@@ -79,6 +79,18 @@ where\n     u: U,\n }\n \n+// Check for the `?` in `?Sized`\n+pub fn f<T: ?Sized>()\n+where\n+    T: Clone,\n+{\n+}\n+pub fn g<T: Clone>()\n+where\n+    T: ?Sized,\n+{\n+}\n+\n // This should not lint\n fn impl_trait(_: impl AsRef<str>, _: impl AsRef<str>) {}\n "}, {"sha": "1d88714814d477007bc0dc6afc60f0fee9bb95a4", "filename": "tests/ui/type_repetition_in_bounds.stderr", "status": "modified", "additions": 17, "deletions": 1, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/ead2c4f1222c7c9023f02bf6dceaa49eb987c716/tests%2Fui%2Ftype_repetition_in_bounds.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/ead2c4f1222c7c9023f02bf6dceaa49eb987c716/tests%2Fui%2Ftype_repetition_in_bounds.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ftype_repetition_in_bounds.stderr?ref=ead2c4f1222c7c9023f02bf6dceaa49eb987c716", "patch": "@@ -19,5 +19,21 @@ LL |     Self: Copy + Default + Ord,\n    |\n    = help: consider combining the bounds: `Self: Clone + Copy + Default + Ord`\n \n-error: aborting due to 2 previous errors\n+error: this type has already been used as a bound predicate\n+  --> $DIR/type_repetition_in_bounds.rs:85:5\n+   |\n+LL |     T: Clone,\n+   |     ^^^^^^^^\n+   |\n+   = help: consider combining the bounds: `T: ?Sized + Clone`\n+\n+error: this type has already been used as a bound predicate\n+  --> $DIR/type_repetition_in_bounds.rs:90:5\n+   |\n+LL |     T: ?Sized,\n+   |     ^^^^^^^^^\n+   |\n+   = help: consider combining the bounds: `T: Clone + ?Sized`\n+\n+error: aborting due to 4 previous errors\n "}]}