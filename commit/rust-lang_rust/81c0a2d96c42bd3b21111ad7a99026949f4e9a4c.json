{"sha": "81c0a2d96c42bd3b21111ad7a99026949f4e9a4c", "node_id": "C_kwDOAAsO6NoAKDgxYzBhMmQ5NmM0MmJkM2IyMTExMWFkN2E5OTAyNjk0OWY0ZTlhNGM", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2022-05-11T04:16:30Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-05-11T04:16:30Z"}, "message": "Rollup merge of #96543 - nnethercote:rm-make_token_stream-hacks, r=Aaron1011\n\nRemove hacks in `make_token_stream`.\n\n`make_tokenstream` has three commented hacks, and a comment at the top\nreferring to #67062. These hacks have no observable effect, at least as judged\nby running the test suite. The hacks were added in #82608, with an explanation\n[here](https://github.com/rust-lang/rust/pull/82608#issuecomment-812877329). It\nappears that one of the following is true: (a) they never did anything useful,\n(b) they do something useful but we have no test coverage for them, or (c)\nsomething has changed in the meantime that means they are no longer necessary.\n\nThis commit removes the hacks and the comments, in the hope that (b) is not\ntrue.\n\nr? `@Aaron1011`", "tree": {"sha": "791724bf90207794f4b7803ec455dc2d1badcb16", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/791724bf90207794f4b7803ec455dc2d1badcb16"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/81c0a2d96c42bd3b21111ad7a99026949f4e9a4c", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJiezieCRBK7hj4Ov3rIwAAMKEIAKeHMuIVkV6ZGoozHMGwU/we\n6XzFbXbU4vy1FtK8O9JqbAvD+qyC86FNoWotBEkKeBXRI4gc6xE9EMXZbq0nsh5t\nBjONHe+1dv0XeOXmrZs/3HFJi65NXgudwO+OioGQhbcsMZf5wfBURyXHfMEx6XEV\nTsgTgeeZGxMy+Z9z41ShgCp/Bi1jAFDEAuonacLeqf5gub/OupCqj1TB9unxf8Gd\nooYjtSZNLkiQvW3TgO6wi7a664KPvbBLPwpKq0ck5D7Ndvnh/aDAQ5W5m4LmErlH\nPUL5Sl+YasLQ/1yyJmUDBEsOlg3d/gj2qQX0xa/29OCtLgDSY+vbVF540aQosjk=\n=eaq4\n-----END PGP SIGNATURE-----\n", "payload": "tree 791724bf90207794f4b7803ec455dc2d1badcb16\nparent 532be942ddf8f40d086e54d157453434b16e9647\nparent 3cd8e9866d55ddd962e6bda92018cbf4bc9ee08f\nauthor Yuki Okushi <jtitor@2k36.org> 1652242590 +0900\ncommitter GitHub <noreply@github.com> 1652242590 +0900\n\nRollup merge of #96543 - nnethercote:rm-make_token_stream-hacks, r=Aaron1011\n\nRemove hacks in `make_token_stream`.\n\n`make_tokenstream` has three commented hacks, and a comment at the top\nreferring to #67062. These hacks have no observable effect, at least as judged\nby running the test suite. The hacks were added in #82608, with an explanation\n[here](https://github.com/rust-lang/rust/pull/82608#issuecomment-812877329). It\nappears that one of the following is true: (a) they never did anything useful,\n(b) they do something useful but we have no test coverage for them, or (c)\nsomething has changed in the meantime that means they are no longer necessary.\n\nThis commit removes the hacks and the comments, in the hope that (b) is not\ntrue.\n\nr? `@Aaron1011`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/81c0a2d96c42bd3b21111ad7a99026949f4e9a4c", "html_url": "https://github.com/rust-lang/rust/commit/81c0a2d96c42bd3b21111ad7a99026949f4e9a4c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/81c0a2d96c42bd3b21111ad7a99026949f4e9a4c/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "532be942ddf8f40d086e54d157453434b16e9647", "url": "https://api.github.com/repos/rust-lang/rust/commits/532be942ddf8f40d086e54d157453434b16e9647", "html_url": "https://github.com/rust-lang/rust/commit/532be942ddf8f40d086e54d157453434b16e9647"}, {"sha": "3cd8e9866d55ddd962e6bda92018cbf4bc9ee08f", "url": "https://api.github.com/repos/rust-lang/rust/commits/3cd8e9866d55ddd962e6bda92018cbf4bc9ee08f", "html_url": "https://github.com/rust-lang/rust/commit/3cd8e9866d55ddd962e6bda92018cbf4bc9ee08f"}], "stats": {"total": 45, "additions": 2, "deletions": 43}, "files": [{"sha": "66db5bf9d7cf2266bc08294892cb82c77b9100df", "filename": "compiler/rustc_parse/src/parser/attr_wrapper.rs", "status": "modified", "additions": 0, "deletions": 38, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/81c0a2d96c42bd3b21111ad7a99026949f4e9a4c/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fattr_wrapper.rs", "raw_url": "https://github.com/rust-lang/rust/raw/81c0a2d96c42bd3b21111ad7a99026949f4e9a4c/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fattr_wrapper.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fattr_wrapper.rs?ref=81c0a2d96c42bd3b21111ad7a99026949f4e9a4c", "patch": "@@ -388,12 +388,6 @@ impl<'a> Parser<'a> {\n /// Converts a flattened iterator of tokens (including open and close delimiter tokens)\n /// into a `TokenStream`, creating a `TokenTree::Delimited` for each matching pair\n /// of open and close delims.\n-// FIXME(#67062): Currently, we don't parse `Invisible`-delimited groups correctly,\n-// which can cause us to end up with mismatched `Invisible` delimiters in our\n-// captured tokens. This function contains several hacks to work around this -\n-// essentially, we throw away mismatched `Invisible` delimiters when we encounter them.\n-// Once we properly parse `Invisible` delimiters, they can be captured just like any\n-// other tokens, and these hacks can be removed.\n fn make_token_stream(\n     mut iter: impl Iterator<Item = (FlatToken, Spacing)>,\n     break_last_token: bool,\n@@ -412,35 +406,10 @@ fn make_token_stream(\n                 stack.push(FrameData { open_delim_sp: Some((delim, span)), inner: vec![] });\n             }\n             FlatToken::Token(Token { kind: TokenKind::CloseDelim(delim), span }) => {\n-                // HACK: If we encounter a mismatched `Invisible` delimiter at the top\n-                // level, just ignore it.\n-                if matches!(delim, Delimiter::Invisible)\n-                    && (stack.len() == 1\n-                        || !matches!(\n-                            stack.last_mut().unwrap().open_delim_sp.unwrap().0,\n-                            Delimiter::Invisible\n-                        ))\n-                {\n-                    token_and_spacing = iter.next();\n-                    continue;\n-                }\n                 let frame_data = stack\n                     .pop()\n                     .unwrap_or_else(|| panic!(\"Token stack was empty for token: {:?}\", token));\n \n-                // HACK: If our current frame has a mismatched opening `Invisible` delimiter,\n-                // merge our current frame with the one above it. That is, transform\n-                // `[ { < first second } third ]` into `[ { first second } third ]`\n-                if !matches!(delim, Delimiter::Invisible)\n-                    && matches!(frame_data.open_delim_sp.unwrap().0, Delimiter::Invisible)\n-                {\n-                    stack.last_mut().unwrap().inner.extend(frame_data.inner);\n-                    // Process our closing delimiter again, this time at the previous\n-                    // frame in the stack\n-                    token_and_spacing = Some((token, spacing));\n-                    continue;\n-                }\n-\n                 let (open_delim, open_sp) = frame_data.open_delim_sp.unwrap();\n                 assert_eq!(\n                     open_delim, delim,\n@@ -472,13 +441,6 @@ fn make_token_stream(\n         }\n         token_and_spacing = iter.next();\n     }\n-    // HACK: If we don't have a closing `Invisible` delimiter for our last\n-    // frame, merge the frame with the top-level frame. That is,\n-    // turn `< first second` into `first second`\n-    if stack.len() == 2 && stack[1].open_delim_sp.unwrap().0 == Delimiter::Invisible {\n-        let temp_buf = stack.pop().unwrap();\n-        stack.last_mut().unwrap().inner.extend(temp_buf.inner);\n-    }\n     let mut final_buf = stack.pop().expect(\"Missing final buf!\");\n     if break_last_token {\n         let (last_token, spacing) = final_buf.inner.pop().unwrap();"}, {"sha": "369650edd57d0e4ccab84d313f6c0b03904dd8f3", "filename": "compiler/rustc_parse/src/parser/diagnostics.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/81c0a2d96c42bd3b21111ad7a99026949f4e9a4c/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/81c0a2d96c42bd3b21111ad7a99026949f4e9a4c/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse%2Fsrc%2Fparser%2Fdiagnostics.rs?ref=81c0a2d96c42bd3b21111ad7a99026949f4e9a4c", "patch": "@@ -2109,8 +2109,7 @@ impl<'a> Parser<'a> {\n                     brace_depth -= 1;\n                     continue;\n                 }\n-            } else if self.token == token::Eof || self.eat(&token::CloseDelim(Delimiter::Invisible))\n-            {\n+            } else if self.token == token::Eof {\n                 return;\n             } else {\n                 self.bump();"}, {"sha": "67f3985926e2f0a9af26fd4d0ab6f5bfdd6bd20d", "filename": "src/tools/rustfmt/src/parse/macros/mod.rs", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/81c0a2d96c42bd3b21111ad7a99026949f4e9a4c/src%2Ftools%2Frustfmt%2Fsrc%2Fparse%2Fmacros%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/81c0a2d96c42bd3b21111ad7a99026949f4e9a4c/src%2Ftools%2Frustfmt%2Fsrc%2Fparse%2Fmacros%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Frustfmt%2Fsrc%2Fparse%2Fmacros%2Fmod.rs?ref=81c0a2d96c42bd3b21111ad7a99026949f4e9a4c", "patch": "@@ -79,9 +79,7 @@ fn check_keyword<'a, 'b: 'a>(parser: &'a mut Parser<'b>) -> Option<MacroArg> {\n     for &keyword in RUST_KW.iter() {\n         if parser.token.is_keyword(keyword)\n             && parser.look_ahead(1, |t| {\n-                t.kind == TokenKind::Eof\n-                    || t.kind == TokenKind::Comma\n-                    || t.kind == TokenKind::CloseDelim(Delimiter::Invisible)\n+                t.kind == TokenKind::Eof || t.kind == TokenKind::Comma\n             })\n         {\n             parser.bump();"}]}