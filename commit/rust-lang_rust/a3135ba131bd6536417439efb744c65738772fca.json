{"sha": "a3135ba131bd6536417439efb744c65738772fca", "node_id": "MDY6Q29tbWl0NzI0NzEyOmEzMTM1YmExMzFiZDY1MzY0MTc0MzllZmI3NDRjNjU3Mzg3NzJmY2E=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-02-06T14:17:35Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-02-06T14:17:35Z"}, "message": "Auto merge of #5132 - JohnTitor:fix-fp-in-unwrap-lint, r=flip1995\n\nDo not lint `unnecessary_unwrap` in external macros\n\nFixes #5131\n\nI think we shouldn't lint `{panicking, unnecessary}_unwrap` in macros, not just `assert!`.\n\nchangelog: Fix false positive in `unnecessary_unwrap`", "tree": {"sha": "73a31f477fd547cc1e31db8342c3a9cbb94bb762", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/73a31f477fd547cc1e31db8342c3a9cbb94bb762"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a3135ba131bd6536417439efb744c65738772fca", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a3135ba131bd6536417439efb744c65738772fca", "html_url": "https://github.com/rust-lang/rust/commit/a3135ba131bd6536417439efb744c65738772fca", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a3135ba131bd6536417439efb744c65738772fca/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c1f8be074edaa702c5b4ca52a9d44bba2b46946c", "url": "https://api.github.com/repos/rust-lang/rust/commits/c1f8be074edaa702c5b4ca52a9d44bba2b46946c", "html_url": "https://github.com/rust-lang/rust/commit/c1f8be074edaa702c5b4ca52a9d44bba2b46946c"}, {"sha": "19ce66c1c12f1de38896081de005a8c0abb47b88", "url": "https://api.github.com/repos/rust-lang/rust/commits/19ce66c1c12f1de38896081de005a8c0abb47b88", "html_url": "https://github.com/rust-lang/rust/commit/19ce66c1c12f1de38896081de005a8c0abb47b88"}], "stats": {"total": 53, "additions": 40, "deletions": 13}, "files": [{"sha": "4fd421e4af94d6cbb60d760e5054a6f93f6c3ff9", "filename": "clippy_lints/src/unwrap.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/a3135ba131bd6536417439efb744c65738772fca/clippy_lints%2Fsrc%2Funwrap.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a3135ba131bd6536417439efb744c65738772fca/clippy_lints%2Fsrc%2Funwrap.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Funwrap.rs?ref=a3135ba131bd6536417439efb744c65738772fca", "patch": "@@ -1,6 +1,7 @@\n use crate::utils::{higher::if_block, match_type, paths, span_lint_and_then, usage::is_potentially_mutated};\n use if_chain::if_chain;\n use rustc::hir::map::Map;\n+use rustc::lint::in_external_macro;\n use rustc_hir::intravisit::*;\n use rustc_hir::*;\n use rustc_lint::{LateContext, LateLintPass};\n@@ -138,6 +139,10 @@ impl<'a, 'tcx> Visitor<'tcx> for UnwrappableVariablesVisitor<'a, 'tcx> {\n     type Map = Map<'tcx>;\n \n     fn visit_expr(&mut self, expr: &'tcx Expr<'_>) {\n+        // Shouldn't lint when `expr` is in macro.\n+        if in_external_macro(self.cx.tcx.sess, expr.span) {\n+            return;\n+        }\n         if let Some((cond, then, els)) = if_block(&expr) {\n             walk_expr(self, cond);\n             self.visit_branch(cond, then, false);"}, {"sha": "b0fc26ff76de559b36b13ee2170f1607d93f1bf8", "filename": "tests/ui/checked_unwrap/simple_conditionals.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/a3135ba131bd6536417439efb744c65738772fca/tests%2Fui%2Fchecked_unwrap%2Fsimple_conditionals.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a3135ba131bd6536417439efb744c65738772fca/tests%2Fui%2Fchecked_unwrap%2Fsimple_conditionals.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fchecked_unwrap%2Fsimple_conditionals.rs?ref=a3135ba131bd6536417439efb744c65738772fca", "patch": "@@ -1,6 +1,14 @@\n #![deny(clippy::panicking_unwrap, clippy::unnecessary_unwrap)]\n #![allow(clippy::if_same_then_else)]\n \n+macro_rules! m {\n+    ($a:expr) => {\n+        if $a.is_some() {\n+            $a.unwrap(); // unnecessary\n+        }\n+    };\n+}\n+\n fn main() {\n     let x = Some(());\n     if x.is_some() {\n@@ -13,6 +21,7 @@ fn main() {\n     } else {\n         x.unwrap(); // unnecessary\n     }\n+    m!(x);\n     let mut x: Result<(), ()> = Ok(());\n     if x.is_ok() {\n         x.unwrap(); // unnecessary\n@@ -39,4 +48,6 @@ fn main() {\n                         // it will always panic but the lint is not smart enough to see this (it\n                         // only checks if conditions).\n     }\n+\n+    assert!(x.is_ok(), \"{:?}\", x.unwrap_err()); // ok, it's a common test pattern\n }"}, {"sha": "b226bd726403f1331bbc960b393c92166e7a5d88", "filename": "tests/ui/checked_unwrap/simple_conditionals.stderr", "status": "modified", "additions": 24, "deletions": 13, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/a3135ba131bd6536417439efb744c65738772fca/tests%2Fui%2Fchecked_unwrap%2Fsimple_conditionals.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a3135ba131bd6536417439efb744c65738772fca/tests%2Fui%2Fchecked_unwrap%2Fsimple_conditionals.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fchecked_unwrap%2Fsimple_conditionals.stderr?ref=a3135ba131bd6536417439efb744c65738772fca", "patch": "@@ -1,5 +1,5 @@\n error: You checked before that `unwrap()` cannot fail. Instead of checking and unwrapping, it's better to use `if let` or `match`.\n-  --> $DIR/simple_conditionals.rs:7:9\n+  --> $DIR/simple_conditionals.rs:15:9\n    |\n LL |     if x.is_some() {\n    |        ----------- the check is happening here\n@@ -13,7 +13,7 @@ LL | #![deny(clippy::panicking_unwrap, clippy::unnecessary_unwrap)]\n    |                                   ^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n error: This call to `unwrap()` will always panic.\n-  --> $DIR/simple_conditionals.rs:9:9\n+  --> $DIR/simple_conditionals.rs:17:9\n    |\n LL |     if x.is_some() {\n    |        ----------- because of this check\n@@ -28,15 +28,15 @@ LL | #![deny(clippy::panicking_unwrap, clippy::unnecessary_unwrap)]\n    |         ^^^^^^^^^^^^^^^^^^^^^^^^\n \n error: This call to `unwrap()` will always panic.\n-  --> $DIR/simple_conditionals.rs:12:9\n+  --> $DIR/simple_conditionals.rs:20:9\n    |\n LL |     if x.is_none() {\n    |        ----------- because of this check\n LL |         x.unwrap(); // will panic\n    |         ^^^^^^^^^^\n \n error: You checked before that `unwrap()` cannot fail. Instead of checking and unwrapping, it's better to use `if let` or `match`.\n-  --> $DIR/simple_conditionals.rs:14:9\n+  --> $DIR/simple_conditionals.rs:22:9\n    |\n LL |     if x.is_none() {\n    |        ----------- the check is happening here\n@@ -45,15 +45,26 @@ LL |         x.unwrap(); // unnecessary\n    |         ^^^^^^^^^^\n \n error: You checked before that `unwrap()` cannot fail. Instead of checking and unwrapping, it's better to use `if let` or `match`.\n-  --> $DIR/simple_conditionals.rs:18:9\n+  --> $DIR/simple_conditionals.rs:7:13\n+   |\n+LL |         if $a.is_some() {\n+   |            ------------ the check is happening here\n+LL |             $a.unwrap(); // unnecessary\n+   |             ^^^^^^^^^^^\n+...\n+LL |     m!(x);\n+   |     ------ in this macro invocation\n+\n+error: You checked before that `unwrap()` cannot fail. Instead of checking and unwrapping, it's better to use `if let` or `match`.\n+  --> $DIR/simple_conditionals.rs:27:9\n    |\n LL |     if x.is_ok() {\n    |        --------- the check is happening here\n LL |         x.unwrap(); // unnecessary\n    |         ^^^^^^^^^^\n \n error: This call to `unwrap_err()` will always panic.\n-  --> $DIR/simple_conditionals.rs:19:9\n+  --> $DIR/simple_conditionals.rs:28:9\n    |\n LL |     if x.is_ok() {\n    |        --------- because of this check\n@@ -62,7 +73,7 @@ LL |         x.unwrap_err(); // will panic\n    |         ^^^^^^^^^^^^^^\n \n error: This call to `unwrap()` will always panic.\n-  --> $DIR/simple_conditionals.rs:21:9\n+  --> $DIR/simple_conditionals.rs:30:9\n    |\n LL |     if x.is_ok() {\n    |        --------- because of this check\n@@ -71,7 +82,7 @@ LL |         x.unwrap(); // will panic\n    |         ^^^^^^^^^^\n \n error: You checked before that `unwrap_err()` cannot fail. Instead of checking and unwrapping, it's better to use `if let` or `match`.\n-  --> $DIR/simple_conditionals.rs:22:9\n+  --> $DIR/simple_conditionals.rs:31:9\n    |\n LL |     if x.is_ok() {\n    |        --------- the check is happening here\n@@ -80,15 +91,15 @@ LL |         x.unwrap_err(); // unnecessary\n    |         ^^^^^^^^^^^^^^\n \n error: This call to `unwrap()` will always panic.\n-  --> $DIR/simple_conditionals.rs:25:9\n+  --> $DIR/simple_conditionals.rs:34:9\n    |\n LL |     if x.is_err() {\n    |        ---------- because of this check\n LL |         x.unwrap(); // will panic\n    |         ^^^^^^^^^^\n \n error: You checked before that `unwrap_err()` cannot fail. Instead of checking and unwrapping, it's better to use `if let` or `match`.\n-  --> $DIR/simple_conditionals.rs:26:9\n+  --> $DIR/simple_conditionals.rs:35:9\n    |\n LL |     if x.is_err() {\n    |        ---------- the check is happening here\n@@ -97,7 +108,7 @@ LL |         x.unwrap_err(); // unnecessary\n    |         ^^^^^^^^^^^^^^\n \n error: You checked before that `unwrap()` cannot fail. Instead of checking and unwrapping, it's better to use `if let` or `match`.\n-  --> $DIR/simple_conditionals.rs:28:9\n+  --> $DIR/simple_conditionals.rs:37:9\n    |\n LL |     if x.is_err() {\n    |        ---------- the check is happening here\n@@ -106,13 +117,13 @@ LL |         x.unwrap(); // unnecessary\n    |         ^^^^^^^^^^\n \n error: This call to `unwrap_err()` will always panic.\n-  --> $DIR/simple_conditionals.rs:29:9\n+  --> $DIR/simple_conditionals.rs:38:9\n    |\n LL |     if x.is_err() {\n    |        ---------- because of this check\n ...\n LL |         x.unwrap_err(); // will panic\n    |         ^^^^^^^^^^^^^^\n \n-error: aborting due to 12 previous errors\n+error: aborting due to 13 previous errors\n "}]}