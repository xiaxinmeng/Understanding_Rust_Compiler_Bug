{"sha": "75b557a2c416f997385a886b39e7ef7625073f5a", "node_id": "C_kwDOAAsO6NoAKDc1YjU1N2EyYzQxNmY5OTczODVhODg2YjM5ZTdlZjc2MjUwNzNmNWE", "commit": {"author": {"name": "Arpad Borsos", "email": "swatinem@swatinem.de", "date": "2023-06-04T08:38:14Z"}, "committer": {"name": "Arpad Borsos", "email": "swatinem@swatinem.de", "date": "2023-06-04T08:56:00Z"}, "message": "Fix type-inference regression in #112225\n\nThe type inference of argument-position closures and async blocks\nregressed in 1.70 as the evaluation order of async blocks changed, as\nthey are not implicitly wrapped in an identity-function anymore.\n\nFixes #112225 by making sure the evaluation order stays the same as it\nused to.", "tree": {"sha": "0272e3eac75a52abfe30db85910883c2371d7502", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0272e3eac75a52abfe30db85910883c2371d7502"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/75b557a2c416f997385a886b39e7ef7625073f5a", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEZNNjbpmzULCa7LeL/HvKd4JLMpgFAmR8UaQACgkQ/HvKd4JL\nMpg3TBAAqIpU9Y6ZqVxulwSeJT/o4QEDB33eG5SgrkCrWW/IYYYT6qDt7YK8ifR2\n8DmQJAYDZJ1rY8skUWfaoFkefT+lzw+6OZ2uVEKYkKDJJGEq+nDbEMwM6AR+Yj26\nKCSXgj5/YVDJGfc0CMtX1EeIASCBohskaE6j37oke/O0uYcwLw/C80nrWbLFZ/9+\n9HR3afZVfbIgrGhoUdPZo4Zzbkt3yKhVGpUEyqb2LV8LIcx+zLrV2SMtFQaklqoy\nRBUN+7PWDVmVKjqaXeOh9suBCYIszAF1giSG0uiw8di3Oo54k2pMSqNDTzq/GVlb\nCqcwVtk52M4QsYNxSmLRoT6Cpe5DezGOu7PxWvwnU0ojlSwKrNebW1ZtnHbaqzta\n1iiKzUEFOBnUcztjsUFHKAnkMbl0cu3Jo4TchvhpSvy6qNX+jXVhlrEF3nNipCZ8\nqURwa0b/GJsxOSdVu3KgOD3nNSbRJV0V7XjWi6zTQIGo2s/p8c+pgAjVaBrqwERG\nTtxg9BGwEibIoI7q1MULh8SwlAM9KlEpGngaC9zl4BwdB44PREo0EmWmLjrywsY/\nWHJKer6FKdRaOWcQNaGZID88ztyP6Tv9kPY04yAeaUMaq2uN1dgWT5IhjrL+YGs8\nQ59/wR3FV/fhQa/hJlczfbdDz5ShRGv5SScRjLmAXkz5yOwnc+Y=\n=UMn4\n-----END PGP SIGNATURE-----", "payload": "tree 0272e3eac75a52abfe30db85910883c2371d7502\nparent 9eee230cd0a56bfba3ce65121798d9f9f4341cdd\nauthor Arpad Borsos <swatinem@swatinem.de> 1685867894 +0200\ncommitter Arpad Borsos <swatinem@swatinem.de> 1685868960 +0200\n\nFix type-inference regression in #112225\n\nThe type inference of argument-position closures and async blocks\nregressed in 1.70 as the evaluation order of async blocks changed, as\nthey are not implicitly wrapped in an identity-function anymore.\n\nFixes #112225 by making sure the evaluation order stays the same as it\nused to.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/75b557a2c416f997385a886b39e7ef7625073f5a", "html_url": "https://github.com/rust-lang/rust/commit/75b557a2c416f997385a886b39e7ef7625073f5a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/75b557a2c416f997385a886b39e7ef7625073f5a/comments", "author": {"login": "Swatinem", "id": 580492, "node_id": "MDQ6VXNlcjU4MDQ5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/580492?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Swatinem", "html_url": "https://github.com/Swatinem", "followers_url": "https://api.github.com/users/Swatinem/followers", "following_url": "https://api.github.com/users/Swatinem/following{/other_user}", "gists_url": "https://api.github.com/users/Swatinem/gists{/gist_id}", "starred_url": "https://api.github.com/users/Swatinem/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Swatinem/subscriptions", "organizations_url": "https://api.github.com/users/Swatinem/orgs", "repos_url": "https://api.github.com/users/Swatinem/repos", "events_url": "https://api.github.com/users/Swatinem/events{/privacy}", "received_events_url": "https://api.github.com/users/Swatinem/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Swatinem", "id": 580492, "node_id": "MDQ6VXNlcjU4MDQ5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/580492?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Swatinem", "html_url": "https://github.com/Swatinem", "followers_url": "https://api.github.com/users/Swatinem/followers", "following_url": "https://api.github.com/users/Swatinem/following{/other_user}", "gists_url": "https://api.github.com/users/Swatinem/gists{/gist_id}", "starred_url": "https://api.github.com/users/Swatinem/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Swatinem/subscriptions", "organizations_url": "https://api.github.com/users/Swatinem/orgs", "repos_url": "https://api.github.com/users/Swatinem/repos", "events_url": "https://api.github.com/users/Swatinem/events{/privacy}", "received_events_url": "https://api.github.com/users/Swatinem/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9eee230cd0a56bfba3ce65121798d9f9f4341cdd", "url": "https://api.github.com/repos/rust-lang/rust/commits/9eee230cd0a56bfba3ce65121798d9f9f4341cdd", "html_url": "https://github.com/rust-lang/rust/commit/9eee230cd0a56bfba3ce65121798d9f9f4341cdd"}], "stats": {"total": 66, "additions": 65, "deletions": 1}, "files": [{"sha": "eba5c829e396d31f31e90751b739779a6694acd2", "filename": "compiler/rustc_hir_typeck/src/fn_ctxt/checks.rs", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/75b557a2c416f997385a886b39e7ef7625073f5a/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2Fchecks.rs", "raw_url": "https://github.com/rust-lang/rust/raw/75b557a2c416f997385a886b39e7ef7625073f5a/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2Fchecks.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2Fchecks.rs?ref=75b557a2c416f997385a886b39e7ef7625073f5a", "patch": "@@ -362,7 +362,16 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                     continue;\n                 }\n \n-                let is_closure = matches!(arg.kind, ExprKind::Closure { .. });\n+                // For this check, we do *not* want to treat async generator closures (async blocks)\n+                // as proper closures. Doing so would regress type inference when feeding\n+                // the return value of an argument-position async block to an argument-position\n+                // closure wrapped in a block.\n+                // See <https://github.com/rust-lang/rust/issues/112225>.\n+                let is_closure = if let ExprKind::Closure(closure) = arg.kind {\n+                    !tcx.generator_is_async(closure.def_id.to_def_id())\n+                } else {\n+                    false\n+                };\n                 if is_closure != check_closures {\n                     continue;\n                 }"}, {"sha": "e28cbee214e1a3d4f78e82f24957ef0733474c45", "filename": "tests/ui/async-await/issues/issue-112225-1.rs", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/75b557a2c416f997385a886b39e7ef7625073f5a/tests%2Fui%2Fasync-await%2Fissues%2Fissue-112225-1.rs", "raw_url": "https://github.com/rust-lang/rust/raw/75b557a2c416f997385a886b39e7ef7625073f5a/tests%2Fui%2Fasync-await%2Fissues%2Fissue-112225-1.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fasync-await%2Fissues%2Fissue-112225-1.rs?ref=75b557a2c416f997385a886b39e7ef7625073f5a", "patch": "@@ -0,0 +1,18 @@\n+// check-pass\n+// edition:2021\n+\n+use core::future::Future;\n+\n+fn main() {\n+    do_async(async { (0,) }, {\n+        // closure must be inside block\n+        |info| println!(\"{:?}\", info.0)\n+    });\n+}\n+\n+fn do_async<R, Fut, F>(_tokio_fut: Fut, _glib_closure: F)\n+where\n+    Fut: Future<Output = R>,\n+    F: FnOnce(R),\n+{\n+}"}, {"sha": "50fa1a79b6beb5575751c054db95da9985fd70cc", "filename": "tests/ui/async-await/issues/issue-112225-2.rs", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/75b557a2c416f997385a886b39e7ef7625073f5a/tests%2Fui%2Fasync-await%2Fissues%2Fissue-112225-2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/75b557a2c416f997385a886b39e7ef7625073f5a/tests%2Fui%2Fasync-await%2Fissues%2Fissue-112225-2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fasync-await%2Fissues%2Fissue-112225-2.rs?ref=75b557a2c416f997385a886b39e7ef7625073f5a", "patch": "@@ -0,0 +1,20 @@\n+// edition:2021\n+\n+// With the current compiler logic, we cannot have both the `112225-1` case,\n+// and this `112225-2` case working, as the type inference depends on the evaluation\n+// order, and there is some explicit ordering going on.\n+// See the `check_closures` part in `FnCtxt::check_argument_types`.\n+// The `112225-1` case was a regression in real world code, whereas the `112225-2`\n+// case never used to work prior to 1.70.\n+\n+use core::future::Future;\n+\n+fn main() {\n+    let x = Default::default();\n+    //~^ ERROR: type annotations needed\n+    do_async(\n+        async { x.0; },\n+        { || { let _: &(i32,) = &x; } },\n+    );\n+}\n+fn do_async<Fut, T>(_fut: Fut, _val: T, ) {}"}, {"sha": "5926a4f3995ad203b30ab5e58fc9db019933cd8e", "filename": "tests/ui/async-await/issues/issue-112225-2.stderr", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/75b557a2c416f997385a886b39e7ef7625073f5a/tests%2Fui%2Fasync-await%2Fissues%2Fissue-112225-2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/75b557a2c416f997385a886b39e7ef7625073f5a/tests%2Fui%2Fasync-await%2Fissues%2Fissue-112225-2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fasync-await%2Fissues%2Fissue-112225-2.stderr?ref=75b557a2c416f997385a886b39e7ef7625073f5a", "patch": "@@ -0,0 +1,17 @@\n+error[E0282]: type annotations needed\n+  --> $DIR/issue-112225-2.rs:13:9\n+   |\n+LL |     let x = Default::default();\n+   |         ^\n+...\n+LL |         async { x.0; },\n+   |                 - type must be known at this point\n+   |\n+help: consider giving `x` an explicit type\n+   |\n+LL |     let x: /* Type */ = Default::default();\n+   |          ++++++++++++\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0282`."}]}