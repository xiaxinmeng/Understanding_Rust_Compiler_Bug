{"sha": "858ad554374a8b1ad67692558a0878391abfdd86", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg1OGFkNTU0Mzc0YThiMWFkNjc2OTI1NThhMDg3ODM5MWFiZmRkODY=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-03-21T19:25:14Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-03-21T19:25:14Z"}, "message": "Merge #8137\n\n8137: Fix box pattern inference panic r=flodiebold a=Veykril\n\nFixes #6560\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>", "tree": {"sha": "cae76f9d2a7ab4e10758ecf881e374f26f6bc803", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cae76f9d2a7ab4e10758ecf881e374f26f6bc803"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/858ad554374a8b1ad67692558a0878391abfdd86", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgV52aCRBK7hj4Ov3rIwAAdHIIABQnrYfBuVQfdioWfdTMX1vo\nMWrUyWDlesjPAZUD5U0ScWfd6K8m+5dTDiw/gt++i8/dIF4xjpyMRhQKcdMpP7rM\nv6JpUEKEhiiV5beVSDxrUxKxkW5jP5JghgqA1G4PAAksQ8+ZxXU/RYPfW0WOHVMc\nB/V09CaoAQHQjMNQbl9f6jykUMkoTL4JtkUGw0C74DWLfpjp7IL4yH9MTB+3xlSz\nGbHz/Af1ViPNKUv1N446ILS/pdTBslCpD0j0BC2pXUUDzzvPU9lLlhEy7p6/vhg5\nczWHWImXoEcCxRWdf/vnD43VSE+llNvNqrb0d7objLgW0x1EMhC3aCOLdhKEqhg=\n=ctVm\n-----END PGP SIGNATURE-----\n", "payload": "tree cae76f9d2a7ab4e10758ecf881e374f26f6bc803\nparent 31ed1641615bd57d9f4897dbe93e97f185fc5273\nparent af50e8d955caa0b689f3e5b02f0d8ff0302fd3e3\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1616354714 +0000\ncommitter GitHub <noreply@github.com> 1616354714 +0000\n\nMerge #8137\n\n8137: Fix box pattern inference panic r=flodiebold a=Veykril\n\nFixes #6560\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/858ad554374a8b1ad67692558a0878391abfdd86", "html_url": "https://github.com/rust-lang/rust/commit/858ad554374a8b1ad67692558a0878391abfdd86", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/858ad554374a8b1ad67692558a0878391abfdd86/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "31ed1641615bd57d9f4897dbe93e97f185fc5273", "url": "https://api.github.com/repos/rust-lang/rust/commits/31ed1641615bd57d9f4897dbe93e97f185fc5273", "html_url": "https://github.com/rust-lang/rust/commit/31ed1641615bd57d9f4897dbe93e97f185fc5273"}, {"sha": "af50e8d955caa0b689f3e5b02f0d8ff0302fd3e3", "url": "https://api.github.com/repos/rust-lang/rust/commits/af50e8d955caa0b689f3e5b02f0d8ff0302fd3e3", "html_url": "https://github.com/rust-lang/rust/commit/af50e8d955caa0b689f3e5b02f0d8ff0302fd3e3"}], "stats": {"total": 60, "additions": 51, "deletions": 9}, "files": [{"sha": "24deff70732ad1cf6b55d4bf38da8af46ad0f977", "filename": "crates/hir_ty/src/infer/expr.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/858ad554374a8b1ad67692558a0878391abfdd86/crates%2Fhir_ty%2Fsrc%2Finfer%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/858ad554374a8b1ad67692558a0878391abfdd86/crates%2Fhir_ty%2Fsrc%2Finfer%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Finfer%2Fexpr.rs?ref=858ad554374a8b1ad67692558a0878391abfdd86", "patch": "@@ -513,10 +513,10 @@ impl<'a> InferenceContext<'a> {\n                 let inner_ty = self.infer_expr_inner(*expr, &Expectation::none());\n                 if let Some(box_) = self.resolve_boxed_box() {\n                     let mut sb =\n-                        Substitution::builder(generics(self.db.upcast(), box_.into()).len());\n+                        Substitution::build_for_generics(&generics(self.db.upcast(), box_.into()));\n                     sb = sb.push(inner_ty);\n-                    match self.db.generic_defaults(box_.into()).as_ref() {\n-                        [_, alloc_ty, ..] if !alloc_ty.value.is_unknown() => {\n+                    match self.db.generic_defaults(box_.into()).get(1) {\n+                        Some(alloc_ty) if !alloc_ty.value.is_unknown() && sb.remaining() > 0 => {\n                             sb = sb.push(alloc_ty.value.clone());\n                         }\n                         _ => (),"}, {"sha": "474363709ba31988147430009afa898b74b765f8", "filename": "crates/hir_ty/src/infer/pat.rs", "status": "modified", "additions": 26, "deletions": 6, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/858ad554374a8b1ad67692558a0878391abfdd86/crates%2Fhir_ty%2Fsrc%2Finfer%2Fpat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/858ad554374a8b1ad67692558a0878391abfdd86/crates%2Fhir_ty%2Fsrc%2Finfer%2Fpat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Finfer%2Fpat.rs?ref=858ad554374a8b1ad67692558a0878391abfdd86", "patch": "@@ -13,7 +13,9 @@ use hir_expand::name::Name;\n \n use super::{BindingMode, Expectation, InferenceContext};\n use crate::{\n-    lower::lower_to_chalk_mutability, utils::variant_data, Interner, Substitution, Ty, TyKind,\n+    lower::lower_to_chalk_mutability,\n+    utils::{generics, variant_data},\n+    Interner, Substitution, Ty, TyKind,\n };\n \n impl<'a> InferenceContext<'a> {\n@@ -233,13 +235,31 @@ impl<'a> InferenceContext<'a> {\n             Pat::Lit(expr) => self.infer_expr(*expr, &Expectation::has_type(expected.clone())),\n             Pat::Box { inner } => match self.resolve_boxed_box() {\n                 Some(box_adt) => {\n-                    let inner_expected = match expected.as_adt() {\n-                        Some((adt, substs)) if adt == box_adt => substs.as_single().clone(),\n-                        _ => self.result.standard_types.unknown.clone(),\n+                    let (inner_ty, alloc_ty) = match expected.as_adt() {\n+                        Some((adt, subst)) if adt == box_adt => {\n+                            (subst[0].clone(), subst.get(1).cloned())\n+                        }\n+                        _ => (self.result.standard_types.unknown.clone(), None),\n                     };\n \n-                    let inner_ty = self.infer_pat(*inner, &inner_expected, default_bm);\n-                    Ty::adt_ty(box_adt, Substitution::single(inner_ty))\n+                    let inner_ty = self.infer_pat(*inner, &inner_ty, default_bm);\n+                    let mut sb = Substitution::build_for_generics(&generics(\n+                        self.db.upcast(),\n+                        box_adt.into(),\n+                    ));\n+                    sb = sb.push(inner_ty);\n+                    if sb.remaining() == 1 {\n+                        sb = sb.push(match alloc_ty {\n+                            Some(alloc_ty) if !alloc_ty.is_unknown() => alloc_ty,\n+                            _ => match self.db.generic_defaults(box_adt.into()).get(1) {\n+                                Some(alloc_ty) if !alloc_ty.value.is_unknown() => {\n+                                    alloc_ty.value.clone()\n+                                }\n+                                _ => self.table.new_type_var(),\n+                            },\n+                        });\n+                    }\n+                    Ty::adt_ty(box_adt, sb.build())\n                 }\n                 None => self.err_ty(),\n             },"}, {"sha": "85a28e76b2367be08a19ad73db24859381b67a28", "filename": "crates/hir_ty/src/tests/patterns.rs", "status": "modified", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/858ad554374a8b1ad67692558a0878391abfdd86/crates%2Fhir_ty%2Fsrc%2Ftests%2Fpatterns.rs", "raw_url": "https://github.com/rust-lang/rust/raw/858ad554374a8b1ad67692558a0878391abfdd86/crates%2Fhir_ty%2Fsrc%2Ftests%2Fpatterns.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Ftests%2Fpatterns.rs?ref=858ad554374a8b1ad67692558a0878391abfdd86", "patch": "@@ -656,6 +656,28 @@ fn slice_tail_pattern() {\n \n #[test]\n fn box_pattern() {\n+    check_infer(\n+        r#\"\n+        pub struct Global;\n+        #[lang = \"owned_box\"]\n+        pub struct Box<T, A = Global>(T);\n+\n+        fn foo(params: Box<i32>) {\n+            match params {\n+                box integer => {}\n+            }\n+        }\n+        \"#,\n+        expect![[r#\"\n+            83..89 'params': Box<i32, Global>\n+            101..155 '{     ...   } }': ()\n+            107..153 'match ...     }': ()\n+            113..119 'params': Box<i32, Global>\n+            130..141 'box integer': Box<i32, Global>\n+            134..141 'integer': i32\n+            145..147 '{}': ()\n+        \"#]],\n+    );\n     check_infer(\n         r#\"\n         #[lang = \"owned_box\"]"}]}