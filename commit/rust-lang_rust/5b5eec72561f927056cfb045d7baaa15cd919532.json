{"sha": "5b5eec72561f927056cfb045d7baaa15cd919532", "node_id": "MDY6Q29tbWl0NzI0NzEyOjViNWVlYzcyNTYxZjkyNzA1NmNmYjA0NWQ3YmFhYTE1Y2Q5MTk1MzI=", "commit": {"author": {"name": "Tyler Mandry", "email": "tmandry@gmail.com", "date": "2020-08-14T01:00:00Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-08-14T01:00:00Z"}, "message": "Rollup merge of #74650 - estebank:ambiguous-expr-binop, r=eddyb\n\nCorrectly parse `{} && false` in tail expression\n\nFix #74233, fix #54186.", "tree": {"sha": "7f432435d2c666da3859a09cec13dbc6b03ec3cc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7f432435d2c666da3859a09cec13dbc6b03ec3cc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5b5eec72561f927056cfb045d7baaa15cd919532", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfNeIQCRBK7hj4Ov3rIwAAdHIIAE/ylaQt5AE2as2piCx74cSy\nHgaLMlGzcaVosW/vrjS5Q0xOKsHCK2sONoZ/ushrFXfAEId9nIeyOOuoA10Y50C6\nZPlkzFpahXaMrnyZUCe427Yhc7Wjja+AnA6CuvpspeRbzKSjYKDfYgjYDOjSSoNo\nqFbdbRCSk0GDsTCOBgAx+hon1ox7CtzCevXmQitjhD1ffzwIPgJ21SrqGIUlv8HT\ntGLDJX0dLn8/p1p6kRdpSAzau1zKnqFrvHH+FRx0vBby3OQdvI1HGG3LcAk9S1sa\nea2zbmfxhmxPIt1Z1DNN0DTWutuWxZQmqE8AfrvpjgwMTz12e36llupeNJLG7HI=\n=KH6e\n-----END PGP SIGNATURE-----\n", "payload": "tree 7f432435d2c666da3859a09cec13dbc6b03ec3cc\nparent 81dc88f88f92ba8ad7465f9cba10c12d3a7b70f1\nparent 9b5a974bd5c398e5706e463045121b20f0f6abb9\nauthor Tyler Mandry <tmandry@gmail.com> 1597366800 -0700\ncommitter GitHub <noreply@github.com> 1597366800 -0700\n\nRollup merge of #74650 - estebank:ambiguous-expr-binop, r=eddyb\n\nCorrectly parse `{} && false` in tail expression\n\nFix #74233, fix #54186.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5b5eec72561f927056cfb045d7baaa15cd919532", "html_url": "https://github.com/rust-lang/rust/commit/5b5eec72561f927056cfb045d7baaa15cd919532", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5b5eec72561f927056cfb045d7baaa15cd919532/comments", "author": {"login": "tmandry", "id": 2280544, "node_id": "MDQ6VXNlcjIyODA1NDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/2280544?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmandry", "html_url": "https://github.com/tmandry", "followers_url": "https://api.github.com/users/tmandry/followers", "following_url": "https://api.github.com/users/tmandry/following{/other_user}", "gists_url": "https://api.github.com/users/tmandry/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmandry/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmandry/subscriptions", "organizations_url": "https://api.github.com/users/tmandry/orgs", "repos_url": "https://api.github.com/users/tmandry/repos", "events_url": "https://api.github.com/users/tmandry/events{/privacy}", "received_events_url": "https://api.github.com/users/tmandry/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "81dc88f88f92ba8ad7465f9cba10c12d3a7b70f1", "url": "https://api.github.com/repos/rust-lang/rust/commits/81dc88f88f92ba8ad7465f9cba10c12d3a7b70f1", "html_url": "https://github.com/rust-lang/rust/commit/81dc88f88f92ba8ad7465f9cba10c12d3a7b70f1"}, {"sha": "9b5a974bd5c398e5706e463045121b20f0f6abb9", "url": "https://api.github.com/repos/rust-lang/rust/commits/9b5a974bd5c398e5706e463045121b20f0f6abb9", "html_url": "https://github.com/rust-lang/rust/commit/9b5a974bd5c398e5706e463045121b20f0f6abb9"}], "stats": {"total": 88, "additions": 63, "deletions": 25}, "files": [{"sha": "2ee94965756a5e0d72fc8bbe084b628f1c49f799", "filename": "src/librustc_ast/util/parser.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/5b5eec72561f927056cfb045d7baaa15cd919532/src%2Flibrustc_ast%2Futil%2Fparser.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5b5eec72561f927056cfb045d7baaa15cd919532/src%2Flibrustc_ast%2Futil%2Fparser.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_ast%2Futil%2Fparser.rs?ref=5b5eec72561f927056cfb045d7baaa15cd919532", "patch": "@@ -222,7 +222,6 @@ impl AssocOp {\n             Greater | // `{ 42 } > 3`\n             GreaterEqual | // `{ 42 } >= 3`\n             AssignOp(_) | // `{ 42 } +=`\n-            LAnd | // `{ 42 } &&foo`\n             As | // `{ 42 } as usize`\n             // Equal | // `{ 42 } == { 42 }`    Accepting these here would regress incorrect\n             // NotEqual | // `{ 42 } != { 42 }  struct literals parser recovery."}, {"sha": "8e2bee2646806c023dfbd5f889b4a7412c34135e", "filename": "src/librustc_parse/parser/expr.rs", "status": "modified", "additions": 9, "deletions": 2, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/5b5eec72561f927056cfb045d7baaa15cd919532/src%2Flibrustc_parse%2Fparser%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5b5eec72561f927056cfb045d7baaa15cd919532/src%2Flibrustc_parse%2Fparser%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_parse%2Fparser%2Fexpr.rs?ref=5b5eec72561f927056cfb045d7baaa15cd919532", "patch": "@@ -318,11 +318,18 @@ impl<'a> Parser<'a> {\n             // want to keep their span info to improve diagnostics in these cases in a later stage.\n             (true, Some(AssocOp::Multiply)) | // `{ 42 } *foo = bar;` or `{ 42 } * 3`\n             (true, Some(AssocOp::Subtract)) | // `{ 42 } -5`\n-            (true, Some(AssocOp::LAnd)) | // `{ 42 } &&x` (#61475)\n             (true, Some(AssocOp::Add)) // `{ 42 } + 42\n             // If the next token is a keyword, then the tokens above *are* unambiguously incorrect:\n             // `if x { a } else { b } && if y { c } else { d }`\n-            if !self.look_ahead(1, |t| t.is_reserved_ident()) => {\n+            if !self.look_ahead(1, |t| t.is_used_keyword()) => {\n+                // These cases are ambiguous and can't be identified in the parser alone.\n+                let sp = self.sess.source_map().start_point(self.token.span);\n+                self.sess.ambiguous_block_expr_parse.borrow_mut().insert(sp, lhs.span);\n+                false\n+            }\n+            (true, Some(AssocOp::LAnd)) => {\n+                // `{ 42 } &&x` (#61475) or `{ 42 } && if x { 1 } else { 0 }`. Separated from the\n+                // above due to #74233.\n                 // These cases are ambiguous and can't be identified in the parser alone.\n                 let sp = self.sess.source_map().start_point(self.token.span);\n                 self.sess.ambiguous_block_expr_parse.borrow_mut().insert(sp, lhs.span);"}, {"sha": "4ea76a4a9e2abb462ce0cd3c6d8148f5c2032edd", "filename": "src/librustc_typeck/check/demand.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/5b5eec72561f927056cfb045d7baaa15cd919532/src%2Flibrustc_typeck%2Fcheck%2Fdemand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5b5eec72561f927056cfb045d7baaa15cd919532/src%2Flibrustc_typeck%2Fcheck%2Fdemand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fdemand.rs?ref=5b5eec72561f927056cfb045d7baaa15cd919532", "patch": "@@ -34,6 +34,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         }\n         self.suggest_boxing_when_appropriate(err, expr, expected, expr_ty);\n         self.suggest_missing_await(err, expr, expected, expr_ty);\n+        self.suggest_missing_parentheses(err, expr);\n         self.note_need_for_fn_pointer(err, expected, expr_ty);\n     }\n "}, {"sha": "6957b6b2a05d08f74b458e558776caf5e9bd9b5a", "filename": "src/librustc_typeck/check/mod.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/5b5eec72561f927056cfb045d7baaa15cd919532/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5b5eec72561f927056cfb045d7baaa15cd919532/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs?ref=5b5eec72561f927056cfb045d7baaa15cd919532", "patch": "@@ -5401,6 +5401,14 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         }\n     }\n \n+    fn suggest_missing_parentheses(&self, err: &mut DiagnosticBuilder<'_>, expr: &hir::Expr<'_>) {\n+        let sp = self.tcx.sess.source_map().start_point(expr.span);\n+        if let Some(sp) = self.tcx.sess.parse_sess.ambiguous_block_expr_parse.borrow().get(&sp) {\n+            // `{ 42 } &&x` (#61475) or `{ 42 } && if x { 1 } else { 0 }`\n+            self.tcx.sess.parse_sess.expr_parentheses_needed(err, *sp, None);\n+        }\n+    }\n+\n     fn note_need_for_fn_pointer(\n         &self,\n         err: &mut DiagnosticBuilder<'_>,"}, {"sha": "3a18bdc3b730a8477a27a00e361d769ef4f8033a", "filename": "src/test/ui/parser/expr-as-stmt-2.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/5b5eec72561f927056cfb045d7baaa15cd919532/src%2Ftest%2Fui%2Fparser%2Fexpr-as-stmt-2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5b5eec72561f927056cfb045d7baaa15cd919532/src%2Ftest%2Fui%2Fparser%2Fexpr-as-stmt-2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fexpr-as-stmt-2.rs?ref=5b5eec72561f927056cfb045d7baaa15cd919532", "patch": "@@ -0,0 +1,10 @@\n+// This is not autofixable because we give extra suggestions to end the first expression with `;`.\n+fn foo(a: Option<u32>, b: Option<u32>) -> bool {\n+    if let Some(x) = a { true } else { false }\n+    //~^ ERROR mismatched types\n+    //~| ERROR mismatched types\n+    && //~ ERROR mismatched types\n+    if let Some(y) = a { true } else { false }\n+}\n+\n+fn main() {}"}, {"sha": "ee07c36763356d64e6fd5ce8d1380bac7508cfc9", "filename": "src/test/ui/parser/expr-as-stmt-2.stderr", "status": "added", "additions": 33, "deletions": 0, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/5b5eec72561f927056cfb045d7baaa15cd919532/src%2Ftest%2Fui%2Fparser%2Fexpr-as-stmt-2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/5b5eec72561f927056cfb045d7baaa15cd919532/src%2Ftest%2Fui%2Fparser%2Fexpr-as-stmt-2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fexpr-as-stmt-2.stderr?ref=5b5eec72561f927056cfb045d7baaa15cd919532", "patch": "@@ -0,0 +1,33 @@\n+error[E0308]: mismatched types\n+  --> $DIR/expr-as-stmt-2.rs:3:26\n+   |\n+LL |     if let Some(x) = a { true } else { false }\n+   |     ---------------------^^^^------------------ help: consider using a semicolon here\n+   |     |                    |\n+   |     |                    expected `()`, found `bool`\n+   |     expected this to be `()`\n+\n+error[E0308]: mismatched types\n+  --> $DIR/expr-as-stmt-2.rs:3:40\n+   |\n+LL |     if let Some(x) = a { true } else { false }\n+   |     -----------------------------------^^^^^--- help: consider using a semicolon here\n+   |     |                                  |\n+   |     |                                  expected `()`, found `bool`\n+   |     expected this to be `()`\n+\n+error[E0308]: mismatched types\n+  --> $DIR/expr-as-stmt-2.rs:6:5\n+   |\n+LL |   fn foo(a: Option<u32>, b: Option<u32>) -> bool {\n+   |                                             ---- expected `bool` because of return type\n+LL |       if let Some(x) = a { true } else { false }\n+   |       ------------------------------------------ help: parentheses are required to parse this as an expression: `(if let Some(x) = a { true } else { false })`\n+...\n+LL | /     &&\n+LL | |     if let Some(y) = a { true } else { false }\n+   | |______________________________________________^ expected `bool`, found `&&bool`\n+\n+error: aborting due to 3 previous errors\n+\n+For more information about this error, try `rustc --explain E0308`."}, {"sha": "02816ef2791b0dcaa5b83ec0a694795e5083e730", "filename": "src/test/ui/parser/expr-as-stmt.fixed", "status": "modified", "additions": 0, "deletions": 6, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/5b5eec72561f927056cfb045d7baaa15cd919532/src%2Ftest%2Fui%2Fparser%2Fexpr-as-stmt.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/5b5eec72561f927056cfb045d7baaa15cd919532/src%2Ftest%2Fui%2Fparser%2Fexpr-as-stmt.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fexpr-as-stmt.fixed?ref=5b5eec72561f927056cfb045d7baaa15cd919532", "patch": "@@ -25,12 +25,6 @@ fn baz() -> i32 {\n     //~^ ERROR mismatched types\n }\n \n-fn qux(a: Option<u32>, b: Option<u32>) -> bool {\n-    (if let Some(x) = a { true } else { false })\n-    && //~ ERROR expected expression\n-    if let Some(y) = a { true } else { false }\n-}\n-\n fn moo(x: u32) -> bool {\n     (match x {\n         _ => 1,"}, {"sha": "93baa8278f890b7bd431c0d86bf63c1d001d5721", "filename": "src/test/ui/parser/expr-as-stmt.rs", "status": "modified", "additions": 0, "deletions": 6, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/5b5eec72561f927056cfb045d7baaa15cd919532/src%2Ftest%2Fui%2Fparser%2Fexpr-as-stmt.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5b5eec72561f927056cfb045d7baaa15cd919532/src%2Ftest%2Fui%2Fparser%2Fexpr-as-stmt.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fexpr-as-stmt.rs?ref=5b5eec72561f927056cfb045d7baaa15cd919532", "patch": "@@ -25,12 +25,6 @@ fn baz() -> i32 {\n     //~^ ERROR mismatched types\n }\n \n-fn qux(a: Option<u32>, b: Option<u32>) -> bool {\n-    if let Some(x) = a { true } else { false }\n-    && //~ ERROR expected expression\n-    if let Some(y) = a { true } else { false }\n-}\n-\n fn moo(x: u32) -> bool {\n     match x {\n         _ => 1,"}, {"sha": "324aed0ad7cf6df71e5ecb701edbe007e6fad0a6", "filename": "src/test/ui/parser/expr-as-stmt.stderr", "status": "modified", "additions": 2, "deletions": 10, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/5b5eec72561f927056cfb045d7baaa15cd919532/src%2Ftest%2Fui%2Fparser%2Fexpr-as-stmt.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/5b5eec72561f927056cfb045d7baaa15cd919532/src%2Ftest%2Fui%2Fparser%2Fexpr-as-stmt.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fexpr-as-stmt.stderr?ref=5b5eec72561f927056cfb045d7baaa15cd919532", "patch": "@@ -22,16 +22,8 @@ LL |     { 42 } + foo;\n    |     |\n    |     help: parentheses are required to parse this as an expression: `({ 42 })`\n \n-error: expected expression, found `&&`\n-  --> $DIR/expr-as-stmt.rs:30:5\n-   |\n-LL |     if let Some(x) = a { true } else { false }\n-   |     ------------------------------------------ help: parentheses are required to parse this as an expression: `(if let Some(x) = a { true } else { false })`\n-LL |     &&\n-   |     ^^ expected expression\n-\n error: expected expression, found `>`\n-  --> $DIR/expr-as-stmt.rs:37:7\n+  --> $DIR/expr-as-stmt.rs:31:7\n    |\n LL |     } > 0\n    |       ^ expected expression\n@@ -75,7 +67,7 @@ LL |     { 3 } * 3\n    |     |\n    |     help: parentheses are required to parse this as an expression: `({ 3 })`\n \n-error: aborting due to 10 previous errors\n+error: aborting due to 9 previous errors\n \n Some errors have detailed explanations: E0308, E0614.\n For more information about an error, try `rustc --explain E0308`."}]}