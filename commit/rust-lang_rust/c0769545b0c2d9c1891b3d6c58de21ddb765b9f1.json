{"sha": "c0769545b0c2d9c1891b3d6c58de21ddb765b9f1", "node_id": "MDY6Q29tbWl0NzI0NzEyOmMwNzY5NTQ1YjBjMmQ5YzE4OTFiM2Q2YzU4ZGUyMWRkYjc2NWI5ZjE=", "commit": {"author": {"name": "Michael Bradshaw", "email": "mjbshaw@google.com", "date": "2018-09-26T14:55:57Z"}, "committer": {"name": "Michael Bradshaw", "email": "mjbshaw@google.com", "date": "2018-09-26T18:04:56Z"}, "message": "Make core::mem::needs_drop a const fn", "tree": {"sha": "bf89a79f70a43cb6f84f169033102e973a8aad52", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bf89a79f70a43cb6f84f169033102e973a8aad52"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c0769545b0c2d9c1891b3d6c58de21ddb765b9f1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c0769545b0c2d9c1891b3d6c58de21ddb765b9f1", "html_url": "https://github.com/rust-lang/rust/commit/c0769545b0c2d9c1891b3d6c58de21ddb765b9f1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c0769545b0c2d9c1891b3d6c58de21ddb765b9f1/comments", "author": {"login": "mjbshaw", "id": 1204698, "node_id": "MDQ6VXNlcjEyMDQ2OTg=", "avatar_url": "https://avatars.githubusercontent.com/u/1204698?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mjbshaw", "html_url": "https://github.com/mjbshaw", "followers_url": "https://api.github.com/users/mjbshaw/followers", "following_url": "https://api.github.com/users/mjbshaw/following{/other_user}", "gists_url": "https://api.github.com/users/mjbshaw/gists{/gist_id}", "starred_url": "https://api.github.com/users/mjbshaw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mjbshaw/subscriptions", "organizations_url": "https://api.github.com/users/mjbshaw/orgs", "repos_url": "https://api.github.com/users/mjbshaw/repos", "events_url": "https://api.github.com/users/mjbshaw/events{/privacy}", "received_events_url": "https://api.github.com/users/mjbshaw/received_events", "type": "User", "site_admin": false}, "committer": {"login": "mjbshaw", "id": 1204698, "node_id": "MDQ6VXNlcjEyMDQ2OTg=", "avatar_url": "https://avatars.githubusercontent.com/u/1204698?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mjbshaw", "html_url": "https://github.com/mjbshaw", "followers_url": "https://api.github.com/users/mjbshaw/followers", "following_url": "https://api.github.com/users/mjbshaw/following{/other_user}", "gists_url": "https://api.github.com/users/mjbshaw/gists{/gist_id}", "starred_url": "https://api.github.com/users/mjbshaw/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mjbshaw/subscriptions", "organizations_url": "https://api.github.com/users/mjbshaw/orgs", "repos_url": "https://api.github.com/users/mjbshaw/repos", "events_url": "https://api.github.com/users/mjbshaw/events{/privacy}", "received_events_url": "https://api.github.com/users/mjbshaw/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e783d2be405353b2ea99b77e107beb2970096b90", "url": "https://api.github.com/repos/rust-lang/rust/commits/e783d2be405353b2ea99b77e107beb2970096b90", "html_url": "https://github.com/rust-lang/rust/commit/e783d2be405353b2ea99b77e107beb2970096b90"}], "stats": {"total": 59, "additions": 57, "deletions": 2}, "files": [{"sha": "13c0b89f5df96fccbe866344a345525fe73a968e", "filename": "src/libcore/mem.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/c0769545b0c2d9c1891b3d6c58de21ddb765b9f1/src%2Flibcore%2Fmem.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c0769545b0c2d9c1891b3d6c58de21ddb765b9f1/src%2Flibcore%2Fmem.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fmem.rs?ref=c0769545b0c2d9c1891b3d6c58de21ddb765b9f1", "patch": "@@ -483,6 +483,15 @@ pub fn align_of_val<T: ?Sized>(val: &T) -> usize {\n /// ```\n #[inline]\n #[stable(feature = \"needs_drop\", since = \"1.21.0\")]\n+#[cfg(not(stage0))]\n+pub const fn needs_drop<T>() -> bool {\n+    intrinsics::needs_drop::<T>()\n+}\n+\n+#[inline]\n+#[stable(feature = \"needs_drop\", since = \"1.21.0\")]\n+#[cfg(stage0)]\n+/// Ceci n'est pas la documentation\n pub fn needs_drop<T>() -> bool {\n     unsafe { intrinsics::needs_drop::<T>() }\n }"}, {"sha": "ccf78eb93c57e9401f12275f9dbb0cb85110f5d4", "filename": "src/librustc/ty/context.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/c0769545b0c2d9c1891b3d6c58de21ddb765b9f1/src%2Flibrustc%2Fty%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c0769545b0c2d9c1891b3d6c58de21ddb765b9f1/src%2Flibrustc%2Fty%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fcontext.rs?ref=c0769545b0c2d9c1891b3d6c58de21ddb765b9f1", "patch": "@@ -1143,6 +1143,7 @@ impl<'a, 'gcx, 'tcx> TyCtxt<'a, 'gcx, 'tcx> {\n                 match &self.item_name(def_id).as_str()[..] {\n                     | \"size_of\"\n                     | \"min_align_of\"\n+                    | \"needs_drop\"\n                     => return true,\n                     _ => {},\n                 }"}, {"sha": "5fee49ba2fcf2ddb5bca8745a35b1bfc72510055", "filename": "src/librustc_mir/interpret/intrinsics.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/c0769545b0c2d9c1891b3d6c58de21ddb765b9f1/src%2Flibrustc_mir%2Finterpret%2Fintrinsics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c0769545b0c2d9c1891b3d6c58de21ddb765b9f1/src%2Flibrustc_mir%2Finterpret%2Fintrinsics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Finterpret%2Fintrinsics.rs?ref=c0769545b0c2d9c1891b3d6c58de21ddb765b9f1", "patch": "@@ -65,6 +65,13 @@ impl<'a, 'mir, 'tcx, M: Machine<'a, 'mir, 'tcx>> EvalContext<'a, 'mir, 'tcx, M>\n                 self.write_scalar(align_val, dest)?;\n             }\n \n+            \"needs_drop\" => {\n+                let ty = substs.type_at(0);\n+                let ty_needs_drop = ty.needs_drop(self.tcx.tcx, self.param_env);\n+                let val = Scalar::from_bool(ty_needs_drop);\n+                self.write_scalar(val, dest)?;\n+            }\n+\n             \"size_of\" => {\n                 let ty = substs.type_at(0);\n                 let size = self.layout_of(ty)?.size.bytes() as u128;"}, {"sha": "fed634f0f257cc72a1295a8f3570325fc4971b60", "filename": "src/librustc_mir/transform/qualify_consts.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/c0769545b0c2d9c1891b3d6c58de21ddb765b9f1/src%2Flibrustc_mir%2Ftransform%2Fqualify_consts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c0769545b0c2d9c1891b3d6c58de21ddb765b9f1/src%2Flibrustc_mir%2Ftransform%2Fqualify_consts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fqualify_consts.rs?ref=c0769545b0c2d9c1891b3d6c58de21ddb765b9f1", "patch": "@@ -823,6 +823,7 @@ impl<'a, 'tcx> Visitor<'tcx> for Qualifier<'a, 'tcx, 'tcx> {\n                         match &self.tcx.item_name(def_id).as_str()[..] {\n                             | \"size_of\"\n                             | \"min_align_of\"\n+                            | \"needs_drop\"\n                             | \"type_id\"\n                             | \"bswap\"\n                             | \"bitreverse\""}, {"sha": "499d58bc2eec149a7a8e78c650194722fbf2291f", "filename": "src/librustc_typeck/check/intrinsic.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/c0769545b0c2d9c1891b3d6c58de21ddb765b9f1/src%2Flibrustc_typeck%2Fcheck%2Fintrinsic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c0769545b0c2d9c1891b3d6c58de21ddb765b9f1/src%2Flibrustc_typeck%2Fcheck%2Fintrinsic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fintrinsic.rs?ref=c0769545b0c2d9c1891b3d6c58de21ddb765b9f1", "patch": "@@ -117,7 +117,7 @@ pub fn check_intrinsic_type<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>,\n         (0, Vec::new(), tcx.types.never, hir::Unsafety::Unsafe)\n     } else {\n         let unsafety = match &name[..] {\n-            \"size_of\" | \"min_align_of\" => hir::Unsafety::Normal,\n+            \"size_of\" | \"min_align_of\" | \"needs_drop\" => hir::Unsafety::Normal,\n             _ => hir::Unsafety::Unsafe,\n         };\n         let (n_tps, inputs, output) = match &name[..] {"}, {"sha": "996468ee38263c1ef83a851f5a1e9bc8b2e55184", "filename": "src/librustc_typeck/collect.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/c0769545b0c2d9c1891b3d6c58de21ddb765b9f1/src%2Flibrustc_typeck%2Fcollect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c0769545b0c2d9c1891b3d6c58de21ddb765b9f1/src%2Flibrustc_typeck%2Fcollect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcollect.rs?ref=c0769545b0c2d9c1891b3d6c58de21ddb765b9f1", "patch": "@@ -2003,7 +2003,7 @@ fn compute_sig_of_foreign_fn_decl<'a, 'tcx>(\n ) -> ty::PolyFnSig<'tcx> {\n     let unsafety = if abi == abi::Abi::RustIntrinsic {\n         match &*tcx.item_name(def_id).as_str() {\n-            \"size_of\" | \"min_align_of\" => hir::Unsafety::Normal,\n+            \"size_of\" | \"min_align_of\" | \"needs_drop\" => hir::Unsafety::Normal,\n             _ => hir::Unsafety::Unsafe,\n         }\n     } else {"}, {"sha": "2e381593b77e62e42107771c873cde81c130f44a", "filename": "src/test/run-pass/const-needs_drop.rs", "status": "added", "additions": 37, "deletions": 0, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/c0769545b0c2d9c1891b3d6c58de21ddb765b9f1/src%2Ftest%2Frun-pass%2Fconst-needs_drop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c0769545b0c2d9c1891b3d6c58de21ddb765b9f1/src%2Ftest%2Frun-pass%2Fconst-needs_drop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fconst-needs_drop.rs?ref=c0769545b0c2d9c1891b3d6c58de21ddb765b9f1", "patch": "@@ -0,0 +1,37 @@\n+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+use std::mem;\n+\n+struct Trivial(u8, f32);\n+\n+struct NonTrivial(u8, String);\n+\n+const CONST_U8: bool = mem::needs_drop::<u8>();\n+const CONST_STRING: bool = mem::needs_drop::<String>();\n+const CONST_TRIVIAL: bool = mem::needs_drop::<Trivial>();\n+const CONST_NON_TRIVIAL: bool = mem::needs_drop::<NonTrivial>();\n+\n+static STATIC_U8: bool = mem::needs_drop::<u8>();\n+static STATIC_STRING: bool = mem::needs_drop::<String>();\n+static STATIC_TRIVIAL: bool = mem::needs_drop::<Trivial>();\n+static STATIC_NON_TRIVIAL: bool = mem::needs_drop::<NonTrivial>();\n+\n+fn main() {\n+    assert!(!CONST_U8);\n+    assert!(CONST_STRING);\n+    assert!(!CONST_TRIVIAL);\n+    assert!(CONST_NON_TRIVIAL);\n+\n+    assert!(!STATIC_U8);\n+    assert!(STATIC_STRING);\n+    assert!(!STATIC_TRIVIAL);\n+    assert!(STATIC_NON_TRIVIAL);\n+}"}]}