{"sha": "519d870c11a9200bdcc33bb788fb7d8a85e5f1e5", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUxOWQ4NzBjMTFhOTIwMGJkY2MzM2JiNzg4ZmI3ZDhhODVlNWYxZTU=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2020-11-26T16:29:09Z"}, "committer": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2020-11-26T16:29:09Z"}, "message": "Don't store `SyntaxNodePtr` in `CrateDefMap`\n\nIt is volatile across reparses and makes incrementality worse.", "tree": {"sha": "41593247bcff0f60adf669dd0c2da0ec53ae80b4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/41593247bcff0f60adf669dd0c2da0ec53ae80b4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/519d870c11a9200bdcc33bb788fb7d8a85e5f1e5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/519d870c11a9200bdcc33bb788fb7d8a85e5f1e5", "html_url": "https://github.com/rust-lang/rust/commit/519d870c11a9200bdcc33bb788fb7d8a85e5f1e5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/519d870c11a9200bdcc33bb788fb7d8a85e5f1e5/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "74cb3e96a5279b4df6409ca4c20aac00d2ba5bfd", "url": "https://api.github.com/repos/rust-lang/rust/commits/74cb3e96a5279b4df6409ca4c20aac00d2ba5bfd", "html_url": "https://github.com/rust-lang/rust/commit/74cb3e96a5279b4df6409ca4c20aac00d2ba5bfd"}], "stats": {"total": 15, "additions": 7, "deletions": 8}, "files": [{"sha": "202a7dcb6d8af3cf74987e7bf4357d92326826ea", "filename": "crates/hir_def/src/nameres.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/519d870c11a9200bdcc33bb788fb7d8a85e5f1e5/crates%2Fhir_def%2Fsrc%2Fnameres.rs", "raw_url": "https://github.com/rust-lang/rust/raw/519d870c11a9200bdcc33bb788fb7d8a85e5f1e5/crates%2Fhir_def%2Fsrc%2Fnameres.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fnameres.rs?ref=519d870c11a9200bdcc33bb788fb7d8a85e5f1e5", "patch": "@@ -287,7 +287,7 @@ mod diagnostics {\n     use hir_expand::diagnostics::DiagnosticSink;\n     use hir_expand::hygiene::Hygiene;\n     use hir_expand::InFile;\n-    use syntax::{ast, AstPtr, SyntaxNodePtr};\n+    use syntax::{ast, AstPtr};\n \n     use crate::path::ModPath;\n     use crate::{db::DefDatabase, diagnostics::*, nameres::LocalModuleId, AstId};\n@@ -300,7 +300,7 @@ mod diagnostics {\n \n         UnresolvedImport { ast: AstId<ast::Use>, index: usize },\n \n-        UnconfiguredCode { ast: InFile<SyntaxNodePtr>, cfg: CfgExpr, opts: CfgOptions },\n+        UnconfiguredCode { ast: AstId<ast::Item>, cfg: CfgExpr, opts: CfgOptions },\n     }\n \n     #[derive(Debug, PartialEq, Eq)]\n@@ -341,7 +341,7 @@ mod diagnostics {\n \n         pub(super) fn unconfigured_code(\n             container: LocalModuleId,\n-            ast: InFile<SyntaxNodePtr>,\n+            ast: AstId<ast::Item>,\n             cfg: CfgExpr,\n             opts: CfgOptions,\n         ) -> Self {\n@@ -399,9 +399,10 @@ mod diagnostics {\n                 }\n \n                 DiagnosticKind::UnconfiguredCode { ast, cfg, opts } => {\n+                    let item = ast.to_node(db.upcast());\n                     sink.push(InactiveCode {\n                         file: ast.file_id,\n-                        node: ast.value.clone(),\n+                        node: AstPtr::new(&item).into(),\n                         cfg: cfg.clone(),\n                         opts: opts.clone(),\n                     });"}, {"sha": "5ed9073e08354daa4b3b928e354cbecc8087dd1d", "filename": "crates/hir_def/src/nameres/collector.rs", "status": "modified", "additions": 2, "deletions": 4, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/519d870c11a9200bdcc33bb788fb7d8a85e5f1e5/crates%2Fhir_def%2Fsrc%2Fnameres%2Fcollector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/519d870c11a9200bdcc33bb788fb7d8a85e5f1e5/crates%2Fhir_def%2Fsrc%2Fnameres%2Fcollector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fnameres%2Fcollector.rs?ref=519d870c11a9200bdcc33bb788fb7d8a85e5f1e5", "patch": "@@ -1336,13 +1336,11 @@ impl ModCollector<'_, '_> {\n \n     fn emit_unconfigured_diagnostic(&mut self, item: ModItem, cfg: &CfgExpr) {\n         let ast_id = item.ast_id(self.item_tree);\n-        let id_map = self.def_collector.db.ast_id_map(self.file_id);\n-        let syntax_ptr = id_map.get(ast_id).syntax_node_ptr();\n \n-        let ast_node = InFile::new(self.file_id, syntax_ptr);\n+        let ast_id = InFile::new(self.file_id, ast_id);\n         self.def_collector.def_map.diagnostics.push(DefDiagnostic::unconfigured_code(\n             self.module_id,\n-            ast_node,\n+            ast_id,\n             cfg.clone(),\n             self.def_collector.cfg_options.clone(),\n         ));"}]}