{"sha": "2d037aa4a66edb601fb65fb3efdc573771cba3e2", "node_id": "C_kwDOAAsO6NoAKDJkMDM3YWE0YTY2ZWRiNjAxZmI2NWZiM2VmZGM1NzM3NzFjYmEzZTI", "commit": {"author": {"name": "dswij", "email": "dswijj@gmail.com", "date": "2021-10-25T04:29:05Z"}, "committer": {"name": "dswij", "email": "dswijj@gmail.com", "date": "2021-11-11T04:30:07Z"}, "message": "Check for no_std and no_core attribute in `swap` lint\n\nThis commit adds a `no_std` and `no_core` check on `swap` lint and additionally suggest `core::mem::swap` whenever possible.\nRemove warning if both `std` and `core` is not present.", "tree": {"sha": "d7951f9baabccf11f9aa1299413fa629ef74c289", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d7951f9baabccf11f9aa1299413fa629ef74c289"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2d037aa4a66edb601fb65fb3efdc573771cba3e2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2d037aa4a66edb601fb65fb3efdc573771cba3e2", "html_url": "https://github.com/rust-lang/rust/commit/2d037aa4a66edb601fb65fb3efdc573771cba3e2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2d037aa4a66edb601fb65fb3efdc573771cba3e2/comments", "author": {"login": "dswij", "id": 44697459, "node_id": "MDQ6VXNlcjQ0Njk3NDU5", "avatar_url": "https://avatars.githubusercontent.com/u/44697459?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dswij", "html_url": "https://github.com/dswij", "followers_url": "https://api.github.com/users/dswij/followers", "following_url": "https://api.github.com/users/dswij/following{/other_user}", "gists_url": "https://api.github.com/users/dswij/gists{/gist_id}", "starred_url": "https://api.github.com/users/dswij/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dswij/subscriptions", "organizations_url": "https://api.github.com/users/dswij/orgs", "repos_url": "https://api.github.com/users/dswij/repos", "events_url": "https://api.github.com/users/dswij/events{/privacy}", "received_events_url": "https://api.github.com/users/dswij/received_events", "type": "User", "site_admin": false}, "committer": {"login": "dswij", "id": 44697459, "node_id": "MDQ6VXNlcjQ0Njk3NDU5", "avatar_url": "https://avatars.githubusercontent.com/u/44697459?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dswij", "html_url": "https://github.com/dswij", "followers_url": "https://api.github.com/users/dswij/followers", "following_url": "https://api.github.com/users/dswij/following{/other_user}", "gists_url": "https://api.github.com/users/dswij/gists{/gist_id}", "starred_url": "https://api.github.com/users/dswij/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dswij/subscriptions", "organizations_url": "https://api.github.com/users/dswij/orgs", "repos_url": "https://api.github.com/users/dswij/repos", "events_url": "https://api.github.com/users/dswij/events{/privacy}", "received_events_url": "https://api.github.com/users/dswij/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "847a95b68283ee682eca9d01067ae9620d1bd296", "url": "https://api.github.com/repos/rust-lang/rust/commits/847a95b68283ee682eca9d01067ae9620d1bd296", "html_url": "https://github.com/rust-lang/rust/commit/847a95b68283ee682eca9d01067ae9620d1bd296"}], "stats": {"total": 69, "additions": 48, "deletions": 21}, "files": [{"sha": "02fb6b79dc47cd9814bb78822413b0c443599606", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/2d037aa4a66edb601fb65fb3efdc573771cba3e2/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2d037aa4a66edb601fb65fb3efdc573771cba3e2/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=2d037aa4a66edb601fb65fb3efdc573771cba3e2", "patch": "@@ -8,6 +8,7 @@\n #![feature(rustc_private)]\n #![feature(stmt_expr_attributes)]\n #![feature(control_flow_enum)]\n+#![feature(let_else)]\n #![recursion_limit = \"512\"]\n #![cfg_attr(feature = \"deny-warnings\", deny(warnings))]\n #![allow(clippy::missing_docs_in_private_items, clippy::must_use_candidate)]"}, {"sha": "bd779124deeeda10b8f38e379192f78e8702488f", "filename": "clippy_lints/src/swap.rs", "status": "modified", "additions": 27, "deletions": 21, "changes": 48, "blob_url": "https://github.com/rust-lang/rust/blob/2d037aa4a66edb601fb65fb3efdc573771cba3e2/clippy_lints%2Fsrc%2Fswap.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2d037aa4a66edb601fb65fb3efdc573771cba3e2/clippy_lints%2Fsrc%2Fswap.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fswap.rs?ref=2d037aa4a66edb601fb65fb3efdc573771cba3e2", "patch": "@@ -2,7 +2,7 @@ use clippy_utils::diagnostics::{span_lint_and_sugg, span_lint_and_then};\n use clippy_utils::source::snippet_with_applicability;\n use clippy_utils::sugg::Sugg;\n use clippy_utils::ty::is_type_diagnostic_item;\n-use clippy_utils::{can_mut_borrow_both, differing_macro_contexts, eq_expr_value};\n+use clippy_utils::{can_mut_borrow_both, differing_macro_contexts, eq_expr_value, std_or_core};\n use if_chain::if_chain;\n use rustc_errors::Applicability;\n use rustc_hir::{BinOpKind, Block, Expr, ExprKind, PatKind, QPath, Stmt, StmtKind};\n@@ -113,6 +113,8 @@ fn generate_swap_warning(cx: &LateContext<'_>, e1: &Expr<'_>, e2: &Expr<'_>, spa\n \n     let first = Sugg::hir_with_applicability(cx, e1, \"..\", &mut applicability);\n     let second = Sugg::hir_with_applicability(cx, e2, \"..\", &mut applicability);\n+    let Some(sugg) = std_or_core(cx) else { return };\n+\n     span_lint_and_then(\n         cx,\n         MANUAL_SWAP,\n@@ -122,11 +124,11 @@ fn generate_swap_warning(cx: &LateContext<'_>, e1: &Expr<'_>, e2: &Expr<'_>, spa\n             diag.span_suggestion(\n                 span,\n                 \"try\",\n-                format!(\"std::mem::swap({}, {})\", first.mut_addr(), second.mut_addr()),\n+                format!(\"{}::mem::swap({}, {})\", sugg, first.mut_addr(), second.mut_addr()),\n                 applicability,\n             );\n             if !is_xor_based {\n-                diag.note(\"or maybe you should use `std::mem::replace`?\");\n+                diag.note(&format!(\"or maybe you should use `{}::mem::replace`?\", sugg));\n             }\n         },\n     );\n@@ -187,26 +189,30 @@ fn check_suspicious_swap(cx: &LateContext<'_>, block: &Block<'_>) {\n                 };\n \n                 let span = first.span.to(second.span);\n+                let Some(sugg) = std_or_core(cx) else { return };\n \n                 span_lint_and_then(cx,\n-                                   ALMOST_SWAPPED,\n-                                   span,\n-                                   &format!(\"this looks like you are trying to swap{}\", what),\n-                                   |diag| {\n-                                       if !what.is_empty() {\n-                                           diag.span_suggestion(\n-                                               span,\n-                                               \"try\",\n-                                               format!(\n-                                                   \"std::mem::swap({}, {})\",\n-                                                   lhs,\n-                                                   rhs,\n-                                               ),\n-                                               Applicability::MaybeIncorrect,\n-                                           );\n-                                           diag.note(\"or maybe you should use `std::mem::replace`?\");\n-                                       }\n-                                   });\n+                    ALMOST_SWAPPED,\n+                    span,\n+                    &format!(\"this looks like you are trying to swap{}\", what),\n+                    |diag| {\n+                        if !what.is_empty() {\n+                            diag.span_suggestion(\n+                                span,\n+                                \"try\",\n+                                format!(\n+                                    \"{}::mem::swap({}, {})\",\n+                                    sugg,\n+                                    lhs,\n+                                    rhs,\n+                                ),\n+                                Applicability::MaybeIncorrect,\n+                            );\n+                            diag.note(\n+                                &format!(\"or maybe you should use `{}::mem::replace`?\", sugg)\n+                            );\n+                        }\n+                    });\n             }\n         }\n     }"}, {"sha": "3fdea55aaa1bf743d87b77cbf8b7f3a56cee8167", "filename": "clippy_utils/src/lib.rs", "status": "modified", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/2d037aa4a66edb601fb65fb3efdc573771cba3e2/clippy_utils%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2d037aa4a66edb601fb65fb3efdc573771cba3e2/clippy_utils%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_utils%2Fsrc%2Flib.rs?ref=2d037aa4a66edb601fb65fb3efdc573771cba3e2", "patch": "@@ -1809,6 +1809,16 @@ pub fn is_expr_final_block_expr(tcx: TyCtxt<'_>, expr: &Expr<'_>) -> bool {\n     matches!(get_parent_node(tcx, expr.hir_id), Some(Node::Block(..)))\n }\n \n+pub fn std_or_core(cx: &LateContext<'_>) -> Option<&'static str> {\n+    if !is_no_std_crate(cx) {\n+        Some(\"std\")\n+    } else if !is_no_core_crate(cx) {\n+        Some(\"core\")\n+    } else {\n+        None\n+    }\n+}\n+\n pub fn is_no_std_crate(cx: &LateContext<'_>) -> bool {\n     cx.tcx.hir().attrs(hir::CRATE_HIR_ID).iter().any(|attr| {\n         if let ast::AttrKind::Normal(ref attr, _) = attr.kind {\n@@ -1819,6 +1829,16 @@ pub fn is_no_std_crate(cx: &LateContext<'_>) -> bool {\n     })\n }\n \n+pub fn is_no_core_crate(cx: &LateContext<'_>) -> bool {\n+    cx.tcx.hir().attrs(hir::CRATE_HIR_ID).iter().any(|attr| {\n+        if let ast::AttrKind::Normal(ref attr, _) = attr.kind {\n+            attr.path == sym::no_core\n+        } else {\n+            false\n+        }\n+    })\n+}\n+\n /// Check if parent of a hir node is a trait implementation block.\n /// For example, `f` in\n /// ```rust,ignore"}]}