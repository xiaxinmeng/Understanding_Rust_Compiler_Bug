{"sha": "f756d5da063461c99c20266dc4896d8388fe28b9", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY3NTZkNWRhMDYzNDYxYzk5YzIwMjY2ZGM0ODk2ZDgzODhmZTI4Yjk=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2020-02-05T12:41:43Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2020-02-05T12:41:43Z"}, "message": "Better cursor placement when merging arms", "tree": {"sha": "3f3e74630dadfc8ee45fc49386152a4c0d5e9cd6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3f3e74630dadfc8ee45fc49386152a4c0d5e9cd6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f756d5da063461c99c20266dc4896d8388fe28b9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f756d5da063461c99c20266dc4896d8388fe28b9", "html_url": "https://github.com/rust-lang/rust/commit/f756d5da063461c99c20266dc4896d8388fe28b9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f756d5da063461c99c20266dc4896d8388fe28b9/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "28acd01c638590a64a06148021ae60c0ccef8bb6", "url": "https://api.github.com/repos/rust-lang/rust/commits/28acd01c638590a64a06148021ae60c0ccef8bb6", "html_url": "https://github.com/rust-lang/rust/commit/28acd01c638590a64a06148021ae60c0ccef8bb6"}], "stats": {"total": 21, "additions": 17, "deletions": 4}, "files": [{"sha": "64c9379da18c16289e693bd0b8a3ab8096de06d0", "filename": "crates/ra_assists/src/assists/merge_match_arms.rs", "status": "modified", "additions": 17, "deletions": 4, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/f756d5da063461c99c20266dc4896d8388fe28b9/crates%2Fra_assists%2Fsrc%2Fassists%2Fmerge_match_arms.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f756d5da063461c99c20266dc4896d8388fe28b9/crates%2Fra_assists%2Fsrc%2Fassists%2Fmerge_match_arms.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_assists%2Fsrc%2Fassists%2Fmerge_match_arms.rs?ref=f756d5da063461c99c20266dc4896d8388fe28b9", "patch": "@@ -40,7 +40,17 @@ pub(crate) fn merge_match_arms(ctx: AssistCtx<impl HirDatabase>) -> Option<Assis\n     }\n     let current_expr = current_arm.expr()?;\n     let current_text_range = current_arm.syntax().text_range();\n-    let cursor_offset_back = current_text_range.end() - ctx.frange.range.start();\n+\n+    enum CursorPos {\n+        InExpr(TextUnit),\n+        InPat(TextUnit),\n+    }\n+    let cursor_pos = ctx.frange.range.start();\n+    let cursor_pos = if current_expr.syntax().text_range().contains(cursor_pos) {\n+        CursorPos::InExpr(current_text_range.end() - cursor_pos)\n+    } else {\n+        CursorPos::InPat(cursor_pos)\n+    };\n \n     // We check if the following match arms match this one. We could, but don't,\n     // compare to the previous match arm as well.\n@@ -78,7 +88,10 @@ pub(crate) fn merge_match_arms(ctx: AssistCtx<impl HirDatabase>) -> Option<Assis\n         let end = arms_to_merge.last().unwrap().syntax().text_range().end();\n \n         edit.target(current_text_range);\n-        edit.set_cursor(start + TextUnit::from_usize(arm.len()) - cursor_offset_back);\n+        edit.set_cursor(match cursor_pos {\n+            CursorPos::InExpr(back_offset) => start + TextUnit::from_usize(arm.len()) - back_offset,\n+            CursorPos::InPat(offset) => offset,\n+        });\n         edit.replace(TextRange::from_to(start, end), arm);\n     })\n }\n@@ -204,7 +217,7 @@ mod tests {\n \n             fn main() {\n                 match X::A {\n-                    X::A =><|> 92,\n+                    X::A<|> => 92,\n                     X::B => 92,\n                     X::C => 92,\n                     X::D => 62,\n@@ -217,7 +230,7 @@ mod tests {\n \n             fn main() {\n                 match X::A {\n-                    X::A | X::B | X::C =><|> 92,\n+                    X::A<|> | X::B | X::C => 92,\n                     X::D => 62,\n                     _ => panic!(),\n                 }"}]}