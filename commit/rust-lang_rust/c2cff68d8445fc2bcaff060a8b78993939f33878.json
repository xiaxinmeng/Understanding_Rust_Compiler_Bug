{"sha": "c2cff68d8445fc2bcaff060a8b78993939f33878", "node_id": "C_kwDOAAsO6NoAKGMyY2ZmNjhkODQ0NWZjMmJjYWZmMDYwYThiNzg5OTM5MzlmMzM4Nzg", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-09-11T20:02:33Z"}, "committer": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-09-12T22:08:30Z"}, "message": "Don't trim substitution if it's only whitespace", "tree": {"sha": "8f8ffb103a6ed90f2ea387cb3157f707a205c021", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8f8ffb103a6ed90f2ea387cb3157f707a205c021"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c2cff68d8445fc2bcaff060a8b78993939f33878", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c2cff68d8445fc2bcaff060a8b78993939f33878", "html_url": "https://github.com/rust-lang/rust/commit/c2cff68d8445fc2bcaff060a8b78993939f33878", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c2cff68d8445fc2bcaff060a8b78993939f33878/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "370c816a71742373401fd3c75699c04f1ceaf81f", "url": "https://api.github.com/repos/rust-lang/rust/commits/370c816a71742373401fd3c75699c04f1ceaf81f", "html_url": "https://github.com/rust-lang/rust/commit/370c816a71742373401fd3c75699c04f1ceaf81f"}], "stats": {"total": 56, "additions": 33, "deletions": 23}, "files": [{"sha": "016404c5f6737a47c57190199aaf44d8322f9212", "filename": "compiler/rustc_errors/src/emitter.rs", "status": "modified", "additions": 19, "deletions": 9, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/c2cff68d8445fc2bcaff060a8b78993939f33878/compiler%2Frustc_errors%2Fsrc%2Femitter.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c2cff68d8445fc2bcaff060a8b78993939f33878/compiler%2Frustc_errors%2Fsrc%2Femitter.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_errors%2Fsrc%2Femitter.rs?ref=c2cff68d8445fc2bcaff060a8b78993939f33878", "patch": "@@ -268,7 +268,10 @@ pub trait Emitter: Translate {\n                     SuggestionStyle::ShowAlways,\n                ].contains(&sugg.style)\n             {\n-                let substitution = &sugg.substitutions[0].parts[0].snippet.trim();\n+                // Don't trim the substitution if it's only whitespace changes\n+                let substitution = &sugg.substitutions[0].parts[0].snippet;\n+                let substitution =\n+                    if substitution.trim().is_empty() { substitution } else { substitution.trim() };\n                 let msg = if substitution.is_empty() || sugg.style.hide_inline() {\n                     // This substitution is only removal OR we explicitly don't want to show the\n                     // code inline (`hide_inline`). Therefore, we don't show the substitution.\n@@ -1880,16 +1883,23 @@ impl EmitterWriter {\n                     let span_start_pos = sm.lookup_char_pos(part.span.lo()).col_display;\n                     let span_end_pos = sm.lookup_char_pos(part.span.hi()).col_display;\n \n+                    // If this addition is _only_ whitespace, then don't trim it,\n+                    // or else we're just not rendering anything.\n+                    let is_whitespace_addition = part.snippet.trim().is_empty();\n+\n                     // Do not underline the leading...\n-                    let start = part.snippet.len().saturating_sub(part.snippet.trim_start().len());\n+                    let start = if is_whitespace_addition {\n+                        0\n+                    } else {\n+                        part.snippet.len().saturating_sub(part.snippet.trim_start().len())\n+                    };\n                     // ...or trailing spaces. Account for substitutions containing unicode\n                     // characters.\n-                    let sub_len: usize = part\n-                        .snippet\n-                        .trim()\n-                        .chars()\n-                        .map(|ch| unicode_width::UnicodeWidthChar::width(ch).unwrap_or(1))\n-                        .sum();\n+                    let sub_len: usize =\n+                        if is_whitespace_addition { &part.snippet } else { part.snippet.trim() }\n+                            .chars()\n+                            .map(|ch| unicode_width::UnicodeWidthChar::width(ch).unwrap_or(1))\n+                            .sum();\n \n                     let offset: isize = offsets\n                         .iter()\n@@ -2130,7 +2140,7 @@ impl EmitterWriter {\n     }\n }\n \n-#[derive(Clone, Copy)]\n+#[derive(Clone, Copy, Debug)]\n enum DisplaySuggestion {\n     Underline,\n     Diff,"}, {"sha": "c6bc082cf18db6cd87e4c683684986e7019162e0", "filename": "src/test/ui/rust-2021/reserved-prefixes-migration.stderr", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/c2cff68d8445fc2bcaff060a8b78993939f33878/src%2Ftest%2Fui%2Frust-2021%2Freserved-prefixes-migration.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c2cff68d8445fc2bcaff060a8b78993939f33878/src%2Ftest%2Fui%2Frust-2021%2Freserved-prefixes-migration.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frust-2021%2Freserved-prefixes-migration.stderr?ref=c2cff68d8445fc2bcaff060a8b78993939f33878", "patch": "@@ -14,7 +14,7 @@ LL | #![warn(rust_2021_prefixes_incompatible_syntax)]\n help: insert whitespace here to avoid this being parsed as a prefix in Rust 2021\n    |\n LL |     m2!(z \"hey\");\n-   |\n+   |          +\n \n warning: prefix `prefix` is unknown\n   --> $DIR/reserved-prefixes-migration.rs:19:9\n@@ -27,7 +27,7 @@ LL |     m2!(prefix\"hey\");\n help: insert whitespace here to avoid this being parsed as a prefix in Rust 2021\n    |\n LL |     m2!(prefix \"hey\");\n-   |\n+   |               +\n \n warning: prefix `hey` is unknown\n   --> $DIR/reserved-prefixes-migration.rs:22:9\n@@ -40,7 +40,7 @@ LL |     m3!(hey#123);\n help: insert whitespace here to avoid this being parsed as a prefix in Rust 2021\n    |\n LL |     m3!(hey #123);\n-   |\n+   |            +\n \n warning: prefix `hey` is unknown\n   --> $DIR/reserved-prefixes-migration.rs:25:9\n@@ -53,7 +53,7 @@ LL |     m3!(hey#hey);\n help: insert whitespace here to avoid this being parsed as a prefix in Rust 2021\n    |\n LL |     m3!(hey #hey);\n-   |\n+   |            +\n \n warning: prefix `kind` is unknown\n   --> $DIR/reserved-prefixes-migration.rs:35:14\n@@ -66,7 +66,7 @@ LL |     #name = #kind#value\n help: insert whitespace here to avoid this being parsed as a prefix in Rust 2021\n    |\n LL |     #name = #kind #value\n-   |\n+   |                  +\n \n warning: 5 warnings emitted\n "}, {"sha": "807d6d98bd3c3f82c1bdb282ce8c7ea9b81f3c97", "filename": "src/test/ui/rust-2021/reserved-prefixes.stderr", "status": "modified", "additions": 9, "deletions": 9, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/c2cff68d8445fc2bcaff060a8b78993939f33878/src%2Ftest%2Fui%2Frust-2021%2Freserved-prefixes.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c2cff68d8445fc2bcaff060a8b78993939f33878/src%2Ftest%2Fui%2Frust-2021%2Freserved-prefixes.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frust-2021%2Freserved-prefixes.stderr?ref=c2cff68d8445fc2bcaff060a8b78993939f33878", "patch": "@@ -8,7 +8,7 @@ LL |     demo3!(foo#bar);\n help: consider inserting whitespace here\n    |\n LL |     demo3!(foo #bar);\n-   |\n+   |               +\n \n error: prefix `foo` is unknown\n   --> $DIR/reserved-prefixes.rs:17:12\n@@ -20,7 +20,7 @@ LL |     demo2!(foo\"bar\");\n help: consider inserting whitespace here\n    |\n LL |     demo2!(foo \"bar\");\n-   |\n+   |               +\n \n error: prefix `foo` is unknown\n   --> $DIR/reserved-prefixes.rs:18:12\n@@ -32,7 +32,7 @@ LL |     demo2!(foo'b');\n help: consider inserting whitespace here\n    |\n LL |     demo2!(foo 'b');\n-   |\n+   |               +\n \n error: prefix `foo` is unknown\n   --> $DIR/reserved-prefixes.rs:20:12\n@@ -44,7 +44,7 @@ LL |     demo2!(foo'b);\n help: consider inserting whitespace here\n    |\n LL |     demo2!(foo 'b);\n-   |\n+   |               +\n \n error: prefix `foo` is unknown\n   --> $DIR/reserved-prefixes.rs:21:12\n@@ -56,7 +56,7 @@ LL |     demo3!(foo# bar);\n help: consider inserting whitespace here\n    |\n LL |     demo3!(foo # bar);\n-   |\n+   |               +\n \n error: prefix `foo` is unknown\n   --> $DIR/reserved-prefixes.rs:22:12\n@@ -68,7 +68,7 @@ LL |     demo4!(foo#! bar);\n help: consider inserting whitespace here\n    |\n LL |     demo4!(foo #! bar);\n-   |\n+   |               +\n \n error: prefix `foo` is unknown\n   --> $DIR/reserved-prefixes.rs:23:12\n@@ -80,7 +80,7 @@ LL |     demo4!(foo## bar);\n help: consider inserting whitespace here\n    |\n LL |     demo4!(foo ## bar);\n-   |\n+   |               +\n \n error: prefix `foo` is unknown\n   --> $DIR/reserved-prefixes.rs:25:12\n@@ -92,7 +92,7 @@ LL |     demo4!(foo#bar#);\n help: consider inserting whitespace here\n    |\n LL |     demo4!(foo #bar#);\n-   |\n+   |               +\n \n error: prefix `bar` is unknown\n   --> $DIR/reserved-prefixes.rs:25:16\n@@ -104,7 +104,7 @@ LL |     demo4!(foo#bar#);\n help: consider inserting whitespace here\n    |\n LL |     demo4!(foo#bar #);\n-   |\n+   |                   +\n \n error: aborting due to 9 previous errors\n "}]}