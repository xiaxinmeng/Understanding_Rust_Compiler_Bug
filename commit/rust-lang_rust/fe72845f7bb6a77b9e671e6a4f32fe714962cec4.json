{"sha": "fe72845f7bb6a77b9e671e6a4f32fe714962cec4", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZlNzI4NDVmN2JiNmE3N2I5ZTY3MWU2YTRmMzJmZTcxNDk2MmNlYzQ=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-05-16T20:19:45Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-05-16T20:19:45Z"}, "message": "Auto merge of #85312 - ehuss:macro_use-unused-attr, r=petrochenkov\n\nFix unused attributes on macro_rules.\n\nThe `unused_attributes` lint wasn't firing on attributes of `macro_rules` definitions. The consequence is that many attributes are silently ignored on `macro_rules`. The reason is that `unused_attributes` is a late-lint pass, and only has access to the HIR, which does not have macro_rules definitions.\n\nMy solution here is to change `non_exported_macro_attrs` to be `macro_attrs` (a list of all attributes used for `macro_rules`, instead of just those for `macro_export`), and then to check this list in the `unused_attributes` lint. There are a number of alternate approaches, but this seemed the most reliable and least invasive. I am open to completely different approaches, though.\n\nOne concern is that I don't fully understand the implications of extending `non_exported_macro_attrs` to include non-exported macros. That list was originally added in #62042 to handle stability attributes, so I suspect it was just an optimization since that was all that was needed. It was later extended to be included in SVH in #83901. #80641 also added a use to check for `invalid` attributes, which seems a little odd to me (it didn't validate non-exported macros, and seems highly specific).\n\nOverall, there doesn't seem to be a clear story of when `unused_attributes` should be used versus an error like E0518. I considered alternatively using an \"allow list\" of built-in attributes that can be used on macro_rules (allow, warn, deny, forbid, cfg, cfg_attr, macro_export, deprecated, doc), but I feel like that could be a pain to maintain.\n\nSome built-in attributes already present hard-errors when used with macro_rules. These are each hard-coded in various places:\n- `derive`\n- `test` and `bench`\n- `proc_macro` and `proc_macro_derive`\n- `inline`\n- `global_allocator`\n\nThe primary motivation is that I sometimes see people use `#[macro_use]` in front of `macro_rules`, which indicates there is some confusion out there (evident that there was even a case of it in rustc).", "tree": {"sha": "e4b4419ed788537aec0fef7c1bd1a0f6e018bc2c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e4b4419ed788537aec0fef7c1bd1a0f6e018bc2c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fe72845f7bb6a77b9e671e6a4f32fe714962cec4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fe72845f7bb6a77b9e671e6a4f32fe714962cec4", "html_url": "https://github.com/rust-lang/rust/commit/fe72845f7bb6a77b9e671e6a4f32fe714962cec4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fe72845f7bb6a77b9e671e6a4f32fe714962cec4/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7dc9ff5c629753b6930ecfe9a0446538b8e25fb7", "url": "https://api.github.com/repos/rust-lang/rust/commits/7dc9ff5c629753b6930ecfe9a0446538b8e25fb7", "html_url": "https://github.com/rust-lang/rust/commit/7dc9ff5c629753b6930ecfe9a0446538b8e25fb7"}, {"sha": "5bbc240ffbb0dcf510fd73d71dae529bd345e6b2", "url": "https://api.github.com/repos/rust-lang/rust/commits/5bbc240ffbb0dcf510fd73d71dae529bd345e6b2", "html_url": "https://github.com/rust-lang/rust/commit/5bbc240ffbb0dcf510fd73d71dae529bd345e6b2"}], "stats": {"total": 73, "additions": 70, "deletions": 3}, "files": [{"sha": "0a7ab4a2bafa38ea6b30ea762b2baf856f319c6c", "filename": "compiler/rustc_lint/src/late.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/fe72845f7bb6a77b9e671e6a4f32fe714962cec4/compiler%2Frustc_lint%2Fsrc%2Flate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fe72845f7bb6a77b9e671e6a4f32fe714962cec4/compiler%2Frustc_lint%2Fsrc%2Flate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_lint%2Fsrc%2Flate.rs?ref=fe72845f7bb6a77b9e671e6a4f32fe714962cec4", "patch": "@@ -448,6 +448,10 @@ fn late_lint_pass_crate<'tcx, T: LateLintPass<'tcx>>(tcx: TyCtxt<'tcx>, pass: T)\n         lint_callback!(cx, check_crate, krate);\n \n         hir_visit::walk_crate(cx, krate);\n+        for attr in krate.non_exported_macro_attrs {\n+            // This HIR ID is a lie, since the macro ID isn't available.\n+            cx.visit_attribute(hir::CRATE_HIR_ID, attr);\n+        }\n \n         lint_callback!(cx, check_crate_post, krate);\n     })"}, {"sha": "c17c2961434e5f6745982174a5f09ee3a1f18b5c", "filename": "compiler/rustc_target/src/asm/mod.rs", "status": "modified", "additions": 0, "deletions": 3, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/fe72845f7bb6a77b9e671e6a4f32fe714962cec4/compiler%2Frustc_target%2Fsrc%2Fasm%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fe72845f7bb6a77b9e671e6a4f32fe714962cec4/compiler%2Frustc_target%2Fsrc%2Fasm%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fasm%2Fmod.rs?ref=fe72845f7bb6a77b9e671e6a4f32fe714962cec4", "patch": "@@ -6,7 +6,6 @@ use rustc_span::Symbol;\n use std::fmt;\n use std::str::FromStr;\n \n-#[macro_use]\n macro_rules! def_reg_class {\n     ($arch:ident $arch_regclass:ident {\n         $(\n@@ -51,7 +50,6 @@ macro_rules! def_reg_class {\n     }\n }\n \n-#[macro_use]\n macro_rules! def_regs {\n     ($arch:ident $arch_reg:ident $arch_regclass:ident {\n         $(\n@@ -129,7 +127,6 @@ macro_rules! def_regs {\n     }\n }\n \n-#[macro_use]\n macro_rules! types {\n     (\n         $(_ : $($ty:expr),+;)?"}, {"sha": "396137a11d06995fb4147158d8e640729f923686", "filename": "src/test/ui/unused/unused-attr-macro-rules.rs", "status": "added", "additions": 34, "deletions": 0, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/fe72845f7bb6a77b9e671e6a4f32fe714962cec4/src%2Ftest%2Fui%2Funused%2Funused-attr-macro-rules.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fe72845f7bb6a77b9e671e6a4f32fe714962cec4/src%2Ftest%2Fui%2Funused%2Funused-attr-macro-rules.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Funused%2Funused-attr-macro-rules.rs?ref=fe72845f7bb6a77b9e671e6a4f32fe714962cec4", "patch": "@@ -0,0 +1,34 @@\n+#![deny(unused_attributes)]\n+// Unused attributes on macro_rules requires special handling since the\n+// macro_rules definition does not survive towards HIR.\n+\n+// A sample of various built-in attributes.\n+#[macro_export]\n+#[macro_use] //~ ERROR unused attribute\n+#[path=\"foo\"] //~ ERROR unused attribute\n+#[recursion_limit=\"1\"] //~ ERROR unused attribute\n+                       //~| ERROR crate-level attribute should be an inner attribute\n+macro_rules! foo {\n+    () => {};\n+}\n+\n+// The following should not warn about unused attributes.\n+#[allow(unused)]\n+macro_rules! foo2 {\n+    () => {};\n+}\n+\n+#[cfg(FALSE)]\n+macro_rules! foo {\n+    () => {};\n+}\n+\n+/// Some docs\n+#[deprecated]\n+#[doc = \"more docs\"]\n+#[macro_export]\n+macro_rules! bar {\n+    () => {};\n+}\n+\n+fn main() {}"}, {"sha": "4606be01ac014738d679395ee3a5f0c1361c0146", "filename": "src/test/ui/unused/unused-attr-macro-rules.stderr", "status": "added", "additions": 32, "deletions": 0, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/fe72845f7bb6a77b9e671e6a4f32fe714962cec4/src%2Ftest%2Fui%2Funused%2Funused-attr-macro-rules.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/fe72845f7bb6a77b9e671e6a4f32fe714962cec4/src%2Ftest%2Fui%2Funused%2Funused-attr-macro-rules.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Funused%2Funused-attr-macro-rules.stderr?ref=fe72845f7bb6a77b9e671e6a4f32fe714962cec4", "patch": "@@ -0,0 +1,32 @@\n+error: unused attribute\n+  --> $DIR/unused-attr-macro-rules.rs:7:1\n+   |\n+LL | #[macro_use]\n+   | ^^^^^^^^^^^^\n+   |\n+note: the lint level is defined here\n+  --> $DIR/unused-attr-macro-rules.rs:1:9\n+   |\n+LL | #![deny(unused_attributes)]\n+   |         ^^^^^^^^^^^^^^^^^\n+\n+error: unused attribute\n+  --> $DIR/unused-attr-macro-rules.rs:8:1\n+   |\n+LL | #[path=\"foo\"]\n+   | ^^^^^^^^^^^^^\n+\n+error: unused attribute\n+  --> $DIR/unused-attr-macro-rules.rs:9:1\n+   |\n+LL | #[recursion_limit=\"1\"]\n+   | ^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: crate-level attribute should be an inner attribute: add an exclamation mark: `#![foo]`\n+  --> $DIR/unused-attr-macro-rules.rs:9:1\n+   |\n+LL | #[recursion_limit=\"1\"]\n+   | ^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: aborting due to 4 previous errors\n+"}]}