{"sha": "25451967ee217b0d8a6db6195b84444f71f89d70", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI1NDUxOTY3ZWUyMTdiMGQ4YTZkYjYxOTViODQ0NDRmNzFmODlkNzA=", "commit": {"author": {"name": "Igor Matuszewski", "email": "Xanewok@gmail.com", "date": "2019-04-17T19:34:35Z"}, "committer": {"name": "Igor Matuszewski", "email": "Xanewok@gmail.com", "date": "2019-04-21T10:45:16Z"}, "message": "save-analysis: Use serde instead of libserialize to dump JSON data", "tree": {"sha": "778c9f1f8568bc4eb3c3d6a737d8afe08120d81c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/778c9f1f8568bc4eb3c3d6a737d8afe08120d81c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/25451967ee217b0d8a6db6195b84444f71f89d70", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/25451967ee217b0d8a6db6195b84444f71f89d70", "html_url": "https://github.com/rust-lang/rust/commit/25451967ee217b0d8a6db6195b84444f71f89d70", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/25451967ee217b0d8a6db6195b84444f71f89d70/comments", "author": {"login": "Xanewok", "id": 3093213, "node_id": "MDQ6VXNlcjMwOTMyMTM=", "avatar_url": "https://avatars.githubusercontent.com/u/3093213?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Xanewok", "html_url": "https://github.com/Xanewok", "followers_url": "https://api.github.com/users/Xanewok/followers", "following_url": "https://api.github.com/users/Xanewok/following{/other_user}", "gists_url": "https://api.github.com/users/Xanewok/gists{/gist_id}", "starred_url": "https://api.github.com/users/Xanewok/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Xanewok/subscriptions", "organizations_url": "https://api.github.com/users/Xanewok/orgs", "repos_url": "https://api.github.com/users/Xanewok/repos", "events_url": "https://api.github.com/users/Xanewok/events{/privacy}", "received_events_url": "https://api.github.com/users/Xanewok/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Xanewok", "id": 3093213, "node_id": "MDQ6VXNlcjMwOTMyMTM=", "avatar_url": "https://avatars.githubusercontent.com/u/3093213?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Xanewok", "html_url": "https://github.com/Xanewok", "followers_url": "https://api.github.com/users/Xanewok/followers", "following_url": "https://api.github.com/users/Xanewok/following{/other_user}", "gists_url": "https://api.github.com/users/Xanewok/gists{/gist_id}", "starred_url": "https://api.github.com/users/Xanewok/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Xanewok/subscriptions", "organizations_url": "https://api.github.com/users/Xanewok/orgs", "repos_url": "https://api.github.com/users/Xanewok/repos", "events_url": "https://api.github.com/users/Xanewok/events{/privacy}", "received_events_url": "https://api.github.com/users/Xanewok/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4d9c6cd7226e1839a195f1b6e7d40a3ccf9bb062", "url": "https://api.github.com/repos/rust-lang/rust/commits/4d9c6cd7226e1839a195f1b6e7d40a3ccf9bb062", "html_url": "https://github.com/rust-lang/rust/commit/4d9c6cd7226e1839a195f1b6e7d40a3ccf9bb062"}], "stats": {"total": 20, "additions": 11, "deletions": 9}, "files": [{"sha": "bfb75874785a07e83900c9e494f9157154b09643", "filename": "Cargo.lock", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/25451967ee217b0d8a6db6195b84444f71f89d70/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/25451967ee217b0d8a6db6195b84444f71f89d70/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=25451967ee217b0d8a6db6195b84444f71f89d70", "patch": "@@ -2933,11 +2933,11 @@ dependencies = [\n  \"rls-data 0.18.2 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"rls-span 0.4.1 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"rustc 0.0.0\",\n- \"rustc-serialize 0.3.24 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"rustc_codegen_utils 0.0.0\",\n  \"rustc_data_structures 0.0.0\",\n  \"rustc_target 0.0.0\",\n  \"rustc_typeck 0.0.0\",\n+ \"serde_json 1.0.33 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"syntax 0.0.0\",\n  \"syntax_pos 0.0.0\",\n ]"}, {"sha": "aee827776fc251c496896f25bdd2c8e36c51fcce", "filename": "src/librustc_save_analysis/Cargo.toml", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/25451967ee217b0d8a6db6195b84444f71f89d70/src%2Flibrustc_save_analysis%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/25451967ee217b0d8a6db6195b84444f71f89d70/src%2Flibrustc_save_analysis%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_save_analysis%2FCargo.toml?ref=25451967ee217b0d8a6db6195b84444f71f89d70", "patch": "@@ -16,9 +16,8 @@ rustc_data_structures = { path = \"../librustc_data_structures\" }\n rustc_codegen_utils = { path = \"../librustc_codegen_utils\" }\n rustc_target = { path = \"../librustc_target\" }\n rustc_typeck = { path = \"../librustc_typeck\" }\n+serde_json = \"1\"\n syntax = { path = \"../libsyntax\" }\n syntax_pos = { path = \"../libsyntax_pos\" }\n rls-data = \"0.18.1\"\n rls-span = \"0.4\"\n-# FIXME(#40527) should move rustc serialize out of tree\n-rustc-serialize = \"0.3\""}, {"sha": "82b78369e1339ea7552164559bfd663ab097fed8", "filename": "src/librustc_save_analysis/json_dumper.rs", "status": "modified", "additions": 2, "deletions": 4, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/25451967ee217b0d8a6db6195b84444f71f89d70/src%2Flibrustc_save_analysis%2Fjson_dumper.rs", "raw_url": "https://github.com/rust-lang/rust/raw/25451967ee217b0d8a6db6195b84444f71f89d70/src%2Flibrustc_save_analysis%2Fjson_dumper.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_save_analysis%2Fjson_dumper.rs?ref=25451967ee217b0d8a6db6195b84444f71f89d70", "patch": "@@ -1,7 +1,5 @@\n use std::io::Write;\n \n-use rustc_serialize::json::as_json;\n-\n use rls_data::config::Config;\n use rls_data::{self, Analysis, CompilationOptions, CratePreludeData, Def, DefKind, Impl, Import,\n                MacroRef, Ref, RefKind, Relation};\n@@ -31,8 +29,8 @@ pub struct WriteOutput<'b, W: Write> {\n \n impl<'b, W: Write> DumpOutput for WriteOutput<'b, W> {\n     fn dump(&mut self, result: &Analysis) {\n-        if write!(self.output, \"{}\", as_json(&result)).is_err() {\n-            error!(\"Error writing output\");\n+        if let Err(e) = serde_json::to_writer(self.output.by_ref(), result) {\n+            error!(\"Can't serialize save-analysis: {:?}\", e);\n         }\n     }\n }"}, {"sha": "c173d51fd4014ea80f284ee876353a56fb6fdfcc", "filename": "src/librustc_save_analysis/lib.rs", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/25451967ee217b0d8a6db6195b84444f71f89d70/src%2Flibrustc_save_analysis%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/25451967ee217b0d8a6db6195b84444f71f89d70/src%2Flibrustc_save_analysis%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_save_analysis%2Flib.rs?ref=25451967ee217b0d8a6db6195b84444f71f89d70", "patch": "@@ -1141,10 +1141,15 @@ fn find_config(supplied: Option<Config>) -> Config {\n     if let Some(config) = supplied {\n         return config;\n     }\n+\n     match env::var_os(\"RUST_SAVE_ANALYSIS_CONFIG\") {\n-        Some(config_string) => rustc_serialize::json::decode(config_string.to_str().unwrap())\n-            .expect(\"Could not deserialize save-analysis config\"),\n         None => Config::default(),\n+        Some(config) => config.to_str()\n+            .ok_or(())\n+            .map_err(|_| error!(\"`RUST_SAVE_ANALYSIS_CONFIG` isn't UTF-8\"))\n+            .and_then(|cfg|  serde_json::from_str(cfg)\n+                .map_err(|_| error!(\"Could not deserialize save-analysis config\"))\n+            ).unwrap_or_default()\n     }\n }\n "}]}