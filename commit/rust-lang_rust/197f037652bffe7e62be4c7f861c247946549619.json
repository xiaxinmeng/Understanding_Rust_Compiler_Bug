{"sha": "197f037652bffe7e62be4c7f861c247946549619", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE5N2YwMzc2NTJiZmZlN2U2MmJlNGM3Zjg2MWMyNDc5NDY1NDk2MTk=", "commit": {"author": {"name": "Michael Woerister", "email": "michaelwoerister@posteo.net", "date": "2017-01-24T16:03:37Z"}, "committer": {"name": "Michael Woerister", "email": "michaelwoerister@posteo.net", "date": "2017-01-24T22:56:29Z"}, "message": "incr.comp.: Make cross-crate tracking for incr. comp. opt-in.", "tree": {"sha": "561b3fd7e5c3400861f7c6469a33c5c4329e1de4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/561b3fd7e5c3400861f7c6469a33c5c4329e1de4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/197f037652bffe7e62be4c7f861c247946549619", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/197f037652bffe7e62be4c7f861c247946549619", "html_url": "https://github.com/rust-lang/rust/commit/197f037652bffe7e62be4c7f861c247946549619", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/197f037652bffe7e62be4c7f861c247946549619/comments", "author": {"login": "michaelwoerister", "id": 1825894, "node_id": "MDQ6VXNlcjE4MjU4OTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1825894?v=4", "gravatar_id": "", "url": "https://api.github.com/users/michaelwoerister", "html_url": "https://github.com/michaelwoerister", "followers_url": "https://api.github.com/users/michaelwoerister/followers", "following_url": "https://api.github.com/users/michaelwoerister/following{/other_user}", "gists_url": "https://api.github.com/users/michaelwoerister/gists{/gist_id}", "starred_url": "https://api.github.com/users/michaelwoerister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/michaelwoerister/subscriptions", "organizations_url": "https://api.github.com/users/michaelwoerister/orgs", "repos_url": "https://api.github.com/users/michaelwoerister/repos", "events_url": "https://api.github.com/users/michaelwoerister/events{/privacy}", "received_events_url": "https://api.github.com/users/michaelwoerister/received_events", "type": "User", "site_admin": false}, "committer": {"login": "michaelwoerister", "id": 1825894, "node_id": "MDQ6VXNlcjE4MjU4OTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1825894?v=4", "gravatar_id": "", "url": "https://api.github.com/users/michaelwoerister", "html_url": "https://github.com/michaelwoerister", "followers_url": "https://api.github.com/users/michaelwoerister/followers", "following_url": "https://api.github.com/users/michaelwoerister/following{/other_user}", "gists_url": "https://api.github.com/users/michaelwoerister/gists{/gist_id}", "starred_url": "https://api.github.com/users/michaelwoerister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/michaelwoerister/subscriptions", "organizations_url": "https://api.github.com/users/michaelwoerister/orgs", "repos_url": "https://api.github.com/users/michaelwoerister/repos", "events_url": "https://api.github.com/users/michaelwoerister/events{/privacy}", "received_events_url": "https://api.github.com/users/michaelwoerister/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d2d8ae6575281e92a58899fb8f8c51fc8f84de04", "url": "https://api.github.com/repos/rust-lang/rust/commits/d2d8ae6575281e92a58899fb8f8c51fc8f84de04", "html_url": "https://github.com/rust-lang/rust/commit/d2d8ae6575281e92a58899fb8f8c51fc8f84de04"}], "stats": {"total": 51, "additions": 38, "deletions": 13}, "files": [{"sha": "7419d74287b97a9d3e4c0adabc88063b2a823f45", "filename": "src/librustc/session/config.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/197f037652bffe7e62be4c7f861c247946549619/src%2Flibrustc%2Fsession%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/197f037652bffe7e62be4c7f861c247946549619/src%2Flibrustc%2Fsession%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fsession%2Fconfig.rs?ref=197f037652bffe7e62be4c7f861c247946549619", "patch": "@@ -899,6 +899,8 @@ options! {DebuggingOptions, DebuggingSetter, basic_debugging_options,\n           \"attempt to recover from parse errors (experimental)\"),\n     incremental: Option<String> = (None, parse_opt_string, [UNTRACKED],\n           \"enable incremental compilation (experimental)\"),\n+    incremental_cc: bool = (false, parse_bool, [UNTRACKED],\n+          \"enable cross-crate incremental compilation (even more experimental)\"),\n     incremental_info: bool = (false, parse_bool, [UNTRACKED],\n         \"print high-level information about incremental reuse (or the lack thereof)\"),\n     incremental_dump_hash: bool = (false, parse_bool, [UNTRACKED],"}, {"sha": "327927b2f7749480165ba3c90e34b7363c8d306a", "filename": "src/librustc_incremental/persist/preds.rs", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/197f037652bffe7e62be4c7f861c247946549619/src%2Flibrustc_incremental%2Fpersist%2Fpreds.rs", "raw_url": "https://github.com/rust-lang/rust/raw/197f037652bffe7e62be4c7f861c247946549619/src%2Flibrustc_incremental%2Fpersist%2Fpreds.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_incremental%2Fpersist%2Fpreds.rs?ref=197f037652bffe7e62be4c7f861c247946549619", "patch": "@@ -33,8 +33,12 @@ pub struct Predecessors<'query> {\n \n impl<'q> Predecessors<'q> {\n     pub fn new(query: &'q DepGraphQuery<DefId>, hcx: &mut HashContext) -> Self {\n-        // Find nodes for which we want to know the full set of preds\n         let tcx = hcx.tcx;\n+\n+        let collect_for_metadata = tcx.sess.opts.debugging_opts.incremental_cc ||\n+                                   tcx.sess.opts.debugging_opts.query_dep_graph;\n+\n+        // Find nodes for which we want to know the full set of preds\n         let node_count = query.graph.len_nodes();\n \n         // Set up some data structures the cache predecessor search needs:\n@@ -52,7 +56,7 @@ impl<'q> Predecessors<'q> {\n             .enumerate()\n             .filter(|&(_, node)| match node.data {\n                 DepNode::WorkProduct(_) => true,\n-                DepNode::MetaData(ref def_id) => def_id.is_local(),\n+                DepNode::MetaData(ref def_id) => collect_for_metadata && def_id.is_local(),\n \n                 // if -Z query-dep-graph is passed, save more extended data\n                 // to enable better unit testing"}, {"sha": "f626905f27d4a1d5ff2f9333e04a126861dedbb5", "filename": "src/librustc_incremental/persist/save.rs", "status": "modified", "additions": 15, "deletions": 11, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/197f037652bffe7e62be4c7f861c247946549619/src%2Flibrustc_incremental%2Fpersist%2Fsave.rs", "raw_url": "https://github.com/rust-lang/rust/raw/197f037652bffe7e62be4c7f861c247946549619/src%2Flibrustc_incremental%2Fpersist%2Fsave.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_incremental%2Fpersist%2Fsave.rs?ref=197f037652bffe7e62be4c7f861c247946549619", "patch": "@@ -55,17 +55,21 @@ pub fn save_dep_graph<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>,\n     let preds = Predecessors::new(&query, &mut hcx);\n     let mut current_metadata_hashes = FxHashMap();\n \n-    // IMPORTANT: We are saving the metadata hashes *before* the dep-graph,\n-    //            since metadata-encoding might add new entries to the\n-    //            DefIdDirectory (which is saved in the dep-graph file).\n-    save_in(sess,\n-            metadata_hash_export_path(sess),\n-            |e| encode_metadata_hashes(tcx,\n-                                       svh,\n-                                       &preds,\n-                                       &mut builder,\n-                                       &mut current_metadata_hashes,\n-                                       e));\n+    if sess.opts.debugging_opts.incremental_cc ||\n+       sess.opts.debugging_opts.query_dep_graph {\n+        // IMPORTANT: We are saving the metadata hashes *before* the dep-graph,\n+        //            since metadata-encoding might add new entries to the\n+        //            DefIdDirectory (which is saved in the dep-graph file).\n+        save_in(sess,\n+                metadata_hash_export_path(sess),\n+                |e| encode_metadata_hashes(tcx,\n+                                           svh,\n+                                           &preds,\n+                                           &mut builder,\n+                                           &mut current_metadata_hashes,\n+                                           e));\n+    }\n+\n     save_in(sess,\n             dep_graph_path(sess),\n             |e| encode_dep_graph(&preds, &mut builder, e));"}, {"sha": "1064c97b744a4e51a899957ed90ac8f6cf35b341", "filename": "src/test/incremental/add_private_fn_at_krate_root_cc/auxiliary/point.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/197f037652bffe7e62be4c7f861c247946549619/src%2Ftest%2Fincremental%2Fadd_private_fn_at_krate_root_cc%2Fauxiliary%2Fpoint.rs", "raw_url": "https://github.com/rust-lang/rust/raw/197f037652bffe7e62be4c7f861c247946549619/src%2Ftest%2Fincremental%2Fadd_private_fn_at_krate_root_cc%2Fauxiliary%2Fpoint.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fincremental%2Fadd_private_fn_at_krate_root_cc%2Fauxiliary%2Fpoint.rs?ref=197f037652bffe7e62be4c7f861c247946549619", "patch": "@@ -8,6 +8,8 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n+// compile-flags: -Z incremental-cc\n+\n pub struct Point {\n     pub x: f32,\n     pub y: f32,"}, {"sha": "a02b71a753cc3bdff1f9b05b4a1e71ba4f3c6676", "filename": "src/test/incremental/callee_caller_cross_crate/auxiliary/a.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/197f037652bffe7e62be4c7f861c247946549619/src%2Ftest%2Fincremental%2Fcallee_caller_cross_crate%2Fauxiliary%2Fa.rs", "raw_url": "https://github.com/rust-lang/rust/raw/197f037652bffe7e62be4c7f861c247946549619/src%2Ftest%2Fincremental%2Fcallee_caller_cross_crate%2Fauxiliary%2Fa.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fincremental%2Fcallee_caller_cross_crate%2Fauxiliary%2Fa.rs?ref=197f037652bffe7e62be4c7f861c247946549619", "patch": "@@ -8,6 +8,8 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n+// compile-flags: -Z incremental-cc\n+\n #![crate_type=\"rlib\"]\n \n #[cfg(rpass1)]"}, {"sha": "08eef2a73f68f21d2bdb9f72083689fb8f762b17", "filename": "src/test/incremental/change_private_fn_cc/auxiliary/point.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/197f037652bffe7e62be4c7f861c247946549619/src%2Ftest%2Fincremental%2Fchange_private_fn_cc%2Fauxiliary%2Fpoint.rs", "raw_url": "https://github.com/rust-lang/rust/raw/197f037652bffe7e62be4c7f861c247946549619/src%2Ftest%2Fincremental%2Fchange_private_fn_cc%2Fauxiliary%2Fpoint.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fincremental%2Fchange_private_fn_cc%2Fauxiliary%2Fpoint.rs?ref=197f037652bffe7e62be4c7f861c247946549619", "patch": "@@ -8,6 +8,8 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n+// compile-flags: -Z incremental-cc\n+\n pub struct Point {\n     pub x: f32,\n     pub y: f32,"}, {"sha": "e69dc51119e920e8bbdd7455c0a5356f8d538c8f", "filename": "src/test/incremental/change_private_impl_method_cc/auxiliary/point.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/197f037652bffe7e62be4c7f861c247946549619/src%2Ftest%2Fincremental%2Fchange_private_impl_method_cc%2Fauxiliary%2Fpoint.rs", "raw_url": "https://github.com/rust-lang/rust/raw/197f037652bffe7e62be4c7f861c247946549619/src%2Ftest%2Fincremental%2Fchange_private_impl_method_cc%2Fauxiliary%2Fpoint.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fincremental%2Fchange_private_impl_method_cc%2Fauxiliary%2Fpoint.rs?ref=197f037652bffe7e62be4c7f861c247946549619", "patch": "@@ -8,6 +8,8 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n+// compile-flags: -Z incremental-cc\n+\n pub struct Point {\n     pub x: f32,\n     pub y: f32,"}, {"sha": "39547fb7359f56e1ba64e78cd466b260481b71bc", "filename": "src/test/incremental/remove-private-item-cross-crate/auxiliary/a.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/197f037652bffe7e62be4c7f861c247946549619/src%2Ftest%2Fincremental%2Fremove-private-item-cross-crate%2Fauxiliary%2Fa.rs", "raw_url": "https://github.com/rust-lang/rust/raw/197f037652bffe7e62be4c7f861c247946549619/src%2Ftest%2Fincremental%2Fremove-private-item-cross-crate%2Fauxiliary%2Fa.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fincremental%2Fremove-private-item-cross-crate%2Fauxiliary%2Fa.rs?ref=197f037652bffe7e62be4c7f861c247946549619", "patch": "@@ -8,6 +8,8 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n+// compile-flags: -Z incremental-cc\n+\n #![allow(warnings)]\n #![crate_name = \"a\"]\n #![crate_type = \"rlib\"]"}, {"sha": "3ecd9aff3f8cdc348d5f55bb415bdf7301b36f77", "filename": "src/test/incremental/rlib_cross_crate/auxiliary/a.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/197f037652bffe7e62be4c7f861c247946549619/src%2Ftest%2Fincremental%2Frlib_cross_crate%2Fauxiliary%2Fa.rs", "raw_url": "https://github.com/rust-lang/rust/raw/197f037652bffe7e62be4c7f861c247946549619/src%2Ftest%2Fincremental%2Frlib_cross_crate%2Fauxiliary%2Fa.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fincremental%2Frlib_cross_crate%2Fauxiliary%2Fa.rs?ref=197f037652bffe7e62be4c7f861c247946549619", "patch": "@@ -8,6 +8,7 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n+// compile-flags: -Z incremental-cc\n // no-prefer-dynamic\n \n #![crate_type=\"rlib\"]"}, {"sha": "d14ebf78d8222b452975d9d7d985f665efac1027", "filename": "src/test/incremental/struct_change_field_type_cross_crate/auxiliary/a.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/197f037652bffe7e62be4c7f861c247946549619/src%2Ftest%2Fincremental%2Fstruct_change_field_type_cross_crate%2Fauxiliary%2Fa.rs", "raw_url": "https://github.com/rust-lang/rust/raw/197f037652bffe7e62be4c7f861c247946549619/src%2Ftest%2Fincremental%2Fstruct_change_field_type_cross_crate%2Fauxiliary%2Fa.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fincremental%2Fstruct_change_field_type_cross_crate%2Fauxiliary%2Fa.rs?ref=197f037652bffe7e62be4c7f861c247946549619", "patch": "@@ -8,6 +8,8 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n+// compile-flags: -Z incremental-cc\n+\n #![crate_type=\"rlib\"]\n \n  #[cfg(rpass1)]"}, {"sha": "0393bcda991565f874e0cba700d01da027f2cca4", "filename": "src/test/incremental/type_alias_cross_crate/auxiliary/a.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/197f037652bffe7e62be4c7f861c247946549619/src%2Ftest%2Fincremental%2Ftype_alias_cross_crate%2Fauxiliary%2Fa.rs", "raw_url": "https://github.com/rust-lang/rust/raw/197f037652bffe7e62be4c7f861c247946549619/src%2Ftest%2Fincremental%2Ftype_alias_cross_crate%2Fauxiliary%2Fa.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fincremental%2Ftype_alias_cross_crate%2Fauxiliary%2Fa.rs?ref=197f037652bffe7e62be4c7f861c247946549619", "patch": "@@ -8,6 +8,8 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n+// compile-flags: -Z incremental-cc\n+\n #![crate_type=\"rlib\"]\n \n #[cfg(rpass1)]"}]}