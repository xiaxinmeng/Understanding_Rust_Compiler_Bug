{"sha": "690cd953273317ee4f3eaefd95bbd3538e929522", "node_id": "MDY6Q29tbWl0NzI0NzEyOjY5MGNkOTUzMjczMzE3ZWU0ZjNlYWVmZDk1YmJkMzUzOGU5Mjk1MjI=", "commit": {"author": {"name": "Kirill Bulatov", "email": "mail4score@gmail.com", "date": "2021-06-10T21:10:09Z"}, "committer": {"name": "Kirill Bulatov", "email": "mail4score@gmail.com", "date": "2021-06-10T21:10:09Z"}, "message": "Reduce fst_path calls", "tree": {"sha": "47210c5b426680b218362ca4dd58f2ee79cf6244", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/47210c5b426680b218362ca4dd58f2ee79cf6244"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/690cd953273317ee4f3eaefd95bbd3538e929522", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/690cd953273317ee4f3eaefd95bbd3538e929522", "html_url": "https://github.com/rust-lang/rust/commit/690cd953273317ee4f3eaefd95bbd3538e929522", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/690cd953273317ee4f3eaefd95bbd3538e929522/comments", "author": {"login": "SomeoneToIgnore", "id": 2690773, "node_id": "MDQ6VXNlcjI2OTA3NzM=", "avatar_url": "https://avatars.githubusercontent.com/u/2690773?v=4", "gravatar_id": "", "url": "https://api.github.com/users/SomeoneToIgnore", "html_url": "https://github.com/SomeoneToIgnore", "followers_url": "https://api.github.com/users/SomeoneToIgnore/followers", "following_url": "https://api.github.com/users/SomeoneToIgnore/following{/other_user}", "gists_url": "https://api.github.com/users/SomeoneToIgnore/gists{/gist_id}", "starred_url": "https://api.github.com/users/SomeoneToIgnore/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/SomeoneToIgnore/subscriptions", "organizations_url": "https://api.github.com/users/SomeoneToIgnore/orgs", "repos_url": "https://api.github.com/users/SomeoneToIgnore/repos", "events_url": "https://api.github.com/users/SomeoneToIgnore/events{/privacy}", "received_events_url": "https://api.github.com/users/SomeoneToIgnore/received_events", "type": "User", "site_admin": false}, "committer": {"login": "SomeoneToIgnore", "id": 2690773, "node_id": "MDQ6VXNlcjI2OTA3NzM=", "avatar_url": "https://avatars.githubusercontent.com/u/2690773?v=4", "gravatar_id": "", "url": "https://api.github.com/users/SomeoneToIgnore", "html_url": "https://github.com/SomeoneToIgnore", "followers_url": "https://api.github.com/users/SomeoneToIgnore/followers", "following_url": "https://api.github.com/users/SomeoneToIgnore/following{/other_user}", "gists_url": "https://api.github.com/users/SomeoneToIgnore/gists{/gist_id}", "starred_url": "https://api.github.com/users/SomeoneToIgnore/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/SomeoneToIgnore/subscriptions", "organizations_url": "https://api.github.com/users/SomeoneToIgnore/orgs", "repos_url": "https://api.github.com/users/SomeoneToIgnore/repos", "events_url": "https://api.github.com/users/SomeoneToIgnore/events{/privacy}", "received_events_url": "https://api.github.com/users/SomeoneToIgnore/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3aaf07b8cb9a17669894db9f3e6afdb302676fdb", "url": "https://api.github.com/repos/rust-lang/rust/commits/3aaf07b8cb9a17669894db9f3e6afdb302676fdb", "html_url": "https://github.com/rust-lang/rust/commit/3aaf07b8cb9a17669894db9f3e6afdb302676fdb"}], "stats": {"total": 16, "additions": 5, "deletions": 11}, "files": [{"sha": "404e3e15394da9bd13607d839a91af6bde16755d", "filename": "crates/hir_def/src/import_map.rs", "status": "modified", "additions": 5, "deletions": 11, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/690cd953273317ee4f3eaefd95bbd3538e929522/crates%2Fhir_def%2Fsrc%2Fimport_map.rs", "raw_url": "https://github.com/rust-lang/rust/raw/690cd953273317ee4f3eaefd95bbd3538e929522/crates%2Fhir_def%2Fsrc%2Fimport_map.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fimport_map.rs?ref=690cd953273317ee4f3eaefd95bbd3538e929522", "patch": "@@ -1,6 +1,6 @@\n //! A map of all publicly exported items in a crate.\n \n-use std::{cmp::Ordering, fmt, hash::BuildHasherDefault, sync::Arc};\n+use std::{fmt, hash::BuildHasherDefault, sync::Arc};\n \n use base_db::CrateId;\n use fst::{self, Streamer};\n@@ -73,21 +73,21 @@ impl ImportMap {\n         let mut import_map = collect_import_map(db, krate);\n \n         let mut importables = import_map.map.iter().collect::<Vec<_>>();\n-        importables.sort_by(cmp);\n+        importables.sort_by_cached_key(|(_, import_info)| fst_path(&import_info.path));\n \n         // Build the FST, taking care not to insert duplicate values.\n \n         let mut builder = fst::MapBuilder::memory();\n         let mut last_batch_start = 0;\n \n         for idx in 0..importables.len() {\n-            if let Some(next_item) = importables.get(idx + 1) {\n-                if cmp(&importables[last_batch_start], next_item) == Ordering::Equal {\n+            let key = fst_path(&importables[last_batch_start].1.path);\n+            if let Some((_, next_import_info)) = importables.get(idx + 1) {\n+                if key == fst_path(&next_import_info.path) {\n                     continue;\n                 }\n             }\n \n-            let key = fst_path(&importables[last_batch_start].1.path);\n             builder.insert(key, last_batch_start as u64).unwrap();\n \n             last_batch_start = idx + 1;\n@@ -255,12 +255,6 @@ fn fst_path(path: &ImportPath) -> String {\n     s\n }\n \n-fn cmp((_, lhs): &(&ItemInNs, &ImportInfo), (_, rhs): &(&ItemInNs, &ImportInfo)) -> Ordering {\n-    let lhs_str = fst_path(&lhs.path);\n-    let rhs_str = fst_path(&rhs.path);\n-    lhs_str.cmp(&rhs_str)\n-}\n-\n #[derive(Debug, Eq, PartialEq, Hash)]\n pub enum ImportKind {\n     Module,"}]}