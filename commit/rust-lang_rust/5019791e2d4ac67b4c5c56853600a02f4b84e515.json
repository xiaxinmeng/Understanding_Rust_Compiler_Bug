{"sha": "5019791e2d4ac67b4c5c56853600a02f4b84e515", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUwMTk3OTFlMmQ0YWM2N2I0YzVjNTY4NTM2MDBhMDJmNGI4NGU1MTU=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-12-08T11:16:19Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-12-08T11:16:19Z"}, "message": "Auto merge of #79752 - cjgillot:dead-alien, r=lcnr\n\nVisit ForeignItems when marking dead code\n\nFollow-up to #79318\n\nr? `@lcnr`", "tree": {"sha": "5821caf1950f46b3b31f44ddcf913fb2da3da634", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5821caf1950f46b3b31f44ddcf913fb2da3da634"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5019791e2d4ac67b4c5c56853600a02f4b84e515", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5019791e2d4ac67b4c5c56853600a02f4b84e515", "html_url": "https://github.com/rust-lang/rust/commit/5019791e2d4ac67b4c5c56853600a02f4b84e515", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5019791e2d4ac67b4c5c56853600a02f4b84e515/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4fd4a98d4788bc987d7f7add9df5f5ead6a1c15e", "url": "https://api.github.com/repos/rust-lang/rust/commits/4fd4a98d4788bc987d7f7add9df5f5ead6a1c15e", "html_url": "https://github.com/rust-lang/rust/commit/4fd4a98d4788bc987d7f7add9df5f5ead6a1c15e"}, {"sha": "37853f925f115eae8b2a3750d071de6af32309e7", "url": "https://api.github.com/repos/rust-lang/rust/commits/37853f925f115eae8b2a3750d071de6af32309e7", "html_url": "https://github.com/rust-lang/rust/commit/37853f925f115eae8b2a3750d071de6af32309e7"}], "stats": {"total": 65, "additions": 44, "deletions": 21}, "files": [{"sha": "bbd6b9b505fb49bfe146135290c5e57b7ce77ad9", "filename": "compiler/rustc_passes/src/dead.rs", "status": "modified", "additions": 25, "deletions": 21, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/5019791e2d4ac67b4c5c56853600a02f4b84e515/compiler%2Frustc_passes%2Fsrc%2Fdead.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5019791e2d4ac67b4c5c56853600a02f4b84e515/compiler%2Frustc_passes%2Fsrc%2Fdead.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fdead.rs?ref=5019791e2d4ac67b4c5c56853600a02f4b84e515", "patch": "@@ -396,24 +396,6 @@ impl<'v, 'k, 'tcx> ItemLikeVisitor<'v> for LifeSeeder<'k, 'tcx> {\n                     }\n                 }\n             }\n-            hir::ItemKind::Trait(.., trait_item_refs) => {\n-                for trait_item_ref in trait_item_refs {\n-                    let trait_item = self.krate.trait_item(trait_item_ref.id);\n-                    match trait_item.kind {\n-                        hir::TraitItemKind::Const(_, Some(_))\n-                        | hir::TraitItemKind::Fn(_, hir::TraitFn::Provided(_)) => {\n-                            if has_allow_dead_code_or_lang_attr(\n-                                self.tcx,\n-                                trait_item.hir_id,\n-                                &trait_item.attrs,\n-                            ) {\n-                                self.worklist.push(trait_item.hir_id);\n-                            }\n-                        }\n-                        _ => {}\n-                    }\n-                }\n-            }\n             hir::ItemKind::Impl { ref of_trait, items, .. } => {\n                 if of_trait.is_some() {\n                     self.worklist.push(item.hir_id);\n@@ -440,15 +422,37 @@ impl<'v, 'k, 'tcx> ItemLikeVisitor<'v> for LifeSeeder<'k, 'tcx> {\n         }\n     }\n \n-    fn visit_trait_item(&mut self, _item: &hir::TraitItem<'_>) {\n-        // ignore: we are handling this in `visit_item` above\n+    fn visit_trait_item(&mut self, trait_item: &hir::TraitItem<'_>) {\n+        match trait_item.kind {\n+            hir::TraitItemKind::Const(_, Some(_))\n+            | hir::TraitItemKind::Fn(_, hir::TraitFn::Provided(_)) => {\n+                if has_allow_dead_code_or_lang_attr(self.tcx, trait_item.hir_id, &trait_item.attrs)\n+                {\n+                    self.worklist.push(trait_item.hir_id);\n+                }\n+            }\n+            _ => {}\n+        }\n     }\n \n     fn visit_impl_item(&mut self, _item: &hir::ImplItem<'_>) {\n         // ignore: we are handling this in `visit_item` above\n     }\n \n-    fn visit_foreign_item(&mut self, _item: &'v hir::ForeignItem<'v>) {}\n+    fn visit_foreign_item(&mut self, foreign_item: &hir::ForeignItem<'_>) {\n+        match foreign_item.kind {\n+            hir::ForeignItemKind::Static(..) | hir::ForeignItemKind::Fn(..) => {\n+                if has_allow_dead_code_or_lang_attr(\n+                    self.tcx,\n+                    foreign_item.hir_id,\n+                    &foreign_item.attrs,\n+                ) {\n+                    self.worklist.push(foreign_item.hir_id);\n+                }\n+            }\n+            _ => {}\n+        }\n+    }\n }\n \n fn create_and_seed_worklist<'tcx>("}, {"sha": "b6c593f316f05ac6efce5a0dc88aaec978f2161b", "filename": "src/test/ui/lint/dead-code/type-in-foreign.rs", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/5019791e2d4ac67b4c5c56853600a02f4b84e515/src%2Ftest%2Fui%2Flint%2Fdead-code%2Ftype-in-foreign.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5019791e2d4ac67b4c5c56853600a02f4b84e515/src%2Ftest%2Fui%2Flint%2Fdead-code%2Ftype-in-foreign.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Fdead-code%2Ftype-in-foreign.rs?ref=5019791e2d4ac67b4c5c56853600a02f4b84e515", "patch": "@@ -0,0 +1,19 @@\n+// Verify that we do not warn on types that are used by foreign functions.\n+// check-pass\n+#![deny(dead_code)]\n+\n+#[repr(C)]\n+struct Type(u8);\n+\n+#[repr(C)]\n+struct Param(u8);\n+\n+extern \"C\" {\n+    #[allow(dead_code)]\n+    fn hey(t: Param);\n+\n+    #[allow(dead_code)]\n+    static much: Type;\n+}\n+\n+fn main() {}"}]}