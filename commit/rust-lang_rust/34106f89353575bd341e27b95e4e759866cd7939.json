{"sha": "34106f89353575bd341e27b95e4e759866cd7939", "node_id": "C_kwDOAAsO6NoAKDM0MTA2Zjg5MzUzNTc1YmQzNDFlMjdiOTVlNGU3NTk4NjZjZDc5Mzk", "commit": {"author": {"name": "Josh Triplett", "email": "josh@joshtriplett.org", "date": "2021-10-21T14:04:22Z"}, "committer": {"name": "Josh Triplett", "email": "josh@joshtriplett.org", "date": "2022-01-01T23:57:35Z"}, "message": "Stabilize -Z instrument-coverage as -C instrument-coverage\n\nContinue supporting -Z instrument-coverage for compatibility for now,\nbut show a deprecation warning for it.\n\nUpdate uses and documentation to use the -C option.\n\nMove the documentation from the unstable book to stable rustc\ndocumentation.", "tree": {"sha": "e1e016742b35c080d9d39949fe50e62fdacc0529", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e1e016742b35c080d9d39949fe50e62fdacc0529"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/34106f89353575bd341e27b95e4e759866cd7939", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/34106f89353575bd341e27b95e4e759866cd7939", "html_url": "https://github.com/rust-lang/rust/commit/34106f89353575bd341e27b95e4e759866cd7939", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/34106f89353575bd341e27b95e4e759866cd7939/comments", "author": {"login": "joshtriplett", "id": 162737, "node_id": "MDQ6VXNlcjE2MjczNw==", "avatar_url": "https://avatars.githubusercontent.com/u/162737?v=4", "gravatar_id": "", "url": "https://api.github.com/users/joshtriplett", "html_url": "https://github.com/joshtriplett", "followers_url": "https://api.github.com/users/joshtriplett/followers", "following_url": "https://api.github.com/users/joshtriplett/following{/other_user}", "gists_url": "https://api.github.com/users/joshtriplett/gists{/gist_id}", "starred_url": "https://api.github.com/users/joshtriplett/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/joshtriplett/subscriptions", "organizations_url": "https://api.github.com/users/joshtriplett/orgs", "repos_url": "https://api.github.com/users/joshtriplett/repos", "events_url": "https://api.github.com/users/joshtriplett/events{/privacy}", "received_events_url": "https://api.github.com/users/joshtriplett/received_events", "type": "User", "site_admin": false}, "committer": {"login": "joshtriplett", "id": 162737, "node_id": "MDQ6VXNlcjE2MjczNw==", "avatar_url": "https://avatars.githubusercontent.com/u/162737?v=4", "gravatar_id": "", "url": "https://api.github.com/users/joshtriplett", "html_url": "https://github.com/joshtriplett", "followers_url": "https://api.github.com/users/joshtriplett/followers", "following_url": "https://api.github.com/users/joshtriplett/following{/other_user}", "gists_url": "https://api.github.com/users/joshtriplett/gists{/gist_id}", "starred_url": "https://api.github.com/users/joshtriplett/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/joshtriplett/subscriptions", "organizations_url": "https://api.github.com/users/joshtriplett/orgs", "repos_url": "https://api.github.com/users/joshtriplett/repos", "events_url": "https://api.github.com/users/joshtriplett/events{/privacy}", "received_events_url": "https://api.github.com/users/joshtriplett/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ff94b3b12b30d1a52d594cb48f80efa39a6029a6", "url": "https://api.github.com/repos/rust-lang/rust/commits/ff94b3b12b30d1a52d594cb48f80efa39a6029a6", "html_url": "https://github.com/rust-lang/rust/commit/ff94b3b12b30d1a52d594cb48f80efa39a6029a6"}], "stats": {"total": 181, "additions": 102, "deletions": 79}, "files": [{"sha": "dc48eac715617e24099f77e941ece87f8de2f683", "filename": "compiler/rustc_codegen_llvm/src/coverageinfo/mapgen.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/34106f89353575bd341e27b95e4e759866cd7939/compiler%2Frustc_codegen_llvm%2Fsrc%2Fcoverageinfo%2Fmapgen.rs", "raw_url": "https://github.com/rust-lang/rust/raw/34106f89353575bd341e27b95e4e759866cd7939/compiler%2Frustc_codegen_llvm%2Fsrc%2Fcoverageinfo%2Fmapgen.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fcoverageinfo%2Fmapgen.rs?ref=34106f89353575bd341e27b95e4e759866cd7939", "patch": "@@ -37,7 +37,7 @@ pub fn finalize<'ll, 'tcx>(cx: &CodegenCx<'ll, 'tcx>) {\n     // LLVM 12.\n     let version = coverageinfo::mapping_version();\n     if version < 4 {\n-        tcx.sess.fatal(\"rustc option `-Z instrument-coverage` requires LLVM 12 or higher.\");\n+        tcx.sess.fatal(\"rustc option `-C instrument-coverage` requires LLVM 12 or higher.\");\n     }\n \n     debug!(\"Generating coverage map for CodegenUnit: `{}`\", cx.codegen_unit.name());\n@@ -264,7 +264,7 @@ fn save_function_record(\n /// (functions referenced by other \"used\" or public items). Any other functions considered unused,\n /// or \"Unreachable\", were still parsed and processed through the MIR stage, but were not\n /// codegenned. (Note that `-Clink-dead-code` can force some unused code to be codegenned, but\n-/// that flag is known to cause other errors, when combined with `-Z instrument-coverage`; and\n+/// that flag is known to cause other errors, when combined with `-C instrument-coverage`; and\n /// `-Clink-dead-code` will not generate code for unused generic functions.)\n ///\n /// We can find the unused functions (including generic functions) by the set difference of all MIR"}, {"sha": "e77201cf0c800a144b0853b2010184f5533b48c9", "filename": "compiler/rustc_codegen_ssa/src/traits/coverageinfo.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/34106f89353575bd341e27b95e4e759866cd7939/compiler%2Frustc_codegen_ssa%2Fsrc%2Ftraits%2Fcoverageinfo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/34106f89353575bd341e27b95e4e759866cd7939/compiler%2Frustc_codegen_ssa%2Fsrc%2Ftraits%2Fcoverageinfo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Ftraits%2Fcoverageinfo.rs?ref=34106f89353575bd341e27b95e4e759866cd7939", "patch": "@@ -22,15 +22,15 @@ pub trait CoverageInfoMethods<'tcx>: BackendTypes {\n \n pub trait CoverageInfoBuilderMethods<'tcx>: BackendTypes {\n     /// Returns true if the function source hash was added to the coverage map (even if it had\n-    /// already been added, for this instance). Returns false *only* if `-Z instrument-coverage` is\n+    /// already been added, for this instance). Returns false *only* if `-C instrument-coverage` is\n     /// not enabled (a coverage map is not being generated).\n     fn set_function_source_hash(\n         &mut self,\n         instance: Instance<'tcx>,\n         function_source_hash: u64,\n     ) -> bool;\n \n-    /// Returns true if the counter was added to the coverage map; false if `-Z instrument-coverage`\n+    /// Returns true if the counter was added to the coverage map; false if `-C instrument-coverage`\n     /// is not enabled (a coverage map is not being generated).\n     fn add_coverage_counter(\n         &mut self,\n@@ -40,7 +40,7 @@ pub trait CoverageInfoBuilderMethods<'tcx>: BackendTypes {\n     ) -> bool;\n \n     /// Returns true if the expression was added to the coverage map; false if\n-    /// `-Z instrument-coverage` is not enabled (a coverage map is not being generated).\n+    /// `-C instrument-coverage` is not enabled (a coverage map is not being generated).\n     fn add_coverage_counter_expression(\n         &mut self,\n         instance: Instance<'tcx>,\n@@ -51,7 +51,7 @@ pub trait CoverageInfoBuilderMethods<'tcx>: BackendTypes {\n         region: Option<CodeRegion>,\n     ) -> bool;\n \n-    /// Returns true if the region was added to the coverage map; false if `-Z instrument-coverage`\n+    /// Returns true if the region was added to the coverage map; false if `-C instrument-coverage`\n     /// is not enabled (a coverage map is not being generated).\n     fn add_coverage_unreachable(&mut self, instance: Instance<'tcx>, region: CodeRegion) -> bool;\n }"}, {"sha": "508af06610a60b33202398daa1dff0e0b99b8d11", "filename": "compiler/rustc_interface/src/tests.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/34106f89353575bd341e27b95e4e759866cd7939/compiler%2Frustc_interface%2Fsrc%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/34106f89353575bd341e27b95e4e759866cd7939/compiler%2Frustc_interface%2Fsrc%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2Fsrc%2Ftests.rs?ref=34106f89353575bd341e27b95e4e759866cd7939", "patch": "@@ -575,6 +575,7 @@ fn test_codegen_options_tracking_hash() {\n     tracked!(force_frame_pointers, Some(false));\n     tracked!(force_unwind_tables, Some(true));\n     tracked!(inline_threshold, Some(0xf007ba11));\n+    tracked!(instrument_coverage, Some(InstrumentCoverage::All));\n     tracked!(linker_plugin_lto, LinkerPluginLto::LinkerPluginAuto);\n     tracked!(link_dead_code, Some(true));\n     tracked!(llvm_args, vec![String::from(\"1\"), String::from(\"2\")]);"}, {"sha": "1ea3ba439b5a9c4911f76f6ef8f194351670b790", "filename": "compiler/rustc_middle/src/mir/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/34106f89353575bd341e27b95e4e759866cd7939/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/34106f89353575bd341e27b95e4e759866cd7939/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmod.rs?ref=34106f89353575bd341e27b95e4e759866cd7939", "patch": "@@ -1590,7 +1590,7 @@ pub enum StatementKind<'tcx> {\n     /// - `Bivariant` -- no effect\n     AscribeUserType(Box<(Place<'tcx>, UserTypeProjection)>, ty::Variance),\n \n-    /// Marks the start of a \"coverage region\", injected with '-Zinstrument-coverage'. A\n+    /// Marks the start of a \"coverage region\", injected with '-Cinstrument-coverage'. A\n     /// `Coverage` statement carries metadata about the coverage region, used to inject a coverage\n     /// map into the binary. If `Coverage::kind` is a `Counter`, the statement also generates\n     /// executable code, to increment a counter variable at runtime, each time the code region is"}, {"sha": "4b8eb3fbd96075193bbda54bf49245f041b5ce5b", "filename": "compiler/rustc_middle/src/mir/query.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/34106f89353575bd341e27b95e4e759866cd7939/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fquery.rs", "raw_url": "https://github.com/rust-lang/rust/raw/34106f89353575bd341e27b95e4e759866cd7939/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fquery.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fquery.rs?ref=34106f89353575bd341e27b95e4e759866cd7939", "patch": "@@ -390,7 +390,7 @@ pub struct DestructuredConst<'tcx> {\n }\n \n /// Coverage information summarized from a MIR if instrumented for source code coverage (see\n-/// compiler option `-Zinstrument-coverage`). This information is generated by the\n+/// compiler option `-Cinstrument-coverage`). This information is generated by the\n /// `InstrumentCoverage` MIR pass and can be retrieved via the `coverageinfo` query.\n #[derive(Clone, TyEncodable, TyDecodable, Debug, HashStable)]\n pub struct CoverageInfo {"}, {"sha": "0ae34e264a9b492dc9f9f4597327220891676462", "filename": "compiler/rustc_middle/src/query/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/34106f89353575bd341e27b95e4e759866cd7939/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/34106f89353575bd341e27b95e4e759866cd7939/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs?ref=34106f89353575bd341e27b95e4e759866cd7939", "patch": "@@ -380,7 +380,7 @@ rustc_queries! {\n     }\n \n     /// Returns coverage summary info for a function, after executing the `InstrumentCoverage`\n-    /// MIR pass (assuming the -Zinstrument-coverage option is enabled).\n+    /// MIR pass (assuming the -Cinstrument-coverage option is enabled).\n     query coverageinfo(key: ty::InstanceDef<'tcx>) -> mir::CoverageInfo {\n         desc { |tcx| \"retrieving coverage info from MIR for `{}`\", tcx.def_path_str(key.def_id()) }\n         storage(ArenaCacheSelector<'tcx>)"}, {"sha": "c64165163ad382355e0a5c303e0db98d6fa3f9f4", "filename": "compiler/rustc_mir_transform/src/coverage/debug.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/34106f89353575bd341e27b95e4e759866cd7939/compiler%2Frustc_mir_transform%2Fsrc%2Fcoverage%2Fdebug.rs", "raw_url": "https://github.com/rust-lang/rust/raw/34106f89353575bd341e27b95e4e759866cd7939/compiler%2Frustc_mir_transform%2Fsrc%2Fcoverage%2Fdebug.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Fcoverage%2Fdebug.rs?ref=34106f89353575bd341e27b95e4e759866cd7939", "patch": "@@ -3,7 +3,7 @@\n //!\n //! To enable coverage, include the rustc command line option:\n //!\n-//!   * `-Z instrument-coverage`\n+//!   * `-C instrument-coverage`\n //!\n //! MIR Dump Files, with additional `CoverageGraph` graphviz and `CoverageSpan` spanview\n //! ------------------------------------------------------------------------------------"}, {"sha": "1c7f73d542e8165722e5014d5ae941a55f5cf43a", "filename": "compiler/rustc_mir_transform/src/simplify.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/34106f89353575bd341e27b95e4e759866cd7939/compiler%2Frustc_mir_transform%2Fsrc%2Fsimplify.rs", "raw_url": "https://github.com/rust-lang/rust/raw/34106f89353575bd341e27b95e4e759866cd7939/compiler%2Frustc_mir_transform%2Fsrc%2Fsimplify.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Fsimplify.rs?ref=34106f89353575bd341e27b95e4e759866cd7939", "patch": "@@ -303,7 +303,7 @@ pub fn remove_dead_blocks<'tcx>(tcx: TyCtxt<'tcx>, body: &mut Body<'tcx>) {\n /// evaluation: `if false { ... }`.\n ///\n /// Those statements are bypassed by redirecting paths in the CFG around the\n-/// `dead blocks`; but with `-Z instrument-coverage`, the dead blocks usually\n+/// `dead blocks`; but with `-C instrument-coverage`, the dead blocks usually\n /// include `Coverage` statements representing the Rust source code regions to\n /// be counted at runtime. Without these `Coverage` statements, the regions are\n /// lost, and the Rust source code will show no coverage information."}, {"sha": "fa14a95bb0c2a6e98d30e60b41c6617cc1ab05a8", "filename": "compiler/rustc_session/src/config.rs", "status": "modified", "additions": 32, "deletions": 13, "changes": 45, "blob_url": "https://github.com/rust-lang/rust/blob/34106f89353575bd341e27b95e4e759866cd7939/compiler%2Frustc_session%2Fsrc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/34106f89353575bd341e27b95e4e759866cd7939/compiler%2Frustc_session%2Fsrc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Fconfig.rs?ref=34106f89353575bd341e27b95e4e759866cd7939", "patch": "@@ -127,15 +127,15 @@ pub enum MirSpanview {\n     Block,\n }\n \n-/// The different settings that the `-Z instrument-coverage` flag can have.\n+/// The different settings that the `-C instrument-coverage` flag can have.\n ///\n-/// Coverage instrumentation now supports combining `-Z instrument-coverage`\n+/// Coverage instrumentation now supports combining `-C instrument-coverage`\n /// with compiler and linker optimization (enabled with `-O` or `-C opt-level=1`\n /// and higher). Nevertheless, there are many variables, depending on options\n /// selected, code structure, and enabled attributes. If errors are encountered,\n /// either while compiling or when generating `llvm-cov show` reports, consider\n /// lowering the optimization level, including or excluding `-C link-dead-code`,\n-/// or using `-Z instrument-coverage=except-unused-functions` or `-Z\n+/// or using `-C instrument-coverage=except-unused-functions` or `-C\n /// instrument-coverage=except-unused-generics`.\n ///\n /// Note that `ExceptUnusedFunctions` means: When `mapgen.rs` generates the\n@@ -148,13 +148,13 @@ pub enum MirSpanview {\n /// unless the function has type parameters.\n #[derive(Clone, Copy, PartialEq, Hash, Debug)]\n pub enum InstrumentCoverage {\n-    /// Default `-Z instrument-coverage` or `-Z instrument-coverage=statement`\n+    /// Default `-C instrument-coverage` or `-C instrument-coverage=statement`\n     All,\n-    /// `-Z instrument-coverage=except-unused-generics`\n+    /// `-C instrument-coverage=except-unused-generics`\n     ExceptUnusedGenerics,\n-    /// `-Z instrument-coverage=except-unused-functions`\n+    /// `-C instrument-coverage=except-unused-functions`\n     ExceptUnusedFunctions,\n-    /// `-Z instrument-coverage=off` (or `no`, etc.)\n+    /// `-C instrument-coverage=off` (or `no`, etc.)\n     Off,\n }\n \n@@ -2144,18 +2144,37 @@ pub fn build_session_options(matches: &getopts::Matches) -> Options {\n         _ => {}\n     }\n \n-    if debugging_opts.instrument_coverage.is_some()\n-        && debugging_opts.instrument_coverage != Some(InstrumentCoverage::Off)\n-    {\n+    // Handle both `-Z instrument-coverage` and `-C instrument-coverage`; the latter takes\n+    // precedence.\n+    match (cg.instrument_coverage, debugging_opts.instrument_coverage) {\n+        (Some(ic_c), Some(ic_z)) if ic_c != ic_z => {\n+            early_error(\n+                error_format,\n+                \"incompatible values passed for `-C instrument-coverage` \\\n+                and `-Z instrument-coverage`\",\n+            );\n+        }\n+        (None, None) => {}\n+        (None, ic) => {\n+            early_warn(\n+                error_format,\n+                \"`-Z instrument-coverage` is deprecated; use `-C instrument-coverage`\",\n+            );\n+            cg.instrument_coverage = ic;\n+        }\n+        _ => {}\n+    }\n+\n+    if cg.instrument_coverage.is_some() && cg.instrument_coverage != Some(InstrumentCoverage::Off) {\n         if cg.profile_generate.enabled() || cg.profile_use.is_some() {\n             early_error(\n                 error_format,\n-                \"option `-Z instrument-coverage` is not compatible with either `-C profile-use` \\\n+                \"option `-C instrument-coverage` is not compatible with either `-C profile-use` \\\n                 or `-C profile-generate`\",\n             );\n         }\n \n-        // `-Z instrument-coverage` implies `-C symbol-mangling-version=v0` - to ensure consistent\n+        // `-C instrument-coverage` implies `-C symbol-mangling-version=v0` - to ensure consistent\n         // and reversible name mangling. Note, LLVM coverage tools can analyze coverage over\n         // multiple runs, including some changes to source code; so mangled names must be consistent\n         // across compilations.\n@@ -2164,7 +2183,7 @@ pub fn build_session_options(matches: &getopts::Matches) -> Options {\n             Some(SymbolManglingVersion::Legacy) => {\n                 early_warn(\n                     error_format,\n-                    \"-Z instrument-coverage requires symbol mangling version `v0`, \\\n+                    \"-C instrument-coverage requires symbol mangling version `v0`, \\\n                     but `-C symbol-mangling-version=legacy` was specified\",\n                 );\n             }"}, {"sha": "2b39d97d55b17467d455dc3c3dc19887e07846fa", "filename": "compiler/rustc_session/src/options.rs", "status": "modified", "additions": 11, "deletions": 4, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/34106f89353575bd341e27b95e4e759866cd7939/compiler%2Frustc_session%2Fsrc%2Foptions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/34106f89353575bd341e27b95e4e759866cd7939/compiler%2Frustc_session%2Fsrc%2Foptions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Foptions.rs?ref=34106f89353575bd341e27b95e4e759866cd7939", "patch": "@@ -109,17 +109,16 @@ impl Options {\n     }\n \n     pub fn instrument_coverage(&self) -> bool {\n-        self.debugging_opts.instrument_coverage.unwrap_or(InstrumentCoverage::Off)\n-            != InstrumentCoverage::Off\n+        self.cg.instrument_coverage.unwrap_or(InstrumentCoverage::Off) != InstrumentCoverage::Off\n     }\n \n     pub fn instrument_coverage_except_unused_generics(&self) -> bool {\n-        self.debugging_opts.instrument_coverage.unwrap_or(InstrumentCoverage::Off)\n+        self.cg.instrument_coverage.unwrap_or(InstrumentCoverage::Off)\n             == InstrumentCoverage::ExceptUnusedGenerics\n     }\n \n     pub fn instrument_coverage_except_unused_functions(&self) -> bool {\n-        self.debugging_opts.instrument_coverage.unwrap_or(InstrumentCoverage::Off)\n+        self.cg.instrument_coverage.unwrap_or(InstrumentCoverage::Off)\n             == InstrumentCoverage::ExceptUnusedFunctions\n     }\n }\n@@ -1021,6 +1020,14 @@ options! {\n         \"enable incremental compilation\"),\n     inline_threshold: Option<u32> = (None, parse_opt_number, [TRACKED],\n         \"set the threshold for inlining a function\"),\n+    instrument_coverage: Option<InstrumentCoverage> = (None, parse_instrument_coverage, [TRACKED],\n+        \"instrument the generated code to support LLVM source-based code coverage \\\n+        reports (note, the compiler build config must include `profiler = true`); \\\n+        implies `-C symbol-mangling-version=v0`. Optional values are:\n+        `=all` (implicit value)\n+        `=except-unused-generics`\n+        `=except-unused-functions`\n+        `=off` (default)\"),\n     link_arg: (/* redirected to link_args */) = ((), parse_string_push, [UNTRACKED],\n         \"a single extra argument to append to the linker invocation (can be used several times)\"),\n     link_args: Vec<String> = (Vec::new(), parse_list, [UNTRACKED],"}, {"sha": "98688ca65b7e29d28db104da044bcd5b37858214", "filename": "config.toml.example", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/34106f89353575bd341e27b95e4e759866cd7939/config.toml.example", "raw_url": "https://github.com/rust-lang/rust/raw/34106f89353575bd341e27b95e4e759866cd7939/config.toml.example", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/config.toml.example?ref=34106f89353575bd341e27b95e4e759866cd7939", "patch": "@@ -289,7 +289,7 @@ changelog-seen = 2\n #sanitizers = false\n \n # Build the profiler runtime (required when compiling with options that depend\n-# on this runtime, such as `-C profile-generate` or `-Z instrument-coverage`).\n+# on this runtime, such as `-C profile-generate` or `-C instrument-coverage`).\n #profiler = false\n \n # Indicates whether the native libraries linked into Cargo will be statically\n@@ -671,7 +671,7 @@ changelog-seen = 2\n #sanitizers = build.sanitizers (bool)\n \n # Build the profiler runtime for this target(required when compiling with options that depend\n-# on this runtime, such as `-C profile-generate` or `-Z instrument-coverage`).\n+# on this runtime, such as `-C profile-generate` or `-C instrument-coverage`).\n # This option will override the same option under [build] section.\n #profiler = build.profiler (bool)\n "}, {"sha": "1142bf59a3923bcdab0de0c98e3a31e5d7c5dd58", "filename": "src/doc/rustc/src/SUMMARY.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/34106f89353575bd341e27b95e4e759866cd7939/src%2Fdoc%2Frustc%2Fsrc%2FSUMMARY.md", "raw_url": "https://github.com/rust-lang/rust/raw/34106f89353575bd341e27b95e4e759866cd7939/src%2Fdoc%2Frustc%2Fsrc%2FSUMMARY.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Frustc%2Fsrc%2FSUMMARY.md?ref=34106f89353575bd341e27b95e4e759866cd7939", "patch": "@@ -23,6 +23,7 @@\n     - [Custom Targets](targets/custom.md)\n     - [Known Issues](targets/known-issues.md)\n - [Profile-guided Optimization](profile-guided-optimization.md)\n+- [Instrumentation-based Code Coverage](instrument-coverage.md)\n - [Linker-plugin based LTO](linker-plugin-lto.md)\n - [Exploit Mitigations](exploit-mitigations.md)\n - [Contributing to `rustc`](contributing.md)"}, {"sha": "d50c2317a0c7443566c21bc109381e19847771da", "filename": "src/doc/rustc/src/codegen-options/index.md", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/34106f89353575bd341e27b95e4e759866cd7939/src%2Fdoc%2Frustc%2Fsrc%2Fcodegen-options%2Findex.md", "raw_url": "https://github.com/rust-lang/rust/raw/34106f89353575bd341e27b95e4e759866cd7939/src%2Fdoc%2Frustc%2Fsrc%2Fcodegen-options%2Findex.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Frustc%2Fsrc%2Fcodegen-options%2Findex.md?ref=34106f89353575bd341e27b95e4e759866cd7939", "patch": "@@ -177,6 +177,11 @@ The default depends on the [opt-level](#opt-level):\n | s         | 75 |\n | z         | 25 |\n \n+## instrument-coverage\n+\n+This option enables instrumentation-based code coverage support. See the\n+chapter on [instrumentation-based code coverage] for more information.\n+\n ## link-arg\n \n This flag lets you append a single extra argument to the linker invocation.\n@@ -597,5 +602,6 @@ effective only for x86 targets.\n \n [option-emit]: ../command-line-arguments.md#option-emit\n [option-o-optimize]: ../command-line-arguments.md#option-o-optimize\n+[instrumentation-based code coverage]: ../instrument-coverage.md\n [profile-guided optimization]: ../profile-guided-optimization.md\n [option-g-debug]: ../command-line-arguments.md#option-g-debug"}, {"sha": "f0b71db1201583bbc011d91260353d74e9f5463b", "filename": "src/doc/rustc/src/instrument-coverage.md", "status": "renamed", "additions": 25, "deletions": 31, "changes": 56, "blob_url": "https://github.com/rust-lang/rust/blob/34106f89353575bd341e27b95e4e759866cd7939/src%2Fdoc%2Frustc%2Fsrc%2Finstrument-coverage.md", "raw_url": "https://github.com/rust-lang/rust/raw/34106f89353575bd341e27b95e4e759866cd7939/src%2Fdoc%2Frustc%2Fsrc%2Finstrument-coverage.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Frustc%2Fsrc%2Finstrument-coverage.md?ref=34106f89353575bd341e27b95e4e759866cd7939", "patch": "@@ -1,23 +1,17 @@\n # `instrument-coverage`\n \n-The tracking issue for this feature is: [#79121].\n-\n-[#79121]: https://github.com/rust-lang/rust/issues/79121\n-\n----\n-\n ## Introduction\n \n The Rust compiler includes two code coverage implementations:\n \n -   A GCC-compatible, gcov-based coverage implementation, enabled with `-Z profile`, which derives coverage data based on DebugInfo.\n--   A source-based code coverage implementation, enabled with `-Z instrument-coverage`, which uses LLVM's native, efficient coverage instrumentation to generate very precise coverage data.\n+-   A source-based code coverage implementation, enabled with `-C instrument-coverage`, which uses LLVM's native, efficient coverage instrumentation to generate very precise coverage data.\n \n-This document describes how to enable and use the LLVM instrumentation-based coverage, via the `-Z instrument-coverage` compiler flag.\n+This document describes how to enable and use the LLVM instrumentation-based coverage, via the `-C instrument-coverage` compiler flag.\n \n ## How it works\n \n-When `-Z instrument-coverage` is enabled, the Rust compiler enhances rust-based libraries and binaries by:\n+When `-C instrument-coverage` is enabled, the Rust compiler enhances rust-based libraries and binaries by:\n \n -   Automatically injecting calls to an LLVM intrinsic ([`llvm.instrprof.increment`]), at functions and branches in compiled code, to increment counters when conditional sections of code are executed.\n -   Embedding additional information in the data section of each library and binary (using the [LLVM Code Coverage Mapping Format] _Version 5_, if compiling with LLVM 12, or _Version 6_, if compiling with LLVM 13 or higher), to define the code regions (start and end positions in the source code) being counted.\n@@ -27,21 +21,21 @@ When running a coverage-instrumented program, the counter values are written to\n [`llvm.instrprof.increment`]: https://llvm.org/docs/LangRef.html#llvm-instrprof-increment-intrinsic\n [llvm code coverage mapping format]: https://llvm.org/docs/CoverageMappingFormat.html\n \n-> **Note**: `-Z instrument-coverage` also automatically enables `-C symbol-mangling-version=v0` (tracking issue [#60705]). The `v0` symbol mangler is strongly recommended, but be aware that this demangler is also experimental. The `v0` demangler can be overridden by explicitly adding `-Z unstable-options -C symbol-mangling-version=legacy`.\n+> **Note**: `-C instrument-coverage` also automatically enables `-C symbol-mangling-version=v0` (tracking issue [#60705]). The `v0` symbol mangler is strongly recommended. The `v0` demangler can be overridden by explicitly adding `-Z unstable-options -C symbol-mangling-version=legacy`.\n \n [#60705]: https://github.com/rust-lang/rust/issues/60705\n \n ## Enable coverage profiling in the Rust compiler\n \n-Rust's source-based code coverage requires the Rust \"profiler runtime\". Without it, compiling with `-Z instrument-coverage` generates an error that the profiler runtime is missing.\n+Rust's source-based code coverage requires the Rust \"profiler runtime\". Without it, compiling with `-C instrument-coverage` generates an error that the profiler runtime is missing.\n \n The Rust `nightly` distribution channel includes the profiler runtime, by default.\n \n > **Important**: If you are building the Rust compiler from the source distribution, the profiler runtime is _not_ enabled in the default `config.toml.example`. Edit your `config.toml` file and ensure the `profiler` feature is set it to `true` (either under the `[build]` section, or under the settings for an individual `[target.<triple>]`):\n >\n > ```toml\n > # Build the profiler runtime (required when compiling with options that depend\n-> # on this runtime, such as `-C profile-generate` or `-Z  instrument-coverage`).\n+> # on this runtime, such as `-C profile-generate` or `-C instrument-coverage`).\n > profiler = true\n > ```\n \n@@ -65,9 +59,9 @@ $ ./x.py build rust-demangler\n \n ## Compiling with coverage enabled\n \n-Set the `-Z instrument-coverage` compiler flag in order to enable LLVM source-based code coverage profiling.\n+Set the `-C instrument-coverage` compiler flag in order to enable LLVM source-based code coverage profiling.\n \n-The default option generates coverage for all functions, including unused (never called) functions and generics. The compiler flag supports an optional value to tailor this behavior. (See [`-Z instrument-coverage=<options>`](#-z-instrument-coverageoptions), below.)\n+The default option generates coverage for all functions, including unused (never called) functions and generics. The compiler flag supports an optional value to tailor this behavior. (See [`-C instrument-coverage=<options>`](#-c-instrument-coverageoptions), below.)\n \n With `cargo`, you can instrument your program binary _and_ dependencies at the same time.\n \n@@ -76,18 +70,18 @@ For example (if your project's Cargo.toml builds a binary by default):\n ```shell\n $ cd your-project\n $ cargo clean\n-$ RUSTFLAGS=\"-Z instrument-coverage\" cargo build\n+$ RUSTFLAGS=\"-C instrument-coverage\" cargo build\n ```\n \n If `cargo` is not configured to use your `profiler`-enabled version of `rustc`, set the path explicitly via the `RUSTC` environment variable. Here is another example, using a `stage1` build of `rustc` to compile an `example` binary (from the [`json5format`] crate):\n \n ```shell\n $ RUSTC=$HOME/rust/build/x86_64-unknown-linux-gnu/stage1/bin/rustc \\\n-    RUSTFLAGS=\"-Z instrument-coverage\" \\\n+    RUSTFLAGS=\"-C instrument-coverage\" \\\n     cargo build --example formatjson5\n ```\n \n-> **Note**: that some compiler options, combined with `-Z instrument-coverage`, can produce LLVM IR and/or linked binaries that are incompatible with LLVM coverage maps. For example, coverage requires references to actual functions in LLVM IR. If any covered function is optimized out, the coverage tools may not be able to process the coverage results. If you need to pass additional options, with coverage enabled, test them early, to confirm you will get the coverage results you expect.\n+> **Note**: that some compiler options, combined with `-C instrument-coverage`, can produce LLVM IR and/or linked binaries that are incompatible with LLVM coverage maps. For example, coverage requires references to actual functions in LLVM IR. If any covered function is optimized out, the coverage tools may not be able to process the coverage results. If you need to pass additional options, with coverage enabled, test them early, to confirm you will get the coverage results you expect.\n \n ## Running the instrumented binary to generate raw coverage profiling data\n \n@@ -176,7 +170,7 @@ Some of the more notable options in this example include:\n \n > **Note**: Coverage can also be disabled on an individual function by annotating the function with the [`no_coverage` attribute] (which requires the feature flag `#![feature(no_coverage)]`).\n \n-[`no_coverage` attribute]: ../language-features/no-coverage.md\n+[`no_coverage` attribute]: ../unstable-book/language-features/no-coverage.html\n \n ## Interpreting reports\n \n@@ -195,10 +189,10 @@ A typical use case for coverage analysis is test coverage. Rust's source-based c\n \n The following example (using the [`json5format`] crate, for demonstration purposes) show how to generate and analyze coverage results for all tests in a crate.\n \n-Since `cargo test` both builds and runs the tests, we set both the additional `RUSTFLAGS`, to add the `-Z instrument-coverage` flag, and `LLVM_PROFILE_FILE`, to set a custom filename for the raw profiling data generated during the test runs. Since there may be more than one test binary, apply `%m` in the filename pattern. This generates unique names for each test binary. (Otherwise, each executed test binary would overwrite the coverage results from the previous binary.)\n+Since `cargo test` both builds and runs the tests, we set both the additional `RUSTFLAGS`, to add the `-C instrument-coverage` flag, and `LLVM_PROFILE_FILE`, to set a custom filename for the raw profiling data generated during the test runs. Since there may be more than one test binary, apply `%m` in the filename pattern. This generates unique names for each test binary. (Otherwise, each executed test binary would overwrite the coverage results from the previous binary.)\n \n ```shell\n-$ RUSTFLAGS=\"-Z instrument-coverage\" \\\n+$ RUSTFLAGS=\"-C instrument-coverage\" \\\n     LLVM_PROFILE_FILE=\"json5format-%m.profraw\" \\\n     cargo test --tests\n ```\n@@ -256,7 +250,7 @@ $ cargo cov -- report \\\n     $( \\\n       for file in \\\n         $( \\\n-          RUSTFLAGS=\"-Z instrument-coverage\" \\\n+          RUSTFLAGS=\"-C instrument-coverage\" \\\n             cargo test --tests --no-run --message-format=json \\\n               | jq -r \"select(.profile.test == true) | .filenames[]\" \\\n               | grep -v dSYM - \\\n@@ -280,12 +274,12 @@ for each listed test binary.\n The previous examples run `cargo test` with `--tests`, which excludes doc tests.[^79417]\n \n To include doc tests in the coverage results, drop the `--tests` flag, and apply the\n-`-Z instrument-coverage` flag, and some doc-test-specific options in the\n+`-C instrument-coverage` flag, and some doc-test-specific options in the\n `RUSTDOCFLAGS` environment variable. (The `cargo profdata` command does not change.)\n \n ```bash\n-$ RUSTFLAGS=\"-Z instrument-coverage\" \\\n-  RUSTDOCFLAGS=\"-Z instrument-coverage -Z unstable-options --persist-doctests target/debug/doctestbins\" \\\n+$ RUSTFLAGS=\"-C instrument-coverage\" \\\n+  RUSTDOCFLAGS=\"-C instrument-coverage -Z unstable-options --persist-doctests target/debug/doctestbins\" \\\n   LLVM_PROFILE_FILE=\"json5format-%m.profraw\" \\\n     cargo test\n $ cargo profdata -- merge \\\n@@ -300,8 +294,8 @@ $ cargo cov -- report \\\n     $( \\\n       for file in \\\n         $( \\\n-          RUSTFLAGS=\"-Z instrument-coverage\" \\\n-          RUSTDOCFLAGS=\"-Z instrument-coverage -Z unstable-options --persist-doctests target/debug/doctestbins\" \\\n+          RUSTFLAGS=\"-C instrument-coverage\" \\\n+          RUSTDOCFLAGS=\"-C instrument-coverage -Z unstable-options --persist-doctests target/debug/doctestbins\" \\\n             cargo test --no-run --message-format=json \\\n               | jq -r \"select(.profile.test == true) | .filenames[]\" \\\n               | grep -v dSYM - \\\n@@ -331,12 +325,12 @@ $ cargo cov -- report \\\n     [(#79417)](https://github.com/rust-lang/rust/issues/79417) that doc test coverage\n     generates incorrect source line numbers in `llvm-cov show` results.\n \n-## `-Z instrument-coverage=<options>`\n+## `-C instrument-coverage=<options>`\n \n--   `-Z instrument-coverage=all`: Instrument all functions, including unused functions and unused generics. (This is the same as `-Z instrument-coverage`, with no value.)\n--   `-Z instrument-coverage=except-unused-generics`: Instrument all functions except unused generics.\n--   `-Z instrument-coverage=except-unused-functions`: Instrument only used (called) functions and instantiated generic functions.\n--   `-Z instrument-coverage=off`: Do not instrument any functions. (This is the same as simply not including the `-Z instrument-coverage` option.)\n+-   `-C instrument-coverage=all`: Instrument all functions, including unused functions and unused generics. (This is the same as `-C instrument-coverage`, with no value.)\n+-   `-C instrument-coverage=except-unused-generics`: Instrument all functions except unused generics.\n+-   `-C instrument-coverage=except-unused-functions`: Instrument only used (called) functions and instantiated generic functions.\n+-   `-C instrument-coverage=off`: Do not instrument any functions. (This is the same as simply not including the `-C instrument-coverage` option.)\n \n ## Other references\n ", "previous_filename": "src/doc/unstable-book/src/compiler-flags/instrument-coverage.md"}, {"sha": "cb65978e0a07e6dd6a27a2b54d6cf985be4911fd", "filename": "src/doc/unstable-book/src/compiler-flags/source-based-code-coverage.md", "status": "removed", "additions": 0, "deletions": 5, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/ff94b3b12b30d1a52d594cb48f80efa39a6029a6/src%2Fdoc%2Funstable-book%2Fsrc%2Fcompiler-flags%2Fsource-based-code-coverage.md", "raw_url": "https://github.com/rust-lang/rust/raw/ff94b3b12b30d1a52d594cb48f80efa39a6029a6/src%2Fdoc%2Funstable-book%2Fsrc%2Fcompiler-flags%2Fsource-based-code-coverage.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Funstable-book%2Fsrc%2Fcompiler-flags%2Fsource-based-code-coverage.md?ref=ff94b3b12b30d1a52d594cb48f80efa39a6029a6", "patch": "@@ -1,5 +0,0 @@\n-# `source-based-code-coverage`\n-\n-See compiler flag [`-Z instrument-coverage`].\n-\n-[`-z instrument-coverage`]: ./instrument-coverage.html"}, {"sha": "227553287a8241f3c137adcdf5d8b4310d82163c", "filename": "src/librustdoc/doctest.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/34106f89353575bd341e27b95e4e759866cd7939/src%2Flibrustdoc%2Fdoctest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/34106f89353575bd341e27b95e4e759866cd7939/src%2Flibrustdoc%2Fdoctest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fdoctest.rs?ref=34106f89353575bd341e27b95e4e759866cd7939", "patch": "@@ -658,7 +658,7 @@ crate fn make_test(\n     } else {\n         let returns_result = everything_else.trim_end().ends_with(\"(())\");\n         // Give each doctest main function a unique name.\n-        // This is for example needed for the tooling around `-Z instrument-coverage`.\n+        // This is for example needed for the tooling around `-C instrument-coverage`.\n         let inner_fn_name = if let Some(test_id) = test_id {\n             format!(\"_doctest_main_{}\", test_id)\n         } else {\n@@ -683,7 +683,7 @@ crate fn make_test(\n         };\n         // Note on newlines: We insert a line/newline *before*, and *after*\n         // the doctest and adjust the `line_offset` accordingly.\n-        // In the case of `-Z instrument-coverage`, this means that the generated\n+        // In the case of `-C instrument-coverage`, this means that the generated\n         // inner `main` function spans from the doctest opening codeblock to the\n         // closing one. For example\n         // /// ``` <- start of the inner main"}, {"sha": "09403bb3a7926675c9134740abf8a073728b196f", "filename": "src/test/mir-opt/coverage_graphviz.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/34106f89353575bd341e27b95e4e759866cd7939/src%2Ftest%2Fmir-opt%2Fcoverage_graphviz.rs", "raw_url": "https://github.com/rust-lang/rust/raw/34106f89353575bd341e27b95e4e759866cd7939/src%2Ftest%2Fmir-opt%2Fcoverage_graphviz.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fcoverage_graphviz.rs?ref=34106f89353575bd341e27b95e4e759866cd7939", "patch": "@@ -1,9 +1,9 @@\n-// Test that `-Z instrument-coverage` with `-Z dump-mir-graphviz` generates a graphviz (.dot file)\n+// Test that `-C instrument-coverage` with `-Z dump-mir-graphviz` generates a graphviz (.dot file)\n // rendering of the `BasicCoverageBlock` coverage control flow graph, with counters and\n // expressions.\n \n // needs-profiler-support\n-// compile-flags: -Z instrument-coverage -Z dump-mir-graphviz\n+// compile-flags: -C instrument-coverage -Z dump-mir-graphviz\n // EMIT_MIR coverage_graphviz.main.InstrumentCoverage.0.dot\n // EMIT_MIR coverage_graphviz.bar.InstrumentCoverage.0.dot\n fn main() {"}, {"sha": "a748f2c5ccc9b54346df5557be2e3fe9658349f7", "filename": "src/test/mir-opt/instrument_coverage.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/34106f89353575bd341e27b95e4e759866cd7939/src%2Ftest%2Fmir-opt%2Finstrument_coverage.rs", "raw_url": "https://github.com/rust-lang/rust/raw/34106f89353575bd341e27b95e4e759866cd7939/src%2Ftest%2Fmir-opt%2Finstrument_coverage.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Finstrument_coverage.rs?ref=34106f89353575bd341e27b95e4e759866cd7939", "patch": "@@ -1,9 +1,9 @@\n-// Test that `-Z instrument-coverage` injects Coverage statements. The Coverage Counter statements\n+// Test that `-C instrument-coverage` injects Coverage statements. The Coverage Counter statements\n // are later converted into LLVM instrprof.increment intrinsics, during codegen.\n \n // needs-profiler-support\n // ignore-windows\n-// compile-flags: -Z instrument-coverage --remap-path-prefix={{src-base}}=/the/src\n+// compile-flags: -C instrument-coverage --remap-path-prefix={{src-base}}=/the/src\n \n // EMIT_MIR instrument_coverage.main.InstrumentCoverage.diff\n // EMIT_MIR instrument_coverage.bar.InstrumentCoverage.diff"}, {"sha": "fbe0a5cb1bb8cac13f2c93e09aebf1e00c92f0cb", "filename": "src/test/run-make-fulldeps/coverage-llvmir/Makefile", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/34106f89353575bd341e27b95e4e759866cd7939/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-llvmir%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/34106f89353575bd341e27b95e4e759866cd7939/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-llvmir%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-llvmir%2FMakefile?ref=34106f89353575bd341e27b95e4e759866cd7939", "patch": "@@ -57,7 +57,7 @@ all: test_llvm_ir\n test_llvm_ir:\n \t# Compile the test program with non-experimental coverage instrumentation, and generate LLVM IR\n \t$(RUSTC) $(BASEDIR)/testprog.rs \\\n-\t\t\t-Zinstrument-coverage \\\n+\t\t\t-Cinstrument-coverage \\\n \t\t\t--emit=llvm-ir\n \n \tcat \"$(TMPDIR)\"/testprog.ll | \\"}, {"sha": "1e2ecc2fbb1cc5f8e6e5748d1a630abaaef95c31", "filename": "src/test/run-make-fulldeps/coverage-llvmir/filecheck.testprog.txt", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/34106f89353575bd341e27b95e4e759866cd7939/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-llvmir%2Ffilecheck.testprog.txt", "raw_url": "https://github.com/rust-lang/rust/raw/34106f89353575bd341e27b95e4e759866cd7939/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-llvmir%2Ffilecheck.testprog.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-llvmir%2Ffilecheck.testprog.txt?ref=34106f89353575bd341e27b95e4e759866cd7939", "patch": "@@ -1,5 +1,5 @@\n # Check for metadata, variables, declarations, and function definitions injected\n-# into LLVM IR when compiling with -Zinstrument-coverage.\n+# into LLVM IR when compiling with -Cinstrument-coverage.\n \n WINDOWS:      $__llvm_profile_runtime_user = comdat any\n "}, {"sha": "53e75ae337ba2ae9619fa428bbf17ae4b24ce7e3", "filename": "src/test/run-make-fulldeps/coverage-reports/Makefile", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/34106f89353575bd341e27b95e4e759866cd7939/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/34106f89353575bd341e27b95e4e759866cd7939/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2FMakefile?ref=34106f89353575bd341e27b95e4e759866cd7939", "patch": "@@ -81,13 +81,13 @@ endif\n \t# Compile the test library with coverage instrumentation\n \t$(RUSTC) $(SOURCEDIR)/lib/$@.rs \\\n \t\t\t$$( sed -n 's/^\\/\\/ compile-flags: \\([^#]*\\).*/\\1/p' $(SOURCEDIR)/lib/$@.rs ) \\\n-\t\t\t--crate-type rlib -Zinstrument-coverage\n+\t\t\t--crate-type rlib -Cinstrument-coverage\n \n %: $(SOURCEDIR)/%.rs\n \t# Compile the test program with coverage instrumentation\n \t$(RUSTC) $(SOURCEDIR)/$@.rs \\\n \t\t\t$$( sed -n 's/^\\/\\/ compile-flags: \\([^#]*\\).*/\\1/p' $(SOURCEDIR)/$@.rs ) \\\n-\t\t\t-L \"$(TMPDIR)\" -Zinstrument-coverage\n+\t\t\t-L \"$(TMPDIR)\" -Cinstrument-coverage\n \n \t# Run it in order to generate some profiling data,\n \t# with `LLVM_PROFILE_FILE=<profdata_file>` environment variable set to\n@@ -109,7 +109,7 @@ endif\n \tLLVM_PROFILE_FILE=\"$(TMPDIR)\"/$@-%p-%m.profraw \\\n \t\t\t$(RUSTDOC) --crate-name workaround_for_79771 --test $(SOURCEDIR)/$@.rs \\\n \t\t\t$$( sed -n 's/^\\/\\/ compile-flags: \\([^#]*\\).*/\\1/p' $(SOURCEDIR)/$@.rs ) \\\n-\t\t\t-L \"$(TMPDIR)\" -Zinstrument-coverage \\\n+\t\t\t-L \"$(TMPDIR)\" -Cinstrument-coverage \\\n \t\t\t-Z unstable-options --persist-doctests=$(TMPDIR)/rustdoc-$@\n \n \t# Postprocess the profiling data so it can be used by the llvm-cov tool"}, {"sha": "8d6a9eb902c17c1e3f4975b539e6dae995b08895", "filename": "src/test/run-make-fulldeps/coverage-reports/expected_show_coverage.uses_crate.txt", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/34106f89353575bd341e27b95e4e759866cd7939/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.uses_crate.txt", "raw_url": "https://github.com/rust-lang/rust/raw/34106f89353575bd341e27b95e4e759866cd7939/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.uses_crate.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.uses_crate.txt?ref=34106f89353575bd341e27b95e4e759866cd7939", "patch": "@@ -125,7 +125,7 @@\n    78|       |// generic functions with:\n    79|       |//\n    80|       |// ```shell\n-   81|       |// $ `rustc -Z instrument-coverage=except-unused-generics ...`\n+   81|       |// $ `rustc -C instrument-coverage=except-unused-generics ...`\n    82|       |// ```\n    83|       |//\n    84|       |// Even though this function is used by `uses_crate.rs` (and"}, {"sha": "9c3b147ac59fe717c593a0040767e8722f51fcaf", "filename": "src/test/run-make-fulldeps/coverage/lib/used_crate.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/34106f89353575bd341e27b95e4e759866cd7939/src%2Ftest%2Frun-make-fulldeps%2Fcoverage%2Flib%2Fused_crate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/34106f89353575bd341e27b95e4e759866cd7939/src%2Ftest%2Frun-make-fulldeps%2Fcoverage%2Flib%2Fused_crate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fcoverage%2Flib%2Fused_crate.rs?ref=34106f89353575bd341e27b95e4e759866cd7939", "patch": "@@ -78,7 +78,7 @@ fn use_this_lib_crate() {\n // generic functions with:\n //\n // ```shell\n-// $ `rustc -Z instrument-coverage=except-unused-generics ...`\n+// $ `rustc -C instrument-coverage=except-unused-generics ...`\n // ```\n //\n // Even though this function is used by `uses_crate.rs` (and"}]}