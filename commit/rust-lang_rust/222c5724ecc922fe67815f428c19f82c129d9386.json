{"sha": "222c5724ecc922fe67815f428c19f82c129d9386", "node_id": "C_kwDOAAsO6NoAKDIyMmM1NzI0ZWNjOTIyZmU2NzgxNWY0MjhjMTlmODJjMTI5ZDkzODY", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-05-23T18:26:42Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-05-23T18:26:42Z"}, "message": "Auto merge of #94053 - GuillaumeGomez:fields-stripped, r=notriddle\n\nrustdoc: Remove fields_stripped fields (and equivalents)\n\nFixes #90588.\n\nr? `@camelid`", "tree": {"sha": "1a971ac53653c12c8198f5ee2f651b8092b0def6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1a971ac53653c12c8198f5ee2f651b8092b0def6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/222c5724ecc922fe67815f428c19f82c129d9386", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/222c5724ecc922fe67815f428c19f82c129d9386", "html_url": "https://github.com/rust-lang/rust/commit/222c5724ecc922fe67815f428c19f82c129d9386", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/222c5724ecc922fe67815f428c19f82c129d9386/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7f997f589f4e0b1c59a3680e7a8dd941d3ada518", "url": "https://api.github.com/repos/rust-lang/rust/commits/7f997f589f4e0b1c59a3680e7a8dd941d3ada518", "html_url": "https://github.com/rust-lang/rust/commit/7f997f589f4e0b1c59a3680e7a8dd941d3ada518"}, {"sha": "8323b053b21cd8a61987d6e4b6c275338dc45cbb", "url": "https://api.github.com/repos/rust-lang/rust/commits/8323b053b21cd8a61987d6e4b6c275338dc45cbb", "html_url": "https://github.com/rust-lang/rust/commit/8323b053b21cd8a61987d6e4b6c275338dc45cbb"}], "stats": {"total": 129, "additions": 75, "deletions": 54}, "files": [{"sha": "d820e43cb6123641efef80edf52bb86702dcbf29", "filename": "src/librustdoc/clean/inline.rs", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/222c5724ecc922fe67815f428c19f82c129d9386/src%2Flibrustdoc%2Fclean%2Finline.rs", "raw_url": "https://github.com/rust-lang/rust/raw/222c5724ecc922fe67815f428c19f82c129d9386/src%2Flibrustdoc%2Fclean%2Finline.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Finline.rs?ref=222c5724ecc922fe67815f428c19f82c129d9386", "patch": "@@ -236,7 +236,6 @@ fn build_enum(cx: &mut DocContext<'_>, did: DefId) -> clean::Enum {\n \n     clean::Enum {\n         generics: clean_ty_generics(cx, cx.tcx.generics_of(did), predicates),\n-        variants_stripped: false,\n         variants: cx.tcx.adt_def(did).variants().iter().map(|v| v.clean(cx)).collect(),\n     }\n }\n@@ -249,7 +248,6 @@ fn build_struct(cx: &mut DocContext<'_>, did: DefId) -> clean::Struct {\n         struct_type: variant.ctor_kind,\n         generics: clean_ty_generics(cx, cx.tcx.generics_of(did), predicates),\n         fields: variant.fields.iter().map(|x| x.clean(cx)).collect(),\n-        fields_stripped: false,\n     }\n }\n \n@@ -259,7 +257,7 @@ fn build_union(cx: &mut DocContext<'_>, did: DefId) -> clean::Union {\n \n     let generics = clean_ty_generics(cx, cx.tcx.generics_of(did), predicates);\n     let fields = variant.fields.iter().map(|x| x.clean(cx)).collect();\n-    clean::Union { generics, fields, fields_stripped: false }\n+    clean::Union { generics, fields }\n }\n \n fn build_type_alias(cx: &mut DocContext<'_>, did: DefId) -> clean::Typedef {"}, {"sha": "4ddfae4daccf853e6e5e89785a68c9c0862fd056", "filename": "src/librustdoc/clean/mod.rs", "status": "modified", "additions": 0, "deletions": 5, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/222c5724ecc922fe67815f428c19f82c129d9386/src%2Flibrustdoc%2Fclean%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/222c5724ecc922fe67815f428c19f82c129d9386/src%2Flibrustdoc%2Fclean%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Fmod.rs?ref=222c5724ecc922fe67815f428c19f82c129d9386", "patch": "@@ -1784,7 +1784,6 @@ impl Clean<VariantStruct> for rustc_hir::VariantData<'_> {\n         VariantStruct {\n             struct_type: CtorKind::from_hir(self),\n             fields: self.fields().iter().map(|x| x.clean(cx)).collect(),\n-            fields_stripped: false,\n         }\n     }\n }\n@@ -1804,7 +1803,6 @@ impl Clean<Item> for ty::VariantDef {\n             }\n             CtorKind::Fictive => Variant::Struct(VariantStruct {\n                 struct_type: CtorKind::Fictive,\n-                fields_stripped: false,\n                 fields: self.fields.iter().map(|field| field.clean(cx)).collect(),\n             }),\n         };\n@@ -1914,7 +1912,6 @@ fn clean_maybe_renamed_item(\n             ItemKind::Enum(ref def, ref generics) => EnumItem(Enum {\n                 variants: def.variants.iter().map(|v| v.clean(cx)).collect(),\n                 generics: generics.clean(cx),\n-                variants_stripped: false,\n             }),\n             ItemKind::TraitAlias(ref generics, bounds) => TraitAliasItem(TraitAlias {\n                 generics: generics.clean(cx),\n@@ -1923,13 +1920,11 @@ fn clean_maybe_renamed_item(\n             ItemKind::Union(ref variant_data, ref generics) => UnionItem(Union {\n                 generics: generics.clean(cx),\n                 fields: variant_data.fields().iter().map(|x| x.clean(cx)).collect(),\n-                fields_stripped: false,\n             }),\n             ItemKind::Struct(ref variant_data, ref generics) => StructItem(Struct {\n                 struct_type: CtorKind::from_hir(variant_data),\n                 generics: generics.clean(cx),\n                 fields: variant_data.fields().iter().map(|x| x.clean(cx)).collect(),\n-                fields_stripped: false,\n             }),\n             ItemKind::Impl(ref impl_) => return clean_impl(impl_, item.hir_id(), cx),\n             // proc macros can have a name set by attributes"}, {"sha": "7118e05e58eb75643612e8ca34570d21cbdbcf6c", "filename": "src/librustdoc/clean/types.rs", "status": "modified", "additions": 42, "deletions": 8, "changes": 50, "blob_url": "https://github.com/rust-lang/rust/blob/222c5724ecc922fe67815f428c19f82c129d9386/src%2Flibrustdoc%2Fclean%2Ftypes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/222c5724ecc922fe67815f428c19f82c129d9386/src%2Flibrustdoc%2Fclean%2Ftypes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Ftypes.rs?ref=222c5724ecc922fe67815f428c19f82c129d9386", "patch": "@@ -619,11 +619,12 @@ impl Item {\n             _ => false,\n         }\n     }\n-    pub(crate) fn has_stripped_fields(&self) -> Option<bool> {\n+    pub(crate) fn has_stripped_entries(&self) -> Option<bool> {\n         match *self.kind {\n-            StructItem(ref _struct) => Some(_struct.fields_stripped),\n-            UnionItem(ref union) => Some(union.fields_stripped),\n-            VariantItem(Variant::Struct(ref vstruct)) => Some(vstruct.fields_stripped),\n+            StructItem(ref struct_) => Some(struct_.has_stripped_entries()),\n+            UnionItem(ref union_) => Some(union_.has_stripped_entries()),\n+            EnumItem(ref enum_) => Some(enum_.has_stripped_entries()),\n+            VariantItem(ref v) => v.has_stripped_entries(),\n             _ => None,\n         }\n     }\n@@ -2028,14 +2029,24 @@ pub(crate) struct Struct {\n     pub(crate) struct_type: CtorKind,\n     pub(crate) generics: Generics,\n     pub(crate) fields: Vec<Item>,\n-    pub(crate) fields_stripped: bool,\n+}\n+\n+impl Struct {\n+    pub(crate) fn has_stripped_entries(&self) -> bool {\n+        self.fields.iter().any(|f| f.is_stripped())\n+    }\n }\n \n #[derive(Clone, Debug)]\n pub(crate) struct Union {\n     pub(crate) generics: Generics,\n     pub(crate) fields: Vec<Item>,\n-    pub(crate) fields_stripped: bool,\n+}\n+\n+impl Union {\n+    pub(crate) fn has_stripped_entries(&self) -> bool {\n+        self.fields.iter().any(|f| f.is_stripped())\n+    }\n }\n \n /// This is a more limited form of the standard Struct, different in that\n@@ -2045,14 +2056,28 @@ pub(crate) struct Union {\n pub(crate) struct VariantStruct {\n     pub(crate) struct_type: CtorKind,\n     pub(crate) fields: Vec<Item>,\n-    pub(crate) fields_stripped: bool,\n+}\n+\n+impl VariantStruct {\n+    pub(crate) fn has_stripped_entries(&self) -> bool {\n+        self.fields.iter().any(|f| f.is_stripped())\n+    }\n }\n \n #[derive(Clone, Debug)]\n pub(crate) struct Enum {\n     pub(crate) variants: IndexVec<VariantIdx, Item>,\n     pub(crate) generics: Generics,\n-    pub(crate) variants_stripped: bool,\n+}\n+\n+impl Enum {\n+    pub(crate) fn has_stripped_entries(&self) -> bool {\n+        self.variants.iter().any(|f| f.is_stripped())\n+    }\n+\n+    pub(crate) fn variants(&self) -> impl Iterator<Item = &Item> {\n+        self.variants.iter().filter(|v| !v.is_stripped())\n+    }\n }\n \n #[derive(Clone, Debug)]\n@@ -2062,6 +2087,15 @@ pub(crate) enum Variant {\n     Struct(VariantStruct),\n }\n \n+impl Variant {\n+    pub(crate) fn has_stripped_entries(&self) -> Option<bool> {\n+        match *self {\n+            Self::Struct(ref struct_) => Some(struct_.has_stripped_entries()),\n+            Self::CLike | Self::Tuple(_) => None,\n+        }\n+    }\n+}\n+\n /// Small wrapper around [`rustc_span::Span`] that adds helper methods\n /// and enforces calling [`rustc_span::Span::source_callsite()`].\n #[derive(Copy, Clone, Debug)]"}, {"sha": "336448904d1652786a81bbb24ae9a04b75765997", "filename": "src/librustdoc/fold.rs", "status": "modified", "additions": 0, "deletions": 20, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/222c5724ecc922fe67815f428c19f82c129d9386/src%2Flibrustdoc%2Ffold.rs", "raw_url": "https://github.com/rust-lang/rust/raw/222c5724ecc922fe67815f428c19f82c129d9386/src%2Flibrustdoc%2Ffold.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Ffold.rs?ref=222c5724ecc922fe67815f428c19f82c129d9386", "patch": "@@ -18,30 +18,15 @@ pub(crate) trait DocFolder: Sized {\n             StrippedItem(..) => unreachable!(),\n             ModuleItem(i) => ModuleItem(self.fold_mod(i)),\n             StructItem(mut i) => {\n-                let num_fields = i.fields.len();\n                 i.fields = i.fields.into_iter().filter_map(|x| self.fold_item(x)).collect();\n-                if !i.fields_stripped {\n-                    i.fields_stripped =\n-                        num_fields != i.fields.len() || i.fields.iter().any(|f| f.is_stripped());\n-                }\n                 StructItem(i)\n             }\n             UnionItem(mut i) => {\n-                let num_fields = i.fields.len();\n                 i.fields = i.fields.into_iter().filter_map(|x| self.fold_item(x)).collect();\n-                if !i.fields_stripped {\n-                    i.fields_stripped =\n-                        num_fields != i.fields.len() || i.fields.iter().any(|f| f.is_stripped());\n-                }\n                 UnionItem(i)\n             }\n             EnumItem(mut i) => {\n-                let num_variants = i.variants.len();\n                 i.variants = i.variants.into_iter().filter_map(|x| self.fold_item(x)).collect();\n-                if !i.variants_stripped {\n-                    i.variants_stripped = num_variants != i.variants.len()\n-                        || i.variants.iter().any(|f| f.is_stripped());\n-                }\n                 EnumItem(i)\n             }\n             TraitItem(mut i) => {\n@@ -54,12 +39,7 @@ pub(crate) trait DocFolder: Sized {\n             }\n             VariantItem(i) => match i {\n                 Variant::Struct(mut j) => {\n-                    let num_fields = j.fields.len();\n                     j.fields = j.fields.into_iter().filter_map(|x| self.fold_item(x)).collect();\n-                    if !j.fields_stripped {\n-                        j.fields_stripped = num_fields != j.fields.len()\n-                            || j.fields.iter().any(|f| f.is_stripped());\n-                    }\n                     VariantItem(Variant::Struct(j))\n                 }\n                 Variant::Tuple(fields) => {"}, {"sha": "1b4a2cf1cb0ac2a76e4a868f5661d0b570069b50", "filename": "src/librustdoc/html/render/mod.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/222c5724ecc922fe67815f428c19f82c129d9386/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/222c5724ecc922fe67815f428c19f82c129d9386/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs?ref=222c5724ecc922fe67815f428c19f82c129d9386", "patch": "@@ -2363,8 +2363,7 @@ fn sidebar_enum(cx: &Context<'_>, buf: &mut Buffer, it: &clean::Item, e: &clean:\n     let mut sidebar = Buffer::new();\n \n     let mut variants = e\n-        .variants\n-        .iter()\n+        .variants()\n         .filter_map(|v| {\n             v.name\n                 .as_ref()"}, {"sha": "ed41b95e73f090da03d44d8bedbdae35650a618f", "filename": "src/librustdoc/html/render/print_item.rs", "status": "modified", "additions": 10, "deletions": 9, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/222c5724ecc922fe67815f428c19f82c129d9386/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs", "raw_url": "https://github.com/rust-lang/rust/raw/222c5724ecc922fe67815f428c19f82c129d9386/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs?ref=222c5724ecc922fe67815f428c19f82c129d9386", "patch": "@@ -1136,6 +1136,7 @@ fn print_tuple_struct_fields(w: &mut Buffer, cx: &Context<'_>, s: &[clean::Item]\n }\n \n fn item_enum(w: &mut Buffer, cx: &Context<'_>, it: &clean::Item, e: &clean::Enum) {\n+    let count_variants = e.variants().count();\n     wrap_into_docblock(w, |w| {\n         wrap_item(w, \"enum\", |w| {\n             render_attributes_in_pre(w, it, \"\");\n@@ -1147,16 +1148,16 @@ fn item_enum(w: &mut Buffer, cx: &Context<'_>, it: &clean::Item, e: &clean::Enum\n                 e.generics.print(cx),\n                 print_where_clause(&e.generics, cx, 0, true),\n             );\n-            if e.variants.is_empty() && !e.variants_stripped {\n+            let variants_stripped = e.has_stripped_entries();\n+            if count_variants == 0 && !variants_stripped {\n                 w.write_str(\" {}\");\n             } else {\n                 w.write_str(\" {\\n\");\n-                let count_variants = e.variants.len();\n                 let toggle = should_hide_fields(count_variants);\n                 if toggle {\n                     toggle_open(w, format_args!(\"{} variants\", count_variants));\n                 }\n-                for v in &e.variants {\n+                for v in e.variants() {\n                     w.write_str(\"    \");\n                     let name = v.name.unwrap();\n                     match *v.kind {\n@@ -1185,7 +1186,7 @@ fn item_enum(w: &mut Buffer, cx: &Context<'_>, it: &clean::Item, e: &clean::Enum\n                     w.write_str(\",\\n\");\n                 }\n \n-                if e.variants_stripped {\n+                if variants_stripped {\n                     w.write_str(\"    // some variants omitted\\n\");\n                 }\n                 if toggle {\n@@ -1198,15 +1199,15 @@ fn item_enum(w: &mut Buffer, cx: &Context<'_>, it: &clean::Item, e: &clean::Enum\n \n     document(w, cx, it, None, HeadingOffset::H2);\n \n-    if !e.variants.is_empty() {\n+    if count_variants != 0 {\n         write!(\n             w,\n             \"<h2 id=\\\"variants\\\" class=\\\"variants small-section-header\\\">\\\n                    Variants{}<a href=\\\"#variants\\\" class=\\\"anchor\\\"></a></h2>\",\n             document_non_exhaustive_header(it)\n         );\n         document_non_exhaustive(w, it);\n-        for variant in &e.variants {\n+        for variant in e.variants() {\n             let id = cx.derive_id(format!(\"{}.{}\", ItemType::Variant, variant.name.unwrap()));\n             write!(\n                 w,\n@@ -1650,7 +1651,7 @@ fn render_union(\n         }\n     }\n \n-    if it.has_stripped_fields().unwrap() {\n+    if it.has_stripped_entries().unwrap() {\n         write!(w, \"    /* private fields */\\n{}\", tab);\n     }\n     if toggle {\n@@ -1706,11 +1707,11 @@ fn render_struct(\n             }\n \n             if has_visible_fields {\n-                if it.has_stripped_fields().unwrap() {\n+                if it.has_stripped_entries().unwrap() {\n                     write!(w, \"\\n{}    /* private fields */\", tab);\n                 }\n                 write!(w, \"\\n{}\", tab);\n-            } else if it.has_stripped_fields().unwrap() {\n+            } else if it.has_stripped_entries().unwrap() {\n                 write!(w, \" /* private fields */ \");\n             }\n             if toggle {"}, {"sha": "6a8e4787676e13bcb6a358818af4b23ce585cc00", "filename": "src/librustdoc/json/conversions.rs", "status": "modified", "additions": 9, "deletions": 5, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/222c5724ecc922fe67815f428c19f82c129d9386/src%2Flibrustdoc%2Fjson%2Fconversions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/222c5724ecc922fe67815f428c19f82c129d9386/src%2Flibrustdoc%2Fjson%2Fconversions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fjson%2Fconversions.rs?ref=222c5724ecc922fe67815f428c19f82c129d9386", "patch": "@@ -249,7 +249,8 @@ fn from_clean_item(item: clean::Item, tcx: TyCtxt<'_>) -> ItemEnum {\n \n impl FromWithTcx<clean::Struct> for Struct {\n     fn from_tcx(struct_: clean::Struct, tcx: TyCtxt<'_>) -> Self {\n-        let clean::Struct { struct_type, generics, fields, fields_stripped } = struct_;\n+        let fields_stripped = struct_.has_stripped_entries();\n+        let clean::Struct { struct_type, generics, fields } = struct_;\n         Struct {\n             struct_type: from_ctor_kind(struct_type),\n             generics: generics.into_tcx(tcx),\n@@ -261,8 +262,9 @@ impl FromWithTcx<clean::Struct> for Struct {\n }\n \n impl FromWithTcx<clean::Union> for Union {\n-    fn from_tcx(struct_: clean::Union, tcx: TyCtxt<'_>) -> Self {\n-        let clean::Union { generics, fields, fields_stripped } = struct_;\n+    fn from_tcx(union_: clean::Union, tcx: TyCtxt<'_>) -> Self {\n+        let fields_stripped = union_.has_stripped_entries();\n+        let clean::Union { generics, fields } = union_;\n         Union {\n             generics: generics.into_tcx(tcx),\n             fields_stripped,\n@@ -586,7 +588,8 @@ pub(crate) fn from_function_method(\n \n impl FromWithTcx<clean::Enum> for Enum {\n     fn from_tcx(enum_: clean::Enum, tcx: TyCtxt<'_>) -> Self {\n-        let clean::Enum { variants, generics, variants_stripped } = enum_;\n+        let variants_stripped = enum_.has_stripped_entries();\n+        let clean::Enum { variants, generics } = enum_;\n         Enum {\n             generics: generics.into_tcx(tcx),\n             variants_stripped,\n@@ -598,7 +601,8 @@ impl FromWithTcx<clean::Enum> for Enum {\n \n impl FromWithTcx<clean::VariantStruct> for Struct {\n     fn from_tcx(struct_: clean::VariantStruct, _tcx: TyCtxt<'_>) -> Self {\n-        let clean::VariantStruct { struct_type, fields, fields_stripped } = struct_;\n+        let fields_stripped = struct_.has_stripped_entries();\n+        let clean::VariantStruct { struct_type, fields } = struct_;\n         Struct {\n             struct_type: from_ctor_kind(struct_type),\n             generics: Default::default(),"}, {"sha": "533e2ce46ddd844acb4691f68b5591007c45fef3", "filename": "src/librustdoc/passes/strip_hidden.rs", "status": "modified", "additions": 9, "deletions": 2, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/222c5724ecc922fe67815f428c19f82c129d9386/src%2Flibrustdoc%2Fpasses%2Fstrip_hidden.rs", "raw_url": "https://github.com/rust-lang/rust/raw/222c5724ecc922fe67815f428c19f82c129d9386/src%2Flibrustdoc%2Fpasses%2Fstrip_hidden.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fstrip_hidden.rs?ref=222c5724ecc922fe67815f428c19f82c129d9386", "patch": "@@ -38,9 +38,16 @@ impl<'a> DocFolder for Stripper<'a> {\n     fn fold_item(&mut self, i: Item) -> Option<Item> {\n         if i.attrs.lists(sym::doc).has_word(sym::hidden) {\n             debug!(\"strip_hidden: stripping {:?} {:?}\", i.type_(), i.name);\n-            // use a dedicated hidden item for given item type if any\n+            // Use a dedicated hidden item for fields, variants, and modules.\n+            // We need to keep private fields and variants, so that the docs\n+            // can show a placeholder \"// some variants omitted\". We need to keep\n+            // private modules, because they can contain impl blocks, and impl\n+            // block privacy is inherited from the type and trait, not from the\n+            // module it's defined in. Both of these are marked \"stripped,\" and\n+            // not included in the final docs, but since they still have an effect\n+            // on the final doc, cannot be completely removed from the Clean IR.\n             match *i.kind {\n-                clean::StructFieldItem(..) | clean::ModuleItem(..) => {\n+                clean::StructFieldItem(..) | clean::ModuleItem(..) | clean::VariantItem(..) => {\n                     // We need to recurse into stripped modules to\n                     // strip things like impl methods but when doing so\n                     // we must not add any items to the `retained` set."}, {"sha": "c4ee1a9911436e401989ed592da31ee33524492b", "filename": "src/test/rustdoc/strip-enum-variant.no-not-shown.html", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/222c5724ecc922fe67815f428c19f82c129d9386/src%2Ftest%2Frustdoc%2Fstrip-enum-variant.no-not-shown.html", "raw_url": "https://github.com/rust-lang/rust/raw/222c5724ecc922fe67815f428c19f82c129d9386/src%2Ftest%2Frustdoc%2Fstrip-enum-variant.no-not-shown.html", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fstrip-enum-variant.no-not-shown.html?ref=222c5724ecc922fe67815f428c19f82c129d9386", "patch": "@@ -0,0 +1 @@\n+<ul><li><a href=\"#variant.Shown\">Shown</a></li></ul>\n\\ No newline at end of file"}, {"sha": "f82ffdfeda58f38bcda89c81997b87712af97bef", "filename": "src/test/rustdoc/strip-enum-variant.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/222c5724ecc922fe67815f428c19f82c129d9386/src%2Ftest%2Frustdoc%2Fstrip-enum-variant.rs", "raw_url": "https://github.com/rust-lang/rust/raw/222c5724ecc922fe67815f428c19f82c129d9386/src%2Ftest%2Frustdoc%2Fstrip-enum-variant.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fstrip-enum-variant.rs?ref=222c5724ecc922fe67815f428c19f82c129d9386", "patch": "@@ -2,6 +2,8 @@\n // @has - '//code' 'Shown'\n // @!has - '//code' 'NotShown'\n // @has - '//code' '// some variants omitted'\n+// Also check that `NotShown` isn't displayed in the sidebar.\n+// @snapshot no-not-shown - '//*[@class=\"sidebar-elems\"]/section/*[@class=\"block\"][1]/ul'\n pub enum MyThing {\n     Shown,\n     #[doc(hidden)]"}]}