{"sha": "26933a638c360442412b51aa70fe25e419f44314", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI2OTMzYTYzOGMzNjA0NDI0MTJiNTFhYTcwZmUyNWU0MTlmNDQzMTQ=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-05-03T14:06:08Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-05-03T14:06:08Z"}, "message": "Auto merge of #25048 - huonw:test-benches, r=alexcrichton\n\nE.g. if `foo.rs` looks like\r\n\r\n    #![feature(test)]\r\n    extern crate test;\r\n\r\n    #[bench]\r\n    fn bar(b: &mut test::Bencher) {\r\n        b.iter(|| {\r\n            1\r\n        })\r\n    }\r\n\r\n    #[test]\r\n    fn baz() {}\r\n\r\n    #[bench]\r\n    fn qux(b: &mut test::Bencher) {\r\n        b.iter(|| {\r\n            panic!()\r\n        })\r\n    }\r\n\r\nThen\r\n\r\n    $ rustc --test foo.rs\r\n    $ ./foo\r\n\r\n    running 3 tests\r\n    test baz ... ok\r\n    test qux ... FAILED\r\n    test bar ... ok\r\n\r\n    failures:\r\n\r\n    ---- qux stdout ----\r\n    \tthread 'qux' panicked at 'explicit panic', bench.rs:17\r\n\r\n    failures:\r\n        qux\r\n\r\n    test result: FAILED. 2 passed; 1 failed; 0 ignored; 0 measured\r\n\r\n    $ ./foo --bench ba\r\n\r\n    running 2 tests\r\n    test baz ... ignored\r\n    test bar ... bench:        97 ns/iter (+/- 74)\r\n\r\n    test result: ok. 0 passed; 0 failed; 1 ignored; 1 measured\r\n\r\nIn particular, the two benchmark are being run as tests in the default\r\nmode.\r\n\r\nThis helps for the main distribution, since benchmarks are only run with\r\n`PLEASE_BENCH=1`, which is rarely set (and never set on the test bots),\r\nand helps for code-coverage tools: benchmarks are run and so don't count\r\nas dead code.\r\n\r\nFixes #15842.", "tree": {"sha": "8936c357d5a2c74e3c5c53f8a62b0d575b094b92", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8936c357d5a2c74e3c5c53f8a62b0d575b094b92"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/26933a638c360442412b51aa70fe25e419f44314", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/26933a638c360442412b51aa70fe25e419f44314", "html_url": "https://github.com/rust-lang/rust/commit/26933a638c360442412b51aa70fe25e419f44314", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/26933a638c360442412b51aa70fe25e419f44314/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "07915ef6a1426952ba612c02ecafad003bf971a3", "url": "https://api.github.com/repos/rust-lang/rust/commits/07915ef6a1426952ba612c02ecafad003bf971a3", "html_url": "https://github.com/rust-lang/rust/commit/07915ef6a1426952ba612c02ecafad003bf971a3"}, {"sha": "d73545ceca711f88e3e79120c77fa83c2a1994e7", "url": "https://api.github.com/repos/rust-lang/rust/commits/d73545ceca711f88e3e79120c77fa83c2a1994e7", "html_url": "https://github.com/rust-lang/rust/commit/d73545ceca711f88e3e79120c77fa83c2a1994e7"}], "stats": {"total": 61, "additions": 46, "deletions": 15}, "files": [{"sha": "2ee391a9374331b0b7d78fa965f945db2e1b4d74", "filename": "src/compiletest/compiletest.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/26933a638c360442412b51aa70fe25e419f44314/src%2Fcompiletest%2Fcompiletest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/26933a638c360442412b51aa70fe25e419f44314/src%2Fcompiletest%2Fcompiletest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcompiletest%2Fcompiletest.rs?ref=26933a638c360442412b51aa70fe25e419f44314", "patch": "@@ -269,7 +269,7 @@ pub fn test_opts(config: &Config) -> test::TestOpts {\n         run_ignored: config.run_ignored,\n         logfile: config.logfile.clone(),\n         run_tests: true,\n-        run_benchmarks: true,\n+        bench_benchmarks: true,\n         nocapture: env::var(\"RUST_TEST_NOCAPTURE\").is_ok(),\n         color: test::AutoColor,\n     }"}, {"sha": "9cbfe283cbddc163a91e9eeb3169949ae9e6833c", "filename": "src/libtest/lib.rs", "status": "modified", "additions": 45, "deletions": 14, "changes": 59, "blob_url": "https://github.com/rust-lang/rust/blob/26933a638c360442412b51aa70fe25e419f44314/src%2Flibtest%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/26933a638c360442412b51aa70fe25e419f44314/src%2Flibtest%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibtest%2Flib.rs?ref=26933a638c360442412b51aa70fe25e419f44314", "patch": "@@ -139,7 +139,7 @@ impl TestDesc {\n }\n \n /// Represents a benchmark function.\n-pub trait TDynBenchFn {\n+pub trait TDynBenchFn: Send {\n     fn run(&self, harness: &mut Bencher);\n }\n \n@@ -285,7 +285,7 @@ pub struct TestOpts {\n     pub filter: Option<String>,\n     pub run_ignored: bool,\n     pub run_tests: bool,\n-    pub run_benchmarks: bool,\n+    pub bench_benchmarks: bool,\n     pub logfile: Option<PathBuf>,\n     pub nocapture: bool,\n     pub color: ColorConfig,\n@@ -298,7 +298,7 @@ impl TestOpts {\n             filter: None,\n             run_ignored: false,\n             run_tests: false,\n-            run_benchmarks: false,\n+            bench_benchmarks: false,\n             logfile: None,\n             nocapture: false,\n             color: AutoColor,\n@@ -377,8 +377,8 @@ pub fn parse_opts(args: &[String]) -> Option<OptRes> {\n     let logfile = matches.opt_str(\"logfile\");\n     let logfile = logfile.map(|s| PathBuf::from(&s));\n \n-    let run_benchmarks = matches.opt_present(\"bench\");\n-    let run_tests = ! run_benchmarks ||\n+    let bench_benchmarks = matches.opt_present(\"bench\");\n+    let run_tests = ! bench_benchmarks ||\n         matches.opt_present(\"test\");\n \n     let mut nocapture = matches.opt_present(\"nocapture\");\n@@ -400,7 +400,7 @@ pub fn parse_opts(args: &[String]) -> Option<OptRes> {\n         filter: filter,\n         run_ignored: run_ignored,\n         run_tests: run_tests,\n-        run_benchmarks: run_benchmarks,\n+        bench_benchmarks: bench_benchmarks,\n         logfile: logfile,\n         nocapture: nocapture,\n         color: color,\n@@ -778,7 +778,11 @@ fn run_tests<F>(opts: &TestOpts,\n                 mut callback: F) -> io::Result<()> where\n     F: FnMut(TestEvent) -> io::Result<()>,\n {\n-    let filtered_tests = filter_tests(opts, tests);\n+    let mut filtered_tests = filter_tests(opts, tests);\n+    if !opts.bench_benchmarks {\n+        filtered_tests = convert_benchmarks_to_tests(filtered_tests);\n+    }\n+\n     let filtered_descs = filtered_tests.iter()\n                                        .map(|t| t.desc.clone())\n                                        .collect();\n@@ -824,13 +828,15 @@ fn run_tests<F>(opts: &TestOpts,\n         pending -= 1;\n     }\n \n-    // All benchmarks run at the end, in serial.\n-    // (this includes metric fns)\n-    for b in filtered_benchs_and_metrics {\n-        try!(callback(TeWait(b.desc.clone(), b.testfn.padding())));\n-        run_test(opts, !opts.run_benchmarks, b, tx.clone());\n-        let (test, result, stdout) = rx.recv().unwrap();\n-        try!(callback(TeResult(test, result, stdout)));\n+    if opts.bench_benchmarks {\n+        // All benchmarks run at the end, in serial.\n+        // (this includes metric fns)\n+        for b in filtered_benchs_and_metrics {\n+            try!(callback(TeWait(b.desc.clone(), b.testfn.padding())));\n+            run_test(opts, false, b, tx.clone());\n+            let (test, result, stdout) = rx.recv().unwrap();\n+            try!(callback(TeResult(test, result, stdout)));\n+        }\n     }\n     Ok(())\n }\n@@ -893,6 +899,22 @@ pub fn filter_tests(opts: &TestOpts, tests: Vec<TestDescAndFn>) -> Vec<TestDescA\n     filtered\n }\n \n+pub fn convert_benchmarks_to_tests(tests: Vec<TestDescAndFn>) -> Vec<TestDescAndFn> {\n+    // convert benchmarks to tests, if we're not benchmarking them\n+    tests.into_iter().map(|x| {\n+        let testfn = match x.testfn {\n+            DynBenchFn(bench) => {\n+                DynTestFn(Box::new(move || bench::run_once(|b| bench.run(b))))\n+            }\n+            StaticBenchFn(benchfn) => {\n+                DynTestFn(Box::new(move || bench::run_once(|b| benchfn(b))))\n+            }\n+            f => f\n+        };\n+        TestDescAndFn { desc: x.desc, testfn: testfn }\n+    }).collect()\n+}\n+\n pub fn run_test(opts: &TestOpts,\n                 force_ignore: bool,\n                 test: TestDescAndFn,\n@@ -1159,6 +1181,15 @@ pub mod bench {\n             mb_s: mb_s as usize\n         }\n     }\n+\n+    pub fn run_once<F>(f: F) where F: FnOnce(&mut Bencher) {\n+        let mut bs = Bencher {\n+            iterations: 0,\n+            dur: Duration::nanoseconds(0),\n+            bytes: 0\n+        };\n+        bs.bench_n(1, f);\n+    }\n }\n \n #[cfg(test)]"}]}