{"sha": "939ebb44544379d0ea483e7e8d5d061f04e6ed12", "node_id": "C_kwDOAAsO6NoAKDkzOWViYjQ0NTQ0Mzc5ZDBlYTQ4M2U3ZThkNWQwNjFmMDRlNmVkMTI", "commit": {"author": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2023-05-04T12:20:52Z"}, "committer": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2023-05-04T12:51:35Z"}, "message": "Forbid canonicalization of paths and normalize all rust-project.json paths", "tree": {"sha": "9805dfeaed3b13982d8f1dd34bc39efcba386423", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9805dfeaed3b13982d8f1dd34bc39efcba386423"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/939ebb44544379d0ea483e7e8d5d061f04e6ed12", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/939ebb44544379d0ea483e7e8d5d061f04e6ed12", "html_url": "https://github.com/rust-lang/rust/commit/939ebb44544379d0ea483e7e8d5d061f04e6ed12", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/939ebb44544379d0ea483e7e8d5d061f04e6ed12/comments", "author": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "60f4b3e26e8656bbe8b65530e237e3907c9565f3", "url": "https://api.github.com/repos/rust-lang/rust/commits/60f4b3e26e8656bbe8b65530e237e3907c9565f3", "html_url": "https://github.com/rust-lang/rust/commit/60f4b3e26e8656bbe8b65530e237e3907c9565f3"}], "stats": {"total": 42, "additions": 17, "deletions": 25}, "files": [{"sha": "0cfbf1d9a168746ef59c3f59040e0cf81fd7f628", "filename": "crates/paths/src/lib.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/939ebb44544379d0ea483e7e8d5d061f04e6ed12/crates%2Fpaths%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/939ebb44544379d0ea483e7e8d5d061f04e6ed12/crates%2Fpaths%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fpaths%2Fsrc%2Flib.rs?ref=939ebb44544379d0ea483e7e8d5d061f04e6ed12", "patch": "@@ -166,9 +166,8 @@ impl AbsPath {\n         AbsPathBuf::try_from(self.0.to_path_buf()).unwrap()\n     }\n \n-    /// Equivalent of [`Path::canonicalize`] for `AbsPath`.\n-    pub fn canonicalize(&self) -> Result<AbsPathBuf, std::io::Error> {\n-        Ok(self.as_ref().canonicalize()?.try_into().unwrap())\n+    pub fn canonicalize(&self) -> ! {\n+        panic!(\"We explicitly do not provide canonicalization API, as that is almost always a wrong solution, see #14430\")\n     }\n \n     /// Equivalent of [`Path::strip_prefix`] for `AbsPath`."}, {"sha": "3f60e4dd92f4325176764a6b473c5783ee409557", "filename": "crates/project-model/src/manifest_path.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/939ebb44544379d0ea483e7e8d5d061f04e6ed12/crates%2Fproject-model%2Fsrc%2Fmanifest_path.rs", "raw_url": "https://github.com/rust-lang/rust/raw/939ebb44544379d0ea483e7e8d5d061f04e6ed12/crates%2Fproject-model%2Fsrc%2Fmanifest_path.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproject-model%2Fsrc%2Fmanifest_path.rs?ref=939ebb44544379d0ea483e7e8d5d061f04e6ed12", "patch": "@@ -35,9 +35,8 @@ impl ManifestPath {\n         self.file.parent().unwrap()\n     }\n \n-    /// Equivalent of [`Path::canonicalize`] for `ManifestPath`.\n-    pub fn canonicalize(&self) -> Result<ManifestPath, std::io::Error> {\n-        Ok((&**self).canonicalize()?.try_into().unwrap())\n+    pub fn canonicalize(&self) -> ! {\n+        (&**self).canonicalize()\n     }\n }\n "}, {"sha": "ede2dc769e3cbf884c1cab79a2b58a8ede0f3880", "filename": "crates/project-model/src/project_json.rs", "status": "modified", "additions": 13, "deletions": 18, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/939ebb44544379d0ea483e7e8d5d061f04e6ed12/crates%2Fproject-model%2Fsrc%2Fproject_json.rs", "raw_url": "https://github.com/rust-lang/rust/raw/939ebb44544379d0ea483e7e8d5d061f04e6ed12/crates%2Fproject-model%2Fsrc%2Fproject_json.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproject-model%2Fsrc%2Fproject_json.rs?ref=939ebb44544379d0ea483e7e8d5d061f04e6ed12", "patch": "@@ -49,13 +49,12 @@\n //! user explores them belongs to that extension (it's totally valid to change\n //! rust-project.json over time via configuration request!)\n \n-use std::path::PathBuf;\n-\n use base_db::{CrateDisplayName, CrateId, CrateName, Dependency, Edition};\n use la_arena::RawIdx;\n use paths::{AbsPath, AbsPathBuf};\n use rustc_hash::FxHashMap;\n use serde::{de, Deserialize};\n+use std::path::PathBuf;\n \n use crate::cfg_flag::CfgFlag;\n \n@@ -99,26 +98,24 @@ impl ProjectJson {\n     /// * `data` - The parsed contents of `rust-project.json`, or project json that's passed via\n     ///            configuration.\n     pub fn new(base: &AbsPath, data: ProjectJsonData) -> ProjectJson {\n+        let absolutize =\n+            |p| AbsPathBuf::try_from(p).unwrap_or_else(|path| base.join(&path)).normalize();\n         ProjectJson {\n-            sysroot: data.sysroot.map(|it| base.join(it)),\n-            sysroot_src: data.sysroot_src.map(|it| base.join(it)),\n+            sysroot: data.sysroot.map(absolutize),\n+            sysroot_src: data.sysroot_src.map(absolutize),\n             project_root: base.to_path_buf(),\n             crates: data\n                 .crates\n                 .into_iter()\n                 .map(|crate_data| {\n-                    let is_workspace_member = crate_data.is_workspace_member.unwrap_or_else(|| {\n-                        crate_data.root_module.is_relative()\n-                            && !crate_data.root_module.starts_with(\"..\")\n-                            || crate_data.root_module.starts_with(base)\n-                    });\n-                    let root_module = base.join(crate_data.root_module).normalize();\n+                    let root_module = absolutize(crate_data.root_module);\n+                    let is_workspace_member = crate_data\n+                        .is_workspace_member\n+                        .unwrap_or_else(|| root_module.starts_with(base));\n                     let (include, exclude) = match crate_data.source {\n                         Some(src) => {\n                             let absolutize = |dirs: Vec<PathBuf>| {\n-                                dirs.into_iter()\n-                                    .map(|it| base.join(it).normalize())\n-                                    .collect::<Vec<_>>()\n+                                dirs.into_iter().map(absolutize).collect::<Vec<_>>()\n                             };\n                             (absolutize(src.include_dirs), absolutize(src.exclude_dirs))\n                         }\n@@ -145,17 +142,15 @@ impl ProjectJson {\n                         cfg: crate_data.cfg,\n                         target: crate_data.target,\n                         env: crate_data.env,\n-                        proc_macro_dylib_path: crate_data\n-                            .proc_macro_dylib_path\n-                            .map(|it| base.join(it)),\n+                        proc_macro_dylib_path: crate_data.proc_macro_dylib_path.map(absolutize),\n                         is_workspace_member,\n                         include,\n                         exclude,\n                         is_proc_macro: crate_data.is_proc_macro,\n                         repository: crate_data.repository,\n                     }\n                 })\n-                .collect::<Vec<_>>(),\n+                .collect(),\n         }\n     }\n \n@@ -243,7 +238,7 @@ struct CrateSource {\n     exclude_dirs: Vec<PathBuf>,\n }\n \n-fn deserialize_crate_name<'de, D>(de: D) -> Result<CrateName, D::Error>\n+fn deserialize_crate_name<'de, D>(de: D) -> std::result::Result<CrateName, D::Error>\n where\n     D: de::Deserializer<'de>,\n {"}, {"sha": "4adaa6d86ee34a27be53cec01673582b4d81f9b3", "filename": "crates/project-model/src/workspace.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/939ebb44544379d0ea483e7e8d5d061f04e6ed12/crates%2Fproject-model%2Fsrc%2Fworkspace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/939ebb44544379d0ea483e7e8d5d061f04e6ed12/crates%2Fproject-model%2Fsrc%2Fworkspace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproject-model%2Fsrc%2Fworkspace.rs?ref=939ebb44544379d0ea483e7e8d5d061f04e6ed12", "patch": "@@ -179,7 +179,6 @@ impl ProjectWorkspace {\n         };\n         let res = match manifest {\n             ProjectManifest::ProjectJson(project_json) => {\n-                let project_json = project_json.canonicalize()?;\n                 let file = fs::read_to_string(&project_json).with_context(|| {\n                     format!(\"Failed to read json file {}\", project_json.display())\n                 })?;"}]}