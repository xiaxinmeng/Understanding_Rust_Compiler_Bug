{"sha": "9d6b9d62ba67fd2ff5d97ae958c954ad2c45d04d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjlkNmI5ZDYyYmE2N2ZkMmZmNWQ5N2FlOTU4Yzk1NGFkMmM0NWQwNGQ=", "commit": {"author": {"name": "Ariel Ben-Yehuda", "email": "ariel.byd@gmail.com", "date": "2017-09-21T14:54:39Z"}, "committer": {"name": "Ariel Ben-Yehuda", "email": "ariel.byd@gmail.com", "date": "2017-09-24T09:40:29Z"}, "message": "typeck::check::coercion - roll back failed unsizing type vars\n\nThis wraps unsizing coercions within an additional level of\n`commit_if_ok`, which rolls back type variables if the unsizing coercion\nfails. This prevents a large amount of type-variables from accumulating\nwhile type-checking a large function, e.g. shaving 2GB off one of the\n4GB peaks in #36799.", "tree": {"sha": "e450f514c2bd1dcfe7e7c0660fbde767f3ce45b9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e450f514c2bd1dcfe7e7c0660fbde767f3ce45b9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9d6b9d62ba67fd2ff5d97ae958c954ad2c45d04d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9d6b9d62ba67fd2ff5d97ae958c954ad2c45d04d", "html_url": "https://github.com/rust-lang/rust/commit/9d6b9d62ba67fd2ff5d97ae958c954ad2c45d04d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9d6b9d62ba67fd2ff5d97ae958c954ad2c45d04d/comments", "author": {"login": "arielb1", "id": 1830974, "node_id": "MDQ6VXNlcjE4MzA5NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1830974?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arielb1", "html_url": "https://github.com/arielb1", "followers_url": "https://api.github.com/users/arielb1/followers", "following_url": "https://api.github.com/users/arielb1/following{/other_user}", "gists_url": "https://api.github.com/users/arielb1/gists{/gist_id}", "starred_url": "https://api.github.com/users/arielb1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arielb1/subscriptions", "organizations_url": "https://api.github.com/users/arielb1/orgs", "repos_url": "https://api.github.com/users/arielb1/repos", "events_url": "https://api.github.com/users/arielb1/events{/privacy}", "received_events_url": "https://api.github.com/users/arielb1/received_events", "type": "User", "site_admin": false}, "committer": {"login": "arielb1", "id": 1830974, "node_id": "MDQ6VXNlcjE4MzA5NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1830974?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arielb1", "html_url": "https://github.com/arielb1", "followers_url": "https://api.github.com/users/arielb1/followers", "following_url": "https://api.github.com/users/arielb1/following{/other_user}", "gists_url": "https://api.github.com/users/arielb1/gists{/gist_id}", "starred_url": "https://api.github.com/users/arielb1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arielb1/subscriptions", "organizations_url": "https://api.github.com/users/arielb1/orgs", "repos_url": "https://api.github.com/users/arielb1/repos", "events_url": "https://api.github.com/users/arielb1/events{/privacy}", "received_events_url": "https://api.github.com/users/arielb1/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "acb73dbe8b311eb2ffa640ac3e01795d84159df4", "url": "https://api.github.com/repos/rust-lang/rust/commits/acb73dbe8b311eb2ffa640ac3e01795d84159df4", "html_url": "https://github.com/rust-lang/rust/commit/acb73dbe8b311eb2ffa640ac3e01795d84159df4"}], "stats": {"total": 6, "additions": 5, "deletions": 1}, "files": [{"sha": "94422f93e5922fd7dd09308120aa397a94cd1bc7", "filename": "src/librustc_typeck/check/coercion.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/9d6b9d62ba67fd2ff5d97ae958c954ad2c45d04d/src%2Flibrustc_typeck%2Fcheck%2Fcoercion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9d6b9d62ba67fd2ff5d97ae958c954ad2c45d04d/src%2Flibrustc_typeck%2Fcheck%2Fcoercion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fcoercion.rs?ref=9d6b9d62ba67fd2ff5d97ae958c954ad2c45d04d", "patch": "@@ -187,7 +187,11 @@ impl<'f, 'gcx, 'tcx> Coerce<'f, 'gcx, 'tcx> {\n         }\n \n         // Consider coercing the subtype to a DST\n-        let unsize = self.coerce_unsized(a, b);\n+        //\n+        // NOTE: this is wrapped in a `commit_if_ok` because it creates\n+        // a \"spurious\" type variable, and we don't want to have that\n+        // type variable in memory if the coercion fails.\n+        let unsize = self.commit_if_ok(|_| self.coerce_unsized(a, b));\n         if unsize.is_ok() {\n             debug!(\"coerce: unsize successful\");\n             return unsize;"}]}