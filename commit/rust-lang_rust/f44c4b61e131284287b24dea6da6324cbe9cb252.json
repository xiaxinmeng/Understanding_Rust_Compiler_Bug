{"sha": "f44c4b61e131284287b24dea6da6324cbe9cb252", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY0NGM0YjYxZTEzMTI4NDI4N2IyNGRlYTZkYTYzMjRjYmU5Y2IyNTI=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonas.schievink@ferrous-systems.com", "date": "2020-07-07T10:10:14Z"}, "committer": {"name": "Jonas Schievink", "email": "jonas.schievink@ferrous-systems.com", "date": "2020-07-07T10:10:14Z"}, "message": "Add a command to compute memory usage statistics", "tree": {"sha": "d05b6d48374da0097d359b16115da959b57048ce", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d05b6d48374da0097d359b16115da959b57048ce"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f44c4b61e131284287b24dea6da6324cbe9cb252", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f44c4b61e131284287b24dea6da6324cbe9cb252", "html_url": "https://github.com/rust-lang/rust/commit/f44c4b61e131284287b24dea6da6324cbe9cb252", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f44c4b61e131284287b24dea6da6324cbe9cb252/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0f5d62a3f3b33edadea50ea93c725ac36460c0d7", "url": "https://api.github.com/repos/rust-lang/rust/commits/0f5d62a3f3b33edadea50ea93c725ac36460c0d7", "html_url": "https://github.com/rust-lang/rust/commit/0f5d62a3f3b33edadea50ea93c725ac36460c0d7"}], "stats": {"total": 75, "additions": 74, "deletions": 1}, "files": [{"sha": "84c6f40ff2163d69a34d2b8835e8d29c5f22a68b", "filename": "crates/ra_ide_db/src/change.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/f44c4b61e131284287b24dea6da6324cbe9cb252/crates%2Fra_ide_db%2Fsrc%2Fchange.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f44c4b61e131284287b24dea6da6324cbe9cb252/crates%2Fra_ide_db%2Fsrc%2Fchange.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_db%2Fsrc%2Fchange.rs?ref=f44c4b61e131284287b24dea6da6324cbe9cb252", "patch": "@@ -164,6 +164,15 @@ impl RootDatabase {\n         hir::db::BodyQuery.in_db(self).sweep(sweep);\n     }\n \n+    // Feature: Memory Usage\n+    //\n+    // Clears rust-analyzer's internal database and prints memory usage statistics.\n+    //\n+    // |===\n+    // | Editor  | Action Name\n+    //\n+    // | VS Code | **Rust Analyzer: Memory Usage (Clears Database)**\n+    // |===\n     pub fn per_query_memory_usage(&mut self) -> Vec<(String, Bytes)> {\n         let mut acc: Vec<(String, Bytes)> = vec![];\n         let sweep = SweepStrategy::default().discard_values().sweep_all_revisions();"}, {"sha": "f374334fe37a231b4ece09ec783b41b07cca09ef", "filename": "crates/rust-analyzer/src/handlers.rs", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/f44c4b61e131284287b24dea6da6324cbe9cb252/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f44c4b61e131284287b24dea6da6324cbe9cb252/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs?ref=f44c4b61e131284287b24dea6da6324cbe9cb252", "patch": "@@ -32,7 +32,7 @@ use crate::{\n     cargo_target_spec::CargoTargetSpec,\n     config::RustfmtConfig,\n     from_json, from_proto,\n-    global_state::GlobalStateSnapshot,\n+    global_state::{GlobalState, GlobalStateSnapshot},\n     lsp_ext::{self, InlayHint, InlayHintsParams},\n     to_proto, LspError, Result,\n };\n@@ -62,6 +62,17 @@ pub(crate) fn handle_analyzer_status(snap: GlobalStateSnapshot, _: ()) -> Result\n     Ok(buf)\n }\n \n+pub(crate) fn handle_memory_usage(state: &mut GlobalState, _: ()) -> Result<String> {\n+    let _p = profile(\"handle_memory_usage\");\n+    let mem = state.analysis_host.per_query_memory_usage();\n+\n+    let mut out = String::new();\n+    for (name, bytes) in mem {\n+        format_to!(out, \"{:>8} {}\\n\", bytes, name);\n+    }\n+    Ok(out)\n+}\n+\n pub(crate) fn handle_syntax_tree(\n     snap: GlobalStateSnapshot,\n     params: lsp_ext::SyntaxTreeParams,"}, {"sha": "ba8a0231fa07e289a26c510a871423a5f7bd1085", "filename": "crates/rust-analyzer/src/lsp_ext.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/f44c4b61e131284287b24dea6da6324cbe9cb252/crates%2Frust-analyzer%2Fsrc%2Flsp_ext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f44c4b61e131284287b24dea6da6324cbe9cb252/crates%2Frust-analyzer%2Fsrc%2Flsp_ext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Flsp_ext.rs?ref=f44c4b61e131284287b24dea6da6324cbe9cb252", "patch": "@@ -14,6 +14,14 @@ impl Request for AnalyzerStatus {\n     const METHOD: &'static str = \"rust-analyzer/analyzerStatus\";\n }\n \n+pub enum MemoryUsage {}\n+\n+impl Request for MemoryUsage {\n+    type Params = ();\n+    type Result = String;\n+    const METHOD: &'static str = \"rust-analyzer/memoryUsage\";\n+}\n+\n pub enum ReloadWorkspace {}\n \n impl Request for ReloadWorkspace {"}, {"sha": "5900886e7d142bb39d286ffb05ed1190e87613bb", "filename": "crates/rust-analyzer/src/main_loop.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/f44c4b61e131284287b24dea6da6324cbe9cb252/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f44c4b61e131284287b24dea6da6324cbe9cb252/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs?ref=f44c4b61e131284287b24dea6da6324cbe9cb252", "patch": "@@ -341,6 +341,7 @@ impl GlobalState {\n             .on_sync::<lsp_ext::MatchingBrace>(|s, p| {\n                 handlers::handle_matching_brace(s.snapshot(), p)\n             })?\n+            .on_sync::<lsp_ext::MemoryUsage>(|s, p| handlers::handle_memory_usage(s, p))?\n             .on::<lsp_ext::AnalyzerStatus>(handlers::handle_analyzer_status)?\n             .on::<lsp_ext::SyntaxTree>(handlers::handle_syntax_tree)?\n             .on::<lsp_ext::ExpandMacro>(handlers::handle_expand_macro)?"}, {"sha": "743a2290cbfefe610f71fbe1cb86c954cafb800d", "filename": "editors/code/package.json", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/f44c4b61e131284287b24dea6da6324cbe9cb252/editors%2Fcode%2Fpackage.json", "raw_url": "https://github.com/rust-lang/rust/raw/f44c4b61e131284287b24dea6da6324cbe9cb252/editors%2Fcode%2Fpackage.json", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fpackage.json?ref=f44c4b61e131284287b24dea6da6324cbe9cb252", "patch": "@@ -61,6 +61,7 @@\n     \"activationEvents\": [\n         \"onLanguage:rust\",\n         \"onCommand:rust-analyzer.analyzerStatus\",\n+        \"onCommand:rust-analyzer.memoryUsage\",\n         \"onCommand:rust-analyzer.reloadWorkspace\",\n         \"workspaceContains:**/Cargo.toml\"\n     ],\n@@ -142,6 +143,11 @@\n                 \"title\": \"Status\",\n                 \"category\": \"Rust Analyzer\"\n             },\n+            {\n+                \"command\": \"rust-analyzer.memoryUsage\",\n+                \"title\": \"Memory Usage (Clears Database)\",\n+                \"category\": \"Rust Analyzer\"\n+            },\n             {\n                 \"command\": \"rust-analyzer.reloadWorkspace\",\n                 \"title\": \"Reload workspace\",\n@@ -843,6 +849,10 @@\n                     \"command\": \"rust-analyzer.analyzerStatus\",\n                     \"when\": \"inRustProject\"\n                 },\n+                {\n+                    \"command\": \"rust-analyzer.memoryUsage\",\n+                    \"when\": \"inRustProject\"\n+                },\n                 {\n                     \"command\": \"rust-analyzer.reloadWorkspace\",\n                     \"when\": \"inRustProject\""}, {"sha": "1f3a7cf7e8c1fd5e3b4403a5fcad8c26ceaa1cf2", "filename": "editors/code/src/commands.ts", "status": "modified", "additions": 32, "deletions": 0, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/f44c4b61e131284287b24dea6da6324cbe9cb252/editors%2Fcode%2Fsrc%2Fcommands.ts", "raw_url": "https://github.com/rust-lang/rust/raw/f44c4b61e131284287b24dea6da6324cbe9cb252/editors%2Fcode%2Fsrc%2Fcommands.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fcommands.ts?ref=f44c4b61e131284287b24dea6da6324cbe9cb252", "patch": "@@ -55,6 +55,38 @@ export function analyzerStatus(ctx: Ctx): Cmd {\n     };\n }\n \n+export function memoryUsage(ctx: Ctx): Cmd {\n+    const tdcp = new class implements vscode.TextDocumentContentProvider {\n+        readonly uri = vscode.Uri.parse('rust-analyzer-memory://memory');\n+        readonly eventEmitter = new vscode.EventEmitter<vscode.Uri>();\n+\n+        provideTextDocumentContent(_uri: vscode.Uri): vscode.ProviderResult<string> {\n+            if (!vscode.window.activeTextEditor) return '';\n+\n+            return ctx.client.sendRequest(ra.memoryUsage, null).then((mem) => {\n+                return 'Per-query memory usage:\\n' + mem + '\\n(note: database has been cleared)';\n+            });\n+        }\n+\n+        get onDidChange(): vscode.Event<vscode.Uri> {\n+            return this.eventEmitter.event;\n+        }\n+    }();\n+\n+    ctx.pushCleanup(\n+        vscode.workspace.registerTextDocumentContentProvider(\n+            'rust-analyzer-memory',\n+            tdcp,\n+        ),\n+    );\n+\n+    return async () => {\n+        tdcp.eventEmitter.fire(tdcp.uri);\n+        const document = await vscode.workspace.openTextDocument(tdcp.uri);\n+        return vscode.window.showTextDocument(document, vscode.ViewColumn.Two, true);\n+    };\n+}\n+\n export function matchingBrace(ctx: Ctx): Cmd {\n     return async () => {\n         const editor = ctx.activeRustEditor;"}, {"sha": "5f32cb40e9a3af35944371e183052cc51b8283a2", "filename": "editors/code/src/lsp_ext.ts", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/f44c4b61e131284287b24dea6da6324cbe9cb252/editors%2Fcode%2Fsrc%2Flsp_ext.ts", "raw_url": "https://github.com/rust-lang/rust/raw/f44c4b61e131284287b24dea6da6324cbe9cb252/editors%2Fcode%2Fsrc%2Flsp_ext.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Flsp_ext.ts?ref=f44c4b61e131284287b24dea6da6324cbe9cb252", "patch": "@@ -5,6 +5,7 @@\n import * as lc from \"vscode-languageclient\";\n \n export const analyzerStatus = new lc.RequestType<null, string, void>(\"rust-analyzer/analyzerStatus\");\n+export const memoryUsage = new lc.RequestType<null, string, void>(\"rust-analyzer/memoryUsage\");\n \n export type Status = \"loading\" | \"ready\" | \"invalid\" | \"needsReload\";\n export const status = new lc.NotificationType<Status>(\"rust-analyzer/status\");"}, {"sha": "eda95ae5c43dad8c13d63939a0af2aa5f725e9b7", "filename": "editors/code/src/main.ts", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/f44c4b61e131284287b24dea6da6324cbe9cb252/editors%2Fcode%2Fsrc%2Fmain.ts", "raw_url": "https://github.com/rust-lang/rust/raw/f44c4b61e131284287b24dea6da6324cbe9cb252/editors%2Fcode%2Fsrc%2Fmain.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fmain.ts?ref=f44c4b61e131284287b24dea6da6324cbe9cb252", "patch": "@@ -96,6 +96,7 @@ async function tryActivate(context: vscode.ExtensionContext) {\n     });\n \n     ctx.registerCommand('analyzerStatus', commands.analyzerStatus);\n+    ctx.registerCommand('memoryUsage', commands.memoryUsage);\n     ctx.registerCommand('reloadWorkspace', commands.reloadWorkspace);\n     ctx.registerCommand('matchingBrace', commands.matchingBrace);\n     ctx.registerCommand('joinLines', commands.joinLines);"}]}