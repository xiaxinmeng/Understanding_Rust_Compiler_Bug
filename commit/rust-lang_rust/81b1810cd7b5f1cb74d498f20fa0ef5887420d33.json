{"sha": "81b1810cd7b5f1cb74d498f20fa0ef5887420d33", "node_id": "C_kwDOAAsO6NoAKDgxYjE4MTBjZDdiNWYxY2I3NGQ0OThmMjBmYTBlZjU4ODc0MjBkMzM", "commit": {"author": {"name": "Deadbeef", "email": "ent3rm4n@gmail.com", "date": "2022-07-30T18:01:03Z"}, "committer": {"name": "Deadbeef", "email": "ent3rm4n@gmail.com", "date": "2022-09-16T03:48:42Z"}, "message": "Require `#[const_trait]` for `const` `impl`s", "tree": {"sha": "7dd79d4fc051ce5fdf8f89706ca4b00dba8ff6a7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7dd79d4fc051ce5fdf8f89706ca4b00dba8ff6a7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/81b1810cd7b5f1cb74d498f20fa0ef5887420d33", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/81b1810cd7b5f1cb74d498f20fa0ef5887420d33", "html_url": "https://github.com/rust-lang/rust/commit/81b1810cd7b5f1cb74d498f20fa0ef5887420d33", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/81b1810cd7b5f1cb74d498f20fa0ef5887420d33/comments", "author": {"login": "fee1-dead", "id": 43851243, "node_id": "MDQ6VXNlcjQzODUxMjQz", "avatar_url": "https://avatars.githubusercontent.com/u/43851243?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fee1-dead", "html_url": "https://github.com/fee1-dead", "followers_url": "https://api.github.com/users/fee1-dead/followers", "following_url": "https://api.github.com/users/fee1-dead/following{/other_user}", "gists_url": "https://api.github.com/users/fee1-dead/gists{/gist_id}", "starred_url": "https://api.github.com/users/fee1-dead/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fee1-dead/subscriptions", "organizations_url": "https://api.github.com/users/fee1-dead/orgs", "repos_url": "https://api.github.com/users/fee1-dead/repos", "events_url": "https://api.github.com/users/fee1-dead/events{/privacy}", "received_events_url": "https://api.github.com/users/fee1-dead/received_events", "type": "User", "site_admin": false}, "committer": {"login": "fee1-dead", "id": 43851243, "node_id": "MDQ6VXNlcjQzODUxMjQz", "avatar_url": "https://avatars.githubusercontent.com/u/43851243?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fee1-dead", "html_url": "https://github.com/fee1-dead", "followers_url": "https://api.github.com/users/fee1-dead/followers", "following_url": "https://api.github.com/users/fee1-dead/following{/other_user}", "gists_url": "https://api.github.com/users/fee1-dead/gists{/gist_id}", "starred_url": "https://api.github.com/users/fee1-dead/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fee1-dead/subscriptions", "organizations_url": "https://api.github.com/users/fee1-dead/orgs", "repos_url": "https://api.github.com/users/fee1-dead/repos", "events_url": "https://api.github.com/users/fee1-dead/events{/privacy}", "received_events_url": "https://api.github.com/users/fee1-dead/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "22f6aec42de6bce63f8e43f144058428d4dba0f5", "url": "https://api.github.com/repos/rust-lang/rust/commits/22f6aec42de6bce63f8e43f144058428d4dba0f5", "html_url": "https://github.com/rust-lang/rust/commit/22f6aec42de6bce63f8e43f144058428d4dba0f5"}], "stats": {"total": 27, "additions": 27, "deletions": 0}, "files": [{"sha": "4062862ad747c775b2688a09b7d49e4847aa4426", "filename": "compiler/rustc_passes/src/check_const.rs", "status": "modified", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/81b1810cd7b5f1cb74d498f20fa0ef5887420d33/compiler%2Frustc_passes%2Fsrc%2Fcheck_const.rs", "raw_url": "https://github.com/rust-lang/rust/raw/81b1810cd7b5f1cb74d498f20fa0ef5887420d33/compiler%2Frustc_passes%2Fsrc%2Fcheck_const.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fcheck_const.rs?ref=81b1810cd7b5f1cb74d498f20fa0ef5887420d33", "patch": "@@ -192,6 +192,28 @@ impl<'tcx> Visitor<'tcx> for CheckConstVisitor<'tcx> {\n     }\n \n     fn visit_item(&mut self, item: &'tcx hir::Item<'tcx>) {\n+        let tcx = self.tcx;\n+        if let hir::ItemKind::Impl(hir::Impl {\n+            constness: hir::Constness::Const,\n+            of_trait: Some(trait_ref),\n+            ..\n+        }) = item.kind\n+        {\n+            let def_id = trait_ref.trait_def_id().unwrap();\n+            let source_map = tcx.sess.source_map();\n+            if !tcx.has_attr(def_id, sym::const_trait) {\n+                tcx.sess\n+                    .struct_span_err(\n+                        source_map.guess_head_span(item.span),\n+                        \"const `impl`s must be for traits marked with `#[const_trait]`\",\n+                    )\n+                    .span_note(\n+                        source_map.guess_head_span(tcx.def_span(def_id)),\n+                        \"this trait must be annotated with `#[const_trait]`\",\n+                    )\n+                    .emit();\n+            }\n+        }\n         intravisit::walk_item(self, item);\n     }\n "}, {"sha": "959008284517e9eff00a936f27a7b4f71f43e28b", "filename": "library/core/src/convert/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/81b1810cd7b5f1cb74d498f20fa0ef5887420d33/library%2Fcore%2Fsrc%2Fconvert%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/81b1810cd7b5f1cb74d498f20fa0ef5887420d33/library%2Fcore%2Fsrc%2Fconvert%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fconvert%2Fmod.rs?ref=81b1810cd7b5f1cb74d498f20fa0ef5887420d33", "patch": "@@ -368,6 +368,7 @@ pub trait Into<T>: Sized {\n     all(_Self = \"&str\", T = \"std::string::String\"),\n     note = \"to coerce a `{T}` into a `{Self}`, use `&*` as a prefix\",\n ))]\n+#[const_trait]\n pub trait From<T>: Sized {\n     /// Converts to this type from the input type.\n     #[lang = \"from\"]"}, {"sha": "d96b53de0a338328fec822aa2a2bfa1e66de5e9f", "filename": "library/core/src/default.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/81b1810cd7b5f1cb74d498f20fa0ef5887420d33/library%2Fcore%2Fsrc%2Fdefault.rs", "raw_url": "https://github.com/rust-lang/rust/raw/81b1810cd7b5f1cb74d498f20fa0ef5887420d33/library%2Fcore%2Fsrc%2Fdefault.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fdefault.rs?ref=81b1810cd7b5f1cb74d498f20fa0ef5887420d33", "patch": "@@ -99,6 +99,7 @@\n /// ```\n #[cfg_attr(not(test), rustc_diagnostic_item = \"Default\")]\n #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+#[const_trait]\n pub trait Default: Sized {\n     /// Returns the \"default value\" for a type.\n     ///"}, {"sha": "5e3dc48b6ca1c1b8a8cc464162b7a598ebb767c8", "filename": "library/core/src/ops/index.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/81b1810cd7b5f1cb74d498f20fa0ef5887420d33/library%2Fcore%2Fsrc%2Fops%2Findex.rs", "raw_url": "https://github.com/rust-lang/rust/raw/81b1810cd7b5f1cb74d498f20fa0ef5887420d33/library%2Fcore%2Fsrc%2Fops%2Findex.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fops%2Findex.rs?ref=81b1810cd7b5f1cb74d498f20fa0ef5887420d33", "patch": "@@ -55,6 +55,7 @@\n #[doc(alias = \"]\")]\n #[doc(alias = \"[\")]\n #[doc(alias = \"[]\")]\n+#[const_trait]\n pub trait Index<Idx: ?Sized> {\n     /// The returned type after indexing.\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n@@ -163,6 +164,7 @@ see chapter in The Book <https://doc.rust-lang.org/book/ch08-02-strings.html#ind\n #[doc(alias = \"[\")]\n #[doc(alias = \"]\")]\n #[doc(alias = \"[]\")]\n+#[const_trait]\n pub trait IndexMut<Idx: ?Sized>: Index<Idx> {\n     /// Performs the mutable indexing (`container[index]`) operation.\n     ///"}, {"sha": "3d99bb7f9a074e2b3e1cbcde3cad6a1d168e1ed4", "filename": "library/core/src/slice/index.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/81b1810cd7b5f1cb74d498f20fa0ef5887420d33/library%2Fcore%2Fsrc%2Fslice%2Findex.rs", "raw_url": "https://github.com/rust-lang/rust/raw/81b1810cd7b5f1cb74d498f20fa0ef5887420d33/library%2Fcore%2Fsrc%2Fslice%2Findex.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fslice%2Findex.rs?ref=81b1810cd7b5f1cb74d498f20fa0ef5887420d33", "patch": "@@ -158,6 +158,7 @@ mod private_slice_index {\n     message = \"the type `{T}` cannot be indexed by `{Self}`\",\n     label = \"slice indices are of type `usize` or ranges of `usize`\"\n )]\n+#[const_trait]\n pub unsafe trait SliceIndex<T: ?Sized>: private_slice_index::Sealed {\n     /// The output type returned by methods.\n     #[stable(feature = \"slice_get_slice\", since = \"1.28.0\")]"}]}