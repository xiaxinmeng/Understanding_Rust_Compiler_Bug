{"sha": "659d44a3b4928b5b9b81927dec74242d3bdb7120", "node_id": "MDY6Q29tbWl0NzI0NzEyOjY1OWQ0NGEzYjQ5MjhiNWI5YjgxOTI3ZGVjNzQyNDJkM2JkYjcxMjA=", "commit": {"author": {"name": "David Wood", "email": "david@davidtw.co", "date": "2020-08-07T14:59:29Z"}, "committer": {"name": "David Wood", "email": "david@davidtw.co", "date": "2020-08-07T14:59:29Z"}, "message": "polymorphize: visit promoted MIR\n\nThis commit makes polymorphization visited the MIR of unevaluated\nconstants with available promoted MIR instead of visiting the\nsubstitutions of that constant - which will mark all of the generic\nparameters as used.\n\nSigned-off-by: David Wood <david@davidtw.co>", "tree": {"sha": "8cb1c958c6dd0da993268afaa9808cdc4c7de8a2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8cb1c958c6dd0da993268afaa9808cdc4c7de8a2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/659d44a3b4928b5b9b81927dec74242d3bdb7120", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEfgm2/wUjk9OnjxlyJZLnbIc4H9kFAl8tbRQACgkQJZLnbIc4\nH9lcrg//VLSXb179fr2ZqCGeYdqTm7yXbeMlSDjmt0B6yjutMRBiuu+Bt89zxA8w\nmP4SBgZpnmkQp7nP3VfIjxE+oSXc9k/PI/WXgAfaOLn5Z1/NixTMmr8cHwmOmvt9\n8QXXS0agbTzXb2qACq7HiPZ1RozXUJUxYouvHjaTXkc/rmyRbXH7W01/e362Y4i5\nBefJCRRw02ZgqBrcYvenp7ezBEFH/v+qeimjVrT8z+2SEMaf3wFqa/v6ifQyGbS7\nZxXtDxZvV7DUE3tmea3TfatgCeybVUfCqsrXbY474JV/B37WjFVO3mVirbwRS4cu\nYvvp6+8VqmRkPUpfiSYSZg1ThftwHvAjD5fDAV6z57gXupR1R2CjZTTW7f1+FKxs\n+p/wX+COXrqX6nYtEDEvzG49dmngT7V1yQk/9YsAZdbGn7jll4r7HMyqarpjxAUl\nm1cl/lJaq9RLz2nOZ69ygfApTJOiG4K+7YU1/jZqsGO16zFAdXqxJez8CEp7W3w6\n7pF/5HXz0hDKJPLc0BIAYKLcNDkyDMzqnrpvM9FnwgnqTzaUvesM5VyczAdmHdj8\nbJJS+hw0ulMlY+5zLxVzoVO64NWUc3H0gGurpRVnD0jdDxh3TQH8JYgfIhaFHXIb\nAQvOGH52Z7k8w+TQpyWzRu/YhCT6N7Zy0+Iug2lpFhpTL/SM9ok=\n=0he1\n-----END PGP SIGNATURE-----", "payload": "tree 8cb1c958c6dd0da993268afaa9808cdc4c7de8a2\nparent 1e0e618cfbcb9240e6beac8cd16778b369ebe1b7\nauthor David Wood <david@davidtw.co> 1596812369 +0100\ncommitter David Wood <david@davidtw.co> 1596812369 +0100\n\npolymorphize: visit promoted MIR\n\nThis commit makes polymorphization visited the MIR of unevaluated\nconstants with available promoted MIR instead of visiting the\nsubstitutions of that constant - which will mark all of the generic\nparameters as used.\n\nSigned-off-by: David Wood <david@davidtw.co>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/659d44a3b4928b5b9b81927dec74242d3bdb7120", "html_url": "https://github.com/rust-lang/rust/commit/659d44a3b4928b5b9b81927dec74242d3bdb7120", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/659d44a3b4928b5b9b81927dec74242d3bdb7120/comments", "author": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "committer": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1e0e618cfbcb9240e6beac8cd16778b369ebe1b7", "url": "https://api.github.com/repos/rust-lang/rust/commits/1e0e618cfbcb9240e6beac8cd16778b369ebe1b7", "html_url": "https://github.com/rust-lang/rust/commit/1e0e618cfbcb9240e6beac8cd16778b369ebe1b7"}], "stats": {"total": 48, "additions": 46, "deletions": 2}, "files": [{"sha": "5aa6fc3ed46986453ee1b5566cea61aac86f6c8f", "filename": "src/librustc_mir/monomorphize/polymorphize.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/659d44a3b4928b5b9b81927dec74242d3bdb7120/src%2Flibrustc_mir%2Fmonomorphize%2Fpolymorphize.rs", "raw_url": "https://github.com/rust-lang/rust/raw/659d44a3b4928b5b9b81927dec74242d3bdb7120/src%2Flibrustc_mir%2Fmonomorphize%2Fpolymorphize.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fmonomorphize%2Fpolymorphize.rs?ref=659d44a3b4928b5b9b81927dec74242d3bdb7120", "patch": "@@ -245,6 +245,13 @@ impl<'a, 'tcx> TypeVisitor<'tcx> for UsedGenericParametersVisitor<'a, 'tcx> {\n                 self.unused_parameters.clear(param.index);\n                 false\n             }\n+            ty::ConstKind::Unevaluated(_, _, Some(p)) => {\n+                // If there is a promoted, don't look at the substs - since it will always contain\n+                // the generic parameters, instead, traverse the promoted MIR.\n+                let promoted = self.tcx.promoted_mir(self.def_id);\n+                self.visit_body(&promoted[p]);\n+                false\n+            }\n             _ => c.super_visit_with(self),\n         }\n     }"}, {"sha": "2cd02673442fed83abbb2a0da807235005f2236c", "filename": "src/test/ui/polymorphization/promoted-function-1.rs", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/659d44a3b4928b5b9b81927dec74242d3bdb7120/src%2Ftest%2Fui%2Fpolymorphization%2Fpromoted-function-1.rs", "raw_url": "https://github.com/rust-lang/rust/raw/659d44a3b4928b5b9b81927dec74242d3bdb7120/src%2Ftest%2Fui%2Fpolymorphization%2Fpromoted-function-1.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fpolymorphization%2Fpromoted-function-1.rs?ref=659d44a3b4928b5b9b81927dec74242d3bdb7120", "patch": "@@ -0,0 +1,12 @@\n+// build-fail\n+// compile-flags: -Zpolymorphize=on\n+#![crate_type = \"lib\"]\n+#![feature(rustc_attrs)]\n+\n+fn foo<'a>(_: &'a ()) {}\n+\n+#[rustc_polymorphize_error]\n+pub fn test<T>() {\n+    //~^ ERROR item has unused generic parameters\n+    foo(&());\n+}"}, {"sha": "fcbb86949232b225598f4396701bb37c95570dc3", "filename": "src/test/ui/polymorphization/promoted-function-1.stderr", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/659d44a3b4928b5b9b81927dec74242d3bdb7120/src%2Ftest%2Fui%2Fpolymorphization%2Fpromoted-function-1.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/659d44a3b4928b5b9b81927dec74242d3bdb7120/src%2Ftest%2Fui%2Fpolymorphization%2Fpromoted-function-1.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fpolymorphization%2Fpromoted-function-1.stderr?ref=659d44a3b4928b5b9b81927dec74242d3bdb7120", "patch": "@@ -0,0 +1,8 @@\n+error: item has unused generic parameters\n+  --> $DIR/promoted-function-1.rs:9:8\n+   |\n+LL | pub fn test<T>() {\n+   |        ^^^^ - generic parameter `T` is unused\n+\n+error: aborting due to previous error\n+"}, {"sha": "a56a8e70e4c50153cdb2cc2fa13c6a2390893940", "filename": "src/test/ui/polymorphization/promoted-function.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/659d44a3b4928b5b9b81927dec74242d3bdb7120/src%2Ftest%2Fui%2Fpolymorphization%2Fpromoted-function.rs", "raw_url": "https://github.com/rust-lang/rust/raw/659d44a3b4928b5b9b81927dec74242d3bdb7120/src%2Ftest%2Fui%2Fpolymorphization%2Fpromoted-function.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fpolymorphization%2Fpromoted-function.rs?ref=659d44a3b4928b5b9b81927dec74242d3bdb7120", "patch": "@@ -1,4 +1,6 @@\n // run-pass\n+// compile-flags:-Zpolymorphize=on\n+\n fn fop<T>() {}\n \n fn bar<T>() -> &'static fn() {"}, {"sha": "b803fec2ccfdb17e4dcb9fee0b5592a0152c6e57", "filename": "src/test/ui/polymorphization/unsized_cast.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/659d44a3b4928b5b9b81927dec74242d3bdb7120/src%2Ftest%2Fui%2Fpolymorphization%2Funsized_cast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/659d44a3b4928b5b9b81927dec74242d3bdb7120/src%2Ftest%2Fui%2Fpolymorphization%2Funsized_cast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fpolymorphization%2Funsized_cast.rs?ref=659d44a3b4928b5b9b81927dec74242d3bdb7120", "patch": "@@ -17,6 +17,7 @@ fn foo<T: Default>() {\n fn foo2<T: Default>() {\n     let _: T = Default::default();\n     (|| {\n+        //~^ ERROR item has unused generic parameters\n         let call: extern \"rust-call\" fn(_, _) = Fn::call;\n         call(&|| {}, ());\n         //~^ ERROR item has unused generic parameters"}, {"sha": "b51cc5c719f0b271d61ff68316243c4299809e40", "filename": "src/test/ui/polymorphization/unsized_cast.stderr", "status": "modified", "additions": 16, "deletions": 2, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/659d44a3b4928b5b9b81927dec74242d3bdb7120/src%2Ftest%2Fui%2Fpolymorphization%2Funsized_cast.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/659d44a3b4928b5b9b81927dec74242d3bdb7120/src%2Ftest%2Fui%2Fpolymorphization%2Funsized_cast.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fpolymorphization%2Funsized_cast.stderr?ref=659d44a3b4928b5b9b81927dec74242d3bdb7120", "patch": "@@ -17,13 +17,27 @@ LL |     (|| Box::new(|| {}) as Box<dyn Fn()>)();\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n error: item has unused generic parameters\n-  --> $DIR/unsized_cast.rs:21:15\n+  --> $DIR/unsized_cast.rs:22:15\n    |\n LL | fn foo2<T: Default>() {\n    |         - generic parameter `T` is unused\n ...\n LL |         call(&|| {}, ());\n    |               ^^^^^\n \n-error: aborting due to 3 previous errors\n+error: item has unused generic parameters\n+  --> $DIR/unsized_cast.rs:19:5\n+   |\n+LL |   fn foo2<T: Default>() {\n+   |           - generic parameter `T` is unused\n+LL |       let _: T = Default::default();\n+LL | /     (|| {\n+LL | |\n+LL | |         let call: extern \"rust-call\" fn(_, _) = Fn::call;\n+LL | |         call(&|| {}, ());\n+LL | |\n+LL | |     })();\n+   | |______^\n+\n+error: aborting due to 4 previous errors\n "}]}