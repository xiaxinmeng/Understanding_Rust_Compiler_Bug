{"sha": "1407c7627e91e8d4472749ac9ea45d9f8a3aaab6", "node_id": "C_kwDOAAsO6NoAKDE0MDdjNzYyN2U5MWU4ZDQ0NzI3NDlhYzllYTQ1ZDlmOGEzYWFhYjY", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-05-09T18:41:30Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-05-09T18:41:30Z"}, "message": "Auto merge of #10751 - blyxyas:explain_with_config, r=xFrednet\n\nAdd configuration options to `--explain`\n\nThis PR rearranges some modules, taking `metadata_collector` out of `internal_lints` and making public just the necessary functions for `explain()` to use.\n\nThe output looks something like this:\n```sh\n$ cargo run --bin cargo-clippy --manifest-path ../rust-clippy/Cargo.toml -- --explain cognitive_complexity\n### What it does\nChecks for methods with high cognitive complexity.\n\n### Why is this bad?\nMethods of high cognitive complexity tend to be hard to\nboth read and maintain. Also LLVM will tend to optimize small methods better.\n\n### Known problems\nSometimes it's hard to find a way to reduce the\ncomplexity.\n\n### Example\nYou'll see it when you get the warning.\n\n========================================\nConfiguration for clippy::cognitive_complexity:\n- cognitive-complexity-threshold: The maximum cognitive complexity a function can have (default: 25)\n```\n\nFixes #9990\nr? `@xFrednet`\n\n---\n\nchangelog: Docs: `cargo clippy --explain LINT` now shows possible configuration options for the explained lint\n[#10751](https://github.com/rust-lang/rust-clippy/pull/10751)\n<!-- changelog_checked -->", "tree": {"sha": "d8d6079b2a9d16ec780e00970afd5450cae97e7e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d8d6079b2a9d16ec780e00970afd5450cae97e7e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1407c7627e91e8d4472749ac9ea45d9f8a3aaab6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1407c7627e91e8d4472749ac9ea45d9f8a3aaab6", "html_url": "https://github.com/rust-lang/rust/commit/1407c7627e91e8d4472749ac9ea45d9f8a3aaab6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1407c7627e91e8d4472749ac9ea45d9f8a3aaab6/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "77e4d7a839665c5687a997289e2c006e5c569e42", "url": "https://api.github.com/repos/rust-lang/rust/commits/77e4d7a839665c5687a997289e2c006e5c569e42", "html_url": "https://github.com/rust-lang/rust/commit/77e4d7a839665c5687a997289e2c006e5c569e42"}, {"sha": "3e8fea612dd8ab8d03aaa264652ced97b800bb91", "url": "https://api.github.com/repos/rust-lang/rust/commits/3e8fea612dd8ab8d03aaa264652ced97b800bb91", "html_url": "https://github.com/rust-lang/rust/commit/3e8fea612dd8ab8d03aaa264652ced97b800bb91"}], "stats": {"total": 280, "additions": 168, "deletions": 112}, "files": [{"sha": "38f4ecc75b6fb8bee207c0b9f39667232bc36715", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 21, "deletions": 3, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/1407c7627e91e8d4472749ac9ea45d9f8a3aaab6/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1407c7627e91e8d4472749ac9ea45d9f8a3aaab6/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=1407c7627e91e8d4472749ac9ea45d9f8a3aaab6", "patch": "@@ -332,8 +332,11 @@ mod zero_div_zero;\n mod zero_sized_map_values;\n // end lints modules, do not remove this comment, it\u2019s used in `update_lints`\n \n-use crate::utils::conf::{format_error, TryConf};\n pub use crate::utils::conf::{lookup_conf_file, Conf};\n+use crate::utils::{\n+    conf::{format_error, metadata::get_configuration_metadata, TryConf},\n+    FindAll,\n+};\n \n /// Register all pre expansion lints\n ///\n@@ -389,7 +392,7 @@ pub fn read_conf(sess: &Session, path: &io::Result<(Option<PathBuf>, Vec<String>\n     conf\n }\n \n-#[derive(Default)]\n+#[derive(Default)] //~ ERROR no such field\n struct RegistrationGroups {\n     all: Vec<LintId>,\n     cargo: Vec<LintId>,\n@@ -472,7 +475,22 @@ pub(crate) struct LintInfo {\n pub fn explain(name: &str) {\n     let target = format!(\"clippy::{}\", name.to_ascii_uppercase());\n     match declared_lints::LINTS.iter().find(|info| info.lint.name == target) {\n-        Some(info) => print!(\"{}\", info.explanation),\n+        Some(info) => {\n+            println!(\"{}\", info.explanation);\n+            // Check if the lint has configuration\n+            let mdconf = get_configuration_metadata();\n+            if let Some(config_vec_positions) = mdconf\n+                .iter()\n+                .find_all(|cconf| cconf.lints.contains(&info.lint.name_lower()[8..].to_owned()))\n+            {\n+                // If it has, print it\n+                println!(\"### Configuration for {}:\\n\", info.lint.name_lower());\n+                for position in config_vec_positions {\n+                    let conf = &mdconf[position];\n+                    println!(\"  - {}: {} (default: {})\", conf.name, conf.doc, conf.default);\n+                }\n+            }\n+        },\n         None => println!(\"unknown lint: {name}\"),\n     }\n }"}, {"sha": "f6de66bb5145b5c2d6c2692b96c55c0e6b204829", "filename": "clippy_lints/src/utils/conf.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/1407c7627e91e8d4472749ac9ea45d9f8a3aaab6/clippy_lints%2Fsrc%2Futils%2Fconf.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1407c7627e91e8d4472749ac9ea45d9f8a3aaab6/clippy_lints%2Fsrc%2Futils%2Fconf.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Futils%2Fconf.rs?ref=1407c7627e91e8d4472749ac9ea45d9f8a3aaab6", "patch": "@@ -174,16 +174,15 @@ macro_rules! define_Conf {\n             }\n         }\n \n-        #[cfg(feature = \"internal\")]\n         pub mod metadata {\n-            use crate::utils::internal_lints::metadata_collector::ClippyConfiguration;\n+            use crate::utils::ClippyConfiguration;\n \n             macro_rules! wrap_option {\n                 () => (None);\n                 ($x:literal) => (Some($x));\n             }\n \n-            pub(crate) fn get_configuration_metadata() -> Vec<ClippyConfiguration> {\n+            pub fn get_configuration_metadata() -> Vec<ClippyConfiguration> {\n                 vec![\n                     $(\n                         {"}, {"sha": "7a1cd3effaef2ae79f48d1cf34734098f9b437fc", "filename": "clippy_lints/src/utils/internal_lints/metadata_collector.rs", "status": "modified", "additions": 5, "deletions": 106, "changes": 111, "blob_url": "https://github.com/rust-lang/rust/blob/1407c7627e91e8d4472749ac9ea45d9f8a3aaab6/clippy_lints%2Fsrc%2Futils%2Finternal_lints%2Fmetadata_collector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1407c7627e91e8d4472749ac9ea45d9f8a3aaab6/clippy_lints%2Fsrc%2Futils%2Finternal_lints%2Fmetadata_collector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Futils%2Finternal_lints%2Fmetadata_collector.rs?ref=1407c7627e91e8d4472749ac9ea45d9f8a3aaab6", "patch": "@@ -8,7 +8,11 @@\n //! a simple mistake)\n \n use crate::renamed_lints::RENAMED_LINTS;\n-use crate::utils::internal_lints::lint_without_lint_pass::{extract_clippy_version_value, is_lint_ref_type};\n+use crate::utils::{\n+    collect_configs,\n+    internal_lints::lint_without_lint_pass::{extract_clippy_version_value, is_lint_ref_type},\n+    ClippyConfiguration,\n+};\n \n use clippy_utils::diagnostics::span_lint;\n use clippy_utils::ty::{match_type, walk_ptrs_ty_depth};\n@@ -520,111 +524,6 @@ impl Serialize for ApplicabilityInfo {\n     }\n }\n \n-// ==================================================================\n-// Configuration\n-// ==================================================================\n-#[derive(Debug, Clone, Default)]\n-pub struct ClippyConfiguration {\n-    name: String,\n-    config_type: &'static str,\n-    default: String,\n-    lints: Vec<String>,\n-    doc: String,\n-    #[allow(dead_code)]\n-    deprecation_reason: Option<&'static str>,\n-}\n-\n-impl ClippyConfiguration {\n-    pub fn new(\n-        name: &'static str,\n-        config_type: &'static str,\n-        default: String,\n-        doc_comment: &'static str,\n-        deprecation_reason: Option<&'static str>,\n-    ) -> Self {\n-        let (lints, doc) = parse_config_field_doc(doc_comment)\n-            .unwrap_or_else(|| (vec![], \"[ERROR] MALFORMED DOC COMMENT\".to_string()));\n-\n-        Self {\n-            name: to_kebab(name),\n-            lints,\n-            doc,\n-            config_type,\n-            default,\n-            deprecation_reason,\n-        }\n-    }\n-\n-    fn to_markdown_paragraph(&self) -> String {\n-        format!(\n-            \"### {}\\n{}\\n\\n**Default Value:** `{}` (`{}`)\\n\\n{}\\n\\n\",\n-            self.name,\n-            self.doc\n-                .lines()\n-                .map(|line| line.strip_prefix(\"    \").unwrap_or(line))\n-                .join(\"\\n\"),\n-            self.default,\n-            self.config_type,\n-            self.lints\n-                .iter()\n-                .map(|name| name.to_string().split_whitespace().next().unwrap().to_string())\n-                .map(|name| format!(\"* [{name}](https://rust-lang.github.io/rust-clippy/master/index.html#{name})\"))\n-                .join(\"\\n\"),\n-        )\n-    }\n-\n-    fn to_markdown_table_entry(&self) -> String {\n-        format!(\"| [{}](#{}) | `{}` |\", self.name, self.name, self.default)\n-    }\n-}\n-\n-fn collect_configs() -> Vec<ClippyConfiguration> {\n-    crate::utils::conf::metadata::get_configuration_metadata()\n-}\n-\n-/// This parses the field documentation of the config struct.\n-///\n-/// ```rust, ignore\n-/// parse_config_field_doc(cx, \"Lint: LINT_NAME_1, LINT_NAME_2. Papa penguin, papa penguin\")\n-/// ```\n-///\n-/// Would yield:\n-/// ```rust, ignore\n-/// Some([\"lint_name_1\", \"lint_name_2\"], \"Papa penguin, papa penguin\")\n-/// ```\n-fn parse_config_field_doc(doc_comment: &str) -> Option<(Vec<String>, String)> {\n-    const DOC_START: &str = \" Lint: \";\n-    if_chain! {\n-        if doc_comment.starts_with(DOC_START);\n-        if let Some(split_pos) = doc_comment.find('.');\n-        then {\n-            let mut doc_comment = doc_comment.to_string();\n-            let mut documentation = doc_comment.split_off(split_pos);\n-\n-            // Extract lints\n-            doc_comment.make_ascii_lowercase();\n-            let lints: Vec<String> = doc_comment\n-                .split_off(DOC_START.len())\n-                .split(\", \")\n-                .map(str::to_string)\n-                .collect();\n-\n-            // Format documentation correctly\n-            // split off leading `.` from lint name list and indent for correct formatting\n-            documentation = documentation.trim_start_matches('.').trim().replace(\"\\n \", \"\\n    \");\n-\n-            Some((lints, documentation))\n-        } else {\n-            None\n-        }\n-    }\n-}\n-\n-/// Transforms a given `snake_case_string` to a tasty `kebab-case-string`\n-fn to_kebab(config_name: &str) -> String {\n-    config_name.replace('_', \"-\")\n-}\n-\n impl fmt::Display for ClippyConfiguration {\n     fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> fmt::Result {\n         writeln!("}, {"sha": "d3ea7cafa80c2f57b44db3d1b7f1d095c8b4e85e", "filename": "clippy_lints/src/utils/mod.rs", "status": "modified", "additions": 140, "deletions": 0, "changes": 140, "blob_url": "https://github.com/rust-lang/rust/blob/1407c7627e91e8d4472749ac9ea45d9f8a3aaab6/clippy_lints%2Fsrc%2Futils%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1407c7627e91e8d4472749ac9ea45d9f8a3aaab6/clippy_lints%2Fsrc%2Futils%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Futils%2Fmod.rs?ref=1407c7627e91e8d4472749ac9ea45d9f8a3aaab6", "patch": "@@ -4,3 +4,143 @@ pub mod dump_hir;\n pub mod format_args_collector;\n #[cfg(feature = \"internal\")]\n pub mod internal_lints;\n+#[cfg(feature = \"internal\")]\n+use itertools::Itertools;\n+\n+/// Transforms a given `snake_case_string` to a tasty `kebab-case-string`\n+fn to_kebab(config_name: &str) -> String {\n+    config_name.replace('_', \"-\")\n+}\n+\n+// ==================================================================\n+// Configuration\n+// ==================================================================\n+#[derive(Debug, Clone, Default)] //~ ERROR no such field\n+pub struct ClippyConfiguration {\n+    pub name: String,\n+    #[allow(dead_code)]\n+    config_type: &'static str,\n+    pub default: String,\n+    pub lints: Vec<String>,\n+    pub doc: String,\n+    #[allow(dead_code)]\n+    deprecation_reason: Option<&'static str>,\n+}\n+\n+impl ClippyConfiguration {\n+    pub fn new(\n+        name: &'static str,\n+        config_type: &'static str,\n+        default: String,\n+        doc_comment: &'static str,\n+        deprecation_reason: Option<&'static str>,\n+    ) -> Self {\n+        let (lints, doc) = parse_config_field_doc(doc_comment)\n+            .unwrap_or_else(|| (vec![], \"[ERROR] MALFORMED DOC COMMENT\".to_string()));\n+\n+        Self {\n+            name: to_kebab(name),\n+            lints,\n+            doc,\n+            config_type,\n+            default,\n+            deprecation_reason,\n+        }\n+    }\n+\n+    #[cfg(feature = \"internal\")]\n+    fn to_markdown_paragraph(&self) -> String {\n+        format!(\n+            \"### {}\\n{}\\n\\n**Default Value:** `{}` (`{}`)\\n\\n{}\\n\\n\",\n+            self.name,\n+            self.doc\n+                .lines()\n+                .map(|line| line.strip_prefix(\"    \").unwrap_or(line))\n+                .join(\"\\n\"),\n+            self.default,\n+            self.config_type,\n+            self.lints\n+                .iter()\n+                .map(|name| name.to_string().split_whitespace().next().unwrap().to_string())\n+                .map(|name| format!(\"* [{name}](https://rust-lang.github.io/rust-clippy/master/index.html#{name})\"))\n+                .join(\"\\n\"),\n+        )\n+    }\n+\n+    #[cfg(feature = \"internal\")]\n+    fn to_markdown_table_entry(&self) -> String {\n+        format!(\"| [{}](#{}) | `{}` |\", self.name, self.name, self.default)\n+    }\n+}\n+\n+#[cfg(feature = \"internal\")]\n+fn collect_configs() -> Vec<ClippyConfiguration> {\n+    crate::utils::conf::metadata::get_configuration_metadata()\n+}\n+\n+/// This parses the field documentation of the config struct.\n+///\n+/// ```rust, ignore\n+/// parse_config_field_doc(cx, \"Lint: LINT_NAME_1, LINT_NAME_2. Papa penguin, papa penguin\")\n+/// ```\n+///\n+/// Would yield:\n+/// ```rust, ignore\n+/// Some([\"lint_name_1\", \"lint_name_2\"], \"Papa penguin, papa penguin\")\n+/// ```\n+fn parse_config_field_doc(doc_comment: &str) -> Option<(Vec<String>, String)> {\n+    const DOC_START: &str = \" Lint: \";\n+    if_chain! {\n+        if doc_comment.starts_with(DOC_START);\n+        if let Some(split_pos) = doc_comment.find('.');\n+        then {\n+            let mut doc_comment = doc_comment.to_string();\n+            let mut documentation = doc_comment.split_off(split_pos);\n+\n+            // Extract lints\n+            doc_comment.make_ascii_lowercase();\n+            let lints: Vec<String> = doc_comment\n+                .split_off(DOC_START.len())\n+                .split(\", \")\n+                .map(str::to_string)\n+                .collect();\n+\n+            // Format documentation correctly\n+            // split off leading `.` from lint name list and indent for correct formatting\n+            documentation = documentation.trim_start_matches('.').trim().replace(\"\\n \", \"\\n    \");\n+\n+            Some((lints, documentation))\n+        } else {\n+            None\n+        }\n+    }\n+}\n+\n+// Shamelessly stolen from find_all (https://github.com/nectariner/find_all)\n+pub trait FindAll: Iterator + Sized {\n+    fn find_all<P>(&mut self, predicate: P) -> Option<Vec<usize>>\n+    where\n+        P: FnMut(&Self::Item) -> bool;\n+}\n+\n+impl<I> FindAll for I\n+where\n+    I: Iterator,\n+{\n+    fn find_all<P>(&mut self, mut predicate: P) -> Option<Vec<usize>>\n+    where\n+        P: FnMut(&Self::Item) -> bool,\n+    {\n+        let mut occurences = Vec::<usize>::default();\n+        for (index, element) in self.enumerate() {\n+            if predicate(&element) {\n+                occurences.push(index);\n+            }\n+        }\n+\n+        match occurences.len() {\n+            0 => None,\n+            _ => Some(occurences),\n+        }\n+    }\n+}"}]}