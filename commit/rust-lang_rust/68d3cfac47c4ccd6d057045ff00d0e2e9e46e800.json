{"sha": "68d3cfac47c4ccd6d057045ff00d0e2e9e46e800", "node_id": "C_kwDOAAsO6NoAKDY4ZDNjZmFjNDdjNGNjZDZkMDU3MDQ1ZmYwMGQwZTJlOWU0NmU4MDA", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2022-09-02T09:34:51Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-09-02T09:34:51Z"}, "message": "Rollup merge of #101166 - GuillaumeGomez:error-index-mdbook, r=notriddle\n\nGenerate error index with mdbook instead of raw HTML pages\n\nThis is a follow-up of https://github.com/rust-lang/rust/pull/100922.\n\nThis comes from a remark from ````@estebank```` who said that the search was a nice thing on the previous version and that it wasn't possible anymore. An easy way to come around this limitation was to use `mdbook`, which is what I did here.\n\nNow some explanations on the code. I'll explain how I developed this and why I reached this solution. First I did it very basically by simply setting the source directory and the output directory, generated a `SUMMARY.md` manually which listed all error codes and that was it. Two problems arose from this:\n 1. A lot of new HTML files were generated at the top level\n 2. An `index.html` file was generated at the top-level (the summary in short).\n\nSo for `1.`, it's not great to have too many files at the top-level as it could create file conflicts more easily. And for `2.`, this is actually a huge issue because <doc.rust-lang.org> generates an `index.html` file with a links to a few different resources, so it should never be overwritten. <s>Unfortunately, `mdbook` **always** generates an `index.html` file so the only solution I could see (except for sending them a contribution, I'll maybe do that later) was to temporaly move a potentially existing `index.html` file and then puts it back once done. For this last part, to ensure that we don't return *before* it has been put back, I wrapped the `mdbook` generation code inside `render_html_inner` which is called from `render_html` which in turn handle the \"save\" of `index.html`.</s>\n\nEDIT: `mdbook` completely deletes ALL the content in the target directory so I instead generate into a sub directory and then I move the files to the real target directory.\n\nTo keep compatibility with the old version, I also put the `<script>` ````@notriddle```` nicely provided in the previous PR only into the `error-index.html` file to prevent unneeded repetition. I didn't use `mdbook` `additional-js` option because the JS is included at the end of all HTML files, which we don't want for two reasons:\n 1. It's slow.\n 2. We only want it to be run in `error-index.html` (even if we also ensure in the JS itself too!).\n\n<s>Now the last part: why we generate the summary twice. We actually generate it once to tell `mdbook` what the book will look like and a second time because a create a new chapter content which will actually list all the error codes (with the updated paths).</s>\n\nEDIT: I removed the need for two summaries.\n\nYou can test it [here](https://rustdoc.crud.net/imperio/error-index-mdbook/error-index.html).\n\nr? ````@notriddle````", "tree": {"sha": "21e6f491a15cac8d88a0e07141622a4fdf091628", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/21e6f491a15cac8d88a0e07141622a4fdf091628"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/68d3cfac47c4ccd6d057045ff00d0e2e9e46e800", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjEc47CRBK7hj4Ov3rIwAAk8IIAFd46t5fvyphYU6zRBx7yzx+\nAfVJ9373aHLjyZuTG1aNwesXmQc/Tw0ASOKBdwMyWPNtROeFWPpcPQmeLHPaqDNb\nlcuU/wRprX8QNQykyP4bzIVSafN0Vg44Ubu0F+oTpZk584MYO1VB/5+PelRsN7Dl\nhcJqq61wjEGVzV+UhRqagY+nl5HIEpIkc8aioSgodlV7GmL9YfN3sx/aAZDrpQjh\nLtTZeT4eiF9cIHbRQM83BypxCOXuK0KI0VtBPOS0+VUITHJYffGTl33LRl7CDW12\ne5HM/WI7m95shQYIZDcPwME08IelsVK/+kQeOnGO1vy7B0F0ZC3+XTyhQXpmvVE=\n=KSf6\n-----END PGP SIGNATURE-----\n", "payload": "tree 21e6f491a15cac8d88a0e07141622a4fdf091628\nparent 203526e576935c75b5ca23a490ea53cee361079c\nparent f5857d5c5e1d2fde302f330d11c5cdea8005eb2a\nauthor Guillaume Gomez <guillaume1.gomez@gmail.com> 1662111291 +0200\ncommitter GitHub <noreply@github.com> 1662111291 +0200\n\nRollup merge of #101166 - GuillaumeGomez:error-index-mdbook, r=notriddle\n\nGenerate error index with mdbook instead of raw HTML pages\n\nThis is a follow-up of https://github.com/rust-lang/rust/pull/100922.\n\nThis comes from a remark from ````@estebank```` who said that the search was a nice thing on the previous version and that it wasn't possible anymore. An easy way to come around this limitation was to use `mdbook`, which is what I did here.\n\nNow some explanations on the code. I'll explain how I developed this and why I reached this solution. First I did it very basically by simply setting the source directory and the output directory, generated a `SUMMARY.md` manually which listed all error codes and that was it. Two problems arose from this:\n 1. A lot of new HTML files were generated at the top level\n 2. An `index.html` file was generated at the top-level (the summary in short).\n\nSo for `1.`, it's not great to have too many files at the top-level as it could create file conflicts more easily. And for `2.`, this is actually a huge issue because <doc.rust-lang.org> generates an `index.html` file with a links to a few different resources, so it should never be overwritten. <s>Unfortunately, `mdbook` **always** generates an `index.html` file so the only solution I could see (except for sending them a contribution, I'll maybe do that later) was to temporaly move a potentially existing `index.html` file and then puts it back once done. For this last part, to ensure that we don't return *before* it has been put back, I wrapped the `mdbook` generation code inside `render_html_inner` which is called from `render_html` which in turn handle the \"save\" of `index.html`.</s>\n\nEDIT: `mdbook` completely deletes ALL the content in the target directory so I instead generate into a sub directory and then I move the files to the real target directory.\n\nTo keep compatibility with the old version, I also put the `<script>` ````@notriddle```` nicely provided in the previous PR only into the `error-index.html` file to prevent unneeded repetition. I didn't use `mdbook` `additional-js` option because the JS is included at the end of all HTML files, which we don't want for two reasons:\n 1. It's slow.\n 2. We only want it to be run in `error-index.html` (even if we also ensure in the JS itself too!).\n\n<s>Now the last part: why we generate the summary twice. We actually generate it once to tell `mdbook` what the book will look like and a second time because a create a new chapter content which will actually list all the error codes (with the updated paths).</s>\n\nEDIT: I removed the need for two summaries.\n\nYou can test it [here](https://rustdoc.crud.net/imperio/error-index-mdbook/error-index.html).\n\nr? ````@notriddle````\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/68d3cfac47c4ccd6d057045ff00d0e2e9e46e800", "html_url": "https://github.com/rust-lang/rust/commit/68d3cfac47c4ccd6d057045ff00d0e2e9e46e800", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/68d3cfac47c4ccd6d057045ff00d0e2e9e46e800/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "203526e576935c75b5ca23a490ea53cee361079c", "url": "https://api.github.com/repos/rust-lang/rust/commits/203526e576935c75b5ca23a490ea53cee361079c", "html_url": "https://github.com/rust-lang/rust/commit/203526e576935c75b5ca23a490ea53cee361079c"}, {"sha": "f5857d5c5e1d2fde302f330d11c5cdea8005eb2a", "url": "https://api.github.com/repos/rust-lang/rust/commits/f5857d5c5e1d2fde302f330d11c5cdea8005eb2a", "html_url": "https://github.com/rust-lang/rust/commit/f5857d5c5e1d2fde302f330d11c5cdea8005eb2a"}], "stats": {"total": 338, "additions": 196, "deletions": 142}, "files": [{"sha": "97a64feca1b7b84101854163ca7b2a0996c3953f", "filename": "Cargo.lock", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/68d3cfac47c4ccd6d057045ff00d0e2e9e46e800/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/68d3cfac47c4ccd6d057045ff00d0e2e9e46e800/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=68d3cfac47c4ccd6d057045ff00d0e2e9e46e800", "patch": "@@ -1259,7 +1259,7 @@ dependencies = [\n name = \"error_index_generator\"\n version = \"0.0.0\"\n dependencies = [\n- \"rustdoc\",\n+ \"mdbook\",\n ]\n \n [[package]]"}, {"sha": "f909ecc0ab858404403aaa3edb7df83d6043df97", "filename": "src/bootstrap/doc.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/68d3cfac47c4ccd6d057045ff00d0e2e9e46e800/src%2Fbootstrap%2Fdoc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/68d3cfac47c4ccd6d057045ff00d0e2e9e46e800/src%2Fbootstrap%2Fdoc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fdoc.rs?ref=68d3cfac47c4ccd6d057045ff00d0e2e9e46e800", "patch": "@@ -793,7 +793,7 @@ impl Step for ErrorIndex {\n         t!(fs::create_dir_all(&out));\n         let mut index = tool::ErrorIndex::command(builder);\n         index.arg(\"html\");\n-        index.arg(out.join(\"error-index.html\"));\n+        index.arg(out);\n         index.arg(&builder.version);\n \n         builder.run(&mut index);"}, {"sha": "f4dac6e947e323e37c7c1996fb982061159d7c39", "filename": "src/tools/error_index_generator/Cargo.toml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/68d3cfac47c4ccd6d057045ff00d0e2e9e46e800/src%2Ftools%2Ferror_index_generator%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/68d3cfac47c4ccd6d057045ff00d0e2e9e46e800/src%2Ftools%2Ferror_index_generator%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ferror_index_generator%2FCargo.toml?ref=68d3cfac47c4ccd6d057045ff00d0e2e9e46e800", "patch": "@@ -4,7 +4,7 @@ version = \"0.0.0\"\n edition = \"2021\"\n \n [dependencies]\n-rustdoc = { path = \"../../librustdoc\" }\n+mdbook = { version = \"0.4\", default-features = false, features = [\"search\"] }\n \n [[bin]]\n name = \"error_index_generator\""}, {"sha": "885100ae3a4490fe63075580c60b29118ee310d3", "filename": "src/tools/error_index_generator/book_config.toml", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/68d3cfac47c4ccd6d057045ff00d0e2e9e46e800/src%2Ftools%2Ferror_index_generator%2Fbook_config.toml", "raw_url": "https://github.com/rust-lang/rust/raw/68d3cfac47c4ccd6d057045ff00d0e2e9e46e800/src%2Ftools%2Ferror_index_generator%2Fbook_config.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ferror_index_generator%2Fbook_config.toml?ref=68d3cfac47c4ccd6d057045ff00d0e2e9e46e800", "patch": "@@ -0,0 +1,19 @@\n+[book]\n+title = \"Error codes index\"\n+description = \"Book listing all Rust error codes\"\n+src = \"\"\n+\n+[output.html]\n+git-repository-url = \"https://github.com/rust-lang/rust/\"\n+additional-css = [\"error-index.css\"]\n+additional-js = [\"error-index.js\"]\n+\n+[output.html.search]\n+enable = true\n+limit-results = 20\n+use-boolean-and = true\n+boost-title = 2\n+boost-hierarchy = 2\n+boost-paragraph = 1\n+expand = true\n+heading-split-level = 0"}, {"sha": "8975af82de03b354b5148ecd94796adfd2ed75b6", "filename": "src/tools/error_index_generator/error-index.css", "status": "added", "additions": 38, "deletions": 0, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/68d3cfac47c4ccd6d057045ff00d0e2e9e46e800/src%2Ftools%2Ferror_index_generator%2Ferror-index.css", "raw_url": "https://github.com/rust-lang/rust/raw/68d3cfac47c4ccd6d057045ff00d0e2e9e46e800/src%2Ftools%2Ferror_index_generator%2Ferror-index.css", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ferror_index_generator%2Ferror-index.css?ref=68d3cfac47c4ccd6d057045ff00d0e2e9e46e800", "patch": "@@ -0,0 +1,38 @@\n+code.compile_fail {\n+\tborder-left: 2px solid red;\n+}\n+\n+pre .tooltip {\n+\tposition: absolute;\n+\tleft: -25px;\n+\ttop: 0;\n+\tz-index: 1;\n+\tcolor: red;\n+\tcursor: pointer;\n+}\n+pre .tooltip::after {\n+\tdisplay: none;\n+\tcontent: \"This example deliberately fails to compile\";\n+\tbackground-color: #000;\n+\tcolor: #fff;\n+\tborder-color: #000;\n+\ttext-align: center;\n+\tpadding: 5px 3px 3px 3px;\n+\tborder-radius: 6px;\n+\tmargin-left: 5px;\n+}\n+pre .tooltip::before {\n+\tdisplay: none;\n+\tborder-color: transparent black transparent transparent;\n+\tcontent: \" \";\n+\tposition: absolute;\n+\ttop: 50%;\n+\tleft: 16px;\n+\tmargin-top: -5px;\n+\tborder-width: 5px;\n+\tborder-style: solid;\n+}\n+\n+pre .tooltip:hover::before, pre .tooltip:hover::after {\n+\tdisplay: inline;\n+}"}, {"sha": "39b371be04b95cb72884bfb35f96a4c96296efee", "filename": "src/tools/error_index_generator/error-index.js", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/68d3cfac47c4ccd6d057045ff00d0e2e9e46e800/src%2Ftools%2Ferror_index_generator%2Ferror-index.js", "raw_url": "https://github.com/rust-lang/rust/raw/68d3cfac47c4ccd6d057045ff00d0e2e9e46e800/src%2Ftools%2Ferror_index_generator%2Ferror-index.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ferror_index_generator%2Ferror-index.js?ref=68d3cfac47c4ccd6d057045ff00d0e2e9e46e800", "patch": "@@ -0,0 +1,9 @@\n+for (const elem of document.querySelectorAll(\"pre.playground\")) {\n+    if (elem.querySelector(\".compile_fail\") === null) {\n+        continue;\n+    }\n+    const child = document.createElement(\"div\");\n+    child.className = \"tooltip\";\n+    child.textContent = \"\u24d8\";\n+    elem.appendChild(child);\n+}"}, {"sha": "1bde8e007826dffca053aa69474ecba3530ea68a", "filename": "src/tools/error_index_generator/main.rs", "status": "modified", "additions": 111, "deletions": 139, "changes": 250, "blob_url": "https://github.com/rust-lang/rust/blob/68d3cfac47c4ccd6d057045ff00d0e2e9e46e800/src%2Ftools%2Ferror_index_generator%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/68d3cfac47c4ccd6d057045ff00d0e2e9e46e800/src%2Ftools%2Ferror_index_generator%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ferror_index_generator%2Fmain.rs?ref=68d3cfac47c4ccd6d057045ff00d0e2e9e46e800", "patch": "@@ -1,20 +1,21 @@\n #![feature(rustc_private)]\n \n extern crate rustc_driver;\n-extern crate rustc_span;\n \n+// We use the function we generate from `register_diagnostics!`.\n use crate::error_codes::error_codes;\n \n use std::env;\n use std::error::Error;\n-use std::fs::{create_dir_all, File};\n+use std::fs::{self, File};\n use std::io::Write;\n use std::path::Path;\n use std::path::PathBuf;\n \n-use rustc_span::edition::DEFAULT_EDITION;\n+use std::str::FromStr;\n \n-use rustdoc::html::markdown::{ErrorCodes, HeadingOffset, IdMap, Markdown, Playground};\n+use mdbook::book::{parse_summary, BookItem, Chapter};\n+use mdbook::{Config, MDBook};\n \n macro_rules! register_diagnostics {\n     ($($error_code:ident: $message:expr,)+ ; $($undocumented:ident,)* ) => {\n@@ -33,104 +34,21 @@ macro_rules! register_diagnostics {\n mod error_codes;\n \n enum OutputFormat {\n-    HTML(HTMLFormatter),\n+    HTML,\n     Markdown,\n     Unknown(String),\n }\n \n impl OutputFormat {\n-    fn from(format: &str, resource_suffix: &str) -> OutputFormat {\n+    fn from(format: &str) -> OutputFormat {\n         match &*format.to_lowercase() {\n-            \"html\" => OutputFormat::HTML(HTMLFormatter(resource_suffix.to_owned())),\n+            \"html\" => OutputFormat::HTML,\n             \"markdown\" => OutputFormat::Markdown,\n             s => OutputFormat::Unknown(s.to_owned()),\n         }\n     }\n }\n \n-struct HTMLFormatter(String);\n-\n-impl HTMLFormatter {\n-    fn create_error_code_file(\n-        &self,\n-        err_code: &str,\n-        explanation: &str,\n-        parent_dir: &Path,\n-    ) -> Result<(), Box<dyn Error>> {\n-        let mut output_file = File::create(parent_dir.join(err_code).with_extension(\"html\"))?;\n-\n-        self.header(&mut output_file, \"../\", \"\")?;\n-        self.title(&mut output_file, &format!(\"Error code {}\", err_code))?;\n-\n-        let mut id_map = IdMap::new();\n-        let playground =\n-            Playground { crate_name: None, url: String::from(\"https://play.rust-lang.org/\") };\n-        write!(\n-            output_file,\n-            \"{}\",\n-            Markdown {\n-                content: explanation,\n-                links: &[],\n-                ids: &mut id_map,\n-                error_codes: ErrorCodes::Yes,\n-                edition: DEFAULT_EDITION,\n-                playground: &Some(playground),\n-                heading_offset: HeadingOffset::H1,\n-            }\n-            .into_string()\n-        )?;\n-        write!(\n-            output_file,\n-            \"<p>\\\n-                <a style='text-align: center;display: block;width: 100%;' \\\n-                   href='../error-index.html'>Back to list of error codes</a>\\\n-             </p>\",\n-        )?;\n-\n-        self.footer(&mut output_file)\n-    }\n-\n-    fn header(\n-        &self,\n-        output: &mut dyn Write,\n-        extra_path: &str,\n-        extra: &str,\n-    ) -> Result<(), Box<dyn Error>> {\n-        write!(\n-            output,\n-            r##\"<!DOCTYPE html>\n-<html>\n-<head>\n-<title>Rust Compiler Error Index</title>\n-<meta charset=\"utf-8\">\n-<!-- Include rust.css after light.css so its rules take priority. -->\n-<link rel=\"stylesheet\" type=\"text/css\" href=\"{extra_path}rustdoc{suffix}.css\"/>\n-<link rel=\"stylesheet\" type=\"text/css\" href=\"{extra_path}light{suffix}.css\"/>\n-<link rel=\"stylesheet\" type=\"text/css\" href=\"{extra_path}rust.css\"/>\n-<style>\n-.error-undescribed {{\n-    display: none;\n-}}\n-</style>{extra}\n-</head>\n-<body>\n-\"##,\n-            suffix = self.0,\n-        )?;\n-        Ok(())\n-    }\n-\n-    fn title(&self, output: &mut dyn Write, title: &str) -> Result<(), Box<dyn Error>> {\n-        write!(output, \"<h1>{}</h1>\\n\", title)?;\n-        Ok(())\n-    }\n-\n-    fn footer(&self, output: &mut dyn Write) -> Result<(), Box<dyn Error>> {\n-        write!(output, \"</body></html>\")?;\n-        Ok(())\n-    }\n-}\n-\n /// Output an HTML page for the errors in `err_map` to `output_path`.\n fn render_markdown(output_path: &Path) -> Result<(), Box<dyn Error>> {\n     let mut output_file = File::create(output_path)?;\n@@ -147,61 +65,119 @@ fn render_markdown(output_path: &Path) -> Result<(), Box<dyn Error>> {\n     Ok(())\n }\n \n-fn render_html(output_path: &Path, formatter: HTMLFormatter) -> Result<(), Box<dyn Error>> {\n-    let mut output_file = File::create(output_path)?;\n+// By default, mdbook doesn't consider code blocks as Rust ones contrary to rustdoc so we have\n+// to manually add `rust` attribute whenever needed.\n+fn add_rust_attribute_on_codeblock(explanation: &str) -> String {\n+    // Very hacky way to add the rust attribute on all code blocks.\n+    let mut skip = true;\n+    explanation.split(\"\\n```\").fold(String::new(), |mut acc, part| {\n+        if !acc.is_empty() {\n+            acc.push_str(\"\\n```\");\n+        }\n+        if !skip {\n+            if let Some(attrs) = part.split('\\n').next() {\n+                if !attrs.contains(\"rust\")\n+                    && (attrs.is_empty()\n+                        || attrs.contains(\"compile_fail\")\n+                        || attrs.contains(\"ignore\")\n+                        || attrs.contains(\"edition\"))\n+                {\n+                    if !attrs.is_empty() {\n+                        acc.push_str(\"rust,\");\n+                    } else {\n+                        acc.push_str(\"rust\");\n+                    }\n+                }\n+            }\n+        }\n+        skip = !skip;\n+        acc.push_str(part);\n+        acc\n+    })\n+}\n \n-    let error_codes_dir = \"error_codes\";\n+fn render_html(output_path: &Path) -> Result<(), Box<dyn Error>> {\n+    let mut introduction = format!(\n+        \"<script src='redirect.js'></script>\n+# Rust error codes index\n \n-    let parent = output_path.parent().expect(\"There should have a parent\").join(error_codes_dir);\n+This page lists all the error codes emitted by the Rust compiler.\n \n-    if !parent.exists() {\n-        create_dir_all(&parent)?;\n-    }\n+\"\n+    );\n \n-    formatter.header(\n-        &mut output_file,\n-        \"\",\n-        &format!(\n-            r#\"<script>(function() {{\n-    if (window.location.hash) {{\n-        let code = window.location.hash.replace(/^#/, '');\n-        // We have to make sure this pattern matches to avoid inadvertently creating an\n-        // open redirect.\n-        if (/^E[0-9]+$/.test(code)) {{\n-            window.location = './{error_codes_dir}/' + code + '.html';\n-        }}\n-    }}\n-}})()</script>\"#\n-        ),\n-    )?;\n-    formatter.title(&mut output_file, \"Rust Compiler Error Index\")?;\n+    let err_codes = error_codes();\n+    let mut chapters = Vec::with_capacity(err_codes.len());\n \n-    write!(\n-        output_file,\n-        \"<p>This page lists all the error codes emitted by the Rust compiler. If you want a full \\\n-            explanation on an error code, click on it.</p>\\\n-         <ul>\",\n-    )?;\n-    for (err_code, explanation) in error_codes().iter() {\n+    for (err_code, explanation) in err_codes.iter() {\n         if let Some(explanation) = explanation {\n-            write!(\n-                output_file,\n-                \"<li><a href='./{0}/{1}.html'>{1}</a></li>\",\n-                error_codes_dir, err_code\n-            )?;\n-            formatter.create_error_code_file(err_code, explanation, &parent)?;\n+            introduction.push_str(&format!(\" * [{0}](./{0}.html)\\n\", err_code));\n+\n+            let content = add_rust_attribute_on_codeblock(explanation);\n+            chapters.push(BookItem::Chapter(Chapter {\n+                name: err_code.to_string(),\n+                content: format!(\"# Error code {}\\n\\n{}\\n\", err_code, content),\n+                number: None,\n+                sub_items: Vec::new(),\n+                // We generate it into the `error_codes` folder.\n+                path: Some(PathBuf::from(&format!(\"{}.html\", err_code))),\n+                source_path: None,\n+                parent_names: Vec::new(),\n+            }));\n         } else {\n-            write!(output_file, \"<li>{}</li>\", err_code)?;\n+            introduction.push_str(&format!(\" * {}\\n\", err_code));\n         }\n     }\n-    write!(output_file, \"</ul>\")?;\n-    formatter.footer(&mut output_file)\n+\n+    let mut config = Config::from_str(include_str!(\"book_config.toml\"))?;\n+    config.build.build_dir = output_path.join(\"error_codes\").to_path_buf();\n+    let mut book = MDBook::load_with_config_and_summary(\n+        env!(\"CARGO_MANIFEST_DIR\"),\n+        config,\n+        parse_summary(\"\")?,\n+    )?;\n+    let chapter = Chapter {\n+        name: \"Rust error codes index\".to_owned(),\n+        content: introduction,\n+        number: None,\n+        sub_items: chapters,\n+        // Very important: this file is named as `error-index.html` and not `index.html`!\n+        path: Some(PathBuf::from(\"error-index.html\")),\n+        source_path: None,\n+        parent_names: Vec::new(),\n+    };\n+    book.book.sections.push(BookItem::Chapter(chapter));\n+    book.build()?;\n+\n+    // We can't put this content into another file, otherwise `mbdbook` will also put it into the\n+    // output directory, making a duplicate.\n+    fs::write(\n+        output_path.join(\"error-index.html\"),\n+        r#\"<!DOCTYPE html>\n+<html>\n+    <head>\n+        <title>Rust error codes index - Error codes index</title>\n+        <meta content=\"text/html; charset=utf-8\" http-equiv=\"Content-Type\">\n+        <meta name=\"description\" content=\"Book listing all Rust error codes\">\n+        <script src=\"error_codes/redirect.js\"></script>\n+    </head>\n+    <body>\n+        <div>If you are not automatically redirected to the error code index, please <a id=\"index-link\" href=\"./error_codes/error-index.html\">here</a>.\n+        <script>document.getElementById(\"index-link\").click()</script>\n+    </body>\n+</html>\"#,\n+    )?;\n+\n+    // No need for a 404 file, it's already handled by the server.\n+    fs::remove_file(output_path.join(\"error_codes/404.html\"))?;\n+\n+    Ok(())\n }\n \n fn main_with_result(format: OutputFormat, dst: &Path) -> Result<(), Box<dyn Error>> {\n     match format {\n         OutputFormat::Unknown(s) => panic!(\"Unknown output format: {}\", s),\n-        OutputFormat::HTML(h) => render_html(dst, h),\n+        OutputFormat::HTML => render_html(dst),\n         OutputFormat::Markdown => render_markdown(dst),\n     }\n }\n@@ -210,12 +186,9 @@ fn parse_args() -> (OutputFormat, PathBuf) {\n     let mut args = env::args().skip(1);\n     let format = args.next();\n     let dst = args.next();\n-    let resource_suffix = args.next().unwrap_or_else(String::new);\n-    let format = format\n-        .map(|a| OutputFormat::from(&a, &resource_suffix))\n-        .unwrap_or(OutputFormat::from(\"html\", &resource_suffix));\n+    let format = format.map(|a| OutputFormat::from(&a)).unwrap_or(OutputFormat::from(\"html\"));\n     let dst = dst.map(PathBuf::from).unwrap_or_else(|| match format {\n-        OutputFormat::HTML(..) => PathBuf::from(\"doc/error-index.html\"),\n+        OutputFormat::HTML => PathBuf::from(\"doc\"),\n         OutputFormat::Markdown => PathBuf::from(\"doc/error-index.md\"),\n         OutputFormat::Unknown(..) => PathBuf::from(\"<nul>\"),\n     });\n@@ -225,9 +198,8 @@ fn parse_args() -> (OutputFormat, PathBuf) {\n fn main() {\n     rustc_driver::init_env_logger(\"RUST_LOG\");\n     let (format, dst) = parse_args();\n-    let result =\n-        rustc_span::create_default_session_globals_then(move || main_with_result(format, &dst));\n+    let result = main_with_result(format, &dst);\n     if let Err(e) = result {\n-        panic!(\"{}\", e.to_string());\n+        panic!(\"{:?}\", e);\n     }\n }"}, {"sha": "8c907f5795d324be867a792e25aeac775ebd3b88", "filename": "src/tools/error_index_generator/redirect.js", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/68d3cfac47c4ccd6d057045ff00d0e2e9e46e800/src%2Ftools%2Ferror_index_generator%2Fredirect.js", "raw_url": "https://github.com/rust-lang/rust/raw/68d3cfac47c4ccd6d057045ff00d0e2e9e46e800/src%2Ftools%2Ferror_index_generator%2Fredirect.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ferror_index_generator%2Fredirect.js?ref=68d3cfac47c4ccd6d057045ff00d0e2e9e46e800", "patch": "@@ -0,0 +1,16 @@\n+(function() {\n+    if (window.location.hash) {\n+        let code = window.location.hash.replace(/^#/, '');\n+        // We have to make sure this pattern matches to avoid inadvertently creating an\n+        // open redirect.\n+        if (!/^E[0-9]+$/.test(code)) {\n+            return;\n+        }\n+        if (window.location.pathname.indexOf(\"/error_codes/\") !== -1) {\n+            // We're not at the top level, so we don't prepend with \"./error_codes/\".\n+            window.location = './' + code + '.html';\n+        } else {\n+            window.location = './error_codes/' + code + '.html';\n+        }\n+    }\n+})()"}]}