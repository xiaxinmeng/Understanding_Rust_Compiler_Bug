{"sha": "4808561c45df77b6a7f8721f22b2f1e324cbeb3d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQ4MDg1NjFjNDVkZjc3YjZhN2Y4NzIxZjIyYjJmMWUzMjRjYmViM2Q=", "commit": {"author": {"name": "Bj\u00f6rn Steinbrink", "email": "bsteinbr@gmail.com", "date": "2015-02-15T22:23:19Z"}, "committer": {"name": "Bj\u00f6rn Steinbrink", "email": "bsteinbr@gmail.com", "date": "2015-02-15T23:50:02Z"}, "message": "Fix misoptimizations when matching against strings/slices\n\nWhen matching against strings/slices, we call the comparison function\nfor strings, which takes two string slices by value. The slices are\npassed in memory, and currently we just pass in a pointer to the\noriginal slice. That can cause misoptimizations because we emit a call\nto llvm.lifetime.end for all by-value arguments at the end of a\nfunction, which in this case marks the original slice as dead.\n\nSo we need to properly create copies of the slices to pass them to the\ncomparison function.\n\nFixes #22008", "tree": {"sha": "adbd0ce91c44ee24e63ff29c2e1fab45b99668a8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/adbd0ce91c44ee24e63ff29c2e1fab45b99668a8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4808561c45df77b6a7f8721f22b2f1e324cbeb3d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4808561c45df77b6a7f8721f22b2f1e324cbeb3d", "html_url": "https://github.com/rust-lang/rust/commit/4808561c45df77b6a7f8721f22b2f1e324cbeb3d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4808561c45df77b6a7f8721f22b2f1e324cbeb3d/comments", "author": {"login": "dotdash", "id": 230962, "node_id": "MDQ6VXNlcjIzMDk2Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dotdash", "html_url": "https://github.com/dotdash", "followers_url": "https://api.github.com/users/dotdash/followers", "following_url": "https://api.github.com/users/dotdash/following{/other_user}", "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}", "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions", "organizations_url": "https://api.github.com/users/dotdash/orgs", "repos_url": "https://api.github.com/users/dotdash/repos", "events_url": "https://api.github.com/users/dotdash/events{/privacy}", "received_events_url": "https://api.github.com/users/dotdash/received_events", "type": "User", "site_admin": false}, "committer": {"login": "dotdash", "id": 230962, "node_id": "MDQ6VXNlcjIzMDk2Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dotdash", "html_url": "https://github.com/dotdash", "followers_url": "https://api.github.com/users/dotdash/followers", "following_url": "https://api.github.com/users/dotdash/following{/other_user}", "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}", "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions", "organizations_url": "https://api.github.com/users/dotdash/orgs", "repos_url": "https://api.github.com/users/dotdash/repos", "events_url": "https://api.github.com/users/dotdash/events{/privacy}", "received_events_url": "https://api.github.com/users/dotdash/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "342ab53bf858a89e418973ba3bfff55161c0b174", "url": "https://api.github.com/repos/rust-lang/rust/commits/342ab53bf858a89e418973ba3bfff55161c0b174", "html_url": "https://github.com/rust-lang/rust/commit/342ab53bf858a89e418973ba3bfff55161c0b174"}], "stats": {"total": 32, "additions": 31, "deletions": 1}, "files": [{"sha": "13b37141f40a7f17b0dcd2c265be2d8bb84408d3", "filename": "src/librustc_trans/trans/_match.rs", "status": "modified", "additions": 13, "deletions": 1, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/4808561c45df77b6a7f8721f22b2f1e324cbeb3d/src%2Flibrustc_trans%2Ftrans%2F_match.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4808561c45df77b6a7f8721f22b2f1e324cbeb3d/src%2Flibrustc_trans%2Ftrans%2F_match.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Ftrans%2F_match.rs?ref=4808561c45df77b6a7f8721f22b2f1e324cbeb3d", "patch": "@@ -828,7 +828,19 @@ fn compare_values<'blk, 'tcx>(cx: Block<'blk, 'tcx>,\n                            &format!(\"comparison of `{}`\",\n                                    cx.ty_to_string(rhs_t))[],\n                            StrEqFnLangItem);\n-        callee::trans_lang_call(cx, did, &[lhs, rhs], None, debug_loc)\n+        let t = ty::mk_str_slice(cx.tcx(), cx.tcx().mk_region(ty::ReStatic), ast::MutImmutable);\n+        // The comparison function gets the slices by value, so we have to make copies here. Even\n+        // if the function doesn't write through the pointer, things like lifetime intrinsics\n+        // require that we do this properly\n+        let lhs_arg = alloc_ty(cx, t, \"lhs\");\n+        let rhs_arg = alloc_ty(cx, t, \"rhs\");\n+        memcpy_ty(cx, lhs_arg, lhs, t);\n+        memcpy_ty(cx, rhs_arg, rhs, t);\n+        let res = callee::trans_lang_call(cx, did, &[lhs_arg, rhs_arg], None, debug_loc);\n+        call_lifetime_end(res.bcx, lhs_arg);\n+        call_lifetime_end(res.bcx, rhs_arg);\n+\n+        res\n     }\n \n     let _icx = push_ctxt(\"compare_values\");"}, {"sha": "3e145122e5aeb12a4acf5e84c0504c4af4d56967", "filename": "src/test/run-pass/issue22008.rs", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/4808561c45df77b6a7f8721f22b2f1e324cbeb3d/src%2Ftest%2Frun-pass%2Fissue22008.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4808561c45df77b6a7f8721f22b2f1e324cbeb3d/src%2Ftest%2Frun-pass%2Fissue22008.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fissue22008.rs?ref=4808561c45df77b6a7f8721f22b2f1e324cbeb3d", "patch": "@@ -0,0 +1,18 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+pub fn main() {\n+    let command = \"a\";\n+\n+    match command {\n+        \"foo\" => println!(\"foo\"),\n+        _     => println!(\"{}\", command),\n+    }\n+}"}]}