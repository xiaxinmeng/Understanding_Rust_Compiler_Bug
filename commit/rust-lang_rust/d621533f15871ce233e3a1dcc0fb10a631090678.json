{"sha": "d621533f15871ce233e3a1dcc0fb10a631090678", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ2MjE1MzNmMTU4NzFjZTIzM2UzYTFkY2MwZmIxMGE2MzEwOTA2Nzg=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-06-26T08:11:28Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-06-26T08:11:28Z"}, "message": "add cpuprofile to ra_prof\n\nNow, one can use `let _p = ra_prof::cpu_profiler()` to capture profile\nof a block of code.\n\nThis is not an out of the box experience, as that relies on gperfools\n\nSee the docs on https://github.com/AtheMathmo/cpuprofiler for more!", "tree": {"sha": "53bfceb17b0d730490e8f489c0c0611433de46e5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/53bfceb17b0d730490e8f489c0c0611433de46e5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d621533f15871ce233e3a1dcc0fb10a631090678", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d621533f15871ce233e3a1dcc0fb10a631090678", "html_url": "https://github.com/rust-lang/rust/commit/d621533f15871ce233e3a1dcc0fb10a631090678", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d621533f15871ce233e3a1dcc0fb10a631090678/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0129790a8f84a0858abcb1448e1052caa01fc41c", "url": "https://api.github.com/repos/rust-lang/rust/commits/0129790a8f84a0858abcb1448e1052caa01fc41c", "html_url": "https://github.com/rust-lang/rust/commit/0129790a8f84a0858abcb1448e1052caa01fc41c"}], "stats": {"total": 90, "additions": 90, "deletions": 0}, "files": [{"sha": "4f3538a51d16790e7bcdf3476f90e60b992168c0", "filename": "Cargo.lock", "status": "modified", "additions": 52, "deletions": 0, "changes": 52, "blob_url": "https://github.com/rust-lang/rust/blob/d621533f15871ce233e3a1dcc0fb10a631090678/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/d621533f15871ce233e3a1dcc0fb10a631090678/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=d621533f15871ce233e3a1dcc0fb10a631090678", "patch": "@@ -39,6 +39,20 @@ name = \"autocfg\"\n version = \"0.1.4\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n \n+[[package]]\n+name = \"backtrace\"\n+version = \"0.2.3\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+dependencies = [\n+ \"backtrace-sys 0.1.28 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"cfg-if 0.1.9 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"dbghelp-sys 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"kernel32-sys 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"libc 0.2.58 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"rustc-demangle 0.1.15 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"winapi 0.2.8 (registry+https://github.com/rust-lang/crates.io-index)\",\n+]\n+\n [[package]]\n name = \"backtrace\"\n version = \"0.3.30\"\n@@ -263,6 +277,15 @@ dependencies = [\n  \"winapi 0.3.7 (registry+https://github.com/rust-lang/crates.io-index)\",\n ]\n \n+[[package]]\n+name = \"cpuprofiler\"\n+version = \"0.0.3\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+dependencies = [\n+ \"error-chain 0.5.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"lazy_static 0.2.11 (registry+https://github.com/rust-lang/crates.io-index)\",\n+]\n+\n [[package]]\n name = \"crossbeam-channel\"\n version = \"0.3.8\"\n@@ -311,6 +334,15 @@ dependencies = [\n  \"lazy_static 1.3.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n ]\n \n+[[package]]\n+name = \"dbghelp-sys\"\n+version = \"0.2.0\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+dependencies = [\n+ \"winapi 0.2.8 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"winapi-build 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)\",\n+]\n+\n [[package]]\n name = \"derive-new\"\n version = \"0.5.6\"\n@@ -375,6 +407,14 @@ name = \"encode_unicode\"\n version = \"0.3.5\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n \n+[[package]]\n+name = \"error-chain\"\n+version = \"0.5.0\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+dependencies = [\n+ \"backtrace 0.2.3 (registry+https://github.com/rust-lang/crates.io-index)\",\n+]\n+\n [[package]]\n name = \"error-chain\"\n version = \"0.12.1\"\n@@ -670,6 +710,11 @@ name = \"lalrpop-intern\"\n version = \"0.15.1\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n \n+[[package]]\n+name = \"lazy_static\"\n+version = \"0.2.11\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+\n [[package]]\n name = \"lazy_static\"\n version = \"1.3.0\"\n@@ -1024,6 +1069,7 @@ dependencies = [\n  \"ra_db 0.1.0\",\n  \"ra_hir 0.1.0\",\n  \"ra_ide_api 0.1.0\",\n+ \"ra_prof 0.1.0\",\n  \"ra_project_model 0.1.0\",\n  \"ra_syntax 0.1.0\",\n  \"ra_vfs 0.2.5 (registry+https://github.com/rust-lang/crates.io-index)\",\n@@ -1176,6 +1222,7 @@ name = \"ra_prof\"\n version = \"0.1.0\"\n dependencies = [\n  \"backtrace 0.3.30 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"cpuprofiler 0.0.3 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"itertools 0.8.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"once_cell 0.2.1 (registry+https://github.com/rust-lang/crates.io-index)\",\n ]\n@@ -1987,6 +2034,7 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n \"checksum arrayvec 0.4.10 (registry+https://github.com/rust-lang/crates.io-index)\" = \"92c7fb76bc8826a8b33b4ee5bb07a247a81e76764ab4d55e8f73e3a4d8808c71\"\n \"checksum atty 0.2.11 (registry+https://github.com/rust-lang/crates.io-index)\" = \"9a7d5b8723950951411ee34d271d99dddcc2035a16ab25310ea2c8cfd4369652\"\n \"checksum autocfg 0.1.4 (registry+https://github.com/rust-lang/crates.io-index)\" = \"0e49efa51329a5fd37e7c79db4621af617cd4e3e5bc224939808d076077077bf\"\n+\"checksum backtrace 0.2.3 (registry+https://github.com/rust-lang/crates.io-index)\" = \"346d7644f0b5f9bc73082d3b2236b69a05fd35cce0cfa3724e184e6a5c9e2a2f\"\n \"checksum backtrace 0.3.30 (registry+https://github.com/rust-lang/crates.io-index)\" = \"ada4c783bb7e7443c14e0480f429ae2cc99da95065aeab7ee1b81ada0419404f\"\n \"checksum backtrace-sys 0.1.28 (registry+https://github.com/rust-lang/crates.io-index)\" = \"797c830ac25ccc92a7f8a7b9862bde440715531514594a6154e3d4a54dd769b6\"\n \"checksum base64 0.10.1 (registry+https://github.com/rust-lang/crates.io-index)\" = \"0b25d992356d2eb0ed82172f5248873db5560c4721f564b13cb5193bda5e668e\"\n@@ -2012,11 +2060,13 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n \"checksum cloudabi 0.0.3 (registry+https://github.com/rust-lang/crates.io-index)\" = \"ddfc5b9aa5d4507acaf872de71051dfd0e309860e88966e1051e462a077aac4f\"\n \"checksum colosseum 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)\" = \"370c83b49aedf022ee27942e8ae1d9de1cf40dc9653ee6550e4455d08f6406f9\"\n \"checksum console 0.7.7 (registry+https://github.com/rust-lang/crates.io-index)\" = \"8ca57c2c14b8a2bf3105bc9d15574aad80babf6a9c44b1058034cdf8bd169628\"\n+\"checksum cpuprofiler 0.0.3 (registry+https://github.com/rust-lang/crates.io-index)\" = \"33f07976bb6821459632d7a18d97ccca005cb5c552f251f822c7c1781c1d7035\"\n \"checksum crossbeam-channel 0.3.8 (registry+https://github.com/rust-lang/crates.io-index)\" = \"0f0ed1a4de2235cabda8558ff5840bffb97fcb64c97827f354a451307df5f72b\"\n \"checksum crossbeam-deque 0.6.3 (registry+https://github.com/rust-lang/crates.io-index)\" = \"05e44b8cf3e1a625844d1750e1f7820da46044ff6d28f4d43e455ba3e5bb2c13\"\n \"checksum crossbeam-epoch 0.7.1 (registry+https://github.com/rust-lang/crates.io-index)\" = \"04c9e3102cc2d69cd681412141b390abd55a362afc1540965dad0ad4d34280b4\"\n \"checksum crossbeam-queue 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)\" = \"7c979cd6cfe72335896575c6b5688da489e420d36a27a0b9eb0c73db574b4a4b\"\n \"checksum crossbeam-utils 0.6.5 (registry+https://github.com/rust-lang/crates.io-index)\" = \"f8306fcef4a7b563b76b7dd949ca48f52bc1141aa067d2ea09565f3e2652aa5c\"\n+\"checksum dbghelp-sys 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"97590ba53bcb8ac28279161ca943a924d1fd4a8fb3fa63302591647c4fc5b850\"\n \"checksum derive-new 0.5.6 (registry+https://github.com/rust-lang/crates.io-index)\" = \"6ca414e896ae072546f4d789f452daaecf60ddee4c9df5dc6d5936d769e3d87c\"\n \"checksum deunicode 0.4.3 (registry+https://github.com/rust-lang/crates.io-index)\" = \"850878694b7933ca4c9569d30a34b55031b9b139ee1fc7b94a527c4ef960d690\"\n \"checksum difference 2.0.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"524cbf6897b527295dff137cec09ecf3a05f4fddffd7dfcd1585403449e74198\"\n@@ -2028,6 +2078,7 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n \"checksum ena 0.13.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"3dc01d68e08ca384955a3aeba9217102ca1aa85b6e168639bf27739f1d749d87\"\n \"checksum encode_unicode 0.3.5 (registry+https://github.com/rust-lang/crates.io-index)\" = \"90b2c9496c001e8cb61827acdefad780795c42264c137744cae6f7d9e3450abd\"\n \"checksum error-chain 0.12.1 (registry+https://github.com/rust-lang/crates.io-index)\" = \"3ab49e9dcb602294bc42f9a7dfc9bc6e936fca4418ea300dbfb84fe16de0b7d9\"\n+\"checksum error-chain 0.5.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"bd5c82c815138e278b8dcdeffc49f27ea6ffb528403e9dea4194f2e3dd40b143\"\n \"checksum failure 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)\" = \"795bd83d3abeb9220f257e597aa0080a508b27533824adf336529648f6abf7e2\"\n \"checksum failure_derive 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)\" = \"ea1063915fd7ef4309e222a5a07cf9c319fb9c7836b1f89b85458672dbb127e1\"\n \"checksum fake-simd 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)\" = \"e88a8acf291dafb59c2d96e8f59828f3838bb1a70398823ade51a84de6a6deed\"\n@@ -2062,6 +2113,7 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n \"checksum join_to_string 0.1.3 (registry+https://github.com/rust-lang/crates.io-index)\" = \"4dc7a5290e8c2606ce2be49f456d50f69173cb96d1541e4f66e34ac8b331a98f\"\n \"checksum kernel32-sys 0.2.2 (registry+https://github.com/rust-lang/crates.io-index)\" = \"7507624b29483431c0ba2d82aece8ca6cdba9382bff4ddd0f7490560c056098d\"\n \"checksum lalrpop-intern 0.15.1 (registry+https://github.com/rust-lang/crates.io-index)\" = \"cc4fd87be4a815fd373e02773983940f0d75fb26fde8c098e9e45f7af03154c0\"\n+\"checksum lazy_static 0.2.11 (registry+https://github.com/rust-lang/crates.io-index)\" = \"76f033c7ad61445c5b347c7382dd1237847eb1bce590fe50365dcb33d546be73\"\n \"checksum lazy_static 1.3.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"bc5729f27f159ddd61f4df6228e827e86643d4d3e7c32183cb30a1c08f604a14\"\n \"checksum lazycell 1.2.1 (registry+https://github.com/rust-lang/crates.io-index)\" = \"b294d6fa9ee409a054354afc4352b0b9ef7ca222c69b8812cbea9e7d2bf3783f\"\n \"checksum libc 0.2.58 (registry+https://github.com/rust-lang/crates.io-index)\" = \"6281b86796ba5e4366000be6e9e18bf35580adf9e63fbe2294aadb587613a319\""}, {"sha": "f521937c5395c68392a404fde71302cbfb099698", "filename": "crates/ra_batch/Cargo.toml", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d621533f15871ce233e3a1dcc0fb10a631090678/crates%2Fra_batch%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/d621533f15871ce233e3a1dcc0fb10a631090678/crates%2Fra_batch%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_batch%2FCargo.toml?ref=d621533f15871ce233e3a1dcc0fb10a631090678", "patch": "@@ -15,5 +15,9 @@ ra_ide_api = { path = \"../ra_ide_api\" }\n ra_hir = { path = \"../ra_hir\" }\n ra_project_model = { path = \"../ra_project_model\" }\n \n+[dependencies.ra_prof]\n+path = \"../ra_prof\"\n+# features = [ \"cpuprofiler\" ]\n+\n [dev-dependencies]\n test_utils = { path = \"../test_utils\" }"}, {"sha": "787e18385983266bba3b9fbebb3a4619e9ad9632", "filename": "crates/ra_prof/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d621533f15871ce233e3a1dcc0fb10a631090678/crates%2Fra_prof%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/d621533f15871ce233e3a1dcc0fb10a631090678/crates%2Fra_prof%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_prof%2FCargo.toml?ref=d621533f15871ce233e3a1dcc0fb10a631090678", "patch": "@@ -9,3 +9,4 @@ publish = false\n once_cell = \"0.2.0\"\n itertools = \"0.8.0\"\n backtrace = \"0.3.28\"\n+cpuprofiler = { version = \"0.0.3\", optional = true }"}, {"sha": "1e8d780ab60c8f1b6dc5d1aa6190edfc0dfcd1f6", "filename": "crates/ra_prof/src/lib.rs", "status": "modified", "additions": 33, "deletions": 0, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/d621533f15871ce233e3a1dcc0fb10a631090678/crates%2Fra_prof%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d621533f15871ce233e3a1dcc0fb10a631090678/crates%2Fra_prof%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_prof%2Fsrc%2Flib.rs?ref=d621533f15871ce233e3a1dcc0fb10a631090678", "patch": "@@ -255,6 +255,39 @@ impl Drop for Scope {\n     }\n }\n \n+/// A wrapper around https://github.com/AtheMathmo/cpuprofiler\n+///\n+/// It can be used to capture sampling profiles of sections of code.\n+/// It is not exactly out-of-the-box, as it relies on gperftools.\n+/// See the docs for the crate for more!\n+#[derive(Debug)]\n+pub struct CpuProfiler {\n+    _private: (),\n+}\n+\n+pub fn cpu_profiler() -> CpuProfiler {\n+    #[cfg(feature = \"cpuprofiler\")]\n+    {\n+        cpuprofiler::PROFILER.lock().unwrap().start(\"./out.profile\").unwrap();\n+    }\n+\n+    #[cfg(not(feature = \"cpuprofiler\"))]\n+    {\n+        eprintln!(\"cpuprofiler feature is disabled\")\n+    }\n+\n+    CpuProfiler { _private: () }\n+}\n+\n+impl Drop for CpuProfiler {\n+    fn drop(&mut self) {\n+        #[cfg(feature = \"cpuprofiler\")]\n+        {\n+            cpuprofiler::PROFILER.lock().unwrap().stop().unwrap();\n+        }\n+    }\n+}\n+\n #[cfg(test)]\n mod tests {\n     use super::*;"}]}