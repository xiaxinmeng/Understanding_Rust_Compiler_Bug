{"sha": "5bbf6733ea3d253740f2b78360c20f05781cfa11", "node_id": "MDY6Q29tbWl0NzI0NzEyOjViYmY2NzMzZWEzZDI1Mzc0MGYyYjc4MzYwYzIwZjA1NzgxY2ZhMTE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-07-31T11:54:00Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-07-31T11:54:00Z"}, "message": "Auto merge of #869 - RalfJung:tests, r=oli-obk\n\ntest suite: be fine with warnings when running on rustc CI\n\nr? @oli-obk", "tree": {"sha": "ba683dc0277df06a1bfca364127cef45ca4a5369", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ba683dc0277df06a1bfca364127cef45ca4a5369"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5bbf6733ea3d253740f2b78360c20f05781cfa11", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5bbf6733ea3d253740f2b78360c20f05781cfa11", "html_url": "https://github.com/rust-lang/rust/commit/5bbf6733ea3d253740f2b78360c20f05781cfa11", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5bbf6733ea3d253740f2b78360c20f05781cfa11/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e276676f0c0fc16f41e46cc56cb7a9362dc717b0", "url": "https://api.github.com/repos/rust-lang/rust/commits/e276676f0c0fc16f41e46cc56cb7a9362dc717b0", "html_url": "https://github.com/rust-lang/rust/commit/e276676f0c0fc16f41e46cc56cb7a9362dc717b0"}, {"sha": "a414492cc736111446a11925aadba5605496624c", "url": "https://api.github.com/repos/rust-lang/rust/commits/a414492cc736111446a11925aadba5605496624c", "html_url": "https://github.com/rust-lang/rust/commit/a414492cc736111446a11925aadba5605496624c"}], "stats": {"total": 11, "additions": 8, "deletions": 3}, "files": [{"sha": "eaf7f8531b8fc293ae8a36126be498997df93f42", "filename": "tests/compiletest.rs", "status": "modified", "additions": 8, "deletions": 3, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/5bbf6733ea3d253740f2b78360c20f05781cfa11/tests%2Fcompiletest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5bbf6733ea3d253740f2b78360c20f05781cfa11/tests%2Fcompiletest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompiletest.rs?ref=5bbf6733ea3d253740f2b78360c20f05781cfa11", "patch": "@@ -25,9 +25,14 @@ fn rustc_lib_path() -> PathBuf {\n }\n \n fn run_tests(mode: &str, path: &str, target: &str, mut flags: Vec<String>) {\n-    // Some flags we always want.\n-    flags.push(\"-Dwarnings -Dunused\".to_owned()); // overwrite the -Aunused in compiletest-rs\n+    let in_rustc_test_suite = rustc_test_suite().is_some();\n+    // Add some flags we always want.\n     flags.push(\"--edition 2018\".to_owned());\n+    if !in_rustc_test_suite {\n+      // Only `-Dwarnings` on the Miri side to make the rustc toolstate management less painful.\n+      // (We often get warnings when e.g. a feature gets stabilized or some lint gets added/improved.)\n+      flags.push(\"-Dwarnings -Dunused\".to_owned()); // overwrite the -Aunused in compiletest-rs\n+    }\n     if let Ok(sysroot) = std::env::var(\"MIRI_SYSROOT\") {\n         flags.push(format!(\"--sysroot {}\", sysroot));\n     }\n@@ -36,7 +41,7 @@ fn run_tests(mode: &str, path: &str, target: &str, mut flags: Vec<String>) {\n     let mut config = compiletest::Config::default().tempdir();\n     config.mode = mode.parse().expect(\"Invalid mode\");\n     config.rustc_path = miri_path();\n-    if rustc_test_suite().is_some() {\n+    if in_rustc_test_suite {\n         config.run_lib_path = rustc_lib_path();\n         config.compile_lib_path = rustc_lib_path();\n     }"}]}