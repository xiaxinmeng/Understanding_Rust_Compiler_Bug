{"sha": "1765a3fd30b12e8647e79f9caf873c800df42bf9", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE3NjVhM2ZkMzBiMTJlODY0N2U3OWY5Y2FmODczYzgwMGRmNDJiZjk=", "commit": {"author": {"name": "Philip Craig", "email": "philipjcraig@gmail.com", "date": "2017-01-01T07:46:15Z"}, "committer": {"name": "Philip Craig", "email": "philipjcraig@gmail.com", "date": "2017-01-01T09:34:06Z"}, "message": "Add pretty printing of unions in debuggers\n\nFixes #37479", "tree": {"sha": "1d7d0ca42f626785f0140dc4adc417a6eed8d7a2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1d7d0ca42f626785f0140dc4adc417a6eed8d7a2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1765a3fd30b12e8647e79f9caf873c800df42bf9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1765a3fd30b12e8647e79f9caf873c800df42bf9", "html_url": "https://github.com/rust-lang/rust/commit/1765a3fd30b12e8647e79f9caf873c800df42bf9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1765a3fd30b12e8647e79f9caf873c800df42bf9/comments", "author": {"login": "philipc", "id": 330342, "node_id": "MDQ6VXNlcjMzMDM0Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/330342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/philipc", "html_url": "https://github.com/philipc", "followers_url": "https://api.github.com/users/philipc/followers", "following_url": "https://api.github.com/users/philipc/following{/other_user}", "gists_url": "https://api.github.com/users/philipc/gists{/gist_id}", "starred_url": "https://api.github.com/users/philipc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/philipc/subscriptions", "organizations_url": "https://api.github.com/users/philipc/orgs", "repos_url": "https://api.github.com/users/philipc/repos", "events_url": "https://api.github.com/users/philipc/events{/privacy}", "received_events_url": "https://api.github.com/users/philipc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "philipc", "id": 330342, "node_id": "MDQ6VXNlcjMzMDM0Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/330342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/philipc", "html_url": "https://github.com/philipc", "followers_url": "https://api.github.com/users/philipc/followers", "following_url": "https://api.github.com/users/philipc/following{/other_user}", "gists_url": "https://api.github.com/users/philipc/gists{/gist_id}", "starred_url": "https://api.github.com/users/philipc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/philipc/subscriptions", "organizations_url": "https://api.github.com/users/philipc/orgs", "repos_url": "https://api.github.com/users/philipc/repos", "events_url": "https://api.github.com/users/philipc/events{/privacy}", "received_events_url": "https://api.github.com/users/philipc/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "08babdb412a87960fe3602e92abf1bf5fe26a8da", "url": "https://api.github.com/repos/rust-lang/rust/commits/08babdb412a87960fe3602e92abf1bf5fe26a8da", "html_url": "https://github.com/rust-lang/rust/commit/08babdb412a87960fe3602e92abf1bf5fe26a8da"}], "stats": {"total": 25, "additions": 15, "deletions": 10}, "files": [{"sha": "5e3ff5246a922d3089b06d5859a39cbd0014224a", "filename": "src/etc/debugger_pretty_printers_common.py", "status": "modified", "additions": 10, "deletions": 6, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/1765a3fd30b12e8647e79f9caf873c800df42bf9/src%2Fetc%2Fdebugger_pretty_printers_common.py", "raw_url": "https://github.com/rust-lang/rust/raw/1765a3fd30b12e8647e79f9caf873c800df42bf9/src%2Fetc%2Fdebugger_pretty_printers_common.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fetc%2Fdebugger_pretty_printers_common.py?ref=1765a3fd30b12e8647e79f9caf873c800df42bf9", "patch": "@@ -45,6 +45,7 @@\n TYPE_KIND_CSTYLE_ENUM       = 14\n TYPE_KIND_PTR               = 15\n TYPE_KIND_FIXED_SIZE_VEC    = 16\n+TYPE_KIND_REGULAR_UNION     = 17\n \n ENCODED_ENUM_PREFIX = \"RUST$ENCODED$ENUM$\"\n ENUM_DISR_FIELD_NAME = \"RUST$ENUM$DISR\"\n@@ -188,15 +189,18 @@ def __classify_union(self):\n         union_member_count = len(union_members)\n         if union_member_count == 0:\n             return TYPE_KIND_EMPTY\n-        elif union_member_count == 1:\n-            first_variant_name = union_members[0].name\n-            if first_variant_name is None:\n+\n+        first_variant_name = union_members[0].name\n+        if first_variant_name is None:\n+            if union_member_count == 1:\n                 return TYPE_KIND_SINGLETON_ENUM\n             else:\n-                assert first_variant_name.startswith(ENCODED_ENUM_PREFIX)\n-                return TYPE_KIND_COMPRESSED_ENUM\n+                return TYPE_KIND_REGULAR_ENUM\n+        elif first_variant_name.startswith(ENCODED_ENUM_PREFIX):\n+            assert union_member_count == 1\n+            return TYPE_KIND_COMPRESSED_ENUM\n         else:\n-            return TYPE_KIND_REGULAR_ENUM\n+            return TYPE_KIND_REGULAR_UNION\n \n \n     def __conforms_to_field_layout(self, expected_fields):"}, {"sha": "4427313f9e5b352b55bbabc9e6ff4b3a2a16548d", "filename": "src/etc/lldb_rust_formatters.py", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/1765a3fd30b12e8647e79f9caf873c800df42bf9/src%2Fetc%2Flldb_rust_formatters.py", "raw_url": "https://github.com/rust-lang/rust/raw/1765a3fd30b12e8647e79f9caf873c800df42bf9/src%2Fetc%2Flldb_rust_formatters.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fetc%2Flldb_rust_formatters.py?ref=1765a3fd30b12e8647e79f9caf873c800df42bf9", "patch": "@@ -90,6 +90,7 @@ def print_val(lldb_val, internal_dict):\n     type_kind = val.type.get_type_kind()\n \n     if (type_kind == rustpp.TYPE_KIND_REGULAR_STRUCT or\n+        type_kind == rustpp.TYPE_KIND_REGULAR_UNION or\n         type_kind == rustpp.TYPE_KIND_EMPTY):\n         return print_struct_val(val,\n                                 internal_dict,\n@@ -175,7 +176,8 @@ def print_struct_val(val, internal_dict, omit_first_field, omit_type_name, is_tu\n     Prints a struct, tuple, or tuple struct value with Rust syntax.\n     Ignores any fields before field_start_index.\n     \"\"\"\n-    assert val.type.get_dwarf_type_kind() == rustpp.DWARF_TYPE_CODE_STRUCT\n+    assert (val.type.get_dwarf_type_kind() == rustpp.DWARF_TYPE_CODE_STRUCT or\n+            val.type.get_dwarf_type_kind() == rustpp.DWARF_TYPE_CODE_UNION)\n \n     if omit_type_name:\n         type_name = \"\""}, {"sha": "5d3fbd62023871b873767fde4018f59144b0adb7", "filename": "src/test/debuginfo/union-smoke.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/1765a3fd30b12e8647e79f9caf873c800df42bf9/src%2Ftest%2Fdebuginfo%2Funion-smoke.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1765a3fd30b12e8647e79f9caf873c800df42bf9/src%2Ftest%2Fdebuginfo%2Funion-smoke.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fdebuginfo%2Funion-smoke.rs?ref=1765a3fd30b12e8647e79f9caf873c800df42bf9", "patch": "@@ -9,7 +9,6 @@\n // except according to those terms.\n \n // min-lldb-version: 310\n-// ignore-macos FIXME(#37479)\n \n // compile-flags:-g\n \n@@ -27,9 +26,9 @@\n \n // lldb-command:run\n // lldb-command:print u\n-// lldb-check:[...]$0 = { a = ('\\x02', '\\x02') b = 514 }\n+// lldb-check:[...]$0 = U { a: ('\\x02', '\\x02'), b: 514 }\n // lldb-command:print union_smoke::SU\n-// lldb-check:[...]$1 = 257\n+// lldb-check:[...]$1 = U { a: ('\\x01', '\\x01'), b: 257 }\n \n #![allow(unused)]\n #![feature(omit_gdb_pretty_printer_section)]"}]}