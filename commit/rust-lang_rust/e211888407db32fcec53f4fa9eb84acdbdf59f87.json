{"sha": "e211888407db32fcec53f4fa9eb84acdbdf59f87", "node_id": "MDY6Q29tbWl0NzI0NzEyOmUyMTE4ODg0MDdkYjMyZmNlYzUzZjRmYTllYjg0YWNkYmRmNTlmODc=", "commit": {"author": {"name": "blake2-ppc", "email": "blake2-ppc", "date": "2013-09-12T03:00:25Z"}, "committer": {"name": "blake2-ppc", "email": "blake2-ppc", "date": "2013-09-17T00:48:00Z"}, "message": "std::at_vec: Fix segfault on overflow when resizing ~[@T]\n\nEasy to reproduce:\n\n    let mut v = ~[@1];\n    v.resize(-1);  // success a.k.a silent failure\n    v.push(@2); // segfault", "tree": {"sha": "74b7b8aae3027586895cb1717c9a93eb751fbcd0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/74b7b8aae3027586895cb1717c9a93eb751fbcd0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e211888407db32fcec53f4fa9eb84acdbdf59f87", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e211888407db32fcec53f4fa9eb84acdbdf59f87", "html_url": "https://github.com/rust-lang/rust/commit/e211888407db32fcec53f4fa9eb84acdbdf59f87", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e211888407db32fcec53f4fa9eb84acdbdf59f87/comments", "author": null, "committer": null, "parents": [{"sha": "6e538edea2557018c3c8eae41aacf6cdf6370a4d", "url": "https://api.github.com/repos/rust-lang/rust/commits/6e538edea2557018c3c8eae41aacf6cdf6370a4d", "html_url": "https://github.com/rust-lang/rust/commit/6e538edea2557018c3c8eae41aacf6cdf6370a4d"}], "stats": {"total": 21, "additions": 16, "deletions": 5}, "files": [{"sha": "42f511f722daba4323cd3cc6d9502b7294ea3974", "filename": "src/libstd/at_vec.rs", "status": "modified", "additions": 8, "deletions": 5, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/e211888407db32fcec53f4fa9eb84acdbdf59f87/src%2Flibstd%2Fat_vec.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e211888407db32fcec53f4fa9eb84acdbdf59f87/src%2Flibstd%2Fat_vec.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fat_vec.rs?ref=e211888407db32fcec53f4fa9eb84acdbdf59f87", "patch": "@@ -230,13 +230,16 @@ pub mod raw {\n     // Implementation detail. Shouldn't be public\n     #[allow(missing_doc)]\n     pub fn reserve_raw(ty: *TyDesc, ptr: *mut *mut Box<Vec<()>>, n: uint) {\n-\n+        // check for `uint` overflow\n         unsafe {\n-            let size_in_bytes = n * (*ty).size;\n-            if size_in_bytes > (**ptr).data.alloc {\n-                let total_size = size_in_bytes + sys::size_of::<Vec<()>>();\n+            if n > (**ptr).data.alloc / (*ty).size {\n+                let alloc = n * (*ty).size;\n+                let total_size = alloc + sys::size_of::<Vec<()>>();\n+                if alloc / (*ty).size != n || total_size < alloc {\n+                    fail!(\"vector size is too large: %u\", n);\n+                }\n                 (*ptr) = local_realloc(*ptr as *(), total_size) as *mut Box<Vec<()>>;\n-                (**ptr).data.alloc = size_in_bytes;\n+                (**ptr).data.alloc = alloc;\n             }\n         }\n "}, {"sha": "9fc0eaf72b14d044de5d1fd8a0df90293de97d8e", "filename": "src/libstd/vec.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/e211888407db32fcec53f4fa9eb84acdbdf59f87/src%2Flibstd%2Fvec.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e211888407db32fcec53f4fa9eb84acdbdf59f87/src%2Flibstd%2Fvec.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fvec.rs?ref=e211888407db32fcec53f4fa9eb84acdbdf59f87", "patch": "@@ -3659,6 +3659,14 @@ mod tests {\n         v.push(2);\n     }\n \n+    #[test]\n+    #[should_fail]\n+    fn test_overflow_does_not_cause_segfault_managed() {\n+        let mut v = ~[@1];\n+        v.reserve(-1);\n+        v.push(@2);\n+    }\n+\n     #[test]\n     fn test_mut_split() {\n         let mut values = [1u8,2,3,4,5];"}]}