{"sha": "c19b2370e419c0be7b46cc9ae7767773560a072c", "node_id": "MDY6Q29tbWl0NzI0NzEyOmMxOWIyMzcwZTQxOWMwYmU3YjQ2Y2M5YWU3NzY3NzczNTYwYTA3MmM=", "commit": {"author": {"name": "Rich Kadel", "email": "richkadel@google.com", "date": "2020-09-08T23:08:35Z"}, "committer": {"name": "Rich Kadel", "email": "richkadel@google.com", "date": "2020-09-09T00:19:38Z"}, "message": "Add -Zgraphviz_dark_mode\n\nMany developers use a dark theme with editors and IDEs, but this\ntypically doesn't extend to graphviz output.\n\nWhen I bring up a MIR graphviz document, the white background is\nstrikingly bright. This new option changes the colors used for graphviz\noutput to work better in dark-themed UIs.", "tree": {"sha": "8f5fdd4b673789eb476a0877f408d9eb8a172643", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8f5fdd4b673789eb476a0877f408d9eb8a172643"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c19b2370e419c0be7b46cc9ae7767773560a072c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c19b2370e419c0be7b46cc9ae7767773560a072c", "html_url": "https://github.com/rust-lang/rust/commit/c19b2370e419c0be7b46cc9ae7767773560a072c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c19b2370e419c0be7b46cc9ae7767773560a072c/comments", "author": {"login": "richkadel", "id": 3827298, "node_id": "MDQ6VXNlcjM4MjcyOTg=", "avatar_url": "https://avatars.githubusercontent.com/u/3827298?v=4", "gravatar_id": "", "url": "https://api.github.com/users/richkadel", "html_url": "https://github.com/richkadel", "followers_url": "https://api.github.com/users/richkadel/followers", "following_url": "https://api.github.com/users/richkadel/following{/other_user}", "gists_url": "https://api.github.com/users/richkadel/gists{/gist_id}", "starred_url": "https://api.github.com/users/richkadel/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/richkadel/subscriptions", "organizations_url": "https://api.github.com/users/richkadel/orgs", "repos_url": "https://api.github.com/users/richkadel/repos", "events_url": "https://api.github.com/users/richkadel/events{/privacy}", "received_events_url": "https://api.github.com/users/richkadel/received_events", "type": "User", "site_admin": false}, "committer": {"login": "richkadel", "id": 3827298, "node_id": "MDQ6VXNlcjM4MjcyOTg=", "avatar_url": "https://avatars.githubusercontent.com/u/3827298?v=4", "gravatar_id": "", "url": "https://api.github.com/users/richkadel", "html_url": "https://github.com/richkadel", "followers_url": "https://api.github.com/users/richkadel/followers", "following_url": "https://api.github.com/users/richkadel/following{/other_user}", "gists_url": "https://api.github.com/users/richkadel/gists{/gist_id}", "starred_url": "https://api.github.com/users/richkadel/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/richkadel/subscriptions", "organizations_url": "https://api.github.com/users/richkadel/orgs", "repos_url": "https://api.github.com/users/richkadel/repos", "events_url": "https://api.github.com/users/richkadel/events{/privacy}", "received_events_url": "https://api.github.com/users/richkadel/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5099914a16a215794ad243df0cc7a05d91d168e0", "url": "https://api.github.com/repos/rust-lang/rust/commits/5099914a16a215794ad243df0cc7a05d91d168e0", "html_url": "https://github.com/rust-lang/rust/commit/5099914a16a215794ad243df0cc7a05d91d168e0"}], "stats": {"total": 57, "additions": 46, "deletions": 11}, "files": [{"sha": "252e34168654182ed875c842c7370a2628810b85", "filename": "compiler/rustc_graphviz/src/lib.rs", "status": "modified", "additions": 17, "deletions": 3, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/c19b2370e419c0be7b46cc9ae7767773560a072c/compiler%2Frustc_graphviz%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c19b2370e419c0be7b46cc9ae7767773560a072c/compiler%2Frustc_graphviz%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_graphviz%2Fsrc%2Flib.rs?ref=c19b2370e419c0be7b46cc9ae7767773560a072c", "patch": "@@ -599,6 +599,7 @@ pub enum RenderOption {\n     NoNodeStyles,\n \n     Monospace,\n+    DarkTheme,\n }\n \n /// Returns vec holding all the default render options.\n@@ -630,10 +631,23 @@ where\n     writeln!(w, \"digraph {} {{\", g.graph_id().as_slice())?;\n \n     // Global graph properties\n+    let mut graph_attrs = Vec::new();\n+    let mut content_attrs = Vec::new();\n     if options.contains(&RenderOption::Monospace) {\n-        writeln!(w, r#\"    graph[fontname=\"monospace\"];\"#)?;\n-        writeln!(w, r#\"    node[fontname=\"monospace\"];\"#)?;\n-        writeln!(w, r#\"    edge[fontname=\"monospace\"];\"#)?;\n+        let font = r#\"fontname=\"monospace\"\"#;\n+        graph_attrs.push(font);\n+        content_attrs.push(font);\n+    };\n+    if options.contains(&RenderOption::DarkTheme) {\n+        graph_attrs.push(r#\"bgcolor=\"black\"\"#);\n+        content_attrs.push(r#\"color=\"white\"\"#);\n+        content_attrs.push(r#\"fontcolor=\"white\"\"#);\n+    }\n+    if !(graph_attrs.is_empty() && content_attrs.is_empty()) {\n+        writeln!(w, r#\"    graph[{}];\"#, graph_attrs.join(\" \"))?;\n+        let content_attrs_str = content_attrs.join(\" \");\n+        writeln!(w, r#\"    node[{}];\"#, content_attrs_str)?;\n+        writeln!(w, r#\"    edge[{}];\"#, content_attrs_str)?;\n     }\n \n     for n in g.nodes().iter() {"}, {"sha": "0b5b437d186aade4297534aaa699ff0327276eee", "filename": "compiler/rustc_mir/src/dataflow/framework/engine.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/c19b2370e419c0be7b46cc9ae7767773560a072c/compiler%2Frustc_mir%2Fsrc%2Fdataflow%2Fframework%2Fengine.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c19b2370e419c0be7b46cc9ae7767773560a072c/compiler%2Frustc_mir%2Fsrc%2Fdataflow%2Fframework%2Fengine.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Fdataflow%2Fframework%2Fengine.rs?ref=c19b2370e419c0be7b46cc9ae7767773560a072c", "patch": "@@ -306,7 +306,11 @@ where\n     let mut buf = Vec::new();\n \n     let graphviz = graphviz::Formatter::new(body, def_id, results, style);\n-    dot::render_opts(&graphviz, &mut buf, &[dot::RenderOption::Monospace])?;\n+    let mut render_opts = vec![dot::RenderOption::Monospace];\n+    if tcx.sess.opts.debugging_opts.graphviz_dark_mode {\n+        render_opts.push(dot::RenderOption::DarkTheme);\n+    }\n+    dot::render_opts(&graphviz, &mut buf, &render_opts)?;\n \n     if let Some(parent) = path.parent() {\n         fs::create_dir_all(parent)?;"}, {"sha": "bc1e3fa8b2915384ba518d55108c4be429457403", "filename": "compiler/rustc_mir/src/util/graphviz.rs", "status": "modified", "additions": 22, "deletions": 7, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/c19b2370e419c0be7b46cc9ae7767773560a072c/compiler%2Frustc_mir%2Fsrc%2Futil%2Fgraphviz.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c19b2370e419c0be7b46cc9ae7767773560a072c/compiler%2Frustc_mir%2Fsrc%2Futil%2Fgraphviz.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Futil%2Fgraphviz.rs?ref=c19b2370e419c0be7b46cc9ae7767773560a072c", "patch": "@@ -55,16 +55,28 @@ where\n     writeln!(w, \"{} {}Mir_{} {{\", kind, cluster, def_name)?;\n \n     // Global graph properties\n-    writeln!(w, r#\"    graph [fontname=\"monospace\"];\"#)?;\n-    writeln!(w, r#\"    node [fontname=\"monospace\"];\"#)?;\n-    writeln!(w, r#\"    edge [fontname=\"monospace\"];\"#)?;\n+    let font = r#\"fontname=\"monospace\"\"#;\n+    let mut graph_attrs = vec![font];\n+    let mut content_attrs = vec![font];\n+\n+    let dark_mode = tcx.sess.opts.debugging_opts.graphviz_dark_mode;\n+    if dark_mode {\n+        graph_attrs.push(r#\"bgcolor=\"black\"\"#);\n+        content_attrs.push(r#\"color=\"white\"\"#);\n+        content_attrs.push(r#\"fontcolor=\"white\"\"#);\n+    }\n+\n+    writeln!(w, r#\"    graph [{}];\"#, graph_attrs.join(\" \"))?;\n+    let content_attrs_str = content_attrs.join(\" \");\n+    writeln!(w, r#\"    node [{}];\"#, content_attrs_str)?;\n+    writeln!(w, r#\"    edge [{}];\"#, content_attrs_str)?;\n \n     // Graph label\n     write_graph_label(tcx, def_id, body, w)?;\n \n     // Nodes\n     for (block, _) in body.basic_blocks().iter_enumerated() {\n-        write_node(def_id, block, body, w)?;\n+        write_node(def_id, block, body, dark_mode, w)?;\n     }\n \n     // Edges\n@@ -84,6 +96,7 @@ where\n pub fn write_node_label<W: Write, INIT, FINI>(\n     block: BasicBlock,\n     body: &Body<'_>,\n+    dark_mode: bool,\n     w: &mut W,\n     num_cols: u32,\n     init: INIT,\n@@ -100,8 +113,9 @@ where\n     // Basic block number at the top.\n     write!(\n         w,\n-        r#\"<tr><td {attrs} colspan=\"{colspan}\">{blk}</td></tr>\"#,\n-        attrs = r#\"bgcolor=\"gray\" align=\"center\"\"#,\n+        r#\"<tr><td bgcolor=\"{bgcolor}\" {attrs} colspan=\"{colspan}\">{blk}</td></tr>\"#,\n+        bgcolor = if dark_mode { \"dimgray\" } else { \"gray\" },\n+        attrs = r#\"align=\"center\"\"#,\n         colspan = num_cols,\n         blk = block.index()\n     )?;\n@@ -134,11 +148,12 @@ fn write_node<W: Write>(\n     def_id: DefId,\n     block: BasicBlock,\n     body: &Body<'_>,\n+    dark_mode: bool,\n     w: &mut W,\n ) -> io::Result<()> {\n     // Start a new node with the label to follow, in one of DOT's pseudo-HTML tables.\n     write!(w, r#\"    {} [shape=\"none\", label=<\"#, node(def_id, block))?;\n-    write_node_label(block, body, w, 1, |_| Ok(()), |_| Ok(()))?;\n+    write_node_label(block, body, dark_mode, w, 1, |_| Ok(()), |_| Ok(()))?;\n     // Close the node label and the node itself.\n     writeln!(w, \">];\")\n }"}, {"sha": "f31e0431d0da7d65da4f5fa2dd9661db9c0cfe4d", "filename": "compiler/rustc_session/src/options.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/c19b2370e419c0be7b46cc9ae7767773560a072c/compiler%2Frustc_session%2Fsrc%2Foptions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c19b2370e419c0be7b46cc9ae7767773560a072c/compiler%2Frustc_session%2Fsrc%2Foptions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Foptions.rs?ref=c19b2370e419c0be7b46cc9ae7767773560a072c", "patch": "@@ -907,6 +907,8 @@ options! {DebuggingOptions, DebuggingSetter, basic_debugging_options,\n         \"force all crates to be `rustc_private` unstable (default: no)\"),\n     fuel: Option<(String, u64)> = (None, parse_optimization_fuel, [TRACKED],\n         \"set the optimization fuel quota for a crate\"),\n+    graphviz_dark_mode: bool = (false, parse_bool, [UNTRACKED],\n+        \"use dark-themed colors in graphviz output (default: no)\"),\n     hir_stats: bool = (false, parse_bool, [UNTRACKED],\n         \"print some statistics about AST and HIR (default: no)\"),\n     human_readable_cgu_names: bool = (false, parse_bool, [TRACKED],"}]}