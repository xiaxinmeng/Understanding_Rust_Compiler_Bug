{"sha": "ad61ff4b817f8581ea4c12f897f5e6baafe27952", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFkNjFmZjRiODE3Zjg1ODFlYTRjMTJmODk3ZjVlNmJhYWZlMjc5NTI=", "commit": {"author": {"name": "Keegan McAllister", "email": "kmcallister@mozilla.com", "date": "2014-11-18T22:02:40Z"}, "committer": {"name": "Keegan McAllister", "email": "kmcallister@mozilla.com", "date": "2014-11-18T22:43:20Z"}, "message": "deriving: error out when used on a non-type\n\nBesides being more helpful, this gives us the flexibility to later define\na meaning for something like\n\n    #[deriving(...)]\n    mod bar { ... }", "tree": {"sha": "4d42d2ea1c3c9a53bf06e0e474f518a4aa8f33db", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4d42d2ea1c3c9a53bf06e0e474f518a4aa8f33db"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ad61ff4b817f8581ea4c12f897f5e6baafe27952", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ad61ff4b817f8581ea4c12f897f5e6baafe27952", "html_url": "https://github.com/rust-lang/rust/commit/ad61ff4b817f8581ea4c12f897f5e6baafe27952", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ad61ff4b817f8581ea4c12f897f5e6baafe27952/comments", "author": {"login": "kmcallister", "id": 444997, "node_id": "MDQ6VXNlcjQ0NDk5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/444997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kmcallister", "html_url": "https://github.com/kmcallister", "followers_url": "https://api.github.com/users/kmcallister/followers", "following_url": "https://api.github.com/users/kmcallister/following{/other_user}", "gists_url": "https://api.github.com/users/kmcallister/gists{/gist_id}", "starred_url": "https://api.github.com/users/kmcallister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kmcallister/subscriptions", "organizations_url": "https://api.github.com/users/kmcallister/orgs", "repos_url": "https://api.github.com/users/kmcallister/repos", "events_url": "https://api.github.com/users/kmcallister/events{/privacy}", "received_events_url": "https://api.github.com/users/kmcallister/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kmcallister", "id": 444997, "node_id": "MDQ6VXNlcjQ0NDk5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/444997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kmcallister", "html_url": "https://github.com/kmcallister", "followers_url": "https://api.github.com/users/kmcallister/followers", "following_url": "https://api.github.com/users/kmcallister/following{/other_user}", "gists_url": "https://api.github.com/users/kmcallister/gists{/gist_id}", "starred_url": "https://api.github.com/users/kmcallister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kmcallister/subscriptions", "organizations_url": "https://api.github.com/users/kmcallister/orgs", "repos_url": "https://api.github.com/users/kmcallister/repos", "events_url": "https://api.github.com/users/kmcallister/events{/privacy}", "received_events_url": "https://api.github.com/users/kmcallister/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "09e2ad13d0aa01143bcb20dece3ff6c5a7e34ea3", "url": "https://api.github.com/repos/rust-lang/rust/commits/09e2ad13d0aa01143bcb20dece3ff6c5a7e34ea3", "html_url": "https://github.com/rust-lang/rust/commit/09e2ad13d0aa01143bcb20dece3ff6c5a7e34ea3"}], "stats": {"total": 47, "additions": 45, "deletions": 2}, "files": [{"sha": "eec3805721a85b50ee1489e6081e686a7c1eb094", "filename": "src/libsyntax/ext/deriving/generic/mod.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/ad61ff4b817f8581ea4c12f897f5e6baafe27952/src%2Flibsyntax%2Fext%2Fderiving%2Fgeneric%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad61ff4b817f8581ea4c12f897f5e6baafe27952/src%2Flibsyntax%2Fext%2Fderiving%2Fgeneric%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fderiving%2Fgeneric%2Fmod.rs?ref=ad61ff4b817f8581ea4c12f897f5e6baafe27952", "patch": "@@ -335,7 +335,7 @@ pub fn combine_substructure<'a>(f: CombineSubstructureFunc<'a>)\n impl<'a> TraitDef<'a> {\n     pub fn expand(&self,\n                   cx: &mut ExtCtxt,\n-                  _mitem: &ast::MetaItem,\n+                  mitem: &ast::MetaItem,\n                   item: &ast::Item,\n                   push: |P<ast::Item>|) {\n         let newitem = match item.node {\n@@ -351,7 +351,10 @@ impl<'a> TraitDef<'a> {\n                                      item.ident,\n                                      generics)\n             }\n-            _ => return\n+            _ => {\n+                cx.span_err(mitem.span, \"`deriving` may only be applied to structs and enums\");\n+                return;\n+            }\n         };\n         // Keep the lint attributes of the previous item to control how the\n         // generated implementations are linted"}, {"sha": "8226bba42b0e1f345d03f5ce440673965b8809b9", "filename": "src/test/compile-fail/deriving-non-type.rs", "status": "added", "additions": 40, "deletions": 0, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/ad61ff4b817f8581ea4c12f897f5e6baafe27952/src%2Ftest%2Fcompile-fail%2Fderiving-non-type.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ad61ff4b817f8581ea4c12f897f5e6baafe27952/src%2Ftest%2Fcompile-fail%2Fderiving-non-type.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fderiving-non-type.rs?ref=ad61ff4b817f8581ea4c12f897f5e6baafe27952", "patch": "@@ -0,0 +1,40 @@\n+// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![allow(dead_code)]\n+\n+struct S;\n+\n+#[deriving(PartialEq)] //~ ERROR: `deriving` may only be applied to structs and enums\n+trait T { }\n+\n+#[deriving(PartialEq)] //~ ERROR: `deriving` may only be applied to structs and enums\n+impl S { }\n+\n+#[deriving(PartialEq)] //~ ERROR: `deriving` may only be applied to structs and enums\n+impl T for S { }\n+\n+#[deriving(PartialEq)] //~ ERROR: `deriving` may only be applied to structs and enums\n+static s: uint = 0u;\n+\n+#[deriving(PartialEq)] //~ ERROR: `deriving` may only be applied to structs and enums\n+const c: uint = 0u;\n+\n+#[deriving(PartialEq)] //~ ERROR: `deriving` may only be applied to structs and enums\n+mod m { }\n+\n+#[deriving(PartialEq)] //~ ERROR: `deriving` may only be applied to structs and enums\n+extern \"C\" { }\n+\n+#[deriving(PartialEq)] //~ ERROR: `deriving` may only be applied to structs and enums\n+type A = uint;\n+\n+#[deriving(PartialEq)] //~ ERROR: `deriving` may only be applied to structs and enums\n+fn main() { }"}]}