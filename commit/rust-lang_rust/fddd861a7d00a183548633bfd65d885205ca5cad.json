{"sha": "fddd861a7d00a183548633bfd65d885205ca5cad", "node_id": "C_kwDOAAsO6NoAKGZkZGQ4NjFhN2QwMGExODM1NDg2MzNiZmQ2NWQ4ODUyMDVjYTVjYWQ", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2023-03-07T14:06:25Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-03-07T14:06:25Z"}, "message": "Rollup merge of #108855 - cbeuw:mir-cast, r=tmiasko\n\nCustom MIR: Support `as` casts\n\nSmall changes to support this low hanging fruit\n\nr? `@oli-obk` or `@tmiasko` or `@JakobDegen`", "tree": {"sha": "d8a8dad13c38fb692eaebd32f4c6160c702afe04", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d8a8dad13c38fb692eaebd32f4c6160c702afe04"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fddd861a7d00a183548633bfd65d885205ca5cad", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkB0ThCRBK7hj4Ov3rIwAA6/MIAIvHxq0BBia0hJIdKuZNyX7P\nAtYeIsLslpG8kt5nO4GGsOdn7nnd+TjjxY4fuOXpdDN5GetHp0iByGyHChuKWPMo\n8JEsRS1Rujlf0iFYJwO2L6stOrepjxamKfM5YztD6UvDixQOklMy0LPhm1ezTm4a\nD6pACoVvvwYpcymH06jS4TbKmyPEpKYjczIWMfMZM/mhURWOJ5wTRejzba2W51pt\nSjlpLf4nrNQbbV9PFymW2oU4CNsddfqng4CXv1skRBo6/LlNyTPUEfF4d3m/jEtm\n8G3CESAp0PGTnZ9fEcZ8bHi9i48fgbhwqkdaaOYdM4W9RwnYXEHmAqLVXXzY4nE=\n=//wD\n-----END PGP SIGNATURE-----\n", "payload": "tree d8a8dad13c38fb692eaebd32f4c6160c702afe04\nparent b866e1ee0ac86ca24c41231d53792aa79e9775d1\nparent 7281cd0c215ef8005adfb83e13ff075df32a0ebd\nauthor Yuki Okushi <jtitor@2k36.org> 1678197985 +0900\ncommitter GitHub <noreply@github.com> 1678197985 +0900\n\nRollup merge of #108855 - cbeuw:mir-cast, r=tmiasko\n\nCustom MIR: Support `as` casts\n\nSmall changes to support this low hanging fruit\n\nr? `@oli-obk` or `@tmiasko` or `@JakobDegen`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fddd861a7d00a183548633bfd65d885205ca5cad", "html_url": "https://github.com/rust-lang/rust/commit/fddd861a7d00a183548633bfd65d885205ca5cad", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fddd861a7d00a183548633bfd65d885205ca5cad/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b866e1ee0ac86ca24c41231d53792aa79e9775d1", "url": "https://api.github.com/repos/rust-lang/rust/commits/b866e1ee0ac86ca24c41231d53792aa79e9775d1", "html_url": "https://github.com/rust-lang/rust/commit/b866e1ee0ac86ca24c41231d53792aa79e9775d1"}, {"sha": "7281cd0c215ef8005adfb83e13ff075df32a0ebd", "url": "https://api.github.com/repos/rust-lang/rust/commits/7281cd0c215ef8005adfb83e13ff075df32a0ebd", "html_url": "https://github.com/rust-lang/rust/commit/7281cd0c215ef8005adfb83e13ff075df32a0ebd"}], "stats": {"total": 82, "additions": 81, "deletions": 1}, "files": [{"sha": "09d2eb96d0f16e4644c19a3ea16c702fe0dd177b", "filename": "compiler/rustc_mir_build/src/build/custom/parse/instruction.rs", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/fddd861a7d00a183548633bfd65d885205ca5cad/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fcustom%2Fparse%2Finstruction.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fddd861a7d00a183548633bfd65d885205ca5cad/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fcustom%2Fparse%2Finstruction.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fcustom%2Fparse%2Finstruction.rs?ref=fddd861a7d00a183548633bfd65d885205ca5cad", "patch": "@@ -1,5 +1,6 @@\n use rustc_middle::mir::interpret::{ConstValue, Scalar};\n use rustc_middle::mir::tcx::PlaceTy;\n+use rustc_middle::ty::cast::mir_cast_kind;\n use rustc_middle::{mir::*, thir::*, ty};\n use rustc_span::Span;\n use rustc_target::abi::VariantIdx;\n@@ -142,7 +143,7 @@ impl<'tcx, 'body> ParseCtxt<'tcx, 'body> {\n     }\n \n     fn parse_rvalue(&self, expr_id: ExprId) -> PResult<Rvalue<'tcx>> {\n-        parse_by_kind!(self, expr_id, _, \"rvalue\",\n+        parse_by_kind!(self, expr_id, expr, \"rvalue\",\n             @call(\"mir_discriminant\", args) => self.parse_place(args[0]).map(Rvalue::Discriminant),\n             @call(\"mir_checked\", args) => {\n                 parse_by_kind!(self, args[0], _, \"binary op\",\n@@ -167,6 +168,12 @@ impl<'tcx, 'body> ParseCtxt<'tcx, 'body> {\n             ExprKind::Repeat { value, count } => Ok(\n                 Rvalue::Repeat(self.parse_operand(*value)?, *count)\n             ),\n+            ExprKind::Cast { source } => {\n+                let source = self.parse_operand(*source)?;\n+                let source_ty = source.ty(self.body.local_decls(), self.tcx);\n+                let cast_kind = mir_cast_kind(source_ty, expr.ty);\n+                Ok(Rvalue::Cast(cast_kind, source, expr.ty))\n+            },\n             _ => self.parse_operand(expr_id).map(Rvalue::Use),\n         )\n     }"}, {"sha": "d0b770783c1f12673665c903af3e2a02e5cd9e7d", "filename": "tests/mir-opt/building/custom/as_cast.float_to_int.built.after.mir", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/fddd861a7d00a183548633bfd65d885205ca5cad/tests%2Fmir-opt%2Fbuilding%2Fcustom%2Fas_cast.float_to_int.built.after.mir", "raw_url": "https://github.com/rust-lang/rust/raw/fddd861a7d00a183548633bfd65d885205ca5cad/tests%2Fmir-opt%2Fbuilding%2Fcustom%2Fas_cast.float_to_int.built.after.mir", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fbuilding%2Fcustom%2Fas_cast.float_to_int.built.after.mir?ref=fddd861a7d00a183548633bfd65d885205ca5cad", "patch": "@@ -0,0 +1,10 @@\n+// MIR for `float_to_int` after built\n+\n+fn float_to_int(_1: f32) -> i32 {\n+    let mut _0: i32;                     // return place in scope 0 at $DIR/as_cast.rs:+0:28: +0:31\n+\n+    bb0: {\n+        _0 = _1 as i32 (FloatToInt);     // scope 0 at $DIR/as_cast.rs:+3:13: +3:27\n+        return;                          // scope 0 at $DIR/as_cast.rs:+4:13: +4:21\n+    }\n+}"}, {"sha": "aaebff0d7673d82cfb822a3993f932ff4fca06e0", "filename": "tests/mir-opt/building/custom/as_cast.int_to_int.built.after.mir", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/fddd861a7d00a183548633bfd65d885205ca5cad/tests%2Fmir-opt%2Fbuilding%2Fcustom%2Fas_cast.int_to_int.built.after.mir", "raw_url": "https://github.com/rust-lang/rust/raw/fddd861a7d00a183548633bfd65d885205ca5cad/tests%2Fmir-opt%2Fbuilding%2Fcustom%2Fas_cast.int_to_int.built.after.mir", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fbuilding%2Fcustom%2Fas_cast.int_to_int.built.after.mir?ref=fddd861a7d00a183548633bfd65d885205ca5cad", "patch": "@@ -0,0 +1,10 @@\n+// MIR for `int_to_int` after built\n+\n+fn int_to_int(_1: u32) -> i32 {\n+    let mut _0: i32;                     // return place in scope 0 at $DIR/as_cast.rs:+0:26: +0:29\n+\n+    bb0: {\n+        _0 = _1 as i32 (IntToInt);       // scope 0 at $DIR/as_cast.rs:+3:13: +3:27\n+        return;                          // scope 0 at $DIR/as_cast.rs:+4:13: +4:21\n+    }\n+}"}, {"sha": "f040cf53df4a8714b5251c291ffc8b0f005ac55d", "filename": "tests/mir-opt/building/custom/as_cast.int_to_ptr.built.after.mir", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/fddd861a7d00a183548633bfd65d885205ca5cad/tests%2Fmir-opt%2Fbuilding%2Fcustom%2Fas_cast.int_to_ptr.built.after.mir", "raw_url": "https://github.com/rust-lang/rust/raw/fddd861a7d00a183548633bfd65d885205ca5cad/tests%2Fmir-opt%2Fbuilding%2Fcustom%2Fas_cast.int_to_ptr.built.after.mir", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fbuilding%2Fcustom%2Fas_cast.int_to_ptr.built.after.mir?ref=fddd861a7d00a183548633bfd65d885205ca5cad", "patch": "@@ -0,0 +1,10 @@\n+// MIR for `int_to_ptr` after built\n+\n+fn int_to_ptr(_1: usize) -> *const i32 {\n+    let mut _0: *const i32;              // return place in scope 0 at $DIR/as_cast.rs:+0:28: +0:38\n+\n+    bb0: {\n+        _0 = _1 as *const i32 (PointerFromExposedAddress); // scope 0 at $DIR/as_cast.rs:+3:13: +3:34\n+        return;                          // scope 0 at $DIR/as_cast.rs:+4:13: +4:21\n+    }\n+}"}, {"sha": "b4b5ac6aa3b1e1a9759afd261f62815a448e3d45", "filename": "tests/mir-opt/building/custom/as_cast.rs", "status": "added", "additions": 43, "deletions": 0, "changes": 43, "blob_url": "https://github.com/rust-lang/rust/blob/fddd861a7d00a183548633bfd65d885205ca5cad/tests%2Fmir-opt%2Fbuilding%2Fcustom%2Fas_cast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fddd861a7d00a183548633bfd65d885205ca5cad/tests%2Fmir-opt%2Fbuilding%2Fcustom%2Fas_cast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Fbuilding%2Fcustom%2Fas_cast.rs?ref=fddd861a7d00a183548633bfd65d885205ca5cad", "patch": "@@ -0,0 +1,43 @@\n+#![feature(custom_mir, core_intrinsics)]\n+\n+extern crate core;\n+use core::intrinsics::mir::*;\n+\n+// EMIT_MIR as_cast.int_to_int.built.after.mir\n+#[custom_mir(dialect = \"built\")]\n+fn int_to_int(x: u32) -> i32 {\n+    mir!(\n+        {\n+            RET = x as i32;\n+            Return()\n+        }\n+    )\n+}\n+\n+// EMIT_MIR as_cast.float_to_int.built.after.mir\n+#[custom_mir(dialect = \"built\")]\n+fn float_to_int(x: f32) -> i32 {\n+    mir!(\n+        {\n+            RET = x as i32;\n+            Return()\n+        }\n+    )\n+}\n+\n+// EMIT_MIR as_cast.int_to_ptr.built.after.mir\n+#[custom_mir(dialect = \"built\")]\n+fn int_to_ptr(x: usize) -> *const i32 {\n+    mir!(\n+        {\n+            RET = x as *const i32;\n+            Return()\n+        }\n+    )\n+}\n+\n+fn main() {\n+    assert_eq!(int_to_int(5), 5);\n+    assert_eq!(float_to_int(5.), 5);\n+    assert_eq!(int_to_ptr(0), std::ptr::null());\n+}"}]}