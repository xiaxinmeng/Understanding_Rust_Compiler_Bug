{"sha": "f503e539bf60416a731f9ecc12b6aab31ef2fe87", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY1MDNlNTM5YmY2MDQxNmE3MzFmOWVjYzEyYjZhYWIzMWVmMmZlODc=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-07-08T21:34:54Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-07-08T21:34:54Z"}, "message": "auto merge of #7608 : glinscott/rust/json_perf, r=pcwalton\n\nAvoids the overhead of read_char for every character.\r\n\r\nBenchmark reading example.json 10 times from\r\nhttps://code.google.com/p/rapidjson/wiki/Performance\r\n\r\nBefore: 2.55s\r\nAfter:  0.16s\r\n\r\nRegression testing is already done by isrustfastyet.", "tree": {"sha": "c1ff5d04cfd8079d5e500c96ac69305ff56b1411", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c1ff5d04cfd8079d5e500c96ac69305ff56b1411"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f503e539bf60416a731f9ecc12b6aab31ef2fe87", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f503e539bf60416a731f9ecc12b6aab31ef2fe87", "html_url": "https://github.com/rust-lang/rust/commit/f503e539bf60416a731f9ecc12b6aab31ef2fe87", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f503e539bf60416a731f9ecc12b6aab31ef2fe87/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f7b293bc75684a368e20567b5987c482dc5f8550", "url": "https://api.github.com/repos/rust-lang/rust/commits/f7b293bc75684a368e20567b5987c482dc5f8550", "html_url": "https://github.com/rust-lang/rust/commit/f7b293bc75684a368e20567b5987c482dc5f8550"}, {"sha": "149c976aa0b6441b93f2e2140e10e0424d39ea17", "url": "https://api.github.com/repos/rust-lang/rust/commits/149c976aa0b6441b93f2e2140e10e0424d39ea17", "html_url": "https://github.com/rust-lang/rust/commit/149c976aa0b6441b93f2e2140e10e0424d39ea17"}], "stats": {"total": 38, "additions": 30, "deletions": 8}, "files": [{"sha": "67ffd53a0e80497d46619b15f895846592dea7ff", "filename": "src/libextra/json.rs", "status": "modified", "additions": 28, "deletions": 7, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/f503e539bf60416a731f9ecc12b6aab31ef2fe87/src%2Flibextra%2Fjson.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f503e539bf60416a731f9ecc12b6aab31ef2fe87/src%2Flibextra%2Fjson.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibextra%2Fjson.rs?ref=f503e539bf60416a731f9ecc12b6aab31ef2fe87", "patch": "@@ -481,22 +481,30 @@ pub fn to_pretty_str(json: &Json) -> ~str {\n     io::with_str_writer(|wr| to_pretty_writer(wr, json))\n }\n \n+static BUF_SIZE : uint = 64000;\n+\n #[allow(missing_doc)]\n pub struct Parser {\n     priv rdr: @io::Reader,\n+    priv buf: ~[char],\n+    priv buf_idx: uint,\n     priv ch: char,\n     priv line: uint,\n     priv col: uint,\n }\n \n /// Decode a json value from an io::reader\n pub fn Parser(rdr: @io::Reader) -> Parser {\n-    Parser {\n+    let mut p = Parser {\n         rdr: rdr,\n-        ch: rdr.read_char(),\n+        buf: rdr.read_chars(BUF_SIZE),\n+        buf_idx: 0,\n+        ch: 0 as char,\n         line: 1,\n-        col: 1,\n-    }\n+        col: 0,\n+    };\n+    p.bump();\n+    p\n }\n \n impl Parser {\n@@ -521,13 +529,26 @@ impl Parser {\n     fn eof(&self) -> bool { self.ch == -1 as char }\n \n     fn bump(&mut self) {\n-        self.ch = self.rdr.read_char();\n+        if self.eof() {\n+            return;\n+        }\n+\n+        self.col += 1u;\n+\n+        if self.buf_idx >= self.buf.len() {\n+            self.buf = self.rdr.read_chars(BUF_SIZE);\n+            if self.buf.len() == 0 {\n+                self.ch = -1 as char;\n+                return;\n+            }\n+            self.buf_idx = 0;\n+        }\n+        self.ch = self.buf[self.buf_idx];\n+        self.buf_idx += 1;\n \n         if self.ch == '\\n' {\n             self.line += 1u;\n             self.col = 1u;\n-        } else {\n-            self.col += 1u;\n         }\n     }\n "}, {"sha": "47473c2faba65649976f64fff6f2e09144a01f34", "filename": "src/libstd/char.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/f503e539bf60416a731f9ecc12b6aab31ef2fe87/src%2Flibstd%2Fchar.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f503e539bf60416a731f9ecc12b6aab31ef2fe87/src%2Flibstd%2Fchar.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fchar.rs?ref=f503e539bf60416a731f9ecc12b6aab31ef2fe87", "patch": "@@ -82,7 +82,8 @@ pub fn is_uppercase(c: char) -> bool { general_category::Lu(c) }\n ///\n #[inline]\n pub fn is_whitespace(c: char) -> bool {\n-    ('\\x09' <= c && c <= '\\x0d')\n+    c == ' '\n+        || ('\\x09' <= c && c <= '\\x0d')\n         || general_category::Zs(c)\n         || general_category::Zl(c)\n         || general_category::Zp(c)"}]}