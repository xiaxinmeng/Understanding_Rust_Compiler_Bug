{"sha": "53ccee0d389270e7e5ac71660d7b496378abb9ae", "node_id": "C_kwDOAAsO6NoAKDUzY2NlZTBkMzg5MjcwZTdlNWFjNzE2NjBkN2I0OTYzNzhhYmI5YWU", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-01-28T10:11:07Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-01-28T10:11:07Z"}, "message": "Rollup merge of #107096 - clubby789:fluent-bad-messageref, r=compiler-errors\n\nDetect references to non-existant messages in Fluent resources\n\nShould help with cases like #107091, where `{variable}` (a message reference) is accidentally typed, rather than `{$variable}` (a variable reference)\n\nFixes #107370\n\n```@rustbot``` label +A-translation", "tree": {"sha": "ed39383b628b7ad869628ce403676ed290c0c5ff", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ed39383b628b7ad869628ce403676ed290c0c5ff"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/53ccee0d389270e7e5ac71660d7b496378abb9ae", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJj1PS7CRBK7hj4Ov3rIwAA6cAIABhtcyZeYlqWGgE6dUFFZ1M4\nfzpZN7b2fHNeXhAp1cbXp65ZQXI3oRMsb+svDSDEHq1+MY56dSRTJlP3eSRMj6ph\nD8Uc+tefK2yGcdM9THgOvhdF0/ikDStmP1C41vg+xPmfKMKKgx79oMKahc1ZzIJH\nNKh/7zBgdeEpo3T7N57TVoYV4J92JQNVZFSFt7yfeeBSS6rlqZlSTHqBX5TuUiSN\nw/1A3PGbJaS1h6NJuigQRPKHkzoUqzWm8upGMCNyWf6/8CjO31TWbSYmh6xG6Stc\nRYzIkR4Hg5wsbDbT9AZdnBOcaS0G2+EznLjY0C6H3ylABdImiBXxIO8Jl2X8NoI=\n=jjOp\n-----END PGP SIGNATURE-----\n", "payload": "tree ed39383b628b7ad869628ce403676ed290c0c5ff\nparent 45430a5351f9aeaa16c1f6e0d19444be3555f43f\nparent 0ae0d87c5dd7b0b0b17124dadb2d5a3ce7e2bfef\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1674900667 +0100\ncommitter GitHub <noreply@github.com> 1674900667 +0100\n\nRollup merge of #107096 - clubby789:fluent-bad-messageref, r=compiler-errors\n\nDetect references to non-existant messages in Fluent resources\n\nShould help with cases like #107091, where `{variable}` (a message reference) is accidentally typed, rather than `{$variable}` (a variable reference)\n\nFixes #107370\n\n```@rustbot``` label +A-translation\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/53ccee0d389270e7e5ac71660d7b496378abb9ae", "html_url": "https://github.com/rust-lang/rust/commit/53ccee0d389270e7e5ac71660d7b496378abb9ae", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/53ccee0d389270e7e5ac71660d7b496378abb9ae/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "45430a5351f9aeaa16c1f6e0d19444be3555f43f", "url": "https://api.github.com/repos/rust-lang/rust/commits/45430a5351f9aeaa16c1f6e0d19444be3555f43f", "html_url": "https://github.com/rust-lang/rust/commit/45430a5351f9aeaa16c1f6e0d19444be3555f43f"}, {"sha": "0ae0d87c5dd7b0b0b17124dadb2d5a3ce7e2bfef", "url": "https://api.github.com/repos/rust-lang/rust/commits/0ae0d87c5dd7b0b0b17124dadb2d5a3ce7e2bfef", "html_url": "https://github.com/rust-lang/rust/commit/0ae0d87c5dd7b0b0b17124dadb2d5a3ce7e2bfef"}], "stats": {"total": 60, "additions": 54, "deletions": 6}, "files": [{"sha": "6101b28ab0cdde9a42b69834de91ea4bff2d6198", "filename": "compiler/rustc_error_messages/locales/en-US/codegen_gcc.ftl", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/53ccee0d389270e7e5ac71660d7b496378abb9ae/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fcodegen_gcc.ftl", "raw_url": "https://github.com/rust-lang/rust/raw/53ccee0d389270e7e5ac71660d7b496378abb9ae/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fcodegen_gcc.ftl", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fcodegen_gcc.ftl?ref=53ccee0d389270e7e5ac71660d7b496378abb9ae", "patch": "@@ -23,7 +23,7 @@ codegen_gcc_invalid_monomorphization_unsupported_element =\n     invalid monomorphization of `{$name}` intrinsic: unsupported {$name} from `{$in_ty}` with element `{$elem_ty}` to `{$ret_ty}`\n \n codegen_gcc_invalid_monomorphization_invalid_bitmask =\n-    invalid monomorphization of `{$name}` intrinsic: invalid bitmask `{ty}`, expected `u{$expected_int_bits}` or `[u8; {$expected_bytes}]`\n+    invalid monomorphization of `{$name}` intrinsic: invalid bitmask `{$ty}`, expected `u{$expected_int_bits}` or `[u8; {$expected_bytes}]`\n \n codegen_gcc_invalid_monomorphization_simd_shuffle =\n     invalid monomorphization of `{$name}` intrinsic: simd_shuffle index must be an array of `u32`, got `{$ty}`"}, {"sha": "4924105128db6eb1d55afa46efdb612999b7fd5b", "filename": "compiler/rustc_error_messages/locales/en-US/codegen_ssa.ftl", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/53ccee0d389270e7e5ac71660d7b496378abb9ae/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fcodegen_ssa.ftl", "raw_url": "https://github.com/rust-lang/rust/raw/53ccee0d389270e7e5ac71660d7b496378abb9ae/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fcodegen_ssa.ftl", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fcodegen_ssa.ftl?ref=53ccee0d389270e7e5ac71660d7b496378abb9ae", "patch": "@@ -179,9 +179,9 @@ codegen_ssa_extract_bundled_libs_write_file = failed to write file '{$rlib}': {$\n \n codegen_ssa_unsupported_arch = unsupported arch `{$arch}` for os `{$os}`\n \n-codegen_ssa_apple_sdk_error_sdk_path = failed to get {$sdk_name} SDK path: {error}\n+codegen_ssa_apple_sdk_error_sdk_path = failed to get {$sdk_name} SDK path: {$error}\n \n-codegen_ssa_read_file = failed to read file: {message}\n+codegen_ssa_read_file = failed to read file: {$message}\n \n codegen_ssa_unsupported_link_self_contained = option `-C link-self-contained` is not supported on this target\n "}, {"sha": "08098c9bb2a85c5a2c37b7a557e7b91fc5f4a2bc", "filename": "compiler/rustc_macros/src/diagnostics/fluent.rs", "status": "modified", "additions": 32, "deletions": 2, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/53ccee0d389270e7e5ac71660d7b496378abb9ae/compiler%2Frustc_macros%2Fsrc%2Fdiagnostics%2Ffluent.rs", "raw_url": "https://github.com/rust-lang/rust/raw/53ccee0d389270e7e5ac71660d7b496378abb9ae/compiler%2Frustc_macros%2Fsrc%2Fdiagnostics%2Ffluent.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_macros%2Fsrc%2Fdiagnostics%2Ffluent.rs?ref=53ccee0d389270e7e5ac71660d7b496378abb9ae", "patch": "@@ -4,7 +4,10 @@ use annotate_snippets::{\n };\n use fluent_bundle::{FluentBundle, FluentError, FluentResource};\n use fluent_syntax::{\n-    ast::{Attribute, Entry, Identifier, Message},\n+    ast::{\n+        Attribute, Entry, Expression, Identifier, InlineExpression, Message, Pattern,\n+        PatternElement,\n+    },\n     parser::ParserError,\n };\n use proc_macro::{Diagnostic, Level, Span};\n@@ -185,9 +188,12 @@ pub(crate) fn fluent_messages(input: proc_macro::TokenStream) -> proc_macro::Tok\n         };\n \n         let mut constants = TokenStream::new();\n+        let mut messagerefs = Vec::new();\n         for entry in resource.entries() {\n             let span = res.krate.span();\n-            if let Entry::Message(Message { id: Identifier { name }, attributes, .. }) = entry {\n+            if let Entry::Message(Message { id: Identifier { name }, attributes, value, .. }) =\n+                entry\n+            {\n                 let _ = previous_defns.entry(name.to_string()).or_insert(path_span);\n \n                 if name.contains('-') {\n@@ -200,6 +206,18 @@ pub(crate) fn fluent_messages(input: proc_macro::TokenStream) -> proc_macro::Tok\n                     .emit();\n                 }\n \n+                if let Some(Pattern { elements }) = value {\n+                    for elt in elements {\n+                        if let PatternElement::Placeable {\n+                            expression:\n+                                Expression::Inline(InlineExpression::MessageReference { id, .. }),\n+                        } = elt\n+                        {\n+                            messagerefs.push((id.name, *name));\n+                        }\n+                    }\n+                }\n+\n                 // Require that the message name starts with the crate name\n                 // `hir_typeck_foo_bar` (in `hir_typeck.ftl`)\n                 // `const_eval_baz` (in `const_eval.ftl`)\n@@ -258,6 +276,18 @@ pub(crate) fn fluent_messages(input: proc_macro::TokenStream) -> proc_macro::Tok\n             }\n         }\n \n+        for (mref, name) in messagerefs.into_iter() {\n+            if !previous_defns.contains_key(mref) {\n+                Diagnostic::spanned(\n+                    path_span,\n+                    Level::Error,\n+                    format!(\"referenced message `{mref}` does not exist (in message `{name}`)\"),\n+                )\n+                .help(&format!(\"you may have meant to use a variable reference (`{{${mref}}}`)\"))\n+                .emit();\n+            }\n+        }\n+\n         if let Err(errs) = bundle.add_resource(resource) {\n             for e in errs {\n                 match e {"}, {"sha": "0cd8229b23010923dd646848aa61b859014a1c6d", "filename": "tests/ui-fulldeps/fluent-messages/missing-message-ref.ftl", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/53ccee0d389270e7e5ac71660d7b496378abb9ae/tests%2Fui-fulldeps%2Ffluent-messages%2Fmissing-message-ref.ftl", "raw_url": "https://github.com/rust-lang/rust/raw/53ccee0d389270e7e5ac71660d7b496378abb9ae/tests%2Fui-fulldeps%2Ffluent-messages%2Fmissing-message-ref.ftl", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-fulldeps%2Ffluent-messages%2Fmissing-message-ref.ftl?ref=53ccee0d389270e7e5ac71660d7b496378abb9ae", "patch": "@@ -0,0 +1 @@\n+missing_message_ref = {message}"}, {"sha": "74303e97dba947c5b9b1e4605c3566eb865f9eb8", "filename": "tests/ui-fulldeps/fluent-messages/test.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/53ccee0d389270e7e5ac71660d7b496378abb9ae/tests%2Fui-fulldeps%2Ffluent-messages%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/53ccee0d389270e7e5ac71660d7b496378abb9ae/tests%2Fui-fulldeps%2Ffluent-messages%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-fulldeps%2Ffluent-messages%2Ftest.rs?ref=53ccee0d389270e7e5ac71660d7b496378abb9ae", "patch": "@@ -96,3 +96,12 @@ mod missing_crate_name {\n \n     use self::fluent_generated::{DEFAULT_LOCALE_RESOURCES, test_crate_foo, with_hyphens};\n }\n+\n+mod missing_message_ref {\n+    use super::fluent_messages;\n+\n+    fluent_messages! {\n+        missing => \"./missing-message-ref.ftl\"\n+//~^ ERROR referenced message `message` does not exist\n+    }\n+}"}, {"sha": "2631b0a623275a08382774ba415aec60889574f9", "filename": "tests/ui-fulldeps/fluent-messages/test.stderr", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/53ccee0d389270e7e5ac71660d7b496378abb9ae/tests%2Fui-fulldeps%2Ffluent-messages%2Ftest.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/53ccee0d389270e7e5ac71660d7b496378abb9ae/tests%2Fui-fulldeps%2Ffluent-messages%2Ftest.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-fulldeps%2Ffluent-messages%2Ftest.stderr?ref=53ccee0d389270e7e5ac71660d7b496378abb9ae", "patch": "@@ -93,6 +93,14 @@ LL |         test_crate => \"./missing-crate-name.ftl\",\n    |\n    = help: replace any '-'s with '_'s\n \n-error: aborting due to 10 previous errors\n+error: referenced message `message` does not exist (in message `missing_message_ref`)\n+  --> $DIR/test.rs:104:20\n+   |\n+LL |         missing => \"./missing-message-ref.ftl\"\n+   |                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+   = help: you may have meant to use a variable reference (`{$message}`)\n+\n+error: aborting due to 11 previous errors\n \n For more information about this error, try `rustc --explain E0428`."}]}