{"sha": "f1fd4673bc997164efbf0ba30cef01ffba24a43f", "node_id": "C_kwDOAAsO6NoAKGYxZmQ0NjczYmM5OTcxNjRlZmJmMGJhMzBjZWYwMWZmYmEyNGE0M2Y", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-05-26T15:20:21Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-05-26T15:20:21Z"}, "message": "Auto merge of #10813 - y21:issue10755, r=xFrednet\n\n[`default_constructed_unit_structs`]: do not lint on type alias paths\n\nFixes #10755.\n\nType aliases cannot be used as a constructor, so this lint should not trigger in those cases.\nI also changed `clippy_utils::is_ty_alias` to also consider associated types since [they kinda are type aliases too](https://github.com/rust-lang/rust/blob/48ec50ae39d0ca0baa0e78f56c395dcc6d7ebd65/compiler/rustc_resolve/src/late/diagnostics.rs#L1520).\n\nchangelog: [`default_constructed_unit_structs`]: do not lint on type alias paths", "tree": {"sha": "3e25bb771f2c291b523acab5f42061e9ee836775", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3e25bb771f2c291b523acab5f42061e9ee836775"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f1fd4673bc997164efbf0ba30cef01ffba24a43f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f1fd4673bc997164efbf0ba30cef01ffba24a43f", "html_url": "https://github.com/rust-lang/rust/commit/f1fd4673bc997164efbf0ba30cef01ffba24a43f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f1fd4673bc997164efbf0ba30cef01ffba24a43f/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2422594f8c457d0a6870af09922698548e3816a3", "url": "https://api.github.com/repos/rust-lang/rust/commits/2422594f8c457d0a6870af09922698548e3816a3", "html_url": "https://github.com/rust-lang/rust/commit/2422594f8c457d0a6870af09922698548e3816a3"}, {"sha": "8c82486ea92219d1c0c720fc598abac27c81a966", "url": "https://api.github.com/repos/rust-lang/rust/commits/8c82486ea92219d1c0c720fc598abac27c81a966", "html_url": "https://github.com/rust-lang/rust/commit/8c82486ea92219d1c0c720fc598abac27c81a966"}], "stats": {"total": 69, "additions": 62, "deletions": 7}, "files": [{"sha": "fb037bbcbf3eb95c1194512d6e8f87af8c00f807", "filename": "clippy_lints/src/default_constructed_unit_structs.rs", "status": "modified", "additions": 13, "deletions": 2, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/f1fd4673bc997164efbf0ba30cef01ffba24a43f/clippy_lints%2Fsrc%2Fdefault_constructed_unit_structs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f1fd4673bc997164efbf0ba30cef01ffba24a43f/clippy_lints%2Fsrc%2Fdefault_constructed_unit_structs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fdefault_constructed_unit_structs.rs?ref=f1fd4673bc997164efbf0ba30cef01ffba24a43f", "patch": "@@ -1,4 +1,4 @@\n-use clippy_utils::{diagnostics::span_lint_and_sugg, match_def_path, paths};\n+use clippy_utils::{diagnostics::span_lint_and_sugg, is_ty_alias, match_def_path, paths};\n use hir::{def::Res, ExprKind};\n use rustc_errors::Applicability;\n use rustc_hir as hir;\n@@ -43,12 +43,23 @@ declare_clippy_lint! {\n }\n declare_lint_pass!(DefaultConstructedUnitStructs => [DEFAULT_CONSTRUCTED_UNIT_STRUCTS]);\n \n+fn is_alias(ty: hir::Ty<'_>) -> bool {\n+    if let hir::TyKind::Path(ref qpath) = ty.kind {\n+        is_ty_alias(qpath)\n+    } else {\n+        false\n+    }\n+}\n+\n impl LateLintPass<'_> for DefaultConstructedUnitStructs {\n     fn check_expr<'tcx>(&mut self, cx: &LateContext<'tcx>, expr: &'tcx hir::Expr<'tcx>) {\n         if_chain!(\n             // make sure we have a call to `Default::default`\n             if let hir::ExprKind::Call(fn_expr, &[]) = expr.kind;\n-            if let ExprKind::Path(ref qpath@ hir::QPath::TypeRelative(_,_)) = fn_expr.kind;\n+            if let ExprKind::Path(ref qpath @ hir::QPath::TypeRelative(base, _)) = fn_expr.kind;\n+            // make sure this isn't a type alias:\n+            // `<Foo as Bar>::Assoc` cannot be used as a constructor\n+            if !is_alias(*base);\n             if let Res::Def(_, def_id) = cx.qpath_res(qpath, fn_expr.hir_id);\n             if match_def_path(cx, def_id, &paths::DEFAULT_TRAIT_METHOD);\n             // make sure we have a struct with no fields (unit struct)"}, {"sha": "8c883445a798469cee598af28e8bc5ce024df4c0", "filename": "clippy_utils/src/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f1fd4673bc997164efbf0ba30cef01ffba24a43f/clippy_utils%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f1fd4673bc997164efbf0ba30cef01ffba24a43f/clippy_utils%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_utils%2Fsrc%2Flib.rs?ref=f1fd4673bc997164efbf0ba30cef01ffba24a43f", "patch": "@@ -287,7 +287,7 @@ pub fn is_wild(pat: &Pat<'_>) -> bool {\n /// Checks if the given `QPath` belongs to a type alias.\n pub fn is_ty_alias(qpath: &QPath<'_>) -> bool {\n     match *qpath {\n-        QPath::Resolved(_, path) => matches!(path.res, Res::Def(DefKind::TyAlias, ..)),\n+        QPath::Resolved(_, path) => matches!(path.res, Res::Def(DefKind::TyAlias | DefKind::AssocTy, ..)),\n         QPath::TypeRelative(ty, _) if let TyKind::Path(qpath) = ty.kind => { is_ty_alias(&qpath) },\n         _ => false,\n     }"}, {"sha": "ac5fe38ff4439068254b93e79a290d28aad982a5", "filename": "tests/ui/default_constructed_unit_structs.fixed", "status": "modified", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/f1fd4673bc997164efbf0ba30cef01ffba24a43f/tests%2Fui%2Fdefault_constructed_unit_structs.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/f1fd4673bc997164efbf0ba30cef01ffba24a43f/tests%2Fui%2Fdefault_constructed_unit_structs.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fdefault_constructed_unit_structs.fixed?ref=f1fd4673bc997164efbf0ba30cef01ffba24a43f", "patch": "@@ -101,6 +101,28 @@ struct EmptyStruct {}\n #[non_exhaustive]\n struct NonExhaustiveStruct;\n \n+mod issue_10755 {\n+    struct Sqlite {}\n+\n+    trait HasArguments<'q> {\n+        type Arguments;\n+    }\n+\n+    impl<'q> HasArguments<'q> for Sqlite {\n+        type Arguments = std::marker::PhantomData<&'q ()>;\n+    }\n+\n+    type SqliteArguments<'q> = <Sqlite as HasArguments<'q>>::Arguments;\n+\n+    fn foo() {\n+        // should not lint\n+        // type alias cannot be used as a constructor\n+        let _ = <Sqlite as HasArguments>::Arguments::default();\n+\n+        let _ = SqliteArguments::default();\n+    }\n+}\n+\n fn main() {\n     // should lint\n     let _ = PhantomData::<usize>;"}, {"sha": "de7f14ffbd95c393a8ebca68b3ab020adb9b511e", "filename": "tests/ui/default_constructed_unit_structs.rs", "status": "modified", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/f1fd4673bc997164efbf0ba30cef01ffba24a43f/tests%2Fui%2Fdefault_constructed_unit_structs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f1fd4673bc997164efbf0ba30cef01ffba24a43f/tests%2Fui%2Fdefault_constructed_unit_structs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fdefault_constructed_unit_structs.rs?ref=f1fd4673bc997164efbf0ba30cef01ffba24a43f", "patch": "@@ -101,6 +101,28 @@ struct EmptyStruct {}\n #[non_exhaustive]\n struct NonExhaustiveStruct;\n \n+mod issue_10755 {\n+    struct Sqlite {}\n+\n+    trait HasArguments<'q> {\n+        type Arguments;\n+    }\n+\n+    impl<'q> HasArguments<'q> for Sqlite {\n+        type Arguments = std::marker::PhantomData<&'q ()>;\n+    }\n+\n+    type SqliteArguments<'q> = <Sqlite as HasArguments<'q>>::Arguments;\n+\n+    fn foo() {\n+        // should not lint\n+        // type alias cannot be used as a constructor\n+        let _ = <Sqlite as HasArguments>::Arguments::default();\n+\n+        let _ = SqliteArguments::default();\n+    }\n+}\n+\n fn main() {\n     // should lint\n     let _ = PhantomData::<usize>::default();"}, {"sha": "13abb9149da246b853a6466181b9223fa78891c2", "filename": "tests/ui/default_constructed_unit_structs.stderr", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/f1fd4673bc997164efbf0ba30cef01ffba24a43f/tests%2Fui%2Fdefault_constructed_unit_structs.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/f1fd4673bc997164efbf0ba30cef01ffba24a43f/tests%2Fui%2Fdefault_constructed_unit_structs.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fdefault_constructed_unit_structs.stderr?ref=f1fd4673bc997164efbf0ba30cef01ffba24a43f", "patch": "@@ -13,25 +13,25 @@ LL |             inner: PhantomData::default(),\n    |                               ^^^^^^^^^^^ help: remove this call to `default`\n \n error: use of `default` to create a unit struct\n-  --> $DIR/default_constructed_unit_structs.rs:106:33\n+  --> $DIR/default_constructed_unit_structs.rs:128:33\n    |\n LL |     let _ = PhantomData::<usize>::default();\n    |                                 ^^^^^^^^^^^ help: remove this call to `default`\n \n error: use of `default` to create a unit struct\n-  --> $DIR/default_constructed_unit_structs.rs:107:42\n+  --> $DIR/default_constructed_unit_structs.rs:129:42\n    |\n LL |     let _: PhantomData<i32> = PhantomData::default();\n    |                                          ^^^^^^^^^^^ help: remove this call to `default`\n \n error: use of `default` to create a unit struct\n-  --> $DIR/default_constructed_unit_structs.rs:108:55\n+  --> $DIR/default_constructed_unit_structs.rs:130:55\n    |\n LL |     let _: PhantomData<i32> = std::marker::PhantomData::default();\n    |                                                       ^^^^^^^^^^^ help: remove this call to `default`\n \n error: use of `default` to create a unit struct\n-  --> $DIR/default_constructed_unit_structs.rs:109:23\n+  --> $DIR/default_constructed_unit_structs.rs:131:23\n    |\n LL |     let _ = UnitStruct::default();\n    |                       ^^^^^^^^^^^ help: remove this call to `default`"}]}