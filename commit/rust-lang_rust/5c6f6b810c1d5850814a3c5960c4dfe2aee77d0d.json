{"sha": "5c6f6b810c1d5850814a3c5960c4dfe2aee77d0d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjVjNmY2YjgxMGMxZDU4NTA4MTRhM2M1OTYwYzRkZmUyYWVlNzdkMGQ=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-06-08T17:44:12Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-06-08T17:44:12Z"}, "message": "Auto merge of #61655 - RalfJung:checktools, r=kennytm\n\nchecktools: unify grepping the TOOLSTATE file\n\nThe file was grepped twice but in a different way. This unifies the code to make sure it is consistent. Or were these deliberately not doing the same thing? That seems strange though.\n\nI wouldn't know how to test these changes.", "tree": {"sha": "1d3280e7afdf1e969a655d337522c9d5de8c36f4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1d3280e7afdf1e969a655d337522c9d5de8c36f4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5c6f6b810c1d5850814a3c5960c4dfe2aee77d0d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5c6f6b810c1d5850814a3c5960c4dfe2aee77d0d", "html_url": "https://github.com/rust-lang/rust/commit/5c6f6b810c1d5850814a3c5960c4dfe2aee77d0d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5c6f6b810c1d5850814a3c5960c4dfe2aee77d0d/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5c45343f11fbf93cf4e15568aee3ff3f2f287466", "url": "https://api.github.com/repos/rust-lang/rust/commits/5c45343f11fbf93cf4e15568aee3ff3f2f287466", "html_url": "https://github.com/rust-lang/rust/commit/5c45343f11fbf93cf4e15568aee3ff3f2f287466"}, {"sha": "fea10c435d70ce1b04885f88b8abc776f22aa2af", "url": "https://api.github.com/repos/rust-lang/rust/commits/fea10c435d70ce1b04885f88b8abc776f22aa2af", "html_url": "https://github.com/rust-lang/rust/commit/fea10c435d70ce1b04885f88b8abc776f22aa2af"}], "stats": {"total": 13, "additions": 10, "deletions": 3}, "files": [{"sha": "978732e3c089f2b5b19eed0cc8794edc5e45f478", "filename": "src/ci/docker/x86_64-gnu-tools/checktools.sh", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/5c6f6b810c1d5850814a3c5960c4dfe2aee77d0d/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2Fchecktools.sh", "raw_url": "https://github.com/rust-lang/rust/raw/5c6f6b810c1d5850814a3c5960c4dfe2aee77d0d/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2Fchecktools.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fx86_64-gnu-tools%2Fchecktools.sh?ref=5c6f6b810c1d5850814a3c5960c4dfe2aee77d0d", "patch": "@@ -35,12 +35,17 @@ set -e\n cat \"$TOOLSTATE_FILE\"\n echo\n \n+# This function checks if a particular tool is *not* in status \"test-pass\".\n+check_tool_failed() {\n+    grep -vq '\"'\"$1\"'\":\"test-pass\"' \"$TOOLSTATE_FILE\"\n+}\n+\n # This function checks that if a tool's submodule changed, the tool's state must improve\n verify_status() {\n     echo \"Verifying status of $1...\"\n     if echo \"$CHANGED_FILES\" | grep -q \"^M[[:blank:]]$2$\"; then\n         echo \"This PR updated '$2', verifying if status is 'test-pass'...\"\n-        if grep -vq '\"'\"$1\"'\":\"test-pass\"' \"$TOOLSTATE_FILE\"; then\n+        if check_tool_failed \"$1\"; then\n             echo\n             echo \"\u26a0\ufe0f We detected that this PR updated '$1', but its tests failed.\"\n             echo\n@@ -55,14 +60,16 @@ verify_status() {\n     fi\n }\n \n-# deduplicates the submodule check and the assertion that on beta some tools MUST be passing\n+# deduplicates the submodule check and the assertion that on beta some tools MUST be passing.\n+# $1 should be \"submodule_changed\" to only check tools that got changed by this PR,\n+# or \"beta_required\" to check all tools that have $2 set to \"beta\".\n check_dispatch() {\n     if [ \"$1\" = submodule_changed ]; then\n         # ignore $2 (branch id)\n         verify_status $3 $4\n     elif [ \"$2\" = beta ]; then\n         echo \"Requiring test passing for $3...\"\n-        if grep -q '\"'\"$3\"'\":\"\\(test\\|build\\)-fail\"' \"$TOOLSTATE_FILE\"; then\n+        if check_tool_failed \"$3\"; then\n             exit 4\n         fi\n     fi"}]}