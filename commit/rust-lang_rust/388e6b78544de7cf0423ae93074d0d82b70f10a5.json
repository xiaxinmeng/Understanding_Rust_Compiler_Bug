{"sha": "388e6b78544de7cf0423ae93074d0d82b70f10a5", "node_id": "C_kwDOAAsO6NoAKDM4OGU2Yjc4NTQ0ZGU3Y2YwNDIzYWU5MzA3NGQwZDgyYjcwZjEwYTU", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-04-24T20:16:40Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-04-24T20:16:40Z"}, "message": "Auto merge of #8742 - goth-turtle:mistyped-literal-suffix, r=llogiq\n\nmistyped_literal_suffix: improve integer suggestions, avoid wrong float suggestions\n\nThis PR fixes 2 things:\n- The known problem that integer types are always suggested as signed, by suggesting an unsigned suffix for literals that wouldnt fit in the signed type, and ignores any literals too big for the corresponding unsigned type too.\n- The lint would only look at the integer part of any floating point literals without an exponent, this causing #6129. This just ignores those literals.\n\nExamples:\n```rust\nlet _ = 2_32; // still 2_i32\nlet _ = 234_8; // would now suggest 234_u8\n\n// these are now ignored\nlet _ = 500_8;\nlet _ = 123_32.123;\n```\n\nchangelog: suggest correct integer types in [`mistyped_literal_suffix`], ignore float literals without an exponent\nfixes #6129", "tree": {"sha": "1c6db1cc77b95f88cf4aa4a029be830cca3e0520", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1c6db1cc77b95f88cf4aa4a029be830cca3e0520"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/388e6b78544de7cf0423ae93074d0d82b70f10a5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/388e6b78544de7cf0423ae93074d0d82b70f10a5", "html_url": "https://github.com/rust-lang/rust/commit/388e6b78544de7cf0423ae93074d0d82b70f10a5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/388e6b78544de7cf0423ae93074d0d82b70f10a5/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6aa3684431e85609eab1168098915afcb4e20d65", "url": "https://api.github.com/repos/rust-lang/rust/commits/6aa3684431e85609eab1168098915afcb4e20d65", "html_url": "https://github.com/rust-lang/rust/commit/6aa3684431e85609eab1168098915afcb4e20d65"}, {"sha": "b4a50e9ee5adda55ad68b0dc637433fa0936e10e", "url": "https://api.github.com/repos/rust-lang/rust/commits/b4a50e9ee5adda55ad68b0dc637433fa0936e10e", "html_url": "https://github.com/rust-lang/rust/commit/b4a50e9ee5adda55ad68b0dc637433fa0936e10e"}], "stats": {"total": 136, "additions": 109, "deletions": 27}, "files": [{"sha": "269d3c62eafcd5d0e9692f80bfb27a250cbbc0d3", "filename": "clippy_lints/src/literal_representation.rs", "status": "modified", "additions": 37, "deletions": 13, "changes": 50, "blob_url": "https://github.com/rust-lang/rust/blob/388e6b78544de7cf0423ae93074d0d82b70f10a5/clippy_lints%2Fsrc%2Fliteral_representation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/388e6b78544de7cf0423ae93074d0d82b70f10a5/clippy_lints%2Fsrc%2Fliteral_representation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fliteral_representation.rs?ref=388e6b78544de7cf0423ae93074d0d82b70f10a5", "patch": "@@ -42,17 +42,12 @@ declare_clippy_lint! {\n     /// This is most probably a typo\n     ///\n     /// ### Known problems\n-    /// - Recommends a signed suffix, even though the number might be too big and an unsigned\n-    ///   suffix is required\n+    /// - Does not match on integers too large to fit in the corresponding unsigned type\n     /// - Does not match on `_127` since that is a valid grouping for decimal and octal numbers\n     ///\n     /// ### Example\n-    /// ```rust\n-    /// // Probably mistyped\n-    /// 2_32;\n-    ///\n-    /// // Good\n-    /// 2_i32;\n+    /// `2_32` => `2_i32`\n+    /// `250_8 => `250_u8`\n     /// ```\n     #[clippy::version = \"1.30.0\"]\n     pub MISTYPED_LITERAL_SUFFIXES,\n@@ -310,18 +305,47 @@ impl LiteralDigitGrouping {\n             return true;\n         }\n \n-        let (part, mistyped_suffixes, missing_char) = if let Some((_, exponent)) = &mut num_lit.exponent {\n-            (exponent, &[\"32\", \"64\"][..], 'f')\n+        let (part, mistyped_suffixes, is_float) = if let Some((_, exponent)) = &mut num_lit.exponent {\n+            (exponent, &[\"32\", \"64\"][..], true)\n         } else if num_lit.fraction.is_some() {\n-            (&mut num_lit.integer, &[\"32\", \"64\"][..], 'f')\n+            return true;\n         } else {\n-            (&mut num_lit.integer, &[\"8\", \"16\", \"32\", \"64\"][..], 'i')\n+            (&mut num_lit.integer, &[\"8\", \"16\", \"32\", \"64\"][..], false)\n         };\n \n         let mut split = part.rsplit('_');\n         let last_group = split.next().expect(\"At least one group\");\n         if split.next().is_some() && mistyped_suffixes.contains(&last_group) {\n-            *part = &part[..part.len() - last_group.len()];\n+            let main_part = &part[..part.len() - last_group.len()];\n+            let missing_char;\n+            if is_float {\n+                missing_char = 'f';\n+            } else {\n+                let radix = match num_lit.radix {\n+                    Radix::Binary => 2,\n+                    Radix::Octal => 8,\n+                    Radix::Decimal => 10,\n+                    Radix::Hexadecimal => 16,\n+                };\n+                if let Ok(int) = u64::from_str_radix(&main_part.replace('_', \"\"), radix) {\n+                    missing_char = match (last_group, int) {\n+                        (\"8\", i) if i8::try_from(i).is_ok() => 'i',\n+                        (\"16\", i) if i16::try_from(i).is_ok() => 'i',\n+                        (\"32\", i) if i32::try_from(i).is_ok() => 'i',\n+                        (\"64\", i) if i64::try_from(i).is_ok() => 'i',\n+                        (\"8\", u) if u8::try_from(u).is_ok() => 'u',\n+                        (\"16\", u) if u16::try_from(u).is_ok() => 'u',\n+                        (\"32\", u) if u32::try_from(u).is_ok() => 'u',\n+                        (\"64\", _) => 'u',\n+                        _ => {\n+                            return true;\n+                        },\n+                    }\n+                } else {\n+                    return true;\n+                }\n+            }\n+            *part = main_part;\n             let mut sugg = num_lit.format();\n             sugg.push('_');\n             sugg.push(missing_char);"}, {"sha": "a7b36d53cd26c7cc1011553d0a1ceb2fd88268ae", "filename": "tests/ui/mistyped_literal_suffix.fixed", "status": "modified", "additions": 15, "deletions": 1, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/388e6b78544de7cf0423ae93074d0d82b70f10a5/tests%2Fui%2Fmistyped_literal_suffix.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/388e6b78544de7cf0423ae93074d0d82b70f10a5/tests%2Fui%2Fmistyped_literal_suffix.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmistyped_literal_suffix.fixed?ref=388e6b78544de7cf0423ae93074d0d82b70f10a5", "patch": "@@ -5,7 +5,8 @@\n     unused_variables,\n     overflowing_literals,\n     clippy::excessive_precision,\n-    clippy::inconsistent_digit_grouping\n+    clippy::inconsistent_digit_grouping,\n+    clippy::unusual_byte_groupings\n )]\n \n fn main() {\n@@ -25,5 +26,18 @@ fn main() {\n     let fail28 = 241_251_235E723_f64;\n     let ok29 = 42279.911_32;\n \n+    // testing that the suggestion actually fits in its type\n+    let fail30 = 127_i8; // should be i8\n+    let fail31 = 240_u8; // should be u8\n+    let ok32 = 360_8; // doesnt fit in either, should be ignored\n+    let fail33 = 0x1234_i16;\n+    let fail34 = 0xABCD_u16;\n+    let ok35 = 0x12345_16;\n+    let fail36 = 0xFFFF_FFFF_FFFF_FFFF_u64; // u64\n+\n+    // issue #6129\n+    let ok37 = 123_32.123;\n+    let ok38 = 124_64.0;\n+\n     let _ = 1.123_45E1_f32;\n }"}, {"sha": "c97b31965c75a7c4cd1f3030dccd3b042f23fd7c", "filename": "tests/ui/mistyped_literal_suffix.rs", "status": "modified", "additions": 15, "deletions": 1, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/388e6b78544de7cf0423ae93074d0d82b70f10a5/tests%2Fui%2Fmistyped_literal_suffix.rs", "raw_url": "https://github.com/rust-lang/rust/raw/388e6b78544de7cf0423ae93074d0d82b70f10a5/tests%2Fui%2Fmistyped_literal_suffix.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmistyped_literal_suffix.rs?ref=388e6b78544de7cf0423ae93074d0d82b70f10a5", "patch": "@@ -5,7 +5,8 @@\n     unused_variables,\n     overflowing_literals,\n     clippy::excessive_precision,\n-    clippy::inconsistent_digit_grouping\n+    clippy::inconsistent_digit_grouping,\n+    clippy::unusual_byte_groupings\n )]\n \n fn main() {\n@@ -25,5 +26,18 @@ fn main() {\n     let fail28 = 241251235E723_64;\n     let ok29 = 42279.911_32;\n \n+    // testing that the suggestion actually fits in its type\n+    let fail30 = 127_8; // should be i8\n+    let fail31 = 240_8; // should be u8\n+    let ok32 = 360_8; // doesnt fit in either, should be ignored\n+    let fail33 = 0x1234_16;\n+    let fail34 = 0xABCD_16;\n+    let ok35 = 0x12345_16;\n+    let fail36 = 0xFFFF_FFFF_FFFF_FFFF_64; // u64\n+\n+    // issue #6129\n+    let ok37 = 123_32.123;\n+    let ok38 = 124_64.0;\n+\n     let _ = 1.12345E1_32;\n }"}, {"sha": "fb761d9bde45255085e56a861d791d370516c251", "filename": "tests/ui/mistyped_literal_suffix.stderr", "status": "modified", "additions": 42, "deletions": 12, "changes": 54, "blob_url": "https://github.com/rust-lang/rust/blob/388e6b78544de7cf0423ae93074d0d82b70f10a5/tests%2Fui%2Fmistyped_literal_suffix.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/388e6b78544de7cf0423ae93074d0d82b70f10a5/tests%2Fui%2Fmistyped_literal_suffix.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmistyped_literal_suffix.stderr?ref=388e6b78544de7cf0423ae93074d0d82b70f10a5", "patch": "@@ -1,70 +1,100 @@\n error: mistyped literal suffix\n-  --> $DIR/mistyped_literal_suffix.rs:12:18\n+  --> $DIR/mistyped_literal_suffix.rs:13:18\n    |\n LL |     let fail14 = 2_32;\n    |                  ^^^^ help: did you mean to write: `2_i32`\n    |\n    = note: `#[deny(clippy::mistyped_literal_suffixes)]` on by default\n \n error: mistyped literal suffix\n-  --> $DIR/mistyped_literal_suffix.rs:13:18\n+  --> $DIR/mistyped_literal_suffix.rs:14:18\n    |\n LL |     let fail15 = 4_64;\n    |                  ^^^^ help: did you mean to write: `4_i64`\n \n error: mistyped literal suffix\n-  --> $DIR/mistyped_literal_suffix.rs:14:18\n+  --> $DIR/mistyped_literal_suffix.rs:15:18\n    |\n LL |     let fail16 = 7_8; //\n    |                  ^^^ help: did you mean to write: `7_i8`\n \n error: mistyped literal suffix\n-  --> $DIR/mistyped_literal_suffix.rs:15:18\n+  --> $DIR/mistyped_literal_suffix.rs:16:18\n    |\n LL |     let fail17 = 23_16; //\n    |                  ^^^^^ help: did you mean to write: `23_i16`\n \n error: mistyped literal suffix\n-  --> $DIR/mistyped_literal_suffix.rs:18:18\n+  --> $DIR/mistyped_literal_suffix.rs:19:18\n    |\n LL |     let fail20 = 2__8; //\n    |                  ^^^^ help: did you mean to write: `2_i8`\n \n error: mistyped literal suffix\n-  --> $DIR/mistyped_literal_suffix.rs:19:18\n+  --> $DIR/mistyped_literal_suffix.rs:20:18\n    |\n LL |     let fail21 = 4___16; //\n    |                  ^^^^^^ help: did you mean to write: `4_i16`\n \n error: mistyped literal suffix\n-  --> $DIR/mistyped_literal_suffix.rs:22:18\n+  --> $DIR/mistyped_literal_suffix.rs:23:18\n    |\n LL |     let fail25 = 1E2_32;\n    |                  ^^^^^^ help: did you mean to write: `1E2_f32`\n \n error: mistyped literal suffix\n-  --> $DIR/mistyped_literal_suffix.rs:23:18\n+  --> $DIR/mistyped_literal_suffix.rs:24:18\n    |\n LL |     let fail26 = 43E7_64;\n    |                  ^^^^^^^ help: did you mean to write: `43E7_f64`\n \n error: mistyped literal suffix\n-  --> $DIR/mistyped_literal_suffix.rs:24:18\n+  --> $DIR/mistyped_literal_suffix.rs:25:18\n    |\n LL |     let fail27 = 243E17_32;\n    |                  ^^^^^^^^^ help: did you mean to write: `243E17_f32`\n \n error: mistyped literal suffix\n-  --> $DIR/mistyped_literal_suffix.rs:25:18\n+  --> $DIR/mistyped_literal_suffix.rs:26:18\n    |\n LL |     let fail28 = 241251235E723_64;\n    |                  ^^^^^^^^^^^^^^^^ help: did you mean to write: `241_251_235E723_f64`\n \n error: mistyped literal suffix\n-  --> $DIR/mistyped_literal_suffix.rs:28:13\n+  --> $DIR/mistyped_literal_suffix.rs:30:18\n+   |\n+LL |     let fail30 = 127_8; // should be i8\n+   |                  ^^^^^ help: did you mean to write: `127_i8`\n+\n+error: mistyped literal suffix\n+  --> $DIR/mistyped_literal_suffix.rs:31:18\n+   |\n+LL |     let fail31 = 240_8; // should be u8\n+   |                  ^^^^^ help: did you mean to write: `240_u8`\n+\n+error: mistyped literal suffix\n+  --> $DIR/mistyped_literal_suffix.rs:33:18\n+   |\n+LL |     let fail33 = 0x1234_16;\n+   |                  ^^^^^^^^^ help: did you mean to write: `0x1234_i16`\n+\n+error: mistyped literal suffix\n+  --> $DIR/mistyped_literal_suffix.rs:34:18\n+   |\n+LL |     let fail34 = 0xABCD_16;\n+   |                  ^^^^^^^^^ help: did you mean to write: `0xABCD_u16`\n+\n+error: mistyped literal suffix\n+  --> $DIR/mistyped_literal_suffix.rs:36:18\n+   |\n+LL |     let fail36 = 0xFFFF_FFFF_FFFF_FFFF_64; // u64\n+   |                  ^^^^^^^^^^^^^^^^^^^^^^^^ help: did you mean to write: `0xFFFF_FFFF_FFFF_FFFF_u64`\n+\n+error: mistyped literal suffix\n+  --> $DIR/mistyped_literal_suffix.rs:42:13\n    |\n LL |     let _ = 1.12345E1_32;\n    |             ^^^^^^^^^^^^ help: did you mean to write: `1.123_45E1_f32`\n \n-error: aborting due to 11 previous errors\n+error: aborting due to 16 previous errors\n "}]}