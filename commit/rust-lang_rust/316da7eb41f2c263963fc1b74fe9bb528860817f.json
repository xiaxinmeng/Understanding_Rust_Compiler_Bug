{"sha": "316da7eb41f2c263963fc1b74fe9bb528860817f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjMxNmRhN2ViNDFmMmMyNjM5NjNmYzFiNzRmZTliYjUyODg2MDgxN2Y=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-07-07T02:25:07Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-07-07T02:25:07Z"}, "message": "Auto merge of #4258 - mikerite:fix-breakage-20190706, r=Manishearth\n\nFix breakage due to rust-lang/rust#61988\n\nchangelog: none", "tree": {"sha": "136a1575061ff916eb9ba2f203b28cbdcf5a2eff", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/136a1575061ff916eb9ba2f203b28cbdcf5a2eff"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/316da7eb41f2c263963fc1b74fe9bb528860817f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/316da7eb41f2c263963fc1b74fe9bb528860817f", "html_url": "https://github.com/rust-lang/rust/commit/316da7eb41f2c263963fc1b74fe9bb528860817f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/316da7eb41f2c263963fc1b74fe9bb528860817f/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5d7f6a10aecca6fda575c6168775b664e0fa8fde", "url": "https://api.github.com/repos/rust-lang/rust/commits/5d7f6a10aecca6fda575c6168775b664e0fa8fde", "html_url": "https://github.com/rust-lang/rust/commit/5d7f6a10aecca6fda575c6168775b664e0fa8fde"}, {"sha": "c72be0f65a20c02dde25be66fa0a78c755a55530", "url": "https://api.github.com/repos/rust-lang/rust/commits/c72be0f65a20c02dde25be66fa0a78c755a55530", "html_url": "https://github.com/rust-lang/rust/commit/c72be0f65a20c02dde25be66fa0a78c755a55530"}], "stats": {"total": 91, "additions": 31, "deletions": 60}, "files": [{"sha": "02074c79b41e4f509085f186bddebfc1bc4023aa", "filename": "clippy_lints/src/loops.rs", "status": "modified", "additions": 11, "deletions": 24, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/316da7eb41f2c263963fc1b74fe9bb528860817f/clippy_lints%2Fsrc%2Floops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/316da7eb41f2c263963fc1b74fe9bb528860817f/clippy_lints%2Fsrc%2Floops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Floops.rs?ref=316da7eb41f2c263963fc1b74fe9bb528860817f", "patch": "@@ -481,16 +481,11 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for Loops {\n         }\n \n         // check for never_loop\n-        match expr.node {\n-            ExprKind::While(_, ref block, _) | ExprKind::Loop(ref block, _, _) => {\n-                match never_loop_block(block, expr.hir_id) {\n-                    NeverLoopResult::AlwaysBreak => {\n-                        span_lint(cx, NEVER_LOOP, expr.span, \"this loop never actually loops\")\n-                    },\n-                    NeverLoopResult::MayContinueMainLoop | NeverLoopResult::Otherwise => (),\n-                }\n-            },\n-            _ => (),\n+        if let ExprKind::Loop(ref block, _, _) = expr.node {\n+            match never_loop_block(block, expr.hir_id) {\n+                NeverLoopResult::AlwaysBreak => span_lint(cx, NEVER_LOOP, expr.span, \"this loop never actually loops\"),\n+                NeverLoopResult::MayContinueMainLoop | NeverLoopResult::Otherwise => (),\n+            }\n         }\n \n         // check for `loop { if let {} else break }` that could be `while let`\n@@ -590,9 +585,8 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for Loops {\n             }\n         }\n \n-        // check for while loops which conditions never change\n-        if let ExprKind::While(ref cond, _, _) = expr.node {\n-            check_infinite_loop(cx, cond, expr);\n+        if let Some((cond, body)) = higher::while_loop(&expr) {\n+            check_infinite_loop(cx, cond, body);\n         }\n \n         check_needless_collect(expr, cx);\n@@ -701,12 +695,6 @@ fn never_loop_expr(expr: &Expr, main_loop_id: HirId) -> NeverLoopResult {\n             // Break can come from the inner loop so remove them.\n             absorb_break(&never_loop_block(b, main_loop_id))\n         },\n-        ExprKind::While(ref e, ref b, _) => {\n-            let e = never_loop_expr(e, main_loop_id);\n-            let result = never_loop_block(b, main_loop_id);\n-            // Break can come from the inner loop so remove them.\n-            combine_seq(e, absorb_break(&result))\n-        },\n         ExprKind::Match(ref e, ref arms, _) => {\n             let e = never_loop_expr(e, main_loop_id);\n             if arms.is_empty() {\n@@ -2202,7 +2190,7 @@ fn var_def_id(cx: &LateContext<'_, '_>, expr: &Expr) -> Option<HirId> {\n \n fn is_loop(expr: &Expr) -> bool {\n     match expr.node {\n-        ExprKind::Loop(..) | ExprKind::While(..) => true,\n+        ExprKind::Loop(..) => true,\n         _ => false,\n     }\n }\n@@ -2239,11 +2227,10 @@ fn is_loop_nested(cx: &LateContext<'_, '_>, loop_expr: &Expr, iter_expr: &Expr)\n             return false;\n         }\n         match cx.tcx.hir().find(parent) {\n-            Some(Node::Expr(expr)) => match expr.node {\n-                ExprKind::Loop(..) | ExprKind::While(..) => {\n+            Some(Node::Expr(expr)) => {\n+                if let ExprKind::Loop(..) = expr.node {\n                     return true;\n-                },\n-                _ => (),\n+                };\n             },\n             Some(Node::Block(block)) => {\n                 let mut block_visitor = LoopNestVisitor {"}, {"sha": "c75e33e8406ca0bf725d05acd506f9aa3a533046", "filename": "clippy_lints/src/shadow.rs", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/316da7eb41f2c263963fc1b74fe9bb528860817f/clippy_lints%2Fsrc%2Fshadow.rs", "raw_url": "https://github.com/rust-lang/rust/raw/316da7eb41f2c263963fc1b74fe9bb528860817f/clippy_lints%2Fsrc%2Fshadow.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fshadow.rs?ref=316da7eb41f2c263963fc1b74fe9bb528860817f", "patch": "@@ -319,10 +319,6 @@ fn check_expr<'a, 'tcx>(cx: &LateContext<'a, 'tcx>, expr: &'tcx Expr, bindings:\n                 check_expr(cx, e, bindings)\n             }\n         },\n-        ExprKind::While(ref cond, ref block, _) => {\n-            check_expr(cx, cond, bindings);\n-            check_block(cx, block, bindings);\n-        },\n         ExprKind::Match(ref init, ref arms, _) => {\n             check_expr(cx, init, bindings);\n             let len = bindings.len();"}, {"sha": "9c02c1c31042abf6f5ffad5293d6ee29fe5877d6", "filename": "clippy_lints/src/unused_label.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/316da7eb41f2c263963fc1b74fe9bb528860817f/clippy_lints%2Fsrc%2Funused_label.rs", "raw_url": "https://github.com/rust-lang/rust/raw/316da7eb41f2c263963fc1b74fe9bb528860817f/clippy_lints%2Fsrc%2Funused_label.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Funused_label.rs?ref=316da7eb41f2c263963fc1b74fe9bb528860817f", "patch": "@@ -68,7 +68,7 @@ impl<'a, 'tcx> Visitor<'tcx> for UnusedLabelVisitor<'a, 'tcx> {\n                     self.labels.remove(&label.ident.as_str());\n                 }\n             },\n-            hir::ExprKind::Loop(_, Some(label), _) | hir::ExprKind::While(_, _, Some(label)) => {\n+            hir::ExprKind::Loop(_, Some(label), _) => {\n                 self.labels.insert(label.ident.as_str(), expr.span);\n             },\n             _ => (),"}, {"sha": "f419338097d2bd2af31b5e0aa49c10dbb1d93c93", "filename": "clippy_lints/src/utils/author.rs", "status": "modified", "additions": 2, "deletions": 13, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/316da7eb41f2c263963fc1b74fe9bb528860817f/clippy_lints%2Fsrc%2Futils%2Fauthor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/316da7eb41f2c263963fc1b74fe9bb528860817f/clippy_lints%2Fsrc%2Futils%2Fauthor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Futils%2Fauthor.rs?ref=316da7eb41f2c263963fc1b74fe9bb528860817f", "patch": "@@ -322,19 +322,6 @@ impl<'tcx> Visitor<'tcx> for PrintVisitor {\n                 self.current = cast_pat;\n                 self.visit_expr(expr);\n             },\n-            ExprKind::While(ref cond, ref body, _) => {\n-                let cond_pat = self.next(\"cond\");\n-                let body_pat = self.next(\"body\");\n-                let label_pat = self.next(\"label\");\n-                println!(\n-                    \"While(ref {}, ref {}, ref {}) = {};\",\n-                    cond_pat, body_pat, label_pat, current\n-                );\n-                self.current = cond_pat;\n-                self.visit_expr(cond);\n-                self.current = body_pat;\n-                self.visit_block(body);\n-            },\n             ExprKind::Loop(ref body, _, desugaring) => {\n                 let body_pat = self.next(\"body\");\n                 let des = loop_desugaring_name(desugaring);\n@@ -696,6 +683,7 @@ fn desugaring_name(des: hir::MatchSource) -> String {\n     match des {\n         hir::MatchSource::ForLoopDesugar => \"MatchSource::ForLoopDesugar\".to_string(),\n         hir::MatchSource::TryDesugar => \"MatchSource::TryDesugar\".to_string(),\n+        hir::MatchSource::WhileDesugar => \"MatchSource::WhileDesugar\".to_string(),\n         hir::MatchSource::WhileLetDesugar => \"MatchSource::WhileLetDesugar\".to_string(),\n         hir::MatchSource::Normal => \"MatchSource::Normal\".to_string(),\n         hir::MatchSource::IfLetDesugar { contains_else_clause } => format!(\n@@ -714,6 +702,7 @@ fn loop_desugaring_name(des: hir::LoopSource) -> &'static str {\n     match des {\n         hir::LoopSource::ForLoop => \"LoopSource::ForLoop\",\n         hir::LoopSource::Loop => \"LoopSource::Loop\",\n+        hir::LoopSource::While => \"LoopSource::While\",\n         hir::LoopSource::WhileLet => \"LoopSource::WhileLet\",\n     }\n }"}, {"sha": "6fb2a3622c603e1efcde4394a659d85f29469d63", "filename": "clippy_lints/src/utils/higher.rs", "status": "modified", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/316da7eb41f2c263963fc1b74fe9bb528860817f/clippy_lints%2Fsrc%2Futils%2Fhigher.rs", "raw_url": "https://github.com/rust-lang/rust/raw/316da7eb41f2c263963fc1b74fe9bb528860817f/clippy_lints%2Fsrc%2Futils%2Fhigher.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Futils%2Fhigher.rs?ref=316da7eb41f2c263963fc1b74fe9bb528860817f", "patch": "@@ -199,6 +199,23 @@ pub fn for_loop(expr: &hir::Expr) -> Option<(&hir::Pat, &hir::Expr, &hir::Expr)>\n     None\n }\n \n+/// Recover the essential nodes of a desugared while loop:\n+/// `while cond { body }` becomes `(cond, body)`.\n+pub fn while_loop(expr: &hir::Expr) -> Option<(&hir::Expr, &hir::Expr)> {\n+    if_chain! {\n+        if let hir::ExprKind::Loop(block, _, hir::LoopSource::While) = &expr.node;\n+        if let hir::Block { expr: Some(expr), .. } = &**block;\n+        if let hir::ExprKind::Match(cond, arms, hir::MatchSource::WhileDesugar) = &expr.node;\n+        if let hir::ExprKind::DropTemps(cond) = &cond.node;\n+        if let [arm, ..] = &arms[..];\n+        if let hir::Arm { body, .. } = arm;\n+        then {\n+            return Some((cond, body));\n+        }\n+    }\n+    None\n+}\n+\n /// Recover the essential nodes of a desugared if block\n /// `if cond { then } else { els }` becomes `(cond, then, Some(els))`\n pub fn if_block(expr: &hir::Expr) -> Option<(&hir::Expr, &hir::Expr, Option<&hir::Expr>)> {"}, {"sha": "e9b5cee430e7cdb373c6dc0882f73981e67ef57f", "filename": "clippy_lints/src/utils/hir_utils.rs", "status": "modified", "additions": 0, "deletions": 12, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/316da7eb41f2c263963fc1b74fe9bb528860817f/clippy_lints%2Fsrc%2Futils%2Fhir_utils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/316da7eb41f2c263963fc1b74fe9bb528860817f/clippy_lints%2Fsrc%2Futils%2Fhir_utils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Futils%2Fhir_utils.rs?ref=316da7eb41f2c263963fc1b74fe9bb528860817f", "patch": "@@ -148,11 +148,6 @@ impl<'a, 'tcx> SpanlessEq<'a, 'tcx> {\n             (&ExprKind::Tup(ref l_tup), &ExprKind::Tup(ref r_tup)) => self.eq_exprs(l_tup, r_tup),\n             (&ExprKind::Unary(l_op, ref le), &ExprKind::Unary(r_op, ref re)) => l_op == r_op && self.eq_expr(le, re),\n             (&ExprKind::Array(ref l), &ExprKind::Array(ref r)) => self.eq_exprs(l, r),\n-            (&ExprKind::While(ref lc, ref lb, ref ll), &ExprKind::While(ref rc, ref rb, ref rl)) => {\n-                self.eq_expr(lc, rc)\n-                    && self.eq_block(lb, rb)\n-                    && both(ll, rl, |l, r| l.ident.as_str() == r.ident.as_str())\n-            },\n             (&ExprKind::DropTemps(ref le), &ExprKind::DropTemps(ref re)) => self.eq_expr(le, re),\n             _ => false,\n         }\n@@ -524,13 +519,6 @@ impl<'a, 'tcx> SpanlessHash<'a, 'tcx> {\n                 lop.hash(&mut self.s);\n                 self.hash_expr(le);\n             },\n-            ExprKind::While(ref cond, ref b, l) => {\n-                self.hash_expr(cond);\n-                self.hash_block(b);\n-                if let Some(l) = l {\n-                    self.hash_name(l.ident.name);\n-                }\n-            },\n         }\n     }\n "}, {"sha": "ea169481ac6b39bebee6482bf9ce8582d8fabdd1", "filename": "clippy_lints/src/utils/inspector.rs", "status": "modified", "additions": 0, "deletions": 5, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/316da7eb41f2c263963fc1b74fe9bb528860817f/clippy_lints%2Fsrc%2Futils%2Finspector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/316da7eb41f2c263963fc1b74fe9bb528860817f/clippy_lints%2Fsrc%2Futils%2Finspector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Futils%2Finspector.rs?ref=316da7eb41f2c263963fc1b74fe9bb528860817f", "patch": "@@ -209,11 +209,6 @@ fn print_expr(cx: &LateContext<'_, '_>, expr: &hir::Expr, indent: usize) {\n             print_expr(cx, e, indent + 1);\n             println!(\"{}target type: {:?}\", ind, target);\n         },\n-        hir::ExprKind::While(ref cond, _, _) => {\n-            println!(\"{}While\", ind);\n-            println!(\"{}condition:\", ind);\n-            print_expr(cx, cond, indent + 1);\n-        },\n         hir::ExprKind::Loop(..) => {\n             println!(\"{}Loop\", ind);\n         },"}, {"sha": "0e45750e94df2327b41aeeb9d4b459acd25bc563", "filename": "clippy_lints/src/utils/sugg.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/316da7eb41f2c263963fc1b74fe9bb528860817f/clippy_lints%2Fsrc%2Futils%2Fsugg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/316da7eb41f2c263963fc1b74fe9bb528860817f/clippy_lints%2Fsrc%2Futils%2Fsugg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Futils%2Fsugg.rs?ref=316da7eb41f2c263963fc1b74fe9bb528860817f", "patch": "@@ -113,7 +113,6 @@ impl<'a> Sugg<'a> {\n             | hir::ExprKind::Ret(..)\n             | hir::ExprKind::Struct(..)\n             | hir::ExprKind::Tup(..)\n-            | hir::ExprKind::While(..)\n             | hir::ExprKind::DropTemps(_)\n             | hir::ExprKind::Err => Sugg::NonParen(snippet),\n             hir::ExprKind::Assign(..) => Sugg::BinOp(AssocOp::Assign, snippet),"}]}