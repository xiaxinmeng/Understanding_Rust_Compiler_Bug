{"sha": "8e8828259ac1433dd3981fcec9670d7394c2ade5", "node_id": "MDY6Q29tbWl0NzI0NzEyOjhlODgyODI1OWFjMTQzM2RkMzk4MWZjZWM5NjcwZDczOTRjMmFkZTU=", "commit": {"author": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2020-10-05T21:29:55Z"}, "committer": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2020-10-05T21:29:55Z"}, "message": "Use macro callsite spans in backtrace\n\nThis mirrors what we do in the debuginfo used for runtime backtraces.", "tree": {"sha": "7561af0cccc45a926b5f52e31d5eccace0d2c6c0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7561af0cccc45a926b5f52e31d5eccace0d2c6c0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8e8828259ac1433dd3981fcec9670d7394c2ade5", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE7J9Gc3TfBwj2K399tAh+UQ6YsWQFAl97kIgACgkQtAh+UQ6Y\nsWTqFBAAojaLdh2b4i5AbFTsXAqSVVz8Fvur86VZQzTtVjzm+M8M71/4gNHf650N\nXvonMM0gi228/wuyJSoOINr4DgchsT+RG786HTXPJuNXGs/Guq88vyMAyjQ2rHx1\nczzc8QIkPQiebCisz9o5zALY3sP23i/8HDvOraHbEsx0dFlhrtOwrGDusxTxI8XK\nxbxmtC/gRTCFUYsmjS3dmLKAVzN2PRFVZ/mgFHBog04qSjM9grNFIMf9wiT4Bcyk\nteWHlcOKKQMtn0R/epWXGyxtRdeT93q/6DLkK4bSYos7qBR5BPfGkx3FFb6rUIpw\nZCpuIZTqt/+QUMjOTeaojhTWdVMggH83c1Gg704ws89KnIyt1S6tvcteBcaqYvwy\n+Uzb+IJdOXtgS0kQruhu3UuDn78cK5UaQJmuL3s414ptYUSpPOljRBSC0Y3rHxHl\nVgEjRzMsNpdE140rAyPg7yl152q9Oc19yPV0a6EeGtMfkK1HIs1iLK7Ku9WUh+ax\no5lQASDjNTmo7BUnHUWBdJExYxZgr6W5Zd1MT1Tv6bKGAwRvQ/FgqwVtYw3bcmm2\nAljkSuAco9lHPdNwAcKl7xPGqXg0nZh1kNQAnUWg2ge86B7CryP+MQuFgT4p/zmo\n/UuzB9HDeHTSgSkA122AvMlAzuvKsF75ge+IzUst8surItbiAjI=\n=C51e\n-----END PGP SIGNATURE-----", "payload": "tree 7561af0cccc45a926b5f52e31d5eccace0d2c6c0\nparent 60c10758200e93b8130357e91bfc0db0092d2ae2\nauthor Aaron Hill <aa1ronham@gmail.com> 1601933395 -0400\ncommitter Aaron Hill <aa1ronham@gmail.com> 1601933395 -0400\n\nUse macro callsite spans in backtrace\n\nThis mirrors what we do in the debuginfo used for runtime backtraces.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8e8828259ac1433dd3981fcec9670d7394c2ade5", "html_url": "https://github.com/rust-lang/rust/commit/8e8828259ac1433dd3981fcec9670d7394c2ade5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8e8828259ac1433dd3981fcec9670d7394c2ade5/comments", "author": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "60c10758200e93b8130357e91bfc0db0092d2ae2", "url": "https://api.github.com/repos/rust-lang/rust/commits/60c10758200e93b8130357e91bfc0db0092d2ae2", "html_url": "https://github.com/rust-lang/rust/commit/60c10758200e93b8130357e91bfc0db0092d2ae2"}], "stats": {"total": 26, "additions": 20, "deletions": 6}, "files": [{"sha": "bd36587116a06f5822b2da1c30fff69b62b88177", "filename": "src/shims/backtrace.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/8e8828259ac1433dd3981fcec9670d7394c2ade5/src%2Fshims%2Fbacktrace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8e8828259ac1433dd3981fcec9670d7394c2ade5/src%2Fshims%2Fbacktrace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fshims%2Fbacktrace.rs?ref=8e8828259ac1433dd3981fcec9670d7394c2ade5", "patch": "@@ -26,7 +26,13 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n \n         let mut data = Vec::new();\n         for frame in this.active_thread_stack().iter().rev() {\n-            data.push((frame.instance, frame.current_span().lo()));\n+            let mut span = frame.current_span();\n+            // Match the behavior of runtime backtrace spans\n+            // by using a non-macro span in our backtrace. See `FunctionCx::debug_loc`.\n+            if span.from_expansion() && !tcx.sess.opts.debugging_opts.debug_macros {\n+                span = rustc_span::hygiene::walk_chain(span, frame.body.span.ctxt())\n+            }\n+            data.push((frame.instance, span.lo()));\n         }\n \n         let ptrs: Vec<_> = data.into_iter().map(|(instance, pos)| {"}, {"sha": "eaf29abfd9f48d16d864367ea8b68e0cfc0f0d1e", "filename": "tests/run-pass/backtrace-api.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/8e8828259ac1433dd3981fcec9670d7394c2ade5/tests%2Frun-pass%2Fbacktrace-api.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8e8828259ac1433dd3981fcec9670d7394c2ade5/tests%2Frun-pass%2Fbacktrace-api.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-pass%2Fbacktrace-api.rs?ref=8e8828259ac1433dd3981fcec9670d7394c2ade5", "patch": "@@ -18,7 +18,13 @@ struct MiriFrame {\n \n #[inline(never)] fn func_a() -> Box<[*mut ()]> { func_b::<u8>() }\n #[inline(never)] fn func_b<T>() -> Box<[*mut ()]> { func_c() }\n-#[inline(never)] fn func_c() -> Box<[*mut ()]> { unsafe { miri_get_backtrace(0) } }\n+\n+macro_rules! invoke_func_d {\n+    () => { func_d() }\n+}\n+\n+#[inline(never)] fn func_c() -> Box<[*mut ()]> { invoke_func_d!() }\n+#[inline(never)] fn func_d() -> Box<[*mut ()]> { unsafe { miri_get_backtrace(0) } }\n \n fn main() {\n     let mut seen_main = false;"}, {"sha": "02e7a7e1eaf9c88635b6c5d449b0b702ceb60840", "filename": "tests/run-pass/backtrace-api.stderr", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/8e8828259ac1433dd3981fcec9670d7394c2ade5/tests%2Frun-pass%2Fbacktrace-api.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/8e8828259ac1433dd3981fcec9670d7394c2ade5/tests%2Frun-pass%2Fbacktrace-api.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-pass%2Fbacktrace-api.stderr?ref=8e8828259ac1433dd3981fcec9670d7394c2ade5", "patch": "@@ -1,7 +1,8 @@\n-$DIR/backtrace-api.rs:21:59 (func_c)\n+$DIR/backtrace-api.rs:27:59 (func_d)\n+$DIR/backtrace-api.rs:26:50 (func_c)\n $DIR/backtrace-api.rs:20:53 (func_b)\n $DIR/backtrace-api.rs:19:50 (func_a)\n-$DIR/backtrace-api.rs:25:18 (main)\n+$DIR/backtrace-api.rs:31:18 (main)\n RUSTLIB/core/src/ops/function.rs:LL:COL (<fn() as std::ops::FnOnce<()>>::call_once - shim(fn()))\n RUSTLIB/std/src/sys_common/backtrace.rs:LL:COL (std::sys_common::backtrace::__rust_begin_short_backtrace)\n RUSTLIB/std/src/rt.rs:LL:COL (std::rt::lang_start::{closure#0})"}, {"sha": "90ab4bb96e625c5e2ac20904f8e273e56bd8ed27", "filename": "tests/run-pass/backtrace-api.stdout", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/8e8828259ac1433dd3981fcec9670d7394c2ade5/tests%2Frun-pass%2Fbacktrace-api.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/8e8828259ac1433dd3981fcec9670d7394c2ade5/tests%2Frun-pass%2Fbacktrace-api.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-pass%2Fbacktrace-api.stdout?ref=8e8828259ac1433dd3981fcec9670d7394c2ade5", "patch": "@@ -1,4 +1,5 @@\n-$DIR/backtrace-api.rs:21:59 (func_c)\n+$DIR/backtrace-api.rs:27:59 (func_d)\n+$DIR/backtrace-api.rs:26:50 (func_c)\n $DIR/backtrace-api.rs:20:53 (func_b::<u8>)\n $DIR/backtrace-api.rs:19:50 (func_a)\n-$DIR/backtrace-api.rs:25:18 (main)\n+$DIR/backtrace-api.rs:31:18 (main)"}]}