{"sha": "1d7931e5ffeb2d65ebcc14a63da1b84cc131bfb8", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFkNzkzMWU1ZmZlYjJkNjVlYmNjMTRhNjNkYTFiODRjYzEzMWJmYjg=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2019-12-20T17:29:11Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-12-20T17:29:11Z"}, "message": "Merge #2618\n\n2618: Fix coercion of last expression in function body r=flodiebold a=flodiebold\n\n\n\nCo-authored-by: Florian Diebold <florian.diebold@freiheit.com>", "tree": {"sha": "2b96a667cd1d7bee5ec41abe38d777bc181b674d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2b96a667cd1d7bee5ec41abe38d777bc181b674d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1d7931e5ffeb2d65ebcc14a63da1b84cc131bfb8", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJd/QTnCRBK7hj4Ov3rIwAAdHIIAGbXHrdL97UUnoMIsjYkvEpN\ntAmcKFIE1ST3W7l3nsNjIL5Okyav/Bpd4CYOaaiJrRYHmB/MHuTGHEwPMKFVhEyV\nHZH52eVWNz6E4MOioWkjMWqb7CqiryfTeJI4rfZ0ASjRWVr4S2RViAThNXgZOppd\neXzlTErcRd9GANhbvdbbmIm9d2uc/Y+/D1TC1V8WMrGO3uwRuPASVBa1eXtcTLL5\nOGrGkHQhRoDX45i25Thc2/F8owQgMsedOnTi6GebEy1z2unqNMIOVUuRFfx1Hofx\nVxZQWC27/u1D0FHSPI3ODEXIxi5mV7Hp8pEKLCVSH8wbw+YJLxtyVSlw6NkKGiE=\n=yY3R\n-----END PGP SIGNATURE-----\n", "payload": "tree 2b96a667cd1d7bee5ec41abe38d777bc181b674d\nparent 99d6f544f2a590d3feef47ce62d5cd9a8b463a47\nparent 9c3f00a90651998c2cd4151f43f17cd92ef8eef1\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1576862951 +0000\ncommitter GitHub <noreply@github.com> 1576862951 +0000\n\nMerge #2618\n\n2618: Fix coercion of last expression in function body r=flodiebold a=flodiebold\n\n\n\nCo-authored-by: Florian Diebold <florian.diebold@freiheit.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1d7931e5ffeb2d65ebcc14a63da1b84cc131bfb8", "html_url": "https://github.com/rust-lang/rust/commit/1d7931e5ffeb2d65ebcc14a63da1b84cc131bfb8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1d7931e5ffeb2d65ebcc14a63da1b84cc131bfb8/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "99d6f544f2a590d3feef47ce62d5cd9a8b463a47", "url": "https://api.github.com/repos/rust-lang/rust/commits/99d6f544f2a590d3feef47ce62d5cd9a8b463a47", "html_url": "https://github.com/rust-lang/rust/commit/99d6f544f2a590d3feef47ce62d5cd9a8b463a47"}, {"sha": "9c3f00a90651998c2cd4151f43f17cd92ef8eef1", "url": "https://api.github.com/repos/rust-lang/rust/commits/9c3f00a90651998c2cd4151f43f17cd92ef8eef1", "html_url": "https://github.com/rust-lang/rust/commit/9c3f00a90651998c2cd4151f43f17cd92ef8eef1"}], "stats": {"total": 20, "additions": 18, "deletions": 2}, "files": [{"sha": "e97b8147395b4e1efa1ab27628797a821c121040", "filename": "crates/ra_hir_ty/src/infer.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1d7931e5ffeb2d65ebcc14a63da1b84cc131bfb8/crates%2Fra_hir_ty%2Fsrc%2Finfer.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d7931e5ffeb2d65ebcc14a63da1b84cc131bfb8/crates%2Fra_hir_ty%2Fsrc%2Finfer.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_ty%2Fsrc%2Finfer.rs?ref=1d7931e5ffeb2d65ebcc14a63da1b84cc131bfb8", "patch": "@@ -460,7 +460,7 @@ impl<'a, D: HirDatabase> InferenceContext<'a, D> {\n     }\n \n     fn infer_body(&mut self) {\n-        self.infer_expr(self.body.body_expr, &Expectation::has_type(self.return_ty.clone()));\n+        self.infer_expr_coerce(self.body.body_expr, &Expectation::has_type(self.return_ty.clone()));\n     }\n \n     fn resolve_into_iter_item(&self) -> Option<TypeAliasId> {"}, {"sha": "3af05394c6b86254bf6f2ef7911fafba5884ea43", "filename": "crates/ra_hir_ty/src/infer/expr.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1d7931e5ffeb2d65ebcc14a63da1b84cc131bfb8/crates%2Fra_hir_ty%2Fsrc%2Finfer%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d7931e5ffeb2d65ebcc14a63da1b84cc131bfb8/crates%2Fra_hir_ty%2Fsrc%2Finfer%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_ty%2Fsrc%2Finfer%2Fexpr.rs?ref=1d7931e5ffeb2d65ebcc14a63da1b84cc131bfb8", "patch": "@@ -41,7 +41,7 @@ impl<'a, D: HirDatabase> InferenceContext<'a, D> {\n \n     /// Infer type of expression with possibly implicit coerce to the expected type.\n     /// Return the type after possible coercion.\n-    fn infer_expr_coerce(&mut self, expr: ExprId, expected: &Expectation) -> Ty {\n+    pub(super) fn infer_expr_coerce(&mut self, expr: ExprId, expected: &Expectation) -> Ty {\n         let ty = self.infer_expr_inner(expr, &expected);\n         let ty = if !self.coerce(&ty, &expected.ty) {\n             self.result"}, {"sha": "793c23e41c64f725dc6658fda506f374b571d259", "filename": "crates/ra_hir_ty/src/tests/coercion.rs", "status": "modified", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/1d7931e5ffeb2d65ebcc14a63da1b84cc131bfb8/crates%2Fra_hir_ty%2Fsrc%2Ftests%2Fcoercion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1d7931e5ffeb2d65ebcc14a63da1b84cc131bfb8/crates%2Fra_hir_ty%2Fsrc%2Ftests%2Fcoercion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_ty%2Fsrc%2Ftests%2Fcoercion.rs?ref=1d7931e5ffeb2d65ebcc14a63da1b84cc131bfb8", "patch": "@@ -369,6 +369,22 @@ fn test() {\n     );\n }\n \n+#[test]\n+fn return_coerce_unknown() {\n+    assert_snapshot!(\n+        infer_with_mismatches(r#\"\n+fn foo() -> u32 {\n+    return unknown;\n+}\n+\"#, true),\n+        @r###\"\n+    [17; 40) '{     ...own; }': !\n+    [23; 37) 'return unknown': !\n+    [30; 37) 'unknown': u32\n+    \"###\n+    );\n+}\n+\n #[test]\n fn coerce_autoderef() {\n     assert_snapshot!("}]}