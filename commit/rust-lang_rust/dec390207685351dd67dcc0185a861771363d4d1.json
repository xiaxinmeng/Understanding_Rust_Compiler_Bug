{"sha": "dec390207685351dd67dcc0185a861771363d4d1", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRlYzM5MDIwNzY4NTM1MWRkNjdkY2MwMTg1YTg2MTc3MTM2M2Q0ZDE=", "commit": {"author": {"name": "rchaser53", "email": "tayoshizawa29@gmail.com", "date": "2019-02-24T14:04:47Z"}, "committer": {"name": "rchaser53", "email": "tayoshizawa29@gmail.com", "date": "2019-03-02T08:33:43Z"}, "message": "leave post comment for self", "tree": {"sha": "0af88961ef5ac1688c7afdef434c0cf89f5338ca", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0af88961ef5ac1688c7afdef434c0cf89f5338ca"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/dec390207685351dd67dcc0185a861771363d4d1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/dec390207685351dd67dcc0185a861771363d4d1", "html_url": "https://github.com/rust-lang/rust/commit/dec390207685351dd67dcc0185a861771363d4d1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/dec390207685351dd67dcc0185a861771363d4d1/comments", "author": {"login": "rchaser53", "id": 9676954, "node_id": "MDQ6VXNlcjk2NzY5NTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/9676954?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rchaser53", "html_url": "https://github.com/rchaser53", "followers_url": "https://api.github.com/users/rchaser53/followers", "following_url": "https://api.github.com/users/rchaser53/following{/other_user}", "gists_url": "https://api.github.com/users/rchaser53/gists{/gist_id}", "starred_url": "https://api.github.com/users/rchaser53/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rchaser53/subscriptions", "organizations_url": "https://api.github.com/users/rchaser53/orgs", "repos_url": "https://api.github.com/users/rchaser53/repos", "events_url": "https://api.github.com/users/rchaser53/events{/privacy}", "received_events_url": "https://api.github.com/users/rchaser53/received_events", "type": "User", "site_admin": false}, "committer": {"login": "rchaser53", "id": 9676954, "node_id": "MDQ6VXNlcjk2NzY5NTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/9676954?v=4", "gravatar_id": "", "url": "https://api.github.com/users/rchaser53", "html_url": "https://github.com/rchaser53", "followers_url": "https://api.github.com/users/rchaser53/followers", "following_url": "https://api.github.com/users/rchaser53/following{/other_user}", "gists_url": "https://api.github.com/users/rchaser53/gists{/gist_id}", "starred_url": "https://api.github.com/users/rchaser53/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/rchaser53/subscriptions", "organizations_url": "https://api.github.com/users/rchaser53/orgs", "repos_url": "https://api.github.com/users/rchaser53/repos", "events_url": "https://api.github.com/users/rchaser53/events{/privacy}", "received_events_url": "https://api.github.com/users/rchaser53/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ae7330eea4100566f9f3826221cb3d694cfde5cc", "url": "https://api.github.com/repos/rust-lang/rust/commits/ae7330eea4100566f9f3826221cb3d694cfde5cc", "html_url": "https://github.com/rust-lang/rust/commit/ae7330eea4100566f9f3826221cb3d694cfde5cc"}], "stats": {"total": 202, "additions": 160, "deletions": 42}, "files": [{"sha": "5f751035f3e9dd0b71b8a44e1b4f6295f63ba5f4", "filename": "src/items.rs", "status": "modified", "additions": 41, "deletions": 30, "changes": 71, "blob_url": "https://github.com/rust-lang/rust/blob/dec390207685351dd67dcc0185a861771363d4d1/src%2Fitems.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dec390207685351dd67dcc0185a861771363d4d1/src%2Fitems.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fitems.rs?ref=dec390207685351dd67dcc0185a861771363d4d1", "patch": "@@ -20,8 +20,8 @@ use crate::expr::{\n     ExprType, RhsTactics,\n };\n use crate::lists::{\n-    definitive_tactic, extract_pre_comment, itemize_list, write_list, ListFormatting, ListItem,\n-    Separator,\n+    definitive_tactic, extract_post_comment, extract_pre_comment, get_comment_end,\n+    has_extra_newline, itemize_list, write_list, ListFormatting, ListItem, Separator,\n };\n use crate::macros::{rewrite_macro, MacroPosition};\n use crate::overflow;\n@@ -2281,6 +2281,10 @@ fn rewrite_args(\n     variadic: bool,\n     generics_str_contains_newline: bool,\n ) -> Option<String> {\n+    let terminator = \")\";\n+    let separator = \",\";\n+    let next_span_start = span.hi();\n+\n     let mut arg_item_strs = args\n         .iter()\n         .map(|arg| {\n@@ -2290,17 +2294,20 @@ fn rewrite_args(\n         .collect::<Vec<_>>();\n \n     // Account for sugary self.\n-    // FIXME: the comment for the self argument is dropped. This is blocked\n-    // on rust issue #27522.\n-    let mut comment_str = \"\";\n+    let mut pre_comment_str = \"\";\n+    let mut post_comment_str = \"\";\n     let min_args = explicit_self\n         .and_then(|explicit_self| rewrite_explicit_self(explicit_self, args, context))\n         .map_or(1, |self_str| {\n-            let comment_span = mk_sp(span.lo(), args[0].pat.span.lo());\n-            comment_str = context\n-                .snippet_provider\n-                .span_to_snippet(comment_span)\n-                .unwrap();\n+            pre_comment_str = context.snippet(mk_sp(span.lo(), args[0].pat.span.lo()));\n+\n+            let next_start = if args.len() > 1 {\n+                args[1].pat.span().lo()\n+            } else {\n+                span.hi()\n+            };\n+            post_comment_str = context.snippet(mk_sp(args[0].ty.span.hi(), next_start));\n+\n             arg_item_strs[0] = self_str;\n             2\n         });\n@@ -2317,14 +2324,18 @@ fn rewrite_args(\n     // it is explicit.\n     if args.len() >= min_args || variadic {\n         let comment_span_start = if min_args == 2 {\n-            let second_arg_start = if arg_has_pattern(&args[1]) {\n-                args[1].pat.span.lo()\n+            let remove_comma_byte_pos = context\n+                .snippet_provider\n+                .span_after(mk_sp(args[0].ty.span.hi(), args[1].pat.span.lo()), \",\");\n+            let first_post_and_second_pre_span =\n+                mk_sp(remove_comma_byte_pos, args[1].pat.span.lo());\n+            if count_newlines(context.snippet(first_post_and_second_pre_span)) > 0 {\n+                context\n+                    .snippet_provider\n+                    .span_after(first_post_and_second_pre_span, \"\\n\")\n             } else {\n-                args[1].ty.span.lo()\n-            };\n-            let reduced_span = mk_sp(span.lo(), second_arg_start);\n-\n-            context.snippet_provider.span_after_last(reduced_span, \",\")\n+                remove_comma_byte_pos\n+            }\n         } else {\n             span.lo()\n         };\n@@ -2349,8 +2360,8 @@ fn rewrite_args(\n                 .iter()\n                 .map(ArgumentKind::Regular)\n                 .chain(variadic_arg),\n-            \")\",\n-            \",\",\n+            terminator,\n+            separator,\n             |arg| match *arg {\n                 ArgumentKind::Regular(arg) => span_lo_for_arg(arg),\n                 ArgumentKind::Variadic(start) => start,\n@@ -2364,22 +2375,30 @@ fn rewrite_args(\n                 ArgumentKind::Variadic(..) => Some(\"...\".to_owned()),\n             },\n             comment_span_start,\n-            span.hi(),\n+            next_span_start,\n             false,\n         );\n \n         arg_items.extend(more_items);\n     }\n \n+    let arg_items_len = arg_items.len();\n     let fits_in_one_line = !generics_str_contains_newline\n         && (arg_items.is_empty()\n-            || arg_items.len() == 1 && arg_item_strs[0].len() <= one_line_budget);\n+            || arg_items_len == 1 && arg_item_strs[0].len() <= one_line_budget);\n \n     for (index, (item, arg)) in arg_items.iter_mut().zip(arg_item_strs).enumerate() {\n+        // add pre comment and post comment for first arg(self)\n         if index == 0 && explicit_self.is_some() {\n-            let (pre_comment, pre_comment_style) = extract_pre_comment(comment_str);\n+            let (pre_comment, pre_comment_style) = extract_pre_comment(pre_comment_str);\n             item.pre_comment = pre_comment;\n             item.pre_comment_style = pre_comment_style;\n+\n+            let comment_end =\n+                get_comment_end(post_comment_str, separator, terminator, arg_items_len == 1);\n+\n+            item.new_lines = has_extra_newline(post_comment_str, comment_end);\n+            item.post_comment = extract_post_comment(post_comment_str, comment_end, separator);\n         }\n         item.item = Some(arg);\n     }\n@@ -2430,14 +2449,6 @@ fn rewrite_args(\n     write_list(&arg_items, &fmt)\n }\n \n-fn arg_has_pattern(arg: &ast::Arg) -> bool {\n-    if let ast::PatKind::Ident(_, ident, _) = arg.pat.node {\n-        ident != symbol::keywords::Invalid.ident()\n-    } else {\n-        true\n-    }\n-}\n-\n fn compute_budgets_for_args(\n     context: &RewriteContext<'_>,\n     result: &str,"}, {"sha": "cb404123af090d975b2f427273ffaee6e76d8cc5", "filename": "src/lists.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/dec390207685351dd67dcc0185a861771363d4d1/src%2Flists.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dec390207685351dd67dcc0185a861771363d4d1/src%2Flists.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flists.rs?ref=dec390207685351dd67dcc0185a861771363d4d1", "patch": "@@ -683,7 +683,7 @@ pub fn get_comment_end(\n \n // Account for extra whitespace between items. This is fiddly\n // because of the way we divide pre- and post- comments.\n-fn has_extra_newline(post_snippet: &str, comment_end: usize) -> bool {\n+pub fn has_extra_newline(post_snippet: &str, comment_end: usize) -> bool {\n     if post_snippet.is_empty() || comment_end == 0 {\n         return false;\n     }"}, {"sha": "48cb24a00259edaff855c4e632c393db0379761a", "filename": "tests/source/issue-3198.rs", "status": "modified", "additions": 65, "deletions": 6, "changes": 71, "blob_url": "https://github.com/rust-lang/rust/blob/dec390207685351dd67dcc0185a861771363d4d1/tests%2Fsource%2Fissue-3198.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dec390207685351dd67dcc0185a861771363d4d1/tests%2Fsource%2Fissue-3198.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fissue-3198.rs?ref=dec390207685351dd67dcc0185a861771363d4d1", "patch": "@@ -1,40 +1,99 @@\n impl TestTrait {\n-    fn foo_one(/* Important comment1 */\n+    fn foo_one_pre(/* Important comment1 */\n     self) {\n     }\n \n-    fn foo(\n+    fn foo_one_post(self\n+    /* Important comment1 */) {\n+    }\n+\n+    fn foo_pre(\n         /* Important comment1 */\n         self,\n         /* Important comment2 */\n         a: i32,\n     ) {\n     }\n \n-    fn bar(\n+    fn foo_post(\n+        self\n+        /* Important comment1 */,\n+        a: i32\n+        /* Important comment2 */,\n+    ) {\n+    }\n+\n+    fn bar_pre(\n             /* Important comment1 */\n     &mut self,\n         /* Important comment2 */\n             a: i32,\n     ) {\n     }\n \n-    fn baz(\n+    fn bar_post(\n+    &mut self\n+            /* Important comment1 */,\n+            a: i32\n+        /* Important comment2 */,\n+    ) {\n+    }\n+\n+    fn baz_pre(\n     /* Important comment1 */\n             self: X< 'a ,  'b >,\n             /* Important comment2 */\n     a: i32,\n     ) {\n     }\n \n-    fn baz_tree(\n-    /* Important comment1 */\n+    fn baz_post(\n+            self: X< 'a ,  'b >\n+    /* Important comment1 */,\n+    a: i32\n+            /* Important comment2 */,\n+    ) {\n+    }\n \n+    fn baz_tree_pre(\n+    /* Important comment1 */\n             self: X< 'a ,  'b >,\n         /* Important comment2 */\n         a: i32,\n         /* Important comment3 */\n         b: i32,\n     ) {\n     }\n+\n+    fn baz_tree_post(\n+            self: X< 'a ,  'b >\n+    /* Important comment1 */,\n+        a: i32\n+        /* Important comment2 */,\n+        b: i32\n+        /* Important comment3 */,){\n+    }\n+\n+    fn multi_line(\n+        self: X<'a, 'b>, /* Important comment1-1 */\n+  /* Important comment1-2 */\n+        a: i32, /* Important comment2 */\n+        b: i32, /* Important comment3 */\n+    ) {\n+    }\n+\n+    fn two_line_comment(\n+        self: X<'a, 'b>, /* Important comment1-1\n+      Important comment1-2 */\n+        a: i32, /* Important comment2 */\n+        b: i32, /* Important comment3 */\n+    ) {\n+    }\n+\n+    fn no_first_line_comment(\n+        self: X<'a, 'b>,\n+        /* Important comment2 */a: i32,\n+        /* Important comment3 */b: i32,\n+    ) {\n+    }\n }"}, {"sha": "9291f181d03a27f1566b395281e30045d8db9f42", "filename": "tests/target/issue-3198.rs", "status": "modified", "additions": 53, "deletions": 5, "changes": 58, "blob_url": "https://github.com/rust-lang/rust/blob/dec390207685351dd67dcc0185a861771363d4d1/tests%2Ftarget%2Fissue-3198.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dec390207685351dd67dcc0185a861771363d4d1/tests%2Ftarget%2Fissue-3198.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fissue-3198.rs?ref=dec390207685351dd67dcc0185a861771363d4d1", "patch": "@@ -1,13 +1,31 @@\n impl TestTrait {\n-    fn foo_one(/* Important comment1 */ self) {}\n+    fn foo_one_pre(/* Important comment1 */ self) {}\n \n-    fn foo(/* Important comment1 */ self, /* Important comment2 */ a: i32) {}\n+    fn foo_one_post(self /* Important comment1 */) {}\n \n-    fn bar(/* Important comment1 */ &mut self, /* Important comment2 */ a: i32) {}\n+    fn foo_pre(/* Important comment1 */ self, /* Important comment2 */ a: i32) {}\n \n-    fn baz(/* Important comment1 */ self: X<'a, 'b>, /* Important comment2 */ a: i32) {}\n+    fn foo_post(self /* Important comment1 */, a: i32 /* Important comment2 */) {}\n \n-    fn baz_tree(\n+    fn bar_pre(/* Important comment1 */ &mut self, /* Important comment2 */ a: i32) {}\n+\n+    fn bar_post(&mut self /* Important comment1 */, a: i32 /* Important comment2 */) {}\n+\n+    fn baz_pre(\n+        /* Important comment1 */\n+        self: X<'a, 'b>,\n+        /* Important comment2 */\n+        a: i32,\n+    ) {\n+    }\n+\n+    fn baz_post(\n+        self: X<'a, 'b>, /* Important comment1 */\n+        a: i32,          /* Important comment2 */\n+    ) {\n+    }\n+\n+    fn baz_tree_pre(\n         /* Important comment1 */\n         self: X<'a, 'b>,\n         /* Important comment2 */\n@@ -16,4 +34,34 @@ impl TestTrait {\n         b: i32,\n     ) {\n     }\n+\n+    fn baz_tree_post(\n+        self: X<'a, 'b>, /* Important comment1 */\n+        a: i32,          /* Important comment2 */\n+        b: i32,          /* Important comment3 */\n+    ) {\n+    }\n+\n+    fn multi_line(\n+        self: X<'a, 'b>, /* Important comment1-1 */\n+        /* Important comment1-2 */\n+        a: i32, /* Important comment2 */\n+        b: i32, /* Important comment3 */\n+    ) {\n+    }\n+\n+    fn two_line_comment(\n+        self: X<'a, 'b>, /* Important comment1-1\n+                         Important comment1-2 */\n+        a: i32, /* Important comment2 */\n+        b: i32, /* Important comment3 */\n+    ) {\n+    }\n+\n+    fn no_first_line_comment(\n+        self: X<'a, 'b>,\n+        /* Important comment2 */ a: i32,\n+        /* Important comment3 */ b: i32,\n+    ) {\n+    }\n }"}]}