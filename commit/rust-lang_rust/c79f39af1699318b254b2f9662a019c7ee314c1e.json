{"sha": "c79f39af1699318b254b2f9662a019c7ee314c1e", "node_id": "MDY6Q29tbWl0NzI0NzEyOmM3OWYzOWFmMTY5OTMxOGIyNTRiMmY5NjYyYTAxOWM3ZWUzMTRjMWU=", "commit": {"author": {"name": "gnzlbg", "email": "gonzalobg88@gmail.com", "date": "2018-05-09T09:57:58Z"}, "committer": {"name": "gnzlbg", "email": "gonzalobg88@gmail.com", "date": "2018-05-09T22:31:55Z"}, "message": "Add integration tests against crates in the rust-lang-nursery\n\nThis commit adds integration tests against some crates in the\nnursery.\n\nEach integration test is added as a separate build-bot, where\nthe rust-lang-nursery/${CRATE} is first downloaded and its tests run.\nAfterwards, `cargo fmt --all` is applied to the crate, and the tests\nare re-run. If the tests fail after formatting, the integration test\nfails.\n\nThe crates that currently fail are added as allowed-to-fail, but the\nintent is that either these crates or rustfmt should be fixed such\nthat the tests pass.", "tree": {"sha": "9c972f2f66dca167a231ff7ed1b95c7f1fcf0683", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9c972f2f66dca167a231ff7ed1b95c7f1fcf0683"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c79f39af1699318b254b2f9662a019c7ee314c1e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c79f39af1699318b254b2f9662a019c7ee314c1e", "html_url": "https://github.com/rust-lang/rust/commit/c79f39af1699318b254b2f9662a019c7ee314c1e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c79f39af1699318b254b2f9662a019c7ee314c1e/comments", "author": {"login": "gnzlbg", "id": 904614, "node_id": "MDQ6VXNlcjkwNDYxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/904614?v=4", "gravatar_id": "", "url": "https://api.github.com/users/gnzlbg", "html_url": "https://github.com/gnzlbg", "followers_url": "https://api.github.com/users/gnzlbg/followers", "following_url": "https://api.github.com/users/gnzlbg/following{/other_user}", "gists_url": "https://api.github.com/users/gnzlbg/gists{/gist_id}", "starred_url": "https://api.github.com/users/gnzlbg/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/gnzlbg/subscriptions", "organizations_url": "https://api.github.com/users/gnzlbg/orgs", "repos_url": "https://api.github.com/users/gnzlbg/repos", "events_url": "https://api.github.com/users/gnzlbg/events{/privacy}", "received_events_url": "https://api.github.com/users/gnzlbg/received_events", "type": "User", "site_admin": false}, "committer": {"login": "gnzlbg", "id": 904614, "node_id": "MDQ6VXNlcjkwNDYxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/904614?v=4", "gravatar_id": "", "url": "https://api.github.com/users/gnzlbg", "html_url": "https://github.com/gnzlbg", "followers_url": "https://api.github.com/users/gnzlbg/followers", "following_url": "https://api.github.com/users/gnzlbg/following{/other_user}", "gists_url": "https://api.github.com/users/gnzlbg/gists{/gist_id}", "starred_url": "https://api.github.com/users/gnzlbg/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/gnzlbg/subscriptions", "organizations_url": "https://api.github.com/users/gnzlbg/orgs", "repos_url": "https://api.github.com/users/gnzlbg/repos", "events_url": "https://api.github.com/users/gnzlbg/events{/privacy}", "received_events_url": "https://api.github.com/users/gnzlbg/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5dba81bbbf0f352335b240fbf1cd64e5f3ca447f", "url": "https://api.github.com/repos/rust-lang/rust/commits/5dba81bbbf0f352335b240fbf1cd64e5f3ca447f", "html_url": "https://github.com/rust-lang/rust/commit/5dba81bbbf0f352335b240fbf1cd64e5f3ca447f"}], "stats": {"total": 159, "additions": 134, "deletions": 25}, "files": [{"sha": "c0fefbbbb2845801eaffd841b267a4cfef44e7e8", "filename": ".travis.yml", "status": "modified", "additions": 56, "deletions": 25, "changes": 81, "blob_url": "https://github.com/rust-lang/rust/blob/c79f39af1699318b254b2f9662a019c7ee314c1e/.travis.yml", "raw_url": "https://github.com/rust-lang/rust/raw/c79f39af1699318b254b2f9662a019c7ee314c1e/.travis.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.travis.yml?ref=c79f39af1699318b254b2f9662a019c7ee314c1e", "patch": "@@ -1,47 +1,78 @@\n sudo: false\n language: rust\n-rust:\n-# - stable\n-# - beta\n- - nightly\n-os:\n- - linux\n- - osx\n+rust: nightly\n+os: linux\n cache:\n  directories:\n   - $HOME/.cargo\n \n-matrix:\n-  include:\n-    # Make sure tests will pass on beta\n-    - env: CFG_RELEASE_CHANNEL=beta\n-\n addons:\n   apt:\n     packages:\n     - libcurl4-openssl-dev\n     - libelf-dev\n     - libdw-dev\n \n+matrix:\n+  include:\n+    - env: DEPLOY=LINUX\n+    - env: CFG_RELEASE_CHANNEL=beta\n+    - os: osx\n+    - env: INTEGRATION=cargo\n+    - env: INTEGRATION=rust-clippy\n+    - env: INTEGRATION=mdbook\n+    - env: INTEGRATION=stdsimd\n+    - env: INTEGRATION=rust-semverver\n+    - env: INTEGRATION=chalk\n+    - env: INTEGRATION=crater\n+    - env: INTEGRATION=futures-rs\n+    - env: INTEGRATION=rand\n+    - env: INTEGRATION=failure\n+    - env: INTEGRATION=glob\n+    - env: INTEGRATION=error-chain\n+    - env: INTEGRATION=tempdir\n+    - env: INTEGRATION=bitflags\n+    - env: INTEGRATION=log\n+  allow_failures:\n+    - env: INTEGRATION=cargo\n+    - env: INTEGRATION=stdsimd\n+    - env: INTEGRATION=mdbook\n+    - env: INTEGRATION=crater\n+    - env: INTEGRATION=rust-semverver\n+    - env: INTEGRATION=rust-clippy\n+    - env: INTEGRATION=chalk\n+    - env: INTEGRATION=bitflags\n+    - env: INTEGRATION=error-chain\n+    - env: INTEGRATION=failure\n+    - env: INTEGRATION=futures-rs\n+    - env: INTEGRATION=log\n+    - env: INTEGRATION=rand\n+\n before_script:\n - |\n-  if [ $TRAVIS_OS_NAME = 'osx' ]; then\n-    virtualenv env &&\n-    source env/bin/activate &&\n-    python --version &&\n-    pip install 'travis-cargo<0.2'\n-  else\n-    pip install 'travis-cargo<0.2' --user &&\n-    export PATH=\"$(python -m site --user-base)/bin:$PATH\"\n+  if [ -z ${INTEGRATION} ]; then\n+    if [ $TRAVIS_OS_NAME = 'osx' ]; then\n+      virtualenv env &&\n+      source env/bin/activate &&\n+      python --version &&\n+      pip install 'travis-cargo<0.2'\n+    else\n+      pip install 'travis-cargo<0.2' --user &&\n+      export PATH=\"$(python -m site --user-base)/bin:$PATH\"\n+    fi\n   fi\n \n script:\n-- |\n-  cargo build &&\n-  cargo test\n+  - |\n+    if [ -z ${INTEGRATION} ]; then\n+      cargo build\n+      cargo test\n+    else\n+      ./ci/integration.sh\n+    fi\n \n after_success:\n-- travis-cargo coveralls --no-sudo\n+- if [ -z ${INTEGRATION} ]; then travis-cargo coveralls --no-sudo; fi\n \n before_deploy:\n   # TODO: cross build\n@@ -57,5 +88,5 @@ deploy:\n   on:\n     repo: nrc/rustfmt\n     tags: true\n-    condition: \"$TRAVIS_OS_NAME = linux\"\n+    condition: \"$DEPLOY = LINUX\"\n   skip_cleanup: true"}, {"sha": "8bdf8677a699cb251d2a93f059642d3ecbd465bf", "filename": "ci/integration.sh", "status": "added", "additions": 78, "deletions": 0, "changes": 78, "blob_url": "https://github.com/rust-lang/rust/blob/c79f39af1699318b254b2f9662a019c7ee314c1e/ci%2Fintegration.sh", "raw_url": "https://github.com/rust-lang/rust/raw/c79f39af1699318b254b2f9662a019c7ee314c1e/ci%2Fintegration.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/ci%2Fintegration.sh?ref=c79f39af1699318b254b2f9662a019c7ee314c1e", "patch": "@@ -0,0 +1,78 @@\n+#!/usr/bin/env bash\n+\n+set -ex\n+\n+: ${INTEGRATION?\"The INTEGRATION environment variable must be set.\"}\n+\n+# FIXME: this is causing the build to fail when rustfmt is found in .cargo/bin\n+# but cargo-fmt is not found.\n+#\n+# `which rustfmt` fails if rustfmt is not found. Since we don't install\n+# `rustfmt` via `rustup`, this is the case unless we manually install it. Once\n+# that happens, `cargo install --force` will be called, which installs\n+# `rustfmt`, `cargo-fmt`, etc to `~/.cargo/bin`. This directory is cached by\n+# travis (see `.travis.yml`'s \"cache\" key), such that build-bots that arrive\n+# here after the first installation will find `rustfmt` and won't need to build\n+# it again.\n+#\n+# which rustfmt || cargo install --force\n+cargo install --force\n+\n+echo \"Integration tests for: ${INTEGRATION}\"\n+\n+function check_fmt {\n+    cargo fmt --all -v -- --error-on-unformatted &> rustfmt_output\n+    if [[ $? != 0 ]]; then\n+        return 1\n+    fi\n+    cat rustfmt_output\n+    ! cat rustfmt_output | grep -q \"internal error\"\n+    if [[ $? != 0 ]]; then\n+        return 1\n+    fi\n+    ! cat rustfmt_output | grep -q \"warning\"\n+    if [[ $? != 0 ]]; then\n+        return 1\n+    fi\n+    ! cat rustfmt_output | grep -q \"Warning\"\n+    if [[ $? != 0 ]]; then\n+        return 1\n+    fi\n+    cargo test --all\n+    if [[ $? != 0 ]]; then\n+        return $?\n+    fi\n+}\n+\n+function check {\n+    cargo test --all\n+    if [[ $? != 0 ]]; then\n+        return 1\n+    fi\n+    check_fmt\n+    if [[ $? != 0 ]]; then\n+        return 1\n+    fi\n+}\n+\n+case ${INTEGRATION} in\n+    cargo)\n+        git clone https://github.com/rust-lang/${INTEGRATION}.git\n+        cd ${INTEGRATION}\n+        export CFG_DISABLE_CROSS_TESTS=1\n+        check\n+        cd -\n+        ;;\n+    failure)\n+        git clone https://github.com/rust-lang-nursery/${INTEGRATION}.git\n+        cd ${INTEGRATION}/failure-1.X\n+        check\n+        cd -\n+        ;;\n+    *)\n+        git clone https://github.com/rust-lang-nursery/${INTEGRATION}.git\n+        cd ${INTEGRATION}\n+        check\n+        cd -\n+        ;;\n+esac"}]}