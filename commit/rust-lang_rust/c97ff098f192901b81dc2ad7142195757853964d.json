{"sha": "c97ff098f192901b81dc2ad7142195757853964d", "node_id": "MDY6Q29tbWl0NzI0NzEyOmM5N2ZmMDk4ZjE5MjkwMWI4MWRjMmFkNzE0MjE5NTc1Nzg1Mzk2NGQ=", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2021-09-17T05:09:49Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-09-17T05:09:49Z"}, "message": "Rollup merge of #88911 - FabianWolff:issue-88653, r=petrochenkov\n\nImprove error message for type mismatch in generator arguments\n\nFixes #88653. The code example given there is invalid because the `Generator` trait (unlike the `Fn` traits) does not take the generator arguments in tupled-up form (because there can only be one argument, from my understanding). Hence, the type error in the example in #88653 is correct, because the given generator takes a `bool` argument, whereas the function's return type talks about a generator with a `(bool,)` argument.\n\nThe error message is both confusing and wrong, though: It is wrong because it displays the wrong \"expected signature\", and it is confusing because both the \"expected\" and \"found\" notes point at the same span. With my changes, I get the following, more helpful output:\n```\nerror[E0631]: type mismatch in generator arguments\n --> test.rs:5:22\n  |\n5 | fn foo(bar: bool) -> impl Generator<(bool,)> {\n  |                      ^^^^^^^^^^^^^^^^^^^^^^^ expected signature of `fn((bool,)) -> _`\n6 |     |bar| {\n  |     ----- found signature of `fn(bool) -> _`\n```", "tree": {"sha": "16d5e079a59f18ddfe1bce4a0611c0e1c3d8832d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/16d5e079a59f18ddfe1bce4a0611c0e1c3d8832d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c97ff098f192901b81dc2ad7142195757853964d", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhRCMeCRBK7hj4Ov3rIwAAiqEIAA7bbN6NVr1uKMwCfj0mdpK2\nlSg1ejGf1St4du+4JClJpzEV4f3zm7vCg3pLKf5LTyO1m0I4tm8wsOu/1UpZ2DGk\naP9sSbVymoN5g02ZKuVdHomEGhpD20ezdvBFK+P1VkyntXHDs1or4qcMrl/vVFqq\nZ457DodiOLCDsyAsMsOOzzgMWMpsYcVTVd4ZCsiw6qTIF5qTs+m0nBjt0oXeO+ZT\nf+IlCcwInnDNJdDPkHhw9w6zOC8X6wZNCieyZT9772j8t6TTC3tmsdcDhqmgslu3\nj2n49oYdzoKsTW4ezjipPjJo08UiohF5Nn2FTysALrA+RnON/zdcMFB76h7odCQ=\n=3wKH\n-----END PGP SIGNATURE-----\n", "payload": "tree 16d5e079a59f18ddfe1bce4a0611c0e1c3d8832d\nparent 5d14396ed0b8efc06e3446bd3a6ed2c3e8eccd80\nparent cbd79836a5b7ef07e33213cb979294ad1b9faccc\nauthor Yuki Okushi <jtitor@2k36.org> 1631855389 +0900\ncommitter GitHub <noreply@github.com> 1631855389 +0900\n\nRollup merge of #88911 - FabianWolff:issue-88653, r=petrochenkov\n\nImprove error message for type mismatch in generator arguments\n\nFixes #88653. The code example given there is invalid because the `Generator` trait (unlike the `Fn` traits) does not take the generator arguments in tupled-up form (because there can only be one argument, from my understanding). Hence, the type error in the example in #88653 is correct, because the given generator takes a `bool` argument, whereas the function's return type talks about a generator with a `(bool,)` argument.\n\nThe error message is both confusing and wrong, though: It is wrong because it displays the wrong \"expected signature\", and it is confusing because both the \"expected\" and \"found\" notes point at the same span. With my changes, I get the following, more helpful output:\n```\nerror[E0631]: type mismatch in generator arguments\n --> test.rs:5:22\n  |\n5 | fn foo(bar: bool) -> impl Generator<(bool,)> {\n  |                      ^^^^^^^^^^^^^^^^^^^^^^^ expected signature of `fn((bool,)) -> _`\n6 |     |bar| {\n  |     ----- found signature of `fn(bool) -> _`\n```\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c97ff098f192901b81dc2ad7142195757853964d", "html_url": "https://github.com/rust-lang/rust/commit/c97ff098f192901b81dc2ad7142195757853964d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c97ff098f192901b81dc2ad7142195757853964d/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5d14396ed0b8efc06e3446bd3a6ed2c3e8eccd80", "url": "https://api.github.com/repos/rust-lang/rust/commits/5d14396ed0b8efc06e3446bd3a6ed2c3e8eccd80", "html_url": "https://github.com/rust-lang/rust/commit/5d14396ed0b8efc06e3446bd3a6ed2c3e8eccd80"}, {"sha": "cbd79836a5b7ef07e33213cb979294ad1b9faccc", "url": "https://api.github.com/repos/rust-lang/rust/commits/cbd79836a5b7ef07e33213cb979294ad1b9faccc", "html_url": "https://github.com/rust-lang/rust/commit/cbd79836a5b7ef07e33213cb979294ad1b9faccc"}], "stats": {"total": 69, "additions": 55, "deletions": 14}, "files": [{"sha": "e435154d9318e7b087a7bc98c84097b4f3e51b64", "filename": "compiler/rustc_trait_selection/src/traits/error_reporting/mod.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/c97ff098f192901b81dc2ad7142195757853964d/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c97ff098f192901b81dc2ad7142195757853964d/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs?ref=c97ff098f192901b81dc2ad7142195757853964d", "patch": "@@ -722,7 +722,10 @@ impl<'a, 'tcx> InferCtxtExt<'tcx> for InferCtxt<'a, 'tcx> {\n                 };\n \n                 let found_did = match *found_trait_ty.kind() {\n-                    ty::Closure(did, _) | ty::Foreign(did) | ty::FnDef(did, _) => Some(did),\n+                    ty::Closure(did, _)\n+                    | ty::Foreign(did)\n+                    | ty::FnDef(did, _)\n+                    | ty::Generator(did, ..) => Some(did),\n                     ty::Adt(def, _) => Some(def.did),\n                     _ => None,\n                 };"}, {"sha": "ae61988928f78e6ba2f317016718c2cf1df01c3f", "filename": "compiler/rustc_trait_selection/src/traits/error_reporting/suggestions.rs", "status": "modified", "additions": 20, "deletions": 13, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/c97ff098f192901b81dc2ad7142195757853964d/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c97ff098f192901b81dc2ad7142195757853964d/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs?ref=c97ff098f192901b81dc2ad7142195757853964d", "patch": "@@ -1256,33 +1256,40 @@ impl<'a, 'tcx> InferCtxtExt<'tcx> for InferCtxt<'a, 'tcx> {\n             trait_ref: ty::PolyTraitRef<'tcx>,\n         ) -> String {\n             let inputs = trait_ref.skip_binder().substs.type_at(1);\n-            let sig = if let ty::Tuple(inputs) = inputs.kind() {\n-                tcx.mk_fn_sig(\n-                    inputs.iter().map(|k| k.expect_ty()),\n-                    tcx.mk_ty_infer(ty::TyVar(ty::TyVid::from_u32(0))),\n-                    false,\n-                    hir::Unsafety::Normal,\n-                    abi::Abi::Rust,\n-                )\n-            } else {\n-                tcx.mk_fn_sig(\n+            let sig = match inputs.kind() {\n+                ty::Tuple(inputs)\n+                    if tcx.fn_trait_kind_from_lang_item(trait_ref.def_id()).is_some() =>\n+                {\n+                    tcx.mk_fn_sig(\n+                        inputs.iter().map(|k| k.expect_ty()),\n+                        tcx.mk_ty_infer(ty::TyVar(ty::TyVid::from_u32(0))),\n+                        false,\n+                        hir::Unsafety::Normal,\n+                        abi::Abi::Rust,\n+                    )\n+                }\n+                _ => tcx.mk_fn_sig(\n                     std::iter::once(inputs),\n                     tcx.mk_ty_infer(ty::TyVar(ty::TyVid::from_u32(0))),\n                     false,\n                     hir::Unsafety::Normal,\n                     abi::Abi::Rust,\n-                )\n+                ),\n             };\n             trait_ref.rebind(sig).to_string()\n         }\n \n-        let argument_is_closure = expected_ref.skip_binder().substs.type_at(0).is_closure();\n+        let argument_kind = match expected_ref.skip_binder().substs.type_at(0) {\n+            t if t.is_closure() => \"closure\",\n+            t if t.is_generator() => \"generator\",\n+            _ => \"function\",\n+        };\n         let mut err = struct_span_err!(\n             self.tcx.sess,\n             span,\n             E0631,\n             \"type mismatch in {} arguments\",\n-            if argument_is_closure { \"closure\" } else { \"function\" }\n+            argument_kind\n         );\n \n         let found_str = format!(\"expected signature of `{}`\", build_fn_sig_string(self.tcx, found));"}, {"sha": "ce9159b53e0f0a5b147e1e5f87df731e217e10ef", "filename": "src/test/ui/generator/issue-88653.rs", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/c97ff098f192901b81dc2ad7142195757853964d/src%2Ftest%2Fui%2Fgenerator%2Fissue-88653.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c97ff098f192901b81dc2ad7142195757853964d/src%2Ftest%2Fui%2Fgenerator%2Fissue-88653.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgenerator%2Fissue-88653.rs?ref=c97ff098f192901b81dc2ad7142195757853964d", "patch": "@@ -0,0 +1,19 @@\n+// Regression test for #88653, where a confusing warning about a\n+// type mismatch in generator arguments was issued.\n+\n+#![feature(generators, generator_trait)]\n+\n+use std::ops::Generator;\n+\n+fn foo(bar: bool) -> impl Generator<(bool,)> {\n+//~^ ERROR: type mismatch in generator arguments [E0631]\n+//~| NOTE: expected signature of `fn((bool,)) -> _`\n+    |bar| {\n+    //~^ NOTE: found signature of `fn(bool) -> _`\n+        if bar {\n+            yield bar;\n+        }\n+    }\n+}\n+\n+fn main() {}"}, {"sha": "5bd8ad129fef908d874662b5f04500e772afe288", "filename": "src/test/ui/generator/issue-88653.stderr", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/c97ff098f192901b81dc2ad7142195757853964d/src%2Ftest%2Fui%2Fgenerator%2Fissue-88653.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c97ff098f192901b81dc2ad7142195757853964d/src%2Ftest%2Fui%2Fgenerator%2Fissue-88653.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fgenerator%2Fissue-88653.stderr?ref=c97ff098f192901b81dc2ad7142195757853964d", "patch": "@@ -0,0 +1,12 @@\n+error[E0631]: type mismatch in generator arguments\n+  --> $DIR/issue-88653.rs:8:22\n+   |\n+LL | fn foo(bar: bool) -> impl Generator<(bool,)> {\n+   |                      ^^^^^^^^^^^^^^^^^^^^^^^ expected signature of `fn((bool,)) -> _`\n+...\n+LL |     |bar| {\n+   |     ----- found signature of `fn(bool) -> _`\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0631`."}]}