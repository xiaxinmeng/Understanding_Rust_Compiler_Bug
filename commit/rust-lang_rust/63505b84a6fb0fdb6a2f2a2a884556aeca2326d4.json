{"sha": "63505b84a6fb0fdb6a2f2a2a884556aeca2326d4", "node_id": "MDY6Q29tbWl0NzI0NzEyOjYzNTA1Yjg0YTZmYjBmZGI2YTJmMmEyYTg4NDU1NmFlY2EyMzI2ZDQ=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-01-31T16:21:39Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-01-31T16:21:39Z"}, "message": "Auto merge of #57914 - jethrogb:jb/sgx-unwind-version, r=alexcrichton\n\nSGX target: clean up dist builder, update libunwind\n\nThis incorporates https://github.com/fortanix/llvm-project/pull/4\n\nFixes https://github.com/fortanix/rust-sgx/issues/65\n\nr? @alexcrichton", "tree": {"sha": "f044db5e9aca7fe1d2f7a9250418cb65c5aeb3bd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f044db5e9aca7fe1d2f7a9250418cb65c5aeb3bd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/63505b84a6fb0fdb6a2f2a2a884556aeca2326d4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/63505b84a6fb0fdb6a2f2a2a884556aeca2326d4", "html_url": "https://github.com/rust-lang/rust/commit/63505b84a6fb0fdb6a2f2a2a884556aeca2326d4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/63505b84a6fb0fdb6a2f2a2a884556aeca2326d4/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8a0e5faec7f62e3cfd88d6625ce213d93b061305", "url": "https://api.github.com/repos/rust-lang/rust/commits/8a0e5faec7f62e3cfd88d6625ce213d93b061305", "html_url": "https://github.com/rust-lang/rust/commit/8a0e5faec7f62e3cfd88d6625ce213d93b061305"}, {"sha": "b025557e9703f2e8a52789ea50bcb7fe060fac54", "url": "https://api.github.com/repos/rust-lang/rust/commits/b025557e9703f2e8a52789ea50bcb7fe060fac54", "html_url": "https://github.com/rust-lang/rust/commit/b025557e9703f2e8a52789ea50bcb7fe060fac54"}], "stats": {"total": 60, "additions": 35, "deletions": 25}, "files": [{"sha": "97892405b8eb475c0dc7de0a0322332892043384", "filename": "src/ci/docker/dist-various-2/Dockerfile", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/63505b84a6fb0fdb6a2f2a2a884556aeca2326d4/src%2Fci%2Fdocker%2Fdist-various-2%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/63505b84a6fb0fdb6a2f2a2a884556aeca2326d4/src%2Fci%2Fdocker%2Fdist-various-2%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-various-2%2FDockerfile?ref=63505b84a6fb0fdb6a2f2a2a884556aeca2326d4", "patch": "@@ -32,7 +32,7 @@ RUN /tmp/build-solaris-toolchain.sh sparcv9 sparcv9 solaris-sparc\n COPY dist-various-2/build-x86_64-fortanix-unknown-sgx-toolchain.sh /tmp/\n # We pass the commit id of the port of LLVM's libunwind to the build script.\n # Any update to the commit id here, should cause the container image to be re-built from this point on.\n-RUN /tmp/build-x86_64-fortanix-unknown-sgx-toolchain.sh \"13fad13f8ea83a8da58d04a5faa45943151b3398\"\n+RUN /tmp/build-x86_64-fortanix-unknown-sgx-toolchain.sh \"53b586346f2c7870e20b170decdc30729d97c42b\"\n \n COPY scripts/sccache.sh /scripts/\n RUN sh /scripts/sccache.sh"}, {"sha": "725ec341b94978041256ef753fdd2a77c080fe14", "filename": "src/ci/docker/dist-various-2/build-x86_64-fortanix-unknown-sgx-toolchain.sh", "status": "modified", "additions": 15, "deletions": 20, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/63505b84a6fb0fdb6a2f2a2a884556aeca2326d4/src%2Fci%2Fdocker%2Fdist-various-2%2Fbuild-x86_64-fortanix-unknown-sgx-toolchain.sh", "raw_url": "https://github.com/rust-lang/rust/raw/63505b84a6fb0fdb6a2f2a2a884556aeca2326d4/src%2Fci%2Fdocker%2Fdist-various-2%2Fbuild-x86_64-fortanix-unknown-sgx-toolchain.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-various-2%2Fbuild-x86_64-fortanix-unknown-sgx-toolchain.sh?ref=63505b84a6fb0fdb6a2f2a2a884556aeca2326d4", "patch": "@@ -12,8 +12,7 @@ target=\"x86_64-fortanix-unknown-sgx\"\n url=\"https://github.com/fortanix/llvm-project/archive/${1}.tar.gz\"\n repo_name=\"llvm-project\"\n \n-install_prereq()\n-{\n+install_prereq() {\n     apt-get update\n     apt-get install -y --no-install-recommends \\\n             build-essential \\\n@@ -22,36 +21,32 @@ install_prereq()\n             git\n }\n \n-# Clone Fortanix's port of llvm-project to build libunwind that would link with this target.\n-# The below method to download a single commit from llvm-project is based on fetch_submodule\n-# from init_repo.sh\n-fetch_llvm_commit()\n-{\n-    cached=\"download-${repo_name}.tar.gz\"\n-    curl -f -sSL -o ${cached} ${url}\n-    tar -xvzf ${cached}\n-    mkdir \"./${repo_name}\" && tar -xf ${cached} -C ${repo_name} --strip-components 1\n-}\n-\n-build_unwind()\n-{\n+build_unwind() {\n+    set -x\n     dir_name=\"${target}_temp\"\n-    rm -rf \"./${dir_name}\"\n+    rm -rf ${dir_name}\n     mkdir -p ${dir_name}\n-    cd ${dir_name}\n+    pushd ${dir_name}\n \n-    retry fetch_llvm_commit\n+    # Clone Fortanix's fork of llvm-project which has a port of libunwind\n+    fetch_github_commit_archive \"$repo_name\" \"$url\"\n     cd \"${repo_name}/libunwind\"\n \n     # Build libunwind\n     mkdir -p build\n     cd build\n-    cmake -DCMAKE_BUILD_TYPE=\"RELEASE\" -DRUST_SGX=1 -G \"Unix Makefiles\" -DLLVM_PATH=../../llvm/ ../\n+    cmake -DCMAKE_BUILD_TYPE=\"RELEASE\" -DRUST_SGX=1 -G \"Unix Makefiles\" \\\n+        -DLLVM_ENABLE_WARNINGS=1 -DLIBUNWIND_ENABLE_WERROR=1 -DLIBUNWIND_ENABLE_PEDANTIC=0 \\\n+        -DLLVM_PATH=../../llvm/ ../\n     make unwind_static\n     install -D \"lib/libunwind.a\" \"/${target}/lib/libunwind.a\"\n+\n+    popd\n     rm -rf ${dir_name}\n+\n+    { set +x; } 2>/dev/null\n }\n \n set -x\n hide_output install_prereq\n-hide_output build_unwind\n+build_unwind"}, {"sha": "7abace65b9c03a1db28378137404e853c7b8bf4b", "filename": "src/ci/docker/dist-various-2/shared.sh", "status": "modified", "additions": 14, "deletions": 1, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/63505b84a6fb0fdb6a2f2a2a884556aeca2326d4/src%2Fci%2Fdocker%2Fdist-various-2%2Fshared.sh", "raw_url": "https://github.com/rust-lang/rust/raw/63505b84a6fb0fdb6a2f2a2a884556aeca2326d4/src%2Fci%2Fdocker%2Fdist-various-2%2Fshared.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-various-2%2Fshared.sh?ref=63505b84a6fb0fdb6a2f2a2a884556aeca2326d4", "patch": "@@ -1,5 +1,5 @@\n hide_output() {\n-  set +x\n+  { set +x; } 2>/dev/null\n   on_err=\"\n echo ERROR: An error was encountered with the build.\n cat /tmp/build.log\n@@ -14,6 +14,7 @@ exit 1\n   set -x\n }\n \n+# Copied from ../../shared.sh\n function retry {\n   echo \"Attempting with retry:\" \"$@\"\n   local n=1\n@@ -31,3 +32,15 @@ function retry {\n     }\n   done\n }\n+\n+# Copied from ../../init_repo.sh\n+function fetch_github_commit_archive {\n+    local module=$1\n+    local cached=\"download-${module//\\//-}.tar.gz\"\n+    retry sh -c \"rm -f $cached && \\\n+        curl -f -sSL -o $cached $2\"\n+    mkdir $module\n+    touch \"$module/.git\"\n+    tar -C $module --strip-components=1 -xf $cached\n+    rm $cached\n+}"}, {"sha": "3dfd3381576170b00edc3c1d851b993eb84a16e3", "filename": "src/ci/init_repo.sh", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/63505b84a6fb0fdb6a2f2a2a884556aeca2326d4/src%2Fci%2Finit_repo.sh", "raw_url": "https://github.com/rust-lang/rust/raw/63505b84a6fb0fdb6a2f2a2a884556aeca2326d4/src%2Fci%2Finit_repo.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Finit_repo.sh?ref=63505b84a6fb0fdb6a2f2a2a884556aeca2326d4", "patch": "@@ -34,11 +34,12 @@ if grep -q RUST_RELEASE_CHANNEL=beta src/ci/run.sh; then\n   git fetch origin --unshallow beta master\n fi\n \n-function fetch_submodule {\n+# Duplicated in docker/dist-various-2/shared.sh\n+function fetch_github_commit_archive {\n     local module=$1\n     local cached=\"download-${module//\\//-}.tar.gz\"\n     retry sh -c \"rm -f $cached && \\\n-        curl -sSL -o $cached $2\"\n+        curl -f -sSL -o $cached $2\"\n     mkdir $module\n     touch \"$module/.git\"\n     tar -C $module --strip-components=1 -xf $cached\n@@ -58,7 +59,7 @@ for i in ${!modules[@]}; do\n         git rm $module\n         url=${urls[$i]}\n         url=${url/\\.git/}\n-        fetch_submodule $module \"$url/archive/$commit.tar.gz\" &\n+        fetch_github_commit_archive $module \"$url/archive/$commit.tar.gz\" &\n         continue\n     else\n         use_git=\"$use_git $module\""}, {"sha": "3ba64ad412064e48b5eb3a91d84793fa891323bb", "filename": "src/ci/shared.sh", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/63505b84a6fb0fdb6a2f2a2a884556aeca2326d4/src%2Fci%2Fshared.sh", "raw_url": "https://github.com/rust-lang/rust/raw/63505b84a6fb0fdb6a2f2a2a884556aeca2326d4/src%2Fci%2Fshared.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fshared.sh?ref=63505b84a6fb0fdb6a2f2a2a884556aeca2326d4", "patch": "@@ -5,6 +5,7 @@\n # marked as an executable file in git.\n \n # See http://unix.stackexchange.com/questions/82598\n+# Duplicated in docker/dist-various-2/shared.sh\n function retry {\n   echo \"Attempting with retry:\" \"$@\"\n   local n=1"}]}