{"sha": "38cd9489f75f4a4387296ee304e2287f7c32c211", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM4Y2Q5NDg5Zjc1ZjRhNDM4NzI5NmVlMzA0ZTIyODdmN2MzMmMyMTE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-06-21T10:16:14Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-06-21T10:16:14Z"}, "message": "Auto merge of #61959 - oli-obk:const_field_ice, r=eddyb\n\nFix a hash collision issue on the `const_field` query\n\nfixes #61530", "tree": {"sha": "a5426f237dab435b99a07bd123e42ff45a49c457", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a5426f237dab435b99a07bd123e42ff45a49c457"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/38cd9489f75f4a4387296ee304e2287f7c32c211", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/38cd9489f75f4a4387296ee304e2287f7c32c211", "html_url": "https://github.com/rust-lang/rust/commit/38cd9489f75f4a4387296ee304e2287f7c32c211", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/38cd9489f75f4a4387296ee304e2287f7c32c211/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "56a12b2ad058f22f1ef090713df15598525ba4a4", "url": "https://api.github.com/repos/rust-lang/rust/commits/56a12b2ad058f22f1ef090713df15598525ba4a4", "html_url": "https://github.com/rust-lang/rust/commit/56a12b2ad058f22f1ef090713df15598525ba4a4"}, {"sha": "d46a373b391cb546f5a737fd5009f7733c220531", "url": "https://api.github.com/repos/rust-lang/rust/commits/d46a373b391cb546f5a737fd5009f7733c220531", "html_url": "https://github.com/rust-lang/rust/commit/d46a373b391cb546f5a737fd5009f7733c220531"}], "stats": {"total": 134, "additions": 85, "deletions": 49}, "files": [{"sha": "0ddc9211f98117aac1c30e6c7fb979feddf433f3", "filename": "src/librustc/ich/impls_ty.rs", "status": "modified", "additions": 10, "deletions": 5, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/38cd9489f75f4a4387296ee304e2287f7c32c211/src%2Flibrustc%2Fich%2Fimpls_ty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/38cd9489f75f4a4387296ee304e2287f7c32c211/src%2Flibrustc%2Fich%2Fimpls_ty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fich%2Fimpls_ty.rs?ref=38cd9489f75f4a4387296ee304e2287f7c32c211", "patch": "@@ -175,13 +175,18 @@ impl<'a> HashStable<StableHashingContext<'a>> for mir::interpret::Allocation {\n         hcx: &mut StableHashingContext<'a>,\n         hasher: &mut StableHasher<W>,\n     ) {\n-        self.bytes.hash_stable(hcx, hasher);\n-        for reloc in self.relocations.iter() {\n+        let mir::interpret::Allocation {\n+            bytes, relocations, undef_mask, align, mutability,\n+            extra: _,\n+        } = self;\n+        bytes.hash_stable(hcx, hasher);\n+        relocations.len().hash_stable(hcx, hasher);\n+        for reloc in relocations.iter() {\n             reloc.hash_stable(hcx, hasher);\n         }\n-        self.undef_mask.hash_stable(hcx, hasher);\n-        self.align.hash_stable(hcx, hasher);\n-        self.mutability.hash_stable(hcx, hasher);\n+        undef_mask.hash_stable(hcx, hasher);\n+        align.hash_stable(hcx, hasher);\n+        mutability.hash_stable(hcx, hasher);\n     }\n }\n "}, {"sha": "400a538baa96557070e89a27ed23610b693afa91", "filename": "src/librustc/infer/freshen.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/38cd9489f75f4a4387296ee304e2287f7c32c211/src%2Flibrustc%2Finfer%2Ffreshen.rs", "raw_url": "https://github.com/rust-lang/rust/raw/38cd9489f75f4a4387296ee304e2287f7c32c211/src%2Flibrustc%2Finfer%2Ffreshen.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Finfer%2Ffreshen.rs?ref=38cd9489f75f4a4387296ee304e2287f7c32c211", "patch": "@@ -260,7 +260,7 @@ impl<'a, 'tcx> TypeFolder<'tcx> for TypeFreshener<'a, 'tcx> {\n             ConstValue::Param(_) |\n             ConstValue::Scalar(_) |\n             ConstValue::Slice { .. } |\n-            ConstValue::ByRef(..) |\n+            ConstValue::ByRef { .. } |\n             ConstValue::Unevaluated(..) => {}\n         }\n "}, {"sha": "8381125798a0d5a79334457804c8cd1c4fda946a", "filename": "src/librustc/mir/interpret/allocation.rs", "status": "modified", "additions": 7, "deletions": 5, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/38cd9489f75f4a4387296ee304e2287f7c32c211/src%2Flibrustc%2Fmir%2Finterpret%2Fallocation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/38cd9489f75f4a4387296ee304e2287f7c32c211/src%2Flibrustc%2Fmir%2Finterpret%2Fallocation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmir%2Finterpret%2Fallocation.rs?ref=38cd9489f75f4a4387296ee304e2287f7c32c211", "patch": "@@ -247,7 +247,7 @@ impl<'tcx, Tag: Copy, Extra: AllocationExtra<Tag>> Allocation<Tag, Extra> {\n         assert_ne!(size.bytes(), 0, \"0-sized accesses should never even get a `Pointer`\");\n         self.check_bounds(cx, ptr, size, CheckInAllocMsg::MemoryAccessTest)?;\n \n-        self.mark_definedness(ptr, size, true)?;\n+        self.mark_definedness(ptr, size, true);\n         self.clear_relocations(cx, ptr, size)?;\n \n         AllocationExtra::memory_written(self, ptr, size)?;\n@@ -406,7 +406,10 @@ impl<'tcx, Tag: Copy, Extra: AllocationExtra<Tag>> Allocation<Tag, Extra> {\n     {\n         let val = match val {\n             ScalarMaybeUndef::Scalar(scalar) => scalar,\n-            ScalarMaybeUndef::Undef => return self.mark_definedness(ptr, type_size, false),\n+            ScalarMaybeUndef::Undef => {\n+                self.mark_definedness(ptr, type_size, false);\n+                return Ok(());\n+            },\n         };\n \n         let bytes = match val.to_bits_or_ptr(type_size, cx) {\n@@ -550,16 +553,15 @@ impl<'tcx, Tag, Extra> Allocation<Tag, Extra> {\n         ptr: Pointer<Tag>,\n         size: Size,\n         new_state: bool,\n-    ) -> InterpResult<'tcx> {\n+    ) {\n         if size.bytes() == 0 {\n-            return Ok(());\n+            return;\n         }\n         self.undef_mask.set_range(\n             ptr.offset,\n             ptr.offset + size,\n             new_state,\n         );\n-        Ok(())\n     }\n }\n "}, {"sha": "388c549324268452183254b523635654ffdb40ba", "filename": "src/librustc/mir/interpret/value.rs", "status": "modified", "additions": 16, "deletions": 9, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/38cd9489f75f4a4387296ee304e2287f7c32c211/src%2Flibrustc%2Fmir%2Finterpret%2Fvalue.rs", "raw_url": "https://github.com/rust-lang/rust/raw/38cd9489f75f4a4387296ee304e2287f7c32c211/src%2Flibrustc%2Fmir%2Finterpret%2Fvalue.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmir%2Finterpret%2Fvalue.rs?ref=38cd9489f75f4a4387296ee304e2287f7c32c211", "patch": "@@ -43,14 +43,21 @@ pub enum ConstValue<'tcx> {\n         end: usize,\n     },\n \n-    /// An allocation together with a pointer into the allocation.\n-    /// Invariant: the pointer's `AllocId` resolves to the allocation.\n-    /// The alignment exists to allow `const_field` to have `ByRef` access to nonprimitive fields\n-    /// of `repr(packed)` structs. The alignment may be lower than the type of this constant.\n-    /// This permits reads with lower alignment than what the type would normally require.\n-    /// FIXME(RalfJ,oli-obk): The alignment checks are part of miri, but const eval doesn't really\n-    /// need them. Disabling them may be too hard though.\n-    ByRef(Pointer, Align, &'tcx Allocation),\n+    /// A value not represented/representable by `Scalar` or `Slice`\n+    ByRef {\n+        /// The alignment exists to allow `const_field` to have `ByRef` access to nonprimitive\n+        /// fields of `repr(packed)` structs. The alignment may be lower than the type of this\n+        /// constant. This permits reads with lower alignment than what the type would normally\n+        /// require.\n+        /// FIXME(RalfJ,oli-obk): The alignment checks are part of miri, but const eval doesn't\n+        /// really need them. Disabling them may be too hard though.\n+        align: Align,\n+        /// Offset into `alloc`\n+        offset: Size,\n+        /// The backing memory of the value, may contain more memory than needed for just the value\n+        /// in order to share `Allocation`s between values\n+        alloc: &'tcx Allocation,\n+    },\n \n     /// Used in the HIR by using `Unevaluated` everywhere and later normalizing to one of the other\n     /// variants when the code is monomorphic enough for that.\n@@ -67,7 +74,7 @@ impl<'tcx> ConstValue<'tcx> {\n             ConstValue::Param(_) |\n             ConstValue::Infer(_) |\n             ConstValue::Placeholder(_) |\n-            ConstValue::ByRef(..) |\n+            ConstValue::ByRef{ .. } |\n             ConstValue::Unevaluated(..) |\n             ConstValue::Slice { .. } => None,\n             ConstValue::Scalar(val) => Some(val),"}, {"sha": "c12402a57cc3cfcd416779e4e0ddda45072ef012", "filename": "src/librustc/ty/print/obsolete.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/38cd9489f75f4a4387296ee304e2287f7c32c211/src%2Flibrustc%2Fty%2Fprint%2Fobsolete.rs", "raw_url": "https://github.com/rust-lang/rust/raw/38cd9489f75f4a4387296ee304e2287f7c32c211/src%2Flibrustc%2Fty%2Fprint%2Fobsolete.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fprint%2Fobsolete.rs?ref=38cd9489f75f4a4387296ee304e2287f7c32c211", "patch": "@@ -186,7 +186,7 @@ impl DefPathBasedNames<'tcx> {\n     // as well as the unprintable types of constants (see `push_type_name` for more details).\n     pub fn push_const_name(&self, c: &Const<'tcx>, output: &mut String, debug: bool) {\n         match c.val {\n-            ConstValue::Scalar(..) | ConstValue::Slice { .. } | ConstValue::ByRef(..) => {\n+            ConstValue::Scalar(..) | ConstValue::Slice { .. } | ConstValue::ByRef { .. } => {\n                 // FIXME(const_generics): we could probably do a better job here.\n                 write!(output, \"{:?}\", c).unwrap()\n             }"}, {"sha": "46adb7eb2a47642d8b61214c7791b7d7f5407ce1", "filename": "src/librustc/ty/relate.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/38cd9489f75f4a4387296ee304e2287f7c32c211/src%2Flibrustc%2Fty%2Frelate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/38cd9489f75f4a4387296ee304e2287f7c32c211/src%2Flibrustc%2Fty%2Frelate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Frelate.rs?ref=38cd9489f75f4a4387296ee304e2287f7c32c211", "patch": "@@ -594,7 +594,7 @@ pub fn super_relate_consts<R: TypeRelation<'tcx>>(\n                 ty: a.ty,\n             }))\n         }\n-        (ConstValue::ByRef(..), _) => {\n+        (ConstValue::ByRef { .. }, _) => {\n             bug!(\n                 \"non-Scalar ConstValue encountered in super_relate_consts {:?} {:?}\",\n                 a,"}, {"sha": "ced2c8c465da498d70fe6cf15d5cd68c2690c133", "filename": "src/librustc/ty/structural_impls.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/38cd9489f75f4a4387296ee304e2287f7c32c211/src%2Flibrustc%2Fty%2Fstructural_impls.rs", "raw_url": "https://github.com/rust-lang/rust/raw/38cd9489f75f4a4387296ee304e2287f7c32c211/src%2Flibrustc%2Fty%2Fstructural_impls.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fstructural_impls.rs?ref=38cd9489f75f4a4387296ee304e2287f7c32c211", "patch": "@@ -1335,7 +1335,8 @@ impl<'tcx> TypeFoldable<'tcx> for &'tcx ty::Const<'tcx> {\n impl<'tcx> TypeFoldable<'tcx> for ConstValue<'tcx> {\n     fn super_fold_with<F: TypeFolder<'tcx>>(&self, folder: &mut F) -> Self {\n         match *self {\n-            ConstValue::ByRef(ptr, align, alloc) => ConstValue::ByRef(ptr, align, alloc),\n+            ConstValue::ByRef { offset, align, alloc } =>\n+                ConstValue::ByRef { offset, align, alloc },\n             ConstValue::Infer(ic) => ConstValue::Infer(ic.fold_with(folder)),\n             ConstValue::Param(p) => ConstValue::Param(p.fold_with(folder)),\n             ConstValue::Placeholder(p) => ConstValue::Placeholder(p),\n@@ -1348,7 +1349,7 @@ impl<'tcx> TypeFoldable<'tcx> for ConstValue<'tcx> {\n \n     fn super_visit_with<V: TypeVisitor<'tcx>>(&self, visitor: &mut V) -> bool {\n         match *self {\n-            ConstValue::ByRef(..) => false,\n+            ConstValue::ByRef { .. } => false,\n             ConstValue::Infer(ic) => ic.visit_with(visitor),\n             ConstValue::Param(p) => p.visit_with(visitor),\n             ConstValue::Placeholder(_) => false,"}, {"sha": "24167a2f88713249eda7e55bd2401a7a6f2c72d7", "filename": "src/librustc_codegen_llvm/consts.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/38cd9489f75f4a4387296ee304e2287f7c32c211/src%2Flibrustc_codegen_llvm%2Fconsts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/38cd9489f75f4a4387296ee304e2287f7c32c211/src%2Flibrustc_codegen_llvm%2Fconsts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fconsts.rs?ref=38cd9489f75f4a4387296ee304e2287f7c32c211", "patch": "@@ -71,7 +71,9 @@ pub fn codegen_static_initializer(\n     let static_ = cx.tcx.const_eval(param_env.and(cid))?;\n \n     let alloc = match static_.val {\n-        ConstValue::ByRef(ptr, align, alloc) if ptr.offset.bytes() == 0 && align == alloc.align => {\n+        ConstValue::ByRef {\n+            offset, align, alloc,\n+        } if offset.bytes() == 0 && align == alloc.align => {\n             alloc\n         },\n         _ => bug!(\"static const eval returned {:#?}\", static_),"}, {"sha": "4a6752fec3556a1e7a205841f40bd2a64e24d6c1", "filename": "src/librustc_codegen_ssa/mir/operand.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/38cd9489f75f4a4387296ee304e2287f7c32c211/src%2Flibrustc_codegen_ssa%2Fmir%2Foperand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/38cd9489f75f4a4387296ee304e2287f7c32c211/src%2Flibrustc_codegen_ssa%2Fmir%2Foperand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fmir%2Foperand.rs?ref=38cd9489f75f4a4387296ee304e2287f7c32c211", "patch": "@@ -109,8 +109,8 @@ impl<'a, 'tcx, V: CodegenObject> OperandRef<'tcx, V> {\n                 let b_llval = bx.const_usize((end - start) as u64);\n                 OperandValue::Pair(a_llval, b_llval)\n             },\n-            ConstValue::ByRef(ptr, align, alloc) => {\n-                return bx.load_operand(bx.from_const_alloc(layout, align, alloc, ptr.offset));\n+            ConstValue::ByRef { offset, align, alloc } => {\n+                return bx.load_operand(bx.from_const_alloc(layout, align, alloc, offset));\n             },\n         };\n "}, {"sha": "d56f39c6de204a7762c9b734b421aa54cfca19c8", "filename": "src/librustc_codegen_ssa/mir/place.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/38cd9489f75f4a4387296ee304e2287f7c32c211/src%2Flibrustc_codegen_ssa%2Fmir%2Fplace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/38cd9489f75f4a4387296ee304e2287f7c32c211/src%2Flibrustc_codegen_ssa%2Fmir%2Fplace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fmir%2Fplace.rs?ref=38cd9489f75f4a4387296ee304e2287f7c32c211", "patch": "@@ -424,8 +424,8 @@ impl<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>> FunctionCx<'a, 'tcx, Bx> {\n                 let layout = cx.layout_of(self.monomorphize(&ty));\n                 match bx.tcx().const_eval(param_env.and(cid)) {\n                     Ok(val) => match val.val {\n-                        mir::interpret::ConstValue::ByRef(ptr, align, alloc) => {\n-                            bx.cx().from_const_alloc(layout, align, alloc, ptr.offset)\n+                        mir::interpret::ConstValue::ByRef { offset, align, alloc } => {\n+                            bx.cx().from_const_alloc(layout, align, alloc, offset)\n                         }\n                         _ => bug!(\"promoteds should have an allocation: {:?}\", val),\n                     },"}, {"sha": "67bcd4943e79a32ad7847ef1114b79c7d45f73b0", "filename": "src/librustc_mir/const_eval.rs", "status": "modified", "additions": 7, "deletions": 7, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/38cd9489f75f4a4387296ee304e2287f7c32c211/src%2Flibrustc_mir%2Fconst_eval.rs", "raw_url": "https://github.com/rust-lang/rust/raw/38cd9489f75f4a4387296ee304e2287f7c32c211/src%2Flibrustc_mir%2Fconst_eval.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fconst_eval.rs?ref=38cd9489f75f4a4387296ee304e2287f7c32c211", "patch": "@@ -99,7 +99,7 @@ fn op_to_const<'tcx>(\n         Ok(mplace) => {\n             let ptr = mplace.ptr.to_ptr().unwrap();\n             let alloc = ecx.tcx.alloc_map.lock().unwrap_memory(ptr.alloc_id);\n-            ConstValue::ByRef(ptr, mplace.align, alloc)\n+            ConstValue::ByRef { offset: ptr.offset, align: mplace.align, alloc }\n         },\n         // see comment on `let try_as_immediate` above\n         Err(ImmTy { imm: Immediate::Scalar(x), .. }) => match x {\n@@ -113,7 +113,7 @@ fn op_to_const<'tcx>(\n                 let mplace = op.to_mem_place();\n                 let ptr = mplace.ptr.to_ptr().unwrap();\n                 let alloc = ecx.tcx.alloc_map.lock().unwrap_memory(ptr.alloc_id);\n-                ConstValue::ByRef(ptr, mplace.align, alloc)\n+                ConstValue::ByRef { offset: ptr.offset, align: mplace.align, alloc }\n             },\n         },\n         Err(ImmTy { imm: Immediate::ScalarPair(a, b), .. }) => {\n@@ -541,11 +541,11 @@ fn validate_and_turn_into_const<'tcx>(\n         if tcx.is_static(def_id) || cid.promoted.is_some() {\n             let ptr = mplace.ptr.to_ptr()?;\n             Ok(tcx.mk_const(ty::Const {\n-                val: ConstValue::ByRef(\n-                    ptr,\n-                    mplace.align,\n-                    ecx.tcx.alloc_map.lock().unwrap_memory(ptr.alloc_id),\n-                ),\n+                val: ConstValue::ByRef {\n+                    offset: ptr.offset,\n+                    align: mplace.align,\n+                    alloc: ecx.tcx.alloc_map.lock().unwrap_memory(ptr.alloc_id),\n+                },\n                 ty: mplace.layout.ty,\n             }))\n         } else {"}, {"sha": "fc2951895f3fe9bd1cc2bd96cd7e8876005780b6", "filename": "src/librustc_mir/hair/pattern/_match.rs", "status": "modified", "additions": 9, "deletions": 8, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/38cd9489f75f4a4387296ee304e2287f7c32c211/src%2Flibrustc_mir%2Fhair%2Fpattern%2F_match.rs", "raw_url": "https://github.com/rust-lang/rust/raw/38cd9489f75f4a4387296ee304e2287f7c32c211/src%2Flibrustc_mir%2Fhair%2Fpattern%2F_match.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fhair%2Fpattern%2F_match.rs?ref=38cd9489f75f4a4387296ee304e2287f7c32c211", "patch": "@@ -217,12 +217,12 @@ impl LiteralExpander<'tcx> {\n             // the easy case, deref a reference\n             (ConstValue::Scalar(Scalar::Ptr(p)), x, y) if x == y => {\n                 let alloc = self.tcx.alloc_map.lock().unwrap_memory(p.alloc_id);\n-                ConstValue::ByRef(\n-                    p,\n+                ConstValue::ByRef {\n+                    offset: p.offset,\n                     // FIXME(oli-obk): this should be the type's layout\n-                    alloc.align,\n+                    align: alloc.align,\n                     alloc,\n-                )\n+                }\n             },\n             // unsize array to slice if pattern is array but match value or other patterns are slice\n             (ConstValue::Scalar(Scalar::Ptr(p)), ty::Array(t, n), ty::Slice(u)) => {\n@@ -1436,9 +1436,10 @@ fn slice_pat_covered_by_const<'tcx>(\n     suffix: &[Pattern<'tcx>],\n ) -> Result<bool, ErrorReported> {\n     let data: &[u8] = match (const_val.val, &const_val.ty.sty) {\n-        (ConstValue::ByRef(ptr, _, alloc), ty::Array(t, n)) => {\n+        (ConstValue::ByRef { offset, alloc, .. }, ty::Array(t, n)) => {\n             assert_eq!(*t, tcx.types.u8);\n             let n = n.assert_usize(tcx).unwrap();\n+            let ptr = Pointer::new(AllocId(0), offset);\n             alloc.get_bytes(&tcx, ptr, Size::from_bytes(n)).unwrap()\n         },\n         (ConstValue::Slice { data, start, end }, ty::Slice(t)) => {\n@@ -1758,9 +1759,9 @@ fn specialize<'p, 'a: 'p, 'tcx>(\n                     let (alloc, offset, n, ty) = match value.ty.sty {\n                         ty::Array(t, n) => {\n                             match value.val {\n-                                ConstValue::ByRef(ptr, _, alloc) => (\n+                                ConstValue::ByRef { offset, alloc, .. } => (\n                                     alloc,\n-                                    ptr.offset,\n+                                    offset,\n                                     n.unwrap_usize(cx.tcx),\n                                     t,\n                                 ),\n@@ -1778,7 +1779,7 @@ fn specialize<'p, 'a: 'p, 'tcx>(\n                                     (end - start) as u64,\n                                     t,\n                                 ),\n-                                ConstValue::ByRef(..) => {\n+                                ConstValue::ByRef { .. } => {\n                                     // FIXME(oli-obk): implement `deref` for `ConstValue`\n                                     return None;\n                                 },"}, {"sha": "ec391b7bc5f0201814ab567b23c3e9a057fa5635", "filename": "src/librustc_mir/interpret/operand.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/38cd9489f75f4a4387296ee304e2287f7c32c211/src%2Flibrustc_mir%2Finterpret%2Foperand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/38cd9489f75f4a4387296ee304e2287f7c32c211/src%2Flibrustc_mir%2Finterpret%2Foperand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Finterpret%2Foperand.rs?ref=38cd9489f75f4a4387296ee304e2287f7c32c211", "patch": "@@ -538,10 +538,11 @@ impl<'mir, 'tcx, M: Machine<'mir, 'tcx>> InterpretCx<'mir, 'tcx, M> {\n             self.layout_of(self.monomorphize(val.ty)?)\n         })?;\n         let op = match val.val {\n-            ConstValue::ByRef(ptr, align, _alloc) => {\n+            ConstValue::ByRef { offset, align, alloc } => {\n+                let id = self.tcx.alloc_map.lock().create_memory_alloc(alloc);\n                 // We rely on mutability being set correctly in that allocation to prevent writes\n                 // where none should happen.\n-                let ptr = self.tag_static_base_pointer(ptr);\n+                let ptr = self.tag_static_base_pointer(Pointer::new(id, offset));\n                 Operand::Indirect(MemPlace::from_ptr(ptr, align))\n             },\n             ConstValue::Scalar(x) =>"}, {"sha": "bb2738d5aa4a32437ff4898e99b7109d2a7a4a54", "filename": "src/librustc_mir/monomorphize/collector.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/38cd9489f75f4a4387296ee304e2287f7c32c211/src%2Flibrustc_mir%2Fmonomorphize%2Fcollector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/38cd9489f75f4a4387296ee304e2287f7c32c211/src%2Flibrustc_mir%2Fmonomorphize%2Fcollector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fmonomorphize%2Fcollector.rs?ref=38cd9489f75f4a4387296ee304e2287f7c32c211", "patch": "@@ -1262,7 +1262,7 @@ fn collect_const<'tcx>(\n         ConstValue::Scalar(Scalar::Ptr(ptr)) =>\n             collect_miri(tcx, ptr.alloc_id, output),\n         ConstValue::Slice { data: alloc, start: _, end: _ } |\n-        ConstValue::ByRef(_, _, alloc) => {\n+        ConstValue::ByRef { alloc, .. } => {\n             for &((), id) in alloc.relocations.values() {\n                 collect_miri(tcx, id, output);\n             }"}, {"sha": "bde4f804574513d1741f7193ddefb07e85cfe0a6", "filename": "src/librustc_typeck/check/mod.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/38cd9489f75f4a4387296ee304e2287f7c32c211/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/38cd9489f75f4a4387296ee304e2287f7c32c211/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs?ref=38cd9489f75f4a4387296ee304e2287f7c32c211", "patch": "@@ -1448,8 +1448,8 @@ fn maybe_check_static_with_link_section(tcx: TyCtxt<'_>, id: DefId, span: Span)\n     };\n     let param_env = ty::ParamEnv::reveal_all();\n     if let Ok(static_) = tcx.const_eval(param_env.and(cid)) {\n-        let alloc = if let ConstValue::ByRef(_, _, allocation) = static_.val {\n-            allocation\n+        let alloc = if let ConstValue::ByRef { alloc, .. } = static_.val {\n+            alloc\n         } else {\n             bug!(\"Matching on non-ByRef static\")\n         };"}, {"sha": "06b2957ac62c9778512404b61cc2680332627abb", "filename": "src/test/incremental/issue-61530.rs", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/38cd9489f75f4a4387296ee304e2287f7c32c211/src%2Ftest%2Fincremental%2Fissue-61530.rs", "raw_url": "https://github.com/rust-lang/rust/raw/38cd9489f75f4a4387296ee304e2287f7c32c211/src%2Ftest%2Fincremental%2Fissue-61530.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fincremental%2Fissue-61530.rs?ref=38cd9489f75f4a4387296ee304e2287f7c32c211", "patch": "@@ -0,0 +1,17 @@\n+#![feature(repr_simd, platform_intrinsics)]\n+\n+// revisions:rpass1 rpass2\n+\n+#[repr(simd)]\n+struct I32x2(i32, i32);\n+\n+extern \"platform-intrinsic\" {\n+    fn simd_shuffle2<T, U>(x: T, y: T, idx: [u32; 2]) -> U;\n+}\n+\n+fn main() {\n+    unsafe {\n+        let _: I32x2 = simd_shuffle2(I32x2(1, 2), I32x2(3, 4), [0, 0]);\n+        let _: I32x2 = simd_shuffle2(I32x2(1, 2), I32x2(3, 4), [0, 0]);\n+    }\n+}"}]}