{"sha": "86dad6e3dd285678335252bef12169232096a97b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg2ZGFkNmUzZGQyODU2NzgzMzUyNTJiZWYxMjE2OTIzMjA5NmE5N2I=", "commit": {"author": {"name": "Seiichi Uchida", "email": "seuchida@gmail.com", "date": "2019-05-21T22:00:07Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-05-21T22:00:07Z"}, "message": "Merge pull request #3576 from rchaser53/issue-3567\n\nadd the handling for vec! with paren inside macro", "tree": {"sha": "8dd2fd029e392fd8686159c24624f9620baf79e5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8dd2fd029e392fd8686159c24624f9620baf79e5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/86dad6e3dd285678335252bef12169232096a97b", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJc5HTnCRBK7hj4Ov3rIwAAdHIIAApN2diUh1H1maYrVfnjZ7dH\nVo7lDgj7ME4T9uZQwyweE5vJzWUPrVgLFYdxXjlgGfJXOYuKww6ERB5rtETxRnAg\nXmM3pMjcDd1lFKEvj8tdICZyE5Kktk2bypz0o0oExGyzmNZO8z6mqzxJ2wdsvoam\n28zkFreyI6VzQdfTsx8IU/NjKY/PH6QhzubVCc53f+PaM8M4Z1hIbrR9qaMnUcKv\nPAgilVQps2FvUc+disCsZPDLjEuIfN0w8wldf34hgRVX4R8jxVpqCEtWFa+efshO\nQnMxIAS+8Bb7f5iH8QfPUA73smp5JN3oNlsEKdxhzrQNmCP0/CDmerxIY2rBwf8=\n=LMk6\n-----END PGP SIGNATURE-----\n", "payload": "tree 8dd2fd029e392fd8686159c24624f9620baf79e5\nparent 27871389365b64c547acdd26f93a79f172532cbe\nparent bee1a32f26301d91284f8dd91ec153b830b3498d\nauthor Seiichi Uchida <seuchida@gmail.com> 1558476007 +0900\ncommitter GitHub <noreply@github.com> 1558476007 +0900\n\nMerge pull request #3576 from rchaser53/issue-3567\n\nadd the handling for vec! with paren inside macro"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/86dad6e3dd285678335252bef12169232096a97b", "html_url": "https://github.com/rust-lang/rust/commit/86dad6e3dd285678335252bef12169232096a97b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/86dad6e3dd285678335252bef12169232096a97b/comments", "author": {"login": "topecongiro", "id": 21980157, "node_id": "MDQ6VXNlcjIxOTgwMTU3", "avatar_url": "https://avatars.githubusercontent.com/u/21980157?v=4", "gravatar_id": "", "url": "https://api.github.com/users/topecongiro", "html_url": "https://github.com/topecongiro", "followers_url": "https://api.github.com/users/topecongiro/followers", "following_url": "https://api.github.com/users/topecongiro/following{/other_user}", "gists_url": "https://api.github.com/users/topecongiro/gists{/gist_id}", "starred_url": "https://api.github.com/users/topecongiro/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/topecongiro/subscriptions", "organizations_url": "https://api.github.com/users/topecongiro/orgs", "repos_url": "https://api.github.com/users/topecongiro/repos", "events_url": "https://api.github.com/users/topecongiro/events{/privacy}", "received_events_url": "https://api.github.com/users/topecongiro/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "27871389365b64c547acdd26f93a79f172532cbe", "url": "https://api.github.com/repos/rust-lang/rust/commits/27871389365b64c547acdd26f93a79f172532cbe", "html_url": "https://github.com/rust-lang/rust/commit/27871389365b64c547acdd26f93a79f172532cbe"}, {"sha": "bee1a32f26301d91284f8dd91ec153b830b3498d", "url": "https://api.github.com/repos/rust-lang/rust/commits/bee1a32f26301d91284f8dd91ec153b830b3498d", "html_url": "https://github.com/rust-lang/rust/commit/bee1a32f26301d91284f8dd91ec153b830b3498d"}], "stats": {"total": 110, "additions": 69, "deletions": 41}, "files": [{"sha": "a42b839f9c5072476d27bd70fc612f11faa46e2d", "filename": "src/macros.rs", "status": "modified", "additions": 66, "deletions": 41, "changes": 107, "blob_url": "https://github.com/rust-lang/rust/blob/86dad6e3dd285678335252bef12169232096a97b/src%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/86dad6e3dd285678335252bef12169232096a97b/src%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fmacros.rs?ref=86dad6e3dd285678335252bef12169232096a97b", "patch": "@@ -361,51 +361,35 @@ fn rewrite_macro_inner(\n \n     match style {\n         DelimToken::Paren => {\n-            // Format macro invocation as function call, preserve the trailing\n-            // comma because not all macros support them.\n-            overflow::rewrite_with_parens(\n-                context,\n-                &macro_name,\n-                arg_vec.iter(),\n-                shape,\n-                mac.span,\n-                context.config.width_heuristics().fn_call_width,\n-                if trailing_comma {\n-                    Some(SeparatorTactic::Always)\n-                } else {\n-                    Some(SeparatorTactic::Never)\n-                },\n-            )\n-            .map(|rw| match position {\n-                MacroPosition::Item => format!(\"{};\", rw),\n-                _ => rw,\n-            })\n+            // Handle special case: `vec!(expr; expr)`\n+            if vec_with_semi {\n+                handle_vec_semi(context, shape, arg_vec, macro_name, style)\n+            } else {\n+                // Format macro invocation as function call, preserve the trailing\n+                // comma because not all macros support them.\n+                overflow::rewrite_with_parens(\n+                    context,\n+                    &macro_name,\n+                    arg_vec.iter(),\n+                    shape,\n+                    mac.span,\n+                    context.config.width_heuristics().fn_call_width,\n+                    if trailing_comma {\n+                        Some(SeparatorTactic::Always)\n+                    } else {\n+                        Some(SeparatorTactic::Never)\n+                    },\n+                )\n+                .map(|rw| match position {\n+                    MacroPosition::Item => format!(\"{};\", rw),\n+                    _ => rw,\n+                })\n+            }\n         }\n         DelimToken::Bracket => {\n             // Handle special case: `vec![expr; expr]`\n             if vec_with_semi {\n-                let mac_shape = shape.offset_left(macro_name.len())?;\n-                // 8 = `vec![]` + `; `\n-                let total_overhead = 8;\n-                let nested_shape = mac_shape.block_indent(context.config.tab_spaces());\n-                let lhs = arg_vec[0].rewrite(context, nested_shape)?;\n-                let rhs = arg_vec[1].rewrite(context, nested_shape)?;\n-                if !lhs.contains('\\n')\n-                    && !rhs.contains('\\n')\n-                    && lhs.len() + rhs.len() + total_overhead <= shape.width\n-                {\n-                    Some(format!(\"{}[{}; {}]\", macro_name, lhs, rhs))\n-                } else {\n-                    Some(format!(\n-                        \"{}[{}{};{}{}{}]\",\n-                        macro_name,\n-                        nested_shape.indent.to_string_with_newline(context.config),\n-                        lhs,\n-                        nested_shape.indent.to_string_with_newline(context.config),\n-                        rhs,\n-                        shape.indent.to_string_with_newline(context.config),\n-                    ))\n-                }\n+                handle_vec_semi(context, shape, arg_vec, macro_name, style)\n             } else {\n                 // If we are rewriting `vec!` macro or other special macros,\n                 // then we can rewrite this as an usual array literal.\n@@ -453,6 +437,47 @@ fn rewrite_macro_inner(\n     }\n }\n \n+fn handle_vec_semi(\n+    context: &RewriteContext<'_>,\n+    shape: Shape,\n+    arg_vec: Vec<MacroArg>,\n+    macro_name: String,\n+    delim_token: DelimToken,\n+) -> Option<String> {\n+    let (left, right) = match delim_token {\n+        DelimToken::Paren => (\"(\", \")\"),\n+        DelimToken::Bracket => (\"[\", \"]\"),\n+        _ => unreachable!(),\n+    };\n+\n+    let mac_shape = shape.offset_left(macro_name.len())?;\n+    // 8 = `vec![]` + `; ` or `vec!()` + `; `\n+    let total_overhead = 8;\n+    let nested_shape = mac_shape.block_indent(context.config.tab_spaces());\n+    let lhs = arg_vec[0].rewrite(context, nested_shape)?;\n+    let rhs = arg_vec[1].rewrite(context, nested_shape)?;\n+    if !lhs.contains('\\n')\n+        && !rhs.contains('\\n')\n+        && lhs.len() + rhs.len() + total_overhead <= shape.width\n+    {\n+        // macro_name(lhs; rhs) or macro_name[lhs; rhs]\n+        Some(format!(\"{}{}{}; {}{}\", macro_name, left, lhs, rhs, right))\n+    } else {\n+        // macro_name(\\nlhs;\\nrhs\\n) or macro_name[\\nlhs;\\nrhs\\n]\n+        Some(format!(\n+            \"{}{}{}{};{}{}{}{}\",\n+            macro_name,\n+            left,\n+            nested_shape.indent.to_string_with_newline(context.config),\n+            lhs,\n+            nested_shape.indent.to_string_with_newline(context.config),\n+            rhs,\n+            shape.indent.to_string_with_newline(context.config),\n+            right\n+        ))\n+    }\n+}\n+\n pub(crate) fn rewrite_macro_def(\n     context: &RewriteContext<'_>,\n     shape: Shape,"}, {"sha": "3cf08628db0ba9f5a6d86fe74977b52da9849737", "filename": "tests/target/issue-3567.rs", "status": "added", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/86dad6e3dd285678335252bef12169232096a97b/tests%2Ftarget%2Fissue-3567.rs", "raw_url": "https://github.com/rust-lang/rust/raw/86dad6e3dd285678335252bef12169232096a97b/tests%2Ftarget%2Fissue-3567.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fissue-3567.rs?ref=86dad6e3dd285678335252bef12169232096a97b", "patch": "@@ -0,0 +1,3 @@\n+fn check() {\n+    vec![vec!(0; 10); 10];\n+}"}]}