{"sha": "cd2c2406c0c5a11d3e998998845ca5c8be683676", "node_id": "C_kwDOAAsO6NoAKGNkMmMyNDA2YzBjNWExMWQzZTk5ODk5ODg0NWNhNWM4YmU2ODM2NzY", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-07-20T15:33:19Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-07-20T15:33:19Z"}, "message": "Auto merge of #12833 - fasterthanlime:literal-tests, r=Veykril\n\nAdd proc-macro-srv integration test that clones literals\n\nThis exercises some of the upcoming proc_macro bridge changes. It should also pass for all supported ABIs, with the older-style bridge.\n\nThis changed is tracked in:\n\n  * https://github.com/rust-lang/rust-analyzer/issues/12818", "tree": {"sha": "c9b01339207e26a0b2d9b65f13b81f3242a91b84", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c9b01339207e26a0b2d9b65f13b81f3242a91b84"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cd2c2406c0c5a11d3e998998845ca5c8be683676", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cd2c2406c0c5a11d3e998998845ca5c8be683676", "html_url": "https://github.com/rust-lang/rust/commit/cd2c2406c0c5a11d3e998998845ca5c8be683676", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cd2c2406c0c5a11d3e998998845ca5c8be683676/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7dc36eeb781fcf35a69bb1a75e7005397a9da418", "url": "https://api.github.com/repos/rust-lang/rust/commits/7dc36eeb781fcf35a69bb1a75e7005397a9da418", "html_url": "https://github.com/rust-lang/rust/commit/7dc36eeb781fcf35a69bb1a75e7005397a9da418"}, {"sha": "f5042947ce93b40e5c6e7ddeb683d11e8faed51c", "url": "https://api.github.com/repos/rust-lang/rust/commits/f5042947ce93b40e5c6e7ddeb683d11e8faed51c", "html_url": "https://github.com/rust-lang/rust/commit/f5042947ce93b40e5c6e7ddeb683d11e8faed51c"}], "stats": {"total": 34, "additions": 30, "deletions": 4}, "files": [{"sha": "d4be992465cadca47f1ccbfb840567e902edd1fa", "filename": "crates/proc-macro-srv/src/tests/mod.rs", "status": "modified", "additions": 22, "deletions": 2, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/cd2c2406c0c5a11d3e998998845ca5c8be683676/crates%2Fproc-macro-srv%2Fsrc%2Ftests%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cd2c2406c0c5a11d3e998998845ca5c8be683676/crates%2Fproc-macro-srv%2Fsrc%2Ftests%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproc-macro-srv%2Fsrc%2Ftests%2Fmod.rs?ref=cd2c2406c0c5a11d3e998998845ca5c8be683676", "patch": "@@ -27,7 +27,7 @@ fn test_derive_error() {\n }\n \n #[test]\n-fn test_fn_like_macro() {\n+fn test_fn_like_macro_noop() {\n     assert_expand(\n         \"fn_like_noop\",\n         r#\"ident, 0, 1, []\"#,\n@@ -44,7 +44,7 @@ fn test_fn_like_macro() {\n }\n \n #[test]\n-fn test_fn_like_macro2() {\n+fn test_fn_like_macro_clone_ident_subtree() {\n     assert_expand(\n         \"fn_like_clone_tokens\",\n         r#\"ident, []\"#,\n@@ -56,6 +56,26 @@ fn test_fn_like_macro2() {\n     );\n }\n \n+#[test]\n+fn test_fn_like_macro_clone_literals() {\n+    assert_expand(\n+        \"fn_like_clone_tokens\",\n+        r#\"1u16, 2_u32, -4i64, 3.14f32, \"hello bridge\"\"#,\n+        expect![[r#\"\n+            SUBTREE $\n+              LITERAL 1u16 4294967295\n+              PUNCH   , [alone] 4294967295\n+              LITERAL 2_u32 4294967295\n+              PUNCH   , [alone] 4294967295\n+              PUNCH   - [alone] 4294967295\n+              LITERAL 4i64 4294967295\n+              PUNCH   , [alone] 4294967295\n+              LITERAL 3.14f32 4294967295\n+              PUNCH   , [alone] 4294967295\n+              LITERAL \"hello bridge\" 4294967295\"#]],\n+    );\n+}\n+\n #[test]\n fn test_attr_macro() {\n     // Corresponds to"}, {"sha": "0082eb7bdaf79e284dcc6c3bdafd2f1541460144", "filename": "crates/proc-macro-test/imp/src/lib.rs", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/cd2c2406c0c5a11d3e998998845ca5c8be683676/crates%2Fproc-macro-test%2Fimp%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cd2c2406c0c5a11d3e998998845ca5c8be683676/crates%2Fproc-macro-test%2Fimp%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproc-macro-test%2Fimp%2Fsrc%2Flib.rs?ref=cd2c2406c0c5a11d3e998998845ca5c8be683676", "patch": "@@ -2,7 +2,7 @@\n \n #![warn(rust_2018_idioms, unused_lifetimes, semicolon_in_expressions_from_macros)]\n \n-use proc_macro::{Group, Ident, Punct, TokenStream, TokenTree};\n+use proc_macro::{Group, Ident, Literal, Punct, TokenStream, TokenTree};\n \n #[proc_macro]\n pub fn fn_like_noop(args: TokenStream) -> TokenStream {\n@@ -71,6 +71,12 @@ fn clone_tree(t: TokenTree) -> TokenTree {\n             new.set_span(orig.span());\n             TokenTree::Punct(new)\n         }\n-        TokenTree::Literal(_orig) => unimplemented!(),\n+        TokenTree::Literal(orig) => {\n+            // this goes through `literal_from_str` as of 2022-07-18, cf.\n+            // https://github.com/rust-lang/rust/commit/b34c79f8f1ef4d0149ad4bf77e1759c07a9a01a8\n+            let mut new: Literal = orig.to_string().parse().unwrap();\n+            new.set_span(orig.span());\n+            TokenTree::Literal(new)\n+        }\n     }\n }"}]}