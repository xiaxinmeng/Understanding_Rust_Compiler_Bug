{"sha": "0aa4ac362d1a40e4aea98857d22a2cd3884aa215", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBhYTRhYzM2MmQxYTQwZTRhZWE5ODg1N2QyMmEyY2QzODg0YWEyMTU=", "commit": {"author": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2021-03-22T18:13:43Z"}, "committer": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2021-03-22T18:13:43Z"}, "message": "Correctly lower TraitRefs with default params", "tree": {"sha": "d5b08bd272f28ad16e7b6a23b3502434c2370e1e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d5b08bd272f28ad16e7b6a23b3502434c2370e1e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0aa4ac362d1a40e4aea98857d22a2cd3884aa215", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0aa4ac362d1a40e4aea98857d22a2cd3884aa215", "html_url": "https://github.com/rust-lang/rust/commit/0aa4ac362d1a40e4aea98857d22a2cd3884aa215", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0aa4ac362d1a40e4aea98857d22a2cd3884aa215/comments", "author": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "94aa3a7b1af7b756139e6c2d8384beb57daa6190", "url": "https://api.github.com/repos/rust-lang/rust/commits/94aa3a7b1af7b756139e6c2d8384beb57daa6190", "html_url": "https://github.com/rust-lang/rust/commit/94aa3a7b1af7b756139e6c2d8384beb57daa6190"}], "stats": {"total": 71, "additions": 63, "deletions": 8}, "files": [{"sha": "3153b5b74ff7a8eade36bfc059465f65474a93c5", "filename": "crates/hir_ty/src/lower.rs", "status": "modified", "additions": 17, "deletions": 8, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/0aa4ac362d1a40e4aea98857d22a2cd3884aa215/crates%2Fhir_ty%2Fsrc%2Flower.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0aa4ac362d1a40e4aea98857d22a2cd3884aa215/crates%2Fhir_ty%2Fsrc%2Flower.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Flower.rs?ref=0aa4ac362d1a40e4aea98857d22a2cd3884aa215", "patch": "@@ -521,7 +521,7 @@ impl<'a> TyLoweringContext<'a> {\n             TyDefId::AdtId(it) => Some(it.into()),\n             TyDefId::TypeAliasId(it) => Some(it.into()),\n         };\n-        let substs = self.substs_from_path_segment(segment, generic_def, infer_args);\n+        let substs = self.substs_from_path_segment(segment, generic_def, infer_args, None);\n         self.db.ty(typeable).subst(&substs)\n     }\n \n@@ -558,14 +558,15 @@ impl<'a> TyLoweringContext<'a> {\n                 (segment, Some(var.parent.into()))\n             }\n         };\n-        self.substs_from_path_segment(segment, generic_def, infer_args)\n+        self.substs_from_path_segment(segment, generic_def, infer_args, None)\n     }\n \n     fn substs_from_path_segment(\n         &self,\n         segment: PathSegment<'_>,\n         def_generic: Option<GenericDefId>,\n         infer_args: bool,\n+        explicit_self_ty: Option<Ty>,\n     ) -> Substitution {\n         let mut substs = Vec::new();\n         let def_generics = def_generic.map(|def| generics(self.db.upcast(), def));\n@@ -576,11 +577,19 @@ impl<'a> TyLoweringContext<'a> {\n \n         substs.extend(iter::repeat(TyKind::Unknown.intern(&Interner)).take(parent_params));\n \n+        let fill_self_params = || {\n+            substs.extend(\n+                explicit_self_ty\n+                    .into_iter()\n+                    .chain(iter::repeat(TyKind::Unknown.intern(&Interner)))\n+                    .take(self_params),\n+            )\n+        };\n         let mut had_explicit_type_args = false;\n \n         if let Some(generic_args) = &segment.args_and_bindings {\n             if !generic_args.has_self_type {\n-                substs.extend(iter::repeat(TyKind::Unknown.intern(&Interner)).take(self_params));\n+                fill_self_params();\n             }\n             let expected_num =\n                 if generic_args.has_self_type { self_params + type_params } else { type_params };\n@@ -602,6 +611,8 @@ impl<'a> TyLoweringContext<'a> {\n                     GenericArg::Lifetime(_) => {}\n                 }\n             }\n+        } else {\n+            fill_self_params();\n         }\n \n         // handle defaults. In expression or pattern path segments without\n@@ -650,10 +661,7 @@ impl<'a> TyLoweringContext<'a> {\n         segment: PathSegment<'_>,\n         explicit_self_ty: Option<Ty>,\n     ) -> TraitRef {\n-        let mut substs = self.trait_ref_substs_from_path(segment, resolved);\n-        if let Some(self_ty) = explicit_self_ty {\n-            substs.0[0] = self_ty;\n-        }\n+        let substs = self.trait_ref_substs_from_path(segment, resolved, explicit_self_ty);\n         TraitRef { trait_id: to_chalk_trait_id(resolved), substitution: substs }\n     }\n \n@@ -673,8 +681,9 @@ impl<'a> TyLoweringContext<'a> {\n         &self,\n         segment: PathSegment<'_>,\n         resolved: TraitId,\n+        explicit_self_ty: Option<Ty>,\n     ) -> Substitution {\n-        self.substs_from_path_segment(segment, Some(resolved.into()), false)\n+        self.substs_from_path_segment(segment, Some(resolved.into()), false, explicit_self_ty)\n     }\n \n     pub(crate) fn lower_where_predicate("}, {"sha": "45a1958e3075dd339f794ceaea78746da33fb7a3", "filename": "crates/hir_ty/src/tests/traits.rs", "status": "modified", "additions": 46, "deletions": 0, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/0aa4ac362d1a40e4aea98857d22a2cd3884aa215/crates%2Fhir_ty%2Fsrc%2Ftests%2Ftraits.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0aa4ac362d1a40e4aea98857d22a2cd3884aa215/crates%2Fhir_ty%2Fsrc%2Ftests%2Ftraits.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Ftests%2Ftraits.rs?ref=0aa4ac362d1a40e4aea98857d22a2cd3884aa215", "patch": "@@ -3324,3 +3324,49 @@ fn f() {\n         \"#]],\n     )\n }\n+\n+#[test]\n+fn infer_default_trait_type_parameter() {\n+    check_infer(\n+        r#\"\n+struct A;\n+\n+trait Op<RHS=Self> {\n+    type Output;\n+\n+    fn do_op(self, rhs: RHS) -> Self::Output;\n+}\n+\n+impl Op for A {\n+    type Output = bool;\n+\n+    fn do_op(self, rhs: Self) -> Self::Output {\n+        true\n+    }\n+}\n+\n+fn test() {\n+    let x = A;\n+    let y = A;\n+    let r = x.do_op(y);\n+}\n+        \"#,\n+        expect![[r#\"\n+            63..67 'self': Self\n+            69..72 'rhs': RHS\n+            153..157 'self': A\n+            159..162 'rhs': A\n+            186..206 '{     ...     }': bool\n+            196..200 'true': bool\n+            220..277 '{     ...(y); }': ()\n+            230..231 'x': A\n+            234..235 'A': A\n+            245..246 'y': A\n+            249..250 'A': A\n+            260..261 'r': bool\n+            264..265 'x': A\n+            264..274 'x.do_op(y)': bool\n+            272..273 'y': A\n+        \"#]],\n+    )\n+}"}]}