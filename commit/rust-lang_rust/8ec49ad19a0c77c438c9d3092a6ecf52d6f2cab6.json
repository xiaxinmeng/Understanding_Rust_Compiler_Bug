{"sha": "8ec49ad19a0c77c438c9d3092a6ecf52d6f2cab6", "node_id": "C_kwDOAAsO6NoAKDhlYzQ5YWQxOWEwYzc3YzQzOGM5ZDMwOTJhNmVjZjUyZDZmMmNhYjY", "commit": {"author": {"name": "Ben Kimock", "email": "kimockb@gmail.com", "date": "2023-04-20T00:52:49Z"}, "committer": {"name": "Ben Kimock", "email": "kimockb@gmail.com", "date": "2023-04-21T00:40:01Z"}, "message": "Run combine_duplicate_switch_targets after the simplification that produces them", "tree": {"sha": "0164bc9572bd61d660673bfba7343c1a81d52ab0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0164bc9572bd61d660673bfba7343c1a81d52ab0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8ec49ad19a0c77c438c9d3092a6ecf52d6f2cab6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8ec49ad19a0c77c438c9d3092a6ecf52d6f2cab6", "html_url": "https://github.com/rust-lang/rust/commit/8ec49ad19a0c77c438c9d3092a6ecf52d6f2cab6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8ec49ad19a0c77c438c9d3092a6ecf52d6f2cab6/comments", "author": {"login": "saethlin", "id": 12105168, "node_id": "MDQ6VXNlcjEyMTA1MTY4", "avatar_url": "https://avatars.githubusercontent.com/u/12105168?v=4", "gravatar_id": "", "url": "https://api.github.com/users/saethlin", "html_url": "https://github.com/saethlin", "followers_url": "https://api.github.com/users/saethlin/followers", "following_url": "https://api.github.com/users/saethlin/following{/other_user}", "gists_url": "https://api.github.com/users/saethlin/gists{/gist_id}", "starred_url": "https://api.github.com/users/saethlin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/saethlin/subscriptions", "organizations_url": "https://api.github.com/users/saethlin/orgs", "repos_url": "https://api.github.com/users/saethlin/repos", "events_url": "https://api.github.com/users/saethlin/events{/privacy}", "received_events_url": "https://api.github.com/users/saethlin/received_events", "type": "User", "site_admin": false}, "committer": {"login": "saethlin", "id": 12105168, "node_id": "MDQ6VXNlcjEyMTA1MTY4", "avatar_url": "https://avatars.githubusercontent.com/u/12105168?v=4", "gravatar_id": "", "url": "https://api.github.com/users/saethlin", "html_url": "https://github.com/saethlin", "followers_url": "https://api.github.com/users/saethlin/followers", "following_url": "https://api.github.com/users/saethlin/following{/other_user}", "gists_url": "https://api.github.com/users/saethlin/gists{/gist_id}", "starred_url": "https://api.github.com/users/saethlin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/saethlin/subscriptions", "organizations_url": "https://api.github.com/users/saethlin/orgs", "repos_url": "https://api.github.com/users/saethlin/repos", "events_url": "https://api.github.com/users/saethlin/events{/privacy}", "received_events_url": "https://api.github.com/users/saethlin/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b658050846f5ebb81f862934e130a1fa17927fe0", "url": "https://api.github.com/repos/rust-lang/rust/commits/b658050846f5ebb81f862934e130a1fa17927fe0", "html_url": "https://github.com/rust-lang/rust/commit/b658050846f5ebb81f862934e130a1fa17927fe0"}], "stats": {"total": 39, "additions": 19, "deletions": 20}, "files": [{"sha": "432852a1fddc641545b9b8ddf6082a02088ae668", "filename": "compiler/rustc_mir_transform/src/instcombine.rs", "status": "modified", "additions": 3, "deletions": 18, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/8ec49ad19a0c77c438c9d3092a6ecf52d6f2cab6/compiler%2Frustc_mir_transform%2Fsrc%2Finstcombine.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8ec49ad19a0c77c438c9d3092a6ecf52d6f2cab6/compiler%2Frustc_mir_transform%2Fsrc%2Finstcombine.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Finstcombine.rs?ref=8ec49ad19a0c77c438c9d3092a6ecf52d6f2cab6", "patch": "@@ -1,11 +1,9 @@\n //! Performs various peephole optimizations.\n \n+use crate::simplify::combine_duplicate_switch_targets;\n use crate::MirPass;\n use rustc_hir::Mutability;\n-use rustc_middle::mir::{\n-    BinOp, Body, CastKind, Constant, ConstantKind, LocalDecls, Operand, Place, ProjectionElem,\n-    Rvalue, SourceInfo, Statement, StatementKind, SwitchTargets, Terminator, TerminatorKind, UnOp,\n-};\n+use rustc_middle::mir::*;\n use rustc_middle::ty::layout::ValidityRequirement;\n use rustc_middle::ty::util::IntTypeExt;\n use rustc_middle::ty::{self, ParamEnv, SubstsRef, Ty, TyCtxt};\n@@ -46,7 +44,7 @@ impl<'tcx> MirPass<'tcx> for InstCombine {\n                 &mut block.terminator.as_mut().unwrap(),\n                 &mut block.statements,\n             );\n-            ctx.combine_duplicate_switch_targets(&mut block.terminator.as_mut().unwrap());\n+            combine_duplicate_switch_targets(block.terminator.as_mut().unwrap());\n         }\n     }\n }\n@@ -264,19 +262,6 @@ impl<'tcx> InstCombineContext<'tcx, '_> {\n         terminator.kind = TerminatorKind::Goto { target: destination_block };\n     }\n \n-    fn combine_duplicate_switch_targets(&self, terminator: &mut Terminator<'tcx>) {\n-        let TerminatorKind::SwitchInt { targets, .. } = &mut terminator.kind\n-        else { return };\n-\n-        let otherwise = targets.otherwise();\n-        if targets.iter().any(|t| t.1 == otherwise) {\n-            *targets = SwitchTargets::new(\n-                targets.iter().filter(|t| t.1 != otherwise),\n-                targets.otherwise(),\n-            );\n-        }\n-    }\n-\n     fn combine_intrinsic_assert(\n         &self,\n         terminator: &mut Terminator<'tcx>,"}, {"sha": "e1ca7c107b9d2bddc61ce9d81c364357abeb8da6", "filename": "compiler/rustc_mir_transform/src/simplify.rs", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/8ec49ad19a0c77c438c9d3092a6ecf52d6f2cab6/compiler%2Frustc_mir_transform%2Fsrc%2Fsimplify.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8ec49ad19a0c77c438c9d3092a6ecf52d6f2cab6/compiler%2Frustc_mir_transform%2Fsrc%2Fsimplify.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Fsimplify.rs?ref=8ec49ad19a0c77c438c9d3092a6ecf52d6f2cab6", "patch": "@@ -278,6 +278,18 @@ impl<'a, 'tcx> CfgSimplifier<'a, 'tcx> {\n     }\n }\n \n+pub fn combine_duplicate_switch_targets(terminator: &mut Terminator<'_>) {\n+    if let TerminatorKind::SwitchInt { targets, .. } = &mut terminator.kind {\n+        let otherwise = targets.otherwise();\n+        if targets.iter().any(|t| t.1 == otherwise) {\n+            *targets = SwitchTargets::new(\n+                targets.iter().filter(|t| t.1 != otherwise),\n+                targets.otherwise(),\n+            );\n+        }\n+    }\n+}\n+\n pub fn remove_duplicate_unreachable_blocks<'tcx>(tcx: TyCtxt<'tcx>, body: &mut Body<'tcx>) {\n     struct OptApplier<'tcx> {\n         tcx: TyCtxt<'tcx>,\n@@ -298,6 +310,8 @@ pub fn remove_duplicate_unreachable_blocks<'tcx>(tcx: TyCtxt<'tcx>, body: &mut B\n                 }\n             }\n \n+            combine_duplicate_switch_targets(terminator);\n+\n             self.super_terminator(terminator, location);\n         }\n     }"}, {"sha": "8a8cd896e85db1f2c0d3fa1f1af36077cf2d31e2", "filename": "tests/mir-opt/inline/unwrap_unchecked.unwrap_unchecked.Inline.diff", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/8ec49ad19a0c77c438c9d3092a6ecf52d6f2cab6/tests%2Fmir-opt%2Finline%2Funwrap_unchecked.unwrap_unchecked.Inline.diff", "raw_url": "https://github.com/rust-lang/rust/raw/8ec49ad19a0c77c438c9d3092a6ecf52d6f2cab6/tests%2Fmir-opt%2Finline%2Funwrap_unchecked.unwrap_unchecked.Inline.diff", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Finline%2Funwrap_unchecked.unwrap_unchecked.Inline.diff?ref=8ec49ad19a0c77c438c9d3092a6ecf52d6f2cab6", "patch": "@@ -34,7 +34,7 @@\n -                                          // + literal: Const { ty: unsafe fn(Option<T>) -> T {Option::<T>::unwrap_unchecked}, val: Value(<ZST>) }\n +         StorageLive(_3);                 // scope 0 at $DIR/unwrap_unchecked.rs:+1:9: +1:27\n +         _4 = discriminant(_2);           // scope 1 at $SRC_DIR/core/src/option.rs:LL:COL\n-+         switchInt(move _4) -> [0: bb1, 1: bb2, otherwise: bb1]; // scope 1 at $SRC_DIR/core/src/option.rs:LL:COL\n++         switchInt(move _4) -> [1: bb2, otherwise: bb1]; // scope 1 at $SRC_DIR/core/src/option.rs:LL:COL\n       }\n   \n       bb1: {"}, {"sha": "acb7297310fb8e369a504d447e1134aa0a0744b3", "filename": "tests/mir-opt/instcombine_duplicate_switch_targets_e2e.ub_if_b.PreCodegen.after.mir", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/8ec49ad19a0c77c438c9d3092a6ecf52d6f2cab6/tests%2Fmir-opt%2Finstcombine_duplicate_switch_targets_e2e.ub_if_b.PreCodegen.after.mir", "raw_url": "https://github.com/rust-lang/rust/raw/8ec49ad19a0c77c438c9d3092a6ecf52d6f2cab6/tests%2Fmir-opt%2Finstcombine_duplicate_switch_targets_e2e.ub_if_b.PreCodegen.after.mir", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Finstcombine_duplicate_switch_targets_e2e.ub_if_b.PreCodegen.after.mir?ref=8ec49ad19a0c77c438c9d3092a6ecf52d6f2cab6", "patch": "@@ -13,7 +13,7 @@ fn ub_if_b(_1: Thing) -> Thing {\n \n     bb0: {\n         _2 = discriminant(_1);           // scope 0 at $DIR/instcombine_duplicate_switch_targets_e2e.rs:+1:11: +1:12\n-        switchInt(move _2) -> [0: bb2, 1: bb1, otherwise: bb1]; // scope 0 at $DIR/instcombine_duplicate_switch_targets_e2e.rs:+1:5: +1:12\n+        switchInt(move _2) -> [0: bb2, otherwise: bb1]; // scope 0 at $DIR/instcombine_duplicate_switch_targets_e2e.rs:+1:5: +1:12\n     }\n \n     bb1: {"}]}