{"sha": "aa06bf4f129ea670f3f9cd1db160c63845759126", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFhMDZiZjRmMTI5ZWE2NzBmM2Y5Y2QxZGIxNjBjNjM4NDU3NTkxMjY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-02-18T20:21:45Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-02-18T20:21:45Z"}, "message": "auto merge of #12357 : chromatic/rust/gh_11976_fail_bounds_check_str, r=alexcrichton\n\nFixes #11976.", "tree": {"sha": "3d113c529e380dc4fedf680ebf25890436a97f9b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3d113c529e380dc4fedf680ebf25890436a97f9b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/aa06bf4f129ea670f3f9cd1db160c63845759126", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/aa06bf4f129ea670f3f9cd1db160c63845759126", "html_url": "https://github.com/rust-lang/rust/commit/aa06bf4f129ea670f3f9cd1db160c63845759126", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/aa06bf4f129ea670f3f9cd1db160c63845759126/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a88654977234d18b57e2a1842549941397ab0d59", "url": "https://api.github.com/repos/rust-lang/rust/commits/a88654977234d18b57e2a1842549941397ab0d59", "html_url": "https://github.com/rust-lang/rust/commit/a88654977234d18b57e2a1842549941397ab0d59"}, {"sha": "96102b39455d414ec5966cb4547f5317f3cada15", "url": "https://api.github.com/repos/rust-lang/rust/commits/96102b39455d414ec5966cb4547f5317f3cada15", "html_url": "https://github.com/rust-lang/rust/commit/96102b39455d414ec5966cb4547f5317f3cada15"}], "stats": {"total": 14, "additions": 12, "deletions": 2}, "files": [{"sha": "8818cb0d270b6cc2c4bbfbe3e4f339a7240b5747", "filename": "src/libstd/unstable/lang.rs", "status": "modified", "additions": 12, "deletions": 2, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/aa06bf4f129ea670f3f9cd1db160c63845759126/src%2Flibstd%2Funstable%2Flang.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aa06bf4f129ea670f3f9cd1db160c63845759126/src%2Flibstd%2Funstable%2Flang.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Funstable%2Flang.rs?ref=aa06bf4f129ea670f3f9cd1db160c63845759126", "patch": "@@ -10,7 +10,10 @@\n \n //! Runtime calls emitted by the compiler.\n \n-use c_str::ToCStr;\n+use c_str::CString;\n+use libc::c_char;\n+use cast;\n+use option::Some;\n \n #[cold]\n #[lang=\"fail_\"]\n@@ -23,7 +26,14 @@ pub fn fail_(expr: *u8, file: *u8, line: uint) -> ! {\n pub fn fail_bounds_check(file: *u8, line: uint, index: uint, len: uint) -> ! {\n     let msg = format!(\"index out of bounds: the len is {} but the index is {}\",\n                       len as uint, index as uint);\n-    msg.with_c_str(|buf| fail_(buf as *u8, file, line))\n+\n+    let file_str = match unsafe { CString::new(file as *c_char, false) }.as_str() {\n+        // This transmute is safe because `file` is always stored in rodata.\n+        Some(s) => unsafe { cast::transmute::<&str, &'static str>(s) },\n+        None    => \"file wasn't UTF-8 safe\"\n+    };\n+\n+    ::rt::begin_unwind(msg, file_str, line)\n }\n \n #[lang=\"malloc\"]"}]}