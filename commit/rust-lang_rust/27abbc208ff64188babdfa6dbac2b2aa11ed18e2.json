{"sha": "27abbc208ff64188babdfa6dbac2b2aa11ed18e2", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI3YWJiYzIwOGZmNjQxODhiYWJkZmE2ZGJhYzJiMmFhMTFlZDE4ZTI=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-01-24T21:09:55Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-01-24T21:09:55Z"}, "message": "Rollup merge of #80933 - rcvalle:fix-sysroot-option, r=nagisa\n\nFix sysroot option not being honored across rustc\n\nChange link_sanitizer_runtime() to check if the sanitizer library exists in the specified/session sysroot, and if it doesn't exist, use the default sysroot. (See #79253.)", "tree": {"sha": "50b23db2e26eb054f9673148aacc58990b1e66a0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/50b23db2e26eb054f9673148aacc58990b1e66a0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/27abbc208ff64188babdfa6dbac2b2aa11ed18e2", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgDeIjCRBK7hj4Ov3rIwAAdHIIAGTIinwewn/ajrOi6GGGoAtl\n6okRLIWgg2I3myFAvacnror8B3+z/EI1km/HDi0TJZBETlIthyL44pPdsxpBsXnO\nDymnyKcTdfN/j7K8Qgh+YOxxtu2rut4y9AOFDLPzhqHnPdUR5u7S+B7M5vqL2qIg\nlAO9kcvEMZKDoSBFmqcyh7bcQW4bFb5sBqL484V1jZrYpon3Up8RouCRq+I9HAU6\nkxELlQ+x2gH6sj/tqsTn/eLezbzfGsAs2MY2gc60kXnvV7RJZSx4dMqTCOxNyGgN\nRWXD3BuK1mIpySvFAb0S7BDbVjpNec4Hd8/9+2iXbxa52J37N6fIDV45syu7bwQ=\n=BoEw\n-----END PGP SIGNATURE-----\n", "payload": "tree 50b23db2e26eb054f9673148aacc58990b1e66a0\nparent e8ef15d9d1d2800477c13f77704bf4d23bba9bb1\nparent 737867618b3c92330c42b7bb488eb0ee387f2e04\nauthor Jonas Schievink <jonasschievink@gmail.com> 1611522595 +0100\ncommitter GitHub <noreply@github.com> 1611522595 +0100\n\nRollup merge of #80933 - rcvalle:fix-sysroot-option, r=nagisa\n\nFix sysroot option not being honored across rustc\n\nChange link_sanitizer_runtime() to check if the sanitizer library exists in the specified/session sysroot, and if it doesn't exist, use the default sysroot. (See #79253.)\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/27abbc208ff64188babdfa6dbac2b2aa11ed18e2", "html_url": "https://github.com/rust-lang/rust/commit/27abbc208ff64188babdfa6dbac2b2aa11ed18e2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/27abbc208ff64188babdfa6dbac2b2aa11ed18e2/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e8ef15d9d1d2800477c13f77704bf4d23bba9bb1", "url": "https://api.github.com/repos/rust-lang/rust/commits/e8ef15d9d1d2800477c13f77704bf4d23bba9bb1", "html_url": "https://github.com/rust-lang/rust/commit/e8ef15d9d1d2800477c13f77704bf4d23bba9bb1"}, {"sha": "737867618b3c92330c42b7bb488eb0ee387f2e04", "url": "https://api.github.com/repos/rust-lang/rust/commits/737867618b3c92330c42b7bb488eb0ee387f2e04", "html_url": "https://github.com/rust-lang/rust/commit/737867618b3c92330c42b7bb488eb0ee387f2e04"}], "stats": {"total": 28, "additions": 21, "deletions": 7}, "files": [{"sha": "72e049b6d7469ed879c42b3405f19d2021bf9ef1", "filename": "compiler/rustc_codegen_ssa/src/back/link.rs", "status": "modified", "additions": 21, "deletions": 7, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/27abbc208ff64188babdfa6dbac2b2aa11ed18e2/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/27abbc208ff64188babdfa6dbac2b2aa11ed18e2/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs?ref=27abbc208ff64188babdfa6dbac2b2aa11ed18e2", "patch": "@@ -885,9 +885,22 @@ fn link_sanitizers(sess: &Session, crate_type: CrateType, linker: &mut dyn Linke\n }\n \n fn link_sanitizer_runtime(sess: &Session, linker: &mut dyn Linker, name: &str) {\n-    let default_sysroot = filesearch::get_or_default_sysroot();\n-    let default_tlib =\n-        filesearch::make_target_lib_path(&default_sysroot, sess.opts.target_triple.triple());\n+    fn find_sanitizer_runtime(sess: &Session, filename: &String) -> PathBuf {\n+        let session_tlib =\n+            filesearch::make_target_lib_path(&sess.sysroot, sess.opts.target_triple.triple());\n+        let path = session_tlib.join(&filename);\n+        if path.exists() {\n+            return session_tlib;\n+        } else {\n+            let default_sysroot = filesearch::get_or_default_sysroot();\n+            let default_tlib = filesearch::make_target_lib_path(\n+                &default_sysroot,\n+                sess.opts.target_triple.triple(),\n+            );\n+            return default_tlib;\n+        }\n+    }\n+\n     let channel = option_env!(\"CFG_RELEASE_CHANNEL\")\n         .map(|channel| format!(\"-{}\", channel))\n         .unwrap_or_default();\n@@ -898,18 +911,19 @@ fn link_sanitizer_runtime(sess: &Session, linker: &mut dyn Linker, name: &str) {\n             // LLVM will link to `@rpath/*.dylib`, so we need to specify an\n             // rpath to the library as well (the rpath should be absolute, see\n             // PR #41352 for details).\n-            let libname = format!(\"rustc{}_rt.{}\", channel, name);\n-            let rpath = default_tlib.to_str().expect(\"non-utf8 component in path\");\n+            let filename = format!(\"rustc{}_rt.{}\", channel, name);\n+            let path = find_sanitizer_runtime(&sess, &filename);\n+            let rpath = path.to_str().expect(\"non-utf8 component in path\");\n             linker.args(&[\"-Wl,-rpath\", \"-Xlinker\", rpath]);\n-            linker.link_dylib(Symbol::intern(&libname));\n+            linker.link_dylib(Symbol::intern(&filename));\n         }\n         \"aarch64-fuchsia\"\n         | \"aarch64-unknown-linux-gnu\"\n         | \"x86_64-fuchsia\"\n         | \"x86_64-unknown-freebsd\"\n         | \"x86_64-unknown-linux-gnu\" => {\n             let filename = format!(\"librustc{}_rt.{}.a\", channel, name);\n-            let path = default_tlib.join(&filename);\n+            let path = find_sanitizer_runtime(&sess, &filename).join(&filename);\n             linker.link_whole_rlib(&path);\n         }\n         _ => {}"}]}