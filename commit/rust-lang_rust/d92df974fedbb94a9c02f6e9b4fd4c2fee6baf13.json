{"sha": "d92df974fedbb94a9c02f6e9b4fd4c2fee6baf13", "node_id": "C_kwDOAAsO6NoAKGQ5MmRmOTc0ZmVkYmI5NGE5YzAyZjZlOWI0ZmQ0YzJmZWU2YmFmMTM", "commit": {"author": {"name": "b-naber", "email": "bn263@gmx.de", "date": "2022-03-07T12:51:59Z"}, "committer": {"name": "b-naber", "email": "bn263@gmx.de", "date": "2022-03-08T09:04:28Z"}, "message": "treat literals in ExprKind::StaticRef as mir::ConstantKind::Val", "tree": {"sha": "07a75da9e7dbce3e342c0c3e3a3491a2d877e9a6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/07a75da9e7dbce3e342c0c3e3a3491a2d877e9a6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d92df974fedbb94a9c02f6e9b4fd4c2fee6baf13", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d92df974fedbb94a9c02f6e9b4fd4c2fee6baf13", "html_url": "https://github.com/rust-lang/rust/commit/d92df974fedbb94a9c02f6e9b4fd4c2fee6baf13", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d92df974fedbb94a9c02f6e9b4fd4c2fee6baf13/comments", "author": {"login": "b-naber", "id": 71934879, "node_id": "MDQ6VXNlcjcxOTM0ODc5", "avatar_url": "https://avatars.githubusercontent.com/u/71934879?v=4", "gravatar_id": "", "url": "https://api.github.com/users/b-naber", "html_url": "https://github.com/b-naber", "followers_url": "https://api.github.com/users/b-naber/followers", "following_url": "https://api.github.com/users/b-naber/following{/other_user}", "gists_url": "https://api.github.com/users/b-naber/gists{/gist_id}", "starred_url": "https://api.github.com/users/b-naber/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/b-naber/subscriptions", "organizations_url": "https://api.github.com/users/b-naber/orgs", "repos_url": "https://api.github.com/users/b-naber/repos", "events_url": "https://api.github.com/users/b-naber/events{/privacy}", "received_events_url": "https://api.github.com/users/b-naber/received_events", "type": "User", "site_admin": false}, "committer": {"login": "b-naber", "id": 71934879, "node_id": "MDQ6VXNlcjcxOTM0ODc5", "avatar_url": "https://avatars.githubusercontent.com/u/71934879?v=4", "gravatar_id": "", "url": "https://api.github.com/users/b-naber", "html_url": "https://github.com/b-naber", "followers_url": "https://api.github.com/users/b-naber/followers", "following_url": "https://api.github.com/users/b-naber/following{/other_user}", "gists_url": "https://api.github.com/users/b-naber/gists{/gist_id}", "starred_url": "https://api.github.com/users/b-naber/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/b-naber/subscriptions", "organizations_url": "https://api.github.com/users/b-naber/orgs", "repos_url": "https://api.github.com/users/b-naber/repos", "events_url": "https://api.github.com/users/b-naber/events{/privacy}", "received_events_url": "https://api.github.com/users/b-naber/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1b14fd3b1063771923e2fcf2110961bfa5ba4ad0", "url": "https://api.github.com/repos/rust-lang/rust/commits/1b14fd3b1063771923e2fcf2110961bfa5ba4ad0", "html_url": "https://github.com/rust-lang/rust/commit/1b14fd3b1063771923e2fcf2110961bfa5ba4ad0"}], "stats": {"total": 51, "additions": 30, "deletions": 21}, "files": [{"sha": "898ce0cdddaefcfecdd5ff89066fa6ba9c3ada9e", "filename": "compiler/rustc_middle/src/mir/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d92df974fedbb94a9c02f6e9b4fd4c2fee6baf13/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d92df974fedbb94a9c02f6e9b4fd4c2fee6baf13/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmod.rs?ref=d92df974fedbb94a9c02f6e9b4fd4c2fee6baf13", "patch": "@@ -2534,7 +2534,7 @@ pub enum ConstantKind<'tcx> {\n \n impl<'tcx> Constant<'tcx> {\n     pub fn check_static_ptr(&self, tcx: TyCtxt<'_>) -> Option<DefId> {\n-        match self.literal.const_for_ty()?.val().try_to_scalar() {\n+        match self.literal.try_to_scalar() {\n             Some(Scalar::Ptr(ptr, _size)) => match tcx.global_alloc(ptr.provenance) {\n                 GlobalAlloc::Static(def_id) => {\n                     assert!(!tcx.is_thread_local_static(def_id));"}, {"sha": "a3900dde1b6abd2c9783cf19e69f03bd0aed122b", "filename": "compiler/rustc_middle/src/mir/pretty.rs", "status": "modified", "additions": 16, "deletions": 6, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/d92df974fedbb94a9c02f6e9b4fd4c2fee6baf13/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fpretty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d92df974fedbb94a9c02f6e9b4fd4c2fee6baf13/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fpretty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fpretty.rs?ref=d92df974fedbb94a9c02f6e9b4fd4c2fee6baf13", "patch": "@@ -17,9 +17,8 @@ use rustc_middle::mir::interpret::{\n use rustc_middle::mir::visit::Visitor;\n use rustc_middle::mir::MirSource;\n use rustc_middle::mir::*;\n-use rustc_middle::ty::{self, TyCtxt, TypeFoldable, TypeVisitor};\n+use rustc_middle::ty::{self, TyCtxt};\n use rustc_target::abi::Size;\n-use std::ops::ControlFlow;\n \n const INDENT: &str = \"    \";\n /// Alignment for lining up comments following MIR statements\n@@ -669,16 +668,27 @@ pub fn write_allocations<'tcx>(\n         }\n     }\n     struct CollectAllocIds(BTreeSet<AllocId>);\n-    impl<'tcx> TypeVisitor<'tcx> for CollectAllocIds {\n-        fn visit_const(&mut self, c: ty::Const<'tcx>) -> ControlFlow<Self::BreakTy> {\n+\n+    impl<'tcx> Visitor<'tcx> for CollectAllocIds {\n+        fn visit_const(&mut self, c: ty::Const<'tcx>, _loc: Location) {\n             if let ty::ConstKind::Value(val) = c.val() {\n                 self.0.extend(alloc_ids_from_const(val));\n             }\n-            c.super_visit_with(self)\n+        }\n+\n+        fn visit_constant(&mut self, c: &Constant<'tcx>, loc: Location) {\n+            match c.literal {\n+                ConstantKind::Ty(c) => self.visit_const(c, loc),\n+                ConstantKind::Val(val, _) => {\n+                    self.0.extend(alloc_ids_from_const(val));\n+                }\n+            }\n         }\n     }\n+\n     let mut visitor = CollectAllocIds(Default::default());\n-    body.visit_with(&mut visitor);\n+    visitor.visit_body(body);\n+\n     // `seen` contains all seen allocations, including the ones we have *not* printed yet.\n     // The protocol is to first `insert` into `seen`, and only if that returns `true`\n     // then push to `todo`."}, {"sha": "04bc0c8b52114dccded115a8b98fa0c9a1ac94f1", "filename": "compiler/rustc_middle/src/thir.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d92df974fedbb94a9c02f6e9b4fd4c2fee6baf13/compiler%2Frustc_middle%2Fsrc%2Fthir.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d92df974fedbb94a9c02f6e9b4fd4c2fee6baf13/compiler%2Frustc_middle%2Fsrc%2Fthir.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fthir.rs?ref=d92df974fedbb94a9c02f6e9b4fd4c2fee6baf13", "patch": "@@ -17,6 +17,7 @@ use rustc_index::newtype_index;\n use rustc_index::vec::IndexVec;\n use rustc_middle::infer::canonical::Canonical;\n use rustc_middle::middle::region;\n+use rustc_middle::mir::interpret::AllocId;\n use rustc_middle::mir::{\n     BinOp, BorrowKind, FakeReadCause, Field, Mutability, UnOp, UserTypeProjection,\n };\n@@ -419,7 +420,8 @@ pub enum ExprKind<'tcx> {\n     /// This is only distinguished from `Literal` so that we can register some\n     /// info for diagnostics.\n     StaticRef {\n-        literal: Const<'tcx>,\n+        alloc_id: AllocId,\n+        ty: Ty<'tcx>,\n         def_id: DefId,\n     },\n     /// Inline assembly, i.e. `asm!()`."}, {"sha": "b3e2cb132a273b90d9984f7c61a9a3fdbab73386", "filename": "compiler/rustc_middle/src/thir/visit.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d92df974fedbb94a9c02f6e9b4fd4c2fee6baf13/compiler%2Frustc_middle%2Fsrc%2Fthir%2Fvisit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d92df974fedbb94a9c02f6e9b4fd4c2fee6baf13/compiler%2Frustc_middle%2Fsrc%2Fthir%2Fvisit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fthir%2Fvisit.rs?ref=d92df974fedbb94a9c02f6e9b4fd4c2fee6baf13", "patch": "@@ -123,7 +123,7 @@ pub fn walk_expr<'a, 'tcx: 'a, V: Visitor<'a, 'tcx>>(visitor: &mut V, expr: &Exp\n         }\n         Closure { closure_id: _, substs: _, upvars: _, movability: _, fake_reads: _ } => {}\n         Literal { literal, user_ty: _, const_id: _ } => visitor.visit_const(literal),\n-        StaticRef { literal, def_id: _ } => visitor.visit_const(literal),\n+        StaticRef { .. } => {}\n         InlineAsm { ref operands, template: _, options: _, line_spans: _ } => {\n             for op in &**operands {\n                 use InlineAsmOperand::*;"}, {"sha": "0c0b0f2bd05affc985dad8dd83c21e488da36c4c", "filename": "compiler/rustc_mir_build/src/build/expr/as_constant.rs", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/d92df974fedbb94a9c02f6e9b4fd4c2fee6baf13/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fexpr%2Fas_constant.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d92df974fedbb94a9c02f6e9b4fd4c2fee6baf13/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fexpr%2Fas_constant.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fexpr%2Fas_constant.rs?ref=d92df974fedbb94a9c02f6e9b4fd4c2fee6baf13", "patch": "@@ -1,6 +1,7 @@\n //! See docs in build/expr/mod.rs\n \n use crate::build::Builder;\n+use rustc_middle::mir::interpret::{ConstValue, Scalar};\n use rustc_middle::mir::*;\n use rustc_middle::thir::*;\n use rustc_middle::ty::CanonicalUserTypeAnnotation;\n@@ -26,8 +27,12 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n                 assert_eq!(literal.ty(), ty);\n                 Constant { span, user_ty, literal: literal.into() }\n             }\n-            ExprKind::StaticRef { literal, .. } => {\n-                Constant { span, user_ty: None, literal: literal.into() }\n+            ExprKind::StaticRef { alloc_id, ty, .. } => {\n+                let const_val =\n+                    ConstValue::Scalar(Scalar::from_pointer(alloc_id.into(), &this.tcx));\n+                let literal = ConstantKind::Val(const_val, ty);\n+\n+                Constant { span, user_ty: None, literal }\n             }\n             ExprKind::ConstBlock { value } => {\n                 Constant { span: span, user_ty: None, literal: value.into() }"}, {"sha": "5a7e1d88dd03f9d8cb2084497fe86edb30c80a6e", "filename": "compiler/rustc_mir_build/src/thir/cx/expr.rs", "status": "modified", "additions": 2, "deletions": 10, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/d92df974fedbb94a9c02f6e9b4fd4c2fee6baf13/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fcx%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d92df974fedbb94a9c02f6e9b4fd4c2fee6baf13/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fcx%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fcx%2Fexpr.rs?ref=d92df974fedbb94a9c02f6e9b4fd4c2fee6baf13", "patch": "@@ -8,7 +8,6 @@ use rustc_middle::hir::place::Place as HirPlace;\n use rustc_middle::hir::place::PlaceBase as HirPlaceBase;\n use rustc_middle::hir::place::ProjectionKind as HirProjectionKind;\n use rustc_middle::middle::region;\n-use rustc_middle::mir::interpret::Scalar;\n use rustc_middle::mir::{BinOp, BorrowKind, Field, UnOp};\n use rustc_middle::thir::*;\n use rustc_middle::ty::adjustment::{\n@@ -941,15 +940,8 @@ impl<'tcx> Cx<'tcx> {\n                 let kind = if self.tcx.is_thread_local_static(id) {\n                     ExprKind::ThreadLocalRef(id)\n                 } else {\n-                    let ptr = self.tcx.create_static_alloc(id);\n-                    ExprKind::StaticRef {\n-                        literal: ty::Const::from_scalar(\n-                            self.tcx,\n-                            Scalar::from_pointer(ptr.into(), &self.tcx),\n-                            ty,\n-                        ),\n-                        def_id: id,\n-                    }\n+                    let alloc_id = self.tcx.create_static_alloc(id);\n+                    ExprKind::StaticRef { alloc_id, ty, def_id: id }\n                 };\n                 ExprKind::Deref {\n                     arg: self.thir.exprs.push(Expr { ty, temp_lifetime, span: expr.span, kind }),"}]}