{"sha": "281bd790de7b992831a1ff8a589c0fc38c842c95", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI4MWJkNzkwZGU3Yjk5MjgzMWExZmY4YTU4OWMwZmMzOGM4NDJjOTU=", "commit": {"author": {"name": "Oliver Schneider", "email": "oli-obk@users.noreply.github.com", "date": "2017-10-20T09:12:21Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2017-10-20T09:12:21Z"}, "message": "Merge pull request #2148 from sinkuu/proc_macro\n\nneedless_pass_by_value false-positive in annotation", "tree": {"sha": "d5763126250b99d93b80f3c826c745a81d933ef6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d5763126250b99d93b80f3c826c745a81d933ef6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/281bd790de7b992831a1ff8a589c0fc38c842c95", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/281bd790de7b992831a1ff8a589c0fc38c842c95", "html_url": "https://github.com/rust-lang/rust/commit/281bd790de7b992831a1ff8a589c0fc38c842c95", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/281bd790de7b992831a1ff8a589c0fc38c842c95/comments", "author": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "327d995bb6ea0dbad3f26cf535fed4039ee918f2", "url": "https://api.github.com/repos/rust-lang/rust/commits/327d995bb6ea0dbad3f26cf535fed4039ee918f2", "html_url": "https://github.com/rust-lang/rust/commit/327d995bb6ea0dbad3f26cf535fed4039ee918f2"}, {"sha": "9221bd9c97047d9eac21867f5a11651080e2b88f", "url": "https://api.github.com/repos/rust-lang/rust/commits/9221bd9c97047d9eac21867f5a11651080e2b88f", "html_url": "https://github.com/rust-lang/rust/commit/9221bd9c97047d9eac21867f5a11651080e2b88f"}], "stats": {"total": 32, "additions": 28, "deletions": 4}, "files": [{"sha": "e67dca5d00d24cbe2159148c38100b60d2302608", "filename": "clippy_lints/src/needless_pass_by_value.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/281bd790de7b992831a1ff8a589c0fc38c842c95/clippy_lints%2Fsrc%2Fneedless_pass_by_value.rs", "raw_url": "https://github.com/rust-lang/rust/raw/281bd790de7b992831a1ff8a589c0fc38c842c95/clippy_lints%2Fsrc%2Fneedless_pass_by_value.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fneedless_pass_by_value.rs?ref=281bd790de7b992831a1ff8a589c0fc38c842c95", "patch": "@@ -121,6 +121,11 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for NeedlessPassByValue {\n             .zip(&body.arguments)\n             .enumerate()\n         {\n+            // All spans generated from a proc-macro invocation are the same...\n+            if span == input.span {\n+                return;\n+            }\n+\n             // * Exclude a type that is specifically bounded by `Borrow`.\n             // * Exclude a type whose reference also fulfills its bound.\n             //   (e.g. `std::convert::AsRef`, `serde::Serialize`)"}, {"sha": "67337afd3e70107eedbca7f1fcecbe84d1eff44f", "filename": "mini-macro/src/lib.rs", "status": "modified", "additions": 22, "deletions": 4, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/281bd790de7b992831a1ff8a589c0fc38c842c95/mini-macro%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/281bd790de7b992831a1ff8a589c0fc38c842c95/mini-macro%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/mini-macro%2Fsrc%2Flib.rs?ref=281bd790de7b992831a1ff8a589c0fc38c842c95", "patch": "@@ -1,21 +1,39 @@\n-#![feature(plugin_registrar, rustc_private)]\n+#![feature(plugin_registrar, rustc_private, quote)]\n \n extern crate rustc_plugin;\n extern crate syntax;\n \n+use rustc_plugin::Registry;\n+use syntax::ast::MetaItem;\n use syntax::codemap::Span;\n-use syntax::tokenstream::TokenTree;\n-use syntax::ext::base::{ExtCtxt, MacEager, MacResult};\n+use syntax::ext::base::{Annotatable, ExtCtxt, MacEager, MacResult, SyntaxExtension};\n use syntax::ext::build::AstBuilder; // trait for expr_usize\n-use rustc_plugin::Registry;\n+use syntax::symbol::Symbol;\n+use syntax::tokenstream::TokenTree;\n \n fn expand_macro(cx: &mut ExtCtxt, sp: Span, _: &[TokenTree]) -> Box<MacResult + 'static> {\n     let e = cx.expr_usize(sp, 42);\n     let e = cx.expr_mut_addr_of(sp, e);\n     MacEager::expr(cx.expr_mut_addr_of(sp, e))\n }\n \n+fn expand_attr_macro(cx: &mut ExtCtxt, _: Span, _: &MetaItem, annotated: Annotatable) -> Vec<Annotatable> {\n+    vec![\n+        Annotatable::Item(\n+            quote_item!(\n+                cx,\n+                #[allow(unused)] fn needless_take_by_value(s: String) { println!(\"{}\", s.len()); }\n+            ).unwrap()\n+        ),\n+        annotated,\n+    ]\n+}\n+\n #[plugin_registrar]\n pub fn plugin_registrar(reg: &mut Registry) {\n     reg.register_macro(\"mini_macro\", expand_macro);\n+    reg.register_syntax_extension(\n+        Symbol::intern(\"mini_macro_attr\"),\n+        SyntaxExtension::MultiModifier(Box::new(expand_attr_macro)),\n+    );\n }"}, {"sha": "f52c778a49dc69fdf427aedd65d1b16389d9c4bd", "filename": "tests/run-pass/procedural_macro.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/281bd790de7b992831a1ff8a589c0fc38c842c95/tests%2Frun-pass%2Fprocedural_macro.rs", "raw_url": "https://github.com/rust-lang/rust/raw/281bd790de7b992831a1ff8a589c0fc38c842c95/tests%2Frun-pass%2Fprocedural_macro.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-pass%2Fprocedural_macro.rs?ref=281bd790de7b992831a1ff8a589c0fc38c842c95", "patch": "@@ -2,6 +2,7 @@\n #![plugin(clippy_mini_macro_test)]\n \n #[deny(warnings)]\n+#[mini_macro_attr]\n fn main() {\n     let _ = mini_macro!();\n }"}]}