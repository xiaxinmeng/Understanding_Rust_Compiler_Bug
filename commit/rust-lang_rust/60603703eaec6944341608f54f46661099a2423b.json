{"sha": "60603703eaec6944341608f54f46661099a2423b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjYwNjAzNzAzZWFlYzY5NDQzNDE2MDhmNTRmNDY2NjEwOTlhMjQyM2I=", "commit": {"author": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2012-06-21T03:08:25Z"}, "committer": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2012-06-21T15:34:54Z"}, "message": "handle moves in let initializers and allow moves from unsafe ptrs\n\nRelated to issue #2657, but this is not a complete fix.", "tree": {"sha": "c4f0749124892e9729fe64efd1671cd7cecf1639", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c4f0749124892e9729fe64efd1671cd7cecf1639"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/60603703eaec6944341608f54f46661099a2423b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/60603703eaec6944341608f54f46661099a2423b", "html_url": "https://github.com/rust-lang/rust/commit/60603703eaec6944341608f54f46661099a2423b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/60603703eaec6944341608f54f46661099a2423b/comments", "author": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f9afce319a1df2cc5c0098ea52e13dd9a54a05c9", "url": "https://api.github.com/repos/rust-lang/rust/commits/f9afce319a1df2cc5c0098ea52e13dd9a54a05c9", "html_url": "https://github.com/rust-lang/rust/commit/f9afce319a1df2cc5c0098ea52e13dd9a54a05c9"}], "stats": {"total": 57, "additions": 57, "deletions": 0}, "files": [{"sha": "bae0f4648d2bfc31865e0385f8badd75e74816b3", "filename": "src/rustc/middle/borrowck/check_loans.rs", "status": "modified", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/60603703eaec6944341608f54f46661099a2423b/src%2Frustc%2Fmiddle%2Fborrowck%2Fcheck_loans.rs", "raw_url": "https://github.com/rust-lang/rust/raw/60603703eaec6944341608f54f46661099a2423b/src%2Frustc%2Fmiddle%2Fborrowck%2Fcheck_loans.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustc%2Fmiddle%2Fborrowck%2Fcheck_loans.rs?ref=60603703eaec6944341608f54f46661099a2423b", "patch": "@@ -47,6 +47,7 @@ fn check_loans(bccx: borrowck_ctxt,\n                                  mut declared_purity: ast::impure_fn,\n                                  mut fn_args: @[]});\n     let vt = visit::mk_vt(@{visit_expr: check_loans_in_expr,\n+                            visit_local: check_loans_in_local,\n                             visit_block: check_loans_in_block,\n                             visit_fn: check_loans_in_fn\n                             with *visit::default_visitor()});\n@@ -419,6 +420,9 @@ impl methods for check_loan_ctxt {\n           // rvalues, I guess.\n           cat_special(sk_static_item) { }\n \n+          cat_deref(_, _, unsafe_ptr) {\n+          }\n+\n           // Nothing else.\n           _ {\n             self.bccx.span_err(\n@@ -542,6 +546,18 @@ fn check_loans_in_fn(fk: visit::fn_kind, decl: ast::fn_decl, body: ast::blk,\n     #debug[\"purity on exit=%?\", copy self.declared_purity];\n }\n \n+fn check_loans_in_local(local: @ast::local,\n+                        &&self: check_loan_ctxt,\n+                        vt: visit::vt<check_loan_ctxt>) {\n+    alt local.node.init {\n+      some({op: ast::init_move, expr: expr}) {\n+        self.check_move_out(expr);\n+      }\n+      some({op: ast::init_assign, _}) | none {}\n+    }\n+    visit::visit_local(local, self, vt);\n+}\n+\n fn check_loans_in_expr(expr: @ast::expr,\n                        &&self: check_loan_ctxt,\n                        vt: visit::vt<check_loan_ctxt>) {"}, {"sha": "00c579dc45ee0de4d0bfd0be996d82f793d06644", "filename": "src/test/compile-fail/borrowck-issue-2657-1.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/60603703eaec6944341608f54f46661099a2423b/src%2Ftest%2Fcompile-fail%2Fborrowck-issue-2657-1.rs", "raw_url": "https://github.com/rust-lang/rust/raw/60603703eaec6944341608f54f46661099a2423b/src%2Ftest%2Fcompile-fail%2Fborrowck-issue-2657-1.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fborrowck-issue-2657-1.rs?ref=60603703eaec6944341608f54f46661099a2423b", "patch": "@@ -0,0 +1,9 @@\n+fn main() {\n+let x = some(~1);\n+alt x { //! NOTE loan of immutable local variable granted here\n+  some(y) {\n+    let _a <- x; //! ERROR moving out of immutable local variable prohibited due to outstanding loan\n+  }\n+  _ {}\n+}\n+}"}, {"sha": "c9e94331ab0d39fff4a78c5be02b8f7f69dca4cc", "filename": "src/test/compile-fail/borrowck-issue-2657-2.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/60603703eaec6944341608f54f46661099a2423b/src%2Ftest%2Fcompile-fail%2Fborrowck-issue-2657-2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/60603703eaec6944341608f54f46661099a2423b/src%2Ftest%2Fcompile-fail%2Fborrowck-issue-2657-2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fborrowck-issue-2657-2.rs?ref=60603703eaec6944341608f54f46661099a2423b", "patch": "@@ -0,0 +1,14 @@\n+//xfail-test\n+\n+// this should be illegal but borrowck is not handling \n+// pattern bindings correctly right now\n+\n+fn main() {\n+let x = some(~1);\n+alt x {\n+  some(y) {\n+    let b <- y;\n+  }\n+  _ {}\n+}\n+}"}, {"sha": "03fbb6b975ce8407ae4009c08b2988bd39634633", "filename": "src/test/compile-fail/borrowck-move-from-unsafe-ptr.rs", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/60603703eaec6944341608f54f46661099a2423b/src%2Ftest%2Fcompile-fail%2Fborrowck-move-from-unsafe-ptr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/60603703eaec6944341608f54f46661099a2423b/src%2Ftest%2Fcompile-fail%2Fborrowck-move-from-unsafe-ptr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fborrowck-move-from-unsafe-ptr.rs?ref=60603703eaec6944341608f54f46661099a2423b", "patch": "@@ -0,0 +1,7 @@\n+fn foo(x: *~int) -> ~int {\n+    let y <- *x; //! ERROR dereference of unsafe pointer requires unsafe function or block\n+    ret y;\n+}\n+\n+fn main() {\n+}\n\\ No newline at end of file"}, {"sha": "ef0803c00d0efcc7c0fb34fad2390b97745a7268", "filename": "src/test/run-pass/borrowck-move-from-unsafe-ptr-ok.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/60603703eaec6944341608f54f46661099a2423b/src%2Ftest%2Frun-pass%2Fborrowck-move-from-unsafe-ptr-ok.rs", "raw_url": "https://github.com/rust-lang/rust/raw/60603703eaec6944341608f54f46661099a2423b/src%2Ftest%2Frun-pass%2Fborrowck-move-from-unsafe-ptr-ok.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fborrowck-move-from-unsafe-ptr-ok.rs?ref=60603703eaec6944341608f54f46661099a2423b", "patch": "@@ -0,0 +1,11 @@\n+// just make sure this compiles:\n+\n+fn bar(x: *~int) -> ~int {\n+    unsafe {\n+        let y <- *x;\n+        ret y;\n+    }\n+}\n+\n+fn main() {\n+}\n\\ No newline at end of file"}]}