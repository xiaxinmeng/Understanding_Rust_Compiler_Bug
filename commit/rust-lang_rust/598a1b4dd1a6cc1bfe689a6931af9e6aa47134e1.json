{"sha": "598a1b4dd1a6cc1bfe689a6931af9e6aa47134e1", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU5OGExYjRkZDFhNmNjMWJmZTY4OWE2OTMxYWY5ZTZhYTQ3MTM0ZTE=", "commit": {"author": {"name": "Lukas Kalbertodt", "email": "lukas.kalbertodt@gmail.com", "date": "2019-03-14T12:43:17Z"}, "committer": {"name": "Lukas Kalbertodt", "email": "lukas.kalbertodt@gmail.com", "date": "2019-03-14T12:43:17Z"}, "message": "Avoid third seek operation in `Seek::stream_len` when possible", "tree": {"sha": "4478371a2fe145c171a6feaecdef5770467610f6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4478371a2fe145c171a6feaecdef5770467610f6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/598a1b4dd1a6cc1bfe689a6931af9e6aa47134e1", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEENwctvZ5TgcKYXim8PLr0FT+BhicFAlyKTGUACgkQPLr0FT+B\nhicgiRAAksLR4oSDI4NU8p8DtNifzHGKQR7SzMi9uuhvMZC7wA4Dp1CYWoNQ9XEx\nzeE9TjbKp8EMYBHWnMseqwmzlivSKfyFTm+O5PhRJtsxDNonfclNTzHZzFNaVRMa\n4TOsFUiIppJHg49XUF5V+ssM41sWiSp3YeFOJO6ZDT01tV7v/xcJPSowus5ffF0D\nsL/+yMKhyce8sCYqcqzXsiJONcCZVDwJwQ+JzCoa0hfBonnHXxYo6ksmMpTZy6aV\n3qQWVIXIyuTTgi9m9l5pJMB5GrBY2mNrne1UFvEYI4/3lCCzCpZ0GlS1wnvm2VFR\nD2MGCjLXB3zCC3zTMKYzja/gubKkwQbXvBavxA+ZgCsltLdDpeRP90+wMbfvYzVG\nDjelh2ydt3hiHKcQ2y/YJrmYRT5uepJR+NA5RJYOr5sS8n/R8EtYzIOUMuCMp+W1\nkitKkXlB3PFQRjVpyBfhuwfVvitPHn3P3UgSYUw4czgqnFV0ei73NgRRFlUDimf6\nXInT6o/9fqVlM5XjDVB2T92mzWq70FZDGrwjIWZO5O+s7jAMRqvX5vyXIcOesi4Z\n/fQlL34xIcw5WVsAqdWzFcpDr61Mr677ALoqMaOscnkzGTvFTSZ8DuMpnppXalwz\nxFeCnSBuybE27q1jIbB/YyizLvD/KnZG4pVFIgAY4uGOpDniC/I=\n=4+pI\n-----END PGP SIGNATURE-----", "payload": "tree 4478371a2fe145c171a6feaecdef5770467610f6\nparent e8ee00a6493b8cde09f5497f430d46a978ae865f\nauthor Lukas Kalbertodt <lukas.kalbertodt@gmail.com> 1552567397 +0100\ncommitter Lukas Kalbertodt <lukas.kalbertodt@gmail.com> 1552567397 +0100\n\nAvoid third seek operation in `Seek::stream_len` when possible\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/598a1b4dd1a6cc1bfe689a6931af9e6aa47134e1", "html_url": "https://github.com/rust-lang/rust/commit/598a1b4dd1a6cc1bfe689a6931af9e6aa47134e1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/598a1b4dd1a6cc1bfe689a6931af9e6aa47134e1/comments", "author": {"login": "LukasKalbertodt", "id": 7419664, "node_id": "MDQ6VXNlcjc0MTk2NjQ=", "avatar_url": "https://avatars.githubusercontent.com/u/7419664?v=4", "gravatar_id": "", "url": "https://api.github.com/users/LukasKalbertodt", "html_url": "https://github.com/LukasKalbertodt", "followers_url": "https://api.github.com/users/LukasKalbertodt/followers", "following_url": "https://api.github.com/users/LukasKalbertodt/following{/other_user}", "gists_url": "https://api.github.com/users/LukasKalbertodt/gists{/gist_id}", "starred_url": "https://api.github.com/users/LukasKalbertodt/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/LukasKalbertodt/subscriptions", "organizations_url": "https://api.github.com/users/LukasKalbertodt/orgs", "repos_url": "https://api.github.com/users/LukasKalbertodt/repos", "events_url": "https://api.github.com/users/LukasKalbertodt/events{/privacy}", "received_events_url": "https://api.github.com/users/LukasKalbertodt/received_events", "type": "User", "site_admin": false}, "committer": {"login": "LukasKalbertodt", "id": 7419664, "node_id": "MDQ6VXNlcjc0MTk2NjQ=", "avatar_url": "https://avatars.githubusercontent.com/u/7419664?v=4", "gravatar_id": "", "url": "https://api.github.com/users/LukasKalbertodt", "html_url": "https://github.com/LukasKalbertodt", "followers_url": "https://api.github.com/users/LukasKalbertodt/followers", "following_url": "https://api.github.com/users/LukasKalbertodt/following{/other_user}", "gists_url": "https://api.github.com/users/LukasKalbertodt/gists{/gist_id}", "starred_url": "https://api.github.com/users/LukasKalbertodt/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/LukasKalbertodt/subscriptions", "organizations_url": "https://api.github.com/users/LukasKalbertodt/orgs", "repos_url": "https://api.github.com/users/LukasKalbertodt/repos", "events_url": "https://api.github.com/users/LukasKalbertodt/events{/privacy}", "received_events_url": "https://api.github.com/users/LukasKalbertodt/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e8ee00a6493b8cde09f5497f430d46a978ae865f", "url": "https://api.github.com/repos/rust-lang/rust/commits/e8ee00a6493b8cde09f5497f430d46a978ae865f", "html_url": "https://github.com/rust-lang/rust/commit/e8ee00a6493b8cde09f5497f430d46a978ae865f"}], "stats": {"total": 17, "additions": 12, "deletions": 5}, "files": [{"sha": "9edda304bb9e84451c218e8850069840ad5135bc", "filename": "src/libstd/io/mod.rs", "status": "modified", "additions": 12, "deletions": 5, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/598a1b4dd1a6cc1bfe689a6931af9e6aa47134e1/src%2Flibstd%2Fio%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/598a1b4dd1a6cc1bfe689a6931af9e6aa47134e1/src%2Flibstd%2Fio%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fio%2Fmod.rs?ref=598a1b4dd1a6cc1bfe689a6931af9e6aa47134e1", "patch": "@@ -1332,10 +1332,11 @@ pub trait Seek {\n \n     /// Returns the length of this stream (in bytes).\n     ///\n-    /// This method is implemented using three seek operations. If this method\n-    /// returns successfully, the seek position is unchanged (i.e. the position\n-    /// before calling this method is the same as afterwards). However, if this\n-    /// method returns an error, the seek position is undefined.\n+    /// This method is implemented using up to three seek operations. If this\n+    /// method returns successfully, the seek position is unchanged (i.e. the\n+    /// position before calling this method is the same as afterwards).\n+    /// However, if this method returns an error, the seek position is\n+    /// undefined.\n     ///\n     /// If you need to obtain the length of *many* streams and you don't care\n     /// about the seek position afterwards, you can reduce the number of seek\n@@ -1368,7 +1369,13 @@ pub trait Seek {\n     fn stream_len(&mut self) -> Result<u64> {\n         let old_pos = self.stream_position()?;\n         let len = self.seek(SeekFrom::End(0))?;\n-        self.seek(SeekFrom::Start(old_pos))?;\n+\n+        // Avoid seeking a third time when we were already at the end of the\n+        // stream. The branch is usually way cheaper than a seek operation.\n+        if old_pos != len {\n+            self.seek(SeekFrom::Start(old_pos))?;\n+        }\n+\n         Ok(len)\n     }\n "}]}