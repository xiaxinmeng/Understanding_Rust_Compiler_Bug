{"sha": "a7c797909c939d5427fe0d0eaa3e8210b76a5431", "node_id": "C_kwDOAAsO6NoAKGE3Yzc5NzkwOWM5MzlkNTQyN2ZlMGQwZWFhM2U4MjEwYjc2YTU0MzE", "commit": {"author": {"name": "bjorn3", "email": "17426603+bjorn3@users.noreply.github.com", "date": "2023-04-25T13:43:27Z"}, "committer": {"name": "bjorn3", "email": "17426603+bjorn3@users.noreply.github.com", "date": "2023-04-25T13:43:27Z"}, "message": "Make rustdoc using run-make tests work", "tree": {"sha": "53f0eba430607827c7893fcefa25e32bce8c32dc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/53f0eba430607827c7893fcefa25e32bce8c32dc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a7c797909c939d5427fe0d0eaa3e8210b76a5431", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a7c797909c939d5427fe0d0eaa3e8210b76a5431", "html_url": "https://github.com/rust-lang/rust/commit/a7c797909c939d5427fe0d0eaa3e8210b76a5431", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a7c797909c939d5427fe0d0eaa3e8210b76a5431/comments", "author": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b56d4ab66b8574e8b583793e536326a40eeab384", "url": "https://api.github.com/repos/rust-lang/rust/commits/b56d4ab66b8574e8b583793e536326a40eeab384", "html_url": "https://github.com/rust-lang/rust/commit/b56d4ab66b8574e8b583793e536326a40eeab384"}], "stats": {"total": 31, "additions": 23, "deletions": 8}, "files": [{"sha": "58cd544754a026fab12b42ba13527f1cdeab651b", "filename": "scripts/test_rustc_tests.sh", "status": "modified", "additions": 23, "deletions": 8, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/a7c797909c939d5427fe0d0eaa3e8210b76a5431/scripts%2Ftest_rustc_tests.sh", "raw_url": "https://github.com/rust-lang/rust/raw/a7c797909c939d5427fe0d0eaa3e8210b76a5431/scripts%2Ftest_rustc_tests.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/scripts%2Ftest_rustc_tests.sh?ref=a7c797909c939d5427fe0d0eaa3e8210b76a5431", "patch": "@@ -126,17 +126,12 @@ rm tests/ui/proc-macro/no-missing-docs.rs # same\n rm tests/ui/rust-2018/proc-macro-crate-in-paths.rs # same\n rm tests/ui/proc-macro/allowed-signatures.rs # same\n \n+# rustdoc-clif passes extra args, suppressing the help message when no args are passed\n+rm -r tests/run-make/issue-88756-default-output\n+\n # doesn't work due to the way the rustc test suite is invoked.\n # should work when using ./x.py test the way it is intended\n # ============================================================\n-rm -r tests/run-make/emit-shared-files # requires the rustdoc executable in dist/bin/\n-rm -r tests/run-make/unstable-flag-required # same\n-rm -r tests/run-make/rustdoc-* # same\n-rm -r tests/run-make/issue-88756-default-output # same\n-rm -r tests/run-make/doctests-keep-binaries # same\n-rm -r tests/run-make/exit-code # same\n-rm -r tests/run-make/issue-22131 # same\n-rm -r tests/run-make/issue-38237 # same\n rm -r tests/run-make/remap-path-prefix-dwarf # requires llvm-dwarfdump\n rm -r tests/ui/consts/missing_span_in_backtrace.rs # expects sysroot source to be elsewhere\n \n@@ -162,6 +157,26 @@ rm tests/ui/process/nofile-limit.rs # TODO some AArch64 linking issue\n \n rm tests/ui/stdio-is-blocking.rs # really slow with unoptimized libstd\n \n+cp ../dist/bin/rustdoc-clif ../dist/bin/rustdoc # some tests expect bin/rustdoc to exist\n+\n+# prevent $(RUSTDOC) from picking up the sysroot built by x.py. It conflicts with the one used by\n+# rustdoc-clif\n+cat <<EOF | git apply -\n+diff --git a/tests/run-make/tools.mk b/tests/run-make/tools.mk\n+index ea06b620c4c..b969d0009c6 100644\n+--- a/tests/run-make/tools.mk\n++++ b/tests/run-make/tools.mk\n+@@ -9,7 +9,7 @@ RUSTC_ORIGINAL := \\$(RUSTC)\n+ BARE_RUSTC := \\$(HOST_RPATH_ENV) '\\$(RUSTC)'\n+ BARE_RUSTDOC := \\$(HOST_RPATH_ENV) '\\$(RUSTDOC)'\n+ RUSTC := \\$(BARE_RUSTC) --out-dir \\$(TMPDIR) -L \\$(TMPDIR) \\$(RUSTFLAGS)\n+-RUSTDOC := \\$(BARE_RUSTDOC) -L \\$(TARGET_RPATH_DIR)\n++RUSTDOC := \\$(BARE_RUSTDOC)\n+ ifdef RUSTC_LINKER\n+ RUSTC := \\$(RUSTC) -Clinker='\\$(RUSTC_LINKER)'\n+ RUSTDOC := \\$(RUSTDOC) -Clinker='\\$(RUSTC_LINKER)'\n+EOF\n+\n echo \"[TEST] rustc test suite\"\n COMPILETEST_FORCE_STAGE0=1 ./x.py test --stage 0 --test-args=--nocapture tests/{codegen-units,run-make,run-pass-valgrind,ui,incremental}\n popd"}]}