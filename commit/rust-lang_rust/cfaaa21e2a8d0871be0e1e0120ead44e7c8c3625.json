{"sha": "cfaaa21e2a8d0871be0e1e0120ead44e7c8c3625", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNmYWFhMjFlMmE4ZDA4NzFiZTBlMWUwMTIwZWFkNDRlN2M4YzM2MjU=", "commit": {"author": {"name": "LeSeulArtichaut", "email": "leseulartichaut@gmail.com", "date": "2020-11-11T15:14:04Z"}, "committer": {"name": "LeSeulArtichaut", "email": "leseulartichaut@gmail.com", "date": "2020-12-06T10:48:08Z"}, "message": "Implement liveness passes for if-let guards", "tree": {"sha": "7ba334918fffb336d06013be06d69de38cf952ed", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7ba334918fffb336d06013be06d69de38cf952ed"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cfaaa21e2a8d0871be0e1e0120ead44e7c8c3625", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cfaaa21e2a8d0871be0e1e0120ead44e7c8c3625", "html_url": "https://github.com/rust-lang/rust/commit/cfaaa21e2a8d0871be0e1e0120ead44e7c8c3625", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cfaaa21e2a8d0871be0e1e0120ead44e7c8c3625/comments", "author": {"login": "LeSeulArtichaut", "id": 38361244, "node_id": "MDQ6VXNlcjM4MzYxMjQ0", "avatar_url": "https://avatars.githubusercontent.com/u/38361244?v=4", "gravatar_id": "", "url": "https://api.github.com/users/LeSeulArtichaut", "html_url": "https://github.com/LeSeulArtichaut", "followers_url": "https://api.github.com/users/LeSeulArtichaut/followers", "following_url": "https://api.github.com/users/LeSeulArtichaut/following{/other_user}", "gists_url": "https://api.github.com/users/LeSeulArtichaut/gists{/gist_id}", "starred_url": "https://api.github.com/users/LeSeulArtichaut/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/LeSeulArtichaut/subscriptions", "organizations_url": "https://api.github.com/users/LeSeulArtichaut/orgs", "repos_url": "https://api.github.com/users/LeSeulArtichaut/repos", "events_url": "https://api.github.com/users/LeSeulArtichaut/events{/privacy}", "received_events_url": "https://api.github.com/users/LeSeulArtichaut/received_events", "type": "User", "site_admin": false}, "committer": {"login": "LeSeulArtichaut", "id": 38361244, "node_id": "MDQ6VXNlcjM4MzYxMjQ0", "avatar_url": "https://avatars.githubusercontent.com/u/38361244?v=4", "gravatar_id": "", "url": "https://api.github.com/users/LeSeulArtichaut", "html_url": "https://github.com/LeSeulArtichaut", "followers_url": "https://api.github.com/users/LeSeulArtichaut/followers", "following_url": "https://api.github.com/users/LeSeulArtichaut/following{/other_user}", "gists_url": "https://api.github.com/users/LeSeulArtichaut/gists{/gist_id}", "starred_url": "https://api.github.com/users/LeSeulArtichaut/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/LeSeulArtichaut/subscriptions", "organizations_url": "https://api.github.com/users/LeSeulArtichaut/orgs", "repos_url": "https://api.github.com/users/LeSeulArtichaut/repos", "events_url": "https://api.github.com/users/LeSeulArtichaut/events{/privacy}", "received_events_url": "https://api.github.com/users/LeSeulArtichaut/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f9cc626028d5ae1bcecf4703fae59d165338ee20", "url": "https://api.github.com/repos/rust-lang/rust/commits/f9cc626028d5ae1bcecf4703fae59d165338ee20", "html_url": "https://github.com/rust-lang/rust/commit/f9cc626028d5ae1bcecf4703fae59d165338ee20"}], "stats": {"total": 14, "additions": 10, "deletions": 4}, "files": [{"sha": "5ff5fd3a6b6dcfba2b6f20277199bbdce578c312", "filename": "compiler/rustc_passes/src/liveness.rs", "status": "modified", "additions": 10, "deletions": 4, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/cfaaa21e2a8d0871be0e1e0120ead44e7c8c3625/compiler%2Frustc_passes%2Fsrc%2Fliveness.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cfaaa21e2a8d0871be0e1e0120ead44e7c8c3625/compiler%2Frustc_passes%2Fsrc%2Fliveness.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fliveness.rs?ref=cfaaa21e2a8d0871be0e1e0120ead44e7c8c3625", "patch": "@@ -358,6 +358,9 @@ impl<'tcx> Visitor<'tcx> for IrMaps<'tcx> {\n \n     fn visit_arm(&mut self, arm: &'tcx hir::Arm<'tcx>) {\n         self.add_from_pat(&arm.pat);\n+        if let Some(hir::Guard::IfLet(ref pat, _)) = arm.guard {\n+            self.add_from_pat(pat);\n+        }\n         intravisit::walk_arm(self, arm);\n     }\n \n@@ -1029,10 +1032,13 @@ impl<'a, 'tcx> Liveness<'a, 'tcx> {\n                 for arm in arms {\n                     let body_succ = self.propagate_through_expr(&arm.body, succ);\n \n-                    let guard_succ = self.propagate_through_opt_expr(\n-                        arm.guard.as_ref().map(|hir::Guard::If(e)| *e),\n-                        body_succ,\n-                    );\n+                    let guard_succ = arm.guard.as_ref().map_or(body_succ, |g| match g {\n+                        hir::Guard::If(e) => self.propagate_through_expr(e, body_succ),\n+                        hir::Guard::IfLet(pat, e) => {\n+                            let let_bind = self.define_bindings_in_pat(pat, body_succ);\n+                            self.propagate_through_expr(e, let_bind)\n+                        }\n+                    });\n                     let arm_succ = self.define_bindings_in_pat(&arm.pat, guard_succ);\n                     self.merge_from_succ(ln, arm_succ, first_merge);\n                     first_merge = false;"}]}