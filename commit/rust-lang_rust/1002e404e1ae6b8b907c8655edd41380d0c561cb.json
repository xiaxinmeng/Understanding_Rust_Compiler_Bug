{"sha": "1002e404e1ae6b8b907c8655edd41380d0c561cb", "node_id": "MDY6Q29tbWl0NzI0NzEyOjEwMDJlNDA0ZTFhZTZiOGI5MDdjODY1NWVkZDQxMzgwZDBjNTYxY2I=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-09-21T10:30:24Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-09-21T10:30:24Z"}, "message": "Auto merge of #54399 - alexcrichton:fix-bug, r=steveklabnik\n\nstd: Check for overflow in `str::repeat`\n\nThis commit fixes a buffer overflow issue in the standard library\ndiscovered by Scott McMurray where if a large number was passed to\n`str::repeat` it may cause and out of bounds write to the buffer of a `Vec`.\nThis bug was accidentally introduced in #48657 when optimizing the\n`str::repeat` function. The bug affects stable Rust releases 1.26.0 to\n1.29.0. We plan on backporting this fix to create a 1.29.1 release, and\nthe 1.30.0 release onwards will include this fix.\n\nThe fix in this commit is to introduce a deterministic panic in the case of\ncapacity overflow. When repeating a slice where the resulting length is larger\nthan the address space, there\u2019s no way it can succeed anyway!\n\nThe standard library and surrounding libraries were briefly checked to see if\nthere were othere instances of preallocating a vector with a calculation that\nmay overflow. No instances of this bug (out of bounds write due to a calculation\noverflow) were found at this time.\n\nNote that this commit is the first steps towards fixing this issue,\nwe'll be making a formal post to the Rust security list once these\ncommits have been merged.", "tree": {"sha": "b0c882168930ac668f90d859077697fb9779fa5f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b0c882168930ac668f90d859077697fb9779fa5f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1002e404e1ae6b8b907c8655edd41380d0c561cb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1002e404e1ae6b8b907c8655edd41380d0c561cb", "html_url": "https://github.com/rust-lang/rust/commit/1002e404e1ae6b8b907c8655edd41380d0c561cb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1002e404e1ae6b8b907c8655edd41380d0c561cb/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2fa1390f6c1ca36b0cc1c126e6d295d360f42b6c", "url": "https://api.github.com/repos/rust-lang/rust/commits/2fa1390f6c1ca36b0cc1c126e6d295d360f42b6c", "html_url": "https://github.com/rust-lang/rust/commit/2fa1390f6c1ca36b0cc1c126e6d295d360f42b6c"}, {"sha": "8ac88d375e00c91a3db5d78852048322f88be3c1", "url": "https://api.github.com/repos/rust-lang/rust/commits/8ac88d375e00c91a3db5d78852048322f88be3c1", "html_url": "https://github.com/rust-lang/rust/commit/8ac88d375e00c91a3db5d78852048322f88be3c1"}], "stats": {"total": 29, "additions": 28, "deletions": 1}, "files": [{"sha": "6c0b1c33a1f7673ee3c4a2ed40a789214a20be4d", "filename": "src/liballoc/slice.rs", "status": "modified", "additions": 15, "deletions": 1, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/1002e404e1ae6b8b907c8655edd41380d0c561cb/src%2Fliballoc%2Fslice.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1002e404e1ae6b8b907c8655edd41380d0c561cb/src%2Fliballoc%2Fslice.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fliballoc%2Fslice.rs?ref=1002e404e1ae6b8b907c8655edd41380d0c561cb", "patch": "@@ -392,6 +392,10 @@ impl<T> [T] {\n \n     /// Creates a vector by repeating a slice `n` times.\n     ///\n+    /// # Panics\n+    ///\n+    /// This function will panic if the capacity would overflow.\n+    ///\n     /// # Examples\n     ///\n     /// Basic usage:\n@@ -403,6 +407,16 @@ impl<T> [T] {\n     ///     assert_eq!([1, 2].repeat(3), vec![1, 2, 1, 2, 1, 2]);\n     /// }\n     /// ```\n+    ///\n+    /// A panic upon overflow:\n+    ///\n+    /// ```should_panic\n+    /// #![feature(repeat_generic_slice)]\n+    /// fn main() {\n+    ///     // this will panic at runtime\n+    ///     b\"0123456789abcdef\".repeat(usize::max_value());\n+    /// }\n+    /// ```\n     #[unstable(feature = \"repeat_generic_slice\",\n                reason = \"it's on str, why not on slice?\",\n                issue = \"48784\")]\n@@ -417,7 +431,7 @@ impl<T> [T] {\n         // and `rem` is the remaining part of `n`.\n \n         // Using `Vec` to access `set_len()`.\n-        let mut buf = Vec::with_capacity(self.len() * n);\n+        let mut buf = Vec::with_capacity(self.len().checked_mul(n).expect(\"capacity overflow\"));\n \n         // `2^expn` repetition is done by doubling `buf` `expn`-times.\n         buf.extend(self);"}, {"sha": "2af89562d69fe1d0a6f37c07350c212117c8b131", "filename": "src/liballoc/str.rs", "status": "modified", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/1002e404e1ae6b8b907c8655edd41380d0c561cb/src%2Fliballoc%2Fstr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1002e404e1ae6b8b907c8655edd41380d0c561cb/src%2Fliballoc%2Fstr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fliballoc%2Fstr.rs?ref=1002e404e1ae6b8b907c8655edd41380d0c561cb", "patch": "@@ -515,6 +515,10 @@ impl str {\n \n     /// Creates a new [`String`] by repeating a string `n` times.\n     ///\n+    /// # Panics\n+    ///\n+    /// This function will panic if the capacity would overflow.\n+    ///\n     /// [`String`]: string/struct.String.html\n     ///\n     /// # Examples\n@@ -524,6 +528,15 @@ impl str {\n     /// ```\n     /// assert_eq!(\"abc\".repeat(4), String::from(\"abcabcabcabc\"));\n     /// ```\n+    ///\n+    /// A panic upon overflow:\n+    ///\n+    /// ```should_panic\n+    /// fn main() {\n+    ///     // this will panic at runtime\n+    ///     \"0123456789abcdef\".repeat(usize::max_value());\n+    /// }\n+    /// ```\n     #[stable(feature = \"repeat_str\", since = \"1.16.0\")]\n     pub fn repeat(&self, n: usize) -> String {\n         unsafe { String::from_utf8_unchecked(self.as_bytes().repeat(n)) }"}]}