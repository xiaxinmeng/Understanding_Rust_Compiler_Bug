{"sha": "445bbde7844eacb3de968e2584db2d44e6c4cbab", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQ0NWJiZGU3ODQ0ZWFjYjNkZTk2OGUyNTg0ZGIyZDQ0ZTZjNGNiYWI=", "commit": {"author": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2017-10-12T08:14:22Z"}, "committer": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2017-10-12T17:58:36Z"}, "message": "Rollup merge of #44989 - QuietMisdreavus:what-is-your-quest, r=GuillaumeGomez\n\nlet rustdoc print the crate version into docs\n\nThis PR adds a new unstable flag to rustdoc, `--crate-version`, which when present will add a new entry to the sidebar of the root module, printing the given version number:\n\n![Screenshot of a test crate, showing \"Version 1.3.37\" under the crate name](https://user-images.githubusercontent.com/5217170/31104096-805e3f4c-a7a0-11e7-96fc-368b6fe063d6.png)\n\nCloses #24336\n\n(The WIP status is because i don't want to merge this until i can get the std docs to use it, which i need help from rustbuild people to make sure i get right.)", "tree": {"sha": "7a16afc1e827ce53ffc5a9f4e86918b6b77ae5be", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7a16afc1e827ce53ffc5a9f4e86918b6b77ae5be"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/445bbde7844eacb3de968e2584db2d44e6c4cbab", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEZ1R8CLMp8f2GxWoQ/vbIBR0OATwFAlnfrUwACgkQ/vbIBR0O\nATxsPRAAjfWFxP49sWcW7PsnbWzcEKyOJ09a8k8+AStE5KdFskiLv+DCEAE1RnJh\nTx1MxPmUoK3N9+QBJfsDDH9l/Qb1NnideWEe/WIEsOgOzn9HLCqLlhc5dmnuqrnX\nAu98Vyp0tEhh9zvS9dnbkngDT8WYpUrLNbgLVBFpL0GqYNv9fNlgn12GqyK+WH7M\nuKs4OvEwvcbEoldiAytziQkZlt3uh+wPGiCurqsMt0RFsman/+NnabwNeC9oXyNg\nofMuA+m0FbdJL2GkCFAdHeQzVUAR6Ox7KNZaemQO1kkhCtlG+/mgy5THSb+V+gmG\npbWUpOWg77++WSFguTuvzrF90Ld3DZIEU3sl3kyyQ8uCQVaGq86KS458wnCy3BRA\n8OyiRLctV3PnyotOLweJeyeod3i+73yi1PPOKKUpCSXX7tZjWrl/O68FXcBFZuCP\nOcNkkVTsWP1qKa8utQoyYZnNu/J84RPOthAD2thw4zCMBVRt1ARGVI0Xuf5ZWajo\nXgd3KVhVBQl7LaAFTz/CgGsuGeuCQkEzncLFcYWSUxnrawRRdQB6wYuZCDH3PZv6\ndNXBq25HLzBea3hdpsygVaPIALKyHYqYDcuQsU74GaBXIKDQXFnHe3ie7nIG4uA+\nlmLw7jW/gwDZTSPk/HKH+aj/YG/A/mf7hAaGTCV0oxbiWjaoG2g=\n=Iagp\n-----END PGP SIGNATURE-----", "payload": "tree 7a16afc1e827ce53ffc5a9f4e86918b6b77ae5be\nparent 1807f27a338e8e3f8c3a9c99fde2223b5942e640\nparent 7ea286e854d88529af76ca486ed676c9fb06e8ee\nauthor kennytm <kennytm@gmail.com> 1507796062 +0800\ncommitter kennytm <kennytm@gmail.com> 1507831116 +0800\n\nRollup merge of #44989 - QuietMisdreavus:what-is-your-quest, r=GuillaumeGomez\n\nlet rustdoc print the crate version into docs\n\nThis PR adds a new unstable flag to rustdoc, `--crate-version`, which when present will add a new entry to the sidebar of the root module, printing the given version number:\n\n![Screenshot of a test crate, showing \"Version 1.3.37\" under the crate name](https://user-images.githubusercontent.com/5217170/31104096-805e3f4c-a7a0-11e7-96fc-368b6fe063d6.png)\n\nCloses #24336\n\n(The WIP status is because i don't want to merge this until i can get the std docs to use it, which i need help from rustbuild people to make sure i get right.)\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/445bbde7844eacb3de968e2584db2d44e6c4cbab", "html_url": "https://github.com/rust-lang/rust/commit/445bbde7844eacb3de968e2584db2d44e6c4cbab", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/445bbde7844eacb3de968e2584db2d44e6c4cbab/comments", "author": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1807f27a338e8e3f8c3a9c99fde2223b5942e640", "url": "https://api.github.com/repos/rust-lang/rust/commits/1807f27a338e8e3f8c3a9c99fde2223b5942e640", "html_url": "https://github.com/rust-lang/rust/commit/1807f27a338e8e3f8c3a9c99fde2223b5942e640"}, {"sha": "7ea286e854d88529af76ca486ed676c9fb06e8ee", "url": "https://api.github.com/repos/rust-lang/rust/commits/7ea286e854d88529af76ca486ed676c9fb06e8ee", "html_url": "https://github.com/rust-lang/rust/commit/7ea286e854d88529af76ca486ed676c9fb06e8ee"}], "stats": {"total": 58, "additions": 57, "deletions": 1}, "files": [{"sha": "d18512b257d6aa9fcc08c037520a310dca995f7c", "filename": "src/bootstrap/bin/rustdoc.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/445bbde7844eacb3de968e2584db2d44e6c4cbab/src%2Fbootstrap%2Fbin%2Frustdoc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/445bbde7844eacb3de968e2584db2d44e6c4cbab/src%2Fbootstrap%2Fbin%2Frustdoc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbin%2Frustdoc.rs?ref=445bbde7844eacb3de968e2584db2d44e6c4cbab", "patch": "@@ -48,6 +48,14 @@ fn main() {\n         cmd.arg(\"-Z\").arg(\"force-unstable-if-unmarked\");\n     }\n \n+    // Bootstrap's Cargo-command builder sets this variable to the current Rust version; let's pick\n+    // it up so we can make rustdoc print this into the docs\n+    if let Some(version) = env::var_os(\"RUSTDOC_CRATE_VERSION\") {\n+        // This \"unstable-options\" can be removed when `--crate-version` is stabilized\n+        cmd.arg(\"-Z\").arg(\"unstable-options\")\n+           .arg(\"--crate-version\").arg(version);\n+    }\n+\n     std::process::exit(match cmd.status() {\n         Ok(s) => s.code().unwrap_or(1),\n         Err(e) => panic!(\"\\n\\nfailed to run {:?}: {}\\n\\n\", cmd, e),"}, {"sha": "1d63e112ca6fb357e9286bcef175cdb065dcbeae", "filename": "src/bootstrap/builder.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/445bbde7844eacb3de968e2584db2d44e6c4cbab/src%2Fbootstrap%2Fbuilder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/445bbde7844eacb3de968e2584db2d44e6c4cbab/src%2Fbootstrap%2Fbuilder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuilder.rs?ref=445bbde7844eacb3de968e2584db2d44e6c4cbab", "patch": "@@ -418,7 +418,8 @@ impl<'a> Builder<'a> {\n             .env(\"RUSTC_SYSROOT\", self.sysroot(compiler))\n             .env(\"RUSTC_LIBDIR\", self.sysroot_libdir(compiler, self.build.build))\n             .env(\"CFG_RELEASE_CHANNEL\", &self.build.config.channel)\n-            .env(\"RUSTDOC_REAL\", self.rustdoc(host));\n+            .env(\"RUSTDOC_REAL\", self.rustdoc(host))\n+            .env(\"RUSTDOC_CRATE_VERSION\", self.build.rust_version());\n         cmd\n     }\n \n@@ -574,6 +575,9 @@ impl<'a> Builder<'a> {\n             cargo.env(\"RUSTC_SAVE_ANALYSIS\", \"api\".to_string());\n         }\n \n+        // For `cargo doc` invocations, make rustdoc print the Rust version into the docs\n+        cargo.env(\"RUSTDOC_CRATE_VERSION\", self.build.rust_version());\n+\n         // Environment variables *required* throughout the build\n         //\n         // FIXME: should update code to not require this env var"}, {"sha": "e217978648efa21bc836f6aeeb8f9c905d67a62d", "filename": "src/librustdoc/clean/mod.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/445bbde7844eacb3de968e2584db2d44e6c4cbab/src%2Flibrustdoc%2Fclean%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/445bbde7844eacb3de968e2584db2d44e6c4cbab/src%2Flibrustdoc%2Fclean%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Fmod.rs?ref=445bbde7844eacb3de968e2584db2d44e6c4cbab", "patch": "@@ -112,6 +112,7 @@ impl<T: Clean<U>, U> Clean<Vec<U>> for P<[T]> {\n #[derive(Clone, Debug)]\n pub struct Crate {\n     pub name: String,\n+    pub version: Option<String>,\n     pub src: PathBuf,\n     pub module: Option<Item>,\n     pub externs: Vec<(CrateNum, ExternalCrate)>,\n@@ -183,6 +184,7 @@ impl<'a, 'tcx> Clean<Crate> for visit_ast::RustdocVisitor<'a, 'tcx> {\n \n         Crate {\n             name,\n+            version: None,\n             src,\n             module: Some(module),\n             externs,"}, {"sha": "967a19e0e968fb103a3d4e783b4a025a32d44667", "filename": "src/librustdoc/html/render.rs", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/445bbde7844eacb3de968e2584db2d44e6c4cbab/src%2Flibrustdoc%2Fhtml%2Frender.rs", "raw_url": "https://github.com/rust-lang/rust/raw/445bbde7844eacb3de968e2584db2d44e6c4cbab/src%2Flibrustdoc%2Fhtml%2Frender.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender.rs?ref=445bbde7844eacb3de968e2584db2d44e6c4cbab", "patch": "@@ -256,6 +256,9 @@ pub struct Cache {\n     // the access levels from crateanalysis.\n     pub access_levels: Arc<AccessLevels<DefId>>,\n \n+    /// The version of the crate being documented, if given fron the `--crate-version` flag.\n+    pub crate_version: Option<String>,\n+\n     // Private fields only used when initially crawling a crate to build a cache\n \n     stack: Vec<String>,\n@@ -534,6 +537,7 @@ pub fn run(mut krate: clean::Crate,\n         primitive_locations: FxHashMap(),\n         stripped_mod: false,\n         access_levels: krate.access_levels.clone(),\n+        crate_version: krate.version.take(),\n         orphan_impl_items: Vec::new(),\n         traits: mem::replace(&mut krate.external_traits, FxHashMap()),\n         deref_trait_did,\n@@ -3433,6 +3437,16 @@ impl<'a> fmt::Display for Sidebar<'a> {\n             write!(fmt, \"{}\", it.name.as_ref().unwrap())?;\n             write!(fmt, \"</p>\")?;\n \n+            if it.is_crate() {\n+                if let Some(ref version) = cache().crate_version {\n+                    write!(fmt,\n+                           \"<div class='block version'>\\\n+                            <p>Version {}</p>\\\n+                            </div>\",\n+                           version)?;\n+                }\n+            }\n+\n             match it.inner {\n                 clean::StructItem(ref s) => sidebar_struct(fmt, it, s)?,\n                 clean::TraitItem(ref t) => sidebar_trait(fmt, it, t)?,"}, {"sha": "61a3902098ffa6eab4c6139143f19e747880fbd7", "filename": "src/librustdoc/html/static/rustdoc.css", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/445bbde7844eacb3de968e2584db2d44e6c4cbab/src%2Flibrustdoc%2Fhtml%2Fstatic%2Frustdoc.css", "raw_url": "https://github.com/rust-lang/rust/raw/445bbde7844eacb3de968e2584db2d44e6c4cbab/src%2Flibrustdoc%2Fhtml%2Fstatic%2Frustdoc.css", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Frustdoc.css?ref=445bbde7844eacb3de968e2584db2d44e6c4cbab", "patch": "@@ -203,6 +203,15 @@ nav.sub {\n \tword-wrap: break-word;\n }\n \n+.sidebar .version {\n+\tfont-size: 15px;\n+\ttext-align: center;\n+\tborder-bottom: #DDDDDD 1px solid;\n+\toverflow-wrap: break-word;\n+\tword-wrap: break-word; /* deprecated */\n+\tword-break: break-word; /* Chrome, non-standard */\n+}\n+\n .location:empty {\n \tborder: none;\n }"}, {"sha": "f8bf00ad73fcca1fb9fc417e80978d6a47e1e619", "filename": "src/librustdoc/lib.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/445bbde7844eacb3de968e2584db2d44e6c4cbab/src%2Flibrustdoc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/445bbde7844eacb3de968e2584db2d44e6c4cbab/src%2Flibrustdoc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Flib.rs?ref=445bbde7844eacb3de968e2584db2d44e6c4cbab", "patch": "@@ -243,6 +243,9 @@ pub fn opts() -> Vec<RustcOptGroup> {\n         unstable(\"display-warnings\", |o| {\n             o.optflag(\"\", \"display-warnings\", \"to print code warnings when testing doc\")\n         }),\n+        unstable(\"crate-version\", |o| {\n+            o.optopt(\"\", \"crate-version\", \"crate version to print into documentation\", \"VERSION\")\n+        }),\n     ]\n }\n \n@@ -460,6 +463,7 @@ where R: 'static + Send, F: 'static + Send + FnOnce(Output) -> R {\n     let triple = matches.opt_str(\"target\");\n     let maybe_sysroot = matches.opt_str(\"sysroot\").map(PathBuf::from);\n     let crate_name = matches.opt_str(\"crate-name\");\n+    let crate_version = matches.opt_str(\"crate-version\");\n     let plugin_path = matches.opt_str(\"plugin-path\");\n \n     let cr = PathBuf::from(cratefile);\n@@ -484,6 +488,8 @@ where R: 'static + Send, F: 'static + Send + FnOnce(Output) -> R {\n             krate.name = name\n         }\n \n+        krate.version = crate_version;\n+\n         // Process all of the crate attributes, extracting plugin metadata along\n         // with the passes which we are supposed to run.\n         for attr in krate.module.as_ref().unwrap().attrs.lists(\"doc\") {"}, {"sha": "07ab5ceedfa028dc068b3d692d76e000fde12e06", "filename": "src/test/rustdoc/crate-version.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/445bbde7844eacb3de968e2584db2d44e6c4cbab/src%2Ftest%2Frustdoc%2Fcrate-version.rs", "raw_url": "https://github.com/rust-lang/rust/raw/445bbde7844eacb3de968e2584db2d44e6c4cbab/src%2Ftest%2Frustdoc%2Fcrate-version.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fcrate-version.rs?ref=445bbde7844eacb3de968e2584db2d44e6c4cbab", "patch": "@@ -0,0 +1,13 @@\n+// Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// compile-flags: --crate-version=1.3.37 -Z unstable-options\n+\n+// @has 'crate_version/index.html' '//div[@class=\"block version\"]/p' 'Version 1.3.37'"}]}