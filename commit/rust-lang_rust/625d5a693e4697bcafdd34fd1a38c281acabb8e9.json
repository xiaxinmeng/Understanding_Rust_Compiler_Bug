{"sha": "625d5a693e4697bcafdd34fd1a38c281acabb8e9", "node_id": "MDY6Q29tbWl0NzI0NzEyOjYyNWQ1YTY5M2U0Njk3YmNhZmRkMzRmZDFhMzhjMjgxYWNhYmI4ZTk=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-06-01T20:09:03Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-06-01T20:09:03Z"}, "message": "Auto merge of #85829 - bjorn3:simplify_crate_num, r=jackh726\n\nRemove CrateNum::ReservedForIncrCompCache\n\nIt's only use is easily replaceable with `Option<CrateNum>`.", "tree": {"sha": "5e75538fc6a096ff500ddb5e396dd62db69c890c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5e75538fc6a096ff500ddb5e396dd62db69c890c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/625d5a693e4697bcafdd34fd1a38c281acabb8e9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/625d5a693e4697bcafdd34fd1a38c281acabb8e9", "html_url": "https://github.com/rust-lang/rust/commit/625d5a693e4697bcafdd34fd1a38c281acabb8e9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/625d5a693e4697bcafdd34fd1a38c281acabb8e9/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7f9ab0300cd66f6f616e03ea90b2d71af474bf28", "url": "https://api.github.com/repos/rust-lang/rust/commits/7f9ab0300cd66f6f616e03ea90b2d71af474bf28", "html_url": "https://github.com/rust-lang/rust/commit/7f9ab0300cd66f6f616e03ea90b2d71af474bf28"}, {"sha": "5ab25ab6821425bb1bfc5bd529e62e7ada266162", "url": "https://api.github.com/repos/rust-lang/rust/commits/5ab25ab6821425bb1bfc5bd529e62e7ada266162", "html_url": "https://github.com/rust-lang/rust/commit/5ab25ab6821425bb1bfc5bd529e62e7ada266162"}], "stats": {"total": 83, "additions": 12, "deletions": 71}, "files": [{"sha": "706f3f6d8542b1f1d3b95cd571563dc4082dc03b", "filename": "compiler/rustc_metadata/src/rmeta/decoder.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/625d5a693e4697bcafdd34fd1a38c281acabb8e9/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fdecoder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/625d5a693e4697bcafdd34fd1a38c281acabb8e9/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fdecoder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fdecoder.rs?ref=625d5a693e4697bcafdd34fd1a38c281acabb8e9", "patch": "@@ -300,7 +300,7 @@ impl<'a, 'tcx> TyDecoder<'tcx> for DecodeContext<'a, 'tcx> {\n     {\n         let tcx = self.tcx();\n \n-        let key = ty::CReaderCacheKey { cnum: self.cdata().cnum, pos: shorthand };\n+        let key = ty::CReaderCacheKey { cnum: Some(self.cdata().cnum), pos: shorthand };\n \n         if let Some(&ty) = tcx.ty_rcache.borrow().get(&key) {\n             return Ok(ty);"}, {"sha": "fa4030e26f9bb2f2ee097e82bef071c91000d473", "filename": "compiler/rustc_middle/src/ty/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/625d5a693e4697bcafdd34fd1a38c281acabb8e9/compiler%2Frustc_middle%2Fsrc%2Fty%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/625d5a693e4697bcafdd34fd1a38c281acabb8e9/compiler%2Frustc_middle%2Fsrc%2Fty%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fmod.rs?ref=625d5a693e4697bcafdd34fd1a38c281acabb8e9", "patch": "@@ -269,7 +269,7 @@ pub struct CrateVariancesMap<'tcx> {\n // the types of AST nodes.\n #[derive(Copy, Clone, PartialEq, Eq, Hash)]\n pub struct CReaderCacheKey {\n-    pub cnum: CrateNum,\n+    pub cnum: Option<CrateNum>,\n     pub pos: usize,\n }\n "}, {"sha": "e473559812fe6222c67201231004d279a88bb0a0", "filename": "compiler/rustc_middle/src/ty/query/on_disk_cache.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/625d5a693e4697bcafdd34fd1a38c281acabb8e9/compiler%2Frustc_middle%2Fsrc%2Fty%2Fquery%2Fon_disk_cache.rs", "raw_url": "https://github.com/rust-lang/rust/raw/625d5a693e4697bcafdd34fd1a38c281acabb8e9/compiler%2Frustc_middle%2Fsrc%2Fty%2Fquery%2Fon_disk_cache.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fquery%2Fon_disk_cache.rs?ref=625d5a693e4697bcafdd34fd1a38c281acabb8e9", "patch": "@@ -755,8 +755,7 @@ impl<'a, 'tcx> TyDecoder<'tcx> for CacheDecoder<'a, 'tcx> {\n     {\n         let tcx = self.tcx();\n \n-        let cache_key =\n-            ty::CReaderCacheKey { cnum: CrateNum::ReservedForIncrCompCache, pos: shorthand };\n+        let cache_key = ty::CReaderCacheKey { cnum: None, pos: shorthand };\n \n         if let Some(&ty) = tcx.ty_rcache.borrow().get(&cache_key) {\n             return Ok(ty);"}, {"sha": "f6672335cb1385d6e80b58767dd6a7755524c66b", "filename": "compiler/rustc_mir/src/transform/coverage/debug.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/625d5a693e4697bcafdd34fd1a38c281acabb8e9/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcoverage%2Fdebug.rs", "raw_url": "https://github.com/rust-lang/rust/raw/625d5a693e4697bcafdd34fd1a38c281acabb8e9/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcoverage%2Fdebug.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcoverage%2Fdebug.rs?ref=625d5a693e4697bcafdd34fd1a38c281acabb8e9", "patch": "@@ -116,7 +116,6 @@ use crate::util::pretty;\n use crate::util::spanview::{self, SpanViewable};\n \n use rustc_data_structures::fx::FxHashMap;\n-use rustc_index::vec::Idx;\n use rustc_middle::mir::coverage::*;\n use rustc_middle::mir::{self, BasicBlock, TerminatorKind};\n use rustc_middle::ty::TyCtxt;"}, {"sha": "770b52a4d4b0fbb3ffc26e9bdf3030b23e2d7e4c", "filename": "compiler/rustc_mir/src/util/generic_graph.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/625d5a693e4697bcafdd34fd1a38c281acabb8e9/compiler%2Frustc_mir%2Fsrc%2Futil%2Fgeneric_graph.rs", "raw_url": "https://github.com/rust-lang/rust/raw/625d5a693e4697bcafdd34fd1a38c281acabb8e9/compiler%2Frustc_mir%2Fsrc%2Futil%2Fgeneric_graph.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Futil%2Fgeneric_graph.rs?ref=625d5a693e4697bcafdd34fd1a38c281acabb8e9", "patch": "@@ -1,6 +1,5 @@\n use gsgdt::{Edge, Graph, Node, NodeStyle};\n use rustc_hir::def_id::DefId;\n-use rustc_index::vec::Idx;\n use rustc_middle::mir::*;\n use rustc_middle::ty::TyCtxt;\n "}, {"sha": "85aba67c5e24008d3f43193fdc6967fd45de58fb", "filename": "compiler/rustc_span/src/def_id.rs", "status": "modified", "additions": 4, "deletions": 60, "changes": 64, "blob_url": "https://github.com/rust-lang/rust/blob/625d5a693e4697bcafdd34fd1a38c281acabb8e9/compiler%2Frustc_span%2Fsrc%2Fdef_id.rs", "raw_url": "https://github.com/rust-lang/rust/raw/625d5a693e4697bcafdd34fd1a38c281acabb8e9/compiler%2Frustc_span%2Fsrc%2Fdef_id.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Fdef_id.rs?ref=625d5a693e4697bcafdd34fd1a38c281acabb8e9", "patch": "@@ -9,76 +9,29 @@ use std::borrow::Borrow;\n use std::fmt;\n \n rustc_index::newtype_index! {\n-    pub struct CrateId {\n+    pub struct CrateNum {\n         ENCODABLE = custom\n+        DEBUG_FORMAT = \"crate{}\"\n     }\n }\n \n-#[derive(Copy, Clone, PartialEq, Eq, PartialOrd, Ord, Hash)]\n-pub enum CrateNum {\n-    /// A special `CrateNum` that we use for the `tcx.rcache` when decoding from\n-    /// the incr. comp. cache.\n-    ReservedForIncrCompCache,\n-    Index(CrateId),\n-}\n-\n /// Item definitions in the currently-compiled crate would have the `CrateNum`\n /// `LOCAL_CRATE` in their `DefId`.\n-pub const LOCAL_CRATE: CrateNum = CrateNum::Index(CrateId::from_u32(0));\n-\n-impl Idx for CrateNum {\n-    #[inline]\n-    fn new(value: usize) -> Self {\n-        CrateNum::Index(Idx::new(value))\n-    }\n-\n-    #[inline]\n-    fn index(self) -> usize {\n-        match self {\n-            CrateNum::Index(idx) => Idx::index(idx),\n-            _ => panic!(\"Tried to get crate index of {:?}\", self),\n-        }\n-    }\n-}\n+pub const LOCAL_CRATE: CrateNum = CrateNum::from_u32(0);\n \n impl CrateNum {\n     pub fn new(x: usize) -> CrateNum {\n         CrateNum::from_usize(x)\n     }\n \n-    pub fn from_usize(x: usize) -> CrateNum {\n-        CrateNum::Index(CrateId::from_usize(x))\n-    }\n-\n-    pub fn from_u32(x: u32) -> CrateNum {\n-        CrateNum::Index(CrateId::from_u32(x))\n-    }\n-\n-    pub fn as_usize(self) -> usize {\n-        match self {\n-            CrateNum::Index(id) => id.as_usize(),\n-            _ => panic!(\"tried to get index of non-standard crate {:?}\", self),\n-        }\n-    }\n-\n-    pub fn as_u32(self) -> u32 {\n-        match self {\n-            CrateNum::Index(id) => id.as_u32(),\n-            _ => panic!(\"tried to get index of non-standard crate {:?}\", self),\n-        }\n-    }\n-\n     pub fn as_def_id(&self) -> DefId {\n         DefId { krate: *self, index: CRATE_DEF_INDEX }\n     }\n }\n \n impl fmt::Display for CrateNum {\n     fn fmt(&self, f: &mut fmt::Formatter<'_>) -> fmt::Result {\n-        match self {\n-            CrateNum::Index(id) => fmt::Display::fmt(&id.private, f),\n-            CrateNum::ReservedForIncrCompCache => write!(f, \"crate for decoding incr comp cache\"),\n-        }\n+        fmt::Display::fmt(&self.private, f)\n     }\n }\n \n@@ -96,15 +49,6 @@ impl<D: Decoder> Decodable<D> for CrateNum {\n     }\n }\n \n-impl ::std::fmt::Debug for CrateNum {\n-    fn fmt(&self, fmt: &mut ::std::fmt::Formatter<'_>) -> ::std::fmt::Result {\n-        match self {\n-            CrateNum::Index(id) => write!(fmt, \"crate{}\", id.private),\n-            CrateNum::ReservedForIncrCompCache => write!(fmt, \"crate for decoding incr comp cache\"),\n-        }\n-    }\n-}\n-\n /// A `DefPathHash` is a fixed-size representation of a `DefPath` that is\n /// stable across crate and compilation session boundaries. It consists of two\n /// separate 64-bit hashes. The first uniquely identifies the crate this"}, {"sha": "be0dbf71607f57ee8436e150b123c3f43335a939", "filename": "src/test/run-make-fulldeps/coverage-reports/expected_show_coverage.generics.txt", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/625d5a693e4697bcafdd34fd1a38c281acabb8e9/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.generics.txt", "raw_url": "https://github.com/rust-lang/rust/raw/625d5a693e4697bcafdd34fd1a38c281acabb8e9/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.generics.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.generics.txt?ref=625d5a693e4697bcafdd34fd1a38c281acabb8e9", "patch": "@@ -11,15 +11,15 @@\n    11|      3|        self.strength = new_strength;\n    12|      3|    }\n   ------------------\n-  | <generics::Firework<f64>>::set_strength:\n-  |   10|      2|    fn set_strength(&mut self, new_strength: T) {\n-  |   11|      2|        self.strength = new_strength;\n-  |   12|      2|    }\n-  ------------------\n   | <generics::Firework<i32>>::set_strength:\n   |   10|      1|    fn set_strength(&mut self, new_strength: T) {\n   |   11|      1|        self.strength = new_strength;\n   |   12|      1|    }\n+  ------------------\n+  | <generics::Firework<f64>>::set_strength:\n+  |   10|      2|    fn set_strength(&mut self, new_strength: T) {\n+  |   11|      2|        self.strength = new_strength;\n+  |   12|      2|    }\n   ------------------\n    13|       |}\n    14|       |"}]}