{"sha": "e78221bc58a050e8651f5be591561e7adf89c371", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU3ODIyMWJjNThhMDUwZTg2NTFmNWJlNTkxNTYxZTdhZGY4OWMzNzE=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-05-11T23:01:51Z"}, "committer": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-05-11T23:01:51Z"}, "message": "Remove delimiters from proc macro input", "tree": {"sha": "191386e03f2975d927a093cc54bab52f37a7cbdf", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/191386e03f2975d927a093cc54bab52f37a7cbdf"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e78221bc58a050e8651f5be591561e7adf89c371", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e78221bc58a050e8651f5be591561e7adf89c371", "html_url": "https://github.com/rust-lang/rust/commit/e78221bc58a050e8651f5be591561e7adf89c371", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e78221bc58a050e8651f5be591561e7adf89c371/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c868414dcd50bbfe433cc93f8319d41e6742542c", "url": "https://api.github.com/repos/rust-lang/rust/commits/c868414dcd50bbfe433cc93f8319d41e6742542c", "html_url": "https://github.com/rust-lang/rust/commit/c868414dcd50bbfe433cc93f8319d41e6742542c"}], "stats": {"total": 15, "additions": 14, "deletions": 1}, "files": [{"sha": "c43d382adf65113bc012c592a217d790cae002bd", "filename": "crates/hir_expand/src/db.rs", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/e78221bc58a050e8651f5be591561e7adf89c371/crates%2Fhir_expand%2Fsrc%2Fdb.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e78221bc58a050e8651f5be591561e7adf89c371/crates%2Fhir_expand%2Fsrc%2Fdb.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_expand%2Fsrc%2Fdb.rs?ref=e78221bc58a050e8651f5be591561e7adf89c371", "patch": "@@ -267,7 +267,16 @@ fn parse_macro_expansion(\n \n fn macro_arg(db: &dyn AstDatabase, id: MacroCallId) -> Option<Arc<(tt::Subtree, mbe::TokenMap)>> {\n     let arg = db.macro_arg_text(id)?;\n-    let (tt, tmap) = mbe::syntax_node_to_token_tree(&SyntaxNode::new_root(arg));\n+    let (mut tt, tmap) = mbe::syntax_node_to_token_tree(&SyntaxNode::new_root(arg));\n+\n+    if let MacroCallId::LazyMacro(id) = id {\n+        let loc: MacroCallLoc = db.lookup_intern_macro(id);\n+        if loc.def.is_proc_macro() {\n+            // proc macros expect their inputs without parentheses, MBEs expect it with them included\n+            tt.delimiter = None;\n+        }\n+    }\n+\n     Some(Arc::new((tt, tmap)))\n }\n "}, {"sha": "88cb16ca4d13fe36a4a4e211e1f5d77b86b59d09", "filename": "crates/hir_expand/src/lib.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/e78221bc58a050e8651f5be591561e7adf89c371/crates%2Fhir_expand%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e78221bc58a050e8651f5be591561e7adf89c371/crates%2Fhir_expand%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_expand%2Fsrc%2Flib.rs?ref=e78221bc58a050e8651f5be591561e7adf89c371", "patch": "@@ -272,6 +272,10 @@ impl MacroDefId {\n         };\n         Either::Left(*id)\n     }\n+\n+    pub fn is_proc_macro(&self) -> bool {\n+        matches!(self.kind, MacroDefKind::ProcMacro(..))\n+    }\n }\n \n #[derive(Debug, Clone, Copy, PartialEq, Eq, Hash)]"}]}