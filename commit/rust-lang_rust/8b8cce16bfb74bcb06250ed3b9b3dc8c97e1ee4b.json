{"sha": "8b8cce16bfb74bcb06250ed3b9b3dc8c97e1ee4b", "node_id": "C_kwDOAAsO6NoAKDhiOGNjZTE2YmZiNzRiY2IwNjI1MGVkM2I5YjNkYzhjOTdlMWVlNGI", "commit": {"author": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2023-01-09T04:43:18Z"}, "committer": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2023-01-11T21:39:07Z"}, "message": "Use the root trait predicate to determine whether to remove references\n\nFix #84837.", "tree": {"sha": "b879547c6d142a13f30692b23512c2a1ca79616b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b879547c6d142a13f30692b23512c2a1ca79616b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8b8cce16bfb74bcb06250ed3b9b3dc8c97e1ee4b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8b8cce16bfb74bcb06250ed3b9b3dc8c97e1ee4b", "html_url": "https://github.com/rust-lang/rust/commit/8b8cce16bfb74bcb06250ed3b9b3dc8c97e1ee4b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8b8cce16bfb74bcb06250ed3b9b3dc8c97e1ee4b/comments", "author": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "committer": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bb7211702e17dd2d10a6d04962d37331ea032010", "url": "https://api.github.com/repos/rust-lang/rust/commits/bb7211702e17dd2d10a6d04962d37331ea032010", "html_url": "https://github.com/rust-lang/rust/commit/bb7211702e17dd2d10a6d04962d37331ea032010"}], "stats": {"total": 77, "additions": 76, "deletions": 1}, "files": [{"sha": "678e7b87829895eb1637be84dc517c2e672fb363", "filename": "compiler/rustc_trait_selection/src/traits/error_reporting/suggestions.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/8b8cce16bfb74bcb06250ed3b9b3dc8c97e1ee4b/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8b8cce16bfb74bcb06250ed3b9b3dc8c97e1ee4b/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs?ref=8b8cce16bfb74bcb06250ed3b9b3dc8c97e1ee4b", "patch": "@@ -1359,6 +1359,14 @@ impl<'tcx> TypeErrCtxtExt<'tcx> for TypeErrCtxt<'_, 'tcx> {\n         trait_pred: ty::PolyTraitPredicate<'tcx>,\n     ) -> bool {\n         let mut span = obligation.cause.span;\n+        let mut trait_pred = trait_pred;\n+        let mut code = obligation.cause.code();\n+        while let Some((c, Some(parent_trait_pred))) = code.parent() {\n+            // We want the root obligation, in order to detect properly handle\n+            // `for _ in &mut &mut vec![] {}`.\n+            code = c;\n+            trait_pred = parent_trait_pred;\n+        }\n         while span.desugaring_kind().is_some() {\n             // Remove all the hir desugaring contexts while maintaining the macro contexts.\n             span.remove_mark();"}, {"sha": "32256ed69a76915cc5f5a5778762364dd2b1ad89", "filename": "tests/ui/auto-traits/typeck-default-trait-impl-precedence.stderr", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/8b8cce16bfb74bcb06250ed3b9b3dc8c97e1ee4b/tests%2Fui%2Fauto-traits%2Ftypeck-default-trait-impl-precedence.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/8b8cce16bfb74bcb06250ed3b9b3dc8c97e1ee4b/tests%2Fui%2Fauto-traits%2Ftypeck-default-trait-impl-precedence.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fauto-traits%2Ftypeck-default-trait-impl-precedence.stderr?ref=8b8cce16bfb74bcb06250ed3b9b3dc8c97e1ee4b", "patch": "@@ -4,7 +4,6 @@ error[E0277]: the trait bound `u32: Signed` is not satisfied\n LL |     is_defaulted::<&'static u32>();\n    |                    ^^^^^^^^^^^^ the trait `Signed` is not implemented for `u32`\n    |\n-   = help: the trait `Signed` is implemented for `i32`\n note: required for `&'static u32` to implement `Defaulted`\n   --> $DIR/typeck-default-trait-impl-precedence.rs:10:19\n    |\n@@ -15,6 +14,11 @@ note: required by a bound in `is_defaulted`\n    |\n LL | fn is_defaulted<T:Defaulted>() { }\n    |                   ^^^^^^^^^ required by this bound in `is_defaulted`\n+help: consider removing the leading `&`-reference\n+   |\n+LL -     is_defaulted::<&'static u32>();\n+LL +     is_defaulted::<u32>();\n+   |\n \n error: aborting due to previous error\n "}, {"sha": "9428c125651ec2f718e315ee34965df117a27707", "filename": "tests/ui/not-panic/not-panic-safe-4.stderr", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/8b8cce16bfb74bcb06250ed3b9b3dc8c97e1ee4b/tests%2Fui%2Fnot-panic%2Fnot-panic-safe-4.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/8b8cce16bfb74bcb06250ed3b9b3dc8c97e1ee4b/tests%2Fui%2Fnot-panic%2Fnot-panic-safe-4.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fnot-panic%2Fnot-panic-safe-4.stderr?ref=8b8cce16bfb74bcb06250ed3b9b3dc8c97e1ee4b", "patch": "@@ -12,6 +12,11 @@ note: required by a bound in `assert`\n    |\n LL | fn assert<T: UnwindSafe + ?Sized>() {}\n    |              ^^^^^^^^^^ required by this bound in `assert`\n+help: consider removing the leading `&`-reference\n+   |\n+LL -     assert::<&RefCell<i32>>();\n+LL +     assert::<RefCell<i32>>();\n+   |\n \n error[E0277]: the type `UnsafeCell<isize>` may contain interior mutability and a reference may not be safely transferrable across a catch_unwind boundary\n   --> $DIR/not-panic-safe-4.rs:9:14\n@@ -28,6 +33,11 @@ note: required by a bound in `assert`\n    |\n LL | fn assert<T: UnwindSafe + ?Sized>() {}\n    |              ^^^^^^^^^^ required by this bound in `assert`\n+help: consider removing the leading `&`-reference\n+   |\n+LL -     assert::<&RefCell<i32>>();\n+LL +     assert::<RefCell<i32>>();\n+   |\n \n error: aborting due to 2 previous errors\n "}, {"sha": "9f59f9c199a331b8a8a212dcf16fe6669f3d5a7c", "filename": "tests/ui/suggestions/suggest-remove-refs-5.fixed", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/8b8cce16bfb74bcb06250ed3b9b3dc8c97e1ee4b/tests%2Fui%2Fsuggestions%2Fsuggest-remove-refs-5.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/8b8cce16bfb74bcb06250ed3b9b3dc8c97e1ee4b/tests%2Fui%2Fsuggestions%2Fsuggest-remove-refs-5.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fsuggestions%2Fsuggest-remove-refs-5.fixed?ref=8b8cce16bfb74bcb06250ed3b9b3dc8c97e1ee4b", "patch": "@@ -0,0 +1,8 @@\n+// run-rustfix\n+fn main() {\n+    let v = &mut Vec::<i32>::new();\n+    for _ in v {} //~ ERROR E0277\n+\n+    let v = &mut [1u8];\n+    for _ in v {} //~ ERROR E0277\n+}"}, {"sha": "d56aa0c9ca47965601cdd0e6eb727e98aad02e18", "filename": "tests/ui/suggestions/suggest-remove-refs-5.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/8b8cce16bfb74bcb06250ed3b9b3dc8c97e1ee4b/tests%2Fui%2Fsuggestions%2Fsuggest-remove-refs-5.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8b8cce16bfb74bcb06250ed3b9b3dc8c97e1ee4b/tests%2Fui%2Fsuggestions%2Fsuggest-remove-refs-5.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fsuggestions%2Fsuggest-remove-refs-5.rs?ref=8b8cce16bfb74bcb06250ed3b9b3dc8c97e1ee4b", "patch": "@@ -0,0 +1,8 @@\n+// run-rustfix\n+fn main() {\n+    let v = &mut &mut Vec::<i32>::new();\n+    for _ in &mut &mut v {} //~ ERROR E0277\n+\n+    let v = &mut &mut [1u8];\n+    for _ in &mut v {} //~ ERROR E0277\n+}"}, {"sha": "7de84d6122b58f094ec2f72e8744ce7d4f6192b3", "filename": "tests/ui/suggestions/suggest-remove-refs-5.stderr", "status": "added", "additions": 37, "deletions": 0, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/8b8cce16bfb74bcb06250ed3b9b3dc8c97e1ee4b/tests%2Fui%2Fsuggestions%2Fsuggest-remove-refs-5.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/8b8cce16bfb74bcb06250ed3b9b3dc8c97e1ee4b/tests%2Fui%2Fsuggestions%2Fsuggest-remove-refs-5.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fsuggestions%2Fsuggest-remove-refs-5.stderr?ref=8b8cce16bfb74bcb06250ed3b9b3dc8c97e1ee4b", "patch": "@@ -0,0 +1,37 @@\n+error[E0277]: `Vec<i32>` is not an iterator\n+  --> $DIR/suggest-remove-refs-5.rs:4:14\n+   |\n+LL |     for _ in &mut &mut v {}\n+   |              ^^^^^^^^^^^ `Vec<i32>` is not an iterator; try calling `.into_iter()` or `.iter()`\n+   |\n+   = help: the trait `Iterator` is not implemented for `Vec<i32>`\n+   = note: required for `&mut Vec<i32>` to implement `Iterator`\n+   = note: 3 redundant requirements hidden\n+   = note: required for `&mut &mut &mut &mut Vec<i32>` to implement `Iterator`\n+   = note: required for `&mut &mut &mut &mut Vec<i32>` to implement `IntoIterator`\n+help: consider removing 3 leading `&`-references\n+   |\n+LL ~     let v = &mut Vec::<i32>::new();\n+LL ~     for _ in v {}\n+   |\n+\n+error[E0277]: `[u8; 1]` is not an iterator\n+  --> $DIR/suggest-remove-refs-5.rs:7:14\n+   |\n+LL |     for _ in &mut v {}\n+   |              ^^^^^^ `[u8; 1]` is not an iterator; try calling `.into_iter()` or `.iter()`\n+   |\n+   = help: the trait `Iterator` is not implemented for `[u8; 1]`\n+   = note: required for `&mut [u8; 1]` to implement `Iterator`\n+   = note: 2 redundant requirements hidden\n+   = note: required for `&mut &mut &mut [u8; 1]` to implement `Iterator`\n+   = note: required for `&mut &mut &mut [u8; 1]` to implement `IntoIterator`\n+help: consider removing 2 leading `&`-references\n+   |\n+LL ~     let v = &mut [1u8];\n+LL ~     for _ in v {}\n+   |\n+\n+error: aborting due to 2 previous errors\n+\n+For more information about this error, try `rustc --explain E0277`."}]}