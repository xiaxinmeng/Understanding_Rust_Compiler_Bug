{"sha": "79eedef984cb0a4e703e6c2398319d4e818f41e9", "node_id": "C_kwDOAAsO6NoAKDc5ZWVkZWY5ODRjYjBhNGU3MDNlNmMyMzk4MzE5ZDRlODE4ZjQxZTk", "commit": {"author": {"name": "BlackHoleFox", "email": "blackholefoxdev@gmail.com", "date": "2022-10-23T20:23:04Z"}, "committer": {"name": "BlackHoleFox", "email": "blackholefoxdev@gmail.com", "date": "2022-10-23T20:44:58Z"}, "message": "Fix x86_64-apple-ios target to use the correct target_abi", "tree": {"sha": "a30da1f564b864392d30737c5a653a2f428d66fd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a30da1f564b864392d30737c5a653a2f428d66fd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/79eedef984cb0a4e703e6c2398319d4e818f41e9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/79eedef984cb0a4e703e6c2398319d4e818f41e9", "html_url": "https://github.com/rust-lang/rust/commit/79eedef984cb0a4e703e6c2398319d4e818f41e9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/79eedef984cb0a4e703e6c2398319d4e818f41e9/comments", "author": {"login": "BlackHoleFox", "id": 20936452, "node_id": "MDQ6VXNlcjIwOTM2NDUy", "avatar_url": "https://avatars.githubusercontent.com/u/20936452?v=4", "gravatar_id": "", "url": "https://api.github.com/users/BlackHoleFox", "html_url": "https://github.com/BlackHoleFox", "followers_url": "https://api.github.com/users/BlackHoleFox/followers", "following_url": "https://api.github.com/users/BlackHoleFox/following{/other_user}", "gists_url": "https://api.github.com/users/BlackHoleFox/gists{/gist_id}", "starred_url": "https://api.github.com/users/BlackHoleFox/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/BlackHoleFox/subscriptions", "organizations_url": "https://api.github.com/users/BlackHoleFox/orgs", "repos_url": "https://api.github.com/users/BlackHoleFox/repos", "events_url": "https://api.github.com/users/BlackHoleFox/events{/privacy}", "received_events_url": "https://api.github.com/users/BlackHoleFox/received_events", "type": "User", "site_admin": false}, "committer": {"login": "BlackHoleFox", "id": 20936452, "node_id": "MDQ6VXNlcjIwOTM2NDUy", "avatar_url": "https://avatars.githubusercontent.com/u/20936452?v=4", "gravatar_id": "", "url": "https://api.github.com/users/BlackHoleFox", "html_url": "https://github.com/BlackHoleFox", "followers_url": "https://api.github.com/users/BlackHoleFox/followers", "following_url": "https://api.github.com/users/BlackHoleFox/following{/other_user}", "gists_url": "https://api.github.com/users/BlackHoleFox/gists{/gist_id}", "starred_url": "https://api.github.com/users/BlackHoleFox/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/BlackHoleFox/subscriptions", "organizations_url": "https://api.github.com/users/BlackHoleFox/orgs", "repos_url": "https://api.github.com/users/BlackHoleFox/repos", "events_url": "https://api.github.com/users/BlackHoleFox/events{/privacy}", "received_events_url": "https://api.github.com/users/BlackHoleFox/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1ca6777c014813e3bdb98d155562fc3d111d86dd", "url": "https://api.github.com/repos/rust-lang/rust/commits/1ca6777c014813e3bdb98d155562fc3d111d86dd", "html_url": "https://github.com/rust-lang/rust/commit/1ca6777c014813e3bdb98d155562fc3d111d86dd"}], "stats": {"total": 37, "additions": 30, "deletions": 7}, "files": [{"sha": "23bfb95c1985b9b48b268ff4b942b13bef50af25", "filename": "compiler/rustc_target/src/spec/apple/tests.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/79eedef984cb0a4e703e6c2398319d4e818f41e9/compiler%2Frustc_target%2Fsrc%2Fspec%2Fapple%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/79eedef984cb0a4e703e6c2398319d4e818f41e9/compiler%2Frustc_target%2Fsrc%2Fspec%2Fapple%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fapple%2Ftests.rs?ref=79eedef984cb0a4e703e6c2398319d4e818f41e9", "patch": "@@ -0,0 +1,15 @@\n+use crate::spec::{aarch64_apple_ios_sim, aarch64_apple_watchos_sim, x86_64_apple_ios};\n+\n+#[test]\n+fn simulator_targets_set_abi() {\n+    let all_sim_targets = [\n+        x86_64_apple_ios::target(),\n+        aarch64_apple_ios_sim::target(),\n+        aarch64_apple_watchos_sim::target(),\n+        // TODO: x86_64-apple-tvos and x86_64-apple-watchos-sim\n+    ];\n+\n+    for target in all_sim_targets {\n+        assert_eq!(target.abi, \"sim\")\n+    }\n+}"}, {"sha": "f920ce8444f7224dc07a231251c70d1d855065bd", "filename": "compiler/rustc_target/src/spec/apple_sdk_base.rs", "status": "modified", "additions": 14, "deletions": 6, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/79eedef984cb0a4e703e6c2398319d4e818f41e9/compiler%2Frustc_target%2Fsrc%2Fspec%2Fapple_sdk_base.rs", "raw_url": "https://github.com/rust-lang/rust/raw/79eedef984cb0a4e703e6c2398319d4e818f41e9/compiler%2Frustc_target%2Fsrc%2Fspec%2Fapple_sdk_base.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fapple_sdk_base.rs?ref=79eedef984cb0a4e703e6c2398319d4e818f41e9", "patch": "@@ -1,6 +1,10 @@\n use crate::spec::{cvs, TargetOptions};\n use std::borrow::Cow;\n \n+#[cfg(test)]\n+#[path = \"apple/tests.rs\"]\n+mod tests;\n+\n use Arch::*;\n #[allow(non_camel_case_types)]\n #[derive(Copy, Clone)]\n@@ -12,6 +16,7 @@ pub enum Arch {\n     Arm64_32,\n     I386,\n     X86_64,\n+    X86_64_sim,\n     X86_64_macabi,\n     Arm64_macabi,\n     Arm64_sim,\n@@ -25,15 +30,17 @@ fn target_arch_name(arch: Arch) -> &'static str {\n         Arm64 | Arm64_macabi | Arm64_sim => \"arm64\",\n         Arm64_32 => \"arm64_32\",\n         I386 => \"i386\",\n-        X86_64 | X86_64_macabi => \"x86_64\",\n+        X86_64 | X86_64_sim | X86_64_macabi => \"x86_64\",\n     }\n }\n \n fn target_abi(arch: Arch) -> &'static str {\n     match arch {\n         Armv7 | Armv7k | Armv7s | Arm64 | Arm64_32 | I386 | X86_64 => \"\",\n         X86_64_macabi | Arm64_macabi => \"macabi\",\n-        Arm64_sim => \"sim\",\n+        // x86_64-apple-ios is a simulator target, even though it isn't\n+        // declared that way in the target like the other ones...\n+        Arm64_sim | X86_64_sim => \"sim\",\n     }\n }\n \n@@ -45,7 +52,7 @@ fn target_cpu(arch: Arch) -> &'static str {\n         Arm64 => \"apple-a7\",\n         Arm64_32 => \"apple-s4\",\n         I386 => \"yonah\",\n-        X86_64 => \"core2\",\n+        X86_64 | X86_64_sim => \"core2\",\n         X86_64_macabi => \"core2\",\n         Arm64_macabi => \"apple-a12\",\n         Arm64_sim => \"apple-a12\",\n@@ -54,19 +61,20 @@ fn target_cpu(arch: Arch) -> &'static str {\n \n fn link_env_remove(arch: Arch) -> Cow<'static, [Cow<'static, str>]> {\n     match arch {\n-        Armv7 | Armv7k | Armv7s | Arm64 | Arm64_32 | I386 | X86_64 | Arm64_sim => {\n+        Armv7 | Armv7k | Armv7s | Arm64 | Arm64_32 | I386 | X86_64 | X86_64_sim | Arm64_sim => {\n             cvs![\"MACOSX_DEPLOYMENT_TARGET\"]\n         }\n         X86_64_macabi | Arm64_macabi => cvs![\"IPHONEOS_DEPLOYMENT_TARGET\"],\n     }\n }\n \n pub fn opts(os: &'static str, arch: Arch) -> TargetOptions {\n+    let abi = target_abi(arch);\n     TargetOptions {\n-        abi: target_abi(arch).into(),\n+        abi: abi.into(),\n         cpu: target_cpu(arch).into(),\n         link_env_remove: link_env_remove(arch),\n         has_thread_local: false,\n-        ..super::apple_base::opts(os, target_arch_name(arch), target_abi(arch))\n+        ..super::apple_base::opts(os, target_arch_name(arch), abi)\n     }\n }"}, {"sha": "db23f01c233265c17bf20e27627eefc3402f181b", "filename": "compiler/rustc_target/src/spec/x86_64_apple_ios.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/79eedef984cb0a4e703e6c2398319d4e818f41e9/compiler%2Frustc_target%2Fsrc%2Fspec%2Fx86_64_apple_ios.rs", "raw_url": "https://github.com/rust-lang/rust/raw/79eedef984cb0a4e703e6c2398319d4e818f41e9/compiler%2Frustc_target%2Fsrc%2Fspec%2Fx86_64_apple_ios.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_target%2Fsrc%2Fspec%2Fx86_64_apple_ios.rs?ref=79eedef984cb0a4e703e6c2398319d4e818f41e9", "patch": "@@ -2,7 +2,7 @@ use super::apple_sdk_base::{opts, Arch};\n use crate::spec::{StackProbeType, Target, TargetOptions};\n \n pub fn target() -> Target {\n-    let base = opts(\"ios\", Arch::X86_64);\n+    let base = opts(\"ios\", Arch::X86_64_sim);\n     let llvm_target = super::apple_base::ios_sim_llvm_target(\"x86_64\");\n \n     Target {"}]}