{"sha": "db4235c4fd20b18fcda7f331913cfe30a13f216c", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRiNDIzNWM0ZmQyMGIxOGZjZGE3ZjMzMTkxM2NmZTMwYTEzZjIxNmM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-04-06T07:04:20Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-04-06T07:04:20Z"}, "message": "Auto merge of #49293 - memoryleak47:add-compiletest-nll-compare-mode, r=pnkfelix\n\nAdd compiletest `--compare-mode nll` option\n\nBefore implementing the tidy stuff, I'd appreciate if someone reviews the changes so far.\nThis is my first non-trivial pull request, so I could really use some feedback. :)\ncloses #48879.\n\nr? @nikomatsakis", "tree": {"sha": "8d9ec84b55b31a89f7adb3989fb5694534c581ee", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8d9ec84b55b31a89f7adb3989fb5694534c581ee"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/db4235c4fd20b18fcda7f331913cfe30a13f216c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/db4235c4fd20b18fcda7f331913cfe30a13f216c", "html_url": "https://github.com/rust-lang/rust/commit/db4235c4fd20b18fcda7f331913cfe30a13f216c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/db4235c4fd20b18fcda7f331913cfe30a13f216c/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "48fa6f9631868b07309b02f479e2ec523bb58c2b", "url": "https://api.github.com/repos/rust-lang/rust/commits/48fa6f9631868b07309b02f479e2ec523bb58c2b", "html_url": "https://github.com/rust-lang/rust/commit/48fa6f9631868b07309b02f479e2ec523bb58c2b"}, {"sha": "03e1509f577c2a474ade1d286210fbf1142d4103", "url": "https://api.github.com/repos/rust-lang/rust/commits/03e1509f577c2a474ade1d286210fbf1142d4103", "html_url": "https://github.com/rust-lang/rust/commit/03e1509f577c2a474ade1d286210fbf1142d4103"}], "stats": {"total": 104, "additions": 82, "deletions": 22}, "files": [{"sha": "41fc67a66f47df828fd6f380c9c8e8607a78f57e", "filename": "src/tools/compiletest/src/common.rs", "status": "modified", "additions": 35, "deletions": 5, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/db4235c4fd20b18fcda7f331913cfe30a13f216c/src%2Ftools%2Fcompiletest%2Fsrc%2Fcommon.rs", "raw_url": "https://github.com/rust-lang/rust/raw/db4235c4fd20b18fcda7f331913cfe30a13f216c/src%2Ftools%2Fcompiletest%2Fsrc%2Fcommon.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fcommon.rs?ref=db4235c4fd20b18fcda7f331913cfe30a13f216c", "patch": "@@ -95,6 +95,26 @@ impl fmt::Display for Mode {\n     }\n }\n \n+#[derive(Clone)]\n+pub enum CompareMode {\n+    Nll\n+}\n+\n+impl CompareMode {\n+    fn to_str(&self) -> &'static str {\n+        match *self {\n+            CompareMode::Nll => \"nll\"\n+        }\n+    }\n+\n+    pub fn parse(s: String) -> CompareMode {\n+        match s.as_str() {\n+            \"nll\" => CompareMode::Nll,\n+            x => panic!(\"unknown --compare-mode option: {}\", x),\n+        }\n+    }\n+}\n+\n #[derive(Clone)]\n pub struct Config {\n     /// The library paths required for running the compiler\n@@ -210,6 +230,9 @@ pub struct Config {\n     /// where to find the remote test client process, if we're using it\n     pub remote_test_client: Option<PathBuf>,\n \n+    /// mode describing what file the actual ui output will be compared to\n+    pub compare_mode: Option<CompareMode>,\n+\n     // Configuration for various run-make tests frobbing things like C compilers\n     // or querying about various LLVM component information.\n     pub cc: String,\n@@ -230,12 +253,19 @@ pub struct TestPaths {\n }\n \n /// Used by `ui` tests to generate things like `foo.stderr` from `foo.rs`.\n-pub fn expected_output_path(testpaths: &TestPaths, revision: Option<&str>, kind: &str) -> PathBuf {\n+pub fn expected_output_path(testpaths: &TestPaths,\n+                            revision: Option<&str>,\n+                            compare_mode: &Option<CompareMode>,\n+                            kind: &str) -> PathBuf {\n+\n     assert!(UI_EXTENSIONS.contains(&kind));\n-    let extension = match revision {\n-        Some(r) => format!(\"{}.{}\", r, kind),\n-        None => kind.to_string(),\n-    };\n+    let mut parts = Vec::new();\n+\n+    if let Some(x) = revision { parts.push(x); }\n+    if let Some(ref x) = *compare_mode { parts.push(x.to_str()); }\n+    parts.push(kind);\n+\n+    let extension = parts.join(\".\");\n     testpaths.file.with_extension(extension)\n }\n "}, {"sha": "80cab96434ba784fa2679228d56a0c6d390b54e0", "filename": "src/tools/compiletest/src/main.rs", "status": "modified", "additions": 15, "deletions": 3, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/db4235c4fd20b18fcda7f331913cfe30a13f216c/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/db4235c4fd20b18fcda7f331913cfe30a13f216c/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs?ref=db4235c4fd20b18fcda7f331913cfe30a13f216c", "patch": "@@ -38,6 +38,7 @@ use getopts::Options;\n use common::{Config, TestPaths};\n use common::{DebugInfoGdb, DebugInfoLldb, Mode, Pretty};\n use common::{expected_output_path, UI_EXTENSIONS};\n+use common::CompareMode;\n use test::ColorConfig;\n use util::logv;\n \n@@ -227,6 +228,12 @@ pub fn parse_config(args: Vec<String>) -> Config {\n             \"path to the remote test client\",\n             \"PATH\",\n         )\n+        .optopt(\n+            \"\",\n+            \"compare-mode\",\n+            \"mode describing what file the actual ui output will be compared to\",\n+            \"COMPARE MODE\"\n+        )\n         .optflag(\"h\", \"help\", \"show this message\");\n \n     let (argv0, args_) = args.split_first().unwrap();\n@@ -320,6 +327,7 @@ pub fn parse_config(args: Vec<String>) -> Config {\n         quiet: matches.opt_present(\"quiet\"),\n         color,\n         remote_test_client: matches.opt_str(\"remote-test-client\").map(PathBuf::from),\n+        compare_mode: matches.opt_str(\"compare-mode\").map(CompareMode::parse),\n \n         cc: matches.opt_str(\"cc\").unwrap(),\n         cxx: matches.opt_str(\"cxx\").unwrap(),\n@@ -615,7 +623,8 @@ pub fn make_test(config: &Config, testpaths: &TestPaths) -> test::TestDescAndFn\n     };\n \n     // Debugging emscripten code doesn't make sense today\n-    let ignore = early_props.ignore || !up_to_date(config, testpaths, &early_props)\n+    let ignore = early_props.ignore\n+        || (!up_to_date(config, testpaths, &early_props) && config.compare_mode.is_none())\n         || (config.mode == DebugInfoGdb || config.mode == DebugInfoLldb)\n             && config.target.contains(\"emscripten\");\n \n@@ -688,12 +697,15 @@ fn up_to_date(config: &Config, testpaths: &TestPaths, props: &EarlyProps) -> boo\n     // UI test files.\n     for extension in UI_EXTENSIONS {\n         for revision in &props.revisions {\n-            let path = &expected_output_path(testpaths, Some(revision), extension);\n+            let path = &expected_output_path(testpaths,\n+                                             Some(revision),\n+                                             &config.compare_mode,\n+                                             extension);\n             inputs.push(mtime(path));\n         }\n \n         if props.revisions.is_empty() {\n-            let path = &expected_output_path(testpaths, None, extension);\n+            let path = &expected_output_path(testpaths, None, &config.compare_mode, extension);\n             inputs.push(mtime(path));\n         }\n     }"}, {"sha": "0081c0ae69d6762dfa95971de225c82989dd6184", "filename": "src/tools/compiletest/src/runtest.rs", "status": "modified", "additions": 32, "deletions": 14, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/db4235c4fd20b18fcda7f331913cfe30a13f216c/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/db4235c4fd20b18fcda7f331913cfe30a13f216c/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs?ref=db4235c4fd20b18fcda7f331913cfe30a13f216c", "patch": "@@ -13,6 +13,7 @@ use common::{CompileFail, ParseFail, Pretty, RunFail, RunPass, RunPassValgrind};\n use common::{Codegen, CodegenUnits, DebugInfoGdb, DebugInfoLldb, Rustdoc};\n use common::{Incremental, MirOpt, RunMake, Ui};\n use common::{expected_output_path, UI_STDERR, UI_STDOUT};\n+use common::CompareMode;\n use diff;\n use errors::{self, Error, ErrorKind};\n use filetime::FileTime;\n@@ -1683,6 +1684,13 @@ impl<'test> TestCx<'test> {\n             }\n         }\n \n+        match self.config.compare_mode {\n+            Some(CompareMode::Nll) => {\n+                rustc.args(&[\"-Znll\", \"-Zborrowck=mir\", \"-Ztwo-phase-borrows\"]);\n+            },\n+            None => {},\n+        }\n+\n         if self.props.force_host {\n             rustc.args(self.split_maybe_args(&self.config.host_rustcflags));\n         } else {\n@@ -2505,11 +2513,8 @@ impl<'test> TestCx<'test> {\n         let proc_res = self.compile_test();\n         self.check_if_test_should_compile(&proc_res);\n \n-        let expected_stderr_path = self.expected_output_path(UI_STDERR);\n-        let expected_stderr = self.load_expected_output(&expected_stderr_path);\n-\n-        let expected_stdout_path = self.expected_output_path(UI_STDOUT);\n-        let expected_stdout = self.load_expected_output(&expected_stdout_path);\n+        let expected_stderr = self.load_expected_output(UI_STDERR);\n+        let expected_stdout = self.load_expected_output(UI_STDOUT);\n \n         let normalized_stdout =\n             self.normalize_output(&proc_res.stdout, &self.props.normalize_stdout);\n@@ -2552,7 +2557,7 @@ impl<'test> TestCx<'test> {\n                 self.fatal_proc_rec(\"test run failed!\", &proc_res);\n             }\n         }\n-        if !explicit {\n+        if !explicit && self.config.compare_mode.is_none() {\n             if !expected_errors.is_empty() || !proc_res.status.success() {\n                 // \"// error-pattern\" comments\n                 self.check_expected_errors(expected_errors, &proc_res);\n@@ -2795,19 +2800,32 @@ impl<'test> TestCx<'test> {\n         normalized\n     }\n \n-    fn expected_output_path(&self, kind: &str) -> PathBuf {\n-        expected_output_path(&self.testpaths, self.revision, kind)\n-    }\n+    fn load_expected_output(&self, kind: &str) -> String {\n+        let mut path = expected_output_path(&self.testpaths,\n+                                            self.revision,\n+                                            &self.config.compare_mode,\n+                                            kind);\n \n-    fn load_expected_output(&self, path: &Path) -> String {\n-        if !path.exists() {\n-            return String::new();\n+        if !path.exists() && self.config.compare_mode.is_some() {\n+            // fallback!\n+            path = expected_output_path(&self.testpaths, self.revision, &None, kind);\n         }\n \n+        if path.exists() {\n+            match self.load_expected_output_from_path(&path) {\n+                Ok(x) => x,\n+                Err(x) => self.fatal(&x),\n+            }\n+        } else {\n+            String::new()\n+        }\n+    }\n+\n+    fn load_expected_output_from_path(&self, path: &Path) -> Result<String, String> {\n         let mut result = String::new();\n         match File::open(path).and_then(|mut f| f.read_to_string(&mut result)) {\n-            Ok(_) => result,\n-            Err(e) => self.fatal(&format!(\n+            Ok(_) => Ok(result),\n+            Err(e) => Err(format!(\n                 \"failed to load expected output from `{}`: {}\",\n                 path.display(),\n                 e"}]}