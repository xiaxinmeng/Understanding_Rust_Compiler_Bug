{"sha": "db1451c7ad08e77a17c59f6755f234ea507ead92", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRiMTQ1MWM3YWQwOGU3N2ExN2M1OWY2NzU1ZjIzNGVhNTA3ZWFkOTI=", "commit": {"author": {"name": "ThePuzzlemaker", "email": "tpzker@thepuzzlemaker.info", "date": "2020-12-20T07:34:33Z"}, "committer": {"name": "ThePuzzlemaker", "email": "tpzker@thepuzzlemaker.info", "date": "2020-12-24T18:46:17Z"}, "message": "rustdoc: Highlight edition-specific keywords correctly in code blocks, accounting for code block edition modifiers\n\nThis is a squash of these commits:\n- Highlight edition-specific keywords correctly in code blocks,\naccounting for code block edition modifiers\n- Fix unit tests\n- Revert changes to rustc_span::symbol to prepare for merge of #80272\n- Use new Symbol::is_reserved API from #80272\n- Remove unused import added by accident when merging", "tree": {"sha": "f29bd05bc6d17caf689207f4f2ffa343ed2c6b22", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f29bd05bc6d17caf689207f4f2ffa343ed2c6b22"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/db1451c7ad08e77a17c59f6755f234ea507ead92", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQGzBAABCAAdFiEEcJXCCpIkPbZRdwewlozZ1xyfu2wFAl/k4goACgkQlozZ1xyf\nu2x7Vgv+LUFQyJQOP2UOfuTN6voem5PHTo96PEmBal9NmtNCj59QnANhTaONWT69\nlnDLb+qNZ5i+PCb7l58ftNXWH9LAvzIRZJHkyEdK4cFZt4R7lWkw9oycuD0FeTeM\nEK9qvY5RN+v59yIO+yEj++s/wlpDKA15pS/ZUQsQcye/q91ST1h7iGnKs5UjMEMt\nKe0m6ITVe6HEAfchmCUDxKWwvFkl9G40bFWZJVk/Z2DYfJ7S2BAXFXMzWtE5qKxk\ns1uiYrD9o+zi3H/e6BhJ0QYTAafI2XGs963OGCe2dfWK2aI4kpu04xkIf1P9j6fD\nMnp89KNLSZzIhPDh16XNWdDbby0bwuHcP3B0Gul5cimmxPqklT0U8DWhYbLE0eS5\nyCaWTTOV2ULUJt8BQee+mdtQVtALMi1np25r9x1zHljwSIYfNSppMIBtlA+Agdsi\nE86AKSn+b/G7BLTm7b8iD0lpzz6V3wU0T6DSTpwyqwvgur3w4cmAPqXF1DFL2SL7\nJVMc/bVN\n=UbX7\n-----END PGP SIGNATURE-----", "payload": "tree f29bd05bc6d17caf689207f4f2ffa343ed2c6b22\nparent b2516121e2f908136ff8351fddd54265a7ba7227\nauthor ThePuzzlemaker <tpzker@thepuzzlemaker.info> 1608449673 -0600\ncommitter ThePuzzlemaker <tpzker@thepuzzlemaker.info> 1608835577 -0600\n\nrustdoc: Highlight edition-specific keywords correctly in code blocks, accounting for code block edition modifiers\n\nThis is a squash of these commits:\n- Highlight edition-specific keywords correctly in code blocks,\naccounting for code block edition modifiers\n- Fix unit tests\n- Revert changes to rustc_span::symbol to prepare for merge of #80272\n- Use new Symbol::is_reserved API from #80272\n- Remove unused import added by accident when merging\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/db1451c7ad08e77a17c59f6755f234ea507ead92", "html_url": "https://github.com/rust-lang/rust/commit/db1451c7ad08e77a17c59f6755f234ea507ead92", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/db1451c7ad08e77a17c59f6755f234ea507ead92/comments", "author": {"login": "ThePuzzlemaker", "id": 12666617, "node_id": "MDQ6VXNlcjEyNjY2NjE3", "avatar_url": "https://avatars.githubusercontent.com/u/12666617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ThePuzzlemaker", "html_url": "https://github.com/ThePuzzlemaker", "followers_url": "https://api.github.com/users/ThePuzzlemaker/followers", "following_url": "https://api.github.com/users/ThePuzzlemaker/following{/other_user}", "gists_url": "https://api.github.com/users/ThePuzzlemaker/gists{/gist_id}", "starred_url": "https://api.github.com/users/ThePuzzlemaker/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ThePuzzlemaker/subscriptions", "organizations_url": "https://api.github.com/users/ThePuzzlemaker/orgs", "repos_url": "https://api.github.com/users/ThePuzzlemaker/repos", "events_url": "https://api.github.com/users/ThePuzzlemaker/events{/privacy}", "received_events_url": "https://api.github.com/users/ThePuzzlemaker/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ThePuzzlemaker", "id": 12666617, "node_id": "MDQ6VXNlcjEyNjY2NjE3", "avatar_url": "https://avatars.githubusercontent.com/u/12666617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ThePuzzlemaker", "html_url": "https://github.com/ThePuzzlemaker", "followers_url": "https://api.github.com/users/ThePuzzlemaker/followers", "following_url": "https://api.github.com/users/ThePuzzlemaker/following{/other_user}", "gists_url": "https://api.github.com/users/ThePuzzlemaker/gists{/gist_id}", "starred_url": "https://api.github.com/users/ThePuzzlemaker/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ThePuzzlemaker/subscriptions", "organizations_url": "https://api.github.com/users/ThePuzzlemaker/orgs", "repos_url": "https://api.github.com/users/ThePuzzlemaker/repos", "events_url": "https://api.github.com/users/ThePuzzlemaker/events{/privacy}", "received_events_url": "https://api.github.com/users/ThePuzzlemaker/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b2516121e2f908136ff8351fddd54265a7ba7227", "url": "https://api.github.com/repos/rust-lang/rust/commits/b2516121e2f908136ff8351fddd54265a7ba7227", "html_url": "https://github.com/rust-lang/rust/commit/b2516121e2f908136ff8351fddd54265a7ba7227"}], "stats": {"total": 36, "additions": 24, "deletions": 12}, "files": [{"sha": "d21998bb8cfe5d358016a7b6e930ee0ed6a60aaf", "filename": "src/librustdoc/html/highlight.rs", "status": "modified", "additions": 15, "deletions": 7, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/db1451c7ad08e77a17c59f6755f234ea507ead92/src%2Flibrustdoc%2Fhtml%2Fhighlight.rs", "raw_url": "https://github.com/rust-lang/rust/raw/db1451c7ad08e77a17c59f6755f234ea507ead92/src%2Flibrustdoc%2Fhtml%2Fhighlight.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fhighlight.rs?ref=db1451c7ad08e77a17c59f6755f234ea507ead92", "patch": "@@ -12,7 +12,7 @@ use std::iter::Peekable;\n \n use rustc_lexer::{LiteralKind, TokenKind};\n use rustc_span::edition::Edition;\n-use rustc_span::symbol::Ident;\n+use rustc_span::symbol::Symbol;\n use rustc_span::with_default_session_globals;\n \n /// Highlights `src`, returning the HTML output.\n@@ -21,6 +21,7 @@ crate fn render_with_highlighting(\n     class: Option<&str>,\n     playground_button: Option<&str>,\n     tooltip: Option<(Option<Edition>, &str)>,\n+    edition: Edition,\n ) -> String {\n     debug!(\"highlighting: ================\\n{}\\n==============\", src);\n     let mut out = String::with_capacity(src.len());\n@@ -39,7 +40,7 @@ crate fn render_with_highlighting(\n     }\n \n     write_header(&mut out, class);\n-    write_code(&mut out, &src);\n+    write_code(&mut out, &src, edition);\n     write_footer(&mut out, playground_button);\n \n     out\n@@ -50,10 +51,10 @@ fn write_header(out: &mut String, class: Option<&str>) {\n         .unwrap()\n }\n \n-fn write_code(out: &mut String, src: &str) {\n+fn write_code(out: &mut String, src: &str, edition: Edition) {\n     // This replace allows to fix how the code source with DOS backline characters is displayed.\n     let src = src.replace(\"\\r\\n\", \"\\n\");\n-    Classifier::new(&src).highlight(&mut |highlight| {\n+    Classifier::new(&src, edition).highlight(&mut |highlight| {\n         match highlight {\n             Highlight::Token { text, class } => string(out, Escape(text), class),\n             Highlight::EnterSpan { class } => enter_span(out, class),\n@@ -144,12 +145,19 @@ struct Classifier<'a> {\n     in_attribute: bool,\n     in_macro: bool,\n     in_macro_nonterminal: bool,\n+    edition: Edition,\n }\n \n impl<'a> Classifier<'a> {\n-    fn new(src: &str) -> Classifier<'_> {\n+    fn new(src: &str, edition: Edition) -> Classifier<'_> {\n         let tokens = TokenIter { src }.peekable();\n-        Classifier { tokens, in_attribute: false, in_macro: false, in_macro_nonterminal: false }\n+        Classifier {\n+            tokens,\n+            in_attribute: false,\n+            in_macro: false,\n+            in_macro_nonterminal: false,\n+            edition,\n+        }\n     }\n \n     /// Exhausts the `Classifier` writing the output into `sink`.\n@@ -301,7 +309,7 @@ impl<'a> Classifier<'a> {\n                 \"Option\" | \"Result\" => Class::PreludeTy,\n                 \"Some\" | \"None\" | \"Ok\" | \"Err\" => Class::PreludeVal,\n                 // Keywords are also included in the identifier set.\n-                _ if Ident::from_str(text).is_reserved() => Class::KeyWord,\n+                _ if Symbol::intern(text).is_reserved(|| self.edition) => Class::KeyWord,\n                 _ if self.in_macro_nonterminal => {\n                     self.in_macro_nonterminal = false;\n                     Class::MacroNonTerminal"}, {"sha": "f97c8a7ab71484cf62235cc92b64aa2f514adb92", "filename": "src/librustdoc/html/highlight/tests.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/db1451c7ad08e77a17c59f6755f234ea507ead92/src%2Flibrustdoc%2Fhtml%2Fhighlight%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/db1451c7ad08e77a17c59f6755f234ea507ead92/src%2Flibrustdoc%2Fhtml%2Fhighlight%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fhighlight%2Ftests.rs?ref=db1451c7ad08e77a17c59f6755f234ea507ead92", "patch": "@@ -1,5 +1,6 @@\n use super::write_code;\n use expect_test::expect_file;\n+use rustc_span::edition::Edition;\n \n const STYLE: &str = r#\"\n <style>\n@@ -18,7 +19,7 @@ fn test_html_highlighting() {\n     let src = include_str!(\"fixtures/sample.rs\");\n     let html = {\n         let mut out = String::new();\n-        write_code(&mut out, src);\n+        write_code(&mut out, src, Edition::Edition2018);\n         format!(\"{}<pre><code>{}</code></pre>\\n\", STYLE, out)\n     };\n     expect_file![\"fixtures/sample.html\"].assert_eq(&html);\n@@ -30,6 +31,6 @@ fn test_dos_backline() {\n     println!(\\\"foo\\\");\\r\\n\\\n }\\r\\n\";\n     let mut html = String::new();\n-    write_code(&mut html, src);\n+    write_code(&mut html, src, Edition::Edition2018);\n     expect_file![\"fixtures/dos_line.html\"].assert_eq(&html);\n }"}, {"sha": "75f7f1f25c88bbac9755f0725898e2f201071f72", "filename": "src/librustdoc/html/markdown.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/db1451c7ad08e77a17c59f6755f234ea507ead92/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs", "raw_url": "https://github.com/rust-lang/rust/raw/db1451c7ad08e77a17c59f6755f234ea507ead92/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs?ref=db1451c7ad08e77a17c59f6755f234ea507ead92", "patch": "@@ -303,6 +303,7 @@ impl<'a, I: Iterator<Item = Event<'a>>> Iterator for CodeBlocks<'_, 'a, I> {\n             )),\n             playground_button.as_deref(),\n             tooltip,\n+            edition,\n         ));\n         Some(Event::Html(s.into()))\n     }"}, {"sha": "185df60735fd4c33fa41964a083c46128c0006f7", "filename": "src/librustdoc/html/render/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/db1451c7ad08e77a17c59f6755f234ea507ead92/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/db1451c7ad08e77a17c59f6755f234ea507ead92/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs?ref=db1451c7ad08e77a17c59f6755f234ea507ead92", "patch": "@@ -4747,6 +4747,7 @@ fn item_macro(w: &mut Buffer, cx: &Context<'_>, it: &clean::Item, t: &clean::Mac\n             Some(\"macro\"),\n             None,\n             None,\n+            it.source.span().edition(),\n         ))\n     });\n     document(w, cx, it, None)"}, {"sha": "ac07aeb8bc8b71d5b9c0b0a12b90d9cc40669854", "filename": "src/librustdoc/html/sources.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/db1451c7ad08e77a17c59f6755f234ea507ead92/src%2Flibrustdoc%2Fhtml%2Fsources.rs", "raw_url": "https://github.com/rust-lang/rust/raw/db1451c7ad08e77a17c59f6755f234ea507ead92/src%2Flibrustdoc%2Fhtml%2Fsources.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fsources.rs?ref=db1451c7ad08e77a17c59f6755f234ea507ead92", "patch": "@@ -8,6 +8,7 @@ use crate::html::layout;\n use crate::html::render::{SharedContext, BASIC_KEYWORDS};\n use rustc_hir::def_id::LOCAL_CRATE;\n use rustc_session::Session;\n+use rustc_span::edition::Edition;\n use rustc_span::source_map::FileName;\n use std::ffi::OsStr;\n use std::fs;\n@@ -132,7 +133,7 @@ impl SourceCollector<'_, '_> {\n             &self.scx.layout,\n             &page,\n             \"\",\n-            |buf: &mut _| print_src(buf, contents),\n+            |buf: &mut _| print_src(buf, contents, self.scx.edition),\n             &self.scx.style_files,\n         );\n         self.scx.fs.write(&cur, v.as_bytes())?;\n@@ -170,7 +171,7 @@ where\n \n /// Wrapper struct to render the source code of a file. This will do things like\n /// adding line numbers to the left-hand side.\n-fn print_src(buf: &mut Buffer, s: String) {\n+fn print_src(buf: &mut Buffer, s: String, edition: Edition) {\n     let lines = s.lines().count();\n     let mut cols = 0;\n     let mut tmp = lines;\n@@ -183,5 +184,5 @@ fn print_src(buf: &mut Buffer, s: String) {\n         write!(buf, \"<span id=\\\"{0}\\\">{0:1$}</span>\\n\", i, cols);\n     }\n     write!(buf, \"</pre>\");\n-    write!(buf, \"{}\", highlight::render_with_highlighting(s, None, None, None));\n+    write!(buf, \"{}\", highlight::render_with_highlighting(s, None, None, None, edition));\n }"}]}