{"sha": "c62daa6ed3866d8649ec8654a09c57f4078e1fdd", "node_id": "MDY6Q29tbWl0NzI0NzEyOmM2MmRhYTZlZDM4NjZkODY0OWVjODY1NGEwOWM1N2Y0MDc4ZTFmZGQ=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2014-04-15T14:35:17Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2014-04-23T17:04:29Z"}, "message": "rustc: Give a friendlier error when writing deps\n\nWhen an error is encountered when writing dependencies, this presents a nicer\nerror rather than an ICE.\n\nCloses #13517", "tree": {"sha": "4722c26129546f3e5d468ea2c2f6b1845166090c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4722c26129546f3e5d468ea2c2f6b1845166090c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c62daa6ed3866d8649ec8654a09c57f4078e1fdd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c62daa6ed3866d8649ec8654a09c57f4078e1fdd", "html_url": "https://github.com/rust-lang/rust/commit/c62daa6ed3866d8649ec8654a09c57f4078e1fdd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c62daa6ed3866d8649ec8654a09c57f4078e1fdd/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "de7845ac72e01b491b4ed352f23c2c9a73efc45b", "url": "https://api.github.com/repos/rust-lang/rust/commits/de7845ac72e01b491b4ed352f23c2c9a73efc45b", "html_url": "https://github.com/rust-lang/rust/commit/de7845ac72e01b491b4ed352f23c2c9a73efc45b"}], "stats": {"total": 63, "additions": 44, "deletions": 19}, "files": [{"sha": "6674ef8abb4ac2c3a4eeca5066cf318710ff479f", "filename": "src/librustc/driver/driver.rs", "status": "modified", "additions": 25, "deletions": 19, "changes": 44, "blob_url": "https://github.com/rust-lang/rust/blob/c62daa6ed3866d8649ec8654a09c57f4078e1fdd/src%2Flibrustc%2Fdriver%2Fdriver.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c62daa6ed3866d8649ec8654a09c57f4078e1fdd/src%2Flibrustc%2Fdriver%2Fdriver.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fdriver%2Fdriver.rs?ref=c62daa6ed3866d8649ec8654a09c57f4078e1fdd", "patch": "@@ -495,7 +495,7 @@ pub fn stop_after_phase_5(sess: &Session) -> bool {\n fn write_out_deps(sess: &Session,\n                   input: &Input,\n                   outputs: &OutputFilenames,\n-                  krate: &ast::Crate) -> io::IoResult<()> {\n+                  krate: &ast::Crate) {\n     let id = link::find_crate_id(krate.attrs.as_slice(), outputs.out_filestem);\n \n     let mut out_filenames = Vec::new();\n@@ -524,28 +524,34 @@ fn write_out_deps(sess: &Session,\n             StrInput(..) => {\n                 sess.warn(\"can not write --dep-info without a filename \\\n                            when compiling stdin.\");\n-                return Ok(());\n+                return\n             },\n         },\n-        _ => return Ok(()),\n+        _ => return,\n     };\n \n-    // Build a list of files used to compile the output and\n-    // write Makefile-compatible dependency rules\n-    let files: Vec<~str> = sess.codemap().files.borrow()\n-                               .iter().filter_map(|fmap| {\n-                                    if fmap.is_real_file() {\n-                                        Some(fmap.name.clone())\n-                                    } else {\n-                                        None\n-                                    }\n-                                }).collect();\n-    let mut file = try!(io::File::create(&deps_filename));\n-    for path in out_filenames.iter() {\n-        try!(write!(&mut file as &mut Writer,\n-                      \"{}: {}\\n\\n\", path.display(), files.connect(\" \")));\n+    let result = (|| {\n+        // Build a list of files used to compile the output and\n+        // write Makefile-compatible dependency rules\n+        let files: Vec<~str> = sess.codemap().files.borrow()\n+                                   .iter().filter(|fmap| fmap.is_real_file())\n+                                   .map(|fmap| fmap.name.clone())\n+                                   .collect();\n+        let mut file = try!(io::File::create(&deps_filename));\n+        for path in out_filenames.iter() {\n+            try!(write!(&mut file as &mut Writer,\n+                          \"{}: {}\\n\\n\", path.display(), files.connect(\" \")));\n+        }\n+        Ok(())\n+    })();\n+\n+    match result {\n+        Ok(()) => {}\n+        Err(e) => {\n+            sess.fatal(format!(\"error writing dependencies to `{}`: {}\",\n+                               deps_filename.display(), e));\n+        }\n     }\n-    Ok(())\n }\n \n pub fn compile_input(sess: Session, cfg: ast::CrateConfig, input: &Input,\n@@ -569,7 +575,7 @@ pub fn compile_input(sess: Session, cfg: ast::CrateConfig, input: &Input,\n                                                                          krate, &id);\n             (outputs, expanded_crate, ast_map)\n         };\n-        write_out_deps(&sess, input, &outputs, &expanded_crate).unwrap();\n+        write_out_deps(&sess, input, &outputs, &expanded_crate);\n \n         if stop_after_phase_2(&sess) { return; }\n "}, {"sha": "9f91618bda493598f75214de9e900f03319b6fb1", "filename": "src/test/run-make/error-writing-dependencies/Makefile", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/c62daa6ed3866d8649ec8654a09c57f4078e1fdd/src%2Ftest%2Frun-make%2Ferror-writing-dependencies%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/c62daa6ed3866d8649ec8654a09c57f4078e1fdd/src%2Ftest%2Frun-make%2Ferror-writing-dependencies%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Ferror-writing-dependencies%2FMakefile?ref=c62daa6ed3866d8649ec8654a09c57f4078e1fdd", "patch": "@@ -0,0 +1,8 @@\n+-include ../tools.mk\n+\n+all:\n+\t# Let's get a nice error message\n+\t$(RUSTC) foo.rs --dep-info foo/bar/baz 2>&1 | \\\n+\t\tgrep \"error writing dependencies\"\n+\t# Make sure the filename shows up\n+\t$(RUSTC) foo.rs --dep-info foo/bar/baz 2>&1 | grep \"baz\""}, {"sha": "8ae3d072362ed6b5db81a00be3becce691926a7f", "filename": "src/test/run-make/error-writing-dependencies/foo.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/c62daa6ed3866d8649ec8654a09c57f4078e1fdd/src%2Ftest%2Frun-make%2Ferror-writing-dependencies%2Ffoo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c62daa6ed3866d8649ec8654a09c57f4078e1fdd/src%2Ftest%2Frun-make%2Ferror-writing-dependencies%2Ffoo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Ferror-writing-dependencies%2Ffoo.rs?ref=c62daa6ed3866d8649ec8654a09c57f4078e1fdd", "patch": "@@ -0,0 +1,11 @@\n+// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+fn main() {}"}]}