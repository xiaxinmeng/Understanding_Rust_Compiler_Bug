{"sha": "eb8f2586ebd842dec49d3d7f50e49a985ab31493", "node_id": "MDY6Q29tbWl0NzI0NzEyOmViOGYyNTg2ZWJkODQyZGVjNDlkM2Q3ZjUwZTQ5YTk4NWFiMzE0OTM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-08-27T12:53:48Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-08-27T12:53:48Z"}, "message": "Auto merge of #44060 - taleks:issue-43205, r=arielb1\n\nFixes issue #43205: ICE in Rvalue::Len evaluation.\n\n- fixes evaluation of array length for zero-sized type referenced by rvalue operand.\n- adds test to verify fix.\n\n*Cause of the issue*.\n\nZero-sized aggregates are handled as operands, not lvalues. Therefore while visiting `Assign` statement by `LocalAnalyser`, `mark_as_lvalue()` is not called for related `Local`. This behaviour is controlled by `rvalue_creates_operand()` method.\n\nAs result it causes error later, when rvalue operand is evaluated in `trans_rvalue_operand()` while handling `Rvalue::Len` case. Array length evaluation invokes `trans_lvalue()` which expects referenced `Local` to be value, not operand.\n\n*How it is fixed*.\n\nIn certain cases result of `Rvalue::Len` can be evaluated without calling\n`trans_lvalue()`. Method `evaluate_array_len()` is introduced to handle length\nevaluation for zero-sized types referenced by Locals.\n\n*Some concerns*.\n\n- `trans_lvalue()` has two other entry points in `rvalue.rs`: it is invoked while handling `Rvalue::Ref` and `Rvalue::Discriminant`. There is a chance those may produce the same issue, but I've failed to write a specific test that leads to this.\n- `evaluate_array_len()` performs the same check (matches lvalue and `Local`), which is performed again in `trans_lvalue()`. Without changing `trans_lvalue()` signature to make it aware that caller deals with rvalue, it seems there is no cheap solution to avoid this check.", "tree": {"sha": "226a99001cbff7d8aabda31213b640ba3a5f1b38", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/226a99001cbff7d8aabda31213b640ba3a5f1b38"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/eb8f2586ebd842dec49d3d7f50e49a985ab31493", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/eb8f2586ebd842dec49d3d7f50e49a985ab31493", "html_url": "https://github.com/rust-lang/rust/commit/eb8f2586ebd842dec49d3d7f50e49a985ab31493", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/eb8f2586ebd842dec49d3d7f50e49a985ab31493/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "78e95bb7ac92f8f92654705a47cef652b6a0b259", "url": "https://api.github.com/repos/rust-lang/rust/commits/78e95bb7ac92f8f92654705a47cef652b6a0b259", "html_url": "https://github.com/rust-lang/rust/commit/78e95bb7ac92f8f92654705a47cef652b6a0b259"}, {"sha": "e13090e8b2f8adce9277f2ebfa37efa75c8837a8", "url": "https://api.github.com/repos/rust-lang/rust/commits/e13090e8b2f8adce9277f2ebfa37efa75c8837a8", "html_url": "https://github.com/rust-lang/rust/commit/e13090e8b2f8adce9277f2ebfa37efa75c8837a8"}], "stats": {"total": 40, "additions": 37, "deletions": 3}, "files": [{"sha": "096f43e44ab0f5496b24b973bbb1c9393bcdd05f", "filename": "src/librustc_trans/mir/rvalue.rs", "status": "modified", "additions": 23, "deletions": 3, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/eb8f2586ebd842dec49d3d7f50e49a985ab31493/src%2Flibrustc_trans%2Fmir%2Frvalue.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eb8f2586ebd842dec49d3d7f50e49a985ab31493/src%2Flibrustc_trans%2Fmir%2Frvalue.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fmir%2Frvalue.rs?ref=eb8f2586ebd842dec49d3d7f50e49a985ab31493", "patch": "@@ -29,7 +29,7 @@ use type_of;\n use tvec;\n use value::Value;\n \n-use super::MirContext;\n+use super::{MirContext, LocalRef};\n use super::constant::const_scalar_checked_binop;\n use super::operand::{OperandRef, OperandValue};\n use super::lvalue::LvalueRef;\n@@ -381,9 +381,9 @@ impl<'a, 'tcx> MirContext<'a, 'tcx> {\n             }\n \n             mir::Rvalue::Len(ref lvalue) => {\n-                let tr_lvalue = self.trans_lvalue(&bcx, lvalue);\n+                let size = self.evaluate_array_len(&bcx, lvalue);\n                 let operand = OperandRef {\n-                    val: OperandValue::Immediate(tr_lvalue.len(bcx.ccx)),\n+                    val: OperandValue::Immediate(size),\n                     ty: bcx.tcx().types.usize,\n                 };\n                 (bcx, operand)\n@@ -512,6 +512,26 @@ impl<'a, 'tcx> MirContext<'a, 'tcx> {\n         }\n     }\n \n+    fn evaluate_array_len(&mut self,\n+                          bcx: &Builder<'a, 'tcx>,\n+                          lvalue: &mir::Lvalue<'tcx>) -> ValueRef\n+    {\n+        // ZST are passed as operands and require special handling\n+        // because trans_lvalue() panics if Local is operand.\n+        if let mir::Lvalue::Local(index) = *lvalue {\n+            if let LocalRef::Operand(Some(op)) = self.locals[index] {\n+                if common::type_is_zero_size(bcx.ccx, op.ty) {\n+                    if let ty::TyArray(_, n) = op.ty.sty {\n+                        return common::C_uint(bcx.ccx, n);\n+                    }\n+                }\n+            }\n+        }\n+        // use common size calculation for non zero-sized types\n+        let tr_value = self.trans_lvalue(&bcx, lvalue);\n+        return tr_value.len(bcx.ccx);\n+    }\n+\n     pub fn trans_scalar_binop(&mut self,\n                               bcx: &Builder<'a, 'tcx>,\n                               op: mir::BinOp,"}, {"sha": "0e613ac0727a6ee146001d4ae6f775f336162efc", "filename": "src/test/run-pass/issue-43205.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/eb8f2586ebd842dec49d3d7f50e49a985ab31493/src%2Ftest%2Frun-pass%2Fissue-43205.rs", "raw_url": "https://github.com/rust-lang/rust/raw/eb8f2586ebd842dec49d3d7f50e49a985ab31493/src%2Ftest%2Frun-pass%2Fissue-43205.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fissue-43205.rs?ref=eb8f2586ebd842dec49d3d7f50e49a985ab31493", "patch": "@@ -0,0 +1,14 @@\n+// Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+fn main() {\n+   &&[()][0];\n+   println!(\"{:?}\", &[(),()][1]);\n+}"}]}