{"sha": "60c4f072eb6dd0de3b551341a391758c7cd3a272", "node_id": "C_kwDOAAsO6NoAKDYwYzRmMDcyZWI2ZGQwZGUzYjU1MTM0MWEzOTE3NThjN2NkM2EyNzI", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-04-25T12:56:57Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-04-25T12:56:57Z"}, "message": "Auto merge of #12007 - edwin0cheng:restart-proc-macro-reload, r=jonas-schievink\n\nRestart proc-macro client when server reload\n\nFix #10719", "tree": {"sha": "d1a2f35cfcdec1d3ccd10fb60abd8da983c8609f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d1a2f35cfcdec1d3ccd10fb60abd8da983c8609f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/60c4f072eb6dd0de3b551341a391758c7cd3a272", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/60c4f072eb6dd0de3b551341a391758c7cd3a272", "html_url": "https://github.com/rust-lang/rust/commit/60c4f072eb6dd0de3b551341a391758c7cd3a272", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/60c4f072eb6dd0de3b551341a391758c7cd3a272/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1d2bd0e37969c81da520b1a790d4cffd9ccd135d", "url": "https://api.github.com/repos/rust-lang/rust/commits/1d2bd0e37969c81da520b1a790d4cffd9ccd135d", "html_url": "https://github.com/rust-lang/rust/commit/1d2bd0e37969c81da520b1a790d4cffd9ccd135d"}, {"sha": "8f616a6cb5cbb7e5ac36505a1d40dca15a905426", "url": "https://api.github.com/repos/rust-lang/rust/commits/8f616a6cb5cbb7e5ac36505a1d40dca15a905426", "html_url": "https://github.com/rust-lang/rust/commit/8f616a6cb5cbb7e5ac36505a1d40dca15a905426"}], "stats": {"total": 20, "additions": 14, "deletions": 6}, "files": [{"sha": "d005cdb985283cf18c13ca0f23a319ef03f7794e", "filename": "crates/rust-analyzer/src/handlers.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/60c4f072eb6dd0de3b551341a391758c7cd3a272/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/60c4f072eb6dd0de3b551341a391758c7cd3a272/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fhandlers.rs?ref=60c4f072eb6dd0de3b551341a391758c7cd3a272", "patch": "@@ -43,6 +43,13 @@ use crate::{\n     to_proto, LspError, Result,\n };\n \n+pub(crate) fn handle_workspace_reload(state: &mut GlobalState, _: ()) -> Result<()> {\n+    state.proc_macro_client = None;\n+    state.fetch_workspaces_queue.request_op(\"reload workspace request\".to_string());\n+    state.fetch_build_data_queue.request_op(\"reload workspace request\".to_string());\n+    Ok(())\n+}\n+\n pub(crate) fn handle_analyzer_status(\n     snap: GlobalStateSnapshot,\n     params: lsp_ext::AnalyzerStatusParams,"}, {"sha": "96f4e2a50b955490a5c7ec88d05bdccba3b44bd1", "filename": "crates/rust-analyzer/src/main_loop.rs", "status": "modified", "additions": 7, "deletions": 6, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/60c4f072eb6dd0de3b551341a391758c7cd3a272/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/60c4f072eb6dd0de3b551341a391758c7cd3a272/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs?ref=60c4f072eb6dd0de3b551341a391758c7cd3a272", "patch": "@@ -499,9 +499,13 @@ impl GlobalState {\n                 self.fetch_workspaces(cause);\n             }\n         }\n-        if let Some(cause) = self.fetch_build_data_queue.should_start_op() {\n-            self.fetch_build_data(cause);\n+\n+        if !self.fetch_workspaces_queue.op_in_progress() {\n+            if let Some(cause) = self.fetch_build_data_queue.should_start_op() {\n+                self.fetch_build_data(cause);\n+            }\n         }\n+\n         if let Some(cause) = self.prime_caches_queue.should_start_op() {\n             tracing::debug!(%cause, \"will prime caches\");\n             let num_worker_threads = self.config.prime_caches_num_threads();\n@@ -571,14 +575,11 @@ impl GlobalState {\n         }\n \n         RequestDispatcher { req: Some(req), global_state: self }\n-            .on_sync_mut::<lsp_ext::ReloadWorkspace>(|s, ()| {\n-                s.fetch_workspaces_queue.request_op(\"reload workspace request\".to_string());\n-                Ok(())\n-            })?\n             .on_sync_mut::<lsp_types::request::Shutdown>(|s, ()| {\n                 s.shutdown_requested = true;\n                 Ok(())\n             })?\n+            .on_sync_mut::<lsp_ext::ReloadWorkspace>(handlers::handle_workspace_reload)?\n             .on_sync_mut::<lsp_ext::MemoryUsage>(handlers::handle_memory_usage)?\n             .on_sync_mut::<lsp_ext::ShuffleCrateGraph>(handlers::handle_shuffle_crate_graph)?\n             .on_sync::<lsp_ext::JoinLines>(handlers::handle_join_lines)?"}]}