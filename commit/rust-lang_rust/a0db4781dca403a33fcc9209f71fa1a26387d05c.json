{"sha": "a0db4781dca403a33fcc9209f71fa1a26387d05c", "node_id": "C_kwDOAAsO6NoAKGEwZGI0NzgxZGNhNDAzYTMzZmNjOTIwOWY3MWZhMWEyNjM4N2QwNWM", "commit": {"author": {"name": "ponyii", "email": "ponyii@protonmail.com", "date": "2023-05-06T18:04:47Z"}, "committer": {"name": "ponyii", "email": "ponyii@protonmail.com", "date": "2023-05-10T12:35:43Z"}, "message": "`generate_derive` no longer breaks indentation", "tree": {"sha": "8ef3c7fad074951b58fe0a9a46ab046b1f451245", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8ef3c7fad074951b58fe0a9a46ab046b1f451245"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a0db4781dca403a33fcc9209f71fa1a26387d05c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a0db4781dca403a33fcc9209f71fa1a26387d05c", "html_url": "https://github.com/rust-lang/rust/commit/a0db4781dca403a33fcc9209f71fa1a26387d05c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a0db4781dca403a33fcc9209f71fa1a26387d05c/comments", "author": {"login": "ponyii", "id": 25033620, "node_id": "MDQ6VXNlcjI1MDMzNjIw", "avatar_url": "https://avatars.githubusercontent.com/u/25033620?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ponyii", "html_url": "https://github.com/ponyii", "followers_url": "https://api.github.com/users/ponyii/followers", "following_url": "https://api.github.com/users/ponyii/following{/other_user}", "gists_url": "https://api.github.com/users/ponyii/gists{/gist_id}", "starred_url": "https://api.github.com/users/ponyii/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ponyii/subscriptions", "organizations_url": "https://api.github.com/users/ponyii/orgs", "repos_url": "https://api.github.com/users/ponyii/repos", "events_url": "https://api.github.com/users/ponyii/events{/privacy}", "received_events_url": "https://api.github.com/users/ponyii/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ponyii", "id": 25033620, "node_id": "MDQ6VXNlcjI1MDMzNjIw", "avatar_url": "https://avatars.githubusercontent.com/u/25033620?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ponyii", "html_url": "https://github.com/ponyii", "followers_url": "https://api.github.com/users/ponyii/followers", "following_url": "https://api.github.com/users/ponyii/following{/other_user}", "gists_url": "https://api.github.com/users/ponyii/gists{/gist_id}", "starred_url": "https://api.github.com/users/ponyii/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ponyii/subscriptions", "organizations_url": "https://api.github.com/users/ponyii/orgs", "repos_url": "https://api.github.com/users/ponyii/repos", "events_url": "https://api.github.com/users/ponyii/events{/privacy}", "received_events_url": "https://api.github.com/users/ponyii/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5ee39a6ee50e6ddfdf5ac5532bbd13e268b3bf36", "url": "https://api.github.com/repos/rust-lang/rust/commits/5ee39a6ee50e6ddfdf5ac5532bbd13e268b3bf36", "html_url": "https://github.com/rust-lang/rust/commit/5ee39a6ee50e6ddfdf5ac5532bbd13e268b3bf36"}], "stats": {"total": 41, "additions": 39, "deletions": 2}, "files": [{"sha": "78ac2eb30e59148955799ab5122a656e09f8842a", "filename": "crates/ide-assists/src/handlers/generate_derive.rs", "status": "modified", "additions": 39, "deletions": 2, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/a0db4781dca403a33fcc9209f71fa1a26387d05c/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fgenerate_derive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a0db4781dca403a33fcc9209f71fa1a26387d05c/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fgenerate_derive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fgenerate_derive.rs?ref=a0db4781dca403a33fcc9209f71fa1a26387d05c", "patch": "@@ -1,5 +1,5 @@\n use syntax::{\n-    ast::{self, AstNode, HasAttrs},\n+    ast::{self, edit::IndentLevel, AstNode, HasAttrs},\n     SyntaxKind::{COMMENT, WHITESPACE},\n     TextSize,\n };\n@@ -42,7 +42,12 @@ pub(crate) fn generate_derive(acc: &mut Assists, ctx: &AssistContext<'_>) -> Opt\n                 .next();\n             match derive_attr {\n                 None => {\n-                    builder.insert_snippet(cap, node_start, \"#[derive($0)]\\n\");\n+                    let indent_level = IndentLevel::from_node(nominal.syntax());\n+                    builder.insert_snippet(\n+                        cap,\n+                        node_start,\n+                        format!(\"#[derive($0)]\\n{indent_level}\"),\n+                    );\n                 }\n                 Some(tt) => {\n                     // Just move the cursor.\n@@ -84,6 +89,20 @@ mod tests {\n             \"struct Foo { $0 a: i32, }\",\n             \"#[derive($0)]\\nstruct Foo {  a: i32, }\",\n         );\n+        check_assist(\n+            generate_derive,\n+            \"\n+mod m {\n+    struct Foo { a: i32,$0 }\n+}\n+            \",\n+            \"\n+mod m {\n+    #[derive($0)]\n+    struct Foo { a: i32, }\n+}\n+            \",\n+        );\n     }\n \n     #[test]\n@@ -111,6 +130,24 @@ struct Foo { a: i32$0, }\n struct Foo { a: i32, }\n             \",\n         );\n+        check_assist(\n+            generate_derive,\n+            \"\n+mod m {\n+    /// `Foo` is a pretty important struct.\n+    /// It does stuff.\n+    struct Foo { a: i32,$0 }\n+}\n+            \",\n+            \"\n+mod m {\n+    /// `Foo` is a pretty important struct.\n+    /// It does stuff.\n+    #[derive($0)]\n+    struct Foo { a: i32, }\n+}\n+            \",\n+        );\n     }\n \n     #[test]"}]}