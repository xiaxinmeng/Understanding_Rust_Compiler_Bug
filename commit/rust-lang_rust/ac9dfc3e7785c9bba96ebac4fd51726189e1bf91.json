{"sha": "ac9dfc3e7785c9bba96ebac4fd51726189e1bf91", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFjOWRmYzNlNzc4NWM5YmJhOTZlYmFjNGZkNTE3MjYxODllMWJmOTE=", "commit": {"author": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2020-04-11T04:50:02Z"}, "committer": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2020-07-22T04:57:43Z"}, "message": "Normalize opaque types when converting `ParamEnv` to `Reveal::All`\n\nFixes #65918", "tree": {"sha": "e7936b2679bf779ada0a87abd1a4436a2a02853c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e7936b2679bf779ada0a87abd1a4436a2a02853c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ac9dfc3e7785c9bba96ebac4fd51726189e1bf91", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE7J9Gc3TfBwj2K399tAh+UQ6YsWQFAl8Xx0gACgkQtAh+UQ6Y\nsWS8CA//f5pfwZR2eSh25o1XU/FvX1Lgp9WKDRJy1uEVGMrtYMAM2pPe8SuC8jZd\nqP1tXtxaLApW0ziq7w6/xRFsnhaQKCiSN+5T6BeXPLB+5VnDnFczcaxvXoj5TdQ7\nJ+F1rMjOlhOVXRldOOqjkK4o4GvtmnCgCRmugHZ+V9TJ6B2kAx4jysujFdtpCqNT\nXbvbFrGmxf6DVvWHCmWTJvi7txttLMfl7XpLs/NFqwjcm5VTNOfUYMYwTswcf9Ed\nUMvFgG9HZYM5yIMpLEB7JghBkE7Vwr3GfPG8VR3Poez8woitweqps8rkqyAXNIoZ\nmPfsGOrNCy+Pt8pCixT8vtTXdAPgPeGElVcUt20lVHsIQp89IciI/sDPUxHdrKqQ\nIh2zamyZc7nbUsZLYqbhe+bUHBKAb4oavj/vICNpLpYAm1jbCebeTrf/EcIC6hxe\nnB0c8U22tbTrRVn7WzC73FMvZRe/4yPeE9FY0FUPd5TpYWAsSXSJxC/9laHWvbJV\nCReVTj1S7/LtmtjDuJ1mn208iCQVMb1etGyWt/VWSi67GIZDRYfCCD4RhXE5Kb+8\ncYoggloi+36ER4QsefxTg2StrWo6nfl+k2GrHvMVqb+/zLHCgcrHKvdM/RvTbxrT\nz2Rb/GeySOTZhKn8YMCdFX55Y7MvN7P0fe+NyeK/3fGItIhNp98=\n=ktK8\n-----END PGP SIGNATURE-----", "payload": "tree e7936b2679bf779ada0a87abd1a4436a2a02853c\nparent 8ad7bc3f428300aee6764f6e23527e19eb235e81\nauthor Aaron Hill <aa1ronham@gmail.com> 1586580602 -0400\ncommitter Aaron Hill <aa1ronham@gmail.com> 1595393863 -0400\n\nNormalize opaque types when converting `ParamEnv` to `Reveal::All`\n\nFixes #65918\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ac9dfc3e7785c9bba96ebac4fd51726189e1bf91", "html_url": "https://github.com/rust-lang/rust/commit/ac9dfc3e7785c9bba96ebac4fd51726189e1bf91", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ac9dfc3e7785c9bba96ebac4fd51726189e1bf91/comments", "author": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8ad7bc3f428300aee6764f6e23527e19eb235e81", "url": "https://api.github.com/repos/rust-lang/rust/commits/8ad7bc3f428300aee6764f6e23527e19eb235e81", "html_url": "https://github.com/rust-lang/rust/commit/8ad7bc3f428300aee6764f6e23527e19eb235e81"}], "stats": {"total": 221, "additions": 139, "deletions": 82}, "files": [{"sha": "442e7f6b0f45e46e5930bcc9519c2e297553d666", "filename": "src/librustc_middle/mir/interpret/queries.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ac9dfc3e7785c9bba96ebac4fd51726189e1bf91/src%2Flibrustc_middle%2Fmir%2Finterpret%2Fqueries.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ac9dfc3e7785c9bba96ebac4fd51726189e1bf91/src%2Flibrustc_middle%2Fmir%2Finterpret%2Fqueries.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_middle%2Fmir%2Finterpret%2Fqueries.rs?ref=ac9dfc3e7785c9bba96ebac4fd51726189e1bf91", "patch": "@@ -18,7 +18,7 @@ impl<'tcx> TyCtxt<'tcx> {\n         let substs = InternalSubsts::identity_for_item(self, def_id);\n         let instance = ty::Instance::new(def_id, substs);\n         let cid = GlobalId { instance, promoted: None };\n-        let param_env = self.param_env(def_id).with_reveal_all();\n+        let param_env = self.param_env(def_id).with_reveal_all_normalized(self);\n         self.const_eval_global_id(param_env, cid, None)\n     }\n "}, {"sha": "a560c2aa0be11907b2a9427fd1b2ae2efbe9fd4a", "filename": "src/librustc_middle/mir/interpret/value.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ac9dfc3e7785c9bba96ebac4fd51726189e1bf91/src%2Flibrustc_middle%2Fmir%2Finterpret%2Fvalue.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ac9dfc3e7785c9bba96ebac4fd51726189e1bf91/src%2Flibrustc_middle%2Fmir%2Finterpret%2Fvalue.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_middle%2Fmir%2Finterpret%2Fvalue.rs?ref=ac9dfc3e7785c9bba96ebac4fd51726189e1bf91", "patch": "@@ -78,7 +78,7 @@ impl<'tcx> ConstValue<'tcx> {\n         param_env: ParamEnv<'tcx>,\n         ty: Ty<'tcx>,\n     ) -> Option<u128> {\n-        let size = tcx.layout_of(param_env.with_reveal_all().and(ty)).ok()?.size;\n+        let size = tcx.layout_of(param_env.with_reveal_all_normalized(tcx).and(ty)).ok()?.size;\n         self.try_to_bits(size)\n     }\n "}, {"sha": "69f1366abf8ec16ee87a295df73cd962d430f9d9", "filename": "src/librustc_middle/query/mod.rs", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/ac9dfc3e7785c9bba96ebac4fd51726189e1bf91/src%2Flibrustc_middle%2Fquery%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ac9dfc3e7785c9bba96ebac4fd51726189e1bf91/src%2Flibrustc_middle%2Fquery%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_middle%2Fquery%2Fmod.rs?ref=ac9dfc3e7785c9bba96ebac4fd51726189e1bf91", "patch": "@@ -864,11 +864,17 @@ rustc_queries! {\n         /// type-checking etc, and it does not normalize specializable\n         /// associated types. This is almost always what you want,\n         /// unless you are doing MIR optimizations, in which case you\n-        /// might want to use `reveal_all()` method to change modes.\n         query param_env(def_id: DefId) -> ty::ParamEnv<'tcx> {\n             desc { |tcx| \"computing normalized predicates of `{}`\", tcx.def_path_str(def_id) }\n         }\n \n+        /// Like `param_env`, but returns the `ParamEnv in `Reveal::All` mode.\n+        /// Prefer this over `tcx.param_env(def_id).with_reveal_all_normalized(tcx)`,\n+        /// as this method is more efficient.\n+        query param_env_reveal_all_normalized(def_id: DefId) -> ty::ParamEnv<'tcx> {\n+            desc { |tcx| \"computing revealed normalized predicates of `{}`\", tcx.def_path_str(def_id) }\n+        }\n+\n         /// Trait selection queries. These are best used by invoking `ty.is_copy_modulo_regions()`,\n         /// `ty.is_copy()`, etc, since that will prune the environment where possible.\n         query is_copy_raw(env: ty::ParamEnvAnd<'tcx, Ty<'tcx>>) -> bool {\n@@ -1527,5 +1533,9 @@ rustc_queries! {\n                 ty::Instance::new(key.value.0.to_def_id(), key.value.2),\n             }\n         }\n+\n+        query normalize_opaque_types(key: &'tcx ty::List<ty::Predicate<'tcx>>) -> &'tcx ty::List<ty::Predicate<'tcx>> {\n+            desc { \"normalizing opaque types in {:?}\", key }\n+        }\n     }\n }"}, {"sha": "06dd2eee50567282a6c2f07862047e8f9c1e26d1", "filename": "src/librustc_middle/ty/layout.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/ac9dfc3e7785c9bba96ebac4fd51726189e1bf91/src%2Flibrustc_middle%2Fty%2Flayout.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ac9dfc3e7785c9bba96ebac4fd51726189e1bf91/src%2Flibrustc_middle%2Fty%2Flayout.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_middle%2Fty%2Flayout.rs?ref=ac9dfc3e7785c9bba96ebac4fd51726189e1bf91", "patch": "@@ -1921,7 +1921,7 @@ impl<'tcx> LayoutOf for LayoutCx<'tcx, TyCtxt<'tcx>> {\n     /// Computes the layout of a type. Note that this implicitly\n     /// executes in \"reveal all\" mode.\n     fn layout_of(&self, ty: Ty<'tcx>) -> Self::TyAndLayout {\n-        let param_env = self.param_env.with_reveal_all();\n+        let param_env = self.param_env.with_reveal_all_normalized(self.tcx);\n         let ty = self.tcx.normalize_erasing_regions(param_env, ty);\n         let layout = self.tcx.layout_raw(param_env.and(ty))?;\n         let layout = TyAndLayout { ty, layout };\n@@ -1945,7 +1945,7 @@ impl LayoutOf for LayoutCx<'tcx, ty::query::TyCtxtAt<'tcx>> {\n     /// Computes the layout of a type. Note that this implicitly\n     /// executes in \"reveal all\" mode.\n     fn layout_of(&self, ty: Ty<'tcx>) -> Self::TyAndLayout {\n-        let param_env = self.param_env.with_reveal_all();\n+        let param_env = self.param_env.with_reveal_all_normalized(*self.tcx);\n         let ty = self.tcx.normalize_erasing_regions(param_env, ty);\n         let layout = self.tcx.layout_raw(param_env.and(ty))?;\n         let layout = TyAndLayout { ty, layout };"}, {"sha": "ef0cf929dcd4d79eea21a428528913e969fe1f5d", "filename": "src/librustc_middle/ty/mod.rs", "status": "modified", "additions": 11, "deletions": 4, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/ac9dfc3e7785c9bba96ebac4fd51726189e1bf91/src%2Flibrustc_middle%2Fty%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ac9dfc3e7785c9bba96ebac4fd51726189e1bf91/src%2Flibrustc_middle%2Fty%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_middle%2Fty%2Fmod.rs?ref=ac9dfc3e7785c9bba96ebac4fd51726189e1bf91", "patch": "@@ -1,5 +1,5 @@\n // ignore-tidy-filelength\n-pub use self::fold::{TypeFoldable, TypeVisitor};\n+pub use self::fold::{TypeFoldable, TypeFolder, TypeVisitor};\n pub use self::AssocItemContainer::*;\n pub use self::BorrowKind::*;\n pub use self::IntVarValue::*;\n@@ -1819,9 +1819,15 @@ impl<'tcx> ParamEnv<'tcx> {\n     /// the desired behavior during codegen and certain other special\n     /// contexts; normally though we want to use `Reveal::UserFacing`,\n     /// which is the default.\n-    pub fn with_reveal_all(mut self) -> Self {\n-        self.packed_data |= 1;\n-        self\n+    /// All opaque types in the caller_bounds of the `ParamEnv`\n+    /// will be normalized to their underlying types.\n+    /// See PR #65989 and issue #65918 for more details\n+    pub fn with_reveal_all_normalized(mut self) -> Self {\n+        if self.packed_data & 1 == 1 {\n+            return self;\n+        }\n+\n+        ParamEnv::new(tcx.normalize_opaque_types(self.caller_bounds()), Reveal::All, self.def_id)\n     }\n \n     /// Returns this same environment but with no caller bounds.\n@@ -3067,6 +3073,7 @@ pub fn provide(providers: &mut ty::query::Providers) {\n     context::provide(providers);\n     erase_regions::provide(providers);\n     layout::provide(providers);\n+    util::provide(providers);\n     super::util::bug::provide(providers);\n     *providers = ty::query::Providers {\n         trait_impls_of: trait_def::trait_impls_of_provider,"}, {"sha": "3f7a20bba2b9add597b91cf99d5dfea170c82f3e", "filename": "src/librustc_middle/ty/query/keys.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/ac9dfc3e7785c9bba96ebac4fd51726189e1bf91/src%2Flibrustc_middle%2Fty%2Fquery%2Fkeys.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ac9dfc3e7785c9bba96ebac4fd51726189e1bf91/src%2Flibrustc_middle%2Fty%2Fquery%2Fkeys.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_middle%2Fty%2Fquery%2Fkeys.rs?ref=ac9dfc3e7785c9bba96ebac4fd51726189e1bf91", "patch": "@@ -270,6 +270,17 @@ impl<'tcx> Key for Ty<'tcx> {\n     }\n }\n \n+impl<'tcx> Key for &'tcx ty::List<ty::Predicate<'tcx>> {\n+    type CacheSelector = DefaultCacheSelector;\n+\n+    fn query_crate(&self) -> CrateNum {\n+        LOCAL_CRATE\n+    }\n+    fn default_span(&self, _: TyCtxt<'_>) -> Span {\n+        DUMMY_SP\n+    }\n+}\n+\n impl<'tcx> Key for ty::ParamEnv<'tcx> {\n     type CacheSelector = DefaultCacheSelector;\n "}, {"sha": "35b684316fd87d452ae4ff524581f1b2ee4d374d", "filename": "src/librustc_middle/ty/util.rs", "status": "modified", "additions": 90, "deletions": 66, "changes": 156, "blob_url": "https://github.com/rust-lang/rust/blob/ac9dfc3e7785c9bba96ebac4fd51726189e1bf91/src%2Flibrustc_middle%2Fty%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ac9dfc3e7785c9bba96ebac4fd51726189e1bf91/src%2Flibrustc_middle%2Fty%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_middle%2Fty%2Futil.rs?ref=ac9dfc3e7785c9bba96ebac4fd51726189e1bf91", "patch": "@@ -3,11 +3,12 @@\n use crate::ich::NodeIdHashingMode;\n use crate::middle::codegen_fn_attrs::CodegenFnAttrFlags;\n use crate::mir::interpret::{sign_extend, truncate};\n+use crate::ty::fold::TypeFolder;\n use crate::ty::layout::IntegerExt;\n use crate::ty::query::TyCtxtAt;\n use crate::ty::subst::{GenericArgKind, InternalSubsts, Subst, SubstsRef};\n use crate::ty::TyKind::*;\n-use crate::ty::{self, DefIdTree, GenericParamDefKind, Ty, TyCtxt, TypeFoldable};\n+use crate::ty::{self, DefIdTree, GenericParamDefKind, List, Ty, TyCtxt, TypeFoldable};\n use rustc_apfloat::Float as _;\n use rustc_ast::ast;\n use rustc_attr::{self as attr, SignedInt, UnsignedInt};\n@@ -557,82 +558,84 @@ impl<'tcx> TyCtxt<'tcx> {\n         def_id: DefId,\n         substs: SubstsRef<'tcx>,\n     ) -> Result<Ty<'tcx>, Ty<'tcx>> {\n-        use crate::ty::fold::TypeFolder;\n-\n-        struct OpaqueTypeExpander<'tcx> {\n-            // Contains the DefIds of the opaque types that are currently being\n-            // expanded. When we expand an opaque type we insert the DefId of\n-            // that type, and when we finish expanding that type we remove the\n-            // its DefId.\n-            seen_opaque_tys: FxHashSet<DefId>,\n-            // Cache of all expansions we've seen so far. This is a critical\n-            // optimization for some large types produced by async fn trees.\n-            expanded_cache: FxHashMap<(DefId, SubstsRef<'tcx>), Ty<'tcx>>,\n-            primary_def_id: DefId,\n-            found_recursion: bool,\n-            tcx: TyCtxt<'tcx>,\n-        }\n-\n-        impl<'tcx> OpaqueTypeExpander<'tcx> {\n-            fn expand_opaque_ty(\n-                &mut self,\n-                def_id: DefId,\n-                substs: SubstsRef<'tcx>,\n-            ) -> Option<Ty<'tcx>> {\n-                if self.found_recursion {\n-                    return None;\n-                }\n-                let substs = substs.fold_with(self);\n-                if self.seen_opaque_tys.insert(def_id) {\n-                    let expanded_ty = match self.expanded_cache.get(&(def_id, substs)) {\n-                        Some(expanded_ty) => expanded_ty,\n-                        None => {\n-                            let generic_ty = self.tcx.type_of(def_id);\n-                            let concrete_ty = generic_ty.subst(self.tcx, substs);\n-                            let expanded_ty = self.fold_ty(concrete_ty);\n-                            self.expanded_cache.insert((def_id, substs), expanded_ty);\n-                            expanded_ty\n-                        }\n-                    };\n-                    self.seen_opaque_tys.remove(&def_id);\n-                    Some(expanded_ty)\n-                } else {\n-                    // If another opaque type that we contain is recursive, then it\n-                    // will report the error, so we don't have to.\n-                    self.found_recursion = def_id == self.primary_def_id;\n-                    None\n-                }\n-            }\n-        }\n-\n-        impl<'tcx> TypeFolder<'tcx> for OpaqueTypeExpander<'tcx> {\n-            fn tcx(&self) -> TyCtxt<'tcx> {\n-                self.tcx\n-            }\n-\n-            fn fold_ty(&mut self, t: Ty<'tcx>) -> Ty<'tcx> {\n-                if let ty::Opaque(def_id, substs) = t.kind {\n-                    self.expand_opaque_ty(def_id, substs).unwrap_or(t)\n-                } else if t.has_opaque_types() {\n-                    t.super_fold_with(self)\n-                } else {\n-                    t\n-                }\n-            }\n-        }\n-\n         let mut visitor = OpaqueTypeExpander {\n             seen_opaque_tys: FxHashSet::default(),\n             expanded_cache: FxHashMap::default(),\n-            primary_def_id: def_id,\n+            primary_def_id: Some(def_id),\n             found_recursion: false,\n+            check_recursion: true,\n             tcx: self,\n         };\n+\n         let expanded_type = visitor.expand_opaque_ty(def_id, substs).unwrap();\n         if visitor.found_recursion { Err(expanded_type) } else { Ok(expanded_type) }\n     }\n }\n \n+struct OpaqueTypeExpander<'tcx> {\n+    // Contains the DefIds of the opaque types that are currently being\n+    // expanded. When we expand an opaque type we insert the DefId of\n+    // that type, and when we finish expanding that type we remove the\n+    // its DefId.\n+    seen_opaque_tys: FxHashSet<DefId>,\n+    // Cache of all expansions we've seen so far. This is a critical\n+    // optimization for some large types produced by async fn trees.\n+    expanded_cache: FxHashMap<(DefId, SubstsRef<'tcx>), Ty<'tcx>>,\n+    primary_def_id: Option<DefId>,\n+    found_recursion: bool,\n+    /// Whether or not to check for recursive opaque types.\n+    /// This is `true` when we're explicitly checking for opaque type\n+    /// recursion, and 'false' otherwise to avoid unecessary work.\n+    check_recursion: bool,\n+    tcx: TyCtxt<'tcx>,\n+}\n+\n+impl<'tcx> OpaqueTypeExpander<'tcx> {\n+    fn expand_opaque_ty(&mut self, def_id: DefId, substs: SubstsRef<'tcx>) -> Option<Ty<'tcx>> {\n+        if self.found_recursion {\n+            return None;\n+        }\n+        let substs = substs.fold_with(self);\n+        if !self.check_recursion || self.seen_opaque_tys.insert(def_id) {\n+            let expanded_ty = match self.expanded_cache.get(&(def_id, substs)) {\n+                Some(expanded_ty) => expanded_ty,\n+                None => {\n+                    let generic_ty = self.tcx.type_of(def_id);\n+                    let concrete_ty = generic_ty.subst(self.tcx, substs);\n+                    let expanded_ty = self.fold_ty(concrete_ty);\n+                    self.expanded_cache.insert((def_id, substs), expanded_ty);\n+                    expanded_ty\n+                }\n+            };\n+            if self.check_recursion {\n+                self.seen_opaque_tys.remove(&def_id);\n+            }\n+            Some(expanded_ty)\n+        } else {\n+            // If another opaque type that we contain is recursive, then it\n+            // will report the error, so we don't have to.\n+            self.found_recursion = def_id == *self.primary_def_id.as_ref().unwrap();\n+            None\n+        }\n+    }\n+}\n+\n+impl<'tcx> TypeFolder<'tcx> for OpaqueTypeExpander<'tcx> {\n+    fn tcx(&self) -> TyCtxt<'tcx> {\n+        self.tcx\n+    }\n+\n+    fn fold_ty(&mut self, t: Ty<'tcx>) -> Ty<'tcx> {\n+        if let ty::Opaque(def_id, substs) = t.kind {\n+            self.expand_opaque_ty(def_id, substs).unwrap_or(t)\n+        } else if t.has_opaque_types() {\n+            t.super_fold_with(self)\n+        } else {\n+            t\n+        }\n+    }\n+}\n+\n impl<'tcx> ty::TyS<'tcx> {\n     /// Returns the maximum value for the given numeric type (including `char`s)\n     /// or returns `None` if the type is not numeric.\n@@ -1142,3 +1145,24 @@ pub fn needs_drop_components(\n \n #[derive(Copy, Clone, Debug, HashStable, RustcEncodable, RustcDecodable)]\n pub struct AlwaysRequiresDrop;\n+\n+/// Normalizes all opaque types in the given value, replacing them\n+/// with their underlying types.\n+pub fn normalize_opaque_types(\n+    tcx: TyCtxt<'tcx>,\n+    val: &'tcx List<ty::Predicate<'tcx>>,\n+) -> &'tcx List<ty::Predicate<'tcx>> {\n+    let mut visitor = OpaqueTypeExpander {\n+        seen_opaque_tys: FxHashSet::default(),\n+        expanded_cache: FxHashMap::default(),\n+        primary_def_id: None,\n+        found_recursion: false,\n+        check_recursion: false,\n+        tcx,\n+    };\n+    val.fold_with(&mut visitor)\n+}\n+\n+pub fn provide(providers: &mut ty::query::Providers<'_>) {\n+    *providers = ty::query::Providers { normalize_opaque_types, ..*providers }\n+}"}, {"sha": "6a7653b60752db1164fa40bd6f78ee33c692e501", "filename": "src/librustc_mir/shim.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ac9dfc3e7785c9bba96ebac4fd51726189e1bf91/src%2Flibrustc_mir%2Fshim.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ac9dfc3e7785c9bba96ebac4fd51726189e1bf91/src%2Flibrustc_mir%2Fshim.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fshim.rs?ref=ac9dfc3e7785c9bba96ebac4fd51726189e1bf91", "patch": "@@ -193,7 +193,7 @@ fn build_drop_shim<'tcx>(tcx: TyCtxt<'tcx>, def_id: DefId, ty: Option<Ty<'tcx>>)\n             );\n         }\n         let patch = {\n-            let param_env = tcx.param_env(def_id).with_reveal_all();\n+            let param_env = tcx.param_env_reveal_all_normalized(def_id);\n             let mut elaborator =\n                 DropShimElaborator { body: &body, patch: MirPatch::new(&body), tcx, param_env };\n             let dropee = tcx.mk_place_deref(dropee_ptr);"}, {"sha": "80fc37207171a6a39a4a1697ef8f7eaf82c77f0a", "filename": "src/librustc_mir/transform/const_prop.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ac9dfc3e7785c9bba96ebac4fd51726189e1bf91/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ac9dfc3e7785c9bba96ebac4fd51726189e1bf91/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs?ref=ac9dfc3e7785c9bba96ebac4fd51726189e1bf91", "patch": "@@ -328,7 +328,7 @@ impl<'mir, 'tcx> ConstPropagator<'mir, 'tcx> {\n     ) -> ConstPropagator<'mir, 'tcx> {\n         let def_id = source.def_id();\n         let substs = &InternalSubsts::identity_for_item(tcx, def_id);\n-        let param_env = tcx.param_env(def_id).with_reveal_all();\n+        let param_env = tcx.param_env_reveal_all_normalized(def_id);\n \n         let span = tcx.def_span(def_id);\n         let can_const_prop = CanConstProp::check(body);"}, {"sha": "ad49090bfc50c1dbc3b5f6e0d67294adad7d988e", "filename": "src/librustc_mir/transform/elaborate_drops.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ac9dfc3e7785c9bba96ebac4fd51726189e1bf91/src%2Flibrustc_mir%2Ftransform%2Felaborate_drops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ac9dfc3e7785c9bba96ebac4fd51726189e1bf91/src%2Flibrustc_mir%2Ftransform%2Felaborate_drops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Felaborate_drops.rs?ref=ac9dfc3e7785c9bba96ebac4fd51726189e1bf91", "patch": "@@ -25,7 +25,7 @@ impl<'tcx> MirPass<'tcx> for ElaborateDrops {\n         debug!(\"elaborate_drops({:?} @ {:?})\", src, body.span);\n \n         let def_id = src.def_id();\n-        let param_env = tcx.param_env(src.def_id()).with_reveal_all();\n+        let param_env = tcx.param_env_reveal_all_normalized(src.def_id());\n         let move_data = match MoveData::gather_moves(body, tcx, param_env) {\n             Ok(move_data) => move_data,\n             Err((move_data, _)) => {"}, {"sha": "92ea162e419dbb6941ffe68dc8439bac96acd8ce", "filename": "src/librustc_mir/transform/inline.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ac9dfc3e7785c9bba96ebac4fd51726189e1bf91/src%2Flibrustc_mir%2Ftransform%2Finline.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ac9dfc3e7785c9bba96ebac4fd51726189e1bf91/src%2Flibrustc_mir%2Ftransform%2Finline.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Finline.rs?ref=ac9dfc3e7785c9bba96ebac4fd51726189e1bf91", "patch": "@@ -72,7 +72,7 @@ impl Inliner<'tcx> {\n \n         let mut callsites = VecDeque::new();\n \n-        let param_env = self.tcx.param_env(self.source.def_id()).with_reveal_all();\n+        let param_env = self.tcx.param_env_reveal_all_normalized(self.source.def_id());\n \n         // Only do inlining into fn bodies.\n         let id = self.tcx.hir().as_local_hir_id(self.source.def_id().expect_local());"}, {"sha": "1c7e8c3c2e8b2bf173b4ad1e567aedf70c4bc3c9", "filename": "src/librustc_mir_build/hair/pattern/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ac9dfc3e7785c9bba96ebac4fd51726189e1bf91/src%2Flibrustc_mir_build%2Fhair%2Fpattern%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ac9dfc3e7785c9bba96ebac4fd51726189e1bf91/src%2Flibrustc_mir_build%2Fhair%2Fpattern%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir_build%2Fhair%2Fpattern%2Fmod.rs?ref=ac9dfc3e7785c9bba96ebac4fd51726189e1bf91", "patch": "@@ -781,7 +781,7 @@ impl<'a, 'tcx> PatCtxt<'a, 'tcx> {\n \n         // Use `Reveal::All` here because patterns are always monomorphic even if their function\n         // isn't.\n-        let param_env_reveal_all = self.param_env.with_reveal_all();\n+        let param_env_reveal_all = self.param_env.with_reveal_all_normalized(self.tcx);\n         let substs = self.typeck_results.node_substs(id);\n         let instance = match ty::Instance::resolve(self.tcx, param_env_reveal_all, def_id, substs) {\n             Ok(Some(i)) => i,"}, {"sha": "8cfab7b9833ba9aa401bf453c71063ed00b53d46", "filename": "src/librustc_symbol_mangling/v0.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ac9dfc3e7785c9bba96ebac4fd51726189e1bf91/src%2Flibrustc_symbol_mangling%2Fv0.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ac9dfc3e7785c9bba96ebac4fd51726189e1bf91/src%2Flibrustc_symbol_mangling%2Fv0.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_symbol_mangling%2Fv0.rs?ref=ac9dfc3e7785c9bba96ebac4fd51726189e1bf91", "patch": "@@ -271,7 +271,7 @@ impl Printer<'tcx> for SymbolMangler<'tcx> {\n         let key = self.tcx.def_key(impl_def_id);\n         let parent_def_id = DefId { index: key.parent.unwrap(), ..impl_def_id };\n \n-        let mut param_env = self.tcx.param_env(impl_def_id).with_reveal_all();\n+        let mut param_env = self.tcx.param_env_reveal_all_normalized(impl_def_id);\n         if !substs.is_empty() {\n             param_env = param_env.subst(self.tcx, substs);\n         }"}, {"sha": "1e0c4055af3c5a476a1dec21b5e9bf042e18ff62", "filename": "src/librustc_ty/instance.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ac9dfc3e7785c9bba96ebac4fd51726189e1bf91/src%2Flibrustc_ty%2Finstance.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ac9dfc3e7785c9bba96ebac4fd51726189e1bf91/src%2Flibrustc_ty%2Finstance.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_ty%2Finstance.rs?ref=ac9dfc3e7785c9bba96ebac4fd51726189e1bf91", "patch": "@@ -137,7 +137,7 @@ fn resolve_associated_item<'tcx>(\n                 });\n \n             let substs = tcx.infer_ctxt().enter(|infcx| {\n-                let param_env = param_env.with_reveal_all();\n+                let param_env = param_env.with_reveal_all_normalized(tcx);\n                 let substs = rcvr_substs.rebase_onto(tcx, trait_def_id, impl_data.substs);\n                 let substs = translate_substs(\n                     &infcx,"}, {"sha": "c508fc5f89bae841109c87edc1634f8616a1c840", "filename": "src/librustc_ty/ty.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/ac9dfc3e7785c9bba96ebac4fd51726189e1bf91/src%2Flibrustc_ty%2Fty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ac9dfc3e7785c9bba96ebac4fd51726189e1bf91/src%2Flibrustc_ty%2Fty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_ty%2Fty.rs?ref=ac9dfc3e7785c9bba96ebac4fd51726189e1bf91", "patch": "@@ -276,6 +276,10 @@ fn param_env(tcx: TyCtxt<'_>, def_id: DefId) -> ty::ParamEnv<'_> {\n     traits::normalize_param_env_or_error(tcx, def_id, unnormalized_env, cause)\n }\n \n+fn param_env_reveal_all_normalized(tcx: TyCtxt<'_>, def_id: DefId) -> ty::ParamEnv<'_> {\n+    tcx.param_env(def_id).with_reveal_all_normalized(tcx)\n+}\n+\n fn crate_disambiguator(tcx: TyCtxt<'_>, crate_num: CrateNum) -> CrateDisambiguator {\n     assert_eq!(crate_num, LOCAL_CRATE);\n     tcx.sess.local_crate_disambiguator()\n@@ -503,6 +507,7 @@ pub fn provide(providers: &mut ty::query::Providers) {\n         adt_sized_constraint,\n         def_span,\n         param_env,\n+        param_env_reveal_all_normalized,\n         trait_of_item,\n         crate_disambiguator,\n         original_crate_name,"}]}