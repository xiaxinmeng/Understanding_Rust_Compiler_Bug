{"sha": "b78ac5b74a62e7b2772d322004a6bb04967f8437", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI3OGFjNWI3NGE2MmU3YjI3NzJkMzIyMDA0YTZiYjA0OTY3Zjg0Mzc=", "commit": {"author": {"name": "Flavio Percoco", "email": "flaper87@gmail.com", "date": "2014-04-05T12:10:13Z"}, "committer": {"name": "Flavio Percoco", "email": "flaper87@gmail.com", "date": "2014-04-06T13:06:44Z"}, "message": "Add support for different relocation models\n\nRust currently defaults to `RelocPIC` regardless. This patch adds a new\ncodegen option that allows choosing different relocation-model. The\navailable models are:\n\n    - default (Use the target-specific default model)\n    - static\n    - pic\n    - no-pic\n\nFor a more detailed information use `llc --help`", "tree": {"sha": "caf4a9390e4ec1c3674e74f3f7fcdb5cba7e14ac", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/caf4a9390e4ec1c3674e74f3f7fcdb5cba7e14ac"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b78ac5b74a62e7b2772d322004a6bb04967f8437", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b78ac5b74a62e7b2772d322004a6bb04967f8437", "html_url": "https://github.com/rust-lang/rust/commit/b78ac5b74a62e7b2772d322004a6bb04967f8437", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b78ac5b74a62e7b2772d322004a6bb04967f8437/comments", "author": {"login": "flaper87", "id": 13816, "node_id": "MDQ6VXNlcjEzODE2", "avatar_url": "https://avatars.githubusercontent.com/u/13816?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flaper87", "html_url": "https://github.com/flaper87", "followers_url": "https://api.github.com/users/flaper87/followers", "following_url": "https://api.github.com/users/flaper87/following{/other_user}", "gists_url": "https://api.github.com/users/flaper87/gists{/gist_id}", "starred_url": "https://api.github.com/users/flaper87/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flaper87/subscriptions", "organizations_url": "https://api.github.com/users/flaper87/orgs", "repos_url": "https://api.github.com/users/flaper87/repos", "events_url": "https://api.github.com/users/flaper87/events{/privacy}", "received_events_url": "https://api.github.com/users/flaper87/received_events", "type": "User", "site_admin": false}, "committer": {"login": "flaper87", "id": 13816, "node_id": "MDQ6VXNlcjEzODE2", "avatar_url": "https://avatars.githubusercontent.com/u/13816?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flaper87", "html_url": "https://github.com/flaper87", "followers_url": "https://api.github.com/users/flaper87/followers", "following_url": "https://api.github.com/users/flaper87/following{/other_user}", "gists_url": "https://api.github.com/users/flaper87/gists{/gist_id}", "starred_url": "https://api.github.com/users/flaper87/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flaper87/subscriptions", "organizations_url": "https://api.github.com/users/flaper87/orgs", "repos_url": "https://api.github.com/users/flaper87/repos", "events_url": "https://api.github.com/users/flaper87/events{/privacy}", "received_events_url": "https://api.github.com/users/flaper87/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e5f1b9f6dc9418325f83d9766c7cfab30cb48018", "url": "https://api.github.com/repos/rust-lang/rust/commits/e5f1b9f6dc9418325f83d9766c7cfab30cb48018", "html_url": "https://github.com/rust-lang/rust/commit/e5f1b9f6dc9418325f83d9766c7cfab30cb48018"}], "stats": {"total": 44, "additions": 43, "deletions": 1}, "files": [{"sha": "0a5bfdb4ebb9d1e3e9d6d19bf9f6aca5bdb97a1b", "filename": "src/etc/zsh/_rust", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/b78ac5b74a62e7b2772d322004a6bb04967f8437/src%2Fetc%2Fzsh%2F_rust", "raw_url": "https://github.com/rust-lang/rust/raw/b78ac5b74a62e7b2772d322004a6bb04967f8437/src%2Fetc%2Fzsh%2F_rust", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fetc%2Fzsh%2F_rust?ref=b78ac5b74a62e7b2772d322004a6bb04967f8437", "patch": "@@ -36,6 +36,7 @@ _rustc_opts_switches=(\n     --target'[Target triple cpu-manufacturer-kernel\\[-os\\] to compile]'\n     --target-cpu'[Select target processor (llc -mcpu=help for details)]'\n     --target-feature'[Target specific attributes (llc -mattr=help for details)]'\n+    --relocation-model'[Relocation model (llc --help for details)]'\n     {-v,--version}'[Print version info and exit]'\n )\n _rustc_opts_lint=("}, {"sha": "9e9602556d49b500b2982e8d25dbbd5e3de98177", "filename": "src/librustc/back/link.rs", "status": "modified", "additions": 14, "deletions": 1, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/b78ac5b74a62e7b2772d322004a6bb04967f8437/src%2Flibrustc%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b78ac5b74a62e7b2772d322004a6bb04967f8437/src%2Flibrustc%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fback%2Flink.rs?ref=b78ac5b74a62e7b2772d322004a6bb04967f8437", "patch": "@@ -152,13 +152,26 @@ pub mod write {\n                              (sess.targ_cfg.os == abi::OsMacos &&\n                               sess.targ_cfg.arch == abi::X86_64);\n \n+            let reloc_model = match sess.opts.cg.relocation_model.as_slice() {\n+                \"pic\" => lib::llvm::RelocPIC,\n+                \"static\" => lib::llvm::RelocStatic,\n+                \"default\" => lib::llvm::RelocDefault,\n+                \"dynamic-no-pic\" => lib::llvm::RelocDynamicNoPic,\n+                _ => {\n+                    sess.err(format!(\"{} is not a valid relocation mode\",\n+                             sess.opts.cg.relocation_model));\n+                    sess.abort_if_errors();\n+                    return;\n+                }\n+            };\n+\n             let tm = sess.targ_cfg.target_strs.target_triple.with_c_str(|t| {\n                 sess.opts.cg.target_cpu.with_c_str(|cpu| {\n                     target_feature(sess).with_c_str(|features| {\n                         llvm::LLVMRustCreateTargetMachine(\n                             t, cpu, features,\n                             lib::llvm::CodeModelDefault,\n-                            lib::llvm::RelocPIC,\n+                            reloc_model,\n                             opt_level,\n                             true,\n                             use_softfp,"}, {"sha": "80003892301d584bbbd070450f1662989faa97db", "filename": "src/librustc/driver/session.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b78ac5b74a62e7b2772d322004a6bb04967f8437/src%2Flibrustc%2Fdriver%2Fsession.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b78ac5b74a62e7b2772d322004a6bb04967f8437/src%2Flibrustc%2Fdriver%2Fsession.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fdriver%2Fsession.rs?ref=b78ac5b74a62e7b2772d322004a6bb04967f8437", "patch": "@@ -455,6 +455,8 @@ cgoptions!(\n         \"prefer dynamic linking to static linking\"),\n     no_integrated_as: bool = (false, parse_bool,\n         \"use an external assembler rather than LLVM's integrated one\"),\n+    relocation_model: ~str = (~\"pic\", parse_string,\n+         \"choose the relocation model to use (llc -relocation-model for details)\"),\n )\n \n // Seems out of place, but it uses session, so I'm putting it here"}, {"sha": "2fcdd32bfcbd4c54b12d57367017a00f92e57496", "filename": "src/test/run-make/relocation-model/Makefile", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/b78ac5b74a62e7b2772d322004a6bb04967f8437/src%2Ftest%2Frun-make%2Frelocation-model%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/b78ac5b74a62e7b2772d322004a6bb04967f8437/src%2Ftest%2Frun-make%2Frelocation-model%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Frelocation-model%2FMakefile?ref=b78ac5b74a62e7b2772d322004a6bb04967f8437", "patch": "@@ -0,0 +1,15 @@\n+-include ../tools.mk\n+\n+all:\n+\t$(RUSTC) -C relocation-model=dynamic-no-pic foo.rs\n+\t$(call RUN,foo)\n+\n+\t$(RUSTC) -C relocation-model=default foo.rs\n+\t$(call RUN,foo)\n+\n+\t$(RUSTC) -C relocation-model=static foo.rs\n+\t$(call RUN,foo)\n+\n+\t$(RUSTC) -C relocation-model=default --crate-type=dylib foo.rs\n+\t$(RUSTC) -C relocation-model=static --crate-type=dylib foo.rs\n+\t$(RUSTC) -C relocation-model=dynamic-no-pic --crate-type=dylib foo.rs"}, {"sha": "e06d81cd60b6563ccbf9414f0dbf1b370ba260b5", "filename": "src/test/run-make/relocation-model/foo.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/b78ac5b74a62e7b2772d322004a6bb04967f8437/src%2Ftest%2Frun-make%2Frelocation-model%2Ffoo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b78ac5b74a62e7b2772d322004a6bb04967f8437/src%2Ftest%2Frun-make%2Frelocation-model%2Ffoo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Frelocation-model%2Ffoo.rs?ref=b78ac5b74a62e7b2772d322004a6bb04967f8437", "patch": "@@ -0,0 +1,11 @@\n+// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+pub fn main() {}"}]}