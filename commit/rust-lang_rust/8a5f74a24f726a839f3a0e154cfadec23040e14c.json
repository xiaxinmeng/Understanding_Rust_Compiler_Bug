{"sha": "8a5f74a24f726a839f3a0e154cfadec23040e14c", "node_id": "MDY6Q29tbWl0NzI0NzEyOjhhNWY3NGEyNGY3MjZhODM5ZjNhMGUxNTRjZmFkZWMyMzA0MGUxNGM=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-01-11T13:01:48Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-01-11T13:06:22Z"}, "message": "use location link in goto def", "tree": {"sha": "2d21c8b094aa6c7fd10fa541b84413c9609c2c8a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2d21c8b094aa6c7fd10fa541b84413c9609c2c8a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8a5f74a24f726a839f3a0e154cfadec23040e14c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8a5f74a24f726a839f3a0e154cfadec23040e14c", "html_url": "https://github.com/rust-lang/rust/commit/8a5f74a24f726a839f3a0e154cfadec23040e14c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8a5f74a24f726a839f3a0e154cfadec23040e14c/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3aaf20bd6ec75a572b13d020520d4df563a2891c", "url": "https://api.github.com/repos/rust-lang/rust/commits/3aaf20bd6ec75a572b13d020520d4df563a2891c", "html_url": "https://github.com/rust-lang/rust/commit/3aaf20bd6ec75a572b13d020520d4df563a2891c"}], "stats": {"total": 37, "additions": 25, "deletions": 12}, "files": [{"sha": "aad698da1ba11eaef299b8cc9e429a685c757922", "filename": "crates/ra_lsp_server/src/conv.rs", "status": "modified", "additions": 20, "deletions": 8, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/8a5f74a24f726a839f3a0e154cfadec23040e14c/crates%2Fra_lsp_server%2Fsrc%2Fconv.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8a5f74a24f726a839f3a0e154cfadec23040e14c/crates%2Fra_lsp_server%2Fsrc%2Fconv.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Fsrc%2Fconv.rs?ref=8a5f74a24f726a839f3a0e154cfadec23040e14c", "patch": "@@ -1,5 +1,5 @@\n use languageserver_types::{\n-    self, CreateFile, DocumentChangeOperation, DocumentChanges, InsertTextFormat, Location,\n+    self, CreateFile, DocumentChangeOperation, DocumentChanges, InsertTextFormat, Location, LocationLink,\n     Position, Range, RenameFile, ResourceOp, SymbolKind, TextDocumentEdit, TextDocumentIdentifier,\n     TextDocumentItem, TextDocumentPositionParams, Url, VersionedTextDocumentIdentifier,\n     WorkspaceEdit,\n@@ -349,13 +349,25 @@ impl TryConvWith for &NavigationTarget {\n     }\n }\n \n-impl TryConvWith for &RangeInfo<NavigationTarget> {\n-    type Ctx = ServerWorld;\n-    type Output = Location;\n-    fn try_conv_with(self, world: &ServerWorld) -> Result<Location> {\n-        let line_index = world.analysis().file_line_index(self.info.file_id());\n-        to_location(self.info.file_id(), self.info.range(), &world, &line_index)\n-    }\n+pub fn to_location_link(\n+    target: &RangeInfo<NavigationTarget>,\n+    world: &ServerWorld,\n+    // line index for original range file\n+    line_index: &LineIndex,\n+) -> Result<LocationLink> {\n+    let url = target.info.file_id().try_conv_with(world)?;\n+    let tgt_line_index = world.analysis().file_line_index(target.info.file_id());\n+\n+    let res = LocationLink {\n+        origin_selection_range: Some(target.range.conv_with(line_index)),\n+        target_uri: url.to_string(),\n+        target_range: target.info.range().conv_with(&tgt_line_index),\n+        target_selection_range: target\n+            .info\n+            .focus_range()\n+            .map(|it| it.conv_with(&tgt_line_index)),\n+    };\n+    Ok(res)\n }\n \n pub fn to_location("}, {"sha": "aad9d6568f247993bfe3bec55f0934583194b387", "filename": "crates/ra_lsp_server/src/main_loop/handlers.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/8a5f74a24f726a839f3a0e154cfadec23040e14c/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop%2Fhandlers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8a5f74a24f726a839f3a0e154cfadec23040e14c/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop%2Fhandlers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop%2Fhandlers.rs?ref=8a5f74a24f726a839f3a0e154cfadec23040e14c", "patch": "@@ -9,15 +9,15 @@ use languageserver_types::{\n     SignatureInformation, SymbolInformation, TextDocumentIdentifier, TextEdit, WorkspaceEdit,\n };\n use ra_ide_api::{\n-    FileId, FilePosition, FileRange, FoldKind, Query, RunnableKind, Severity, SourceChange, RangeInfo,\n+    FileId, FilePosition, FileRange, FoldKind, Query, RunnableKind, Severity, RangeInfo,\n };\n use ra_syntax::{TextUnit, AstNode};\n use rustc_hash::FxHashMap;\n use serde_json::to_value;\n use std::io::Write;\n \n use crate::{\n-    conv::{to_location, Conv, ConvWith, MapConvWith, TryConvWith},\n+    conv::{to_location, to_location_link, Conv, ConvWith, MapConvWith, TryConvWith},\n     project_model::TargetKind,\n     req::{self, Decoration},\n     server_world::ServerWorld,\n@@ -208,6 +208,7 @@ pub fn handle_goto_definition(\n     params: req::TextDocumentPositionParams,\n ) -> Result<Option<req::GotoDefinitionResponse>> {\n     let position = params.try_conv_with(&world)?;\n+    let line_index = world.analysis().file_line_index(position.file_id);\n     let nav_info = match world.analysis().goto_definition(position)? {\n         None => return Ok(None),\n         Some(it) => it,\n@@ -217,9 +218,9 @@ pub fn handle_goto_definition(\n         .info\n         .into_iter()\n         .map(|nav| RangeInfo::new(nav_range, nav))\n-        .map(|nav| nav.try_conv_with(&world))\n+        .map(|nav| to_location_link(&nav, &world, &line_index))\n         .collect::<Result<Vec<_>>>()?;\n-    Ok(Some(req::GotoDefinitionResponse::Array(res)))\n+    Ok(Some(req::GotoDefinitionResponse::Link(res)))\n }\n \n pub fn handle_parent_module("}]}