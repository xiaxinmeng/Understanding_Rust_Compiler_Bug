{"sha": "890a44f66b355d40a284349a22ac82aea82f0520", "node_id": "C_kwDOAAsO6NoAKDg5MGE0NGY2NmIzNTVkNDBhMjg0MzQ5YTIyYWM4MmFlYTgyZjA1MjA", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-03-06T23:56:29Z"}, "committer": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-03-06T23:58:35Z"}, "message": "Fix rustdoc for GATs with with anonymous bound regions", "tree": {"sha": "4a1f52d879eee288d38c130d9fd76428fe4b3471", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4a1f52d879eee288d38c130d9fd76428fe4b3471"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/890a44f66b355d40a284349a22ac82aea82f0520", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/890a44f66b355d40a284349a22ac82aea82f0520", "html_url": "https://github.com/rust-lang/rust/commit/890a44f66b355d40a284349a22ac82aea82f0520", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/890a44f66b355d40a284349a22ac82aea82f0520/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c38b8a8c621e0c946af1b74f57bb8cc028e0060d", "url": "https://api.github.com/repos/rust-lang/rust/commits/c38b8a8c621e0c946af1b74f57bb8cc028e0060d", "html_url": "https://github.com/rust-lang/rust/commit/c38b8a8c621e0c946af1b74f57bb8cc028e0060d"}], "stats": {"total": 75, "additions": 40, "deletions": 35}, "files": [{"sha": "eba31a17cf4c32af8553d41dce715608f86cc36f", "filename": "src/librustdoc/clean/mod.rs", "status": "modified", "additions": 2, "deletions": 15, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/890a44f66b355d40a284349a22ac82aea82f0520/src%2Flibrustdoc%2Fclean%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/890a44f66b355d40a284349a22ac82aea82f0520/src%2Flibrustdoc%2Fclean%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Fmod.rs?ref=890a44f66b355d40a284349a22ac82aea82f0520", "patch": "@@ -402,16 +402,7 @@ fn projection_to_path_segment(ty: ty::ProjectionTy<'_>, cx: &mut DocContext<'_>)\n     PathSegment {\n         name: item.name,\n         args: GenericArgs::AngleBracketed {\n-            args: ty.substs[generics.parent_count..]\n-                .iter()\n-                .map(|ty| match ty.unpack() {\n-                    ty::subst::GenericArgKind::Lifetime(lt) => {\n-                        GenericArg::Lifetime(lt.clean(cx).unwrap())\n-                    }\n-                    ty::subst::GenericArgKind::Type(ty) => GenericArg::Type(ty.clean(cx)),\n-                    ty::subst::GenericArgKind::Const(c) => GenericArg::Const(Box::new(c.clean(cx))),\n-                })\n-                .collect(),\n+            args: substs_to_args(cx, &ty.substs[generics.parent_count..], false),\n             bindings: Default::default(),\n         },\n     }\n@@ -1379,11 +1370,7 @@ fn maybe_expand_private_type_alias(cx: &mut DocContext<'_>, path: &hir::Path<'_>\n                 });\n                 if let Some(lt) = lifetime.cloned() {\n                     let lt_def_id = cx.tcx.hir().local_def_id(param.hir_id);\n-                    let cleaned = if !lt.is_elided() {\n-                        lt.clean(cx)\n-                    } else {\n-                        self::types::Lifetime::elided()\n-                    };\n+                    let cleaned = if !lt.is_elided() { lt.clean(cx) } else { Lifetime::elided() };\n                     substs.insert(lt_def_id.to_def_id(), SubstParam::Lifetime(cleaned));\n                 }\n                 indices.lifetimes += 1;"}, {"sha": "7861b915e9627668edd0e9be6f388f4270f229b7", "filename": "src/librustdoc/clean/utils.rs", "status": "modified", "additions": 25, "deletions": 20, "changes": 45, "blob_url": "https://github.com/rust-lang/rust/blob/890a44f66b355d40a284349a22ac82aea82f0520/src%2Flibrustdoc%2Fclean%2Futils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/890a44f66b355d40a284349a22ac82aea82f0520/src%2Flibrustdoc%2Fclean%2Futils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Futils.rs?ref=890a44f66b355d40a284349a22ac82aea82f0520", "patch": "@@ -77,16 +77,12 @@ crate fn krate(cx: &mut DocContext<'_>) -> Crate {\n     Crate { module, primitives, external_traits: cx.external_traits.clone() }\n }\n \n-fn external_generic_args(\n+crate fn substs_to_args(\n     cx: &mut DocContext<'_>,\n-    did: DefId,\n-    has_self: bool,\n-    bindings: Vec<TypeBinding>,\n-    substs: SubstsRef<'_>,\n-) -> GenericArgs {\n-    let mut skip_self = has_self;\n-    let mut ty_kind = None;\n-    let args: Vec<_> = substs\n+    substs: &[ty::subst::GenericArg<'_>],\n+    mut skip_first: bool,\n+) -> Vec<GenericArg> {\n+    substs\n         .iter()\n         .filter_map(|kind| match kind.unpack() {\n             GenericArgKind::Lifetime(lt) => match *lt {\n@@ -95,23 +91,32 @@ fn external_generic_args(\n                 }\n                 _ => lt.clean(cx).map(GenericArg::Lifetime),\n             },\n-            GenericArgKind::Type(_) if skip_self => {\n-                skip_self = false;\n+            GenericArgKind::Type(_) if skip_first => {\n+                skip_first = false;\n                 None\n             }\n-            GenericArgKind::Type(ty) => {\n-                ty_kind = Some(ty.kind());\n-                Some(GenericArg::Type(ty.clean(cx)))\n-            }\n+            GenericArgKind::Type(ty) => Some(GenericArg::Type(ty.clean(cx))),\n             GenericArgKind::Const(ct) => Some(GenericArg::Const(Box::new(ct.clean(cx)))),\n         })\n-        .collect();\n+        .collect()\n+}\n+\n+fn external_generic_args(\n+    cx: &mut DocContext<'_>,\n+    did: DefId,\n+    has_self: bool,\n+    bindings: Vec<TypeBinding>,\n+    substs: SubstsRef<'_>,\n+) -> GenericArgs {\n+    let args = substs_to_args(cx, &substs, has_self);\n \n     if cx.tcx.fn_trait_kind_from_lang_item(did).is_some() {\n-        let inputs = match ty_kind.unwrap() {\n-            ty::Tuple(tys) => tys.iter().map(|t| t.clean(cx)).collect(),\n-            _ => return GenericArgs::AngleBracketed { args, bindings: bindings.into() },\n-        };\n+        let inputs =\n+            // The trait's first substitution is the one after self, if there is one.\n+            match substs.iter().nth(if has_self { 1 } else { 0 }).unwrap().expect_ty().kind() {\n+                ty::Tuple(tys) => tys.iter().map(|t| t.clean(cx)).collect(),\n+                _ => return GenericArgs::AngleBracketed { args, bindings: bindings.into() },\n+            };\n         let output = None;\n         // FIXME(#20299) return type comes from a projection now\n         // match types[1].kind {"}, {"sha": "38ecf5283108f047462a5832192b6001e4689b30", "filename": "src/test/rustdoc/generic-associated-types/issue-94683.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/890a44f66b355d40a284349a22ac82aea82f0520/src%2Ftest%2Frustdoc%2Fgeneric-associated-types%2Fissue-94683.rs", "raw_url": "https://github.com/rust-lang/rust/raw/890a44f66b355d40a284349a22ac82aea82f0520/src%2Ftest%2Frustdoc%2Fgeneric-associated-types%2Fissue-94683.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fgeneric-associated-types%2Fissue-94683.rs?ref=890a44f66b355d40a284349a22ac82aea82f0520", "patch": "@@ -0,0 +1,13 @@\n+#![crate_name = \"foo\"]\n+#![feature(generic_associated_types)]\n+\n+pub trait Trait {\n+    type Gat<'a>;\n+}\n+\n+// Make sure that the elided lifetime shows up\n+\n+// @has foo/type.T.html\n+// @has - \"pub type T = \"\n+// @has - \"&lt;'_&gt;\"\n+pub type T = fn(&<() as Trait>::Gat<'_>);"}]}