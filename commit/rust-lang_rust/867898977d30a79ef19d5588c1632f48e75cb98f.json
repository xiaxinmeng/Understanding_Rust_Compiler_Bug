{"sha": "867898977d30a79ef19d5588c1632f48e75cb98f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg2Nzg5ODk3N2QzMGE3OWVmMTlkNTU4OGMxNjMyZjQ4ZTc1Y2I5OGY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-04-24T06:51:30Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-04-24T06:51:30Z"}, "message": "auto merge of #12812 : sfackler/rust/attr-arm, r=alexcrichton\n\nThis is really only useful for #[cfg()]. For example:\r\n\r\n```rust\r\nenum Foo {\r\n    Bar,\r\n    Baz,\r\n    #[cfg(blob)]\r\n    Blob\r\n}\r\n\r\nfn match_foos(f: &Foo) {\r\n    match *f {\r\n        Bar => {}\r\n        Baz => {}\r\n        #[cfg(blob)]\r\n        Blob => {}\r\n    }\r\n}\r\n```\r\n\r\nThis is a kind of weird place to allow attributes, so it should probably\r\nbe discussed before merging.", "tree": {"sha": "fadd42a856cb56ccc07a66920331eb19a5a4d331", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fadd42a856cb56ccc07a66920331eb19a5a4d331"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/867898977d30a79ef19d5588c1632f48e75cb98f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/867898977d30a79ef19d5588c1632f48e75cb98f", "html_url": "https://github.com/rust-lang/rust/commit/867898977d30a79ef19d5588c1632f48e75cb98f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/867898977d30a79ef19d5588c1632f48e75cb98f/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4e1a09844e49a91d0f9dea19561f15d34992d0e8", "url": "https://api.github.com/repos/rust-lang/rust/commits/4e1a09844e49a91d0f9dea19561f15d34992d0e8", "html_url": "https://github.com/rust-lang/rust/commit/4e1a09844e49a91d0f9dea19561f15d34992d0e8"}, {"sha": "1452c9c04a11dd6ad6890b811b411ef80b0c5b6f", "url": "https://api.github.com/repos/rust-lang/rust/commits/1452c9c04a11dd6ad6890b811b411ef80b0c5b6f", "html_url": "https://github.com/rust-lang/rust/commit/1452c9c04a11dd6ad6890b811b411ef80b0c5b6f"}], "stats": {"total": 69, "additions": 66, "deletions": 3}, "files": [{"sha": "8dcc97c936cbbbb53cc5d08ab226bfb7251b7640", "filename": "src/librustc/front/config.rs", "status": "modified", "additions": 22, "deletions": 1, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/867898977d30a79ef19d5588c1632f48e75cb98f/src%2Flibrustc%2Ffront%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/867898977d30a79ef19d5588c1632f48e75cb98f/src%2Flibrustc%2Ffront%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ffront%2Fconfig.rs?ref=867898977d30a79ef19d5588c1632f48e75cb98f", "patch": "@@ -1,4 +1,4 @@\n-// Copyright 2012 The Rust Project Developers. See the COPYRIGHT\n+// Copyright 2012-2014 The Rust Project Developers. See the COPYRIGHT\n // file at the top-level directory of this distribution and at\n // http://rust-lang.org/COPYRIGHT.\n //\n@@ -36,6 +36,9 @@ impl<'a> fold::Folder for Context<'a> {\n     fn fold_item_underscore(&mut self, item: &ast::Item_) -> ast::Item_ {\n         fold_item_underscore(self, item)\n     }\n+    fn fold_expr(&mut self, expr: @ast::Expr) -> @ast::Expr {\n+        fold_expr(self, expr)\n+    }\n }\n \n pub fn strip_items(krate: ast::Crate,\n@@ -189,6 +192,24 @@ fn fold_block(cx: &mut Context, b: ast::P<ast::Block>) -> ast::P<ast::Block> {\n     })\n }\n \n+fn fold_expr(cx: &mut Context, expr: @ast::Expr) -> @ast::Expr {\n+    let expr = match expr.node {\n+        ast::ExprMatch(ref m, ref arms) => {\n+            let arms = arms.iter()\n+                .filter(|a| (cx.in_cfg)(a.attrs.as_slice()))\n+                .map(|a| a.clone())\n+                .collect();\n+            @ast::Expr {\n+                id: expr.id,\n+                span: expr.span.clone(),\n+                node: ast::ExprMatch(m.clone(), arms),\n+            }\n+        }\n+        _ => expr.clone()\n+    };\n+    fold::noop_fold_expr(expr, cx)\n+}\n+\n fn item_in_cfg(cx: &mut Context, item: &ast::Item) -> bool {\n     return (cx.in_cfg)(item.attrs.as_slice());\n }"}, {"sha": "4a93fed8d039b823847e690619a66bb56a44710c", "filename": "src/libsyntax/ast.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/867898977d30a79ef19d5588c1632f48e75cb98f/src%2Flibsyntax%2Fast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/867898977d30a79ef19d5588c1632f48e75cb98f/src%2Flibsyntax%2Fast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fast.rs?ref=867898977d30a79ef19d5588c1632f48e75cb98f", "patch": "@@ -440,6 +440,7 @@ pub enum Decl_ {\n \n #[deriving(Clone, Eq, TotalEq, Encodable, Decodable, Hash)]\n pub struct Arm {\n+    pub attrs: Vec<Attribute>,\n     pub pats: Vec<@Pat>,\n     pub guard: Option<@Expr>,\n     pub body: @Expr,"}, {"sha": "b0dbd8b635ac6f0b26ca830690e8038f18a8dd44", "filename": "src/libsyntax/ext/build.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/867898977d30a79ef19d5588c1632f48e75cb98f/src%2Flibsyntax%2Fext%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/867898977d30a79ef19d5588c1632f48e75cb98f/src%2Flibsyntax%2Fext%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fbuild.rs?ref=867898977d30a79ef19d5588c1632f48e75cb98f", "patch": "@@ -726,6 +726,7 @@ impl<'a> AstBuilder for ExtCtxt<'a> {\n \n     fn arm(&self, _span: Span, pats: Vec<@ast::Pat> , expr: @ast::Expr) -> ast::Arm {\n         ast::Arm {\n+            attrs: vec!(),\n             pats: pats,\n             guard: None,\n             body: expr"}, {"sha": "9978a2edce9c120144c5fcbaf05c435e186d6541", "filename": "src/libsyntax/ext/deriving/primitive.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/867898977d30a79ef19d5588c1632f48e75cb98f/src%2Flibsyntax%2Fext%2Fderiving%2Fprimitive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/867898977d30a79ef19d5588c1632f48e75cb98f/src%2Flibsyntax%2Fext%2Fderiving%2Fprimitive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fderiving%2Fprimitive.rs?ref=867898977d30a79ef19d5588c1632f48e75cb98f", "patch": "@@ -112,6 +112,7 @@ fn cs_from(name: &str, cx: &mut ExtCtxt, trait_span: Span, substr: &Substructure\n \n                         // arm for `_ if $guard => $body`\n                         let arm = ast::Arm {\n+                            attrs: vec!(),\n                             pats: vec!(cx.pat_wild(span)),\n                             guard: Some(guard),\n                             body: body,\n@@ -131,6 +132,7 @@ fn cs_from(name: &str, cx: &mut ExtCtxt, trait_span: Span, substr: &Substructure\n \n             // arm for `_ => None`\n             let arm = ast::Arm {\n+                attrs: vec!(),\n                 pats: vec!(cx.pat_wild(trait_span)),\n                 guard: None,\n                 body: cx.expr_none(trait_span),"}, {"sha": "9f05db5f807c4f1cd0a0147efc2413f8fdcfcb16", "filename": "src/libsyntax/fold.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/867898977d30a79ef19d5588c1632f48e75cb98f/src%2Flibsyntax%2Ffold.rs", "raw_url": "https://github.com/rust-lang/rust/raw/867898977d30a79ef19d5588c1632f48e75cb98f/src%2Flibsyntax%2Ffold.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Ffold.rs?ref=867898977d30a79ef19d5588c1632f48e75cb98f", "patch": "@@ -119,6 +119,7 @@ pub trait Folder {\n \n     fn fold_arm(&mut self, a: &Arm) -> Arm {\n         Arm {\n+            attrs: a.attrs.iter().map(|x| fold_attribute_(*x, self)).collect(),\n             pats: a.pats.iter().map(|x| self.fold_pat(*x)).collect(),\n             guard: a.guard.map(|x| self.fold_expr(x)),\n             body: self.fold_expr(a.body),"}, {"sha": "f30d756d854f458b42cc24f71f6af47e041a77a9", "filename": "src/libsyntax/parse/parser.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/867898977d30a79ef19d5588c1632f48e75cb98f/src%2Flibsyntax%2Fparse%2Fparser.rs", "raw_url": "https://github.com/rust-lang/rust/raw/867898977d30a79ef19d5588c1632f48e75cb98f/src%2Flibsyntax%2Fparse%2Fparser.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fparse%2Fparser.rs?ref=867898977d30a79ef19d5588c1632f48e75cb98f", "patch": "@@ -2539,6 +2539,7 @@ impl<'a> Parser<'a> {\n         self.commit_expr_expecting(discriminant, token::LBRACE);\n         let mut arms: Vec<Arm> = Vec::new();\n         while self.token != token::RBRACE {\n+            let attrs = self.parse_outer_attributes();\n             let pats = self.parse_pats();\n             let mut guard = None;\n             if self.eat_keyword(keywords::If) {\n@@ -2557,7 +2558,12 @@ impl<'a> Parser<'a> {\n                 self.eat(&token::COMMA);\n             }\n \n-            arms.push(ast::Arm { pats: pats, guard: guard, body: expr });\n+            arms.push(ast::Arm {\n+                attrs: attrs,\n+                pats: pats,\n+                guard: guard,\n+                body: expr\n+            });\n         }\n         let hi = self.span.hi;\n         self.bump();"}, {"sha": "b0130f127a3816fb52338a05835202fad3cf8f92", "filename": "src/libsyntax/print/pprust.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/867898977d30a79ef19d5588c1632f48e75cb98f/src%2Flibsyntax%2Fprint%2Fpprust.rs", "raw_url": "https://github.com/rust-lang/rust/raw/867898977d30a79ef19d5588c1632f48e75cb98f/src%2Flibsyntax%2Fprint%2Fpprust.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fprint%2Fpprust.rs?ref=867898977d30a79ef19d5588c1632f48e75cb98f", "patch": "@@ -1286,9 +1286,14 @@ impl<'a> State<'a> {\n                 try!(self.bopen());\n                 let len = arms.len();\n                 for (i, arm) in arms.iter().enumerate() {\n-                    try!(space(&mut self.s));\n+                    // I have no idea why this check is necessary, but here it\n+                    // is :(\n+                    if arm.attrs.is_empty() {\n+                        try!(space(&mut self.s));\n+                    }\n                     try!(self.cbox(indent_unit));\n                     try!(self.ibox(0u));\n+                    try!(self.print_outer_attributes(arm.attrs.as_slice()));\n                     let mut first = true;\n                     for p in arm.pats.iter() {\n                         if first {"}, {"sha": "9858b804b7b3a2c1b9583bd408e39ee10c4c081b", "filename": "src/test/run-pass/cfg-match-arm.rs", "status": "added", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/867898977d30a79ef19d5588c1632f48e75cb98f/src%2Ftest%2Frun-pass%2Fcfg-match-arm.rs", "raw_url": "https://github.com/rust-lang/rust/raw/867898977d30a79ef19d5588c1632f48e75cb98f/src%2Ftest%2Frun-pass%2Fcfg-match-arm.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fcfg-match-arm.rs?ref=867898977d30a79ef19d5588c1632f48e75cb98f", "patch": "@@ -0,0 +1,26 @@\n+// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+enum Foo {\n+    Bar,\n+    Baz,\n+}\n+\n+fn foo(f: Foo) {\n+    match f {\n+        Bar => {},\n+        #[cfg(not(asdfa))]\n+        Baz => {},\n+        #[cfg(afsd)]\n+        Basdfwe => {}\n+    }\n+}\n+\n+pub fn main() {}"}]}