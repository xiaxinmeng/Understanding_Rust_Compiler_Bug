{"sha": "20010d759718ade4ae33a173539ff808854ac269", "node_id": "C_kwDOAAsO6NoAKDIwMDEwZDc1OTcxOGFkZTRhZTMzYTE3MzUzOWZmODA4ODU0YWMyNjk", "commit": {"author": {"name": "Michael Howell", "email": "michael@notriddle.com", "date": "2022-05-06T00:20:14Z"}, "committer": {"name": "Michael Howell", "email": "michael@notriddle.com", "date": "2022-05-06T00:45:33Z"}, "message": "rustdoc: ensure HTML/JS side implementors don't have dups", "tree": {"sha": "44b586266b227355c32a3469a7a10d1751eee86e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/44b586266b227355c32a3469a7a10d1751eee86e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/20010d759718ade4ae33a173539ff808854ac269", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/20010d759718ade4ae33a173539ff808854ac269", "html_url": "https://github.com/rust-lang/rust/commit/20010d759718ade4ae33a173539ff808854ac269", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/20010d759718ade4ae33a173539ff808854ac269/comments", "author": {"login": "notriddle", "id": 1593513, "node_id": "MDQ6VXNlcjE1OTM1MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1593513?v=4", "gravatar_id": "", "url": "https://api.github.com/users/notriddle", "html_url": "https://github.com/notriddle", "followers_url": "https://api.github.com/users/notriddle/followers", "following_url": "https://api.github.com/users/notriddle/following{/other_user}", "gists_url": "https://api.github.com/users/notriddle/gists{/gist_id}", "starred_url": "https://api.github.com/users/notriddle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/notriddle/subscriptions", "organizations_url": "https://api.github.com/users/notriddle/orgs", "repos_url": "https://api.github.com/users/notriddle/repos", "events_url": "https://api.github.com/users/notriddle/events{/privacy}", "received_events_url": "https://api.github.com/users/notriddle/received_events", "type": "User", "site_admin": false}, "committer": {"login": "notriddle", "id": 1593513, "node_id": "MDQ6VXNlcjE1OTM1MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1593513?v=4", "gravatar_id": "", "url": "https://api.github.com/users/notriddle", "html_url": "https://github.com/notriddle", "followers_url": "https://api.github.com/users/notriddle/followers", "following_url": "https://api.github.com/users/notriddle/following{/other_user}", "gists_url": "https://api.github.com/users/notriddle/gists{/gist_id}", "starred_url": "https://api.github.com/users/notriddle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/notriddle/subscriptions", "organizations_url": "https://api.github.com/users/notriddle/orgs", "repos_url": "https://api.github.com/users/notriddle/repos", "events_url": "https://api.github.com/users/notriddle/events{/privacy}", "received_events_url": "https://api.github.com/users/notriddle/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a7d6768e3b60209d4195c822ea3247482909b604", "url": "https://api.github.com/repos/rust-lang/rust/commits/a7d6768e3b60209d4195c822ea3247482909b604", "html_url": "https://github.com/rust-lang/rust/commit/a7d6768e3b60209d4195c822ea3247482909b604"}], "stats": {"total": 142, "additions": 126, "deletions": 16}, "files": [{"sha": "b6ac687731e49e2cc59ec3a1d7870cda5e97ded4", "filename": "src/librustdoc/html/render/print_item.rs", "status": "modified", "additions": 90, "deletions": 12, "changes": 102, "blob_url": "https://github.com/rust-lang/rust/blob/20010d759718ade4ae33a173539ff808854ac269/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs", "raw_url": "https://github.com/rust-lang/rust/raw/20010d759718ade4ae33a173539ff808854ac269/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs?ref=20010d759718ade4ae33a173539ff808854ac269", "patch": "@@ -3,7 +3,7 @@ use clean::AttributesExt;\n use std::cmp::Ordering;\n use std::fmt;\n \n-use rustc_data_structures::fx::FxHashMap;\n+use rustc_data_structures::fx::{FxHashMap, FxHashSet};\n use rustc_hir as hir;\n use rustc_hir::def::CtorKind;\n use rustc_hir::def_id::DefId;\n@@ -790,16 +790,18 @@ fn item_trait(w: &mut Buffer, cx: &Context<'_>, it: &clean::Item, t: &clean::Tra\n     render_assoc_items(w, cx, it, it.item_id.expect_def_id(), AssocItemRender::All);\n \n     let cache = cx.cache();\n+    let mut extern_crates = FxHashSet::default();\n     if let Some(implementors) = cache.implementors.get(&it.item_id.expect_def_id()) {\n         // The DefId is for the first Type found with that name. The bool is\n         // if any Types with the same name but different DefId have been found.\n         let mut implementor_dups: FxHashMap<Symbol, (DefId, bool)> = FxHashMap::default();\n         for implementor in implementors {\n-            match implementor.inner_impl().for_ {\n-                clean::Type::Path { ref path }\n-                | clean::BorrowedRef { type_: box clean::Type::Path { ref path }, .. }\n-                    if !path.is_assoc_ty() =>\n-                {\n+            if let Some(did) = implementor.inner_impl().for_.without_borrowed_ref().def_id(cx.cache()) &&\n+                !did.is_local() {\n+                extern_crates.insert(did.krate);\n+            }\n+            match implementor.inner_impl().for_.without_borrowed_ref() {\n+                clean::Type::Path { ref path } if !path.is_assoc_ty() => {\n                     let did = path.def_id();\n                     let &mut (prev_did, ref mut has_duplicates) =\n                         implementor_dups.entry(path.last()).or_insert((did, false));\n@@ -898,20 +900,96 @@ fn item_trait(w: &mut Buffer, cx: &Context<'_>, it: &clean::Item, t: &clean::Tra\n         }\n     }\n \n+    // Include implementors in crates that depend on the current crate.\n+    //\n+    // This is complicated by the way rustdoc is invoked, which is basically\n+    // the same way rustc is invoked: it gets called, one at a time, for each\n+    // crate. When building the rustdocs for the current crate, rustdoc can\n+    // see crate metadata for its dependencies, but cannot see metadata for its\n+    // dependents.\n+    //\n+    // To make this work, we generate a \"hook\" at this stage, and our\n+    // dependents can \"plug in\" to it when they build. For simplicity's sake,\n+    // it's [JSONP]: a JavaScript file with the data we need (and can parse),\n+    // surrounded by a tiny wrapper that the Rust side ignores, but allows the\n+    // JavaScript side to include without having to worry about Same Origin\n+    // Policy. The code for *that* is in `write_shared.rs`.\n+    //\n+    // This is further complicated by `#[doc(inline)]`. We want all copies\n+    // of an inlined trait to reference the same JS file, to address complex\n+    // dependency graphs like this one (lower crates depend on higher crates):\n+    //\n+    // ```text\n+    //  --------------------------------------------\n+    //  |            crate A: trait Foo            |\n+    //  --------------------------------------------\n+    //      |                               |\n+    //  --------------------------------    |\n+    //  | crate B: impl A::Foo for Bar |    |\n+    //  --------------------------------    |\n+    //      |                               |\n+    //  ---------------------------------------------\n+    //  | crate C: #[doc(inline)] use A::Foo as Baz |\n+    //  |          impl Baz for Quux                |\n+    //  ---------------------------------------------\n+    // ```\n+    //\n+    // Basically, we want `C::Baz` and `A::Foo` to show the same set of\n+    // impls, which is easier if they both treat `/implementors/A/trait.Foo.js`\n+    // as the Single Source of Truth.\n+    //\n+    // We also want the `impl Baz for Quux` to be written to\n+    // `trait.Foo.js`. However, when we generate plain HTML for `C::Baz`,\n+    // we're going to want to generate plain HTML for `impl Baz for Quux` too,\n+    // because that'll load faster, and it's better for SEO. And we don't want\n+    // the same impl to show up twice on the same page.\n+    //\n+    // To make this work, the implementors JS file has a structure kinda\n+    // like this:\n+    //\n+    // ```js\n+    // JSONP({\n+    // \"B\": {\"impl A::Foo for Bar\"},\n+    // \"C\": {\"impl Baz for Quux\"},\n+    // });\n+    // ```\n+    //\n+    // First of all, this means we can rebuild a crate, and it'll replace its own\n+    // data if something changes. That is, `rustdoc` is idempotent. The other\n+    // advantage is that we can list the crates that get included in the HTML,\n+    // and ignore them when doing the JavaScript-based part of rendering.\n+    // So C's HTML will have something like this:\n+    //\n+    // ```html\n+    // <script type=\"text/javascript\" src=\"/implementors/A/trait.Foo.js\"\n+    //     data-ignore-extern-crates=\"A,B\" async></script>\n+    // ```\n+    //\n+    // And, when the JS runs, anything in data-ignore-extern-crates is known\n+    // to already be in the HTML, and will be ignored.\n+    //\n+    // [JSONP]: https://en.wikipedia.org/wiki/JSONP\n     let mut js_src_path: UrlPartsBuilder = std::iter::repeat(\"..\")\n         .take(cx.current.len())\n         .chain(std::iter::once(\"implementors\"))\n         .collect();\n-    if it.item_id.is_local() {\n-        js_src_path.extend(cx.current.iter().copied());\n+    if let Some(did) = it.item_id.as_def_id() &&\n+        let get_extern = { || cache.external_paths.get(&did).map(|s| s.0.clone()) } &&\n+        let Some(fqp) = cache.exact_paths.get(&did).cloned().or_else(get_extern) {\n+        js_src_path.extend(fqp[..fqp.len() - 1].iter().copied());\n+        js_src_path.push_fmt(format_args!(\"{}.{}.js\", it.type_(), fqp.last().unwrap()));\n     } else {\n-        let (ref path, _) = cache.external_paths[&it.item_id.expect_def_id()];\n-        js_src_path.extend(path[..path.len() - 1].iter().copied());\n+        js_src_path.extend(cx.current.iter().copied());\n+        js_src_path.push_fmt(format_args!(\"{}.{}.js\", it.type_(), it.name.unwrap()));\n     }\n-    js_src_path.push_fmt(format_args!(\"{}.{}.js\", it.type_(), it.name.unwrap()));\n+    let extern_crates = extern_crates\n+        .into_iter()\n+        .map(|cnum| cx.shared.tcx.crate_name(cnum).to_string())\n+        .collect::<Vec<_>>()\n+        .join(\",\");\n     write!(\n         w,\n-        \"<script type=\\\"text/javascript\\\" src=\\\"{src}\\\" async></script>\",\n+        \"<script type=\\\"text/javascript\\\" src=\\\"{src}\\\" data-ignore-extern-crates=\\\"{extern_crates}\\\" async></script>\",\n         src = js_src_path.finish(),\n     );\n }"}, {"sha": "e8e5fa17993337ddbaf0b0684de78e8d34cad61f", "filename": "src/librustdoc/html/render/write_shared.rs", "status": "modified", "additions": 6, "deletions": 3, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/20010d759718ade4ae33a173539ff808854ac269/src%2Flibrustdoc%2Fhtml%2Frender%2Fwrite_shared.rs", "raw_url": "https://github.com/rust-lang/rust/raw/20010d759718ade4ae33a173539ff808854ac269/src%2Flibrustdoc%2Fhtml%2Frender%2Fwrite_shared.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fwrite_shared.rs?ref=20010d759718ade4ae33a173539ff808854ac269", "patch": "@@ -501,10 +501,13 @@ pub(super) fn write_shared(\n         //\n         // FIXME: this is a vague explanation for why this can't be a `get`, in\n         //        theory it should be...\n-        let &(ref remote_path, remote_item_type) = match cache.paths.get(&did) {\n-            Some(p) => p,\n+        let (remote_path, remote_item_type) = match cache.exact_paths.get(&did) {\n+            Some(p) => match cache.paths.get(&did).or_else(|| cache.external_paths.get(&did)) {\n+                Some((_, t)) => (p, t),\n+                None => continue,\n+            },\n             None => match cache.external_paths.get(&did) {\n-                Some(p) => p,\n+                Some((p, t)) => (p, t),\n                 None => continue,\n             },\n         };"}, {"sha": "272b129362dff9a3bb4fad0af8877d7375518bb2", "filename": "src/librustdoc/html/static/js/main.js", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/20010d759718ade4ae33a173539ff808854ac269/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fmain.js", "raw_url": "https://github.com/rust-lang/rust/raw/20010d759718ade4ae33a173539ff808854ac269/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fmain.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fmain.js?ref=20010d759718ade4ae33a173539ff808854ac269", "patch": "@@ -756,8 +756,14 @@ function loadCss(cssFileName) {\n         const traitName = document.querySelector(\"h1.fqn > .in-band > .trait\").textContent;\n         const baseIdName = \"impl-\" + traitName + \"-\";\n         const libs = Object.getOwnPropertyNames(imp);\n+        // We don't want to include impls from this JS file, when the HTML already has them.\n+        // The current crate should always be ignored. Other crates that should also be\n+        // ignored are included in the attribute `data-ignore-extern-crates`.\n+        const ignoreExternCrates = document\n+            .querySelector(\"script[data-ignore-extern-crates]\")\n+            .getAttribute(\"data-ignore-extern-crates\");\n         for (const lib of libs) {\n-            if (lib === window.currentCrate) {\n+            if (lib === window.currentCrate || ignoreExternCrates.indexOf(lib) !== -1) {\n                 continue;\n             }\n             const structs = imp[lib];"}, {"sha": "ccc69cc6bd7a7321bb19730a7b324a88dab36b85", "filename": "src/test/rustdoc-gui/implementors.goml", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/20010d759718ade4ae33a173539ff808854ac269/src%2Ftest%2Frustdoc-gui%2Fimplementors.goml", "raw_url": "https://github.com/rust-lang/rust/raw/20010d759718ade4ae33a173539ff808854ac269/src%2Ftest%2Frustdoc-gui%2Fimplementors.goml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-gui%2Fimplementors.goml?ref=20010d759718ade4ae33a173539ff808854ac269", "patch": "@@ -18,3 +18,10 @@ assert: \"#implementors-list .impl:nth-child(2) > .code-header.in-band\"\n goto: file://|DOC_PATH|/test_docs/struct.HasEmptyTraits.html\n compare-elements-position-near-false: (\"#impl-EmptyTrait1\", \"#impl-EmptyTrait2\", {\"y\": 30})\n compare-elements-position-near: (\"#impl-EmptyTrait3 h3\", \"#impl-EmptyTrait3 .item-info\", {\"y\": 30})\n+\n+// Now check that re-exports work correctly.\n+// There should be exactly one impl shown on both of these pages.\n+goto: file://|DOC_PATH|/lib2/trait.TraitToReexport.html\n+assert-count: (\"#implementors-list .impl\", 1)\n+goto: file://|DOC_PATH|/implementors/trait.TraitToReexport.html\n+assert-count: (\"#implementors-list .impl\", 1)\n\\ No newline at end of file"}, {"sha": "1620e842291915ea8a8ffdc54235b2c75ad1a770", "filename": "src/test/rustdoc-gui/src/lib2/implementors/lib.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/20010d759718ade4ae33a173539ff808854ac269/src%2Ftest%2Frustdoc-gui%2Fsrc%2Flib2%2Fimplementors%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/20010d759718ade4ae33a173539ff808854ac269/src%2Ftest%2Frustdoc-gui%2Fsrc%2Flib2%2Fimplementors%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-gui%2Fsrc%2Flib2%2Fimplementors%2Flib.rs?ref=20010d759718ade4ae33a173539ff808854ac269", "patch": "@@ -9,3 +9,12 @@ pub struct Struct;\n impl Whatever for Struct {\n     type Foo = u8;\n }\n+\n+mod traits {\n+    pub trait TraitToReexport {\n+        fn method() {}\n+    }\n+}\n+\n+#[doc(inline)]\n+pub use traits::TraitToReexport;"}, {"sha": "d06b46f952d0e7cf559b5c7bd4eb11b72ac197bd", "filename": "src/test/rustdoc-gui/src/lib2/lib.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/20010d759718ade4ae33a173539ff808854ac269/src%2Ftest%2Frustdoc-gui%2Fsrc%2Flib2%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/20010d759718ade4ae33a173539ff808854ac269/src%2Ftest%2Frustdoc-gui%2Fsrc%2Flib2%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-gui%2Fsrc%2Flib2%2Flib.rs?ref=20010d759718ade4ae33a173539ff808854ac269", "patch": "@@ -43,6 +43,13 @@ impl implementors::Whatever for Foo {\n     type Foo = u32;\n }\n \n+#[doc(inline)]\n+pub use implementors::TraitToReexport;\n+\n+pub struct StructToImplOnReexport;\n+\n+impl TraitToReexport for StructToImplOnReexport {}\n+\n pub mod sub_mod {\n     /// ```txt\n     /// aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"}]}