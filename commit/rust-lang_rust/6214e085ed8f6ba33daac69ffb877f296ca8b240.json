{"sha": "6214e085ed8f6ba33daac69ffb877f296ca8b240", "node_id": "C_kwDOAAsO6NoAKDYyMTRlMDg1ZWQ4ZjZiYTMzZGFhYzY5ZmZiODc3ZjI5NmNhOGIyNDA", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-09-17T03:04:22Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-09-17T03:04:22Z"}, "message": "Auto merge of #98588 - b-naber:valtrees-cleanup, r=lcnr\n\nUse only ty::Unevaluated<'tcx, ()> in type system\n\nr? `@lcnr`", "tree": {"sha": "e196dce88c560af39685b9afb82ced0c1fd8444e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e196dce88c560af39685b9afb82ced0c1fd8444e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6214e085ed8f6ba33daac69ffb877f296ca8b240", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6214e085ed8f6ba33daac69ffb877f296ca8b240", "html_url": "https://github.com/rust-lang/rust/commit/6214e085ed8f6ba33daac69ffb877f296ca8b240", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6214e085ed8f6ba33daac69ffb877f296ca8b240/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e4d2f94a834f0679d18ae03ef47bddb59a2ac042", "url": "https://api.github.com/repos/rust-lang/rust/commits/e4d2f94a834f0679d18ae03ef47bddb59a2ac042", "html_url": "https://github.com/rust-lang/rust/commit/e4d2f94a834f0679d18ae03ef47bddb59a2ac042"}, {"sha": "d7c77313cb108b8a8fbeb61dffb74adcc36a82ca", "url": "https://api.github.com/repos/rust-lang/rust/commits/d7c77313cb108b8a8fbeb61dffb74adcc36a82ca", "html_url": "https://github.com/rust-lang/rust/commit/d7c77313cb108b8a8fbeb61dffb74adcc36a82ca"}], "stats": {"total": 73, "additions": 31, "deletions": 42}, "files": [{"sha": "6b4ed9b9d4053911b786715c1ef1060495060be8", "filename": "src/constant.rs", "status": "modified", "additions": 31, "deletions": 42, "changes": 73, "blob_url": "https://github.com/rust-lang/rust/blob/6214e085ed8f6ba33daac69ffb877f296ca8b240/src%2Fconstant.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6214e085ed8f6ba33daac69ffb877f296ca8b240/src%2Fconstant.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fconstant.rs?ref=6214e085ed8f6ba33daac69ffb877f296ca8b240", "patch": "@@ -41,36 +41,30 @@ impl ConstantCx {\n pub(crate) fn check_constants(fx: &mut FunctionCx<'_, '_, '_>) -> bool {\n     let mut all_constants_ok = true;\n     for constant in &fx.mir.required_consts {\n-        let const_ = match fx.monomorphize(constant.literal) {\n-            ConstantKind::Ty(ct) => ct,\n+        let unevaluated = match fx.monomorphize(constant.literal) {\n+            ConstantKind::Ty(ct) => match ct.kind() {\n+                ConstKind::Unevaluated(uv) => uv.expand(),\n+                ConstKind::Value(_) => continue,\n+                ConstKind::Param(_)\n+                | ConstKind::Infer(_)\n+                | ConstKind::Bound(_, _)\n+                | ConstKind::Placeholder(_)\n+                | ConstKind::Error(_) => unreachable!(\"{:?}\", ct),\n+            },\n+            ConstantKind::Unevaluated(uv, _) => uv,\n             ConstantKind::Val(..) => continue,\n         };\n-        match const_.kind() {\n-            ConstKind::Value(_) => {}\n-            ConstKind::Unevaluated(unevaluated) => {\n-                if let Err(err) =\n-                    fx.tcx.const_eval_resolve(ParamEnv::reveal_all(), unevaluated, None)\n-                {\n-                    all_constants_ok = false;\n-                    match err {\n-                        ErrorHandled::Reported(_) | ErrorHandled::Linted => {\n-                            fx.tcx.sess.span_err(constant.span, \"erroneous constant encountered\");\n-                        }\n-                        ErrorHandled::TooGeneric => {\n-                            span_bug!(\n-                                constant.span,\n-                                \"codegen encountered polymorphic constant: {:?}\",\n-                                err\n-                            );\n-                        }\n-                    }\n+\n+        if let Err(err) = fx.tcx.const_eval_resolve(ParamEnv::reveal_all(), unevaluated, None) {\n+            all_constants_ok = false;\n+            match err {\n+                ErrorHandled::Reported(_) | ErrorHandled::Linted => {\n+                    fx.tcx.sess.span_err(constant.span, \"erroneous constant encountered\");\n+                }\n+                ErrorHandled::TooGeneric => {\n+                    span_bug!(constant.span, \"codegen encountered polymorphic constant: {:?}\", err);\n                 }\n             }\n-            ConstKind::Param(_)\n-            | ConstKind::Infer(_)\n-            | ConstKind::Bound(_, _)\n-            | ConstKind::Placeholder(_)\n-            | ConstKind::Error(_) => unreachable!(\"{:?}\", const_),\n         }\n     }\n     all_constants_ok\n@@ -122,36 +116,28 @@ pub(crate) fn codegen_constant<'tcx>(\n     fx: &mut FunctionCx<'_, '_, 'tcx>,\n     constant: &Constant<'tcx>,\n ) -> CValue<'tcx> {\n-    let const_ = match fx.monomorphize(constant.literal) {\n-        ConstantKind::Ty(ct) => ct,\n-        ConstantKind::Val(val, ty) => return codegen_const_value(fx, val, ty),\n-    };\n-    let const_val = match const_.kind() {\n-        ConstKind::Value(valtree) => fx.tcx.valtree_to_const_val((const_.ty(), valtree)),\n-        ConstKind::Unevaluated(ty::Unevaluated { def, substs, promoted })\n+    let (const_val, ty) = match fx.monomorphize(constant.literal) {\n+        ConstantKind::Ty(const_) => unreachable!(\"{:?}\", const_),\n+        ConstantKind::Unevaluated(ty::Unevaluated { def, substs, promoted }, ty)\n             if fx.tcx.is_static(def.did) =>\n         {\n             assert!(substs.is_empty());\n             assert!(promoted.is_none());\n \n-            return codegen_static_ref(fx, def.did, fx.layout_of(const_.ty())).to_cvalue(fx);\n+            return codegen_static_ref(fx, def.did, fx.layout_of(ty)).to_cvalue(fx);\n         }\n-        ConstKind::Unevaluated(unevaluated) => {\n+        ConstantKind::Unevaluated(unevaluated, ty) => {\n             match fx.tcx.const_eval_resolve(ParamEnv::reveal_all(), unevaluated, None) {\n-                Ok(const_val) => const_val,\n+                Ok(const_val) => (const_val, ty),\n                 Err(_) => {\n                     span_bug!(constant.span, \"erroneous constant not captured by required_consts\");\n                 }\n             }\n         }\n-        ConstKind::Param(_)\n-        | ConstKind::Infer(_)\n-        | ConstKind::Bound(_, _)\n-        | ConstKind::Placeholder(_)\n-        | ConstKind::Error(_) => unreachable!(\"{:?}\", const_),\n+        ConstantKind::Val(val, ty) => (val, ty),\n     };\n \n-    codegen_const_value(fx, const_val, const_.ty())\n+    codegen_const_value(fx, const_val, ty)\n }\n \n pub(crate) fn codegen_const_value<'tcx>(\n@@ -496,6 +482,9 @@ pub(crate) fn mir_operand_get_const_val<'tcx>(\n                 .eval_for_mir(fx.tcx, ParamEnv::reveal_all())\n                 .try_to_value(fx.tcx),\n             ConstantKind::Val(val, _) => Some(val),\n+            ConstantKind::Unevaluated(uv, _) => {\n+                fx.tcx.const_eval_resolve(ParamEnv::reveal_all(), uv, None).ok()\n+            }\n         },\n         // FIXME(rust-lang/rust#85105): Casts like `IMM8 as u32` result in the const being stored\n         // inside a temporary before being passed to the intrinsic requiring the const argument."}]}