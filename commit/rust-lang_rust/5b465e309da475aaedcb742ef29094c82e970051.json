{"sha": "5b465e309da475aaedcb742ef29094c82e970051", "node_id": "MDY6Q29tbWl0NzI0NzEyOjViNDY1ZTMwOWRhNDc1YWFlZGNiNzQyZWYyOTA5NGM4MmU5NzAwNTE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-07-28T11:37:41Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-07-28T11:37:41Z"}, "message": "Auto merge of #52761 - toidiu:ak-static-infer-fg, r=nikomatsakis\n\nstatic infer feature gate\n\nhttps://github.com/rust-lang/rust/issues/44493\n\nr? @nikomatsakis", "tree": {"sha": "2d8779c94b4e4158c88a82e008b1ed7ca8a2762e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2d8779c94b4e4158c88a82e008b1ed7ca8a2762e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5b465e309da475aaedcb742ef29094c82e970051", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5b465e309da475aaedcb742ef29094c82e970051", "html_url": "https://github.com/rust-lang/rust/commit/5b465e309da475aaedcb742ef29094c82e970051", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5b465e309da475aaedcb742ef29094c82e970051/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cc224282de8de427005103e5c0504cbdf1148694", "url": "https://api.github.com/repos/rust-lang/rust/commits/cc224282de8de427005103e5c0504cbdf1148694", "html_url": "https://github.com/rust-lang/rust/commit/cc224282de8de427005103e5c0504cbdf1148694"}, {"sha": "130e3ab31b28c9839e2f04c98c4b62c6f1c215a3", "url": "https://api.github.com/repos/rust-lang/rust/commits/130e3ab31b28c9839e2f04c98c4b62c6f1c215a3", "html_url": "https://github.com/rust-lang/rust/commit/130e3ab31b28c9839e2f04c98c4b62c6f1c215a3"}], "stats": {"total": 206, "additions": 199, "deletions": 7}, "files": [{"sha": "f50472fb41e31128d1dcb1da186dc66516ecd35f", "filename": "src/doc/unstable-book/src/language-features/infer-static-outlives-requirements.md", "status": "added", "additions": 45, "deletions": 0, "changes": 45, "blob_url": "https://github.com/rust-lang/rust/blob/5b465e309da475aaedcb742ef29094c82e970051/src%2Fdoc%2Funstable-book%2Fsrc%2Flanguage-features%2Finfer-static-outlives-requirements.md", "raw_url": "https://github.com/rust-lang/rust/raw/5b465e309da475aaedcb742ef29094c82e970051/src%2Fdoc%2Funstable-book%2Fsrc%2Flanguage-features%2Finfer-static-outlives-requirements.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Funstable-book%2Fsrc%2Flanguage-features%2Finfer-static-outlives-requirements.md?ref=5b465e309da475aaedcb742ef29094c82e970051", "patch": "@@ -0,0 +1,45 @@\n+# `infer_static_outlives_requirements`\n+\n+The tracking issue for this feature is: [#44493]\n+\n+[#44493]: https://github.com/rust-lang/rust/issues/44493\n+\n+------------------------\n+The `infer_static_outlives_requirements` feature indicates that certain\n+`'static` outlives requirements can be infered by the compiler rather than\n+stating them explicitly.\n+\n+Note: It is an accompanying feature to `infer_outlives_requirements`,\n+which must be enabled to infer outlives requirements.\n+\n+For example, currently generic struct definitions that contain\n+references, require where-clauses of the form T: 'static. By using\n+this feature the outlives predicates will be infered, although\n+they may still be written explicitly.\n+\n+```rust,ignore (pseudo-Rust)\n+struct Foo<U> where U: 'static { // <-- currently required\n+    bar: Bar<U>\n+}\n+struct Bar<T: 'static> {\n+    x: T,\n+}\n+```\n+\n+\n+## Examples:\n+\n+```rust,ignore (pseudo-Rust)\n+#![feature(infer_outlives_requirements)]\n+#![feature(infer_static_outlives_requirements)]\n+\n+#[rustc_outlives]\n+// Implicitly infer U: 'static\n+struct Foo<U> {\n+    bar: Bar<U>\n+}\n+struct Bar<T: 'static> {\n+    x: T,\n+}\n+```\n+"}, {"sha": "0d833c50d7e3b310d51836bcff458d042ee06933", "filename": "src/librustc_typeck/outlives/utils.rs", "status": "modified", "additions": 24, "deletions": 7, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/5b465e309da475aaedcb742ef29094c82e970051/src%2Flibrustc_typeck%2Foutlives%2Futils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5b465e309da475aaedcb742ef29094c82e970051/src%2Flibrustc_typeck%2Foutlives%2Futils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Foutlives%2Futils.rs?ref=5b465e309da475aaedcb742ef29094c82e970051", "patch": "@@ -27,7 +27,7 @@ pub fn insert_outlives_predicate<'tcx>(\n ) {\n     // If the `'a` region is bound within the field type itself, we\n     // don't want to propagate this constraint to the header.\n-    if !is_free_region(outlived_region) {\n+    if !is_free_region(tcx, outlived_region) {\n         return;\n     }\n \n@@ -120,27 +120,44 @@ pub fn insert_outlives_predicate<'tcx>(\n         }\n \n         UnpackedKind::Lifetime(r) => {\n-            if !is_free_region(r) {\n+            if !is_free_region(tcx, r) {\n                 return;\n             }\n             required_predicates.insert(ty::OutlivesPredicate(kind, outlived_region));\n         }\n     }\n }\n \n-fn is_free_region(region: Region<'_>) -> bool {\n+fn is_free_region<'tcx>(tcx: TyCtxt<'_, 'tcx, 'tcx>, region: Region<'_>) -> bool {\n     // First, screen for regions that might appear in a type header.\n     match region {\n-        // *These* correspond to `T: 'a` relationships where `'a` is\n-        // either declared on the type or `'static`:\n+        // These correspond to `T: 'a` relationships:\n         //\n         //     struct Foo<'a, T> {\n         //         field: &'a T, // this would generate a ReEarlyBound referencing `'a`\n-        //         field2: &'static T, // this would generate a ReStatic\n         //     }\n         //\n         // We care about these, so fall through.\n-        RegionKind::ReStatic | RegionKind::ReEarlyBound(_) => true,\n+        RegionKind::ReEarlyBound(_) => true,\n+\n+        // These correspond to `T: 'static` relationships which can be\n+        // rather surprising. We are therefore putting this behind a\n+        // feature flag:\n+        //\n+        //     struct Foo<'a, T> {\n+        //         field: &'static T, // this would generate a ReStatic\n+        //     }\n+        RegionKind::ReStatic => {\n+            if tcx\n+                .sess\n+                .features_untracked()\n+                .infer_static_outlives_requirements\n+            {\n+                true\n+            } else {\n+                false\n+            }\n+        }\n \n         // Late-bound regions can appear in `fn` types:\n         //"}, {"sha": "087fec097191bdb7b5b72cfc56d89122360d5496", "filename": "src/libsyntax/feature_gate.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/5b465e309da475aaedcb742ef29094c82e970051/src%2Flibsyntax%2Ffeature_gate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5b465e309da475aaedcb742ef29094c82e970051/src%2Flibsyntax%2Ffeature_gate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Ffeature_gate.rs?ref=5b465e309da475aaedcb742ef29094c82e970051", "patch": "@@ -396,6 +396,9 @@ declare_features! (\n     // Infer outlives requirements; RFC 2093\n     (active, infer_outlives_requirements, \"1.26.0\", Some(44493), None),\n \n+    // Infer outlives requirements; RFC 2093\n+    (active, infer_static_outlives_requirements, \"1.26.0\", Some(44493), None),\n+\n     // Multiple patterns with `|` in `if let` and `while let`\n     (active, if_while_or_patterns, \"1.26.0\", Some(48215), None),\n \n@@ -1057,6 +1060,12 @@ pub const BUILTIN_ATTRIBUTES: &'static [(&'static str, AttributeType, AttributeG\n                                    \"infer outlives requirements is an experimental feature\",\n                                    cfg_fn!(infer_outlives_requirements))),\n \n+    // RFC #2093\n+    (\"infer_static_outlives_requirements\", Normal, Gated(Stability::Unstable,\n+                                   \"infer_static_outlives_requirements\",\n+                                   \"infer 'static lifetime requirements\",\n+                                   cfg_fn!(infer_static_outlives_requirements))),\n+\n     // RFC 2070\n     (\"panic_implementation\", Normal, Gated(Stability::Unstable,\n                            \"panic_implementation\","}, {"sha": "7b68449859e96e25e4099c578431cd0e8da51f98", "filename": "src/test/ui/feature-gate-infer_static_outlives_requirements.rs", "status": "added", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/5b465e309da475aaedcb742ef29094c82e970051/src%2Ftest%2Fui%2Ffeature-gate-infer_static_outlives_requirements.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5b465e309da475aaedcb742ef29094c82e970051/src%2Ftest%2Fui%2Ffeature-gate-infer_static_outlives_requirements.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffeature-gate-infer_static_outlives_requirements.rs?ref=5b465e309da475aaedcb742ef29094c82e970051", "patch": "@@ -0,0 +1,22 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// Needs an explicit where clause stating outlives condition. (RFC 2093)\n+\n+// Type T needs to outlive lifetime 'static.\n+struct Foo<U> {\n+    bar: Bar<U> //~ ERROR 15:5: 15:16: the parameter type `U` may not live long enough [E0310]\n+}\n+struct Bar<T: 'static> {\n+    x: T,\n+}\n+\n+\n+fn main() { }"}, {"sha": "13022b901a76f0284a81dd0e4ecfdffc846026a1", "filename": "src/test/ui/feature-gate-infer_static_outlives_requirements.stderr", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/5b465e309da475aaedcb742ef29094c82e970051/src%2Ftest%2Fui%2Ffeature-gate-infer_static_outlives_requirements.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/5b465e309da475aaedcb742ef29094c82e970051/src%2Ftest%2Fui%2Ffeature-gate-infer_static_outlives_requirements.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffeature-gate-infer_static_outlives_requirements.stderr?ref=5b465e309da475aaedcb742ef29094c82e970051", "patch": "@@ -0,0 +1,17 @@\n+error[E0310]: the parameter type `U` may not live long enough\n+  --> $DIR/feature-gate-infer_static_outlives_requirements.rs:15:5\n+   |\n+LL | struct Foo<U> {\n+   |            - help: consider adding an explicit lifetime bound `U: 'static`...\n+LL |     bar: Bar<U> //~ ERROR 15:5: 15:16: the parameter type `U` may not live long enough [E0310]\n+   |     ^^^^^^^^^^^\n+   |\n+note: ...so that the type `U` will meet its required lifetime bounds\n+  --> $DIR/feature-gate-infer_static_outlives_requirements.rs:15:5\n+   |\n+LL |     bar: Bar<U> //~ ERROR 15:5: 15:16: the parameter type `U` may not live long enough [E0310]\n+   |     ^^^^^^^^^^^\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0310`."}, {"sha": "72d5127c294dc704cbd32a984e3e8f88a257221c", "filename": "src/test/ui/rfc-2093-infer-outlives/dont-infer-static.rs", "status": "added", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/5b465e309da475aaedcb742ef29094c82e970051/src%2Ftest%2Fui%2Frfc-2093-infer-outlives%2Fdont-infer-static.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5b465e309da475aaedcb742ef29094c82e970051/src%2Ftest%2Fui%2Frfc-2093-infer-outlives%2Fdont-infer-static.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frfc-2093-infer-outlives%2Fdont-infer-static.rs?ref=5b465e309da475aaedcb742ef29094c82e970051", "patch": "@@ -0,0 +1,29 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// ignore-tidy-linelength\n+\n+#![feature(infer_outlives_requirements)]\n+\n+/*\n+ * We don't infer `T: 'static` outlives relationships by default.\n+ * Instead an additional feature gate `infer_static_outlives_requirements`\n+ * is required.\n+ */\n+\n+struct Foo<U> {\n+    bar: Bar<U> //~ ERROR 22:5: 22:16: the parameter type `U` may not live long enough [E0310]\n+}\n+struct Bar<T: 'static> {\n+    x: T,\n+}\n+\n+fn main() {}\n+"}, {"sha": "775ac215e190df8f8d547a0f4f581cac05ca506e", "filename": "src/test/ui/rfc-2093-infer-outlives/dont-infer-static.stderr", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/5b465e309da475aaedcb742ef29094c82e970051/src%2Ftest%2Fui%2Frfc-2093-infer-outlives%2Fdont-infer-static.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/5b465e309da475aaedcb742ef29094c82e970051/src%2Ftest%2Fui%2Frfc-2093-infer-outlives%2Fdont-infer-static.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frfc-2093-infer-outlives%2Fdont-infer-static.stderr?ref=5b465e309da475aaedcb742ef29094c82e970051", "patch": "@@ -0,0 +1,17 @@\n+error[E0310]: the parameter type `U` may not live long enough\n+  --> $DIR/dont-infer-static.rs:22:5\n+   |\n+LL | struct Foo<U> {\n+   |            - help: consider adding an explicit lifetime bound `U: 'static`...\n+LL |     bar: Bar<U> //~ ERROR 22:5: 22:16: the parameter type `U` may not live long enough [E0310]\n+   |     ^^^^^^^^^^^\n+   |\n+note: ...so that the type `U` will meet its required lifetime bounds\n+  --> $DIR/dont-infer-static.rs:22:5\n+   |\n+LL |     bar: Bar<U> //~ ERROR 22:5: 22:16: the parameter type `U` may not live long enough [E0310]\n+   |     ^^^^^^^^^^^\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0310`."}, {"sha": "aeca18c24b3db211e22aaff9ecdd446a6e515f56", "filename": "src/test/ui/rfc-2093-infer-outlives/infer-static.rs", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/5b465e309da475aaedcb742ef29094c82e970051/src%2Ftest%2Fui%2Frfc-2093-infer-outlives%2Finfer-static.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5b465e309da475aaedcb742ef29094c82e970051/src%2Ftest%2Fui%2Frfc-2093-infer-outlives%2Finfer-static.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frfc-2093-infer-outlives%2Finfer-static.rs?ref=5b465e309da475aaedcb742ef29094c82e970051", "patch": "@@ -0,0 +1,24 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![feature(rustc_attrs)]\n+#![feature(infer_outlives_requirements)]\n+#![feature(infer_static_outlives_requirements)]\n+\n+#[rustc_outlives]\n+struct Foo<U> { //~ ERROR 16:1: 18:2: rustc_outlives\n+    bar: Bar<U>\n+}\n+struct Bar<T: 'static> {\n+    x: T,\n+}\n+\n+fn main() {}\n+"}, {"sha": "f167e522df650a29f62c53395af769be864e6997", "filename": "src/test/ui/rfc-2093-infer-outlives/infer-static.stderr", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/5b465e309da475aaedcb742ef29094c82e970051/src%2Ftest%2Fui%2Frfc-2093-infer-outlives%2Finfer-static.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/5b465e309da475aaedcb742ef29094c82e970051/src%2Ftest%2Fui%2Frfc-2093-infer-outlives%2Finfer-static.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frfc-2093-infer-outlives%2Finfer-static.stderr?ref=5b465e309da475aaedcb742ef29094c82e970051", "patch": "@@ -0,0 +1,12 @@\n+error: rustc_outlives\n+  --> $DIR/infer-static.rs:16:1\n+   |\n+LL | / struct Foo<U> { //~ ERROR 16:1: 18:2: rustc_outlives\n+LL | |     bar: Bar<U>\n+LL | | }\n+   | |_^\n+   |\n+   = note: U : 'static\n+\n+error: aborting due to previous error\n+"}]}