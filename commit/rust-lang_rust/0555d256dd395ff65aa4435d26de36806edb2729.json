{"sha": "0555d256dd395ff65aa4435d26de36806edb2729", "node_id": "MDY6Q29tbWl0NzI0NzEyOjA1NTVkMjU2ZGQzOTVmZjY1YWE0NDM1ZDI2ZGUzNjgwNmVkYjI3Mjk=", "commit": {"author": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2017-12-18T06:22:24Z"}, "committer": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2017-12-18T16:55:52Z"}, "message": "Rework expected closure error\n\n* point at def span\n* add label to primary span\n* use `span_label`s instead of `span_note`s", "tree": {"sha": "c1bdbc7fc799c31c2e0a425a56e2c5d08487340e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c1bdbc7fc799c31c2e0a425a56e2c5d08487340e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0555d256dd395ff65aa4435d26de36806edb2729", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0555d256dd395ff65aa4435d26de36806edb2729", "html_url": "https://github.com/rust-lang/rust/commit/0555d256dd395ff65aa4435d26de36806edb2729", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0555d256dd395ff65aa4435d26de36806edb2729/comments", "author": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "committer": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3cc68bac7c89a81ec83cbd8f0aff9db001425c50", "url": "https://api.github.com/repos/rust-lang/rust/commits/3cc68bac7c89a81ec83cbd8f0aff9db001425c50", "html_url": "https://github.com/rust-lang/rust/commit/3cc68bac7c89a81ec83cbd8f0aff9db001425c50"}], "stats": {"total": 59, "additions": 23, "deletions": 36}, "files": [{"sha": "f249a6131aec450fe0e7de9e8a51053d5b6dbbec", "filename": "src/librustc/traits/error_reporting.rs", "status": "modified", "additions": 7, "deletions": 3, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/0555d256dd395ff65aa4435d26de36806edb2729/src%2Flibrustc%2Ftraits%2Ferror_reporting.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0555d256dd395ff65aa4435d26de36806edb2729/src%2Flibrustc%2Ftraits%2Ferror_reporting.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ftraits%2Ferror_reporting.rs?ref=0555d256dd395ff65aa4435d26de36806edb2729", "patch": "@@ -647,7 +647,8 @@ impl<'a, 'gcx, 'tcx> InferCtxt<'a, 'gcx, 'tcx> {\n \n                     ty::Predicate::ClosureKind(closure_def_id, closure_substs, kind) => {\n                         let found_kind = self.closure_kind(closure_def_id, closure_substs).unwrap();\n-                        let closure_span = self.tcx.hir.span_if_local(closure_def_id).unwrap();\n+                        let closure_span = self.tcx.sess.codemap()\n+                            .def_span(self.tcx.hir.span_if_local(closure_def_id).unwrap());\n                         let node_id = self.tcx.hir.as_local_node_id(closure_def_id).unwrap();\n                         let mut err = struct_span_err!(\n                             self.tcx.sess, closure_span, E0525,\n@@ -656,6 +657,9 @@ impl<'a, 'gcx, 'tcx> InferCtxt<'a, 'gcx, 'tcx> {\n                             kind,\n                             found_kind);\n \n+                        err.span_label(\n+                            closure_span,\n+                            format!(\"this closure implements `{}`, not `{}`\", found_kind, kind));\n                         err.span_label(\n                             obligation.cause.span,\n                             format!(\"the requirement to implement `{}` derives from here\", kind));\n@@ -667,12 +671,12 @@ impl<'a, 'gcx, 'tcx> InferCtxt<'a, 'gcx, 'tcx> {\n                             let closure_hir_id = self.tcx.hir.node_to_hir_id(node_id);\n                             match (found_kind, tables.closure_kind_origins().get(closure_hir_id)) {\n                                 (ty::ClosureKind::FnOnce, Some((span, name))) => {\n-                                    err.span_note(*span, &format!(\n+                                    err.span_label(*span, format!(\n                                         \"closure is `FnOnce` because it moves the \\\n                                          variable `{}` out of its environment\", name));\n                                 },\n                                 (ty::ClosureKind::FnMut, Some((span, name))) => {\n-                                    err.span_note(*span, &format!(\n+                                    err.span_label(*span, format!(\n                                         \"closure is `FnMut` because it mutates the \\\n                                          variable `{}` here\", name));\n                                 },"}, {"sha": "77ce1176b5cd0f964275ab6be2570804d877b7af", "filename": "src/test/ui/closure_context/issue-26046-fn-mut.stderr", "status": "modified", "additions": 6, "deletions": 13, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/0555d256dd395ff65aa4435d26de36806edb2729/src%2Ftest%2Fui%2Fclosure_context%2Fissue-26046-fn-mut.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/0555d256dd395ff65aa4435d26de36806edb2729/src%2Ftest%2Fui%2Fclosure_context%2Fissue-26046-fn-mut.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fclosure_context%2Fissue-26046-fn-mut.stderr?ref=0555d256dd395ff65aa4435d26de36806edb2729", "patch": "@@ -1,20 +1,13 @@\n error[E0525]: expected a closure that implements the `Fn` trait, but this closure only implements `FnMut`\n   --> $DIR/issue-26046-fn-mut.rs:14:19\n    |\n-14 |       let closure = || { //~ ERROR expected a closure that\n-   |  ___________________^\n-15 | |         num += 1;\n-16 | |     };\n-   | |_____^\n-17 | \n-18 |       Box::new(closure)\n-   |       ----------------- the requirement to implement `Fn` derives from here\n-   |\n-note: closure is `FnMut` because it mutates the variable `num` here\n-  --> $DIR/issue-26046-fn-mut.rs:15:9\n-   |\n+14 |     let closure = || { //~ ERROR expected a closure that\n+   |                   ^^ this closure implements `FnMut`, not `Fn`\n 15 |         num += 1;\n-   |         ^^^\n+   |         --- closure is `FnMut` because it mutates the variable `num` here\n+...\n+18 |     Box::new(closure)\n+   |     ----------------- the requirement to implement `Fn` derives from here\n \n error: aborting due to previous error\n "}, {"sha": "4eed4461ebafe9037845e833174a3c7704d5508e", "filename": "src/test/ui/closure_context/issue-26046-fn-once.stderr", "status": "modified", "additions": 6, "deletions": 13, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/0555d256dd395ff65aa4435d26de36806edb2729/src%2Ftest%2Fui%2Fclosure_context%2Fissue-26046-fn-once.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/0555d256dd395ff65aa4435d26de36806edb2729/src%2Ftest%2Fui%2Fclosure_context%2Fissue-26046-fn-once.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fclosure_context%2Fissue-26046-fn-once.stderr?ref=0555d256dd395ff65aa4435d26de36806edb2729", "patch": "@@ -1,20 +1,13 @@\n error[E0525]: expected a closure that implements the `Fn` trait, but this closure only implements `FnOnce`\n   --> $DIR/issue-26046-fn-once.rs:14:19\n    |\n-14 |       let closure = move || { //~ ERROR expected a closure\n-   |  ___________________^\n-15 | |         vec\n-16 | |     };\n-   | |_____^\n-17 | \n-18 |       Box::new(closure)\n-   |       ----------------- the requirement to implement `Fn` derives from here\n-   |\n-note: closure is `FnOnce` because it moves the variable `vec` out of its environment\n-  --> $DIR/issue-26046-fn-once.rs:15:9\n-   |\n+14 |     let closure = move || { //~ ERROR expected a closure\n+   |                   ^^^^^^^ this closure implements `FnOnce`, not `Fn`\n 15 |         vec\n-   |         ^^^\n+   |         --- closure is `FnOnce` because it moves the variable `vec` out of its environment\n+...\n+18 |     Box::new(closure)\n+   |     ----------------- the requirement to implement `Fn` derives from here\n \n error: aborting due to previous error\n "}, {"sha": "2c16c5b619a8bd387371e5616b18896e3b4f46ea", "filename": "src/test/ui/unboxed-closures-infer-fn-once-move-from-projection.stderr", "status": "modified", "additions": 4, "deletions": 7, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/0555d256dd395ff65aa4435d26de36806edb2729/src%2Ftest%2Fui%2Funboxed-closures-infer-fn-once-move-from-projection.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/0555d256dd395ff65aa4435d26de36806edb2729/src%2Ftest%2Fui%2Funboxed-closures-infer-fn-once-move-from-projection.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Funboxed-closures-infer-fn-once-move-from-projection.stderr?ref=0555d256dd395ff65aa4435d26de36806edb2729", "patch": "@@ -2,15 +2,12 @@ error[E0525]: expected a closure that implements the `Fn` trait, but this closur\n   --> $DIR/unboxed-closures-infer-fn-once-move-from-projection.rs:24:13\n    |\n 24 |     let c = || drop(y.0); //~ ERROR expected a closure that implements the `Fn` trait\n-   |             ^^^^^^^^^^^^\n+   |             ^^^^^^^^-^^^\n+   |             |       |\n+   |             |       closure is `FnOnce` because it moves the variable `y` out of its environment\n+   |             this closure implements `FnOnce`, not `Fn`\n 25 |     foo(c);\n    |     --- the requirement to implement `Fn` derives from here\n-   |\n-note: closure is `FnOnce` because it moves the variable `y` out of its environment\n-  --> $DIR/unboxed-closures-infer-fn-once-move-from-projection.rs:24:21\n-   |\n-24 |     let c = || drop(y.0); //~ ERROR expected a closure that implements the `Fn` trait\n-   |                     ^\n \n error: aborting due to previous error\n "}]}