{"sha": "0dc9b265232183c1b8fed68cfeedcf25a093ba05", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBkYzliMjY1MjMyMTgzYzFiOGZlZDY4Y2ZlZWRjZjI1YTA5M2JhMDU=", "commit": {"author": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2021-01-02T04:51:07Z"}, "committer": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2021-01-02T04:51:07Z"}, "message": "Use `UnhashMap` whenever we have a key of `DefPathHash`", "tree": {"sha": "48e64c22d4ac22e428d65045422e9a43fe13da83", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/48e64c22d4ac22e428d65045422e9a43fe13da83"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0dc9b265232183c1b8fed68cfeedcf25a093ba05", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE7J9Gc3TfBwj2K399tAh+UQ6YsWQFAl/v+84ACgkQtAh+UQ6Y\nsWSc2w//TFQO/tFCekU3EtTzcU5Al4Wf3tWT1GBnR1zFHqDGKC9v0/RS59U/aCYB\nZnwyngQrM0HO8/ssLt1I7wNJzbtQc0kHxf/9x5e3aVvHGdsCE/xmlj8qX8TJBpsc\nXbqo7I/N1FnIAx34pnh6HG3IdhWLGkVEYoE8Y96QhfJriVBoqIREAX+roOznY57O\nQPrjhBIkrDR9EzMYTVudjTGxZxuFjOtfYsRMaJQGOq/JAtcULhsm5V0S4KeotTZz\nxe31TrEzkq5ou4DWBpFYzD8/d+TojoZmeMPtTxXhD1rVUa5ekNiOD4IW9iBfsdTe\nz/4+aC7jYUAW+Juj5Ui+njtPMDI0yRhLCSPSt7HCOlwQ3p4Ic7zAw+CBiZGlFu2e\nxdWXLjHA/24X8VOtbLRjRcpAFuvusrg6en6rLQwGEgipiChwRPaSzz4nIsVQnrts\nVj+l41va/AELAG6zRQyXHHbPu6U/hUxUDxbMV8OMRhV2inpRmyab+2F2ESKO8R6V\nfohZ21C3NxebzlVS8oa7D5fcIR08WIUg/2kOWulPlbrp/wstE9wakitrswc8HQC5\npIpN6M75iSZ4BisFOvJOtEQX1uS/HI7hD/IKnWTrlDuJF509iv9qy8Ecc30y3/Y6\noBR+olW9YXsSgtBNSF8M/5ZcKwqvpEYsaQrxx8RPH9USGF7qWAM=\n=Y/uS\n-----END PGP SIGNATURE-----", "payload": "tree 48e64c22d4ac22e428d65045422e9a43fe13da83\nparent 0876f59b975a67ce79b0d83750f0d153f119b790\nauthor Aaron Hill <aa1ronham@gmail.com> 1609563067 -0500\ncommitter Aaron Hill <aa1ronham@gmail.com> 1609563067 -0500\n\nUse `UnhashMap` whenever we have a key of `DefPathHash`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0dc9b265232183c1b8fed68cfeedcf25a093ba05", "html_url": "https://github.com/rust-lang/rust/commit/0dc9b265232183c1b8fed68cfeedcf25a093ba05", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0dc9b265232183c1b8fed68cfeedcf25a093ba05/comments", "author": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0876f59b975a67ce79b0d83750f0d153f119b790", "url": "https://api.github.com/repos/rust-lang/rust/commits/0876f59b975a67ce79b0d83750f0d153f119b790", "html_url": "https://github.com/rust-lang/rust/commit/0876f59b975a67ce79b0d83750f0d153f119b790"}], "stats": {"total": 22, "additions": 12, "deletions": 10}, "files": [{"sha": "280fdc1e9d637bbfda9658362ce3a777e2c80617", "filename": "compiler/rustc_metadata/src/rmeta/decoder.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/0dc9b265232183c1b8fed68cfeedcf25a093ba05/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fdecoder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0dc9b265232183c1b8fed68cfeedcf25a093ba05/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fdecoder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fdecoder.rs?ref=0dc9b265232183c1b8fed68cfeedcf25a093ba05", "patch": "@@ -11,6 +11,7 @@ use rustc_data_structures::fingerprint::{Fingerprint, FingerprintDecoder};\n use rustc_data_structures::fx::FxHashMap;\n use rustc_data_structures::svh::Svh;\n use rustc_data_structures::sync::{AtomicCell, Lock, LockGuard, Lrc, OnceCell};\n+use rustc_data_structures::unhash::UnhashMap;\n use rustc_errors::ErrorReported;\n use rustc_expand::base::{SyntaxExtension, SyntaxExtensionKind};\n use rustc_expand::proc_macro::{AttrProcMacro, BangProcMacro, ProcMacroDerive};\n@@ -80,7 +81,7 @@ crate struct CrateMetadata {\n     /// For every definition in this crate, maps its `DefPathHash` to its\n     /// `DefIndex`. See `raw_def_id_to_def_id` for more details about how\n     /// this is used.\n-    def_path_hash_map: OnceCell<FxHashMap<DefPathHash, DefIndex>>,\n+    def_path_hash_map: OnceCell<UnhashMap<DefPathHash, DefIndex>>,\n     /// Used for decoding interpret::AllocIds in a cached & thread-safe manner.\n     alloc_decoding_state: AllocDecodingState,\n     /// The `DepNodeIndex` of the `DepNode` representing this upstream crate.\n@@ -1560,7 +1561,7 @@ impl<'a, 'tcx> CrateMetadataRef<'a> {\n         // stored in this crate.\n         let map = self.cdata.def_path_hash_map.get_or_init(|| {\n             let end_id = self.root.tables.def_path_hashes.size() as u32;\n-            let mut map = FxHashMap::with_capacity_and_hasher(end_id as usize, Default::default());\n+            let mut map = UnhashMap::with_capacity_and_hasher(end_id as usize, Default::default());\n             for i in 0..end_id {\n                 let def_index = DefIndex::from_u32(i);\n                 // There may be gaps in the encoded table if we're decoding a proc-macro crate"}, {"sha": "c98cecf758d528e87cef28beaacf9ba75ffa7395", "filename": "compiler/rustc_middle/src/ty/query/on_disk_cache.rs", "status": "modified", "additions": 9, "deletions": 8, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/0dc9b265232183c1b8fed68cfeedcf25a093ba05/compiler%2Frustc_middle%2Fsrc%2Fty%2Fquery%2Fon_disk_cache.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0dc9b265232183c1b8fed68cfeedcf25a093ba05/compiler%2Frustc_middle%2Fsrc%2Fty%2Fquery%2Fon_disk_cache.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fquery%2Fon_disk_cache.rs?ref=0dc9b265232183c1b8fed68cfeedcf25a093ba05", "patch": "@@ -8,6 +8,7 @@ use rustc_data_structures::fingerprint::{Fingerprint, FingerprintDecoder, Finger\n use rustc_data_structures::fx::{FxHashMap, FxHashSet, FxIndexSet};\n use rustc_data_structures::sync::{HashMapExt, Lock, Lrc, OnceCell};\n use rustc_data_structures::thin_vec::ThinVec;\n+use rustc_data_structures::unhash::UnhashMap;\n use rustc_errors::Diagnostic;\n use rustc_hir::def_id::{CrateNum, DefId, DefIndex, LocalDefId, LOCAL_CRATE};\n use rustc_hir::definitions::DefPathHash;\n@@ -87,27 +88,27 @@ pub struct OnDiskCache<'sess> {\n     // compilation session. This is used as an initial 'guess' when\n     // we try to map a `DefPathHash` to its `DefId` in the current compilation\n     // session.\n-    foreign_def_path_hashes: FxHashMap<DefPathHash, RawDefId>,\n+    foreign_def_path_hashes: UnhashMap<DefPathHash, RawDefId>,\n \n     // The *next* compilation sessison's `foreign_def_path_hashes` - at\n     // the end of our current compilation session, this will get written\n     // out to the `foreign_def_path_hashes` field of the `Footer`, which\n     // will become `foreign_def_path_hashes` of the next compilation session.\n     // This stores any `DefPathHash` that we may need to map to a `DefId`\n     // during the next compilation session.\n-    latest_foreign_def_path_hashes: Lock<FxHashMap<DefPathHash, RawDefId>>,\n+    latest_foreign_def_path_hashes: Lock<UnhashMap<DefPathHash, RawDefId>>,\n \n     // Maps `DefPathHashes` to their corresponding `LocalDefId`s for all\n     // local items in the current compilation session. This is only populated\n     // when we are in incremental mode and have loaded a pre-existing cache\n     // from disk, since this map is only used when deserializing a `DefPathHash`\n     // from the incremental cache.\n-    local_def_path_hash_to_def_id: FxHashMap<DefPathHash, LocalDefId>,\n+    local_def_path_hash_to_def_id: UnhashMap<DefPathHash, LocalDefId>,\n     // Caches all lookups of `DefPathHashes`, both for local and foreign\n     // definitions. A definition from the previous compilation session\n     // may no longer exist in the current compilation session, so\n     // we use `Option<DefId>` so that we can cache a lookup failure.\n-    def_path_hash_to_def_id_cache: Lock<FxHashMap<DefPathHash, Option<DefId>>>,\n+    def_path_hash_to_def_id_cache: Lock<UnhashMap<DefPathHash, Option<DefId>>>,\n }\n \n // This type is used only for serialization and deserialization.\n@@ -123,7 +124,7 @@ struct Footer {\n     syntax_contexts: FxHashMap<u32, AbsoluteBytePos>,\n     // See `OnDiskCache.expn_data`\n     expn_data: FxHashMap<u32, AbsoluteBytePos>,\n-    foreign_def_path_hashes: FxHashMap<DefPathHash, RawDefId>,\n+    foreign_def_path_hashes: UnhashMap<DefPathHash, RawDefId>,\n }\n \n type EncodedQueryResultIndex = Vec<(SerializedDepNodeIndex, AbsoluteBytePos)>;\n@@ -160,8 +161,8 @@ crate struct RawDefId {\n     pub index: u32,\n }\n \n-fn make_local_def_path_hash_map(definitions: &Definitions) -> FxHashMap<DefPathHash, LocalDefId> {\n-    FxHashMap::from_iter(\n+fn make_local_def_path_hash_map(definitions: &Definitions) -> UnhashMap<DefPathHash, LocalDefId> {\n+    UnhashMap::from_iter(\n         definitions\n             .def_path_table()\n             .all_def_path_hashes_and_def_ids(LOCAL_CRATE)\n@@ -964,7 +965,7 @@ struct CacheEncoder<'a, 'tcx, E: OpaqueEncoder> {\n     source_map: CachingSourceMapView<'tcx>,\n     file_to_file_index: FxHashMap<*const SourceFile, SourceFileIndex>,\n     hygiene_context: &'a HygieneEncodeContext,\n-    latest_foreign_def_path_hashes: FxHashMap<DefPathHash, RawDefId>,\n+    latest_foreign_def_path_hashes: UnhashMap<DefPathHash, RawDefId>,\n }\n \n impl<'a, 'tcx, E> CacheEncoder<'a, 'tcx, E>"}]}