{"sha": "496c11005c30d93cbae5e2f27f15cc387dc0787b", "node_id": "C_kwDOAAsO6NoAKDQ5NmMxMTAwNWMzMGQ5M2NiYWU1ZTJmMjdmMTVjYzM4N2RjMDc4N2I", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-04-23T13:33:51Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-04-23T13:33:51Z"}, "message": "Auto merge of #10679 - y21:better-const-ctx-check, r=Jarcho\n\nuse `is_inside_const_context` for `in_constant` util fn\n\nFixes #10452.\n\nThis PR improves the `in_constant` util function to detect more cases of const contexts. Previously this function would not detect cases like expressions in array length position or expression in an inline const block `const { .. }`.\n\nchangelog: [`bool_to_int_with_if`]: recognize array length operand as being in a const context and don't suggest `usize::from` there", "tree": {"sha": "68ae1922329ca16b40859c8db3441b31d278ad91", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/68ae1922329ca16b40859c8db3441b31d278ad91"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/496c11005c30d93cbae5e2f27f15cc387dc0787b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/496c11005c30d93cbae5e2f27f15cc387dc0787b", "html_url": "https://github.com/rust-lang/rust/commit/496c11005c30d93cbae5e2f27f15cc387dc0787b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/496c11005c30d93cbae5e2f27f15cc387dc0787b/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "316d83a4d81d295f5a36361d8141f030f513c3ee", "url": "https://api.github.com/repos/rust-lang/rust/commits/316d83a4d81d295f5a36361d8141f030f513c3ee", "html_url": "https://github.com/rust-lang/rust/commit/316d83a4d81d295f5a36361d8141f030f513c3ee"}, {"sha": "654d12ff8930a332a4cdcfccc6c1c34700e2f3b7", "url": "https://api.github.com/repos/rust-lang/rust/commits/654d12ff8930a332a4cdcfccc6c1c34700e2f3b7", "html_url": "https://github.com/rust-lang/rust/commit/654d12ff8930a332a4cdcfccc6c1c34700e2f3b7"}], "stats": {"total": 52, "additions": 21, "deletions": 31}, "files": [{"sha": "ba4bd6e176918c87fba4e95b372718d1279eea5d", "filename": "clippy_utils/src/lib.rs", "status": "modified", "additions": 4, "deletions": 28, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/496c11005c30d93cbae5e2f27f15cc387dc0787b/clippy_utils%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/496c11005c30d93cbae5e2f27f15cc387dc0787b/clippy_utils%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_utils%2Fsrc%2Flib.rs?ref=496c11005c30d93cbae5e2f27f15cc387dc0787b", "patch": "@@ -86,10 +86,10 @@ use rustc_hir::hir_id::{HirIdMap, HirIdSet};\n use rustc_hir::intravisit::{walk_expr, FnKind, Visitor};\n use rustc_hir::LangItem::{OptionNone, ResultErr, ResultOk};\n use rustc_hir::{\n-    self as hir, def, Arm, ArrayLen, BindingAnnotation, Block, BlockCheckMode, Body, Closure, Constness, Destination,\n-    Expr, ExprKind, FnDecl, HirId, Impl, ImplItem, ImplItemKind, ImplItemRef, IsAsync, Item, ItemKind, LangItem, Local,\n+    self as hir, def, Arm, ArrayLen, BindingAnnotation, Block, BlockCheckMode, Body, Closure, Destination, Expr,\n+    ExprKind, FnDecl, HirId, Impl, ImplItem, ImplItemKind, ImplItemRef, IsAsync, Item, ItemKind, LangItem, Local,\n     MatchSource, Mutability, Node, OwnerId, Param, Pat, PatKind, Path, PathSegment, PrimTy, QPath, Stmt, StmtKind,\n-    TraitItem, TraitItemKind, TraitItemRef, TraitRef, TyKind, UnOp,\n+    TraitItem, TraitItemRef, TraitRef, TyKind, UnOp,\n };\n use rustc_lexer::{tokenize, TokenKind};\n use rustc_lint::{LateContext, Level, Lint, LintContext};\n@@ -197,31 +197,7 @@ pub fn find_binding_init<'tcx>(cx: &LateContext<'tcx>, hir_id: HirId) -> Option<\n /// }\n /// ```\n pub fn in_constant(cx: &LateContext<'_>, id: HirId) -> bool {\n-    let parent_id = cx.tcx.hir().get_parent_item(id).def_id;\n-    match cx.tcx.hir().get_by_def_id(parent_id) {\n-        Node::Item(&Item {\n-            kind: ItemKind::Const(..) | ItemKind::Static(..) | ItemKind::Enum(..),\n-            ..\n-        })\n-        | Node::TraitItem(&TraitItem {\n-            kind: TraitItemKind::Const(..),\n-            ..\n-        })\n-        | Node::ImplItem(&ImplItem {\n-            kind: ImplItemKind::Const(..),\n-            ..\n-        })\n-        | Node::AnonConst(_) => true,\n-        Node::Item(&Item {\n-            kind: ItemKind::Fn(ref sig, ..),\n-            ..\n-        })\n-        | Node::ImplItem(&ImplItem {\n-            kind: ImplItemKind::Fn(ref sig, _),\n-            ..\n-        }) => sig.header.constness == Constness::Const,\n-        _ => false,\n-    }\n+    cx.tcx.hir().is_inside_const_context(id)\n }\n \n /// Checks if a `Res` refers to a constructor of a `LangItem`"}, {"sha": "fbb10a133e2b0a5a83a81fccf0ad618e969cb555", "filename": "tests/ui/bool_to_int_with_if.fixed", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/496c11005c30d93cbae5e2f27f15cc387dc0787b/tests%2Fui%2Fbool_to_int_with_if.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/496c11005c30d93cbae5e2f27f15cc387dc0787b/tests%2Fui%2Fbool_to_int_with_if.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fbool_to_int_with_if.fixed?ref=496c11005c30d93cbae5e2f27f15cc387dc0787b", "patch": "@@ -1,6 +1,6 @@\n //@run-rustfix\n \n-#![feature(let_chains)]\n+#![feature(let_chains, inline_const)]\n #![warn(clippy::bool_to_int_with_if)]\n #![allow(unused, dead_code, clippy::unnecessary_operation, clippy::no_effect)]\n \n@@ -79,6 +79,13 @@ fn main() {\n \n     pub const SHOULD_NOT_LINT: usize = if true { 1 } else { 0 };\n \n+    // https://github.com/rust-lang/rust-clippy/issues/10452\n+    let should_not_lint = [(); if true { 1 } else { 0 }];\n+\n+    let should_not_lint = const {\n+        if true { 1 } else { 0 }\n+    };\n+\n     some_fn(a);\n }\n "}, {"sha": "709a18d63e401c00f5f7a2d974dfaef8fd3d80cf", "filename": "tests/ui/bool_to_int_with_if.rs", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/496c11005c30d93cbae5e2f27f15cc387dc0787b/tests%2Fui%2Fbool_to_int_with_if.rs", "raw_url": "https://github.com/rust-lang/rust/raw/496c11005c30d93cbae5e2f27f15cc387dc0787b/tests%2Fui%2Fbool_to_int_with_if.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fbool_to_int_with_if.rs?ref=496c11005c30d93cbae5e2f27f15cc387dc0787b", "patch": "@@ -1,6 +1,6 @@\n //@run-rustfix\n \n-#![feature(let_chains)]\n+#![feature(let_chains, inline_const)]\n #![warn(clippy::bool_to_int_with_if)]\n #![allow(unused, dead_code, clippy::unnecessary_operation, clippy::no_effect)]\n \n@@ -111,6 +111,13 @@ fn main() {\n \n     pub const SHOULD_NOT_LINT: usize = if true { 1 } else { 0 };\n \n+    // https://github.com/rust-lang/rust-clippy/issues/10452\n+    let should_not_lint = [(); if true { 1 } else { 0 }];\n+\n+    let should_not_lint = const {\n+        if true { 1 } else { 0 }\n+    };\n+\n     some_fn(a);\n }\n "}, {"sha": "3bdae75cad22b037d7d03c1325a3663ea0a0e2a6", "filename": "tests/ui/bool_to_int_with_if.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/496c11005c30d93cbae5e2f27f15cc387dc0787b/tests%2Fui%2Fbool_to_int_with_if.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/496c11005c30d93cbae5e2f27f15cc387dc0787b/tests%2Fui%2Fbool_to_int_with_if.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fbool_to_int_with_if.stderr?ref=496c11005c30d93cbae5e2f27f15cc387dc0787b", "patch": "@@ -98,7 +98,7 @@ LL | |     };\n    = note: `!b as i32` or `(!b).into()` can also be valid options\n \n error: boolean to int conversion using if\n-  --> $DIR/bool_to_int_with_if.rs:119:5\n+  --> $DIR/bool_to_int_with_if.rs:126:5\n    |\n LL |     if a { 1 } else { 0 }\n    |     ^^^^^^^^^^^^^^^^^^^^^ help: replace with from: `u8::from(a)`"}]}