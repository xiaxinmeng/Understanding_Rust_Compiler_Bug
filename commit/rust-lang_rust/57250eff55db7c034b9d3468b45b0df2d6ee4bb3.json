{"sha": "57250eff55db7c034b9d3468b45b0df2d6ee4bb3", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU3MjUwZWZmNTVkYjdjMDM0YjlkMzQ2OGI0NWIwZGYyZDZlZTRiYjM=", "commit": {"author": {"name": "Joshua Nelson", "email": "jyn514@gmail.com", "date": "2020-09-11T17:42:56Z"}, "committer": {"name": "Joshua Nelson", "email": "jyn514@gmail.com", "date": "2020-09-11T17:42:56Z"}, "message": "Use `span_label` instead of `note`\n\nThis puts the error message closer to the link, making it easier to see\nwhat went wrong.", "tree": {"sha": "83c30a2359fc15290745b0b4381a4710e122f1fc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/83c30a2359fc15290745b0b4381a4710e122f1fc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/57250eff55db7c034b9d3468b45b0df2d6ee4bb3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/57250eff55db7c034b9d3468b45b0df2d6ee4bb3", "html_url": "https://github.com/rust-lang/rust/commit/57250eff55db7c034b9d3468b45b0df2d6ee4bb3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/57250eff55db7c034b9d3468b45b0df2d6ee4bb3/comments", "author": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c213c68500f5fff51f26997d27a346c896232df7", "url": "https://api.github.com/repos/rust-lang/rust/commits/c213c68500f5fff51f26997d27a346c896232df7", "html_url": "https://github.com/rust-lang/rust/commit/c213c68500f5fff51f26997d27a346c896232df7"}], "stats": {"total": 143, "additions": 65, "deletions": 78}, "files": [{"sha": "0319096635211e3879b9e4dcdd0b1b78e55b5f27", "filename": "src/librustdoc/passes/collect_intra_doc_links.rs", "status": "modified", "additions": 47, "deletions": 37, "changes": 84, "blob_url": "https://github.com/rust-lang/rust/blob/57250eff55db7c034b9d3468b45b0df2d6ee4bb3/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57250eff55db7c034b9d3468b45b0df2d6ee4bb3/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs?ref=57250eff55db7c034b9d3468b45b0df2d6ee4bb3", "patch": "@@ -1516,16 +1516,15 @@ fn resolution_failure(\n                     collector.cx.tcx.item_name(res.def_id()).to_string()\n                 )\n             };\n-            let assoc_item_not_allowed = |res: Res, diag: &mut DiagnosticBuilder<'_>| {\n+            let assoc_item_not_allowed = |res: Res| {\n                 let def_id = res.def_id();\n                 let name = collector.cx.tcx.item_name(def_id);\n-                let note = format!(\n+                format!(\n                     \"`{}` is {} {}, not a module or type, and cannot have associated items\",\n                     name,\n                     res.article(),\n                     res.descr()\n-                );\n-                diag.note(&note);\n+                )\n             };\n             // ignore duplicates\n             let mut variants_seen = SmallVec::<[_; 3]>::new();\n@@ -1559,29 +1558,29 @@ fn resolution_failure(\n                     continue;\n                 }\n                 variants_seen.push(variant);\n-                match failure {\n+                let note = match failure {\n                     ResolutionFailure::NotInScope { name, .. } => {\n                         if in_scope {\n                             continue;\n                         }\n-                        diag.note(&format!(\"no item named `{}` is in scope\", name));\n+                        // NOTE: uses an explicit `continue` so the `note:` will come before the `help:`\n+                        let note = format!(\"no item named `{}` is in scope\", name);\n+                        if let Some(span) = sp {\n+                            diag.span_label(span, &note);\n+                        } else {\n+                            diag.note(&note);\n+                        }\n                         // If the link has `::` in the path, assume it's meant to be an intra-doc link\n                         if !path_str.contains(\"::\") {\n                             // Otherwise, the `[]` might be unrelated.\n                             // FIXME(https://github.com/raphlinus/pulldown-cmark/issues/373):\n                             // don't show this for autolinks (`<>`), `()` style links, or reference links\n                             diag.help(r#\"to escape `[` and `]` characters, add '\\' before them like `\\[` or `\\]`\"#);\n                         }\n+                        continue;\n                     }\n                     ResolutionFailure::Dummy => continue,\n                     ResolutionFailure::WrongNamespace(res, expected_ns) => {\n-                        let note = format!(\n-                            \"this link resolves to {}, which is not in the {} namespace\",\n-                            item(res),\n-                            expected_ns.descr()\n-                        );\n-                        diag.note(&note);\n-\n                         if let Res::Def(kind, _) = res {\n                             let disambiguator = Disambiguator::Kind(kind);\n                             suggest_disambiguator(\n@@ -1593,24 +1592,26 @@ fn resolution_failure(\n                                 &link_range,\n                             )\n                         }\n+\n+                        format!(\n+                            \"this link resolves to {}, which is not in the {} namespace\",\n+                            item(res),\n+                            expected_ns.descr()\n+                        )\n                     }\n                     ResolutionFailure::NoParentItem => {\n                         diag.level = rustc_errors::Level::Bug;\n-                        diag.note(\"all intra doc links should have a parent item\");\n-                    }\n-                    ResolutionFailure::NoPrimitiveImpl(res, _) => {\n-                        let note = format!(\n-                            \"this link partially resolves to {}, which does not have any associated items\",\n-                            item(res),\n-                        );\n-                        diag.note(&note);\n+                        \"all intra doc links should have a parent item\".to_owned()\n                     }\n+                    ResolutionFailure::NoPrimitiveImpl(res, _) => format!(\n+                        \"this link partially resolves to {}, which does not have any associated items\",\n+                        item(res),\n+                    ),\n                     ResolutionFailure::NoPrimitiveAssocItem { prim_name, assoc_item, .. } => {\n-                        let note = format!(\n+                        format!(\n                             \"the builtin type `{}` does not have an associated item named `{}`\",\n                             prim_name, assoc_item\n-                        );\n-                        diag.note(&note);\n+                        )\n                     }\n                     ResolutionFailure::NoAssocItem(res, assoc_item) => {\n                         use DefKind::*;\n@@ -1645,32 +1646,41 @@ fn resolution_failure(\n                                 | Use\n                                 | LifetimeParam\n                                 | Ctor(_, _)\n-                                | AnonConst => return assoc_item_not_allowed(res, diag),\n+                                | AnonConst => {\n+                                    let note = assoc_item_not_allowed(res);\n+                                    if let Some(span) = sp {\n+                                        diag.span_label(span, &note);\n+                                    } else {\n+                                        diag.note(&note);\n+                                    }\n+                                    return;\n+                                }\n                                 Trait | TyAlias | ForeignTy | OpaqueTy | TraitAlias | TyParam\n                                 | Static => \"associated item\",\n                                 Impl | GlobalAsm => unreachable!(\"not a path\"),\n                             }\n                         };\n-                        let note = format!(\n+                        format!(\n                             \"the {} `{}` has no {} named `{}`\",\n                             res.descr(),\n                             name,\n                             path_description,\n                             assoc_item\n-                        );\n-                        diag.note(&note);\n+                        )\n                     }\n                     ResolutionFailure::CannotHaveAssociatedItems(res, _) => {\n-                        assoc_item_not_allowed(res, diag)\n-                    }\n-                    ResolutionFailure::NotAVariant(res, variant) => {\n-                        let note = format!(\n-                            \"this link partially resolves to {}, but there is no variant named {}\",\n-                            item(res),\n-                            variant\n-                        );\n-                        diag.note(&note);\n+                        assoc_item_not_allowed(res)\n                     }\n+                    ResolutionFailure::NotAVariant(res, variant) => format!(\n+                        \"this link partially resolves to {}, but there is no variant named {}\",\n+                        item(res),\n+                        variant\n+                    ),\n+                };\n+                if let Some(span) = sp {\n+                    diag.span_label(span, &note);\n+                } else {\n+                    diag.note(&note);\n                 }\n             }\n         },"}, {"sha": "d64c7e14ba61dd803f0e10cbbcc121dbce4e268c", "filename": "src/test/rustdoc-ui/intra-links-warning-crlf.stderr", "status": "modified", "additions": 4, "deletions": 8, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/57250eff55db7c034b9d3468b45b0df2d6ee4bb3/src%2Ftest%2Frustdoc-ui%2Fintra-links-warning-crlf.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/57250eff55db7c034b9d3468b45b0df2d6ee4bb3/src%2Ftest%2Frustdoc-ui%2Fintra-links-warning-crlf.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fintra-links-warning-crlf.stderr?ref=57250eff55db7c034b9d3468b45b0df2d6ee4bb3", "patch": "@@ -2,37 +2,33 @@ warning: unresolved link to `error`\n   --> $DIR/intra-links-warning-crlf.rs:7:6\n    |\n LL | /// [error]\n-   |      ^^^^^\n+   |      ^^^^^ no item named `error` is in scope\n    |\n    = note: `#[warn(broken_intra_doc_links)]` on by default\n-   = note: no item named `error` is in scope\n    = help: to escape `[` and `]` characters, add '\\' before them like `\\[` or `\\]`\n \n warning: unresolved link to `error1`\n   --> $DIR/intra-links-warning-crlf.rs:12:11\n    |\n LL | /// docs [error1]\n-   |           ^^^^^^\n+   |           ^^^^^^ no item named `error1` is in scope\n    |\n-   = note: no item named `error1` is in scope\n    = help: to escape `[` and `]` characters, add '\\' before them like `\\[` or `\\]`\n \n warning: unresolved link to `error2`\n   --> $DIR/intra-links-warning-crlf.rs:15:11\n    |\n LL | /// docs [error2]\n-   |           ^^^^^^\n+   |           ^^^^^^ no item named `error2` is in scope\n    |\n-   = note: no item named `error2` is in scope\n    = help: to escape `[` and `]` characters, add '\\' before them like `\\[` or `\\]`\n \n warning: unresolved link to `error`\n   --> $DIR/intra-links-warning-crlf.rs:23:20\n    |\n LL |  * It also has an [error].\n-   |                    ^^^^^\n+   |                    ^^^^^ no item named `error` is in scope\n    |\n-   = note: no item named `error` is in scope\n    = help: to escape `[` and `]` characters, add '\\' before them like `\\[` or `\\]`\n \n warning: 4 warnings emitted"}, {"sha": "0eaad25501a32c7450e9efebf545fcd895edb67a", "filename": "src/test/rustdoc-ui/intra-links-warning.stderr", "status": "modified", "additions": 14, "deletions": 33, "changes": 47, "blob_url": "https://github.com/rust-lang/rust/blob/57250eff55db7c034b9d3468b45b0df2d6ee4bb3/src%2Ftest%2Frustdoc-ui%2Fintra-links-warning.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/57250eff55db7c034b9d3468b45b0df2d6ee4bb3/src%2Ftest%2Frustdoc-ui%2Fintra-links-warning.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fintra-links-warning.stderr?ref=57250eff55db7c034b9d3468b45b0df2d6ee4bb3", "patch": "@@ -2,76 +2,62 @@ warning: unresolved link to `Foo::baz`\n   --> $DIR/intra-links-warning.rs:3:23\n    |\n LL |        //! Test with [Foo::baz], [Bar::foo], ...\n-   |                       ^^^^^^^^\n+   |                       ^^^^^^^^ the struct `Foo` has no field or associated item named `baz`\n    |\n    = note: `#[warn(broken_intra_doc_links)]` on by default\n-   = note: the struct `Foo` has no field or associated item named `baz`\n \n warning: unresolved link to `Bar::foo`\n   --> $DIR/intra-links-warning.rs:3:35\n    |\n LL |        //! Test with [Foo::baz], [Bar::foo], ...\n-   |                                   ^^^^^^^^\n-   |\n-   = note: no item named `Bar` is in scope\n+   |                                   ^^^^^^^^ no item named `Bar` is in scope\n \n warning: unresolved link to `Uniooon::X`\n   --> $DIR/intra-links-warning.rs:6:13\n    |\n LL |      //! , [Uniooon::X] and [Qux::Z].\n-   |             ^^^^^^^^^^\n-   |\n-   = note: no item named `Uniooon` is in scope\n+   |             ^^^^^^^^^^ no item named `Uniooon` is in scope\n \n warning: unresolved link to `Qux::Z`\n   --> $DIR/intra-links-warning.rs:6:30\n    |\n LL |      //! , [Uniooon::X] and [Qux::Z].\n-   |                              ^^^^^^\n-   |\n-   = note: no item named `Qux` is in scope\n+   |                              ^^^^^^ no item named `Qux` is in scope\n \n warning: unresolved link to `Uniooon::X`\n   --> $DIR/intra-links-warning.rs:10:14\n    |\n LL |       //! , [Uniooon::X] and [Qux::Z].\n-   |              ^^^^^^^^^^\n-   |\n-   = note: no item named `Uniooon` is in scope\n+   |              ^^^^^^^^^^ no item named `Uniooon` is in scope\n \n warning: unresolved link to `Qux::Z`\n   --> $DIR/intra-links-warning.rs:10:31\n    |\n LL |       //! , [Uniooon::X] and [Qux::Z].\n-   |                               ^^^^^^\n-   |\n-   = note: no item named `Qux` is in scope\n+   |                               ^^^^^^ no item named `Qux` is in scope\n \n warning: unresolved link to `Qux:Y`\n   --> $DIR/intra-links-warning.rs:14:13\n    |\n LL |        /// [Qux:Y]\n-   |             ^^^^^\n+   |             ^^^^^ no item named `Qux:Y` is in scope\n    |\n-   = note: no item named `Qux:Y` is in scope\n    = help: to escape `[` and `]` characters, add '\\' before them like `\\[` or `\\]`\n \n warning: unresolved link to `error`\n   --> $DIR/intra-links-warning.rs:58:30\n    |\n LL |  * time to introduce a link [error]*/\n-   |                              ^^^^^\n+   |                              ^^^^^ no item named `error` is in scope\n    |\n-   = note: no item named `error` is in scope\n    = help: to escape `[` and `]` characters, add '\\' before them like `\\[` or `\\]`\n \n warning: unresolved link to `error`\n   --> $DIR/intra-links-warning.rs:64:30\n    |\n LL |  * time to introduce a link [error]\n-   |                              ^^^^^\n+   |                              ^^^^^ no item named `error` is in scope\n    |\n-   = note: no item named `error` is in scope\n    = help: to escape `[` and `]` characters, add '\\' before them like `\\[` or `\\]`\n \n warning: unresolved link to `error`\n@@ -119,45 +105,40 @@ warning: unresolved link to `error1`\n   --> $DIR/intra-links-warning.rs:80:11\n    |\n LL | /// docs [error1]\n-   |           ^^^^^^\n+   |           ^^^^^^ no item named `error1` is in scope\n    |\n-   = note: no item named `error1` is in scope\n    = help: to escape `[` and `]` characters, add '\\' before them like `\\[` or `\\]`\n \n warning: unresolved link to `error2`\n   --> $DIR/intra-links-warning.rs:82:11\n    |\n LL | /// docs [error2]\n-   |           ^^^^^^\n+   |           ^^^^^^ no item named `error2` is in scope\n    |\n-   = note: no item named `error2` is in scope\n    = help: to escape `[` and `]` characters, add '\\' before them like `\\[` or `\\]`\n \n warning: unresolved link to `BarA`\n   --> $DIR/intra-links-warning.rs:21:10\n    |\n LL | /// bar [BarA] bar\n-   |          ^^^^\n+   |          ^^^^ no item named `BarA` is in scope\n    |\n-   = note: no item named `BarA` is in scope\n    = help: to escape `[` and `]` characters, add '\\' before them like `\\[` or `\\]`\n \n warning: unresolved link to `BarB`\n   --> $DIR/intra-links-warning.rs:27:9\n    |\n LL |  * bar [BarB] bar\n-   |         ^^^^\n+   |         ^^^^ no item named `BarB` is in scope\n    |\n-   = note: no item named `BarB` is in scope\n    = help: to escape `[` and `]` characters, add '\\' before them like `\\[` or `\\]`\n \n warning: unresolved link to `BarC`\n   --> $DIR/intra-links-warning.rs:34:6\n    |\n LL | bar [BarC] bar\n-   |      ^^^^\n+   |      ^^^^ no item named `BarC` is in scope\n    |\n-   = note: no item named `BarC` is in scope\n    = help: to escape `[` and `]` characters, add '\\' before them like `\\[` or `\\]`\n \n warning: unresolved link to `BarD`"}]}