{"sha": "fd034bea1a13cf557f9fa3446f8f31fa18c084f9", "node_id": "C_kwDOAAsO6NoAKGZkMDM0YmVhMWExM2NmNTU3ZjlmYTM0NDZmOGYzMWZhMThjMDg0Zjk", "commit": {"author": {"name": "hkalbasi", "email": "hamidrezakalbasi@protonmail.com", "date": "2023-05-16T21:57:45Z"}, "committer": {"name": "hkalbasi", "email": "hamidrezakalbasi@protonmail.com", "date": "2023-05-16T21:57:45Z"}, "message": "Fix evaluating negative for floating point types", "tree": {"sha": "d8b2d2a82748d95452ec06014e50adae4492ec08", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d8b2d2a82748d95452ec06014e50adae4492ec08"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fd034bea1a13cf557f9fa3446f8f31fa18c084f9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fd034bea1a13cf557f9fa3446f8f31fa18c084f9", "html_url": "https://github.com/rust-lang/rust/commit/fd034bea1a13cf557f9fa3446f8f31fa18c084f9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fd034bea1a13cf557f9fa3446f8f31fa18c084f9/comments", "author": {"login": "HKalbasi", "id": 45197576, "node_id": "MDQ6VXNlcjQ1MTk3NTc2", "avatar_url": "https://avatars.githubusercontent.com/u/45197576?v=4", "gravatar_id": "", "url": "https://api.github.com/users/HKalbasi", "html_url": "https://github.com/HKalbasi", "followers_url": "https://api.github.com/users/HKalbasi/followers", "following_url": "https://api.github.com/users/HKalbasi/following{/other_user}", "gists_url": "https://api.github.com/users/HKalbasi/gists{/gist_id}", "starred_url": "https://api.github.com/users/HKalbasi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/HKalbasi/subscriptions", "organizations_url": "https://api.github.com/users/HKalbasi/orgs", "repos_url": "https://api.github.com/users/HKalbasi/repos", "events_url": "https://api.github.com/users/HKalbasi/events{/privacy}", "received_events_url": "https://api.github.com/users/HKalbasi/received_events", "type": "User", "site_admin": false}, "committer": {"login": "HKalbasi", "id": 45197576, "node_id": "MDQ6VXNlcjQ1MTk3NTc2", "avatar_url": "https://avatars.githubusercontent.com/u/45197576?v=4", "gravatar_id": "", "url": "https://api.github.com/users/HKalbasi", "html_url": "https://github.com/HKalbasi", "followers_url": "https://api.github.com/users/HKalbasi/followers", "following_url": "https://api.github.com/users/HKalbasi/following{/other_user}", "gists_url": "https://api.github.com/users/HKalbasi/gists{/gist_id}", "starred_url": "https://api.github.com/users/HKalbasi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/HKalbasi/subscriptions", "organizations_url": "https://api.github.com/users/HKalbasi/orgs", "repos_url": "https://api.github.com/users/HKalbasi/repos", "events_url": "https://api.github.com/users/HKalbasi/events{/privacy}", "received_events_url": "https://api.github.com/users/HKalbasi/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cbd14e98403dc5e19f19fdf913808656d81a0516", "url": "https://api.github.com/repos/rust-lang/rust/commits/cbd14e98403dc5e19f19fdf913808656d81a0516", "html_url": "https://github.com/rust-lang/rust/commit/cbd14e98403dc5e19f19fdf913808656d81a0516"}], "stats": {"total": 43, "additions": 30, "deletions": 13}, "files": [{"sha": "aa84103dd8ad6828328deff6326072581a653d31", "filename": "crates/hir-ty/src/consteval/tests.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/fd034bea1a13cf557f9fa3446f8f31fa18c084f9/crates%2Fhir-ty%2Fsrc%2Fconsteval%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd034bea1a13cf557f9fa3446f8f31fa18c084f9/crates%2Fhir-ty%2Fsrc%2Fconsteval%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-ty%2Fsrc%2Fconsteval%2Ftests.rs?ref=fd034bea1a13cf557f9fa3446f8f31fa18c084f9", "patch": "@@ -113,6 +113,10 @@ fn floating_point() {\n         r#\"const GOAL: f32 = 2.0 + 3.0 * 5.5 - 8.;\"#,\n         i128::from_le_bytes(pad16(&f32::to_le_bytes(10.5), true)),\n     );\n+    check_number(\n+        r#\"const GOAL: f32 = -90.0 + 36.0;\"#,\n+        i128::from_le_bytes(pad16(&f32::to_le_bytes(-54.0), true)),\n+    );\n }\n \n #[test]"}, {"sha": "c55ecb056c05a71b49e2176fc39aee7fbd34904f", "filename": "crates/hir-ty/src/mir/eval.rs", "status": "modified", "additions": 26, "deletions": 13, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/fd034bea1a13cf557f9fa3446f8f31fa18c084f9/crates%2Fhir-ty%2Fsrc%2Fmir%2Feval.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fd034bea1a13cf557f9fa3446f8f31fa18c084f9/crates%2Fhir-ty%2Fsrc%2Fmir%2Feval.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-ty%2Fsrc%2Fmir%2Feval.rs?ref=fd034bea1a13cf557f9fa3446f8f31fa18c084f9", "patch": "@@ -759,25 +759,38 @@ impl Evaluator<'_> {\n                     let size = self.size_of_sized(&ty, locals, \"operand of unary op\")?;\n                     c = self.read_memory(Address::from_bytes(c)?, size)?;\n                 }\n-                let mut c = c.to_vec();\n-                if ty.as_builtin() == Some(BuiltinType::Bool) {\n-                    c[0] = 1 - c[0];\n+                if let TyKind::Scalar(chalk_ir::Scalar::Float(f)) = ty.kind(Interner) {\n+                    match f {\n+                        chalk_ir::FloatTy::F32 => {\n+                            let c = -from_bytes!(f32, c);\n+                            Owned(c.to_le_bytes().into())\n+                        }\n+                        chalk_ir::FloatTy::F64 => {\n+                            let c = -from_bytes!(f32, c);\n+                            Owned(c.to_le_bytes().into())\n+                        }\n+                    }\n                 } else {\n-                    match op {\n-                        UnOp::Not => c.iter_mut().for_each(|x| *x = !*x),\n-                        UnOp::Neg => {\n-                            c.iter_mut().for_each(|x| *x = !*x);\n-                            for k in c.iter_mut() {\n-                                let o;\n-                                (*k, o) = k.overflowing_add(1);\n-                                if !o {\n-                                    break;\n+                    let mut c = c.to_vec();\n+                    if ty.as_builtin() == Some(BuiltinType::Bool) {\n+                        c[0] = 1 - c[0];\n+                    } else {\n+                        match op {\n+                            UnOp::Not => c.iter_mut().for_each(|x| *x = !*x),\n+                            UnOp::Neg => {\n+                                c.iter_mut().for_each(|x| *x = !*x);\n+                                for k in c.iter_mut() {\n+                                    let o;\n+                                    (*k, o) = k.overflowing_add(1);\n+                                    if !o {\n+                                        break;\n+                                    }\n                                 }\n                             }\n                         }\n                     }\n+                    Owned(c)\n                 }\n-                Owned(c)\n             }\n             Rvalue::CheckedBinaryOp(op, lhs, rhs) => {\n                 let lc = self.eval_operand(lhs, locals)?;"}]}