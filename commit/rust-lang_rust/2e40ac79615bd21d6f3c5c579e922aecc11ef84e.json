{"sha": "2e40ac79615bd21d6f3c5c579e922aecc11ef84e", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJlNDBhYzc5NjE1YmQyMWQ2ZjNjNWM1NzllOTIyYWVjYzExZWY4NGU=", "commit": {"author": {"name": "Luro02", "email": "24826124+Luro02@users.noreply.github.com", "date": "2020-03-01T09:34:08Z"}, "committer": {"name": "Luro02", "email": "24826124+Luro02@users.noreply.github.com", "date": "2020-03-31T11:47:37Z"}, "message": "improve folder name for persistent doc tests", "tree": {"sha": "b5f3db67b5256f774bcd2a315ee00a75dc875f2a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b5f3db67b5256f774bcd2a315ee00a75dc875f2a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2e40ac79615bd21d6f3c5c579e922aecc11ef84e", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQEzBAABCAAdFiEEtEv6UH35w4B/69kQtm/U90UBqc8FAl6DLdkACgkQtm/U90UB\nqc9qLwgAqNSKugqiigcPa15IimZYlldkyduJXwfelD/BXvucoxqYI4i6wdx7XP7+\nHPFh2vc2hQjCME1QTwmLuSwRmeEqOXf+2gNJbTVzjX9P1PfpK+mj8LiALaXTU/me\nXSaj/RF9gmeyDSkzt9Db4U89VbTh+Nq1cK8bUpQVtQa5116xamA2apYqd3kaBtlJ\nxEvpd0XSv4vvU5JGMoXpuO339ZIPEJ3xfPdeMx8BgIbN0c5BE2IsvP/iSE1QZCIB\nz654KZOhr5bicu96hfH+Fd+K1fZKO9au2yIO2xqAMYdEVZQHJwSGiNN/qXDH4hse\nNhFMo7qU0/R52Xb8lXcqE7qrZgeblg==\n=5Z2k\n-----END PGP SIGNATURE-----", "payload": "tree b5f3db67b5256f774bcd2a315ee00a75dc875f2a\nparent 2113659479a82ea69633b23ef710b58ab127755e\nauthor Luro02 <24826124+Luro02@users.noreply.github.com> 1583055248 +0100\ncommitter Luro02 <24826124+Luro02@users.noreply.github.com> 1585655257 +0200\n\nimprove folder name for persistent doc tests\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2e40ac79615bd21d6f3c5c579e922aecc11ef84e", "html_url": "https://github.com/rust-lang/rust/commit/2e40ac79615bd21d6f3c5c579e922aecc11ef84e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2e40ac79615bd21d6f3c5c579e922aecc11ef84e/comments", "author": {"login": "Luro02", "id": 24826124, "node_id": "MDQ6VXNlcjI0ODI2MTI0", "avatar_url": "https://avatars.githubusercontent.com/u/24826124?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Luro02", "html_url": "https://github.com/Luro02", "followers_url": "https://api.github.com/users/Luro02/followers", "following_url": "https://api.github.com/users/Luro02/following{/other_user}", "gists_url": "https://api.github.com/users/Luro02/gists{/gist_id}", "starred_url": "https://api.github.com/users/Luro02/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Luro02/subscriptions", "organizations_url": "https://api.github.com/users/Luro02/orgs", "repos_url": "https://api.github.com/users/Luro02/repos", "events_url": "https://api.github.com/users/Luro02/events{/privacy}", "received_events_url": "https://api.github.com/users/Luro02/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Luro02", "id": 24826124, "node_id": "MDQ6VXNlcjI0ODI2MTI0", "avatar_url": "https://avatars.githubusercontent.com/u/24826124?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Luro02", "html_url": "https://github.com/Luro02", "followers_url": "https://api.github.com/users/Luro02/followers", "following_url": "https://api.github.com/users/Luro02/following{/other_user}", "gists_url": "https://api.github.com/users/Luro02/gists{/gist_id}", "starred_url": "https://api.github.com/users/Luro02/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Luro02/subscriptions", "organizations_url": "https://api.github.com/users/Luro02/orgs", "repos_url": "https://api.github.com/users/Luro02/repos", "events_url": "https://api.github.com/users/Luro02/events{/privacy}", "received_events_url": "https://api.github.com/users/Luro02/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2113659479a82ea69633b23ef710b58ab127755e", "url": "https://api.github.com/repos/rust-lang/rust/commits/2113659479a82ea69633b23ef710b58ab127755e", "html_url": "https://github.com/rust-lang/rust/commit/2113659479a82ea69633b23ef710b58ab127755e"}], "stats": {"total": 103, "additions": 63, "deletions": 40}, "files": [{"sha": "f9e9a07914d692efc378f74b41ae61f5a73bde8d", "filename": "src/librustdoc/test.rs", "status": "modified", "additions": 63, "deletions": 40, "changes": 103, "blob_url": "https://github.com/rust-lang/rust/blob/2e40ac79615bd21d6f3c5c579e922aecc11ef84e/src%2Flibrustdoc%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2e40ac79615bd21d6f3c5c579e922aecc11ef84e/src%2Flibrustdoc%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Ftest.rs?ref=2e40ac79615bd21d6f3c5c579e922aecc11ef84e", "patch": "@@ -13,6 +13,7 @@ use rustc_span::source_map::SourceMap;\n use rustc_span::symbol::sym;\n use rustc_span::{BytePos, FileName, Pos, Span, DUMMY_SP};\n use rustc_target::spec::TargetTriple;\n+use std::collections::HashMap;\n use std::env;\n use std::io::{self, Write};\n use std::panic;\n@@ -190,10 +191,23 @@ enum TestFailure {\n     UnexpectedRunPass,\n }\n \n+enum DirState {\n+    Temp(tempfile::TempDir),\n+    Perm(PathBuf),\n+}\n+\n+impl DirState {\n+    fn path(&self) -> &std::path::Path {\n+        match self {\n+            DirState::Temp(t) => t.path(),\n+            DirState::Perm(p) => p.as_path(),\n+        }\n+    }\n+}\n+\n fn run_test(\n     test: &str,\n     cratename: &str,\n-    filename: &FileName,\n     line: usize,\n     options: Options,\n     should_panic: bool,\n@@ -206,47 +220,11 @@ fn run_test(\n     mut error_codes: Vec<String>,\n     opts: &TestOptions,\n     edition: Edition,\n+    outdir: DirState,\n+    path: PathBuf,\n ) -> Result<(), TestFailure> {\n     let (test, line_offset) = make_test(test, Some(cratename), as_test_harness, opts, edition);\n \n-    // FIXME(#44940): if doctests ever support path remapping, then this filename\n-    // needs to be the result of `SourceMap::span_to_unmapped_path`.\n-    let path = match filename {\n-        FileName::Real(path) => path.clone(),\n-        _ => PathBuf::from(r\"doctest.rs\"),\n-    };\n-\n-    enum DirState {\n-        Temp(tempfile::TempDir),\n-        Perm(PathBuf),\n-    }\n-\n-    impl DirState {\n-        fn path(&self) -> &std::path::Path {\n-            match self {\n-                DirState::Temp(t) => t.path(),\n-                DirState::Perm(p) => p.as_path(),\n-            }\n-        }\n-    }\n-\n-    let outdir = if let Some(mut path) = options.persist_doctests {\n-        path.push(format!(\n-            \"{}_{}\",\n-            filename.to_string().rsplit('/').next().unwrap().replace(\".\", \"_\"),\n-            line\n-        ));\n-        std::fs::create_dir_all(&path).expect(\"Couldn't create directory for doctest executables\");\n-\n-        DirState::Perm(path)\n-    } else {\n-        DirState::Temp(\n-            TempFileBuilder::new()\n-                .prefix(\"rustdoctest\")\n-                .tempdir()\n-                .expect(\"rustdoc needs a tempdir\"),\n-        )\n-    };\n     let output_file = outdir.path().join(\"rust_out\");\n \n     let rustc_binary = options\n@@ -639,6 +617,7 @@ pub struct Collector {\n     position: Span,\n     source_map: Option<Lrc<SourceMap>>,\n     filename: Option<PathBuf>,\n+    visited_tests: HashMap<(String, usize), usize>,\n }\n \n impl Collector {\n@@ -662,6 +641,7 @@ impl Collector {\n             position: DUMMY_SP,\n             source_map,\n             filename,\n+            visited_tests: HashMap::new(),\n         }\n     }\n \n@@ -705,6 +685,48 @@ impl Tester for Collector {\n         let target = self.options.target.clone();\n         let target_str = target.to_string();\n \n+        // FIXME(#44940): if doctests ever support path remapping, then this filename\n+        // needs to be the result of `SourceMap::span_to_unmapped_path`.\n+        let path = match &filename {\n+            FileName::Real(path) => path.clone(),\n+            _ => PathBuf::from(r\"doctest.rs\"),\n+        };\n+\n+        let outdir = if let Some(mut path) = options.persist_doctests.clone() {\n+            // For example `module/file.rs` would become `module_file_rs`\n+            let folder_name = filename\n+                .to_string()\n+                .chars()\n+                .map(|c| if c == '/' || c == '.' { '_' } else { c })\n+                .collect::<String>();\n+\n+            path.push(format!(\n+                \"{name}_{line}_{number}\",\n+                name = folder_name,\n+                number = {\n+                    // Increases the current test number, if this file already\n+                    // exists or it creates a new entry with a test number of 0.\n+                    self.visited_tests\n+                        .entry((folder_name.clone(), line))\n+                        .and_modify(|v| *v += 1)\n+                        .or_insert(0)\n+                },\n+                line = line,\n+            ));\n+\n+            std::fs::create_dir_all(&path)\n+                .expect(\"Couldn't create directory for doctest executables\");\n+\n+            DirState::Perm(path)\n+        } else {\n+            DirState::Temp(\n+                TempFileBuilder::new()\n+                    .prefix(\"rustdoctest\")\n+                    .tempdir()\n+                    .expect(\"rustdoc needs a tempdir\"),\n+            )\n+        };\n+\n         debug!(\"creating test {}: {}\", name, test);\n         self.tests.push(testing::TestDescAndFn {\n             desc: testing::TestDesc {\n@@ -723,7 +745,6 @@ impl Tester for Collector {\n                 let res = run_test(\n                     &test,\n                     &cratename,\n-                    &filename,\n                     line,\n                     options,\n                     config.should_panic,\n@@ -736,6 +757,8 @@ impl Tester for Collector {\n                     config.error_codes,\n                     &opts,\n                     edition,\n+                    outdir,\n+                    path,\n                 );\n \n                 if let Err(err) = res {"}]}