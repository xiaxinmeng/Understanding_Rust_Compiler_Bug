{"sha": "95daca4aaf9ec8e4f1dd2188147c8958b1d1467f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk1ZGFjYTRhYWY5ZWM4ZTRmMWRkMjE4ODE0N2M4OTU4YjFkMTQ2N2Y=", "commit": {"author": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2019-02-19T17:13:47Z"}, "committer": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2019-02-20T03:59:23Z"}, "message": "Rollup merge of #58569 - kenta7777:reduce-code-repetition, r=oli-obk\n\nReduce Some Code Repetitions like `(n << amt) >> amt`\n\nThis Pull Request is related to [#49937](https://github.com/rust-lang/rust/issues/49937).\nThis Pull Request has reduced repetition of `(n << amt) >> amt`.", "tree": {"sha": "21701d5b5e079385ac0c1c701ef2bf79aedc5e23", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/21701d5b5e079385ac0c1c701ef2bf79aedc5e23"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/95daca4aaf9ec8e4f1dd2188147c8958b1d1467f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEZ1R8CLMp8f2GxWoQ/vbIBR0OATwFAlxs0JsACgkQ/vbIBR0O\nATwVdxAAnndNSSKWpVdBDmTgkmu9/Jk9dpD5Qas2AuklV78gPuVTf+VJOe8Lcrgt\njBKKWl0mXo5XFqH5JSzydZYx/Dbx1oNG0k668yG8rq5mP0H8pK7bTpZee3Z1wAoD\nHqP4EssJtwTn3aFppJ3bXzoNuTbJToE2tLf1a/G/J3innlKfH1iLyWVg3sixaHn5\nh+oodJmCLE5+HpZSVAT+G+n4xrtYNCGTQPZZG+6OSnL7m1P2NLL815qxhIk7vxFG\nUs6IA5mxWuv9xs8gZNlaNvEEQ2smUyR9gpNxpuUMumHnwTAWUUCZl+unIJvJFcRR\n0zvTQmbciX22bGZlcEpe1AY6lueyJ7wRJviZQxYesBLlV3nvm5Wp0Dx8m3egWfbl\nI+9u9R58xXBLhPGhqNDtU5P6DyFDZD82gZmgOyDOdMIrsZtjijD0grUsmo2GfBUK\n2O73eKCbqkio+plDsuPqppptxvFAD944qdMpm4kBIJkpnI4FWOaFZuDClv7+zgAh\nhV7DRBwrLxDEHFz6eGG04KiHApJpohaLE3ftQboV+h9SJEVSIevZ27nzxA3yOOgY\nSwK2jjyKI98I8oBJiedUUe3HbVsBZ5/vq0uTgkl3CjR/0YhfOh9KGmZ1RuA8d5pU\nfyeLQBxQsPvDH5rcY0NCmx00XiCj6QKJKZ/csdCwdgaTsbJAORw=\n=jK4S\n-----END PGP SIGNATURE-----", "payload": "tree 21701d5b5e079385ac0c1c701ef2bf79aedc5e23\nparent 2f9fa199d260138ba28178585a5c12df2d230588\nparent 94b6bf240a2e78c2f97d33adf433d0c9c03a11c4\nauthor kennytm <kennytm@gmail.com> 1550596427 +0800\ncommitter kennytm <kennytm@gmail.com> 1550635163 +0800\n\nRollup merge of #58569 - kenta7777:reduce-code-repetition, r=oli-obk\n\nReduce Some Code Repetitions like `(n << amt) >> amt`\n\nThis Pull Request is related to [#49937](https://github.com/rust-lang/rust/issues/49937).\nThis Pull Request has reduced repetition of `(n << amt) >> amt`.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/95daca4aaf9ec8e4f1dd2188147c8958b1d1467f", "html_url": "https://github.com/rust-lang/rust/commit/95daca4aaf9ec8e4f1dd2188147c8958b1d1467f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/95daca4aaf9ec8e4f1dd2188147c8958b1d1467f/comments", "author": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2f9fa199d260138ba28178585a5c12df2d230588", "url": "https://api.github.com/repos/rust-lang/rust/commits/2f9fa199d260138ba28178585a5c12df2d230588", "html_url": "https://github.com/rust-lang/rust/commit/2f9fa199d260138ba28178585a5c12df2d230588"}, {"sha": "94b6bf240a2e78c2f97d33adf433d0c9c03a11c4", "url": "https://api.github.com/repos/rust-lang/rust/commits/94b6bf240a2e78c2f97d33adf433d0c9c03a11c4", "html_url": "https://github.com/rust-lang/rust/commit/94b6bf240a2e78c2f97d33adf433d0c9c03a11c4"}], "stats": {"total": 10, "additions": 4, "deletions": 6}, "files": [{"sha": "c6902ddb3c6a65775a1fef69db5076497bafc14f", "filename": "src/librustc_mir/interpret/operand.rs", "status": "modified", "additions": 4, "deletions": 6, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/95daca4aaf9ec8e4f1dd2188147c8958b1d1467f/src%2Flibrustc_mir%2Finterpret%2Foperand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/95daca4aaf9ec8e4f1dd2188147c8958b1d1467f/src%2Flibrustc_mir%2Finterpret%2Foperand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Finterpret%2Foperand.rs?ref=95daca4aaf9ec8e4f1dd2188147c8958b1d1467f", "patch": "@@ -10,6 +10,7 @@ use rustc::mir::interpret::{\n     GlobalId, AllocId, InboundsCheck,\n     ConstValue, Pointer, Scalar,\n     EvalResult, EvalErrorKind,\n+    sign_extend, truncate,\n };\n use super::{\n     EvalContext, Machine, AllocMap, Allocation, AllocationExtra,\n@@ -633,20 +634,17 @@ impl<'a, 'mir, 'tcx, M: Machine<'a, 'mir, 'tcx>> EvalContext<'a, 'mir, 'tcx, M>\n                     Err(_) => return err!(InvalidDiscriminant(raw_discr.erase_tag())),\n                 };\n                 let real_discr = if discr_val.layout.ty.is_signed() {\n-                    let i = bits_discr as i128;\n                     // going from layout tag type to typeck discriminant type\n                     // requires first sign extending with the layout discriminant\n-                    let shift = 128 - discr_val.layout.size.bits();\n-                    let sexted = (i << shift) >> shift;\n+                    let sexted = sign_extend(bits_discr, discr_val.layout.size) as i128;\n                     // and then zeroing with the typeck discriminant type\n                     let discr_ty = rval.layout.ty\n                         .ty_adt_def().expect(\"tagged layout corresponds to adt\")\n                         .repr\n                         .discr_type();\n-                    let discr_ty = layout::Integer::from_attr(self, discr_ty);\n-                    let shift = 128 - discr_ty.size().bits();\n+                    let size = layout::Integer::from_attr(self, discr_ty).size();\n                     let truncatee = sexted as u128;\n-                    (truncatee << shift) >> shift\n+                    truncate(truncatee, size)\n                 } else {\n                     bits_discr\n                 };"}]}