{"sha": "57bab5e0206d887e9e94de7fd95613f789ff6052", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU3YmFiNWUwMjA2ZDg4N2U5ZTk0ZGU3ZmQ5NTYxM2Y3ODlmZjYwNTI=", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2020-07-16T14:36:25Z"}, "committer": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2020-11-17T09:32:48Z"}, "message": "Add check to get windows console type to decide to use colors or not", "tree": {"sha": "5147a486d7288e8b54ab688fe73eec5b538a31fb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5147a486d7288e8b54ab688fe73eec5b538a31fb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/57bab5e0206d887e9e94de7fd95613f789ff6052", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/57bab5e0206d887e9e94de7fd95613f789ff6052", "html_url": "https://github.com/rust-lang/rust/commit/57bab5e0206d887e9e94de7fd95613f789ff6052", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/57bab5e0206d887e9e94de7fd95613f789ff6052/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "54e8216348a1cd47a7fe43bbfbf7fd469ae83c44", "url": "https://api.github.com/repos/rust-lang/rust/commits/54e8216348a1cd47a7fe43bbfbf7fd469ae83c44", "html_url": "https://github.com/rust-lang/rust/commit/54e8216348a1cd47a7fe43bbfbf7fd469ae83c44"}], "stats": {"total": 32, "additions": 30, "deletions": 2}, "files": [{"sha": "085f155ec2595c584826534b7ed7c3ff1579e0d8", "filename": "src/librustdoc/Cargo.toml", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/57bab5e0206d887e9e94de7fd95613f789ff6052/src%2Flibrustdoc%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/57bab5e0206d887e9e94de7fd95613f789ff6052/src%2Flibrustdoc%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2FCargo.toml?ref=57bab5e0206d887e9e94de7fd95613f789ff6052", "patch": "@@ -20,3 +20,6 @@ regex = \"1\"\n \n [dev-dependencies]\n expect-test = \"1.0\"\n+\n+[target.'cfg(windows)'.dependencies]\n+termcolor = \"1.0\""}, {"sha": "d1219c30b894d0d229c696a218b1f8b38b6bec0d", "filename": "src/librustdoc/doctest.rs", "status": "modified", "additions": 23, "deletions": 2, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/57bab5e0206d887e9e94de7fd95613f789ff6052/src%2Flibrustdoc%2Fdoctest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57bab5e0206d887e9e94de7fd95613f789ff6052/src%2Flibrustdoc%2Fdoctest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fdoctest.rs?ref=57bab5e0206d887e9e94de7fd95613f789ff6052", "patch": "@@ -298,10 +298,31 @@ fn run_test(\n         ErrorOutputType::HumanReadable(kind) => {\n             let (_, color_config) = kind.unzip();\n             match color_config {\n-                ColorConfig::Never => {}\n-                _ => {\n+                ColorConfig::Never => {\n+                    compiler.arg(\"--color\").arg(\"never\");\n+                }\n+                ColorConfig::Always => {\n                     compiler.arg(\"--color\").arg(\"always\");\n                 }\n+                ColorConfig::Auto => {\n+                    #[cfg(windows)]\n+                    {\n+                        // This specific check is because old windows consoles require a connection\n+                        // to be able to display colors (and they don't support ANSI), which we\n+                        // cannot in here, so in case this is an old windows console, we can't\n+                        // display colors.\n+                        use crate::termcolor::{ColorChoice, StandardStream, WriteColor};\n+                        if StandardStream::stdout(ColorChoice::Auto).is_synchronous() {\n+                            compiler.arg(\"--color\").arg(\"never\");\n+                        } else {\n+                            compiler.arg(\"--color\").arg(\"always\");\n+                        }\n+                    }\n+                    #[cfg(not(windows))]\n+                    {\n+                        compiler.arg(\"--color\").arg(\"always\");\n+                    }\n+                }\n             }\n         }\n         _ => {}"}, {"sha": "1f46ac59e6a4218db19b486f46d12288a041eb10", "filename": "src/librustdoc/lib.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/57bab5e0206d887e9e94de7fd95613f789ff6052/src%2Flibrustdoc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57bab5e0206d887e9e94de7fd95613f789ff6052/src%2Flibrustdoc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Flib.rs?ref=57bab5e0206d887e9e94de7fd95613f789ff6052", "patch": "@@ -54,6 +54,10 @@ extern crate rustc_target;\n extern crate rustc_trait_selection;\n extern crate rustc_typeck;\n extern crate test as testing;\n+#[macro_use]\n+extern crate tracing;\n+#[cfg(windows)]\n+extern crate termcolor;\n \n use std::default::Default;\n use std::env;"}]}