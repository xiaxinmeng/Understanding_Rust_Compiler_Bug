{"sha": "68aa1331087e51857e91be2a3dc38a5b7ac49bad", "node_id": "C_kwDOAAsO6NoAKDY4YWExMzMxMDg3ZTUxODU3ZTkxYmUyYTNkYzM4YTViN2FjNDliYWQ", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-03-25T13:16:43Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-03-25T13:16:43Z"}, "message": "Auto merge of #14380 - DropDemBits:coalesce-indels, r=Veykril\n\ninternal: Coalesce adjacent Indels\n\nOriginally part of working on a structured snippet API (since sometimes the `$` bit of snippets would be broken off and would lead to it not being recognized), though since this is a pretty separate change, I thought it would make sense to put it into it's own PR.\n\nThe implementation is relatively straight forward and not overly optimized, though it's pretty low hanging fruit to optimize it when need be.", "tree": {"sha": "ddbab09ed7ffd030084c27e01d224b6a8daec143", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ddbab09ed7ffd030084c27e01d224b6a8daec143"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/68aa1331087e51857e91be2a3dc38a5b7ac49bad", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/68aa1331087e51857e91be2a3dc38a5b7ac49bad", "html_url": "https://github.com/rust-lang/rust/commit/68aa1331087e51857e91be2a3dc38a5b7ac49bad", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/68aa1331087e51857e91be2a3dc38a5b7ac49bad/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "eb791f31e688ae00908eb75d4c704ef60c430a92", "url": "https://api.github.com/repos/rust-lang/rust/commits/eb791f31e688ae00908eb75d4c704ef60c430a92", "html_url": "https://github.com/rust-lang/rust/commit/eb791f31e688ae00908eb75d4c704ef60c430a92"}, {"sha": "28225cc33d60615aaa140dc4b0d32e2a1c21462c", "url": "https://api.github.com/repos/rust-lang/rust/commits/28225cc33d60615aaa140dc4b0d32e2a1c21462c", "html_url": "https://github.com/rust-lang/rust/commit/28225cc33d60615aaa140dc4b0d32e2a1c21462c"}], "stats": {"total": 52, "additions": 52, "deletions": 0}, "files": [{"sha": "4705d18187af8f3ac92477a9ecc90d556aa6ee45", "filename": "crates/text-edit/src/lib.rs", "status": "modified", "additions": 52, "deletions": 0, "changes": 52, "blob_url": "https://github.com/rust-lang/rust/blob/68aa1331087e51857e91be2a3dc38a5b7ac49bad/crates%2Ftext-edit%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/68aa1331087e51857e91be2a3dc38a5b7ac49bad/crates%2Ftext-edit%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Ftext-edit%2Fsrc%2Flib.rs?ref=68aa1331087e51857e91be2a3dc38a5b7ac49bad", "patch": "@@ -176,6 +176,7 @@ impl TextEditBuilder {\n     pub fn finish(self) -> TextEdit {\n         let mut indels = self.indels;\n         assert_disjoint_or_equal(&mut indels);\n+        indels = coalesce_indels(indels);\n         TextEdit { indels }\n     }\n     pub fn invalidates_offset(&self, offset: TextSize) -> bool {\n@@ -205,6 +206,21 @@ where\n     indels.clone().zip(indels.skip(1)).all(|(l, r)| l.delete.end() <= r.delete.start() || l == r)\n }\n \n+fn coalesce_indels(indels: Vec<Indel>) -> Vec<Indel> {\n+    indels\n+        .into_iter()\n+        .coalesce(|mut a, b| {\n+            if a.delete.end() == b.delete.start() {\n+                a.insert.push_str(&b.insert);\n+                a.delete = TextRange::new(a.delete.start(), b.delete.end());\n+                Ok(a)\n+            } else {\n+                Err((a, b))\n+            }\n+        })\n+        .collect_vec()\n+}\n+\n #[cfg(test)]\n mod tests {\n     use super::{TextEdit, TextEditBuilder, TextRange};\n@@ -261,4 +277,40 @@ mod tests {\n         let edit2 = TextEdit::delete(range(9, 13));\n         assert!(edit1.union(edit2).is_err());\n     }\n+\n+    #[test]\n+    fn test_coalesce_disjoint() {\n+        let mut builder = TextEditBuilder::default();\n+        builder.replace(range(1, 3), \"aa\".into());\n+        builder.replace(range(5, 7), \"bb\".into());\n+        let edit = builder.finish();\n+\n+        assert_eq!(edit.indels.len(), 2);\n+    }\n+\n+    #[test]\n+    fn test_coalesce_adjacent() {\n+        let mut builder = TextEditBuilder::default();\n+        builder.replace(range(1, 3), \"aa\".into());\n+        builder.replace(range(3, 5), \"bb\".into());\n+\n+        let edit = builder.finish();\n+        assert_eq!(edit.indels.len(), 1);\n+        assert_eq!(edit.indels[0].insert, \"aabb\");\n+        assert_eq!(edit.indels[0].delete, range(1, 5));\n+    }\n+\n+    #[test]\n+    fn test_coalesce_adjacent_series() {\n+        let mut builder = TextEditBuilder::default();\n+        builder.replace(range(1, 3), \"au\".into());\n+        builder.replace(range(3, 5), \"www\".into());\n+        builder.replace(range(5, 8), \"\".into());\n+        builder.replace(range(8, 9), \"ub\".into());\n+\n+        let edit = builder.finish();\n+        assert_eq!(edit.indels.len(), 1);\n+        assert_eq!(edit.indels[0].insert, \"auwwwub\");\n+        assert_eq!(edit.indels[0].delete, range(1, 9));\n+    }\n }"}]}