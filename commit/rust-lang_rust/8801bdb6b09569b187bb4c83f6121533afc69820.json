{"sha": "8801bdb6b09569b187bb4c83f6121533afc69820", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg4MDFiZGI2YjA5NTY5YjE4N2JiNGM4M2Y2MTIxNTMzYWZjNjk4MjA=", "commit": {"author": {"name": "Felix S. Klock II", "email": "pnkfelix@pnkfx.org", "date": "2016-02-06T03:28:20Z"}, "committer": {"name": "Felix S. Klock II", "email": "pnkfelix@pnkfx.org", "date": "2016-02-08T12:44:03Z"}, "message": "Split dummy in region inference graph into distinct source and sink nodes.\n\nWhy do this: The RegionGraph representation previously conflated all\nof the non-variable regions (i.e. the concrete regions such as\nlifetime parameters to the current function) into a single dummy node.\n\nA single dummy node leads DFS on a graph `'a -> '_#1 -> '_#0 -> 'b` to\nclaim that `'_#1` is reachable from `'_#0` (due to `'a` and `'b` being\nconflated in the graph representation), which is incorrect (and can\nlead to soundness bugs later on in compilation, see #30438).\n\nSplitting the dummy node ensures that DFS will never introduce new\nancestor relationships between nodes for variable regions in the\ngraph.", "tree": {"sha": "e51e02455b7c296cb819aa2d00ca7a0b9671ce49", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e51e02455b7c296cb819aa2d00ca7a0b9671ce49"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8801bdb6b09569b187bb4c83f6121533afc69820", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8801bdb6b09569b187bb4c83f6121533afc69820", "html_url": "https://github.com/rust-lang/rust/commit/8801bdb6b09569b187bb4c83f6121533afc69820", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8801bdb6b09569b187bb4c83f6121533afc69820/comments", "author": {"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pnkfelix", "id": 173127, "node_id": "MDQ6VXNlcjE3MzEyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/173127?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pnkfelix", "html_url": "https://github.com/pnkfelix", "followers_url": "https://api.github.com/users/pnkfelix/followers", "following_url": "https://api.github.com/users/pnkfelix/following{/other_user}", "gists_url": "https://api.github.com/users/pnkfelix/gists{/gist_id}", "starred_url": "https://api.github.com/users/pnkfelix/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pnkfelix/subscriptions", "organizations_url": "https://api.github.com/users/pnkfelix/orgs", "repos_url": "https://api.github.com/users/pnkfelix/repos", "events_url": "https://api.github.com/users/pnkfelix/events{/privacy}", "received_events_url": "https://api.github.com/users/pnkfelix/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e06f6928cb840a018706cabf75ab2bf3807551b1", "url": "https://api.github.com/repos/rust-lang/rust/commits/e06f6928cb840a018706cabf75ab2bf3807551b1", "html_url": "https://github.com/rust-lang/rust/commit/e06f6928cb840a018706cabf75ab2bf3807551b1"}], "stats": {"total": 13, "additions": 10, "deletions": 3}, "files": [{"sha": "bfc770d53aaba5c8b5dae220ae268e56dae3f3e1", "filename": "src/librustc/middle/infer/region_inference/mod.rs", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/8801bdb6b09569b187bb4c83f6121533afc69820/src%2Flibrustc%2Fmiddle%2Finfer%2Fregion_inference%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8801bdb6b09569b187bb4c83f6121533afc69820/src%2Flibrustc%2Fmiddle%2Finfer%2Fregion_inference%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Finfer%2Fregion_inference%2Fmod.rs?ref=8801bdb6b09569b187bb4c83f6121533afc69820", "patch": "@@ -1105,7 +1105,14 @@ impl<'a, 'tcx> RegionVarBindings<'a, 'tcx> {\n         for _ in 0..num_vars {\n             graph.add_node(());\n         }\n-        let dummy_idx = graph.add_node(());\n+\n+        // Issue #30438: two distinct dummy nodes, one for incoming\n+        // edges (dummy_source) and another for outgoing edges\n+        // (dummy_sink). In `dummy -> a -> b -> dummy`, using one\n+        // dummy node leads one to think (erroneously) there exists a\n+        // path from `b` to `a`. Two dummy nodes sidesteps the issue.\n+        let dummy_source = graph.add_node(());\n+        let dummy_sink = graph.add_node(());\n \n         for (constraint, _) in constraints.iter() {\n             match *constraint {\n@@ -1115,10 +1122,10 @@ impl<'a, 'tcx> RegionVarBindings<'a, 'tcx> {\n                                    *constraint);\n                 }\n                 ConstrainRegSubVar(_, b_id) => {\n-                    graph.add_edge(dummy_idx, NodeIndex(b_id.index as usize), *constraint);\n+                    graph.add_edge(dummy_source, NodeIndex(b_id.index as usize), *constraint);\n                 }\n                 ConstrainVarSubReg(a_id, _) => {\n-                    graph.add_edge(NodeIndex(a_id.index as usize), dummy_idx, *constraint);\n+                    graph.add_edge(NodeIndex(a_id.index as usize), dummy_sink, *constraint);\n                 }\n             }\n         }"}]}