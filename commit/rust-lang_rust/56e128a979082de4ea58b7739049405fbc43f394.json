{"sha": "56e128a979082de4ea58b7739049405fbc43f394", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU2ZTEyOGE5NzkwODJkZTRlYTU4Yjc3MzkwNDk0MDVmYmM0M2YzOTQ=", "commit": {"author": {"name": "wxb1ank", "email": "wxblank@gmail.com", "date": "2021-06-15T17:29:02Z"}, "committer": {"name": "wxb1ank", "email": "wxblank@gmail.com", "date": "2021-06-15T17:29:02Z"}, "message": "fix: clean-up #8951", "tree": {"sha": "5f85baa3fc4c36162ff2ea3011b796bf6ff56bf2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5f85baa3fc4c36162ff2ea3011b796bf6ff56bf2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/56e128a979082de4ea58b7739049405fbc43f394", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/56e128a979082de4ea58b7739049405fbc43f394", "html_url": "https://github.com/rust-lang/rust/commit/56e128a979082de4ea58b7739049405fbc43f394", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/56e128a979082de4ea58b7739049405fbc43f394/comments", "author": {"login": "wxb1ank", "id": 44535681, "node_id": "MDQ6VXNlcjQ0NTM1Njgx", "avatar_url": "https://avatars.githubusercontent.com/u/44535681?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wxb1ank", "html_url": "https://github.com/wxb1ank", "followers_url": "https://api.github.com/users/wxb1ank/followers", "following_url": "https://api.github.com/users/wxb1ank/following{/other_user}", "gists_url": "https://api.github.com/users/wxb1ank/gists{/gist_id}", "starred_url": "https://api.github.com/users/wxb1ank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wxb1ank/subscriptions", "organizations_url": "https://api.github.com/users/wxb1ank/orgs", "repos_url": "https://api.github.com/users/wxb1ank/repos", "events_url": "https://api.github.com/users/wxb1ank/events{/privacy}", "received_events_url": "https://api.github.com/users/wxb1ank/received_events", "type": "User", "site_admin": false}, "committer": {"login": "wxb1ank", "id": 44535681, "node_id": "MDQ6VXNlcjQ0NTM1Njgx", "avatar_url": "https://avatars.githubusercontent.com/u/44535681?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wxb1ank", "html_url": "https://github.com/wxb1ank", "followers_url": "https://api.github.com/users/wxb1ank/followers", "following_url": "https://api.github.com/users/wxb1ank/following{/other_user}", "gists_url": "https://api.github.com/users/wxb1ank/gists{/gist_id}", "starred_url": "https://api.github.com/users/wxb1ank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wxb1ank/subscriptions", "organizations_url": "https://api.github.com/users/wxb1ank/orgs", "repos_url": "https://api.github.com/users/wxb1ank/repos", "events_url": "https://api.github.com/users/wxb1ank/events{/privacy}", "received_events_url": "https://api.github.com/users/wxb1ank/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7a8a72c38f5626aea6c8f3c2dacbb23ed166901e", "url": "https://api.github.com/repos/rust-lang/rust/commits/7a8a72c38f5626aea6c8f3c2dacbb23ed166901e", "html_url": "https://github.com/rust-lang/rust/commit/7a8a72c38f5626aea6c8f3c2dacbb23ed166901e"}], "stats": {"total": 40, "additions": 25, "deletions": 15}, "files": [{"sha": "049d6cb8e76fbe0d9d746b55b2ea1a2d83aaeb1d", "filename": "editors/code/src/main.ts", "status": "modified", "additions": 9, "deletions": 7, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/56e128a979082de4ea58b7739049405fbc43f394/editors%2Fcode%2Fsrc%2Fmain.ts", "raw_url": "https://github.com/rust-lang/rust/raw/56e128a979082de4ea58b7739049405fbc43f394/editors%2Fcode%2Fsrc%2Fmain.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fmain.ts?ref=56e128a979082de4ea58b7739049405fbc43f394", "patch": "@@ -158,7 +158,9 @@ export async function deactivate() {\n }\n \n async function bootstrap(config: Config, state: PersistentState): Promise<string> {\n-    await vscode.workspace.fs.createDirectory(config.globalStorageUri);\n+    try {\n+        await vscode.workspace.fs.createDirectory(config.globalStorageUri);\n+    } catch {}\n \n     if (!config.currentExtensionIsNightly) {\n         await state.updateNightlyReleaseId(undefined);\n@@ -277,11 +279,11 @@ async function patchelf(dest: vscode.Uri): Promise<void> {\n                     '';\n                 }\n             `;\n-            const origFile = vscode.Uri.file(dest.path + \"-orig\");\n+            const origFile = vscode.Uri.file(dest.fsPath + \"-orig\");\n             await vscode.workspace.fs.rename(dest, origFile);\n             progress.report({ message: \"Patching executable\", increment: 20 });\n             await new Promise((resolve, reject) => {\n-                const handle = exec(`nix-build -E - --argstr srcStr '${origFile.path}' -o '${dest.path}'`,\n+                const handle = exec(`nix-build -E - --argstr srcStr '${origFile.fsPath}' -o '${dest.fsPath}'`,\n                     (err, stdout, stderr) => {\n                         if (err != null) {\n                             reject(Error(stderr));\n@@ -338,14 +340,14 @@ async function getServer(config: Config, state: PersistentState): Promise<string\n         await state.updateServerVersion(undefined);\n     }\n \n-    if (state.serverVersion === config.package.version) return dest.path;\n+    if (state.serverVersion === config.package.version) return dest.fsPath;\n \n     if (config.askBeforeDownload) {\n         const userResponse = await vscode.window.showInformationMessage(\n             `Language server version ${config.package.version} for rust-analyzer is not installed.`,\n             \"Download now\"\n         );\n-        if (userResponse !== \"Download now\") return dest.path;\n+        if (userResponse !== \"Download now\") return dest.fsPath;\n     }\n \n     const releaseTag = config.package.releaseTag;\n@@ -372,7 +374,7 @@ async function getServer(config: Config, state: PersistentState): Promise<string\n     }\n \n     await state.updateServerVersion(config.package.version);\n-    return dest.path;\n+    return dest.fsPath;\n }\n \n function serverPath(config: Config): string | null {\n@@ -383,7 +385,7 @@ async function isNixOs(): Promise<boolean> {\n     try {\n         const contents = (await vscode.workspace.fs.readFile(vscode.Uri.file(\"/etc/os-release\"))).toString();\n         return contents.indexOf(\"ID=nixos\") !== -1;\n-    } catch (e) {\n+    } catch {\n         return false;\n     }\n }"}, {"sha": "722dab756bde43ce3bba7340fdaf0482c6ff0a34", "filename": "editors/code/src/net.ts", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/56e128a979082de4ea58b7739049405fbc43f394/editors%2Fcode%2Fsrc%2Fnet.ts", "raw_url": "https://github.com/rust-lang/rust/raw/56e128a979082de4ea58b7739049405fbc43f394/editors%2Fcode%2Fsrc%2Fnet.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fnet.ts?ref=56e128a979082de4ea58b7739049405fbc43f394", "patch": "@@ -91,7 +91,7 @@ export async function download(opts: DownloadOpts) {\n     // to prevent partially downloaded files when user kills vscode\n     // This also avoids overwriting running executables\n     const randomHex = crypto.randomBytes(5).toString(\"hex\");\n-    const rawDest = path.parse(opts.dest.path);\n+    const rawDest = path.parse(opts.dest.fsPath);\n     const tempFilePath = vscode.Uri.joinPath(vscode.Uri.file(rawDest.dir), `${rawDest.name}${randomHex}`);\n \n     await vscode.window.withProgress(\n@@ -116,7 +116,7 @@ export async function download(opts: DownloadOpts) {\n         }\n     );\n \n-    await vscode.workspace.fs.rename(tempFilePath, opts.dest);\n+    await vscode.workspace.fs.rename(tempFilePath, opts.dest, { overwrite: true });\n }\n \n async function downloadFile(\n@@ -148,15 +148,15 @@ async function downloadFile(\n     const totalBytes = Number(res.headers.get('content-length'));\n     assert(!Number.isNaN(totalBytes), \"Sanity check of content-length protocol\");\n \n-    log.debug(\"Downloading file of\", totalBytes, \"bytes size from\", urlString, \"to\", destFilePath.path);\n+    log.debug(\"Downloading file of\", totalBytes, \"bytes size from\", urlString, \"to\", destFilePath.fsPath);\n \n     let readBytes = 0;\n     res.body.on(\"data\", (chunk: Buffer) => {\n         readBytes += chunk.length;\n         onProgress(readBytes, totalBytes);\n     });\n \n-    const destFileStream = fs.createWriteStream(destFilePath.path, { mode });\n+    const destFileStream = fs.createWriteStream(destFilePath.fsPath, { mode });\n     const srcStream = gunzip ? res.body.pipe(zlib.createGunzip()) : res.body;\n \n     await pipeline(srcStream, destFileStream);"}, {"sha": "355dd76fe5095551a5adfbc4ee6469acaf929183", "filename": "editors/code/src/toolchain.ts", "status": "modified", "additions": 12, "deletions": 4, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/56e128a979082de4ea58b7739049405fbc43f394/editors%2Fcode%2Fsrc%2Ftoolchain.ts", "raw_url": "https://github.com/rust-lang/rust/raw/56e128a979082de4ea58b7739049405fbc43f394/editors%2Fcode%2Fsrc%2Ftoolchain.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Ftoolchain.ts?ref=56e128a979082de4ea58b7739049405fbc43f394", "patch": "@@ -159,7 +159,7 @@ export const getPathForExecutable = memoize(\n             // it is not mentioned in docs and cannot be infered by the type signature...\n             const standardPath = vscode.Uri.joinPath(vscode.Uri.file(os.homedir()), \".cargo\", \"bin\", executableName);\n \n-            if (isFile(standardPath.path)) return standardPath.path;\n+            if (isFileAtUri(standardPath)) return standardPath.fsPath;\n         } catch (err) {\n             log.error(\"Failed to read the fs info\", err);\n         }\n@@ -177,9 +177,17 @@ function lookupInPath(exec: string): boolean {\n             : [candidate];\n     });\n \n-    return candidates.some(isFile);\n+    return candidates.some(isFileAtPath);\n }\n \n-async function isFile(path: string): Promise<boolean> {\n-    return ((await vscode.workspace.fs.stat(vscode.Uri.file(path))).type & vscode.FileType.File) !== 0;\n+async function isFileAtPath(path: string): Promise<boolean> {\n+    return isFileAtUri(vscode.Uri.file(path));\n+}\n+\n+async function isFileAtUri(uri: vscode.Uri): Promise<boolean> {\n+    try {\n+        return ((await vscode.workspace.fs.stat(uri)).type & vscode.FileType.File) !== 0;\n+    } catch {\n+        return false;\n+    }\n }"}]}