{"sha": "6e436be91730880449ae8bed0740b8d009fd1f78", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZlNDM2YmU5MTczMDg4MDQ0OWFlOGJlZDA3NDBiOGQwMDlmZDFmNzg=", "commit": {"author": {"name": "Eduard-Mihai Burtescu", "email": "edy.burt@gmail.com", "date": "2016-11-12T08:38:44Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2016-11-12T08:38:44Z"}, "message": "Rollup merge of #37709 - bluss:cleaner-vec-extend, r=alexcrichton\n\nvec: Write the .extend() specialization in cleaner style\n\nAs far as possible, use regular `default fn` specialization in favour of\nad-hoc conditionals.\n\nNo intentional functional change. Code quality was validated against the same\nbenchmarks that were used in initial trusted len development.\n\nThis change is prompted by taking impressions from\nhttps://github.com/rust-lang/rust/issues/27749#issuecomment-244498705", "tree": {"sha": "c6f34d0f632ed4cf5c5c806ce4898bc60e762d10", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c6f34d0f632ed4cf5c5c806ce4898bc60e762d10"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6e436be91730880449ae8bed0740b8d009fd1f78", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6e436be91730880449ae8bed0740b8d009fd1f78", "html_url": "https://github.com/rust-lang/rust/commit/6e436be91730880449ae8bed0740b8d009fd1f78", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6e436be91730880449ae8bed0740b8d009fd1f78/comments", "author": {"login": "eddyb", "id": 77424, "node_id": "MDQ6VXNlcjc3NDI0", "avatar_url": "https://avatars.githubusercontent.com/u/77424?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eddyb", "html_url": "https://github.com/eddyb", "followers_url": "https://api.github.com/users/eddyb/followers", "following_url": "https://api.github.com/users/eddyb/following{/other_user}", "gists_url": "https://api.github.com/users/eddyb/gists{/gist_id}", "starred_url": "https://api.github.com/users/eddyb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eddyb/subscriptions", "organizations_url": "https://api.github.com/users/eddyb/orgs", "repos_url": "https://api.github.com/users/eddyb/repos", "events_url": "https://api.github.com/users/eddyb/events{/privacy}", "received_events_url": "https://api.github.com/users/eddyb/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "69717bbdedbc9cecb3b8e133d1e1a4813e34b4e1", "url": "https://api.github.com/repos/rust-lang/rust/commits/69717bbdedbc9cecb3b8e133d1e1a4813e34b4e1", "html_url": "https://github.com/rust-lang/rust/commit/69717bbdedbc9cecb3b8e133d1e1a4813e34b4e1"}, {"sha": "5058e58676bd6c3af63fc4e35a327c07fce2a276", "url": "https://api.github.com/repos/rust-lang/rust/commits/5058e58676bd6c3af63fc4e35a327c07fce2a276", "html_url": "https://github.com/rust-lang/rust/commit/5058e58676bd6c3af63fc4e35a327c07fce2a276"}], "stats": {"total": 71, "additions": 41, "deletions": 30}, "files": [{"sha": "53b7ae0703bf4819e29f50a11ca3bbce6c7f99eb", "filename": "src/libcollections/vec.rs", "status": "modified", "additions": 41, "deletions": 30, "changes": 71, "blob_url": "https://github.com/rust-lang/rust/blob/6e436be91730880449ae8bed0740b8d009fd1f78/src%2Flibcollections%2Fvec.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6e436be91730880449ae8bed0740b8d009fd1f78/src%2Flibcollections%2Fvec.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcollections%2Fvec.rs?ref=6e436be91730880449ae8bed0740b8d009fd1f78", "patch": "@@ -1586,36 +1586,34 @@ impl<'a, T> IntoIterator for &'a mut Vec<T> {\n impl<T> Extend<T> for Vec<T> {\n     #[inline]\n     fn extend<I: IntoIterator<Item = T>>(&mut self, iter: I) {\n-        self.extend_desugared(iter.into_iter())\n+        self.spec_extend(iter.into_iter())\n     }\n }\n \n-trait IsTrustedLen : Iterator {\n-    fn trusted_len(&self) -> Option<usize> { None }\n+trait SpecExtend<I> {\n+    fn spec_extend(&mut self, iter: I);\n }\n-impl<I> IsTrustedLen for I where I: Iterator { }\n \n-impl<I> IsTrustedLen for I where I: TrustedLen\n+impl<I, T> SpecExtend<I> for Vec<T>\n+    where I: Iterator<Item=T>,\n {\n-    fn trusted_len(&self) -> Option<usize> {\n-        let (low, high) = self.size_hint();\n+    default fn spec_extend(&mut self, iter: I) {\n+        self.extend_desugared(iter)\n+    }\n+}\n+\n+impl<I, T> SpecExtend<I> for Vec<T>\n+    where I: TrustedLen<Item=T>,\n+{\n+    fn spec_extend(&mut self, iterator: I) {\n+        // This is the case for a TrustedLen iterator.\n+        let (low, high) = iterator.size_hint();\n         if let Some(high_value) = high {\n             debug_assert_eq!(low, high_value,\n                              \"TrustedLen iterator's size hint is not exact: {:?}\",\n                              (low, high));\n         }\n-        high\n-    }\n-}\n-\n-impl<T> Vec<T> {\n-    fn extend_desugared<I: Iterator<Item = T>>(&mut self, mut iterator: I) {\n-        // This function should be the moral equivalent of:\n-        //\n-        //      for item in iterator {\n-        //          self.push(item);\n-        //      }\n-        if let Some(additional) = iterator.trusted_len() {\n+        if let Some(additional) = high {\n             self.reserve(additional);\n             unsafe {\n                 let mut ptr = self.as_mut_ptr().offset(self.len() as isize);\n@@ -1628,17 +1626,30 @@ impl<T> Vec<T> {\n                 }\n             }\n         } else {\n-            while let Some(element) = iterator.next() {\n-                let len = self.len();\n-                if len == self.capacity() {\n-                    let (lower, _) = iterator.size_hint();\n-                    self.reserve(lower.saturating_add(1));\n-                }\n-                unsafe {\n-                    ptr::write(self.get_unchecked_mut(len), element);\n-                    // NB can't overflow since we would have had to alloc the address space\n-                    self.set_len(len + 1);\n-                }\n+            self.extend_desugared(iterator)\n+        }\n+    }\n+}\n+\n+impl<T> Vec<T> {\n+    fn extend_desugared<I: Iterator<Item = T>>(&mut self, mut iterator: I) {\n+        // This is the case for a general iterator.\n+        //\n+        // This function should be the moral equivalent of:\n+        //\n+        //      for item in iterator {\n+        //          self.push(item);\n+        //      }\n+        while let Some(element) = iterator.next() {\n+            let len = self.len();\n+            if len == self.capacity() {\n+                let (lower, _) = iterator.size_hint();\n+                self.reserve(lower.saturating_add(1));\n+            }\n+            unsafe {\n+                ptr::write(self.get_unchecked_mut(len), element);\n+                // NB can't overflow since we would have had to alloc the address space\n+                self.set_len(len + 1);\n             }\n         }\n     }"}]}