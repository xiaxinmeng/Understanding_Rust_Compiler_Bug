{"sha": "da2d8a4c5797b3d1e2139a1ec0638e1b0546fd0c", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRhMmQ4YTRjNTc5N2IzZDFlMjEzOWExZWMwNjM4ZTFiMDU0NmZkMGM=", "commit": {"author": {"name": "Evgenii", "email": "evgeniy@nspcc.ru", "date": "2019-02-06T06:34:50Z"}, "committer": {"name": "Evgenii", "email": "evgeniy@nspcc.ru", "date": "2019-02-06T07:05:51Z"}, "message": "calculate statement first line properly", "tree": {"sha": "84f20890621adecc5984b914a7fecb893be18c60", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/84f20890621adecc5984b914a7fecb893be18c60"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/da2d8a4c5797b3d1e2139a1ec0638e1b0546fd0c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/da2d8a4c5797b3d1e2139a1ec0638e1b0546fd0c", "html_url": "https://github.com/rust-lang/rust/commit/da2d8a4c5797b3d1e2139a1ec0638e1b0546fd0c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/da2d8a4c5797b3d1e2139a1ec0638e1b0546fd0c/comments", "author": {"login": "fyrchik", "id": 22011053, "node_id": "MDQ6VXNlcjIyMDExMDUz", "avatar_url": "https://avatars.githubusercontent.com/u/22011053?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fyrchik", "html_url": "https://github.com/fyrchik", "followers_url": "https://api.github.com/users/fyrchik/followers", "following_url": "https://api.github.com/users/fyrchik/following{/other_user}", "gists_url": "https://api.github.com/users/fyrchik/gists{/gist_id}", "starred_url": "https://api.github.com/users/fyrchik/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fyrchik/subscriptions", "organizations_url": "https://api.github.com/users/fyrchik/orgs", "repos_url": "https://api.github.com/users/fyrchik/repos", "events_url": "https://api.github.com/users/fyrchik/events{/privacy}", "received_events_url": "https://api.github.com/users/fyrchik/received_events", "type": "User", "site_admin": false}, "committer": {"login": "fyrchik", "id": 22011053, "node_id": "MDQ6VXNlcjIyMDExMDUz", "avatar_url": "https://avatars.githubusercontent.com/u/22011053?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fyrchik", "html_url": "https://github.com/fyrchik", "followers_url": "https://api.github.com/users/fyrchik/followers", "following_url": "https://api.github.com/users/fyrchik/following{/other_user}", "gists_url": "https://api.github.com/users/fyrchik/gists{/gist_id}", "starred_url": "https://api.github.com/users/fyrchik/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fyrchik/subscriptions", "organizations_url": "https://api.github.com/users/fyrchik/orgs", "repos_url": "https://api.github.com/users/fyrchik/repos", "events_url": "https://api.github.com/users/fyrchik/events{/privacy}", "received_events_url": "https://api.github.com/users/fyrchik/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "aec0a7c99952649e8fbf9bf5f4609af470c17c83", "url": "https://api.github.com/repos/rust-lang/rust/commits/aec0a7c99952649e8fbf9bf5f4609af470c17c83", "html_url": "https://github.com/rust-lang/rust/commit/aec0a7c99952649e8fbf9bf5f4609af470c17c83"}], "stats": {"total": 64, "additions": 54, "deletions": 10}, "files": [{"sha": "52b55a9a1752104e7c4521d6cc5ef8746e5366a0", "filename": "src/attr.rs", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/da2d8a4c5797b3d1e2139a1ec0638e1b0546fd0c/src%2Fattr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/da2d8a4c5797b3d1e2139a1ec0638e1b0546fd0c/src%2Fattr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fattr.rs?ref=da2d8a4c5797b3d1e2139a1ec0638e1b0546fd0c", "patch": "@@ -34,6 +34,18 @@ pub fn get_attrs_from_stmt(stmt: &ast::Stmt) -> &[ast::Attribute] {\n     }\n }\n \n+pub fn get_span_without_attrs(stmt: &ast::Stmt) -> Span {\n+    match stmt.node {\n+        ast::StmtKind::Local(ref local) => local.span,\n+        ast::StmtKind::Item(ref item) => item.span,\n+        ast::StmtKind::Expr(ref expr) | ast::StmtKind::Semi(ref expr) => expr.span,\n+        ast::StmtKind::Mac(ref mac) => {\n+            let (ref mac, _, _) = **mac;\n+            mac.span\n+        }\n+    }\n+}\n+\n /// Returns attributes that are within `outer_span`.\n pub fn filter_inline_attrs(attrs: &[ast::Attribute], outer_span: Span) -> Vec<ast::Attribute> {\n     attrs"}, {"sha": "41309f5272e8ce22a380a1f0cd9fb2c468d3cfe5", "filename": "src/visitor.rs", "status": "modified", "additions": 18, "deletions": 10, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/da2d8a4c5797b3d1e2139a1ec0638e1b0546fd0c/src%2Fvisitor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/da2d8a4c5797b3d1e2139a1ec0638e1b0546fd0c/src%2Fvisitor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fvisitor.rs?ref=da2d8a4c5797b3d1e2139a1ec0638e1b0546fd0c", "patch": "@@ -113,7 +113,7 @@ impl<'b, 'a: 'b> FmtVisitor<'a> {\n             ast::StmtKind::Local(..) | ast::StmtKind::Expr(..) | ast::StmtKind::Semi(..) => {\n                 let attrs = get_attrs_from_stmt(stmt);\n                 if contains_skip(attrs) {\n-                    self.push_skipped_with_span(attrs, stmt.span());\n+                    self.push_skipped_with_span(attrs, stmt.span(), get_span_without_attrs(stmt));\n                 } else {\n                     let shape = self.shape();\n                     let rewrite = self.with_context(|ctx| stmt.rewrite(&ctx, shape));\n@@ -123,7 +123,7 @@ impl<'b, 'a: 'b> FmtVisitor<'a> {\n             ast::StmtKind::Mac(ref mac) => {\n                 let (ref mac, _macro_style, ref attrs) = **mac;\n                 if self.visit_attrs(attrs, ast::AttrStyle::Outer) {\n-                    self.push_skipped_with_span(attrs, stmt.span());\n+                    self.push_skipped_with_span(attrs, stmt.span(), get_span_without_attrs(stmt));\n                 } else {\n                     self.visit_mac(mac, None, MacroPosition::Statement);\n                 }\n@@ -331,14 +331,14 @@ impl<'b, 'a: 'b> FmtVisitor<'a> {\n             // For use items, skip rewriting attributes. Just check for a skip attribute.\n             ast::ItemKind::Use(..) => {\n                 if contains_skip(attrs) {\n-                    self.push_skipped_with_span(attrs.as_slice(), item.span());\n+                    self.push_skipped_with_span(attrs.as_slice(), item.span(), item.span());\n                     return;\n                 }\n             }\n             // Module is inline, in this case we treat it like any other item.\n             _ if !is_mod_decl(item) => {\n                 if self.visit_attrs(&item.attrs, ast::AttrStyle::Outer) {\n-                    self.push_skipped_with_span(item.attrs.as_slice(), item.span());\n+                    self.push_skipped_with_span(item.attrs.as_slice(), item.span(), item.span());\n                     return;\n                 }\n             }\n@@ -357,7 +357,7 @@ impl<'b, 'a: 'b> FmtVisitor<'a> {\n             }\n             _ => {\n                 if self.visit_attrs(&item.attrs, ast::AttrStyle::Outer) {\n-                    self.push_skipped_with_span(item.attrs.as_slice(), item.span());\n+                    self.push_skipped_with_span(item.attrs.as_slice(), item.span(), item.span());\n                     return;\n                 }\n             }\n@@ -474,7 +474,7 @@ impl<'b, 'a: 'b> FmtVisitor<'a> {\n         skip_out_of_file_lines_range_visitor!(self, ti.span);\n \n         if self.visit_attrs(&ti.attrs, ast::AttrStyle::Outer) {\n-            self.push_skipped_with_span(ti.attrs.as_slice(), ti.span());\n+            self.push_skipped_with_span(ti.attrs.as_slice(), ti.span(), ti.span());\n             return;\n         }\n \n@@ -518,7 +518,7 @@ impl<'b, 'a: 'b> FmtVisitor<'a> {\n         skip_out_of_file_lines_range_visitor!(self, ii.span);\n \n         if self.visit_attrs(&ii.attrs, ast::AttrStyle::Outer) {\n-            self.push_skipped_with_span(ii.attrs.as_slice(), ii.span());\n+            self.push_skipped_with_span(ii.attrs.as_slice(), ii.span(), ii.span());\n             return;\n         }\n \n@@ -592,16 +592,24 @@ impl<'b, 'a: 'b> FmtVisitor<'a> {\n         self.push_rewrite_inner(span, rewrite);\n     }\n \n-    pub fn push_skipped_with_span(&mut self, attrs: &[ast::Attribute], item_span: Span) {\n+    pub fn push_skipped_with_span(\n+        &mut self,\n+        attrs: &[ast::Attribute],\n+        item_span: Span,\n+        main_span: Span,\n+    ) {\n         self.format_missing_with_indent(source!(self, item_span).lo());\n         // do not take into account the lines with attributes as part of the skipped range\n         let attrs_end = attrs\n             .iter()\n             .map(|attr| self.source_map.lookup_char_pos(attr.span().hi()).line)\n             .max()\n             .unwrap_or(1);\n-        // Add 1 to get the line past the last attribute\n-        let lo = attrs_end + 1;\n+        let first_line = self.source_map.lookup_char_pos(main_span.lo()).line;\n+        // Statement can start after some newlines and/or spaces\n+        // or it can be on the same line as the last attribute.\n+        // So here we need to take a minimum between two.\n+        let lo = std::cmp::min(attrs_end + 1, first_line);\n         self.push_rewrite_inner(item_span, None);\n         let hi = self.line_number + 1;\n         self.skipped_range.push((lo, hi));"}, {"sha": "680a80ef3339897b0c13de2d0953df589eb804e1", "filename": "tests/source/issue-3304.rs", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/da2d8a4c5797b3d1e2139a1ec0638e1b0546fd0c/tests%2Fsource%2Fissue-3304.rs", "raw_url": "https://github.com/rust-lang/rust/raw/da2d8a4c5797b3d1e2139a1ec0638e1b0546fd0c/tests%2Fsource%2Fissue-3304.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fissue-3304.rs?ref=da2d8a4c5797b3d1e2139a1ec0638e1b0546fd0c", "patch": "@@ -0,0 +1,12 @@\n+// rustfmt-error_on_line_overflow: true\n+\n+macro_rules! test_macro {\n+    ($($id:ident),*) => {};\n+}\n+\n+fn main() {\n+    #[rustfmt::skip] test_macro! { one, two, three, four, five, six, seven, eight, night, ten, eleven, twelve, thirteen, fourteen, fiveteen };\n+    #[rustfmt::skip]\n+    \n+    test_macro! { one, two, three, four, five, six, seven, eight, night, ten, eleven, twelve, thirteen, fourteen, fiveteen };\n+}"}, {"sha": "680a80ef3339897b0c13de2d0953df589eb804e1", "filename": "tests/target/issue-3304.rs", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/da2d8a4c5797b3d1e2139a1ec0638e1b0546fd0c/tests%2Ftarget%2Fissue-3304.rs", "raw_url": "https://github.com/rust-lang/rust/raw/da2d8a4c5797b3d1e2139a1ec0638e1b0546fd0c/tests%2Ftarget%2Fissue-3304.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fissue-3304.rs?ref=da2d8a4c5797b3d1e2139a1ec0638e1b0546fd0c", "patch": "@@ -0,0 +1,12 @@\n+// rustfmt-error_on_line_overflow: true\n+\n+macro_rules! test_macro {\n+    ($($id:ident),*) => {};\n+}\n+\n+fn main() {\n+    #[rustfmt::skip] test_macro! { one, two, three, four, five, six, seven, eight, night, ten, eleven, twelve, thirteen, fourteen, fiveteen };\n+    #[rustfmt::skip]\n+    \n+    test_macro! { one, two, three, four, five, six, seven, eight, night, ten, eleven, twelve, thirteen, fourteen, fiveteen };\n+}"}]}