{"sha": "0a2562bf4de82b897beacf788e153f5738458325", "node_id": "C_kwDOAAsO6NoAKDBhMjU2MmJmNGRlODJiODk3YmVhY2Y3ODhlMTUzZjU3Mzg0NTgzMjU", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-05-01T15:10:24Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-05-01T15:10:24Z"}, "message": "Rollup merge of #111042 - Zalathar:no-coverage, r=wesleywiser\n\nAdd `#[no_coverage]` to the test harness's `fn main`\n\nThere are two main motivations for adding `#[no_coverage]` to the test harness's entry point:\n\n- The entry point is trivial compiler-generated code that doesn't correspond to user source, and it always runs, so there's no value in instrumenting it for coverage.\n- Because it has dummy spans, it causes the instrumentor implementation to emit invalid coverage mappings that confuse `llvm-cov` and result in strange coverage reports.\n\nFixes #110749.", "tree": {"sha": "86d653b537a79b7f14be61e22cc34f3cf987b6fd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/86d653b537a79b7f14be61e22cc34f3cf987b6fd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0a2562bf4de82b897beacf788e153f5738458325", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkT9ZgCRBK7hj4Ov3rIwAAJrgIAI7FkVR5z/AsxwJD8z+aCRbp\nE++m8WLg/k+z4k96rhEp1OeOz8iFZlCBcCvn2TquHXqEObYIN3csAtEDJfM4mf7N\nxMncOPy+mKuFt/GP1EBRVzlhpwEpg/OEgNM3wBRvDHIV91vBanR5UxBpJGHsGi7/\n50+h6D79s+64jVayfHoIDEZNjuCZvMgMjxGwNsgWZxx4/ZAeAdDzsYgcOVnOXxyu\ndp0hbKIr4G5Aaznu/6xVrdDAR22q3smfoAuvLvIY3PQySN3WBpRidhKCVjEh4vM+\ng5LQlhNWVzaC1/lkENyp0nvIYECcJesOTP/aMbIQ4U/TiJJFKSKdm7qaLocaX/I=\n=IRhf\n-----END PGP SIGNATURE-----\n", "payload": "tree 86d653b537a79b7f14be61e22cc34f3cf987b6fd\nparent f835b13812e505830370f5dde863d4ff9cabe2a6\nparent 77af67ab64ffd3daaa255d6afff1f02bb1f5faa2\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1682953824 +0200\ncommitter GitHub <noreply@github.com> 1682953824 +0200\n\nRollup merge of #111042 - Zalathar:no-coverage, r=wesleywiser\n\nAdd `#[no_coverage]` to the test harness's `fn main`\n\nThere are two main motivations for adding `#[no_coverage]` to the test harness's entry point:\n\n- The entry point is trivial compiler-generated code that doesn't correspond to user source, and it always runs, so there's no value in instrumenting it for coverage.\n- Because it has dummy spans, it causes the instrumentor implementation to emit invalid coverage mappings that confuse `llvm-cov` and result in strange coverage reports.\n\nFixes #110749.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0a2562bf4de82b897beacf788e153f5738458325", "html_url": "https://github.com/rust-lang/rust/commit/0a2562bf4de82b897beacf788e153f5738458325", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0a2562bf4de82b897beacf788e153f5738458325/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f835b13812e505830370f5dde863d4ff9cabe2a6", "url": "https://api.github.com/repos/rust-lang/rust/commits/f835b13812e505830370f5dde863d4ff9cabe2a6", "html_url": "https://github.com/rust-lang/rust/commit/f835b13812e505830370f5dde863d4ff9cabe2a6"}, {"sha": "77af67ab64ffd3daaa255d6afff1f02bb1f5faa2", "url": "https://api.github.com/repos/rust-lang/rust/commits/77af67ab64ffd3daaa255d6afff1f02bb1f5faa2", "html_url": "https://github.com/rust-lang/rust/commit/77af67ab64ffd3daaa255d6afff1f02bb1f5faa2"}], "stats": {"total": 28, "additions": 26, "deletions": 2}, "files": [{"sha": "9bc1e27b4ec74032c514114f09b375f6eb571f14", "filename": "compiler/rustc_builtin_macros/src/test_harness.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/0a2562bf4de82b897beacf788e153f5738458325/compiler%2Frustc_builtin_macros%2Fsrc%2Ftest_harness.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0a2562bf4de82b897beacf788e153f5738458325/compiler%2Frustc_builtin_macros%2Fsrc%2Ftest_harness.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_builtin_macros%2Fsrc%2Ftest_harness.rs?ref=0a2562bf4de82b897beacf788e153f5738458325", "patch": "@@ -232,7 +232,7 @@ fn generate_test_harness(\n     let expn_id = ext_cx.resolver.expansion_for_ast_pass(\n         DUMMY_SP,\n         AstPass::TestHarness,\n-        &[sym::test, sym::rustc_attrs],\n+        &[sym::test, sym::rustc_attrs, sym::no_coverage],\n         None,\n     );\n     let def_site = DUMMY_SP.with_def_site_ctxt(expn_id.to_expn_id());\n@@ -313,6 +313,8 @@ fn mk_main(cx: &mut TestCtxt<'_>) -> P<ast::Item> {\n \n     // #[rustc_main]\n     let main_attr = ecx.attr_word(sym::rustc_main, sp);\n+    // #[no_coverage]\n+    let no_coverage_attr = ecx.attr_word(sym::no_coverage, sp);\n \n     // pub fn main() { ... }\n     let main_ret_ty = ecx.ty(sp, ast::TyKind::Tup(ThinVec::new()));\n@@ -342,7 +344,7 @@ fn mk_main(cx: &mut TestCtxt<'_>) -> P<ast::Item> {\n \n     let main = P(ast::Item {\n         ident: main_id,\n-        attrs: thin_vec![main_attr],\n+        attrs: thin_vec![main_attr, no_coverage_attr],\n         id: ast::DUMMY_NODE_ID,\n         kind: main,\n         vis: ast::Visibility { span: sp, kind: ast::VisibilityKind::Public, tokens: None },"}, {"sha": "7d7f682130df86b6d780c3e51697e7c6f0a4dfee", "filename": "tests/pretty/tests-are-sorted.pp", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/0a2562bf4de82b897beacf788e153f5738458325/tests%2Fpretty%2Ftests-are-sorted.pp", "raw_url": "https://github.com/rust-lang/rust/raw/0a2562bf4de82b897beacf788e153f5738458325/tests%2Fpretty%2Ftests-are-sorted.pp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fpretty%2Ftests-are-sorted.pp?ref=0a2562bf4de82b897beacf788e153f5738458325", "patch": "@@ -79,6 +79,7 @@\n     };\n fn a_test() {}\n #[rustc_main]\n+#[no_coverage]\n pub fn main() -> () {\n     extern crate test;\n     test::test_main_static(&[&a_test, &m_test, &z_test])"}, {"sha": "93bd1cfcb48971c55c1e21bb91f3c2cedeb2b5a8", "filename": "tests/run-make/coverage-reports/expected_show_coverage.test_harness.txt", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/0a2562bf4de82b897beacf788e153f5738458325/tests%2Frun-make%2Fcoverage-reports%2Fexpected_show_coverage.test_harness.txt", "raw_url": "https://github.com/rust-lang/rust/raw/0a2562bf4de82b897beacf788e153f5738458325/tests%2Frun-make%2Fcoverage-reports%2Fexpected_show_coverage.test_harness.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-make%2Fcoverage-reports%2Fexpected_show_coverage.test_harness.txt?ref=0a2562bf4de82b897beacf788e153f5738458325", "patch": "@@ -0,0 +1,11 @@\n+    1|       |// Verify that the entry point injected by the test harness doesn't cause\n+    2|       |// weird artifacts in the coverage report (e.g. issue #10749).\n+    3|       |\n+    4|       |// compile-flags: --test\n+    5|       |\n+    6|       |#[allow(dead_code)]\n+    7|      0|fn unused() {}\n+    8|       |\n+    9|      1|#[test]\n+   10|      1|fn my_test() {}\n+"}, {"sha": "12a755734c198bd6d1b7a969c3def47c3b339ffc", "filename": "tests/run-make/coverage/test_harness.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/0a2562bf4de82b897beacf788e153f5738458325/tests%2Frun-make%2Fcoverage%2Ftest_harness.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0a2562bf4de82b897beacf788e153f5738458325/tests%2Frun-make%2Fcoverage%2Ftest_harness.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-make%2Fcoverage%2Ftest_harness.rs?ref=0a2562bf4de82b897beacf788e153f5738458325", "patch": "@@ -0,0 +1,10 @@\n+// Verify that the entry point injected by the test harness doesn't cause\n+// weird artifacts in the coverage report (e.g. issue #10749).\n+\n+// compile-flags: --test\n+\n+#[allow(dead_code)]\n+fn unused() {}\n+\n+#[test]\n+fn my_test() {}"}]}