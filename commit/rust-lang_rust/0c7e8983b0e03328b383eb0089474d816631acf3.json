{"sha": "0c7e8983b0e03328b383eb0089474d816631acf3", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBjN2U4OTgzYjBlMDMzMjhiMzgzZWIwMDg5NDc0ZDgxNjYzMWFjZjM=", "commit": {"author": {"name": "Yuki Okushi", "email": "huyuumi.dev@gmail.com", "date": "2021-03-03T07:27:40Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-03-03T07:27:40Z"}, "message": "Rollup merge of #82469 - notriddle:bring-our-own-diff, r=Mark-Simulacrum\n\nUse a crate to produce rustdoc tree comparisons instead of the `diff` command\n\nIt doesn't come with Windows, so bring [our own](https://github.com/notriddle/rust-unified-diff/).\n\nFixes #82409\n\n![image](https://user-images.githubusercontent.com/1593513/109230755-9a1d5700-7782-11eb-8359-353a506875ab.png)", "tree": {"sha": "e4d09857defc20c6151c71eaaf96cc969ce97cdb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e4d09857defc20c6151c71eaaf96cc969ce97cdb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0c7e8983b0e03328b383eb0089474d816631acf3", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgPzptCRBK7hj4Ov3rIwAAdHIIAACJvPcy8u7CZJWiuP+i96lR\n5Tb5BYITr1E1TnGt+C+v6PaJoYRrhopuC9fYibMqKy7WM7ZDULiNBZSTs3eJgYHR\nH5GWVYtXgYh7co/OqzahpSvFnFWhyn70Vhbtbsf7gqezK3CfeCTN9ImJyME8zZKy\nHZwuSf4sz4i7fmqqBENF69Zlv6KUOiGTmen+2CgjsK/lbOVm6BcuRmg7CLXcqUZZ\n8TXi1CZDkCL5G868npT8H6kRaRAB8imChiF/09Zg68I10WvxgxqzXeDW7e9Ayp8B\nCsAAcPc3OjnEU5uUgn3uDtj8A7e87Y7UQQm9/M6/uUMPTFUKv6nSkyKd8UMMWMk=\n=FNrU\n-----END PGP SIGNATURE-----\n", "payload": "tree e4d09857defc20c6151c71eaaf96cc969ce97cdb\nparent 46f9253098ce2793c57e28bf3f79ace0946ccb3e\nparent b29d9d5503ff69caa7885e088e23f5467eb3d10a\nauthor Yuki Okushi <huyuumi.dev@gmail.com> 1614756460 +0900\ncommitter GitHub <noreply@github.com> 1614756460 +0900\n\nRollup merge of #82469 - notriddle:bring-our-own-diff, r=Mark-Simulacrum\n\nUse a crate to produce rustdoc tree comparisons instead of the `diff` command\n\nIt doesn't come with Windows, so bring [our own](https://github.com/notriddle/rust-unified-diff/).\n\nFixes #82409\n\n![image](https://user-images.githubusercontent.com/1593513/109230755-9a1d5700-7782-11eb-8359-353a506875ab.png)\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0c7e8983b0e03328b383eb0089474d816631acf3", "html_url": "https://github.com/rust-lang/rust/commit/0c7e8983b0e03328b383eb0089474d816631acf3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0c7e8983b0e03328b383eb0089474d816631acf3/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "46f9253098ce2793c57e28bf3f79ace0946ccb3e", "url": "https://api.github.com/repos/rust-lang/rust/commits/46f9253098ce2793c57e28bf3f79ace0946ccb3e", "html_url": "https://github.com/rust-lang/rust/commit/46f9253098ce2793c57e28bf3f79ace0946ccb3e"}, {"sha": "b29d9d5503ff69caa7885e088e23f5467eb3d10a", "url": "https://api.github.com/repos/rust-lang/rust/commits/b29d9d5503ff69caa7885e088e23f5467eb3d10a", "html_url": "https://github.com/rust-lang/rust/commit/b29d9d5503ff69caa7885e088e23f5467eb3d10a"}], "stats": {"total": 95, "additions": 82, "deletions": 13}, "files": [{"sha": "0666abadcba339efe5dbc212cd61c09ca797f516", "filename": "Cargo.lock", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/0c7e8983b0e03328b383eb0089474d816631acf3/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/0c7e8983b0e03328b383eb0089474d816631acf3/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=0c7e8983b0e03328b383eb0089474d816631acf3", "patch": "@@ -676,6 +676,7 @@ dependencies = [\n name = \"compiletest\"\n version = \"0.0.0\"\n dependencies = [\n+ \"colored\",\n  \"diff\",\n  \"getopts\",\n  \"glob\",\n@@ -688,6 +689,7 @@ dependencies = [\n  \"serde_json\",\n  \"tracing\",\n  \"tracing-subscriber\",\n+ \"unified-diff\",\n  \"walkdir\",\n  \"winapi 0.3.9\",\n ]\n@@ -5526,6 +5528,15 @@ version = \"0.1.1\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"39ec24b3121d976906ece63c9daad25b85969647682eee313cb5779fdd69e14e\"\n \n+[[package]]\n+name = \"unified-diff\"\n+version = \"0.2.1\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"496a3d395ed0c30f411ceace4a91f7d93b148fb5a9b383d5d4cff7850f048d5f\"\n+dependencies = [\n+ \"diff\",\n+]\n+\n [[package]]\n name = \"unstable-book-gen\"\n version = \"0.1.0\""}, {"sha": "1ab560ac09d4e8fdfe7f1754033b89c66d76e690", "filename": "src/tools/compiletest/Cargo.toml", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0c7e8983b0e03328b383eb0089474d816631acf3/src%2Ftools%2Fcompiletest%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/0c7e8983b0e03328b383eb0089474d816631acf3/src%2Ftools%2Fcompiletest%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2FCargo.toml?ref=0c7e8983b0e03328b383eb0089474d816631acf3", "patch": "@@ -5,7 +5,9 @@ version = \"0.0.0\"\n edition = \"2018\"\n \n [dependencies]\n+colored = \"2\"\n diff = \"0.1.10\"\n+unified-diff = \"0.2.1\"\n getopts = \"0.2\"\n tracing = \"0.1\"\n tracing-subscriber = { version = \"0.2.13\", default-features = false, features = [\"fmt\", \"env-filter\", \"smallvec\", \"parking_lot\", \"ansi\"] }"}, {"sha": "2e7b42b6c7cf263714fa85cc41a24f5e7bc06614", "filename": "src/tools/compiletest/src/runtest.rs", "status": "modified", "additions": 69, "deletions": 13, "changes": 82, "blob_url": "https://github.com/rust-lang/rust/blob/0c7e8983b0e03328b383eb0089474d816631acf3/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0c7e8983b0e03328b383eb0089474d816631acf3/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs?ref=0c7e8983b0e03328b383eb0089474d816631acf3", "patch": "@@ -13,6 +13,7 @@ use crate::header::TestProps;\n use crate::json;\n use crate::util::get_pointer_width;\n use crate::util::{logv, PathBufExt};\n+use crate::ColorConfig;\n use regex::{Captures, Regex};\n use rustfix::{apply_suggestions, get_suggestions_from_json, Filter};\n \n@@ -2440,37 +2441,92 @@ impl<'test> TestCx<'test> {\n                 }\n             })\n         };\n-        let mut diff = Command::new(\"diff\");\n-        // diff recursively, showing context, and excluding .css files\n-        diff.args(&[\"-u\", \"-r\", \"-x\", \"*.css\"]).args(&[&compare_dir, out_dir]);\n \n-        let output = if let Some(pager) = pager {\n-            let diff_pid = diff.stdout(Stdio::piped()).spawn().expect(\"failed to run `diff`\");\n+        let diff_filename = format!(\"build/tmp/rustdoc-compare-{}.diff\", std::process::id());\n+\n+        {\n+            let mut diff_output = File::create(&diff_filename).unwrap();\n+            for entry in walkdir::WalkDir::new(out_dir) {\n+                let entry = entry.expect(\"failed to read file\");\n+                let extension = entry.path().extension().and_then(|p| p.to_str());\n+                if entry.file_type().is_file()\n+                    && (extension == Some(\"html\".into()) || extension == Some(\"js\".into()))\n+                {\n+                    let expected_path =\n+                        compare_dir.join(entry.path().strip_prefix(&out_dir).unwrap());\n+                    let expected =\n+                        if let Ok(s) = std::fs::read(&expected_path) { s } else { continue };\n+                    let actual_path = entry.path();\n+                    let actual = std::fs::read(&actual_path).unwrap();\n+                    diff_output\n+                        .write_all(&unified_diff::diff(\n+                            &expected,\n+                            &expected_path.to_string_lossy(),\n+                            &actual,\n+                            &actual_path.to_string_lossy(),\n+                            3,\n+                        ))\n+                        .unwrap();\n+                }\n+            }\n+        }\n+\n+        match self.config.color {\n+            ColorConfig::AlwaysColor => colored::control::set_override(true),\n+            ColorConfig::NeverColor => colored::control::set_override(false),\n+            _ => {}\n+        }\n+\n+        if let Some(pager) = pager {\n             let pager = pager.trim();\n             if self.config.verbose {\n                 eprintln!(\"using pager {}\", pager);\n             }\n             let output = Command::new(pager)\n                 // disable paging; we want this to be non-interactive\n                 .env(\"PAGER\", \"\")\n-                .stdin(diff_pid.stdout.unwrap())\n+                .stdin(File::open(&diff_filename).unwrap())\n                 // Capture output and print it explicitly so it will in turn be\n                 // captured by libtest.\n                 .output()\n                 .unwrap();\n             assert!(output.status.success());\n-            output\n+            println!(\"{}\", String::from_utf8_lossy(&output.stdout));\n+            eprintln!(\"{}\", String::from_utf8_lossy(&output.stderr));\n         } else {\n-            eprintln!(\"warning: no pager configured, falling back to `diff --color`\");\n+            use colored::Colorize;\n+            eprintln!(\"warning: no pager configured, falling back to unified diff\");\n             eprintln!(\n                 \"help: try configuring a git pager (e.g. `delta`) with `git config --global core.pager delta`\"\n             );\n-            let output = diff.arg(\"--color\").output().unwrap();\n-            assert!(output.status.success() || output.status.code() == Some(1));\n-            output\n+            let mut out = io::stdout();\n+            let mut diff = BufReader::new(File::open(&diff_filename).unwrap());\n+            let mut line = Vec::new();\n+            loop {\n+                line.truncate(0);\n+                match diff.read_until(b'\\n', &mut line) {\n+                    Ok(0) => break,\n+                    Ok(_) => {}\n+                    Err(e) => eprintln!(\"ERROR: {:?}\", e),\n+                }\n+                match String::from_utf8(line.clone()) {\n+                    Ok(line) => {\n+                        if line.starts_with(\"+\") {\n+                            write!(&mut out, \"{}\", line.green()).unwrap();\n+                        } else if line.starts_with(\"-\") {\n+                            write!(&mut out, \"{}\", line.red()).unwrap();\n+                        } else if line.starts_with(\"@\") {\n+                            write!(&mut out, \"{}\", line.blue()).unwrap();\n+                        } else {\n+                            out.write_all(line.as_bytes()).unwrap();\n+                        }\n+                    }\n+                    Err(_) => {\n+                        write!(&mut out, \"{}\", String::from_utf8_lossy(&line).reversed()).unwrap();\n+                    }\n+                }\n+            }\n         };\n-        println!(\"{}\", String::from_utf8_lossy(&output.stdout));\n-        eprintln!(\"{}\", String::from_utf8_lossy(&output.stderr));\n     }\n \n     fn run_rustdoc_json_test(&self) {"}]}