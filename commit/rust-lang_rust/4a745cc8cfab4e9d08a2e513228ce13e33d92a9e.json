{"sha": "4a745cc8cfab4e9d08a2e513228ce13e33d92a9e", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRhNzQ1Y2M4Y2ZhYjRlOWQwOGEyZTUxMzIyOGNlMTNlMzNkOTJhOWU=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2020-03-11T11:40:38Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2020-03-11T13:28:18Z"}, "message": "Fix parsing of stement-ish binary expressions\n\ncloses #3512", "tree": {"sha": "d67482ef3c3c231e4c0a1f9a8641548ddf7974fc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d67482ef3c3c231e4c0a1f9a8641548ddf7974fc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4a745cc8cfab4e9d08a2e513228ce13e33d92a9e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4a745cc8cfab4e9d08a2e513228ce13e33d92a9e", "html_url": "https://github.com/rust-lang/rust/commit/4a745cc8cfab4e9d08a2e513228ce13e33d92a9e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4a745cc8cfab4e9d08a2e513228ce13e33d92a9e/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bddf6b5266997dd7e017fcb963e54a86b68afbaa", "url": "https://api.github.com/repos/rust-lang/rust/commits/bddf6b5266997dd7e017fcb963e54a86b68afbaa", "html_url": "https://github.com/rust-lang/rust/commit/bddf6b5266997dd7e017fcb963e54a86b68afbaa"}], "stats": {"total": 51, "additions": 49, "deletions": 2}, "files": [{"sha": "0c170ac5ec2092e49b497b51aef18f65b6fb9472", "filename": "crates/ra_parser/src/grammar/expressions.rs", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/4a745cc8cfab4e9d08a2e513228ce13e33d92a9e/crates%2Fra_parser%2Fsrc%2Fgrammar%2Fexpressions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4a745cc8cfab4e9d08a2e513228ce13e33d92a9e/crates%2Fra_parser%2Fsrc%2Fgrammar%2Fexpressions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_parser%2Fsrc%2Fgrammar%2Fexpressions.rs?ref=4a745cc8cfab4e9d08a2e513228ce13e33d92a9e", "patch": "@@ -278,7 +278,7 @@ fn current_op(p: &Parser) -> (u8, SyntaxKind) {\n }\n \n // Parses expression with binding power of at least bp.\n-fn expr_bp(p: &mut Parser, r: Restrictions, bp: u8) -> (Option<CompletedMarker>, BlockLike) {\n+fn expr_bp(p: &mut Parser, mut r: Restrictions, bp: u8) -> (Option<CompletedMarker>, BlockLike) {\n     let mut lhs = match lhs(p, r) {\n         Some((lhs, blocklike)) => {\n             // test stmt_bin_expr_ambiguity\n@@ -311,6 +311,12 @@ fn expr_bp(p: &mut Parser, r: Restrictions, bp: u8) -> (Option<CompletedMarker>,\n         let m = lhs.precede(p);\n         p.bump(op);\n \n+        // test binop_resets_statementness\n+        // fn foo() {\n+        //     v = {1}&2;\n+        // }\n+        r = Restrictions { prefer_stmt: false, ..r };\n+\n         if is_range {\n             // test postfix_range\n             // fn foo() {\n@@ -327,7 +333,7 @@ fn expr_bp(p: &mut Parser, r: Restrictions, bp: u8) -> (Option<CompletedMarker>,\n             }\n         }\n \n-        expr_bp(p, r, op_bp + 1);\n+        expr_bp(p, Restrictions { prefer_stmt: false, ..r }, op_bp + 1);\n         lhs = m.complete(p, if is_range { RANGE_EXPR } else { BIN_EXPR });\n     }\n     (Some(lhs), BlockLike::NotBlock)"}, {"sha": "05acc30f126d9cea4015429a5be500e0b334467b", "filename": "crates/ra_syntax/test_data/parser/inline/ok/0158_binop_resets_statementness.rs", "status": "added", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/4a745cc8cfab4e9d08a2e513228ce13e33d92a9e/crates%2Fra_syntax%2Ftest_data%2Fparser%2Finline%2Fok%2F0158_binop_resets_statementness.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4a745cc8cfab4e9d08a2e513228ce13e33d92a9e/crates%2Fra_syntax%2Ftest_data%2Fparser%2Finline%2Fok%2F0158_binop_resets_statementness.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_syntax%2Ftest_data%2Fparser%2Finline%2Fok%2F0158_binop_resets_statementness.rs?ref=4a745cc8cfab4e9d08a2e513228ce13e33d92a9e", "patch": "@@ -0,0 +1,3 @@\n+fn foo() {\n+    v = {1}&2;\n+}"}, {"sha": "d568a1d457b268393c7f14c126c1d5f270e62bc6", "filename": "crates/ra_syntax/test_data/parser/inline/ok/0158_binop_resets_statementness.txt", "status": "added", "additions": 38, "deletions": 0, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/4a745cc8cfab4e9d08a2e513228ce13e33d92a9e/crates%2Fra_syntax%2Ftest_data%2Fparser%2Finline%2Fok%2F0158_binop_resets_statementness.txt", "raw_url": "https://github.com/rust-lang/rust/raw/4a745cc8cfab4e9d08a2e513228ce13e33d92a9e/crates%2Fra_syntax%2Ftest_data%2Fparser%2Finline%2Fok%2F0158_binop_resets_statementness.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_syntax%2Ftest_data%2Fparser%2Finline%2Fok%2F0158_binop_resets_statementness.txt?ref=4a745cc8cfab4e9d08a2e513228ce13e33d92a9e", "patch": "@@ -0,0 +1,38 @@\n+SOURCE_FILE@[0; 28)\n+  FN_DEF@[0; 27)\n+    FN_KW@[0; 2) \"fn\"\n+    WHITESPACE@[2; 3) \" \"\n+    NAME@[3; 6)\n+      IDENT@[3; 6) \"foo\"\n+    PARAM_LIST@[6; 8)\n+      L_PAREN@[6; 7) \"(\"\n+      R_PAREN@[7; 8) \")\"\n+    WHITESPACE@[8; 9) \" \"\n+    BLOCK_EXPR@[9; 27)\n+      BLOCK@[9; 27)\n+        L_CURLY@[9; 10) \"{\"\n+        WHITESPACE@[10; 15) \"\\n    \"\n+        EXPR_STMT@[15; 25)\n+          BIN_EXPR@[15; 24)\n+            PATH_EXPR@[15; 16)\n+              PATH@[15; 16)\n+                PATH_SEGMENT@[15; 16)\n+                  NAME_REF@[15; 16)\n+                    IDENT@[15; 16) \"v\"\n+            WHITESPACE@[16; 17) \" \"\n+            EQ@[17; 18) \"=\"\n+            WHITESPACE@[18; 19) \" \"\n+            BIN_EXPR@[19; 24)\n+              BLOCK_EXPR@[19; 22)\n+                BLOCK@[19; 22)\n+                  L_CURLY@[19; 20) \"{\"\n+                  LITERAL@[20; 21)\n+                    INT_NUMBER@[20; 21) \"1\"\n+                  R_CURLY@[21; 22) \"}\"\n+              AMP@[22; 23) \"&\"\n+              LITERAL@[23; 24)\n+                INT_NUMBER@[23; 24) \"2\"\n+          SEMI@[24; 25) \";\"\n+        WHITESPACE@[25; 26) \"\\n\"\n+        R_CURLY@[26; 27) \"}\"\n+  WHITESPACE@[27; 28) \"\\n\""}]}