{"sha": "15398b6b358b8585d5ab23ae95bbcd3330e5fdb4", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE1Mzk4YjZiMzU4Yjg1ODVkNWFiMjNhZTk1YmJjZDMzMzBlNWZkYjQ=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-07-26T16:56:58Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-07-26T16:56:58Z"}, "message": "Rollup merge of #62980 - alexcrichton:windows-metadata, r=sfackler\n\nstd: Add more accessors for `Metadata` on Windows\n\nThis commit adds accessors for more fields in `fs::Metadata` on Windows\nwhich weren't previously exposed. There's two sources of `fs::Metadata`\non Windows currently, one from `DirEntry` and one from a file itself.\nThese two sources of information don't actually have the same set of\nfields exposed in their stat information, however. To handle this the\nplatform-specific accessors of Windows-specific information all return\n`Option` to return `None` in the case a metadata comes from a\n`DirEntry`, but they're guaranteed to return `Some` if it comes from a\nfile itself.\n\nThis is motivated by some changes in CraneStation/wasi-common#42, and\nI'm curious how others feel about this platform-specific functionality!", "tree": {"sha": "81e3708ad40ea25f200f4d0dd60701f5712157bd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/81e3708ad40ea25f200f4d0dd60701f5712157bd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/15398b6b358b8585d5ab23ae95bbcd3330e5fdb4", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJdOzDaCRBK7hj4Ov3rIwAAdHIIAFTchGj7imncAmvjDcQ2KysQ\nFScyEcdSWKOQkwTfUP793oxotFZA0B32oPBj7TEDyxawEBc67rkBVCwvwiV+S1Ye\nsMCa1e6xJkmsCakTqWRVGMXMJBnRxeoNl7ZayE1YGCY28yW/KmL94tV0gDBqiQgj\nHxWd5/CPK4Sjge9jM0jVYqLCS3Hl7ZLBdXc5iyq8E445q4weNDmWCbm3kJMtL2TU\nf2HXNkcwkj687uIa9UoeSsCQc/mkFhaMMQ+mPO2dPPoIhHXUTXj2/mOuxd/c5YMR\ngwon3+nHQEkAqpiMs/zddOXGhFqQw9Ws5lJ1EMHYA7RPTw+AxMnRjfeAT0QNfpk=\n=R1FN\n-----END PGP SIGNATURE-----\n", "payload": "tree 81e3708ad40ea25f200f4d0dd60701f5712157bd\nparent 7e1ce7da80f45b512601708fbaa637d1b609e189\nparent c69f367bafb3a2f90d44fe54fc20d57996fa294a\nauthor Mazdak Farrokhzad <twingoow@gmail.com> 1564160218 +0200\ncommitter GitHub <noreply@github.com> 1564160218 +0200\n\nRollup merge of #62980 - alexcrichton:windows-metadata, r=sfackler\n\nstd: Add more accessors for `Metadata` on Windows\n\nThis commit adds accessors for more fields in `fs::Metadata` on Windows\nwhich weren't previously exposed. There's two sources of `fs::Metadata`\non Windows currently, one from `DirEntry` and one from a file itself.\nThese two sources of information don't actually have the same set of\nfields exposed in their stat information, however. To handle this the\nplatform-specific accessors of Windows-specific information all return\n`Option` to return `None` in the case a metadata comes from a\n`DirEntry`, but they're guaranteed to return `Some` if it comes from a\nfile itself.\n\nThis is motivated by some changes in CraneStation/wasi-common#42, and\nI'm curious how others feel about this platform-specific functionality!\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/15398b6b358b8585d5ab23ae95bbcd3330e5fdb4", "html_url": "https://github.com/rust-lang/rust/commit/15398b6b358b8585d5ab23ae95bbcd3330e5fdb4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/15398b6b358b8585d5ab23ae95bbcd3330e5fdb4/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7e1ce7da80f45b512601708fbaa637d1b609e189", "url": "https://api.github.com/repos/rust-lang/rust/commits/7e1ce7da80f45b512601708fbaa637d1b609e189", "html_url": "https://github.com/rust-lang/rust/commit/7e1ce7da80f45b512601708fbaa637d1b609e189"}, {"sha": "c69f367bafb3a2f90d44fe54fc20d57996fa294a", "url": "https://api.github.com/repos/rust-lang/rust/commits/c69f367bafb3a2f90d44fe54fc20d57996fa294a", "html_url": "https://github.com/rust-lang/rust/commit/c69f367bafb3a2f90d44fe54fc20d57996fa294a"}], "stats": {"total": 85, "additions": 69, "deletions": 16}, "files": [{"sha": "23964dc5bd5df9bf2233d8fea660dc8e51803d07", "filename": "src/libstd/sys/windows/ext/fs.rs", "status": "modified", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/15398b6b358b8585d5ab23ae95bbcd3330e5fdb4/src%2Flibstd%2Fsys%2Fwindows%2Fext%2Ffs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/15398b6b358b8585d5ab23ae95bbcd3330e5fdb4/src%2Flibstd%2Fsys%2Fwindows%2Fext%2Ffs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Fwindows%2Fext%2Ffs.rs?ref=15398b6b358b8585d5ab23ae95bbcd3330e5fdb4", "patch": "@@ -437,6 +437,33 @@ pub trait MetadataExt {\n     /// ```\n     #[stable(feature = \"metadata_ext\", since = \"1.1.0\")]\n     fn file_size(&self) -> u64;\n+\n+    /// Returns the value of the `dwVolumeSerialNumber` field of this\n+    /// metadata.\n+    ///\n+    /// This will return `None` if the `Metadata` instance was created from a\n+    /// call to `DirEntry::metadata`. If this `Metadata` was created by using\n+    /// `fs::metadata` or `File::metadata`, then this will return `Some`.\n+    #[unstable(feature = \"windows_by_handle\", issue = \"63010\")]\n+    fn volume_serial_number(&self) -> Option<u32>;\n+\n+    /// Returns the value of the `nNumberOfLinks` field of this\n+    /// metadata.\n+    ///\n+    /// This will return `None` if the `Metadata` instance was created from a\n+    /// call to `DirEntry::metadata`. If this `Metadata` was created by using\n+    /// `fs::metadata` or `File::metadata`, then this will return `Some`.\n+    #[unstable(feature = \"windows_by_handle\", issue = \"63010\")]\n+    fn number_of_links(&self) -> Option<u32>;\n+\n+    /// Returns the value of the `nFileIndex{Low,High}` fields of this\n+    /// metadata.\n+    ///\n+    /// This will return `None` if the `Metadata` instance was created from a\n+    /// call to `DirEntry::metadata`. If this `Metadata` was created by using\n+    /// `fs::metadata` or `File::metadata`, then this will return `Some`.\n+    #[unstable(feature = \"windows_by_handle\", issue = \"63010\")]\n+    fn file_index(&self) -> Option<u64>;\n }\n \n #[stable(feature = \"metadata_ext\", since = \"1.1.0\")]\n@@ -446,6 +473,9 @@ impl MetadataExt for Metadata {\n     fn last_access_time(&self) -> u64 { self.as_inner().accessed_u64() }\n     fn last_write_time(&self) -> u64 { self.as_inner().modified_u64() }\n     fn file_size(&self) -> u64 { self.as_inner().size() }\n+    fn volume_serial_number(&self) -> Option<u32> { self.as_inner().volume_serial_number() }\n+    fn number_of_links(&self) -> Option<u32> { self.as_inner().number_of_links() }\n+    fn file_index(&self) -> Option<u64> { self.as_inner().file_index() }\n }\n \n /// Windows-specific extensions to [`FileType`]."}, {"sha": "5bae6ba4749bd1e2f8bea3f0df94a5023e20ef39", "filename": "src/libstd/sys/windows/fs.rs", "status": "modified", "additions": 39, "deletions": 16, "changes": 55, "blob_url": "https://github.com/rust-lang/rust/blob/15398b6b358b8585d5ab23ae95bbcd3330e5fdb4/src%2Flibstd%2Fsys%2Fwindows%2Ffs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/15398b6b358b8585d5ab23ae95bbcd3330e5fdb4/src%2Flibstd%2Fsys%2Fwindows%2Ffs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Fwindows%2Ffs.rs?ref=15398b6b358b8585d5ab23ae95bbcd3330e5fdb4", "patch": "@@ -25,6 +25,9 @@ pub struct FileAttr {\n     last_write_time: c::FILETIME,\n     file_size: u64,\n     reparse_tag: c::DWORD,\n+    volume_serial_number: Option<u32>,\n+    number_of_links: Option<u32>,\n+    file_index: Option<u64>,\n }\n \n #[derive(Copy, Clone, PartialEq, Eq, Hash, Debug)]\n@@ -156,6 +159,9 @@ impl DirEntry {\n                 } else {\n                     0\n                 },\n+            volume_serial_number: None,\n+            number_of_links: None,\n+            file_index: None,\n         })\n     }\n }\n@@ -291,23 +297,26 @@ impl File {\n     pub fn file_attr(&self) -> io::Result<FileAttr> {\n         unsafe {\n             let mut info: c::BY_HANDLE_FILE_INFORMATION = mem::zeroed();\n-            cvt(c::GetFileInformationByHandle(self.handle.raw(),\n-                                              &mut info))?;\n-            let mut attr = FileAttr {\n-                attributes: info.dwFileAttributes,\n-                creation_time: info.ftCreationTime,\n-                last_access_time: info.ftLastAccessTime,\n-                last_write_time: info.ftLastWriteTime,\n-                file_size: ((info.nFileSizeHigh as u64) << 32) | (info.nFileSizeLow as u64),\n-                reparse_tag: 0,\n-            };\n-            if attr.is_reparse_point() {\n+            cvt(c::GetFileInformationByHandle(self.handle.raw(), &mut info))?;\n+            let mut reparse_tag = 0;\n+            if info.dwFileAttributes & c::FILE_ATTRIBUTE_REPARSE_POINT != 0 {\n                 let mut b = [0; c::MAXIMUM_REPARSE_DATA_BUFFER_SIZE];\n                 if let Ok((_, buf)) = self.reparse_point(&mut b) {\n-                    attr.reparse_tag = buf.ReparseTag;\n+                    reparse_tag = buf.ReparseTag;\n                 }\n             }\n-            Ok(attr)\n+            Ok(FileAttr {\n+                attributes: info.dwFileAttributes,\n+                creation_time: info.ftCreationTime,\n+                last_access_time: info.ftLastAccessTime,\n+                last_write_time: info.ftLastWriteTime,\n+                file_size: (info.nFileSizeLow as u64) | ((info.nFileSizeHigh as u64) << 32),\n+                reparse_tag,\n+                volume_serial_number: Some(info.dwVolumeSerialNumber),\n+                number_of_links: Some(info.nNumberOfLinks),\n+                file_index: Some((info.nFileIndexLow as u64) |\n+                                 ((info.nFileIndexHigh as u64) << 32)),\n+            })\n         }\n     }\n \n@@ -336,6 +345,9 @@ impl File {\n                 },\n                 file_size: 0,\n                 reparse_tag: 0,\n+                volume_serial_number: None,\n+                number_of_links: None,\n+                file_index: None,\n             };\n             let mut info: c::FILE_STANDARD_INFO = mem::zeroed();\n             let size = mem::size_of_val(&info);\n@@ -344,6 +356,7 @@ impl File {\n                                                 &mut info as *mut _ as *mut libc::c_void,\n                                                 size as c::DWORD))?;\n             attr.file_size = info.AllocationSize as u64;\n+            attr.number_of_links = Some(info.NumberOfLinks);\n             if attr.is_reparse_point() {\n                 let mut b = [0; c::MAXIMUM_REPARSE_DATA_BUFFER_SIZE];\n                 if let Ok((_, buf)) = self.reparse_point(&mut b) {\n@@ -507,7 +520,9 @@ impl FileAttr {\n         FilePermissions { attrs: self.attributes }\n     }\n \n-    pub fn attrs(&self) -> u32 { self.attributes as u32 }\n+    pub fn attrs(&self) -> u32 {\n+        self.attributes\n+    }\n \n     pub fn file_type(&self) -> FileType {\n         FileType::new(self.attributes, self.reparse_tag)\n@@ -537,8 +552,16 @@ impl FileAttr {\n         to_u64(&self.creation_time)\n     }\n \n-    fn is_reparse_point(&self) -> bool {\n-        self.attributes & c::FILE_ATTRIBUTE_REPARSE_POINT != 0\n+    pub fn volume_serial_number(&self) -> Option<u32> {\n+        self.volume_serial_number\n+    }\n+\n+    pub fn number_of_links(&self) -> Option<u32> {\n+        self.number_of_links\n+    }\n+\n+    pub fn file_index(&self) -> Option<u64> {\n+        self.file_index\n     }\n }\n "}]}