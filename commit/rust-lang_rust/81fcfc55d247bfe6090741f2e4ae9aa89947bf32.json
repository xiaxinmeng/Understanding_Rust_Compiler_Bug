{"sha": "81fcfc55d247bfe6090741f2e4ae9aa89947bf32", "node_id": "MDY6Q29tbWl0NzI0NzEyOjgxZmNmYzU1ZDI0N2JmZTYwOTA3NDFmMmU0YWU5YWE4OTk0N2JmMzI=", "commit": {"author": {"name": "bors[bot]", "email": "bors[bot]@users.noreply.github.com", "date": "2019-01-23T13:25:44Z"}, "committer": {"name": "bors[bot]", "email": "bors[bot]@users.noreply.github.com", "date": "2019-01-23T13:25:44Z"}, "message": "Merge #608\n\n608: Complete parens r=matklad a=matklad\n\n\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>", "tree": {"sha": "407c0ed2edf70d73c78224a9934c4a8c9e7eac2c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/407c0ed2edf70d73c78224a9934c4a8c9e7eac2c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/81fcfc55d247bfe6090741f2e4ae9aa89947bf32", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/81fcfc55d247bfe6090741f2e4ae9aa89947bf32", "html_url": "https://github.com/rust-lang/rust/commit/81fcfc55d247bfe6090741f2e4ae9aa89947bf32", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/81fcfc55d247bfe6090741f2e4ae9aa89947bf32/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "parents": [{"sha": "86507c0626eb07485b21c61638673acbb3c2a9ad", "url": "https://api.github.com/repos/rust-lang/rust/commits/86507c0626eb07485b21c61638673acbb3c2a9ad", "html_url": "https://github.com/rust-lang/rust/commit/86507c0626eb07485b21c61638673acbb3c2a9ad"}, {"sha": "71b9f06c89735b78439d0720e314b71969c17eb3", "url": "https://api.github.com/repos/rust-lang/rust/commits/71b9f06c89735b78439d0720e314b71969c17eb3", "html_url": "https://github.com/rust-lang/rust/commit/71b9f06c89735b78439d0720e314b71969c17eb3"}], "stats": {"total": 184, "additions": 124, "deletions": 60}, "files": [{"sha": "a861ee88e6d272ee2babf7b1656dcc0915eeba27", "filename": "crates/ra_hir/src/lib.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/81fcfc55d247bfe6090741f2e4ae9aa89947bf32/crates%2Fra_hir%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/81fcfc55d247bfe6090741f2e4ae9aa89947bf32/crates%2Fra_hir%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Flib.rs?ref=81fcfc55d247bfe6090741f2e4ae9aa89947bf32", "patch": "@@ -8,8 +8,6 @@\n pub mod db;\n #[cfg(test)]\n mod mock;\n-#[cfg(test)]\n-mod marks;\n mod query_definitions;\n mod path;\n pub mod source_binder;\n@@ -29,6 +27,9 @@ mod generics;\n mod code_model_api;\n mod code_model_impl;\n \n+#[cfg(test)]\n+mod marks;\n+\n use crate::{\n     db::HirDatabase,\n     name::{AsName, KnownName},"}, {"sha": "f4d0c3e59667c3d6a0df2be6d93c6af4601bfab3", "filename": "crates/ra_hir/src/marks.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/81fcfc55d247bfe6090741f2e4ae9aa89947bf32/crates%2Fra_hir%2Fsrc%2Fmarks.rs", "raw_url": "https://github.com/rust-lang/rust/raw/81fcfc55d247bfe6090741f2e4ae9aa89947bf32/crates%2Fra_hir%2Fsrc%2Fmarks.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fmarks.rs?ref=81fcfc55d247bfe6090741f2e4ae9aa89947bf32", "patch": "@@ -1 +1,3 @@\n-test_utils::mark!(name_res_works_for_broken_modules);\n+use test_utils::mark;\n+\n+mark!(name_res_works_for_broken_modules);"}, {"sha": "6bed299d2f4012ab26b010e5610e4b5eff8934ac", "filename": "crates/ra_ide_api/src/completion/complete_path.rs", "status": "modified", "additions": 0, "deletions": 26, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/81fcfc55d247bfe6090741f2e4ae9aa89947bf32/crates%2Fra_ide_api%2Fsrc%2Fcompletion%2Fcomplete_path.rs", "raw_url": "https://github.com/rust-lang/rust/raw/81fcfc55d247bfe6090741f2e4ae9aa89947bf32/crates%2Fra_ide_api%2Fsrc%2Fcompletion%2Fcomplete_path.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Fcompletion%2Fcomplete_path.rs?ref=81fcfc55d247bfe6090741f2e4ae9aa89947bf32", "patch": "@@ -121,30 +121,4 @@ mod tests {\n             \",\n         );\n     }\n-\n-    #[test]\n-    fn dont_render_function_parens_in_use_item() {\n-        check_reference_completion(\n-            \"dont_render_function_parens_in_use_item\",\n-            \"\n-            //- /lib.rs\n-            mod m { pub fn foo() {} }\n-            use crate::m::f<|>;\n-            \",\n-        )\n-    }\n-\n-    #[test]\n-    fn dont_render_function_parens_if_already_call() {\n-        check_reference_completion(\n-            \"dont_render_function_parens_if_already_call\",\n-            \"\n-            //- /lib.rs\n-            fn frobnicate() {}\n-            fn main() {\n-                frob<|>();\n-            }\n-            \",\n-        )\n-    }\n }"}, {"sha": "f837bb1db2bcaff0f0ce60c356c482419cc5650c", "filename": "crates/ra_ide_api/src/completion/complete_scope.rs", "status": "modified", "additions": 0, "deletions": 17, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/81fcfc55d247bfe6090741f2e4ae9aa89947bf32/crates%2Fra_ide_api%2Fsrc%2Fcompletion%2Fcomplete_scope.rs", "raw_url": "https://github.com/rust-lang/rust/raw/81fcfc55d247bfe6090741f2e4ae9aa89947bf32/crates%2Fra_ide_api%2Fsrc%2Fcompletion%2Fcomplete_scope.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Fcompletion%2Fcomplete_scope.rs?ref=81fcfc55d247bfe6090741f2e4ae9aa89947bf32", "patch": "@@ -175,21 +175,4 @@ mod tests {\n         check_reference_completion(\"self_in_methods\", r\"impl S { fn foo(&self) { <|> } }\")\n     }\n \n-    #[test]\n-    fn inserts_parens_for_function_calls() {\n-        check_reference_completion(\n-            \"inserts_parens_for_function_calls1\",\n-            r\"\n-            fn no_args() {}\n-            fn main() { no_<|> }\n-            \",\n-        );\n-        check_reference_completion(\n-            \"inserts_parens_for_function_calls2\",\n-            r\"\n-            fn with_args(x: i32, y: String) {}\n-            fn main() { with_<|> }\n-            \",\n-        );\n-    }\n }"}, {"sha": "e3bf82304e0174039eaa38a919c6e4132f973cc1", "filename": "crates/ra_ide_api/src/completion/completion_item.rs", "status": "modified", "additions": 74, "deletions": 2, "changes": 76, "blob_url": "https://github.com/rust-lang/rust/blob/81fcfc55d247bfe6090741f2e4ae9aa89947bf32/crates%2Fra_ide_api%2Fsrc%2Fcompletion%2Fcompletion_item.rs", "raw_url": "https://github.com/rust-lang/rust/raw/81fcfc55d247bfe6090741f2e4ae9aa89947bf32/crates%2Fra_ide_api%2Fsrc%2Fcompletion%2Fcompletion_item.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Fcompletion%2Fcompletion_item.rs?ref=81fcfc55d247bfe6090741f2e4ae9aa89947bf32", "patch": "@@ -3,9 +3,10 @@ use hir::PerNs;\n use crate::completion::completion_context::CompletionContext;\n use ra_syntax::{\n     ast::{self, AstNode},\n-    TextRange\n+    TextRange,\n };\n use ra_text_edit::TextEdit;\n+use test_utils::tested_by;\n \n /// `CompletionItem` describes a single completion variant in the editor pop-up.\n /// It is basically a POD with various properties. To construct a\n@@ -255,7 +256,9 @@ impl Builder {\n     ) -> Builder {\n         // If not an import, add parenthesis automatically.\n         if ctx.use_item_syntax.is_none() && !ctx.is_call {\n-            if function.signature(ctx.db).params().is_empty() {\n+            tested_by!(inserts_parens_for_function_calls);\n+            let sig = function.signature(ctx.db);\n+            if sig.params().is_empty() || sig.has_self_param() && sig.params().len() == 1 {\n                 self.insert_text = Some(format!(\"{}()$0\", self.label));\n             } else {\n                 self.insert_text = Some(format!(\"{}($0)\", self.label));\n@@ -344,3 +347,72 @@ pub(crate) fn check_completion(test_name: &str, code: &str, kind: CompletionKind\n         .collect();\n     assert_debug_snapshot_matches!(test_name, kind_completions);\n }\n+\n+#[cfg(test)]\n+mod tests {\n+    use test_utils::covers;\n+\n+    use super::*;\n+\n+    fn check_reference_completion(code: &str, expected_completions: &str) {\n+        check_completion(code, expected_completions, CompletionKind::Reference);\n+    }\n+\n+    #[test]\n+    fn inserts_parens_for_function_calls() {\n+        covers!(inserts_parens_for_function_calls);\n+        check_reference_completion(\n+            \"inserts_parens_for_function_calls1\",\n+            r\"\n+            fn no_args() {}\n+            fn main() { no_<|> }\n+            \",\n+        );\n+        check_reference_completion(\n+            \"inserts_parens_for_function_calls2\",\n+            r\"\n+            fn with_args(x: i32, y: String) {}\n+            fn main() { with_<|> }\n+            \",\n+        );\n+        check_reference_completion(\n+            \"inserts_parens_for_function_calls3\",\n+            r\"\n+            struct S {}\n+            impl S {\n+                fn foo(&self) {}\n+            }\n+            fn bar(s: &S) {\n+                s.f<|>\n+            }\n+            \",\n+        )\n+    }\n+\n+    #[test]\n+    fn dont_render_function_parens_in_use_item() {\n+        check_reference_completion(\n+            \"dont_render_function_parens_in_use_item\",\n+            \"\n+            //- /lib.rs\n+            mod m { pub fn foo() {} }\n+            use crate::m::f<|>;\n+            \",\n+        )\n+    }\n+\n+    #[test]\n+    fn dont_render_function_parens_if_already_call() {\n+        check_reference_completion(\n+            \"dont_render_function_parens_if_already_call\",\n+            \"\n+            //- /lib.rs\n+            fn frobnicate() {}\n+            fn main() {\n+                frob<|>();\n+            }\n+            \",\n+        )\n+    }\n+\n+}"}, {"sha": "92068e50a5402b5c6ce7995a24d303ff326f6aec", "filename": "crates/ra_ide_api/src/completion/snapshots/completion_item__inserts_parens_for_function_calls3.snap", "status": "added", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/81fcfc55d247bfe6090741f2e4ae9aa89947bf32/crates%2Fra_ide_api%2Fsrc%2Fcompletion%2Fsnapshots%2Fcompletion_item__inserts_parens_for_function_calls3.snap", "raw_url": "https://github.com/rust-lang/rust/raw/81fcfc55d247bfe6090741f2e4ae9aa89947bf32/crates%2Fra_ide_api%2Fsrc%2Fcompletion%2Fsnapshots%2Fcompletion_item__inserts_parens_for_function_calls3.snap", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Fcompletion%2Fsnapshots%2Fcompletion_item__inserts_parens_for_function_calls3.snap?ref=81fcfc55d247bfe6090741f2e4ae9aa89947bf32", "patch": "@@ -0,0 +1,26 @@\n+---\n+created: \"2019-01-23T13:19:23.525922020+00:00\"\n+creator: insta@0.5.2\n+expression: kind_completions\n+source: crates/ra_ide_api/src/completion/completion_item.rs\n+---\n+[\n+    CompletionItem {\n+        completion_kind: Reference,\n+        label: \"foo\",\n+        kind: Some(\n+            Method\n+        ),\n+        detail: Some(\n+            \"fn foo(&self)\"\n+        ),\n+        documentation: None,\n+        lookup: None,\n+        insert_text: Some(\n+            \"foo()$0\"\n+        ),\n+        insert_text_format: Snippet,\n+        source_range: [139; 140),\n+        text_edit: None\n+    }\n+]"}, {"sha": "10fe59248951a52b6bb527388c3ee4ab78a59503", "filename": "crates/ra_ide_api/src/completion/snapshots/completion_item__method_completion.snap", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/81fcfc55d247bfe6090741f2e4ae9aa89947bf32/crates%2Fra_ide_api%2Fsrc%2Fcompletion%2Fsnapshots%2Fcompletion_item__method_completion.snap", "raw_url": "https://github.com/rust-lang/rust/raw/81fcfc55d247bfe6090741f2e4ae9aa89947bf32/crates%2Fra_ide_api%2Fsrc%2Fcompletion%2Fsnapshots%2Fcompletion_item__method_completion.snap", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Fcompletion%2Fsnapshots%2Fcompletion_item__method_completion.snap?ref=81fcfc55d247bfe6090741f2e4ae9aa89947bf32", "patch": "@@ -1,8 +1,8 @@\n ---\n-created: \"2019-01-22T15:38:19.541947400+00:00\"\n-creator: insta@0.4.0\n+created: \"2019-01-23T13:19:23.501258181+00:00\"\n+creator: insta@0.5.2\n expression: kind_completions\n-source: \"crates\\\\ra_ide_api\\\\src\\\\completion\\\\completion_item.rs\"\n+source: crates/ra_ide_api/src/completion/completion_item.rs\n ---\n [\n     CompletionItem {\n@@ -17,7 +17,7 @@ source: \"crates\\\\ra_ide_api\\\\src\\\\completion\\\\completion_item.rs\"\n         documentation: None,\n         lookup: None,\n         insert_text: Some(\n-            \"the_method($0)\"\n+            \"the_method()$0\"\n         ),\n         insert_text_format: Snippet,\n         source_range: [144; 144),"}, {"sha": "5f5df00332b576ef8006ac6d5cf2e57a13d4d179", "filename": "crates/ra_ide_api/src/completion/snapshots/completion_item__struct_field_completion_autoderef.snap", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/81fcfc55d247bfe6090741f2e4ae9aa89947bf32/crates%2Fra_ide_api%2Fsrc%2Fcompletion%2Fsnapshots%2Fcompletion_item__struct_field_completion_autoderef.snap", "raw_url": "https://github.com/rust-lang/rust/raw/81fcfc55d247bfe6090741f2e4ae9aa89947bf32/crates%2Fra_ide_api%2Fsrc%2Fcompletion%2Fsnapshots%2Fcompletion_item__struct_field_completion_autoderef.snap", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Fcompletion%2Fsnapshots%2Fcompletion_item__struct_field_completion_autoderef.snap?ref=81fcfc55d247bfe6090741f2e4ae9aa89947bf32", "patch": "@@ -1,8 +1,8 @@\n ---\n-created: \"2019-01-22T15:38:19.541947400+00:00\"\n-creator: insta@0.4.0\n+created: \"2019-01-23T13:19:23.501353210+00:00\"\n+creator: insta@0.5.2\n expression: kind_completions\n-source: \"crates\\\\ra_ide_api\\\\src\\\\completion\\\\completion_item.rs\"\n+source: crates/ra_ide_api/src/completion/completion_item.rs\n ---\n [\n     CompletionItem {\n@@ -33,7 +33,7 @@ source: \"crates\\\\ra_ide_api\\\\src\\\\completion\\\\completion_item.rs\"\n         documentation: None,\n         lookup: None,\n         insert_text: Some(\n-            \"foo($0)\"\n+            \"foo()$0\"\n         ),\n         insert_text_format: Snippet,\n         source_range: [126; 126),"}, {"sha": "80e8f3df58be97d03ffacef8e857a17aa74eecfb", "filename": "crates/ra_ide_api/src/completion/snapshots/completion_item__struct_field_completion_self.snap", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/81fcfc55d247bfe6090741f2e4ae9aa89947bf32/crates%2Fra_ide_api%2Fsrc%2Fcompletion%2Fsnapshots%2Fcompletion_item__struct_field_completion_self.snap", "raw_url": "https://github.com/rust-lang/rust/raw/81fcfc55d247bfe6090741f2e4ae9aa89947bf32/crates%2Fra_ide_api%2Fsrc%2Fcompletion%2Fsnapshots%2Fcompletion_item__struct_field_completion_self.snap", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Fcompletion%2Fsnapshots%2Fcompletion_item__struct_field_completion_self.snap?ref=81fcfc55d247bfe6090741f2e4ae9aa89947bf32", "patch": "@@ -1,8 +1,8 @@\n ---\n-created: \"2019-01-22T15:38:19.541947400+00:00\"\n-creator: insta@0.4.0\n+created: \"2019-01-23T13:19:23.501297515+00:00\"\n+creator: insta@0.5.2\n expression: kind_completions\n-source: \"crates\\\\ra_ide_api\\\\src\\\\completion\\\\completion_item.rs\"\n+source: crates/ra_ide_api/src/completion/completion_item.rs\n ---\n [\n     CompletionItem {\n@@ -33,7 +33,7 @@ source: \"crates\\\\ra_ide_api\\\\src\\\\completion\\\\completion_item.rs\"\n         documentation: None,\n         lookup: None,\n         insert_text: Some(\n-            \"foo($0)\"\n+            \"foo()$0\"\n         ),\n         insert_text_format: Snippet,\n         source_range: [121; 121),"}, {"sha": "3502bfd2e56407d0fd30299a8132091154110355", "filename": "crates/ra_ide_api/src/lib.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/81fcfc55d247bfe6090741f2e4ae9aa89947bf32/crates%2Fra_ide_api%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/81fcfc55d247bfe6090741f2e4ae9aa89947bf32/crates%2Fra_ide_api%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Flib.rs?ref=81fcfc55d247bfe6090741f2e4ae9aa89947bf32", "patch": "@@ -26,6 +26,9 @@ mod syntax_highlighting;\n mod parent_module;\n mod rename;\n \n+#[cfg(test)]\n+mod marks;\n+\n use std::{fmt, sync::Arc};\n \n use ra_syntax::{SourceFile, TreeArc, TextRange, TextUnit};"}, {"sha": "b4a726ef002ba7c5fec57a0d3dab682be06172d1", "filename": "crates/ra_ide_api/src/marks.rs", "status": "added", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/81fcfc55d247bfe6090741f2e4ae9aa89947bf32/crates%2Fra_ide_api%2Fsrc%2Fmarks.rs", "raw_url": "https://github.com/rust-lang/rust/raw/81fcfc55d247bfe6090741f2e4ae9aa89947bf32/crates%2Fra_ide_api%2Fsrc%2Fmarks.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Fmarks.rs?ref=81fcfc55d247bfe6090741f2e4ae9aa89947bf32", "patch": "@@ -0,0 +1,3 @@\n+use test_utils::mark;\n+\n+mark!(inserts_parens_for_function_calls);"}]}