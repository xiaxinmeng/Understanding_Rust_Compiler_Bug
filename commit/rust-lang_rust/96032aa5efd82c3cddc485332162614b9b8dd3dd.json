{"sha": "96032aa5efd82c3cddc485332162614b9b8dd3dd", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk2MDMyYWE1ZWZkODJjM2NkZGM0ODUzMzIxNjI2MTRiOWI4ZGQzZGQ=", "commit": {"author": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2019-08-19T20:35:25Z"}, "committer": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2019-08-21T08:53:39Z"}, "message": "expand: Keep the correct current expansion ID for eager expansions\n\nSolve the problem of `ParentScope` entries for eager expansions not exising in the resolver map by creating them on demand.", "tree": {"sha": "72146d69b916e548ac03c6481fa3a95f0f0f2d62", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/72146d69b916e548ac03c6481fa3a95f0f0f2d62"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/96032aa5efd82c3cddc485332162614b9b8dd3dd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/96032aa5efd82c3cddc485332162614b9b8dd3dd", "html_url": "https://github.com/rust-lang/rust/commit/96032aa5efd82c3cddc485332162614b9b8dd3dd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/96032aa5efd82c3cddc485332162614b9b8dd3dd/comments", "author": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "committer": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1dd56aa3047851891e6a1923e8fec3569d0fc89f", "url": "https://api.github.com/repos/rust-lang/rust/commits/1dd56aa3047851891e6a1923e8fec3569d0fc89f", "html_url": "https://github.com/rust-lang/rust/commit/1dd56aa3047851891e6a1923e8fec3569d0fc89f"}], "stats": {"total": 11, "additions": 9, "deletions": 2}, "files": [{"sha": "8a7a30813c1e0ce2dbc19aeda7addd0fab676fb8", "filename": "src/librustc_resolve/macros.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/96032aa5efd82c3cddc485332162614b9b8dd3dd/src%2Flibrustc_resolve%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/96032aa5efd82c3cddc485332162614b9b8dd3dd/src%2Flibrustc_resolve%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Fmacros.rs?ref=96032aa5efd82c3cddc485332162614b9b8dd3dd", "patch": "@@ -142,7 +142,9 @@ impl<'a> base::Resolver for Resolver<'a> {\n \n     fn resolve_macro_invocation(&mut self, invoc: &Invocation, invoc_id: ExpnId, force: bool)\n                                 -> Result<Option<Lrc<SyntaxExtension>>, Indeterminate> {\n-        let parent_scope = self.invocation_parent_scopes[&invoc_id];\n+        let inherited_parent_scope = self.invocation_parent_scopes[&invoc_id];\n+        let parent_scope = *self.invocation_parent_scopes.entry(invoc.expansion_data.id)\n+                                                         .or_insert(inherited_parent_scope);\n         let (path, kind, derives, after_derive) = match invoc.kind {\n             InvocationKind::Attr { ref attr, ref derives, after_derive, .. } =>\n                 (&attr.path, MacroKind::Attr, self.arenas.alloc_ast_paths(derives), after_derive),"}, {"sha": "5ac234b78d0fe5b6eb9d956a8cad99d39a71b2de", "filename": "src/libsyntax/ext/expand.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/96032aa5efd82c3cddc485332162614b9b8dd3dd/src%2Flibsyntax%2Fext%2Fexpand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/96032aa5efd82c3cddc485332162614b9b8dd3dd/src%2Flibsyntax%2Fext%2Fexpand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fexpand.rs?ref=96032aa5efd82c3cddc485332162614b9b8dd3dd", "patch": "@@ -318,7 +318,6 @@ impl<'a, 'b> MacroExpander<'a, 'b> {\n             progress = true;\n             let ExpansionData { depth, id: expn_id, .. } = invoc.expansion_data;\n             self.cx.current_expansion = invoc.expansion_data.clone();\n-            self.cx.current_expansion.id = scope;\n \n             // FIXME(jseyfried): Refactor out the following logic\n             let (expanded_fragment, new_invocations) = if let Some(ext) = ext {"}, {"sha": "f696e6caff7ca9462d532b4332434efbcd9e2b14", "filename": "src/test/ui/hygiene/eager-from-opaque.stderr", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/96032aa5efd82c3cddc485332162614b9b8dd3dd/src%2Ftest%2Fui%2Fhygiene%2Feager-from-opaque.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/96032aa5efd82c3cddc485332162614b9b8dd3dd/src%2Ftest%2Fui%2Fhygiene%2Feager-from-opaque.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fhygiene%2Feager-from-opaque.stderr?ref=96032aa5efd82c3cddc485332162614b9b8dd3dd", "patch": "@@ -3,6 +3,9 @@ error: cannot find macro `foo!` in this scope\n    |\n LL |         foo!()\n    |         ^^^\n+...\n+LL |     format_args!(bar!());\n+   |                  ------ in this macro invocation\n \n error: aborting due to previous error\n "}, {"sha": "5ca4088e585dbcc38ca5eadd8311a6b5a2c7eb64", "filename": "src/test/ui/macros/derive-in-eager-expansion-hang.stderr", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/96032aa5efd82c3cddc485332162614b9b8dd3dd/src%2Ftest%2Fui%2Fmacros%2Fderive-in-eager-expansion-hang.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/96032aa5efd82c3cddc485332162614b9b8dd3dd/src%2Ftest%2Fui%2Fmacros%2Fderive-in-eager-expansion-hang.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacros%2Fderive-in-eager-expansion-hang.stderr?ref=96032aa5efd82c3cddc485332162614b9b8dd3dd", "patch": "@@ -8,6 +8,9 @@ LL | |\n LL | |         \"\"\n LL | |     }\n    | |_____^\n+...\n+LL |       format_args!(hang!());\n+   |                    ------- in this macro invocation\n help: you might be missing a string literal to format with\n    |\n LL |     format_args!(\"{}\", hang!());"}]}