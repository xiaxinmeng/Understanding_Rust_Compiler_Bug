{"sha": "c076392143e483f60429d148ac58522e423eea9e", "node_id": "MDY6Q29tbWl0NzI0NzEyOmMwNzYzOTIxNDNlNDgzZjYwNDI5ZDE0OGFjNTg1MjJlNDIzZWVhOWU=", "commit": {"author": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2019-08-06T21:20:39Z"}, "committer": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2019-08-09T14:18:05Z"}, "message": "Tweak mismatched types error on break expressions", "tree": {"sha": "70625460727d33c3d7f3e0a42687e61f3af94238", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/70625460727d33c3d7f3e0a42687e61f3af94238"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c076392143e483f60429d148ac58522e423eea9e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c076392143e483f60429d148ac58522e423eea9e", "html_url": "https://github.com/rust-lang/rust/commit/c076392143e483f60429d148ac58522e423eea9e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c076392143e483f60429d148ac58522e423eea9e/comments", "author": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "committer": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "813a3a5d4b2be4e2101faa73a067da02a704a598", "url": "https://api.github.com/repos/rust-lang/rust/commits/813a3a5d4b2be4e2101faa73a067da02a704a598", "html_url": "https://github.com/rust-lang/rust/commit/813a3a5d4b2be4e2101faa73a067da02a704a598"}], "stats": {"total": 79, "additions": 57, "deletions": 22}, "files": [{"sha": "c567741be3980b2bbb08ba66becdae58d6a9509c", "filename": "src/librustc_typeck/check/expr.rs", "status": "modified", "additions": 15, "deletions": 1, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/c076392143e483f60429d148ac58522e423eea9e/src%2Flibrustc_typeck%2Fcheck%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c076392143e483f60429d148ac58522e423eea9e/src%2Flibrustc_typeck%2Fcheck%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fexpr.rs?ref=c076392143e483f60429d148ac58522e423eea9e", "patch": "@@ -548,7 +548,21 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                     coerce.coerce(self, &cause, e, e_ty);\n                 } else {\n                     assert!(e_ty.is_unit());\n-                    coerce.coerce_forced_unit(self, &cause, &mut |_| (), true);\n+                    let ty = coerce.expected_ty();\n+                    coerce.coerce_forced_unit(self, &cause, &mut |err| {\n+                        let msg = \"give it a value of the expected type\";\n+                        let label = destination.label\n+                            .map(|l| format!(\" {}\", l.ident))\n+                            .unwrap_or_else(String::new);\n+                        let sugg = format!(\"break{} {}\", label, match ty.sty {\n+                            ty::Bool => \"true\",\n+                            ty::Char => \"'a'\",\n+                            ty::Int(_) | ty::Uint(_) => \"42\",\n+                            ty::Float(_) => \"3.14159\",\n+                            _ => \"value\",\n+                        });\n+                        err.span_suggestion(expr.span, msg, sugg, Applicability::HasPlaceholders);\n+                    }, false);\n                 }\n             } else {\n                 // If `ctxt.coerce` is `None`, we can just ignore"}, {"sha": "7678984a518ba89bdc84ada86fef76bb10e00b41", "filename": "src/test/ui/issues/issue-27042.stderr", "status": "modified", "additions": 6, "deletions": 3, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/c076392143e483f60429d148ac58522e423eea9e/src%2Ftest%2Fui%2Fissues%2Fissue-27042.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c076392143e483f60429d148ac58522e423eea9e/src%2Ftest%2Fui%2Fissues%2Fissue-27042.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-27042.stderr?ref=c076392143e483f60429d148ac58522e423eea9e", "patch": "@@ -12,10 +12,13 @@ error[E0308]: mismatched types\n   --> $DIR/issue-27042.rs:6:16\n    |\n LL |         loop { break };\n-   |                ^^^^^ expected (), found i32\n+   |                ^^^^^\n+   |                |\n+   |                expected i32, found ()\n+   |                help: give it a value of the expected type: `break 42`\n    |\n-   = note: expected type `()`\n-              found type `i32`\n+   = note: expected type `i32`\n+              found type `()`\n \n error[E0308]: mismatched types\n   --> $DIR/issue-27042.rs:8:9"}, {"sha": "7310790b880c24ba206d461ec9f722caae3afcda", "filename": "src/test/ui/loops/loop-break-value.stderr", "status": "modified", "additions": 12, "deletions": 6, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/c076392143e483f60429d148ac58522e423eea9e/src%2Ftest%2Fui%2Floops%2Floop-break-value.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c076392143e483f60429d148ac58522e423eea9e/src%2Ftest%2Fui%2Floops%2Floop-break-value.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Floops%2Floop-break-value.stderr?ref=c076392143e483f60429d148ac58522e423eea9e", "patch": "@@ -90,10 +90,13 @@ error[E0308]: mismatched types\n   --> $DIR/loop-break-value.rs:4:31\n    |\n LL |     let val: ! = loop { break break; };\n-   |                               ^^^^^ expected (), found !\n+   |                               ^^^^^\n+   |                               |\n+   |                               expected !, found ()\n+   |                               help: give it a value of the expected type: `break value`\n    |\n-   = note: expected type `()`\n-              found type `!`\n+   = note: expected type `!`\n+              found type `()`\n \n error[E0308]: mismatched types\n   --> $DIR/loop-break-value.rs:11:19\n@@ -153,10 +156,13 @@ error[E0308]: mismatched types\n   --> $DIR/loop-break-value.rs:90:9\n    |\n LL |         break;\n-   |         ^^^^^ expected (), found integer\n+   |         ^^^^^\n+   |         |\n+   |         expected integer, found ()\n+   |         help: give it a value of the expected type: `break value`\n    |\n-   = note: expected type `()`\n-              found type `{integer}`\n+   = note: expected type `{integer}`\n+              found type `()`\n \n error: aborting due to 16 previous errors\n "}, {"sha": "8b9468cacc1f9d5a11a049bf20d86e7b253abf2d", "filename": "src/test/ui/loops/loop-labeled-break-value.stderr", "status": "modified", "additions": 18, "deletions": 9, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/c076392143e483f60429d148ac58522e423eea9e/src%2Ftest%2Fui%2Floops%2Floop-labeled-break-value.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c076392143e483f60429d148ac58522e423eea9e/src%2Ftest%2Fui%2Floops%2Floop-labeled-break-value.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Floops%2Floop-labeled-break-value.stderr?ref=c076392143e483f60429d148ac58522e423eea9e", "patch": "@@ -2,28 +2,37 @@ error[E0308]: mismatched types\n   --> $DIR/loop-labeled-break-value.rs:3:29\n    |\n LL |         let _: i32 = loop { break };\n-   |                             ^^^^^ expected (), found i32\n+   |                             ^^^^^\n+   |                             |\n+   |                             expected i32, found ()\n+   |                             help: give it a value of the expected type: `break 42`\n    |\n-   = note: expected type `()`\n-              found type `i32`\n+   = note: expected type `i32`\n+              found type `()`\n \n error[E0308]: mismatched types\n   --> $DIR/loop-labeled-break-value.rs:6:37\n    |\n LL |         let _: i32 = 'inner: loop { break 'inner };\n-   |                                     ^^^^^^^^^^^^ expected (), found i32\n+   |                                     ^^^^^^^^^^^^\n+   |                                     |\n+   |                                     expected i32, found ()\n+   |                                     help: give it a value of the expected type: `break 'inner 42`\n    |\n-   = note: expected type `()`\n-              found type `i32`\n+   = note: expected type `i32`\n+              found type `()`\n \n error[E0308]: mismatched types\n   --> $DIR/loop-labeled-break-value.rs:9:45\n    |\n LL |         let _: i32 = 'inner2: loop { loop { break 'inner2 } };\n-   |                                             ^^^^^^^^^^^^^ expected (), found i32\n+   |                                             ^^^^^^^^^^^^^\n+   |                                             |\n+   |                                             expected i32, found ()\n+   |                                             help: give it a value of the expected type: `break 'inner2 42`\n    |\n-   = note: expected type `()`\n-              found type `i32`\n+   = note: expected type `i32`\n+              found type `()`\n \n error: aborting due to 3 previous errors\n "}, {"sha": "3758bbf9f6f31c3be80d95f5dcf142e6671103d5", "filename": "src/test/ui/loops/loop-properly-diverging-2.stderr", "status": "modified", "additions": 6, "deletions": 3, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/c076392143e483f60429d148ac58522e423eea9e/src%2Ftest%2Fui%2Floops%2Floop-properly-diverging-2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c076392143e483f60429d148ac58522e423eea9e/src%2Ftest%2Fui%2Floops%2Floop-properly-diverging-2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Floops%2Floop-properly-diverging-2.stderr?ref=c076392143e483f60429d148ac58522e423eea9e", "patch": "@@ -2,10 +2,13 @@ error[E0308]: mismatched types\n   --> $DIR/loop-properly-diverging-2.rs:2:23\n    |\n LL |   let x: i32 = loop { break };\n-   |                       ^^^^^ expected (), found i32\n+   |                       ^^^^^\n+   |                       |\n+   |                       expected i32, found ()\n+   |                       help: give it a value of the expected type: `break 42`\n    |\n-   = note: expected type `()`\n-              found type `i32`\n+   = note: expected type `i32`\n+              found type `()`\n \n error: aborting due to previous error\n "}]}