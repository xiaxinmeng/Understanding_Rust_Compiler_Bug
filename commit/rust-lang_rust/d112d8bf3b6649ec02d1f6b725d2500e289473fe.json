{"sha": "d112d8bf3b6649ec02d1f6b725d2500e289473fe", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQxMTJkOGJmM2I2NjQ5ZWMwMmQxZjZiNzI1ZDI1MDBlMjg5NDczZmU=", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2020-06-06T19:57:39Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-06-06T19:57:39Z"}, "message": "Rollup merge of #72708 - petrochenkov:linkhack, r=cuviper\n\nlinker: Add a linker rerun hack for gcc versions not supporting -static-pie\n\nWhich mirrors the existing `-no-pie` linker rerun hack, but the logic is a bit more elaborated in this case.\n\nIf the linker (gcc or clang) errors on `-static-pie` we rerun in with `-static` instead.\nWe must also replace CRT objects corresponding to `-static-pie` with ones corresponding to `-static` in this case.\n\n(One sanity check for CRT objects in target specs is also added as a drive-by fix.)\n\nTo do in the future: refactor all linker rerun hacks into separate functions and share more code with `add_(pre,post)_link_objects`.\n\nThis PR accompanies https://github.com/rust-lang/rust/pull/71804 and unblocks https://github.com/rust-lang/rust/pull/70740.", "tree": {"sha": "9f83165f7d0305cdcd36f97c7c7253368456ac12", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9f83165f7d0305cdcd36f97c7c7253368456ac12"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d112d8bf3b6649ec02d1f6b725d2500e289473fe", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJe2/U0CRBK7hj4Ov3rIwAAdHIIABIFSgfQxo+fQqqs8fO2Poaj\ns/NrkwQJLJC0OKGmGhup7m4MGdIawPM496euSeLVM2uefrjMJRQ46JkLc1Z3SYiB\nV99Nrtvlx8cJXSoWhws2I0/inN4wgIrKCCweNGimV+eT8kKWhEs6lJ2qh0/LJY3n\ncGGNm9Y5SKe9H7F0oY8CiZt4TeCEfG7fxL8x0RbQkClBUmhDwBIJWijJK7Kz96MT\neQZIyDldqfRm/QXeZLN4yqQnyij+UdeGvoff8TZdY54kHsJjlYkzvi1r5VrvFd2l\n8vpffkovhrpJ770W+ptpUYxQO+s8fdrrdHQCdEsfTnLiTLDe56Ix8VXgIZvR+KA=\n=+Evi\n-----END PGP SIGNATURE-----\n", "payload": "tree 9f83165f7d0305cdcd36f97c7c7253368456ac12\nparent de4d5ce11e064cbca604d9bb891c00b94e1ec8f5\nparent 071f0422c6dd897bc61891f96d4448df44d8069f\nauthor Ralf Jung <post@ralfj.de> 1591473459 +0200\ncommitter GitHub <noreply@github.com> 1591473459 +0200\n\nRollup merge of #72708 - petrochenkov:linkhack, r=cuviper\n\nlinker: Add a linker rerun hack for gcc versions not supporting -static-pie\n\nWhich mirrors the existing `-no-pie` linker rerun hack, but the logic is a bit more elaborated in this case.\n\nIf the linker (gcc or clang) errors on `-static-pie` we rerun in with `-static` instead.\nWe must also replace CRT objects corresponding to `-static-pie` with ones corresponding to `-static` in this case.\n\n(One sanity check for CRT objects in target specs is also added as a drive-by fix.)\n\nTo do in the future: refactor all linker rerun hacks into separate functions and share more code with `add_(pre,post)_link_objects`.\n\nThis PR accompanies https://github.com/rust-lang/rust/pull/71804 and unblocks https://github.com/rust-lang/rust/pull/70740.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d112d8bf3b6649ec02d1f6b725d2500e289473fe", "html_url": "https://github.com/rust-lang/rust/commit/d112d8bf3b6649ec02d1f6b725d2500e289473fe", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d112d8bf3b6649ec02d1f6b725d2500e289473fe/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "de4d5ce11e064cbca604d9bb891c00b94e1ec8f5", "url": "https://api.github.com/repos/rust-lang/rust/commits/de4d5ce11e064cbca604d9bb891c00b94e1ec8f5", "html_url": "https://github.com/rust-lang/rust/commit/de4d5ce11e064cbca604d9bb891c00b94e1ec8f5"}, {"sha": "071f0422c6dd897bc61891f96d4448df44d8069f", "url": "https://api.github.com/repos/rust-lang/rust/commits/071f0422c6dd897bc61891f96d4448df44d8069f", "html_url": "https://github.com/rust-lang/rust/commit/071f0422c6dd897bc61891f96d4448df44d8069f"}], "stats": {"total": 70, "additions": 62, "deletions": 8}, "files": [{"sha": "53e3da3c0baf0bc40c0e111e71c6b23d029d079a", "filename": "src/librustc_codegen_ssa/back/link.rs", "status": "modified", "additions": 57, "deletions": 8, "changes": 65, "blob_url": "https://github.com/rust-lang/rust/blob/d112d8bf3b6649ec02d1f6b725d2500e289473fe/src%2Flibrustc_codegen_ssa%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d112d8bf3b6649ec02d1f6b725d2500e289473fe/src%2Flibrustc_codegen_ssa%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fback%2Flink.rs?ref=d112d8bf3b6649ec02d1f6b725d2500e289473fe", "patch": "@@ -12,7 +12,7 @@ use rustc_session::utils::NativeLibKind;\n /// need out of the shared crate context before we get rid of it.\n use rustc_session::{filesearch, Session};\n use rustc_span::symbol::Symbol;\n-use rustc_target::spec::crt_objects::CrtObjectsFallback;\n+use rustc_target::spec::crt_objects::{CrtObjects, CrtObjectsFallback};\n use rustc_target::spec::{LinkOutputKind, LinkerFlavor, LldFlavor};\n use rustc_target::spec::{PanicStrategy, RelocModel, RelroLevel};\n \n@@ -25,16 +25,10 @@ use crate::{looks_like_rust_object_file, CodegenResults, CrateInfo, METADATA_FIL\n use cc::windows_registry;\n use tempfile::{Builder as TempFileBuilder, TempDir};\n \n-use std::ascii;\n-use std::char;\n-use std::env;\n use std::ffi::OsString;\n-use std::fmt;\n-use std::fs;\n-use std::io;\n use std::path::{Path, PathBuf};\n use std::process::{ExitStatus, Output, Stdio};\n-use std::str;\n+use std::{ascii, char, env, fmt, fs, io, mem, str};\n \n pub fn remove(sess: &Session, path: &Path) {\n     if let Err(e) = fs::remove_file(path) {\n@@ -543,6 +537,61 @@ fn link_natively<'a, B: ArchiveBuilder<'a>>(\n             continue;\n         }\n \n+        // Detect '-static-pie' used with an older version of gcc or clang not supporting it.\n+        // Fallback from '-static-pie' to '-static' in that case.\n+        if sess.target.target.options.linker_is_gnu\n+            && flavor != LinkerFlavor::Ld\n+            && (out.contains(\"unrecognized command line option\")\n+                || out.contains(\"unknown argument\"))\n+            && (out.contains(\"-static-pie\") || out.contains(\"--no-dynamic-linker\"))\n+            && cmd.get_args().iter().any(|e| e.to_string_lossy() == \"-static-pie\")\n+        {\n+            info!(\"linker output: {:?}\", out);\n+            warn!(\n+                \"Linker does not support -static-pie command line option. Retrying with -static instead.\"\n+            );\n+            // Mirror `add_(pre,post)_link_objects` to replace CRT objects.\n+            let fallback = crt_objects_fallback(sess, crate_type);\n+            let opts = &sess.target.target.options;\n+            let pre_objects =\n+                if fallback { &opts.pre_link_objects_fallback } else { &opts.pre_link_objects };\n+            let post_objects =\n+                if fallback { &opts.post_link_objects_fallback } else { &opts.post_link_objects };\n+            let get_objects = |objects: &CrtObjects, kind| {\n+                objects\n+                    .get(&kind)\n+                    .iter()\n+                    .copied()\n+                    .flatten()\n+                    .map(|obj| get_object_file_path(sess, obj).into_os_string())\n+                    .collect::<Vec<_>>()\n+            };\n+            let pre_objects_static_pie = get_objects(pre_objects, LinkOutputKind::StaticPicExe);\n+            let post_objects_static_pie = get_objects(post_objects, LinkOutputKind::StaticPicExe);\n+            let mut pre_objects_static = get_objects(pre_objects, LinkOutputKind::StaticNoPicExe);\n+            let mut post_objects_static = get_objects(post_objects, LinkOutputKind::StaticNoPicExe);\n+            // Assume that we know insertion positions for the replacement arguments from replaced\n+            // arguments, which is true for all supported targets.\n+            assert!(pre_objects_static.is_empty() || !pre_objects_static_pie.is_empty());\n+            assert!(post_objects_static.is_empty() || !post_objects_static_pie.is_empty());\n+            for arg in cmd.take_args() {\n+                if arg.to_string_lossy() == \"-static-pie\" {\n+                    // Replace the output kind.\n+                    cmd.arg(\"-static\");\n+                } else if pre_objects_static_pie.contains(&arg) {\n+                    // Replace the pre-link objects (replace the first and remove the rest).\n+                    cmd.args(mem::take(&mut pre_objects_static));\n+                } else if post_objects_static_pie.contains(&arg) {\n+                    // Replace the post-link objects (replace the first and remove the rest).\n+                    cmd.args(mem::take(&mut post_objects_static));\n+                } else {\n+                    cmd.arg(arg);\n+                }\n+            }\n+            info!(\"{:?}\", &cmd);\n+            continue;\n+        }\n+\n         // Here's a terribly awful hack that really shouldn't be present in any\n         // compiler. Here an environment variable is supported to automatically\n         // retry the linker invocation if the linker looks like it segfaulted."}, {"sha": "b2ad62e1b260ba9bddd29ecdcf4a43a1312a5b1e", "filename": "src/librustc_target/spec/tests/tests_impl.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/d112d8bf3b6649ec02d1f6b725d2500e289473fe/src%2Flibrustc_target%2Fspec%2Ftests%2Ftests_impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d112d8bf3b6649ec02d1f6b725d2500e289473fe/src%2Flibrustc_target%2Fspec%2Ftests%2Ftests_impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_target%2Fspec%2Ftests%2Ftests_impl.rs?ref=d112d8bf3b6649ec02d1f6b725d2500e289473fe", "patch": "@@ -38,5 +38,10 @@ impl Target {\n                 assert_eq!(self.options.lld_flavor, LldFlavor::Link);\n             }\n         }\n+        assert!(\n+            (self.options.pre_link_objects_fallback.is_empty()\n+                && self.options.post_link_objects_fallback.is_empty())\n+                || self.options.crt_objects_fallback.is_some()\n+        );\n     }\n }"}]}