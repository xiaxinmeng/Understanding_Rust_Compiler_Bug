{"sha": "9ff5b7ee41cd53737865328c7a210316078e2c17", "node_id": "C_kwDOAAsO6NoAKDlmZjViN2VlNDFjZDUzNzM3ODY1MzI4YzdhMjEwMzE2MDc4ZTJjMTc", "commit": {"author": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2022-04-21T00:00:00Z"}, "committer": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2022-04-21T19:44:15Z"}, "message": "Update `validate_uninhabited_zsts.rs` test after MIR building changes\n\nto ensure that it still tests validation, instead of failing earlier on\nduring evaluation.", "tree": {"sha": "b24da6dfb3181169babec127c8b1621ffe5967f4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b24da6dfb3181169babec127c8b1621ffe5967f4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9ff5b7ee41cd53737865328c7a210316078e2c17", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9ff5b7ee41cd53737865328c7a210316078e2c17", "html_url": "https://github.com/rust-lang/rust/commit/9ff5b7ee41cd53737865328c7a210316078e2c17", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9ff5b7ee41cd53737865328c7a210316078e2c17/comments", "author": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b04c5329e1e145fb2fb46c5a7e775638712b03aa", "url": "https://api.github.com/repos/rust-lang/rust/commits/b04c5329e1e145fb2fb46c5a7e775638712b03aa", "html_url": "https://github.com/rust-lang/rust/commit/b04c5329e1e145fb2fb46c5a7e775638712b03aa"}], "stats": {"total": 89, "additions": 55, "deletions": 34}, "files": [{"sha": "65ab1b02b3587d3cbbae56c1946f5e07c4db2f4e", "filename": "src/test/ui/consts/const-eval/validate_uninhabited_zsts.32bit.stderr", "status": "modified", "additions": 21, "deletions": 14, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/9ff5b7ee41cd53737865328c7a210316078e2c17/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fvalidate_uninhabited_zsts.32bit.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/9ff5b7ee41cd53737865328c7a210316078e2c17/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fvalidate_uninhabited_zsts.32bit.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fvalidate_uninhabited_zsts.32bit.stderr?ref=9ff5b7ee41cd53737865328c7a210316078e2c17", "patch": "@@ -7,14 +7,17 @@ LL |     unsafe { std::mem::transmute(()) }\n    |              transmuting to uninhabited type\n    |              inside `foo` at $DIR/validate_uninhabited_zsts.rs:4:14\n ...\n-LL | const FOO: [Empty; 3] = [foo(); 3];\n-   |                          ----- inside `FOO` at $DIR/validate_uninhabited_zsts.rs:13:26\n+LL | const FOO: [empty::Empty; 3] = [foo(); 3];\n+   |                                 ----- inside `FOO` at $DIR/validate_uninhabited_zsts.rs:20:33\n \n-error[E0080]: evaluation of constant value failed\n-  --> $DIR/validate_uninhabited_zsts.rs:16:35\n+error[E0080]: it is undefined behavior to use this value\n+  --> $DIR/validate_uninhabited_zsts.rs:23:1\n+   |\n+LL | const BAR: [empty::Empty; 3] = [unsafe { std::mem::transmute(()) }; 3];\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ type validation failed at [0].0: encountered a value of uninhabited type empty::Void\n    |\n-LL | const BAR: [Empty; 3] = [unsafe { std::mem::transmute(()) }; 3];\n-   |                                   ^^^^^^^^^^^^^^^^^^^^^^^ transmuting to uninhabited type\n+   = note: The rules on what exactly is undefined behavior aren't clear, so this check might be overzealous. Please open an issue on the rustc repository if you believe it should not be considered undefined behavior.\n+   = note: the raw bytes of the constant (size: 0, align: 1) {}\n \n warning: the type `!` does not permit zero-initialization\n   --> $DIR/validate_uninhabited_zsts.rs:4:14\n@@ -28,16 +31,20 @@ LL |     unsafe { std::mem::transmute(()) }\n    = note: `#[warn(invalid_value)]` on by default\n    = note: the `!` type has no valid value\n \n-warning: the type `Empty` does not permit zero-initialization\n-  --> $DIR/validate_uninhabited_zsts.rs:16:35\n+warning: the type `empty::Empty` does not permit zero-initialization\n+  --> $DIR/validate_uninhabited_zsts.rs:23:42\n+   |\n+LL | const BAR: [empty::Empty; 3] = [unsafe { std::mem::transmute(()) }; 3];\n+   |                                          ^^^^^^^^^^^^^^^^^^^^^^^\n+   |                                          |\n+   |                                          this code causes undefined behavior when executed\n+   |                                          help: use `MaybeUninit<T>` instead, and only call `assume_init` after initialization is done\n    |\n-LL | const BAR: [Empty; 3] = [unsafe { std::mem::transmute(()) }; 3];\n-   |                                   ^^^^^^^^^^^^^^^^^^^^^^^\n-   |                                   |\n-   |                                   this code causes undefined behavior when executed\n-   |                                   help: use `MaybeUninit<T>` instead, and only call `assume_init` after initialization is done\n+note: enums with no variants have no valid value (in this struct field)\n+  --> $DIR/validate_uninhabited_zsts.rs:16:22\n    |\n-   = note: enums with no variants have no valid value\n+LL |     pub struct Empty(Void);\n+   |                      ^^^^\n \n error: aborting due to 2 previous errors; 2 warnings emitted\n "}, {"sha": "65ab1b02b3587d3cbbae56c1946f5e07c4db2f4e", "filename": "src/test/ui/consts/const-eval/validate_uninhabited_zsts.64bit.stderr", "status": "modified", "additions": 21, "deletions": 14, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/9ff5b7ee41cd53737865328c7a210316078e2c17/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fvalidate_uninhabited_zsts.64bit.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/9ff5b7ee41cd53737865328c7a210316078e2c17/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fvalidate_uninhabited_zsts.64bit.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fvalidate_uninhabited_zsts.64bit.stderr?ref=9ff5b7ee41cd53737865328c7a210316078e2c17", "patch": "@@ -7,14 +7,17 @@ LL |     unsafe { std::mem::transmute(()) }\n    |              transmuting to uninhabited type\n    |              inside `foo` at $DIR/validate_uninhabited_zsts.rs:4:14\n ...\n-LL | const FOO: [Empty; 3] = [foo(); 3];\n-   |                          ----- inside `FOO` at $DIR/validate_uninhabited_zsts.rs:13:26\n+LL | const FOO: [empty::Empty; 3] = [foo(); 3];\n+   |                                 ----- inside `FOO` at $DIR/validate_uninhabited_zsts.rs:20:33\n \n-error[E0080]: evaluation of constant value failed\n-  --> $DIR/validate_uninhabited_zsts.rs:16:35\n+error[E0080]: it is undefined behavior to use this value\n+  --> $DIR/validate_uninhabited_zsts.rs:23:1\n+   |\n+LL | const BAR: [empty::Empty; 3] = [unsafe { std::mem::transmute(()) }; 3];\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ type validation failed at [0].0: encountered a value of uninhabited type empty::Void\n    |\n-LL | const BAR: [Empty; 3] = [unsafe { std::mem::transmute(()) }; 3];\n-   |                                   ^^^^^^^^^^^^^^^^^^^^^^^ transmuting to uninhabited type\n+   = note: The rules on what exactly is undefined behavior aren't clear, so this check might be overzealous. Please open an issue on the rustc repository if you believe it should not be considered undefined behavior.\n+   = note: the raw bytes of the constant (size: 0, align: 1) {}\n \n warning: the type `!` does not permit zero-initialization\n   --> $DIR/validate_uninhabited_zsts.rs:4:14\n@@ -28,16 +31,20 @@ LL |     unsafe { std::mem::transmute(()) }\n    = note: `#[warn(invalid_value)]` on by default\n    = note: the `!` type has no valid value\n \n-warning: the type `Empty` does not permit zero-initialization\n-  --> $DIR/validate_uninhabited_zsts.rs:16:35\n+warning: the type `empty::Empty` does not permit zero-initialization\n+  --> $DIR/validate_uninhabited_zsts.rs:23:42\n+   |\n+LL | const BAR: [empty::Empty; 3] = [unsafe { std::mem::transmute(()) }; 3];\n+   |                                          ^^^^^^^^^^^^^^^^^^^^^^^\n+   |                                          |\n+   |                                          this code causes undefined behavior when executed\n+   |                                          help: use `MaybeUninit<T>` instead, and only call `assume_init` after initialization is done\n    |\n-LL | const BAR: [Empty; 3] = [unsafe { std::mem::transmute(()) }; 3];\n-   |                                   ^^^^^^^^^^^^^^^^^^^^^^^\n-   |                                   |\n-   |                                   this code causes undefined behavior when executed\n-   |                                   help: use `MaybeUninit<T>` instead, and only call `assume_init` after initialization is done\n+note: enums with no variants have no valid value (in this struct field)\n+  --> $DIR/validate_uninhabited_zsts.rs:16:22\n    |\n-   = note: enums with no variants have no valid value\n+LL |     pub struct Empty(Void);\n+   |                      ^^^^\n \n error: aborting due to 2 previous errors; 2 warnings emitted\n "}, {"sha": "96f3312758292e34b8e9cf9a5e9f206de18c8e1e", "filename": "src/test/ui/consts/const-eval/validate_uninhabited_zsts.rs", "status": "modified", "additions": 13, "deletions": 6, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/9ff5b7ee41cd53737865328c7a210316078e2c17/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fvalidate_uninhabited_zsts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9ff5b7ee41cd53737865328c7a210316078e2c17/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fvalidate_uninhabited_zsts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fvalidate_uninhabited_zsts.rs?ref=9ff5b7ee41cd53737865328c7a210316078e2c17", "patch": "@@ -6,16 +6,23 @@ const fn foo() -> ! {\n     //~| WARN the type `!` does not permit zero-initialization [invalid_value]\n }\n \n-#[derive(Clone, Copy)]\n-enum Empty { }\n+// Type defined in a submodule, so that it is not \"visibly\"\n+// uninhabited (which would change interpreter behavior).\n+pub mod empty {\n+    #[derive(Clone, Copy)]\n+    enum Void {}\n+\n+    #[derive(Clone, Copy)]\n+    pub struct Empty(Void);\n+}\n \n #[warn(const_err)]\n-const FOO: [Empty; 3] = [foo(); 3];\n+const FOO: [empty::Empty; 3] = [foo(); 3];\n \n #[warn(const_err)]\n-const BAR: [Empty; 3] = [unsafe { std::mem::transmute(()) }; 3];\n-//~^ ERROR evaluation of constant value failed\n-//~| WARN the type `Empty` does not permit zero-initialization\n+const BAR: [empty::Empty; 3] = [unsafe { std::mem::transmute(()) }; 3];\n+//~^ ERROR it is undefined behavior to use this value\n+//~| WARN the type `empty::Empty` does not permit zero-initialization\n \n fn main() {\n     FOO;"}]}