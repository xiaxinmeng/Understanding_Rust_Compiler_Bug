{"sha": "a803f313fdf8f6eb2d674d7dfb3694a2b437ee1e", "node_id": "C_kwDOAAsO6NoAKGE4MDNmMzEzZmRmOGY2ZWIyZDY3NGQ3ZGZiMzY5NGEyYjQzN2VlMWU", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-12-16T06:45:08Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-12-16T06:45:08Z"}, "message": "Auto merge of #105717 - compiler-errors:anonymize, r=jackh726\n\nalways use `anonymize_bound_vars`\n\nUnless this is perf-sensitive, it's probably best to always use one anonymize function that does the right thing for all bound vars.\n\nr? types", "tree": {"sha": "311ccf71f46b7d3f40eb3420e7a5f08bf67a0f80", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/311ccf71f46b7d3f40eb3420e7a5f08bf67a0f80"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a803f313fdf8f6eb2d674d7dfb3694a2b437ee1e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a803f313fdf8f6eb2d674d7dfb3694a2b437ee1e", "html_url": "https://github.com/rust-lang/rust/commit/a803f313fdf8f6eb2d674d7dfb3694a2b437ee1e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a803f313fdf8f6eb2d674d7dfb3694a2b437ee1e/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "39b2a41b39b445bf7efab02f6eade16135d7df85", "url": "https://api.github.com/repos/rust-lang/rust/commits/39b2a41b39b445bf7efab02f6eade16135d7df85", "html_url": "https://github.com/rust-lang/rust/commit/39b2a41b39b445bf7efab02f6eade16135d7df85"}, {"sha": "3eb5b62898a8e7f24679aa7a4a9ce4d769f4ba32", "url": "https://api.github.com/repos/rust-lang/rust/commits/3eb5b62898a8e7f24679aa7a4a9ce4d769f4ba32", "html_url": "https://github.com/rust-lang/rust/commit/3eb5b62898a8e7f24679aa7a4a9ce4d769f4ba32"}], "stats": {"total": 42, "additions": 6, "deletions": 36}, "files": [{"sha": "0c4649cea14edda97552e175a99e877201d87690", "filename": "compiler/rustc_hir_analysis/src/collect.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a803f313fdf8f6eb2d674d7dfb3694a2b437ee1e/compiler%2Frustc_hir_analysis%2Fsrc%2Fcollect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a803f313fdf8f6eb2d674d7dfb3694a2b437ee1e/compiler%2Frustc_hir_analysis%2Fsrc%2Fcollect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_analysis%2Fsrc%2Fcollect.rs?ref=a803f313fdf8f6eb2d674d7dfb3694a2b437ee1e", "patch": "@@ -489,7 +489,7 @@ impl<'tcx> AstConv<'tcx> for ItemCtxt<'tcx> {\n                         format!(\n                             \"{}::\",\n                             // Erase named lt, we want `<A as B<'_>::C`, not `<A as B<'a>::C`.\n-                            self.tcx.anonymize_late_bound_regions(poly_trait_ref).skip_binder(),\n+                            self.tcx.anonymize_bound_vars(poly_trait_ref).skip_binder(),\n                         ),\n                         Applicability::MaybeIncorrect,\n                     );"}, {"sha": "5bd02dff73bfc1f033318eff0d0568c9e382d9cb", "filename": "compiler/rustc_hir_typeck/src/closure.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a803f313fdf8f6eb2d674d7dfb3694a2b437ee1e/compiler%2Frustc_hir_typeck%2Fsrc%2Fclosure.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a803f313fdf8f6eb2d674d7dfb3694a2b437ee1e/compiler%2Frustc_hir_typeck%2Fsrc%2Fclosure.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Fclosure.rs?ref=a803f313fdf8f6eb2d674d7dfb3694a2b437ee1e", "patch": "@@ -426,7 +426,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         // `deduce_expectations_from_expected_type` introduces\n         // late-bound lifetimes defined elsewhere, which we now\n         // anonymize away, so as not to confuse the user.\n-        let bound_sig = self.tcx.anonymize_late_bound_regions(bound_sig);\n+        let bound_sig = self.tcx.anonymize_bound_vars(bound_sig);\n \n         let closure_sigs = self.closure_sigs(expr_def_id, body, bound_sig);\n "}, {"sha": "09fee0c3f7c30819138b4df81f49295aa0a6d031", "filename": "compiler/rustc_middle/src/ty/fold.rs", "status": "modified", "additions": 0, "deletions": 30, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/a803f313fdf8f6eb2d674d7dfb3694a2b437ee1e/compiler%2Frustc_middle%2Fsrc%2Fty%2Ffold.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a803f313fdf8f6eb2d674d7dfb3694a2b437ee1e/compiler%2Frustc_middle%2Fsrc%2Fty%2Ffold.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Ffold.rs?ref=a803f313fdf8f6eb2d674d7dfb3694a2b437ee1e", "patch": "@@ -583,36 +583,6 @@ impl<'tcx> TyCtxt<'tcx> {\n         self.replace_late_bound_regions(value, |_| self.lifetimes.re_erased).0\n     }\n \n-    /// Rewrite any late-bound regions so that they are anonymous. Region numbers are\n-    /// assigned starting at 0 and increasing monotonically in the order traversed\n-    /// by the fold operation.\n-    ///\n-    /// The chief purpose of this function is to canonicalize regions so that two\n-    /// `FnSig`s or `TraitRef`s which are equivalent up to region naming will become\n-    /// structurally identical. For example, `for<'a, 'b> fn(&'a isize, &'b isize)` and\n-    /// `for<'a, 'b> fn(&'b isize, &'a isize)` will become identical after anonymization.\n-    pub fn anonymize_late_bound_regions<T>(self, sig: Binder<'tcx, T>) -> Binder<'tcx, T>\n-    where\n-        T: TypeFoldable<'tcx>,\n-    {\n-        let mut counter = 0;\n-        let inner = self\n-            .replace_late_bound_regions(sig, |_| {\n-                let br = ty::BoundRegion {\n-                    var: ty::BoundVar::from_u32(counter),\n-                    kind: ty::BrAnon(counter, None),\n-                };\n-                let r = self.mk_region(ty::ReLateBound(ty::INNERMOST, br));\n-                counter += 1;\n-                r\n-            })\n-            .0;\n-        let bound_vars = self.mk_bound_variable_kinds(\n-            (0..counter).map(|i| ty::BoundVariableKind::Region(ty::BrAnon(i, None))),\n-        );\n-        Binder::bind_with_vars(inner, bound_vars)\n-    }\n-\n     /// Anonymize all bound variables in `value`, this is mostly used to improve caching.\n     pub fn anonymize_bound_vars<T>(self, value: Binder<'tcx, T>) -> Binder<'tcx, T>\n     where"}, {"sha": "d47a5ea3e3706fa68ddcda5e27f80186ab6ca550", "filename": "compiler/rustc_trait_selection/src/traits/error_reporting/suggestions.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/a803f313fdf8f6eb2d674d7dfb3694a2b437ee1e/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a803f313fdf8f6eb2d674d7dfb3694a2b437ee1e/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs?ref=a803f313fdf8f6eb2d674d7dfb3694a2b437ee1e", "patch": "@@ -1812,10 +1812,10 @@ impl<'tcx> TypeErrCtxtExt<'tcx> for TypeErrCtxt<'_, 'tcx> {\n             && self.tcx.is_fn_trait(trait_pred.def_id())\n         {\n             let expected_self =\n-                self.tcx.anonymize_late_bound_regions(pred.kind().rebind(trait_pred.self_ty()));\n+                self.tcx.anonymize_bound_vars(pred.kind().rebind(trait_pred.self_ty()));\n             let expected_substs = self\n                 .tcx\n-                .anonymize_late_bound_regions(pred.kind().rebind(trait_pred.trait_ref.substs));\n+                .anonymize_bound_vars(pred.kind().rebind(trait_pred.trait_ref.substs));\n \n             // Find another predicate whose self-type is equal to the expected self type,\n             // but whose substs don't match.\n@@ -1828,12 +1828,12 @@ impl<'tcx> TypeErrCtxtExt<'tcx> for TypeErrCtxt<'_, 'tcx> {\n                             // Make sure that the self type matches\n                             // (i.e. constraining this closure)\n                             && expected_self\n-                                == self.tcx.anonymize_late_bound_regions(\n+                                == self.tcx.anonymize_bound_vars(\n                                     pred.kind().rebind(trait_pred.self_ty()),\n                                 )\n                             // But the substs don't match (i.e. incompatible args)\n                             && expected_substs\n-                                != self.tcx.anonymize_late_bound_regions(\n+                                != self.tcx.anonymize_bound_vars(\n                                     pred.kind().rebind(trait_pred.trait_ref.substs),\n                                 ) =>\n                     {"}]}