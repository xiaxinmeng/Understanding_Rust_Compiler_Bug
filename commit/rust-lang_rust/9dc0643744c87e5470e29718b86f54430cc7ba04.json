{"sha": "9dc0643744c87e5470e29718b86f54430cc7ba04", "node_id": "C_kwDOAAsO6NoAKDlkYzA2NDM3NDRjODdlNTQ3MGUyOTcxOGI4NmY1NDQzMGNjN2JhMDQ", "commit": {"author": {"name": "Xiretza", "email": "xiretza@xiretza.xyz", "date": "2022-08-26T09:09:06Z"}, "committer": {"name": "Xiretza", "email": "xiretza@xiretza.xyz", "date": "2022-08-30T07:48:03Z"}, "message": "SessionSubdiagnostic: make `#[applicability]` optional", "tree": {"sha": "074a997f2af9abf81e78f8a2832ea5afe403ab3a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/074a997f2af9abf81e78f8a2832ea5afe403ab3a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9dc0643744c87e5470e29718b86f54430cc7ba04", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9dc0643744c87e5470e29718b86f54430cc7ba04", "html_url": "https://github.com/rust-lang/rust/commit/9dc0643744c87e5470e29718b86f54430cc7ba04", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9dc0643744c87e5470e29718b86f54430cc7ba04/comments", "author": {"login": "Xiretza", "id": 3107142, "node_id": "MDQ6VXNlcjMxMDcxNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3107142?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Xiretza", "html_url": "https://github.com/Xiretza", "followers_url": "https://api.github.com/users/Xiretza/followers", "following_url": "https://api.github.com/users/Xiretza/following{/other_user}", "gists_url": "https://api.github.com/users/Xiretza/gists{/gist_id}", "starred_url": "https://api.github.com/users/Xiretza/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Xiretza/subscriptions", "organizations_url": "https://api.github.com/users/Xiretza/orgs", "repos_url": "https://api.github.com/users/Xiretza/repos", "events_url": "https://api.github.com/users/Xiretza/events{/privacy}", "received_events_url": "https://api.github.com/users/Xiretza/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Xiretza", "id": 3107142, "node_id": "MDQ6VXNlcjMxMDcxNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3107142?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Xiretza", "html_url": "https://github.com/Xiretza", "followers_url": "https://api.github.com/users/Xiretza/followers", "following_url": "https://api.github.com/users/Xiretza/following{/other_user}", "gists_url": "https://api.github.com/users/Xiretza/gists{/gist_id}", "starred_url": "https://api.github.com/users/Xiretza/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Xiretza/subscriptions", "organizations_url": "https://api.github.com/users/Xiretza/orgs", "repos_url": "https://api.github.com/users/Xiretza/repos", "events_url": "https://api.github.com/users/Xiretza/events{/privacy}", "received_events_url": "https://api.github.com/users/Xiretza/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6e8dad5c073555dcbea9a276f76db47e3d7cc693", "url": "https://api.github.com/repos/rust-lang/rust/commits/6e8dad5c073555dcbea9a276f76db47e3d7cc693", "html_url": "https://github.com/rust-lang/rust/commit/6e8dad5c073555dcbea9a276f76db47e3d7cc693"}], "stats": {"total": 68, "additions": 13, "deletions": 55}, "files": [{"sha": "f66565af4c1d845490ad6e2c9b57548c445e5339", "filename": "compiler/rustc_macros/src/diagnostics/subdiagnostic.rs", "status": "modified", "additions": 4, "deletions": 8, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/9dc0643744c87e5470e29718b86f54430cc7ba04/compiler%2Frustc_macros%2Fsrc%2Fdiagnostics%2Fsubdiagnostic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9dc0643744c87e5470e29718b86f54430cc7ba04/compiler%2Frustc_macros%2Fsrc%2Fdiagnostics%2Fsubdiagnostic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_macros%2Fsrc%2Fdiagnostics%2Fsubdiagnostic.rs?ref=9dc0643744c87e5470e29718b86f54430cc7ba04", "patch": "@@ -469,14 +469,10 @@ impl<'a> SessionSubdiagnosticDeriveBuilder<'a> {\n         };\n \n         let span_field = self.span_field.as_ref().map(|(span, _)| span);\n-        let applicability = match self.applicability.clone() {\n-            Some((applicability, _)) => Some(applicability),\n-            None if is_suggestion => {\n-                span_err(self.span, \"suggestion without `applicability`\").emit();\n-                Some(quote! { rustc_errors::Applicability::Unspecified })\n-            }\n-            None => None,\n-        };\n+        let applicability = self.applicability.take().map_or_else(\n+            || quote! { rustc_errors::Applicability::Unspecified },\n+            |(applicability, _)| applicability,\n+        );\n \n         let diag = &self.diag;\n         let name = format_ident!(\"{}{}\", if span_field.is_some() { \"span_\" } else { \"\" }, kind);"}, {"sha": "2505a5a9975c1fae18189772d379685f1eaa052c", "filename": "src/test/ui-fulldeps/session-diagnostic/subdiagnostic-derive.rs", "status": "modified", "additions": 1, "deletions": 4, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/9dc0643744c87e5470e29718b86f54430cc7ba04/src%2Ftest%2Fui-fulldeps%2Fsession-diagnostic%2Fsubdiagnostic-derive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9dc0643744c87e5470e29718b86f54430cc7ba04/src%2Ftest%2Fui-fulldeps%2Fsession-diagnostic%2Fsubdiagnostic-derive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui-fulldeps%2Fsession-diagnostic%2Fsubdiagnostic-derive.rs?ref=9dc0643744c87e5470e29718b86f54430cc7ba04", "patch": "@@ -401,7 +401,6 @@ struct AK {\n \n #[derive(SessionSubdiagnostic)]\n #[suggestion(parser::add_paren, code = \"...\")]\n-//~^ ERROR suggestion without `applicability`\n struct AL {\n     #[primary_span]\n     span: Span,\n@@ -412,7 +411,6 @@ struct AL {\n \n #[derive(SessionSubdiagnostic)]\n #[suggestion(parser::add_paren, code = \"...\")]\n-//~^ ERROR suggestion without `applicability`\n struct AM {\n     #[primary_span]\n     span: Span,\n@@ -448,8 +446,7 @@ struct AQ;\n \n #[derive(SessionSubdiagnostic)]\n #[suggestion(parser::add_paren, code = \"...\")]\n-//~^ ERROR suggestion without `applicability`\n-//~^^ ERROR suggestion without `#[primary_span]` field\n+//~^ ERROR suggestion without `#[primary_span]` field\n struct AR {\n     var: String,\n }"}, {"sha": "68d33323db035b9bcf57fa03ad0cf4e732124919", "filename": "src/test/ui-fulldeps/session-diagnostic/subdiagnostic-derive.stderr", "status": "modified", "additions": 8, "deletions": 43, "changes": 51, "blob_url": "https://github.com/rust-lang/rust/blob/9dc0643744c87e5470e29718b86f54430cc7ba04/src%2Ftest%2Fui-fulldeps%2Fsession-diagnostic%2Fsubdiagnostic-derive.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/9dc0643744c87e5470e29718b86f54430cc7ba04/src%2Ftest%2Fui-fulldeps%2Fsession-diagnostic%2Fsubdiagnostic-derive.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui-fulldeps%2Fsession-diagnostic%2Fsubdiagnostic-derive.stderr?ref=9dc0643744c87e5470e29718b86f54430cc7ba04", "patch": "@@ -249,36 +249,13 @@ LL |     #[applicability]\n    |     ^^^^^^^^^^^^^^^^\n \n error: the `#[applicability]` attribute can only be applied to fields of type `Applicability`\n-  --> $DIR/subdiagnostic-derive.rs:408:5\n+  --> $DIR/subdiagnostic-derive.rs:407:5\n    |\n LL |     #[applicability]\n    |     ^^^^^^^^^^^^^^^^\n \n-error: suggestion without `applicability`\n-  --> $DIR/subdiagnostic-derive.rs:403:1\n-   |\n-LL | / #[suggestion(parser::add_paren, code = \"...\")]\n-LL | |\n-LL | | struct AL {\n-LL | |     #[primary_span]\n-...  |\n-LL | |     applicability: Span,\n-LL | | }\n-   | |_^\n-\n-error: suggestion without `applicability`\n-  --> $DIR/subdiagnostic-derive.rs:414:1\n-   |\n-LL | / #[suggestion(parser::add_paren, code = \"...\")]\n-LL | |\n-LL | | struct AM {\n-LL | |     #[primary_span]\n-LL | |     span: Span,\n-LL | | }\n-   | |_^\n-\n error: suggestion without `code = \"...\"`\n-  --> $DIR/subdiagnostic-derive.rs:422:1\n+  --> $DIR/subdiagnostic-derive.rs:420:1\n    |\n LL | / #[suggestion(parser::add_paren)]\n LL | |\n@@ -290,47 +267,35 @@ LL | | }\n    | |_^\n \n error: invalid applicability\n-  --> $DIR/subdiagnostic-derive.rs:432:46\n+  --> $DIR/subdiagnostic-derive.rs:430:46\n    |\n LL | #[suggestion(parser::add_paren, code =\"...\", applicability = \"foo\")]\n    |                                              ^^^^^^^^^^^^^^^^^^^^^\n \n-error: suggestion without `applicability`\n-  --> $DIR/subdiagnostic-derive.rs:450:1\n-   |\n-LL | / #[suggestion(parser::add_paren, code = \"...\")]\n-LL | |\n-LL | |\n-LL | | struct AR {\n-LL | |     var: String,\n-LL | | }\n-   | |_^\n-\n error: suggestion without `#[primary_span]` field\n-  --> $DIR/subdiagnostic-derive.rs:450:1\n+  --> $DIR/subdiagnostic-derive.rs:448:1\n    |\n LL | / #[suggestion(parser::add_paren, code = \"...\")]\n LL | |\n-LL | |\n LL | | struct AR {\n LL | |     var: String,\n LL | | }\n    | |_^\n \n error: unsupported type attribute for subdiagnostic enum\n-  --> $DIR/subdiagnostic-derive.rs:465:1\n+  --> $DIR/subdiagnostic-derive.rs:462:1\n    |\n LL | #[label]\n    | ^^^^^^^^\n \n error: `var` doesn't refer to a field on this type\n-  --> $DIR/subdiagnostic-derive.rs:485:39\n+  --> $DIR/subdiagnostic-derive.rs:482:39\n    |\n LL | #[suggestion(parser::add_paren, code =\"{var}\", applicability = \"machine-applicable\")]\n    |                                       ^^^^^^^\n \n error: `var` doesn't refer to a field on this type\n-  --> $DIR/subdiagnostic-derive.rs:504:43\n+  --> $DIR/subdiagnostic-derive.rs:501:43\n    |\n LL |     #[suggestion(parser::add_paren, code =\"{var}\", applicability = \"machine-applicable\")]\n    |                                           ^^^^^^^\n@@ -395,6 +360,6 @@ error[E0425]: cannot find value `slug` in module `rustc_errors::fluent`\n LL | #[label(slug)]\n    |         ^^^^ not found in `rustc_errors::fluent`\n \n-error: aborting due to 52 previous errors\n+error: aborting due to 49 previous errors\n \n For more information about this error, try `rustc --explain E0425`."}]}