{"sha": "6d718f236dfdb086099d6147895416422aae4283", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZkNzE4ZjIzNmRmZGIwODYwOTlkNjE0Nzg5NTQxNjQyMmFhZTQyODM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-05-20T07:38:45Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-05-20T07:38:45Z"}, "message": "Auto merge of #25595 - dotdash:issue25549, r=eddyb\n\nWhen taking the address of an unsized field we generate a rvalue datum\r\nfor the field and then convert it to an lvalue datum. At that point,\r\ncleanup is scheduled for the field, leading to multiple drop calls.\r\n\r\nThe problem is that we generate an rvalue datum for the field, since the\r\npointer does not own the data and there's already cleanup scheduled\r\nelsewhere by the true owner. Instead, an lvalue datum must be created.\r\n\r\nThanks to @eddyb for identifying the underlying cause and suggesting the\r\ncorrect fix.\r\n\r\nFixes #25549.", "tree": {"sha": "0f661b59a81ed0518ca7485b149e33469a73c421", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0f661b59a81ed0518ca7485b149e33469a73c421"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6d718f236dfdb086099d6147895416422aae4283", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6d718f236dfdb086099d6147895416422aae4283", "html_url": "https://github.com/rust-lang/rust/commit/6d718f236dfdb086099d6147895416422aae4283", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6d718f236dfdb086099d6147895416422aae4283/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "720735b9430f7ff61761f54587b82dab45317938", "url": "https://api.github.com/repos/rust-lang/rust/commits/720735b9430f7ff61761f54587b82dab45317938", "html_url": "https://github.com/rust-lang/rust/commit/720735b9430f7ff61761f54587b82dab45317938"}, {"sha": "b802b187303ff3499849c5763d3dcd39f1b6c3cf", "url": "https://api.github.com/repos/rust-lang/rust/commits/b802b187303ff3499849c5763d3dcd39f1b6c3cf", "html_url": "https://github.com/rust-lang/rust/commit/b802b187303ff3499849c5763d3dcd39f1b6c3cf"}], "stats": {"total": 75, "additions": 73, "deletions": 2}, "files": [{"sha": "7536c4e670bb173be69ffb54185ba99bd417d77c", "filename": "src/librustc_trans/trans/expr.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/6d718f236dfdb086099d6147895416422aae4283/src%2Flibrustc_trans%2Ftrans%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6d718f236dfdb086099d6147895416422aae4283/src%2Flibrustc_trans%2Ftrans%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Ftrans%2Fexpr.rs?ref=6d718f236dfdb086099d6147895416422aae4283", "patch": "@@ -730,8 +730,9 @@ fn trans_field<'blk, 'tcx, F>(bcx: Block<'blk, 'tcx>,\n             let info = Load(bcx, get_len(bcx, base_datum.val));\n             Store(bcx, info, get_len(bcx, scratch.val));\n \n-            DatumBlock::new(bcx, scratch.to_expr_datum())\n-\n+            // Always generate an lvalue datum, because this pointer doesn't own\n+            // the data and cleanup is scheduled elsewhere.\n+            DatumBlock::new(bcx, Datum::new(scratch.val, scratch.ty, LvalueExpr))\n         }\n     })\n "}, {"sha": "d1746ec01910253628fd48dafd6de0d5c6227394", "filename": "src/test/run-pass/issue-25515.rs", "status": "added", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/6d718f236dfdb086099d6147895416422aae4283/src%2Ftest%2Frun-pass%2Fissue-25515.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6d718f236dfdb086099d6147895416422aae4283/src%2Ftest%2Frun-pass%2Fissue-25515.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fissue-25515.rs?ref=6d718f236dfdb086099d6147895416422aae4283", "patch": "@@ -0,0 +1,29 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+use std::rc::Rc;\n+\n+struct Foo<'r>(&'r mut i32);\n+\n+impl<'r> Drop for Foo<'r> {\n+    fn drop(&mut self) {\n+        *self.0 += 1;\n+    }\n+}\n+\n+fn main() {\n+    let mut drops = 0;\n+\n+    {\n+        let _: Rc<Send> = Rc::new(Foo(&mut drops));\n+    }\n+\n+    assert_eq!(1, drops);\n+}"}, {"sha": "5280891677e376987a6c3755669418f86e777250", "filename": "src/test/run-pass/issue-25549-multiple-drop.rs", "status": "added", "additions": 41, "deletions": 0, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/6d718f236dfdb086099d6147895416422aae4283/src%2Ftest%2Frun-pass%2Fissue-25549-multiple-drop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6d718f236dfdb086099d6147895416422aae4283/src%2Ftest%2Frun-pass%2Fissue-25549-multiple-drop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fissue-25549-multiple-drop.rs?ref=6d718f236dfdb086099d6147895416422aae4283", "patch": "@@ -0,0 +1,41 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+struct Foo<'r>(&'r mut i32);\n+\n+impl<'r> Drop for Foo<'r> {\n+    fn drop(&mut self) {\n+        *self.0 += 1;\n+    }\n+}\n+\n+trait Trait {}\n+impl<'r> Trait for Foo<'r> {}\n+\n+struct Holder<T: ?Sized>(T);\n+\n+fn main() {\n+    let mut drops = 0;\n+\n+    {\n+        let y = &Holder([Foo(&mut drops)]) as &Holder<[Foo]>;\n+        // this used to cause an extra drop of the Foo instance\n+        let x = &y.0;\n+    }\n+    assert_eq!(1, drops);\n+\n+    drops = 0;\n+    {\n+        let y = &Holder(Foo(&mut drops)) as &Holder<Trait>;\n+        // this used to cause an extra drop of the Foo instance\n+        let x = &y.0;\n+    }\n+    assert_eq!(1, drops);\n+}"}]}