{"sha": "08b1fe39c2f263ed9df49c445f65ce0b118d1a07", "node_id": "MDY6Q29tbWl0NzI0NzEyOjA4YjFmZTM5YzJmMjYzZWQ5ZGY0OWM0NDVmNjVjZTBiMTE4ZDFhMDc=", "commit": {"author": {"name": "Mikhail Modin", "email": "mikhailm1@gmail.com", "date": "2017-10-24T11:48:39Z"}, "committer": {"name": "Your Name", "email": "mikhailm1@gmail.com", "date": "2017-10-26T08:14:08Z"}, "message": "add graphvis DOT files to dump mir directory", "tree": {"sha": "037f48ce71deefe5fc9c75a2d829769a056dfc25", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/037f48ce71deefe5fc9c75a2d829769a056dfc25"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/08b1fe39c2f263ed9df49c445f65ce0b118d1a07", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/08b1fe39c2f263ed9df49c445f65ce0b118d1a07", "html_url": "https://github.com/rust-lang/rust/commit/08b1fe39c2f263ed9df49c445f65ce0b118d1a07", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/08b1fe39c2f263ed9df49c445f65ce0b118d1a07/comments", "author": {"login": "mikhail-m1", "id": 5663581, "node_id": "MDQ6VXNlcjU2NjM1ODE=", "avatar_url": "https://avatars.githubusercontent.com/u/5663581?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mikhail-m1", "html_url": "https://github.com/mikhail-m1", "followers_url": "https://api.github.com/users/mikhail-m1/followers", "following_url": "https://api.github.com/users/mikhail-m1/following{/other_user}", "gists_url": "https://api.github.com/users/mikhail-m1/gists{/gist_id}", "starred_url": "https://api.github.com/users/mikhail-m1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mikhail-m1/subscriptions", "organizations_url": "https://api.github.com/users/mikhail-m1/orgs", "repos_url": "https://api.github.com/users/mikhail-m1/repos", "events_url": "https://api.github.com/users/mikhail-m1/events{/privacy}", "received_events_url": "https://api.github.com/users/mikhail-m1/received_events", "type": "User", "site_admin": false}, "committer": {"login": "mikhail-m1", "id": 5663581, "node_id": "MDQ6VXNlcjU2NjM1ODE=", "avatar_url": "https://avatars.githubusercontent.com/u/5663581?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mikhail-m1", "html_url": "https://github.com/mikhail-m1", "followers_url": "https://api.github.com/users/mikhail-m1/followers", "following_url": "https://api.github.com/users/mikhail-m1/following{/other_user}", "gists_url": "https://api.github.com/users/mikhail-m1/gists{/gist_id}", "starred_url": "https://api.github.com/users/mikhail-m1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mikhail-m1/subscriptions", "organizations_url": "https://api.github.com/users/mikhail-m1/orgs", "repos_url": "https://api.github.com/users/mikhail-m1/repos", "events_url": "https://api.github.com/users/mikhail-m1/events{/privacy}", "received_events_url": "https://api.github.com/users/mikhail-m1/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d5d449421398fe4005f3b3ded551a6274e3d856e", "url": "https://api.github.com/repos/rust-lang/rust/commits/d5d449421398fe4005f3b3ded551a6274e3d856e", "html_url": "https://github.com/rust-lang/rust/commit/d5d449421398fe4005f3b3ded551a6274e3d856e"}], "stats": {"total": 56, "additions": 39, "deletions": 17}, "files": [{"sha": "db439c0787cbe1767f65964d7245b1219f9fcb60", "filename": "src/librustc/session/config.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/08b1fe39c2f263ed9df49c445f65ce0b118d1a07/src%2Flibrustc%2Fsession%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/08b1fe39c2f263ed9df49c445f65ce0b118d1a07/src%2Flibrustc%2Fsession%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fsession%2Fconfig.rs?ref=08b1fe39c2f263ed9df49c445f65ce0b118d1a07", "patch": "@@ -1057,6 +1057,8 @@ options! {DebuggingOptions, DebuggingSetter, basic_debugging_options,\n           \"dump MIR state at various points in translation\"),\n     dump_mir_dir: Option<String> = (None, parse_opt_string, [UNTRACKED],\n           \"the directory the MIR is dumped into\"),\n+    dump_mir_graphviz: bool = (false, parse_bool, [UNTRACKED],\n+          \"additionally to `.mir` files, create graphviz `.dot` files\"),\n     dump_mir_exclude_pass_number: bool = (false, parse_bool, [UNTRACKED],\n           \"if set, exclude the pass number when dumping MIR (used in tests)\"),\n     mir_emit_validate: usize = (0, parse_uint, [TRACKED],\n@@ -2650,6 +2652,8 @@ mod tests {\n         assert_eq!(reference.dep_tracking_hash(), opts.dep_tracking_hash());\n         opts.debugging_opts.dump_mir_dir = Some(String::from(\"abc\"));\n         assert_eq!(reference.dep_tracking_hash(), opts.dep_tracking_hash());\n+        opts.debugging_opts.dump_mir_graphviz = true;\n+        assert_eq!(reference.dep_tracking_hash(), opts.dep_tracking_hash());\n \n         // Make sure changing a [TRACKED] option changes the hash\n         opts = reference.clone();"}, {"sha": "cec8067530b6119563798853f61f566fc1a0c52b", "filename": "src/librustc_mir/util/graphviz.rs", "status": "modified", "additions": 26, "deletions": 17, "changes": 43, "blob_url": "https://github.com/rust-lang/rust/blob/08b1fe39c2f263ed9df49c445f65ce0b118d1a07/src%2Flibrustc_mir%2Futil%2Fgraphviz.rs", "raw_url": "https://github.com/rust-lang/rust/raw/08b1fe39c2f263ed9df49c445f65ce0b118d1a07/src%2Flibrustc_mir%2Futil%2Fgraphviz.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Futil%2Fgraphviz.rs?ref=08b1fe39c2f263ed9df49c445f65ce0b118d1a07", "patch": "@@ -30,29 +30,38 @@ pub fn write_mir_graphviz<'a, 'tcx, W>(tcx: TyCtxt<'a, 'tcx, 'tcx>,\n     for def_id in dump_mir_def_ids(tcx, single) {\n         let nodeid = tcx.hir.as_local_node_id(def_id).unwrap();\n         let mir = &tcx.optimized_mir(def_id);\n+        write_mir_fn_graphviz(tcx, nodeid, mir, w)?;\n+    }\n+    Ok(())\n+}\n \n-        writeln!(w, \"digraph Mir_{} {{\", nodeid)?;\n+/// Write a graphviz DOT graph of the MIR.\n+pub fn write_mir_fn_graphviz<'a, 'tcx, W>(tcx: TyCtxt<'a, 'tcx, 'tcx>,\n+                                        nodeid: NodeId,\n+                                        mir: &Mir,\n+                                        w: &mut W) -> io::Result<()>\n+    where W: Write\n+{\n+    writeln!(w, \"digraph Mir_{} {{\", nodeid)?;\n \n-        // Global graph properties\n-        writeln!(w, r#\"    graph [fontname=\"monospace\"];\"#)?;\n-        writeln!(w, r#\"    node [fontname=\"monospace\"];\"#)?;\n-        writeln!(w, r#\"    edge [fontname=\"monospace\"];\"#)?;\n+    // Global graph properties\n+    writeln!(w, r#\"    graph [fontname=\"monospace\"];\"#)?;\n+    writeln!(w, r#\"    node [fontname=\"monospace\"];\"#)?;\n+    writeln!(w, r#\"    edge [fontname=\"monospace\"];\"#)?;\n \n-        // Graph label\n-        write_graph_label(tcx, nodeid, mir, w)?;\n+    // Graph label\n+    write_graph_label(tcx, nodeid, mir, w)?;\n \n-        // Nodes\n-        for (block, _) in mir.basic_blocks().iter_enumerated() {\n-            write_node(block, mir, w)?;\n-        }\n+    // Nodes\n+    for (block, _) in mir.basic_blocks().iter_enumerated() {\n+        write_node(block, mir, w)?;\n+    }\n \n-        // Edges\n-        for (source, _) in mir.basic_blocks().iter_enumerated() {\n-            write_edges(source, mir, w)?;\n-        }\n-        writeln!(w, \"}}\")?\n+    // Edges\n+    for (source, _) in mir.basic_blocks().iter_enumerated() {\n+        write_edges(source, mir, w)?;\n     }\n-    Ok(())\n+    writeln!(w, \"}}\")\n }\n \n /// Write a graphviz HTML-styled label for the given basic block, with"}, {"sha": "61914a6fc36d433e556c6dcd15ba28a1e14031e9", "filename": "src/librustc_mir/util/pretty.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/08b1fe39c2f263ed9df49c445f65ce0b118d1a07/src%2Flibrustc_mir%2Futil%2Fpretty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/08b1fe39c2f263ed9df49c445f65ce0b118d1a07/src%2Flibrustc_mir%2Futil%2Fpretty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Futil%2Fpretty.rs?ref=08b1fe39c2f263ed9df49c445f65ce0b118d1a07", "patch": "@@ -20,6 +20,7 @@ use std::fmt::Display;\n use std::fs;\n use std::io::{self, Write};\n use std::path::{PathBuf, Path};\n+use super::graphviz::write_mir_fn_graphviz;\n \n const INDENT: &'static str = \"    \";\n /// Alignment for lining up comments following MIR statements\n@@ -128,6 +129,14 @@ fn dump_matched_mir_node<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>,\n         write_mir_fn(tcx, source, mir, &mut file)?;\n         Ok(())\n     });\n+\n+    if tcx.sess.opts.debugging_opts.dump_mir_graphviz {\n+        file_path.set_extension(\"dot\");\n+        let _ = fs::File::create(&file_path).and_then(|mut file| {\n+            write_mir_fn_graphviz(tcx, source.item_id(), mir, &mut file)?;\n+            Ok(())\n+        });\n+    }\n }\n \n /// Write out a human-readable textual representation for the given MIR."}]}