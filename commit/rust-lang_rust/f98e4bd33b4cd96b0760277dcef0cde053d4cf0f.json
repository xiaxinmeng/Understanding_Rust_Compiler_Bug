{"sha": "f98e4bd33b4cd96b0760277dcef0cde053d4cf0f", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY5OGU0YmQzM2I0Y2Q5NmIwNzYwMjc3ZGNlZjBjZGUwNTNkNGNmMGY=", "commit": {"author": {"name": "Oliver Scherer", "email": "github35764891676564198441@oli-obk.de", "date": "2019-05-19T14:52:44Z"}, "committer": {"name": "flip1995", "email": "hello@philkrones.com", "date": "2019-05-28T11:01:11Z"}, "message": "Fix `Block`  dump in author lint", "tree": {"sha": "dba966fd9639fc5fa1047bdd54ecd197dd667e43", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/dba966fd9639fc5fa1047bdd54ecd197dd667e43"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f98e4bd33b4cd96b0760277dcef0cde053d4cf0f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEdgbJzPSa+gJi9jP1Acg2tkD/37EFAlztFPcACgkQAcg2tkD/\n37FaPBAAn68+YmQToGrwtg0awtf39pxZn6l1wCQxK4jTqjeqQvYOS37EQNSEgq5/\n6uThDc1WjK4pzuatWbKJyWfAe29dAPkcwADYFRSviYrXo2eoisdgR2aa5VYIerrG\nuTr27xKrETBHYntfmsUdim80hCvHcdg4aVOzWnQLmZGYanjBfnHMleG8w1FE813Z\n4WRbYSaik1H8saMG4mXHhwCSIszm70lKq8c/QC5T7ZD9hPSqWOrqxCmnnzJnI9Yw\nMXuxEHIXgLwWgkMwtbtkibIXWS58atsCPzyJelWSl1vCFOv5ZjOBy2IazoMa7evZ\nrtFH6IMDHmWBrBmPAkzus/ADMJS022vAXDfpWS5NgjCieBKSAPXLdXBwWfFxlF1+\nT/QYHBNbwM6PsSRCEiCxevIHLDB38FlbKaToRkqWpOeh5vHz5Hs3QX1SaARbRvky\nBnJV93lXPTHop1QzQKreIXi8GRnVnfDOXJTfVlQy9QcGtVUqrvyMU2roa4VQcKiY\nsbRn/uP3SOvjsGlyCV16nRnMt5U+MqANb94qxgqqt1CE28tqchzSFxyrkEuEZrHp\nbjEEb+0N6vuDzgC91Lm1KHd0Hzlg22daGdQ+6MgSCZ7roF+cO5xKMHcOxCAllM2C\nKydbx2gJ/+h9Os8VU3wZMD3RjjoLbbnWzUhtdI4OawofOjlEooU=\n=R/So\n-----END PGP SIGNATURE-----", "payload": "tree dba966fd9639fc5fa1047bdd54ecd197dd667e43\nparent fb33fad08e8f08c032b443bab0df299ce22fe61b\nauthor Oliver Scherer <github35764891676564198441@oli-obk.de> 1558277564 +0200\ncommitter flip1995 <hello@philkrones.com> 1559041271 +0200\n\nFix `Block`  dump in author lint\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f98e4bd33b4cd96b0760277dcef0cde053d4cf0f", "html_url": "https://github.com/rust-lang/rust/commit/f98e4bd33b4cd96b0760277dcef0cde053d4cf0f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f98e4bd33b4cd96b0760277dcef0cde053d4cf0f/comments", "author": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "committer": {"login": "flip1995", "id": 9744647, "node_id": "MDQ6VXNlcjk3NDQ2NDc=", "avatar_url": "https://avatars.githubusercontent.com/u/9744647?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flip1995", "html_url": "https://github.com/flip1995", "followers_url": "https://api.github.com/users/flip1995/followers", "following_url": "https://api.github.com/users/flip1995/following{/other_user}", "gists_url": "https://api.github.com/users/flip1995/gists{/gist_id}", "starred_url": "https://api.github.com/users/flip1995/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flip1995/subscriptions", "organizations_url": "https://api.github.com/users/flip1995/orgs", "repos_url": "https://api.github.com/users/flip1995/repos", "events_url": "https://api.github.com/users/flip1995/events{/privacy}", "received_events_url": "https://api.github.com/users/flip1995/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fb33fad08e8f08c032b443bab0df299ce22fe61b", "url": "https://api.github.com/repos/rust-lang/rust/commits/fb33fad08e8f08c032b443bab0df299ce22fe61b", "html_url": "https://github.com/rust-lang/rust/commit/fb33fad08e8f08c032b443bab0df299ce22fe61b"}], "stats": {"total": 72, "additions": 64, "deletions": 8}, "files": [{"sha": "d66e2b5f86400d996b220c9c311df80f30e29d90", "filename": "clippy_lints/src/utils/author.rs", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/f98e4bd33b4cd96b0760277dcef0cde053d4cf0f/clippy_lints%2Fsrc%2Futils%2Fauthor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f98e4bd33b4cd96b0760277dcef0cde053d4cf0f/clippy_lints%2Fsrc%2Futils%2Fauthor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Futils%2Fauthor.rs?ref=f98e4bd33b4cd96b0760277dcef0cde053d4cf0f", "patch": "@@ -4,7 +4,7 @@\n use crate::utils::{get_attr, higher};\n use rustc::hir;\n use rustc::hir::intravisit::{NestedVisitorMap, Visitor};\n-use rustc::hir::{BindingAnnotation, Expr, ExprKind, Pat, PatKind, QPath, Stmt, StmtKind, TyKind};\n+use rustc::hir::{BindingAnnotation, Block, Expr, ExprKind, Pat, PatKind, QPath, Stmt, StmtKind, TyKind};\n use rustc::lint::{LateContext, LateLintPass, LintArray, LintContext, LintPass};\n use rustc::session::Session;\n use rustc::{declare_lint_pass, declare_tool_lint};\n@@ -511,6 +511,17 @@ impl<'tcx> Visitor<'tcx> for PrintVisitor {\n         }\n     }\n \n+    fn visit_block(&mut self, block: &Block) {\n+        let trailing_pat = self.next(\"trailing_expr\");\n+        println!(\"    if let Some({}) = &{}.expr;\", trailing_pat, self.current);\n+        println!(\"    if {}.stmts.len() == {};\", self.current, block.stmts.len());\n+        let current = self.current.clone();\n+        for (i, stmt) in block.stmts.iter().enumerate() {\n+            self.current = format!(\"{}.stmts[{}]\", current, i);\n+            self.visit_stmt(stmt);\n+        }\n+    }\n+\n     #[allow(clippy::too_many_lines)]\n     fn visit_pat(&mut self, pat: &Pat) {\n         print!(\"    if let PatKind::\");"}, {"sha": "912e6785706a9cd4f8b3593ef6532d7ef8932864", "filename": "tests/ui/author/blocks.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/f98e4bd33b4cd96b0760277dcef0cde053d4cf0f/tests%2Fui%2Fauthor%2Fblocks.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f98e4bd33b4cd96b0760277dcef0cde053d4cf0f/tests%2Fui%2Fauthor%2Fblocks.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fauthor%2Fblocks.rs?ref=f98e4bd33b4cd96b0760277dcef0cde053d4cf0f", "patch": "@@ -0,0 +1,14 @@\n+#![feature(stmt_expr_attributes)]\n+\n+fn main() {\n+    #[clippy::author]\n+    {\n+        ;;;;\n+    }\n+}\n+\n+#[clippy::author]\n+fn foo() {\n+    let x = 42i32;\n+    -x;\n+}"}, {"sha": "426c52b653076630d21f5f729178942149401b9f", "filename": "tests/ui/author/blocks.stderr", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/f98e4bd33b4cd96b0760277dcef0cde053d4cf0f/tests%2Fui%2Fauthor%2Fblocks.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/f98e4bd33b4cd96b0760277dcef0cde053d4cf0f/tests%2Fui%2Fauthor%2Fblocks.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fauthor%2Fblocks.stderr?ref=f98e4bd33b4cd96b0760277dcef0cde053d4cf0f", "patch": "@@ -0,0 +1,10 @@\n+error: statement with no effect\n+  --> $DIR/blocks.rs:13:5\n+   |\n+LL |     -x;\n+   |     ^^^\n+   |\n+   = note: `-D clippy::no-effect` implied by `-D warnings`\n+\n+error: aborting due to previous error\n+"}, {"sha": "0128b3b02898be74f869a73ce9b4196fdad97709", "filename": "tests/ui/author/blocks.stdout", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/f98e4bd33b4cd96b0760277dcef0cde053d4cf0f/tests%2Fui%2Fauthor%2Fblocks.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/f98e4bd33b4cd96b0760277dcef0cde053d4cf0f/tests%2Fui%2Fauthor%2Fblocks.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fauthor%2Fblocks.stdout?ref=f98e4bd33b4cd96b0760277dcef0cde053d4cf0f", "patch": "@@ -0,0 +1,13 @@\n+if_chain! {\n+    if let ExprKind::Block(ref block) = expr.node;\n+    if let Some(trailing_expr) = &block.expr;\n+    if block.stmts.len() == 0;\n+    then {\n+        // report your lint here\n+    }\n+}\n+if_chain! {\n+    then {\n+        // report your lint here\n+    }\n+}"}, {"sha": "7ce04e44b03deb929fd6bd3cfca4be00a9d0e258", "filename": "tests/ui/author/for_loop.stdout", "status": "modified", "additions": 9, "deletions": 5, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/f98e4bd33b4cd96b0760277dcef0cde053d4cf0f/tests%2Fui%2Fauthor%2Ffor_loop.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/f98e4bd33b4cd96b0760277dcef0cde053d4cf0f/tests%2Fui%2Fauthor%2Ffor_loop.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fauthor%2Ffor_loop.stdout?ref=f98e4bd33b4cd96b0760277dcef0cde053d4cf0f", "patch": "@@ -11,10 +11,12 @@ if_chain! {\n     // unimplemented: field checks\n     if arms.len() == 1;\n     if let ExprKind::Loop(ref body, ref label, LoopSource::ForLoop) = arms[0].body.node;\n-    if let StmtKind::Local(ref local) = body.node;\n+    if let Some(trailing_expr) = &body.expr;\n+    if body.stmts.len() == 4;\n+    if let StmtKind::Local(ref local) = body.stmts[0].node;\n     if let PatKind::Binding(BindingAnnotation::Mutable, _, name, None) = local.pat.node;\n     if name.node.as_str() == \"__next\";\n-    if let StmtKind::Expr(ref e, _) = local.pat.node\n+    if let StmtKind::Expr(ref e, _) = body.stmts[1].node\n     if let ExprKind::Match(ref expr2, ref arms1, MatchSource::ForLoopDesugar) = e.node;\n     if let ExprKind::Call(ref func1, ref args1) = expr2.node;\n     if let ExprKind::Path(ref path2) = func1.node;\n@@ -38,15 +40,17 @@ if_chain! {\n     if arms1[1].pats.len() == 1;\n     if let PatKind::Path(ref path7) = arms1[1].pats[0].node;\n     if match_qpath(path7, &[\"{{root}}\", \"std\", \"option\", \"Option\", \"None\"]);\n-    if let StmtKind::Local(ref local1) = path7.node;\n+    if let StmtKind::Local(ref local1) = body.stmts[2].node;\n     if let Some(ref init) = local1.init;\n     if let ExprKind::Path(ref path8) = init.node;\n     if match_qpath(path8, &[\"__next\"]);\n     if let PatKind::Binding(BindingAnnotation::Unannotated, _, name1, None) = local1.pat.node;\n     if name1.node.as_str() == \"y\";\n-    if let StmtKind::Expr(ref e1, _) = local1.pat.node\n+    if let StmtKind::Expr(ref e1, _) = body.stmts[3].node\n     if let ExprKind::Block(ref block) = e1.node;\n-    if let StmtKind::Local(ref local2) = block.node;\n+    if let Some(trailing_expr1) = &block.expr;\n+    if block.stmts.len() == 1;\n+    if let StmtKind::Local(ref local2) = block.stmts[0].node;\n     if let Some(ref init1) = local2.init;\n     if let ExprKind::Path(ref path9) = init1.node;\n     if match_qpath(path9, &[\"y\"]);"}, {"sha": "be8260007b2171036bb80a0489a3cff26227f325", "filename": "tests/ui/author/if.stdout", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/f98e4bd33b4cd96b0760277dcef0cde053d4cf0f/tests%2Fui%2Fauthor%2Fif.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/f98e4bd33b4cd96b0760277dcef0cde053d4cf0f/tests%2Fui%2Fauthor%2Fif.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fauthor%2Fif.stdout?ref=f98e4bd33b4cd96b0760277dcef0cde053d4cf0f", "patch": "@@ -3,7 +3,9 @@ if_chain! {\n     if let Some(ref init) = local.init;\n     if let Some((ref cond, ref then, Some(else_))) = higher::if_block(&init);\n     if let ExprKind::Block(ref block) = else_.node;\n-    if let StmtKind::Semi(ref e, _) = block.node\n+    if let Some(trailing_expr) = &block.expr;\n+    if block.stmts.len() == 1;\n+    if let StmtKind::Semi(ref e, _) = block.stmts[0].node\n     if let ExprKind::Binary(ref op, ref left, ref right) = e.node;\n     if BinOpKind::Eq == op.node;\n     if let ExprKind::Lit(ref lit) = left.node;\n@@ -13,7 +15,9 @@ if_chain! {\n     if let ExprKind::Lit(ref lit2) = cond.node;\n     if let LitKind::Bool(true) = lit2.node;\n     if let ExprKind::Block(ref block1) = then.node;\n-    if let StmtKind::Semi(ref e1, _) = block1.node\n+    if let Some(trailing_expr1) = &block1.expr;\n+    if block1.stmts.len() == 1;\n+    if let StmtKind::Semi(ref e1, _) = block1.stmts[0].node\n     if let ExprKind::Binary(ref op1, ref left1, ref right1) = e1.node;\n     if BinOpKind::Eq == op1.node;\n     if let ExprKind::Lit(ref lit3) = left1.node;"}]}