{"sha": "0448b7364666ba59b39bbd5564fe8a34b67b8f01", "node_id": "MDY6Q29tbWl0NzI0NzEyOjA0NDhiNzM2NDY2NmJhNTliMzliYmQ1NTY0ZmU4YTM0YjY3YjhmMDE=", "commit": {"author": {"name": "wxb1ank", "email": "wxblank@gmail.com", "date": "2021-05-24T02:37:10Z"}, "committer": {"name": "wxb1ank", "email": "wxblank@gmail.com", "date": "2021-06-02T16:11:32Z"}, "message": "migrate from `fs` to `vscode.FileSystem` API", "tree": {"sha": "483dcccf2033eaba79bef5865b0d929da073413c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/483dcccf2033eaba79bef5865b0d929da073413c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0448b7364666ba59b39bbd5564fe8a34b67b8f01", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0448b7364666ba59b39bbd5564fe8a34b67b8f01", "html_url": "https://github.com/rust-lang/rust/commit/0448b7364666ba59b39bbd5564fe8a34b67b8f01", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0448b7364666ba59b39bbd5564fe8a34b67b8f01/comments", "author": {"login": "wxb1ank", "id": 44535681, "node_id": "MDQ6VXNlcjQ0NTM1Njgx", "avatar_url": "https://avatars.githubusercontent.com/u/44535681?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wxb1ank", "html_url": "https://github.com/wxb1ank", "followers_url": "https://api.github.com/users/wxb1ank/followers", "following_url": "https://api.github.com/users/wxb1ank/following{/other_user}", "gists_url": "https://api.github.com/users/wxb1ank/gists{/gist_id}", "starred_url": "https://api.github.com/users/wxb1ank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wxb1ank/subscriptions", "organizations_url": "https://api.github.com/users/wxb1ank/orgs", "repos_url": "https://api.github.com/users/wxb1ank/repos", "events_url": "https://api.github.com/users/wxb1ank/events{/privacy}", "received_events_url": "https://api.github.com/users/wxb1ank/received_events", "type": "User", "site_admin": false}, "committer": {"login": "wxb1ank", "id": 44535681, "node_id": "MDQ6VXNlcjQ0NTM1Njgx", "avatar_url": "https://avatars.githubusercontent.com/u/44535681?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wxb1ank", "html_url": "https://github.com/wxb1ank", "followers_url": "https://api.github.com/users/wxb1ank/followers", "following_url": "https://api.github.com/users/wxb1ank/following{/other_user}", "gists_url": "https://api.github.com/users/wxb1ank/gists{/gist_id}", "starred_url": "https://api.github.com/users/wxb1ank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wxb1ank/subscriptions", "organizations_url": "https://api.github.com/users/wxb1ank/orgs", "repos_url": "https://api.github.com/users/wxb1ank/repos", "events_url": "https://api.github.com/users/wxb1ank/events{/privacy}", "received_events_url": "https://api.github.com/users/wxb1ank/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3ca7f61a8d736d8e56f0d413b109e6e6562c0a30", "url": "https://api.github.com/repos/rust-lang/rust/commits/3ca7f61a8d736d8e56f0d413b109e6e6562c0a30", "html_url": "https://github.com/rust-lang/rust/commit/3ca7f61a8d736d8e56f0d413b109e6e6562c0a30"}], "stats": {"total": 79, "additions": 35, "deletions": 44}, "files": [{"sha": "f58d2621523262119e67ab38121489923fdd3c12", "filename": "editors/code/src/main.ts", "status": "modified", "additions": 14, "deletions": 16, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/0448b7364666ba59b39bbd5564fe8a34b67b8f01/editors%2Fcode%2Fsrc%2Fmain.ts", "raw_url": "https://github.com/rust-lang/rust/raw/0448b7364666ba59b39bbd5564fe8a34b67b8f01/editors%2Fcode%2Fsrc%2Fmain.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fmain.ts?ref=0448b7364666ba59b39bbd5564fe8a34b67b8f01", "patch": "@@ -1,7 +1,5 @@\n import * as vscode from 'vscode';\n-import * as path from \"path\";\n import * as os from \"os\";\n-import { promises as fs, PathLike } from \"fs\";\n \n import * as commands from './commands';\n import { activateInlayHints } from './inlay_hints';\n@@ -222,7 +220,7 @@ async function bootstrapExtension(config: Config, state: PersistentState): Promi\n     const artifact = latestNightlyRelease.assets.find(artifact => artifact.name === \"rust-analyzer.vsix\");\n     assert(!!artifact, `Bad release: ${JSON.stringify(latestNightlyRelease)}`);\n \n-    const dest = path.join(config.globalStorageUri.path, \"rust-analyzer.vsix\");\n+    const dest = vscode.Uri.joinPath(config.globalStorageUri, \"rust-analyzer.vsix\");\n \n     await downloadWithRetryDialog(state, async () => {\n         await download({\n@@ -233,8 +231,8 @@ async function bootstrapExtension(config: Config, state: PersistentState): Promi\n         });\n     });\n \n-    await vscode.commands.executeCommand(\"workbench.extensions.installExtension\", vscode.Uri.file(dest));\n-    await fs.unlink(dest);\n+    await vscode.commands.executeCommand(\"workbench.extensions.installExtension\", dest);\n+    await vscode.workspace.fs.delete(dest);\n \n     await state.updateNightlyReleaseId(latestNightlyRelease.id);\n     await state.updateLastCheck(now);\n@@ -259,7 +257,7 @@ async function bootstrapServer(config: Config, state: PersistentState): Promise<\n     return path;\n }\n \n-async function patchelf(dest: PathLike): Promise<void> {\n+async function patchelf(dest: vscode.Uri): Promise<void> {\n     await vscode.window.withProgress(\n         {\n             location: vscode.ProgressLocation.Notification,\n@@ -279,11 +277,11 @@ async function patchelf(dest: PathLike): Promise<void> {\n                     '';\n                 }\n             `;\n-            const origFile = dest + \"-orig\";\n-            await fs.rename(dest, origFile);\n+            const origFile = vscode.Uri.file(dest.path + \"-orig\");\n+            await vscode.workspace.fs.rename(dest, origFile);\n             progress.report({ message: \"Patching executable\", increment: 20 });\n             await new Promise((resolve, reject) => {\n-                const handle = exec(`nix-build -E - --argstr srcStr '${origFile}' -o '${dest}'`,\n+                const handle = exec(`nix-build -E - --argstr srcStr '${origFile.path}' -o '${dest.path}'`,\n                     (err, stdout, stderr) => {\n                         if (err != null) {\n                             reject(Error(stderr));\n@@ -294,7 +292,7 @@ async function patchelf(dest: PathLike): Promise<void> {\n                 handle.stdin?.write(expression);\n                 handle.stdin?.end();\n             });\n-            await fs.unlink(origFile);\n+            await vscode.workspace.fs.delete(origFile);\n         }\n     );\n }\n@@ -334,20 +332,20 @@ async function getServer(config: Config, state: PersistentState): Promise<string\n         platform = \"x86_64-unknown-linux-musl\";\n     }\n     const ext = platform.indexOf(\"-windows-\") !== -1 ? \".exe\" : \"\";\n-    const dest = path.join(config.globalStorageUri.path, `rust-analyzer-${platform}${ext}`);\n-    const exists = await fs.stat(dest).then(() => true, () => false);\n+    const dest = vscode.Uri.joinPath(config.globalStorageUri, `rust-analyzer-${platform}${ext}`);\n+    const exists = await vscode.workspace.fs.stat(dest).then(() => true, () => false);\n     if (!exists) {\n         await state.updateServerVersion(undefined);\n     }\n \n-    if (state.serverVersion === config.package.version) return dest;\n+    if (state.serverVersion === config.package.version) return dest.path;\n \n     if (config.askBeforeDownload) {\n         const userResponse = await vscode.window.showInformationMessage(\n             `Language server version ${config.package.version} for rust-analyzer is not installed.`,\n             \"Download now\"\n         );\n-        if (userResponse !== \"Download now\") return dest;\n+        if (userResponse !== \"Download now\") return dest.path;\n     }\n \n     const releaseTag = config.package.releaseTag;\n@@ -374,7 +372,7 @@ async function getServer(config: Config, state: PersistentState): Promise<string\n     }\n \n     await state.updateServerVersion(config.package.version);\n-    return dest;\n+    return dest.path;\n }\n \n function serverPath(config: Config): string | null {\n@@ -383,7 +381,7 @@ function serverPath(config: Config): string | null {\n \n async function isNixOs(): Promise<boolean> {\n     try {\n-        const contents = await fs.readFile(\"/etc/os-release\");\n+        const contents = (await vscode.workspace.fs.readFile(vscode.Uri.file(\"/etc/os-release\"))).toString();\n         return contents.indexOf(\"ID=nixos\") !== -1;\n     } catch (e) {\n         return false;"}, {"sha": "747c02db91abd5fbac9f2356452817fd5465f3bf", "filename": "editors/code/src/net.ts", "status": "modified", "additions": 15, "deletions": 15, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/0448b7364666ba59b39bbd5564fe8a34b67b8f01/editors%2Fcode%2Fsrc%2Fnet.ts", "raw_url": "https://github.com/rust-lang/rust/raw/0448b7364666ba59b39bbd5564fe8a34b67b8f01/editors%2Fcode%2Fsrc%2Fnet.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fnet.ts?ref=0448b7364666ba59b39bbd5564fe8a34b67b8f01", "patch": "@@ -73,14 +73,14 @@ export interface GithubRelease {\n     assets: Array<{\n         name: string;\n         // eslint-disable-next-line camelcase\n-        browser_download_url: string;\n+        browser_download_url: vscode.Uri;\n     }>;\n }\n \n interface DownloadOpts {\n     progressTitle: string;\n-    url: string;\n-    dest: string;\n+    url: vscode.Uri;\n+    dest: vscode.Uri;\n     mode?: number;\n     gunzip?: boolean;\n     httpProxy?: string;\n@@ -90,9 +90,9 @@ export async function download(opts: DownloadOpts) {\n     // Put artifact into a temporary file (in the same dir for simplicity)\n     // to prevent partially downloaded files when user kills vscode\n     // This also avoids overwriting running executables\n-    const dest = path.parse(opts.dest);\n     const randomHex = crypto.randomBytes(5).toString(\"hex\");\n-    const tempFile = path.join(dest.dir, `${dest.name}${randomHex}`);\n+    const rawDest = path.parse(opts.dest.path);\n+    const tempFilePath = vscode.Uri.joinPath(vscode.Uri.file(rawDest.dir), `${rawDest.name}${randomHex}`);\n \n     await vscode.window.withProgress(\n         {\n@@ -102,7 +102,7 @@ export async function download(opts: DownloadOpts) {\n         },\n         async (progress, _cancellationToken) => {\n             let lastPercentage = 0;\n-            await downloadFile(opts.url, tempFile, opts.mode, !!opts.gunzip, opts.httpProxy, (readBytes, totalBytes) => {\n+            await downloadFile(opts.url, tempFilePath, opts.mode, !!opts.gunzip, opts.httpProxy, (readBytes, totalBytes) => {\n                 const newPercentage = Math.round((readBytes / totalBytes) * 100);\n                 if (newPercentage !== lastPercentage) {\n                     progress.report({\n@@ -116,28 +116,28 @@ export async function download(opts: DownloadOpts) {\n         }\n     );\n \n-    await fs.promises.rename(tempFile, opts.dest);\n+    await vscode.workspace.fs.rename(tempFilePath, opts.dest);\n }\n \n async function downloadFile(\n-    url: string,\n-    destFilePath: fs.PathLike,\n+    url: vscode.Uri,\n+    destFilePath: vscode.Uri,\n     mode: number | undefined,\n     gunzip: boolean,\n     httpProxy: string | null | undefined,\n     onProgress: (readBytes: number, totalBytes: number) => void\n ): Promise<void> {\n     const res = await (() => {\n         if (httpProxy) {\n-            log.debug(`Downloading ${url} via proxy: ${httpProxy}`);\n-            return fetch(url, { agent: new HttpsProxyAgent(httpProxy) });\n+            log.debug(`Downloading ${url.path} via proxy: ${httpProxy}`);\n+            return fetch(url.path, { agent: new HttpsProxyAgent(httpProxy) });\n         }\n \n-        return fetch(url);\n+        return fetch(url.path);\n     })();\n \n     if (!res.ok) {\n-        log.error(\"Error\", res.status, \"while downloading file from\", url);\n+        log.error(\"Error\", res.status, \"while downloading file from\", url.path);\n         log.error({ body: await res.text(), headers: res.headers });\n \n         throw new Error(`Got response ${res.status} when trying to download a file.`);\n@@ -146,15 +146,15 @@ async function downloadFile(\n     const totalBytes = Number(res.headers.get('content-length'));\n     assert(!Number.isNaN(totalBytes), \"Sanity check of content-length protocol\");\n \n-    log.debug(\"Downloading file of\", totalBytes, \"bytes size from\", url, \"to\", destFilePath);\n+    log.debug(\"Downloading file of\", totalBytes, \"bytes size from\", url.path, \"to\", destFilePath.path);\n \n     let readBytes = 0;\n     res.body.on(\"data\", (chunk: Buffer) => {\n         readBytes += chunk.length;\n         onProgress(readBytes, totalBytes);\n     });\n \n-    const destFileStream = fs.createWriteStream(destFilePath, { mode });\n+    const destFileStream = fs.createWriteStream(destFilePath.path, { mode });\n     const srcStream = gunzip ? res.body.pipe(zlib.createGunzip()) : res.body;\n \n     await pipeline(srcStream, destFileStream);"}, {"sha": "ba1b8617ae116ce05722b7bfd776fb8d3810bcad", "filename": "editors/code/src/toolchain.ts", "status": "modified", "additions": 6, "deletions": 13, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/0448b7364666ba59b39bbd5564fe8a34b67b8f01/editors%2Fcode%2Fsrc%2Ftoolchain.ts", "raw_url": "https://github.com/rust-lang/rust/raw/0448b7364666ba59b39bbd5564fe8a34b67b8f01/editors%2Fcode%2Fsrc%2Ftoolchain.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Ftoolchain.ts?ref=0448b7364666ba59b39bbd5564fe8a34b67b8f01", "patch": "@@ -1,9 +1,8 @@\n import * as cp from 'child_process';\n import * as os from 'os';\n import * as path from 'path';\n-import * as fs from 'fs';\n import * as readline from 'readline';\n-import { OutputChannel } from 'vscode';\n+import * as vscode from 'vscode';\n import { execute, log, memoize } from './util';\n \n interface CompilationArtifact {\n@@ -19,7 +18,7 @@ export interface ArtifactSpec {\n }\n \n export class Cargo {\n-    constructor(readonly rootFolder: string, readonly output: OutputChannel) { }\n+    constructor(readonly rootFolder: string, readonly output: vscode.OutputChannel) { }\n \n     // Made public for testing purposes\n     static artifactSpec(args: readonly string[]): ArtifactSpec {\n@@ -158,9 +157,9 @@ export const getPathForExecutable = memoize(\n         try {\n             // hmm, `os.homedir()` seems to be infallible\n             // it is not mentioned in docs and cannot be infered by the type signature...\n-            const standardPath = path.join(os.homedir(), \".cargo\", \"bin\", executableName);\n+            const standardPath = vscode.Uri.joinPath(vscode.Uri.file(os.homedir()), \".cargo\", \"bin\", executableName);\n \n-            if (isFile(standardPath)) return standardPath;\n+            if (isFile(standardPath.path)) return standardPath.path;\n         } catch (err) {\n             log.error(\"Failed to read the fs info\", err);\n         }\n@@ -181,12 +180,6 @@ function lookupInPath(exec: string): boolean {\n     return candidates.some(isFile);\n }\n \n-function isFile(suspectPath: string): boolean {\n-    // It is not mentionned in docs, but `statSync()` throws an error when\n-    // the path doesn't exist\n-    try {\n-        return fs.statSync(suspectPath).isFile();\n-    } catch {\n-        return false;\n-    }\n+async function isFile(path: string): Promise<boolean> {\n+    return ((await vscode.workspace.fs.stat(vscode.Uri.file(path))).type & vscode.FileType.File) != 0;\n }"}]}