{"sha": "e18a8efb8b8b87eb2576a12176c45dd59e5c5d18", "node_id": "C_kwDOAAsO6NoAKGUxOGE4ZWZiOGI4Yjg3ZWIyNTc2YTEyMTc2YzQ1ZGQ1OWU1YzVkMTg", "commit": {"author": {"name": "Hirochika Matsumoto", "email": "git@hkmatsumoto.com", "date": "2021-08-28T13:01:56Z"}, "committer": {"name": "Hirochika Matsumoto", "email": "git@hkmatsumoto.com", "date": "2021-09-29T14:57:01Z"}, "message": "Don't ignore impls for primitive types", "tree": {"sha": "e3ce1e3d43fab5a8a27550ff0ae07b7d2b13cc6a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e3ce1e3d43fab5a8a27550ff0ae07b7d2b13cc6a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e18a8efb8b8b87eb2576a12176c45dd59e5c5d18", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e18a8efb8b8b87eb2576a12176c45dd59e5c5d18", "html_url": "https://github.com/rust-lang/rust/commit/e18a8efb8b8b87eb2576a12176c45dd59e5c5d18", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e18a8efb8b8b87eb2576a12176c45dd59e5c5d18/comments", "author": {"login": "hkmatsumoto", "id": 57856193, "node_id": "MDQ6VXNlcjU3ODU2MTkz", "avatar_url": "https://avatars.githubusercontent.com/u/57856193?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hkmatsumoto", "html_url": "https://github.com/hkmatsumoto", "followers_url": "https://api.github.com/users/hkmatsumoto/followers", "following_url": "https://api.github.com/users/hkmatsumoto/following{/other_user}", "gists_url": "https://api.github.com/users/hkmatsumoto/gists{/gist_id}", "starred_url": "https://api.github.com/users/hkmatsumoto/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hkmatsumoto/subscriptions", "organizations_url": "https://api.github.com/users/hkmatsumoto/orgs", "repos_url": "https://api.github.com/users/hkmatsumoto/repos", "events_url": "https://api.github.com/users/hkmatsumoto/events{/privacy}", "received_events_url": "https://api.github.com/users/hkmatsumoto/received_events", "type": "User", "site_admin": false}, "committer": {"login": "hkmatsumoto", "id": 57856193, "node_id": "MDQ6VXNlcjU3ODU2MTkz", "avatar_url": "https://avatars.githubusercontent.com/u/57856193?v=4", "gravatar_id": "", "url": "https://api.github.com/users/hkmatsumoto", "html_url": "https://github.com/hkmatsumoto", "followers_url": "https://api.github.com/users/hkmatsumoto/followers", "following_url": "https://api.github.com/users/hkmatsumoto/following{/other_user}", "gists_url": "https://api.github.com/users/hkmatsumoto/gists{/gist_id}", "starred_url": "https://api.github.com/users/hkmatsumoto/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/hkmatsumoto/subscriptions", "organizations_url": "https://api.github.com/users/hkmatsumoto/orgs", "repos_url": "https://api.github.com/users/hkmatsumoto/repos", "events_url": "https://api.github.com/users/hkmatsumoto/events{/privacy}", "received_events_url": "https://api.github.com/users/hkmatsumoto/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f6e6ddc09d660fbfb4d483a9677d80768cc4e31c", "url": "https://api.github.com/repos/rust-lang/rust/commits/f6e6ddc09d660fbfb4d483a9677d80768cc4e31c", "html_url": "https://github.com/rust-lang/rust/commit/f6e6ddc09d660fbfb4d483a9677d80768cc4e31c"}], "stats": {"total": 42, "additions": 39, "deletions": 3}, "files": [{"sha": "830e54d51b67348a608dc304150ea918fef0d107", "filename": "src/librustdoc/json/conversions.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/e18a8efb8b8b87eb2576a12176c45dd59e5c5d18/src%2Flibrustdoc%2Fjson%2Fconversions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e18a8efb8b8b87eb2576a12176c45dd59e5c5d18/src%2Flibrustdoc%2Fjson%2Fconversions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fjson%2Fconversions.rs?ref=e18a8efb8b8b87eb2576a12176c45dd59e5c5d18", "patch": "@@ -218,14 +218,15 @@ fn from_clean_item(item: clean::Item, tcx: TyCtxt<'_>) -> ItemEnum {\n         ConstantItem(c) => ItemEnum::Constant(c.into_tcx(tcx)),\n         MacroItem(m) => ItemEnum::Macro(m.source),\n         ProcMacroItem(m) => ItemEnum::ProcMacro(m.into_tcx(tcx)),\n+        PrimitiveItem(p) => ItemEnum::PrimitiveType(p.as_sym().to_string()),\n         AssocConstItem(t, s) => ItemEnum::AssocConst { type_: t.into_tcx(tcx), default: s },\n         AssocTypeItem(g, t) => ItemEnum::AssocType {\n             bounds: g.into_iter().map(|x| x.into_tcx(tcx)).collect(),\n             default: t.map(|x| x.into_tcx(tcx)),\n         },\n         // `convert_item` early returns `None` for striped items\n         StrippedItem(_) => unreachable!(),\n-        PrimitiveItem(_) | KeywordItem(_) => {\n+        KeywordItem(_) => {\n             panic!(\"{:?} is not supported for JSON output\", item)\n         }\n         ExternCrateItem { ref src } => ItemEnum::ExternCrate {"}, {"sha": "ee81250864a48894151a0938ff4599454327a85b", "filename": "src/librustdoc/json/mod.rs", "status": "modified", "additions": 21, "deletions": 2, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/e18a8efb8b8b87eb2576a12176c45dd59e5c5d18/src%2Flibrustdoc%2Fjson%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e18a8efb8b8b87eb2576a12176c45dd59e5c5d18/src%2Flibrustdoc%2Fjson%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fjson%2Fmod.rs?ref=e18a8efb8b8b87eb2576a12176c45dd59e5c5d18", "patch": "@@ -69,7 +69,21 @@ impl JsonRenderer<'tcx> {\n                     .iter()\n                     .filter_map(|i| {\n                         let item = &i.impl_item;\n-                        if item.def_id.is_local() {\n+\n+                        // HACK(hkmatsumoto): For impls of primitive types, we index them\n+                        // regardless of whether they're local. This is because users can\n+                        // document primitive items in an arbitrary crate by using\n+                        // `doc(primitive)`.\n+                        let mut is_primitive_impl = false;\n+                        if let clean::types::ItemKind::ImplItem(ref impl_) = *item.kind {\n+                            if impl_.trait_.is_none() {\n+                                if let clean::types::Type::Primitive(_) = impl_.for_ {\n+                                    is_primitive_impl = true;\n+                                }\n+                            }\n+                        }\n+\n+                        if item.def_id.is_local() || is_primitive_impl {\n                             self.item(item.clone()).unwrap();\n                             Some(from_item_id(item.def_id))\n                         } else {\n@@ -189,6 +203,11 @@ impl<'tcx> FormatRenderer<'tcx> for JsonRenderer<'tcx> {\n \n     fn after_krate(&mut self) -> Result<(), Error> {\n         debug!(\"Done with crate\");\n+\n+        for primitive in Rc::clone(&self.cache).primitive_locations.values() {\n+            self.get_impls(primitive.clone());\n+        }\n+\n         let mut index = (*self.index).clone().into_inner();\n         index.extend(self.get_trait_items());\n         // This needs to be the default HashMap for compatibility with the public interface for\n@@ -234,7 +253,7 @@ impl<'tcx> FormatRenderer<'tcx> for JsonRenderer<'tcx> {\n                     )\n                 })\n                 .collect(),\n-            format_version: 7,\n+            format_version: 8,\n         };\n         let mut p = self.out_path.clone();\n         p.push(output.index.get(&output.root).unwrap().name.clone().unwrap());"}, {"sha": "22debd296c2367505c423da217b10bf023c7c7c4", "filename": "src/rustdoc-json-types/lib.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e18a8efb8b8b87eb2576a12176c45dd59e5c5d18/src%2Frustdoc-json-types%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e18a8efb8b8b87eb2576a12176c45dd59e5c5d18/src%2Frustdoc-json-types%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frustdoc-json-types%2Flib.rs?ref=e18a8efb8b8b87eb2576a12176c45dd59e5c5d18", "patch": "@@ -221,6 +221,8 @@ pub enum ItemEnum {\n     Macro(String),\n     ProcMacro(ProcMacro),\n \n+    PrimitiveType(String),\n+\n     AssocConst {\n         #[serde(rename = \"type\")]\n         type_: Type,"}, {"sha": "3a7d6d18c1bd0639f64ccfa6d19c501c795906fe", "filename": "src/test/rustdoc-json/primitive.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/e18a8efb8b8b87eb2576a12176c45dd59e5c5d18/src%2Ftest%2Frustdoc-json%2Fprimitive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e18a8efb8b8b87eb2576a12176c45dd59e5c5d18/src%2Ftest%2Frustdoc-json%2Fprimitive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-json%2Fprimitive.rs?ref=e18a8efb8b8b87eb2576a12176c45dd59e5c5d18", "patch": "@@ -0,0 +1,14 @@\n+// edition:2018\n+\n+#![feature(doc_primitive)]\n+\n+#[doc(primitive = \"usize\")]\n+mod usize {}\n+\n+// @set local_crate_id = primitive.json \"$.index[*][?(@.name=='primitive')].crate_id\"\n+\n+// @has - \"$.index[*][?(@.name=='log10')]\"\n+// @!is - \"$.index[*][?(@.name=='log10')].crate_id\" $local_crate_id\n+// @has - \"$.index[*][?(@.name=='checked_add')]\"\n+// @!is - \"$.index[*][?(@.name=='checked_add')]\" $local_crate_id\n+// @!has - \"$.index[*][?(@.name=='is_ascii_uppercase')]\""}]}