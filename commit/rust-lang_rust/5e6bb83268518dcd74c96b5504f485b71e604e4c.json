{"sha": "5e6bb83268518dcd74c96b5504f485b71e604e4c", "node_id": "C_kwDOAAsO6NoAKDVlNmJiODMyNjg1MThkY2Q3NGM5NmI1NTA0ZjQ4NWI3MWU2MDRlNGM", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-06-02T07:58:29Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-06-02T07:58:29Z"}, "message": "Auto merge of #96737 - ChrisDenton:win-manifest, r=wesleywiser\n\nAdd Windows application manifest to rustc-main\n\nWindows allows setting some runtime options using a manifest file. The format of the XML file is documented here: https://docs.microsoft.com/en-us/windows/win32/sbscs/application-manifests\n\nThe manifest file in this PR does three things:\n\n* Declares which Windows versions we support. This may help avoid unnecessary compatibility shims.\n* Uses the UTF-8 code page. While Rust itself uses UTF-16 APIs, other code may rely on the code page.\n* Makes the application long path aware (if also enabled by the user). This allows for the current directory to be longer than `PATH_MAX`.\n\nThese changes only affect the `rustc` process and not any other DLLs or compiled programs.", "tree": {"sha": "3145c686b4ed2b423a433cfe8002c86eca67dc89", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3145c686b4ed2b423a433cfe8002c86eca67dc89"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5e6bb83268518dcd74c96b5504f485b71e604e4c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5e6bb83268518dcd74c96b5504f485b71e604e4c", "html_url": "https://github.com/rust-lang/rust/commit/5e6bb83268518dcd74c96b5504f485b71e604e4c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5e6bb83268518dcd74c96b5504f485b71e604e4c/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fb1976011e3df96b5d3eccd6b2f4e51ef7dc8f16", "url": "https://api.github.com/repos/rust-lang/rust/commits/fb1976011e3df96b5d3eccd6b2f4e51ef7dc8f16", "html_url": "https://github.com/rust-lang/rust/commit/fb1976011e3df96b5d3eccd6b2f4e51ef7dc8f16"}, {"sha": "7255bc63387eacd097e960800a05299c93e57d4d", "url": "https://api.github.com/repos/rust-lang/rust/commits/7255bc63387eacd097e960800a05299c93e57d4d", "html_url": "https://github.com/rust-lang/rust/commit/7255bc63387eacd097e960800a05299c93e57d4d"}], "stats": {"total": 52, "additions": 52, "deletions": 0}, "files": [{"sha": "b37a2fd4c76d52437fc5b4c76a1ad9528d34831a", "filename": "compiler/rustc/Windows Manifest.xml", "status": "added", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/5e6bb83268518dcd74c96b5504f485b71e604e4c/compiler%2Frustc%2FWindows%20Manifest.xml", "raw_url": "https://github.com/rust-lang/rust/raw/5e6bb83268518dcd74c96b5504f485b71e604e4c/compiler%2Frustc%2FWindows%20Manifest.xml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc%2FWindows%20Manifest.xml?ref=5e6bb83268518dcd74c96b5504f485b71e604e4c", "patch": "@@ -0,0 +1,28 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>\n+<!--\n+This is a Windows application manifest file.\n+See: https://docs.microsoft.com/en-us/windows/win32/sbscs/application-manifests\n+-->\n+<assembly xmlns=\"urn:schemas-microsoft-com:asm.v1\" manifestVersion=\"1.0\" xmlns:asmv3=\"urn:schemas-microsoft-com:asm.v3\">\n+    <!-- Versions rustc supports as compiler hosts -->\n+    <compatibility xmlns=\"urn:schemas-microsoft-com:compatibility.v1\"> \n+        <application> \n+            <!-- Windows 7 --><supportedOS Id=\"{35138b9a-5d96-4fbd-8e2d-a2440225f93a}\"/>\n+            <!-- Windows 8 --><supportedOS Id=\"{4a2f28e3-53b9-4441-ba9c-d69d4a4a6e38}\"/>\n+            <!-- Windows 8.1 --><supportedOS Id=\"{1f676c76-80e1-4239-95bb-83d0f6d0da78}\"/>\n+            <!-- Windows 10 and 11 --><supportedOS Id=\"{8e0f7a12-bfb3-4fe8-b9a5-48fd50a15a9a}\"/>\n+        </application> \n+    </compatibility>\n+    <!-- Use UTF-8 code page -->\n+    <asmv3:application>\n+        <asmv3:windowsSettings xmlns=\"http://schemas.microsoft.com/SMI/2019/WindowsSettings\">\n+            <activeCodePage>UTF-8</activeCodePage>\n+        </asmv3:windowsSettings>\n+    </asmv3:application>\n+    <!-- Remove (most) legacy path limits -->\n+    <asmv3:application>\n+        <asmv3:windowsSettings xmlns:ws2=\"http://schemas.microsoft.com/SMI/2016/WindowsSettings\">\n+            <ws2:longPathAware>true</ws2:longPathAware>\n+        </asmv3:windowsSettings>\n+    </asmv3:application>\n+</assembly>"}, {"sha": "24c06c0ddbf6cb48c692c2e3e90e18b63fdbc6bb", "filename": "compiler/rustc/build.rs", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/5e6bb83268518dcd74c96b5504f485b71e604e4c/compiler%2Frustc%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5e6bb83268518dcd74c96b5504f485b71e604e4c/compiler%2Frustc%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc%2Fbuild.rs?ref=5e6bb83268518dcd74c96b5504f485b71e604e4c", "patch": "@@ -0,0 +1,24 @@\n+use std::env;\n+\n+fn main() {\n+    let target_os = env::var(\"CARGO_CFG_TARGET_OS\");\n+    let target_env = env::var(\"CARGO_CFG_TARGET_ENV\");\n+    if Ok(\"windows\") == target_os.as_deref() && Ok(\"msvc\") == target_env.as_deref() {\n+        set_windows_exe_options();\n+    }\n+}\n+\n+// Add a manifest file to rustc.exe.\n+fn set_windows_exe_options() {\n+    static WINDOWS_MANIFEST_FILE: &str = \"Windows Manifest.xml\";\n+\n+    let mut manifest = env::current_dir().unwrap();\n+    manifest.push(WINDOWS_MANIFEST_FILE);\n+\n+    println!(\"cargo:rerun-if-changed={}\", WINDOWS_MANIFEST_FILE);\n+    // Embed the Windows application manifest file.\n+    println!(\"cargo:rustc-link-arg-bin=rustc-main=/MANIFEST:EMBED\");\n+    println!(\"cargo:rustc-link-arg-bin=rustc-main=/MANIFESTINPUT:{}\", manifest.to_str().unwrap());\n+    // Turn linker warnings into errors.\n+    println!(\"cargo:rustc-link-arg-bin=rustc-main=/WX\");\n+}"}]}