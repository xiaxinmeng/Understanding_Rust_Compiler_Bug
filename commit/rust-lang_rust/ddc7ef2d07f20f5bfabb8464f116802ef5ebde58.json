{"sha": "ddc7ef2d07f20f5bfabb8464f116802ef5ebde58", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRkYzdlZjJkMDdmMjBmNWJmYWJiODQ2NGYxMTY4MDJlZjVlYmRlNTg=", "commit": {"author": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-11-30T17:06:06Z"}, "committer": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-11-30T18:03:52Z"}, "message": "Rollup merge of #56360 - alexcrichton:linkchecker-omg, r=pietroalbini\n\nOptimize local linkchecker program\n\nI noticed on a [recent build][1] that the linkchecker stage of CI took a\nwhopping 15 minutes of CI time for something that should be near\ninstantaneous. Some local profiling showed some very hot functions and\nclones which were pretty easy to remove, and now instead of running in\nminutes locally it runs in seconds.\n\n[1]: https://ci.appveyor.com/project/rust-lang/rust/build/job/kptifw1kb1nm4xuu", "tree": {"sha": "1d3e9ba77a3b0058d76f2c37a46f2bd0edb92fe9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1d3e9ba77a3b0058d76f2c37a46f2bd0edb92fe9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ddc7ef2d07f20f5bfabb8464f116802ef5ebde58", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEZ1R8CLMp8f2GxWoQ/vbIBR0OATwFAlwBe4kACgkQ/vbIBR0O\nATzarBAArSIbIySRqLZ0wUaj4Sb5fNaNPCmx6hveEXOtuxccbTwjzdGA7X0ZZkj6\nhUO56OD+jUh9BB6rQy8J6sXyJ+5Ys9fVNOCZskofj7sOvC5G4//HnhllJ0xDeaPB\ni0hmumpcleXJCy3WKUHDQhWcZr/MbWkspX89lHi+gphCawwQ+ULW/Nl2P3aVRZkB\novQiV8wS209cSZAKnQO3Sbp0qJKB0I6WH4adHZfVyVA7OPzgLNmVJpzxKjLt9bT3\nnP8B7JtwIKNXGbROYM7jH1O8m8qFjYXNG9gmFKt7/AxOc+kekRXTAQv927bAGyv5\nopDJXyMPR9zYZQe9RPMpv4VskefRm+Uv3hGf0AJCCKZDfS4/OJDZtCOskseDekLC\nc7hXn6pWuM4Q4u5ED0mcPt9FvsLLObnIxRBi9BTrFEF/ZzPj/2GXBWtbC/qfW255\nT0OwUwbnzL/pb1GxhvX22kWVhFuwHqtfAdt81QsBYXbX+gvymcomFIQTSUK69ynM\ntLAm/OuyEUos8x68WelZylMRusaAB7+c6cWPZzrlw90zd7TYCNP3QC/fLsoOZa7c\n0FtWVT0j2vxOVRndVxOctiJwmoCs8edAOMWwWhift7KIduzO0xF/ZC2BKHc+r8ho\n2jU3I+5Ky36WFiadLDxpJayQIRrqwnOiR1hwr3Sn5OU8ekghj4s=\n=5ezu\n-----END PGP SIGNATURE-----", "payload": "tree 1d3e9ba77a3b0058d76f2c37a46f2bd0edb92fe9\nparent 45aaaa70bbb209da877762c90514ab9920c9a043\nparent 225140ed216d7395530b2e4597fb224305e6375b\nauthor kennytm <kennytm@gmail.com> 1543597566 +0800\ncommitter kennytm <kennytm@gmail.com> 1543601032 +0800\n\nRollup merge of #56360 - alexcrichton:linkchecker-omg, r=pietroalbini\n\nOptimize local linkchecker program\n\nI noticed on a [recent build][1] that the linkchecker stage of CI took a\nwhopping 15 minutes of CI time for something that should be near\ninstantaneous. Some local profiling showed some very hot functions and\nclones which were pretty easy to remove, and now instead of running in\nminutes locally it runs in seconds.\n\n[1]: https://ci.appveyor.com/project/rust-lang/rust/build/job/kptifw1kb1nm4xuu\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ddc7ef2d07f20f5bfabb8464f116802ef5ebde58", "html_url": "https://github.com/rust-lang/rust/commit/ddc7ef2d07f20f5bfabb8464f116802ef5ebde58", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ddc7ef2d07f20f5bfabb8464f116802ef5ebde58/comments", "author": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "45aaaa70bbb209da877762c90514ab9920c9a043", "url": "https://api.github.com/repos/rust-lang/rust/commits/45aaaa70bbb209da877762c90514ab9920c9a043", "html_url": "https://github.com/rust-lang/rust/commit/45aaaa70bbb209da877762c90514ab9920c9a043"}, {"sha": "225140ed216d7395530b2e4597fb224305e6375b", "url": "https://api.github.com/repos/rust-lang/rust/commits/225140ed216d7395530b2e4597fb224305e6375b", "html_url": "https://github.com/rust-lang/rust/commit/225140ed216d7395530b2e4597fb224305e6375b"}], "stats": {"total": 38, "additions": 19, "deletions": 19}, "files": [{"sha": "11c83819eaa93527b6152d0fd7c061195c5c1dfa", "filename": "src/tools/linkchecker/main.rs", "status": "modified", "additions": 19, "deletions": 19, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/ddc7ef2d07f20f5bfabb8464f116802ef5ebde58/src%2Ftools%2Flinkchecker%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ddc7ef2d07f20f5bfabb8464f116802ef5ebde58/src%2Ftools%2Flinkchecker%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Flinkchecker%2Fmain.rs?ref=ddc7ef2d07f20f5bfabb8464f116802ef5ebde58", "patch": "@@ -24,12 +24,12 @@\n //! A few whitelisted exceptions are allowed as there's known bugs in rustdoc,\n //! but this should catch the majority of \"broken link\" cases.\n \n+use std::collections::hash_map::Entry;\n+use std::collections::{HashMap, HashSet};\n use std::env;\n-use std::fs::File;\n-use std::io::prelude::*;\n+use std::fs;\n use std::path::{Path, PathBuf, Component};\n-use std::collections::{HashMap, HashSet};\n-use std::collections::hash_map::Entry;\n+use std::rc::Rc;\n \n use Redirect::*;\n \n@@ -63,7 +63,7 @@ enum Redirect {\n }\n \n struct FileEntry {\n-    source: String,\n+    source: Rc<String>,\n     ids: HashSet<String>,\n }\n \n@@ -113,7 +113,7 @@ fn walk(cache: &mut Cache, root: &Path, dir: &Path, errors: &mut bool) {\n                 let entry = cache.get_mut(&pretty_path).unwrap();\n                 // we don't need the source anymore,\n                 // so drop to reduce memory-usage\n-                entry.source = String::new();\n+                entry.source = Rc::new(String::new());\n             }\n         }\n     }\n@@ -287,24 +287,24 @@ fn load_file(cache: &mut Cache,\n              root: &Path,\n              file: &Path,\n              redirect: Redirect)\n-             -> Result<(PathBuf, String), LoadError> {\n-    let mut contents = String::new();\n+             -> Result<(PathBuf, Rc<String>), LoadError> {\n     let pretty_file = PathBuf::from(file.strip_prefix(root).unwrap_or(&file));\n \n-    let maybe_redirect = match cache.entry(pretty_file.clone()) {\n+    let (maybe_redirect, contents) = match cache.entry(pretty_file.clone()) {\n         Entry::Occupied(entry) => {\n-            contents = entry.get().source.clone();\n-            None\n+            (None, entry.get().source.clone())\n         }\n         Entry::Vacant(entry) => {\n-            let mut fp = File::open(file).map_err(|err| {\n-                if let FromRedirect(true) = redirect {\n-                    LoadError::BrokenRedirect(file.to_path_buf(), err)\n-                } else {\n-                    LoadError::IOError(err)\n+            let contents = match fs::read_to_string(file) {\n+                Ok(s) => Rc::new(s),\n+                Err(err) => {\n+                    return Err(if let FromRedirect(true) = redirect {\n+                        LoadError::BrokenRedirect(file.to_path_buf(), err)\n+                    } else {\n+                        LoadError::IOError(err)\n+                    })\n                 }\n-            })?;\n-            fp.read_to_string(&mut contents).map_err(|err| LoadError::IOError(err))?;\n+            };\n \n             let maybe = maybe_redirect(&contents);\n             if maybe.is_some() {\n@@ -317,7 +317,7 @@ fn load_file(cache: &mut Cache,\n                     ids: HashSet::new(),\n                 });\n             }\n-            maybe\n+            (maybe, contents)\n         }\n     };\n     match maybe_redirect.map(|url| file.parent().unwrap().join(url)) {"}]}