{"sha": "9625ed8be7fa66c3ee5f78180a3d5911817096f6", "node_id": "C_kwDOAAsO6NoAKDk2MjVlZDhiZTdmYTY2YzNlZTVmNzgxODBhM2Q1OTExODE3MDk2ZjY", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume.gomez@huawei.com", "date": "2022-01-19T21:36:15Z"}, "committer": {"name": "Guillaume Gomez", "email": "guillaume.gomez@huawei.com", "date": "2022-04-30T11:12:41Z"}, "message": "Move settings into full JS", "tree": {"sha": "eca2280b9a9644ab284bed1e27ec5024b084a6c7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/eca2280b9a9644ab284bed1e27ec5024b084a6c7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9625ed8be7fa66c3ee5f78180a3d5911817096f6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9625ed8be7fa66c3ee5f78180a3d5911817096f6", "html_url": "https://github.com/rust-lang/rust/commit/9625ed8be7fa66c3ee5f78180a3d5911817096f6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9625ed8be7fa66c3ee5f78180a3d5911817096f6/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "76d4862fdd131b6f79dc0a31857f888d26bcdb27", "url": "https://api.github.com/repos/rust-lang/rust/commits/76d4862fdd131b6f79dc0a31857f888d26bcdb27", "html_url": "https://github.com/rust-lang/rust/commit/76d4862fdd131b6f79dc0a31857f888d26bcdb27"}], "stats": {"total": 539, "additions": 343, "deletions": 196}, "files": [{"sha": "56a085c2982508b3f50c988d5188f787413e0708", "filename": "src/librustdoc/html/markdown.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/9625ed8be7fa66c3ee5f78180a3d5911817096f6/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9625ed8be7fa66c3ee5f78180a3d5911817096f6/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs?ref=9625ed8be7fa66c3ee5f78180a3d5911817096f6", "patch": "@@ -1440,6 +1440,10 @@ fn init_id_map() -> FxHashMap<Cow<'static, str>, usize> {\n     let mut map = FxHashMap::default();\n     // This is the list of IDs used in Javascript.\n     map.insert(\"help\".into(), 1);\n+    map.insert(\"settings\".into(), 1);\n+    map.insert(\"not-displayed\".into(), 1);\n+    map.insert(\"alternative-display\".into(), 1);\n+    map.insert(\"search\".into(), 1);\n     // This is the list of IDs used in HTML generated in Rust (including the ones\n     // used in tera template files).\n     map.insert(\"mainThemeStyle\".into(), 1);\n@@ -1449,7 +1453,6 @@ fn init_id_map() -> FxHashMap<Cow<'static, str>, usize> {\n     map.insert(\"settings-menu\".into(), 1);\n     map.insert(\"help-button\".into(), 1);\n     map.insert(\"main-content\".into(), 1);\n-    map.insert(\"search\".into(), 1);\n     map.insert(\"crate-search\".into(), 1);\n     map.insert(\"render-detail\".into(), 1);\n     map.insert(\"toggle-all-docs\".into(), 1);"}, {"sha": "a30c533aa48c8f04bfd64e9155e6bc368c2dc1e7", "filename": "src/librustdoc/html/render/context.rs", "status": "modified", "additions": 10, "deletions": 13, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/9625ed8be7fa66c3ee5f78180a3d5911817096f6/src%2Flibrustdoc%2Fhtml%2Frender%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9625ed8be7fa66c3ee5f78180a3d5911817096f6/src%2Flibrustdoc%2Fhtml%2Frender%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fcontext.rs?ref=9625ed8be7fa66c3ee5f78180a3d5911817096f6", "patch": "@@ -17,8 +17,8 @@ use super::print_item::{full_path, item_path, print_item};\n use super::search_index::build_index;\n use super::write_shared::write_shared;\n use super::{\n-    collect_spans_and_sources, print_sidebar, scrape_examples_help, settings, AllTypes,\n-    LinkFromSrc, NameDoc, StylePath, BASIC_KEYWORDS,\n+    collect_spans_and_sources, print_sidebar, scrape_examples_help, AllTypes, LinkFromSrc, NameDoc,\n+    StylePath, BASIC_KEYWORDS,\n };\n \n use crate::clean::{self, types::ExternalLocation, ExternalCrate};\n@@ -589,21 +589,18 @@ impl<'tcx> FormatRenderer<'tcx> for Context<'tcx> {\n         page.root_path = \"./\";\n \n         let sidebar = \"<h2 class=\\\"location\\\">Settings</h2><div class=\\\"sidebar-elems\\\"></div>\";\n-        let theme_names: Vec<String> = self\n-            .shared\n-            .style_files\n-            .iter()\n-            .map(StylePath::basename)\n-            .collect::<Result<_, Error>>()?;\n         let v = layout::render(\n             &self.shared.layout,\n             &page,\n             sidebar,\n-            settings(\n-                self.shared.static_root_path.as_deref().unwrap_or(\"./\"),\n-                &self.shared.resource_suffix,\n-                theme_names,\n-            )?,\n+            |buf: &mut Buffer| {\n+                write!(\n+                    buf,\n+                    \"<script defer src=\\\"{}settings{}.js\\\"></script>\",\n+                    page.static_root_path.unwrap_or(\"\"),\n+                    page.resource_suffix\n+                )\n+            },\n             &self.shared.style_files,\n         );\n         self.shared.fs.write(settings_file, v)?;"}, {"sha": "fedeb449b2e0e9a39aa96eda57a8efa388e818da", "filename": "src/librustdoc/html/render/mod.rs", "status": "modified", "additions": 0, "deletions": 128, "changes": 128, "blob_url": "https://github.com/rust-lang/rust/blob/9625ed8be7fa66c3ee5f78180a3d5911817096f6/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9625ed8be7fa66c3ee5f78180a3d5911817096f6/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs?ref=9625ed8be7fa66c3ee5f78180a3d5911817096f6", "patch": "@@ -334,134 +334,6 @@ impl AllTypes {\n     }\n }\n \n-#[derive(Debug)]\n-enum Setting {\n-    Section {\n-        description: &'static str,\n-        sub_settings: Vec<Setting>,\n-    },\n-    Toggle {\n-        js_data_name: &'static str,\n-        description: &'static str,\n-        default_value: bool,\n-    },\n-    Select {\n-        js_data_name: &'static str,\n-        description: &'static str,\n-        default_value: &'static str,\n-        options: Vec<String>,\n-    },\n-}\n-\n-impl Setting {\n-    fn display(&self, root_path: &str, suffix: &str) -> String {\n-        match *self {\n-            Setting::Section { description, ref sub_settings } => format!(\n-                \"<div class=\\\"setting-line\\\">\\\n-                     <div class=\\\"title\\\">{}</div>\\\n-                     <div class=\\\"sub-settings\\\">{}</div>\n-                 </div>\",\n-                description,\n-                sub_settings.iter().map(|s| s.display(root_path, suffix)).collect::<String>()\n-            ),\n-            Setting::Toggle { js_data_name, description, default_value } => format!(\n-                \"<div class=\\\"setting-line\\\">\\\n-                     <label class=\\\"toggle\\\">\\\n-                     <input type=\\\"checkbox\\\" id=\\\"{}\\\" {}>\\\n-                     <span class=\\\"slider\\\"></span>\\\n-                     </label>\\\n-                     <div>{}</div>\\\n-                 </div>\",\n-                js_data_name,\n-                if default_value { \" checked\" } else { \"\" },\n-                description,\n-            ),\n-            Setting::Select { js_data_name, description, default_value, ref options } => format!(\n-                \"<div class=\\\"setting-line\\\"><div class=\\\"radio-line\\\" id=\\\"{}\\\"><span class=\\\"setting-name\\\">{}</span><div class=\\\"choices\\\">{}</div></div></div>\",\n-                js_data_name,\n-                description,\n-                options\n-                    .iter()\n-                    .map(|opt| format!(\n-                        \"<label for=\\\"{js_data_name}-{name}\\\" class=\\\"choice\\\">\n-                           <input type=\\\"radio\\\" name=\\\"{js_data_name}\\\" id=\\\"{js_data_name}-{name}\\\" value=\\\"{name}\\\" {checked}>\\\n-                           {name}\\\n-                         </label>\",\n-                        js_data_name = js_data_name,\n-                        name = opt,\n-                        checked = if opt == default_value { \"checked\" } else { \"\" },\n-                    ))\n-                    .collect::<String>(),\n-            ),\n-        }\n-    }\n-}\n-\n-impl From<(&'static str, &'static str, bool)> for Setting {\n-    fn from(values: (&'static str, &'static str, bool)) -> Setting {\n-        Setting::Toggle { js_data_name: values.0, description: values.1, default_value: values.2 }\n-    }\n-}\n-\n-impl<T: Into<Setting>> From<(&'static str, Vec<T>)> for Setting {\n-    fn from(values: (&'static str, Vec<T>)) -> Setting {\n-        Setting::Section {\n-            description: values.0,\n-            sub_settings: values.1.into_iter().map(|v| v.into()).collect::<Vec<_>>(),\n-        }\n-    }\n-}\n-\n-fn settings(root_path: &str, suffix: &str, theme_names: Vec<String>) -> Result<String, Error> {\n-    // (id, explanation, default value)\n-    let settings: &[Setting] = &[\n-        Setting::from((\"use-system-theme\", \"Use system theme\", true)),\n-        Setting::Select {\n-            js_data_name: \"theme\",\n-            description: \"Theme\",\n-            default_value: \"light\",\n-            options: theme_names.clone(),\n-        },\n-        Setting::Select {\n-            js_data_name: \"preferred-light-theme\",\n-            description: \"Preferred light theme\",\n-            default_value: \"light\",\n-            options: theme_names.clone(),\n-        },\n-        Setting::Select {\n-            js_data_name: \"preferred-dark-theme\",\n-            description: \"Preferred dark theme\",\n-            default_value: \"dark\",\n-            options: theme_names,\n-        },\n-        (\"auto-hide-large-items\", \"Auto-hide item contents for large items.\", true).into(),\n-        (\"auto-hide-method-docs\", \"Auto-hide item methods' documentation\", false).into(),\n-        (\"auto-hide-trait-implementations\", \"Auto-hide trait implementation documentation\", false)\n-            .into(),\n-        (\"go-to-only-result\", \"Directly go to item in search if there is only one result\", false)\n-            .into(),\n-        (\"line-numbers\", \"Show line numbers on code examples\", false).into(),\n-        (\"disable-shortcuts\", \"Disable keyboard shortcuts\", false).into(),\n-    ];\n-\n-    Ok(format!(\n-        \"<div class=\\\"main-heading\\\">\n-            <h1 class=\\\"fqn\\\">\\\n-                <span class=\\\"in-band\\\">Rustdoc settings</span>\\\n-            </h1>\\\n-            <span class=\\\"out-of-band\\\">\\\n-            <a id=\\\"back\\\" href=\\\"javascript:void(0)\\\">Back</a>\\\n-            </span>\\\n-        </div>\\\n-        <div class=\\\"settings\\\">{}</div>\\\n-        <link rel=\\\"stylesheet\\\" href=\\\"{root_path}settings{suffix}.css\\\">\\\n-        <script src=\\\"{root_path}settings{suffix}.js\\\"></script>\",\n-        settings.iter().map(|s| s.display(root_path, suffix)).collect::<String>(),\n-        root_path = root_path,\n-        suffix = suffix\n-    ))\n-}\n-\n fn scrape_examples_help(shared: &SharedContext<'_>) -> String {\n     let mut content = SCRAPE_EXAMPLES_HELP_MD.to_owned();\n     content.push_str(&format!("}, {"sha": "7ac835b327034a4c688cafad520e7df96294dc21", "filename": "src/librustdoc/html/static/js/main.js", "status": "modified", "additions": 145, "deletions": 34, "changes": 179, "blob_url": "https://github.com/rust-lang/rust/blob/9625ed8be7fa66c3ee5f78180a3d5911817096f6/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fmain.js", "raw_url": "https://github.com/rust-lang/rust/raw/9625ed8be7fa66c3ee5f78180a3d5911817096f6/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fmain.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fmain.js?ref=9625ed8be7fa66c3ee5f78180a3d5911817096f6", "patch": "@@ -57,11 +57,20 @@ function resourcePath(basename, extension) {\n     return getVar(\"root-path\") + basename + getVar(\"resource-suffix\") + extension;\n }\n \n+function hideMain() {\n+    addClass(document.getElementById(MAIN_ID), \"hidden\");\n+}\n+\n+function showMain() {\n+    removeClass(document.getElementById(MAIN_ID), \"hidden\");\n+}\n+\n (function () {\n     window.rootPath = getVar(\"root-path\");\n     window.currentCrate = getVar(\"current-crate\");\n     window.searchJS =  resourcePath(\"search\", \".js\");\n     window.searchIndexJS = resourcePath(\"search-index\", \".js\");\n+    window.settingsJS = resourcePath(\"settings\", \".js\");\n     const sidebarVars = document.getElementById(\"sidebar-vars\");\n     if (sidebarVars) {\n         window.sidebarCurrent = {\n@@ -104,6 +113,9 @@ function getVirtualKey(ev) {\n const THEME_PICKER_ELEMENT_ID = \"theme-picker\";\n const THEMES_ELEMENT_ID = \"theme-choices\";\n const MAIN_ID = \"main-content\";\n+const SETTINGS_BUTTON_ID = \"settings-menu\";\n+const ALTERNATIVE_DISPLAY_ID = \"alternative-display\";\n+const NOT_DISPLAYED_ID = \"not-displayed\";\n \n function getThemesElement() {\n     return document.getElementById(THEMES_ELEMENT_ID);\n@@ -113,6 +125,10 @@ function getThemePickerElement() {\n     return document.getElementById(THEME_PICKER_ELEMENT_ID);\n }\n \n+function getSettingsButton() {\n+    return document.getElementById(SETTINGS_BUTTON_ID);\n+}\n+\n // Returns the current URL without any query parameter or hash.\n function getNakedUrl() {\n     return window.location.href.split(\"?\")[0].split(\"#\")[0];\n@@ -136,6 +152,10 @@ function hideThemeButtonState() {\n     themePicker.style.borderBottomLeftRadius = \"3px\";\n }\n \n+window.hideSettings = function() {\n+    // Does nothing by default.\n+};\n+\n // Set up the theme picker list.\n (function () {\n     if (!document.location.href.startsWith(\"file:///\")) {\n@@ -182,14 +202,120 @@ function hideThemeButtonState() {\n     });\n }());\n \n+/**\n+ * This function inserts `newNode` after `referenceNode`. It doesn't work if `referenceNode`\n+ * doesn't have a parent node.\n+ *\n+ * @param {DOM} newNode\n+ * @param {DOM} referenceNode\n+ */\n+function insertAfter(newNode, referenceNode) {\n+    referenceNode.parentNode.insertBefore(newNode, referenceNode.nextSibling);\n+}\n+\n+/**\n+ * This function creates a new `<section>` with the given `id` and `classes` if it doesn't already\n+ * exist.\n+ *\n+ * More information about this in `switchDisplayedElement` documentation.\n+ *\n+ * @param {string} id\n+ * @param {string} classes\n+ */\n+function getOrCreateSection(id, classes) {\n+    let el = document.getElementById(id);\n+\n+    if (!el) {\n+        el = document.createElement(\"section\");\n+        el.id = id;\n+        el.className = classes;\n+        insertAfter(el, document.getElementById(MAIN_ID));\n+    }\n+    return el;\n+}\n+\n+/**\n+ * Returns the `<section>` element which contains the displayed element.\n+ *\n+ * @return {DOM}\n+ */\n+function getAlternativeDisplayElem() {\n+    return getOrCreateSection(ALTERNATIVE_DISPLAY_ID, \"content hidden\");\n+}\n+\n+/**\n+ * Returns the `<section>` element which contains the not-displayed elements.\n+ *\n+ * @return {DOM}\n+ */\n+function getNotDisplayedElem() {\n+    return getOrCreateSection(NOT_DISPLAYED_ID, \"hidden\");\n+}\n+\n+/**\n+ * To nicely switch between displayed \"extra\" elements (such as search results or settings menu)\n+ * and to alternate between the displayed and not displayed elements, we hold them in two different\n+ * `<section>` elements. They work in pair: one hold the not displayed elements while the other\n+ * contains the displayed element (there can be only one at the same time!). So basically, we switch\n+ * elements between the two `<section>` elements.\n+ *\n+ * @param {DOM} elemToDisplay\n+ */\n+function switchDisplayedElement(elemToDisplay) {\n+    const el = getAlternativeDisplayElem();\n+\n+    if (el.children.length > 0) {\n+        getNotDisplayedElem().appendChild(el.firstElementChild);\n+    }\n+    if (elemToDisplay === null) {\n+        addClass(el, \"hidden\");\n+        showMain();\n+        return;\n+    }\n+    el.appendChild(elemToDisplay);\n+    hideMain();\n+    removeClass(el, \"hidden\");\n+}\n+\n+function browserSupportsHistoryApi() {\n+    return window.history && typeof window.history.pushState === \"function\";\n+}\n+\n+// eslint-disable-next-line no-unused-vars\n+function loadCss(cssFileName) {\n+    const link = document.createElement(\"link\");\n+    link.href = resourcePath(cssFileName, \".css\");\n+    link.type = \"text/css\";\n+    link.rel = \"stylesheet\";\n+    document.getElementsByTagName(\"head\")[0].appendChild(link);\n+}\n+\n (function() {\n     \"use strict\";\n \n+    function loadScript(url) {\n+        const script = document.createElement('script');\n+        script.src = url;\n+        document.head.append(script);\n+    }\n+\n+\n+    getSettingsButton().onclick = function(event) {\n+        event.preventDefault();\n+        loadScript(window.settingsJS);\n+    };\n+\n     window.searchState = {\n         loadingText: \"Loading search results...\",\n         input: document.getElementsByClassName(\"search-input\")[0],\n         outputElement: function() {\n-            return document.getElementById(\"search\");\n+            let el = document.getElementById(\"search\");\n+            if (!el) {\n+                el = document.createElement(\"section\");\n+                el.id = \"search\";\n+                getNotDisplayedElem().appendChild(el);\n+            }\n+            return el;\n         },\n         title: document.title,\n         titleBeforeSearch: document.title,\n@@ -208,6 +334,9 @@ function hideThemeButtonState() {\n                 searchState.timeout = null;\n             }\n         },\n+        isDisplayed: function() {\n+            return searchState.outputElement().parentElement.id === ALTERNATIVE_DISPLAY_ID;\n+        },\n         // Sets the focus on the search bar at the top of the page\n         focus: function() {\n             searchState.input.focus();\n@@ -220,20 +349,15 @@ function hideThemeButtonState() {\n             if (search === null || typeof search === 'undefined') {\n                 search = searchState.outputElement();\n             }\n-            addClass(main, \"hidden\");\n-            removeClass(search, \"hidden\");\n+            switchDisplayedElement(search);\n             searchState.mouseMovedAfterSearch = false;\n             document.title = searchState.title;\n         },\n-        hideResults: function(search) {\n-            if (search === null || typeof search === 'undefined') {\n-                search = searchState.outputElement();\n-            }\n-            addClass(search, \"hidden\");\n-            removeClass(main, \"hidden\");\n+        hideResults: function() {\n+            switchDisplayedElement(null);\n             document.title = searchState.titleBeforeSearch;\n             // We also remove the query parameter from the URL.\n-            if (searchState.browserSupportsHistoryApi()) {\n+            if (browserSupportsHistoryApi()) {\n                 history.replaceState(null, window.currentCrate + \" - Rust\",\n                     getNakedUrl() + window.location.hash);\n             }\n@@ -248,20 +372,11 @@ function hideThemeButtonState() {\n                 });\n             return params;\n         },\n-        browserSupportsHistoryApi: function() {\n-            return window.history && typeof window.history.pushState === \"function\";\n-        },\n         setup: function() {\n             const search_input = searchState.input;\n             if (!searchState.input) {\n                 return;\n             }\n-            function loadScript(url) {\n-                const script = document.createElement('script');\n-                script.src = url;\n-                document.head.append(script);\n-            }\n-\n             let searchLoaded = false;\n             function loadSearch() {\n                 if (!searchLoaded) {\n@@ -303,23 +418,20 @@ function hideThemeButtonState() {\n     }\n \n     const toggleAllDocsId = \"toggle-all-docs\";\n-    const main = document.getElementById(MAIN_ID);\n     let savedHash = \"\";\n \n     function handleHashes(ev) {\n-        let elem;\n-        const search = searchState.outputElement();\n-        if (ev !== null && search && !hasClass(search, \"hidden\") && ev.newURL) {\n+        if (ev !== null && searchState.isDisplayed() && ev.newURL) {\n             // This block occurs when clicking on an element in the navbar while\n             // in a search.\n-            searchState.hideResults(search);\n+            switchDisplayedElement(null);\n             const hash = ev.newURL.slice(ev.newURL.indexOf(\"#\") + 1);\n-            if (searchState.browserSupportsHistoryApi()) {\n+            if (browserSupportsHistoryApi()) {\n                 // `window.location.search`` contains all the query parameters, not just `search`.\n                 history.replaceState(null, \"\",\n                     getNakedUrl() + window.location.search + \"#\" + hash);\n             }\n-            elem = document.getElementById(hash);\n+            const elem = document.getElementById(hash);\n             if (elem) {\n                 elem.scrollIntoView();\n             }\n@@ -389,14 +501,17 @@ function hideThemeButtonState() {\n     }\n \n     function handleEscape(ev) {\n+        searchState.clearInputTimeout();\n         const help = getHelpElement(false);\n-        const search = searchState.outputElement();\n         if (help && !hasClass(help, \"hidden\")) {\n             displayHelp(false, ev, help);\n-        } else if (search && !hasClass(search, \"hidden\")) {\n-            searchState.clearInputTimeout();\n+        } else {\n+            switchDisplayedElement(null);\n+            if (browserSupportsHistoryApi()) {\n+                history.replaceState(null, window.currentCrate + \" - Rust\",\n+                    getNakedUrl() + window.location.hash);\n+            }\n             ev.preventDefault();\n-            searchState.hideResults(search);\n         }\n         searchState.defocus();\n         hideThemeButtonState();\n@@ -733,10 +848,6 @@ function hideThemeButtonState() {\n         innerToggle.children[0].innerText = labelForToggleButton(sectionIsCollapsed);\n     }\n \n-    function insertAfter(newNode, referenceNode) {\n-        referenceNode.parentNode.insertBefore(newNode, referenceNode.nextSibling);\n-    }\n-\n     (function() {\n         const toggles = document.getElementById(toggleAllDocsId);\n         if (toggles) {"}, {"sha": "84600fa3e094f6bfc96fe868e0c8f538033979a8", "filename": "src/librustdoc/html/static/js/search.js", "status": "modified", "additions": 8, "deletions": 8, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/9625ed8be7fa66c3ee5f78180a3d5911817096f6/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsearch.js", "raw_url": "https://github.com/rust-lang/rust/raw/9625ed8be7fa66c3ee5f78180a3d5911817096f6/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsearch.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsearch.js?ref=9625ed8be7fa66c3ee5f78180a3d5911817096f6", "patch": "@@ -2,7 +2,7 @@\n /* eslint no-var: \"error\" */\n /* eslint prefer-const: \"error\" */\n /* global addClass, getNakedUrl, getSettingValue, hasOwnPropertyRustdoc, initSearch, onEach */\n-/* global onEachLazy, removeClass, searchState, hasClass */\n+/* global onEachLazy, removeClass, searchState, browserSupportsHistoryApi */\n \n (function() {\n // This mapping table should match the discriminants of\n@@ -1786,8 +1786,9 @@ window.initSearch = function(rawSearchIndex) {\n \n         // Because searching is incremental by character, only the most\n         // recent search query is added to the browser history.\n-        if (searchState.browserSupportsHistoryApi()) {\n+        if (browserSupportsHistoryApi()) {\n             const newURL = buildUrl(query.original, filterCrates);\n+\n             if (!history.state && !params.search) {\n                 history.pushState(null, \"\", newURL);\n             } else {\n@@ -1965,10 +1966,9 @@ window.initSearch = function(rawSearchIndex) {\n         if (!searchState.input) {\n             return;\n         }\n-        const search = searchState.outputElement();\n-        if (search_input.value !== \"\" && hasClass(search, \"hidden\")) {\n-            searchState.showResults(search);\n-            if (searchState.browserSupportsHistoryApi()) {\n+        if (search_input.value !== \"\" && !searchState.isDisplayed()) {\n+            searchState.showResults();\n+            if (browserSupportsHistoryApi()) {\n                 history.replaceState(null, \"\",\n                     buildUrl(search_input.value, getFilterCrates()));\n             }\n@@ -1980,7 +1980,7 @@ window.initSearch = function(rawSearchIndex) {\n         const searchAfter500ms = function() {\n             searchState.clearInputTimeout();\n             if (searchState.input.value.length === 0) {\n-                if (searchState.browserSupportsHistoryApi()) {\n+                if (browserSupportsHistoryApi()) {\n                     history.replaceState(null, window.currentCrate + \" - Rust\",\n                         getNakedUrl() + window.location.hash);\n                 }\n@@ -2058,7 +2058,7 @@ window.initSearch = function(rawSearchIndex) {\n \n         // Push and pop states are used to add search results to the browser\n         // history.\n-        if (searchState.browserSupportsHistoryApi()) {\n+        if (browserSupportsHistoryApi()) {\n             // Store the previous <title> so we can revert back to it later.\n             const previousTitle = document.title;\n "}, {"sha": "bdc1162a7c07100ea749f8a3c2cf79c0bcdee4a0", "filename": "src/librustdoc/html/static/js/settings.js", "status": "modified", "additions": 174, "deletions": 9, "changes": 183, "blob_url": "https://github.com/rust-lang/rust/blob/9625ed8be7fa66c3ee5f78180a3d5911817096f6/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsettings.js", "raw_url": "https://github.com/rust-lang/rust/raw/9625ed8be7fa66c3ee5f78180a3d5911817096f6/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsettings.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsettings.js?ref=9625ed8be7fa66c3ee5f78180a3d5911817096f6", "patch": "@@ -2,10 +2,13 @@\n /* eslint no-var: \"error\" */\n /* eslint prefer-const: \"error\" */\n // Local js definitions:\n-/* global getSettingValue, getVirtualKey, onEachLazy, updateLocalStorage, updateSystemTheme */\n-/* global addClass, removeClass */\n+/* global getSettingValue, getVirtualKey, updateLocalStorage, updateSystemTheme, loadCss */\n+/* global addClass, removeClass, onEach, onEachLazy, NOT_DISPLAYED_ID */\n+/* global MAIN_ID, getVar, getSettingsButton, switchDisplayedElement, getNotDisplayedElem */\n \n (function () {\n+    const isSettingsPage = window.location.pathname.endsWith(\"/settings.html\");\n+\n     function changeSetting(settingName, value) {\n         updateLocalStorage(settingName, value);\n \n@@ -55,9 +58,9 @@\n         }\n     }\n \n-    function setEvents() {\n+    function setEvents(settingsElement) {\n         updateLightAndDark();\n-        onEachLazy(document.getElementsByClassName(\"slider\"), function(elem) {\n+        onEachLazy(settingsElement.getElementsByClassName(\"slider\"), function(elem) {\n             const toggle = elem.previousElementSibling;\n             const settingId = toggle.id;\n             const settingValue = getSettingValue(settingId);\n@@ -70,7 +73,7 @@\n             toggle.onkeyup = handleKey;\n             toggle.onkeyrelease = handleKey;\n         });\n-        onEachLazy(document.getElementsByClassName(\"select-wrapper\"), function(elem) {\n+        onEachLazy(settingsElement.getElementsByClassName(\"select-wrapper\"), function(elem) {\n             const select = elem.getElementsByTagName(\"select\")[0];\n             const settingId = select.id;\n             const settingValue = getSettingValue(settingId);\n@@ -81,7 +84,7 @@\n                 changeSetting(this.id, this.value);\n             };\n         });\n-        onEachLazy(document.querySelectorAll(\"input[type=\\\"radio\\\"]\"), function(elem) {\n+        onEachLazy(settingsElement.querySelectorAll(\"input[type=\\\"radio\\\"]\"), function(elem) {\n             const settingId = elem.name;\n             const settingValue = getSettingValue(settingId);\n             if (settingValue !== null && settingValue !== \"null\") {\n@@ -91,10 +94,172 @@\n                 changeSetting(ev.target.name, ev.target.value);\n             });\n         });\n-        document.getElementById(\"back\").addEventListener(\"click\", function() {\n-            history.back();\n+    }\n+\n+    function buildSettings(settings) {\n+        let output = \"\";\n+\n+        onEach(settings, function(setting) {\n+            output += `<div class=\"setting-line\">`;\n+            const js_data_name = setting[\"js_name\"];\n+            const setting_name = setting[\"name\"];\n+\n+            if (setting[\"options\"] !== undefined) {\n+                // This is a select setting.\n+                output += `<div class=\"radio-line\" id=\"${js_data_name}\">\\\n+                        <span class=\"setting-name\">${setting_name}</span>\\\n+                        <div class=\"choices\">`;\n+                onEach(setting[\"options\"], function(option) {\n+                    const checked = option === setting[\"default\"] ? \" checked\" : \"\";\n+\n+                    output += `<label for=\"${js_data_name}-${option}\" class=\"choice\">\\\n+                           <input type=\"radio\" name=\"${js_data_name}\" \\\n+                                id=\"${js_data_name}-${option}\" value=\"${option}\"${checked}>\\\n+                           ${option}\\\n+                         </label>`;\n+                });\n+                output += \"</div></div>\";\n+            } else {\n+                // This is a toggle.\n+                const checked = setting[\"default\"] === true ? \" checked\" : \"\";\n+                output += `\n+                    <label class=\"toggle\">\n+                        <input type=\"checkbox\" id=\"${js_data_name}\"${checked}>\n+                        <span class=\"slider\"></span>\n+                    </label>\n+                    <div>${setting_name}</div>`;\n+            }\n+            output += \"</div>\";\n         });\n+        return output;\n     }\n \n-    window.addEventListener(\"DOMContentLoaded\", setEvents);\n+    function buildSettingsPage(settings) {\n+        // First, we add the settings.css file.\n+        loadCss(\"settings\");\n+\n+        // Then we build the DOM.\n+        const el = document.createElement(\"section\");\n+        el.id = \"settings\";\n+        let innerHTML = `\n+            <div class=\"main-heading\">\n+                <h1 class=\"fqn\">\n+                    <span class=\"in-band\">Rustdoc settings</span>\n+                </h1>\n+                <span class=\"out-of-band\">`;\n+\n+        if (isSettingsPage) {\n+            innerHTML +=\n+                `<a id=\"back\" href=\"javascript:void(0)\" onclick=\"history.back();\">Back</a>`;\n+        } else {\n+            innerHTML +=\n+                `<a id=\"back\" href=\"javascript:void(0)\" onclick=\"switchDisplayedElement(null);\">\\\n+                    Back</a>`;\n+        }\n+        innerHTML += `</span>\n+            </div>\n+            <div class=\"settings\">${buildSettings(settings)}</div>`;\n+\n+        el.innerHTML = innerHTML;\n+\n+        if (isSettingsPage) {\n+            document.getElementById(MAIN_ID).appendChild(el);\n+        } else {\n+            getNotDisplayedElem().appendChild(el);\n+        }\n+        return el;\n+    }\n+\n+    function createSettingsPage() {\n+        const themes = getVar(\"themes\").split(\",\");\n+        const settings = [\n+            {\n+                \"name\": \"Use system theme\",\n+                \"js_name\": \"use-system-theme\",\n+                \"default\": true,\n+            },\n+            {\n+                \"name\": \"Theme\",\n+                \"js_name\": \"theme\",\n+                \"default\": \"light\",\n+                \"options\": themes,\n+            },\n+            {\n+                \"name\": \"Preferred dark theme\",\n+                \"js_name\": \"preferred-dark-theme\",\n+                \"default\": \"dark\",\n+                \"options\": themes,\n+            },\n+            {\n+                \"name\": \"Preferred light theme\",\n+                \"js_name\": \"preferred-light-theme\",\n+                \"default\": \"light\",\n+                \"options\": themes,\n+            },\n+            {\n+                \"name\": \"Auto-hide item contents for large items\",\n+                \"js_name\": \"auto-hide-large-items\",\n+                \"default\": true,\n+            },\n+            {\n+                \"name\": \"Auto-hide item methods' documentation\",\n+                \"js_name\": \"auto-hide-method-docs\",\n+                \"default\": false,\n+            },\n+            {\n+                \"name\": \"Auto-hide trait implementation documentation\",\n+                \"js_name\": \"auto-hide-trait-implementations\",\n+                \"default\": false,\n+            },\n+            {\n+                \"name\": \"Directly go to item in search if there is only one result\",\n+                \"js_name\": \"go-to-only-result\",\n+                \"default\": false,\n+            },\n+            {\n+                \"name\": \"Show line numbers on code examples\",\n+                \"js_name\": \"line-numbers\",\n+                \"default\": false,\n+            },\n+            {\n+                \"name\": \"Disable keyboard shortcuts\",\n+                \"js_name\": \"disable-shortcuts\",\n+                \"default\": false,\n+            },\n+        ];\n+\n+        return buildSettingsPage(settings);\n+    }\n+\n+    const settingsMenu = createSettingsPage();\n+\n+    if (isSettingsPage) {\n+        // We replace the existing \"onclick\" callback to do nothing if clicked.\n+        getSettingsButton().onclick = function(event) {\n+            event.preventDefault();\n+        };\n+    } else {\n+        // We replace the existing \"onclick\" callback.\n+        const settingsButton = getSettingsButton();\n+        settingsButton.onclick = function(event) {\n+            event.preventDefault();\n+            if (settingsMenu.parentElement.id === NOT_DISPLAYED_ID) {\n+                switchDisplayedElement(settingsMenu);\n+            } else {\n+                window.hideSettings();\n+            }\n+        };\n+        window.hideSettings = function() {\n+            switchDisplayedElement(null);\n+        };\n+    }\n+\n+    // We now wait a bit for the web browser to end re-computing the DOM...\n+    setTimeout(function() {\n+        setEvents(settingsMenu);\n+        // The setting menu is already displayed if we're on the settings page.\n+        if (!isSettingsPage) {\n+            switchDisplayedElement(settingsMenu);\n+        }\n+    }, 10);\n })();"}, {"sha": "6aee0da69f8de58898c71f97c40af9b817c8e2c0", "filename": "src/librustdoc/html/static/js/source-script.js", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/9625ed8be7fa66c3ee5f78180a3d5911817096f6/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsource-script.js", "raw_url": "https://github.com/rust-lang/rust/raw/9625ed8be7fa66c3ee5f78180a3d5911817096f6/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsource-script.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsource-script.js?ref=9625ed8be7fa66c3ee5f78180a3d5911817096f6", "patch": "@@ -6,7 +6,7 @@\n /* global search, sourcesIndex */\n \n // Local js definitions:\n-/* global addClass, getCurrentValue, hasClass, onEachLazy, removeClass, searchState */\n+/* global addClass, getCurrentValue, hasClass, onEachLazy, removeClass, browserSupportsHistoryApi */\n /* global updateLocalStorage */\n (function() {\n \n@@ -195,7 +195,7 @@ const handleSourceHighlight = (function() {\n     const set_fragment = function(name) {\n         const x = window.scrollX,\n             y = window.scrollY;\n-        if (searchState.browserSupportsHistoryApi()) {\n+        if (browserSupportsHistoryApi()) {\n             history.replaceState(null, null, \"#\" + name);\n             highlightSourceLines();\n         } else {"}, {"sha": "470cce93a5020fca5d4c8ea410e48b830eaa168f", "filename": "src/librustdoc/html/templates/page.html", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/9625ed8be7fa66c3ee5f78180a3d5911817096f6/src%2Flibrustdoc%2Fhtml%2Ftemplates%2Fpage.html", "raw_url": "https://github.com/rust-lang/rust/raw/9625ed8be7fa66c3ee5f78180a3d5911817096f6/src%2Flibrustdoc%2Fhtml%2Ftemplates%2Fpage.html", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Ftemplates%2Fpage.html?ref=9625ed8be7fa66c3ee5f78180a3d5911817096f6", "patch": "@@ -135,7 +135,6 @@ <h2 class=\"location\"></h2>\n                 </nav> {#- -#}\n             </div> {#- -#}\n             <section id=\"main-content\" class=\"content\">{{- content|safe -}}</section> {#- -#}\n-            <section id=\"search\" class=\"content hidden\"></section> {#- -#}\n         </div> {#- -#}\n     </main> {#- -#}\n     {{- layout.external_html.after_content|safe -}}"}]}