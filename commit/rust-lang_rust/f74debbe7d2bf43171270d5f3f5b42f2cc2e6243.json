{"sha": "f74debbe7d2bf43171270d5f3f5b42f2cc2e6243", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY3NGRlYmJlN2QyYmY0MzE3MTI3MGQ1ZjNmNWI0MmYyY2MyZTYyNDM=", "commit": {"author": {"name": "Mateusz Miku\u0142a", "email": "matti@marinelayer.io", "date": "2019-05-02T15:22:14Z"}, "committer": {"name": "Mateusz Miku\u0142a", "email": "mati865@gmail.com", "date": "2019-05-10T14:12:47Z"}, "message": "Make tests compatible with musl host", "tree": {"sha": "88f5daa4edb5816aff2bfe8b3cc6875d73bb83c4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/88f5daa4edb5816aff2bfe8b3cc6875d73bb83c4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f74debbe7d2bf43171270d5f3f5b42f2cc2e6243", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f74debbe7d2bf43171270d5f3f5b42f2cc2e6243", "html_url": "https://github.com/rust-lang/rust/commit/f74debbe7d2bf43171270d5f3f5b42f2cc2e6243", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f74debbe7d2bf43171270d5f3f5b42f2cc2e6243/comments", "author": {"login": "mati865", "id": 1174646, "node_id": "MDQ6VXNlcjExNzQ2NDY=", "avatar_url": "https://avatars.githubusercontent.com/u/1174646?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mati865", "html_url": "https://github.com/mati865", "followers_url": "https://api.github.com/users/mati865/followers", "following_url": "https://api.github.com/users/mati865/following{/other_user}", "gists_url": "https://api.github.com/users/mati865/gists{/gist_id}", "starred_url": "https://api.github.com/users/mati865/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mati865/subscriptions", "organizations_url": "https://api.github.com/users/mati865/orgs", "repos_url": "https://api.github.com/users/mati865/repos", "events_url": "https://api.github.com/users/mati865/events{/privacy}", "received_events_url": "https://api.github.com/users/mati865/received_events", "type": "User", "site_admin": false}, "committer": {"login": "mati865", "id": 1174646, "node_id": "MDQ6VXNlcjExNzQ2NDY=", "avatar_url": "https://avatars.githubusercontent.com/u/1174646?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mati865", "html_url": "https://github.com/mati865", "followers_url": "https://api.github.com/users/mati865/followers", "following_url": "https://api.github.com/users/mati865/following{/other_user}", "gists_url": "https://api.github.com/users/mati865/gists{/gist_id}", "starred_url": "https://api.github.com/users/mati865/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mati865/subscriptions", "organizations_url": "https://api.github.com/users/mati865/orgs", "repos_url": "https://api.github.com/users/mati865/repos", "events_url": "https://api.github.com/users/mati865/events{/privacy}", "received_events_url": "https://api.github.com/users/mati865/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0ac53da03dad79655e2f3e65a58f94a2f3314d5f", "url": "https://api.github.com/repos/rust-lang/rust/commits/0ac53da03dad79655e2f3e65a58f94a2f3314d5f", "html_url": "https://github.com/rust-lang/rust/commit/0ac53da03dad79655e2f3e65a58f94a2f3314d5f"}], "stats": {"total": 45, "additions": 37, "deletions": 8}, "files": [{"sha": "9867113e48f430c98fe89595afd7cd3cf01d2cb8", "filename": "src/bootstrap/test.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f74debbe7d2bf43171270d5f3f5b42f2cc2e6243/src%2Fbootstrap%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f74debbe7d2bf43171270d5f3f5b42f2cc2e6243/src%2Fbootstrap%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Ftest.rs?ref=f74debbe7d2bf43171270d5f3f5b42f2cc2e6243", "patch": "@@ -1870,6 +1870,10 @@ impl Step for CrateRustdoc {\n         cargo.arg(\"--\");\n         cargo.args(&builder.config.cmd.test_args());\n \n+        if self.host.contains(\"musl\") {\n+            cargo.arg(\"'-Ctarget-feature=-crt-static'\");\n+        }\n+\n         if !builder.config.verbose_tests {\n             cargo.arg(\"--quiet\");\n         }"}, {"sha": "bc3a3bd6fbc68e474f5598b42c4a85f30fc68cf9", "filename": "src/ci/docker/dist-x86_64-musl/Dockerfile", "status": "modified", "additions": 2, "deletions": 4, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/f74debbe7d2bf43171270d5f3f5b42f2cc2e6243/src%2Fci%2Fdocker%2Fdist-x86_64-musl%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/f74debbe7d2bf43171270d5f3f5b42f2cc2e6243/src%2Fci%2Fdocker%2Fdist-x86_64-musl%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-x86_64-musl%2FDockerfile?ref=f74debbe7d2bf43171270d5f3f5b42f2cc2e6243", "patch": "@@ -35,10 +35,7 @@ ENV RUST_CONFIGURE_ARGS \\\n       --enable-extended \\\n       --disable-docs \\\n       --set target.x86_64-unknown-linux-musl.crt-static=false \\\n-      --build $HOSTS \\\n-      --set target.x86_64-unknown-linux-musl.cc=x86_64-linux-musl-gcc \\\n-      --set target.x86_64-unknown-linux-musl.cxx=x86_64-linux-musl-g++ \\\n-      --set target.x86_64-unknown-linux-musl.linker=x86_64-linux-musl-gcc\n+      --build $HOSTS\n \n # Newer binutils broke things on some vms/distros (i.e., linking against\n # unknown relocs disabled by the following flag), so we need to go out of our\n@@ -49,4 +46,5 @@ ENV RUST_CONFIGURE_ARGS \\\n ENV CFLAGS_x86_64_unknown_linux_musl=\"-Wa,-mrelax-relocations=no -Wa,--compress-debug-sections=none \\\n     -Wl,--compress-debug-sections=none\"\n \n+# To run native tests replace `dist` below with `test`\n ENV SCRIPT python2.7 ../x.py dist --build $HOSTS"}, {"sha": "e132615738bac1a6187a9a0b3d2b8751c5300169", "filename": "src/ci/docker/scripts/musl-toolchain.sh", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/f74debbe7d2bf43171270d5f3f5b42f2cc2e6243/src%2Fci%2Fdocker%2Fscripts%2Fmusl-toolchain.sh", "raw_url": "https://github.com/rust-lang/rust/raw/f74debbe7d2bf43171270d5f3f5b42f2cc2e6243/src%2Fci%2Fdocker%2Fscripts%2Fmusl-toolchain.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fscripts%2Fmusl-toolchain.sh?ref=f74debbe7d2bf43171270d5f3f5b42f2cc2e6243", "patch": "@@ -45,6 +45,13 @@ cd -\n ln -s $OUTPUT/$TARGET/lib/libc.so /lib/ld-musl-$ARCH.so.1\n echo $OUTPUT/$TARGET/lib >> /etc/ld-musl-$ARCH.path\n \n+# Now when musl bootstraps itself create proper toolchain symlinks to make build and tests easier\n+for exec in cc gcc; do\n+    ln -s $TARGET-gcc /usr/local/bin/$exec\n+done\n+for exec in cpp c++ g++; do\n+    ln -s $TARGET-g++ /usr/local/bin/$exec\n+done\n \n export CC=$TARGET-gcc\n export CXX=$TARGET-g++"}, {"sha": "2701b4a593cc61926387912819c2f743549b0647", "filename": "src/test/run-make-fulldeps/link-cfg/Makefile", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f74debbe7d2bf43171270d5f3f5b42f2cc2e6243/src%2Ftest%2Frun-make-fulldeps%2Flink-cfg%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/f74debbe7d2bf43171270d5f3f5b42f2cc2e6243/src%2Ftest%2Frun-make-fulldeps%2Flink-cfg%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Flink-cfg%2FMakefile?ref=f74debbe7d2bf43171270d5f3f5b42f2cc2e6243", "patch": "@@ -2,7 +2,7 @@\n \n all: $(call DYLIB,return1) $(call DYLIB,return2) $(call NATIVE_STATICLIB,return3)\n \tls $(TMPDIR)\n-\t$(RUSTC) --print cfg --target x86_64-unknown-linux-musl | $(CGREP) crt-static\n+\t$(BARE_RUSTC) --print cfg --target x86_64-unknown-linux-musl | $(CGREP) crt-static\n \n \t$(RUSTC) no-deps.rs --cfg foo\n \t$(call RUN,no-deps)"}, {"sha": "b47ce17ec8baa2d64292a34532c86b1c15535631", "filename": "src/test/run-make-fulldeps/linker-output-non-utf8/Makefile", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f74debbe7d2bf43171270d5f3f5b42f2cc2e6243/src%2Ftest%2Frun-make-fulldeps%2Flinker-output-non-utf8%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/f74debbe7d2bf43171270d5f3f5b42f2cc2e6243/src%2Ftest%2Frun-make-fulldeps%2Flinker-output-non-utf8%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Flinker-output-non-utf8%2FMakefile?ref=f74debbe7d2bf43171270d5f3f5b42f2cc2e6243", "patch": "@@ -20,4 +20,4 @@ all:\n \t$(RUSTC) library.rs\n \tmkdir $(bad_dir)\n \tmv $(TMPDIR)/liblibrary.a $(bad_dir)\n-\tLIBRARY_PATH=$(bad_dir) $(RUSTC) exec.rs 2>&1 | $(CGREP) this_symbol_not_defined\n+\t$(RUSTC) -L $(bad_dir) exec.rs 2>&1 | $(CGREP) this_symbol_not_defined"}, {"sha": "a17ec212cfd58250f3185c1d2302c00bf9eb7e84", "filename": "src/test/run-make-fulldeps/reproducible-build/Makefile", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f74debbe7d2bf43171270d5f3f5b42f2cc2e6243/src%2Ftest%2Frun-make-fulldeps%2Freproducible-build%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/f74debbe7d2bf43171270d5f3f5b42f2cc2e6243/src%2Ftest%2Frun-make-fulldeps%2Freproducible-build%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Freproducible-build%2FMakefile?ref=f74debbe7d2bf43171270d5f3f5b42f2cc2e6243", "patch": "@@ -1,4 +1,8 @@\n -include ../tools.mk\n+\n+# ignore-musl\n+# Objects are reproducible but their path is not.\n+\n all:  \\\n \tsmoke \\\n \tdebug \\"}, {"sha": "a08a63fb44bf5cc2a4fbef39826150e3cc51d0a5", "filename": "src/test/run-make/rustc-macro-dep-files/Makefile", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/f74debbe7d2bf43171270d5f3f5b42f2cc2e6243/src%2Ftest%2Frun-make%2Frustc-macro-dep-files%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/f74debbe7d2bf43171270d5f3f5b42f2cc2e6243/src%2Ftest%2Frun-make%2Frustc-macro-dep-files%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Frustc-macro-dep-files%2FMakefile?ref=f74debbe7d2bf43171270d5f3f5b42f2cc2e6243", "patch": "@@ -2,7 +2,10 @@\n \n # FIXME(eddyb) provide `HOST_RUSTC` and `TARGET_RUSTC`\n # instead of hardcoding them everywhere they're needed.\n+ifeq ($(IS_MUSL_HOST),1)\n+ADDITIONAL_ARGS := $(RUSTFLAGS)\n+endif\n all:\n-\t$(BARE_RUSTC) foo.rs --out-dir $(TMPDIR)\n+\t$(BARE_RUSTC) $(ADDITIONAL_ARGS) foo.rs --out-dir $(TMPDIR)\n \t$(RUSTC) bar.rs --target $(TARGET) --emit dep-info\n \t$(CGREP) -v \"proc-macro source\" < $(TMPDIR)/bar.d"}, {"sha": "10b8133326bba2f798aa6c4506bb0687dbe5e804", "filename": "src/tools/compiletest/src/runtest.rs", "status": "modified", "additions": 14, "deletions": 1, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/f74debbe7d2bf43171270d5f3f5b42f2cc2e6243/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f74debbe7d2bf43171270d5f3f5b42f2cc2e6243/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs?ref=f74debbe7d2bf43171270d5f3f5b42f2cc2e6243", "patch": "@@ -1650,7 +1650,9 @@ impl<'test> TestCx<'test> {\n                 (true, None)\n             } else if self.config.target.contains(\"cloudabi\")\n                 || self.config.target.contains(\"emscripten\")\n-                || (self.config.target.contains(\"musl\") && !aux_props.force_host)\n+                || (self.config.target.contains(\"musl\")\n+                    && !aux_props.force_host\n+                    && !self.config.host.contains(\"musl\"))\n                 || self.config.target.contains(\"wasm32\")\n                 || self.config.target.contains(\"nvptx\")\n             {\n@@ -1932,6 +1934,11 @@ impl<'test> TestCx<'test> {\n             }\n         }\n \n+        // Use dynamic musl for tests because static doesn't allow creating dylibs\n+        if self.config.host.contains(\"musl\") {\n+            rustc.arg(\"-Ctarget-feature=-crt-static\");\n+        }\n+\n         rustc.args(&self.props.compile_flags);\n \n         rustc\n@@ -2725,6 +2732,12 @@ impl<'test> TestCx<'test> {\n         // compiler flags set in the test cases:\n         cmd.env_remove(\"RUSTFLAGS\");\n \n+        // Use dynamic musl for tests because static doesn't allow creating dylibs\n+        if self.config.host.contains(\"musl\") {\n+            cmd.env(\"RUSTFLAGS\", \"-Ctarget-feature=-crt-static\")\n+                .env(\"IS_MUSL_HOST\", \"1\");\n+        }\n+\n         if self.config.target.contains(\"msvc\") && self.config.cc != \"\" {\n             // We need to pass a path to `lib.exe`, so assume that `cc` is `cl.exe`\n             // and that `lib.exe` lives next to it."}]}