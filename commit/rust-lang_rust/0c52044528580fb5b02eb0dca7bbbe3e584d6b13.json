{"sha": "0c52044528580fb5b02eb0dca7bbbe3e584d6b13", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBjNTIwNDQ1Mjg1ODBmYjViMDJlYjBkY2E3YmJiZTNlNTg0ZDZiMTM=", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2020-11-15T19:51:25Z"}, "committer": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2020-11-15T19:57:20Z"}, "message": "Add test to ensure that no DOS backline (\\r\\n) doesn't create extra backline in source rendering", "tree": {"sha": "9e5745c1cc04aa78981ce299bd8102cf877f2b34", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9e5745c1cc04aa78981ce299bd8102cf877f2b34"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0c52044528580fb5b02eb0dca7bbbe3e584d6b13", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0c52044528580fb5b02eb0dca7bbbe3e584d6b13", "html_url": "https://github.com/rust-lang/rust/commit/0c52044528580fb5b02eb0dca7bbbe3e584d6b13", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0c52044528580fb5b02eb0dca7bbbe3e584d6b13/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1861a38ca9040c36741fb51f9b22f65228722b13", "url": "https://api.github.com/repos/rust-lang/rust/commits/1861a38ca9040c36741fb51f9b22f65228722b13", "html_url": "https://github.com/rust-lang/rust/commit/1861a38ca9040c36741fb51f9b22f65228722b13"}], "stats": {"total": 41, "additions": 27, "deletions": 14}, "files": [{"sha": "b5fe593dc0105112247db67ccc6c922899e1ba9c", "filename": "src/librustdoc/html/highlight.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/0c52044528580fb5b02eb0dca7bbbe3e584d6b13/src%2Flibrustdoc%2Fhtml%2Fhighlight.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0c52044528580fb5b02eb0dca7bbbe3e584d6b13/src%2Flibrustdoc%2Fhtml%2Fhighlight.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fhighlight.rs?ref=0c52044528580fb5b02eb0dca7bbbe3e584d6b13", "patch": "@@ -21,8 +21,6 @@ pub fn render_with_highlighting(\n     playground_button: Option<&str>,\n     tooltip: Option<(&str, &str)>,\n ) -> String {\n-    // This replace allows to fix how the code source with DOS backline characters is displayed.\n-    let src = src.replace(\"\\r\\n\", \"\\n\");\n     debug!(\"highlighting: ================\\n{}\\n==============\", src);\n     let mut out = String::with_capacity(src.len());\n     if let Some((tooltip, class)) = tooltip {\n@@ -48,7 +46,9 @@ fn write_header(out: &mut String, class: Option<&str>) {\n }\n \n fn write_code(out: &mut String, src: &str) {\n-    Classifier::new(src).highlight(&mut |highlight| {\n+    // This replace allows to fix how the code source with DOS backline characters is displayed.\n+    let src = src.replace(\"\\r\\n\", \"\\n\");\n+    Classifier::new(&src).highlight(&mut |highlight| {\n         match highlight {\n             Highlight::Token { text, class } => string(out, Escape(text), class),\n             Highlight::EnterSpan { class } => enter_span(out, class),"}, {"sha": "4400f85681d8a7d5110da6bbd205c0277223eb08", "filename": "src/librustdoc/html/highlight/fixtures/dos_line.html", "status": "added", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/0c52044528580fb5b02eb0dca7bbbe3e584d6b13/src%2Flibrustdoc%2Fhtml%2Fhighlight%2Ffixtures%2Fdos_line.html", "raw_url": "https://github.com/rust-lang/rust/raw/0c52044528580fb5b02eb0dca7bbbe3e584d6b13/src%2Flibrustdoc%2Fhtml%2Fhighlight%2Ffixtures%2Fdos_line.html", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fhighlight%2Ffixtures%2Fdos_line.html?ref=0c52044528580fb5b02eb0dca7bbbe3e584d6b13", "patch": "@@ -0,0 +1,3 @@\n+<span class=\"kw\">pub</span> <span class=\"kw\">fn</span> <span class=\"ident\">foo</span>() {\n+<span class=\"macro\">println</span><span class=\"macro\">!</span>(<span class=\"string\">&quot;foo&quot;</span>);\n+}"}, {"sha": "f57f52d6f087554ae57537cb98be73daa4f67663", "filename": "src/librustdoc/html/highlight/tests.rs", "status": "modified", "additions": 21, "deletions": 11, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/0c52044528580fb5b02eb0dca7bbbe3e584d6b13/src%2Flibrustdoc%2Fhtml%2Fhighlight%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0c52044528580fb5b02eb0dca7bbbe3e584d6b13/src%2Flibrustdoc%2Fhtml%2Fhighlight%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fhighlight%2Ftests.rs?ref=0c52044528580fb5b02eb0dca7bbbe3e584d6b13", "patch": "@@ -1,17 +1,6 @@\n use super::write_code;\n use expect_test::expect_file;\n \n-#[test]\n-fn test_html_highlighting() {\n-    let src = include_str!(\"fixtures/sample.rs\");\n-    let html = {\n-        let mut out = String::new();\n-        write_code(&mut out, src);\n-        format!(\"{}<pre><code>{}</code></pre>\\n\", STYLE, out)\n-    };\n-    expect_file![\"fixtures/sample.html\"].assert_eq(&html);\n-}\n-\n const STYLE: &str = r#\"\n <style>\n .kw { color: #8959A8; }\n@@ -23,3 +12,24 @@ const STYLE: &str = r#\"\n .question-mark { color: #ff9011; }\n </style>\n \"#;\n+\n+#[test]\n+fn test_html_highlighting() {\n+    let src = include_str!(\"fixtures/sample.rs\");\n+    let html = {\n+        let mut out = String::new();\n+        write_code(&mut out, src);\n+        format!(\"{}<pre><code>{}</code></pre>\\n\", STYLE, out)\n+    };\n+    expect_file![\"fixtures/sample.html\"].assert_eq(&html);\n+}\n+\n+#[test]\n+fn test_dos_backline() {\n+    let src = \"pub fn foo() {\\r\\n\\\n+    println!(\\\"foo\\\");\\r\\n\\\n+}\\r\\n\";\n+    let mut html = String::new();\n+    write_code(&mut html, src);\n+    expect_file![\"fixtures/dos_line.html\"].assert_eq(&html);\n+}"}]}