{"sha": "0aa15d048573d4fd0453e1da301857d7ca1faf7f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBhYTE1ZDA0ODU3M2Q0ZmQwNDUzZTFkYTMwMTg1N2Q3Y2ExZmFmN2Y=", "commit": {"author": {"name": "John K\u00e5re Alsaker", "email": "john.kare.alsaker@gmail.com", "date": "2020-03-16T18:17:40Z"}, "committer": {"name": "John K\u00e5re Alsaker", "email": "john.kare.alsaker@gmail.com", "date": "2020-03-21T19:12:55Z"}, "message": "Allow `hir().find` to return `None`", "tree": {"sha": "acfb928d6b943b9b8058e4247ed0d4ce67ed9a25", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/acfb928d6b943b9b8058e4247ed0d4ce67ed9a25"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0aa15d048573d4fd0453e1da301857d7ca1faf7f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0aa15d048573d4fd0453e1da301857d7ca1faf7f", "html_url": "https://github.com/rust-lang/rust/commit/0aa15d048573d4fd0453e1da301857d7ca1faf7f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0aa15d048573d4fd0453e1da301857d7ca1faf7f/comments", "author": {"login": "Zoxc", "id": 25784, "node_id": "MDQ6VXNlcjI1Nzg0", "avatar_url": "https://avatars.githubusercontent.com/u/25784?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Zoxc", "html_url": "https://github.com/Zoxc", "followers_url": "https://api.github.com/users/Zoxc/followers", "following_url": "https://api.github.com/users/Zoxc/following{/other_user}", "gists_url": "https://api.github.com/users/Zoxc/gists{/gist_id}", "starred_url": "https://api.github.com/users/Zoxc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Zoxc/subscriptions", "organizations_url": "https://api.github.com/users/Zoxc/orgs", "repos_url": "https://api.github.com/users/Zoxc/repos", "events_url": "https://api.github.com/users/Zoxc/events{/privacy}", "received_events_url": "https://api.github.com/users/Zoxc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Zoxc", "id": 25784, "node_id": "MDQ6VXNlcjI1Nzg0", "avatar_url": "https://avatars.githubusercontent.com/u/25784?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Zoxc", "html_url": "https://github.com/Zoxc", "followers_url": "https://api.github.com/users/Zoxc/followers", "following_url": "https://api.github.com/users/Zoxc/following{/other_user}", "gists_url": "https://api.github.com/users/Zoxc/gists{/gist_id}", "starred_url": "https://api.github.com/users/Zoxc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Zoxc/subscriptions", "organizations_url": "https://api.github.com/users/Zoxc/orgs", "repos_url": "https://api.github.com/users/Zoxc/repos", "events_url": "https://api.github.com/users/Zoxc/events{/privacy}", "received_events_url": "https://api.github.com/users/Zoxc/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7900b2bc135a0e02d945143176cf3a80b6e92aa8", "url": "https://api.github.com/repos/rust-lang/rust/commits/7900b2bc135a0e02d945143176cf3a80b6e92aa8", "html_url": "https://github.com/rust-lang/rust/commit/7900b2bc135a0e02d945143176cf3a80b6e92aa8"}], "stats": {"total": 75, "additions": 56, "deletions": 19}, "files": [{"sha": "49b7ce3445ba827901fc2cebdca8326e59307ccf", "filename": "src/librustc/hir/map/mod.rs", "status": "modified", "additions": 19, "deletions": 13, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/0aa15d048573d4fd0453e1da301857d7ca1faf7f/src%2Flibrustc%2Fhir%2Fmap%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0aa15d048573d4fd0453e1da301857d7ca1faf7f/src%2Flibrustc%2Fhir%2Fmap%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Fmap%2Fmod.rs?ref=0aa15d048573d4fd0453e1da301857d7ca1faf7f", "patch": "@@ -337,23 +337,28 @@ impl<'hir> Map<'hir> {\n     }\n \n     fn find_entry(&self, id: HirId) -> Option<Entry<'hir>> {\n-        Some(self.get_entry(id))\n-    }\n-\n-    fn get_entry(&self, id: HirId) -> Entry<'hir> {\n         if id.local_id == ItemLocalId::from_u32(0) {\n             let owner = self.tcx.hir_owner(id.owner);\n-            Entry { parent: owner.parent, node: owner.node }\n+            owner.map(|owner| Entry { parent: owner.parent, node: owner.node })\n         } else {\n             let owner = self.tcx.hir_owner_nodes(id.owner);\n-            let node = owner.nodes[id.local_id].as_ref().unwrap();\n-            // FIXME(eddyb) use a single generic type insted of having both\n-            // `Entry` and `ParentedNode`, which are effectively the same.\n-            // Alternatively, rewrite code using `Entry` to use `ParentedNode`.\n-            Entry { parent: HirId { owner: id.owner, local_id: node.parent }, node: node.node }\n+            owner.and_then(|owner| {\n+                let node = owner.nodes[id.local_id].as_ref();\n+                // FIXME(eddyb) use a single generic type insted of having both\n+                // `Entry` and `ParentedNode`, which are effectively the same.\n+                // Alternatively, rewrite code using `Entry` to use `ParentedNode`.\n+                node.map(|node| Entry {\n+                    parent: HirId { owner: id.owner, local_id: node.parent },\n+                    node: node.node,\n+                })\n+            })\n         }\n     }\n \n+    fn get_entry(&self, id: HirId) -> Entry<'hir> {\n+        self.find_entry(id).unwrap()\n+    }\n+\n     pub fn item(&self, id: HirId) -> &'hir Item<'hir> {\n         match self.find(id).unwrap() {\n             Node::Item(item) => item,\n@@ -376,7 +381,7 @@ impl<'hir> Map<'hir> {\n     }\n \n     pub fn body(&self, id: BodyId) -> &'hir Body<'hir> {\n-        self.tcx.hir_owner_nodes(id.hir_id.owner).bodies.get(&id.hir_id.local_id).unwrap()\n+        self.tcx.hir_owner_nodes(id.hir_id.owner).unwrap().bodies.get(&id.hir_id.local_id).unwrap()\n     }\n \n     pub fn fn_decl_by_hir_id(&self, hir_id: HirId) -> Option<&'hir FnDecl<'hir>> {\n@@ -536,8 +541,9 @@ impl<'hir> Map<'hir> {\n \n     /// Retrieves the `Node` corresponding to `id`, returning `None` if cannot be found.\n     pub fn find(&self, hir_id: HirId) -> Option<Node<'hir>> {\n-        let node = self.get_entry(hir_id).node;\n-        if let Node::Crate(..) = node { None } else { Some(node) }\n+        self.find_entry(hir_id).and_then(|entry| {\n+            if let Node::Crate(..) = entry.node { None } else { Some(entry.node) }\n+        })\n     }\n \n     /// Similar to `get_parent`; returns the parent HIR Id, or just `hir_id` if there"}, {"sha": "ce8e1f48daa77dcf5c0e925b90e743c3a7dca14b", "filename": "src/librustc/hir/mod.rs", "status": "modified", "additions": 3, "deletions": 4, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/0aa15d048573d4fd0453e1da301857d7ca1faf7f/src%2Flibrustc%2Fhir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0aa15d048573d4fd0453e1da301857d7ca1faf7f/src%2Flibrustc%2Fhir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Fmod.rs?ref=0aa15d048573d4fd0453e1da301857d7ca1faf7f", "patch": "@@ -78,9 +78,8 @@ pub fn provide(providers: &mut Providers<'_>) {\n         let module = hir.as_local_hir_id(id.to_def_id()).unwrap();\n         &tcx.untracked_crate.modules[&module]\n     };\n-    providers.hir_owner = |tcx, id| tcx.index_hir(LOCAL_CRATE).map[id].signature.unwrap();\n-    providers.hir_owner_nodes = |tcx, id| {\n-        tcx.index_hir(LOCAL_CRATE).map[id].with_bodies.as_ref().map(|nodes| &**nodes).unwrap()\n-    };\n+    providers.hir_owner = |tcx, id| tcx.index_hir(LOCAL_CRATE).map[id].signature;\n+    providers.hir_owner_nodes =\n+        |tcx, id| tcx.index_hir(LOCAL_CRATE).map[id].with_bodies.as_ref().map(|nodes| &**nodes);\n     map::provide(providers);\n }"}, {"sha": "54f5103f736ec07875cb2174d5176415dbf0e1e8", "filename": "src/librustc/query/mod.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/0aa15d048573d4fd0453e1da301857d7ca1faf7f/src%2Flibrustc%2Fquery%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0aa15d048573d4fd0453e1da301857d7ca1faf7f/src%2Flibrustc%2Fquery%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fquery%2Fmod.rs?ref=0aa15d048573d4fd0453e1da301857d7ca1faf7f", "patch": "@@ -76,7 +76,7 @@ rustc_queries! {\n         //\n         // This can be conveniently accessed by methods on `tcx.hir()`.\n         // Avoid calling this query directly.\n-        query hir_owner(key: LocalDefId) -> &'tcx crate::hir::Owner<'tcx> {\n+        query hir_owner(key: LocalDefId) -> Option<&'tcx crate::hir::Owner<'tcx>> {\n             eval_always\n             desc { |tcx| \"HIR owner of `{}`\", tcx.def_path_str(key.to_def_id()) }\n         }\n@@ -85,7 +85,7 @@ rustc_queries! {\n         //\n         // This can be conveniently accessed by methods on `tcx.hir()`.\n         // Avoid calling this query directly.\n-        query hir_owner_nodes(key: LocalDefId) -> &'tcx crate::hir::OwnerNodes<'tcx> {\n+        query hir_owner_nodes(key: LocalDefId) -> Option<&'tcx crate::hir::OwnerNodes<'tcx>> {\n             eval_always\n             desc { |tcx| \"HIR owner items in `{}`\", tcx.def_path_str(key.to_def_id()) }\n         }"}, {"sha": "22e42295eedf302a992441e24eb303f17c838c92", "filename": "src/test/ui/issues/issue-70041.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/0aa15d048573d4fd0453e1da301857d7ca1faf7f/src%2Ftest%2Fui%2Fissues%2Fissue-70041.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0aa15d048573d4fd0453e1da301857d7ca1faf7f/src%2Ftest%2Fui%2Fissues%2Fissue-70041.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-70041.rs?ref=0aa15d048573d4fd0453e1da301857d7ca1faf7f", "patch": "@@ -0,0 +1,13 @@\n+// compile-flags: --edition=2018\n+// run-pass\n+\n+macro_rules! regex {\n+    //~^ WARN unused macro definition\n+    () => {};\n+}\n+\n+#[allow(dead_code)]\n+use regex;\n+//~^ WARN unused import\n+\n+fn main() {}"}, {"sha": "b180175c5ab76a7a5750ea1cd0b94942d33bfff6", "filename": "src/test/ui/issues/issue-70041.stderr", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/0aa15d048573d4fd0453e1da301857d7ca1faf7f/src%2Ftest%2Fui%2Fissues%2Fissue-70041.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/0aa15d048573d4fd0453e1da301857d7ca1faf7f/src%2Ftest%2Fui%2Fissues%2Fissue-70041.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-70041.stderr?ref=0aa15d048573d4fd0453e1da301857d7ca1faf7f", "patch": "@@ -0,0 +1,19 @@\n+warning: unused macro definition\n+  --> $DIR/issue-70041.rs:4:1\n+   |\n+LL | / macro_rules! regex {\n+LL | |\n+LL | |     () => {};\n+LL | | }\n+   | |_^\n+   |\n+   = note: `#[warn(unused_macros)]` on by default\n+\n+warning: unused import: `regex`\n+  --> $DIR/issue-70041.rs:10:5\n+   |\n+LL | use regex;\n+   |     ^^^^^\n+   |\n+   = note: `#[warn(unused_imports)]` on by default\n+"}]}