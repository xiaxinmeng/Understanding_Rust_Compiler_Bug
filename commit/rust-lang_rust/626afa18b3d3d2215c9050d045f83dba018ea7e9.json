{"sha": "626afa18b3d3d2215c9050d045f83dba018ea7e9", "node_id": "C_kwDOAAsO6NoAKDYyNmFmYTE4YjNkM2QyMjE1YzkwNTBkMDQ1ZjgzZGJhMDE4ZWE3ZTk", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2021-11-30T08:29:07Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-11-30T08:29:07Z"}, "message": "Rollup merge of #91250 - rukai:remove_trailing_whitespace, r=wesleywiser\n\nRefactor EmitterWriter::emit_suggestion_default\n\nMakes progress towards https://github.com/rust-lang/rust/issues/89979\n\nSplit into 2 commits:\n* the first commit is purely a refactor and I verified that `./x.py test src/test/ui --stage 1` and  `./x.py test src/test/rustdoc-ui --stage 1` continue to pass on this commit.\n* ~~the second commit removes the empty trailing line from diff style suggestions.~~ - I discovered an issue with this so its just the refactor now.\n\nr? diagnostics", "tree": {"sha": "8ad55af67d7fd36169c8edc59ced337e03840cbe", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8ad55af67d7fd36169c8edc59ced337e03840cbe"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/626afa18b3d3d2215c9050d045f83dba018ea7e9", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhpeDTCRBK7hj4Ov3rIwAANLYIAD3ih7HGFHGkqPQcYPGKbKdG\nGgiliZnqNz6fKm4/pponFlsOLf9Ox7+MQJrKDITdfPFFIYHiysM5h6Z0JLonOj+V\nmVawKovq0SplZCLS4C905g3Q9MBqkT7RGeUVumqIUqwo3xCwdV9UaKdt5TV9XSLT\nKNqFC073z2mIN8zk6A0U5tECmuNxN6EVn8ur702AP1cuEo1F21Yuwacqrn1WH8vc\nYpqM9YmnlXUxuBGOxrDFs/KyP9CpLlw7yNzzKzzxopeI/py0vGoLwQghC99Nz19J\nEbg+pyIaf/DT+/kqgoi440d1nSA8j/BANMWMcoGt/TQxjyf1jHg2yTUYRfoVTYw=\n=5GjG\n-----END PGP SIGNATURE-----\n", "payload": "tree 8ad55af67d7fd36169c8edc59ced337e03840cbe\nparent 6e7cf2e88b96995ed85b6f9b81c178f08ad5107c\nparent df3e7a28f77170bcdb9d8860d6c4a06a7cdfbe20\nauthor Yuki Okushi <jtitor@2k36.org> 1638260947 +0900\ncommitter GitHub <noreply@github.com> 1638260947 +0900\n\nRollup merge of #91250 - rukai:remove_trailing_whitespace, r=wesleywiser\n\nRefactor EmitterWriter::emit_suggestion_default\n\nMakes progress towards https://github.com/rust-lang/rust/issues/89979\n\nSplit into 2 commits:\n* the first commit is purely a refactor and I verified that `./x.py test src/test/ui --stage 1` and  `./x.py test src/test/rustdoc-ui --stage 1` continue to pass on this commit.\n* ~~the second commit removes the empty trailing line from diff style suggestions.~~ - I discovered an issue with this so its just the refactor now.\n\nr? diagnostics\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/626afa18b3d3d2215c9050d045f83dba018ea7e9", "html_url": "https://github.com/rust-lang/rust/commit/626afa18b3d3d2215c9050d045f83dba018ea7e9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/626afa18b3d3d2215c9050d045f83dba018ea7e9/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6e7cf2e88b96995ed85b6f9b81c178f08ad5107c", "url": "https://api.github.com/repos/rust-lang/rust/commits/6e7cf2e88b96995ed85b6f9b81c178f08ad5107c", "html_url": "https://github.com/rust-lang/rust/commit/6e7cf2e88b96995ed85b6f9b81c178f08ad5107c"}, {"sha": "df3e7a28f77170bcdb9d8860d6c4a06a7cdfbe20", "url": "https://api.github.com/repos/rust-lang/rust/commits/df3e7a28f77170bcdb9d8860d6c4a06a7cdfbe20", "html_url": "https://github.com/rust-lang/rust/commit/df3e7a28f77170bcdb9d8860d6c4a06a7cdfbe20"}], "stats": {"total": 39, "additions": 25, "deletions": 14}, "files": [{"sha": "c04246a5022e88fa0892129df55849cae9d2af8e", "filename": "compiler/rustc_errors/src/emitter.rs", "status": "modified", "additions": 25, "deletions": 14, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/626afa18b3d3d2215c9050d045f83dba018ea7e9/compiler%2Frustc_errors%2Fsrc%2Femitter.rs", "raw_url": "https://github.com/rust-lang/rust/raw/626afa18b3d3d2215c9050d045f83dba018ea7e9/compiler%2Frustc_errors%2Fsrc%2Femitter.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_errors%2Fsrc%2Femitter.rs?ref=626afa18b3d3d2215c9050d045f83dba018ea7e9", "patch": "@@ -214,7 +214,7 @@ pub trait Emitter {\n \n     /// Formats the substitutions of the primary_span\n     ///\n-    /// The are a lot of conditions to this method, but in short:\n+    /// There are a lot of conditions to this method, but in short:\n     ///\n     /// * If the current `Diagnostic` has only one visible `CodeSuggestion`,\n     ///   we format the `help` suggestion depending on the content of the\n@@ -736,7 +736,9 @@ impl EmitterWriter {\n \n         let line_offset = buffer.num_lines();\n \n-        let left = margin.left(source_string.len()); // Left trim\n+        // Left trim\n+        let left = margin.left(source_string.len());\n+\n         // Account for unicode characters of width !=0 that were removed.\n         let left = source_string\n             .chars()\n@@ -1623,18 +1625,27 @@ impl EmitterWriter {\n             suggestions.iter().take(MAX_SUGGESTIONS)\n         {\n             notice_capitalization |= only_capitalization;\n-            // Only show underline if the suggestion spans a single line and doesn't cover the\n-            // entirety of the code output. If you have multiple replacements in the same line\n-            // of code, show the underline.\n-            let show_underline = !(parts.len() == 1 && parts[0].snippet.trim() == complete.trim())\n-                && complete.lines().count() == 1;\n \n             let has_deletion = parts.iter().any(|p| p.is_deletion());\n             let is_multiline = complete.lines().count() > 1;\n \n-            let show_diff = has_deletion && !is_multiline;\n+            enum DisplaySuggestion {\n+                Underline,\n+                Diff,\n+                None,\n+            }\n+\n+            let show_code_change = if has_deletion && !is_multiline {\n+                DisplaySuggestion::Diff\n+            } else if (parts.len() != 1 || parts[0].snippet.trim() != complete.trim())\n+                && !is_multiline\n+            {\n+                DisplaySuggestion::Underline\n+            } else {\n+                DisplaySuggestion::None\n+            };\n \n-            if show_diff {\n+            if let DisplaySuggestion::Diff = show_code_change {\n                 row_num += 1;\n             }\n \n@@ -1657,7 +1668,7 @@ impl EmitterWriter {\n                     &self.maybe_anonymized(line_start + line_pos),\n                     Style::LineNumber,\n                 );\n-                if show_diff {\n+                if let DisplaySuggestion::Diff = show_code_change {\n                     // Add the line number for both addition and removal to drive the point home.\n                     //\n                     // N - fn foo<A: T>(bar: A) {\n@@ -1727,7 +1738,7 @@ impl EmitterWriter {\n             let mut offsets: Vec<(usize, isize)> = Vec::new();\n             // Only show an underline in the suggestions if the suggestion is not the\n             // entirety of the code being shown and the displayed code is not multiline.\n-            if show_underline {\n+            if let DisplaySuggestion::Diff | DisplaySuggestion::Underline = show_code_change {\n                 draw_col_separator(&mut buffer, row_num, max_line_num_len + 1);\n                 for part in parts {\n                     let span_start_pos = sm.lookup_char_pos(part.span.lo()).col_display;\n@@ -1755,7 +1766,7 @@ impl EmitterWriter {\n                     assert!(underline_start >= 0 && underline_end >= 0);\n                     let padding: usize = max_line_num_len + 3;\n                     for p in underline_start..underline_end {\n-                        if !show_diff {\n+                        if let DisplaySuggestion::Underline = show_code_change {\n                             // If this is a replacement, underline with `^`, if this is an addition\n                             // underline with `+`.\n                             buffer.putc(\n@@ -1766,7 +1777,7 @@ impl EmitterWriter {\n                             );\n                         }\n                     }\n-                    if show_diff {\n+                    if let DisplaySuggestion::Diff = show_code_change {\n                         // Colorize removal with red in diff format.\n                         buffer.set_style_range(\n                             row_num - 2,\n@@ -1797,7 +1808,7 @@ impl EmitterWriter {\n             // if we elided some lines, add an ellipsis\n             if lines.next().is_some() {\n                 buffer.puts(row_num, max_line_num_len - 1, \"...\", Style::LineNumber);\n-            } else if !show_underline {\n+            } else if let DisplaySuggestion::None = show_code_change {\n                 draw_col_separator_no_space(&mut buffer, row_num, max_line_num_len + 1);\n                 row_num += 1;\n             }"}]}