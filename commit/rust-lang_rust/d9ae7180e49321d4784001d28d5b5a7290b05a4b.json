{"sha": "d9ae7180e49321d4784001d28d5b5a7290b05a4b", "node_id": "C_kwDOAAsO6NoAKGQ5YWU3MTgwZTQ5MzIxZDQ3ODQwMDFkMjhkNWI1YTcyOTBiMDVhNGI", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-06-11T16:38:28Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-06-11T16:38:28Z"}, "message": "Rollup merge of #112513 - compiler-errors:dont-compute-box-span-for-tait, r=cjgillot\n\nDont compute `opt_suggest_box_span` span for TAIT\n\nFixes #112434\n\nAlso a couple more commits on top, pruning some dead code and fixing another weird suggestion encountered in the above issue.", "tree": {"sha": "4ec89a9edbf16a8473d9a8e78c4509cb0a0db149", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4ec89a9edbf16a8473d9a8e78c4509cb0a0db149"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d9ae7180e49321d4784001d28d5b5a7290b05a4b", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkhfiECRBK7hj4Ov3rIwAAO08IAK93tFMS8vs8RSp43M1a+p+7\nbtzNTROTRr/zvK77ulwL15tKAzpIBPoGmMwyX2wZ4Q1F2sdLkFizbBPegvJ6AkVf\nsayxGmbKIHJsj4+zgGzQukWPGK4EwXX6GnTTq2TdITnxn0K3Yvy6o88c2rHFper5\n9N4gzsVHEbStzCu4wmc8tZM8ASBsm42eKCm31Fog1O6DxhN1KhVtvK6txMMrnb1i\nLQ3NcqAq4jmg8AfEEWQ8mr+eYIDRc4TdbziUNCtvgJUkaEsYIHgmJvvAb7t8QyFo\nDECSj/NqJ9rXKbd1Ngg/TxZSOW8XiW33rIeg1GeGHTTjUhcwo4EXKsOpmubbHvc=\n=RqJU\n-----END PGP SIGNATURE-----\n", "payload": "tree 4ec89a9edbf16a8473d9a8e78c4509cb0a0db149\nparent 733617bd16e35a26d048a089d2a927511f4a3097\nparent d80440263c3eb083a91335ab14bee76bcb9988d1\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1686501508 +0200\ncommitter GitHub <noreply@github.com> 1686501508 +0200\n\nRollup merge of #112513 - compiler-errors:dont-compute-box-span-for-tait, r=cjgillot\n\nDont compute `opt_suggest_box_span` span for TAIT\n\nFixes #112434\n\nAlso a couple more commits on top, pruning some dead code and fixing another weird suggestion encountered in the above issue.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d9ae7180e49321d4784001d28d5b5a7290b05a4b", "html_url": "https://github.com/rust-lang/rust/commit/d9ae7180e49321d4784001d28d5b5a7290b05a4b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d9ae7180e49321d4784001d28d5b5a7290b05a4b/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "733617bd16e35a26d048a089d2a927511f4a3097", "url": "https://api.github.com/repos/rust-lang/rust/commits/733617bd16e35a26d048a089d2a927511f4a3097", "html_url": "https://github.com/rust-lang/rust/commit/733617bd16e35a26d048a089d2a927511f4a3097"}, {"sha": "d80440263c3eb083a91335ab14bee76bcb9988d1", "url": "https://api.github.com/repos/rust-lang/rust/commits/d80440263c3eb083a91335ab14bee76bcb9988d1", "html_url": "https://github.com/rust-lang/rust/commit/d80440263c3eb083a91335ab14bee76bcb9988d1"}], "stats": {"total": 166, "additions": 56, "deletions": 110}, "files": [{"sha": "444ff90595c2318e5102cb4b72bc374a37f514d0", "filename": "compiler/rustc_hir_typeck/src/_match.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/d9ae7180e49321d4784001d28d5b5a7290b05a4b/compiler%2Frustc_hir_typeck%2Fsrc%2F_match.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9ae7180e49321d4784001d28d5b5a7290b05a4b/compiler%2Frustc_hir_typeck%2Fsrc%2F_match.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2F_match.rs?ref=d9ae7180e49321d4784001d28d5b5a7290b05a4b", "patch": "@@ -510,6 +510,14 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                     ..\n                 } = self.type_var_origin(expected)? else { return None; };\n \n+                let Some(rpit_local_def_id) = rpit_def_id.as_local() else { return None; };\n+                if !matches!(\n+                    self.tcx.hir().expect_item(rpit_local_def_id).expect_opaque_ty().origin,\n+                    hir::OpaqueTyOrigin::FnReturn(..)\n+                ) {\n+                    return None;\n+                }\n+\n                 let sig = self.body_fn_sig()?;\n \n                 let substs = sig.output().walk().find_map(|arg| {"}, {"sha": "79157eae7ed6d9d4f235904f56b9f55687bf328c", "filename": "compiler/rustc_hir_typeck/src/coercion.rs", "status": "modified", "additions": 4, "deletions": 109, "changes": 113, "blob_url": "https://github.com/rust-lang/rust/blob/d9ae7180e49321d4784001d28d5b5a7290b05a4b/compiler%2Frustc_hir_typeck%2Fsrc%2Fcoercion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9ae7180e49321d4784001d28d5b5a7290b05a4b/compiler%2Frustc_hir_typeck%2Fsrc%2Fcoercion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Fcoercion.rs?ref=d9ae7180e49321d4784001d28d5b5a7290b05a4b", "patch": "@@ -36,9 +36,7 @@\n //! ```\n \n use crate::FnCtxt;\n-use rustc_errors::{\n-    struct_span_err, Applicability, Diagnostic, DiagnosticBuilder, ErrorGuaranteed, MultiSpan,\n-};\n+use rustc_errors::{struct_span_err, Diagnostic, DiagnosticBuilder, ErrorGuaranteed, MultiSpan};\n use rustc_hir as hir;\n use rustc_hir::def_id::DefId;\n use rustc_hir::intravisit::{self, Visitor};\n@@ -58,7 +56,7 @@ use rustc_middle::ty::visit::TypeVisitableExt;\n use rustc_middle::ty::{self, Ty, TypeAndMut};\n use rustc_session::parse::feature_err;\n use rustc_span::symbol::sym;\n-use rustc_span::{self, BytePos, DesugaringKind, Span};\n+use rustc_span::{self, DesugaringKind};\n use rustc_target::spec::abi::Abi;\n use rustc_trait_selection::infer::InferCtxtExt as _;\n use rustc_trait_selection::traits::error_reporting::TypeErrCtxtExt as _;\n@@ -1702,9 +1700,6 @@ impl<'tcx, 'exprs, E: AsCoercionSite> CoerceMany<'tcx, 'exprs, E> {\n     ) -> DiagnosticBuilder<'a, ErrorGuaranteed> {\n         let mut err = fcx.err_ctxt().report_mismatched_types(cause, expected, found, ty_err);\n \n-        let mut pointing_at_return_type = false;\n-        let mut fn_output = None;\n-\n         let parent_id = fcx.tcx.hir().parent_id(id);\n         let parent = fcx.tcx.hir().get(parent_id);\n         if let Some(expr) = expression\n@@ -1717,7 +1712,7 @@ impl<'tcx, 'exprs, E: AsCoercionSite> CoerceMany<'tcx, 'exprs, E> {\n         // label pointing out the cause for the type coercion will be wrong\n         // as prior return coercions would not be relevant (#57664).\n         let fn_decl = if let (Some(expr), Some(blk_id)) = (expression, blk_id) {\n-            pointing_at_return_type =\n+            let pointing_at_return_type =\n                 fcx.suggest_mismatched_types_on_tail(&mut err, expr, expected, found, blk_id);\n             if let (Some(cond_expr), true, false) = (\n                 fcx.tcx.hir().get_if_cause(expr.hir_id),\n@@ -1749,7 +1744,7 @@ impl<'tcx, 'exprs, E: AsCoercionSite> CoerceMany<'tcx, 'exprs, E> {\n \n         if let Some((fn_id, fn_decl, can_suggest)) = fn_decl {\n             if blk_id.is_none() {\n-                pointing_at_return_type |= fcx.suggest_missing_return_type(\n+                fcx.suggest_missing_return_type(\n                     &mut err,\n                     &fn_decl,\n                     expected,\n@@ -1758,9 +1753,6 @@ impl<'tcx, 'exprs, E: AsCoercionSite> CoerceMany<'tcx, 'exprs, E> {\n                     fn_id,\n                 );\n             }\n-            if !pointing_at_return_type {\n-                fn_output = Some(&fn_decl.output); // `impl Trait` return type\n-            }\n         }\n \n         let parent_id = fcx.tcx.hir().get_parent_item(id);\n@@ -1795,106 +1787,9 @@ impl<'tcx, 'exprs, E: AsCoercionSite> CoerceMany<'tcx, 'exprs, E> {\n             );\n         }\n \n-        if let (Some(sp), Some(fn_output)) = (ret_coercion_span, fn_output) {\n-            self.add_impl_trait_explanation(&mut err, cause, fcx, expected, sp, fn_output);\n-        }\n-\n         err\n     }\n \n-    fn add_impl_trait_explanation<'a>(\n-        &self,\n-        err: &mut Diagnostic,\n-        cause: &ObligationCause<'tcx>,\n-        fcx: &FnCtxt<'a, 'tcx>,\n-        expected: Ty<'tcx>,\n-        sp: Span,\n-        fn_output: &hir::FnRetTy<'_>,\n-    ) {\n-        let return_sp = fn_output.span();\n-        err.span_label(return_sp, \"expected because this return type...\");\n-        err.span_label(\n-            sp,\n-            format!(\"...is found to be `{}` here\", fcx.resolve_vars_with_obligations(expected)),\n-        );\n-        let impl_trait_msg = \"for information on `impl Trait`, see \\\n-                <https://doc.rust-lang.org/book/ch10-02-traits.html\\\n-                #returning-types-that-implement-traits>\";\n-        let trait_obj_msg = \"for information on trait objects, see \\\n-                <https://doc.rust-lang.org/book/ch17-02-trait-objects.html\\\n-                #using-trait-objects-that-allow-for-values-of-different-types>\";\n-        err.note(\"to return `impl Trait`, all returned values must be of the same type\");\n-        err.note(impl_trait_msg);\n-        let snippet = fcx\n-            .tcx\n-            .sess\n-            .source_map()\n-            .span_to_snippet(return_sp)\n-            .unwrap_or_else(|_| \"dyn Trait\".to_string());\n-        let mut snippet_iter = snippet.split_whitespace();\n-        let has_impl = snippet_iter.next().is_some_and(|s| s == \"impl\");\n-        // Only suggest `Box<dyn Trait>` if `Trait` in `impl Trait` is object safe.\n-        let mut is_object_safe = false;\n-        if let hir::FnRetTy::Return(ty) = fn_output\n-            // Get the return type.\n-            && let hir::TyKind::OpaqueDef(..) = ty.kind\n-        {\n-            let ty = fcx.astconv().ast_ty_to_ty( ty);\n-            // Get the `impl Trait`'s `DefId`.\n-            if let ty::Alias(ty::Opaque, ty::AliasTy { def_id, .. }) = ty.kind()\n-                // Get the `impl Trait`'s `Item` so that we can get its trait bounds and\n-                // get the `Trait`'s `DefId`.\n-                && let hir::ItemKind::OpaqueTy(hir::OpaqueTy { bounds, .. }) =\n-                    fcx.tcx.hir().expect_item(def_id.expect_local()).kind\n-            {\n-                // Are of this `impl Trait`'s traits object safe?\n-                is_object_safe = bounds.iter().all(|bound| {\n-                    bound\n-                        .trait_ref()\n-                        .and_then(|t| t.trait_def_id())\n-                        .is_some_and(|def_id| {\n-                            fcx.tcx.check_is_object_safe(def_id)\n-                        })\n-                })\n-            }\n-        };\n-        if has_impl {\n-            if is_object_safe {\n-                err.multipart_suggestion(\n-                    \"you could change the return type to be a boxed trait object\",\n-                    vec![\n-                        (return_sp.with_hi(return_sp.lo() + BytePos(4)), \"Box<dyn\".to_string()),\n-                        (return_sp.shrink_to_hi(), \">\".to_string()),\n-                    ],\n-                    Applicability::MachineApplicable,\n-                );\n-                let sugg = [sp, cause.span]\n-                    .into_iter()\n-                    .flat_map(|sp| {\n-                        [\n-                            (sp.shrink_to_lo(), \"Box::new(\".to_string()),\n-                            (sp.shrink_to_hi(), \")\".to_string()),\n-                        ]\n-                        .into_iter()\n-                    })\n-                    .collect::<Vec<_>>();\n-                err.multipart_suggestion(\n-                    \"if you change the return type to expect trait objects, box the returned \\\n-                     expressions\",\n-                    sugg,\n-                    Applicability::MaybeIncorrect,\n-                );\n-            } else {\n-                err.help(format!(\n-                    \"if the trait `{}` were object safe, you could return a boxed trait object\",\n-                    &snippet[5..]\n-                ));\n-            }\n-            err.note(trait_obj_msg);\n-        }\n-        err.help(\"you could instead create a new `enum` with a variant for each returned type\");\n-    }\n-\n     /// Checks whether the return type is unsized via an obligation, which makes\n     /// sure we consider `dyn Trait: Sized` where clauses, which are trivially\n     /// false but technically valid for typeck."}, {"sha": "3e4812e7ca995d4553089c2d316e1e9952c48519", "filename": "compiler/rustc_infer/src/infer/error_reporting/mod.rs", "status": "modified", "additions": 19, "deletions": 1, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/d9ae7180e49321d4784001d28d5b5a7290b05a4b/compiler%2Frustc_infer%2Fsrc%2Finfer%2Ferror_reporting%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9ae7180e49321d4784001d28d5b5a7290b05a4b/compiler%2Frustc_infer%2Fsrc%2Finfer%2Ferror_reporting%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_infer%2Fsrc%2Finfer%2Ferror_reporting%2Fmod.rs?ref=d9ae7180e49321d4784001d28d5b5a7290b05a4b", "patch": "@@ -847,7 +847,25 @@ impl<'tcx> TypeErrCtxt<'_, 'tcx> {\n                 ) {\n                     err.subdiagnostic(subdiag);\n                 }\n-                if let Some(ret_sp) = opt_suggest_box_span {\n+                // don't suggest wrapping either blocks in `if .. {} else {}`\n+                let is_empty_arm = |id| {\n+                    let hir::Node::Block(blk) = self.tcx.hir().get(id)\n+                    else {\n+                        return false;\n+                    };\n+                    if blk.expr.is_some() || !blk.stmts.is_empty() {\n+                        return false;\n+                    }\n+                    let Some((_, hir::Node::Expr(expr))) = self.tcx.hir().parent_iter(id).nth(1)\n+                    else {\n+                        return false;\n+                    };\n+                    matches!(expr.kind, hir::ExprKind::If(..))\n+                };\n+                if let Some(ret_sp) = opt_suggest_box_span\n+                    && !is_empty_arm(then_id)\n+                    && !is_empty_arm(else_id)\n+                {\n                     self.suggest_boxing_for_return_impl_trait(\n                         err,\n                         ret_sp,"}, {"sha": "befd768b1818a6322d9b170107a889d2319b89ec", "filename": "tests/ui/impl-trait/dont-suggest-box-on-empty-else-arm.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/d9ae7180e49321d4784001d28d5b5a7290b05a4b/tests%2Fui%2Fimpl-trait%2Fdont-suggest-box-on-empty-else-arm.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d9ae7180e49321d4784001d28d5b5a7290b05a4b/tests%2Fui%2Fimpl-trait%2Fdont-suggest-box-on-empty-else-arm.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fimpl-trait%2Fdont-suggest-box-on-empty-else-arm.rs?ref=d9ae7180e49321d4784001d28d5b5a7290b05a4b", "patch": "@@ -0,0 +1,9 @@\n+fn test() -> impl std::fmt::Debug {\n+    if true {\n+        \"boo2\"\n+    } else {\n+        //~^ ERROR `if` and `else` have incompatible types\n+    }\n+}\n+\n+fn main() {}"}, {"sha": "9b63911da7aa35489c3557fa058dab8c79cb6da7", "filename": "tests/ui/impl-trait/dont-suggest-box-on-empty-else-arm.stderr", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/d9ae7180e49321d4784001d28d5b5a7290b05a4b/tests%2Fui%2Fimpl-trait%2Fdont-suggest-box-on-empty-else-arm.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d9ae7180e49321d4784001d28d5b5a7290b05a4b/tests%2Fui%2Fimpl-trait%2Fdont-suggest-box-on-empty-else-arm.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fimpl-trait%2Fdont-suggest-box-on-empty-else-arm.stderr?ref=d9ae7180e49321d4784001d28d5b5a7290b05a4b", "patch": "@@ -0,0 +1,16 @@\n+error[E0308]: `if` and `else` have incompatible types\n+  --> $DIR/dont-suggest-box-on-empty-else-arm.rs:4:12\n+   |\n+LL |       if true {\n+   |       ------- `if` and `else` have incompatible types\n+LL |           \"boo2\"\n+   |           ------ expected because of this\n+LL |       } else {\n+   |  ____________^\n+LL | |\n+LL | |     }\n+   | |_____^ expected `&str`, found `()`\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0308`."}]}