{"sha": "d32f3fe14ecab069ceebe73063061f6aef05c217", "node_id": "C_kwDOAAsO6NoAKGQzMmYzZmUxNGVjYWIwNjljZWViZTczMDYzMDYxZjZhZWYwNWMyMTc", "commit": {"author": {"name": "Eric Holk", "email": "ericholk@microsoft.com", "date": "2023-01-10T01:07:52Z"}, "committer": {"name": "Eric Holk", "email": "ericholk@microsoft.com", "date": "2023-01-12T19:58:32Z"}, "message": "[drop tracking] Visit break expressions\n\nThis fixes #102383 by remembering to visit the expression in\n`break expr` when building the drop tracking CFG. Missing this step was\ncausing an off-by-one error which meant after a number of awaits we'd be\nlooking for dropped values at the wrong point in the code.\n\nAdditionally, this changes the order of traversal for assignment\nexpressions to visit the rhs and then the lhs. This matches what is done\nelsewhere.", "tree": {"sha": "50cba6041a1f5ec2cc4d590e249abafb636e5eaf", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/50cba6041a1f5ec2cc4d590e249abafb636e5eaf"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d32f3fe14ecab069ceebe73063061f6aef05c217", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d32f3fe14ecab069ceebe73063061f6aef05c217", "html_url": "https://github.com/rust-lang/rust/commit/d32f3fe14ecab069ceebe73063061f6aef05c217", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d32f3fe14ecab069ceebe73063061f6aef05c217/comments", "author": {"login": "eholk", "id": 105766, "node_id": "MDQ6VXNlcjEwNTc2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/105766?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eholk", "html_url": "https://github.com/eholk", "followers_url": "https://api.github.com/users/eholk/followers", "following_url": "https://api.github.com/users/eholk/following{/other_user}", "gists_url": "https://api.github.com/users/eholk/gists{/gist_id}", "starred_url": "https://api.github.com/users/eholk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eholk/subscriptions", "organizations_url": "https://api.github.com/users/eholk/orgs", "repos_url": "https://api.github.com/users/eholk/repos", "events_url": "https://api.github.com/users/eholk/events{/privacy}", "received_events_url": "https://api.github.com/users/eholk/received_events", "type": "User", "site_admin": false}, "committer": {"login": "eholk", "id": 105766, "node_id": "MDQ6VXNlcjEwNTc2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/105766?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eholk", "html_url": "https://github.com/eholk", "followers_url": "https://api.github.com/users/eholk/followers", "following_url": "https://api.github.com/users/eholk/following{/other_user}", "gists_url": "https://api.github.com/users/eholk/gists{/gist_id}", "starred_url": "https://api.github.com/users/eholk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eholk/subscriptions", "organizations_url": "https://api.github.com/users/eholk/orgs", "repos_url": "https://api.github.com/users/eholk/repos", "events_url": "https://api.github.com/users/eholk/events{/privacy}", "received_events_url": "https://api.github.com/users/eholk/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "96de375e6773836e47c69fd23e55c77c509a5419", "url": "https://api.github.com/repos/rust-lang/rust/commits/96de375e6773836e47c69fd23e55c77c509a5419", "html_url": "https://github.com/rust-lang/rust/commit/96de375e6773836e47c69fd23e55c77c509a5419"}], "stats": {"total": 52, "additions": 40, "deletions": 12}, "files": [{"sha": "b3dd3031db2a98d75780d00288364133be6041f4", "filename": "compiler/rustc_hir_typeck/src/generator_interior/drop_ranges/cfg_build.rs", "status": "modified", "additions": 17, "deletions": 4, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/d32f3fe14ecab069ceebe73063061f6aef05c217/compiler%2Frustc_hir_typeck%2Fsrc%2Fgenerator_interior%2Fdrop_ranges%2Fcfg_build.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d32f3fe14ecab069ceebe73063061f6aef05c217/compiler%2Frustc_hir_typeck%2Fsrc%2Fgenerator_interior%2Fdrop_ranges%2Fcfg_build.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Fgenerator_interior%2Fdrop_ranges%2Fcfg_build.rs?ref=d32f3fe14ecab069ceebe73063061f6aef05c217", "patch": "@@ -304,8 +304,8 @@ impl<'a, 'tcx> Visitor<'tcx> for DropRangeVisitor<'a, 'tcx> {\n         let mut reinit = None;\n         match expr.kind {\n             ExprKind::Assign(lhs, rhs, _) => {\n-                self.visit_expr(lhs);\n                 self.visit_expr(rhs);\n+                self.visit_expr(lhs);\n \n                 reinit = Some(lhs);\n             }\n@@ -433,7 +433,7 @@ impl<'a, 'tcx> Visitor<'tcx> for DropRangeVisitor<'a, 'tcx> {\n                     self.drop_ranges.add_control_edge(self.expr_index, *target)\n                 }),\n \n-            ExprKind::Break(destination, ..) => {\n+            ExprKind::Break(destination, value) => {\n                 // destination either points to an expression or to a block. We use\n                 // find_target_expression_from_destination to use the last expression of the block\n                 // if destination points to a block.\n@@ -443,7 +443,11 @@ impl<'a, 'tcx> Visitor<'tcx> for DropRangeVisitor<'a, 'tcx> {\n                 // will refer to the end of the block due to the post order traversal.\n                 self.find_target_expression_from_destination(destination).map_or((), |target| {\n                     self.drop_ranges.add_control_edge_hir_id(self.expr_index, target)\n-                })\n+                });\n+\n+                if let Some(value) = value {\n+                    self.visit_expr(value);\n+                }\n             }\n \n             ExprKind::Call(f, args) => {\n@@ -465,6 +469,12 @@ impl<'a, 'tcx> Visitor<'tcx> for DropRangeVisitor<'a, 'tcx> {\n \n             ExprKind::AddrOf(..)\n             | ExprKind::Array(..)\n+            // FIXME(eholk): We probably need special handling for AssignOps. The ScopeTree builder\n+            // in region.rs runs both lhs then rhs and rhs then lhs and then sets all yields to be\n+            // the latest they show up in either traversal. With the older scope-based\n+            // approximation, this was fine, but it's probably not right now. What we probably want\n+            // to do instead is still run both orders, but consider anything that showed up as a\n+            // yield in either order.\n             | ExprKind::AssignOp(..)\n             | ExprKind::Binary(..)\n             | ExprKind::Block(..)\n@@ -502,6 +512,9 @@ impl<'a, 'tcx> Visitor<'tcx> for DropRangeVisitor<'a, 'tcx> {\n \n         // Increment expr_count here to match what InteriorVisitor expects.\n         self.expr_index = self.expr_index + 1;\n+\n+        // Save a node mapping to get better CFG visualization\n+        self.drop_ranges.add_node_mapping(pat.hir_id, self.expr_index);\n     }\n }\n \n@@ -521,7 +534,7 @@ impl DropRangesBuilder {\n                 }\n             });\n         }\n-        debug!(\"hir_id_map: {:?}\", tracked_value_map);\n+        debug!(\"hir_id_map: {:#?}\", tracked_value_map);\n         let num_values = tracked_value_map.len();\n         Self {\n             tracked_value_map,"}, {"sha": "e8d31be79d9c9fccff6d6722db6cadf044cbb7a8", "filename": "compiler/rustc_hir_typeck/src/generator_interior/drop_ranges/cfg_visualize.rs", "status": "modified", "additions": 9, "deletions": 4, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/d32f3fe14ecab069ceebe73063061f6aef05c217/compiler%2Frustc_hir_typeck%2Fsrc%2Fgenerator_interior%2Fdrop_ranges%2Fcfg_visualize.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d32f3fe14ecab069ceebe73063061f6aef05c217/compiler%2Frustc_hir_typeck%2Fsrc%2Fgenerator_interior%2Fdrop_ranges%2Fcfg_visualize.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Fgenerator_interior%2Fdrop_ranges%2Fcfg_visualize.rs?ref=d32f3fe14ecab069ceebe73063061f6aef05c217", "patch": "@@ -2,6 +2,7 @@\n //! flow graph when needed for debugging.\n \n use rustc_graphviz as dot;\n+use rustc_hir::{Expr, ExprKind, Node};\n use rustc_middle::ty::TyCtxt;\n \n use super::{DropRangesBuilder, PostOrderId};\n@@ -80,10 +81,14 @@ impl<'a> dot::Labeller<'a> for DropRangesGraph<'_, '_> {\n                     .post_order_map\n                     .iter()\n                     .find(|(_hir_id, &post_order_id)| post_order_id == *n)\n-                    .map_or(\"<unknown>\".into(), |(hir_id, _)| self\n-                        .tcx\n-                        .hir()\n-                        .node_to_string(*hir_id))\n+                    .map_or(\"<unknown>\".into(), |(hir_id, _)| format!(\n+                        \"{}{}\",\n+                        self.tcx.hir().node_to_string(*hir_id),\n+                        match self.tcx.hir().find(*hir_id) {\n+                            Some(Node::Expr(Expr { kind: ExprKind::Yield(..), .. })) => \" (yield)\",\n+                            _ => \"\",\n+                        }\n+                    ))\n             )\n             .into(),\n         )"}, {"sha": "7af5260538568c0d873ad2767cdbb903e5a6517e", "filename": "compiler/rustc_hir_typeck/src/generator_interior/mod.rs", "status": "modified", "additions": 14, "deletions": 4, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/d32f3fe14ecab069ceebe73063061f6aef05c217/compiler%2Frustc_hir_typeck%2Fsrc%2Fgenerator_interior%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d32f3fe14ecab069ceebe73063061f6aef05c217/compiler%2Frustc_hir_typeck%2Fsrc%2Fgenerator_interior%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Fgenerator_interior%2Fmod.rs?ref=d32f3fe14ecab069ceebe73063061f6aef05c217", "patch": "@@ -71,10 +71,8 @@ impl<'a, 'tcx> InteriorVisitor<'a, 'tcx> {\n                                 yield_data.expr_and_pat_count, self.expr_count, source_span\n                             );\n \n-                            if self.fcx.sess().opts.unstable_opts.drop_tracking\n-                                && self\n-                                    .drop_ranges\n-                                    .is_dropped_at(hir_id, yield_data.expr_and_pat_count)\n+                            if self\n+                                .is_dropped_at_yield_location(hir_id, yield_data.expr_and_pat_count)\n                             {\n                                 debug!(\"value is dropped at yield point; not recording\");\n                                 return false;\n@@ -173,6 +171,18 @@ impl<'a, 'tcx> InteriorVisitor<'a, 'tcx> {\n             }\n         }\n     }\n+\n+    /// If drop tracking is enabled, consult drop_ranges to see if a value is\n+    /// known to be dropped at a yield point and therefore can be omitted from\n+    /// the generator witness.\n+    fn is_dropped_at_yield_location(&self, value_hir_id: HirId, yield_location: usize) -> bool {\n+        // short-circuit if drop tracking is not enabled.\n+        if !self.fcx.sess().opts.unstable_opts.drop_tracking {\n+            return false;\n+        }\n+\n+        self.drop_ranges.is_dropped_at(value_hir_id, yield_location)\n+    }\n }\n \n pub fn resolve_interior<'a, 'tcx>("}]}