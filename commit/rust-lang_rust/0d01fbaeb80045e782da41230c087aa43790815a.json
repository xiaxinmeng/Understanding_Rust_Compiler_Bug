{"sha": "0d01fbaeb80045e782da41230c087aa43790815a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBkMDFmYmFlYjgwMDQ1ZTc4MmRhNDEyMzBjMDg3YWE0Mzc5MDgxNWE=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-04-01T15:29:51Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-04-01T15:29:51Z"}, "message": "Rollup merge of #58919 - estebank:impl-trait-return-lifetime, r=pnkfelix\n\nSuggest using anonymous lifetime in `impl Trait` return\n\nFix #48467.\n\nr? @nikomatsakis", "tree": {"sha": "a8164680bfd03ea97edd318dbf723e50dcc601a4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a8164680bfd03ea97edd318dbf723e50dcc601a4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0d01fbaeb80045e782da41230c087aa43790815a", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJcoi5wCRBK7hj4Ov3rIwAAdHIIAIGUAJOQnrx6pY1r/rwJpCqY\nLqOehS9O29L4dTZ1tMlXetn2ehCHuqhETUrpmEkOx9Y2Zwi/N8/eynH9Xb1GUSM+\nBhxQ8QVkyPKtB4WfiCYAc/2nul86A4On6brzlbn6mmfq5TtQMng2ddldOK5zm2tW\nBelmPxVeomZREWAF2OXyadwUov1KweKnWtqq/zgo8riNJTgrZHCYFlTOVzIq8CLE\nJ69gH3IAVKtM9kS+s2NIAYHQhqrrkni2/PXQph9MY0PpxUBFzmq0OlM1hGDuK0iU\nf3rAbQruv48w3Jq3sNkgi9jEEdHWlp7TR6hlTBA9E/qzbE2x3U4ZqGTIOTXJ+ek=\n=wAQE\n-----END PGP SIGNATURE-----\n", "payload": "tree a8164680bfd03ea97edd318dbf723e50dcc601a4\nparent 9f9529acd54f82c7bf6008cd486513414a650a5f\nparent 30c247f881a87e40aed30983d4c923efb6148f9b\nauthor Mazdak Farrokhzad <twingoow@gmail.com> 1554132591 +0200\ncommitter GitHub <noreply@github.com> 1554132591 +0200\n\nRollup merge of #58919 - estebank:impl-trait-return-lifetime, r=pnkfelix\n\nSuggest using anonymous lifetime in `impl Trait` return\n\nFix #48467.\n\nr? @nikomatsakis\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0d01fbaeb80045e782da41230c087aa43790815a", "html_url": "https://github.com/rust-lang/rust/commit/0d01fbaeb80045e782da41230c087aa43790815a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0d01fbaeb80045e782da41230c087aa43790815a/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9f9529acd54f82c7bf6008cd486513414a650a5f", "url": "https://api.github.com/repos/rust-lang/rust/commits/9f9529acd54f82c7bf6008cd486513414a650a5f", "html_url": "https://github.com/rust-lang/rust/commit/9f9529acd54f82c7bf6008cd486513414a650a5f"}, {"sha": "30c247f881a87e40aed30983d4c923efb6148f9b", "url": "https://api.github.com/repos/rust-lang/rust/commits/30c247f881a87e40aed30983d4c923efb6148f9b", "html_url": "https://github.com/rust-lang/rust/commit/30c247f881a87e40aed30983d4c923efb6148f9b"}], "stats": {"total": 67, "additions": 48, "deletions": 19}, "files": [{"sha": "7403a5d7dbb09e80219a9441da7b95c3abf2a222", "filename": "src/librustc/infer/error_reporting/nice_region_error/named_anon_conflict.rs", "status": "modified", "additions": 17, "deletions": 8, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/0d01fbaeb80045e782da41230c087aa43790815a/src%2Flibrustc%2Finfer%2Ferror_reporting%2Fnice_region_error%2Fnamed_anon_conflict.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0d01fbaeb80045e782da41230c087aa43790815a/src%2Flibrustc%2Finfer%2Ferror_reporting%2Fnice_region_error%2Fnamed_anon_conflict.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Finfer%2Ferror_reporting%2Fnice_region_error%2Fnamed_anon_conflict.rs?ref=0d01fbaeb80045e782da41230c087aa43790815a", "patch": "@@ -1,6 +1,7 @@\n //! Error Reporting for Anonymous Region Lifetime Errors\n //! where one region is named and the other is anonymous.\n use crate::infer::error_reporting::nice_region_error::NiceRegionError;\n+use crate::hir::{FunctionRetTy, TyKind};\n use crate::ty;\n use errors::{Applicability, DiagnosticBuilder};\n \n@@ -11,9 +12,10 @@ impl<'a, 'gcx, 'tcx> NiceRegionError<'a, 'gcx, 'tcx> {\n         let (span, sub, sup) = self.get_regions();\n \n         debug!(\n-            \"try_report_named_anon_conflict(sub={:?}, sup={:?})\",\n+            \"try_report_named_anon_conflict(sub={:?}, sup={:?}, error={:?})\",\n             sub,\n-            sup\n+            sup,\n+            self.error,\n         );\n \n         // Determine whether the sub and sup consist of one named region ('a)\n@@ -84,6 +86,13 @@ impl<'a, 'gcx, 'tcx> NiceRegionError<'a, 'gcx, 'tcx> {\n             {\n                 return None;\n             }\n+            if let FunctionRetTy::Return(ty) = &fndecl.output {\n+                if let (TyKind::Def(_, _), ty::ReStatic) = (&ty.node, sub) {\n+                    // This is an impl Trait return that evaluates de need of 'static.\n+                    // We handle this case better in `static_impl_trait`.\n+                    return None;\n+                }\n+            }\n         }\n \n         let (error_var, span_label_var) = if let Some(simple_ident) = arg.pat.simple_ident() {\n@@ -103,13 +112,13 @@ impl<'a, 'gcx, 'tcx> NiceRegionError<'a, 'gcx, 'tcx> {\n             error_var\n         );\n \n+        diag.span_label(span, format!(\"lifetime `{}` required\", named));\n         diag.span_suggestion(\n-                new_ty_span,\n-                &format!(\"add explicit lifetime `{}` to {}\", named, span_label_var),\n-                new_ty.to_string(),\n-                Applicability::Unspecified,\n-            )\n-            .span_label(span, format!(\"lifetime `{}` required\", named));\n+            new_ty_span,\n+            &format!(\"add explicit lifetime `{}` to {}\", named, span_label_var),\n+            new_ty.to_string(),\n+            Applicability::Unspecified,\n+        );\n \n         Some(diag)\n     }"}, {"sha": "3773f1a40c7924545878b83ec8b7dc0c03a4370d", "filename": "src/librustc_mir/borrow_check/nll/region_infer/error_reporting/mod.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/0d01fbaeb80045e782da41230c087aa43790815a/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Fregion_infer%2Ferror_reporting%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0d01fbaeb80045e782da41230c087aa43790815a/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Fregion_infer%2Ferror_reporting%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Fregion_infer%2Ferror_reporting%2Fmod.rs?ref=0d01fbaeb80045e782da41230c087aa43790815a", "patch": "@@ -132,6 +132,15 @@ impl<'tcx> RegionInferenceContext<'tcx> {\n             }\n         });\n         if let Some(i) = best_choice {\n+            if let Some(next) = categorized_path.get(i + 1) {\n+                if categorized_path[i].0 == ConstraintCategory::Return\n+                    && next.0 == ConstraintCategory::OpaqueType\n+                {\n+                    // The return expression is being influenced by the return type being\n+                    // impl Trait, point at the return type and not the return expr.\n+                    return *next;\n+                }\n+            }\n             return categorized_path[i];\n         }\n \n@@ -240,6 +249,7 @@ impl<'tcx> RegionInferenceContext<'tcx> {\n             self.provides_universal_region(r, fr, outlived_fr)\n         });\n \n+        debug!(\"report_error: category={:?} {:?}\", category, span);\n         // Check if we can use one of the \"nice region errors\".\n         if let (Some(f), Some(o)) = (self.to_error_region(fr), self.to_error_region(outlived_fr)) {\n             let tables = infcx.tcx.typeck_tables_of(mir_def_id);"}, {"sha": "1c3b5ac76138f2eb56f25c2effda0fb28a494d14", "filename": "src/test/ui/impl-trait/must_outlive_least_region_or_bound.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0d01fbaeb80045e782da41230c087aa43790815a/src%2Ftest%2Fui%2Fimpl-trait%2Fmust_outlive_least_region_or_bound.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0d01fbaeb80045e782da41230c087aa43790815a/src%2Ftest%2Fui%2Fimpl-trait%2Fmust_outlive_least_region_or_bound.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fimpl-trait%2Fmust_outlive_least_region_or_bound.rs?ref=0d01fbaeb80045e782da41230c087aa43790815a", "patch": "@@ -1,7 +1,7 @@\n use std::fmt::Debug;\n \n fn elided(x: &i32) -> impl Copy { x }\n-//~^ ERROR explicit lifetime required in the type of `x` [E0621]\n+//~^ ERROR cannot infer an appropriate lifetime\n \n fn explicit<'a>(x: &'a i32) -> impl Copy { x }\n //~^ ERROR cannot infer an appropriate lifetime"}, {"sha": "9339a83b09a9df8388a63cfc8e7a33bf3bb5227f", "filename": "src/test/ui/impl-trait/must_outlive_least_region_or_bound.stderr", "status": "modified", "additions": 16, "deletions": 6, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/0d01fbaeb80045e782da41230c087aa43790815a/src%2Ftest%2Fui%2Fimpl-trait%2Fmust_outlive_least_region_or_bound.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/0d01fbaeb80045e782da41230c087aa43790815a/src%2Ftest%2Fui%2Fimpl-trait%2Fmust_outlive_least_region_or_bound.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fimpl-trait%2Fmust_outlive_least_region_or_bound.stderr?ref=0d01fbaeb80045e782da41230c087aa43790815a", "patch": "@@ -1,10 +1,20 @@\n-error[E0621]: explicit lifetime required in the type of `x`\n-  --> $DIR/must_outlive_least_region_or_bound.rs:3:23\n+error: cannot infer an appropriate lifetime\n+  --> $DIR/must_outlive_least_region_or_bound.rs:3:35\n    |\n LL | fn elided(x: &i32) -> impl Copy { x }\n-   |              ----     ^^^^^^^^^ lifetime `'static` required\n-   |              |\n-   |              help: add explicit lifetime `'static` to the type of `x`: `&'static i32`\n+   |                       ---------   ^ ...but this borrow...\n+   |                       |\n+   |                       this return type evaluates to the `'static` lifetime...\n+   |\n+note: ...can't outlive the anonymous lifetime #1 defined on the function body at 3:1\n+  --> $DIR/must_outlive_least_region_or_bound.rs:3:1\n+   |\n+LL | fn elided(x: &i32) -> impl Copy { x }\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+help: you can add a constraint to the return type to make it last less than `'static` and match the anonymous lifetime #1 defined on the function body at 3:1\n+   |\n+LL | fn elided(x: &i32) -> impl Copy + '_ { x }\n+   |                       ^^^^^^^^^^^^^^\n \n error: cannot infer an appropriate lifetime\n   --> $DIR/must_outlive_least_region_or_bound.rs:6:44\n@@ -67,5 +77,5 @@ LL | fn ty_param_wont_outlive_static<T:Debug>(x: T) -> impl Debug + 'static {\n \n error: aborting due to 5 previous errors\n \n-Some errors occurred: E0310, E0621, E0623.\n+Some errors occurred: E0310, E0623.\n For more information about an error, try `rustc --explain E0310`."}, {"sha": "bcdf643c0b9d1136001d98643105630f55fe0231", "filename": "src/test/ui/nll/ty-outlives/impl-trait-captures.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0d01fbaeb80045e782da41230c087aa43790815a/src%2Ftest%2Fui%2Fnll%2Fty-outlives%2Fimpl-trait-captures.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0d01fbaeb80045e782da41230c087aa43790815a/src%2Ftest%2Fui%2Fnll%2Fty-outlives%2Fimpl-trait-captures.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fnll%2Fty-outlives%2Fimpl-trait-captures.rs?ref=0d01fbaeb80045e782da41230c087aa43790815a", "patch": "@@ -8,8 +8,8 @@ trait Foo<'a> {\n impl<'a, T> Foo<'a> for T { }\n \n fn foo<'a, T>(x: &T) -> impl Foo<'a> {\n+//~^ ERROR explicit lifetime required in the type of `x` [E0621]\n     x\n-        //~^ ERROR explicit lifetime required in the type of `x` [E0621]\n }\n \n fn main() {}"}, {"sha": "3a1e3ce3ad1a0d3a539b60618d939688e2a6b65e", "filename": "src/test/ui/nll/ty-outlives/impl-trait-captures.stderr", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/0d01fbaeb80045e782da41230c087aa43790815a/src%2Ftest%2Fui%2Fnll%2Fty-outlives%2Fimpl-trait-captures.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/0d01fbaeb80045e782da41230c087aa43790815a/src%2Ftest%2Fui%2Fnll%2Fty-outlives%2Fimpl-trait-captures.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fnll%2Fty-outlives%2Fimpl-trait-captures.stderr?ref=0d01fbaeb80045e782da41230c087aa43790815a", "patch": "@@ -1,8 +1,8 @@\n error[E0621]: explicit lifetime required in the type of `x`\n-  --> $DIR/impl-trait-captures.rs:11:5\n+  --> $DIR/impl-trait-captures.rs:10:25\n    |\n-LL |     x\n-   |     ^ lifetime `ReEarlyBound(0, 'a)` required\n+LL | fn foo<'a, T>(x: &T) -> impl Foo<'a> {\n+   |                         ^^^^^^^^^^^^ lifetime `ReEarlyBound(0, 'a)` required\n help: add explicit lifetime `ReEarlyBound(0, 'a)` to the type of `x`\n    |\n LL | fn foo<'a, T>(x: &ReEarlyBound(0, 'a) T) -> impl Foo<'a> {"}]}