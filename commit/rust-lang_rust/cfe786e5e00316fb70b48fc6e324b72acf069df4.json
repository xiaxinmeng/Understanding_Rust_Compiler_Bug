{"sha": "cfe786e5e00316fb70b48fc6e324b72acf069df4", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNmZTc4NmU1ZTAwMzE2ZmI3MGI0OGZjNmUzMjRiNzJhY2YwNjlkZjQ=", "commit": {"author": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2021-03-06T12:55:20Z"}, "committer": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2021-03-30T16:10:06Z"}, "message": "Fix tests.\n\nAvoid invoking queries inside `check_paths`, since we are holding a lock\nto the reconstructed graph.", "tree": {"sha": "74464ecfb4e789981ad77b8cf37291242f584138", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/74464ecfb4e789981ad77b8cf37291242f584138"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cfe786e5e00316fb70b48fc6e324b72acf069df4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cfe786e5e00316fb70b48fc6e324b72acf069df4", "html_url": "https://github.com/rust-lang/rust/commit/cfe786e5e00316fb70b48fc6e324b72acf069df4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cfe786e5e00316fb70b48fc6e324b72acf069df4/comments", "author": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "39b306a53db513c754d5e8d60fc2691829209131", "url": "https://api.github.com/repos/rust-lang/rust/commits/39b306a53db513c754d5e8d60fc2691829209131", "html_url": "https://github.com/rust-lang/rust/commit/39b306a53db513c754d5e8d60fc2691829209131"}], "stats": {"total": 44, "additions": 30, "deletions": 14}, "files": [{"sha": "0fe3748e38630342fc281649a570f38ff52ffd58", "filename": "compiler/rustc_query_system/src/dep_graph/query.rs", "status": "modified", "additions": 13, "deletions": 4, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/cfe786e5e00316fb70b48fc6e324b72acf069df4/compiler%2Frustc_query_system%2Fsrc%2Fdep_graph%2Fquery.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cfe786e5e00316fb70b48fc6e324b72acf069df4/compiler%2Frustc_query_system%2Fsrc%2Fdep_graph%2Fquery.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_query_system%2Fsrc%2Fdep_graph%2Fquery.rs?ref=cfe786e5e00316fb70b48fc6e324b72acf069df4", "patch": "@@ -1,11 +1,13 @@\n use rustc_data_structures::fx::FxHashMap;\n use rustc_data_structures::graph::implementation::{Direction, Graph, NodeIndex, INCOMING};\n+use rustc_index::vec::IndexVec;\n \n use super::{DepKind, DepNode, DepNodeIndex};\n \n pub struct DepGraphQuery<K> {\n     pub graph: Graph<DepNode<K>, ()>,\n     pub indices: FxHashMap<DepNode<K>, NodeIndex>,\n+    pub dep_index_to_index: IndexVec<DepNodeIndex, Option<NodeIndex>>,\n }\n \n impl<K: DepKind> DepGraphQuery<K> {\n@@ -15,18 +17,25 @@ impl<K: DepKind> DepGraphQuery<K> {\n \n         let graph = Graph::with_capacity(node_count, edge_count);\n         let indices = FxHashMap::default();\n+        let dep_index_to_index = IndexVec::new();\n \n-        DepGraphQuery { graph, indices }\n+        DepGraphQuery { graph, indices, dep_index_to_index }\n     }\n \n     pub fn push(&mut self, index: DepNodeIndex, node: DepNode<K>, edges: &[DepNodeIndex]) {\n         let source = self.graph.add_node(node);\n-        debug_assert_eq!(index.index(), source.0);\n+        if index.index() >= self.dep_index_to_index.len() {\n+            self.dep_index_to_index.resize(index.index() + 1, None);\n+        }\n+        self.dep_index_to_index[index] = Some(source);\n         self.indices.insert(node, source);\n \n         for &target in edges.iter() {\n-            let target = NodeIndex(target.index());\n-            self.graph.add_edge(source, target, ());\n+            let target = self.dep_index_to_index[target];\n+            // Skip missing edges.\n+            if let Some(target) = target {\n+                self.graph.add_edge(source, target, ());\n+            }\n         }\n     }\n "}, {"sha": "6a3cc215a0b3c540719a205d0aadba6b82da9ac2", "filename": "compiler/rustc_query_system/src/dep_graph/serialized.rs", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/cfe786e5e00316fb70b48fc6e324b72acf069df4/compiler%2Frustc_query_system%2Fsrc%2Fdep_graph%2Fserialized.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cfe786e5e00316fb70b48fc6e324b72acf069df4/compiler%2Frustc_query_system%2Fsrc%2Fdep_graph%2Fserialized.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_query_system%2Fsrc%2Fdep_graph%2Fserialized.rs?ref=cfe786e5e00316fb70b48fc6e324b72acf069df4", "patch": "@@ -144,7 +144,14 @@ fn encode_node<K: DepKind>(\n ) -> FileEncodeResult {\n     #[cfg(debug_assertions)]\n     if let Some(record_graph) = &_record_graph {\n-        record_graph.lock().push(_index, node.node, &node.edges);\n+        if let Some(record_graph) = &mut if cfg!(parallel_compiler) {\n+            Some(record_graph.lock())\n+        } else {\n+            // Do not ICE when a query is called from within `with_query`.\n+            record_graph.try_lock()\n+        } {\n+            record_graph.push(_index, node.node, &node.edges);\n+        }\n     }\n \n     if let Some(record_stats) = &record_stats {"}, {"sha": "5313d1715c4835574c22bcddf63ff88cba76510c", "filename": "src/test/ui/async-await/issues/issue-64964.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cfe786e5e00316fb70b48fc6e324b72acf069df4/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fissue-64964.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cfe786e5e00316fb70b48fc6e324b72acf069df4/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fissue-64964.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fissues%2Fissue-64964.rs?ref=cfe786e5e00316fb70b48fc6e324b72acf069df4", "patch": "@@ -1,5 +1,5 @@\n // check-pass\n-// compile-flags: -Z query-dep-graph\n+// compile-flags: -Z query-dep-graph -C incremental=tmp/issue-64964\n // edition:2018\n \n // Regression test for ICE related to `await`ing in a method + incr. comp. (#64964)"}, {"sha": "a0ee3ad31e6976f2899f146405ee5ba5454f69d8", "filename": "src/test/ui/dep-graph/dep-graph-assoc-type-codegen.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cfe786e5e00316fb70b48fc6e324b72acf069df4/src%2Ftest%2Fui%2Fdep-graph%2Fdep-graph-assoc-type-codegen.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cfe786e5e00316fb70b48fc6e324b72acf069df4/src%2Ftest%2Fui%2Fdep-graph%2Fdep-graph-assoc-type-codegen.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fdep-graph%2Fdep-graph-assoc-type-codegen.rs?ref=cfe786e5e00316fb70b48fc6e324b72acf069df4", "patch": "@@ -1,7 +1,7 @@\n // Test that when a trait impl changes, fns whose body uses that trait\n // must also be recompiled.\n \n-// compile-flags: -Z query-dep-graph\n+// compile-flags: -Z query-dep-graph -C incremental=tmp/dep-graph-assoc-type-codegen\n \n #![feature(rustc_attrs)]\n #![allow(warnings)]"}, {"sha": "c95ea53650b479b78abbc6dd1344366089d43178", "filename": "src/test/ui/dep-graph/dep-graph-caller-callee.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cfe786e5e00316fb70b48fc6e324b72acf069df4/src%2Ftest%2Fui%2Fdep-graph%2Fdep-graph-caller-callee.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cfe786e5e00316fb70b48fc6e324b72acf069df4/src%2Ftest%2Fui%2Fdep-graph%2Fdep-graph-caller-callee.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fdep-graph%2Fdep-graph-caller-callee.rs?ref=cfe786e5e00316fb70b48fc6e324b72acf069df4", "patch": "@@ -1,7 +1,7 @@\n // Test that immediate callers have to change when callee changes, but\n // not callers' callers.\n \n-// compile-flags: -Z query-dep-graph\n+// compile-flags: -Z query-dep-graph -C incremental=tmp/dep-graph-caller-callee\n \n #![feature(rustc_attrs)]\n #![allow(dead_code)]"}, {"sha": "50a670b87723826eacd976d93747d085f243f894", "filename": "src/test/ui/dep-graph/dep-graph-struct-signature.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cfe786e5e00316fb70b48fc6e324b72acf069df4/src%2Ftest%2Fui%2Fdep-graph%2Fdep-graph-struct-signature.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cfe786e5e00316fb70b48fc6e324b72acf069df4/src%2Ftest%2Fui%2Fdep-graph%2Fdep-graph-struct-signature.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fdep-graph%2Fdep-graph-struct-signature.rs?ref=cfe786e5e00316fb70b48fc6e324b72acf069df4", "patch": "@@ -1,7 +1,7 @@\n // Test cases where a changing struct appears in the signature of fns\n // and methods.\n \n-// compile-flags: -Z query-dep-graph\n+// compile-flags: -Z query-dep-graph -C incremental=tmp/dep-graph-struct-signature\n \n #![feature(rustc_attrs)]\n #![allow(dead_code)]"}, {"sha": "c0a6617316b8dc9994c991cc5a9e52175262a32a", "filename": "src/test/ui/dep-graph/dep-graph-trait-impl-two-traits-same-method.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cfe786e5e00316fb70b48fc6e324b72acf069df4/src%2Ftest%2Fui%2Fdep-graph%2Fdep-graph-trait-impl-two-traits-same-method.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cfe786e5e00316fb70b48fc6e324b72acf069df4/src%2Ftest%2Fui%2Fdep-graph%2Fdep-graph-trait-impl-two-traits-same-method.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fdep-graph%2Fdep-graph-trait-impl-two-traits-same-method.rs?ref=cfe786e5e00316fb70b48fc6e324b72acf069df4", "patch": "@@ -1,7 +1,7 @@\n // Test that adding an impl to a trait `Foo` DOES affect functions\n // that only use `Bar` if they have methods in common.\n \n-// compile-flags: -Z query-dep-graph\n+// compile-flags: -Z query-dep-graph -C incremental=tmp/dep-graph-trait-impl-two-traits-same-method\n \n #![feature(rustc_attrs)]\n #![allow(dead_code)]"}, {"sha": "56e9762ddb26c1740b55ee185748175e31b97d7c", "filename": "src/test/ui/dep-graph/dep-graph-trait-impl-two-traits.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cfe786e5e00316fb70b48fc6e324b72acf069df4/src%2Ftest%2Fui%2Fdep-graph%2Fdep-graph-trait-impl-two-traits.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cfe786e5e00316fb70b48fc6e324b72acf069df4/src%2Ftest%2Fui%2Fdep-graph%2Fdep-graph-trait-impl-two-traits.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fdep-graph%2Fdep-graph-trait-impl-two-traits.rs?ref=cfe786e5e00316fb70b48fc6e324b72acf069df4", "patch": "@@ -1,7 +1,7 @@\n // Test that adding an impl to a trait `Foo` does not affect functions\n // that only use `Bar`, so long as they do not have methods in common.\n \n-// compile-flags: -Z query-dep-graph\n+// compile-flags: -Z query-dep-graph -C incremental=tmp/dep-graph-trait-impl-two-traits\n \n #![feature(rustc_attrs)]\n #![allow(warnings)]"}, {"sha": "3bbe3e745ca691c7ad266f3946996b82a4ca642a", "filename": "src/test/ui/dep-graph/dep-graph-trait-impl.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cfe786e5e00316fb70b48fc6e324b72acf069df4/src%2Ftest%2Fui%2Fdep-graph%2Fdep-graph-trait-impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cfe786e5e00316fb70b48fc6e324b72acf069df4/src%2Ftest%2Fui%2Fdep-graph%2Fdep-graph-trait-impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fdep-graph%2Fdep-graph-trait-impl.rs?ref=cfe786e5e00316fb70b48fc6e324b72acf069df4", "patch": "@@ -1,7 +1,7 @@\n // Test that when a trait impl changes, fns whose body uses that trait\n // must also be recompiled.\n \n-// compile-flags: -Z query-dep-graph\n+// compile-flags: -Z query-dep-graph -C incremental=tmp/dep-graph-trait-impl\n \n #![feature(rustc_attrs)]\n #![allow(warnings)]"}, {"sha": "5c5e24693a4f563039c99a0edc55f840fc613203", "filename": "src/test/ui/dep-graph/dep-graph-type-alias.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cfe786e5e00316fb70b48fc6e324b72acf069df4/src%2Ftest%2Fui%2Fdep-graph%2Fdep-graph-type-alias.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cfe786e5e00316fb70b48fc6e324b72acf069df4/src%2Ftest%2Fui%2Fdep-graph%2Fdep-graph-type-alias.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fdep-graph%2Fdep-graph-type-alias.rs?ref=cfe786e5e00316fb70b48fc6e324b72acf069df4", "patch": "@@ -1,6 +1,6 @@\n // Test that changing what a `type` points to does not go unnoticed.\n \n-// compile-flags: -Z query-dep-graph\n+// compile-flags: -Z query-dep-graph -C incremental=tmp/dep-graph-type-alias\n \n #![feature(rustc_attrs)]\n #![allow(dead_code)]"}, {"sha": "6cc1f44104a097c023f0d4b90ffe6ad8a027644f", "filename": "src/test/ui/dep-graph/dep-graph-variance-alias.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cfe786e5e00316fb70b48fc6e324b72acf069df4/src%2Ftest%2Fui%2Fdep-graph%2Fdep-graph-variance-alias.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cfe786e5e00316fb70b48fc6e324b72acf069df4/src%2Ftest%2Fui%2Fdep-graph%2Fdep-graph-variance-alias.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fdep-graph%2Fdep-graph-variance-alias.rs?ref=cfe786e5e00316fb70b48fc6e324b72acf069df4", "patch": "@@ -1,7 +1,7 @@\n // Test that changing what a `type` points to does not go unnoticed\n // by the variance analysis.\n \n-// compile-flags: -Z query-dep-graph\n+// compile-flags: -Z query-dep-graph -C incremental=tmp/dep-graph-variance-alias\n \n #![feature(rustc_attrs)]\n #![allow(dead_code)]"}]}