{"sha": "67d0db6b008f98c1a1ba8ed6c267105433250fc9", "node_id": "MDY6Q29tbWl0NzI0NzEyOjY3ZDBkYjZiMDA4Zjk4YzFhMWJhOGVkNmMyNjcxMDU0MzMyNTBmYzk=", "commit": {"author": {"name": "Joshua Nelson", "email": "jyn514@gmail.com", "date": "2020-10-22T02:00:32Z"}, "committer": {"name": "Joshua Nelson", "email": "jyn514@gmail.com", "date": "2020-11-07T15:37:12Z"}, "message": "Fix handling of item names for HIR\n\n- Handle variants, fields, macros in `Node::ident()`\n- Handle the crate root in `opt_item_name`\n- Factor out `item_name_from_def_id` to reduce duplication\n- Look at HIR before the DefId for `opt_item_name`\n\n  This gives accurate spans, which are not available from serialized\n  metadata.\n\n- Don't panic on the crate root in `opt_item_name`\n- Add comments", "tree": {"sha": "9ee22c1d8d10686e4333584654b0e8fc41a21682", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9ee22c1d8d10686e4333584654b0e8fc41a21682"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/67d0db6b008f98c1a1ba8ed6c267105433250fc9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/67d0db6b008f98c1a1ba8ed6c267105433250fc9", "html_url": "https://github.com/rust-lang/rust/commit/67d0db6b008f98c1a1ba8ed6c267105433250fc9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/67d0db6b008f98c1a1ba8ed6c267105433250fc9/comments", "author": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "dc06a36074f04c6a77b5834f2950011d49607898", "url": "https://api.github.com/repos/rust-lang/rust/commits/dc06a36074f04c6a77b5834f2950011d49607898", "html_url": "https://github.com/rust-lang/rust/commit/dc06a36074f04c6a77b5834f2950011d49607898"}], "stats": {"total": 70, "additions": 49, "deletions": 21}, "files": [{"sha": "3c72937ad313435be1f6d0729c6bab4b1d26e06e", "filename": "compiler/rustc_hir/src/hir.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/67d0db6b008f98c1a1ba8ed6c267105433250fc9/compiler%2Frustc_hir%2Fsrc%2Fhir.rs", "raw_url": "https://github.com/rust-lang/rust/raw/67d0db6b008f98c1a1ba8ed6c267105433250fc9/compiler%2Frustc_hir%2Fsrc%2Fhir.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir%2Fsrc%2Fhir.rs?ref=67d0db6b008f98c1a1ba8ed6c267105433250fc9", "patch": "@@ -2677,6 +2677,9 @@ impl<'hir> Node<'hir> {\n             Node::TraitItem(TraitItem { ident, .. })\n             | Node::ImplItem(ImplItem { ident, .. })\n             | Node::ForeignItem(ForeignItem { ident, .. })\n+            | Node::Field(StructField { ident, .. })\n+            | Node::Variant(Variant { ident, .. })\n+            | Node::MacroDef(MacroDef { ident, .. })\n             | Node::Item(Item { ident, .. }) => Some(*ident),\n             _ => None,\n         }"}, {"sha": "d86e8987195570fb4b1c30dc1a527c37ea6d89ea", "filename": "compiler/rustc_middle/src/hir/map/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/67d0db6b008f98c1a1ba8ed6c267105433250fc9/compiler%2Frustc_middle%2Fsrc%2Fhir%2Fmap%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/67d0db6b008f98c1a1ba8ed6c267105433250fc9/compiler%2Frustc_middle%2Fsrc%2Fhir%2Fmap%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fhir%2Fmap%2Fmod.rs?ref=67d0db6b008f98c1a1ba8ed6c267105433250fc9", "patch": "@@ -478,7 +478,7 @@ impl<'hir> Map<'hir> {\n     }\n \n     pub fn get_if_local(&self, id: DefId) -> Option<Node<'hir>> {\n-        id.as_local().map(|id| self.get(self.local_def_id_to_hir_id(id)))\n+        id.as_local().and_then(|id| self.find(self.local_def_id_to_hir_id(id)))\n     }\n \n     pub fn get_generics(&self, id: DefId) -> Option<&'hir Generics<'hir>> {"}, {"sha": "c69dabda54937079d3c02028a4f6bba3b87f6699", "filename": "compiler/rustc_middle/src/ty/mod.rs", "status": "modified", "additions": 45, "deletions": 20, "changes": 65, "blob_url": "https://github.com/rust-lang/rust/blob/67d0db6b008f98c1a1ba8ed6c267105433250fc9/compiler%2Frustc_middle%2Fsrc%2Fty%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/67d0db6b008f98c1a1ba8ed6c267105433250fc9/compiler%2Frustc_middle%2Fsrc%2Fty%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fmod.rs?ref=67d0db6b008f98c1a1ba8ed6c267105433250fc9", "patch": "@@ -2795,10 +2795,52 @@ impl<'tcx> TyCtxt<'tcx> {\n             .filter(|item| item.kind == AssocKind::Fn && item.defaultness.has_value())\n     }\n \n+    fn item_name_from_hir(self, def_id: DefId) -> Option<Ident> {\n+        self.hir().get_if_local(def_id).and_then(|node| node.ident())\n+    }\n+\n+    fn item_name_from_def_id(self, def_id: DefId) -> Option<Symbol> {\n+        if def_id.index == CRATE_DEF_INDEX {\n+            Some(self.original_crate_name(def_id.krate))\n+        } else {\n+            let def_key = self.def_key(def_id);\n+            match def_key.disambiguated_data.data {\n+                // The name of a constructor is that of its parent.\n+                rustc_hir::definitions::DefPathData::Ctor => self.item_name_from_def_id(DefId {\n+                    krate: def_id.krate,\n+                    index: def_key.parent.unwrap(),\n+                }),\n+                _ => def_key.disambiguated_data.data.get_opt_name(),\n+            }\n+        }\n+    }\n+\n+    /// Look up the name of an item across crates. This does not look at HIR.\n+    ///\n+    /// When possible, this function should be used for cross-crate lookups over\n+    /// [`opt_item_name`] to avoid invalidating the incremental cache. If you\n+    /// need to handle items without a name, or HIR items that will not be\n+    /// serialized cross-crate, or if you need the span of the item, use\n+    /// [`opt_item_name`] instead.\n+    ///\n+    /// [`opt_item_name`]: Self::opt_item_name\n+    pub fn item_name(self, id: DefId) -> Symbol {\n+        // Look at cross-crate items first to avoid invalidating the incremental cache\n+        // unless we have to.\n+        self.item_name_from_def_id(id)\n+            .or_else(|| self.item_name_from_hir(id).map(|ident| ident.name))\n+            .unwrap_or_else(|| {\n+                bug!(\"item_name: no name for {:?}\", self.def_path(id));\n+            })\n+    }\n+\n+    /// Look up the name and span of an item or [`Node`].\n+    ///\n+    /// See [`item_name`][Self::item_name] for more information.\n     pub fn opt_item_name(self, def_id: DefId) -> Option<Ident> {\n-        def_id\n-            .as_local()\n-            .and_then(|def_id| self.hir().get(self.hir().local_def_id_to_hir_id(def_id)).ident())\n+        // Look at the HIR first so the span will be correct if this is a local item.\n+        self.item_name_from_hir(def_id)\n+            .or_else(|| self.item_name_from_def_id(def_id).map(Ident::with_dummy_span))\n     }\n \n     pub fn opt_associated_item(self, def_id: DefId) -> Option<&'tcx AssocItem> {\n@@ -2921,23 +2963,6 @@ impl<'tcx> TyCtxt<'tcx> {\n         }\n     }\n \n-    pub fn item_name(self, id: DefId) -> Symbol {\n-        if id.index == CRATE_DEF_INDEX {\n-            self.original_crate_name(id.krate)\n-        } else {\n-            let def_key = self.def_key(id);\n-            match def_key.disambiguated_data.data {\n-                // The name of a constructor is that of its parent.\n-                rustc_hir::definitions::DefPathData::Ctor => {\n-                    self.item_name(DefId { krate: id.krate, index: def_key.parent.unwrap() })\n-                }\n-                _ => def_key.disambiguated_data.data.get_opt_name().unwrap_or_else(|| {\n-                    bug!(\"item_name: no name for {:?}\", self.def_path(id));\n-                }),\n-            }\n-        }\n-    }\n-\n     /// Returns the possibly-auto-generated MIR of a `(DefId, Subst)` pair.\n     pub fn instance_mir(self, instance: ty::InstanceDef<'tcx>) -> &'tcx Body<'tcx> {\n         match instance {"}]}