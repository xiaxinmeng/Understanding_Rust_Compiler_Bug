{"sha": "e221be89e0772de3ff2999921b6a89005f19bafd", "node_id": "MDY6Q29tbWl0NzI0NzEyOmUyMjFiZTg5ZTA3NzJkZTNmZjI5OTk5MjFiNmE4OTAwNWYxOWJhZmQ=", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2018-06-23T13:09:21Z"}, "committer": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2018-07-05T19:07:51Z"}, "message": "Add command line lint manipulation in rustdoc", "tree": {"sha": "45b2a9ba41b6fa279381bc7afd583192b34e962f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/45b2a9ba41b6fa279381bc7afd583192b34e962f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e221be89e0772de3ff2999921b6a89005f19bafd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e221be89e0772de3ff2999921b6a89005f19bafd", "html_url": "https://github.com/rust-lang/rust/commit/e221be89e0772de3ff2999921b6a89005f19bafd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e221be89e0772de3ff2999921b6a89005f19bafd/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2ea922a96d676ff84cd78421d314e6aac305b5e9", "url": "https://api.github.com/repos/rust-lang/rust/commits/2ea922a96d676ff84cd78421d314e6aac305b5e9", "html_url": "https://github.com/rust-lang/rust/commit/2ea922a96d676ff84cd78421d314e6aac305b5e9"}], "stats": {"total": 78, "additions": 58, "deletions": 20}, "files": [{"sha": "89945a29e9b0aeec98c416898a05ecc4cba4d07f", "filename": "src/librustc/session/config.rs", "status": "modified", "additions": 24, "deletions": 17, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/e221be89e0772de3ff2999921b6a89005f19bafd/src%2Flibrustc%2Fsession%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e221be89e0772de3ff2999921b6a89005f19bafd/src%2Flibrustc%2Fsession%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fsession%2Fconfig.rs?ref=e221be89e0772de3ff2999921b6a89005f19bafd", "patch": "@@ -1747,6 +1747,29 @@ pub fn parse_cfgspecs(cfgspecs: Vec<String>) -> ast::CrateConfig {\n         .collect::<ast::CrateConfig>()\n }\n \n+pub fn get_cmd_lint_options(matches: &getopts::Matches,\n+                            error_format: ErrorOutputType)\n+                            -> (Vec<(String, lint::Level)>, bool, Option<lint::Level>) {\n+    let mut lint_opts = vec![];\n+    let mut describe_lints = false;\n+\n+    for &level in &[lint::Allow, lint::Warn, lint::Deny, lint::Forbid] {\n+        for lint_name in matches.opt_strs(level.as_str()) {\n+            if lint_name == \"help\" {\n+                describe_lints = true;\n+            } else {\n+                lint_opts.push((lint_name.replace(\"-\", \"_\"), level));\n+            }\n+        }\n+    }\n+\n+    let lint_cap = matches.opt_str(\"cap-lints\").map(|cap| {\n+        lint::Level::from_str(&cap)\n+            .unwrap_or_else(|| early_error(error_format, &format!(\"unknown lint level: `{}`\", cap)))\n+    });\n+    (lint_opts, describe_lints, lint_cap)\n+}\n+\n pub fn build_session_options_and_crate_config(\n     matches: &getopts::Matches,\n ) -> (Options, ast::CrateConfig) {\n@@ -1824,23 +1847,7 @@ pub fn build_session_options_and_crate_config(\n     let crate_types = parse_crate_types_from_list(unparsed_crate_types)\n         .unwrap_or_else(|e| early_error(error_format, &e[..]));\n \n-    let mut lint_opts = vec![];\n-    let mut describe_lints = false;\n-\n-    for &level in &[lint::Allow, lint::Warn, lint::Deny, lint::Forbid] {\n-        for lint_name in matches.opt_strs(level.as_str()) {\n-            if lint_name == \"help\" {\n-                describe_lints = true;\n-            } else {\n-                lint_opts.push((lint_name.replace(\"-\", \"_\"), level));\n-            }\n-        }\n-    }\n-\n-    let lint_cap = matches.opt_str(\"cap-lints\").map(|cap| {\n-        lint::Level::from_str(&cap)\n-            .unwrap_or_else(|| early_error(error_format, &format!(\"unknown lint level: `{}`\", cap)))\n-    });\n+    let (lint_opts, describe_lints, lint_cap) = get_cmd_lint_options(matches, error_format);\n \n     let mut debugging_opts = build_debugging_options(matches, error_format);\n "}, {"sha": "527ad08d7f2fe4e96b56ec4658595ad6103807e6", "filename": "src/librustdoc/core.rs", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/e221be89e0772de3ff2999921b6a89005f19bafd/src%2Flibrustdoc%2Fcore.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e221be89e0772de3ff2999921b6a89005f19bafd/src%2Flibrustdoc%2Fcore.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fcore.rs?ref=e221be89e0772de3ff2999921b6a89005f19bafd", "patch": "@@ -178,7 +178,10 @@ pub fn run_core(search_paths: SearchPaths,\n                 force_unstable_if_unmarked: bool,\n                 edition: Edition,\n                 cg: CodegenOptions,\n-                error_format: ErrorOutputType) -> (clean::Crate, RenderInfo)\n+                error_format: ErrorOutputType,\n+                cmd_lints: Vec<(String, lint::Level)>,\n+                lint_cap: Option<lint::Level>,\n+                describe_lints: bool) -> (clean::Crate, RenderInfo)\n {\n     // Parse, resolve, and typecheck the given crate.\n \n@@ -200,6 +203,7 @@ pub fn run_core(search_paths: SearchPaths,\n                             Some((lint.name_lower(), lint::Allow))\n                         }\n                     })\n+                    .chain(cmd_lints.into_iter())\n                     .collect::<Vec<_>>();\n \n     let host_triple = TargetTriple::from_triple(config::host_triple());\n@@ -213,7 +217,7 @@ pub fn run_core(search_paths: SearchPaths,\n         } else {\n             vec![]\n         },\n-        lint_cap: Some(lint::Forbid),\n+        lint_cap: Some(lint_cap.unwrap_or_else(|| lint::Forbid)),\n         cg,\n         externs,\n         target_triple: triple.unwrap_or(host_triple),\n@@ -226,6 +230,7 @@ pub fn run_core(search_paths: SearchPaths,\n         },\n         error_format,\n         edition,\n+        describe_lints,\n         ..config::basic_options()\n     };\n     driver::spawn_thread_pool(sessopts, move |sessopts| {"}, {"sha": "029be7dc805c61fff5662c40f01bf2aa7db9e871", "filename": "src/librustdoc/lib.rs", "status": "modified", "additions": 27, "deletions": 1, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/e221be89e0772de3ff2999921b6a89005f19bafd/src%2Flibrustdoc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e221be89e0772de3ff2999921b6a89005f19bafd/src%2Flibrustdoc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Flib.rs?ref=e221be89e0772de3ff2999921b6a89005f19bafd", "patch": "@@ -68,6 +68,7 @@ use rustc::session::search_paths::SearchPaths;\n use rustc::session::config::{ErrorOutputType, RustcOptGroup, Externs, CodegenOptions};\n use rustc::session::config::{nightly_options, build_codegen_options};\n use rustc_target::spec::TargetTriple;\n+use rustc::session::config::get_cmd_lint_options;\n \n #[macro_use]\n pub mod externalfiles;\n@@ -304,6 +305,28 @@ pub fn opts() -> Vec<RustcOptGroup> {\n                        \"disable-minification\",\n                        \"Disable minification applied on JS files\")\n         }),\n+        unstable(\"warn\", |o| {\n+            o.optmulti(\"W\", \"warn\", \"Set lint warnings\", \"OPT\")\n+        }),\n+        unstable(\"allow\", |o| {\n+            o.optmulti(\"A\", \"allow\", \"Set lint allowed\", \"OPT\")\n+        }),\n+        unstable(\"deny\", |o| {\n+            o.optmulti(\"D\", \"deny\", \"Set lint denied\", \"OPT\")\n+        }),\n+        unstable(\"forbid\", |o| {\n+            o.optmulti(\"F\", \"forbid\", \"Set lint forbidden\", \"OPT\")\n+        }),\n+        unstable(\"cap-lints\", |o| {\n+            o.optmulti(\n+                \"\",\n+                \"cap-lints\",\n+                \"Set the most restrictive lint level. \\\n+                 More restrictive lints are capped at this \\\n+                 level. By default, it is at `forbid` level.\",\n+                \"LEVEL\",\n+            )\n+        }),\n     ]\n }\n \n@@ -636,6 +659,8 @@ where R: 'static + Send,\n         *x == \"force-unstable-if-unmarked\"\n     });\n \n+    let (lint_opts, describe_lints, lint_cap) = get_cmd_lint_options(matches, error_format);\n+\n     let (tx, rx) = channel();\n \n     rustc_driver::monitor(move || syntax::with_globals(move || {\n@@ -644,7 +669,8 @@ where R: 'static + Send,\n         let (mut krate, renderinfo) =\n             core::run_core(paths, cfgs, externs, Input::File(cratefile), triple, maybe_sysroot,\n                            display_warnings, crate_name.clone(),\n-                           force_unstable_if_unmarked, edition, cg, error_format);\n+                           force_unstable_if_unmarked, edition, cg, error_format,\n+                           lint_opts, lint_cap, describe_lints);\n \n         info!(\"finished with rustc\");\n "}]}