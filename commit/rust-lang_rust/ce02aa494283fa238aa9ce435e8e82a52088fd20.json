{"sha": "ce02aa494283fa238aa9ce435e8e82a52088fd20", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNlMDJhYTQ5NDI4M2ZhMjM4YWE5Y2U0MzVlOGU4MmE1MjA4OGZkMjA=", "commit": {"author": {"name": "Ariel Ben-Yehuda", "email": "arielb1@mail.tau.ac.il", "date": "2015-09-17T17:50:27Z"}, "committer": {"name": "Ariel Ben-Yehuda", "email": "ariel.byd@gmail.com", "date": "2015-10-01T18:50:52Z"}, "message": "don't mark_stable_position needlessly in tyencode\n\nanother 1% improvement in libcore size - also 1% in librustc\n\n550076 liballoc-bb943c5a.rlib\n1425150 liballoc_jemalloc-bb943c5a.rlib\n10100 liballoc_system-bb943c5a.rlib\n149372 libarena-bb943c5a.rlib\n3964144 libcollections-bb943c5a.rlib\n17744342 libcore-bb943c5a.rlib\n197420 libflate-bb943c5a.rlib\n241582 libfmt_macros-bb943c5a.rlib\n550560 libgetopts-bb943c5a.rlib\n219444 libgraphviz-bb943c5a.rlib\n402668 liblibc-bb943c5a.rlib\n187158 liblog-bb943c5a.rlib\n704588 librand-bb943c5a.rlib\n594522 librbml-bb943c5a.rlib\n1392516 librustc_back-bb943c5a.rlib\n38196500 librustc-bb943c5a.rlib\n12826 librustc_bitflags-bb943c5a.rlib\n2286918 librustc_borrowck-bb943c5a.rlib\n561714 librustc_data_structures-bb943c5a.rlib\n9356400 librustc_driver-bb943c5a.rlib\n9378650 librustc_front-bb943c5a.rlib\n1603680 librustc_lint-bb943c5a.rlib\n79184908 librustc_llvm-bb943c5a.rlib\n4746824 librustc_mir-bb943c5a.rlib\n3532474 librustc_platform_intrinsics-bb943c5a.rlib\n592664 librustc_privacy-bb943c5a.rlib\n3114986 librustc_resolve-bb943c5a.rlib\n14153174 librustc_trans-bb943c5a.rlib\n11918356 librustc_typeck-bb943c5a.rlib\n1669986 librustc_unicode-bb943c5a.rlib\n15611582 librustdoc-bb943c5a.rlib\n2836912 libserialize-bb943c5a.rlib\n8549994 libstd-bb943c5a.rlib\n30399156 libsyntax-bb943c5a.rlib\n907058 libterm-bb943c5a.rlib", "tree": {"sha": "9d8a7674768aa2711ee7662e3dd5fdbfc9046ffd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9d8a7674768aa2711ee7662e3dd5fdbfc9046ffd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ce02aa494283fa238aa9ce435e8e82a52088fd20", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ce02aa494283fa238aa9ce435e8e82a52088fd20", "html_url": "https://github.com/rust-lang/rust/commit/ce02aa494283fa238aa9ce435e8e82a52088fd20", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ce02aa494283fa238aa9ce435e8e82a52088fd20/comments", "author": null, "committer": {"login": "arielb1", "id": 1830974, "node_id": "MDQ6VXNlcjE4MzA5NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1830974?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arielb1", "html_url": "https://github.com/arielb1", "followers_url": "https://api.github.com/users/arielb1/followers", "following_url": "https://api.github.com/users/arielb1/following{/other_user}", "gists_url": "https://api.github.com/users/arielb1/gists{/gist_id}", "starred_url": "https://api.github.com/users/arielb1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arielb1/subscriptions", "organizations_url": "https://api.github.com/users/arielb1/orgs", "repos_url": "https://api.github.com/users/arielb1/repos", "events_url": "https://api.github.com/users/arielb1/events{/privacy}", "received_events_url": "https://api.github.com/users/arielb1/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7aed441ac8ef9da3f12c0606a93a55bd998f2d4f", "url": "https://api.github.com/repos/rust-lang/rust/commits/7aed441ac8ef9da3f12c0606a93a55bd998f2d4f", "html_url": "https://github.com/rust-lang/rust/commit/7aed441ac8ef9da3f12c0606a93a55bd998f2d4f"}], "stats": {"total": 19, "additions": 13, "deletions": 6}, "files": [{"sha": "489d213879c9ab24e92336a627f5e2e592e635d8", "filename": "src/librustc/metadata/tyencode.rs", "status": "modified", "additions": 13, "deletions": 6, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/ce02aa494283fa238aa9ce435e8e82a52088fd20/src%2Flibrustc%2Fmetadata%2Ftyencode.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ce02aa494283fa238aa9ce435e8e82a52088fd20/src%2Flibrustc%2Fmetadata%2Ftyencode.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmetadata%2Ftyencode.rs?ref=ce02aa494283fa238aa9ce435e8e82a52088fd20", "patch": "@@ -14,6 +14,7 @@\n #![allow(non_camel_case_types)]\n \n use std::cell::RefCell;\n+use std::str;\n use std::io::prelude::*;\n \n use middle::def_id::DefId;\n@@ -173,12 +174,18 @@ pub fn enc_ty<'a, 'tcx>(w: &mut Encoder, cx: &ctxt<'a, 'tcx>, t: Ty<'tcx>) {\n         return len;\n     }\n     let abbrev_len = 3 + estimate_sz(pos) + estimate_sz(len);\n-    if abbrev_len < len {\n-        // I.e. it's actually an abbreviation.\n-        cx.abbrevs.borrow_mut().insert(t, ty_abbrev {\n-            s: format!(\"#{:x}:{:x}#\", pos, len)\n-        });\n-    }\n+    cx.abbrevs.borrow_mut().insert(t, ty_abbrev {\n+        s: if abbrev_len < len {\n+            format!(\"#{:x}:{:x}#\", pos, len)\n+        } else {\n+            // if the abbreviation is longer than the real type,\n+            // don't use #-notation. However, insert it here so\n+            // other won't have to `mark_stable_position`\n+            str::from_utf8(\n+                &w.writer.get_ref()[pos as usize..end as usize]\n+            ).unwrap().to_owned()\n+        }\n+    });\n }\n \n fn enc_mutability(w: &mut Encoder, mt: hir::Mutability) {"}]}