{"sha": "0c4cb48e03af0cc7481b76ada343c092bf6dfdfd", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBjNGNiNDhlMDNhZjBjYzc0ODFiNzZhZGEzNDNjMDkyYmY2ZGZkZmQ=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-03-09T16:18:17Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-03-09T16:18:17Z"}, "message": "Rollup merge of #58670 - saleemjaffer:refactor_typecast_check_kinds, r=oli-obk\n\nfixes rust-lang#52482", "tree": {"sha": "2193e91a5f59c0de56d01cc59af23bb6cd10d6bb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2193e91a5f59c0de56d01cc59af23bb6cd10d6bb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0c4cb48e03af0cc7481b76ada343c092bf6dfdfd", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJcg+dJCRBK7hj4Ov3rIwAAdHIIAFdwSSPktyAhNLe7Ujnm7yyY\nw1K3B0PWJZtXgsEe8RkG2JqncowH3F7AaS2RyEqiiE4hv63/ptf+zH08vY8CeNUM\nj6pbBTVe5ejhzNqgExDTnXmJCQYdQJqM3D7b4pqJ/VaWNTRWgnT2dFiNp8YJh4yL\nCSMO08EneHyiz4vCpxbozFPuPf12zeYDEMjZV6WGwCMMheV0KGEM/XPiP9LQSWZq\nswe4uBbZg/p4vqhy7YYKhNOZZJjLsFFs/00b8GgZpLwA+8Xvir0u3atTiOyrTqbO\n4iy+Zqn+mvpEC1n1G/UdS02vMCZy3fACgJFXQBHVEiVc5P9A5lFRzSCAYfMqBE4=\n=XVG2\n-----END PGP SIGNATURE-----\n", "payload": "tree 2193e91a5f59c0de56d01cc59af23bb6cd10d6bb\nparent 5e52010304e885f8991e73223c22051503fa1d13\nparent 9902f8c3c2e89c87ab25a543e12c851bef955608\nauthor Mazdak Farrokhzad <twingoow@gmail.com> 1552148297 +0100\ncommitter GitHub <noreply@github.com> 1552148297 +0100\n\nRollup merge of #58670 - saleemjaffer:refactor_typecast_check_kinds, r=oli-obk\n\nfixes rust-lang#52482\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0c4cb48e03af0cc7481b76ada343c092bf6dfdfd", "html_url": "https://github.com/rust-lang/rust/commit/0c4cb48e03af0cc7481b76ada343c092bf6dfdfd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0c4cb48e03af0cc7481b76ada343c092bf6dfdfd/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5e52010304e885f8991e73223c22051503fa1d13", "url": "https://api.github.com/repos/rust-lang/rust/commits/5e52010304e885f8991e73223c22051503fa1d13", "html_url": "https://github.com/rust-lang/rust/commit/5e52010304e885f8991e73223c22051503fa1d13"}, {"sha": "9902f8c3c2e89c87ab25a543e12c851bef955608", "url": "https://api.github.com/repos/rust-lang/rust/commits/9902f8c3c2e89c87ab25a543e12c851bef955608", "html_url": "https://github.com/rust-lang/rust/commit/9902f8c3c2e89c87ab25a543e12c851bef955608"}], "stats": {"total": 79, "additions": 32, "deletions": 47}, "files": [{"sha": "04d503d993db773e160b64cf9c8e8117bb0e3af4", "filename": "src/librustc/ty/context.rs", "status": "modified", "additions": 17, "deletions": 17, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/0c4cb48e03af0cc7481b76ada343c092bf6dfdfd/src%2Flibrustc%2Fty%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0c4cb48e03af0cc7481b76ada343c092bf6dfdfd/src%2Flibrustc%2Fty%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fcontext.rs?ref=0c4cb48e03af0cc7481b76ada343c092bf6dfdfd", "patch": "@@ -41,7 +41,7 @@ use crate::ty::steal::Steal;\n use crate::ty::subst::{UserSubsts, UnpackedKind};\n use crate::ty::{BoundVar, BindingMode};\n use crate::ty::CanonicalPolyFnSig;\n-use crate::util::nodemap::{DefIdMap, DefIdSet, ItemLocalMap};\n+use crate::util::nodemap::{DefIdMap, DefIdSet, ItemLocalMap, ItemLocalSet};\n use crate::util::nodemap::{FxHashMap, FxHashSet};\n use errors::DiagnosticBuilder;\n use rustc_data_structures::interner::HashInterner;\n@@ -409,9 +409,9 @@ pub struct TypeckTables<'tcx> {\n     /// MIR construction and hence is not serialized to metadata.\n     fru_field_types: ItemLocalMap<Vec<Ty<'tcx>>>,\n \n-    /// Maps a cast expression to its kind. This is keyed on the\n-    /// *from* expression of the cast, not the cast itself.\n-    cast_kinds: ItemLocalMap<ty::cast::CastKind>,\n+    /// For every coercion cast we add the HIR node ID of the cast\n+    /// expression to this set.\n+    coercion_casts: ItemLocalSet,\n \n     /// Set of trait imports actually used in the method resolution.\n     /// This is used for warning unused imports. During type\n@@ -456,7 +456,7 @@ impl<'tcx> TypeckTables<'tcx> {\n             closure_kind_origins: Default::default(),\n             liberated_fn_sigs: Default::default(),\n             fru_field_types: Default::default(),\n-            cast_kinds: Default::default(),\n+            coercion_casts: Default::default(),\n             used_trait_imports: Lrc::new(Default::default()),\n             tainted_by_errors: false,\n             free_region_map: Default::default(),\n@@ -718,19 +718,19 @@ impl<'tcx> TypeckTables<'tcx> {\n         }\n     }\n \n-    pub fn cast_kinds(&self) -> LocalTableInContext<'_, ty::cast::CastKind> {\n-        LocalTableInContext {\n-            local_id_root: self.local_id_root,\n-            data: &self.cast_kinds\n-        }\n+    pub fn is_coercion_cast(&self, hir_id: hir::HirId) -> bool {\n+        validate_hir_id_for_typeck_tables(self.local_id_root, hir_id, true);\n+        self.coercion_casts.contains(&hir_id.local_id)\n     }\n \n-    pub fn cast_kinds_mut(&mut self) -> LocalTableInContextMut<'_, ty::cast::CastKind> {\n-        LocalTableInContextMut {\n-            local_id_root: self.local_id_root,\n-            data: &mut self.cast_kinds\n-        }\n+    pub fn set_coercion_cast(&mut self, id: ItemLocalId) {\n+        self.coercion_casts.insert(id);\n+    }\n+\n+    pub fn coercion_casts(&self) -> &ItemLocalSet {\n+        &self.coercion_casts\n     }\n+\n }\n \n impl<'a, 'gcx> HashStable<StableHashingContext<'a>> for TypeckTables<'gcx> {\n@@ -753,7 +753,7 @@ impl<'a, 'gcx> HashStable<StableHashingContext<'a>> for TypeckTables<'gcx> {\n             ref liberated_fn_sigs,\n             ref fru_field_types,\n \n-            ref cast_kinds,\n+            ref coercion_casts,\n \n             ref used_trait_imports,\n             tainted_by_errors,\n@@ -798,7 +798,7 @@ impl<'a, 'gcx> HashStable<StableHashingContext<'a>> for TypeckTables<'gcx> {\n             closure_kind_origins.hash_stable(hcx, hasher);\n             liberated_fn_sigs.hash_stable(hcx, hasher);\n             fru_field_types.hash_stable(hcx, hasher);\n-            cast_kinds.hash_stable(hcx, hasher);\n+            coercion_casts.hash_stable(hcx, hasher);\n             used_trait_imports.hash_stable(hcx, hasher);\n             tainted_by_errors.hash_stable(hcx, hasher);\n             free_region_map.hash_stable(hcx, hasher);"}, {"sha": "ad0a22cc7827c9f3e2163ebc2cdd8d63d5ca7586", "filename": "src/librustc_mir/hair/cx/expr.rs", "status": "modified", "additions": 1, "deletions": 6, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/0c4cb48e03af0cc7481b76ada343c092bf6dfdfd/src%2Flibrustc_mir%2Fhair%2Fcx%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0c4cb48e03af0cc7481b76ada343c092bf6dfdfd/src%2Flibrustc_mir%2Fhair%2Fcx%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fhair%2Fcx%2Fexpr.rs?ref=0c4cb48e03af0cc7481b76ada343c092bf6dfdfd", "patch": "@@ -8,7 +8,6 @@ use rustc::hir::def::{Def, CtorKind};\n use rustc::mir::interpret::{GlobalId, ErrorHandled, ConstValue};\n use rustc::ty::{self, AdtKind, Ty};\n use rustc::ty::adjustment::{Adjustment, Adjust, AutoBorrow, AutoBorrowMutability};\n-use rustc::ty::cast::CastKind as TyCastKind;\n use rustc::ty::subst::{InternalSubsts, SubstsRef};\n use rustc::hir;\n use rustc::hir::def_id::LocalDefId;\n@@ -655,11 +654,7 @@ fn make_mirror_unadjusted<'a, 'gcx, 'tcx>(cx: &mut Cx<'a, 'gcx, 'tcx>,\n \n             // Check to see if this cast is a \"coercion cast\", where the cast is actually done\n             // using a coercion (or is a no-op).\n-            let cast = if let Some(&TyCastKind::CoercionCast) =\n-                cx.tables()\n-                .cast_kinds()\n-                .get(source.hir_id)\n-            {\n+            let cast = if cx.tables().is_coercion_cast(source.hir_id) {\n                 // Convert the lexpr to a vexpr.\n                 ExprKind::Use { source: source.to_ref() }\n             } else {"}, {"sha": "9de022a4021a55c0733e7128b3c85cd758b2060f", "filename": "src/librustc_passes/rvalue_promotion.rs", "status": "modified", "additions": 7, "deletions": 10, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/0c4cb48e03af0cc7481b76ada343c092bf6dfdfd/src%2Flibrustc_passes%2Frvalue_promotion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0c4cb48e03af0cc7481b76ada343c092bf6dfdfd/src%2Flibrustc_passes%2Frvalue_promotion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_passes%2Frvalue_promotion.rs?ref=0c4cb48e03af0cc7481b76ada343c092bf6dfdfd", "patch": "@@ -14,7 +14,7 @@\n // - It's not possible to take the address of a static item with unsafe interior. This is enforced\n // by borrowck::gather_loans\n \n-use rustc::ty::cast::CastKind;\n+use rustc::ty::cast::CastTy;\n use rustc::hir::def::{Def, CtorKind};\n use rustc::hir::def_id::DefId;\n use rustc::middle::expr_use_visitor as euv;\n@@ -318,15 +318,12 @@ fn check_expr_kind<'a, 'tcx>(\n         hir::ExprKind::Cast(ref from, _) => {\n             let expr_promotability = v.check_expr(from);\n             debug!(\"Checking const cast(id={})\", from.hir_id);\n-            match v.tables.cast_kinds().get(from.hir_id) {\n-                None => {\n-                    v.tcx.sess.delay_span_bug(e.span, \"no kind for cast\");\n-                    NotPromotable\n-                },\n-                Some(&CastKind::PtrAddrCast) | Some(&CastKind::FnPtrAddrCast) => {\n-                    NotPromotable\n-                }\n-                _ => expr_promotability\n+            let cast_in = CastTy::from_ty(v.tables.expr_ty(from));\n+            let cast_out = CastTy::from_ty(v.tables.expr_ty(e));\n+            match (cast_in, cast_out) {\n+                (Some(CastTy::FnPtr), Some(CastTy::Int(_))) |\n+                (Some(CastTy::Ptr(_)), Some(CastTy::Int(_))) => NotPromotable,\n+                (_, _) => expr_promotability\n             }\n         }\n         hir::ExprKind::Path(ref qpath) => {"}, {"sha": "cad9e73bd2ac99b01d49c21019fde19e44070975", "filename": "src/librustc_typeck/check/cast.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/0c4cb48e03af0cc7481b76ada343c092bf6dfdfd/src%2Flibrustc_typeck%2Fcheck%2Fcast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0c4cb48e03af0cc7481b76ada343c092bf6dfdfd/src%2Flibrustc_typeck%2Fcheck%2Fcast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fcast.rs?ref=0c4cb48e03af0cc7481b76ada343c092bf6dfdfd", "patch": "@@ -428,13 +428,12 @@ impl<'a, 'gcx, 'tcx> CastCheck<'tcx> {\n         } else if self.try_coercion_cast(fcx) {\n             self.trivial_cast_lint(fcx);\n             debug!(\" -> CoercionCast\");\n-            fcx.tables.borrow_mut().cast_kinds_mut().insert(self.expr.hir_id,\n-                                                            CastKind::CoercionCast);\n+            fcx.tables.borrow_mut().set_coercion_cast(self.expr.hir_id.local_id);\n+\n         } else {\n             match self.do_check(fcx) {\n                 Ok(k) => {\n                     debug!(\" -> {:?}\", k);\n-                    fcx.tables.borrow_mut().cast_kinds_mut().insert(self.expr.hir_id, k);\n                 }\n                 Err(e) => self.report_cast_error(fcx, e),\n             };"}, {"sha": "d001545d1d9152e345a6a9e5e2c9de4c7fb89b09", "filename": "src/librustc_typeck/check/writeback.rs", "status": "modified", "additions": 5, "deletions": 11, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/0c4cb48e03af0cc7481b76ada343c092bf6dfdfd/src%2Flibrustc_typeck%2Fcheck%2Fwriteback.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0c4cb48e03af0cc7481b76ada343c092bf6dfdfd/src%2Flibrustc_typeck%2Fcheck%2Fwriteback.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fwriteback.rs?ref=0c4cb48e03af0cc7481b76ada343c092bf6dfdfd", "patch": "@@ -50,7 +50,7 @@ impl<'a, 'gcx, 'tcx> FnCtxt<'a, 'gcx, 'tcx> {\n         wbcx.visit_liberated_fn_sigs();\n         wbcx.visit_fru_field_types();\n         wbcx.visit_opaque_types(body.value.span);\n-        wbcx.visit_cast_types();\n+        wbcx.visit_coercion_casts();\n         wbcx.visit_free_region_map();\n         wbcx.visit_user_provided_tys();\n         wbcx.visit_user_provided_sigs();\n@@ -355,19 +355,13 @@ impl<'cx, 'gcx, 'tcx> WritebackCx<'cx, 'gcx, 'tcx> {\n         }\n     }\n \n-    fn visit_cast_types(&mut self) {\n+    fn visit_coercion_casts(&mut self) {\n         let fcx_tables = self.fcx.tables.borrow();\n-        let fcx_cast_kinds = fcx_tables.cast_kinds();\n+        let fcx_coercion_casts = fcx_tables.coercion_casts();\n         debug_assert_eq!(fcx_tables.local_id_root, self.tables.local_id_root);\n-        let mut self_cast_kinds = self.tables.cast_kinds_mut();\n-        let common_local_id_root = fcx_tables.local_id_root.unwrap();\n \n-        for (&local_id, &cast_kind) in fcx_cast_kinds.iter() {\n-            let hir_id = hir::HirId {\n-                owner: common_local_id_root.index,\n-                local_id,\n-            };\n-            self_cast_kinds.insert(hir_id, cast_kind);\n+        for local_id in fcx_coercion_casts {\n+            self.tables.set_coercion_cast(*local_id);\n         }\n     }\n "}]}