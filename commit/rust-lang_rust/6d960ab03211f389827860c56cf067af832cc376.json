{"sha": "6d960ab03211f389827860c56cf067af832cc376", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZkOTYwYWIwMzIxMWYzODk4Mjc4NjBjNTZjZjA2N2FmODMyY2MzNzY=", "commit": {"author": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2021-08-11T15:09:51Z"}, "committer": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2021-08-11T15:09:51Z"}, "message": "Fix extract_function tagging params as mut unnecessarily", "tree": {"sha": "a2080ca0050d701ca3a9e2ac66ac75c11dd65516", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a2080ca0050d701ca3a9e2ac66ac75c11dd65516"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6d960ab03211f389827860c56cf067af832cc376", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6d960ab03211f389827860c56cf067af832cc376", "html_url": "https://github.com/rust-lang/rust/commit/6d960ab03211f389827860c56cf067af832cc376", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6d960ab03211f389827860c56cf067af832cc376/comments", "author": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f2246fecef40fb86806fbe440df3b1eeb19a0f34", "url": "https://api.github.com/repos/rust-lang/rust/commits/f2246fecef40fb86806fbe440df3b1eeb19a0f34", "html_url": "https://github.com/rust-lang/rust/commit/f2246fecef40fb86806fbe440df3b1eeb19a0f34"}], "stats": {"total": 63, "additions": 54, "deletions": 9}, "files": [{"sha": "757c754339669919d5eb0225ed5fc297757cf9a1", "filename": "crates/ide_assists/src/handlers/extract_function.rs", "status": "modified", "additions": 54, "deletions": 9, "changes": 63, "blob_url": "https://github.com/rust-lang/rust/blob/6d960ab03211f389827860c56cf067af832cc376/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fextract_function.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6d960ab03211f389827860c56cf067af832cc376/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fextract_function.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fextract_function.rs?ref=6d960ab03211f389827860c56cf067af832cc376", "patch": "@@ -827,16 +827,21 @@ impl FunctionBody {\n             .map(|(var, src)| {\n                 let usages = LocalUsages::find_local_usages(ctx, var);\n                 let ty = var.ty(ctx.db());\n+\n+                let defined_outside_parent_loop = container_info\n+                    .parent_loop\n+                    .as_ref()\n+                    .map_or(true, |it| it.text_range().contains_range(src.syntax().text_range()));\n+\n                 let is_copy = ty.is_copy(ctx.db());\n-                Param {\n-                    var,\n-                    ty,\n-                    move_local: container_info.parent_loop.as_ref().map_or(true, |it| {\n-                        it.text_range().contains_range(src.syntax().text_range())\n-                    }) && !self.has_usages_after_body(&usages),\n-                    requires_mut: has_exclusive_usages(ctx, &usages, self),\n-                    is_copy,\n-                }\n+                let has_usages = self.has_usages_after_body(&usages);\n+                let requires_mut =\n+                    !ty.is_mutable_reference() && has_exclusive_usages(ctx, &usages, self);\n+                // We can move the value into the function call if it's not used after the call,\n+                // if the var is not used but defined outside a loop we are extracting from we can't move it either\n+                // as the function will reuse it in the next iteration.\n+                let move_local = !has_usages && defined_outside_parent_loop;\n+                Param { var, ty, move_local, requires_mut, is_copy }\n             })\n             .collect()\n     }\n@@ -4114,6 +4119,46 @@ fn foo() {\n fn $0fun_name(x: &mut i32) {\n     *x += 1;\n }\n+\"#,\n+        );\n+    }\n+\n+    // regression test for #9822\n+    #[test]\n+    fn extract_mut_ref_param_has_no_mut_binding_in_loop() {\n+        check_assist(\n+            extract_function,\n+            r#\"\n+struct Foo;\n+impl Foo {\n+    fn foo(&mut self) {}\n+}\n+fn foo() {\n+    let mut x = Foo;\n+    while false {\n+        let y = &mut x;\n+        $0y.foo();$0\n+    }\n+    let z = x;\n+}\n+\"#,\n+            r#\"\n+struct Foo;\n+impl Foo {\n+    fn foo(&mut self) {}\n+}\n+fn foo() {\n+    let mut x = Foo;\n+    while false {\n+        let y = &mut x;\n+        fun_name(y);\n+    }\n+    let z = x;\n+}\n+\n+fn $0fun_name(y: &mut Foo) {\n+    y.foo();\n+}\n \"#,\n         );\n     }"}]}