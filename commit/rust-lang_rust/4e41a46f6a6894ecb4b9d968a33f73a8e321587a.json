{"sha": "4e41a46f6a6894ecb4b9d968a33f73a8e321587a", "node_id": "C_kwDOAAsO6NoAKDRlNDFhNDZmNmE2ODk0ZWNiNGI5ZDk2OGEzM2Y3M2E4ZTMyMTU4N2E", "commit": {"author": {"name": "David Wood", "email": "david@davidtw.co", "date": "2022-02-17T18:36:44Z"}, "committer": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2022-02-22T07:23:53Z"}, "message": "Reapply cg_llvm: `fewer_names` in `uncached_llvm_type`\n\nCo-authored-by: Erik Desjardins <erikdesjardins@users.noreply.github.com>\nCo-authored-by: Tomasz Mi\u0105sko <tomasz.miasko@gmail.com>", "tree": {"sha": "046b8e73a9f12d85801f25bb49a684a770bf0dd1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/046b8e73a9f12d85801f25bb49a684a770bf0dd1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4e41a46f6a6894ecb4b9d968a33f73a8e321587a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4e41a46f6a6894ecb4b9d968a33f73a8e321587a", "html_url": "https://github.com/rust-lang/rust/commit/4e41a46f6a6894ecb4b9d968a33f73a8e321587a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4e41a46f6a6894ecb4b9d968a33f73a8e321587a/comments", "author": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b8967b0d52a2ba5f0c9da0da03e78ccba5534e4a", "url": "https://api.github.com/repos/rust-lang/rust/commits/b8967b0d52a2ba5f0c9da0da03e78ccba5534e4a", "html_url": "https://github.com/rust-lang/rust/commit/b8967b0d52a2ba5f0c9da0da03e78ccba5534e4a"}], "stats": {"total": 11, "additions": 10, "deletions": 1}, "files": [{"sha": "da378dc649352603f54d38a390d44ee1c076f9d6", "filename": "compiler/rustc_codegen_llvm/src/type_of.rs", "status": "modified", "additions": 10, "deletions": 1, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/4e41a46f6a6894ecb4b9d968a33f73a8e321587a/compiler%2Frustc_codegen_llvm%2Fsrc%2Ftype_of.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4e41a46f6a6894ecb4b9d968a33f73a8e321587a/compiler%2Frustc_codegen_llvm%2Fsrc%2Ftype_of.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Ftype_of.rs?ref=4e41a46f6a6894ecb4b9d968a33f73a8e321587a", "patch": "@@ -1,5 +1,6 @@\n use crate::common::*;\n use crate::context::TypeLowering;\n+use crate::llvm_util::get_version;\n use crate::type_::Type;\n use rustc_codegen_ssa::traits::*;\n use rustc_middle::bug;\n@@ -42,7 +43,12 @@ fn uncached_llvm_type<'a, 'tcx>(\n         // FIXME(eddyb) producing readable type names for trait objects can result\n         // in problematically distinct types due to HRTB and subtyping (see #47638).\n         // ty::Dynamic(..) |\n-        ty::Adt(..) | ty::Closure(..) | ty::Foreign(..) | ty::Generator(..) | ty::Str => {\n+        ty::Adt(..) | ty::Closure(..) | ty::Foreign(..) | ty::Generator(..) | ty::Str\n+            // For performance reasons we use names only when emitting LLVM IR. Unless we are on\n+            // LLVM < 14, where the use of unnamed types resulted in various issues, e.g., #76213,\n+            // #79564, and #79246.\n+            if get_version() < (14, 0, 0) || !cx.sess().fewer_names() =>\n+        {\n             let mut name = with_no_visible_paths!(with_no_trimmed_paths!(layout.ty.to_string()));\n             if let (&ty::Adt(def, _), &Variants::Single { index }) =\n                 (layout.ty.kind(), &layout.variants)\n@@ -58,6 +64,9 @@ fn uncached_llvm_type<'a, 'tcx>(\n             }\n             Some(name)\n         }\n+        // Use identified structure types for ADT. Due to pointee types in LLVM IR their definition\n+        // might be recursive. Other cases are non-recursive and we can use literal structure types.\n+        ty::Adt(..) => Some(String::new()),\n         _ => None,\n     };\n "}]}