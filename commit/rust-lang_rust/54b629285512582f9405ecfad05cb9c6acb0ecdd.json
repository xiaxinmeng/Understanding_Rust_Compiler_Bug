{"sha": "54b629285512582f9405ecfad05cb9c6acb0ecdd", "node_id": "C_kwDOAAsO6NoAKDU0YjYyOTI4NTUxMjU4MmY5NDA1ZWNmYWQwNWNiOWM2YWNiMGVjZGQ", "commit": {"author": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2022-11-23T03:54:40Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-11-23T03:54:40Z"}, "message": "Rollup merge of #104621 - YC:master, r=davidtwco\n\nFix --extern library finding errors\n\n- `crate_name` is not specified/passed to `metadata_crate_location_unknown_type`\nhttps://github.com/rust-lang/rust/blob/c493bae0d8efd75723460ce5c371f726efa93f15/compiler/rustc_error_messages/locales/en-US/metadata.ftl#L274-L275\n- `metadata_lib_filename_form` is missing `$`\n- Add additional check to ensure that library is file\n\nTesting\n1. Create file `a.rs`\n```rust\nextern crate t;\nfn main() {}\n```\n1. Create empty file `x`\n1. Create empty directory `y`\n1. Run\n```sh\n$ rustc -o a a.rs --extern t=x\n$ rustc -o a a.rs --extern t=y\n```\nBoth currently panic with stable.", "tree": {"sha": "b61d4f3d0fdd0a23b330caf04368927252c2503f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b61d4f3d0fdd0a23b330caf04368927252c2503f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/54b629285512582f9405ecfad05cb9c6acb0ecdd", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjfZmACRBK7hj4Ov3rIwAAhNwIADkZ2meK4GAtRWuazplJT5xz\n2EygNSRGOhL4UVTbKgSTZISdxxcIZ3CXq+mQmLcHuAxHnDCEnZwipaJhR7FY0tti\ncgj+XtYLBDmyOsAQySjHjTXEU+GfyQFCrDavnwE7ls2eibDYoVJ+TRz1W6opk7wm\nzJ2iqLw13ZA6zxv85S9AYJkPWvoV6Kv0dny+qymTwv1FYbRazJkBl8dOo0k+j76W\nscjh6C0y5N5IuXUs2W19XWQGAR7Xypd8sX1iNDj2g5Wft/+01gMXFg7xtmj2CHLk\n3NEet+ZlALYfOJJLq8SLCcKnFknd7RZq+uZ+bj4kDAHIcx4AjPyvBMKfagyCHkg=\n=lXxn\n-----END PGP SIGNATURE-----\n", "payload": "tree b61d4f3d0fdd0a23b330caf04368927252c2503f\nparent 36815c6e3bbe3a38704e1e89038fa5f6bb9fe41d\nparent 7169c7d1051a235d76eb24d704f19c1928abf383\nauthor Manish Goregaokar <manishsmail@gmail.com> 1669175680 -0500\ncommitter GitHub <noreply@github.com> 1669175680 -0500\n\nRollup merge of #104621 - YC:master, r=davidtwco\n\nFix --extern library finding errors\n\n- `crate_name` is not specified/passed to `metadata_crate_location_unknown_type`\nhttps://github.com/rust-lang/rust/blob/c493bae0d8efd75723460ce5c371f726efa93f15/compiler/rustc_error_messages/locales/en-US/metadata.ftl#L274-L275\n- `metadata_lib_filename_form` is missing `$`\n- Add additional check to ensure that library is file\n\nTesting\n1. Create file `a.rs`\n```rust\nextern crate t;\nfn main() {}\n```\n1. Create empty file `x`\n1. Create empty directory `y`\n1. Run\n```sh\n$ rustc -o a a.rs --extern t=x\n$ rustc -o a a.rs --extern t=y\n```\nBoth currently panic with stable.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/54b629285512582f9405ecfad05cb9c6acb0ecdd", "html_url": "https://github.com/rust-lang/rust/commit/54b629285512582f9405ecfad05cb9c6acb0ecdd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/54b629285512582f9405ecfad05cb9c6acb0ecdd/comments", "author": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "36815c6e3bbe3a38704e1e89038fa5f6bb9fe41d", "url": "https://api.github.com/repos/rust-lang/rust/commits/36815c6e3bbe3a38704e1e89038fa5f6bb9fe41d", "html_url": "https://github.com/rust-lang/rust/commit/36815c6e3bbe3a38704e1e89038fa5f6bb9fe41d"}, {"sha": "7169c7d1051a235d76eb24d704f19c1928abf383", "url": "https://api.github.com/repos/rust-lang/rust/commits/7169c7d1051a235d76eb24d704f19c1928abf383", "html_url": "https://github.com/rust-lang/rust/commit/7169c7d1051a235d76eb24d704f19c1928abf383"}], "stats": {"total": 53, "additions": 50, "deletions": 3}, "files": [{"sha": "d1e1fd54db9bf22bcacc11f105c8b56be3dc5c36", "filename": "compiler/rustc_error_messages/locales/en-US/metadata.ftl", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/54b629285512582f9405ecfad05cb9c6acb0ecdd/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fmetadata.ftl", "raw_url": "https://github.com/rust-lang/rust/raw/54b629285512582f9405ecfad05cb9c6acb0ecdd/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fmetadata.ftl", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fmetadata.ftl?ref=54b629285512582f9405ecfad05cb9c6acb0ecdd", "patch": "@@ -275,7 +275,7 @@ metadata_crate_location_unknown_type =\n     extern location for {$crate_name} is of an unknown type: {$path}\n \n metadata_lib_filename_form =\n-    file name should be lib*.rlib or {dll_prefix}*.{dll_suffix}\n+    file name should be lib*.rlib or {$dll_prefix}*{$dll_suffix}\n \n metadata_multiple_import_name_type =\n     multiple `import_name_type` arguments in a single `#[link]` attribute"}, {"sha": "6f7e6e09ca5eddfabcf7ff0c908c7ce2a9de72d9", "filename": "compiler/rustc_metadata/src/errors.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/54b629285512582f9405ecfad05cb9c6acb0ecdd/compiler%2Frustc_metadata%2Fsrc%2Ferrors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54b629285512582f9405ecfad05cb9c6acb0ecdd/compiler%2Frustc_metadata%2Fsrc%2Ferrors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_metadata%2Fsrc%2Ferrors.rs?ref=54b629285512582f9405ecfad05cb9c6acb0ecdd", "patch": "@@ -692,6 +692,7 @@ pub struct CrateLocationUnknownType<'a> {\n     #[primary_span]\n     pub span: Span,\n     pub path: &'a Path,\n+    pub crate_name: Symbol,\n }\n \n #[derive(Diagnostic)]"}, {"sha": "15546092e41a2bb37a80663b2b222963252bcb3a", "filename": "compiler/rustc_metadata/src/locator.rs", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/54b629285512582f9405ecfad05cb9c6acb0ecdd/compiler%2Frustc_metadata%2Fsrc%2Flocator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54b629285512582f9405ecfad05cb9c6acb0ecdd/compiler%2Frustc_metadata%2Fsrc%2Flocator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_metadata%2Fsrc%2Flocator.rs?ref=54b629285512582f9405ecfad05cb9c6acb0ecdd", "patch": "@@ -707,6 +707,12 @@ impl<'a> CrateLocator<'a> {\n                     loc.original().clone(),\n                 ));\n             }\n+            if !loc.original().is_file() {\n+                return Err(CrateError::ExternLocationNotFile(\n+                    self.crate_name,\n+                    loc.original().clone(),\n+                ));\n+            }\n             let Some(file) = loc.original().file_name().and_then(|s| s.to_str()) else {\n                 return Err(CrateError::ExternLocationNotFile(\n                     self.crate_name,\n@@ -1020,11 +1026,10 @@ impl CrateError {\n                     None => String::new(),\n                     Some(r) => format!(\" which `{}` depends on\", r.name),\n                 };\n-                // FIXME: There are no tests for CrateLocationUnknownType or LibFilenameForm\n                 if !locator.crate_rejections.via_filename.is_empty() {\n                     let mismatches = locator.crate_rejections.via_filename.iter();\n                     for CrateMismatch { path, .. } in mismatches {\n-                        sess.emit_err(CrateLocationUnknownType { span, path: &path });\n+                        sess.emit_err(CrateLocationUnknownType { span, path: &path, crate_name });\n                         sess.emit_err(LibFilenameForm {\n                             span,\n                             dll_prefix: &locator.dll_prefix,"}, {"sha": "3f13d605232036ace6a2a913c5e27212c0fc27dc", "filename": "src/test/ui/errors/issue-104621-extern-bad-file.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/54b629285512582f9405ecfad05cb9c6acb0ecdd/src%2Ftest%2Fui%2Ferrors%2Fissue-104621-extern-bad-file.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54b629285512582f9405ecfad05cb9c6acb0ecdd/src%2Ftest%2Fui%2Ferrors%2Fissue-104621-extern-bad-file.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ferrors%2Fissue-104621-extern-bad-file.rs?ref=54b629285512582f9405ecfad05cb9c6acb0ecdd", "patch": "@@ -0,0 +1,8 @@\n+// compile-flags: --extern foo={{src-base}}/errors/issue-104621-extern-bad-file.rs\n+// only-linux\n+\n+extern crate foo;\n+//~^ ERROR extern location for foo is of an unknown type\n+//~| ERROR file name should be lib*.rlib or lib*.so\n+//~| ERROR can't find crate for `foo` [E0463]\n+fn main() {}"}, {"sha": "b8500ad0e045b8f154042a8c0c4ff2e28eeb240e", "filename": "src/test/ui/errors/issue-104621-extern-bad-file.stderr", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/54b629285512582f9405ecfad05cb9c6acb0ecdd/src%2Ftest%2Fui%2Ferrors%2Fissue-104621-extern-bad-file.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/54b629285512582f9405ecfad05cb9c6acb0ecdd/src%2Ftest%2Fui%2Ferrors%2Fissue-104621-extern-bad-file.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ferrors%2Fissue-104621-extern-bad-file.stderr?ref=54b629285512582f9405ecfad05cb9c6acb0ecdd", "patch": "@@ -0,0 +1,21 @@\n+error: extern location for foo is of an unknown type: $DIR/issue-104621-extern-bad-file.rs\n+  --> $DIR/issue-104621-extern-bad-file.rs:4:1\n+   |\n+LL | extern crate foo;\n+   | ^^^^^^^^^^^^^^^^^\n+\n+error: file name should be lib*.rlib or lib*.so\n+  --> $DIR/issue-104621-extern-bad-file.rs:4:1\n+   |\n+LL | extern crate foo;\n+   | ^^^^^^^^^^^^^^^^^\n+\n+error[E0463]: can't find crate for `foo`\n+  --> $DIR/issue-104621-extern-bad-file.rs:4:1\n+   |\n+LL | extern crate foo;\n+   | ^^^^^^^^^^^^^^^^^ can't find crate\n+\n+error: aborting due to 3 previous errors\n+\n+For more information about this error, try `rustc --explain E0463`."}, {"sha": "899e45a306b052be90ff11c698705cf2d3555a50", "filename": "src/test/ui/errors/issue-104621-extern-not-file.rs", "status": "added", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/54b629285512582f9405ecfad05cb9c6acb0ecdd/src%2Ftest%2Fui%2Ferrors%2Fissue-104621-extern-not-file.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54b629285512582f9405ecfad05cb9c6acb0ecdd/src%2Ftest%2Fui%2Ferrors%2Fissue-104621-extern-not-file.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ferrors%2Fissue-104621-extern-not-file.rs?ref=54b629285512582f9405ecfad05cb9c6acb0ecdd", "patch": "@@ -0,0 +1,4 @@\n+// compile-flags: --extern foo=.\n+\n+extern crate foo; //~ ERROR extern location for foo is not a file: .\n+fn main() {}"}, {"sha": "5aaf9741360ef85bb52f03b5f3b6c3a76d931e5a", "filename": "src/test/ui/errors/issue-104621-extern-not-file.stderr", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/54b629285512582f9405ecfad05cb9c6acb0ecdd/src%2Ftest%2Fui%2Ferrors%2Fissue-104621-extern-not-file.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/54b629285512582f9405ecfad05cb9c6acb0ecdd/src%2Ftest%2Fui%2Ferrors%2Fissue-104621-extern-not-file.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ferrors%2Fissue-104621-extern-not-file.stderr?ref=54b629285512582f9405ecfad05cb9c6acb0ecdd", "patch": "@@ -0,0 +1,8 @@\n+error: extern location for foo is not a file: .\n+  --> $DIR/issue-104621-extern-not-file.rs:3:1\n+   |\n+LL | extern crate foo;\n+   | ^^^^^^^^^^^^^^^^^\n+\n+error: aborting due to previous error\n+"}]}