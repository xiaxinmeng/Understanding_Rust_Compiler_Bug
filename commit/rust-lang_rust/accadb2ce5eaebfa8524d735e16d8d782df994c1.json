{"sha": "accadb2ce5eaebfa8524d735e16d8d782df994c1", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFjY2FkYjJjZTVlYWViZmE4NTI0ZDczNWUxNmQ4ZDc4MmRmOTk0YzE=", "commit": {"author": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-02-14T08:14:48Z"}, "committer": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-02-14T10:25:28Z"}, "message": "Rollup merge of #48181 - michaelwoerister:fix-incr-dir-finalization, r=nikomatsakis\n\nincr.comp.: Run cache directory garbage collection before loading dep-graph.\n\nPrior to this PR, the incr. comp. cache directory would only be garbage collected after the final output artifacts were generated. However, compilation often aborts earlier and in the case of the RLS, which starts lots of compilation sessions, we might fill up the cache directory with chunk sessions.\n\nThis PR makes the compiler do a garbage collection run before loading the dep-graph.\n\ncc @nrc https://github.com/rust-lang/rust/issues/48172\n\nr? @nikomatsakis", "tree": {"sha": "f9ff3419366e768b1cb6a9c33c99ed4e6bb11c2c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f9ff3419366e768b1cb6a9c33c99ed4e6bb11c2c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/accadb2ce5eaebfa8524d735e16d8d782df994c1", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEZ1R8CLMp8f2GxWoQ/vbIBR0OATwFAlqEDpgACgkQ/vbIBR0O\nATz7bg//f3gGEj28BDeh2kGScAkTF3wpmeZ7PwrhDUnXhj3DnHJhTCVGenmHIVpF\nzZA/+Dy9cX6hO8hi/2dvWGzhdf7xd18woiVf1t/jqv7U/8pD0nCAQgMGkkGdcTA3\nFzLraANg8gSrSAeUKTjCrG9xtvM3DqNHiaIwez4ujoiWWkmGwngt+o2jUeHL5Eol\nwxA4kwXutaqeX2vswgW1FxVCo9oXRCk5cOdeANk4w9Rr2t6Wnnmp2v72XzV+at2g\nYo6BI6xa5l5tLTG3FX0Zug5DnS77LaB31Lt3RjFe7WZmo+HOZf+k3iANxnC3qW/3\n5JGQBGKd6PEz3q16ymcNEP2whX9V38CGDEsFvFOcKKOHGbrGJQ/tloRHK+k+YRU/\n4Ug1RTnIEScrK0GzIPmlS5VhPxWCEZkxdgkuRtZqdFhPo4TRUmFIIfpAZG7TOq3V\nGuhMVRDldiPKa5hRsGytuRCuoJHToIRQq4WRp0REIr5RGMphlLEk7ZSNOAqLzrOB\n2hfiLIYMFAOCZsslox6oe7UsoliDhHkELOoaS4xwR5GL+OZ1kg1HUSOlyAVQL46K\nCBw6Z65Pstn/VU6JmXx3Ad3ZmZ7hKw7SulTMKv5j33WVVOFidyAzoAsvOwX++zLu\nWM46qAtgRibkcODEUJ7qWuqEVSB/l9dmPX5s+PxW3izYUAs9ekI=\n=w8ou\n-----END PGP SIGNATURE-----", "payload": "tree f9ff3419366e768b1cb6a9c33c99ed4e6bb11c2c\nparent dc9d93f220c2adb3d89936fb2d82e1bebad0ddc7\nparent 580dd42cfaefcb3189eab786224403ffe45bd37f\nauthor kennytm <kennytm@gmail.com> 1518596088 +0800\ncommitter kennytm <kennytm@gmail.com> 1518603928 +0800\n\nRollup merge of #48181 - michaelwoerister:fix-incr-dir-finalization, r=nikomatsakis\n\nincr.comp.: Run cache directory garbage collection before loading dep-graph.\n\nPrior to this PR, the incr. comp. cache directory would only be garbage collected after the final output artifacts were generated. However, compilation often aborts earlier and in the case of the RLS, which starts lots of compilation sessions, we might fill up the cache directory with chunk sessions.\n\nThis PR makes the compiler do a garbage collection run before loading the dep-graph.\n\ncc @nrc https://github.com/rust-lang/rust/issues/48172\n\nr? @nikomatsakis\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/accadb2ce5eaebfa8524d735e16d8d782df994c1", "html_url": "https://github.com/rust-lang/rust/commit/accadb2ce5eaebfa8524d735e16d8d782df994c1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/accadb2ce5eaebfa8524d735e16d8d782df994c1/comments", "author": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "dc9d93f220c2adb3d89936fb2d82e1bebad0ddc7", "url": "https://api.github.com/repos/rust-lang/rust/commits/dc9d93f220c2adb3d89936fb2d82e1bebad0ddc7", "html_url": "https://github.com/rust-lang/rust/commit/dc9d93f220c2adb3d89936fb2d82e1bebad0ddc7"}, {"sha": "580dd42cfaefcb3189eab786224403ffe45bd37f", "url": "https://api.github.com/repos/rust-lang/rust/commits/580dd42cfaefcb3189eab786224403ffe45bd37f", "html_url": "https://github.com/rust-lang/rust/commit/580dd42cfaefcb3189eab786224403ffe45bd37f"}], "stats": {"total": 29, "additions": 27, "deletions": 2}, "files": [{"sha": "b8a1fe99105406b63edbe42f6bb6e343a38578d6", "filename": "src/librustc_driver/driver.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/accadb2ce5eaebfa8524d735e16d8d782df994c1/src%2Flibrustc_driver%2Fdriver.rs", "raw_url": "https://github.com/rust-lang/rust/raw/accadb2ce5eaebfa8524d735e16d8d782df994c1/src%2Flibrustc_driver%2Fdriver.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Fdriver.rs?ref=accadb2ce5eaebfa8524d735e16d8d782df994c1", "patch": "@@ -660,6 +660,15 @@ pub fn phase_2_configure_and_expand_inner<'a, F>(sess: &'a Session,\n         disambiguator,\n     );\n \n+    if sess.opts.incremental.is_some() {\n+        time(time_passes, \"garbage collect incremental cache directory\", || {\n+            if let Err(e) = rustc_incremental::garbage_collect_session_directories(sess) {\n+                warn!(\"Error while trying to garbage collect incremental \\\n+                       compilation cache directory: {}\", e);\n+            }\n+        });\n+    }\n+\n     // If necessary, compute the dependency graph (in the background).\n     let future_dep_graph = if sess.opts.build_dep_graph() {\n         Some(rustc_incremental::load_dep_graph(sess, time_passes))"}, {"sha": "65fbd9d0bf8f1a213a02dbe72347c60a1c1def77", "filename": "src/librustc_incremental/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/accadb2ce5eaebfa8524d735e16d8d782df994c1/src%2Flibrustc_incremental%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/accadb2ce5eaebfa8524d735e16d8d782df994c1/src%2Flibrustc_incremental%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_incremental%2Flib.rs?ref=accadb2ce5eaebfa8524d735e16d8d782df994c1", "patch": "@@ -46,3 +46,4 @@ pub use persist::in_incr_comp_dir;\n pub use persist::prepare_session_directory;\n pub use persist::finalize_session_directory;\n pub use persist::delete_workproduct_files;\n+pub use persist::garbage_collect_session_directories;"}, {"sha": "795825f180c9dfdcb0658b1c2a1e6898043fff7a", "filename": "src/librustc_incremental/persist/fs.rs", "status": "modified", "additions": 15, "deletions": 1, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/accadb2ce5eaebfa8524d735e16d8d782df994c1/src%2Flibrustc_incremental%2Fpersist%2Ffs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/accadb2ce5eaebfa8524d735e16d8d782df994c1/src%2Flibrustc_incremental%2Fpersist%2Ffs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_incremental%2Fpersist%2Ffs.rs?ref=accadb2ce5eaebfa8524d735e16d8d782df994c1", "patch": "@@ -603,7 +603,7 @@ fn timestamp_to_string(timestamp: SystemTime) -> String {\n }\n \n fn string_to_timestamp(s: &str) -> Result<SystemTime, ()> {\n-    let micros_since_unix_epoch = u64::from_str_radix(s, 36);\n+    let micros_since_unix_epoch = u64::from_str_radix(s, INT_ENCODE_BASE as u32);\n \n     if micros_since_unix_epoch.is_err() {\n         return Err(())\n@@ -733,6 +733,20 @@ pub fn garbage_collect_session_directories(sess: &Session) -> io::Result<()> {\n                                 })\n                                 .collect();\n \n+    // Delete all session directories that don't have a lock file.\n+    for directory_name in session_directories {\n+        if !lock_file_to_session_dir.values().any(|dir| *dir == directory_name) {\n+            let path = crate_directory.join(directory_name);\n+            if let Err(err) = safe_remove_dir_all(&path) {\n+                sess.warn(&format!(\"Failed to garbage collect invalid incremental \\\n+                                    compilation session directory `{}`: {}\",\n+                                    path.display(),\n+                                    err));\n+            }\n+        }\n+    }\n+\n+    // Now garbage collect the valid session directories.\n     let mut deletion_candidates = vec![];\n     let mut definitely_delete = vec![];\n "}, {"sha": "2f864aaefba89df6fb0a9075260e1ba0f8d53344", "filename": "src/librustc_incremental/persist/mod.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/accadb2ce5eaebfa8524d735e16d8d782df994c1/src%2Flibrustc_incremental%2Fpersist%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/accadb2ce5eaebfa8524d735e16d8d782df994c1/src%2Flibrustc_incremental%2Fpersist%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_incremental%2Fpersist%2Fmod.rs?ref=accadb2ce5eaebfa8524d735e16d8d782df994c1", "patch": "@@ -20,9 +20,10 @@ mod save;\n mod work_product;\n mod file_format;\n \n-pub use self::fs::prepare_session_directory;\n pub use self::fs::finalize_session_directory;\n+pub use self::fs::garbage_collect_session_directories;\n pub use self::fs::in_incr_comp_dir;\n+pub use self::fs::prepare_session_directory;\n pub use self::load::dep_graph_tcx_init;\n pub use self::load::load_dep_graph;\n pub use self::load::load_query_result_cache;"}]}