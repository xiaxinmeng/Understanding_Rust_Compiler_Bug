{"sha": "0009fad4356a520228e0e3c8c2883c713d823e44", "node_id": "MDY6Q29tbWl0NzI0NzEyOjAwMDlmYWQ0MzU2YTUyMDIyOGUwZTNjOGMyODgzYzcxM2Q4MjNlNDQ=", "commit": {"author": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-08-24T08:44:51Z"}, "committer": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-08-24T11:24:45Z"}, "message": "Rollup merge of #53644 - llogiq:smallvec-for-small-c-str, r=estebank\n\nUse SmallVec for SmallCStr\n\nThis reuses the awesome optimizations from Servo's `SmallVec` to speed up `SmallCStr`.", "tree": {"sha": "4ec20583455572577c75b0375869dde566d90f87", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4ec20583455572577c75b0375869dde566d90f87"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0009fad4356a520228e0e3c8c2883c713d823e44", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEZ1R8CLMp8f2GxWoQ/vbIBR0OATwFAlt/6v4ACgkQ/vbIBR0O\nATwBTxAAn+IiNfT2LqKiijkCh1GfmNue1EUc+KSFBOqBiNdUnUHgn/hLvjKvtlSC\niG4CYqvRAqa9IxydHHnB63zAZpATZYNJb8jQqau89dj7OqQ7NqKetf1GQ17KUWiX\nTsVuYua+GZ9o7/Z8sCb12OBo6v7ypSmJnowildFMYt4wbUTF5j+7OZbLlb0ZPGwr\nkXRYUE4jXK4ElOWg0Ah9E35KoMmBYki/CkXyOL1blArUC26VroSMVLQ2uM9Q5rR9\nned5chOChz3VdAImlrUyuxz0X1dHVHOrQwiJgvRp4c3Vnmw7JSnblxUL88DrBpIi\ni5E8Rv+UWLwZjqHSeWbBzklO3bpFxESCL6Pqnfa4JQJhHXzrk04RDa9hS6akD0H5\nZxGsOgacPiPnb6yndp7HdHohKcSCId0IkcL0g3DoydIYDy0m32tTrciGHvNC2eXO\nMh/4OcJagwX2e0CDFFpvkRnWUb2zh+NfVALLRM/gisfe4NHDWb2XdWSaThzil1UB\nvZybi/y0Sa80QC7eJACqPl2lYHfTbHiSuAA1Yb9KeijekibpQ1t5BwhrYnMVGieb\nEHlZPEw13CZRvUd+fJ+OHz2MycH8IqKtkr61AqqsPUBaJqyzvkYnayyYUnbRgps0\nkMRmPlg8gPwrkFhLvjZtfWaA/FOmK0V0EzJnmUDEgSNt+F05QX0=\n=5f/Y\n-----END PGP SIGNATURE-----", "payload": "tree 4ec20583455572577c75b0375869dde566d90f87\nparent 9dfb95b11fe61357e9f4ed9a8903a80cdaa06495\nparent 25a83e3a88bf5f199c8a8d8d8f452bab83d9a061\nauthor kennytm <kennytm@gmail.com> 1535100291 +0800\ncommitter kennytm <kennytm@gmail.com> 1535109885 +0800\n\nRollup merge of #53644 - llogiq:smallvec-for-small-c-str, r=estebank\n\nUse SmallVec for SmallCStr\n\nThis reuses the awesome optimizations from Servo's `SmallVec` to speed up `SmallCStr`.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0009fad4356a520228e0e3c8c2883c713d823e44", "html_url": "https://github.com/rust-lang/rust/commit/0009fad4356a520228e0e3c8c2883c713d823e44", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0009fad4356a520228e0e3c8c2883c713d823e44/comments", "author": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9dfb95b11fe61357e9f4ed9a8903a80cdaa06495", "url": "https://api.github.com/repos/rust-lang/rust/commits/9dfb95b11fe61357e9f4ed9a8903a80cdaa06495", "html_url": "https://github.com/rust-lang/rust/commit/9dfb95b11fe61357e9f4ed9a8903a80cdaa06495"}, {"sha": "25a83e3a88bf5f199c8a8d8d8f452bab83d9a061", "url": "https://api.github.com/repos/rust-lang/rust/commits/25a83e3a88bf5f199c8a8d8d8f452bab83d9a061", "html_url": "https://github.com/rust-lang/rust/commit/25a83e3a88bf5f199c8a8d8d8f452bab83d9a061"}], "stats": {"total": 87, "additions": 39, "deletions": 48}, "files": [{"sha": "08794fbec8dc5df7adb7ae66083e137e94b85b64", "filename": "src/librustc_data_structures/small_c_str.rs", "status": "modified", "additions": 39, "deletions": 48, "changes": 87, "blob_url": "https://github.com/rust-lang/rust/blob/0009fad4356a520228e0e3c8c2883c713d823e44/src%2Flibrustc_data_structures%2Fsmall_c_str.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0009fad4356a520228e0e3c8c2883c713d823e44/src%2Flibrustc_data_structures%2Fsmall_c_str.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_data_structures%2Fsmall_c_str.rs?ref=0009fad4356a520228e0e3c8c2883c713d823e44", "patch": "@@ -11,69 +11,61 @@\n use std::ffi;\n use std::ops::Deref;\n \n-const SIZE: usize = 38;\n+use smallvec::SmallVec;\n+\n+const SIZE: usize = 36;\n \n /// Like SmallVec but for C strings.\n #[derive(Clone)]\n-pub enum SmallCStr {\n-    OnStack {\n-        data: [u8; SIZE],\n-        len_with_nul: u8,\n-    },\n-    OnHeap {\n-        data: ffi::CString,\n-    }\n+pub struct SmallCStr {\n+    data: SmallVec<[u8; SIZE]>,\n }\n \n impl SmallCStr {\n     #[inline]\n     pub fn new(s: &str) -> SmallCStr {\n-        if s.len() < SIZE {\n-            let mut data = [0; SIZE];\n-            data[.. s.len()].copy_from_slice(s.as_bytes());\n-            let len_with_nul = s.len() + 1;\n-\n-            // Make sure once that this is a valid CStr\n-            if let Err(e) = ffi::CStr::from_bytes_with_nul(&data[.. len_with_nul]) {\n-                panic!(\"The string \\\"{}\\\" cannot be converted into a CStr: {}\", s, e);\n-            }\n-\n-            SmallCStr::OnStack {\n-                data,\n-                len_with_nul: len_with_nul as u8,\n-            }\n+        let len = s.len();\n+        let len1 = len + 1;\n+        let data = if len < SIZE {\n+            let mut buf = [0; SIZE];\n+            buf[..len].copy_from_slice(s.as_bytes());\n+            SmallVec::from_buf_and_len(buf, len1)\n         } else {\n-            SmallCStr::OnHeap {\n-                data: ffi::CString::new(s).unwrap()\n-            }\n+            let mut data = Vec::with_capacity(len1);\n+            data.extend_from_slice(s.as_bytes());\n+            data.push(0);\n+            SmallVec::from_vec(data)\n+        };\n+        if let Err(e) = ffi::CStr::from_bytes_with_nul(&data) {\n+            panic!(\"The string \\\"{}\\\" cannot be converted into a CStr: {}\", s, e);\n         }\n+        SmallCStr { data }\n     }\n \n+    #[inline]\n+    pub fn new_with_nul(s: &str) -> SmallCStr {\n+        let b = s.as_bytes();\n+        if let Err(e) = ffi::CStr::from_bytes_with_nul(b) {\n+            panic!(\"The string \\\"{}\\\" cannot be converted into a CStr: {}\", s, e);\n+        }\n+        SmallCStr { data: SmallVec::from_slice(s.as_bytes()) }\n+    }\n+\n+\n     #[inline]\n     pub fn as_c_str(&self) -> &ffi::CStr {\n-        match *self {\n-            SmallCStr::OnStack { ref data, len_with_nul } => {\n-                unsafe {\n-                    let slice = &data[.. len_with_nul as usize];\n-                    ffi::CStr::from_bytes_with_nul_unchecked(slice)\n-                }\n-            }\n-            SmallCStr::OnHeap { ref data } => {\n-                data.as_c_str()\n-            }\n+        unsafe {\n+            ffi::CStr::from_bytes_with_nul_unchecked(&self.data[..])\n         }\n     }\n \n     #[inline]\n     pub fn len_with_nul(&self) -> usize {\n-        match *self {\n-            SmallCStr::OnStack { len_with_nul, .. } => {\n-                len_with_nul as usize\n-            }\n-            SmallCStr::OnHeap { ref data } => {\n-                data.as_bytes_with_nul().len()\n-            }\n-        }\n+        self.data.len()\n+    }\n+\n+    pub fn spilled(&self) -> bool {\n+        self.data.spilled()\n     }\n }\n \n@@ -85,7 +77,6 @@ impl Deref for SmallCStr {\n     }\n }\n \n-\n #[test]\n fn short() {\n     const TEXT: &str = \"abcd\";\n@@ -95,7 +86,7 @@ fn short() {\n \n     assert_eq!(scs.len_with_nul(), TEXT.len() + 1);\n     assert_eq!(scs.as_c_str(), reference.as_c_str());\n-    assert!(if let SmallCStr::OnStack { .. } = scs { true } else { false });\n+    assert!(!scs.spilled());\n }\n \n #[test]\n@@ -107,7 +98,7 @@ fn empty() {\n \n     assert_eq!(scs.len_with_nul(), TEXT.len() + 1);\n     assert_eq!(scs.as_c_str(), reference.as_c_str());\n-    assert!(if let SmallCStr::OnStack { .. } = scs { true } else { false });\n+    assert!(!scs.spilled());\n }\n \n #[test]\n@@ -121,7 +112,7 @@ fn long() {\n \n     assert_eq!(scs.len_with_nul(), TEXT.len() + 1);\n     assert_eq!(scs.as_c_str(), reference.as_c_str());\n-    assert!(if let SmallCStr::OnHeap { .. } = scs { true } else { false });\n+    assert!(scs.spilled());\n }\n \n #[test]"}]}