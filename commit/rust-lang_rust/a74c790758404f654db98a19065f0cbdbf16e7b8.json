{"sha": "a74c790758404f654db98a19065f0cbdbf16e7b8", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE3NGM3OTA3NTg0MDRmNjU0ZGI5OGExOTA2NWYwY2JkYmYxNmU3Yjg=", "commit": {"author": {"name": "Yuki Okushi", "email": "huyuumi.dev@gmail.com", "date": "2020-01-10T19:50:49Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-01-10T19:50:49Z"}, "message": "Rollup merge of #68019 - cuviper:in-tree-compiletest, r=Mark-Simulacrum\n\nBuild compiletest with in-tree libtest\n\nThis updates compiletest to build in `Mode::ToolStd`, using the locally-built crates for `std` and especially `test`. This way we're immune to unstable differences in the bootstrap compiler crates, whether that's a prior-release stage0 or a current release local rebuild. Fixes #59264.\n\nAs a minor cleanup, this also removes the unused `llvm_tools` flag.", "tree": {"sha": "a9109b4d6fcaeb9905f0e6e2cabb1f6baf69a173", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a9109b4d6fcaeb9905f0e6e2cabb1f6baf69a173"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a74c790758404f654db98a19065f0cbdbf16e7b8", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJeGNWaCRBK7hj4Ov3rIwAAdHIIAD5FpJeOz+pbCW27bAiw1fY+\nfF+QipzfPlks89RDm89k33CtaxzCCD/5aeGWWT5Y5AOqW879bUjf/ZUFP8pbf/Sq\nxT+9sjPkiLI4gsGV+90GoxOL5zGh0HMb0ECxezy2HFNwWXQHfHsMHrMlWO3vy8FT\nwZvxELHHDzG9gVd35/v2PdGGQI3wTPZ/A9wLgne1OmxxJieSIWCr+iyRtNwIdCWm\nqtSUwp0WtN/Rs1rFqd0GYtn6DV6Tqz9uhhkPrZM3/5aaaqQ6Ns6/1ILhisB1+DMW\nQzgMsh8iKZQw5a8NFU5+toPBWv1UErOeTJiKkSN0klpeMvYiMEz7hWybacyk+kk=\n=w9rN\n-----END PGP SIGNATURE-----\n", "payload": "tree a9109b4d6fcaeb9905f0e6e2cabb1f6baf69a173\nparent a491100aa3e6d3dbc1f4633e446617ab31b18688\nparent 686d5f83efcd552465ce4ab236f2ffb66c055d90\nauthor Yuki Okushi <huyuumi.dev@gmail.com> 1578685849 +0900\ncommitter GitHub <noreply@github.com> 1578685849 +0900\n\nRollup merge of #68019 - cuviper:in-tree-compiletest, r=Mark-Simulacrum\n\nBuild compiletest with in-tree libtest\n\nThis updates compiletest to build in `Mode::ToolStd`, using the locally-built crates for `std` and especially `test`. This way we're immune to unstable differences in the bootstrap compiler crates, whether that's a prior-release stage0 or a current release local rebuild. Fixes #59264.\n\nAs a minor cleanup, this also removes the unused `llvm_tools` flag.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a74c790758404f654db98a19065f0cbdbf16e7b8", "html_url": "https://github.com/rust-lang/rust/commit/a74c790758404f654db98a19065f0cbdbf16e7b8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a74c790758404f654db98a19065f0cbdbf16e7b8/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a491100aa3e6d3dbc1f4633e446617ab31b18688", "url": "https://api.github.com/repos/rust-lang/rust/commits/a491100aa3e6d3dbc1f4633e446617ab31b18688", "html_url": "https://github.com/rust-lang/rust/commit/a491100aa3e6d3dbc1f4633e446617ab31b18688"}, {"sha": "686d5f83efcd552465ce4ab236f2ffb66c055d90", "url": "https://api.github.com/repos/rust-lang/rust/commits/686d5f83efcd552465ce4ab236f2ffb66c055d90", "html_url": "https://github.com/rust-lang/rust/commit/686d5f83efcd552465ce4ab236f2ffb66c055d90"}], "stats": {"total": 24, "additions": 11, "deletions": 13}, "files": [{"sha": "7f24768a4f10e54cce459ab65dc2af4f46134f0f", "filename": "src/bootstrap/tool.rs", "status": "modified", "additions": 8, "deletions": 12, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/a74c790758404f654db98a19065f0cbdbf16e7b8/src%2Fbootstrap%2Ftool.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a74c790758404f654db98a19065f0cbdbf16e7b8/src%2Fbootstrap%2Ftool.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Ftool.rs?ref=a74c790758404f654db98a19065f0cbdbf16e7b8", "patch": "@@ -289,8 +289,8 @@ fn rustbook_features() -> Vec<String> {\n macro_rules! bootstrap_tool {\n     ($(\n         $name:ident, $path:expr, $tool_name:expr\n-        $(,llvm_tools = $llvm:expr)*\n         $(,is_external_tool = $external:expr)*\n+        $(,is_unstable_tool = $unstable:expr)*\n         $(,features = $features:expr)*\n         ;\n     )+) => {\n@@ -301,15 +301,6 @@ macro_rules! bootstrap_tool {\n             )+\n         }\n \n-        impl Tool {\n-            /// Whether this tool requires LLVM to run\n-            pub fn uses_llvm_tools(&self) -> bool {\n-                match self {\n-                    $(Tool::$name => false $(|| $llvm)*,)+\n-                }\n-            }\n-        }\n-\n         impl<'a> Builder<'a> {\n             pub fn tool_exe(&self, tool: Tool) -> PathBuf {\n                 match tool {\n@@ -350,7 +341,12 @@ macro_rules! bootstrap_tool {\n                     compiler: self.compiler,\n                     target: self.target,\n                     tool: $tool_name,\n-                    mode: Mode::ToolBootstrap,\n+                    mode: if false $(|| $unstable)* {\n+                        // use in-tree libraries for unstable features\n+                        Mode::ToolStd\n+                    } else {\n+                        Mode::ToolBootstrap\n+                    },\n                     path: $path,\n                     is_optional_tool: false,\n                     source_type: if false $(|| $external)* {\n@@ -377,7 +373,7 @@ bootstrap_tool!(\n     Tidy, \"src/tools/tidy\", \"tidy\";\n     Linkchecker, \"src/tools/linkchecker\", \"linkchecker\";\n     CargoTest, \"src/tools/cargotest\", \"cargotest\";\n-    Compiletest, \"src/tools/compiletest\", \"compiletest\", llvm_tools = true;\n+    Compiletest, \"src/tools/compiletest\", \"compiletest\", is_unstable_tool = true;\n     BuildManifest, \"src/tools/build-manifest\", \"build-manifest\";\n     RemoteTestClient, \"src/tools/remote-test-client\", \"remote-test-client\";\n     RustInstaller, \"src/tools/rust-installer\", \"fabricate\", is_external_tool = true;"}, {"sha": "0642823404aedfca07db67d9fa3b7236f4a53e99", "filename": "src/tools/compiletest/src/main.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/a74c790758404f654db98a19065f0cbdbf16e7b8/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a74c790758404f654db98a19065f0cbdbf16e7b8/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs?ref=a74c790758404f654db98a19065f0cbdbf16e7b8", "patch": "@@ -1,6 +1,8 @@\n #![crate_name = \"compiletest\"]\n-#![feature(test)]\n #![deny(warnings)]\n+// The `test` crate is the only unstable feature\n+// allowed here, just to share similar code.\n+#![feature(test)]\n \n extern crate test;\n "}]}