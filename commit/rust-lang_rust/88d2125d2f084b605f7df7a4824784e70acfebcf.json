{"sha": "88d2125d2f084b605f7df7a4824784e70acfebcf", "node_id": "C_kwDOAAsO6NoAKDg4ZDIxMjVkMmYwODRiNjA1ZjdkZjdhNDgyNDc4NGU3MGFjZmViY2Y", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-05-18T01:32:17Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-05-18T01:32:17Z"}, "message": "Auto merge of #14811 - Veykril:closure-hover, r=HKalbasi\n\nfeat: Render hover actions for closure captures and sig\n\nAlso special cases closures for ranged type hover to render the closure hover instead", "tree": {"sha": "b3773c19280169d3382cdc3785e6a457a0d8e3a3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b3773c19280169d3382cdc3785e6a457a0d8e3a3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/88d2125d2f084b605f7df7a4824784e70acfebcf", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/88d2125d2f084b605f7df7a4824784e70acfebcf", "html_url": "https://github.com/rust-lang/rust/commit/88d2125d2f084b605f7df7a4824784e70acfebcf", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/88d2125d2f084b605f7df7a4824784e70acfebcf/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2f8cd66fb4c98026d2bdbdf17270e3472e1ca42a", "url": "https://api.github.com/repos/rust-lang/rust/commits/2f8cd66fb4c98026d2bdbdf17270e3472e1ca42a", "html_url": "https://github.com/rust-lang/rust/commit/2f8cd66fb4c98026d2bdbdf17270e3472e1ca42a"}, {"sha": "ba8bcde4f5f0033752d772d4026468e7a8747072", "url": "https://api.github.com/repos/rust-lang/rust/commits/ba8bcde4f5f0033752d772d4026468e7a8747072", "html_url": "https://github.com/rust-lang/rust/commit/ba8bcde4f5f0033752d772d4026468e7a8747072"}], "stats": {"total": 216, "additions": 173, "deletions": 43}, "files": [{"sha": "907c94ea6b19352cf0772e7e13707a40dc2b3c0b", "filename": "crates/hir-ty/src/infer/closure.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/88d2125d2f084b605f7df7a4824784e70acfebcf/crates%2Fhir-ty%2Fsrc%2Finfer%2Fclosure.rs", "raw_url": "https://github.com/rust-lang/rust/raw/88d2125d2f084b605f7df7a4824784e70acfebcf/crates%2Fhir-ty%2Fsrc%2Finfer%2Fclosure.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-ty%2Fsrc%2Finfer%2Fclosure.rs?ref=88d2125d2f084b605f7df7a4824784e70acfebcf", "patch": "@@ -166,6 +166,10 @@ impl CapturedItem {\n         self.place.local\n     }\n \n+    pub fn ty(&self, subst: &Substitution) -> Ty {\n+        self.ty.clone().substitute(Interner, utils::ClosureSubst(subst).parent_subst())\n+    }\n+\n     pub fn kind(&self) -> CaptureKind {\n         self.kind\n     }"}, {"sha": "3e5087474281b4fbfa848faec6b0c55be856e68b", "filename": "crates/hir/src/lib.rs", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/88d2125d2f084b605f7df7a4824784e70acfebcf/crates%2Fhir%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/88d2125d2f084b605f7df7a4824784e70acfebcf/crates%2Fhir%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Flib.rs?ref=88d2125d2f084b605f7df7a4824784e70acfebcf", "patch": "@@ -3221,6 +3221,20 @@ impl Closure {\n             .collect()\n     }\n \n+    pub fn capture_types(&self, db: &dyn HirDatabase) -> Vec<Type> {\n+        let owner = db.lookup_intern_closure((self.id).into()).0;\n+        let infer = &db.infer(owner);\n+        let (captures, _) = infer.closure_info(&self.id);\n+        captures\n+            .iter()\n+            .cloned()\n+            .map(|capture| Type {\n+                env: db.trait_environment_for_body(owner),\n+                ty: capture.ty(&self.subst),\n+            })\n+            .collect()\n+    }\n+\n     pub fn fn_trait(&self, db: &dyn HirDatabase) -> FnTrait {\n         let owner = db.lookup_intern_closure((self.id).into()).0;\n         let infer = &db.infer(owner);"}, {"sha": "3b639104efe7cef27b25034d8795249ee4e0e0ba", "filename": "crates/ide/src/highlight_related.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/88d2125d2f084b605f7df7a4824784e70acfebcf/crates%2Fide%2Fsrc%2Fhighlight_related.rs", "raw_url": "https://github.com/rust-lang/rust/raw/88d2125d2f084b605f7df7a4824784e70acfebcf/crates%2Fide%2Fsrc%2Fhighlight_related.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fhighlight_related.rs?ref=88d2125d2f084b605f7df7a4824784e70acfebcf", "patch": "@@ -54,9 +54,10 @@ pub(crate) fn highlight_related(\n \n     let token = pick_best_token(syntax.token_at_offset(offset), |kind| match kind {\n         T![?] => 4, // prefer `?` when the cursor is sandwiched like in `await$0?`\n-        T![->] | T![|] => 3,\n-        kind if kind.is_keyword() => 2,\n-        IDENT | INT_NUMBER => 1,\n+        T![->] => 4,\n+        kind if kind.is_keyword() => 3,\n+        IDENT | INT_NUMBER => 2,\n+        T![|] => 1,\n         _ => 0,\n     })?;\n     // most if not all of these should be re-implemented with information seeded from hir"}, {"sha": "c2b9222cb959801dabf15ed8966702d60f23502e", "filename": "crates/ide/src/hover/render.rs", "status": "modified", "additions": 73, "deletions": 40, "changes": 113, "blob_url": "https://github.com/rust-lang/rust/blob/88d2125d2f084b605f7df7a4824784e70acfebcf/crates%2Fide%2Fsrc%2Fhover%2Frender.rs", "raw_url": "https://github.com/rust-lang/rust/raw/88d2125d2f084b605f7df7a4824784e70acfebcf/crates%2Fide%2Fsrc%2Fhover%2Frender.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fhover%2Frender.rs?ref=88d2125d2f084b605f7df7a4824784e70acfebcf", "patch": "@@ -35,53 +35,20 @@ pub(super) fn type_info_of(\n     _config: &HoverConfig,\n     expr_or_pat: &Either<ast::Expr, ast::Pat>,\n ) -> Option<HoverResult> {\n-    let TypeInfo { original, adjusted } = match expr_or_pat {\n+    let ty_info = match expr_or_pat {\n         Either::Left(expr) => sema.type_of_expr(expr)?,\n         Either::Right(pat) => sema.type_of_pat(pat)?,\n     };\n-    type_info(sema, _config, original, adjusted)\n+    type_info(sema, _config, ty_info)\n }\n \n pub(super) fn closure_expr(\n     sema: &Semantics<'_, RootDatabase>,\n     config: &HoverConfig,\n     c: ast::ClosureExpr,\n ) -> Option<HoverResult> {\n-    let ty = &sema.type_of_expr(&c.into())?.original;\n-    let layout = if config.memory_layout {\n-        ty.layout(sema.db)\n-            .map(|x| format!(\" // size = {}, align = {}\", x.size.bytes(), x.align.abi.bytes()))\n-            .unwrap_or_default()\n-    } else {\n-        String::default()\n-    };\n-    let c = ty.as_closure()?;\n-    let mut captures = c\n-        .captured_items(sema.db)\n-        .into_iter()\n-        .map(|it| {\n-            let borrow_kind=   match it.kind() {\n-                CaptureKind::SharedRef => \"immutable borrow\",\n-                CaptureKind::UniqueSharedRef => \"unique immutable borrow ([read more](https://doc.rust-lang.org/stable/reference/types/closure.html#unique-immutable-borrows-in-captures))\",\n-                CaptureKind::MutableRef => \"mutable borrow\",\n-                CaptureKind::Move => \"move\",\n-            };\n-            format!(\"* `{}` by {}\", it.display_place(sema.db), borrow_kind)\n-        })\n-        .join(\"\\n\");\n-    if captures.trim().is_empty() {\n-        captures = \"This closure captures nothing\".to_string();\n-    }\n-    let mut res = HoverResult::default();\n-    res.markup = format!(\n-        \"```rust\\n{}{}\\n{}\\n```\\n\\n## Captures\\n{}\",\n-        c.display_with_id(sema.db),\n-        layout,\n-        c.display_with_impl(sema.db),\n-        captures,\n-    )\n-    .into();\n-    Some(res)\n+    let TypeInfo { original, .. } = sema.type_of_expr(&c.into())?;\n+    closure_ty(sema, config, &TypeInfo { original, adjusted: None })\n }\n \n pub(super) fn try_expr(\n@@ -522,10 +489,13 @@ pub(super) fn definition(\n \n fn type_info(\n     sema: &Semantics<'_, RootDatabase>,\n-    _config: &HoverConfig,\n-    original: hir::Type,\n-    adjusted: Option<hir::Type>,\n+    config: &HoverConfig,\n+    ty: TypeInfo,\n ) -> Option<HoverResult> {\n+    if let Some(res) = closure_ty(sema, config, &ty) {\n+        return Some(res);\n+    };\n+    let TypeInfo { original, adjusted } = ty;\n     let mut res = HoverResult::default();\n     let mut targets: Vec<hir::ModuleDef> = Vec::new();\n     let mut push_new_def = |item: hir::ModuleDef| {\n@@ -555,6 +525,69 @@ fn type_info(\n     Some(res)\n }\n \n+fn closure_ty(\n+    sema: &Semantics<'_, RootDatabase>,\n+    config: &HoverConfig,\n+    TypeInfo { original, adjusted }: &TypeInfo,\n+) -> Option<HoverResult> {\n+    let c = original.as_closure()?;\n+    let layout = if config.memory_layout {\n+        original\n+            .layout(sema.db)\n+            .map(|x| format!(\" // size = {}, align = {}\", x.size.bytes(), x.align.abi.bytes()))\n+            .unwrap_or_default()\n+    } else {\n+        String::default()\n+    };\n+    let mut captures_rendered = c.captured_items(sema.db)\n+        .into_iter()\n+        .map(|it| {\n+            let borrow_kind = match it.kind() {\n+                CaptureKind::SharedRef => \"immutable borrow\",\n+                CaptureKind::UniqueSharedRef => \"unique immutable borrow ([read more](https://doc.rust-lang.org/stable/reference/types/closure.html#unique-immutable-borrows-in-captures))\",\n+                CaptureKind::MutableRef => \"mutable borrow\",\n+                CaptureKind::Move => \"move\",\n+            };\n+            format!(\"* `{}` by {}\", it.display_place(sema.db), borrow_kind)\n+        })\n+        .join(\"\\n\");\n+    if captures_rendered.trim().is_empty() {\n+        captures_rendered = \"This closure captures nothing\".to_string();\n+    }\n+    let mut targets: Vec<hir::ModuleDef> = Vec::new();\n+    let mut push_new_def = |item: hir::ModuleDef| {\n+        if !targets.contains(&item) {\n+            targets.push(item);\n+        }\n+    };\n+    walk_and_push_ty(sema.db, original, &mut push_new_def);\n+    c.capture_types(sema.db).into_iter().for_each(|ty| {\n+        walk_and_push_ty(sema.db, &ty, &mut push_new_def);\n+    });\n+\n+    let adjusted = if let Some(adjusted_ty) = adjusted {\n+        walk_and_push_ty(sema.db, &adjusted_ty, &mut push_new_def);\n+        format!(\n+            \"\\nCoerced to: {}\",\n+            adjusted_ty.display(sema.db).with_closure_style(hir::ClosureStyle::ImplFn)\n+        )\n+    } else {\n+        String::new()\n+    };\n+\n+    let mut res = HoverResult::default();\n+    res.actions.push(HoverAction::goto_type_from_targets(sema.db, targets));\n+    res.markup = format!(\n+        \"```rust\\n{}{}\\n{}\\n```{adjusted}\\n\\n## Captures\\n{}\",\n+        c.display_with_id(sema.db),\n+        layout,\n+        c.display_with_impl(sema.db),\n+        captures_rendered,\n+    )\n+    .into();\n+    Some(res)\n+}\n+\n fn render_builtin_attr(db: &RootDatabase, attr: hir::BuiltinAttr) -> Option<Markup> {\n     let name = attr.name(db);\n     let desc = format!(\"#[{name}]\");"}, {"sha": "0d8fc8a5f72f2bb52f3c929a8f0defd9fce60634", "filename": "crates/ide/src/hover/tests.rs", "status": "modified", "additions": 78, "deletions": 0, "changes": 78, "blob_url": "https://github.com/rust-lang/rust/blob/88d2125d2f084b605f7df7a4824784e70acfebcf/crates%2Fide%2Fsrc%2Fhover%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/88d2125d2f084b605f7df7a4824784e70acfebcf/crates%2Fide%2Fsrc%2Fhover%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fhover%2Ftests.rs?ref=88d2125d2f084b605f7df7a4824784e70acfebcf", "patch": "@@ -114,6 +114,15 @@ fn check_hover_range(ra_fixture: &str, expect: Expect) {\n     expect.assert_eq(hover.info.markup.as_str())\n }\n \n+fn check_hover_range_actions(ra_fixture: &str, expect: Expect) {\n+    let (analysis, range) = fixture::range(ra_fixture);\n+    let hover = analysis\n+        .hover(&HoverConfig { links_in_hover: true, ..HOVER_BASE_CONFIG }, range)\n+        .unwrap()\n+        .unwrap();\n+    expect.assert_debug_eq(&hover.info.actions);\n+}\n+\n fn check_hover_range_no_results(ra_fixture: &str) {\n     let (analysis, range) = fixture::range(ra_fixture);\n     let hover = analysis.hover(&HOVER_BASE_CONFIG, range).unwrap();\n@@ -294,6 +303,75 @@ fn main() {\n     );\n }\n \n+#[test]\n+fn hover_ranged_closure() {\n+    check_hover_range(\n+        r#\"\n+//- minicore: fn\n+struct S;\n+struct S2;\n+fn main() {\n+    let x = &S;\n+    let y = ($0|| {x; S2}$0).call();\n+}\n+\"#,\n+        expect![[r#\"\n+            ```rust\n+            {closure#0} // size = 8, align = 8\n+            impl FnOnce() -> S2\n+            ```\n+            Coerced to: &impl FnOnce() -> S2\n+\n+            ## Captures\n+            * `x` by move\"#]],\n+    );\n+    check_hover_range_actions(\n+        r#\"\n+//- minicore: fn\n+struct S;\n+struct S2;\n+fn main() {\n+    let x = &S;\n+    let y = ($0|| {x; S2}$0).call();\n+}\n+\"#,\n+        expect![[r#\"\n+            [\n+                GoToType(\n+                    [\n+                        HoverGotoTypeData {\n+                            mod_path: \"test::S2\",\n+                            nav: NavigationTarget {\n+                                file_id: FileId(\n+                                    0,\n+                                ),\n+                                full_range: 10..20,\n+                                focus_range: 17..19,\n+                                name: \"S2\",\n+                                kind: Struct,\n+                                description: \"struct S2\",\n+                            },\n+                        },\n+                        HoverGotoTypeData {\n+                            mod_path: \"test::S\",\n+                            nav: NavigationTarget {\n+                                file_id: FileId(\n+                                    0,\n+                                ),\n+                                full_range: 0..9,\n+                                focus_range: 7..8,\n+                                name: \"S\",\n+                                kind: Struct,\n+                                description: \"struct S\",\n+                            },\n+                        },\n+                    ],\n+                ),\n+            ]\n+        \"#]],\n+    );\n+}\n+\n #[test]\n fn hover_shows_long_type_of_an_expression() {\n     check("}]}