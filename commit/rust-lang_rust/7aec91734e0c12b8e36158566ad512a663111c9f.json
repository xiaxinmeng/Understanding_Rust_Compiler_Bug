{"sha": "7aec91734e0c12b8e36158566ad512a663111c9f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdhZWM5MTczNGUwYzEyYjhlMzYxNTg1NjZhZDUxMmE2NjMxMTFjOWY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-10-19T12:45:25Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-10-19T12:45:25Z"}, "message": "Auto merge of #29153 - arcnmx:thread-spawn, r=alexcrichton\n\nFixes #29128\r\n\r\nMost of the weird lifetime things and `inner` stuff seems like leftover cruft from `thread::scoped`. Should `JoinInner` just be removed/merged with `JoinHandle`?\r\n\r\nAlso is it okay to remove the `FnBox`? I'm not really sure why there were two allocations there...", "tree": {"sha": "d2d3e5a0092bbf9e6f5c1f5d4cf955114e17a384", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d2d3e5a0092bbf9e6f5c1f5d4cf955114e17a384"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7aec91734e0c12b8e36158566ad512a663111c9f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7aec91734e0c12b8e36158566ad512a663111c9f", "html_url": "https://github.com/rust-lang/rust/commit/7aec91734e0c12b8e36158566ad512a663111c9f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7aec91734e0c12b8e36158566ad512a663111c9f/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3e268f2fbafca7e0a59bf77e17985a27c61d5a11", "url": "https://api.github.com/repos/rust-lang/rust/commits/3e268f2fbafca7e0a59bf77e17985a27c61d5a11", "html_url": "https://github.com/rust-lang/rust/commit/3e268f2fbafca7e0a59bf77e17985a27c61d5a11"}, {"sha": "1303687d4811e8c3e261e14adbfb9850b23ff973", "url": "https://api.github.com/repos/rust-lang/rust/commits/1303687d4811e8c3e261e14adbfb9850b23ff973", "html_url": "https://github.com/rust-lang/rust/commit/1303687d4811e8c3e261e14adbfb9850b23ff973"}], "stats": {"total": 39, "additions": 16, "deletions": 23}, "files": [{"sha": "9b8f63997b64278ffd88bbcf282cb8a5e6c02ad0", "filename": "src/libstd/thread/mod.rs", "status": "modified", "additions": 16, "deletions": 23, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/7aec91734e0c12b8e36158566ad512a663111c9f/src%2Flibstd%2Fthread%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7aec91734e0c12b8e36158566ad512a663111c9f/src%2Flibstd%2Fthread%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fthread%2Fmod.rs?ref=7aec91734e0c12b8e36158566ad512a663111c9f", "patch": "@@ -162,7 +162,6 @@\n \n use prelude::v1::*;\n \n-use alloc::boxed::FnBox;\n use any::Any;\n use cell::UnsafeCell;\n use fmt;\n@@ -249,16 +248,6 @@ impl Builder {\n     pub fn spawn<F, T>(self, f: F) -> io::Result<JoinHandle<T>> where\n         F: FnOnce() -> T, F: Send + 'static, T: Send + 'static\n     {\n-        unsafe {\n-            self.spawn_inner(Box::new(f)).map(JoinHandle)\n-        }\n-    }\n-\n-    // NB: this function is unsafe as the lifetime parameter of the code to run\n-    //     in the new thread is not tied into the return value, and the return\n-    //     value must not outlast that lifetime.\n-    unsafe fn spawn_inner<'a, T: Send>(self, f: Box<FnBox() -> T + Send + 'a>)\n-                                       -> io::Result<JoinInner<T>> {\n         let Builder { name, stack_size } = self;\n \n         let stack_size = stack_size.unwrap_or(util::min_stack());\n@@ -274,22 +263,26 @@ impl Builder {\n             if let Some(name) = their_thread.name() {\n                 imp::Thread::set_name(name);\n             }\n-            thread_info::set(imp::guard::current(), their_thread);\n-            let mut output = None;\n-            let try_result = {\n-                let ptr = &mut output;\n-                unwind::try(move || *ptr = Some(f()))\n-            };\n-            *their_packet.get() = Some(try_result.map(|()| {\n-                output.unwrap()\n-            }));\n+            unsafe {\n+                thread_info::set(imp::guard::current(), their_thread);\n+                let mut output = None;\n+                let try_result = {\n+                    let ptr = &mut output;\n+                    unwind::try(move || *ptr = Some(f()))\n+                };\n+                *their_packet.get() = Some(try_result.map(|()| {\n+                    output.unwrap()\n+                }));\n+            }\n         };\n \n-        Ok(JoinInner {\n-            native: Some(try!(imp::Thread::new(stack_size, Box::new(main)))),\n+        Ok(JoinHandle(JoinInner {\n+            native: unsafe {\n+                Some(try!(imp::Thread::new(stack_size, Box::new(main))))\n+            },\n             thread: my_thread,\n             packet: Packet(my_packet),\n-        })\n+        }))\n     }\n }\n "}]}