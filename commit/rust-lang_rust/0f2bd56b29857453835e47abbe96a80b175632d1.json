{"sha": "0f2bd56b29857453835e47abbe96a80b175632d1", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBmMmJkNTZiMjk4NTc0NTM4MzVlNDdhYmJlOTZhODBiMTc1NjMyZDE=", "commit": {"author": {"name": "David Wood", "email": "david@davidtw.co", "date": "2020-08-03T10:08:03Z"}, "committer": {"name": "David Wood", "email": "david@davidtw.co", "date": "2020-08-30T17:57:46Z"}, "message": "lint/ty: move fns to avoid abstraction violation\n\nThis commit moves `transparent_newtype_field` and `is_zst` to\n`LateContext` where they are used, rather than being on the `VariantDef`\nand `TyS` types.\n\nSigned-off-by: David Wood <david@davidtw.co>", "tree": {"sha": "01d739a102aa6e01e61380e3a53083791339e830", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/01d739a102aa6e01e61380e3a53083791339e830"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0f2bd56b29857453835e47abbe96a80b175632d1", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEfgm2/wUjk9OnjxlyJZLnbIc4H9kFAl9L6JoACgkQJZLnbIc4\nH9luyBAAioGtDIy3LxlFqlByobAuBiq1TSYvbyfhj7+cYPNvXTH/e9rRBltvNocy\nwI0UhNQ0COojJJrKh46e/HR3V9GeAqQ2wvvr7tlJVhVoriE86UNB0et6EyLksbvB\n+Zyr0IpIZqJpfFDVhPQIFLyCDTuPAXrso89bjIlpEIqIs8PHeA0xWlwx6g+JqOck\n9rKtT43pmhxc711Ox8IKwcXvtc8DWf7Kumj0ub+Q0587SeUvx8qXeW3+LeaykI3v\nUIyXuq8HctinXdb+Ahj4mqqZKCrXeTxQ7g63bHi48lXOTScLMcr1lwSa1KHD7pLM\nJVyOJJ75p33TzfiMoHunkpGyj46MqiRe37n2Cl1DsuTFBz4zwHkj1l9/4LzE0cdJ\nuLyg1+OzmAh4mvEwZI8lt8e7uNygEXMOfsqWL24JtGGyNcihBKj7mUl9OKElfPdk\n5JaHATNSrPEOm/hRL7+1FnbLYEkaa1VjwUwwZYztk5PkgA2y7vFYoH2W4Aku98vo\nWFuWHGy3vZ9i+0NSWAaL/Ju36JmQFpiBB6HipJErRw93u5rTvcLe2SuJLJqVoeXq\nIFQuvAvqpmXToceActjUcB/LU2pd+svU8S6dO0dYHHVX02ND/ArOwlmXfXJLitWO\nB4clwqjzZ6DrxnclQ7ptusJ8xHHf1BkRf9QfI/h/u9znoyQGhfU=\n=k5zd\n-----END PGP SIGNATURE-----", "payload": "tree 01d739a102aa6e01e61380e3a53083791339e830\nparent 85fbf49ce0e2274d0acf798f6e703747674feec3\nauthor David Wood <david@davidtw.co> 1596449283 +0100\ncommitter David Wood <david@davidtw.co> 1598810266 +0100\n\nlint/ty: move fns to avoid abstraction violation\n\nThis commit moves `transparent_newtype_field` and `is_zst` to\n`LateContext` where they are used, rather than being on the `VariantDef`\nand `TyS` types.\n\nSigned-off-by: David Wood <david@davidtw.co>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0f2bd56b29857453835e47abbe96a80b175632d1", "html_url": "https://github.com/rust-lang/rust/commit/0f2bd56b29857453835e47abbe96a80b175632d1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0f2bd56b29857453835e47abbe96a80b175632d1/comments", "author": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "committer": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "85fbf49ce0e2274d0acf798f6e703747674feec3", "url": "https://api.github.com/repos/rust-lang/rust/commits/85fbf49ce0e2274d0acf798f6e703747674feec3", "html_url": "https://github.com/rust-lang/rust/commit/85fbf49ce0e2274d0acf798f6e703747674feec3"}], "stats": {"total": 52, "additions": 27, "deletions": 25}, "files": [{"sha": "694455171e9ec340a65b6defaf6edbccbe13908f", "filename": "compiler/rustc_lint/src/builtin.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/0f2bd56b29857453835e47abbe96a80b175632d1/compiler%2Frustc_lint%2Fsrc%2Fbuiltin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0f2bd56b29857453835e47abbe96a80b175632d1/compiler%2Frustc_lint%2Fsrc%2Fbuiltin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_lint%2Fsrc%2Fbuiltin.rs?ref=0f2bd56b29857453835e47abbe96a80b175632d1", "patch": "@@ -21,7 +21,8 @@\n //! `late_lint_methods!` invocation in `lib.rs`.\n \n use crate::{\n-    types::CItemKind, EarlyContext, EarlyLintPass, LateContext, LateLintPass, LintContext,\n+    types::{transparent_newtype_field, CItemKind},\n+    EarlyContext, EarlyLintPass, LateContext, LateLintPass, LintContext,\n };\n use rustc_ast::attr::{self, HasAttrs};\n use rustc_ast::tokenstream::{TokenStream, TokenTree};\n@@ -2180,8 +2181,7 @@ impl ClashingExternDeclarations {\n                         if is_transparent && !is_non_null {\n                             debug_assert!(def.variants.len() == 1);\n                             let v = &def.variants[VariantIdx::new(0)];\n-                            ty = v\n-                                .transparent_newtype_field(tcx)\n+                            ty = transparent_newtype_field(tcx, v)\n                                 .expect(\n                                     \"single-variant transparent structure with zero-sized field\",\n                                 )"}, {"sha": "132e9286f6b3b917170749628d104de30be08830", "filename": "compiler/rustc_lint/src/types.rs", "status": "modified", "additions": 23, "deletions": 3, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/0f2bd56b29857453835e47abbe96a80b175632d1/compiler%2Frustc_lint%2Fsrc%2Ftypes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0f2bd56b29857453835e47abbe96a80b175632d1/compiler%2Frustc_lint%2Fsrc%2Ftypes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_lint%2Fsrc%2Ftypes.rs?ref=0f2bd56b29857453835e47abbe96a80b175632d1", "patch": "@@ -533,6 +533,26 @@ crate fn nonnull_optimization_guaranteed<'tcx>(tcx: TyCtxt<'tcx>, def: &ty::AdtD\n         .any(|a| tcx.sess.check_name(a, sym::rustc_nonnull_optimization_guaranteed))\n }\n \n+/// `repr(transparent)` structs can have a single non-ZST field, this function returns that\n+/// field.\n+pub fn transparent_newtype_field<'a, 'tcx>(\n+    tcx: TyCtxt<'tcx>,\n+    variant: &'a ty::VariantDef,\n+) -> Option<&'a ty::FieldDef> {\n+    let param_env = tcx.param_env(variant.def_id);\n+    for field in &variant.fields {\n+        let field_ty = tcx.type_of(field.did);\n+        let is_zst =\n+            tcx.layout_of(param_env.and(field_ty)).map(|layout| layout.is_zst()).unwrap_or(false);\n+\n+        if !is_zst {\n+            return Some(field);\n+        }\n+    }\n+\n+    None\n+}\n+\n /// Is type known to be non-null?\n crate fn ty_is_known_nonnull<'tcx>(cx: &LateContext<'tcx>, ty: Ty<'tcx>, mode: CItemKind) -> bool {\n     let tcx = cx.tcx;\n@@ -548,7 +568,7 @@ crate fn ty_is_known_nonnull<'tcx>(cx: &LateContext<'tcx>, ty: Ty<'tcx>, mode: C\n             }\n \n             for variant in &def.variants {\n-                if let Some(field) = variant.transparent_newtype_field(tcx) {\n+                if let Some(field) = transparent_newtype_field(cx.tcx, variant) {\n                     if ty_is_known_nonnull(cx, field.ty(tcx, substs), mode) {\n                         return true;\n                     }\n@@ -569,7 +589,7 @@ fn get_nullable_type<'tcx>(cx: &LateContext<'tcx>, ty: Ty<'tcx>) -> Option<Ty<'t\n         ty::Adt(field_def, field_substs) => {\n             let inner_field_ty = {\n                 let first_non_zst_ty =\n-                    field_def.variants.iter().filter_map(|v| v.transparent_newtype_field(tcx));\n+                    field_def.variants.iter().filter_map(|v| transparent_newtype_field(cx.tcx, v));\n                 debug_assert_eq!(\n                     first_non_zst_ty.clone().count(),\n                     1,\n@@ -710,7 +730,7 @@ impl<'a, 'tcx> ImproperCTypesVisitor<'a, 'tcx> {\n         if def.repr.transparent() {\n             // Can assume that only one field is not a ZST, so only check\n             // that field's type for FFI-safety.\n-            if let Some(field) = variant.transparent_newtype_field(self.cx.tcx) {\n+            if let Some(field) = transparent_newtype_field(self.cx.tcx, variant) {\n                 self.check_field_type_for_ffi(cache, field, substs)\n             } else {\n                 bug!(\"malformed transparent type\");"}, {"sha": "8027bed2c8cf05fef86d5af19ff365308de8b076", "filename": "compiler/rustc_middle/src/ty/mod.rs", "status": "modified", "additions": 1, "deletions": 14, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/0f2bd56b29857453835e47abbe96a80b175632d1/compiler%2Frustc_middle%2Fsrc%2Fty%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0f2bd56b29857453835e47abbe96a80b175632d1/compiler%2Frustc_middle%2Fsrc%2Fty%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fmod.rs?ref=0f2bd56b29857453835e47abbe96a80b175632d1", "patch": "@@ -2005,7 +2005,7 @@ pub struct VariantDef {\n     flags: VariantFlags,\n }\n \n-impl<'tcx> VariantDef {\n+impl VariantDef {\n     /// Creates a new `VariantDef`.\n     ///\n     /// `variant_did` is the `DefId` that identifies the enum variant (if this `VariantDef`\n@@ -2071,19 +2071,6 @@ impl<'tcx> VariantDef {\n     pub fn is_recovered(&self) -> bool {\n         self.flags.intersects(VariantFlags::IS_RECOVERED)\n     }\n-\n-    /// `repr(transparent)` structs can have a single non-ZST field, this function returns that\n-    /// field.\n-    pub fn transparent_newtype_field(&self, tcx: TyCtxt<'tcx>) -> Option<&FieldDef> {\n-        for field in &self.fields {\n-            let field_ty = field.ty(tcx, InternalSubsts::identity_for_item(tcx, self.def_id));\n-            if !field_ty.is_zst(tcx, self.def_id) {\n-                return Some(field);\n-            }\n-        }\n-\n-        None\n-    }\n }\n \n #[derive(Copy, Clone, Debug, PartialEq, Eq, TyEncodable, TyDecodable, HashStable)]"}, {"sha": "2af3fb7f8638a3f93c92902e913863dc9749a514", "filename": "compiler/rustc_middle/src/ty/sty.rs", "status": "modified", "additions": 0, "deletions": 5, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/0f2bd56b29857453835e47abbe96a80b175632d1/compiler%2Frustc_middle%2Fsrc%2Fty%2Fsty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0f2bd56b29857453835e47abbe96a80b175632d1/compiler%2Frustc_middle%2Fsrc%2Fty%2Fsty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fsty.rs?ref=0f2bd56b29857453835e47abbe96a80b175632d1", "patch": "@@ -2280,9 +2280,4 @@ impl<'tcx> TyS<'tcx> {\n             }\n         }\n     }\n-\n-    /// Is this a zero-sized type?\n-    pub fn is_zst(&'tcx self, tcx: TyCtxt<'tcx>, did: DefId) -> bool {\n-        tcx.layout_of(tcx.param_env(did).and(self)).map(|layout| layout.is_zst()).unwrap_or(false)\n-    }\n }"}]}