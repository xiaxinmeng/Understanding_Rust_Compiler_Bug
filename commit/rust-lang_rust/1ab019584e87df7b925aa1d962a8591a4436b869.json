{"sha": "1ab019584e87df7b925aa1d962a8591a4436b869", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFhYjAxOTU4NGU4N2RmN2I5MjVhYTFkOTYyYTg1OTFhNDQzNmI4Njk=", "commit": {"author": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2016-05-03T13:39:09Z"}, "committer": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2016-05-03T14:24:58Z"}, "message": "Rollup merge of #33371 - birkenfeld:issue-33302, r=cmr\n\nrustdoc: fix inserting source code spans for constant values\n\nThis will go wrong when the constants partially result from macro expansion.\nInstead, use the expressions and pretty-print them as Rust code.\n\nFixes: #33302", "tree": {"sha": "71d5bef5445cf0fee58a8243e5724f3e7277ec26", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/71d5bef5445cf0fee58a8243e5724f3e7277ec26"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1ab019584e87df7b925aa1d962a8591a4436b869", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\nVersion: GnuPG v1\n\niQIcBAABAgAGBQJXKLS6AAoJEDu/TT4u95+YTZMQAII9JBIwODojX4rRnxKQsUHN\n3voDiVd53xD+GSjuuKWu9dPAnkBpNOA87Vzv2Epb0p5Pf90QYvMYKzpm95CM68fA\nZzmuWZFqP5yg/DxbnQS4XL2ThHzWUfCYLonEItFjY3Ih2HjyZK9/nyxMcPSIVZh5\nwy24kza1yZMxdJgHKqFcaZrPcSN85Kyqt7H2N1qfExBzl0i+ZVWOdLiGFWXG2M1+\ncErLTvRcJDh1PnX6Poef0aqWJI5q2OoZsN97y4qgWMsHFk+GlQ2MhrB6Qa6iU9xP\nwjk5/ASlrKfWV4rWd5L4f/5inPDFW26ZHLgFxHElY3ecKcx6lo9MNwT+AhjtUHLN\nkWjWpWH0m6pLFRg4+DpMfQHo/wV/lA7CLf2LsN54/KxH6vrDiIMmySP9OIXOiaUQ\nVcIE2fSV65bLFBcvV322rBqTjsW33vOJRWePV+FlDO9+6IRWZs0AyPX45ku1B5E2\n2qkE5wT6hMcNK/rgsXBcAr5+nZ23lFjxuoD1OxbF8nwDx9aHeWMj0Z4n7Y6IV+3H\nX8+Tp9cq85s7M2BD1PdyjkUuxxiZ1EBNGV0f0u1vzKmjTc6w2eUNhDefHsjifJub\n3VyVK1gii8tMBe7N7vTtmonDRHIBWK8o+/Hxlrua0/lkVF+NxMXPSLB1JtPycahJ\nvwzSBPSw0ZqkKrWO1t6w\n=WQTO\n-----END PGP SIGNATURE-----", "payload": "tree 71d5bef5445cf0fee58a8243e5724f3e7277ec26\nparent 676fd362ff2face76a42cc73a25f3b554d5ed58d\nparent 24117f3c589dca680bdfe7e193e52e210770dc79\nauthor Manish Goregaokar <manishsmail@gmail.com> 1462282749 +0530\ncommitter Manish Goregaokar <manishsmail@gmail.com> 1462285498 +0530\n\nRollup merge of #33371 - birkenfeld:issue-33302, r=cmr\n\nrustdoc: fix inserting source code spans for constant values\n\nThis will go wrong when the constants partially result from macro expansion.\nInstead, use the expressions and pretty-print them as Rust code.\n\nFixes: #33302\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1ab019584e87df7b925aa1d962a8591a4436b869", "html_url": "https://github.com/rust-lang/rust/commit/1ab019584e87df7b925aa1d962a8591a4436b869", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1ab019584e87df7b925aa1d962a8591a4436b869/comments", "author": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "676fd362ff2face76a42cc73a25f3b554d5ed58d", "url": "https://api.github.com/repos/rust-lang/rust/commits/676fd362ff2face76a42cc73a25f3b554d5ed58d", "html_url": "https://github.com/rust-lang/rust/commit/676fd362ff2face76a42cc73a25f3b554d5ed58d"}, {"sha": "24117f3c589dca680bdfe7e193e52e210770dc79", "url": "https://api.github.com/repos/rust-lang/rust/commits/24117f3c589dca680bdfe7e193e52e210770dc79", "html_url": "https://github.com/rust-lang/rust/commit/24117f3c589dca680bdfe7e193e52e210770dc79"}], "stats": {"total": 69, "additions": 57, "deletions": 12}, "files": [{"sha": "36eb1a1301c9ded4db01f9b8bccaac9546987330", "filename": "src/librustdoc/clean/inline.rs", "status": "modified", "additions": 4, "deletions": 5, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/1ab019584e87df7b925aa1d962a8591a4436b869/src%2Flibrustdoc%2Fclean%2Finline.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1ab019584e87df7b925aa1d962a8591a4436b869/src%2Flibrustdoc%2Fclean%2Finline.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Finline.rs?ref=1ab019584e87df7b925aa1d962a8591a4436b869", "patch": "@@ -20,6 +20,7 @@ use rustc::hir;\n use rustc::middle::cstore::{self, CrateStore};\n use rustc::hir::def::Def;\n use rustc::hir::def_id::DefId;\n+use rustc::hir::print as pprust;\n use rustc::ty::{self, TyCtxt};\n use rustc::ty::subst;\n use rustc::middle::stability;\n@@ -30,7 +31,7 @@ use core::{DocContext, DocAccessLevels};\n use doctree;\n use clean::{self, GetDefId};\n \n-use super::{Clean, ToSource};\n+use super::Clean;\n \n /// Attempt to inline the definition of a local node id into this AST.\n ///\n@@ -333,8 +334,8 @@ pub fn build_impl(cx: &DocContext,\n                 let did = assoc_const.def_id;\n                 let type_scheme = tcx.lookup_item_type(did);\n                 let default = if assoc_const.has_value {\n-                    Some(lookup_const_by_id(tcx, did, None)\n-                         .unwrap().0.span.to_src(cx))\n+                    Some(pprust::expr_to_string(\n+                        lookup_const_by_id(tcx, did, None).unwrap().0))\n                 } else {\n                     None\n                 };\n@@ -479,8 +480,6 @@ fn build_module(cx: &DocContext, tcx: &TyCtxt,\n \n fn build_const(cx: &DocContext, tcx: &TyCtxt,\n                did: DefId) -> clean::Constant {\n-    use rustc::hir::print as pprust;\n-\n     let (expr, ty) = lookup_const_by_id(tcx, did, None).unwrap_or_else(|| {\n         panic!(\"expected lookup_const_by_id to succeed for {:?}\", did);\n     });"}, {"sha": "0a606e1425c4552579b597d27a02d0c1ca733a3e", "filename": "src/librustdoc/clean/mod.rs", "status": "modified", "additions": 7, "deletions": 7, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/1ab019584e87df7b925aa1d962a8591a4436b869/src%2Flibrustdoc%2Fclean%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1ab019584e87df7b925aa1d962a8591a4436b869/src%2Flibrustdoc%2Fclean%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Fmod.rs?ref=1ab019584e87df7b925aa1d962a8591a4436b869", "patch": "@@ -39,6 +39,7 @@ use rustc::middle::cstore::{self, CrateStore};\n use rustc::middle::privacy::AccessLevels;\n use rustc::hir::def::Def;\n use rustc::hir::def_id::{DefId, DefIndex, CRATE_DEF_INDEX};\n+use rustc::hir::print as pprust;\n use rustc::ty::subst::{self, ParamSpace, VecPerParamSpace};\n use rustc::ty;\n use rustc::middle::stability;\n@@ -1285,8 +1286,7 @@ impl Clean<Item> for hir::TraitItem {\n         let inner = match self.node {\n             hir::ConstTraitItem(ref ty, ref default) => {\n                 AssociatedConstItem(ty.clean(cx),\n-                                    default.as_ref().map(|expr|\n-                                                         expr.span.to_src(cx)))\n+                                    default.as_ref().map(|e| pprust::expr_to_string(&e)))\n             }\n             hir::MethodTraitItem(ref sig, Some(_)) => {\n                 MethodItem(sig.clean(cx))\n@@ -1316,7 +1316,7 @@ impl Clean<Item> for hir::ImplItem {\n         let inner = match self.node {\n             hir::ImplItemKind::Const(ref ty, ref expr) => {\n                 AssociatedConstItem(ty.clean(cx),\n-                                    Some(expr.span.to_src(cx)))\n+                                    Some(pprust::expr_to_string(expr)))\n             }\n             hir::ImplItemKind::Method(ref sig, _) => {\n                 MethodItem(sig.clean(cx))\n@@ -1635,8 +1635,8 @@ impl Clean<Type> for hir::Ty {\n                 BorrowedRef {lifetime: l.clean(cx), mutability: m.mutbl.clean(cx),\n                              type_: box m.ty.clean(cx)},\n             TyVec(ref ty) => Vector(box ty.clean(cx)),\n-            TyFixedLengthVec(ref ty, ref e) => FixedVector(box ty.clean(cx),\n-                                                           e.span.to_src(cx)),\n+            TyFixedLengthVec(ref ty, ref e) =>\n+                FixedVector(box ty.clean(cx), pprust::expr_to_string(e)),\n             TyTup(ref tys) => Tuple(tys.clean(cx)),\n             TyPath(None, ref p) => {\n                 resolve_type(cx, p.clean(cx), self.id)\n@@ -2185,7 +2185,7 @@ impl Clean<Item> for doctree::Static {\n             inner: StaticItem(Static {\n                 type_: self.type_.clean(cx),\n                 mutability: self.mutability.clean(cx),\n-                expr: self.expr.span.to_src(cx),\n+                expr: pprust::expr_to_string(&self.expr),\n             }),\n         }\n     }\n@@ -2209,7 +2209,7 @@ impl Clean<Item> for doctree::Constant {\n             deprecation: self.depr.clean(cx),\n             inner: ConstantItem(Constant {\n                 type_: self.type_.clean(cx),\n-                expr: self.expr.span.to_src(cx),\n+                expr: pprust::expr_to_string(&self.expr),\n             }),\n         }\n     }"}, {"sha": "b9188e8a4e9bacbb82a7507f72ee12a03a3f9cbf", "filename": "src/test/rustdoc/issue-33302.rs", "status": "added", "additions": 46, "deletions": 0, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/1ab019584e87df7b925aa1d962a8591a4436b869/src%2Ftest%2Frustdoc%2Fissue-33302.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1ab019584e87df7b925aa1d962a8591a4436b869/src%2Ftest%2Frustdoc%2Fissue-33302.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fissue-33302.rs?ref=1ab019584e87df7b925aa1d962a8591a4436b869", "patch": "@@ -0,0 +1,46 @@\n+// Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// Ensure constant and array length values are not taken from source\n+// code, which wreaks havoc with macros.\n+\n+#![feature(associated_consts)]\n+\n+macro_rules! make {\n+    ($n:expr) => {\n+        pub struct S;\n+\n+        // @has issue_33302/constant.CST.html \\\n+        //        '//pre[@class=\"rust const\"]' 'pub const CST: i32 = 4 * 4'\n+        pub const CST: i32 = ($n * $n);\n+        // @has issue_33302/static.ST.html \\\n+        //        '//pre[@class=\"rust static\"]' 'pub static ST: i32 = 4 * 4'\n+        pub static ST: i32 = ($n * $n);\n+\n+        pub trait T<X> {\n+            fn ignore(_: &X) {}\n+            const C: X;\n+            // @has issue_33302/trait.T.html \\\n+            //        '//*[@class=\"rust trait\"]' 'const D: i32 = 4 * 4;'\n+            // @has - '//*[@id=\"associatedconstant.D\"]' 'const D: i32 = 4 * 4'\n+            const D: i32 = ($n * $n);\n+        }\n+\n+        // @has issue_33302/struct.S.html \\\n+        //        '//h3[@class=\"impl\"]' 'impl T<[i32; 4 * 4]> for S'\n+        // @has - '//*[@id=\"associatedconstant.C\"]' 'const C: [i32; 4 * 4] = [0; 4 * 4]'\n+        // @has - '//*[@id=\"associatedconstant.D\"]' 'const D: i32 = 4 * 4'\n+        impl T<[i32; ($n * $n)]> for S {\n+            const C: [i32; ($n * $n)] = [0; ($n * $n)];\n+        }\n+    }\n+}\n+\n+make!(4);"}]}