{"sha": "292ba98cb723fe2ab6ddcac9e4852be960deaaaa", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI5MmJhOThjYjcyM2ZlMmFiNmRkY2FjOWU0ODUyYmU5NjBkZWFhYWE=", "commit": {"author": {"name": "Guanqun Lu", "email": "guanqun.lu@gmail.com", "date": "2019-11-10T07:38:09Z"}, "committer": {"name": "Guanqun Lu", "email": "guanqun.lu@gmail.com", "date": "2019-11-11T14:21:16Z"}, "message": "fix an ICE in macro's diagnostic message", "tree": {"sha": "8d6f916b003df4696ee2cc66c188c2b45cff9bb3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8d6f916b003df4696ee2cc66c188c2b45cff9bb3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/292ba98cb723fe2ab6ddcac9e4852be960deaaaa", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/292ba98cb723fe2ab6ddcac9e4852be960deaaaa", "html_url": "https://github.com/rust-lang/rust/commit/292ba98cb723fe2ab6ddcac9e4852be960deaaaa", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/292ba98cb723fe2ab6ddcac9e4852be960deaaaa/comments", "author": null, "committer": null, "parents": [{"sha": "1062b698c1faa66f7d53078cbb9ef2a493dc2ab7", "url": "https://api.github.com/repos/rust-lang/rust/commits/1062b698c1faa66f7d53078cbb9ef2a493dc2ab7", "html_url": "https://github.com/rust-lang/rust/commit/1062b698c1faa66f7d53078cbb9ef2a493dc2ab7"}], "stats": {"total": 55, "additions": 50, "deletions": 5}, "files": [{"sha": "1f386b8bbbf547da4273958dbc37ae224db30ea4", "filename": "src/librustc_parse/parser/item.rs", "status": "modified", "additions": 13, "deletions": 2, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/292ba98cb723fe2ab6ddcac9e4852be960deaaaa/src%2Flibrustc_parse%2Fparser%2Fitem.rs", "raw_url": "https://github.com/rust-lang/rust/raw/292ba98cb723fe2ab6ddcac9e4852be960deaaaa/src%2Flibrustc_parse%2Fparser%2Fitem.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_parse%2Fparser%2Fitem.rs?ref=292ba98cb723fe2ab6ddcac9e4852be960deaaaa", "patch": "@@ -1742,14 +1742,25 @@ impl<'a> Parser<'a> {\n     }\n \n     fn report_invalid_macro_expansion_item(&self) {\n+        let has_close_delim = self.sess.source_map()\n+            .span_to_snippet(self.prev_span)\n+            .map(|s| s.ends_with(\")\") || s.ends_with(\"]\"))\n+            .unwrap_or(false);\n+        let right_brace_span = if has_close_delim {\n+            // it's safe to peel off one character only when it has the close delim\n+            self.prev_span.with_lo(self.prev_span.hi() - BytePos(1))\n+        } else {\n+            self.sess.source_map().next_point(self.prev_span)\n+        };\n+\n         self.struct_span_err(\n             self.prev_span,\n             \"macros that expand to items must be delimited with braces or followed by a semicolon\",\n         ).multipart_suggestion(\n             \"change the delimiters to curly braces\",\n             vec![\n-                (self.prev_span.with_hi(self.prev_span.lo() + BytePos(1)), String::from(\" {\")),\n-                (self.prev_span.with_lo(self.prev_span.hi() - BytePos(1)), '}'.to_string()),\n+                (self.prev_span.with_hi(self.prev_span.lo() + BytePos(1)), \"{\".to_string()),\n+                (right_brace_span, '}'.to_string()),\n             ],\n             Applicability::MaybeIncorrect,\n         ).span_suggestion("}, {"sha": "f9019b78c8d3862e86de88406cf41688cec117d7", "filename": "src/test/ui/parser/macros-no-semicolon-items.stderr", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/292ba98cb723fe2ab6ddcac9e4852be960deaaaa/src%2Ftest%2Fui%2Fparser%2Fmacros-no-semicolon-items.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/292ba98cb723fe2ab6ddcac9e4852be960deaaaa/src%2Ftest%2Fui%2Fparser%2Fmacros-no-semicolon-items.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fmacros-no-semicolon-items.stderr?ref=292ba98cb723fe2ab6ddcac9e4852be960deaaaa", "patch": "@@ -6,8 +6,8 @@ LL | macro_rules! foo()\n    |\n help: change the delimiters to curly braces\n    |\n-LL | macro_rules! foo {}\n-   |                  ^^\n+LL | macro_rules! foo{}\n+   |                 ^^\n help: add a semicolon\n    |\n LL | macro_rules! foo();\n@@ -26,7 +26,7 @@ LL | | )\n    |\n help: change the delimiters to curly braces\n    |\n-LL | bar! {\n+LL | bar!{\n LL |     blah\n LL |     blah\n LL |     blah"}, {"sha": "689176b3eb75b76489f665a2b5a47d6b685ab046", "filename": "src/test/ui/parser/mbe_missing_right_paren.rs", "status": "added", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/292ba98cb723fe2ab6ddcac9e4852be960deaaaa/src%2Ftest%2Fui%2Fparser%2Fmbe_missing_right_paren.rs", "raw_url": "https://github.com/rust-lang/rust/raw/292ba98cb723fe2ab6ddcac9e4852be960deaaaa/src%2Ftest%2Fui%2Fparser%2Fmbe_missing_right_paren.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fmbe_missing_right_paren.rs?ref=292ba98cb723fe2ab6ddcac9e4852be960deaaaa", "patch": "@@ -0,0 +1,3 @@\n+// ignore-tidy-trailing-newlines\n+// error-pattern: aborting due to 3 previous errors\n+macro_rules! abc(\u063c\n\\ No newline at end of file"}, {"sha": "4504fc0eb0004843cfd0f7a830b3dbb0225abcec", "filename": "src/test/ui/parser/mbe_missing_right_paren.stderr", "status": "added", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/292ba98cb723fe2ab6ddcac9e4852be960deaaaa/src%2Ftest%2Fui%2Fparser%2Fmbe_missing_right_paren.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/292ba98cb723fe2ab6ddcac9e4852be960deaaaa/src%2Ftest%2Fui%2Fparser%2Fmbe_missing_right_paren.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fmbe_missing_right_paren.stderr?ref=292ba98cb723fe2ab6ddcac9e4852be960deaaaa", "patch": "@@ -0,0 +1,31 @@\n+error: this file contains an un-closed delimiter\n+  --> $DIR/mbe_missing_right_paren.rs:3:19\n+   |\n+LL | macro_rules! abc(\u063c\n+   |                 - ^\n+   |                 |\n+   |                 un-closed delimiter\n+\n+error: macros that expand to items must be delimited with braces or followed by a semicolon\n+  --> $DIR/mbe_missing_right_paren.rs:3:17\n+   |\n+LL | macro_rules! abc(\u063c\n+   |                 ^^\n+   |\n+help: change the delimiters to curly braces\n+   |\n+LL | macro_rules! abc{\u063c}\n+   |                 ^ ^\n+help: add a semicolon\n+   |\n+LL | macro_rules! abc(\u063c;\n+   |                   ^\n+\n+error: unexpected end of macro invocation\n+  --> $DIR/mbe_missing_right_paren.rs:3:1\n+   |\n+LL | macro_rules! abc(\u063c\n+   | ^^^^^^^^^^^^^^^^^^ missing tokens in macro arguments\n+\n+error: aborting due to 3 previous errors\n+"}]}