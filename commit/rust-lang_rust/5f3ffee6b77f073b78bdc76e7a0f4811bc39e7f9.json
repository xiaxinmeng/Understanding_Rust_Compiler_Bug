{"sha": "5f3ffee6b77f073b78bdc76e7a0f4811bc39e7f9", "node_id": "MDY6Q29tbWl0NzI0NzEyOjVmM2ZmZWU2Yjc3ZjA3M2I3OGJkYzc2ZTdhMGY0ODExYmMzOWU3Zjk=", "commit": {"author": {"name": "Jake Vossen", "email": "jake@vossen.dev", "date": "2020-02-28T22:32:09Z"}, "committer": {"name": "Jake Vossen", "email": "jake@vossen.dev", "date": "2020-02-29T18:53:51Z"}, "message": "added `try_find_description` to distinguish no desc from invalid code", "tree": {"sha": "e5f1636fb10b7b570078b96b1d7e711e663f3776", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e5f1636fb10b7b570078b96b1d7e711e663f3776"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5f3ffee6b77f073b78bdc76e7a0f4811bc39e7f9", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEECM1n2v46Cue5RmrDuBJwUtnjgXsFAl5asz8ACgkQuBJwUtnj\ngXthcBAAyDipuNxTPWFB2cjEg7i1VSjUnXSgxHYbhzagZ0QTkDNfRjq/mBedlsvm\nhqtXhWNt+jOzHTyZ6Hxvt8c2O6byA5Q6CZgSUomm0JK9kmvcpiHd9rAe4vHdkYNk\nh3enrCvJdxGnOTJ4Hc5hPBMQCzlocUjZWYUa0ikrhbingJKwi1vbpBPckPhjk7Us\nf4anBOHBnH0kpFmkxuV3c1rgO9ufiJFVh21+JDqBC9JetE9a5XhanbKf4UZcyFrF\nc9Zy8tCzmJa40RcHffg824e2IcRka4NAHOwqpZGGuo7dcxYnvK7IICJtHBFcHnjd\no9hlNAmHuC2qnIcbph3V9Jv4pg5gyXUtnHhyVTlsyhWhxA5yoWxoQJnZ0NOV1ycr\nD7v7Hei6ZpopM5i3ji78i1IkFbCRrW/XWyx2FxpWQqUrtaq/RQmJwvpF36eWMRE8\n0XSyljEVqt1I7N2kXaCoQwcxHvYSAwqpIYpu8tO93fKsmTDWZhpsIiTwYBB4trYG\ndIcQSfogKjxmNNqxLdVmXrgcuAQCCbl5somi/V6LUkeC3fZzy1Js6ZWwbBsUc/it\nSs2hnn0vqwd5KoTs0TGt2IZ5iznlGc7z38/oZwTVe3xYuVdcjF2NeI5hli4sWsK3\n3SFjKmphaBzMTOp6rjtR8PQePJpYshXNH78TcSHJc02EbgvnRdU=\n=o7eY\n-----END PGP SIGNATURE-----", "payload": "tree e5f1636fb10b7b570078b96b1d7e711e663f3776\nparent e9bca510fe17354f876aa289bb39d347d7c69c69\nauthor Jake Vossen <jake@vossen.dev> 1582929129 -0700\ncommitter Jake Vossen <jake@vossen.dev> 1583002431 -0700\n\nadded `try_find_description` to distinguish no desc from invalid code\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5f3ffee6b77f073b78bdc76e7a0f4811bc39e7f9", "html_url": "https://github.com/rust-lang/rust/commit/5f3ffee6b77f073b78bdc76e7a0f4811bc39e7f9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5f3ffee6b77f073b78bdc76e7a0f4811bc39e7f9/comments", "author": {"login": "jakevossen5", "id": 16298666, "node_id": "MDQ6VXNlcjE2Mjk4NjY2", "avatar_url": "https://avatars.githubusercontent.com/u/16298666?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakevossen5", "html_url": "https://github.com/jakevossen5", "followers_url": "https://api.github.com/users/jakevossen5/followers", "following_url": "https://api.github.com/users/jakevossen5/following{/other_user}", "gists_url": "https://api.github.com/users/jakevossen5/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakevossen5/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakevossen5/subscriptions", "organizations_url": "https://api.github.com/users/jakevossen5/orgs", "repos_url": "https://api.github.com/users/jakevossen5/repos", "events_url": "https://api.github.com/users/jakevossen5/events{/privacy}", "received_events_url": "https://api.github.com/users/jakevossen5/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jakevossen5", "id": 16298666, "node_id": "MDQ6VXNlcjE2Mjk4NjY2", "avatar_url": "https://avatars.githubusercontent.com/u/16298666?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jakevossen5", "html_url": "https://github.com/jakevossen5", "followers_url": "https://api.github.com/users/jakevossen5/followers", "following_url": "https://api.github.com/users/jakevossen5/following{/other_user}", "gists_url": "https://api.github.com/users/jakevossen5/gists{/gist_id}", "starred_url": "https://api.github.com/users/jakevossen5/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jakevossen5/subscriptions", "organizations_url": "https://api.github.com/users/jakevossen5/orgs", "repos_url": "https://api.github.com/users/jakevossen5/repos", "events_url": "https://api.github.com/users/jakevossen5/events{/privacy}", "received_events_url": "https://api.github.com/users/jakevossen5/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e9bca510fe17354f876aa289bb39d347d7c69c69", "url": "https://api.github.com/repos/rust-lang/rust/commits/e9bca510fe17354f876aa289bb39d347d7c69c69", "html_url": "https://github.com/rust-lang/rust/commit/e9bca510fe17354f876aa289bb39d347d7c69c69"}], "stats": {"total": 59, "additions": 42, "deletions": 17}, "files": [{"sha": "6aa3b225b96cc2b7baaef3946d9f044ea57bd2ea", "filename": "src/librustc_driver/lib.rs", "status": "modified", "additions": 10, "deletions": 6, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/5f3ffee6b77f073b78bdc76e7a0f4811bc39e7f9/src%2Flibrustc_driver%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5f3ffee6b77f073b78bdc76e7a0f4811bc39e7f9/src%2Flibrustc_driver%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Flib.rs?ref=5f3ffee6b77f073b78bdc76e7a0f4811bc39e7f9", "patch": "@@ -30,7 +30,10 @@ use rustc_codegen_ssa::CodegenResults;\n use rustc_codegen_utils::codegen_backend::CodegenBackend;\n use rustc_data_structures::profiling::print_time_passes_entry;\n use rustc_data_structures::sync::SeqCst;\n-use rustc_errors::{registry::Registry, PResult};\n+use rustc_errors::{\n+    registry::{InvalidErrorCode, Registry},\n+    PResult,\n+};\n use rustc_feature::{find_gated_cfg, UnstableFeatures};\n use rustc_hir::def_id::LOCAL_CRATE;\n use rustc_interface::util::{collect_crate_types, get_builtin_codegen_backend};\n@@ -522,11 +525,10 @@ fn stdout_isatty() -> bool {\n fn handle_explain(registry: Registry, code: &str, output: ErrorOutputType) {\n     let normalised =\n         if code.starts_with('E') { code.to_string() } else { format!(\"E{0:0>4}\", code) };\n-    match registry.find_description(&normalised) {\n-        Some(ref description) => {\n+    match registry.try_find_description(&normalised) {\n+        Ok(Some(description)) => {\n             let mut is_in_code_block = false;\n             let mut text = String::new();\n-\n             // Slice off the leading newline and print.\n             for line in description.lines() {\n                 let indent_level =\n@@ -542,16 +544,18 @@ fn handle_explain(registry: Registry, code: &str, output: ErrorOutputType) {\n                 }\n                 text.push('\\n');\n             }\n-\n             if stdout_isatty() {\n                 show_content_with_pager(&text);\n             } else {\n                 print!(\"{}\", text);\n             }\n         }\n-        None => {\n+        Ok(None) => {\n             early_error(output, &format!(\"no extended information for {}\", code));\n         }\n+        Err(InvalidErrorCode) => {\n+            early_error(output, &format!(\"{} is not a valid error code\", code));\n+        }\n     }\n }\n "}, {"sha": "4353a294cc31db9f11c53b8f3499a155c5ea790e", "filename": "src/librustc_error_codes/lib.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/5f3ffee6b77f073b78bdc76e7a0f4811bc39e7f9/src%2Flibrustc_error_codes%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5f3ffee6b77f073b78bdc76e7a0f4811bc39e7f9/src%2Flibrustc_error_codes%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_error_codes%2Flib.rs?ref=5f3ffee6b77f073b78bdc76e7a0f4811bc39e7f9", "patch": "@@ -3,8 +3,9 @@\n \n macro_rules! register_diagnostics {\n     ($($ecode:ident: $message:expr,)* ; $($code:ident,)*) => (\n-        pub static DIAGNOSTICS: &[(&str, &str)] = &[\n-            $( (stringify!($ecode), $message), )*\n+        pub static DIAGNOSTICS: &[(&str, Option<&str>)] = &[\n+            $( (stringify!($ecode), Some($message)), )*\n+            $( (stringify!($code), None), )*\n         ];\n     )\n }"}, {"sha": "0767b8dda9b8e3ac74c384bef19b233266dbf61c", "filename": "src/librustc_errors/json.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/5f3ffee6b77f073b78bdc76e7a0f4811bc39e7f9/src%2Flibrustc_errors%2Fjson.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5f3ffee6b77f073b78bdc76e7a0f4811bc39e7f9/src%2Flibrustc_errors%2Fjson.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_errors%2Fjson.rs?ref=5f3ffee6b77f073b78bdc76e7a0f4811bc39e7f9", "patch": "@@ -419,10 +419,10 @@ impl DiagnosticCode {\n                 DiagnosticId::Error(s) => s,\n                 DiagnosticId::Lint(s) => s,\n             };\n-            let explanation =\n-                je.registry.as_ref().and_then(|registry| registry.find_description(&s));\n+            let je_result =\n+                je.registry.as_ref().map(|registry| registry.try_find_description(&s)).unwrap();\n \n-            DiagnosticCode { code: s, explanation }\n+            DiagnosticCode { code: s, explanation: je_result.unwrap_or(None) }\n         })\n     }\n }"}, {"sha": "bc943f2c09cdf915354b69c4ec3016dcebf7ee15", "filename": "src/librustc_errors/lib.rs", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/5f3ffee6b77f073b78bdc76e7a0f4811bc39e7f9/src%2Flibrustc_errors%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5f3ffee6b77f073b78bdc76e7a0f4811bc39e7f9/src%2Flibrustc_errors%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_errors%2Flib.rs?ref=5f3ffee6b77f073b78bdc76e7a0f4811bc39e7f9", "patch": "@@ -786,8 +786,12 @@ impl HandlerInner {\n                 .emitted_diagnostic_codes\n                 .iter()\n                 .filter_map(|x| match &x {\n-                    DiagnosticId::Error(s) if registry.find_description(s).is_some() => {\n-                        Some(s.clone())\n+                    DiagnosticId::Error(s) => {\n+                        if let Ok(Some(_explanation)) = registry.try_find_description(s) {\n+                            Some(s.clone())\n+                        } else {\n+                            None\n+                        }\n                     }\n                     _ => None,\n                 })"}, {"sha": "c92a9d04775d1e819179fe8472ce3a20794fc536", "filename": "src/librustc_errors/registry.rs", "status": "modified", "additions": 20, "deletions": 4, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/5f3ffee6b77f073b78bdc76e7a0f4811bc39e7f9/src%2Flibrustc_errors%2Fregistry.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5f3ffee6b77f073b78bdc76e7a0f4811bc39e7f9/src%2Flibrustc_errors%2Fregistry.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_errors%2Fregistry.rs?ref=5f3ffee6b77f073b78bdc76e7a0f4811bc39e7f9", "patch": "@@ -1,16 +1,32 @@\n use rustc_data_structures::fx::FxHashMap;\n \n+#[derive(Debug)]\n+pub struct InvalidErrorCode;\n+\n #[derive(Clone)]\n pub struct Registry {\n-    descriptions: FxHashMap<&'static str, &'static str>,\n+    long_descriptions: FxHashMap<&'static str, Option<&'static str>>,\n }\n \n impl Registry {\n-    pub fn new(descriptions: &[(&'static str, &'static str)]) -> Registry {\n-        Registry { descriptions: descriptions.iter().cloned().collect() }\n+    pub fn new(long_descriptions: &[(&'static str, Option<&'static str>)]) -> Registry {\n+        Registry { long_descriptions: long_descriptions.iter().cloned().collect() }\n     }\n \n+    /// This will panic if an invalid error code is passed in\n     pub fn find_description(&self, code: &str) -> Option<&'static str> {\n-        self.descriptions.get(code).cloned()\n+        self.try_find_description(code).unwrap()\n+    }\n+    /// Returns `InvalidErrorCode` if the code requested does not exist in the\n+    /// registry. Otherwise, returns an `Option` where `None` means the error\n+    /// code is valid but has no extended information.\n+    pub fn try_find_description(\n+        &self,\n+        code: &str,\n+    ) -> Result<Option<&'static str>, InvalidErrorCode> {\n+        if !self.long_descriptions.contains_key(code) {\n+            return Err(InvalidErrorCode);\n+        }\n+        Ok(self.long_descriptions.get(code).unwrap().clone())\n     }\n }"}]}