{"sha": "42f2be8a8c655695ecf2b56eebf023faf7d62463", "node_id": "C_kwDOAAsO6NoAKDQyZjJiZThhOGM2NTU2OTVlY2YyYjU2ZWViZjAyM2ZhZjdkNjI0NjM", "commit": {"author": {"name": "Tom Martin", "email": "tom.martin1239@gmail.com", "date": "2023-03-26T14:59:45Z"}, "committer": {"name": "Tom Martin", "email": "tom.martin1239@gmail.com", "date": "2023-03-26T15:01:25Z"}, "message": "Add suggestion to remove derive() if invoked macro is non-derive", "tree": {"sha": "494c2329fd7deff61ad2587f81456e604e0c66d9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/494c2329fd7deff61ad2587f81456e604e0c66d9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/42f2be8a8c655695ecf2b56eebf023faf7d62463", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEE4EiFxdccn1fd6ae9c6cz+WKfWsUFAmQgXkUACgkQc6cz+WKf\nWsW/eQ/8CDusuNnbzsFNSWBhHTvDGkuCjZgxh6sa/605R2d8ZEN3QbKbIznK8fZb\nnsNWuZK2l+juKfNSyKSkJl6S4tMxuklVfSLIaonrgw3grR9swOhGzv2nRrdWsADN\npTf28mQHXOmh7AchaLkQ/5SgI1+aT5NwAKieast0M+nbTCNHVtumcBtNOOpNNXnL\nAfrp6V/DWABSqT/enIWadyDxgz9FdShSS64YApws8OYA8ekPTuiZEjPczkd1qRXP\nidbW1FL5a2RHb8W9jiSQYYaHqLxcawc79IErxmuHxku9DYRP1Cx4ElFM6kOZk+pu\nCTaC/5BJicR2IiEp/fstE11huAltfd9jjlDYm+TYz9UvGxsyK9xf8Ql/rlpFQ/rU\nFyaqggQzWMA5sWo1NzRM+cbrcLMxixvRpYy9HxmiYFKy98DVwSNd4kwyHi2uzWnV\nGoSqwWPQkEwD9o6LSL9E60HKE6e11NUm2SWPTAmnuJBKoO2UvtCXrANmtJ84HLr2\n1XEjypTZLtlseAzI46hPf9IUtJpd2WI0XyqPUMnZo220v+ex5l2VNyIfO1JNny0e\nZTljL92h1LLpUivy6hZaJNLKn2y7IZl2bgakn1dXGrh4EJbnArkgN0l1gxxIyL0e\nsWjAEGw3MbVo2MEuP7jtphp5nv31iK/EM1Vgk25EyZzJC4wcA7M=\n=QHeK\n-----END PGP SIGNATURE-----", "payload": "tree 494c2329fd7deff61ad2587f81456e604e0c66d9\nparent 89c2e3d3d75486e52473de3ae38f0ca6efeffef2\nauthor Tom Martin <tom.martin1239@gmail.com> 1679842785 +0100\ncommitter Tom Martin <tom.martin1239@gmail.com> 1679842885 +0100\n\nAdd suggestion to remove derive() if invoked macro is non-derive\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/42f2be8a8c655695ecf2b56eebf023faf7d62463", "html_url": "https://github.com/rust-lang/rust/commit/42f2be8a8c655695ecf2b56eebf023faf7d62463", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/42f2be8a8c655695ecf2b56eebf023faf7d62463/comments", "author": {"login": "NotStirred", "id": 16853282, "node_id": "MDQ6VXNlcjE2ODUzMjgy", "avatar_url": "https://avatars.githubusercontent.com/u/16853282?v=4", "gravatar_id": "", "url": "https://api.github.com/users/NotStirred", "html_url": "https://github.com/NotStirred", "followers_url": "https://api.github.com/users/NotStirred/followers", "following_url": "https://api.github.com/users/NotStirred/following{/other_user}", "gists_url": "https://api.github.com/users/NotStirred/gists{/gist_id}", "starred_url": "https://api.github.com/users/NotStirred/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/NotStirred/subscriptions", "organizations_url": "https://api.github.com/users/NotStirred/orgs", "repos_url": "https://api.github.com/users/NotStirred/repos", "events_url": "https://api.github.com/users/NotStirred/events{/privacy}", "received_events_url": "https://api.github.com/users/NotStirred/received_events", "type": "User", "site_admin": false}, "committer": {"login": "NotStirred", "id": 16853282, "node_id": "MDQ6VXNlcjE2ODUzMjgy", "avatar_url": "https://avatars.githubusercontent.com/u/16853282?v=4", "gravatar_id": "", "url": "https://api.github.com/users/NotStirred", "html_url": "https://github.com/NotStirred", "followers_url": "https://api.github.com/users/NotStirred/followers", "following_url": "https://api.github.com/users/NotStirred/following{/other_user}", "gists_url": "https://api.github.com/users/NotStirred/gists{/gist_id}", "starred_url": "https://api.github.com/users/NotStirred/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/NotStirred/subscriptions", "organizations_url": "https://api.github.com/users/NotStirred/orgs", "repos_url": "https://api.github.com/users/NotStirred/repos", "events_url": "https://api.github.com/users/NotStirred/events{/privacy}", "received_events_url": "https://api.github.com/users/NotStirred/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "89c2e3d3d75486e52473de3ae38f0ca6efeffef2", "url": "https://api.github.com/repos/rust-lang/rust/commits/89c2e3d3d75486e52473de3ae38f0ca6efeffef2", "html_url": "https://github.com/rust-lang/rust/commit/89c2e3d3d75486e52473de3ae38f0ca6efeffef2"}], "stats": {"total": 46, "additions": 41, "deletions": 5}, "files": [{"sha": "38e8cf8cd2f12358f77bc18048c61abbda002569", "filename": "compiler/rustc_resolve/src/macros.rs", "status": "modified", "additions": 17, "deletions": 5, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/42f2be8a8c655695ecf2b56eebf023faf7d62463/compiler%2Frustc_resolve%2Fsrc%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/42f2be8a8c655695ecf2b56eebf023faf7d62463/compiler%2Frustc_resolve%2Fsrc%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Fmacros.rs?ref=42f2be8a8c655695ecf2b56eebf023faf7d62463", "patch": "@@ -544,11 +544,23 @@ impl<'a, 'tcx> Resolver<'a, 'tcx> {\n         if let Some((article, expected)) = unexpected_res {\n             let path_str = pprust::path_to_string(path);\n             let msg = format!(\"expected {}, found {} `{}`\", expected, res.descr(), path_str);\n-            self.tcx\n-                .sess\n-                .struct_span_err(path.span, &msg)\n-                .span_label(path.span, format!(\"not {} {}\", article, expected))\n-                .emit();\n+            let mut err = self.tcx.sess.struct_span_err(path.span, &msg);\n+\n+            err.span_label(path.span, format!(\"not {} {}\", article, expected));\n+\n+            if kind == MacroKind::Derive && ext.macro_kind() != MacroKind::Derive {\n+                // Suggest removing the derive() as the macro isn't Derive\n+                let opening_span =\n+                    path.span.shrink_to_lo().with_lo(path.span.lo() - rustc_span::BytePos(7));\n+                let closing_span =\n+                    path.span.shrink_to_hi().with_hi(path.span.hi() + rustc_span::BytePos(1));\n+                err.span_help(\n+                    vec![opening_span, closing_span],\n+                    \"remove the surrounding \\\"derive()\\\":\",\n+                );\n+            }\n+\n+            err.emit();\n             return Ok((self.dummy_ext(kind), Res::Err));\n         }\n "}, {"sha": "fb4e19d8565121e78b7d3649c0c963e5bc8a96c3", "filename": "tests/ui/macros/macro-path-prelude-fail-4.stderr", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/42f2be8a8c655695ecf2b56eebf023faf7d62463/tests%2Fui%2Fmacros%2Fmacro-path-prelude-fail-4.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/42f2be8a8c655695ecf2b56eebf023faf7d62463/tests%2Fui%2Fmacros%2Fmacro-path-prelude-fail-4.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmacros%2Fmacro-path-prelude-fail-4.stderr?ref=42f2be8a8c655695ecf2b56eebf023faf7d62463", "patch": "@@ -3,6 +3,12 @@ error: expected derive macro, found built-in attribute `inline`\n    |\n LL | #[derive(inline)]\n    |          ^^^^^^ not a derive macro\n+   |\n+help: remove the surrounding \"derive()\":\n+  --> $DIR/macro-path-prelude-fail-4.rs:1:3\n+   |\n+LL | #[derive(inline)]\n+   |   ^^^^^^^      ^\n \n error: aborting due to previous error\n "}, {"sha": "6e7adc2e3b12a0d13cde28f452984a8a0f719189", "filename": "tests/ui/proc-macro/macro-namespace-reserved-2.stderr", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/42f2be8a8c655695ecf2b56eebf023faf7d62463/tests%2Fui%2Fproc-macro%2Fmacro-namespace-reserved-2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/42f2be8a8c655695ecf2b56eebf023faf7d62463/tests%2Fui%2Fproc-macro%2Fmacro-namespace-reserved-2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fproc-macro%2Fmacro-namespace-reserved-2.stderr?ref=42f2be8a8c655695ecf2b56eebf023faf7d62463", "patch": "@@ -57,6 +57,12 @@ error: expected derive macro, found attribute macro `my_macro_attr`\n    |\n LL | #[derive(my_macro_attr)]\n    |          ^^^^^^^^^^^^^ not a derive macro\n+   |\n+help: remove the surrounding \"derive()\":\n+  --> $DIR/macro-namespace-reserved-2.rs:53:3\n+   |\n+LL | #[derive(my_macro_attr)]\n+   |   ^^^^^^^             ^\n \n error: can't use a procedural macro from the same crate that defines it\n   --> $DIR/macro-namespace-reserved-2.rs:56:10\n@@ -87,6 +93,12 @@ error: expected derive macro, found macro `crate::my_macro`\n    |\n LL | #[derive(crate::my_macro)]\n    |          ^^^^^^^^^^^^^^^ not a derive macro\n+   |\n+help: remove the surrounding \"derive()\":\n+  --> $DIR/macro-namespace-reserved-2.rs:50:3\n+   |\n+LL | #[derive(crate::my_macro)]\n+   |   ^^^^^^^               ^\n \n error: cannot find macro `my_macro_attr` in this scope\n   --> $DIR/macro-namespace-reserved-2.rs:28:5"}, {"sha": "6befa99f58355da5899d091a5a61ed4df7947bce", "filename": "tests/ui/tool-attributes/tool-attributes-misplaced-2.stderr", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/42f2be8a8c655695ecf2b56eebf023faf7d62463/tests%2Fui%2Ftool-attributes%2Ftool-attributes-misplaced-2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/42f2be8a8c655695ecf2b56eebf023faf7d62463/tests%2Fui%2Ftool-attributes%2Ftool-attributes-misplaced-2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ftool-attributes%2Ftool-attributes-misplaced-2.stderr?ref=42f2be8a8c655695ecf2b56eebf023faf7d62463", "patch": "@@ -3,6 +3,12 @@ error: expected derive macro, found tool attribute `rustfmt::skip`\n    |\n LL | #[derive(rustfmt::skip)]\n    |          ^^^^^^^^^^^^^ not a derive macro\n+   |\n+help: remove the surrounding \"derive()\":\n+  --> $DIR/tool-attributes-misplaced-2.rs:1:3\n+   |\n+LL | #[derive(rustfmt::skip)]\n+   |   ^^^^^^^             ^\n \n error: expected macro, found tool attribute `rustfmt::skip`\n   --> $DIR/tool-attributes-misplaced-2.rs:5:5"}]}