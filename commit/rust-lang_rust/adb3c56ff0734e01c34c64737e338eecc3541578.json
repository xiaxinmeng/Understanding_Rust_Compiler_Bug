{"sha": "adb3c56ff0734e01c34c64737e338eecc3541578", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFkYjNjNTZmZjA3MzRlMDFjMzRjNjQ3MzdlMzM4ZWVjYzM1NDE1Nzg=", "commit": {"author": {"name": "Wesley Norris", "email": "repnop@outlook.com", "date": "2020-10-03T18:17:21Z"}, "committer": {"name": "Wesley Norris", "email": "repnop@outlook.com", "date": "2020-10-03T18:17:21Z"}, "message": "Trim all trailing whitespace in onEnter\n\nFixes #5848", "tree": {"sha": "cdbe21cfdd810d8bd186bc9cae48f21f6503f362", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cdbe21cfdd810d8bd186bc9cae48f21f6503f362"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/adb3c56ff0734e01c34c64737e338eecc3541578", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/adb3c56ff0734e01c34c64737e338eecc3541578", "html_url": "https://github.com/rust-lang/rust/commit/adb3c56ff0734e01c34c64737e338eecc3541578", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/adb3c56ff0734e01c34c64737e338eecc3541578/comments", "author": {"login": "repnop", "id": 24203105, "node_id": "MDQ6VXNlcjI0MjAzMTA1", "avatar_url": "https://avatars.githubusercontent.com/u/24203105?v=4", "gravatar_id": "", "url": "https://api.github.com/users/repnop", "html_url": "https://github.com/repnop", "followers_url": "https://api.github.com/users/repnop/followers", "following_url": "https://api.github.com/users/repnop/following{/other_user}", "gists_url": "https://api.github.com/users/repnop/gists{/gist_id}", "starred_url": "https://api.github.com/users/repnop/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/repnop/subscriptions", "organizations_url": "https://api.github.com/users/repnop/orgs", "repos_url": "https://api.github.com/users/repnop/repos", "events_url": "https://api.github.com/users/repnop/events{/privacy}", "received_events_url": "https://api.github.com/users/repnop/received_events", "type": "User", "site_admin": false}, "committer": {"login": "repnop", "id": 24203105, "node_id": "MDQ6VXNlcjI0MjAzMTA1", "avatar_url": "https://avatars.githubusercontent.com/u/24203105?v=4", "gravatar_id": "", "url": "https://api.github.com/users/repnop", "html_url": "https://github.com/repnop", "followers_url": "https://api.github.com/users/repnop/followers", "following_url": "https://api.github.com/users/repnop/following{/other_user}", "gists_url": "https://api.github.com/users/repnop/gists{/gist_id}", "starred_url": "https://api.github.com/users/repnop/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/repnop/subscriptions", "organizations_url": "https://api.github.com/users/repnop/orgs", "repos_url": "https://api.github.com/users/repnop/repos", "events_url": "https://api.github.com/users/repnop/events{/privacy}", "received_events_url": "https://api.github.com/users/repnop/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e5f252ade72fee4776396122dc91a17ddc185a66", "url": "https://api.github.com/repos/rust-lang/rust/commits/e5f252ade72fee4776396122dc91a17ddc185a66", "html_url": "https://github.com/rust-lang/rust/commit/e5f252ade72fee4776396122dc91a17ddc185a66"}], "stats": {"total": 29, "additions": 25, "deletions": 4}, "files": [{"sha": "98adef1d6f807217438b75945c79b8efa4eaa9a9", "filename": "crates/ide/src/typing/on_enter.rs", "status": "modified", "additions": 25, "deletions": 4, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/adb3c56ff0734e01c34c64737e338eecc3541578/crates%2Fide%2Fsrc%2Ftyping%2Fon_enter.rs", "raw_url": "https://github.com/rust-lang/rust/raw/adb3c56ff0734e01c34c64737e338eecc3541578/crates%2Fide%2Fsrc%2Ftyping%2Fon_enter.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Ftyping%2Fon_enter.rs?ref=adb3c56ff0734e01c34c64737e338eecc3541578", "patch": "@@ -51,21 +51,23 @@ pub(crate) fn on_enter(db: &RootDatabase, position: FilePosition) -> Option<Text\n         return None;\n     }\n \n-    let mut remove_last_space = false;\n+    let mut remove_trailing_whitespace = false;\n     // Continuing single-line non-doc comments (like this one :) ) is annoying\n     if prefix == \"//\" && comment_range.end() == position.offset {\n         if comment.text().ends_with(' ') {\n             mark::hit!(continues_end_of_line_comment_with_space);\n-            remove_last_space = true;\n+            remove_trailing_whitespace = true;\n         } else if !followed_by_comment(&comment) {\n             return None;\n         }\n     }\n \n     let indent = node_indent(&file, comment.syntax())?;\n     let inserted = format!(\"\\n{}{} $0\", indent, prefix);\n-    let delete = if remove_last_space {\n-        TextRange::new(position.offset - TextSize::of(' '), position.offset)\n+    let delete = if remove_trailing_whitespace {\n+        let trimmed_len = comment.text().trim_end().len() as u32;\n+        let trailing_whitespace_len = comment.text().len() as u32 - trimmed_len;\n+        TextRange::new(position.offset - TextSize::from(trailing_whitespace_len), position.offset)\n     } else {\n         TextRange::empty(position.offset)\n     };\n@@ -253,4 +255,23 @@ fn main() {\n \"#,\n         );\n     }\n+\n+    #[test]\n+    fn trims_all_trailing_whitespace() {\n+        do_check(\n+            \"\n+fn main() {\n+    // Fix me  \\t\\t   <|>\n+    let x = 1 + 1;\n+}\n+\",\n+            \"\n+fn main() {\n+    // Fix me\n+    // $0\n+    let x = 1 + 1;\n+}\n+\",\n+        );\n+    }\n }"}]}