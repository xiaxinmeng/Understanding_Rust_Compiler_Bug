{"sha": "f540a25745e03cfe9eac7e3a5e5489d36e4ad58a", "node_id": "C_kwDOAAsO6NoAKGY1NDBhMjU3NDVlMDNjZmU5ZWFjN2UzYTVlNTQ4OWQzNmU0YWQ1OGE", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-02-27T15:07:47Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-02-27T15:07:47Z"}, "message": "Auto merge of #108493 - cjgillot:thir-print, r=compiler-errors\n\nMove THIR printing to rustc_mir_build.\n\nhttps://github.com/rust-lang/rust/pull/107451 increased the compilation time of `rustc_middle` by 10% = 3s.\n\nAs https://github.com/rust-lang/rust/pull/107006 adds quite a lot of code to rustc_middle, I suspect it to be the cause.\n\nThis PR moves the THIR printing code to `rustc_mir_build`, where the query provider lives, in order to benefit from higher parallelism when compiling rustc.", "tree": {"sha": "ab30ecf80eed76e57b2aba96bf46c82faa23a5b0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ab30ecf80eed76e57b2aba96bf46c82faa23a5b0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f540a25745e03cfe9eac7e3a5e5489d36e4ad58a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f540a25745e03cfe9eac7e3a5e5489d36e4ad58a", "html_url": "https://github.com/rust-lang/rust/commit/f540a25745e03cfe9eac7e3a5e5489d36e4ad58a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f540a25745e03cfe9eac7e3a5e5489d36e4ad58a/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7d782b7ff4d57170e110211565209ecc5bbb3907", "url": "https://api.github.com/repos/rust-lang/rust/commits/7d782b7ff4d57170e110211565209ecc5bbb3907", "html_url": "https://github.com/rust-lang/rust/commit/7d782b7ff4d57170e110211565209ecc5bbb3907"}, {"sha": "380ca0c9e6efe2ccc6f35abef7931f7a9581bf70", "url": "https://api.github.com/repos/rust-lang/rust/commits/380ca0c9e6efe2ccc6f35abef7931f7a9581bf70", "html_url": "https://github.com/rust-lang/rust/commit/380ca0c9e6efe2ccc6f35abef7931f7a9581bf70"}], "stats": {"total": 53, "additions": 22, "deletions": 31}, "files": [{"sha": "5f320708c8416944466a25137159b95386baee11", "filename": "compiler/rustc_middle/src/thir.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/f540a25745e03cfe9eac7e3a5e5489d36e4ad58a/compiler%2Frustc_middle%2Fsrc%2Fthir.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f540a25745e03cfe9eac7e3a5e5489d36e4ad58a/compiler%2Frustc_middle%2Fsrc%2Fthir.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fthir.rs?ref=f540a25745e03cfe9eac7e3a5e5489d36e4ad58a", "patch": "@@ -29,7 +29,6 @@ use rustc_target::asm::InlineAsmRegOrRegClass;\n use std::fmt;\n use std::ops::Index;\n \n-pub mod print;\n pub mod visit;\n \n macro_rules! thir_with_elements {"}, {"sha": "e10a264d385d0623e6eb7bbde6b9fced20c58e90", "filename": "compiler/rustc_mir_build/src/lib.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f540a25745e03cfe9eac7e3a5e5489d36e4ad58a/compiler%2Frustc_mir_build%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f540a25745e03cfe9eac7e3a5e5489d36e4ad58a/compiler%2Frustc_mir_build%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Flib.rs?ref=f540a25745e03cfe9eac7e3a5e5489d36e4ad58a", "patch": "@@ -38,6 +38,6 @@ pub fn provide(providers: &mut Providers) {\n     providers.thir_check_unsafety = check_unsafety::thir_check_unsafety;\n     providers.thir_check_unsafety_for_const_arg = check_unsafety::thir_check_unsafety_for_const_arg;\n     providers.thir_body = thir::cx::thir_body;\n-    providers.thir_tree = thir::cx::thir_tree;\n-    providers.thir_flat = thir::cx::thir_flat;\n+    providers.thir_tree = thir::print::thir_tree;\n+    providers.thir_flat = thir::print::thir_flat;\n }"}, {"sha": "b5e819db5f82bbf8447bf9fa940c41d6ec260f0f", "filename": "compiler/rustc_mir_build/src/thir/cx/mod.rs", "status": "modified", "additions": 0, "deletions": 17, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/f540a25745e03cfe9eac7e3a5e5489d36e4ad58a/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fcx%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f540a25745e03cfe9eac7e3a5e5489d36e4ad58a/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fcx%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fcx%2Fmod.rs?ref=f540a25745e03cfe9eac7e3a5e5489d36e4ad58a", "patch": "@@ -52,23 +52,6 @@ pub(crate) fn thir_body(\n     Ok((tcx.alloc_steal_thir(cx.thir), expr))\n }\n \n-pub(crate) fn thir_tree(tcx: TyCtxt<'_>, owner_def: ty::WithOptConstParam<LocalDefId>) -> String {\n-    match thir_body(tcx, owner_def) {\n-        Ok((thir, _)) => {\n-            let thir = thir.steal();\n-            tcx.thir_tree_representation(&thir)\n-        }\n-        Err(_) => \"error\".into(),\n-    }\n-}\n-\n-pub(crate) fn thir_flat(tcx: TyCtxt<'_>, owner_def: ty::WithOptConstParam<LocalDefId>) -> String {\n-    match thir_body(tcx, owner_def) {\n-        Ok((thir, _)) => format!(\"{:#?}\", thir.steal()),\n-        Err(_) => \"error\".into(),\n-    }\n-}\n-\n struct Cx<'tcx> {\n     tcx: TyCtxt<'tcx>,\n     thir: Thir<'tcx>,"}, {"sha": "ca26cc13b5e877944c04280137c37dfbbb6541b1", "filename": "compiler/rustc_mir_build/src/thir/mod.rs", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f540a25745e03cfe9eac7e3a5e5489d36e4ad58a/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f540a25745e03cfe9eac7e3a5e5489d36e4ad58a/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fmod.rs?ref=f540a25745e03cfe9eac7e3a5e5489d36e4ad58a", "patch": "@@ -5,9 +5,7 @@\n //! structures.\n \n pub(crate) mod constant;\n-\n pub(crate) mod cx;\n-\n pub(crate) mod pattern;\n-\n+pub(crate) mod print;\n mod util;"}, {"sha": "8028227aafd2acc4ac302aa06d757b1c0fc27227", "filename": "compiler/rustc_mir_build/src/thir/print.rs", "status": "renamed", "additions": 19, "deletions": 8, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/f540a25745e03cfe9eac7e3a5e5489d36e4ad58a/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fprint.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f540a25745e03cfe9eac7e3a5e5489d36e4ad58a/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fprint.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fprint.rs?ref=f540a25745e03cfe9eac7e3a5e5489d36e4ad58a", "patch": "@@ -1,13 +1,24 @@\n-use crate::thir::*;\n-use crate::ty::{self, TyCtxt};\n-\n+use rustc_middle::thir::*;\n+use rustc_middle::ty::{self, TyCtxt};\n+use rustc_span::def_id::LocalDefId;\n use std::fmt::{self, Write};\n \n-impl<'tcx> TyCtxt<'tcx> {\n-    pub fn thir_tree_representation<'a>(self, thir: &'a Thir<'tcx>) -> String {\n-        let mut printer = ThirPrinter::new(thir);\n-        printer.print();\n-        printer.into_buffer()\n+pub(crate) fn thir_tree(tcx: TyCtxt<'_>, owner_def: ty::WithOptConstParam<LocalDefId>) -> String {\n+    match super::cx::thir_body(tcx, owner_def) {\n+        Ok((thir, _)) => {\n+            let thir = thir.steal();\n+            let mut printer = ThirPrinter::new(&thir);\n+            printer.print();\n+            printer.into_buffer()\n+        }\n+        Err(_) => \"error\".into(),\n+    }\n+}\n+\n+pub(crate) fn thir_flat(tcx: TyCtxt<'_>, owner_def: ty::WithOptConstParam<LocalDefId>) -> String {\n+    match super::cx::thir_body(tcx, owner_def) {\n+        Ok((thir, _)) => format!(\"{:#?}\", thir.steal()),\n+        Err(_) => \"error\".into(),\n     }\n }\n ", "previous_filename": "compiler/rustc_middle/src/thir/print.rs"}]}