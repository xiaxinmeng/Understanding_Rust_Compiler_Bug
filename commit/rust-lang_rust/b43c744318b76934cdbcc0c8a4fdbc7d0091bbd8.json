{"sha": "b43c744318b76934cdbcc0c8a4fdbc7d0091bbd8", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI0M2M3NDQzMThiNzY5MzRjZGJjYzBjOGE0ZmRiYzdkMDA5MWJiZDg=", "commit": {"author": {"name": "Tobias Schottdorf", "email": "tobias.schottdorf@gmail.com", "date": "2017-03-11T15:54:45Z"}, "committer": {"name": "Tobias Schottdorf", "email": "tobias.schottdorf@gmail.com", "date": "2017-03-14T15:06:50Z"}, "message": "Add feature toggle for rvalue-static-promotion RFC\n\nSee https://github.com/rust-lang/rfcs/pull/1414.\n\nUpdates #38865.", "tree": {"sha": "47ba83b177bf4e315a7698f8777af2983e16df18", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/47ba83b177bf4e315a7698f8777af2983e16df18"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b43c744318b76934cdbcc0c8a4fdbc7d0091bbd8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b43c744318b76934cdbcc0c8a4fdbc7d0091bbd8", "html_url": "https://github.com/rust-lang/rust/commit/b43c744318b76934cdbcc0c8a4fdbc7d0091bbd8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b43c744318b76934cdbcc0c8a4fdbc7d0091bbd8/comments", "author": {"login": "tbg", "id": 5076964, "node_id": "MDQ6VXNlcjUwNzY5NjQ=", "avatar_url": "https://avatars.githubusercontent.com/u/5076964?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tbg", "html_url": "https://github.com/tbg", "followers_url": "https://api.github.com/users/tbg/followers", "following_url": "https://api.github.com/users/tbg/following{/other_user}", "gists_url": "https://api.github.com/users/tbg/gists{/gist_id}", "starred_url": "https://api.github.com/users/tbg/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tbg/subscriptions", "organizations_url": "https://api.github.com/users/tbg/orgs", "repos_url": "https://api.github.com/users/tbg/repos", "events_url": "https://api.github.com/users/tbg/events{/privacy}", "received_events_url": "https://api.github.com/users/tbg/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tbg", "id": 5076964, "node_id": "MDQ6VXNlcjUwNzY5NjQ=", "avatar_url": "https://avatars.githubusercontent.com/u/5076964?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tbg", "html_url": "https://github.com/tbg", "followers_url": "https://api.github.com/users/tbg/followers", "following_url": "https://api.github.com/users/tbg/following{/other_user}", "gists_url": "https://api.github.com/users/tbg/gists{/gist_id}", "starred_url": "https://api.github.com/users/tbg/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tbg/subscriptions", "organizations_url": "https://api.github.com/users/tbg/orgs", "repos_url": "https://api.github.com/users/tbg/repos", "events_url": "https://api.github.com/users/tbg/events{/privacy}", "received_events_url": "https://api.github.com/users/tbg/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6f10e2f63de720468e2b4bfcb275e4b90b1f9870", "url": "https://api.github.com/repos/rust-lang/rust/commits/6f10e2f63de720468e2b4bfcb275e4b90b1f9870", "html_url": "https://github.com/rust-lang/rust/commit/6f10e2f63de720468e2b4bfcb275e4b90b1f9870"}], "stats": {"total": 46, "additions": 43, "deletions": 3}, "files": [{"sha": "034f9f4eb25238fedf7cbe5d246144e103ecd9de", "filename": "src/doc/unstable-book/src/SUMMARY.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/b43c744318b76934cdbcc0c8a4fdbc7d0091bbd8/src%2Fdoc%2Funstable-book%2Fsrc%2FSUMMARY.md", "raw_url": "https://github.com/rust-lang/rust/raw/b43c744318b76934cdbcc0c8a4fdbc7d0091bbd8/src%2Fdoc%2Funstable-book%2Fsrc%2FSUMMARY.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Funstable-book%2Fsrc%2FSUMMARY.md?ref=b43c744318b76934cdbcc0c8a4fdbc7d0091bbd8", "patch": "@@ -71,6 +71,7 @@\n - [repr_simd](repr-simd.md)\n - [rustc_attrs](rustc-attrs.md)\n - [rustc_diagnostic_macros](rustc-diagnostic-macros.md)\n+- [rvalue_static_promotion](rvalue-static-promotion.md)\n - [sanitizer_runtime](sanitizer-runtime.md)\n - [simd](simd.md)\n - [simd_ffi](simd-ffi.md)"}, {"sha": "3b654960c8e3cc37b88d95606f09eb9f43b462b4", "filename": "src/doc/unstable-book/src/rvalue-static-promotion.md", "status": "added", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/b43c744318b76934cdbcc0c8a4fdbc7d0091bbd8/src%2Fdoc%2Funstable-book%2Fsrc%2Frvalue-static-promotion.md", "raw_url": "https://github.com/rust-lang/rust/raw/b43c744318b76934cdbcc0c8a4fdbc7d0091bbd8/src%2Fdoc%2Funstable-book%2Fsrc%2Frvalue-static-promotion.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Funstable-book%2Fsrc%2Frvalue-static-promotion.md?ref=b43c744318b76934cdbcc0c8a4fdbc7d0091bbd8", "patch": "@@ -0,0 +1,5 @@\n+# `rvalue_static_promotion`\n+\n+The tracking issue for this feature is: [#38865]\n+\n+------------------------"}, {"sha": "a669ac3a69b9855f4c310f2afe254ff39536265c", "filename": "src/librustc/middle/mem_categorization.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/b43c744318b76934cdbcc0c8a4fdbc7d0091bbd8/src%2Flibrustc%2Fmiddle%2Fmem_categorization.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b43c744318b76934cdbcc0c8a4fdbc7d0091bbd8/src%2Flibrustc%2Fmiddle%2Fmem_categorization.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fmem_categorization.rs?ref=b43c744318b76934cdbcc0c8a4fdbc7d0091bbd8", "patch": "@@ -843,11 +843,10 @@ impl<'a, 'gcx, 'tcx> MemCategorizationContext<'a, 'gcx, 'tcx> {\n         let promotable = self.tcx().rvalue_promotable_to_static.borrow().get(&id).cloned()\n                                    .unwrap_or(false);\n \n-        // Only promote `[T; 0]` before an RFC for rvalue promotions\n-        // is accepted.\n+        // When the corresponding feature isn't toggled, only promote `[T; 0]`.\n         let promotable = match expr_ty.sty {\n             ty::TyArray(_, 0) => true,\n-            _ => promotable & false\n+            _ => promotable & self.tcx().sess.features.borrow().rvalue_static_promotion,\n         };\n \n         // Compute maximum lifetime of this rvalue. This is 'static if"}, {"sha": "59e9ab30e0e8c765653e19868d372130179e0d4f", "filename": "src/libsyntax/feature_gate.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/b43c744318b76934cdbcc0c8a4fdbc7d0091bbd8/src%2Flibsyntax%2Ffeature_gate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b43c744318b76934cdbcc0c8a4fdbc7d0091bbd8/src%2Flibsyntax%2Ffeature_gate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Ffeature_gate.rs?ref=b43c744318b76934cdbcc0c8a4fdbc7d0091bbd8", "patch": "@@ -342,6 +342,9 @@ declare_features! (\n \n     // Allows the `catch {...}` expression\n     (active, catch_expr, \"1.17.0\", Some(31436)),\n+\n+    // See rust-lang/rfcs#1414. Allows code like `let x: &'static u32 = &42` to work.\n+    (active, rvalue_static_promotion, \"1.15.1\", Some(38865)),\n );\n \n declare_features! ("}, {"sha": "41dc282be41f0be200cba34f7079a2dd1cae4486", "filename": "src/test/compile-fail/feature-gate-rvalue_static_promotion.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/b43c744318b76934cdbcc0c8a4fdbc7d0091bbd8/src%2Ftest%2Fcompile-fail%2Ffeature-gate-rvalue_static_promotion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b43c744318b76934cdbcc0c8a4fdbc7d0091bbd8/src%2Ftest%2Fcompile-fail%2Ffeature-gate-rvalue_static_promotion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Ffeature-gate-rvalue_static_promotion.rs?ref=b43c744318b76934cdbcc0c8a4fdbc7d0091bbd8", "patch": "@@ -0,0 +1,15 @@\n+// Copyright 2017 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#[allow(unused_variables)]\n+fn main() {\n+    let x: &'static u32 = &42; //~ error: does not live long enough\n+    let y: &'static Option<u32> = &None; //~ error: does not live long enough\n+}\n\\ No newline at end of file"}, {"sha": "f8d93783877bba4ee899f808f827d932f5e71a0e", "filename": "src/test/run-pass/rvalue-static-promotion.rs", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/b43c744318b76934cdbcc0c8a4fdbc7d0091bbd8/src%2Ftest%2Frun-pass%2Frvalue-static-promotion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b43c744318b76934cdbcc0c8a4fdbc7d0091bbd8/src%2Ftest%2Frun-pass%2Frvalue-static-promotion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Frvalue-static-promotion.rs?ref=b43c744318b76934cdbcc0c8a4fdbc7d0091bbd8", "patch": "@@ -0,0 +1,17 @@\n+// Copyright 2017 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![feature(rvalue_static_promotion)]\n+\n+#[allow(unused_variables)]\n+fn main() {\n+    let x: &'static u32 = &42;\n+    let y: &'static Option<u32> = &None;\n+}\n\\ No newline at end of file"}]}