{"sha": "911659a166c48fcdd258140205d414bbd9d11f42", "node_id": "MDY6Q29tbWl0NzI0NzEyOjkxMTY1OWExNjZjNDhmY2RkMjU4MTQwMjA1ZDQxNGJiZDlkMTFmNDI=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-09-15T18:13:09Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-09-15T18:13:09Z"}, "message": "Merge #10048\n\n10048: fix: correctly complete macro call if cursor at `!` r=Veykril a=unexge\n\nFixes https://github.com/rust-analyzer/rust-analyzer/issues/9904\n\nCo-authored-by: unexge <unexge@gmail.com>", "tree": {"sha": "1fa23f625e76202c13042b329895763b44473c73", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1fa23f625e76202c13042b329895763b44473c73"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/911659a166c48fcdd258140205d414bbd9d11f42", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhQje1CRBK7hj4Ov3rIwAAheIIAKm3K+kDOPTHmNC/4Ex4YpAe\nS2r/RXbKDcilLVgdeek5U2SGyE67OkpkULTuIn6bipgAVebwlQpurI81xEz6wC/P\n6eNu1xirYlEqQFw+k7YcEi4lZ/BXbjL57Z2/8j9hfgT/LiDb/w7iUwK1aXsj3yWM\npUjkM2uaZMTdVB6T5G9n8sxaK1FXMXojhuGxdZGKSzCNDyGOrQpNwgCZd38QHLME\nsUke9Mm/VrW87PvE/T/wTHgmoZR0r9xWwatfVjR3uJMJVgOyc4pcjsJfvfY1yVst\nWcsqKHPOS4oYlw+HNANXhMw6XcHiHpBlRkif1Gvdcd97+0Kk9oPz/QLD6MwGi5U=\n=uTLm\n-----END PGP SIGNATURE-----\n", "payload": "tree 1fa23f625e76202c13042b329895763b44473c73\nparent 4c9eef7edea40f8a30b033cc81ef14546c63fba6\nparent e0e7f0c1702063552f090b20aa980454ac61f02b\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1631729589 +0000\ncommitter GitHub <noreply@github.com> 1631729589 +0000\n\nMerge #10048\n\n10048: fix: correctly complete macro call if cursor at `!` r=Veykril a=unexge\n\nFixes https://github.com/rust-analyzer/rust-analyzer/issues/9904\n\nCo-authored-by: unexge <unexge@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/911659a166c48fcdd258140205d414bbd9d11f42", "html_url": "https://github.com/rust-lang/rust/commit/911659a166c48fcdd258140205d414bbd9d11f42", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/911659a166c48fcdd258140205d414bbd9d11f42/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4c9eef7edea40f8a30b033cc81ef14546c63fba6", "url": "https://api.github.com/repos/rust-lang/rust/commits/4c9eef7edea40f8a30b033cc81ef14546c63fba6", "html_url": "https://github.com/rust-lang/rust/commit/4c9eef7edea40f8a30b033cc81ef14546c63fba6"}, {"sha": "e0e7f0c1702063552f090b20aa980454ac61f02b", "url": "https://api.github.com/repos/rust-lang/rust/commits/e0e7f0c1702063552f090b20aa980454ac61f02b", "html_url": "https://github.com/rust-lang/rust/commit/e0e7f0c1702063552f090b20aa980454ac61f02b"}], "stats": {"total": 40, "additions": 38, "deletions": 2}, "files": [{"sha": "11df134466222fceab7b60d9aaaaaafa30911682", "filename": "crates/ide_completion/src/context.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/911659a166c48fcdd258140205d414bbd9d11f42/crates%2Fide_completion%2Fsrc%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/911659a166c48fcdd258140205d414bbd9d11f42/crates%2Fide_completion%2Fsrc%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Fcontext.rs?ref=911659a166c48fcdd258140205d414bbd9d11f42", "patch": "@@ -438,6 +438,10 @@ impl<'a> CompletionContext<'a> {\n         }\n     }\n \n+    pub(crate) fn is_immediately_after_macro_bang(&self) -> bool {\n+        self.token.kind() == BANG && self.token.parent().map_or(false, |it| it.kind() == MACRO_CALL)\n+    }\n+\n     /// A version of [`SemanticsScope::process_all_names`] that filters out `#[doc(hidden)]` items.\n     pub(crate) fn process_all_names(&self, f: &mut dyn FnMut(Name, ScopeDef)) {\n         self.scope.process_all_names(&mut |name, def| {"}, {"sha": "d1b549df1bb9df0339d48e47ffb5755c39001a1c", "filename": "crates/ide_completion/src/render/macro_.rs", "status": "modified", "additions": 34, "deletions": 2, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/911659a166c48fcdd258140205d414bbd9d11f42/crates%2Fide_completion%2Fsrc%2Frender%2Fmacro_.rs", "raw_url": "https://github.com/rust-lang/rust/raw/911659a166c48fcdd258140205d414bbd9d11f42/crates%2Fide_completion%2Fsrc%2Frender%2Fmacro_.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_completion%2Fsrc%2Frender%2Fmacro_.rs?ref=911659a166c48fcdd258140205d414bbd9d11f42", "patch": "@@ -41,8 +41,13 @@ impl<'a> MacroRender<'a> {\n     }\n \n     fn render(&self, import_to_add: Option<ImportEdit>) -> Option<CompletionItem> {\n-        let mut item =\n-            CompletionItem::new(CompletionKind::Reference, self.ctx.source_range(), &self.label());\n+        let source_range = if self.ctx.completion.is_immediately_after_macro_bang() {\n+            cov_mark::hit!(completes_macro_call_if_cursor_at_bang_token);\n+            self.ctx.completion.token.parent().map(|it| it.text_range())\n+        } else {\n+            Some(self.ctx.source_range())\n+        }?;\n+        let mut item = CompletionItem::new(CompletionKind::Reference, source_range, &self.label());\n         item.kind(SymbolKind::Macro)\n             .set_documentation(self.docs.clone())\n             .set_deprecated(self.ctx.is_deprecated(self.macro_))\n@@ -230,4 +235,31 @@ fn main() { foo! {$0} }\n \"#,\n         )\n     }\n+\n+    #[test]\n+    fn completes_macro_call_if_cursor_at_bang_token() {\n+        // Regression test for https://github.com/rust-analyzer/rust-analyzer/issues/9904\n+        cov_mark::check!(completes_macro_call_if_cursor_at_bang_token);\n+        check_edit(\n+            \"foo!\",\n+            r#\"\n+macro_rules! foo {\n+    () => {}\n+}\n+\n+fn main() {\n+    foo!$0\n+}\n+\"#,\n+            r#\"\n+macro_rules! foo {\n+    () => {}\n+}\n+\n+fn main() {\n+    foo!($0)\n+}\n+\"#,\n+        );\n+    }\n }"}]}