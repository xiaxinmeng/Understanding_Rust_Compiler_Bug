{"sha": "4f233a513e0f52bfea3c89f0660ea4f7f4c13fb6", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRmMjMzYTUxM2UwZjUyYmZlYTNjODlmMDY2MGVhNGY3ZjRjMTNmYjY=", "commit": {"author": {"name": "Nick Cameron", "email": "nrc@ncameron.org", "date": "2018-11-28T22:48:46Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2018-11-28T22:48:46Z"}, "message": "Merge pull request #3222 from scampi/issue-3217\n\nfix the visitor's starting position when visiting a labelled block", "tree": {"sha": "bd09162e0f43ededf8d8f3b4f3ae600ccac9e6a4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bd09162e0f43ededf8d8f3b4f3ae600ccac9e6a4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4f233a513e0f52bfea3c89f0660ea4f7f4c13fb6", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJb/xtOCRBK7hj4Ov3rIwAAdHIIAFLGut/YQIDhfe9oAOxtcRqu\nWGzvBoQlqvxQS6mFI3QUI/4/auHm50RnE/RtXHx0i5kM49S5tbtUCQ3ZeYndifWQ\njzGRym5EZpJT2GKhh+99SWf3mcKyxGN7QuvuXGriezg2xVu06McL5MIXxOKtbSSq\nCL2As3dr8JErjN4Xc7kJ9UIPH5aDrvMsSTAmo0T6OHvQAyzN1H4GqqylR3sJt9fO\nwfGaoTg4V3/hZ2xOQ5lJUP3kgVwyQKFwM2S62Fqqf+4SgCkGYL4nHFN2jyT0PeUW\nbVX8CRv2SKIvjJEqQPC+fHg9HG7Fj843WbmjacVigom1f5rmk4CulEtozJ1kmQQ=\n=8gye\n-----END PGP SIGNATURE-----\n", "payload": "tree bd09162e0f43ededf8d8f3b4f3ae600ccac9e6a4\nparent bbc380b1e6b0e41042c8c259dfad49cea7af0b35\nparent 40174e9481872d99ac446ac61e27cf800bfd4842\nauthor Nick Cameron <nrc@ncameron.org> 1543445326 +1300\ncommitter GitHub <noreply@github.com> 1543445326 +1300\n\nMerge pull request #3222 from scampi/issue-3217\n\nfix the visitor's starting position when visiting a labelled block"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4f233a513e0f52bfea3c89f0660ea4f7f4c13fb6", "html_url": "https://github.com/rust-lang/rust/commit/4f233a513e0f52bfea3c89f0660ea4f7f4c13fb6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4f233a513e0f52bfea3c89f0660ea4f7f4c13fb6/comments", "author": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bbc380b1e6b0e41042c8c259dfad49cea7af0b35", "url": "https://api.github.com/repos/rust-lang/rust/commits/bbc380b1e6b0e41042c8c259dfad49cea7af0b35", "html_url": "https://github.com/rust-lang/rust/commit/bbc380b1e6b0e41042c8c259dfad49cea7af0b35"}, {"sha": "40174e9481872d99ac446ac61e27cf800bfd4842", "url": "https://api.github.com/repos/rust-lang/rust/commits/40174e9481872d99ac446ac61e27cf800bfd4842", "html_url": "https://github.com/rust-lang/rust/commit/40174e9481872d99ac446ac61e27cf800bfd4842"}], "stats": {"total": 53, "additions": 42, "deletions": 11}, "files": [{"sha": "5d0383ddcb2b8e7a644ce22f9422a743e8444903", "filename": "src/expr.rs", "status": "modified", "additions": 8, "deletions": 7, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/4f233a513e0f52bfea3c89f0660ea4f7f4c13fb6/src%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4f233a513e0f52bfea3c89f0660ea4f7f4c13fb6/src%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fexpr.rs?ref=4f233a513e0f52bfea3c89f0660ea4f7f4c13fb6", "patch": "@@ -417,15 +417,16 @@ fn rewrite_empty_block(\n     prefix: &str,\n     shape: Shape,\n ) -> Option<String> {\n+    if !block.stmts.is_empty() {\n+        return None;\n+    }\n+\n     let label_str = rewrite_label(label);\n     if attrs.map_or(false, |a| !inner_attributes(a).is_empty()) {\n         return None;\n     }\n \n-    if block.stmts.is_empty()\n-        && !block_contains_comment(block, context.source_map)\n-        && shape.width >= 2\n-    {\n+    if !block_contains_comment(block, context.source_map) && shape.width >= 2 {\n         return Some(format!(\"{}{}{{}}\", prefix, label_str));\n     }\n \n@@ -510,13 +511,13 @@ pub fn rewrite_block_with_visitor(\n     let mut visitor = FmtVisitor::from_context(context);\n     visitor.block_indent = shape.indent;\n     visitor.is_if_else_block = context.is_if_else_block();\n-    match block.rules {\n-        ast::BlockCheckMode::Unsafe(..) => {\n+    match (block.rules, label) {\n+        (ast::BlockCheckMode::Unsafe(..), _) | (ast::BlockCheckMode::Default, Some(_)) => {\n             let snippet = context.snippet(block.span);\n             let open_pos = snippet.find_uncommented(\"{\")?;\n             visitor.last_pos = block.span.lo() + BytePos(open_pos as u32)\n         }\n-        ast::BlockCheckMode::Default => visitor.last_pos = block.span.lo(),\n+        (ast::BlockCheckMode::Default, None) => visitor.last_pos = block.span.lo(),\n     }\n \n     let inner_attrs = attrs.map(inner_attributes);"}, {"sha": "eddc04460350c434f0dc1587e2a74608817efab2", "filename": "src/reorder.rs", "status": "modified", "additions": 2, "deletions": 4, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/4f233a513e0f52bfea3c89f0660ea4f7f4c13fb6/src%2Freorder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4f233a513e0f52bfea3c89f0660ea4f7f4c13fb6/src%2Freorder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Freorder.rs?ref=4f233a513e0f52bfea3c89f0660ea4f7f4c13fb6", "patch": "@@ -42,10 +42,8 @@ fn compare_items(a: &ast::Item, b: &ast::Item) -> Ordering {\n         (&ast::ItemKind::ExternCrate(ref a_name), &ast::ItemKind::ExternCrate(ref b_name)) => {\n             // `extern crate foo as bar;`\n             //               ^^^ Comparing this.\n-            let a_orig_name =\n-                a_name.map_or_else(|| a.ident.as_str(), |symbol| symbol.as_str());\n-            let b_orig_name =\n-                b_name.map_or_else(|| b.ident.as_str(), |symbol| symbol.as_str());\n+            let a_orig_name = a_name.map_or_else(|| a.ident.as_str(), |symbol| symbol.as_str());\n+            let b_orig_name = b_name.map_or_else(|| b.ident.as_str(), |symbol| symbol.as_str());\n             let result = a_orig_name.cmp(&b_orig_name);\n             if result != Ordering::Equal {\n                 return result;"}, {"sha": "176c702002a2804e157f845ea3c7aa1af8ac9628", "filename": "tests/source/issue-3217.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/4f233a513e0f52bfea3c89f0660ea4f7f4c13fb6/tests%2Fsource%2Fissue-3217.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4f233a513e0f52bfea3c89f0660ea4f7f4c13fb6/tests%2Fsource%2Fissue-3217.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fissue-3217.rs?ref=4f233a513e0f52bfea3c89f0660ea4f7f4c13fb6", "patch": "@@ -0,0 +1,8 @@\n+#![feature(label_break_value)]\n+\n+fn main() {\n+    let mut res = 0;\n+    's_39: { if res == 0i32 { println!(\"Hello, world!\"); } }\n+    's_40: loop { println!(\"res = {}\", res); res += 1; if res == 3i32 { break 's_40; } }\n+    let toto = || { if true { 42 } else { 24 } };\n+}"}, {"sha": "5121320a0975b1e523ef025ccab9bf3109a2c0f5", "filename": "tests/target/issue-3217.rs", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/4f233a513e0f52bfea3c89f0660ea4f7f4c13fb6/tests%2Ftarget%2Fissue-3217.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4f233a513e0f52bfea3c89f0660ea4f7f4c13fb6/tests%2Ftarget%2Fissue-3217.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fissue-3217.rs?ref=4f233a513e0f52bfea3c89f0660ea4f7f4c13fb6", "patch": "@@ -0,0 +1,24 @@\n+#![feature(label_break_value)]\n+\n+fn main() {\n+    let mut res = 0;\n+    's_39: {\n+        if res == 0i32 {\n+            println!(\"Hello, world!\");\n+        }\n+    }\n+    's_40: loop {\n+        println!(\"res = {}\", res);\n+        res += 1;\n+        if res == 3i32 {\n+            break 's_40;\n+        }\n+    }\n+    let toto = || {\n+        if true {\n+            42\n+        } else {\n+            24\n+        }\n+    };\n+}"}]}