{"sha": "afbd004d696063adf1301ae461c41565f2f1921a", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFmYmQwMDRkNjk2MDYzYWRmMTMwMWFlNDYxYzQxNTY1ZjJmMTkyMWE=", "commit": {"author": {"name": "Nicholas Nethercote", "email": "nnethercote@mozilla.com", "date": "2019-01-16T23:39:24Z"}, "committer": {"name": "Nicholas Nethercote", "email": "nnethercote@mozilla.com", "date": "2019-01-17T01:13:22Z"}, "message": "Remove `hir::StmtKind::Decl`.\n\nIt's a level of indirection that hurts far more than it helps. The code\nis simpler without it. (This commit cuts more than 120 lines of code.)\n\nIn particular, this commit removes some unnecessary `Span`s within\n`DeclKind` that were always identical to those in the enclosing `Stmt`,\nand some unnecessary allocations via `P`.", "tree": {"sha": "d7665dd808adc79b361516e104e76eb2b70f6e51", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d7665dd808adc79b361516e104e76eb2b70f6e51"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/afbd004d696063adf1301ae461c41565f2f1921a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/afbd004d696063adf1301ae461c41565f2f1921a", "html_url": "https://github.com/rust-lang/rust/commit/afbd004d696063adf1301ae461c41565f2f1921a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/afbd004d696063adf1301ae461c41565f2f1921a/comments", "author": {"login": "nnethercote", "id": 1940286, "node_id": "MDQ6VXNlcjE5NDAyODY=", "avatar_url": "https://avatars.githubusercontent.com/u/1940286?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nnethercote", "html_url": "https://github.com/nnethercote", "followers_url": "https://api.github.com/users/nnethercote/followers", "following_url": "https://api.github.com/users/nnethercote/following{/other_user}", "gists_url": "https://api.github.com/users/nnethercote/gists{/gist_id}", "starred_url": "https://api.github.com/users/nnethercote/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nnethercote/subscriptions", "organizations_url": "https://api.github.com/users/nnethercote/orgs", "repos_url": "https://api.github.com/users/nnethercote/repos", "events_url": "https://api.github.com/users/nnethercote/events{/privacy}", "received_events_url": "https://api.github.com/users/nnethercote/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nnethercote", "id": 1940286, "node_id": "MDQ6VXNlcjE5NDAyODY=", "avatar_url": "https://avatars.githubusercontent.com/u/1940286?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nnethercote", "html_url": "https://github.com/nnethercote", "followers_url": "https://api.github.com/users/nnethercote/followers", "following_url": "https://api.github.com/users/nnethercote/following{/other_user}", "gists_url": "https://api.github.com/users/nnethercote/gists{/gist_id}", "starred_url": "https://api.github.com/users/nnethercote/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nnethercote/subscriptions", "organizations_url": "https://api.github.com/users/nnethercote/orgs", "repos_url": "https://api.github.com/users/nnethercote/repos", "events_url": "https://api.github.com/users/nnethercote/events{/privacy}", "received_events_url": "https://api.github.com/users/nnethercote/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b2ce5a90995be655b1a1e8fd764e2b1c1f0dab14", "url": "https://api.github.com/repos/rust-lang/rust/commits/b2ce5a90995be655b1a1e8fd764e2b1c1f0dab14", "html_url": "https://github.com/rust-lang/rust/commit/b2ce5a90995be655b1a1e8fd764e2b1c1f0dab14"}], "stats": {"total": 422, "additions": 150, "deletions": 272}, "files": [{"sha": "6122fe6370940cd9d2d89e19e8b86daa7fee58e7", "filename": "src/librustc/cfg/construct.rs", "status": "modified", "additions": 10, "deletions": 19, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/afbd004d696063adf1301ae461c41565f2f1921a/src%2Flibrustc%2Fcfg%2Fconstruct.rs", "raw_url": "https://github.com/rust-lang/rust/raw/afbd004d696063adf1301ae461c41565f2f1921a/src%2Flibrustc%2Fcfg%2Fconstruct.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fcfg%2Fconstruct.rs?ref=afbd004d696063adf1301ae461c41565f2f1921a", "patch": "@@ -100,29 +100,20 @@ impl<'a, 'tcx> CFGBuilder<'a, 'tcx> {\n \n     fn stmt(&mut self, stmt: &hir::Stmt, pred: CFGIndex) -> CFGIndex {\n         let hir_id = self.tcx.hir().node_to_hir_id(stmt.id);\n-        match stmt.node {\n-            hir::StmtKind::Decl(ref decl) => {\n-                let exit = self.decl(&decl, pred);\n-                self.add_ast_node(hir_id.local_id, &[exit])\n+        let exit = match stmt.node {\n+            hir::StmtKind::Local(ref local) => {\n+                let init_exit = self.opt_expr(&local.init, pred);\n+                self.pat(&local.pat, init_exit)\n+            }\n+            hir::StmtKind::Item(_) => {\n+                pred\n             }\n-\n             hir::StmtKind::Expr(ref expr) |\n             hir::StmtKind::Semi(ref expr) => {\n-                let exit = self.expr(&expr, pred);\n-                self.add_ast_node(hir_id.local_id, &[exit])\n+                self.expr(&expr, pred)\n             }\n-        }\n-    }\n-\n-    fn decl(&mut self, decl: &hir::Decl, pred: CFGIndex) -> CFGIndex {\n-        match decl.node {\n-            hir::DeclKind::Local(ref local) => {\n-                let init_exit = self.opt_expr(&local.init, pred);\n-                self.pat(&local.pat, init_exit)\n-            }\n-\n-            hir::DeclKind::Item(_) => pred,\n-        }\n+        };\n+        self.add_ast_node(hir_id.local_id, &[exit])\n     }\n \n     fn pat(&mut self, pat: &hir::Pat, pred: CFGIndex) -> CFGIndex {"}, {"sha": "9fa5f4aabe5123a888d266def35652df36504550", "filename": "src/librustc/hir/check_attr.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/afbd004d696063adf1301ae461c41565f2f1921a/src%2Flibrustc%2Fhir%2Fcheck_attr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/afbd004d696063adf1301ae461c41565f2f1921a/src%2Flibrustc%2Fhir%2Fcheck_attr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Fcheck_attr.rs?ref=afbd004d696063adf1301ae461c41565f2f1921a", "patch": "@@ -298,8 +298,8 @@ impl<'a, 'tcx> CheckAttrVisitor<'a, 'tcx> {\n \n     fn check_stmt_attributes(&self, stmt: &hir::Stmt) {\n         // When checking statements ignore expressions, they will be checked later\n-        if let hir::StmtKind::Decl(..) = stmt.node {\n-            for attr in stmt.node.attrs() {\n+        if let hir::StmtKind::Local(ref l) = stmt.node {\n+            for attr in l.attrs.iter() {\n                 if attr.check_name(\"inline\") {\n                     self.check_inline(attr, &stmt.span, Target::Statement);\n                 }"}, {"sha": "a3eda804aa70cf7520c8409443a8564eb9f6e286", "filename": "src/librustc/hir/intravisit.rs", "status": "modified", "additions": 2, "deletions": 13, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/afbd004d696063adf1301ae461c41565f2f1921a/src%2Flibrustc%2Fhir%2Fintravisit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/afbd004d696063adf1301ae461c41565f2f1921a/src%2Flibrustc%2Fhir%2Fintravisit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Fintravisit.rs?ref=afbd004d696063adf1301ae461c41565f2f1921a", "patch": "@@ -260,9 +260,6 @@ pub trait Visitor<'v> : Sized {\n     fn visit_pat(&mut self, p: &'v Pat) {\n         walk_pat(self, p)\n     }\n-    fn visit_decl(&mut self, d: &'v Decl) {\n-        walk_decl(self, d)\n-    }\n     fn visit_anon_const(&mut self, c: &'v AnonConst) {\n         walk_anon_const(self, c)\n     }\n@@ -955,23 +952,15 @@ pub fn walk_block<'v, V: Visitor<'v>>(visitor: &mut V, block: &'v Block) {\n pub fn walk_stmt<'v, V: Visitor<'v>>(visitor: &mut V, statement: &'v Stmt) {\n     visitor.visit_id(statement.id);\n     match statement.node {\n-        StmtKind::Decl(ref declaration) => {\n-            visitor.visit_decl(declaration)\n-        }\n+        StmtKind::Local(ref local) => visitor.visit_local(local),\n+        StmtKind::Item(ref item) => visitor.visit_nested_item(**item),\n         StmtKind::Expr(ref expression) |\n         StmtKind::Semi(ref expression) => {\n             visitor.visit_expr(expression)\n         }\n     }\n }\n \n-pub fn walk_decl<'v, V: Visitor<'v>>(visitor: &mut V, declaration: &'v Decl) {\n-    match declaration.node {\n-        DeclKind::Local(ref local) => visitor.visit_local(local),\n-        DeclKind::Item(item) => visitor.visit_nested_item(item),\n-    }\n-}\n-\n pub fn walk_anon_const<'v, V: Visitor<'v>>(visitor: &mut V, constant: &'v AnonConst) {\n     visitor.visit_id(constant.id);\n     visitor.visit_nested_body(constant.body);"}, {"sha": "02e66300f24d9ce72795834c0dd7cbc5a297970c", "filename": "src/librustc/hir/lowering.rs", "status": "modified", "additions": 9, "deletions": 25, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/afbd004d696063adf1301ae461c41565f2f1921a/src%2Flibrustc%2Fhir%2Flowering.rs", "raw_url": "https://github.com/rust-lang/rust/raw/afbd004d696063adf1301ae461c41565f2f1921a/src%2Flibrustc%2Fhir%2Flowering.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Flowering.rs?ref=afbd004d696063adf1301ae461c41565f2f1921a", "patch": "@@ -1957,7 +1957,7 @@ impl<'a> LoweringContext<'a> {\n         )\n     }\n \n-    fn lower_local(&mut self, l: &Local) -> (P<hir::Local>, SmallVec<[hir::ItemId; 1]>) {\n+    fn lower_local(&mut self, l: &Local) -> (hir::Local, SmallVec<[hir::ItemId; 1]>) {\n         let LoweredNodeId { node_id, hir_id } = self.lower_node_id(l.id);\n         let mut ids = SmallVec::<[hir::ItemId; 1]>::new();\n         if self.sess.features_untracked().impl_trait_in_bindings {\n@@ -1967,7 +1967,7 @@ impl<'a> LoweringContext<'a> {\n             }\n         }\n         let parent_def_id = DefId::local(self.current_hir_id_owner.last().unwrap().0);\n-        (P(hir::Local {\n+        (hir::Local {\n             id: node_id,\n             hir_id,\n             ty: l.ty\n@@ -1984,7 +1984,7 @@ impl<'a> LoweringContext<'a> {\n             span: l.span,\n             attrs: l.attrs.clone(),\n             source: hir::LocalSource::Normal,\n-        }), ids)\n+        }, ids)\n     }\n \n     fn lower_mutability(&mut self, m: Mutability) -> hir::Mutability {\n@@ -4537,23 +4537,13 @@ impl<'a> LoweringContext<'a> {\n                     .into_iter()\n                     .map(|item_id| hir::Stmt {\n                         id: self.next_id().node_id,\n-                        node: hir::StmtKind::Decl(\n-                            P(Spanned {\n-                                node: hir::DeclKind::Item(item_id),\n-                                span: s.span,\n-                            }),\n-                        ),\n+                        node: hir::StmtKind::Item(P(item_id)),\n                         span: s.span,\n                     })\n                     .collect();\n                 ids.push(hir::Stmt {\n                     id: self.lower_node_id(s.id).node_id,\n-                    node: hir::StmtKind::Decl(\n-                        P(Spanned {\n-                            node: hir::DeclKind::Local(l),\n-                            span: s.span,\n-                        }),\n-                    ),\n+                    node: hir::StmtKind::Local(P(l)),\n                     span: s.span,\n                 });\n                 return ids;\n@@ -4567,12 +4557,7 @@ impl<'a> LoweringContext<'a> {\n                         id: id.take()\n                               .map(|id| self.lower_node_id(id).node_id)\n                               .unwrap_or_else(|| self.next_id().node_id),\n-                        node: hir::StmtKind::Decl(\n-                            P(Spanned {\n-                                node: hir::DeclKind::Item(item_id),\n-                                span: s.span,\n-                            }),\n-                        ),\n+                        node: hir::StmtKind::Item(P(item_id)),\n                         span: s.span,\n                     })\n                     .collect();\n@@ -4799,7 +4784,7 @@ impl<'a> LoweringContext<'a> {\n     ) -> hir::Stmt {\n         let LoweredNodeId { node_id, hir_id } = self.next_id();\n \n-        let local = P(hir::Local {\n+        let local = hir::Local {\n             pat,\n             ty: None,\n             init: ex,\n@@ -4808,11 +4793,10 @@ impl<'a> LoweringContext<'a> {\n             span: sp,\n             attrs: ThinVec::new(),\n             source,\n-        });\n-        let decl = respan(sp, hir::DeclKind::Local(local));\n+        };\n         hir::Stmt {\n             id: self.next_id().node_id,\n-            node: hir::StmtKind::Decl(P(decl)),\n+            node: hir::StmtKind::Local(P(local)),\n             span: sp\n         }\n     }"}, {"sha": "5660b879c9733f10163c71858577191e2fd545e0", "filename": "src/librustc/hir/mod.rs", "status": "modified", "additions": 6, "deletions": 29, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/afbd004d696063adf1301ae461c41565f2f1921a/src%2Flibrustc%2Fhir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/afbd004d696063adf1301ae461c41565f2f1921a/src%2Flibrustc%2Fhir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Fmod.rs?ref=afbd004d696063adf1301ae461c41565f2f1921a", "patch": "@@ -1160,8 +1160,10 @@ impl fmt::Debug for Stmt {\n \n #[derive(Clone, RustcEncodable, RustcDecodable)]\n pub enum StmtKind {\n-    /// Could be an item or a local (let) binding:\n-    Decl(P<Decl>),\n+    /// A local (let) binding:\n+    Local(P<Local>),\n+    /// An item binding:\n+    Item(P<ItemId>),\n \n     /// Expr without trailing semi-colon (must have unit type):\n     Expr(P<Expr>),\n@@ -1173,7 +1175,8 @@ pub enum StmtKind {\n impl StmtKind {\n     pub fn attrs(&self) -> &[Attribute] {\n         match *self {\n-            StmtKind::Decl(ref d) => d.node.attrs(),\n+            StmtKind::Local(ref l) => &l.attrs,\n+            StmtKind::Item(_) => &[],\n             StmtKind::Expr(ref e) |\n             StmtKind::Semi(ref e) => &e.attrs,\n         }\n@@ -1194,32 +1197,6 @@ pub struct Local {\n     pub source: LocalSource,\n }\n \n-pub type Decl = Spanned<DeclKind>;\n-\n-#[derive(Clone, RustcEncodable, RustcDecodable, Debug)]\n-pub enum DeclKind {\n-    /// A local (let) binding:\n-    Local(P<Local>),\n-    /// An item binding:\n-    Item(ItemId),\n-}\n-\n-impl DeclKind {\n-    pub fn attrs(&self) -> &[Attribute] {\n-        match *self {\n-            DeclKind::Local(ref l) => &l.attrs,\n-            DeclKind::Item(_) => &[]\n-        }\n-    }\n-\n-    pub fn is_local(&self) -> bool {\n-        match *self {\n-            DeclKind::Local(_) => true,\n-            _ => false,\n-        }\n-    }\n-}\n-\n /// represents one arm of a 'match'\n #[derive(Clone, RustcEncodable, RustcDecodable, Debug)]\n pub struct Arm {"}, {"sha": "e950f25c2ac9ae8697dbc969d91dc54ea30c9625", "filename": "src/librustc/hir/print.rs", "status": "modified", "additions": 21, "deletions": 38, "changes": 59, "blob_url": "https://github.com/rust-lang/rust/blob/afbd004d696063adf1301ae461c41565f2f1921a/src%2Flibrustc%2Fhir%2Fprint.rs", "raw_url": "https://github.com/rust-lang/rust/raw/afbd004d696063adf1301ae461c41565f2f1921a/src%2Flibrustc%2Fhir%2Fprint.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Fprint.rs?ref=afbd004d696063adf1301ae461c41565f2f1921a", "patch": "@@ -992,8 +992,23 @@ impl<'a> State<'a> {\n     pub fn print_stmt(&mut self, st: &hir::Stmt) -> io::Result<()> {\n         self.maybe_print_comment(st.span.lo())?;\n         match st.node {\n-            hir::StmtKind::Decl(ref decl) => {\n-                self.print_decl(&decl)?;\n+            hir::StmtKind::Local(ref loc) => {\n+                self.space_if_not_bol()?;\n+                self.ibox(indent_unit)?;\n+                self.word_nbsp(\"let\")?;\n+\n+                self.ibox(indent_unit)?;\n+                self.print_local_decl(&loc)?;\n+                self.end()?;\n+                if let Some(ref init) = loc.init {\n+                    self.nbsp()?;\n+                    self.word_space(\"=\")?;\n+                    self.print_expr(&init)?;\n+                }\n+                self.end()?\n+            }\n+            hir::StmtKind::Item(ref item) => {\n+                self.ann.nested(self, Nested::Item(**item))?\n             }\n             hir::StmtKind::Expr(ref expr) => {\n                 self.space_if_not_bol()?;\n@@ -1562,30 +1577,6 @@ impl<'a> State<'a> {\n         Ok(())\n     }\n \n-    pub fn print_decl(&mut self, decl: &hir::Decl) -> io::Result<()> {\n-        self.maybe_print_comment(decl.span.lo())?;\n-        match decl.node {\n-            hir::DeclKind::Local(ref loc) => {\n-                self.space_if_not_bol()?;\n-                self.ibox(indent_unit)?;\n-                self.word_nbsp(\"let\")?;\n-\n-                self.ibox(indent_unit)?;\n-                self.print_local_decl(&loc)?;\n-                self.end()?;\n-                if let Some(ref init) = loc.init {\n-                    self.nbsp()?;\n-                    self.word_space(\"=\")?;\n-                    self.print_expr(&init)?;\n-                }\n-                self.end()\n-            }\n-            hir::DeclKind::Item(item) => {\n-                self.ann.nested(self, Nested::Item(item))\n-            }\n-        }\n-    }\n-\n     pub fn print_usize(&mut self, i: usize) -> io::Result<()> {\n         self.s.word(i.to_string())\n     }\n@@ -2401,18 +2392,10 @@ fn expr_requires_semi_to_be_stmt(e: &hir::Expr) -> bool {\n /// seen the semicolon, and thus don't need another.\n fn stmt_ends_with_semi(stmt: &hir::StmtKind) -> bool {\n     match *stmt {\n-        hir::StmtKind::Decl(ref d) => {\n-            match d.node {\n-                hir::DeclKind::Local(_) => true,\n-                hir::DeclKind::Item(_) => false,\n-            }\n-        }\n-        hir::StmtKind::Expr(ref e) => {\n-            expr_requires_semi_to_be_stmt(&e)\n-        }\n-        hir::StmtKind::Semi(..) => {\n-            false\n-        }\n+        hir::StmtKind::Local(_) => true,\n+        hir::StmtKind::Item(_) => false,\n+        hir::StmtKind::Expr(ref e) => expr_requires_semi_to_be_stmt(&e),\n+        hir::StmtKind::Semi(..) => false,\n     }\n }\n "}, {"sha": "9aa8e4c229f47847677cddf9fb37ad83f04a3977", "filename": "src/librustc/ich/impls_hir.rs", "status": "modified", "additions": 2, "deletions": 7, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/afbd004d696063adf1301ae461c41565f2f1921a/src%2Flibrustc%2Fich%2Fimpls_hir.rs", "raw_url": "https://github.com/rust-lang/rust/raw/afbd004d696063adf1301ae461c41565f2f1921a/src%2Flibrustc%2Fich%2Fimpls_hir.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fich%2Fimpls_hir.rs?ref=afbd004d696063adf1301ae461c41565f2f1921a", "patch": "@@ -501,12 +501,6 @@ impl_stable_hash_for!(struct hir::Local {\n     source\n });\n \n-impl_stable_hash_for_spanned!(hir::DeclKind);\n-impl_stable_hash_for!(enum hir::DeclKind {\n-    Local(local),\n-    Item(item_id)\n-});\n-\n impl_stable_hash_for!(struct hir::Arm {\n     attrs,\n     pats,\n@@ -946,7 +940,8 @@ impl_stable_hash_for!(enum hir::ForeignItemKind {\n });\n \n impl_stable_hash_for!(enum hir::StmtKind {\n-    Decl(decl),\n+    Local(local),\n+    Item(item_id),\n     Expr(expr),\n     Semi(expr)\n });"}, {"sha": "837a3645d1c94d3c455bcb2c8523e827875ad69e", "filename": "src/librustc/lint/context.rs", "status": "modified", "additions": 0, "deletions": 5, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/afbd004d696063adf1301ae461c41565f2f1921a/src%2Flibrustc%2Flint%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/afbd004d696063adf1301ae461c41565f2f1921a/src%2Flibrustc%2Flint%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Flint%2Fcontext.rs?ref=afbd004d696063adf1301ae461c41565f2f1921a", "patch": "@@ -941,11 +941,6 @@ impl<'a, 'tcx> hir_visit::Visitor<'tcx> for LateContext<'a, 'tcx> {\n         hir_visit::walk_arm(self, a);\n     }\n \n-    fn visit_decl(&mut self, d: &'tcx hir::Decl) {\n-        run_lints!(self, check_decl, d);\n-        hir_visit::walk_decl(self, d);\n-    }\n-\n     fn visit_generic_param(&mut self, p: &'tcx hir::GenericParam) {\n         run_lints!(self, check_generic_param, p);\n         hir_visit::walk_generic_param(self, p);"}, {"sha": "3caa88dbc898eb5db59954b7bce5d597c8f0e436", "filename": "src/librustc/lint/mod.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/afbd004d696063adf1301ae461c41565f2f1921a/src%2Flibrustc%2Flint%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/afbd004d696063adf1301ae461c41565f2f1921a/src%2Flibrustc%2Flint%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Flint%2Fmod.rs?ref=afbd004d696063adf1301ae461c41565f2f1921a", "patch": "@@ -191,7 +191,6 @@ macro_rules! late_lint_methods {\n             fn check_stmt(a: &$hir hir::Stmt);\n             fn check_arm(a: &$hir hir::Arm);\n             fn check_pat(a: &$hir hir::Pat);\n-            fn check_decl(a: &$hir hir::Decl);\n             fn check_expr(a: &$hir hir::Expr);\n             fn check_expr_post(a: &$hir hir::Expr);\n             fn check_ty(a: &$hir hir::Ty);"}, {"sha": "08210c3f075ce453e3a5fc4c06a80e8207ecee6d", "filename": "src/librustc/middle/expr_use_visitor.rs", "status": "modified", "additions": 6, "deletions": 10, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/afbd004d696063adf1301ae461c41565f2f1921a/src%2Flibrustc%2Fmiddle%2Fexpr_use_visitor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/afbd004d696063adf1301ae461c41565f2f1921a/src%2Flibrustc%2Fmiddle%2Fexpr_use_visitor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fexpr_use_visitor.rs?ref=afbd004d696063adf1301ae461c41565f2f1921a", "patch": "@@ -589,17 +589,13 @@ impl<'a, 'gcx, 'tcx> ExprUseVisitor<'a, 'gcx, 'tcx> {\n \n     fn walk_stmt(&mut self, stmt: &hir::Stmt) {\n         match stmt.node {\n-            hir::StmtKind::Decl(ref decl) => {\n-                match decl.node {\n-                    hir::DeclKind::Local(ref local) => {\n-                        self.walk_local(&local);\n-                    }\n+            hir::StmtKind::Local(ref local) => {\n+                self.walk_local(&local);\n+            }\n \n-                    hir::DeclKind::Item(_) => {\n-                        // we don't visit nested items in this visitor,\n-                        // only the fn body we were given.\n-                    }\n-                }\n+            hir::StmtKind::Item(_) => {\n+                // we don't visit nested items in this visitor,\n+                // only the fn body we were given.\n             }\n \n             hir::StmtKind::Expr(ref expr) |"}, {"sha": "13464242f1cedef28c6c2bd6e4f63739dee67e2c", "filename": "src/librustc/middle/liveness.rs", "status": "modified", "additions": 18, "deletions": 33, "changes": 51, "blob_url": "https://github.com/rust-lang/rust/blob/afbd004d696063adf1301ae461c41565f2f1921a/src%2Flibrustc%2Fmiddle%2Fliveness.rs", "raw_url": "https://github.com/rust-lang/rust/raw/afbd004d696063adf1301ae461c41565f2f1921a/src%2Flibrustc%2Fmiddle%2Fliveness.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fliveness.rs?ref=afbd004d696063adf1301ae461c41565f2f1921a", "patch": "@@ -956,46 +956,31 @@ impl<'a, 'tcx> Liveness<'a, 'tcx> {\n     fn propagate_through_stmt(&mut self, stmt: &hir::Stmt, succ: LiveNode)\n                               -> LiveNode {\n         match stmt.node {\n-            hir::StmtKind::Decl(ref decl) => {\n-                self.propagate_through_decl(&decl, succ)\n-            }\n+            hir::StmtKind::Local(ref local) => {\n+                // Note: we mark the variable as defined regardless of whether\n+                // there is an initializer.  Initially I had thought to only mark\n+                // the live variable as defined if it was initialized, and then we\n+                // could check for uninit variables just by scanning what is live\n+                // at the start of the function. But that doesn't work so well for\n+                // immutable variables defined in a loop:\n+                //     loop { let x; x = 5; }\n+                // because the \"assignment\" loops back around and generates an error.\n+                //\n+                // So now we just check that variables defined w/o an\n+                // initializer are not live at the point of their\n+                // initialization, which is mildly more complex than checking\n+                // once at the func header but otherwise equivalent.\n \n+                let succ = self.propagate_through_opt_expr(local.init.as_ref().map(|e| &**e), succ);\n+                self.define_bindings_in_pat(&local.pat, succ)\n+            }\n+            hir::StmtKind::Item(..) => succ,\n             hir::StmtKind::Expr(ref expr) | hir::StmtKind::Semi(ref expr) => {\n                 self.propagate_through_expr(&expr, succ)\n             }\n         }\n     }\n \n-    fn propagate_through_decl(&mut self, decl: &hir::Decl, succ: LiveNode)\n-                              -> LiveNode {\n-        match decl.node {\n-            hir::DeclKind::Local(ref local) => {\n-                self.propagate_through_local(&local, succ)\n-            }\n-            hir::DeclKind::Item(_) => succ,\n-        }\n-    }\n-\n-    fn propagate_through_local(&mut self, local: &hir::Local, succ: LiveNode)\n-                               -> LiveNode {\n-        // Note: we mark the variable as defined regardless of whether\n-        // there is an initializer.  Initially I had thought to only mark\n-        // the live variable as defined if it was initialized, and then we\n-        // could check for uninit variables just by scanning what is live\n-        // at the start of the function. But that doesn't work so well for\n-        // immutable variables defined in a loop:\n-        //     loop { let x; x = 5; }\n-        // because the \"assignment\" loops back around and generates an error.\n-        //\n-        // So now we just check that variables defined w/o an\n-        // initializer are not live at the point of their\n-        // initialization, which is mildly more complex than checking\n-        // once at the func header but otherwise equivalent.\n-\n-        let succ = self.propagate_through_opt_expr(local.init.as_ref().map(|e| &**e), succ);\n-        self.define_bindings_in_pat(&local.pat, succ)\n-    }\n-\n     fn propagate_through_exprs(&mut self, exprs: &[Expr], succ: LiveNode)\n                                -> LiveNode {\n         exprs.iter().rev().fold(succ, |succ, expr| {"}, {"sha": "819dd8aa7d53e43f4c1671d561411b6ebb57a744", "filename": "src/librustc/middle/region.rs", "status": "modified", "additions": 19, "deletions": 14, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/afbd004d696063adf1301ae461c41565f2f1921a/src%2Flibrustc%2Fmiddle%2Fregion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/afbd004d696063adf1301ae461c41565f2f1921a/src%2Flibrustc%2Fmiddle%2Fregion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fregion.rs?ref=afbd004d696063adf1301ae461c41565f2f1921a", "patch": "@@ -784,20 +784,25 @@ fn resolve_block<'a, 'tcx>(visitor: &mut RegionResolutionVisitor<'a, 'tcx>, blk:\n         // index information.)\n \n         for (i, statement) in blk.stmts.iter().enumerate() {\n-            if let hir::StmtKind::Decl(..) = statement.node {\n-                // Each StmtKind::Decl introduces a subscope for bindings\n-                // introduced by the declaration; this subscope covers\n-                // a suffix of the block . Each subscope in a block\n-                // has the previous subscope in the block as a parent,\n-                // except for the first such subscope, which has the\n-                // block itself as a parent.\n-                visitor.enter_scope(\n-                    Scope {\n-                        id: blk.hir_id.local_id,\n-                        data: ScopeData::Remainder(FirstStatementIndex::new(i))\n-                    }\n-                );\n-                visitor.cx.var_parent = visitor.cx.parent;\n+            match statement.node {\n+                hir::StmtKind::Local(..) |\n+                hir::StmtKind::Item(..) => {\n+                    // Each declaration introduces a subscope for bindings\n+                    // introduced by the declaration; this subscope covers a\n+                    // suffix of the block. Each subscope in a block has the\n+                    // previous subscope in the block as a parent, except for\n+                    // the first such subscope, which has the block itself as a\n+                    // parent.\n+                    visitor.enter_scope(\n+                        Scope {\n+                            id: blk.hir_id.local_id,\n+                            data: ScopeData::Remainder(FirstStatementIndex::new(i))\n+                        }\n+                    );\n+                    visitor.cx.var_parent = visitor.cx.parent;\n+                }\n+                hir::StmtKind::Expr(..) |\n+                hir::StmtKind::Semi(..) => {}\n             }\n             visitor.visit_stmt(statement)\n         }"}, {"sha": "c50d9ddcb152e95a228817ef5fc7bfe54f4e7c96", "filename": "src/librustc_mir/hair/cx/block.rs", "status": "modified", "additions": 38, "deletions": 42, "changes": 80, "blob_url": "https://github.com/rust-lang/rust/blob/afbd004d696063adf1301ae461c41565f2f1921a/src%2Flibrustc_mir%2Fhair%2Fcx%2Fblock.rs", "raw_url": "https://github.com/rust-lang/rust/raw/afbd004d696063adf1301ae461c41565f2f1921a/src%2Flibrustc_mir%2Fhair%2Fcx%2Fblock.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fhair%2Fcx%2Fblock.rs?ref=afbd004d696063adf1301ae461c41565f2f1921a", "patch": "@@ -64,52 +64,48 @@ fn mirror_stmts<'a, 'gcx, 'tcx>(cx: &mut Cx<'a, 'gcx, 'tcx>,\n                     span: stmt_span,\n                 })))\n             }\n-            hir::StmtKind::Decl(ref decl) => {\n-                match decl.node {\n-                    hir::DeclKind::Item(..) => {\n-                        // ignore for purposes of the MIR\n-                    }\n-                    hir::DeclKind::Local(ref local) => {\n-                        let remainder_scope = region::Scope {\n-                            id: block_id,\n-                            data: region::ScopeData::Remainder(\n-                                region::FirstStatementIndex::new(index)),\n-                        };\n-\n-                        let mut pattern = cx.pattern_from_hir(&local.pat);\n+            hir::StmtKind::Item(..) => {\n+                // ignore for purposes of the MIR\n+            }\n+            hir::StmtKind::Local(ref local) => {\n+                let remainder_scope = region::Scope {\n+                    id: block_id,\n+                    data: region::ScopeData::Remainder(\n+                        region::FirstStatementIndex::new(index)),\n+                };\n \n-                        if let Some(ty) = &local.ty {\n-                            if let Some(&user_ty) = cx.tables.user_provided_types().get(ty.hir_id) {\n-                                debug!(\"mirror_stmts: user_ty={:?}\", user_ty);\n-                                pattern = Pattern {\n-                                    ty: pattern.ty,\n-                                    span: pattern.span,\n-                                    kind: Box::new(PatternKind::AscribeUserType {\n-                                        user_ty: PatternTypeProjection::from_user_type(user_ty),\n-                                        user_ty_span: ty.span,\n-                                        subpattern: pattern,\n-                                        variance: ty::Variance::Covariant,\n-                                    })\n-                                };\n-                            }\n-                        }\n+                let mut pattern = cx.pattern_from_hir(&local.pat);\n \n-                        result.push(StmtRef::Mirror(Box::new(Stmt {\n-                            kind: StmtKind::Let {\n-                                remainder_scope: remainder_scope,\n-                                init_scope: region::Scope {\n-                                    id: hir_id.local_id,\n-                                    data: region::ScopeData::Node\n-                                },\n-                                pattern,\n-                                initializer: local.init.to_ref(),\n-                                lint_level: cx.lint_level_of(local.id),\n-                            },\n-                            opt_destruction_scope: opt_dxn_ext,\n-                            span: stmt_span,\n-                        })));\n+                if let Some(ty) = &local.ty {\n+                    if let Some(&user_ty) = cx.tables.user_provided_types().get(ty.hir_id) {\n+                        debug!(\"mirror_stmts: user_ty={:?}\", user_ty);\n+                        pattern = Pattern {\n+                            ty: pattern.ty,\n+                            span: pattern.span,\n+                            kind: Box::new(PatternKind::AscribeUserType {\n+                                user_ty: PatternTypeProjection::from_user_type(user_ty),\n+                                user_ty_span: ty.span,\n+                                subpattern: pattern,\n+                                variance: ty::Variance::Covariant,\n+                            })\n+                        };\n                     }\n                 }\n+\n+                result.push(StmtRef::Mirror(Box::new(Stmt {\n+                    kind: StmtKind::Let {\n+                        remainder_scope: remainder_scope,\n+                        init_scope: region::Scope {\n+                            id: hir_id.local_id,\n+                            data: region::ScopeData::Node\n+                        },\n+                        pattern,\n+                        initializer: local.init.to_ref(),\n+                        lint_level: cx.lint_level_of(local.id),\n+                    },\n+                    opt_destruction_scope: opt_dxn_ext,\n+                    span: stmt_span,\n+                })));\n             }\n         }\n     }"}, {"sha": "74d6d75a7f528ad9ef403b8406af5676aa05cebf", "filename": "src/librustc_passes/hir_stats.rs", "status": "modified", "additions": 0, "deletions": 5, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/afbd004d696063adf1301ae461c41565f2f1921a/src%2Flibrustc_passes%2Fhir_stats.rs", "raw_url": "https://github.com/rust-lang/rust/raw/afbd004d696063adf1301ae461c41565f2f1921a/src%2Flibrustc_passes%2Fhir_stats.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_passes%2Fhir_stats.rs?ref=afbd004d696063adf1301ae461c41565f2f1921a", "patch": "@@ -158,11 +158,6 @@ impl<'v> hir_visit::Visitor<'v> for StatCollector<'v> {\n         hir_visit::walk_pat(self, p)\n     }\n \n-    fn visit_decl(&mut self, d: &'v hir::Decl) {\n-        self.record(\"Decl\", Id::None, d);\n-        hir_visit::walk_decl(self, d)\n-    }\n-\n     fn visit_expr(&mut self, ex: &'v hir::Expr) {\n         self.record(\"Expr\", Id::Node(ex.id), ex);\n         hir_visit::walk_expr(self, ex)"}, {"sha": "49914dc7078fdbc2159cbbb84b5e05088a289391", "filename": "src/librustc_passes/rvalue_promotion.rs", "status": "modified", "additions": 11, "deletions": 15, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/afbd004d696063adf1301ae461c41565f2f1921a/src%2Flibrustc_passes%2Frvalue_promotion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/afbd004d696063adf1301ae461c41565f2f1921a/src%2Flibrustc_passes%2Frvalue_promotion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_passes%2Frvalue_promotion.rs?ref=afbd004d696063adf1301ae461c41565f2f1921a", "patch": "@@ -220,24 +220,20 @@ impl<'a, 'tcx> CheckCrateVisitor<'a, 'tcx> {\n \n     fn check_stmt(&mut self, stmt: &'tcx hir::Stmt) -> Promotability {\n         match stmt.node {\n-            hir::StmtKind::Decl(ref decl) => {\n-                match &decl.node {\n-                    hir::DeclKind::Local(local) => {\n-                        if self.remove_mut_rvalue_borrow(&local.pat) {\n-                            if let Some(init) = &local.init {\n-                                self.mut_rvalue_borrows.insert(init.id);\n-                            }\n-                        }\n-\n-                        if let Some(ref expr) = local.init {\n-                            let _ = self.check_expr(&expr);\n-                        }\n-                        NotPromotable\n+            hir::StmtKind::Local(ref local) => {\n+                if self.remove_mut_rvalue_borrow(&local.pat) {\n+                    if let Some(init) = &local.init {\n+                        self.mut_rvalue_borrows.insert(init.id);\n                     }\n-                    // Item statements are allowed\n-                    hir::DeclKind::Item(_) => Promotable\n                 }\n+\n+                if let Some(ref expr) = local.init {\n+                    let _ = self.check_expr(&expr);\n+                }\n+                NotPromotable\n             }\n+            // Item statements are allowed\n+            hir::StmtKind::Item(..) => Promotable,\n             hir::StmtKind::Expr(ref box_expr) |\n             hir::StmtKind::Semi(ref box_expr) => {\n                 let _ = self.check_expr(box_expr);"}, {"sha": "daade27768ae3b712cab40e595f4e9f65c24f106", "filename": "src/librustc_typeck/check/mod.rs", "status": "modified", "additions": 6, "deletions": 14, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/afbd004d696063adf1301ae461c41565f2f1921a/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/afbd004d696063adf1301ae461c41565f2f1921a/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs?ref=afbd004d696063adf1301ae461c41565f2f1921a", "patch": "@@ -4840,12 +4840,8 @@ impl<'a, 'gcx, 'tcx> FnCtxt<'a, 'gcx, 'tcx> {\n     pub fn check_stmt(&self, stmt: &'gcx hir::Stmt) {\n         // Don't do all the complex logic below for `DeclItem`.\n         match stmt.node {\n-            hir::StmtKind::Decl(ref decl) => {\n-                if let hir::DeclKind::Item(_) = decl.node {\n-                    return\n-                }\n-            }\n-            hir::StmtKind::Expr(..) | hir::StmtKind::Semi(..) => {}\n+            hir::StmtKind::Item(..) => return,\n+            hir::StmtKind::Local(..) | hir::StmtKind::Expr(..) | hir::StmtKind::Semi(..) => {}\n         }\n \n         self.warn_if_unreachable(stmt.id, stmt.span, \"statement\");\n@@ -4857,15 +4853,11 @@ impl<'a, 'gcx, 'tcx> FnCtxt<'a, 'gcx, 'tcx> {\n         self.has_errors.set(false);\n \n         match stmt.node {\n-            hir::StmtKind::Decl(ref decl) => {\n-                match decl.node {\n-                    hir::DeclKind::Local(ref l) => {\n-                        self.check_decl_local(&l);\n-                    }\n-                    // Ignore for now.\n-                    hir::DeclKind::Item(_) => ()\n-                }\n+            hir::StmtKind::Local(ref l) => {\n+                self.check_decl_local(&l);\n             }\n+            // Ignore for now.\n+            hir::StmtKind::Item(_) => {}\n             hir::StmtKind::Expr(ref expr) => {\n                 // Check with expected type of `()`.\n                 self.check_expr_has_type_or_error(&expr, self.tcx.mk_unit());"}]}