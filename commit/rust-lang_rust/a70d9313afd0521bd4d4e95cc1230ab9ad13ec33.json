{"sha": "a70d9313afd0521bd4d4e95cc1230ab9ad13ec33", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE3MGQ5MzEzYWZkMDUyMWJkNGQ0ZTk1Y2MxMjMwYWI5YWQxM2VjMzM=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-07-11T12:44:31Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-07-11T12:44:31Z"}, "message": "Merge #9570\n\n9570: minor: Simplify Semantics::type_of_expr_with_coercion r=Veykril a=Veykril\n\nbors r+\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>", "tree": {"sha": "6ef959af065d58661cddbfeea4a281f779ff7648", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6ef959af065d58661cddbfeea4a281f779ff7648"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a70d9313afd0521bd4d4e95cc1230ab9ad13ec33", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJg6uevCRBK7hj4Ov3rIwAA8wcIACrakh20PNB5wW2jzR7PDoYT\nZGl7QW7hPiXFpt09GndIHQ97lCKHqKH7OQmuCI0DYeAZeDPM2lTj/k2rF0SLxzkI\n03MaNHwJxBLuMAD8mGko1QlXIxPUpH9ylpAfMxF2IZXOlsziX1WmdzybYGxzC0t6\nB0aWde7kNZ3I+Ouokjlam8Oi6zHsb0VZgwAdN/HkFWqhAahc7MXWwZZ4ydvUKZWf\ncrozIpFr90sas2gzGv2HIK6ceAK8dGwRsHSzr/9GscDxEZZP+Zjs1WwUH8LyNp19\nb6pkXuMTQQDQgsk4d2c58uT5XX1bPW8PsFkQqCN0sc7AdOYBm8JbRyT4p3LPUv4=\n=hUqb\n-----END PGP SIGNATURE-----\n", "payload": "tree 6ef959af065d58661cddbfeea4a281f779ff7648\nparent 0fbeacc1d34162c92b15c9e1b798cc75038012d6\nparent c6b6f18520a54803e818d6df519d4d6401075599\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1626007471 +0000\ncommitter GitHub <noreply@github.com> 1626007471 +0000\n\nMerge #9570\n\n9570: minor: Simplify Semantics::type_of_expr_with_coercion r=Veykril a=Veykril\n\nbors r+\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a70d9313afd0521bd4d4e95cc1230ab9ad13ec33", "html_url": "https://github.com/rust-lang/rust/commit/a70d9313afd0521bd4d4e95cc1230ab9ad13ec33", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a70d9313afd0521bd4d4e95cc1230ab9ad13ec33/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0fbeacc1d34162c92b15c9e1b798cc75038012d6", "url": "https://api.github.com/repos/rust-lang/rust/commits/0fbeacc1d34162c92b15c9e1b798cc75038012d6", "html_url": "https://github.com/rust-lang/rust/commit/0fbeacc1d34162c92b15c9e1b798cc75038012d6"}, {"sha": "c6b6f18520a54803e818d6df519d4d6401075599", "url": "https://api.github.com/repos/rust-lang/rust/commits/c6b6f18520a54803e818d6df519d4d6401075599", "html_url": "https://github.com/rust-lang/rust/commit/c6b6f18520a54803e818d6df519d4d6401075599"}], "stats": {"total": 36, "additions": 18, "deletions": 18}, "files": [{"sha": "cc320227f8038d3676419912888febb6d2cf241c", "filename": "crates/hir/src/semantics.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/a70d9313afd0521bd4d4e95cc1230ab9ad13ec33/crates%2Fhir%2Fsrc%2Fsemantics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a70d9313afd0521bd4d4e95cc1230ab9ad13ec33/crates%2Fhir%2Fsrc%2Fsemantics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Fsemantics.rs?ref=a70d9313afd0521bd4d4e95cc1230ab9ad13ec33", "patch": "@@ -216,15 +216,16 @@ impl<'db, DB: HirDatabase> Semantics<'db, DB> {\n         self.imp.type_of_expr(expr)\n     }\n \n-    pub fn type_of_expr_with_coercion(&self, expr: &ast::Expr) -> Option<(Type, Option<Type>)> {\n+    /// Returns true in case a coercion happened.\n+    pub fn type_of_expr_with_coercion(&self, expr: &ast::Expr) -> Option<(Type, bool)> {\n         self.imp.type_of_expr_with_coercion(expr)\n     }\n \n     pub fn type_of_pat(&self, pat: &ast::Pat) -> Option<Type> {\n         self.imp.type_of_pat(pat)\n     }\n \n-    pub fn type_of_pat_with_coercion(&self, expr: &ast::Pat) -> Option<(Type, Option<Type>)> {\n+    pub fn type_of_pat_with_coercion(&self, expr: &ast::Pat) -> Option<Type> {\n         self.imp.type_of_pat_with_coercion(expr)\n     }\n \n@@ -568,15 +569,15 @@ impl<'db> SemanticsImpl<'db> {\n         self.analyze(expr.syntax()).type_of_expr(self.db, expr)\n     }\n \n-    fn type_of_expr_with_coercion(&self, expr: &ast::Expr) -> Option<(Type, Option<Type>)> {\n+    fn type_of_expr_with_coercion(&self, expr: &ast::Expr) -> Option<(Type, bool)> {\n         self.analyze(expr.syntax()).type_of_expr_with_coercion(self.db, expr)\n     }\n \n     fn type_of_pat(&self, pat: &ast::Pat) -> Option<Type> {\n         self.analyze(pat.syntax()).type_of_pat(self.db, pat)\n     }\n \n-    fn type_of_pat_with_coercion(&self, pat: &ast::Pat) -> Option<(Type, Option<Type>)> {\n+    fn type_of_pat_with_coercion(&self, pat: &ast::Pat) -> Option<Type> {\n         self.analyze(pat.syntax()).type_of_pat_with_coercion(self.db, pat)\n     }\n "}, {"sha": "b1792f2ab0d1d8d0d585d3c6b29a0a02e8a80323", "filename": "crates/hir/src/source_analyzer.rs", "status": "modified", "additions": 11, "deletions": 11, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/a70d9313afd0521bd4d4e95cc1230ab9ad13ec33/crates%2Fhir%2Fsrc%2Fsource_analyzer.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a70d9313afd0521bd4d4e95cc1230ab9ad13ec33/crates%2Fhir%2Fsrc%2Fsource_analyzer.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Fsource_analyzer.rs?ref=a70d9313afd0521bd4d4e95cc1230ab9ad13ec33", "patch": "@@ -21,7 +21,7 @@ use hir_def::{\n use hir_expand::{hygiene::Hygiene, name::AsName, HirFileId, InFile};\n use hir_ty::{\n     diagnostics::{record_literal_missing_fields, record_pattern_missing_fields},\n-    InferenceResult, Interner, Substitution, Ty, TyExt, TyLoweringContext,\n+    InferenceResult, Interner, Substitution, TyExt, TyLoweringContext,\n };\n use syntax::{\n     ast::{self, AstNode},\n@@ -126,15 +126,15 @@ impl SourceAnalyzer {\n         &self,\n         db: &dyn HirDatabase,\n         expr: &ast::Expr,\n-    ) -> Option<(Type, Option<Type>)> {\n+    ) -> Option<(Type, bool)> {\n         let expr_id = self.expr_id(db, expr)?;\n         let infer = self.infer.as_ref()?;\n-        let coerced = infer\n+        let (ty, coerced) = infer\n             .expr_adjustments\n             .get(&expr_id)\n-            .and_then(|adjusts| adjusts.last().map(|adjust| &adjust.target));\n-        let mk_ty = |ty: &Ty| Type::new_with_resolver(db, &self.resolver, ty.clone());\n-        mk_ty(&infer[expr_id]).map(|ty| (ty, coerced.and_then(mk_ty)))\n+            .and_then(|adjusts| adjusts.last().map(|adjust| (&adjust.target, true)))\n+            .unwrap_or_else(|| (&infer[expr_id], false));\n+        Type::new_with_resolver(db, &self.resolver, ty.clone()).zip(Some(coerced))\n     }\n \n     pub(crate) fn type_of_pat(&self, db: &dyn HirDatabase, pat: &ast::Pat) -> Option<Type> {\n@@ -147,15 +147,15 @@ impl SourceAnalyzer {\n         &self,\n         db: &dyn HirDatabase,\n         pat: &ast::Pat,\n-    ) -> Option<(Type, Option<Type>)> {\n+    ) -> Option<Type> {\n         let pat_id = self.pat_id(pat)?;\n         let infer = self.infer.as_ref()?;\n-        let coerced = infer\n+        let ty = infer\n             .pat_adjustments\n             .get(&pat_id)\n-            .and_then(|adjusts| adjusts.last().map(|adjust| &adjust.target));\n-        let mk_ty = |ty: &Ty| Type::new_with_resolver(db, &self.resolver, ty.clone());\n-        mk_ty(&infer[pat_id]).map(|ty| (ty, coerced.and_then(mk_ty)))\n+            .and_then(|adjusts| adjusts.last().map(|adjust| &adjust.target))\n+            .unwrap_or_else(|| &infer[pat_id]);\n+        Type::new_with_resolver(db, &self.resolver, ty.clone())\n     }\n \n     pub(crate) fn type_of_self("}, {"sha": "b1fec65ac06e8e8b349f09e57eb24494bc2f6923", "filename": "crates/ide_assists/src/handlers/add_explicit_type.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/a70d9313afd0521bd4d4e95cc1230ab9ad13ec33/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fadd_explicit_type.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a70d9313afd0521bd4d4e95cc1230ab9ad13ec33/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fadd_explicit_type.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fadd_explicit_type.rs?ref=a70d9313afd0521bd4d4e95cc1230ab9ad13ec33", "patch": "@@ -55,8 +55,7 @@ pub(crate) fn add_explicit_type(acc: &mut Assists, ctx: &AssistContext) -> Optio\n     }\n \n     // Infer type\n-    let (ty, coerced) = ctx.sema.type_of_expr_with_coercion(&expr)?;\n-    let ty = coerced.unwrap_or(ty);\n+    let (ty, _) = ctx.sema.type_of_expr_with_coercion(&expr)?;\n     if ty.contains_unknown() || ty.is_closure() {\n         cov_mark::hit!(add_explicit_type_not_applicable_if_ty_not_inferred);\n         return None;"}, {"sha": "0ecf930cb929bc912d146aa1d9be7e19f8bea7e2", "filename": "crates/ide_assists/src/handlers/inline_call.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a70d9313afd0521bd4d4e95cc1230ab9ad13ec33/crates%2Fide_assists%2Fsrc%2Fhandlers%2Finline_call.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a70d9313afd0521bd4d4e95cc1230ab9ad13ec33/crates%2Fide_assists%2Fsrc%2Fhandlers%2Finline_call.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_assists%2Fsrc%2Fhandlers%2Finline_call.rs?ref=a70d9313afd0521bd4d4e95cc1230ab9ad13ec33", "patch": "@@ -190,7 +190,7 @@ pub(crate) fn inline_(\n                         let ty = ctx\n                             .sema\n                             .type_of_expr_with_coercion(&expr)\n-                            .map_or(false, |(_, coerced)| coerced.is_some())\n+                            .map_or(false, |(_, coerced)| coerced)\n                             .then(|| param_ty)\n                             .flatten();\n                         body.push_front("}]}