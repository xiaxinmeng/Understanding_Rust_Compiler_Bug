{"sha": "a27186636d030c847193ab21c59a1857a1e93785", "node_id": "MDY6Q29tbWl0NzI0NzEyOmEyNzE4NjYzNmQwMzBjODQ3MTkzYWIyMWM1OWExODU3YTFlOTM3ODU=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2020-11-12T11:09:12Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2020-11-12T11:09:12Z"}, "message": "Fix attachment of inner doc comments", "tree": {"sha": "a2df8b9f6d26611283120faccb387723b1a0c944", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a2df8b9f6d26611283120faccb387723b1a0c944"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a27186636d030c847193ab21c59a1857a1e93785", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a27186636d030c847193ab21c59a1857a1e93785", "html_url": "https://github.com/rust-lang/rust/commit/a27186636d030c847193ab21c59a1857a1e93785", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a27186636d030c847193ab21c59a1857a1e93785/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "81ac99f60a3b847aa2b566af54e8ffa0b3b1a147", "url": "https://api.github.com/repos/rust-lang/rust/commits/81ac99f60a3b847aa2b566af54e8ffa0b3b1a147", "html_url": "https://github.com/rust-lang/rust/commit/81ac99f60a3b847aa2b566af54e8ffa0b3b1a147"}], "stats": {"total": 52, "additions": 33, "deletions": 19}, "files": [{"sha": "7844f9ed63540a543a7740ce4253e0739128685e", "filename": "crates/syntax/src/ast.rs", "status": "modified", "additions": 17, "deletions": 2, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/a27186636d030c847193ab21c59a1857a1e93785/crates%2Fsyntax%2Fsrc%2Fast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a27186636d030c847193ab21c59a1857a1e93785/crates%2Fsyntax%2Fsrc%2Fast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fsyntax%2Fsrc%2Fast.rs?ref=a27186636d030c847193ab21c59a1857a1e93785", "patch": "@@ -115,10 +115,10 @@ fn test_doc_comment_none() {\n }\n \n #[test]\n-fn test_doc_comment_of_items() {\n+fn test_outer_doc_comment_of_items() {\n     let file = SourceFile::parse(\n         r#\"\n-        //! doc\n+        /// doc\n         // non-doc\n         mod foo {}\n         \"#,\n@@ -129,6 +129,21 @@ fn test_doc_comment_of_items() {\n     assert_eq!(\"doc\", module.doc_comment_text().unwrap());\n }\n \n+#[test]\n+fn test_inner_doc_comment_of_items() {\n+    let file = SourceFile::parse(\n+        r#\"\n+        //! doc\n+        // non-doc\n+        mod foo {}\n+        \"#,\n+    )\n+    .ok()\n+    .unwrap();\n+    let module = file.syntax().descendants().find_map(Module::cast).unwrap();\n+    assert!(module.doc_comment_text().is_none());\n+}\n+\n #[test]\n fn test_doc_comment_of_statics() {\n     let file = SourceFile::parse("}, {"sha": "997bc5d288bcabd07e81ebd0e325245f2a9607ef", "filename": "crates/syntax/src/parsing/text_tree_sink.rs", "status": "modified", "additions": 13, "deletions": 14, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/a27186636d030c847193ab21c59a1857a1e93785/crates%2Fsyntax%2Fsrc%2Fparsing%2Ftext_tree_sink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a27186636d030c847193ab21c59a1857a1e93785/crates%2Fsyntax%2Fsrc%2Fparsing%2Ftext_tree_sink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fsyntax%2Fsrc%2Fparsing%2Ftext_tree_sink.rs?ref=a27186636d030c847193ab21c59a1857a1e93785", "patch": "@@ -5,6 +5,7 @@ use std::mem;\n use parser::{ParseError, TreeSink};\n \n use crate::{\n+    ast,\n     parsing::Token,\n     syntax_node::GreenNode,\n     SmolStr, SyntaxError,\n@@ -153,24 +154,22 @@ fn n_attached_trivias<'a>(\n \n             while let Some((i, (kind, text))) = trivias.next() {\n                 match kind {\n-                    WHITESPACE => {\n-                        if text.contains(\"\\n\\n\") {\n-                            // we check whether the next token is a doc-comment\n-                            // and skip the whitespace in this case\n-                            if let Some((peek_kind, peek_text)) =\n-                                trivias.peek().map(|(_, pair)| pair)\n-                            {\n-                                if *peek_kind == COMMENT\n-                                    && peek_text.starts_with(\"///\")\n-                                    && !peek_text.starts_with(\"////\")\n-                                {\n-                                    continue;\n-                                }\n+                    WHITESPACE if text.contains(\"\\n\\n\") => {\n+                        // we check whether the next token is a doc-comment\n+                        // and skip the whitespace in this case\n+                        if let Some((COMMENT, peek_text)) = trivias.peek().map(|(_, pair)| pair) {\n+                            let comment_kind = ast::CommentKind::from_text(peek_text);\n+                            if comment_kind.doc == Some(ast::CommentPlacement::Outer) {\n+                                continue;\n                             }\n-                            break;\n                         }\n+                        break;\n                     }\n                     COMMENT => {\n+                        let comment_kind = ast::CommentKind::from_text(text);\n+                        if comment_kind.doc == Some(ast::CommentPlacement::Inner) {\n+                            break;\n+                        }\n                         res = i + 1;\n                     }\n                     _ => (),"}, {"sha": "35577272e5621ceeb0a8200a0f4cc46df4ed3147", "filename": "crates/syntax/test_data/parser/ok/0037_mod.rast", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/a27186636d030c847193ab21c59a1857a1e93785/crates%2Fsyntax%2Ftest_data%2Fparser%2Fok%2F0037_mod.rast", "raw_url": "https://github.com/rust-lang/rust/raw/a27186636d030c847193ab21c59a1857a1e93785/crates%2Fsyntax%2Ftest_data%2Fparser%2Fok%2F0037_mod.rast", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fsyntax%2Ftest_data%2Fparser%2Fok%2F0037_mod.rast?ref=a27186636d030c847193ab21c59a1857a1e93785", "patch": "@@ -1,9 +1,9 @@\n SOURCE_FILE@0..93\n   COMMENT@0..60 \"// https://github.com ...\"\n   WHITESPACE@60..62 \"\\n\\n\"\n-  MODULE@62..93\n-    COMMENT@62..70 \"//! docs\"\n-    WHITESPACE@70..71 \"\\n\"\n+  COMMENT@62..70 \"//! docs\"\n+  WHITESPACE@70..71 \"\\n\"\n+  MODULE@71..93\n     COMMENT@71..82 \"// non-docs\"\n     WHITESPACE@82..83 \"\\n\"\n     MOD_KW@83..86 \"mod\""}]}