{"sha": "1140ceebccdf9ab00bce927dd71dbe5957486ef2", "node_id": "MDY6Q29tbWl0NzI0NzEyOjExNDBjZWViY2NkZjlhYjAwYmNlOTI3ZGQ3MWRiZTU5NTc0ODZlZjI=", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2020-01-04T12:17:29Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-01-04T12:17:29Z"}, "message": "Rollup merge of #67823 - euclio:drop-improvements, r=petrochenkov\n\nimprove some `Drop`-related error messages", "tree": {"sha": "b66e79853f903fa8d5845f556c7e9d46e1361be2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b66e79853f903fa8d5845f556c7e9d46e1361be2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1140ceebccdf9ab00bce927dd71dbe5957486ef2", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJeEIJZCRBK7hj4Ov3rIwAAdHIIABmZnxmwfC94ycQssbP9y3YS\nWik6BA2zkaG0fa8AN+4h/aLGSlwCYQxsFoWVaVlVoxMs9KuTHVhLSfziz1ZxPKVo\n9wBpgUuTyQ8yIfnhI/R/20LlsiZuDSYXSSUGqWnJ14boPeIDu+kHwZRlahAUBRMF\nXoBDFRj6T81xCsdUDhscyND4yliAXCyUE6RaCNtBwUB5aaMZWdeXjo1YlKV6bmD4\nhiSBancUJIeH8zNBk8G+ajjb93REzOtvkFJ1Op2kIwVSGxwWwbU3CJ8e/6UTntvd\nGR3DnEs/HrpNNfmOCd0z2QLriH6YiYDefwB3f2kq90AIblZXdCfolRhkLgwFO94=\n=u+bG\n-----END PGP SIGNATURE-----\n", "payload": "tree b66e79853f903fa8d5845f556c7e9d46e1361be2\nparent a469b1785d7ff414abe718cf013440ca0ead7e42\nparent e9990bc65f8e44fd2843478ac685bb79c0a50ed0\nauthor Guillaume Gomez <guillaume1.gomez@gmail.com> 1578140249 +0100\ncommitter GitHub <noreply@github.com> 1578140249 +0100\n\nRollup merge of #67823 - euclio:drop-improvements, r=petrochenkov\n\nimprove some `Drop`-related error messages\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1140ceebccdf9ab00bce927dd71dbe5957486ef2", "html_url": "https://github.com/rust-lang/rust/commit/1140ceebccdf9ab00bce927dd71dbe5957486ef2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1140ceebccdf9ab00bce927dd71dbe5957486ef2/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a469b1785d7ff414abe718cf013440ca0ead7e42", "url": "https://api.github.com/repos/rust-lang/rust/commits/a469b1785d7ff414abe718cf013440ca0ead7e42", "html_url": "https://github.com/rust-lang/rust/commit/a469b1785d7ff414abe718cf013440ca0ead7e42"}, {"sha": "e9990bc65f8e44fd2843478ac685bb79c0a50ed0", "url": "https://api.github.com/repos/rust-lang/rust/commits/e9990bc65f8e44fd2843478ac685bb79c0a50ed0", "html_url": "https://github.com/rust-lang/rust/commit/e9990bc65f8e44fd2843478ac685bb79c0a50ed0"}], "stats": {"total": 262, "additions": 151, "deletions": 111}, "files": [{"sha": "004fce7e35b7098a67e787eb1f1ddb7dc46af9da", "filename": "src/librustc_typeck/check/dropck.rs", "status": "modified", "additions": 18, "deletions": 16, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/1140ceebccdf9ab00bce927dd71dbe5957486ef2/src%2Flibrustc_typeck%2Fcheck%2Fdropck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1140ceebccdf9ab00bce927dd71dbe5957486ef2/src%2Flibrustc_typeck%2Fcheck%2Fdropck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fdropck.rs?ref=1140ceebccdf9ab00bce927dd71dbe5957486ef2", "patch": "@@ -47,7 +47,6 @@ pub fn check_drop_impl(tcx: TyCtxt<'_>, drop_impl_did: DefId) -> Result<(), Erro\n \n             ensure_drop_predicates_are_implied_by_item_defn(\n                 tcx,\n-                drop_impl_did,\n                 dtor_predicates,\n                 adt_def.did,\n                 self_to_impl_substs,\n@@ -95,16 +94,23 @@ fn ensure_drop_params_and_item_params_correspond<'tcx>(\n             }\n             Err(_) => {\n                 let item_span = tcx.def_span(self_type_did);\n+                let self_descr = tcx\n+                    .def_kind(self_type_did)\n+                    .map(|kind| kind.descr(self_type_did))\n+                    .unwrap_or(\"type\");\n                 struct_span_err!(\n                     tcx.sess,\n                     drop_impl_span,\n                     E0366,\n-                    \"Implementations of Drop cannot be specialized\"\n+                    \"`Drop` impls cannot be specialized\"\n                 )\n                 .span_note(\n                     item_span,\n-                    \"Use same sequence of generic type and region \\\n-                     parameters that is on the struct/enum definition\",\n+                    &format!(\n+                        \"use the same sequence of generic type, lifetime and const parameters \\\n+                        as the {} definition\",\n+                        self_descr,\n+                    ),\n                 )\n                 .emit();\n                 return Err(ErrorReported);\n@@ -143,7 +149,6 @@ fn ensure_drop_params_and_item_params_correspond<'tcx>(\n /// implied by assuming the predicates attached to self_type_did.\n fn ensure_drop_predicates_are_implied_by_item_defn<'tcx>(\n     tcx: TyCtxt<'tcx>,\n-    drop_impl_did: DefId,\n     dtor_predicates: ty::GenericPredicates<'tcx>,\n     self_type_did: DefId,\n     self_to_impl_substs: SubstsRef<'tcx>,\n@@ -187,8 +192,6 @@ fn ensure_drop_predicates_are_implied_by_item_defn<'tcx>(\n \n     let self_type_hir_id = tcx.hir().as_local_hir_id(self_type_did).unwrap();\n \n-    let drop_impl_span = tcx.def_span(drop_impl_did);\n-\n     // We can assume the predicates attached to struct/enum definition\n     // hold.\n     let generic_assumptions = tcx.predicates_of(self_type_did);\n@@ -205,7 +208,7 @@ fn ensure_drop_predicates_are_implied_by_item_defn<'tcx>(\n     // just to look for all the predicates directly.\n \n     assert_eq!(dtor_predicates.parent, None);\n-    for (predicate, _) in dtor_predicates.predicates {\n+    for (predicate, predicate_sp) in dtor_predicates.predicates {\n         // (We do not need to worry about deep analysis of type\n         // expressions etc because the Drop impls are already forced\n         // to take on a structure that is roughly an alpha-renaming of\n@@ -241,18 +244,17 @@ fn ensure_drop_predicates_are_implied_by_item_defn<'tcx>(\n \n         if !assumptions_in_impl_context.iter().any(predicate_matches_closure) {\n             let item_span = tcx.hir().span(self_type_hir_id);\n+            let self_descr =\n+                tcx.def_kind(self_type_did).map(|kind| kind.descr(self_type_did)).unwrap_or(\"type\");\n             struct_span_err!(\n                 tcx.sess,\n-                drop_impl_span,\n+                *predicate_sp,\n                 E0367,\n-                \"The requirement `{}` is added only by the Drop impl.\",\n-                predicate\n-            )\n-            .span_note(\n-                item_span,\n-                \"The same requirement must be part of \\\n-                 the struct/enum definition\",\n+                \"`Drop` impl requires `{}` but the {} it is implemented for does not\",\n+                predicate,\n+                self_descr,\n             )\n+            .span_note(item_span, \"the implementor must specify the same requirement\")\n             .emit();\n             result = Err(ErrorReported);\n         }"}, {"sha": "7e016cf7e9a95940a893d777016a3d5b65da5d51", "filename": "src/librustc_typeck/coherence/builtin.rs", "status": "modified", "additions": 18, "deletions": 29, "changes": 47, "blob_url": "https://github.com/rust-lang/rust/blob/1140ceebccdf9ab00bce927dd71dbe5957486ef2/src%2Flibrustc_typeck%2Fcoherence%2Fbuiltin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1140ceebccdf9ab00bce927dd71dbe5957486ef2/src%2Flibrustc_typeck%2Fcoherence%2Fbuiltin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcoherence%2Fbuiltin.rs?ref=1140ceebccdf9ab00bce927dd71dbe5957486ef2", "patch": "@@ -13,7 +13,6 @@ use rustc::ty::util::CopyImplementationError;\n use rustc::ty::TypeFoldable;\n use rustc::ty::{self, Ty, TyCtxt};\n \n-use hir::Node;\n use rustc::hir::def_id::DefId;\n use rustc::hir::{self, ItemKind};\n \n@@ -51,35 +50,25 @@ impl<'tcx> Checker<'tcx> {\n }\n \n fn visit_implementation_of_drop(tcx: TyCtxt<'_>, impl_did: DefId) {\n-    if let ty::Adt(..) = tcx.type_of(impl_did).kind {\n-        /* do nothing */\n-    } else {\n-        // Destructors only work on nominal types.\n-        if let Some(impl_hir_id) = tcx.hir().as_local_hir_id(impl_did) {\n-            if let Some(Node::Item(item)) = tcx.hir().find(impl_hir_id) {\n-                let span = match item.kind {\n-                    ItemKind::Impl(.., ref ty, _) => ty.span,\n-                    _ => item.span,\n-                };\n-                struct_span_err!(\n-                    tcx.sess,\n-                    span,\n-                    E0120,\n-                    \"the Drop trait may only be implemented on \\\n-                                  structures\"\n-                )\n-                .span_label(span, \"implementing Drop requires a struct\")\n-                .emit();\n-            } else {\n-                bug!(\"didn't find impl in ast map\");\n-            }\n-        } else {\n-            bug!(\n-                \"found external impl of Drop trait on \\\n-                  something other than a struct\"\n-            );\n-        }\n+    // Destructors only work on nominal types.\n+    if let ty::Adt(..) | ty::Error = tcx.type_of(impl_did).kind {\n+        return;\n     }\n+\n+    let impl_hir_id = tcx.hir().as_local_hir_id(impl_did).expect(\"foreign Drop impl on non-ADT\");\n+    let sp = match tcx.hir().expect_item(impl_hir_id).kind {\n+        ItemKind::Impl(.., ty, _) => ty.span,\n+        _ => bug!(\"expected Drop impl item\"),\n+    };\n+\n+    struct_span_err!(\n+        tcx.sess,\n+        sp,\n+        E0120,\n+        \"the `Drop` trait may only be implemented for structs, enums, and unions\",\n+    )\n+    .span_label(sp, \"must be a struct, enum, or union\")\n+    .emit();\n }\n \n fn visit_implementation_of_copy(tcx: TyCtxt<'_>, impl_did: DefId) {"}, {"sha": "ef5e18126dc6860bf7e18a1ce3544d1bc190bd6f", "filename": "src/test/ui/dropck/drop-on-non-struct.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/1140ceebccdf9ab00bce927dd71dbe5957486ef2/src%2Ftest%2Fui%2Fdropck%2Fdrop-on-non-struct.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1140ceebccdf9ab00bce927dd71dbe5957486ef2/src%2Ftest%2Fui%2Fdropck%2Fdrop-on-non-struct.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fdropck%2Fdrop-on-non-struct.rs?ref=1140ceebccdf9ab00bce927dd71dbe5957486ef2", "patch": "@@ -1,10 +1,15 @@\n impl<'a> Drop for &'a mut isize {\n-    //~^ ERROR the Drop trait may only be implemented on structures\n+    //~^ ERROR the `Drop` trait may only be implemented for structs, enums, and unions\n     //~^^ ERROR E0117\n     fn drop(&mut self) {\n         println!(\"kaboom\");\n     }\n }\n \n+impl Drop for Nonexistent {\n+    //~^ ERROR cannot find type `Nonexistent`\n+    fn drop(&mut self) { }\n+}\n+\n fn main() {\n }"}, {"sha": "3991c44f2edce620e2d0bcef0002363389506837", "filename": "src/test/ui/dropck/drop-on-non-struct.stderr", "status": "modified", "additions": 10, "deletions": 4, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/1140ceebccdf9ab00bce927dd71dbe5957486ef2/src%2Ftest%2Fui%2Fdropck%2Fdrop-on-non-struct.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/1140ceebccdf9ab00bce927dd71dbe5957486ef2/src%2Ftest%2Fui%2Fdropck%2Fdrop-on-non-struct.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fdropck%2Fdrop-on-non-struct.stderr?ref=1140ceebccdf9ab00bce927dd71dbe5957486ef2", "patch": "@@ -1,8 +1,14 @@\n-error[E0120]: the Drop trait may only be implemented on structures\n+error[E0412]: cannot find type `Nonexistent` in this scope\n+  --> $DIR/drop-on-non-struct.rs:9:15\n+   |\n+LL | impl Drop for Nonexistent {\n+   |               ^^^^^^^^^^^ not found in this scope\n+\n+error[E0120]: the `Drop` trait may only be implemented for structs, enums, and unions\n   --> $DIR/drop-on-non-struct.rs:1:19\n    |\n LL | impl<'a> Drop for &'a mut isize {\n-   |                   ^^^^^^^^^^^^^ implementing Drop requires a struct\n+   |                   ^^^^^^^^^^^^^ must be a struct, enum, or union\n \n error[E0117]: only traits defined in the current crate can be implemented for arbitrary types\n   --> $DIR/drop-on-non-struct.rs:1:1\n@@ -15,7 +21,7 @@ LL | impl<'a> Drop for &'a mut isize {\n    |\n    = note: define and implement a trait or new type instead\n \n-error: aborting due to 2 previous errors\n+error: aborting due to 3 previous errors\n \n-Some errors have detailed explanations: E0117, E0120.\n+Some errors have detailed explanations: E0117, E0120, E0412.\n For more information about an error, try `rustc --explain E0117`."}, {"sha": "dbbac514801f7ba53dead6208c26757679c1c758", "filename": "src/test/ui/error-codes/E0117.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/1140ceebccdf9ab00bce927dd71dbe5957486ef2/src%2Ftest%2Fui%2Ferror-codes%2FE0117.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1140ceebccdf9ab00bce927dd71dbe5957486ef2/src%2Ftest%2Fui%2Ferror-codes%2FE0117.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ferror-codes%2FE0117.rs?ref=1140ceebccdf9ab00bce927dd71dbe5957486ef2", "patch": "@@ -1,6 +1,5 @@\n impl Drop for u32 {} //~ ERROR E0117\n-//~| ERROR the Drop trait may only be implemented on structures\n-//~| implementing Drop requires a struct\n+//~| ERROR the `Drop` trait may only be implemented for structs, enums, and unions\n \n fn main() {\n }"}, {"sha": "b48a1d8e50d4de1c665b3a86fdad7f9abf29ef52", "filename": "src/test/ui/error-codes/E0117.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/1140ceebccdf9ab00bce927dd71dbe5957486ef2/src%2Ftest%2Fui%2Ferror-codes%2FE0117.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/1140ceebccdf9ab00bce927dd71dbe5957486ef2/src%2Ftest%2Fui%2Ferror-codes%2FE0117.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ferror-codes%2FE0117.stderr?ref=1140ceebccdf9ab00bce927dd71dbe5957486ef2", "patch": "@@ -1,8 +1,8 @@\n-error[E0120]: the Drop trait may only be implemented on structures\n+error[E0120]: the `Drop` trait may only be implemented for structs, enums, and unions\n   --> $DIR/E0117.rs:1:15\n    |\n LL | impl Drop for u32 {}\n-   |               ^^^ implementing Drop requires a struct\n+   |               ^^^ must be a struct, enum, or union\n \n error[E0117]: only traits defined in the current crate can be implemented for arbitrary types\n   --> $DIR/E0117.rs:1:1"}, {"sha": "6c306455e42545b8bf4c776b3ac9075982c9e2a3", "filename": "src/test/ui/error-codes/E0120.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/1140ceebccdf9ab00bce927dd71dbe5957486ef2/src%2Ftest%2Fui%2Ferror-codes%2FE0120.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/1140ceebccdf9ab00bce927dd71dbe5957486ef2/src%2Ftest%2Fui%2Ferror-codes%2FE0120.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ferror-codes%2FE0120.stderr?ref=1140ceebccdf9ab00bce927dd71dbe5957486ef2", "patch": "@@ -1,8 +1,8 @@\n-error[E0120]: the Drop trait may only be implemented on structures\n+error[E0120]: the `Drop` trait may only be implemented for structs, enums, and unions\n   --> $DIR/E0120.rs:3:15\n    |\n LL | impl Drop for dyn MyTrait {\n-   |               ^^^^^^^^^^^ implementing Drop requires a struct\n+   |               ^^^^^^^^^^^ must be a struct, enum, or union\n \n error: aborting due to previous error\n "}, {"sha": "01416a0d79e5f72d24d928b4f9166c43f09ec6d8", "filename": "src/test/ui/issues/issue-17959.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1140ceebccdf9ab00bce927dd71dbe5957486ef2/src%2Ftest%2Fui%2Fissues%2Fissue-17959.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1140ceebccdf9ab00bce927dd71dbe5957486ef2/src%2Ftest%2Fui%2Fissues%2Fissue-17959.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-17959.rs?ref=1140ceebccdf9ab00bce927dd71dbe5957486ef2", "patch": "@@ -9,7 +9,7 @@ struct G<T: ?Sized> {\n }\n \n impl<T> Drop for G<T> {\n-//~^ ERROR: The requirement `T: std::marker::Sized` is added only by the Drop impl. [E0367]\n+//~^ ERROR `Drop` impl requires `T: std::marker::Sized`\n     fn drop(&mut self) {\n         if !self._ptr.is_null() {\n         }"}, {"sha": "29d32c1f3cec6975cfe11734fa2793241c5f6cae", "filename": "src/test/ui/issues/issue-17959.stderr", "status": "modified", "additions": 5, "deletions": 11, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/1140ceebccdf9ab00bce927dd71dbe5957486ef2/src%2Ftest%2Fui%2Fissues%2Fissue-17959.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/1140ceebccdf9ab00bce927dd71dbe5957486ef2/src%2Ftest%2Fui%2Fissues%2Fissue-17959.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-17959.stderr?ref=1140ceebccdf9ab00bce927dd71dbe5957486ef2", "patch": "@@ -1,16 +1,10 @@\n-error[E0367]: The requirement `T: std::marker::Sized` is added only by the Drop impl.\n-  --> $DIR/issue-17959.rs:11:1\n+error[E0367]: `Drop` impl requires `T: std::marker::Sized` but the struct it is implemented for does not\n+  --> $DIR/issue-17959.rs:11:6\n    |\n-LL | / impl<T> Drop for G<T> {\n-LL | |\n-LL | |     fn drop(&mut self) {\n-LL | |         if !self._ptr.is_null() {\n-LL | |         }\n-LL | |     }\n-LL | | }\n-   | |_^\n+LL | impl<T> Drop for G<T> {\n+   |      ^\n    |\n-note: The same requirement must be part of the struct/enum definition\n+note: the implementor must specify the same requirement\n   --> $DIR/issue-17959.rs:7:1\n    |\n LL | / struct G<T: ?Sized> {"}, {"sha": "10d1e7c4e66dc20aa908f49e9e195030a3266ebe", "filename": "src/test/ui/issues/issue-38868.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/1140ceebccdf9ab00bce927dd71dbe5957486ef2/src%2Ftest%2Fui%2Fissues%2Fissue-38868.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/1140ceebccdf9ab00bce927dd71dbe5957486ef2/src%2Ftest%2Fui%2Fissues%2Fissue-38868.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-38868.stderr?ref=1140ceebccdf9ab00bce927dd71dbe5957486ef2", "patch": "@@ -1,4 +1,4 @@\n-error[E0366]: Implementations of Drop cannot be specialized\n+error[E0366]: `Drop` impls cannot be specialized\n   --> $DIR/issue-38868.rs:5:1\n    |\n LL | / impl Drop for List<i32> {\n@@ -8,7 +8,7 @@ LL | |     }\n LL | | }\n    | |_^\n    |\n-note: Use same sequence of generic type and region parameters that is on the struct/enum definition\n+note: use the same sequence of generic type, lifetime and const parameters as the struct definition\n   --> $DIR/issue-38868.rs:1:1\n    |\n LL | / pub struct List<T> {"}, {"sha": "d082e0a6b5dc46bf311ca1101bf7d6c88b4773cf", "filename": "src/test/ui/issues/issue-41974.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/1140ceebccdf9ab00bce927dd71dbe5957486ef2/src%2Ftest%2Fui%2Fissues%2Fissue-41974.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/1140ceebccdf9ab00bce927dd71dbe5957486ef2/src%2Ftest%2Fui%2Fissues%2Fissue-41974.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-41974.stderr?ref=1140ceebccdf9ab00bce927dd71dbe5957486ef2", "patch": "@@ -9,11 +9,11 @@ LL | impl<T> Drop for T where T: A {\n              where T: ?Sized;\n    = note: downstream crates may implement trait `A` for type `std::boxed::Box<_>`\n \n-error[E0120]: the Drop trait may only be implemented on structures\n+error[E0120]: the `Drop` trait may only be implemented for structs, enums, and unions\n   --> $DIR/issue-41974.rs:7:18\n    |\n LL | impl<T> Drop for T where T: A {\n-   |                  ^ implementing Drop requires a struct\n+   |                  ^ must be a struct, enum, or union\n \n error[E0210]: type parameter `T` must be used as the type parameter for some local type (e.g., `MyStruct<T>`)\n   --> $DIR/issue-41974.rs:7:6"}, {"sha": "d7fec8802f08bb8d1ac2a2cfb78eb8cd70f456cf", "filename": "src/test/ui/reject-specialized-drops-8142.rs", "status": "modified", "additions": 20, "deletions": 7, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/1140ceebccdf9ab00bce927dd71dbe5957486ef2/src%2Ftest%2Fui%2Freject-specialized-drops-8142.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1140ceebccdf9ab00bce927dd71dbe5957486ef2/src%2Ftest%2Fui%2Freject-specialized-drops-8142.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Freject-specialized-drops-8142.rs?ref=1140ceebccdf9ab00bce927dd71dbe5957486ef2", "patch": "@@ -1,5 +1,5 @@\n // Issue 8142: Test that Drop impls cannot be specialized beyond the\n-// predicates attached to the struct/enum definition itself.\n+// predicates attached to the type definition itself.\n \n trait Bound { fn foo(&self) { } }\n struct K<'l1,'l2> { x: &'l1 i8, y: &'l2 u8 }\n@@ -16,12 +16,16 @@ struct U;\n struct V<Tva, Tvb> { x: *const Tva, y: *const Tvb }\n struct W<'l1, 'l2> { x: &'l1 i8, y: &'l2 u8 }\n \n+enum Enum<T> { Variant(T) }\n+struct TupleStruct<T>(T);\n+union Union<T: Copy> { f: T }\n+\n impl<'al,'adds_bnd:'al> Drop for K<'al,'adds_bnd> {                        // REJECT\n-    //~^ ERROR The requirement `'adds_bnd : 'al` is added only by the Drop impl.\n+    //~^ ERROR `Drop` impl requires `'adds_bnd : 'al`\n     fn drop(&mut self) { } }\n \n impl<'al,'adds_bnd>     Drop for L<'al,'adds_bnd> where 'adds_bnd:'al {    // REJECT\n-    //~^ ERROR The requirement `'adds_bnd : 'al` is added only by the Drop impl.\n+    //~^ ERROR `Drop` impl requires `'adds_bnd : 'al`\n     fn drop(&mut self) { } }\n \n impl<'ml>               Drop for M<'ml>         { fn drop(&mut self) { } } // ACCEPT\n@@ -34,13 +38,13 @@ impl                    Drop for N<'static>     { fn drop(&mut self) { } } // RE\n impl<COkNoBound> Drop for O<COkNoBound> { fn drop(&mut self) { } } // ACCEPT\n \n impl              Drop for P<i8>          { fn drop(&mut self) { } } // REJECT\n-//~^ ERROR Implementations of Drop cannot be specialized\n+//~^ ERROR `Drop` impls cannot be specialized\n \n impl<AddsBnd:Bound> Drop for Q<AddsBnd> { fn drop(&mut self) { } } // REJECT\n-//~^ ERROR The requirement `AddsBnd: Bound` is added only by the Drop impl.\n+//~^ ERROR `Drop` impl requires `AddsBnd: Bound`\n \n impl<'rbnd,AddsRBnd:'rbnd> Drop for R<AddsRBnd> { fn drop(&mut self) { } } // REJECT\n-//~^ ERROR The requirement `AddsRBnd : 'rbnd` is added only by the Drop impl.\n+//~^ ERROR `Drop` impl requires `AddsRBnd : 'rbnd`\n \n impl<Bs:Bound>    Drop for S<Bs>          { fn drop(&mut self) { } } // ACCEPT\n \n@@ -49,9 +53,18 @@ impl<'t,Bt:'t>    Drop for T<'t,Bt>       { fn drop(&mut self) { } } // ACCEPT\n impl              Drop for U              { fn drop(&mut self) { } } // ACCEPT\n \n impl<One>         Drop for V<One,One>     { fn drop(&mut self) { } } // REJECT\n-//~^ ERROR Implementations of Drop cannot be specialized\n+//~^ ERROR `Drop` impls cannot be specialized\n \n impl<'lw>         Drop for W<'lw,'lw>     { fn drop(&mut self) { } } // REJECT\n //~^ ERROR cannot infer an appropriate lifetime for lifetime parameter `'lw`\n \n+impl<AddsBnd:Bound> Drop for Enum<AddsBnd> { fn drop(&mut self) { } } // REJECT\n+//~^ ERROR `Drop` impl requires `AddsBnd: Bound`\n+\n+impl<AddsBnd:Bound> Drop for TupleStruct<AddsBnd> { fn drop(&mut self) { } } // REJECT\n+//~^ ERROR `Drop` impl requires `AddsBnd: Bound`\n+\n+impl<AddsBnd:Copy + Bound> Drop for Union<AddsBnd> { fn drop(&mut self) { } } // REJECT\n+//~^ ERROR `Drop` impl requires `AddsBnd: Bound`\n+\n pub fn main() { }"}, {"sha": "14618df90cb6292a0f2bba5d181804bd68f5050a", "filename": "src/test/ui/reject-specialized-drops-8142.stderr", "status": "modified", "additions": 64, "deletions": 32, "changes": 96, "blob_url": "https://github.com/rust-lang/rust/blob/1140ceebccdf9ab00bce927dd71dbe5957486ef2/src%2Ftest%2Fui%2Freject-specialized-drops-8142.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/1140ceebccdf9ab00bce927dd71dbe5957486ef2/src%2Ftest%2Fui%2Freject-specialized-drops-8142.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Freject-specialized-drops-8142.stderr?ref=1140ceebccdf9ab00bce927dd71dbe5957486ef2", "patch": "@@ -1,33 +1,41 @@\n-error[E0367]: The requirement `'adds_bnd : 'al` is added only by the Drop impl.\n-  --> $DIR/reject-specialized-drops-8142.rs:19:1\n+error[E0367]: `Drop` impl requires `AddsBnd: Bound` but the union it is implemented for does not\n+  --> $DIR/reject-specialized-drops-8142.rs:67:21\n+   |\n+LL | impl<AddsBnd:Copy + Bound> Drop for Union<AddsBnd> { fn drop(&mut self) { } } // REJECT\n+   |                     ^^^^^\n+   |\n+note: the implementor must specify the same requirement\n+  --> $DIR/reject-specialized-drops-8142.rs:21:1\n+   |\n+LL | union Union<T: Copy> { f: T }\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error[E0367]: `Drop` impl requires `'adds_bnd : 'al` but the struct it is implemented for does not\n+  --> $DIR/reject-specialized-drops-8142.rs:23:20\n    |\n-LL | / impl<'al,'adds_bnd:'al> Drop for K<'al,'adds_bnd> {                        // REJECT\n-LL | |\n-LL | |     fn drop(&mut self) { } }\n-   | |____________________________^\n+LL | impl<'al,'adds_bnd:'al> Drop for K<'al,'adds_bnd> {                        // REJECT\n+   |                    ^^^\n    |\n-note: The same requirement must be part of the struct/enum definition\n+note: the implementor must specify the same requirement\n   --> $DIR/reject-specialized-drops-8142.rs:5:1\n    |\n LL | struct K<'l1,'l2> { x: &'l1 i8, y: &'l2 u8 }\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n-error[E0367]: The requirement `'adds_bnd : 'al` is added only by the Drop impl.\n-  --> $DIR/reject-specialized-drops-8142.rs:23:1\n+error[E0367]: `Drop` impl requires `'adds_bnd : 'al` but the struct it is implemented for does not\n+  --> $DIR/reject-specialized-drops-8142.rs:27:67\n    |\n-LL | / impl<'al,'adds_bnd>     Drop for L<'al,'adds_bnd> where 'adds_bnd:'al {    // REJECT\n-LL | |\n-LL | |     fn drop(&mut self) { } }\n-   | |____________________________^\n+LL | impl<'al,'adds_bnd>     Drop for L<'al,'adds_bnd> where 'adds_bnd:'al {    // REJECT\n+   |                                                                   ^^^\n    |\n-note: The same requirement must be part of the struct/enum definition\n+note: the implementor must specify the same requirement\n   --> $DIR/reject-specialized-drops-8142.rs:6:1\n    |\n LL | struct L<'l1,'l2> { x: &'l1 i8, y: &'l2 u8 }\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n error[E0308]: mismatched types\n-  --> $DIR/reject-specialized-drops-8142.rs:29:1\n+  --> $DIR/reject-specialized-drops-8142.rs:33:1\n    |\n LL | impl                    Drop for N<'static>     { fn drop(&mut self) { } } // REJECT\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ lifetime mismatch\n@@ -41,56 +49,56 @@ LL | struct N<'n> { x: &'n i8 }\n    |          ^^\n    = note: ...does not necessarily outlive the static lifetime\n \n-error[E0366]: Implementations of Drop cannot be specialized\n-  --> $DIR/reject-specialized-drops-8142.rs:36:1\n+error[E0366]: `Drop` impls cannot be specialized\n+  --> $DIR/reject-specialized-drops-8142.rs:40:1\n    |\n LL | impl              Drop for P<i8>          { fn drop(&mut self) { } } // REJECT\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |\n-note: Use same sequence of generic type and region parameters that is on the struct/enum definition\n+note: use the same sequence of generic type, lifetime and const parameters as the struct definition\n   --> $DIR/reject-specialized-drops-8142.rs:10:1\n    |\n LL | struct P<Tp> { x: *const Tp }\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n-error[E0367]: The requirement `AddsBnd: Bound` is added only by the Drop impl.\n-  --> $DIR/reject-specialized-drops-8142.rs:39:1\n+error[E0367]: `Drop` impl requires `AddsBnd: Bound` but the struct it is implemented for does not\n+  --> $DIR/reject-specialized-drops-8142.rs:43:14\n    |\n LL | impl<AddsBnd:Bound> Drop for Q<AddsBnd> { fn drop(&mut self) { } } // REJECT\n-   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |              ^^^^^\n    |\n-note: The same requirement must be part of the struct/enum definition\n+note: the implementor must specify the same requirement\n   --> $DIR/reject-specialized-drops-8142.rs:11:1\n    |\n LL | struct Q<Tq> { x: *const Tq }\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n-error[E0367]: The requirement `AddsRBnd : 'rbnd` is added only by the Drop impl.\n-  --> $DIR/reject-specialized-drops-8142.rs:42:1\n+error[E0367]: `Drop` impl requires `AddsRBnd : 'rbnd` but the struct it is implemented for does not\n+  --> $DIR/reject-specialized-drops-8142.rs:46:21\n    |\n LL | impl<'rbnd,AddsRBnd:'rbnd> Drop for R<AddsRBnd> { fn drop(&mut self) { } } // REJECT\n-   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |                     ^^^^^\n    |\n-note: The same requirement must be part of the struct/enum definition\n+note: the implementor must specify the same requirement\n   --> $DIR/reject-specialized-drops-8142.rs:12:1\n    |\n LL | struct R<Tr> { x: *const Tr }\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n-error[E0366]: Implementations of Drop cannot be specialized\n-  --> $DIR/reject-specialized-drops-8142.rs:51:1\n+error[E0366]: `Drop` impls cannot be specialized\n+  --> $DIR/reject-specialized-drops-8142.rs:55:1\n    |\n LL | impl<One>         Drop for V<One,One>     { fn drop(&mut self) { } } // REJECT\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |\n-note: Use same sequence of generic type and region parameters that is on the struct/enum definition\n+note: use the same sequence of generic type, lifetime and const parameters as the struct definition\n   --> $DIR/reject-specialized-drops-8142.rs:16:1\n    |\n LL | struct V<Tva, Tvb> { x: *const Tva, y: *const Tvb }\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n error[E0495]: cannot infer an appropriate lifetime for lifetime parameter `'lw` due to conflicting requirements\n-  --> $DIR/reject-specialized-drops-8142.rs:54:1\n+  --> $DIR/reject-specialized-drops-8142.rs:58:1\n    |\n LL | impl<'lw>         Drop for W<'lw,'lw>     { fn drop(&mut self) { } } // REJECT\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n@@ -106,14 +114,38 @@ note: ...but the lifetime must also be valid for the lifetime `'l2` as defined o\n LL | struct W<'l1, 'l2> { x: &'l1 i8, y: &'l2 u8 }\n    |               ^^^\n note: ...so that the types are compatible\n-  --> $DIR/reject-specialized-drops-8142.rs:54:1\n+  --> $DIR/reject-specialized-drops-8142.rs:58:1\n    |\n LL | impl<'lw>         Drop for W<'lw,'lw>     { fn drop(&mut self) { } } // REJECT\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    = note: expected  `W<'l1, 'l2>`\n               found  `W<'_, '_>`\n \n-error: aborting due to 8 previous errors\n+error[E0367]: `Drop` impl requires `AddsBnd: Bound` but the enum it is implemented for does not\n+  --> $DIR/reject-specialized-drops-8142.rs:61:14\n+   |\n+LL | impl<AddsBnd:Bound> Drop for Enum<AddsBnd> { fn drop(&mut self) { } } // REJECT\n+   |              ^^^^^\n+   |\n+note: the implementor must specify the same requirement\n+  --> $DIR/reject-specialized-drops-8142.rs:19:1\n+   |\n+LL | enum Enum<T> { Variant(T) }\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error[E0367]: `Drop` impl requires `AddsBnd: Bound` but the struct it is implemented for does not\n+  --> $DIR/reject-specialized-drops-8142.rs:64:14\n+   |\n+LL | impl<AddsBnd:Bound> Drop for TupleStruct<AddsBnd> { fn drop(&mut self) { } } // REJECT\n+   |              ^^^^^\n+   |\n+note: the implementor must specify the same requirement\n+  --> $DIR/reject-specialized-drops-8142.rs:20:1\n+   |\n+LL | struct TupleStruct<T>(T);\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: aborting due to 11 previous errors\n \n Some errors have detailed explanations: E0308, E0366, E0367, E0495.\n For more information about an error, try `rustc --explain E0308`."}]}