{"sha": "01510612ee20d14a3397427891a4042a34d53956", "node_id": "MDY6Q29tbWl0NzI0NzEyOjAxNTEwNjEyZWUyMGQxNGEzMzk3NDI3ODkxYTQwNDJhMzRkNTM5NTY=", "commit": {"author": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2020-09-03T00:00:00Z"}, "committer": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2020-09-04T00:33:37Z"}, "message": "NRVO: Allow occurrences of the return place in var debug info\n\nThe non-use occurrence of the return place in var debug info does not\ncurrently inhibit NRVO optimization, but it will fail assertion in\n`visit_place` when optimization is performed.\n\nRelax assertion check to allow the return place in var debug info.\n\nThis case might be impossible to hit in optimization pipelines as of\nnow, but can be encountered in customized mir-opt-level=2 pipeline with\ncopy propagation disabled. For example in:\n\n```\npub fn b(s: String) -> String {\n    a(s)\n}\n\n#[inline]\npub fn a(s: String) -> String {\n    let x = s;\n    let y = x;\n    y\n}\n```", "tree": {"sha": "7d61c84405b01c0201aec4f80612f34a7daf2420", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7d61c84405b01c0201aec4f80612f34a7daf2420"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/01510612ee20d14a3397427891a4042a34d53956", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/01510612ee20d14a3397427891a4042a34d53956", "html_url": "https://github.com/rust-lang/rust/commit/01510612ee20d14a3397427891a4042a34d53956", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/01510612ee20d14a3397427891a4042a34d53956/comments", "author": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0d0f6b113047b2cf9afbde990cee30fd5b866469", "url": "https://api.github.com/repos/rust-lang/rust/commits/0d0f6b113047b2cf9afbde990cee30fd5b866469", "html_url": "https://github.com/rust-lang/rust/commit/0d0f6b113047b2cf9afbde990cee30fd5b866469"}], "stats": {"total": 9, "additions": 5, "deletions": 4}, "files": [{"sha": "3673b6a4aa223c2e5e9c0b9dd139c3133aed904e", "filename": "compiler/rustc_mir/src/transform/nrvo.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/01510612ee20d14a3397427891a4042a34d53956/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fnrvo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/01510612ee20d14a3397427891a4042a34d53956/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fnrvo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fnrvo.rs?ref=01510612ee20d14a3397427891a4042a34d53956", "patch": "@@ -1,6 +1,6 @@\n use rustc_hir::Mutability;\n use rustc_index::bit_set::HybridBitSet;\n-use rustc_middle::mir::visit::{MutVisitor, PlaceContext, Visitor};\n+use rustc_middle::mir::visit::{MutVisitor, NonUseContext, PlaceContext, Visitor};\n use rustc_middle::mir::{self, BasicBlock, Local, Location};\n use rustc_middle::ty::TyCtxt;\n \n@@ -196,9 +196,10 @@ impl MutVisitor<'tcx> for RenameToReturnPlace<'tcx> {\n         self.super_terminator(terminator, loc);\n     }\n \n-    fn visit_local(&mut self, l: &mut Local, _: PlaceContext, _: Location) {\n-        assert_ne!(*l, mir::RETURN_PLACE);\n-        if *l == self.to_rename {\n+    fn visit_local(&mut self, l: &mut Local, ctxt: PlaceContext, _: Location) {\n+        if *l == mir::RETURN_PLACE {\n+            assert_eq!(ctxt, PlaceContext::NonUse(NonUseContext::VarDebugInfo));\n+        } else if *l == self.to_rename {\n             *l = mir::RETURN_PLACE;\n         }\n     }"}]}