{"sha": "7e7a43b8765307239a73fc72dddcd426ee5908c0", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdlN2E0M2I4NzY1MzA3MjM5YTczZmM3MmRkZGNkNDI2ZWU1OTA4YzA=", "commit": {"author": {"name": "Jethro Beekman", "email": "jethro@fortanix.com", "date": "2019-01-26T09:16:39Z"}, "committer": {"name": "Jethro Beekman", "email": "jethro@fortanix.com", "date": "2019-01-26T09:23:00Z"}, "message": "Clean up build-x86_64-fortanix-unknown-sgx-toolchain.sh", "tree": {"sha": "d2356ada1f40fe0b4724910d0f41761745c266e8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d2356ada1f40fe0b4724910d0f41761745c266e8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7e7a43b8765307239a73fc72dddcd426ee5908c0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7e7a43b8765307239a73fc72dddcd426ee5908c0", "html_url": "https://github.com/rust-lang/rust/commit/7e7a43b8765307239a73fc72dddcd426ee5908c0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7e7a43b8765307239a73fc72dddcd426ee5908c0/comments", "author": null, "committer": null, "parents": [{"sha": "9df043b543bb9bc3e50bc243811c58d52a3aefea", "url": "https://api.github.com/repos/rust-lang/rust/commits/9df043b543bb9bc3e50bc243811c58d52a3aefea", "html_url": "https://github.com/rust-lang/rust/commit/9df043b543bb9bc3e50bc243811c58d52a3aefea"}], "stats": {"total": 56, "additions": 33, "deletions": 23}, "files": [{"sha": "f94cd36e8d6ec6f56eab54cc0530da7260928b32", "filename": "src/ci/docker/dist-various-2/build-x86_64-fortanix-unknown-sgx-toolchain.sh", "status": "modified", "additions": 14, "deletions": 19, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/7e7a43b8765307239a73fc72dddcd426ee5908c0/src%2Fci%2Fdocker%2Fdist-various-2%2Fbuild-x86_64-fortanix-unknown-sgx-toolchain.sh", "raw_url": "https://github.com/rust-lang/rust/raw/7e7a43b8765307239a73fc72dddcd426ee5908c0/src%2Fci%2Fdocker%2Fdist-various-2%2Fbuild-x86_64-fortanix-unknown-sgx-toolchain.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-various-2%2Fbuild-x86_64-fortanix-unknown-sgx-toolchain.sh?ref=7e7a43b8765307239a73fc72dddcd426ee5908c0", "patch": "@@ -12,8 +12,7 @@ target=\"x86_64-fortanix-unknown-sgx\"\n url=\"https://github.com/fortanix/llvm-project/archive/${1}.tar.gz\"\n repo_name=\"llvm-project\"\n \n-install_prereq()\n-{\n+install_prereq() {\n     apt-get update\n     apt-get install -y --no-install-recommends \\\n             build-essential \\\n@@ -22,34 +21,30 @@ install_prereq()\n             git\n }\n \n-# Clone Fortanix's port of llvm-project to build libunwind that would link with this target.\n-# The below method to download a single commit from llvm-project is based on fetch_submodule\n-# from init_repo.sh\n-fetch_llvm_commit()\n-{\n-    cached=\"download-${repo_name}.tar.gz\"\n-    curl -f -sSL -o ${cached} ${url}\n-    tar -xvzf ${cached}\n-    mkdir \"./${repo_name}\" && tar -xf ${cached} -C ${repo_name} --strip-components 1\n-}\n-\n-build_unwind()\n-{\n+build_unwind() {\n+    set -x\n     dir_name=\"${target}_temp\"\n-    rm -rf \"./${dir_name}\"\n+    rm -rf ${dir_name}\n     mkdir -p ${dir_name}\n-    cd ${dir_name}\n+    pushd ${dir_name}\n \n-    retry fetch_llvm_commit\n+    # Clone Fortanix's fork of llvm-project which has a port of libunwind\n+    fetch_github_commit_archive \"$repo_name\" \"$url\"\n     cd \"${repo_name}/libunwind\"\n \n     # Build libunwind\n     mkdir -p build\n     cd build\n-    cmake -DCMAKE_BUILD_TYPE=\"RELEASE\" -DRUST_SGX=1 -G \"Unix Makefiles\" -DLLVM_PATH=../../llvm/ ../\n+    cmake -DCMAKE_BUILD_TYPE=\"RELEASE\" -DRUST_SGX=1 -G \"Unix Makefiles\" \\\n+        -DLLVM_ENABLE_WARNINGS=1 -DLIBUNWIND_ENABLE_WERROR=1 -DLIBUNWIND_ENABLE_PEDANTIC=0 \\\n+        -DLLVM_PATH=../../llvm/ ../\n     make unwind_static\n     install -D \"lib/libunwind.a\" \"/${target}/lib/libunwind.a\"\n+\n+    popd\n     rm -rf ${dir_name}\n+\n+    { set +x; } 2>/dev/null\n }\n \n set -x"}, {"sha": "7abace65b9c03a1db28378137404e853c7b8bf4b", "filename": "src/ci/docker/dist-various-2/shared.sh", "status": "modified", "additions": 14, "deletions": 1, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/7e7a43b8765307239a73fc72dddcd426ee5908c0/src%2Fci%2Fdocker%2Fdist-various-2%2Fshared.sh", "raw_url": "https://github.com/rust-lang/rust/raw/7e7a43b8765307239a73fc72dddcd426ee5908c0/src%2Fci%2Fdocker%2Fdist-various-2%2Fshared.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-various-2%2Fshared.sh?ref=7e7a43b8765307239a73fc72dddcd426ee5908c0", "patch": "@@ -1,5 +1,5 @@\n hide_output() {\n-  set +x\n+  { set +x; } 2>/dev/null\n   on_err=\"\n echo ERROR: An error was encountered with the build.\n cat /tmp/build.log\n@@ -14,6 +14,7 @@ exit 1\n   set -x\n }\n \n+# Copied from ../../shared.sh\n function retry {\n   echo \"Attempting with retry:\" \"$@\"\n   local n=1\n@@ -31,3 +32,15 @@ function retry {\n     }\n   done\n }\n+\n+# Copied from ../../init_repo.sh\n+function fetch_github_commit_archive {\n+    local module=$1\n+    local cached=\"download-${module//\\//-}.tar.gz\"\n+    retry sh -c \"rm -f $cached && \\\n+        curl -f -sSL -o $cached $2\"\n+    mkdir $module\n+    touch \"$module/.git\"\n+    tar -C $module --strip-components=1 -xf $cached\n+    rm $cached\n+}"}, {"sha": "3dfd3381576170b00edc3c1d851b993eb84a16e3", "filename": "src/ci/init_repo.sh", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/7e7a43b8765307239a73fc72dddcd426ee5908c0/src%2Fci%2Finit_repo.sh", "raw_url": "https://github.com/rust-lang/rust/raw/7e7a43b8765307239a73fc72dddcd426ee5908c0/src%2Fci%2Finit_repo.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Finit_repo.sh?ref=7e7a43b8765307239a73fc72dddcd426ee5908c0", "patch": "@@ -34,11 +34,12 @@ if grep -q RUST_RELEASE_CHANNEL=beta src/ci/run.sh; then\n   git fetch origin --unshallow beta master\n fi\n \n-function fetch_submodule {\n+# Duplicated in docker/dist-various-2/shared.sh\n+function fetch_github_commit_archive {\n     local module=$1\n     local cached=\"download-${module//\\//-}.tar.gz\"\n     retry sh -c \"rm -f $cached && \\\n-        curl -sSL -o $cached $2\"\n+        curl -f -sSL -o $cached $2\"\n     mkdir $module\n     touch \"$module/.git\"\n     tar -C $module --strip-components=1 -xf $cached\n@@ -58,7 +59,7 @@ for i in ${!modules[@]}; do\n         git rm $module\n         url=${urls[$i]}\n         url=${url/\\.git/}\n-        fetch_submodule $module \"$url/archive/$commit.tar.gz\" &\n+        fetch_github_commit_archive $module \"$url/archive/$commit.tar.gz\" &\n         continue\n     else\n         use_git=\"$use_git $module\""}, {"sha": "3ba64ad412064e48b5eb3a91d84793fa891323bb", "filename": "src/ci/shared.sh", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7e7a43b8765307239a73fc72dddcd426ee5908c0/src%2Fci%2Fshared.sh", "raw_url": "https://github.com/rust-lang/rust/raw/7e7a43b8765307239a73fc72dddcd426ee5908c0/src%2Fci%2Fshared.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fshared.sh?ref=7e7a43b8765307239a73fc72dddcd426ee5908c0", "patch": "@@ -5,6 +5,7 @@\n # marked as an executable file in git.\n \n # See http://unix.stackexchange.com/questions/82598\n+# Duplicated in docker/dist-various-2/shared.sh\n function retry {\n   echo \"Attempting with retry:\" \"$@\"\n   local n=1"}]}