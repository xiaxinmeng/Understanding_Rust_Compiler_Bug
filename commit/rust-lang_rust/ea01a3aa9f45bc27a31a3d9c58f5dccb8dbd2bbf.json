{"sha": "ea01a3aa9f45bc27a31a3d9c58f5dccb8dbd2bbf", "node_id": "C_kwDOAAsO6NoAKGVhMDFhM2FhOWY0NWJjMjdhMzFhM2Q5YzU4ZjVkY2NiOGRiZDJiYmY", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-11-18T08:38:07Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-11-18T08:38:07Z"}, "message": "Merge #10799\n\n10799: fix: Fix proc macro ABI version checks r=lnicola a=lnicola\n\nIf I'm reading this right, we used to pick `Abi1_55` for `1.54` and `Abi_1_58` for `1.57`.\r\n\r\nCC `@alexjg` (just in case I'm misinterpreting the code), CC #10772.\r\n\r\nbors r+\n\nCo-authored-by: Lauren\u021biu Nicola <lnicola@dend.ro>", "tree": {"sha": "e0d9b36eaca2229adca4a887990f20a335f4d36e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e0d9b36eaca2229adca4a887990f20a335f4d36e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ea01a3aa9f45bc27a31a3d9c58f5dccb8dbd2bbf", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhlhDvCRBK7hj4Ov3rIwAA3U8IAC+qT7Rp6ZNVIT8Nazw5dlI1\nq+1JBx/b5pQZFa759WVDVgLewNfE68DEqSVz9nXM6J1/QmBuwOUxFRfy8113gu1s\n2wBOc/4UBZ/0wxTjSLqc2WOKGnOcQxJTa+y+4S4iR616aIcqjNmzvlqWdJLulO4w\nVdwgKn3np1A+ZeAOP9Stk1LJU7ZsaEqMLQiz5znKAmopa2VX1ApKyfOyLm7GIwln\nC+PXbX5WwZ33GhI9WC3twUf8otAbwZCFj7IDjYVB7GilbBU0DiQmqnmwba6EOW05\nfDfTWtN7qyi5NfxaA2cQCbbmW518ZvLLCbIb0k8U4K/uzlRjJwB7Yp29/ur+RvA=\n=hPHS\n-----END PGP SIGNATURE-----\n", "payload": "tree e0d9b36eaca2229adca4a887990f20a335f4d36e\nparent 64a73dcfba277587843bd2548b0d6990dc4a4b16\nparent 6196b928a44f469e37dc746a84a2175a560f09d4\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1637224687 +0000\ncommitter GitHub <noreply@github.com> 1637224687 +0000\n\nMerge #10799\n\n10799: fix: Fix proc macro ABI version checks r=lnicola a=lnicola\n\nIf I'm reading this right, we used to pick `Abi1_55` for `1.54` and `Abi_1_58` for `1.57`.\r\n\r\nCC `@alexjg` (just in case I'm misinterpreting the code), CC #10772.\r\n\r\nbors r+\n\nCo-authored-by: Lauren\u021biu Nicola <lnicola@dend.ro>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ea01a3aa9f45bc27a31a3d9c58f5dccb8dbd2bbf", "html_url": "https://github.com/rust-lang/rust/commit/ea01a3aa9f45bc27a31a3d9c58f5dccb8dbd2bbf", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ea01a3aa9f45bc27a31a3d9c58f5dccb8dbd2bbf/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "64a73dcfba277587843bd2548b0d6990dc4a4b16", "url": "https://api.github.com/repos/rust-lang/rust/commits/64a73dcfba277587843bd2548b0d6990dc4a4b16", "html_url": "https://github.com/rust-lang/rust/commit/64a73dcfba277587843bd2548b0d6990dc4a4b16"}, {"sha": "6196b928a44f469e37dc746a84a2175a560f09d4", "url": "https://api.github.com/repos/rust-lang/rust/commits/6196b928a44f469e37dc746a84a2175a560f09d4", "html_url": "https://github.com/rust-lang/rust/commit/6196b928a44f469e37dc746a84a2175a560f09d4"}], "stats": {"total": 36, "additions": 20, "deletions": 16}, "files": [{"sha": "0de15b48329a4d628a5ef71645343d58304f44bc", "filename": "crates/proc_macro_srv/src/abis/mod.rs", "status": "modified", "additions": 20, "deletions": 16, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/ea01a3aa9f45bc27a31a3d9c58f5dccb8dbd2bbf/crates%2Fproc_macro_srv%2Fsrc%2Fabis%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ea01a3aa9f45bc27a31a3d9c58f5dccb8dbd2bbf/crates%2Fproc_macro_srv%2Fsrc%2Fabis%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproc_macro_srv%2Fsrc%2Fabis%2Fmod.rs?ref=ea01a3aa9f45bc27a31a3d9c58f5dccb8dbd2bbf", "patch": "@@ -69,22 +69,26 @@ impl Abi {\n         symbol_name: String,\n         info: RustCInfo,\n     ) -> Result<Abi, LoadProcMacroDylibError> {\n-        if info.version.0 != 1 {\n-            Err(LoadProcMacroDylibError::UnsupportedABI)\n-        } else if info.version.1 < 47 {\n-            Err(LoadProcMacroDylibError::UnsupportedABI)\n-        } else if info.version.1 < 54 {\n-            let inner = unsafe { Abi_1_47::from_lib(lib, symbol_name) }?;\n-            Ok(Abi::Abi1_47(inner))\n-        } else if info.version.1 < 56 {\n-            let inner = unsafe { Abi_1_55::from_lib(lib, symbol_name) }?;\n-            Ok(Abi::Abi1_55(inner))\n-        } else if info.version.1 < 57 {\n-            let inner = unsafe { Abi_1_56::from_lib(lib, symbol_name) }?;\n-            Ok(Abi::Abi1_56(inner))\n-        } else {\n-            let inner = unsafe { Abi_1_58::from_lib(lib, symbol_name) }?;\n-            Ok(Abi::Abi1_58(inner))\n+        // FIXME: this should use exclusive ranges when they're stable\n+        // https://github.com/rust-lang/rust/issues/37854\n+        match (info.version.0, info.version.1) {\n+            (1, 47..=54) => {\n+                let inner = unsafe { Abi_1_47::from_lib(lib, symbol_name) }?;\n+                Ok(Abi::Abi1_47(inner))\n+            }\n+            (1, 55..=55) => {\n+                let inner = unsafe { Abi_1_55::from_lib(lib, symbol_name) }?;\n+                Ok(Abi::Abi1_55(inner))\n+            }\n+            (1, 56..=57) => {\n+                let inner = unsafe { Abi_1_56::from_lib(lib, symbol_name) }?;\n+                Ok(Abi::Abi1_56(inner))\n+            }\n+            (1, 58..) => {\n+                let inner = unsafe { Abi_1_58::from_lib(lib, symbol_name) }?;\n+                Ok(Abi::Abi1_58(inner))\n+            }\n+            _ => Err(LoadProcMacroDylibError::UnsupportedABI),\n         }\n     }\n "}]}