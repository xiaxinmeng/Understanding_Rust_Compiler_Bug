{"sha": "8894c903cb02f8abde4d2d2b288320bc0930b8f9", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg4OTRjOTAzY2IwMmY4YWJkZTRkMmQyYjI4ODMyMGJjMDkzMGI4Zjk=", "commit": {"author": {"name": "Yuki Okushi", "email": "huyuumi.dev@gmail.com", "date": "2020-11-03T06:27:16Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-11-03T06:27:16Z"}, "message": "Rollup merge of #78663 - Aaron1011:fix/cap-future-compat, r=tmandry\n\nFix ICE when a future-incompat-report has its command-line level capped\n\nFixes #78660\n\nWith PR https://github.com/rust-lang/rust/pull/75534 merged, we now run\nmore lint-related code for future-incompat-report, even when their final\nlevel is Allow. Some lint-related code was not expecting `Level::Allow`,\nand had an explicit panic.\n\nThis PR explicitly tracks the lint level set on the command line before\n`--cap-lints` is applied. This is used to emit a more precise error\nnote (e.g. we don't say that `-W lint-name` was specified on the\ncommand line just because a lint was capped to Warn). As a result, we\ncan now correctly emit a note that `-A` was used if we got\n`Level::Allow` from the command line (before the cap is applied).", "tree": {"sha": "b19509fe573b4ac806ba2ba145465752e5092999", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b19509fe573b4ac806ba2ba145465752e5092999"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8894c903cb02f8abde4d2d2b288320bc0930b8f9", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfoPhECRBK7hj4Ov3rIwAAdHIIAAQKt3OgKbAAEqziExpeITvI\nItHHq3adO2j+ZchniDxHDSh6NkD9MUgnqJh85ZbFhqeY4sK8KMWahVDelRCi/BkF\nwTFCim8g8xog6aKzHIggwrb+rkuGbRxTXmayCgD/WWVxI3SWxsGRS3dtZyezO0dl\ns66VN4N8FdbAKuCZHCPGYvcyRhlhssTTOfLDbHPmRzqNaoUWNEbC0wyBPjqqs92w\naP4oYqstCdflemG44sbGsfNfSxgMorqqwrB/Zo0sz4jA3ACspKKhSiHc5vGjFCci\nTvDJggW/OwJiDMRvIGxK9hsiInUi1zphzK/1KwI6j1Q6akb7ITLdY+1eWP5OveQ=\n=FIAd\n-----END PGP SIGNATURE-----\n", "payload": "tree b19509fe573b4ac806ba2ba145465752e5092999\nparent 416dd6757b42089d63e3f2899adfcfe1e25bd0fd\nparent 6c1f15fa81be5f89cd7af7f7e73012967b4e673a\nauthor Yuki Okushi <huyuumi.dev@gmail.com> 1604384836 +0900\ncommitter GitHub <noreply@github.com> 1604384836 +0900\n\nRollup merge of #78663 - Aaron1011:fix/cap-future-compat, r=tmandry\n\nFix ICE when a future-incompat-report has its command-line level capped\n\nFixes #78660\n\nWith PR https://github.com/rust-lang/rust/pull/75534 merged, we now run\nmore lint-related code for future-incompat-report, even when their final\nlevel is Allow. Some lint-related code was not expecting `Level::Allow`,\nand had an explicit panic.\n\nThis PR explicitly tracks the lint level set on the command line before\n`--cap-lints` is applied. This is used to emit a more precise error\nnote (e.g. we don't say that `-W lint-name` was specified on the\ncommand line just because a lint was capped to Warn). As a result, we\ncan now correctly emit a note that `-A` was used if we got\n`Level::Allow` from the command line (before the cap is applied).\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8894c903cb02f8abde4d2d2b288320bc0930b8f9", "html_url": "https://github.com/rust-lang/rust/commit/8894c903cb02f8abde4d2d2b288320bc0930b8f9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8894c903cb02f8abde4d2d2b288320bc0930b8f9/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "416dd6757b42089d63e3f2899adfcfe1e25bd0fd", "url": "https://api.github.com/repos/rust-lang/rust/commits/416dd6757b42089d63e3f2899adfcfe1e25bd0fd", "html_url": "https://github.com/rust-lang/rust/commit/416dd6757b42089d63e3f2899adfcfe1e25bd0fd"}, {"sha": "6c1f15fa81be5f89cd7af7f7e73012967b4e673a", "url": "https://api.github.com/repos/rust-lang/rust/commits/6c1f15fa81be5f89cd7af7f7e73012967b4e673a", "html_url": "https://github.com/rust-lang/rust/commit/6c1f15fa81be5f89cd7af7f7e73012967b4e673a"}], "stats": {"total": 44, "additions": 34, "deletions": 10}, "files": [{"sha": "aca28988364e6802a0d83e9ea3528cd58f80e330", "filename": "compiler/rustc_lint/src/levels.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/8894c903cb02f8abde4d2d2b288320bc0930b8f9/compiler%2Frustc_lint%2Fsrc%2Flevels.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8894c903cb02f8abde4d2d2b288320bc0930b8f9/compiler%2Frustc_lint%2Fsrc%2Flevels.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_lint%2Fsrc%2Flevels.rs?ref=8894c903cb02f8abde4d2d2b288320bc0930b8f9", "patch": "@@ -74,6 +74,7 @@ impl<'s> LintLevelsBuilder<'s> {\n \n         for &(ref lint_name, level) in &sess.opts.lint_opts {\n             store.check_lint_name_cmdline(sess, &lint_name, level);\n+            let orig_level = level;\n \n             // If the cap is less than this specified level, e.g., if we've got\n             // `--cap-lints allow` but we've also got `-D foo` then we ignore\n@@ -88,7 +89,7 @@ impl<'s> LintLevelsBuilder<'s> {\n             };\n             for id in ids {\n                 self.check_gated_lint(id, DUMMY_SP);\n-                let src = LintSource::CommandLine(lint_flag_val);\n+                let src = LintSource::CommandLine(lint_flag_val, orig_level);\n                 specs.insert(id, (level, src));\n             }\n         }\n@@ -123,7 +124,7 @@ impl<'s> LintLevelsBuilder<'s> {\n                             diag_builder.note(&rationale.as_str());\n                         }\n                     }\n-                    LintSource::CommandLine(_) => {\n+                    LintSource::CommandLine(_, _) => {\n                         diag_builder.note(\"`forbid` lint level was set on command line\");\n                     }\n                 }\n@@ -422,7 +423,7 @@ impl<'s> LintLevelsBuilder<'s> {\n             let forbidden_lint_name = match forbid_src {\n                 LintSource::Default => id.to_string(),\n                 LintSource::Node(name, _, _) => name.to_string(),\n-                LintSource::CommandLine(name) => name.to_string(),\n+                LintSource::CommandLine(name, _) => name.to_string(),\n             };\n             let (lint_attr_name, lint_attr_span) = match *src {\n                 LintSource::Node(name, span, _) => (name, span),\n@@ -446,7 +447,7 @@ impl<'s> LintLevelsBuilder<'s> {\n                         diag_builder.note(&rationale.as_str());\n                     }\n                 }\n-                LintSource::CommandLine(_) => {\n+                LintSource::CommandLine(_, _) => {\n                     diag_builder.note(\"`forbid` lint level was set on command line\");\n                 }\n             }"}, {"sha": "781c1744ac62da86d15d91f5955a4b2fe482e4e6", "filename": "compiler/rustc_middle/src/lint.rs", "status": "modified", "additions": 8, "deletions": 6, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/8894c903cb02f8abde4d2d2b288320bc0930b8f9/compiler%2Frustc_middle%2Fsrc%2Flint.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8894c903cb02f8abde4d2d2b288320bc0930b8f9/compiler%2Frustc_middle%2Fsrc%2Flint.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Flint.rs?ref=8894c903cb02f8abde4d2d2b288320bc0930b8f9", "patch": "@@ -22,23 +22,25 @@ pub enum LintSource {\n     Node(Symbol, Span, Option<Symbol> /* RFC 2383 reason */),\n \n     /// Lint level was set by a command-line flag.\n-    CommandLine(Symbol),\n+    /// The provided `Level` is the level specified on the command line -\n+    /// the actual level may be lower due to `--cap-lints`\n+    CommandLine(Symbol, Level),\n }\n \n impl LintSource {\n     pub fn name(&self) -> Symbol {\n         match *self {\n             LintSource::Default => symbol::kw::Default,\n             LintSource::Node(name, _, _) => name,\n-            LintSource::CommandLine(name) => name,\n+            LintSource::CommandLine(name, _) => name,\n         }\n     }\n \n     pub fn span(&self) -> Span {\n         match *self {\n             LintSource::Default => DUMMY_SP,\n             LintSource::Node(_, span, _) => span,\n-            LintSource::CommandLine(_) => DUMMY_SP,\n+            LintSource::CommandLine(_, _) => DUMMY_SP,\n         }\n     }\n }\n@@ -279,12 +281,12 @@ pub fn struct_lint_level<'s, 'd>(\n                     &format!(\"`#[{}({})]` on by default\", level.as_str(), name),\n                 );\n             }\n-            LintSource::CommandLine(lint_flag_val) => {\n-                let flag = match level {\n+            LintSource::CommandLine(lint_flag_val, orig_level) => {\n+                let flag = match orig_level {\n                     Level::Warn => \"-W\",\n                     Level::Deny => \"-D\",\n                     Level::Forbid => \"-F\",\n-                    Level::Allow => panic!(),\n+                    Level::Allow => \"-A\",\n                 };\n                 let hyphen_case_lint_name = name.replace(\"_\", \"-\");\n                 if lint_flag_val.as_str() == name {"}, {"sha": "4d98f0ad62d4ddceff454fc3106e60c84ad392e7", "filename": "src/test/ui/lint/issue-78660-cap-lints-future-compat.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/8894c903cb02f8abde4d2d2b288320bc0930b8f9/src%2Ftest%2Fui%2Flint%2Fissue-78660-cap-lints-future-compat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8894c903cb02f8abde4d2d2b288320bc0930b8f9/src%2Ftest%2Fui%2Flint%2Fissue-78660-cap-lints-future-compat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Fissue-78660-cap-lints-future-compat.rs?ref=8894c903cb02f8abde4d2d2b288320bc0930b8f9", "patch": "@@ -0,0 +1,10 @@\n+// compile-flags: -D warnings --cap-lints allow\n+// check-pass\n+\n+// Regression test for issue #78660\n+// Tests that we don't ICE when a future-incompat-report lint has\n+// has a command-line source, but is capped to allow\n+\n+fn main() {\n+    [\"hi\"].into_iter();\n+}"}, {"sha": "79958ba90d409c9f8eb4af66051261dea3b5eef8", "filename": "src/test/ui/lint/issue-78660-cap-lints-future-compat.stderr", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/8894c903cb02f8abde4d2d2b288320bc0930b8f9/src%2Ftest%2Fui%2Flint%2Fissue-78660-cap-lints-future-compat.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/8894c903cb02f8abde4d2d2b288320bc0930b8f9/src%2Ftest%2Fui%2Flint%2Fissue-78660-cap-lints-future-compat.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Fissue-78660-cap-lints-future-compat.stderr?ref=8894c903cb02f8abde4d2d2b288320bc0930b8f9", "patch": "@@ -0,0 +1,11 @@\n+Future incompatibility report: Future breakage date: None, diagnostic:\n+warning: this method call currently resolves to `<&[T; N] as IntoIterator>::into_iter` (due to autoref coercions), but that might change in the future when `IntoIterator` impls for arrays are added.\n+  --> $DIR/issue-78660-cap-lints-future-compat.rs:9:12\n+   |\n+LL |     [\"hi\"].into_iter();\n+   |            ^^^^^^^^^ help: use `.iter()` instead of `.into_iter()` to avoid ambiguity: `iter`\n+   |\n+   = note: `-D array-into-iter` implied by `-D warnings`\n+   = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n+   = note: for more information, see issue #66145 <https://github.com/rust-lang/rust/issues/66145>\n+"}]}