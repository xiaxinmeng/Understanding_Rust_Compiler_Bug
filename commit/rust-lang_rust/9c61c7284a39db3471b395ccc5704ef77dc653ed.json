{"sha": "9c61c7284a39db3471b395ccc5704ef77dc653ed", "node_id": "MDY6Q29tbWl0NzI0NzEyOjljNjFjNzI4NGEzOWRiMzQ3MWIzOTVjY2M1NzA0ZWY3N2RjNjUzZWQ=", "commit": {"author": {"name": "Emilio Cobos \u00c1lvarez", "email": "emilio@crisal.io", "date": "2018-02-19T01:04:49Z"}, "committer": {"name": "Emilio Cobos \u00c1lvarez", "email": "emilio@crisal.io", "date": "2018-03-25T01:30:05Z"}, "message": "rustc_trans: Fix PGO generation linking on Linux by adding the relevant linker commands.\n\nSee the linked LLVM reviews for the clang counter-parts.\n\nSigned-off-by: Emilio Cobos \u00c1lvarez <emilio@crisal.io>", "tree": {"sha": "3cfbdfdaf11f3ac1041e35f55637098d0d4b7063", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3cfbdfdaf11f3ac1041e35f55637098d0d4b7063"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9c61c7284a39db3471b395ccc5704ef77dc653ed", "comment_count": 0, "verification": {"verified": false, "reason": "unknown_key", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQEzBAABCAAdFiEE+uMrE+H37zcdV8pyBWtye7nBAnwFAlq2+50ACgkQBWtye7nB\nAnzjJQf9GP9T6EZvH3iQ9LVnosH8vT3D7CyQ1QDfUm3IemU1QZDl9ZisJXio4UwW\nkcptLIpvAfMr3U39cjyMcrfbXXJWPavMOxmB1zHOsP2WJKifqKTvxVl8HsyjaeEU\nwYFCVujO95RiXnDTdA88cX9ko7QJJsVyr9Y5EWAsj9WujkgRipH3ZhiJw0C3Ja6l\nMBlWvkb0oUJhjJTNuIDq8yYYubQinJM5wGW8Cnw3KDKdAWwpneCrlgNdXtA/coIM\neRXjsUnffLK9+OlpSBIns/Pghsjt1bLJXvghMdIcZ+7kNauA8oe+vWrB28Beq0xI\nZiLUtPLkMrl9iT/4lwiN27B586CxqQ==\n=GmaH\n-----END PGP SIGNATURE-----", "payload": "tree 3cfbdfdaf11f3ac1041e35f55637098d0d4b7063\nparent 99127abca8c9678e14ee11bee4d46bc34ec8b164\nauthor Emilio Cobos \u00c1lvarez <emilio@crisal.io> 1519002289 +0100\ncommitter Emilio Cobos \u00c1lvarez <emilio@crisal.io> 1521941405 +0200\n\nrustc_trans: Fix PGO generation linking on Linux by adding the relevant linker commands.\n\nSee the linked LLVM reviews for the clang counter-parts.\n\nSigned-off-by: Emilio Cobos \u00c1lvarez <emilio@crisal.io>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9c61c7284a39db3471b395ccc5704ef77dc653ed", "html_url": "https://github.com/rust-lang/rust/commit/9c61c7284a39db3471b395ccc5704ef77dc653ed", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9c61c7284a39db3471b395ccc5704ef77dc653ed/comments", "author": {"login": "emilio", "id": 1323194, "node_id": "MDQ6VXNlcjEzMjMxOTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1323194?v=4", "gravatar_id": "", "url": "https://api.github.com/users/emilio", "html_url": "https://github.com/emilio", "followers_url": "https://api.github.com/users/emilio/followers", "following_url": "https://api.github.com/users/emilio/following{/other_user}", "gists_url": "https://api.github.com/users/emilio/gists{/gist_id}", "starred_url": "https://api.github.com/users/emilio/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/emilio/subscriptions", "organizations_url": "https://api.github.com/users/emilio/orgs", "repos_url": "https://api.github.com/users/emilio/repos", "events_url": "https://api.github.com/users/emilio/events{/privacy}", "received_events_url": "https://api.github.com/users/emilio/received_events", "type": "User", "site_admin": false}, "committer": {"login": "emilio", "id": 1323194, "node_id": "MDQ6VXNlcjEzMjMxOTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1323194?v=4", "gravatar_id": "", "url": "https://api.github.com/users/emilio", "html_url": "https://github.com/emilio", "followers_url": "https://api.github.com/users/emilio/followers", "following_url": "https://api.github.com/users/emilio/following{/other_user}", "gists_url": "https://api.github.com/users/emilio/gists{/gist_id}", "starred_url": "https://api.github.com/users/emilio/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/emilio/subscriptions", "organizations_url": "https://api.github.com/users/emilio/orgs", "repos_url": "https://api.github.com/users/emilio/repos", "events_url": "https://api.github.com/users/emilio/events{/privacy}", "received_events_url": "https://api.github.com/users/emilio/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "99127abca8c9678e14ee11bee4d46bc34ec8b164", "url": "https://api.github.com/repos/rust-lang/rust/commits/99127abca8c9678e14ee11bee4d46bc34ec8b164", "html_url": "https://github.com/rust-lang/rust/commit/99127abca8c9678e14ee11bee4d46bc34ec8b164"}], "stats": {"total": 14, "additions": 14, "deletions": 0}, "files": [{"sha": "657563eac2cf8718ee33b979efde473196ee76c8", "filename": "src/librustc_trans/back/link.rs", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/9c61c7284a39db3471b395ccc5704ef77dc653ed/src%2Flibrustc_trans%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9c61c7284a39db3471b395ccc5704ef77dc653ed/src%2Flibrustc_trans%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fback%2Flink.rs?ref=9c61c7284a39db3471b395ccc5704ef77dc653ed", "patch": "@@ -1085,6 +1085,20 @@ fn link_args(cmd: &mut Linker,\n         cmd.build_static_executable();\n     }\n \n+    // If we're doing PGO generation stuff and on a GNU-like linker, use the\n+    // \"-u\" flag to properly pull in the profiler runtime bits.\n+    //\n+    // This is because LLVM otherwise won't add the needed initialization for us\n+    // on Linux (though the extra flag should be harmless if it does).\n+    //\n+    // See https://reviews.llvm.org/D14033 and https://reviews.llvm.org/D14030.\n+    //\n+    // Though it may be worth to try to revert those changes upstream, since the\n+    // overhead of the initialization should be minor.\n+    if sess.opts.cg.pgo_gen.is_some() && sess.target.target.options.linker_is_gnu {\n+        cmd.args(&[\"-u\".to_owned(), \"__llvm_profile_runtime\".to_owned()]);\n+    }\n+\n     // FIXME (#2397): At some point we want to rpath our guesses as to\n     // where extern libraries might live, based on the\n     // addl_lib_search_paths"}]}