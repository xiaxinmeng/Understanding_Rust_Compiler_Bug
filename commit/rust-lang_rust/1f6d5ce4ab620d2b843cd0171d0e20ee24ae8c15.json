{"sha": "1f6d5ce4ab620d2b843cd0171d0e20ee24ae8c15", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFmNmQ1Y2U0YWI2MjBkMmI4NDNjZDAxNzFkMGUyMGVlMjRhZThjMTU=", "commit": {"author": {"name": "Yuki Okushi", "email": "huyuumi.dev@gmail.com", "date": "2020-07-24T09:56:32Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-07-24T09:56:32Z"}, "message": "Rollup merge of #74665 - smmalis37:issue-62200, r=davidtwco\n\nDon't ICE on unconstrained anonymous lifetimes inside associated types.\n\nFixes #62200. The change here is inspired (copied) by how this case is handled on bare fns at https://github.com/rust-lang/rust/blob/e8b55a4ad230ebec762fdfc4f241ba98a98560af/src/librustc_typeck/astconv.rs#L3083-L3106.", "tree": {"sha": "753430a21e794025b53275a410ac74798f78cb82", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/753430a21e794025b53275a410ac74798f78cb82"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1f6d5ce4ab620d2b843cd0171d0e20ee24ae8c15", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfGrBRCRBK7hj4Ov3rIwAAdHIIAE33akvKsg7p6S++LsRogRbS\nH8Nv2g1SRjLyagKvatjBoQIFtBl5ESIaWFJ+JGaZ82CZWem6hCjQfcS9dBBQdHe9\nqVpO2c5XqKO8IU8uq7kSGioUmmgGgb/w3rsEy32fuea0KkgcZUldd8FZonLSDF9J\n34mV+bm/f0yQJ5AAVjmVkIwRu7F3z7uny2C/zSFpXXEBAMbQLHAFmyhMuoOpSeuT\nZhLE2BeRj3l3nJtpOsSl7rJi1/9NZjJGp97EnlIhizC/ZniZhVUDFASnZHI5uQV/\ntqgLs4xqfQnf7Op6KUue4jOR0WDiLfoUk14UCC53gKZ9CyGXc/c8ITLUbMRFSxk=\n=GpCL\n-----END PGP SIGNATURE-----\n", "payload": "tree 753430a21e794025b53275a410ac74798f78cb82\nparent a02aecba211ba82e79350db9e4dcd2675fd79423\nparent bbaab63f844d64ca726a2a83c18774b3957c7169\nauthor Yuki Okushi <huyuumi.dev@gmail.com> 1595584592 +0900\ncommitter GitHub <noreply@github.com> 1595584592 +0900\n\nRollup merge of #74665 - smmalis37:issue-62200, r=davidtwco\n\nDon't ICE on unconstrained anonymous lifetimes inside associated types.\n\nFixes #62200. The change here is inspired (copied) by how this case is handled on bare fns at https://github.com/rust-lang/rust/blob/e8b55a4ad230ebec762fdfc4f241ba98a98560af/src/librustc_typeck/astconv.rs#L3083-L3106.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1f6d5ce4ab620d2b843cd0171d0e20ee24ae8c15", "html_url": "https://github.com/rust-lang/rust/commit/1f6d5ce4ab620d2b843cd0171d0e20ee24ae8c15", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1f6d5ce4ab620d2b843cd0171d0e20ee24ae8c15/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a02aecba211ba82e79350db9e4dcd2675fd79423", "url": "https://api.github.com/repos/rust-lang/rust/commits/a02aecba211ba82e79350db9e4dcd2675fd79423", "html_url": "https://github.com/rust-lang/rust/commit/a02aecba211ba82e79350db9e4dcd2675fd79423"}, {"sha": "bbaab63f844d64ca726a2a83c18774b3957c7169", "url": "https://api.github.com/repos/rust-lang/rust/commits/bbaab63f844d64ca726a2a83c18774b3957c7169", "html_url": "https://github.com/rust-lang/rust/commit/bbaab63f844d64ca726a2a83c18774b3957c7169"}], "stats": {"total": 55, "additions": 43, "deletions": 12}, "files": [{"sha": "e6d59d30e2f585331ba3bff358cf7e50acd16602", "filename": "src/librustc_typeck/astconv.rs", "status": "modified", "additions": 17, "deletions": 12, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/1f6d5ce4ab620d2b843cd0171d0e20ee24ae8c15/src%2Flibrustc_typeck%2Fastconv.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1f6d5ce4ab620d2b843cd0171d0e20ee24ae8c15/src%2Flibrustc_typeck%2Fastconv.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fastconv.rs?ref=1f6d5ce4ab620d2b843cd0171d0e20ee24ae8c15", "patch": "@@ -1485,28 +1485,33 @@ impl<'o, 'tcx> dyn AstConv<'tcx> + 'o {\n                 debug!(\"late_bound_in_ty = {:?}\", late_bound_in_ty);\n                 for br in late_bound_in_ty.difference(&late_bound_in_trait_ref) {\n                     let br_name = match *br {\n-                        ty::BrNamed(_, name) => name,\n-                        _ => {\n-                            span_bug!(\n-                                binding.span,\n-                                \"anonymous bound region {:?} in binding but not trait ref\",\n-                                br\n-                            );\n-                        }\n+                        ty::BrNamed(_, name) => format!(\"lifetime `{}`\", name),\n+                        _ => \"an anonymous lifetime\".to_string(),\n                     };\n                     // FIXME: point at the type params that don't have appropriate lifetimes:\n                     // struct S1<F: for<'a> Fn(&i32, &i32) -> &'a i32>(F);\n                     //                         ----  ----     ^^^^^^^\n-                    struct_span_err!(\n+                    let mut err = struct_span_err!(\n                         tcx.sess,\n                         binding.span,\n                         E0582,\n-                        \"binding for associated type `{}` references lifetime `{}`, \\\n+                        \"binding for associated type `{}` references {}, \\\n                          which does not appear in the trait input types\",\n                         binding.item_name,\n                         br_name\n-                    )\n-                    .emit();\n+                    );\n+\n+                    if let ty::BrAnon(_) = *br {\n+                        // The only way for an anonymous lifetime to wind up\n+                        // in the return type but **also** be unconstrained is\n+                        // if it only appears in \"associated types\" in the\n+                        // input. See #62200 for an example. In this case,\n+                        // though we can easily give a hint that ought to be\n+                        // relevant.\n+                        err.note(\"lifetimes appearing in an associated type are not considered constrained\");\n+                    }\n+\n+                    err.emit();\n                 }\n             }\n         }"}, {"sha": "9d18690e96049a189cf6190449d3d1060b762e8e", "filename": "src/test/ui/associated-types/issue-62200.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/1f6d5ce4ab620d2b843cd0171d0e20ee24ae8c15/src%2Ftest%2Fui%2Fassociated-types%2Fissue-62200.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1f6d5ce4ab620d2b843cd0171d0e20ee24ae8c15/src%2Ftest%2Fui%2Fassociated-types%2Fissue-62200.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fassociated-types%2Fissue-62200.rs?ref=1f6d5ce4ab620d2b843cd0171d0e20ee24ae8c15", "patch": "@@ -0,0 +1,15 @@\n+struct S {}\n+\n+trait T<'a> {\n+    type A;\n+}\n+\n+impl T<'_> for S {\n+    type A = u32;\n+}\n+\n+fn foo(x: impl Fn(<S as T<'_>>::A) -> <S as T<'_>>::A) {}\n+//~^ ERROR binding for associated type `Output` references an anonymous lifetime\n+//~^^ NOTE lifetimes appearing in an associated type are not considered constrained\n+\n+fn main() {}"}, {"sha": "f14cd81fdfe1f43583bb1b429d07437e93894eff", "filename": "src/test/ui/associated-types/issue-62200.stderr", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/1f6d5ce4ab620d2b843cd0171d0e20ee24ae8c15/src%2Ftest%2Fui%2Fassociated-types%2Fissue-62200.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/1f6d5ce4ab620d2b843cd0171d0e20ee24ae8c15/src%2Ftest%2Fui%2Fassociated-types%2Fissue-62200.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fassociated-types%2Fissue-62200.stderr?ref=1f6d5ce4ab620d2b843cd0171d0e20ee24ae8c15", "patch": "@@ -0,0 +1,11 @@\n+error[E0582]: binding for associated type `Output` references an anonymous lifetime, which does not appear in the trait input types\n+  --> $DIR/issue-62200.rs:11:39\n+   |\n+LL | fn foo(x: impl Fn(<S as T<'_>>::A) -> <S as T<'_>>::A) {}\n+   |                                       ^^^^^^^^^^^^^^^\n+   |\n+   = note: lifetimes appearing in an associated type are not considered constrained\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0582`."}]}