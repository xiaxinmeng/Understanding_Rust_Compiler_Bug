{"sha": "194d52cc182241348e2372dfaf96896565fb51d9", "node_id": "C_kwDOAAsO6NoAKDE5NGQ1MmNjMTgyMjQxMzQ4ZTIzNzJkZmFmOTY4OTY1NjVmYjUxZDk", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-02-20T21:12:18Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-02-20T21:12:18Z"}, "message": "Rollup merge of #108254 - Nathan-Fenner:nathanf/error-span-ref-trait-refine, r=WaffleLapkin\n\nRefine error span for trait error into borrowed expression\n\nExtends the error span refinement in #106477 to drill into borrowed expressions just like tuples/struct/enum literals. For example,\n\n```rs\ntrait Fancy {}\ntrait Good {}\nimpl <'a, T> Fancy for &'a T where T: Good {}\nimpl <S> Good for Option<S> where S: Iterator {}\n\nfn want_fancy<F>(f: F) where F: Fancy {}\n\nfn example() {\n    want_fancy(&Some(5));\n//  (BEFORE)   ^^^^^^^^ `{integer}` is not an iterator\n//  (AFTER)          ^  `{integer}` is not an iterator\n}\n```\n\nExisting heuristics try to find the right part of the expression to \"point at\"; current heuristics look at e.g. struct constructors and tuples. This PR adds a new check for borrowed expressions when looking into a borrowed type.", "tree": {"sha": "2ba84089967739288c8b724beab42355bc3e674c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2ba84089967739288c8b724beab42355bc3e674c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/194d52cc182241348e2372dfaf96896565fb51d9", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJj8+IyCRBK7hj4Ov3rIwAAB0gIAGqDH92uTwkxfieR5Z4P/Eii\nh/9vOxtrC1aM8FAzPI/qQju7ovQgwJowJGwnTWfD1JRgYkWohl2ZlL0jlxHohOtq\n08wgF96DUrOdRavu6t+aub7fDX/uTkVmVfAsADB4ceepHigwFntHy7IA/HNsotAu\nPZiDq70tm4506lwYxGcYWssrwQ9w6SOO9SQM0yMCYD6m9aj+2h6+77nLkbv5PatQ\ncAqBQ78O1N+WvN302IQTQ1WrFqohvY3iyh1ZWj2G/z8T50hRj31O8RRuzmoTluIS\nB/bhOx37QrdrI9gOhCpBz8Ni7OESr1uVtlC92zehwPTG2+D59PsaBhsscRubpUM=\n=Tbiw\n-----END PGP SIGNATURE-----\n", "payload": "tree 2ba84089967739288c8b724beab42355bc3e674c\nparent 52fa8fe376de2bf9ad5ae39aba018f9b965e6194\nparent fbcca2aaf0280190111982e931bc113b21f7ec0d\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1676927538 +0100\ncommitter GitHub <noreply@github.com> 1676927538 +0100\n\nRollup merge of #108254 - Nathan-Fenner:nathanf/error-span-ref-trait-refine, r=WaffleLapkin\n\nRefine error span for trait error into borrowed expression\n\nExtends the error span refinement in #106477 to drill into borrowed expressions just like tuples/struct/enum literals. For example,\n\n```rs\ntrait Fancy {}\ntrait Good {}\nimpl <'a, T> Fancy for &'a T where T: Good {}\nimpl <S> Good for Option<S> where S: Iterator {}\n\nfn want_fancy<F>(f: F) where F: Fancy {}\n\nfn example() {\n    want_fancy(&Some(5));\n//  (BEFORE)   ^^^^^^^^ `{integer}` is not an iterator\n//  (AFTER)          ^  `{integer}` is not an iterator\n}\n```\n\nExisting heuristics try to find the right part of the expression to \"point at\"; current heuristics look at e.g. struct constructors and tuples. This PR adds a new check for borrowed expressions when looking into a borrowed type.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/194d52cc182241348e2372dfaf96896565fb51d9", "html_url": "https://github.com/rust-lang/rust/commit/194d52cc182241348e2372dfaf96896565fb51d9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/194d52cc182241348e2372dfaf96896565fb51d9/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "52fa8fe376de2bf9ad5ae39aba018f9b965e6194", "url": "https://api.github.com/repos/rust-lang/rust/commits/52fa8fe376de2bf9ad5ae39aba018f9b965e6194", "html_url": "https://github.com/rust-lang/rust/commit/52fa8fe376de2bf9ad5ae39aba018f9b965e6194"}, {"sha": "fbcca2aaf0280190111982e931bc113b21f7ec0d", "url": "https://api.github.com/repos/rust-lang/rust/commits/fbcca2aaf0280190111982e931bc113b21f7ec0d", "html_url": "https://github.com/rust-lang/rust/commit/fbcca2aaf0280190111982e931bc113b21f7ec0d"}], "stats": {"total": 83, "additions": 67, "deletions": 16}, "files": [{"sha": "39e0ea98f96e3263f9bb01624164ca1b0da92007", "filename": "compiler/rustc_hir_typeck/src/fn_ctxt/adjust_fulfillment_errors.rs", "status": "modified", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/194d52cc182241348e2372dfaf96896565fb51d9/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2Fadjust_fulfillment_errors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/194d52cc182241348e2372dfaf96896565fb51d9/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2Fadjust_fulfillment_errors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2Fadjust_fulfillment_errors.rs?ref=194d52cc182241348e2372dfaf96896565fb51d9", "patch": "@@ -549,6 +549,19 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n             return Err(expr);\n         };\n \n+        if let (\n+            hir::ExprKind::AddrOf(_borrow_kind, _borrow_mutability, borrowed_expr),\n+            ty::Ref(_ty_region, ty_ref_type, _ty_mutability),\n+        ) = (&expr.kind, in_ty.kind())\n+        {\n+            // We can \"drill into\" the borrowed expression.\n+            return self.blame_specific_part_of_expr_corresponding_to_generic_param(\n+                param,\n+                borrowed_expr,\n+                (*ty_ref_type).into(),\n+            );\n+        }\n+\n         if let (hir::ExprKind::Tup(expr_elements), ty::Tuple(in_ty_elements)) =\n             (&expr.kind, in_ty.kind())\n         {"}, {"sha": "6fea409ed4716244a484c2ba1c86f3ff4c86e76c", "filename": "tests/ui/errors/traits/blame-trait-error-spans-on-exprs.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/194d52cc182241348e2372dfaf96896565fb51d9/tests%2Fui%2Ferrors%2Ftraits%2Fblame-trait-error-spans-on-exprs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/194d52cc182241348e2372dfaf96896565fb51d9/tests%2Fui%2Ferrors%2Ftraits%2Fblame-trait-error-spans-on-exprs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ferrors%2Ftraits%2Fblame-trait-error-spans-on-exprs.rs?ref=194d52cc182241348e2372dfaf96896565fb51d9", "patch": "@@ -71,6 +71,8 @@ struct DoubleWrapper<T> {\n \n impl<T: T1> T1 for DoubleWrapper<T> {}\n \n+impl<'a, T: T2> T1 for &'a T {}\n+\n fn example<Q>(q: Q) {\n     // In each of the following examples, we expect the error span to point at the 'q' variable,\n     // since the missing constraint is `Q: T3`.\n@@ -126,6 +128,10 @@ fn example<Q>(q: Q) {\n         Two { a: Two { a: (), b: Two { a: Two { a: (), b: q }, b: () } }, b: () },\n         //~^ ERROR the trait bound `Q: T1` is not satisfied [E0277]\n     );\n+\n+    // Verifies for reference:\n+    want(&Burrito { spicy: false, filling: q });\n+    //~^ ERROR the trait bound `Q: T3` is not satisfied [E0277]\n }\n \n fn main() {}"}, {"sha": "6913771f2883e020f23898696f41545245c73246", "filename": "tests/ui/errors/traits/blame-trait-error-spans-on-exprs.stderr", "status": "modified", "additions": 46, "deletions": 14, "changes": 60, "blob_url": "https://github.com/rust-lang/rust/blob/194d52cc182241348e2372dfaf96896565fb51d9/tests%2Fui%2Ferrors%2Ftraits%2Fblame-trait-error-spans-on-exprs.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/194d52cc182241348e2372dfaf96896565fb51d9/tests%2Fui%2Ferrors%2Ftraits%2Fblame-trait-error-spans-on-exprs.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ferrors%2Ftraits%2Fblame-trait-error-spans-on-exprs.stderr?ref=194d52cc182241348e2372dfaf96896565fb51d9", "patch": "@@ -1,5 +1,5 @@\n error[E0277]: the trait bound `Q: T3` is not satisfied\n-  --> $DIR/blame-trait-error-spans-on-exprs.rs:79:60\n+  --> $DIR/blame-trait-error-spans-on-exprs.rs:81:60\n    |\n LL |     want(Wrapper { value: Burrito { spicy: false, filling: q } });\n    |     ---- required by a bound introduced by this call       ^ the trait `T3` is not implemented for `Q`\n@@ -29,7 +29,7 @@ LL | fn example<Q: T3>(q: Q) {\n    |             ++++\n \n error[E0277]: the trait bound `Q: T3` is not satisfied\n-  --> $DIR/blame-trait-error-spans-on-exprs.rs:83:84\n+  --> $DIR/blame-trait-error-spans-on-exprs.rs:85:84\n    |\n LL |     want(Wrapper { value: BurritoKinds::SmallBurrito { spicy: true, small_filling: q } });\n    |     ---- required by a bound introduced by this call                               ^ the trait `T3` is not implemented for `Q`\n@@ -59,7 +59,7 @@ LL | fn example<Q: T3>(q: Q) {\n    |             ++++\n \n error[E0277]: the trait bound `Q: T3` is not satisfied\n-  --> $DIR/blame-trait-error-spans-on-exprs.rs:87:39\n+  --> $DIR/blame-trait-error-spans-on-exprs.rs:89:39\n    |\n LL |     want(Wrapper { value: Taco(false, q) });\n    |     ----                              ^ the trait `T3` is not implemented for `Q`\n@@ -91,7 +91,7 @@ LL | fn example<Q: T3>(q: Q) {\n    |             ++++\n \n error[E0277]: the trait bound `Q: T3` is not satisfied\n-  --> $DIR/blame-trait-error-spans-on-exprs.rs:91:27\n+  --> $DIR/blame-trait-error-spans-on-exprs.rs:93:27\n    |\n LL |     want(Wrapper { value: TacoKinds::OneTaco(false, q) });\n    |     ----                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^ the trait `T3` is not implemented for `Q`\n@@ -123,7 +123,7 @@ LL | fn example<Q: T3>(q: Q) {\n    |             ++++\n \n error[E0277]: the trait bound `Q: T3` is not satisfied\n-  --> $DIR/blame-trait-error-spans-on-exprs.rs:95:74\n+  --> $DIR/blame-trait-error-spans-on-exprs.rs:97:74\n    |\n LL |     want(Wrapper { value: GenericBurrito { spiciness: NotSpicy, filling: q } });\n    |     ---- required by a bound introduced by this call                     ^ the trait `T3` is not implemented for `Q`\n@@ -153,7 +153,7 @@ LL | fn example<Q: T3>(q: Q) {\n    |             ++++\n \n error[E0277]: the trait bound `Q: T2` is not satisfied\n-  --> $DIR/blame-trait-error-spans-on-exprs.rs:99:14\n+  --> $DIR/blame-trait-error-spans-on-exprs.rs:101:14\n    |\n LL |     want((3, q));\n    |     ----     ^ the trait `T2` is not implemented for `Q`\n@@ -178,7 +178,7 @@ LL | fn example<Q: T2>(q: Q) {\n    |             ++++\n \n error[E0277]: the trait bound `Q: T3` is not satisfied\n-  --> $DIR/blame-trait-error-spans-on-exprs.rs:103:31\n+  --> $DIR/blame-trait-error-spans-on-exprs.rs:105:31\n    |\n LL |     want(Wrapper { value: (3, q) });\n    |     ----                      ^ the trait `T3` is not implemented for `Q`\n@@ -210,7 +210,7 @@ LL | fn example<Q: T3>(q: Q) {\n    |             ++++\n \n error[E0277]: the trait bound `Q: T3` is not satisfied\n-  --> $DIR/blame-trait-error-spans-on-exprs.rs:107:15\n+  --> $DIR/blame-trait-error-spans-on-exprs.rs:109:15\n    |\n LL |     want(((3, q), 5));\n    |     ----      ^ the trait `T3` is not implemented for `Q`\n@@ -242,7 +242,7 @@ LL | fn example<Q: T3>(q: Q) {\n    |             ++++\n \n error[E0277]: the trait bound `Q: T1` is not satisfied\n-  --> $DIR/blame-trait-error-spans-on-exprs.rs:110:49\n+  --> $DIR/blame-trait-error-spans-on-exprs.rs:112:49\n    |\n LL |     want(DoubleWrapper { item: Wrapper { value: q } });\n    |     ----                                        ^ the trait `T1` is not implemented for `Q`\n@@ -267,7 +267,7 @@ LL | fn example<Q: T1>(q: Q) {\n    |             ++++\n \n error[E0277]: the trait bound `Q: T1` is not satisfied\n-  --> $DIR/blame-trait-error-spans-on-exprs.rs:113:88\n+  --> $DIR/blame-trait-error-spans-on-exprs.rs:115:88\n    |\n LL |     want(DoubleWrapper { item: Wrapper { value: DoubleWrapper { item: Wrapper { value: q } } } });\n    |     ---- required by a bound introduced by this call                                   ^ the trait `T1` is not implemented for `Q`\n@@ -292,7 +292,7 @@ LL | fn example<Q: T1>(q: Q) {\n    |             ++++\n \n error[E0277]: the trait bound `Q: T3` is not satisfied\n-  --> $DIR/blame-trait-error-spans-on-exprs.rs:117:27\n+  --> $DIR/blame-trait-error-spans-on-exprs.rs:119:27\n    |\n LL |     want(Wrapper { value: AliasBurrito { spiciness: q, filling: q } });\n    |     ----                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ the trait `T3` is not implemented for `Q`\n@@ -324,7 +324,7 @@ LL | fn example<Q: T3>(q: Q) {\n    |             ++++\n \n error[E0277]: the trait bound `Q: T1` is not satisfied\n-  --> $DIR/blame-trait-error-spans-on-exprs.rs:120:35\n+  --> $DIR/blame-trait-error-spans-on-exprs.rs:122:35\n    |\n LL |     want(Two { a: Two { a: (), b: q }, b: () });\n    |     ----                          ^ the trait `T1` is not implemented for `Q`\n@@ -349,7 +349,7 @@ LL | fn example<Q: T1>(q: Q) {\n    |             ++++\n \n error[E0277]: the trait bound `Q: T1` is not satisfied\n-  --> $DIR/blame-trait-error-spans-on-exprs.rs:126:59\n+  --> $DIR/blame-trait-error-spans-on-exprs.rs:128:59\n    |\n LL |     want(\n    |     ---- required by a bound introduced by this call\n@@ -375,6 +375,38 @@ help: consider restricting type parameter `Q`\n LL | fn example<Q: T1>(q: Q) {\n    |             ++++\n \n-error: aborting due to 13 previous errors\n+error[E0277]: the trait bound `Q: T3` is not satisfied\n+  --> $DIR/blame-trait-error-spans-on-exprs.rs:133:44\n+   |\n+LL |     want(&Burrito { spicy: false, filling: q });\n+   |     ----                                   ^ the trait `T3` is not implemented for `Q`\n+   |     |\n+   |     required by a bound introduced by this call\n+   |\n+note: required for `Burrito<Q>` to implement `T2`\n+  --> $DIR/blame-trait-error-spans-on-exprs.rs:22:13\n+   |\n+LL | impl<A: T3> T2 for Burrito<A> {}\n+   |         --  ^^     ^^^^^^^^^^\n+   |         |\n+   |         unsatisfied trait bound introduced here\n+note: required for `&Burrito<Q>` to implement `T1`\n+  --> $DIR/blame-trait-error-spans-on-exprs.rs:74:17\n+   |\n+LL | impl<'a, T: T2> T1 for &'a T {}\n+   |             --  ^^     ^^^^^\n+   |             |\n+   |             unsatisfied trait bound introduced here\n+note: required by a bound in `want`\n+  --> $DIR/blame-trait-error-spans-on-exprs.rs:53:12\n+   |\n+LL | fn want<V: T1>(_x: V) {}\n+   |            ^^ required by this bound in `want`\n+help: consider restricting type parameter `Q`\n+   |\n+LL | fn example<Q: T3>(q: Q) {\n+   |             ++++\n+\n+error: aborting due to 14 previous errors\n \n For more information about this error, try `rustc --explain E0277`."}, {"sha": "49105de3d691dd395b7f7f450c8fba5b862d69a6", "filename": "tests/ui/traits/suggest-deferences/issue-39029.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/194d52cc182241348e2372dfaf96896565fb51d9/tests%2Fui%2Ftraits%2Fsuggest-deferences%2Fissue-39029.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/194d52cc182241348e2372dfaf96896565fb51d9/tests%2Fui%2Ftraits%2Fsuggest-deferences%2Fissue-39029.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ftraits%2Fsuggest-deferences%2Fissue-39029.stderr?ref=194d52cc182241348e2372dfaf96896565fb51d9", "patch": "@@ -1,8 +1,8 @@\n error[E0277]: the trait bound `NoToSocketAddrs: ToSocketAddrs` is not satisfied\n-  --> $DIR/issue-39029.rs:16:37\n+  --> $DIR/issue-39029.rs:16:38\n    |\n LL |     let _errors = TcpListener::bind(&bad);\n-   |                   ----------------- ^^^^ the trait `ToSocketAddrs` is not implemented for `NoToSocketAddrs`\n+   |                   -----------------  ^^^ the trait `ToSocketAddrs` is not implemented for `NoToSocketAddrs`\n    |                   |\n    |                   required by a bound introduced by this call\n    |"}]}