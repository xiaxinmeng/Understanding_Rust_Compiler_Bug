{"sha": "065c6f78e7b4089ad93eafb0c0c478bbfaa00db8", "node_id": "C_kwDOAAsO6NoAKDA2NWM2Zjc4ZTdiNDA4OWFkOTNlYWZiMGMwYzQ3OGJiZmFhMDBkYjg", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-12-21T19:39:32Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-12-21T19:39:32Z"}, "message": "Auto merge of #10091 - EricWu2003:manual-filter-FP, r=llogiq\n\nfix manual_filter false positive\n\nfixes #10088\nfixes #9766\n\nchangelog: FP: [`manual_filter`]: Now ignores if expressions where the else branch has side effects or doesn't return `None`\n[#10091](https://github.com/rust-lang/rust-clippy/pull/10091)\n<!-- changelog_checked -->", "tree": {"sha": "ab51f01c32de3dd49e2714b609f9eec2ec1866c7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ab51f01c32de3dd49e2714b609f9eec2ec1866c7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/065c6f78e7b4089ad93eafb0c0c478bbfaa00db8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/065c6f78e7b4089ad93eafb0c0c478bbfaa00db8", "html_url": "https://github.com/rust-lang/rust/commit/065c6f78e7b4089ad93eafb0c0c478bbfaa00db8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/065c6f78e7b4089ad93eafb0c0c478bbfaa00db8/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4a09068f878334c73a5a1fbfc455931593f1564e", "url": "https://api.github.com/repos/rust-lang/rust/commits/4a09068f878334c73a5a1fbfc455931593f1564e", "html_url": "https://github.com/rust-lang/rust/commit/4a09068f878334c73a5a1fbfc455931593f1564e"}, {"sha": "3c14075b465bdfa7e6b402ebba8cac6766b3dcdf", "url": "https://api.github.com/repos/rust-lang/rust/commits/3c14075b465bdfa7e6b402ebba8cac6766b3dcdf", "html_url": "https://github.com/rust-lang/rust/commit/3c14075b465bdfa7e6b402ebba8cac6766b3dcdf"}], "stats": {"total": 99, "additions": 93, "deletions": 6}, "files": [{"sha": "f6bf0e7aa1ad9bcfb17c896b116bdab9df215cae", "filename": "clippy_lints/src/matches/manual_filter.rs", "status": "modified", "additions": 11, "deletions": 6, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/065c6f78e7b4089ad93eafb0c0c478bbfaa00db8/clippy_lints%2Fsrc%2Fmatches%2Fmanual_filter.rs", "raw_url": "https://github.com/rust-lang/rust/raw/065c6f78e7b4089ad93eafb0c0c478bbfaa00db8/clippy_lints%2Fsrc%2Fmatches%2Fmanual_filter.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmatches%2Fmanual_filter.rs?ref=065c6f78e7b4089ad93eafb0c0c478bbfaa00db8", "patch": "@@ -3,7 +3,7 @@ use clippy_utils::ty::is_type_diagnostic_item;\n use clippy_utils::visitors::contains_unsafe_block;\n use clippy_utils::{is_res_lang_ctor, path_res, path_to_local_id};\n \n-use rustc_hir::LangItem::OptionSome;\n+use rustc_hir::LangItem::{OptionNone, OptionSome};\n use rustc_hir::{Arm, Expr, ExprKind, HirId, Pat, PatKind};\n use rustc_lint::LateContext;\n use rustc_span::{sym, SyntaxContext};\n@@ -25,15 +25,13 @@ fn get_cond_expr<'tcx>(\n         if let Some(block_expr) = peels_blocks_incl_unsafe_opt(expr);\n         if let ExprKind::If(cond, then_expr, Some(else_expr)) = block_expr.kind;\n         if let PatKind::Binding(_,target, ..) = pat.kind;\n-        if let (then_visitor, else_visitor)\n-            = (is_some_expr(cx, target, ctxt, then_expr),\n-                is_some_expr(cx, target, ctxt, else_expr));\n-        if then_visitor != else_visitor; // check that one expr resolves to `Some(x)`, the other to `None`\n+        if is_some_expr(cx, target, ctxt, then_expr) && is_none_expr(cx, else_expr)\n+            || is_none_expr(cx, then_expr) && is_some_expr(cx, target, ctxt, else_expr); // check that one expr resolves to `Some(x)`, the other to `None`\n         then {\n             return Some(SomeExpr {\n                     expr: peels_blocks_incl_unsafe(cond.peel_drop_temps()),\n                     needs_unsafe_block: contains_unsafe_block(cx, expr),\n-                    needs_negated: !then_visitor // if the `then_expr` resolves to `None`, need to negate the cond\n+                    needs_negated: is_none_expr(cx, then_expr) // if the `then_expr` resolves to `None`, need to negate the cond\n                 })\n             }\n     };\n@@ -74,6 +72,13 @@ fn is_some_expr(cx: &LateContext<'_>, target: HirId, ctxt: SyntaxContext, expr:\n     false\n }\n \n+fn is_none_expr(cx: &LateContext<'_>, expr: &Expr<'_>) -> bool {\n+    if let Some(inner_expr) = peels_blocks_incl_unsafe_opt(expr) {\n+        return is_res_lang_ctor(cx, path_res(cx, inner_expr), OptionNone);\n+    };\n+    false\n+}\n+\n // given the closure: `|<pattern>| <expr>`\n // returns `|&<pattern>| <expr>`\n fn add_ampersand_if_copy(body_str: String, has_copy_trait: bool) -> String {"}, {"sha": "ef6780dc96d9c8f74ec38a3d90767d0b3307710f", "filename": "tests/ui/manual_filter.fixed", "status": "modified", "additions": 41, "deletions": 0, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/065c6f78e7b4089ad93eafb0c0c478bbfaa00db8/tests%2Fui%2Fmanual_filter.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/065c6f78e7b4089ad93eafb0c0c478bbfaa00db8/tests%2Fui%2Fmanual_filter.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmanual_filter.fixed?ref=065c6f78e7b4089ad93eafb0c0c478bbfaa00db8", "patch": "@@ -116,4 +116,45 @@ fn main() {\n         },\n         None => None,\n     };\n+\n+    match Some(20) {\n+        // Don't Lint, because `Some(3*x)` is not `None`\n+        None => None,\n+        Some(x) => {\n+            if x > 0 {\n+                Some(3 * x)\n+            } else {\n+                Some(x)\n+            }\n+        },\n+    };\n+\n+    // Don't lint: https://github.com/rust-lang/rust-clippy/issues/10088\n+    let result = if let Some(a) = maybe_some() {\n+        if let Some(b) = maybe_some() {\n+            Some(a + b)\n+        } else {\n+            Some(a)\n+        }\n+    } else {\n+        None\n+    };\n+\n+    let allowed_integers = vec![3, 4, 5, 6];\n+    // Don't lint, since there's a side effect in the else branch\n+    match Some(21) {\n+        Some(x) => {\n+            if allowed_integers.contains(&x) {\n+                Some(x)\n+            } else {\n+                println!(\"Invalid integer: {x:?}\");\n+                None\n+            }\n+        },\n+        None => None,\n+    };\n+}\n+\n+fn maybe_some() -> Option<u32> {\n+    Some(0)\n }"}, {"sha": "ea0ce83172b7dd4af1469185d0c22f5b68c52717", "filename": "tests/ui/manual_filter.rs", "status": "modified", "additions": 41, "deletions": 0, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/065c6f78e7b4089ad93eafb0c0c478bbfaa00db8/tests%2Fui%2Fmanual_filter.rs", "raw_url": "https://github.com/rust-lang/rust/raw/065c6f78e7b4089ad93eafb0c0c478bbfaa00db8/tests%2Fui%2Fmanual_filter.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmanual_filter.rs?ref=065c6f78e7b4089ad93eafb0c0c478bbfaa00db8", "patch": "@@ -240,4 +240,45 @@ fn main() {\n         },\n         None => None,\n     };\n+\n+    match Some(20) {\n+        // Don't Lint, because `Some(3*x)` is not `None`\n+        None => None,\n+        Some(x) => {\n+            if x > 0 {\n+                Some(3 * x)\n+            } else {\n+                Some(x)\n+            }\n+        },\n+    };\n+\n+    // Don't lint: https://github.com/rust-lang/rust-clippy/issues/10088\n+    let result = if let Some(a) = maybe_some() {\n+        if let Some(b) = maybe_some() {\n+            Some(a + b)\n+        } else {\n+            Some(a)\n+        }\n+    } else {\n+        None\n+    };\n+\n+    let allowed_integers = vec![3, 4, 5, 6];\n+    // Don't lint, since there's a side effect in the else branch\n+    match Some(21) {\n+        Some(x) => {\n+            if allowed_integers.contains(&x) {\n+                Some(x)\n+            } else {\n+                println!(\"Invalid integer: {x:?}\");\n+                None\n+            }\n+        },\n+        None => None,\n+    };\n+}\n+\n+fn maybe_some() -> Option<u32> {\n+    Some(0)\n }"}]}