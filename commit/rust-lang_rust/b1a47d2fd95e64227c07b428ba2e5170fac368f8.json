{"sha": "b1a47d2fd95e64227c07b428ba2e5170fac368f8", "node_id": "C_kwDOAAsO6NoAKGIxYTQ3ZDJmZDk1ZTY0MjI3YzA3YjQyOGJhMmU1MTcwZmFjMzY4Zjg", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-11-04T23:02:05Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-11-04T23:02:05Z"}, "message": "Rollup merge of #103956 - JakobDegen:tidy-bless, r=jyn514\n\nMake mir opt unused file check blessable\n\nMakes it slightly nicer to work with.\n\nCan't write automated test but tested locally via\n\n```\n$ touch src/test/mir-opt/random\n$ x test tidy // shows failure\n$ x test tidy --bless // file gone\n```\n\nr? `@jyn514`", "tree": {"sha": "dacc45b199cf97a0bd8795576d89d0b2e23fc031", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/dacc45b199cf97a0bd8795576d89d0b2e23fc031"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b1a47d2fd95e64227c07b428ba2e5170fac368f8", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjZZntCRBK7hj4Ov3rIwAA/XAIAGb+/qwL7L51lNVwXb49alNr\nvtHDheAhOC99gmD6jJAA9tQXQ8A1y0UplcoM1NU7d90S1jqp8wrULAQcggylqwsx\nudjiiMkunvTkZzCpeDwe/UP0Xy3qHCRMxBolf7sforZf9vZuzkmb/idRR253XD8+\n4uI6nZsaL/xlWxemXplTz6E3K0IL3Tiow4Y2Z6CW8F/+QUxGs+b2dZKCdX50HkL6\n8G79kDGi5nMyF2AIaMSQF1MrI0SZp0XXr56zL0pDBn2jmC0/ULs3lEsNPRi6ybpc\naZleiIjURC3TcWxKtOW0I25kC6Uu2pSPZouAFPRUQjGhbYbRuuWB6LJ7F8QelLk=\n=S3Y6\n-----END PGP SIGNATURE-----\n", "payload": "tree dacc45b199cf97a0bd8795576d89d0b2e23fc031\nparent 7b518af5d92e1f5aa4ff9946cc1fa17bd4fa9cdd\nparent d98cce19b28f37a457db3d27ff5ade33f32bcaa4\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1667602925 +0100\ncommitter GitHub <noreply@github.com> 1667602925 +0100\n\nRollup merge of #103956 - JakobDegen:tidy-bless, r=jyn514\n\nMake mir opt unused file check blessable\n\nMakes it slightly nicer to work with.\n\nCan't write automated test but tested locally via\n\n```\n$ touch src/test/mir-opt/random\n$ x test tidy // shows failure\n$ x test tidy --bless // file gone\n```\n\nr? `@jyn514`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b1a47d2fd95e64227c07b428ba2e5170fac368f8", "html_url": "https://github.com/rust-lang/rust/commit/b1a47d2fd95e64227c07b428ba2e5170fac368f8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b1a47d2fd95e64227c07b428ba2e5170fac368f8/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7b518af5d92e1f5aa4ff9946cc1fa17bd4fa9cdd", "url": "https://api.github.com/repos/rust-lang/rust/commits/7b518af5d92e1f5aa4ff9946cc1fa17bd4fa9cdd", "html_url": "https://github.com/rust-lang/rust/commit/7b518af5d92e1f5aa4ff9946cc1fa17bd4fa9cdd"}, {"sha": "d98cce19b28f37a457db3d27ff5ade33f32bcaa4", "url": "https://api.github.com/repos/rust-lang/rust/commits/d98cce19b28f37a457db3d27ff5ade33f32bcaa4", "html_url": "https://github.com/rust-lang/rust/commit/d98cce19b28f37a457db3d27ff5ade33f32bcaa4"}], "stats": {"total": 18, "additions": 11, "deletions": 7}, "files": [{"sha": "018573284ea7959f6db074e64a11226a21ea8c69", "filename": "src/tools/tidy/src/mir_opt_tests.rs", "status": "modified", "additions": 11, "deletions": 7, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/b1a47d2fd95e64227c07b428ba2e5170fac368f8/src%2Ftools%2Ftidy%2Fsrc%2Fmir_opt_tests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b1a47d2fd95e64227c07b428ba2e5170fac368f8/src%2Ftools%2Ftidy%2Fsrc%2Fmir_opt_tests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Fmir_opt_tests.rs?ref=b1a47d2fd95e64227c07b428ba2e5170fac368f8", "patch": "@@ -3,7 +3,7 @@\n use std::collections::HashSet;\n use std::path::{Path, PathBuf};\n \n-fn check_unused_files(path: &Path, bad: &mut bool) {\n+fn check_unused_files(path: &Path, bless: bool, bad: &mut bool) {\n     let mut rs_files = Vec::<PathBuf>::new();\n     let mut output_files = HashSet::<PathBuf>::new();\n     let files = walkdir::WalkDir::new(&path.join(\"test/mir-opt\")).into_iter();\n@@ -27,11 +27,15 @@ fn check_unused_files(path: &Path, bad: &mut bool) {\n \n     for extra in output_files {\n         if extra.file_name() != Some(\"README.md\".as_ref()) {\n-            tidy_error!(\n-                bad,\n-                \"the following output file is not associated with any mir-opt test, you can remove it: {}\",\n-                extra.display()\n-            );\n+            if !bless {\n+                tidy_error!(\n+                    bad,\n+                    \"the following output file is not associated with any mir-opt test, you can remove it: {}\",\n+                    extra.display()\n+                );\n+            } else {\n+                let _ = std::fs::remove_file(extra);\n+            }\n         }\n     }\n }\n@@ -65,6 +69,6 @@ fn check_dash_files(path: &Path, bless: bool, bad: &mut bool) {\n }\n \n pub fn check(path: &Path, bless: bool, bad: &mut bool) {\n-    check_unused_files(path, bad);\n+    check_unused_files(path, bless, bad);\n     check_dash_files(path, bless, bad);\n }"}]}