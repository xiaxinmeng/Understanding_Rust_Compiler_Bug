{"sha": "9845a41233903435ac0be22c4f6e9723667b429c", "node_id": "C_kwDOAAsO6NoAKDk4NDVhNDEyMzM5MDM0MzVhYzBiZTIyYzRmNmU5NzIzNjY3YjQyOWM", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2022-05-24T03:18:32Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-05-24T03:18:32Z"}, "message": "Rollup merge of #97290 - jyn514:fast-submodules, r=Mark-Simulacrum\n\nTurn on `fast_submodules` unconditionally\n\nI don't know why anyone would turn this off; doing so makes builds much slower (nearly a 60x slowdown according to #49057).\nRemove the option to do so, which makes bootstrap a little easier to maintain.\n\nBootstrap continues to allow you to manage submodules manually by setting `submodules = false`.", "tree": {"sha": "dd25021382fcbe989dc74fc196611c40bb62f05a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/dd25021382fcbe989dc74fc196611c40bb62f05a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9845a41233903435ac0be22c4f6e9723667b429c", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJijE6ICRBK7hj4Ov3rIwAAy9wIABsnnL4ilcvdocb6XuOjaKyw\nwR2wvSZq+OuYEOxPJ16gl3DHKL8nzN+VLBfJyxwwvd99bCY9XFdKpu62y60TwVK9\nMf+00HsoEziqTPCps0zN4rGAAPykJY3BLIm8qMC60eS2rDlkl37q53ippF/TYGbU\nVVL/NkL+pweIHawRZB40mBA15XG51o/ViHYjYqbxq3VTdX/KBtEg0aIeBeQJvDnn\n6BPZykpxo1ASRifOXxyXrCFb85LXfEZSo6M01mBb77ZLXkkYj/8cWXGWmEs5HndE\nAd67sYdHDxxtVclxrnRMZEE+V8ArSzGTqbUF0qA/Aj1nlqHFVDPb2WG5+YywdYQ=\n=qyMR\n-----END PGP SIGNATURE-----\n", "payload": "tree dd25021382fcbe989dc74fc196611c40bb62f05a\nparent 3157e1f4bd0a86a16fccd62197b09b4d14287d1d\nparent 5df276eef56171a063a230414c07cf38e67f3838\nauthor Yuki Okushi <jtitor@2k36.org> 1653362312 +0900\ncommitter GitHub <noreply@github.com> 1653362312 +0900\n\nRollup merge of #97290 - jyn514:fast-submodules, r=Mark-Simulacrum\n\nTurn on `fast_submodules` unconditionally\n\nI don't know why anyone would turn this off; doing so makes builds much slower (nearly a 60x slowdown according to #49057).\nRemove the option to do so, which makes bootstrap a little easier to maintain.\n\nBootstrap continues to allow you to manage submodules manually by setting `submodules = false`.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9845a41233903435ac0be22c4f6e9723667b429c", "html_url": "https://github.com/rust-lang/rust/commit/9845a41233903435ac0be22c4f6e9723667b429c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9845a41233903435ac0be22c4f6e9723667b429c/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3157e1f4bd0a86a16fccd62197b09b4d14287d1d", "url": "https://api.github.com/repos/rust-lang/rust/commits/3157e1f4bd0a86a16fccd62197b09b4d14287d1d", "html_url": "https://github.com/rust-lang/rust/commit/3157e1f4bd0a86a16fccd62197b09b4d14287d1d"}, {"sha": "5df276eef56171a063a230414c07cf38e67f3838", "url": "https://api.github.com/repos/rust-lang/rust/commits/5df276eef56171a063a230414c07cf38e67f3838", "html_url": "https://github.com/rust-lang/rust/commit/5df276eef56171a063a230414c07cf38e67f3838"}], "stats": {"total": 78, "additions": 30, "deletions": 48}, "files": [{"sha": "a7968bca7be89cc91149171fd52bff14a215323b", "filename": "config.toml.example", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/9845a41233903435ac0be22c4f6e9723667b429c/config.toml.example", "raw_url": "https://github.com/rust-lang/rust/raw/9845a41233903435ac0be22c4f6e9723667b429c/config.toml.example", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/config.toml.example?ref=9845a41233903435ac0be22c4f6e9723667b429c", "patch": "@@ -240,10 +240,6 @@ changelog-seen = 2\n # Indicate whether git submodules are managed and updated automatically.\n #submodules = true\n \n-# Update git submodules only when the checked out commit in the submodules differs\n-# from what is committed in the main rustc repo.\n-#fast-submodules = true\n-\n # The path to (or name of) the GDB executable to use. This is only used for\n # executing the debuginfo test suite.\n #gdb = \"gdb\""}, {"sha": "add73ebd44b8c399d65c502203b45b1408982990", "filename": "src/bootstrap/CHANGELOG.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/9845a41233903435ac0be22c4f6e9723667b429c/src%2Fbootstrap%2FCHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/9845a41233903435ac0be22c4f6e9723667b429c/src%2Fbootstrap%2FCHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2FCHANGELOG.md?ref=9845a41233903435ac0be22c4f6e9723667b429c", "patch": "@@ -11,6 +11,7 @@ The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/).\n - The options `infodir`, `localstatedir`, and `gpg-password-file` are no longer allowed in config.toml. Previously, they were ignored without warning. Note that `infodir` and `localstatedir` are still accepted by `./configure`, with a warning. [#82451](https://github.com/rust-lang/rust/pull/82451)\n - Add options for enabling overflow checks, one for std (`overflow-checks-std`) and one for everything else (`overflow-checks`). Both default to false.\n - Change the names for `dist` commands to match the component they generate. [#90684](https://github.com/rust-lang/rust/pull/90684)\n+- The `build.fast-submodules` option has been removed. Fast submodule checkouts are enabled unconditionally. Automatic submodule handling can still be disabled with `build.submodules = false`.\n \n ### Non-breaking changes\n "}, {"sha": "916c8e5d187c2a2b4c64748e8ba36ddc37a78e4a", "filename": "src/bootstrap/bootstrap.py", "status": "modified", "additions": 11, "deletions": 19, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/9845a41233903435ac0be22c4f6e9723667b429c/src%2Fbootstrap%2Fbootstrap.py", "raw_url": "https://github.com/rust-lang/rust/raw/9845a41233903435ac0be22c4f6e9723667b429c/src%2Fbootstrap%2Fbootstrap.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbootstrap.py?ref=9845a41233903435ac0be22c4f6e9723667b429c", "patch": "@@ -926,23 +926,19 @@ def build_triple(self):\n             return config\n         return default_build_triple(self.verbose)\n \n-    def check_submodule(self, module, slow_submodules):\n-        if not slow_submodules:\n-            checked_out = subprocess.Popen([\"git\", \"rev-parse\", \"HEAD\"],\n-                                           cwd=os.path.join(self.rust_root, module),\n-                                           stdout=subprocess.PIPE)\n-            return checked_out\n-        else:\n-            return None\n+    def check_submodule(self, module):\n+        checked_out = subprocess.Popen([\"git\", \"rev-parse\", \"HEAD\"],\n+                                        cwd=os.path.join(self.rust_root, module),\n+                                        stdout=subprocess.PIPE)\n+        return checked_out\n \n     def update_submodule(self, module, checked_out, recorded_submodules):\n         module_path = os.path.join(self.rust_root, module)\n \n-        if checked_out is not None:\n-            default_encoding = sys.getdefaultencoding()\n-            checked_out = checked_out.communicate()[0].decode(default_encoding).strip()\n-            if recorded_submodules[module] == checked_out:\n-                return\n+        default_encoding = sys.getdefaultencoding()\n+        checked_out = checked_out.communicate()[0].decode(default_encoding).strip()\n+        if recorded_submodules[module] == checked_out:\n+            return\n \n         print(\"Updating submodule\", module)\n \n@@ -991,12 +987,8 @@ def update_submodules(self):\n         git_version_str = require(['git', '--version']).split()[2].decode(default_encoding)\n         self.git_version = distutils.version.LooseVersion(git_version_str)\n \n-        slow_submodules = self.get_toml('fast-submodules') == \"false\"\n         start_time = time()\n-        if slow_submodules:\n-            print('Unconditionally updating submodules')\n-        else:\n-            print('Updating only changed submodules')\n+        print('Updating only changed submodules')\n         default_encoding = sys.getdefaultencoding()\n         # Only update submodules that are needed to build bootstrap.  These are needed because Cargo\n         # currently requires everything in a workspace to be \"locally present\" when starting a\n@@ -1022,7 +1014,7 @@ def update_submodules(self):\n         filtered_submodules = []\n         submodules_names = []\n         for module in submodules:\n-            check = self.check_submodule(module, slow_submodules)\n+            check = self.check_submodule(module)\n             filtered_submodules.append((module, check))\n             submodules_names.append(module)\n         recorded = subprocess.Popen([\"git\", \"ls-tree\", \"HEAD\"] + submodules_names,"}, {"sha": "f9acd52274f88f44cdbd6a9bee9be66cf0a0dd25", "filename": "src/bootstrap/config.rs", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/9845a41233903435ac0be22c4f6e9723667b429c/src%2Fbootstrap%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9845a41233903435ac0be22c4f6e9723667b429c/src%2Fbootstrap%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fconfig.rs?ref=9845a41233903435ac0be22c4f6e9723667b429c", "patch": "@@ -50,7 +50,6 @@ pub struct Config {\n     pub ninja_in_file: bool,\n     pub verbose: usize,\n     pub submodules: Option<bool>,\n-    pub fast_submodules: bool,\n     pub compiler_docs: bool,\n     pub docs_minification: bool,\n     pub docs: bool,\n@@ -517,7 +516,6 @@ define_config! {\n         compiler_docs: Option<bool> = \"compiler-docs\",\n         docs_minification: Option<bool> = \"docs-minification\",\n         submodules: Option<bool> = \"submodules\",\n-        fast_submodules: Option<bool> = \"fast-submodules\",\n         gdb: Option<String> = \"gdb\",\n         nodejs: Option<String> = \"nodejs\",\n         npm: Option<String> = \"npm\",\n@@ -705,7 +703,6 @@ impl Config {\n         config.rust_optimize = true;\n         config.rust_optimize_tests = true;\n         config.submodules = None;\n-        config.fast_submodules = true;\n         config.docs = true;\n         config.docs_minification = true;\n         config.rust_rpath = true;\n@@ -847,7 +844,6 @@ impl Config {\n         set(&mut config.compiler_docs, build.compiler_docs);\n         set(&mut config.docs_minification, build.docs_minification);\n         set(&mut config.docs, build.docs);\n-        set(&mut config.fast_submodules, build.fast_submodules);\n         set(&mut config.locked_deps, build.locked_deps);\n         set(&mut config.vendor, build.vendor);\n         set(&mut config.full_bootstrap, build.full_bootstrap);"}, {"sha": "769382525fbb88d9d68d6f5aafba69c12167df0c", "filename": "src/bootstrap/lib.rs", "status": "modified", "additions": 18, "deletions": 21, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/9845a41233903435ac0be22c4f6e9723667b429c/src%2Fbootstrap%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9845a41233903435ac0be22c4f6e9723667b429c/src%2Fbootstrap%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Flib.rs?ref=9845a41233903435ac0be22c4f6e9723667b429c", "patch": "@@ -556,27 +556,24 @@ impl Build {\n         }\n \n         // check_submodule\n-        if self.config.fast_submodules {\n-            let checked_out_hash = output(\n-                Command::new(\"git\").args(&[\"rev-parse\", \"HEAD\"]).current_dir(&absolute_path),\n-            );\n-            // update_submodules\n-            let recorded = output(\n-                Command::new(\"git\")\n-                    .args(&[\"ls-tree\", \"HEAD\"])\n-                    .arg(relative_path)\n-                    .current_dir(&self.config.src),\n-            );\n-            let actual_hash = recorded\n-                .split_whitespace()\n-                .nth(2)\n-                .unwrap_or_else(|| panic!(\"unexpected output `{}`\", recorded));\n-\n-            // update_submodule\n-            if actual_hash == checked_out_hash.trim_end() {\n-                // already checked out\n-                return;\n-            }\n+        let checked_out_hash =\n+            output(Command::new(\"git\").args(&[\"rev-parse\", \"HEAD\"]).current_dir(&absolute_path));\n+        // update_submodules\n+        let recorded = output(\n+            Command::new(\"git\")\n+                .args(&[\"ls-tree\", \"HEAD\"])\n+                .arg(relative_path)\n+                .current_dir(&self.config.src),\n+        );\n+        let actual_hash = recorded\n+            .split_whitespace()\n+            .nth(2)\n+            .unwrap_or_else(|| panic!(\"unexpected output `{}`\", recorded));\n+\n+        // update_submodule\n+        if actual_hash == checked_out_hash.trim_end() {\n+            // already checked out\n+            return;\n         }\n \n         println!(\"Updating submodule {}\", relative_path.display());"}]}