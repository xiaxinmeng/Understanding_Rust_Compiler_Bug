{"sha": "76452956e4ee3be89a9da69cccadfb980b075049", "node_id": "MDY6Q29tbWl0NzI0NzEyOjc2NDUyOTU2ZTRlZTNiZTg5YTlkYTY5Y2NjYWRmYjk4MGIwNzUwNDk=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-04-02T16:11:08Z"}, "committer": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-04-02T16:11:08Z"}, "message": "Split `Intern::drop` into hot and cold path", "tree": {"sha": "77334a48103518d4cd9252d9304a1abcb3f76cf8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/77334a48103518d4cd9252d9304a1abcb3f76cf8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/76452956e4ee3be89a9da69cccadfb980b075049", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/76452956e4ee3be89a9da69cccadfb980b075049", "html_url": "https://github.com/rust-lang/rust/commit/76452956e4ee3be89a9da69cccadfb980b075049", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/76452956e4ee3be89a9da69cccadfb980b075049/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "afd83e0686512ad2678a2b0bad3b1421692a28bf", "url": "https://api.github.com/repos/rust-lang/rust/commits/afd83e0686512ad2678a2b0bad3b1421692a28bf", "html_url": "https://github.com/rust-lang/rust/commit/afd83e0686512ad2678a2b0bad3b1421692a28bf"}], "stats": {"total": 39, "additions": 23, "deletions": 16}, "files": [{"sha": "785d9e3c64c0cfecc3bb602a7d341dd18947bfab", "filename": "crates/hir_def/src/intern.rs", "status": "modified", "additions": 23, "deletions": 16, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/76452956e4ee3be89a9da69cccadfb980b075049/crates%2Fhir_def%2Fsrc%2Fintern.rs", "raw_url": "https://github.com/rust-lang/rust/raw/76452956e4ee3be89a9da69cccadfb980b075049/crates%2Fhir_def%2Fsrc%2Fintern.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fintern.rs?ref=76452956e4ee3be89a9da69cccadfb980b075049", "patch": "@@ -53,31 +53,38 @@ impl<T: Internable> Interned<T> {\n }\n \n impl<T: Internable + ?Sized> Drop for Interned<T> {\n+    #[inline]\n     fn drop(&mut self) {\n         // When the last `Ref` is dropped, remove the object from the global map.\n         if Arc::strong_count(&self.arc) == 2 {\n             // Only `self` and the global map point to the object.\n \n-            let storage = T::storage().get();\n-            let shard_idx = storage.determine_map(&self.arc);\n-            let shard = &storage.shards()[shard_idx];\n-            let mut shard = shard.write();\n+            self.drop_slow();\n+        }\n+    }\n+}\n+\n+impl<T: Internable + ?Sized> Interned<T> {\n+    #[cold]\n+    fn drop_slow(&mut self) {\n+        let storage = T::storage().get();\n+        let shard_idx = storage.determine_map(&self.arc);\n+        let shard = &storage.shards()[shard_idx];\n+        let mut shard = shard.write();\n \n-            // FIXME: avoid double lookup\n-            let (arc, _) =\n-                shard.get_key_value(&self.arc).expect(\"interned value removed prematurely\");\n+        // FIXME: avoid double lookup\n+        let (arc, _) = shard.get_key_value(&self.arc).expect(\"interned value removed prematurely\");\n \n-            if Arc::strong_count(arc) != 2 {\n-                // Another thread has interned another copy\n-                return;\n-            }\n+        if Arc::strong_count(arc) != 2 {\n+            // Another thread has interned another copy\n+            return;\n+        }\n \n-            shard.remove(&self.arc);\n+        shard.remove(&self.arc);\n \n-            // Shrink the backing storage if the shard is less than 50% occupied.\n-            if shard.len() * 2 < shard.capacity() {\n-                shard.shrink_to_fit();\n-            }\n+        // Shrink the backing storage if the shard is less than 50% occupied.\n+        if shard.len() * 2 < shard.capacity() {\n+            shard.shrink_to_fit();\n         }\n     }\n }"}]}