{"sha": "b411391f8e350a18c08151d270521e44e6417659", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI0MTEzOTFmOGUzNTBhMThjMDgxNTFkMjcwNTIxZTQ0ZTY0MTc2NTk=", "commit": {"author": {"name": "Andr\u00e9 Luis Leal Cardoso Junior", "email": "andrehjr@gmail.com", "date": "2019-04-27T22:06:35Z"}, "committer": {"name": "Andr\u00e9 Luis Leal Cardoso Junior", "email": "andrehjr@gmail.com", "date": "2019-04-30T19:45:28Z"}, "message": "Add lints for find_map", "tree": {"sha": "8118b57eee7966db8480ae1359b8752218f20174", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8118b57eee7966db8480ae1359b8752218f20174"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b411391f8e350a18c08151d270521e44e6417659", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b411391f8e350a18c08151d270521e44e6417659", "html_url": "https://github.com/rust-lang/rust/commit/b411391f8e350a18c08151d270521e44e6417659", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b411391f8e350a18c08151d270521e44e6417659/comments", "author": {"login": "andrehjr", "id": 16997, "node_id": "MDQ6VXNlcjE2OTk3", "avatar_url": "https://avatars.githubusercontent.com/u/16997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/andrehjr", "html_url": "https://github.com/andrehjr", "followers_url": "https://api.github.com/users/andrehjr/followers", "following_url": "https://api.github.com/users/andrehjr/following{/other_user}", "gists_url": "https://api.github.com/users/andrehjr/gists{/gist_id}", "starred_url": "https://api.github.com/users/andrehjr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/andrehjr/subscriptions", "organizations_url": "https://api.github.com/users/andrehjr/orgs", "repos_url": "https://api.github.com/users/andrehjr/repos", "events_url": "https://api.github.com/users/andrehjr/events{/privacy}", "received_events_url": "https://api.github.com/users/andrehjr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "andrehjr", "id": 16997, "node_id": "MDQ6VXNlcjE2OTk3", "avatar_url": "https://avatars.githubusercontent.com/u/16997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/andrehjr", "html_url": "https://github.com/andrehjr", "followers_url": "https://api.github.com/users/andrehjr/followers", "following_url": "https://api.github.com/users/andrehjr/following{/other_user}", "gists_url": "https://api.github.com/users/andrehjr/gists{/gist_id}", "starred_url": "https://api.github.com/users/andrehjr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/andrehjr/subscriptions", "organizations_url": "https://api.github.com/users/andrehjr/orgs", "repos_url": "https://api.github.com/users/andrehjr/repos", "events_url": "https://api.github.com/users/andrehjr/events{/privacy}", "received_events_url": "https://api.github.com/users/andrehjr/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "86f73473c8de4598f8ade982dbb9d44f89777c54", "url": "https://api.github.com/repos/rust-lang/rust/commits/86f73473c8de4598f8ade982dbb9d44f89777c54", "html_url": "https://github.com/rust-lang/rust/commit/86f73473c8de4598f8ade982dbb9d44f89777c54"}], "stats": {"total": 189, "additions": 188, "deletions": 1}, "files": [{"sha": "397916fe409e0f22516d899743c3e2d4feb2bdf1", "filename": "CHANGELOG.md", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b411391f8e350a18c08151d270521e44e6417659/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/b411391f8e350a18c08151d270521e44e6417659/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=b411391f8e350a18c08151d270521e44e6417659", "patch": "@@ -896,7 +896,9 @@ All notable changes to this project will be documented in this file.\n [`extra_unused_lifetimes`]: https://rust-lang.github.io/rust-clippy/master/index.html#extra_unused_lifetimes\n [`fallible_impl_from`]: https://rust-lang.github.io/rust-clippy/master/index.html#fallible_impl_from\n [`filter_map`]: https://rust-lang.github.io/rust-clippy/master/index.html#filter_map\n+[`filter_map_next`]: https://rust-lang.github.io/rust-clippy/master/index.html#filter_map_next\n [`filter_next`]: https://rust-lang.github.io/rust-clippy/master/index.html#filter_next\n+[`find_map`]: https://rust-lang.github.io/rust-clippy/master/index.html#find_map\n [`float_arithmetic`]: https://rust-lang.github.io/rust-clippy/master/index.html#float_arithmetic\n [`float_cmp`]: https://rust-lang.github.io/rust-clippy/master/index.html#float_cmp\n [`float_cmp_const`]: https://rust-lang.github.io/rust-clippy/master/index.html#float_cmp_const"}, {"sha": "4ed388db1763ae84b3e9034161d717243761fa56", "filename": "README.md", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b411391f8e350a18c08151d270521e44e6417659/README.md", "raw_url": "https://github.com/rust-lang/rust/raw/b411391f8e350a18c08151d270521e44e6417659/README.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/README.md?ref=b411391f8e350a18c08151d270521e44e6417659", "patch": "@@ -7,7 +7,7 @@\n \n A collection of lints to catch common mistakes and improve your [Rust](https://github.com/rust-lang/rust) code.\n \n-[There are 299 lints included in this crate!](https://rust-lang.github.io/rust-clippy/master/index.html)\n+[There are 301 lints included in this crate!](https://rust-lang.github.io/rust-clippy/master/index.html)\n \n We have a bunch of lint categories to allow you to choose how much Clippy is supposed to ~~annoy~~ help you:\n "}, {"sha": "0f09f678e4bb8ce603d4e6c23d166586199a6986", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b411391f8e350a18c08151d270521e44e6417659/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b411391f8e350a18c08151d270521e44e6417659/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=b411391f8e350a18c08151d270521e44e6417659", "patch": "@@ -622,6 +622,8 @@ pub fn register_plugins(reg: &mut rustc_plugin::Registry<'_>, conf: &Conf) {\n         loops::EXPLICIT_ITER_LOOP,\n         matches::SINGLE_MATCH_ELSE,\n         methods::FILTER_MAP,\n+        methods::FILTER_MAP_NEXT,\n+        methods::FIND_MAP,\n         methods::MAP_FLATTEN,\n         methods::OPTION_MAP_UNWRAP_OR,\n         methods::OPTION_MAP_UNWRAP_OR_ELSE,"}, {"sha": "2904fd4c98dc82603d39476548f8ce80c343428f", "filename": "clippy_lints/src/methods/mod.rs", "status": "modified", "additions": 84, "deletions": 0, "changes": 84, "blob_url": "https://github.com/rust-lang/rust/blob/b411391f8e350a18c08151d270521e44e6417659/clippy_lints%2Fsrc%2Fmethods%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b411391f8e350a18c08151d270521e44e6417659/clippy_lints%2Fsrc%2Fmethods%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmethods%2Fmod.rs?ref=b411391f8e350a18c08151d270521e44e6417659", "patch": "@@ -288,6 +288,50 @@ declare_clippy_lint! {\n     \"using combinations of `filter`, `map`, `filter_map` and `flat_map` which can usually be written as a single method call\"\n }\n \n+declare_clippy_lint! {\n+    /// **What it does:** Checks for usage of `_.filter_map(_).next()`.\n+    ///\n+    /// **Why is this bad?** Readability, this can be written more concisely as a\n+    /// single method call.\n+    ///\n+    /// **Known problems:** None\n+    ///\n+    /// **Example:**\n+    /// ```rust\n+    ///  (0..3).filter_map(|x| if x == 2 { Some(x) } else { None }).next();\n+    /// ```\n+    /// Can be written as\n+    ///\n+    /// ```rust\n+    ///  (0..3).find_map(|x| if x == 2 { Some(x) } else { None });\n+    /// ```\n+    pub FILTER_MAP_NEXT,\n+    pedantic,\n+    \"using combination of `filter_map` and `next` which can usually be written as a single method call\"\n+}\n+\n+declare_clippy_lint! {\n+    /// **What it does:** Checks for usage of `_.find(_).map(_)`.\n+    ///\n+    /// **Why is this bad?** Readability, this can be written more concisely as a\n+    /// single method call.\n+    ///\n+    /// **Known problems:** Often requires a condition + Option/Iterator creation\n+    /// inside the closure.\n+    ///\n+    /// **Example:**\n+    /// ```rust\n+    ///  (0..3).find(|x| x == 2).map(|x| x * 2);\n+    /// ```\n+    /// Can be written as\n+    /// ```rust\n+    ///  (0..3).find_map(|x| if x == 2 { Some(x * 2) } else { None });\n+    /// ```\n+    pub FIND_MAP,\n+    pedantic,\n+    \"using a combination of `find` and `map` can usually be written as a single method call\"\n+}\n+\n declare_clippy_lint! {\n     /// **What it does:** Checks for an iterator search (such as `find()`,\n     /// `position()`, or `rposition()`) followed by a call to `is_some()`.\n@@ -798,6 +842,8 @@ declare_lint_pass!(Methods => [\n     TEMPORARY_CSTRING_AS_PTR,\n     FILTER_NEXT,\n     FILTER_MAP,\n+    FILTER_MAP_NEXT,\n+    FIND_MAP,\n     MAP_FLATTEN,\n     ITER_NTH,\n     ITER_SKIP_NEXT,\n@@ -833,6 +879,8 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for Methods {\n             [\"next\", \"filter\"] => lint_filter_next(cx, expr, arg_lists[1]),\n             [\"map\", \"filter\"] => lint_filter_map(cx, expr, arg_lists[1], arg_lists[0]),\n             [\"map\", \"filter_map\"] => lint_filter_map_map(cx, expr, arg_lists[1], arg_lists[0]),\n+            [\"next\", \"filter_map\"] => lint_filter_map_next(cx, expr, arg_lists[1]),\n+            [\"map\", \"find\"] => lint_find_map(cx, expr, arg_lists[1], arg_lists[0]),\n             [\"flat_map\", \"filter\"] => lint_filter_flat_map(cx, expr, arg_lists[1], arg_lists[0]),\n             [\"flat_map\", \"filter_map\"] => lint_filter_map_flat_map(cx, expr, arg_lists[1], arg_lists[0]),\n             [\"flatten\", \"map\"] => lint_map_flatten(cx, expr, arg_lists[1]),\n@@ -1911,6 +1959,42 @@ fn lint_filter_map<'a, 'tcx>(\n     }\n }\n \n+/// lint use of `filter_map().next()` for `Iterators`\n+fn lint_filter_map_next<'a, 'tcx>(cx: &LateContext<'a, 'tcx>, expr: &'tcx hir::Expr, filter_args: &'tcx [hir::Expr]) {\n+    if match_trait_method(cx, expr, &paths::ITERATOR) {\n+        let msg = \"called `filter_map(p).next()` on an `Iterator`. This is more succinctly expressed by calling \\\n+                   `.find_map(p)` instead.\";\n+        let filter_snippet = snippet(cx, filter_args[1].span, \"..\");\n+        if filter_snippet.lines().count() <= 1 {\n+            span_note_and_lint(\n+                cx,\n+                FILTER_MAP_NEXT,\n+                expr.span,\n+                msg,\n+                expr.span,\n+                &format!(\"replace `filter_map({0}).next()` with `find_map({0})`\", filter_snippet),\n+            );\n+        } else {\n+            span_lint(cx, FILTER_MAP_NEXT, expr.span, msg);\n+        }\n+    }\n+}\n+\n+/// lint use of `find().map()` for `Iterators`\n+fn lint_find_map<'a, 'tcx>(\n+    cx: &LateContext<'a, 'tcx>,\n+    expr: &'tcx hir::Expr,\n+    _find_args: &'tcx [hir::Expr],\n+    map_args: &'tcx [hir::Expr],\n+) {\n+    // lint if caller of `.filter().map()` is an Iterator\n+    if match_trait_method(cx, &map_args[0], &paths::ITERATOR) {\n+        let msg = \"called `find(p).map(q)` on an `Iterator`. \\\n+                   This is more succinctly expressed by calling `.find_map(..)` instead.\";\n+        span_lint(cx, FIND_MAP, expr.span, msg);\n+    }\n+}\n+\n /// lint use of `filter().map()` for `Iterators`\n fn lint_filter_map_map<'a, 'tcx>(\n     cx: &LateContext<'a, 'tcx>,"}, {"sha": "f5d051be198ed3011ed7ae74b06c1ccec983d286", "filename": "tests/ui/filter_map_next.rs", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/b411391f8e350a18c08151d270521e44e6417659/tests%2Fui%2Ffilter_map_next.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b411391f8e350a18c08151d270521e44e6417659/tests%2Fui%2Ffilter_map_next.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ffilter_map_next.rs?ref=b411391f8e350a18c08151d270521e44e6417659", "patch": "@@ -0,0 +1,20 @@\n+#![warn(clippy::all, clippy::pedantic)]\n+\n+fn main() {\n+    let a = [\"1\", \"lol\", \"3\", \"NaN\", \"5\"];\n+\n+    let element: Option<i32> = a.iter().filter_map(|s| s.parse().ok()).next();\n+    assert_eq!(element, Some(1));\n+\n+    #[rustfmt::skip]\n+    let _: Option<u32> = vec![1, 2, 3, 4, 5, 6]\n+        .into_iter()\n+        .filter_map(|x| {\n+            if x == 2 {\n+                Some(x * 2)\n+            } else {\n+                None\n+            }\n+        })\n+        .next();\n+}"}, {"sha": "d69ae212414f621ea719250b62d10c5ff9fd48cb", "filename": "tests/ui/filter_map_next.stderr", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/b411391f8e350a18c08151d270521e44e6417659/tests%2Fui%2Ffilter_map_next.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b411391f8e350a18c08151d270521e44e6417659/tests%2Fui%2Ffilter_map_next.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ffilter_map_next.stderr?ref=b411391f8e350a18c08151d270521e44e6417659", "patch": "@@ -0,0 +1,24 @@\n+error: called `filter_map(p).next()` on an `Iterator`. This is more succinctly expressed by calling `.find_map(p)` instead.\n+  --> $DIR/filter_map_next.rs:6:32\n+   |\n+LL |     let element: Option<i32> = a.iter().filter_map(|s| s.parse().ok()).next();\n+   |                                ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+   = note: `-D clippy::filter-map-next` implied by `-D warnings`\n+   = note: replace `filter_map(|s| s.parse().ok()).next()` with `find_map(|s| s.parse().ok())`\n+\n+error: called `filter_map(p).next()` on an `Iterator`. This is more succinctly expressed by calling `.find_map(p)` instead.\n+  --> $DIR/filter_map_next.rs:10:26\n+   |\n+LL |       let _: Option<u32> = vec![1, 2, 3, 4, 5, 6]\n+   |  __________________________^\n+LL | |         .into_iter()\n+LL | |         .filter_map(|x| {\n+LL | |             if x == 2 {\n+...  |\n+LL | |         })\n+LL | |         .next();\n+   | |_______________^\n+\n+error: aborting due to 2 previous errors\n+"}, {"sha": "c28cca144ca3f15bb6aa90c0095d7e844d1d7ea9", "filename": "tests/ui/find_map.rs", "status": "added", "additions": 32, "deletions": 0, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/b411391f8e350a18c08151d270521e44e6417659/tests%2Fui%2Ffind_map.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b411391f8e350a18c08151d270521e44e6417659/tests%2Fui%2Ffind_map.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ffind_map.rs?ref=b411391f8e350a18c08151d270521e44e6417659", "patch": "@@ -0,0 +1,32 @@\n+#![warn(clippy::all, clippy::pedantic)]\n+\n+#[derive(Debug, Copy, Clone)]\n+enum Flavor {\n+    Chocolate,\n+}\n+\n+#[derive(Debug, Copy, Clone)]\n+enum Dessert {\n+    Banana,\n+    Pudding,\n+    Cake(Flavor),\n+}\n+\n+fn main() {\n+    let desserts_of_the_week = vec![Dessert::Banana, Dessert::Cake(Flavor::Chocolate), Dessert::Pudding];\n+\n+    let a = [\"lol\", \"NaN\", \"2\", \"5\", \"Xunda\"];\n+\n+    let _: Option<i32> = a.iter().find(|s| s.parse::<i32>().is_ok()).map(|s| s.parse().unwrap());\n+\n+    let _: Option<Flavor> = desserts_of_the_week\n+        .iter()\n+        .find(|dessert| match *dessert {\n+            Dessert::Cake(_) => true,\n+            _ => false,\n+        })\n+        .map(|dessert| match *dessert {\n+            Dessert::Cake(ref flavor) => *flavor,\n+            _ => unreachable!(),\n+        });\n+}"}, {"sha": "0417c7f3dc9a03721920bc756ee45bedae65c567", "filename": "tests/ui/find_map.stderr", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/b411391f8e350a18c08151d270521e44e6417659/tests%2Fui%2Ffind_map.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b411391f8e350a18c08151d270521e44e6417659/tests%2Fui%2Ffind_map.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ffind_map.stderr?ref=b411391f8e350a18c08151d270521e44e6417659", "patch": "@@ -0,0 +1,23 @@\n+error: called `find(p).map(q)` on an `Iterator`. This is more succinctly expressed by calling `.find_map(..)` instead.\n+  --> $DIR/find_map.rs:20:26\n+   |\n+LL |     let _: Option<i32> = a.iter().find(|s| s.parse::<i32>().is_ok()).map(|s| s.parse().unwrap());\n+   |                          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+   = note: `-D clippy::find-map` implied by `-D warnings`\n+\n+error: called `find(p).map(q)` on an `Iterator`. This is more succinctly expressed by calling `.find_map(..)` instead.\n+  --> $DIR/find_map.rs:22:29\n+   |\n+LL |       let _: Option<Flavor> = desserts_of_the_week\n+   |  _____________________________^\n+LL | |         .iter()\n+LL | |         .find(|dessert| match *dessert {\n+LL | |             Dessert::Cake(_) => true,\n+...  |\n+LL | |             _ => unreachable!(),\n+LL | |         });\n+   | |__________^\n+\n+error: aborting due to 2 previous errors\n+"}]}