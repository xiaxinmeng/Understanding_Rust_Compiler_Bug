{"sha": "6a649e6b8b3e42bb8fa8fa806d783ecd9b543784", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZhNjQ5ZTZiOGIzZTQyYmI4ZmE4ZmE4MDZkNzgzZWNkOWI1NDM3ODQ=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-08-25T11:21:15Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-08-25T11:21:15Z"}, "message": "auto merge of #8710 : pnkfelix/rust/fsk-issue5516-codepoint-fix, r=alexcrichton\n\n...bytes.\r\n\r\n(removing previous note about eff-eye-ex'ing #5516 since it actually does not do so, it just gets us half-way.)", "tree": {"sha": "7846affbd49aaefb860c25633b39dc5502b4bf2d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7846affbd49aaefb860c25633b39dc5502b4bf2d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6a649e6b8b3e42bb8fa8fa806d783ecd9b543784", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6a649e6b8b3e42bb8fa8fa806d783ecd9b543784", "html_url": "https://github.com/rust-lang/rust/commit/6a649e6b8b3e42bb8fa8fa806d783ecd9b543784", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6a649e6b8b3e42bb8fa8fa806d783ecd9b543784/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bed84898fca9443f97fc3db17b0417c179d25803", "url": "https://api.github.com/repos/rust-lang/rust/commits/bed84898fca9443f97fc3db17b0417c179d25803", "html_url": "https://github.com/rust-lang/rust/commit/bed84898fca9443f97fc3db17b0417c179d25803"}, {"sha": "ca0e7b12aa3ec542a75769cc3453464813b20490", "url": "https://api.github.com/repos/rust-lang/rust/commits/ca0e7b12aa3ec542a75769cc3453464813b20490", "html_url": "https://github.com/rust-lang/rust/commit/ca0e7b12aa3ec542a75769cc3453464813b20490"}], "stats": {"total": 37, "additions": 32, "deletions": 5}, "files": [{"sha": "a21d9dc605f40ccc18afa5650cf97a6233c1ae18", "filename": "src/libextra/getopts.rs", "status": "modified", "additions": 32, "deletions": 5, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/6a649e6b8b3e42bb8fa8fa806d783ecd9b543784/src%2Flibextra%2Fgetopts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6a649e6b8b3e42bb8fa8fa806d783ecd9b543784/src%2Flibextra%2Fgetopts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibextra%2Fgetopts.rs?ref=6a649e6b8b3e42bb8fa8fa806d783ecd9b543784", "patch": "@@ -689,9 +689,9 @@ pub mod groups {\n                 }\n             }\n \n-            // FIXME: #5516\n+            // FIXME: #5516 should be graphemes not codepoints\n             // here we just need to indent the start of the description\n-            let rowlen = row.len();\n+            let rowlen = row.char_len();\n             if rowlen < 24 {\n                 do (24 - rowlen).times {\n                     row.push_char(' ')\n@@ -707,14 +707,14 @@ pub mod groups {\n                 desc_normalized_whitespace.push_char(' ');\n             }\n \n-            // FIXME: #5516\n+            // FIXME: #5516 should be graphemes not codepoints\n             let mut desc_rows = ~[];\n             do each_split_within(desc_normalized_whitespace, 54) |substr| {\n                 desc_rows.push(substr.to_owned());\n                 true\n             };\n \n-            // FIXME: #5516\n+            // FIXME: #5516 should be graphemes not codepoints\n             // wrapped description\n             row.push_str(desc_rows.connect(desc_sep));\n \n@@ -798,7 +798,7 @@ pub mod groups {\n             cont\n         };\n \n-        ss.iter().enumerate().advance(|x| machine(x));\n+        ss.char_offset_iter().advance(|x| machine(x));\n \n         // Let the automaton 'run out' by supplying trailing whitespace\n         while cont && match state { B | C => true, A => false } {\n@@ -1580,4 +1580,31 @@ Options:\n         debug!(\"generated: <<%s>>\", usage);\n         assert!(usage == expected)\n     }\n+\n+    #[test]\n+    fn test_groups_usage_description_multibyte_handling() {\n+        let optgroups = ~[\n+            groups::optflag(\"k\", \"k\\u2013w\\u2013\",\n+                \"The word kiwi is normally spelled with two i's\"),\n+            groups::optflag(\"a\", \"apple\",\n+                \"This \\u201Cdescription\\u201D has some characters that could \\\n+confuse the line wrapping; an apple costs 0.51\u20ac in some parts of Europe.\"),\n+        ];\n+\n+        let expected =\n+~\"Usage: fruits\n+\n+Options:\n+    -k --k\u2013w\u2013           The word kiwi is normally spelled with two i's\n+    -a --apple          This \u201cdescription\u201d has some characters that could\n+                        confuse the line wrapping; an apple costs 0.51\u20ac in\n+                        some parts of Europe.\n+\";\n+\n+        let usage = groups::usage(\"Usage: fruits\", optgroups);\n+\n+        debug!(\"expected: <<%s>>\", expected);\n+        debug!(\"generated: <<%s>>\", usage);\n+        assert!(usage == expected)\n+    }\n }"}]}