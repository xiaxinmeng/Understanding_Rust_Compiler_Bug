{"sha": "7778f314f2dfdc1b9749b6e4f21686dff27df6ac", "node_id": "MDY6Q29tbWl0NzI0NzEyOjc3NzhmMzE0ZjJkZmRjMWI5NzQ5YjZlNGYyMTY4NmRmZjI3ZGY2YWM=", "commit": {"author": {"name": "mcarton", "email": "cartonmartin+git@gmail.com", "date": "2016-07-03T21:56:06Z"}, "committer": {"name": "mcarton", "email": "cartonmartin+git@gmail.com", "date": "2016-07-03T22:51:19Z"}, "message": "Merge branch 'master' into sugg", "tree": {"sha": "d68561120d1bbd882eb36bb9614c60617dac1c27", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d68561120d1bbd882eb36bb9614c60617dac1c27"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7778f314f2dfdc1b9749b6e4f21686dff27df6ac", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\nVersion: GnuPG v2\n\niQIcBAABCAAGBQJXeZbpAAoJEF5CfHlMukXoAnwQALKT3i0VWdoOwt8iVSi3LpLs\nM9kF/YENvsjiDtdA3YTAo3O1nFzr8UJhhxYEPo74UPGewQSMD1r/wj31i0e3m0Uw\nXepCxoNTf+M3sIGWqqKet+CofATh1yNRCcFvij3YSxrvK2bYIamcTtXEkNdSKkML\nldIIl+8oc+qgmm3ljxkqapGPSyCq//MLrV8W8bkyijmhUW3zfd6K13/sNOJUBR0c\n7KBypaj2sUbVDwYmi5XlXb5+PtMxLDgiuRS9luSKuVqnUbf6lJyRTKz+NQMXTMXn\nuCQYtf1qg5PRl5m8TnoGHJ2WBawLT+ox/KwW+daGXlrj9sfq1tae6rfARvVtLJMY\nFRjhI8HtB7kSSBFts+fA6d6BzK3nb94nnmfHkrpTn37pJL1UamPBLisQY4QFdHiE\nqxOWG8lAievGZqIHfoMKfgIxa82SRKnHJbX8KR2ZqMqqhT0tOZG8CzR5ZOig5cTG\nl3dhvAbOiRSY1PRodXUR4AuZa5kdySa9WccVsmw9gz8EILmoV3p1i0GGWHS7TvYj\n8wZtgPzT9XDgoHj1KgoPB6jSC8EFVbhT42H3ZOHIHiRzv8OLV1grgAH569hEZHFz\n49Tc9FBOhJtb1YUufx2sYirgZR2YtE/cXK9iRYDNDpCJu+lYfnU4qjTYuZF/2Kk7\n22uzbeAUN5VG2jqBsLBw\n=rtKG\n-----END PGP SIGNATURE-----", "payload": "tree d68561120d1bbd882eb36bb9614c60617dac1c27\nparent 2f259b8cd345988090c401f551001dfc63ccfd2d\nparent 5d6e4a6f4d83ce8307aa9c65ce14af06668ef7b6\nauthor mcarton <cartonmartin+git@gmail.com> 1467582966 +0200\ncommitter mcarton <cartonmartin+git@gmail.com> 1467586279 +0200\n\nMerge branch 'master' into sugg\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7778f314f2dfdc1b9749b6e4f21686dff27df6ac", "html_url": "https://github.com/rust-lang/rust/commit/7778f314f2dfdc1b9749b6e4f21686dff27df6ac", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7778f314f2dfdc1b9749b6e4f21686dff27df6ac/comments", "author": {"login": "mcarton", "id": 3751788, "node_id": "MDQ6VXNlcjM3NTE3ODg=", "avatar_url": "https://avatars.githubusercontent.com/u/3751788?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mcarton", "html_url": "https://github.com/mcarton", "followers_url": "https://api.github.com/users/mcarton/followers", "following_url": "https://api.github.com/users/mcarton/following{/other_user}", "gists_url": "https://api.github.com/users/mcarton/gists{/gist_id}", "starred_url": "https://api.github.com/users/mcarton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mcarton/subscriptions", "organizations_url": "https://api.github.com/users/mcarton/orgs", "repos_url": "https://api.github.com/users/mcarton/repos", "events_url": "https://api.github.com/users/mcarton/events{/privacy}", "received_events_url": "https://api.github.com/users/mcarton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "mcarton", "id": 3751788, "node_id": "MDQ6VXNlcjM3NTE3ODg=", "avatar_url": "https://avatars.githubusercontent.com/u/3751788?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mcarton", "html_url": "https://github.com/mcarton", "followers_url": "https://api.github.com/users/mcarton/followers", "following_url": "https://api.github.com/users/mcarton/following{/other_user}", "gists_url": "https://api.github.com/users/mcarton/gists{/gist_id}", "starred_url": "https://api.github.com/users/mcarton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mcarton/subscriptions", "organizations_url": "https://api.github.com/users/mcarton/orgs", "repos_url": "https://api.github.com/users/mcarton/repos", "events_url": "https://api.github.com/users/mcarton/events{/privacy}", "received_events_url": "https://api.github.com/users/mcarton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2f259b8cd345988090c401f551001dfc63ccfd2d", "url": "https://api.github.com/repos/rust-lang/rust/commits/2f259b8cd345988090c401f551001dfc63ccfd2d", "html_url": "https://github.com/rust-lang/rust/commit/2f259b8cd345988090c401f551001dfc63ccfd2d"}, {"sha": "5d6e4a6f4d83ce8307aa9c65ce14af06668ef7b6", "url": "https://api.github.com/repos/rust-lang/rust/commits/5d6e4a6f4d83ce8307aa9c65ce14af06668ef7b6", "html_url": "https://github.com/rust-lang/rust/commit/5d6e4a6f4d83ce8307aa9c65ce14af06668ef7b6"}], "stats": {"total": 275, "additions": 237, "deletions": 38}, "files": [{"sha": "ae316a90b05a144994bd78492e38710c065333ee", "filename": "CHANGELOG.md", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/7778f314f2dfdc1b9749b6e4f21686dff27df6ac/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/7778f314f2dfdc1b9749b6e4f21686dff27df6ac/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=7778f314f2dfdc1b9749b6e4f21686dff27df6ac", "patch": "@@ -1,7 +1,8 @@\n # Change Log\n All notable changes to this project will be documented in this file.\n \n-## 0.0.78 - TBA\n+## 0.0.78 - 2016-07-02\n+* Rustup to *rustc 1.11.0-nightly (01411937f 2016-07-01)*\n * New lints: [`wrong_transmute`, `double_neg`]\n * For compatibility, `cargo clippy` does not defines the `clippy` feature\n   introduced in 0.0.76 anymore\n@@ -14,6 +15,7 @@ All notable changes to this project will be documented in this file.\n ## 0.0.76 \u2014 2016-06-10\n * Rustup to *rustc 1.11.0-nightly (7d2f75a95 2016-06-09)*\n * `cargo clippy` now automatically defines the `clippy` feature\n+* New lint: [`not_unsafe_ptr_arg_deref`]\n \n ## 0.0.75 \u2014 2016-06-08\n * Rustup to *rustc 1.11.0-nightly (763f9234b 2016-06-06)*\n@@ -219,6 +221,7 @@ All notable changes to this project will be documented in this file.\n [`non_ascii_literal`]: https://github.com/Manishearth/rust-clippy/wiki#non_ascii_literal\n [`nonminimal_bool`]: https://github.com/Manishearth/rust-clippy/wiki#nonminimal_bool\n [`nonsensical_open_options`]: https://github.com/Manishearth/rust-clippy/wiki#nonsensical_open_options\n+[`not_unsafe_ptr_arg_deref`]: https://github.com/Manishearth/rust-clippy/wiki#not_unsafe_ptr_arg_deref\n [`ok_expect`]: https://github.com/Manishearth/rust-clippy/wiki#ok_expect\n [`option_map_unwrap_or`]: https://github.com/Manishearth/rust-clippy/wiki#option_map_unwrap_or\n [`option_map_unwrap_or_else`]: https://github.com/Manishearth/rust-clippy/wiki#option_map_unwrap_or_else"}, {"sha": "f8b63a56257c4a59db3ebfd8fbfdda64e0b0600a", "filename": "Cargo.toml", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/7778f314f2dfdc1b9749b6e4f21686dff27df6ac/Cargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/7778f314f2dfdc1b9749b6e4f21686dff27df6ac/Cargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.toml?ref=7778f314f2dfdc1b9749b6e4f21686dff27df6ac", "patch": "@@ -1,6 +1,6 @@\n [package]\n name = \"clippy\"\n-version = \"0.0.77\"\n+version = \"0.0.78\"\n authors = [\n \t\"Manish Goregaokar <manishsmail@gmail.com>\",\n \t\"Andre Bogus <bogusandre@gmail.com>\",\n@@ -25,7 +25,7 @@ test = false\n \n [dependencies]\n # begin automatic update\n-clippy_lints = { version = \"0.0.77\", path = \"clippy_lints\" }\n+clippy_lints = { version = \"0.0.78\", path = \"clippy_lints\" }\n # end automatic update\n \n [dev-dependencies]"}, {"sha": "c413b6a0dae7ba5e257a8d8307423c9518b478d3", "filename": "README.md", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/7778f314f2dfdc1b9749b6e4f21686dff27df6ac/README.md", "raw_url": "https://github.com/rust-lang/rust/raw/7778f314f2dfdc1b9749b6e4f21686dff27df6ac/README.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/README.md?ref=7778f314f2dfdc1b9749b6e4f21686dff27df6ac", "patch": "@@ -17,7 +17,7 @@ Table of contents:\n \n ## Lints\n \n-There are 157 lints included in this crate:\n+There are 158 lints included in this crate:\n \n name                                                                                                                 | default | meaning\n ---------------------------------------------------------------------------------------------------------------------|---------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n@@ -115,6 +115,7 @@ name\n [non_ascii_literal](https://github.com/Manishearth/rust-clippy/wiki#non_ascii_literal)                               | allow   | using any literal non-ASCII chars in a string literal; suggests using the \\\\u escape instead\n [nonminimal_bool](https://github.com/Manishearth/rust-clippy/wiki#nonminimal_bool)                                   | allow   | checks for boolean expressions that can be written more concisely\n [nonsensical_open_options](https://github.com/Manishearth/rust-clippy/wiki#nonsensical_open_options)                 | warn    | nonsensical combination of options for opening a file\n+[not_unsafe_ptr_arg_deref](https://github.com/Manishearth/rust-clippy/wiki#not_unsafe_ptr_arg_deref)                 | warn    | public functions dereferencing raw pointer arguments but not marked `unsafe`\n [ok_expect](https://github.com/Manishearth/rust-clippy/wiki#ok_expect)                                               | warn    | using `ok().expect()`, which gives worse error messages than calling `expect` directly on the Result\n [option_map_unwrap_or](https://github.com/Manishearth/rust-clippy/wiki#option_map_unwrap_or)                         | warn    | using `Option.map(f).unwrap_or(a)`, which is more succinctly expressed as `map_or(a, f)`\n [option_map_unwrap_or_else](https://github.com/Manishearth/rust-clippy/wiki#option_map_unwrap_or_else)               | warn    | using `Option.map(f).unwrap_or_else(g)`, which is more succinctly expressed as `map_or_else(g, f)`"}, {"sha": "e74db2b17a64dd432f853d12a669a881e31f8141", "filename": "clippy_lints/Cargo.toml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/7778f314f2dfdc1b9749b6e4f21686dff27df6ac/clippy_lints%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/7778f314f2dfdc1b9749b6e4f21686dff27df6ac/clippy_lints%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2FCargo.toml?ref=7778f314f2dfdc1b9749b6e4f21686dff27df6ac", "patch": "@@ -1,7 +1,7 @@\n [package]\n name = \"clippy_lints\"\n # begin automatic update\n-version = \"0.0.77\"\n+version = \"0.0.78\"\n # end automatic update\n authors = [\n \t\"Manish Goregaokar <manishsmail@gmail.com>\","}, {"sha": "0dec4e94c0b87d46903d0aaefc384b9ca9f64c55", "filename": "clippy_lints/src/functions.rs", "status": "modified", "additions": 124, "deletions": 15, "changes": 139, "blob_url": "https://github.com/rust-lang/rust/blob/7778f314f2dfdc1b9749b6e4f21686dff27df6ac/clippy_lints%2Fsrc%2Ffunctions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7778f314f2dfdc1b9749b6e4f21686dff27df6ac/clippy_lints%2Fsrc%2Ffunctions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Ffunctions.rs?ref=7778f314f2dfdc1b9749b6e4f21686dff27df6ac", "patch": "@@ -1,9 +1,11 @@\n-use rustc::lint::*;\n-use rustc::hir;\n use rustc::hir::intravisit;\n+use rustc::hir;\n+use rustc::ty;\n+use rustc::lint::*;\n+use std::collections::HashSet;\n use syntax::ast;\n use syntax::codemap::Span;\n-use utils::span_lint;\n+use utils::{span_lint, type_is_unsafe_function};\n \n /// **What it does:** Check for functions with too many parameters.\n ///\n@@ -15,7 +17,7 @@ use utils::span_lint;\n ///\n /// **Example:**\n ///\n-/// ```\n+/// ```rust\n /// fn foo(x: u32, y: u32, name: &str, c: Color, w: f32, h: f32, a: f32, b: f32) { .. }\n /// ```\n declare_lint! {\n@@ -24,6 +26,30 @@ declare_lint! {\n     \"functions with too many arguments\"\n }\n \n+/// **What it does:** Check for public functions that dereferences raw pointer arguments but are\n+/// not marked unsafe.\n+///\n+/// **Why is this bad?** The function should probably be marked `unsafe`, since for an arbitrary\n+/// raw pointer, there is no way of telling for sure if it is valid.\n+///\n+/// **Known problems:**\n+///\n+/// * It does not check functions recursively so if the pointer is passed to a private non-\n+/// `unsafe` function which does the dereferencing, the lint won't trigger.\n+/// * It only checks for arguments whose type are raw pointers, not raw pointers got from an\n+/// argument in some other way (`fn foo(bar: &[*const u8])` or `some_argument.get_raw_ptr()`).\n+///\n+/// **Example:**\n+///\n+/// ```rust\n+/// pub fn foo(x: *const u8) { println!(\"{}\", unsafe { *x }); }\n+/// ```\n+declare_lint! {\n+    pub NOT_UNSAFE_PTR_ARG_DEREF,\n+    Warn,\n+    \"public functions dereferencing raw pointer arguments but not marked `unsafe`\"\n+}\n+\n #[derive(Copy,Clone)]\n pub struct Functions {\n     threshold: u64,\n@@ -37,29 +63,41 @@ impl Functions {\n \n impl LintPass for Functions {\n     fn get_lints(&self) -> LintArray {\n-        lint_array!(TOO_MANY_ARGUMENTS)\n+        lint_array!(TOO_MANY_ARGUMENTS, NOT_UNSAFE_PTR_ARG_DEREF)\n     }\n }\n \n impl LateLintPass for Functions {\n-    fn check_fn(&mut self, cx: &LateContext, _: intravisit::FnKind, decl: &hir::FnDecl, _: &hir::Block, span: Span,\n-                nodeid: ast::NodeId) {\n+    fn check_fn(&mut self, cx: &LateContext, kind: intravisit::FnKind, decl: &hir::FnDecl, block: &hir::Block, span: Span, nodeid: ast::NodeId) {\n         use rustc::hir::map::Node::*;\n \n-        if let Some(NodeItem(ref item)) = cx.tcx.map.find(cx.tcx.map.get_parent_node(nodeid)) {\n-            match item.node {\n-                hir::ItemImpl(_, _, _, Some(_), _, _) |\n-                hir::ItemDefaultImpl(..) => return,\n-                _ => (),\n-            }\n+        let is_impl = if let Some(NodeItem(ref item)) = cx.tcx.map.find(cx.tcx.map.get_parent_node(nodeid)) {\n+            matches!(item.node, hir::ItemImpl(_, _, _, Some(_), _, _) | hir::ItemDefaultImpl(..))\n+        } else {\n+            false\n+        };\n+\n+        let unsafety = match kind {\n+            hir::intravisit::FnKind::ItemFn(_, _, unsafety, _, _, _, _) => unsafety,\n+            hir::intravisit::FnKind::Method(_, sig, _, _) => sig.unsafety,\n+            hir::intravisit::FnKind::Closure(_) => return,\n+        };\n+\n+        // don't warn for implementations, it's not their fault\n+        if !is_impl {\n+            self.check_arg_number(cx, decl, span);\n         }\n \n-        self.check_arg_number(cx, decl, span);\n+        self.check_raw_ptr(cx, unsafety, decl, block, nodeid);\n     }\n \n     fn check_trait_item(&mut self, cx: &LateContext, item: &hir::TraitItem) {\n-        if let hir::MethodTraitItem(ref sig, _) = item.node {\n+        if let hir::MethodTraitItem(ref sig, ref block) = item.node {\n             self.check_arg_number(cx, &sig.decl, item.span);\n+\n+            if let Some(ref block) = *block {\n+                self.check_raw_ptr(cx, sig.unsafety, &sig.decl, block, item.id);\n+            }\n         }\n     }\n }\n@@ -74,4 +112,75 @@ impl Functions {\n                       &format!(\"this function has too many arguments ({}/{})\", args, self.threshold));\n         }\n     }\n+\n+    fn check_raw_ptr(&self, cx: &LateContext, unsafety: hir::Unsafety, decl: &hir::FnDecl, block: &hir::Block, nodeid: ast::NodeId) {\n+        if unsafety == hir::Unsafety::Normal && cx.access_levels.is_exported(nodeid) {\n+            let raw_ptrs = decl.inputs.iter().filter_map(|arg| raw_ptr_arg(cx, arg)).collect::<HashSet<_>>();\n+\n+            if !raw_ptrs.is_empty() {\n+                let mut v = DerefVisitor {\n+                    cx: cx,\n+                    ptrs: raw_ptrs,\n+                };\n+\n+                hir::intravisit::walk_block(&mut v, block);\n+            }\n+        }\n+    }\n+}\n+\n+fn raw_ptr_arg(cx: &LateContext, arg: &hir::Arg) -> Option<hir::def_id::DefId> {\n+    if let (&hir::PatKind::Binding(_, _, _), &hir::TyPtr(_)) = (&arg.pat.node, &arg.ty.node) {\n+        cx.tcx.def_map.borrow().get(&arg.pat.id).map(|pr| pr.full_def().def_id())\n+    } else {\n+        None\n+    }\n+}\n+\n+struct DerefVisitor<'a, 'tcx: 'a> {\n+    cx: &'a LateContext<'a, 'tcx>,\n+    ptrs: HashSet<hir::def_id::DefId>,\n+}\n+\n+impl<'a, 'tcx, 'v> hir::intravisit::Visitor<'v> for DerefVisitor<'a, 'tcx> {\n+    fn visit_expr(&mut self, expr: &'v hir::Expr) {\n+        match expr.node {\n+            hir::ExprCall(ref f, ref args) => {\n+                let ty = self.cx.tcx.expr_ty(f);\n+\n+                if type_is_unsafe_function(ty) {\n+                    for arg in args {\n+                        self.check_arg(arg);\n+                    }\n+                }\n+            }\n+            hir::ExprMethodCall(_, _, ref args) => {\n+                let method_call = ty::MethodCall::expr(expr.id);\n+                let base_type = self.cx.tcx.tables.borrow().method_map[&method_call].ty;\n+\n+                if type_is_unsafe_function(base_type) {\n+                    for arg in args {\n+                        self.check_arg(arg);\n+                    }\n+                }\n+            }\n+            hir::ExprUnary(hir::UnDeref, ref ptr) => self.check_arg(ptr),\n+            _ => (),\n+        }\n+\n+        hir::intravisit::walk_expr(self, expr);\n+    }\n+}\n+\n+impl<'a, 'tcx: 'a> DerefVisitor<'a, 'tcx> {\n+    fn check_arg(&self, ptr: &hir::Expr) {\n+        if let Some(def) = self.cx.tcx.def_map.borrow().get(&ptr.id) {\n+            if self.ptrs.contains(&def.full_def().def_id()) {\n+                span_lint(self.cx,\n+                          NOT_UNSAFE_PTR_ARG_DEREF,\n+                          ptr.span,\n+                          \"this public function dereferences a raw pointer but is not marked `unsafe`\");\n+            }\n+        }\n+    }\n }"}, {"sha": "411be22411847f38bb34510bfcfd0d3657e8c757", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7778f314f2dfdc1b9749b6e4f21686dff27df6ac/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7778f314f2dfdc1b9749b6e4f21686dff27df6ac/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=7778f314f2dfdc1b9749b6e4f21686dff27df6ac", "patch": "@@ -324,6 +324,7 @@ pub fn register_plugins(reg: &mut rustc_plugin::Registry) {\n         format::USELESS_FORMAT,\n         formatting::SUSPICIOUS_ASSIGNMENT_FORMATTING,\n         formatting::SUSPICIOUS_ELSE_FORMATTING,\n+        functions::NOT_UNSAFE_PTR_ARG_DEREF,\n         functions::TOO_MANY_ARGUMENTS,\n         identity_op::IDENTITY_OP,\n         len_zero::LEN_WITHOUT_IS_EMPTY,"}, {"sha": "9d5c436c2cbc03e88b7ff34cdef617ff1fcec187", "filename": "clippy_lints/src/methods.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/7778f314f2dfdc1b9749b6e4f21686dff27df6ac/clippy_lints%2Fsrc%2Fmethods.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7778f314f2dfdc1b9749b6e4f21686dff27df6ac/clippy_lints%2Fsrc%2Fmethods.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmethods.rs?ref=7778f314f2dfdc1b9749b6e4f21686dff27df6ac", "patch": "@@ -73,7 +73,7 @@ declare_lint! {\n /// |`is_`  |`&self` or none     |\n /// |`to_`  |`&self`             |\n ///\n-/// **Why is this bad?** Consistency breeds readability. If you follow the conventions, your users won't be surprised that they e.g. need to supply a mutable reference to a `as_..` function.\n+/// **Why is this bad?** Consistency breeds readability. If you follow the conventions, your users won't be surprised that they, e.g., need to supply a mutable reference to a `as_..` function.\n ///\n /// **Known problems:** None\n ///"}, {"sha": "189801c8c0b5615b778907b9553977fa900d6a75", "filename": "clippy_lints/src/utils/mod.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/7778f314f2dfdc1b9749b6e4f21686dff27df6ac/clippy_lints%2Fsrc%2Futils%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7778f314f2dfdc1b9749b6e4f21686dff27df6ac/clippy_lints%2Fsrc%2Futils%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Futils%2Fmod.rs?ref=7778f314f2dfdc1b9749b6e4f21686dff27df6ac", "patch": "@@ -714,3 +714,12 @@ pub fn same_tys<'a, 'tcx>(cx: &LateContext<'a, 'tcx>, a: ty::Ty<'tcx>, b: ty::Ty\n         infcx.can_equate(&new_a, &new_b).is_ok()\n     })\n }\n+\n+/// Return whether the given type is an `unsafe` function.\n+pub fn type_is_unsafe_function(ty: ty::Ty) -> bool {\n+    match ty.sty {\n+        ty::TyFnDef(_, _, ref f) |\n+        ty::TyFnPtr(ref f) => f.unsafety == Unsafety::Unsafe,\n+        _ => false,\n+    }\n+}"}, {"sha": "114817989d8d1f9df158b8588575ead80641da0d", "filename": "clippy_lints/src/vec.rs", "status": "modified", "additions": 21, "deletions": 15, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/7778f314f2dfdc1b9749b6e4f21686dff27df6ac/clippy_lints%2Fsrc%2Fvec.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7778f314f2dfdc1b9749b6e4f21686dff27df6ac/clippy_lints%2Fsrc%2Fvec.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fvec.rs?ref=7778f314f2dfdc1b9749b6e4f21686dff27df6ac", "patch": "@@ -1,6 +1,8 @@\n use rustc::lint::*;\n use rustc::ty::TypeVariants;\n use rustc::hir::*;\n+use rustc_const_eval::EvalHint::ExprTypeChecked;\n+use rustc_const_eval::eval_const_expr_partial;\n use syntax::codemap::Span;\n use utils::{higher, snippet, span_lint_and_then};\n \n@@ -51,26 +53,30 @@ impl LateLintPass for Pass {\n \n fn check_vec_macro(cx: &LateContext, vec: &Expr, span: Span) {\n     if let Some(vec_args) = higher::vec_macro(cx, vec) {\n-        span_lint_and_then(cx, USELESS_VEC, span, \"useless use of `vec!`\", |db| {\n-            let snippet = match vec_args {\n-                higher::VecArgs::Repeat(elem, len) => {\n+        let snippet = match vec_args {\n+            higher::VecArgs::Repeat(elem, len) => {\n+                if eval_const_expr_partial(cx.tcx, len, ExprTypeChecked, None).is_ok() {\n                     format!(\"&[{}; {}]\", snippet(cx, elem.span, \"elem\"), snippet(cx, len.span, \"len\")).into()\n+                } else {\n+                    return;\n                 }\n-                higher::VecArgs::Vec(args) => {\n-                    if let Some(last) = args.iter().last() {\n-                        let span = Span {\n-                            lo: args[0].span.lo,\n-                            hi: last.span.hi,\n-                            expn_id: args[0].span.expn_id,\n-                        };\n+            }\n+            higher::VecArgs::Vec(args) => {\n+                if let Some(last) = args.iter().last() {\n+                    let span = Span {\n+                        lo: args[0].span.lo,\n+                        hi: last.span.hi,\n+                        expn_id: args[0].span.expn_id,\n+                    };\n \n-                        format!(\"&[{}]\", snippet(cx, span, \"..\")).into()\n-                    } else {\n-                        \"&[]\".into()\n-                    }\n+                    format!(\"&[{}]\", snippet(cx, span, \"..\")).into()\n+                } else {\n+                    \"&[]\".into()\n                 }\n-            };\n+            }\n+        };\n \n+        span_lint_and_then(cx, USELESS_VEC, span, \"useless use of `vec!`\", |db| {\n             db.span_suggestion(span, \"you can use a slice directly\", snippet);\n         });\n     }"}, {"sha": "f7ee41d281699d631863a8f4e3e4b1f97d526160", "filename": "tests/compile-fail/functions.rs", "status": "modified", "additions": 56, "deletions": 2, "changes": 58, "blob_url": "https://github.com/rust-lang/rust/blob/7778f314f2dfdc1b9749b6e4f21686dff27df6ac/tests%2Fcompile-fail%2Ffunctions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7778f314f2dfdc1b9749b6e4f21686dff27df6ac/tests%2Fcompile-fail%2Ffunctions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Ffunctions.rs?ref=7778f314f2dfdc1b9749b6e4f21686dff27df6ac", "patch": "@@ -3,20 +3,24 @@\n \n #![deny(clippy)]\n #![allow(dead_code)]\n+#![allow(unused_unsafe)]\n \n+// TOO_MANY_ARGUMENTS\n fn good(_one: u32, _two: u32, _three: &str, _four: bool, _five: f32, _six: f32, _seven: bool) {}\n \n fn bad(_one: u32, _two: u32, _three: &str, _four: bool, _five: f32, _six: f32, _seven: bool, _eight: ()) {\n     //~^ ERROR: this function has too many arguments (8/7)\n }\n \n-trait Foo {\n+pub trait Foo {\n     fn good(_one: u32, _two: u32, _three: &str, _four: bool, _five: f32, _six: f32, _seven: bool);\n     fn bad(_one: u32, _two: u32, _three: &str, _four: bool, _five: f32, _six: f32, _seven: bool, _eight: ());\n     //~^ ERROR: this function has too many arguments (8/7)\n+\n+    fn ptr(p: *const u8);\n }\n \n-struct Bar;\n+pub struct Bar;\n \n impl Bar {\n     fn good_method(_one: u32, _two: u32, _three: &str, _four: bool, _five: f32, _six: f32, _seven: bool) {}\n@@ -28,6 +32,56 @@ impl Bar {\n impl Foo for Bar {\n     fn good(_one: u32, _two: u32, _three: &str, _four: bool, _five: f32, _six: f32, _seven: bool) {}\n     fn bad(_one: u32, _two: u32, _three: &str, _four: bool, _five: f32, _six: f32, _seven: bool, _eight: ()) {}\n+\n+    fn ptr(p: *const u8) {\n+        println!(\"{}\", unsafe { *p });\n+        //~^ ERROR: this public function dereferences a raw pointer but is not marked `unsafe`\n+        println!(\"{:?}\", unsafe { p.as_ref() });\n+        //~^ ERROR: this public function dereferences a raw pointer but is not marked `unsafe`\n+        unsafe { std::ptr::read(p) };\n+        //~^ ERROR: this public function dereferences a raw pointer but is not marked `unsafe`\n+    }\n+}\n+\n+// NOT_UNSAFE_PTR_ARG_DEREF\n+\n+fn private(p: *const u8) {\n+    println!(\"{}\", unsafe { *p });\n+}\n+\n+pub fn public(p: *const u8) {\n+    println!(\"{}\", unsafe { *p });\n+    //~^ ERROR: this public function dereferences a raw pointer but is not marked `unsafe`\n+    println!(\"{:?}\", unsafe { p.as_ref() });\n+    //~^ ERROR: this public function dereferences a raw pointer but is not marked `unsafe`\n+    unsafe { std::ptr::read(p) };\n+    //~^ ERROR: this public function dereferences a raw pointer but is not marked `unsafe`\n+}\n+\n+impl Bar {\n+    fn private(self, p: *const u8) {\n+        println!(\"{}\", unsafe { *p });\n+    }\n+\n+    pub fn public(self, p: *const u8) {\n+        println!(\"{}\", unsafe { *p });\n+        //~^ ERROR: this public function dereferences a raw pointer but is not marked `unsafe`\n+        println!(\"{:?}\", unsafe { p.as_ref() });\n+        //~^ ERROR: this public function dereferences a raw pointer but is not marked `unsafe`\n+        unsafe { std::ptr::read(p) };\n+        //~^ ERROR: this public function dereferences a raw pointer but is not marked `unsafe`\n+    }\n+\n+    pub fn public_ok(self, p: *const u8) {\n+        if !p.is_null() {\n+            println!(\"{:p}\", p);\n+        }\n+    }\n+\n+    pub unsafe fn public_unsafe(self, p: *const u8) {\n+        println!(\"{}\", unsafe { *p });\n+        println!(\"{:?}\", unsafe { p.as_ref() });\n+    }\n }\n \n fn main() {}"}, {"sha": "92c99c20e36ea8ce3f8656e865fb374bed3a9acc", "filename": "tests/compile-fail/vec.rs", "status": "modified", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/7778f314f2dfdc1b9749b6e4f21686dff27df6ac/tests%2Fcompile-fail%2Fvec.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7778f314f2dfdc1b9749b6e4f21686dff27df6ac/tests%2Fcompile-fail%2Fvec.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Fvec.rs?ref=7778f314f2dfdc1b9749b6e4f21686dff27df6ac", "patch": "@@ -7,6 +7,16 @@ fn on_slice(_: &[u8]) {}\n #[allow(ptr_arg)]\n fn on_vec(_: &Vec<u8>) {}\n \n+struct Line {\n+    length: usize,\n+}\n+\n+impl Line {\n+    fn length(&self) -> usize {\n+        self.length\n+    }\n+}\n+\n fn main() {\n     on_slice(&vec![]);\n     //~^ ERROR useless use of `vec!`\n@@ -42,6 +52,12 @@ fn main() {\n     on_vec(&vec![1, 2]);\n     on_vec(&vec![1; 2]);\n \n+    // Now with non-constant expressions\n+    let line = Line { length: 2 };\n+\n+    on_slice(&vec![2; line.length]);\n+    on_slice(&vec![2; line.length()]);\n+\n     for a in vec![1, 2, 3] {\n         //~^ ERROR useless use of `vec!`\n         //~| HELP you can use"}]}