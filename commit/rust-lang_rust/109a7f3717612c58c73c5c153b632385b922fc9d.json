{"sha": "109a7f3717612c58c73c5c153b632385b922fc9d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjEwOWE3ZjM3MTc2MTJjNThjNzNjNWMxNTNiNjMyMzg1YjkyMmZjOWQ=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2018-11-27T19:58:09Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2018-11-27T19:58:09Z"}, "message": "itroduce FunctionDescriptor", "tree": {"sha": "195ab74809d05b38938a25a68d327084abb25984", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/195ab74809d05b38938a25a68d327084abb25984"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/109a7f3717612c58c73c5c153b632385b922fc9d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/109a7f3717612c58c73c5c153b632385b922fc9d", "html_url": "https://github.com/rust-lang/rust/commit/109a7f3717612c58c73c5c153b632385b922fc9d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/109a7f3717612c58c73c5c153b632385b922fc9d/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f4d0cb64fc8b3010bdc4b168a2fa6d96a6cf90b1", "url": "https://api.github.com/repos/rust-lang/rust/commits/f4d0cb64fc8b3010bdc4b168a2fa6d96a6cf90b1", "html_url": "https://github.com/rust-lang/rust/commit/f4d0cb64fc8b3010bdc4b168a2fa6d96a6cf90b1"}], "stats": {"total": 45, "additions": 36, "deletions": 9}, "files": [{"sha": "c8af6bc21db990ddbcfd82a404a3887699460177", "filename": "crates/ra_analysis/src/hir/function/mod.rs", "status": "modified", "additions": 24, "deletions": 1, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/109a7f3717612c58c73c5c153b632385b922fc9d/crates%2Fra_analysis%2Fsrc%2Fhir%2Ffunction%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/109a7f3717612c58c73c5c153b632385b922fc9d/crates%2Fra_analysis%2Fsrc%2Fhir%2Ffunction%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_analysis%2Fsrc%2Fhir%2Ffunction%2Fmod.rs?ref=109a7f3717612c58c73c5c153b632385b922fc9d", "patch": "@@ -1,14 +1,18 @@\n pub(super) mod imp;\n mod scope;\n \n-use std::cmp::{max, min};\n+use std::{\n+    cmp::{max, min},\n+    sync::Arc,\n+};\n \n use ra_syntax::{\n     ast::{self, AstNode, DocCommentsOwner, NameOwner},\n     TextRange, TextUnit,\n };\n \n use crate::{\n+    hir::HirDatabase,\n     syntax_ptr::SyntaxPtr, FileId,\n     loc2id::IdDatabase,\n };\n@@ -23,6 +27,25 @@ impl FnId {\n     }\n }\n \n+pub(crate) struct FunctionDescriptor {\n+    fn_id: FnId,\n+}\n+\n+impl FunctionDescriptor {\n+    pub(crate) fn guess_from_source(\n+        db: &impl HirDatabase,\n+        file_id: FileId,\n+        fn_def: ast::FnDef,\n+    ) -> FunctionDescriptor {\n+        let fn_id = FnId::get(db, file_id, fn_def);\n+        FunctionDescriptor { fn_id }\n+    }\n+\n+    pub(crate) fn scope(&self, db: &impl HirDatabase) -> Arc<FnScopes> {\n+        db.fn_scopes(self.fn_id)\n+    }\n+}\n+\n #[derive(Debug, Clone)]\n pub struct FnDescriptor {\n     pub name: String,"}, {"sha": "edeaeb8e6f543d7a560270aa7ba137344ca33982", "filename": "crates/ra_analysis/src/hir/mod.rs", "status": "modified", "additions": 6, "deletions": 3, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/109a7f3717612c58c73c5c153b632385b922fc9d/crates%2Fra_analysis%2Fsrc%2Fhir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/109a7f3717612c58c73c5c153b632385b922fc9d/crates%2Fra_analysis%2Fsrc%2Fhir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_analysis%2Fsrc%2Fhir%2Fmod.rs?ref=109a7f3717612c58c73c5c153b632385b922fc9d", "patch": "@@ -21,7 +21,7 @@ use crate::{\n     db::SyntaxDatabase,\n     hir::function::{resolve_local_name, FnId, FnScopes},\n     hir::module::{\n-        ModuleId, ModuleTree, ModuleSource, ModuleDescriptor,\n+        ModuleId, ModuleTree, ModuleSource,\n         nameres::{ItemMap, InputModuleItems, FileItems}\n     },\n     input::SourceRootId,\n@@ -30,8 +30,11 @@ use crate::{\n     Cancelable,\n };\n \n-pub(crate) use self::path::{Path, PathKind};\n-pub(crate) use self::module::nameres::FileItemId;\n+pub(crate) use self::{\n+    path::{Path, PathKind},\n+    module::{ModuleDescriptor, nameres::FileItemId},\n+    function::FunctionDescriptor,\n+};\n \n salsa::query_group! {\n pub(crate) trait HirDatabase: SyntaxDatabase + IdDatabase {"}, {"sha": "ad4b40c5894e2246ca35be8cbadb9f725fff3d63", "filename": "crates/ra_analysis/src/imp.rs", "status": "modified", "additions": 6, "deletions": 5, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/109a7f3717612c58c73c5c153b632385b922fc9d/crates%2Fra_analysis%2Fsrc%2Fimp.rs", "raw_url": "https://github.com/rust-lang/rust/raw/109a7f3717612c58c73c5c153b632385b922fc9d/crates%2Fra_analysis%2Fsrc%2Fimp.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_analysis%2Fsrc%2Fimp.rs?ref=109a7f3717612c58c73c5c153b632385b922fc9d", "patch": "@@ -20,9 +20,10 @@ use crate::{\n     completion::{completions, CompletionItem},\n     db::{self, FileSyntaxQuery, SyntaxDatabase},\n     hir::{\n-        function::{FnDescriptor, FnId},\n-        module::{ModuleDescriptor, Problem},\n-        DeclarationDescriptor, HirDatabase,\n+        FunctionDescriptor, ModuleDescriptor,\n+        function::FnDescriptor,\n+        module::{Problem},\n+        DeclarationDescriptor,\n     },\n     input::{FilesDatabase, SourceRoot, SourceRootId, WORKSPACE},\n     symbol_index::SymbolIndex,\n@@ -587,8 +588,8 @@ fn resolve_local_name(\n     name_ref: ast::NameRef,\n ) -> Option<(SmolStr, TextRange)> {\n     let fn_def = name_ref.syntax().ancestors().find_map(ast::FnDef::cast)?;\n-    let fn_id = FnId::get(db, file_id, fn_def);\n-    let scopes = db.fn_scopes(fn_id);\n+    let function = FunctionDescriptor::guess_from_source(db, file_id, fn_def);\n+    let scopes = function.scope(db);\n     let scope_entry = crate::hir::function::resolve_local_name(name_ref, &scopes)?;\n     let syntax = db.resolve_syntax_ptr(scope_entry.ptr().into_global(file_id));\n     Some((scope_entry.name().clone(), syntax.range()))"}]}