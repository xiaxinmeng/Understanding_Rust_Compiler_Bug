{"sha": "846c372f86dfad597797ee73665f330fc557c63f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg0NmMzNzJmODZkZmFkNTk3Nzk3ZWU3MzY2NWYzMzBmYzU1N2M2M2Y=", "commit": {"author": {"name": "Wesley Wiser", "email": "wesleywiser@microsoft.com", "date": "2021-08-20T20:25:39Z"}, "committer": {"name": "Michael Woerister", "email": "michaelwoerister@posteo", "date": "2021-08-30T09:51:27Z"}, "message": "Don't allow both the `+bundle` and `+whole-archive` modifiers for rlibs", "tree": {"sha": "c677dfa15c8136df5f6b4eac93a756ada23e184e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c677dfa15c8136df5f6b4eac93a756ada23e184e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/846c372f86dfad597797ee73665f330fc557c63f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/846c372f86dfad597797ee73665f330fc557c63f", "html_url": "https://github.com/rust-lang/rust/commit/846c372f86dfad597797ee73665f330fc557c63f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/846c372f86dfad597797ee73665f330fc557c63f/comments", "author": {"login": "wesleywiser", "id": 831192, "node_id": "MDQ6VXNlcjgzMTE5Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/831192?v=4", "gravatar_id": "", "url": "https://api.github.com/users/wesleywiser", "html_url": "https://github.com/wesleywiser", "followers_url": "https://api.github.com/users/wesleywiser/followers", "following_url": "https://api.github.com/users/wesleywiser/following{/other_user}", "gists_url": "https://api.github.com/users/wesleywiser/gists{/gist_id}", "starred_url": "https://api.github.com/users/wesleywiser/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/wesleywiser/subscriptions", "organizations_url": "https://api.github.com/users/wesleywiser/orgs", "repos_url": "https://api.github.com/users/wesleywiser/repos", "events_url": "https://api.github.com/users/wesleywiser/events{/privacy}", "received_events_url": "https://api.github.com/users/wesleywiser/received_events", "type": "User", "site_admin": false}, "committer": {"login": "michaelwoerister", "id": 1825894, "node_id": "MDQ6VXNlcjE4MjU4OTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1825894?v=4", "gravatar_id": "", "url": "https://api.github.com/users/michaelwoerister", "html_url": "https://github.com/michaelwoerister", "followers_url": "https://api.github.com/users/michaelwoerister/followers", "following_url": "https://api.github.com/users/michaelwoerister/following{/other_user}", "gists_url": "https://api.github.com/users/michaelwoerister/gists{/gist_id}", "starred_url": "https://api.github.com/users/michaelwoerister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/michaelwoerister/subscriptions", "organizations_url": "https://api.github.com/users/michaelwoerister/orgs", "repos_url": "https://api.github.com/users/michaelwoerister/repos", "events_url": "https://api.github.com/users/michaelwoerister/events{/privacy}", "received_events_url": "https://api.github.com/users/michaelwoerister/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "522f9757f6b9665b9452dea95fc42ebb604a05fe", "url": "https://api.github.com/repos/rust-lang/rust/commits/522f9757f6b9665b9452dea95fc42ebb604a05fe", "html_url": "https://github.com/rust-lang/rust/commit/522f9757f6b9665b9452dea95fc42ebb604a05fe"}], "stats": {"total": 45, "additions": 45, "deletions": 0}, "files": [{"sha": "173b91e7903dee2f85761b270030c5d1845abe10", "filename": "compiler/rustc_codegen_ssa/src/back/link.rs", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/846c372f86dfad597797ee73665f330fc557c63f/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/846c372f86dfad597797ee73665f330fc557c63f/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs?ref=846c372f86dfad597797ee73665f330fc557c63f", "patch": "@@ -255,6 +255,19 @@ fn link_rlib<'a, B: ArchiveBuilder<'a>>(\n     // metadata of the rlib we're generating somehow.\n     for lib in codegen_results.crate_info.used_libraries.iter() {\n         match lib.kind {\n+            NativeLibKind::Static { bundle: None | Some(true), whole_archive: Some(true) }\n+                if flavor == RlibFlavor::Normal =>\n+            {\n+                // Don't allow mixing +bundle with +whole_archive since an rlib may contain\n+                // multiple native libs, some of which are +whole-archive and some of which are\n+                // -whole-archive and it isn't clear how we can currently handle such a\n+                // situation correctly.\n+                // See https://github.com/rust-lang/rust/issues/88085#issuecomment-901050897\n+                sess.err(\n+                    \"the linking modifiers `+bundle` and `+whole-archive` are not compatible \\\n+                        with each other when generating rlibs\",\n+                );\n+            }\n             NativeLibKind::Static { bundle: None | Some(true), .. } => {}\n             NativeLibKind::Static { bundle: Some(false), .. }\n             | NativeLibKind::Dylib { .. }\n@@ -1223,6 +1236,7 @@ pub fn archive_search_paths(sess: &Session) -> Vec<PathBuf> {\n     sess.target_filesearch(PathKind::Native).search_path_dirs()\n }\n \n+#[derive(PartialEq)]\n enum RlibFlavor {\n     Normal,\n     StaticlibBase,"}, {"sha": "c3714a384518053bff409884a14b15380aa1c098", "filename": "src/test/ui/native-library-link-flags/mix-bundle-and-whole-archive-link-attr.rs", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/846c372f86dfad597797ee73665f330fc557c63f/src%2Ftest%2Fui%2Fnative-library-link-flags%2Fmix-bundle-and-whole-archive-link-attr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/846c372f86dfad597797ee73665f330fc557c63f/src%2Ftest%2Fui%2Fnative-library-link-flags%2Fmix-bundle-and-whole-archive-link-attr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fnative-library-link-flags%2Fmix-bundle-and-whole-archive-link-attr.rs?ref=846c372f86dfad597797ee73665f330fc557c63f", "patch": "@@ -0,0 +1,12 @@\n+// compile-flags: -Zunstable-options --crate-type rlib\n+// build-fail\n+// error-pattern: the linking modifiers `+bundle` and `+whole-archive` are not compatible with each other when generating rlibs\n+\n+#![feature(native_link_modifiers)]\n+#![feature(native_link_modifiers_bundle)]\n+#![feature(native_link_modifiers_whole_archive)]\n+\n+#[link(name = \"mylib\", kind = \"static\", modifiers = \"+bundle,+whole-archive\")]\n+extern \"C\" { }\n+\n+fn main() { }"}, {"sha": "246efb8d627cb5430ebd6a415b618e9625d673ba", "filename": "src/test/ui/native-library-link-flags/mix-bundle-and-whole-archive-link-attr.stderr", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/846c372f86dfad597797ee73665f330fc557c63f/src%2Ftest%2Fui%2Fnative-library-link-flags%2Fmix-bundle-and-whole-archive-link-attr.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/846c372f86dfad597797ee73665f330fc557c63f/src%2Ftest%2Fui%2Fnative-library-link-flags%2Fmix-bundle-and-whole-archive-link-attr.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fnative-library-link-flags%2Fmix-bundle-and-whole-archive-link-attr.stderr?ref=846c372f86dfad597797ee73665f330fc557c63f", "patch": "@@ -0,0 +1,6 @@\n+error: the linking modifiers `+bundle` and `+whole-archive` are not compatible with each other when generating rlibs\n+\n+error: could not find native static library `mylib`, perhaps an -L flag is missing?\n+\n+error: aborting due to 2 previous errors\n+"}, {"sha": "1d0768d99cffd9284c08ef03fd1b7215c4617a29", "filename": "src/test/ui/native-library-link-flags/mix-bundle-and-whole-archive.rs", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/846c372f86dfad597797ee73665f330fc557c63f/src%2Ftest%2Fui%2Fnative-library-link-flags%2Fmix-bundle-and-whole-archive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/846c372f86dfad597797ee73665f330fc557c63f/src%2Ftest%2Fui%2Fnative-library-link-flags%2Fmix-bundle-and-whole-archive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fnative-library-link-flags%2Fmix-bundle-and-whole-archive.rs?ref=846c372f86dfad597797ee73665f330fc557c63f", "patch": "@@ -0,0 +1,7 @@\n+// Mixing +bundle and +whole-archive is not allowed\n+\n+// compile-flags: -l static:+bundle,+whole-archive=mylib -Zunstable-options --crate-type rlib\n+// build-fail\n+// error-pattern: the linking modifiers `+bundle` and `+whole-archive` are not compatible with each other when generating rlibs\n+\n+fn main() { }"}, {"sha": "246efb8d627cb5430ebd6a415b618e9625d673ba", "filename": "src/test/ui/native-library-link-flags/mix-bundle-and-whole-archive.stderr", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/846c372f86dfad597797ee73665f330fc557c63f/src%2Ftest%2Fui%2Fnative-library-link-flags%2Fmix-bundle-and-whole-archive.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/846c372f86dfad597797ee73665f330fc557c63f/src%2Ftest%2Fui%2Fnative-library-link-flags%2Fmix-bundle-and-whole-archive.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fnative-library-link-flags%2Fmix-bundle-and-whole-archive.stderr?ref=846c372f86dfad597797ee73665f330fc557c63f", "patch": "@@ -0,0 +1,6 @@\n+error: the linking modifiers `+bundle` and `+whole-archive` are not compatible with each other when generating rlibs\n+\n+error: could not find native static library `mylib`, perhaps an -L flag is missing?\n+\n+error: aborting due to 2 previous errors\n+"}]}