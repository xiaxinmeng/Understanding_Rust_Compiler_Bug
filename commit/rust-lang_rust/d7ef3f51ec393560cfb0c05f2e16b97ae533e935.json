{"sha": "d7ef3f51ec393560cfb0c05f2e16b97ae533e935", "node_id": "C_kwDOAAsO6NoAKGQ3ZWYzZjUxZWMzOTM1NjBjZmIwYzA1ZjJlMTZiOTdhZTUzM2U5MzU", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2022-09-04T16:56:01Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2022-09-04T17:12:55Z"}, "message": "fix: correct broken logic for return complition\n\nIt seems that we've accidentally deleted the tests here couple of years\nago, and then fairly recently made a typo during refactor as well.\n\nReinstall tests, with coverage marks this time :-)", "tree": {"sha": "2f1744f3ee4c05e9228e4850dad265bcb3c2493c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2f1744f3ee4c05e9228e4850dad265bcb3c2493c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d7ef3f51ec393560cfb0c05f2e16b97ae533e935", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d7ef3f51ec393560cfb0c05f2e16b97ae533e935", "html_url": "https://github.com/rust-lang/rust/commit/d7ef3f51ec393560cfb0c05f2e16b97ae533e935", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d7ef3f51ec393560cfb0c05f2e16b97ae533e935/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8ddb8b7e8ed9fd99f580503b5ee94e8452d57f5e", "url": "https://api.github.com/repos/rust-lang/rust/commits/8ddb8b7e8ed9fd99f580503b5ee94e8452d57f5e", "html_url": "https://github.com/rust-lang/rust/commit/8ddb8b7e8ed9fd99f580503b5ee94e8452d57f5e"}], "stats": {"total": 62, "additions": 55, "deletions": 7}, "files": [{"sha": "588b52cc1ee3a72090d66899fdf89756ad6c48f3", "filename": "crates/ide-completion/src/completions/expr.rs", "status": "modified", "additions": 18, "deletions": 6, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/d7ef3f51ec393560cfb0c05f2e16b97ae533e935/crates%2Fide-completion%2Fsrc%2Fcompletions%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d7ef3f51ec393560cfb0c05f2e16b97ae533e935/crates%2Fide-completion%2Fsrc%2Fcompletions%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Fcompletions%2Fexpr.rs?ref=d7ef3f51ec393560cfb0c05f2e16b97ae533e935", "patch": "@@ -282,14 +282,26 @@ pub(crate) fn complete_expr_path(\n                         }\n                     }\n \n-                    if let Some(ty) = innermost_ret_ty {\n+                    if let Some(ret_ty) = innermost_ret_ty {\n                         add_keyword(\n                             \"return\",\n-                            match (in_block_expr, ty.is_unit()) {\n-                                (true, true) => \"return ;\",\n-                                (true, false) => \"return;\",\n-                                (false, true) => \"return $0\",\n-                                (false, false) => \"return\",\n+                            match (ret_ty.is_unit(), in_block_expr) {\n+                                (true, true) => {\n+                                    cov_mark::hit!(return_unit_block);\n+                                    \"return;\"\n+                                }\n+                                (true, false) => {\n+                                    cov_mark::hit!(return_unit_no_block);\n+                                    \"return\"\n+                                }\n+                                (false, true) => {\n+                                    cov_mark::hit!(return_value_block);\n+                                    \"return $0;\"\n+                                }\n+                                (false, false) => {\n+                                    cov_mark::hit!(return_value_no_block);\n+                                    \"return $0\"\n+                                }\n                             },\n                         );\n                     }"}, {"sha": "38e24ebc732d497aa4250f6fe23d06a2c2614f61", "filename": "crates/ide-completion/src/tests/expression.rs", "status": "modified", "additions": 37, "deletions": 1, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/d7ef3f51ec393560cfb0c05f2e16b97ae533e935/crates%2Fide-completion%2Fsrc%2Ftests%2Fexpression.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d7ef3f51ec393560cfb0c05f2e16b97ae533e935/crates%2Fide-completion%2Fsrc%2Ftests%2Fexpression.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-completion%2Fsrc%2Ftests%2Fexpression.rs?ref=d7ef3f51ec393560cfb0c05f2e16b97ae533e935", "patch": "@@ -1,7 +1,7 @@\n //! Completion tests for expressions.\n use expect_test::{expect, Expect};\n \n-use crate::tests::{completion_list, BASE_ITEMS_FIXTURE};\n+use crate::tests::{check_edit, completion_list, BASE_ITEMS_FIXTURE};\n \n fn check(ra_fixture: &str, expect: Expect) {\n     let actual = completion_list(&format!(\"{}{}\", BASE_ITEMS_FIXTURE, ra_fixture));\n@@ -670,3 +670,39 @@ fn main() {\n         \"#]],\n     );\n }\n+\n+#[test]\n+fn return_unit_block() {\n+    cov_mark::check!(return_unit_block);\n+    check_edit(\"return\", r#\"fn f() { if true { $0 } }\"#, r#\"fn f() { if true { return; } }\"#);\n+}\n+\n+#[test]\n+fn return_unit_no_block() {\n+    cov_mark::check!(return_unit_no_block);\n+    check_edit(\n+        \"return\",\n+        r#\"fn f() { match () { () => $0 } }\"#,\n+        r#\"fn f() { match () { () => return } }\"#,\n+    );\n+}\n+\n+#[test]\n+fn return_value_block() {\n+    cov_mark::check!(return_value_block);\n+    check_edit(\n+        \"return\",\n+        r#\"fn f() -> i32 { if true { $0 } }\"#,\n+        r#\"fn f() -> i32 { if true { return $0; } }\"#,\n+    );\n+}\n+\n+#[test]\n+fn return_value_no_block() {\n+    cov_mark::check!(return_value_no_block);\n+    check_edit(\n+        \"return\",\n+        r#\"fn f() -> i32 { match () { () => $0 } }\"#,\n+        r#\"fn f() -> i32 { match () { () => return $0 } }\"#,\n+    );\n+}"}]}