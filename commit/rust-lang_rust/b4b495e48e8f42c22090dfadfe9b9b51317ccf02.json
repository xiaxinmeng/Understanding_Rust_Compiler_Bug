{"sha": "b4b495e48e8f42c22090dfadfe9b9b51317ccf02", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI0YjQ5NWU0OGU4ZjQyYzIyMDkwZGZhZGZlOWI5YjUxMzE3Y2NmMDI=", "commit": {"author": {"name": "Xuanwo", "email": "github@xuanwo.io", "date": "2021-08-16T05:37:51Z"}, "committer": {"name": "Xuanwo", "email": "github@xuanwo.io", "date": "2021-08-16T05:37:51Z"}, "message": "Optimize unnecessary check in VecDeque::retain\n\nSigned-off-by: Xuanwo <github@xuanwo.io>", "tree": {"sha": "15912ca404eaa2d805edc7bd5c9286d09829bd3b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/15912ca404eaa2d805edc7bd5c9286d09829bd3b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b4b495e48e8f42c22090dfadfe9b9b51317ccf02", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niHUEABYIAB0WIQS0g6EMly6nymf8UQ5LnJWuBIMyLQUCYRn5wwAKCRBLnJWuBIMy\nLflUAP4vwBrZi4OdRZuYZEQGqMmC4UmSyNjezZ/kB24r5YtkmAD+KR0xVvzeJCKq\n3CGxs5Ht4mcCqw6HJn1WW1h98BJFoAo=\n=cKg8\n-----END PGP SIGNATURE-----", "payload": "tree 15912ca404eaa2d805edc7bd5c9286d09829bd3b\nparent 2bd17c1d43bba43412cc2f051323a279d6751e43\nauthor Xuanwo <github@xuanwo.io> 1629092271 +0800\ncommitter Xuanwo <github@xuanwo.io> 1629092271 +0800\n\nOptimize unnecessary check in VecDeque::retain\n\nSigned-off-by: Xuanwo <github@xuanwo.io>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b4b495e48e8f42c22090dfadfe9b9b51317ccf02", "html_url": "https://github.com/rust-lang/rust/commit/b4b495e48e8f42c22090dfadfe9b9b51317ccf02", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b4b495e48e8f42c22090dfadfe9b9b51317ccf02/comments", "author": {"login": "Xuanwo", "id": 5351546, "node_id": "MDQ6VXNlcjUzNTE1NDY=", "avatar_url": "https://avatars.githubusercontent.com/u/5351546?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Xuanwo", "html_url": "https://github.com/Xuanwo", "followers_url": "https://api.github.com/users/Xuanwo/followers", "following_url": "https://api.github.com/users/Xuanwo/following{/other_user}", "gists_url": "https://api.github.com/users/Xuanwo/gists{/gist_id}", "starred_url": "https://api.github.com/users/Xuanwo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Xuanwo/subscriptions", "organizations_url": "https://api.github.com/users/Xuanwo/orgs", "repos_url": "https://api.github.com/users/Xuanwo/repos", "events_url": "https://api.github.com/users/Xuanwo/events{/privacy}", "received_events_url": "https://api.github.com/users/Xuanwo/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Xuanwo", "id": 5351546, "node_id": "MDQ6VXNlcjUzNTE1NDY=", "avatar_url": "https://avatars.githubusercontent.com/u/5351546?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Xuanwo", "html_url": "https://github.com/Xuanwo", "followers_url": "https://api.github.com/users/Xuanwo/followers", "following_url": "https://api.github.com/users/Xuanwo/following{/other_user}", "gists_url": "https://api.github.com/users/Xuanwo/gists{/gist_id}", "starred_url": "https://api.github.com/users/Xuanwo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Xuanwo/subscriptions", "organizations_url": "https://api.github.com/users/Xuanwo/orgs", "repos_url": "https://api.github.com/users/Xuanwo/repos", "events_url": "https://api.github.com/users/Xuanwo/events{/privacy}", "received_events_url": "https://api.github.com/users/Xuanwo/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2bd17c1d43bba43412cc2f051323a279d6751e43", "url": "https://api.github.com/repos/rust-lang/rust/commits/2bd17c1d43bba43412cc2f051323a279d6751e43", "html_url": "https://github.com/rust-lang/rust/commit/2bd17c1d43bba43412cc2f051323a279d6751e43"}], "stats": {"total": 67, "additions": 59, "deletions": 8}, "files": [{"sha": "e4b28204158d9d3372ade952b5487eb1e96ebfd7", "filename": "library/alloc/src/collections/vec_deque/mod.rs", "status": "modified", "additions": 24, "deletions": 8, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/b4b495e48e8f42c22090dfadfe9b9b51317ccf02/library%2Falloc%2Fsrc%2Fcollections%2Fvec_deque%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b4b495e48e8f42c22090dfadfe9b9b51317ccf02/library%2Falloc%2Fsrc%2Fcollections%2Fvec_deque%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Falloc%2Fsrc%2Fcollections%2Fvec_deque%2Fmod.rs?ref=b4b495e48e8f42c22090dfadfe9b9b51317ccf02", "patch": "@@ -2129,16 +2129,32 @@ impl<T, A: Allocator> VecDeque<T, A> {\n         F: FnMut(&T) -> bool,\n     {\n         let len = self.len();\n-        let mut del = 0;\n-        for i in 0..len {\n-            if !f(&self[i]) {\n-                del += 1;\n-            } else if del > 0 {\n-                self.swap(i - del, i);\n+        let mut idx = 0;\n+        let mut cur = 0;\n+\n+        // Stage 1: All values are retained.\n+        while cur < len {\n+            if !f(&self[cur]) {\n+                cur += 1;\n+                break;\n             }\n+            cur += 1;\n+            idx += 1;\n         }\n-        if del > 0 {\n-            self.truncate(len - del);\n+        // Stage 2: Swap retained value into current idx.\n+        while cur < len {\n+            if !f(&self[cur]) {\n+                cur += 1;\n+                continue;\n+            }\n+\n+            self.swap(idx, cur);\n+            cur += 1;\n+            idx += 1;\n+        }\n+        // Stage 3: Trancate all values after idx.\n+        if cur != idx {\n+            self.truncate(idx);\n         }\n     }\n "}, {"sha": "bf1c73eb0780340261a37243b9320bb755fdd466", "filename": "library/alloc/src/collections/vec_deque/tests.rs", "status": "modified", "additions": 35, "deletions": 0, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/b4b495e48e8f42c22090dfadfe9b9b51317ccf02/library%2Falloc%2Fsrc%2Fcollections%2Fvec_deque%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b4b495e48e8f42c22090dfadfe9b9b51317ccf02/library%2Falloc%2Fsrc%2Fcollections%2Fvec_deque%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Falloc%2Fsrc%2Fcollections%2Fvec_deque%2Ftests.rs?ref=b4b495e48e8f42c22090dfadfe9b9b51317ccf02", "patch": "@@ -40,6 +40,39 @@ fn bench_pop_back_100(b: &mut test::Bencher) {\n     })\n }\n \n+#[bench]\n+#[cfg_attr(miri, ignore)] // isolated Miri does not support benchmarks\n+fn bench_retain_whole_10000(b: &mut test::Bencher) {\n+    let v = (1..100000).collect::<VecDeque<u32>>();\n+\n+    b.iter(|| {\n+        let mut v = v.clone();\n+        v.retain(|x| *x > 0)\n+    })\n+}\n+\n+#[bench]\n+#[cfg_attr(miri, ignore)] // isolated Miri does not support benchmarks\n+fn bench_retain_odd_10000(b: &mut test::Bencher) {\n+    let v = (1..100000).collect::<VecDeque<u32>>();\n+\n+    b.iter(|| {\n+        let mut v = v.clone();\n+        v.retain(|x| x & 1 == 0)\n+    })\n+}\n+\n+#[bench]\n+#[cfg_attr(miri, ignore)] // isolated Miri does not support benchmarks\n+fn bench_retain_half_10000(b: &mut test::Bencher) {\n+    let v = (1..100000).collect::<VecDeque<u32>>();\n+\n+    b.iter(|| {\n+        let mut v = v.clone();\n+        v.retain(|x| *x > 50000)\n+    })\n+}\n+\n #[bench]\n #[cfg_attr(miri, ignore)] // isolated Miri does not support benchmarks\n fn bench_pop_front_100(b: &mut test::Bencher) {\n@@ -54,6 +87,8 @@ fn bench_pop_front_100(b: &mut test::Bencher) {\n     })\n }\n \n+\n+\n #[test]\n fn test_swap_front_back_remove() {\n     fn test(back: bool) {"}]}