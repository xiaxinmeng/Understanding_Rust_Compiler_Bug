{"sha": "627957100c9b810a10c30a11cf1a8a3188d5f9f4", "node_id": "MDY6Q29tbWl0NzI0NzEyOjYyNzk1NzEwMGM5YjgxMGExMGMzMGExMWNmMWE4YTMxODhkNWY5ZjQ=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-06-04T04:38:48Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-06-04T04:38:48Z"}, "message": "Auto merge of #72618 - Aaron1011:feature/early-sourcemap, r=petrochenkov\n\nMake `SourceMap` available for early debug-printing of `Span`s\n\nNormally, we debug-print `Spans` using the `SourceMap` retrieved from\nthe global `TyCtxt`. However, we fall back to printing out the `Span`'s\nraw fields (instead of a file and line number) when we try to print a\n`Span` before a `TyCtxt` is available. This makes debugging early phases\nof the compile, such as parsing, much more difficult.\n\nThis commit stores a `SourceMap` in `rustc_span::GlOBALS` as a fallback.\nWhen a `TyCtxt` is not available, we try to retrieve one from `GLOBALS`\n- only if this is not available do we fall back to the raw field output.\n\nI'm not sure how to write a test for this - however, this can be\nverified locally by setting `RUSTC_LOG=\"rustc_parse=debug\"`, and\nverifying that the output contains filenames and line numbers.", "tree": {"sha": "29547a498515c0bf7a5126ee1ef78df18d69f604", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/29547a498515c0bf7a5126ee1ef78df18d69f604"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/627957100c9b810a10c30a11cf1a8a3188d5f9f4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/627957100c9b810a10c30a11cf1a8a3188d5f9f4", "html_url": "https://github.com/rust-lang/rust/commit/627957100c9b810a10c30a11cf1a8a3188d5f9f4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/627957100c9b810a10c30a11cf1a8a3188d5f9f4/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f3fadf6abd571868d70538561a0731ddd800003a", "url": "https://api.github.com/repos/rust-lang/rust/commits/f3fadf6abd571868d70538561a0731ddd800003a", "html_url": "https://github.com/rust-lang/rust/commit/f3fadf6abd571868d70538561a0731ddd800003a"}, {"sha": "717fd665ad1095b12907ed0f2426d8eb06c2bddc", "url": "https://api.github.com/repos/rust-lang/rust/commits/717fd665ad1095b12907ed0f2426d8eb06c2bddc", "html_url": "https://github.com/rust-lang/rust/commit/717fd665ad1095b12907ed0f2426d8eb06c2bddc"}], "stats": {"total": 69, "additions": 53, "deletions": 16}, "files": [{"sha": "5aad64f84cee3ac9368307f318e52ecedbc7ac5c", "filename": "src/librustc_interface/interface.rs", "status": "modified", "additions": 13, "deletions": 11, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/627957100c9b810a10c30a11cf1a8a3188d5f9f4/src%2Flibrustc_interface%2Finterface.rs", "raw_url": "https://github.com/rust-lang/rust/raw/627957100c9b810a10c30a11cf1a8a3188d5f9f4/src%2Flibrustc_interface%2Finterface.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_interface%2Finterface.rs?ref=627957100c9b810a10c30a11cf1a8a3188d5f9f4", "patch": "@@ -186,17 +186,19 @@ pub fn run_compiler_in_existing_thread_pool<R>(\n         override_queries: config.override_queries,\n     };\n \n-    let r = {\n-        let _sess_abort_error = OnDrop(|| {\n-            compiler.sess.finish_diagnostics(registry);\n-        });\n-\n-        f(&compiler)\n-    };\n-\n-    let prof = compiler.sess.prof.clone();\n-    prof.generic_activity(\"drop_compiler\").run(move || drop(compiler));\n-    r\n+    rustc_span::with_source_map(compiler.sess.parse_sess.clone_source_map(), move || {\n+        let r = {\n+            let _sess_abort_error = OnDrop(|| {\n+                compiler.sess.finish_diagnostics(registry);\n+            });\n+\n+            f(&compiler)\n+        };\n+\n+        let prof = compiler.sess.prof.clone();\n+        prof.generic_activity(\"drop_compiler\").run(move || drop(compiler));\n+        r\n+    })\n }\n \n pub fn run_compiler<R: Send>(mut config: Config, f: impl FnOnce(&Compiler) -> R + Send) -> R {"}, {"sha": "fbab99b2f8f20c7913d641047b74fdb890827c39", "filename": "src/librustc_span/lib.rs", "status": "modified", "additions": 40, "deletions": 5, "changes": 45, "blob_url": "https://github.com/rust-lang/rust/blob/627957100c9b810a10c30a11cf1a8a3188d5f9f4/src%2Flibrustc_span%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/627957100c9b810a10c30a11cf1a8a3188d5f9f4/src%2Flibrustc_span%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_span%2Flib.rs?ref=627957100c9b810a10c30a11cf1a8a3188d5f9f4", "patch": "@@ -25,6 +25,7 @@ use rustc_serialize::{Decodable, Decoder, Encodable, Encoder};\n mod caching_source_map_view;\n pub mod source_map;\n pub use self::caching_source_map_view::CachingSourceMapView;\n+use source_map::SourceMap;\n \n pub mod edition;\n use edition::Edition;\n@@ -67,6 +68,7 @@ pub struct Globals {\n     symbol_interner: Lock<symbol::Interner>,\n     span_interner: Lock<span_encoding::SpanInterner>,\n     hygiene_data: Lock<hygiene::HygieneData>,\n+    source_map: Lock<Option<Lrc<SourceMap>>>,\n }\n \n impl Globals {\n@@ -75,6 +77,7 @@ impl Globals {\n             symbol_interner: Lock::new(symbol::Interner::fresh()),\n             span_interner: Lock::new(span_encoding::SpanInterner::default()),\n             hygiene_data: Lock::new(hygiene::HygieneData::new(edition)),\n+            source_map: Lock::new(None),\n         }\n     }\n }\n@@ -697,12 +700,44 @@ impl rustc_serialize::UseSpecializedDecodable for Span {\n     }\n }\n \n+/// Calls the provided closure, using the provided `SourceMap` to format\n+/// any spans that are debug-printed during the closure'e exectuino.\n+///\n+/// Normally, the global `TyCtxt` is used to retrieve the `SourceMap`\n+/// (see `rustc_interface::callbacks::span_debug1). However, some parts\n+/// of the compiler (e.g. `rustc_parse`) may debug-print `Span`s before\n+/// a `TyCtxt` is available. In this case, we fall back to\n+/// the `SourceMap` provided to this function. If that is not available,\n+/// we fall back to printing the raw `Span` field values\n+pub fn with_source_map<T, F: FnOnce() -> T>(source_map: Lrc<SourceMap>, f: F) -> T {\n+    GLOBALS.with(|globals| {\n+        *globals.source_map.borrow_mut() = Some(source_map);\n+    });\n+    struct ClearSourceMap;\n+    impl Drop for ClearSourceMap {\n+        fn drop(&mut self) {\n+            GLOBALS.with(|globals| {\n+                globals.source_map.borrow_mut().take();\n+            });\n+        }\n+    }\n+\n+    let _guard = ClearSourceMap;\n+    f()\n+}\n+\n pub fn default_span_debug(span: Span, f: &mut fmt::Formatter<'_>) -> fmt::Result {\n-    f.debug_struct(\"Span\")\n-        .field(\"lo\", &span.lo())\n-        .field(\"hi\", &span.hi())\n-        .field(\"ctxt\", &span.ctxt())\n-        .finish()\n+    GLOBALS.with(|globals| {\n+        if let Some(source_map) = &*globals.source_map.borrow() {\n+            write!(f, \"{}\", source_map.span_to_string(span))\n+        } else {\n+            f.debug_struct(\"Span\")\n+                .field(\"lo\", &span.lo())\n+                .field(\"hi\", &span.hi())\n+                .field(\"ctxt\", &span.ctxt())\n+                .finish()\n+        }\n+    })\n }\n \n impl fmt::Debug for Span {"}]}