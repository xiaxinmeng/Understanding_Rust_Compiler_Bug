{"sha": "7ae251789ccd0a647e5abfc8085a8bd42359de65", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdhZTI1MTc4OWNjZDBhNjQ3ZTVhYmZjODA4NWE4YmQ0MjM1OWRlNjU=", "commit": {"author": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2011-09-21T00:46:49Z"}, "committer": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2011-09-21T00:51:17Z"}, "message": "Make creation of unique boxes work again\n\nIssue #409", "tree": {"sha": "29da75623f0fe7806b17f4e203878ce78180d664", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/29da75623f0fe7806b17f4e203878ce78180d664"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7ae251789ccd0a647e5abfc8085a8bd42359de65", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7ae251789ccd0a647e5abfc8085a8bd42359de65", "html_url": "https://github.com/rust-lang/rust/commit/7ae251789ccd0a647e5abfc8085a8bd42359de65", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7ae251789ccd0a647e5abfc8085a8bd42359de65/comments", "author": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "865dcb663da2d0534d508346cbe1df5dc66f3ad6", "url": "https://api.github.com/repos/rust-lang/rust/commits/865dcb663da2d0534d508346cbe1df5dc66f3ad6", "html_url": "https://github.com/rust-lang/rust/commit/865dcb663da2d0534d508346cbe1df5dc66f3ad6"}], "stats": {"total": 25, "additions": 22, "deletions": 3}, "files": [{"sha": "697f6d9e05c61fdc5a18552712295ca24794657b", "filename": "src/comp/middle/trans.rs", "status": "modified", "additions": 12, "deletions": 3, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/7ae251789ccd0a647e5abfc8085a8bd42359de65/src%2Fcomp%2Fmiddle%2Ftrans.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7ae251789ccd0a647e5abfc8085a8bd42359de65/src%2Fcomp%2Fmiddle%2Ftrans.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomp%2Fmiddle%2Ftrans.rs?ref=7ae251789ccd0a647e5abfc8085a8bd42359de65", "patch": "@@ -4246,7 +4246,9 @@ fn trans_expr_out(cx: @block_ctxt, e: @ast::expr, output: out_method) ->\n         CondBr(cx, cond, then_cx.llbb, else_cx.llbb);\n         ret rslt(join_branches(cx, [check_res, els]), C_nil());\n       }\n-      ast::expr_uniq(contents) { ret trans_uniq(cx, contents); }\n+      ast::expr_uniq(contents) {\n+        ret trans_uniq(cx, contents, e.id);\n+      }\n       ast::expr_break. { ret trans_break(e.span, cx); }\n       ast::expr_cont. { ret trans_cont(e.span, cx); }\n       ast::expr_ret(ex) { ret trans_ret(cx, ex); }\n@@ -4488,7 +4490,8 @@ fn trans_put(in_cx: @block_ctxt, e: option::t<@ast::expr>) -> result {\n     ret rslt(next_cx, C_nil());\n }\n \n-fn trans_uniq(cx: @block_ctxt, contents: @ast::expr) -> result {\n+fn trans_uniq(cx: @block_ctxt, contents: @ast::expr,\n+              node_id: ast::node_id) -> result {\n     let bcx = cx;\n \n     let contents_ty = ty::expr_ty(bcx_tcx(bcx), contents);\n@@ -4500,10 +4503,16 @@ fn trans_uniq(cx: @block_ctxt, contents: @ast::expr) -> result {\n \n     r = trans_shared_malloc(bcx, llptrty, llsz);\n     bcx = r.bcx;\n+    let llptr = r.val;\n+\n+    let uniq_ty = node_id_type(bcx_ccx(cx), node_id);\n+    r = alloc_ty(bcx, uniq_ty);\n     let llptrptr = r.val;\n+    bcx = r.bcx;\n+    Store(bcx, llptr, llptrptr);\n \n-    let llptr = Load(bcx, llptrptr);\n     r = trans_expr_out(bcx, contents, save_in(llptr));\n+    add_clean_temp(r.bcx, llptrptr, uniq_ty);\n     ret rslt(r.bcx, llptrptr);\n }\n "}, {"sha": "c46cf29ba5dac8bfcbba72d36cbbd7581b16571b", "filename": "src/test/run-pass/unique-create.rs", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/7ae251789ccd0a647e5abfc8085a8bd42359de65/src%2Ftest%2Frun-pass%2Funique-create.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7ae251789ccd0a647e5abfc8085a8bd42359de65/src%2Ftest%2Frun-pass%2Funique-create.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Funique-create.rs?ref=7ae251789ccd0a647e5abfc8085a8bd42359de65", "patch": "@@ -0,0 +1,7 @@\n+fn main() {\n+    ~100;\n+}\n+\n+fn vec() {\n+    [0];\n+}\n\\ No newline at end of file"}, {"sha": "54f173fcd716edc36bb4e42d816684d8b8fbc954", "filename": "src/test/run-pass/unique-init.rs", "status": "added", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/7ae251789ccd0a647e5abfc8085a8bd42359de65/src%2Ftest%2Frun-pass%2Funique-init.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7ae251789ccd0a647e5abfc8085a8bd42359de65/src%2Ftest%2Frun-pass%2Funique-init.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Funique-init.rs?ref=7ae251789ccd0a647e5abfc8085a8bd42359de65", "patch": "@@ -0,0 +1,3 @@\n+fn main() {\n+    let i = ~100;\n+}\n\\ No newline at end of file"}]}