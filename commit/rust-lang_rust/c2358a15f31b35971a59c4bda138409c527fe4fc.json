{"sha": "c2358a15f31b35971a59c4bda138409c527fe4fc", "node_id": "C_kwDOAAsO6NoAKGMyMzU4YTE1ZjMxYjM1OTcxYTU5YzRiZGExMzg0MDljNTI3ZmU0ZmM", "commit": {"author": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2022-11-12T20:02:15Z"}, "committer": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2022-11-12T20:02:33Z"}, "message": "linker: Link `profiler_builtins` even if it's marked as `NotLinked`", "tree": {"sha": "5ae2d099beda0cd53a206bbd3166111661555a7a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5ae2d099beda0cd53a206bbd3166111661555a7a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c2358a15f31b35971a59c4bda138409c527fe4fc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c2358a15f31b35971a59c4bda138409c527fe4fc", "html_url": "https://github.com/rust-lang/rust/commit/c2358a15f31b35971a59c4bda138409c527fe4fc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c2358a15f31b35971a59c4bda138409c527fe4fc/comments", "author": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "committer": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "58e4644969e770e85396c913c715e2d183ddc8f2", "url": "https://api.github.com/repos/rust-lang/rust/commits/58e4644969e770e85396c913c715e2d183ddc8f2", "html_url": "https://github.com/rust-lang/rust/commit/58e4644969e770e85396c913c715e2d183ddc8f2"}], "stats": {"total": 7, "additions": 4, "deletions": 3}, "files": [{"sha": "2bd9023395dbdde765922bce927f3e353ba6826c", "filename": "compiler/rustc_codegen_ssa/src/back/link.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/c2358a15f31b35971a59c4bda138409c527fe4fc/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c2358a15f31b35971a59c4bda138409c527fe4fc/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs?ref=c2358a15f31b35971a59c4bda138409c527fe4fc", "patch": "@@ -2454,15 +2454,17 @@ fn add_upstream_rust_crates<'a>(\n         // We must always link crates `compiler_builtins` and `profiler_builtins` statically.\n         // Even if they were already included into a dylib\n         // (e.g. `libstd` when `-C prefer-dynamic` is used).\n+        // FIXME: `dependency_formats` can report `profiler_builtins` as `NotLinked` for some\n+        // reason, it shouldn't do that because `profiler_builtins` should indeed be linked.\n         let linkage = data[cnum.as_usize() - 1];\n         let link_static_crate = linkage == Linkage::Static\n-            || linkage == Linkage::IncludedFromDylib\n+            || (linkage == Linkage::IncludedFromDylib || linkage == Linkage::NotLinked)\n                 && (codegen_results.crate_info.compiler_builtins == Some(cnum)\n                     || codegen_results.crate_info.profiler_runtime == Some(cnum));\n \n         let mut bundled_libs = Default::default();\n         match linkage {\n-            Linkage::Static | Linkage::IncludedFromDylib => {\n+            Linkage::Static | Linkage::IncludedFromDylib | Linkage::NotLinked => {\n                 if link_static_crate {\n                     bundled_libs = codegen_results.crate_info.native_libraries[&cnum]\n                         .iter()\n@@ -2483,7 +2485,6 @@ fn add_upstream_rust_crates<'a>(\n                 let src = &codegen_results.crate_info.used_crate_source[&cnum];\n                 add_dynamic_crate(cmd, sess, &src.dylib.as_ref().unwrap().0);\n             }\n-            Linkage::NotLinked => {}\n         }\n \n         // Static libraries are linked for a subset of linked upstream crates."}]}