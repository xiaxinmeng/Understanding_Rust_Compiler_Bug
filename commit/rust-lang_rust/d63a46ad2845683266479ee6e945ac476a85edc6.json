{"sha": "d63a46ad2845683266479ee6e945ac476a85edc6", "node_id": "C_kwDOAAsO6NoAKGQ2M2E0NmFkMjg0NTY4MzI2NjQ3OWVlNmU5NDVhYzQ3NmE4NWVkYzY", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2022-04-12T21:17:00Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-04-12T21:17:00Z"}, "message": "Rollup merge of #95970 - WaffleLapkin:nicer_trait_suggestions, r=compiler-errors\n\nFix suggestions in case of `T:` bounds\n\nThis PR fixes a corner case in `suggest_constraining_type_params` that was causing incorrect suggestions.\n\nFor the following functions:\n```rust\nfn a<T:>(t: T) { [t, t]; }\nfn b<T>(t: T) where T: { [t, t]; }\n```\n\nWe previously suggested the following:\n```text\n...\nhelp: consider restricting type parameter `T`\n  |\n1 | fn a<T: Copy:>(t: T) { [t, t]; }\n  |       ++++++\n...\nhelp: consider further restricting this bound\n  |\n2 | fn b<T>(t: T) where T: + Copy { [t, t]; }\n  |                        ++++++\n```\n\nNote that neither `T: Copy:` not `where T: + Copy` is a correct bound.\n\nWith this commit the suggestions are correct:\n```text\n...\nhelp: consider restricting type parameter `T`\n  |\n1 | fn a<T: Copy>(t: T) { [t, t]; }\n  |         ++++\n...\nhelp: consider further restricting this bound\n  |\n2 | fn b<T>(t: T) where T: Copy { [t, t]; }\n  |                        ++++\n```\n\nr? `@compiler-errors`\n\nI've tried fixing #95898 here too, but got too confused with how `suggest_traits_to_import` works and what it does :sweat_smile:", "tree": {"sha": "8ca45c4741c4441a0fcfbc6824d0d9c3985907fc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8ca45c4741c4441a0fcfbc6824d0d9c3985907fc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d63a46ad2845683266479ee6e945ac476a85edc6", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJiVexMCRBK7hj4Ov3rIwAAwFUIAIPMpUwoBVpszkNeYwVG/vO6\nd0wtNBB8Oj/yyc91FS4wF+XiIzh0Qc4S2EZCwZbIhDiBVXFfXj1TOWYJaLVsaLIz\nXK00oUIbDH6XJmxvF9HZRAjGnJvrL//iQpvd5exsvmkSG8LYAmnadY23B8/EQO9w\nfRi7jGrzjvcbLYUzVXhdVDZYNYTRSmbuLn1O/Xx1iZaxuGbSROTzcIHA2hwow34D\n0HPRqPzptEMsvX4JpyYz56LaAYOe8AZ4xL09+uAyTjT8Qli3bJTvqZwNr5Ca2Tbb\nhEp71MjHD7lNfvrNyOissBLv9QhjJhNtZJ59d3jj0nVdQozcBzseM9OS2y2caRI=\n=ZYsD\n-----END PGP SIGNATURE-----\n", "payload": "tree 8ca45c4741c4441a0fcfbc6824d0d9c3985907fc\nparent 91813a7175dacce03be33ba63c7abbdea3da1748\nparent e4710fe2214ba85fd9a3514c76c7722253a3a275\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1649798220 +0200\ncommitter GitHub <noreply@github.com> 1649798220 +0200\n\nRollup merge of #95970 - WaffleLapkin:nicer_trait_suggestions, r=compiler-errors\n\nFix suggestions in case of `T:` bounds\n\nThis PR fixes a corner case in `suggest_constraining_type_params` that was causing incorrect suggestions.\n\nFor the following functions:\n```rust\nfn a<T:>(t: T) { [t, t]; }\nfn b<T>(t: T) where T: { [t, t]; }\n```\n\nWe previously suggested the following:\n```text\n...\nhelp: consider restricting type parameter `T`\n  |\n1 | fn a<T: Copy:>(t: T) { [t, t]; }\n  |       ++++++\n...\nhelp: consider further restricting this bound\n  |\n2 | fn b<T>(t: T) where T: + Copy { [t, t]; }\n  |                        ++++++\n```\n\nNote that neither `T: Copy:` not `where T: + Copy` is a correct bound.\n\nWith this commit the suggestions are correct:\n```text\n...\nhelp: consider restricting type parameter `T`\n  |\n1 | fn a<T: Copy>(t: T) { [t, t]; }\n  |         ++++\n...\nhelp: consider further restricting this bound\n  |\n2 | fn b<T>(t: T) where T: Copy { [t, t]; }\n  |                        ++++\n```\n\nr? `@compiler-errors`\n\nI've tried fixing #95898 here too, but got too confused with how `suggest_traits_to_import` works and what it does :sweat_smile:\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d63a46ad2845683266479ee6e945ac476a85edc6", "html_url": "https://github.com/rust-lang/rust/commit/d63a46ad2845683266479ee6e945ac476a85edc6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d63a46ad2845683266479ee6e945ac476a85edc6/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "91813a7175dacce03be33ba63c7abbdea3da1748", "url": "https://api.github.com/repos/rust-lang/rust/commits/91813a7175dacce03be33ba63c7abbdea3da1748", "html_url": "https://github.com/rust-lang/rust/commit/91813a7175dacce03be33ba63c7abbdea3da1748"}, {"sha": "e4710fe2214ba85fd9a3514c76c7722253a3a275", "url": "https://api.github.com/repos/rust-lang/rust/commits/e4710fe2214ba85fd9a3514c76c7722253a3a275", "html_url": "https://github.com/rust-lang/rust/commit/e4710fe2214ba85fd9a3514c76c7722253a3a275"}], "stats": {"total": 133, "additions": 124, "deletions": 9}, "files": [{"sha": "76971d7ad3a05404d45b5875277f83d51637aba3", "filename": "compiler/rustc_hir/src/hir.rs", "status": "modified", "additions": 35, "deletions": 1, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/d63a46ad2845683266479ee6e945ac476a85edc6/compiler%2Frustc_hir%2Fsrc%2Fhir.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d63a46ad2845683266479ee6e945ac476a85edc6/compiler%2Frustc_hir%2Fsrc%2Fhir.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir%2Fsrc%2Fhir.rs?ref=d63a46ad2845683266479ee6e945ac476a85edc6", "patch": "@@ -17,7 +17,7 @@ use rustc_error_messages::MultiSpan;\n use rustc_index::vec::IndexVec;\n use rustc_macros::HashStable_Generic;\n use rustc_span::hygiene::MacroKind;\n-use rustc_span::source_map::Spanned;\n+use rustc_span::source_map::{SourceMap, Spanned};\n use rustc_span::symbol::{kw, sym, Ident, Symbol};\n use rustc_span::{def_id::LocalDefId, BytePos, Span, DUMMY_SP};\n use rustc_target::asm::InlineAsmRegOrRegClass;\n@@ -523,6 +523,40 @@ impl<'hir> GenericParam<'hir> {\n             })\n             .map(|sp| sp.shrink_to_hi())\n     }\n+\n+    /// Returns the span of `:` after a generic parameter.\n+    ///\n+    /// For example:\n+    ///\n+    /// ```text\n+    /// fn a<T:>()\n+    ///       ^\n+    ///       |      here\n+    ///       here   |\n+    ///              v\n+    /// fn b<T       :>()\n+    ///\n+    /// fn c<T\n+    ///\n+    /// :>()\n+    /// ^\n+    /// |\n+    /// here\n+    /// ```\n+    pub fn colon_span_for_suggestions(&self, source_map: &SourceMap) -> Option<Span> {\n+        let sp = source_map\n+            .span_extend_while(self.span.shrink_to_hi(), |c| c.is_whitespace() || c == ':')\n+            .ok()?;\n+\n+        let snippet = source_map.span_to_snippet(sp).ok()?;\n+        let offset = snippet.find(':')?;\n+\n+        let colon_sp = sp\n+            .with_lo(BytePos(sp.lo().0 + offset as u32))\n+            .with_hi(BytePos(sp.lo().0 + (offset + ':'.len_utf8()) as u32));\n+\n+        Some(colon_sp)\n+    }\n }\n \n #[derive(Default)]"}, {"sha": "3b044b19259d0b2000dad7c3abc5387c3b1cb3e9", "filename": "compiler/rustc_middle/src/ty/diagnostics.rs", "status": "modified", "additions": 28, "deletions": 7, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/d63a46ad2845683266479ee6e945ac476a85edc6/compiler%2Frustc_middle%2Fsrc%2Fty%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d63a46ad2845683266479ee6e945ac476a85edc6/compiler%2Frustc_middle%2Fsrc%2Fty%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fdiagnostics.rs?ref=d63a46ad2845683266479ee6e945ac476a85edc6", "patch": "@@ -336,10 +336,14 @@ pub fn suggest_constraining_type_params<'a>(\n         }\n \n         let constraint = constraints.iter().map(|&(c, _)| c).collect::<Vec<_>>().join(\" + \");\n-        let mut suggest_restrict = |span| {\n+        let mut suggest_restrict = |span, bound_list_non_empty| {\n             suggestions.push((\n                 span,\n-                format!(\" + {}\", constraint),\n+                if bound_list_non_empty {\n+                    format!(\" + {}\", constraint)\n+                } else {\n+                    format!(\" {}\", constraint)\n+                },\n                 SuggestChangingConstraintsMessage::RestrictBoundFurther,\n             ))\n         };\n@@ -360,7 +364,10 @@ pub fn suggest_constraining_type_params<'a>(\n             //             |\n             //             replace with: `impl Foo + Bar`\n \n-            suggest_restrict(param.span.shrink_to_hi());\n+            // `impl Trait` must have at least one trait in the list\n+            let bound_list_non_empty = true;\n+\n+            suggest_restrict(param.span.shrink_to_hi(), bound_list_non_empty);\n             continue;\n         }\n \n@@ -383,15 +390,25 @@ pub fn suggest_constraining_type_params<'a>(\n                 //          --\n                 //          |\n                 //          replace with: `T: Bar +`\n-                suggest_restrict(span);\n+\n+                // `bounds_span_for_suggestions` returns `None` if the list is empty\n+                let bound_list_non_empty = true;\n+\n+                suggest_restrict(span, bound_list_non_empty);\n             } else {\n+                let (colon, span) = match param.colon_span_for_suggestions(tcx.sess.source_map()) {\n+                    // If there is already a colon after generic, do not suggest adding it again\n+                    Some(sp) => (\"\", sp.shrink_to_hi()),\n+                    None => (\":\", param.span.shrink_to_hi()),\n+                };\n+\n                 // If user hasn't provided any bounds, suggest adding a new one:\n                 //\n                 //   fn foo<T>(t: T) { ... }\n                 //          - help: consider restricting this type parameter with `T: Foo`\n                 suggestions.push((\n-                    param.span.shrink_to_hi(),\n-                    format!(\": {}\", constraint),\n+                    span,\n+                    format!(\"{colon} {constraint}\"),\n                     SuggestChangingConstraintsMessage::RestrictType { ty: param_name },\n                 ));\n             }\n@@ -459,17 +476,21 @@ pub fn suggest_constraining_type_params<'a>(\n                 ));\n             } else {\n                 let mut param_spans = Vec::new();\n+                let mut non_empty = false;\n \n                 for predicate in generics.where_clause.predicates {\n                     if let WherePredicate::BoundPredicate(WhereBoundPredicate {\n                         span,\n                         bounded_ty,\n+                        bounds,\n                         ..\n                     }) = predicate\n                     {\n                         if let TyKind::Path(QPath::Resolved(_, path)) = &bounded_ty.kind {\n                             if let Some(segment) = path.segments.first() {\n                                 if segment.ident.to_string() == param_name {\n+                                    non_empty = !bounds.is_empty();\n+\n                                     param_spans.push(span);\n                                 }\n                             }\n@@ -478,7 +499,7 @@ pub fn suggest_constraining_type_params<'a>(\n                 }\n \n                 match param_spans[..] {\n-                    [&param_span] => suggest_restrict(param_span.shrink_to_hi()),\n+                    [&param_span] => suggest_restrict(param_span.shrink_to_hi(), non_empty),\n                     _ => {\n                         suggestions.push((\n                             generics.where_clause.tail_span_for_suggestion(),"}, {"sha": "fb6cf7e8996c0b93107b71fe2ea2d42408c604b1", "filename": "src/test/ui/moves/use_of_moved_value_copy_suggestions.fixed", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/d63a46ad2845683266479ee6e945ac476a85edc6/src%2Ftest%2Fui%2Fmoves%2Fuse_of_moved_value_copy_suggestions.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/d63a46ad2845683266479ee6e945ac476a85edc6/src%2Ftest%2Fui%2Fmoves%2Fuse_of_moved_value_copy_suggestions.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmoves%2Fuse_of_moved_value_copy_suggestions.fixed?ref=d63a46ad2845683266479ee6e945ac476a85edc6", "patch": "@@ -69,4 +69,18 @@ where\n     (t, t) //~ use of moved value: `t`\n }\n \n+#[rustfmt::skip]\n+fn existing_colon<T: Copy>(t: T) {\n+    //~^ HELP consider restricting type parameter `T`\n+    [t, t]; //~ use of moved value: `t`\n+}\n+\n+fn existing_colon_in_where<T>(t: T)\n+where\n+    T: Copy,\n+    //~^ HELP consider further restricting this bound\n+{\n+    [t, t]; //~ use of moved value: `t`\n+}\n+\n fn main() {}"}, {"sha": "cadbf2a54cc3765dfecc3764d78f0549f65bf862", "filename": "src/test/ui/moves/use_of_moved_value_copy_suggestions.rs", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/d63a46ad2845683266479ee6e945ac476a85edc6/src%2Ftest%2Fui%2Fmoves%2Fuse_of_moved_value_copy_suggestions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d63a46ad2845683266479ee6e945ac476a85edc6/src%2Ftest%2Fui%2Fmoves%2Fuse_of_moved_value_copy_suggestions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmoves%2Fuse_of_moved_value_copy_suggestions.rs?ref=d63a46ad2845683266479ee6e945ac476a85edc6", "patch": "@@ -69,4 +69,18 @@ where\n     (t, t) //~ use of moved value: `t`\n }\n \n+#[rustfmt::skip]\n+fn existing_colon<T:>(t: T) {\n+    //~^ HELP consider restricting type parameter `T`\n+    [t, t]; //~ use of moved value: `t`\n+}\n+\n+fn existing_colon_in_where<T>(t: T)\n+where\n+    T:,\n+    //~^ HELP consider further restricting this bound\n+{\n+    [t, t]; //~ use of moved value: `t`\n+}\n+\n fn main() {}"}, {"sha": "f5252084d6884f76534992c0f5f3a0a9a59731e0", "filename": "src/test/ui/moves/use_of_moved_value_copy_suggestions.stderr", "status": "modified", "additions": 33, "deletions": 1, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/d63a46ad2845683266479ee6e945ac476a85edc6/src%2Ftest%2Fui%2Fmoves%2Fuse_of_moved_value_copy_suggestions.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d63a46ad2845683266479ee6e945ac476a85edc6/src%2Ftest%2Fui%2Fmoves%2Fuse_of_moved_value_copy_suggestions.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmoves%2Fuse_of_moved_value_copy_suggestions.stderr?ref=d63a46ad2845683266479ee6e945ac476a85edc6", "patch": "@@ -142,6 +142,38 @@ help: consider further restricting this bound\n LL |     T: B + Trait + Copy,\n    |          ++++++++++++++\n \n-error: aborting due to 9 previous errors\n+error[E0382]: use of moved value: `t`\n+  --> $DIR/use_of_moved_value_copy_suggestions.rs:83:9\n+   |\n+LL | fn existing_colon_in_where<T>(t: T)\n+   |                               - move occurs because `t` has type `T`, which does not implement the `Copy` trait\n+...\n+LL |     [t, t];\n+   |      -  ^ value used here after move\n+   |      |\n+   |      value moved here\n+   |\n+help: consider further restricting this bound\n+   |\n+LL |     T: Copy,\n+   |        ++++\n+\n+error[E0382]: use of moved value: `t`\n+  --> $DIR/use_of_moved_value_copy_suggestions.rs:75:9\n+   |\n+LL | fn existing_colon<T:>(t: T) {\n+   |                       - move occurs because `t` has type `T`, which does not implement the `Copy` trait\n+LL |\n+LL |     [t, t];\n+   |      -  ^ value used here after move\n+   |      |\n+   |      value moved here\n+   |\n+help: consider restricting type parameter `T`\n+   |\n+LL | fn existing_colon<T: Copy>(t: T) {\n+   |                      ++++\n+\n+error: aborting due to 11 previous errors\n \n For more information about this error, try `rustc --explain E0382`."}]}