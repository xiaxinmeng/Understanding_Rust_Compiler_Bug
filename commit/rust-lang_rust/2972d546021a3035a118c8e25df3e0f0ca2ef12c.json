{"sha": "2972d546021a3035a118c8e25df3e0f0ca2ef12c", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI5NzJkNTQ2MDIxYTMwMzVhMTE4YzhlMjVkZjNlMGYwY2EyZWYxMmM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-02-01T23:49:46Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-02-01T23:49:46Z"}, "message": "Auto merge of #3732 - phansch:fix_ice_3720, r=oli-obk\n\nFix ICE in vec_box lint and add run-rustfix\n\nIncludes https://github.com/rust-lang/rust-clippy/pull/3726\n\n`hir::Ty` doesn't seem to know anything about type bounds and\n`cx.tcx.type_of(def_id)` caused an ICE when it was passed a generic type\nwith a bound:\n\n```\nsrc/librustc_typeck/collect.rs:1311: unexpected non-type Node::GenericParam: Type { default: None, synthetic: None }\n```\n\nConverting it to a proper `Ty` fixes the ICE and catches a few more places\nwhere the lint applies.\n\nFixes #3720", "tree": {"sha": "bf2dde7122516d3a4b8f87136819e3e7dc54aa9c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bf2dde7122516d3a4b8f87136819e3e7dc54aa9c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2972d546021a3035a118c8e25df3e0f0ca2ef12c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2972d546021a3035a118c8e25df3e0f0ca2ef12c", "html_url": "https://github.com/rust-lang/rust/commit/2972d546021a3035a118c8e25df3e0f0ca2ef12c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2972d546021a3035a118c8e25df3e0f0ca2ef12c/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5176a5c4b70423ca1fc4dbaa77ada0f40afdb479", "url": "https://api.github.com/repos/rust-lang/rust/commits/5176a5c4b70423ca1fc4dbaa77ada0f40afdb479", "html_url": "https://github.com/rust-lang/rust/commit/5176a5c4b70423ca1fc4dbaa77ada0f40afdb479"}, {"sha": "38347bad3868aee11e2b47db5ae15a39829becd7", "url": "https://api.github.com/repos/rust-lang/rust/commits/38347bad3868aee11e2b47db5ae15a39829becd7", "html_url": "https://github.com/rust-lang/rust/commit/38347bad3868aee11e2b47db5ae15a39829becd7"}], "stats": {"total": 127, "additions": 96, "deletions": 31}, "files": [{"sha": "6ee7d10155cd602d96fcd1489d1462c4ec29b447", "filename": "clippy_lints/src/types.rs", "status": "modified", "additions": 14, "deletions": 16, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/2972d546021a3035a118c8e25df3e0f0ca2ef12c/clippy_lints%2Fsrc%2Ftypes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2972d546021a3035a118c8e25df3e0f0ca2ef12c/clippy_lints%2Fsrc%2Ftypes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Ftypes.rs?ref=2972d546021a3035a118c8e25df3e0f0ca2ef12c", "patch": "@@ -275,26 +275,24 @@ fn check_ty(cx: &LateContext<'_, '_>, hir_ty: &hir::Ty, is_local: bool) {\n                         if Some(def_id) == cx.tcx.lang_items().owned_box();\n                         // At this point, we know ty is Box<T>, now get T\n                         if let Some(ref last) = last_path_segment(ty_qpath).args;\n-                        if let Some(ty) = last.args.iter().find_map(|arg| match arg {\n+                        if let Some(boxed_ty) = last.args.iter().find_map(|arg| match arg {\n                             GenericArg::Type(ty) => Some(ty),\n                             GenericArg::Lifetime(_) => None,\n                         });\n-                        if let TyKind::Path(ref ty_qpath) = ty.node;\n-                        let def = cx.tables.qpath_def(ty_qpath, ty.hir_id);\n-                        if let Some(def_id) = opt_def_id(def);\n-                        let boxed_type = cx.tcx.type_of(def_id);\n-                        if boxed_type.is_sized(cx.tcx.at(ty.span), cx.param_env);\n                         then {\n-                            span_lint_and_sugg(\n-                                cx,\n-                                VEC_BOX,\n-                                hir_ty.span,\n-                                \"`Vec<T>` is already on the heap, the boxing is unnecessary.\",\n-                                \"try\",\n-                                format!(\"Vec<{}>\", boxed_type),\n-                                Applicability::MaybeIncorrect,\n-                            );\n-                            return; // don't recurse into the type\n+                            let ty_ty = hir_ty_to_ty(cx.tcx, boxed_ty);\n+                            if ty_ty.is_sized(cx.tcx.at(ty.span), cx.param_env) {\n+                                span_lint_and_sugg(\n+                                    cx,\n+                                    VEC_BOX,\n+                                    hir_ty.span,\n+                                    \"`Vec<T>` is already on the heap, the boxing is unnecessary.\",\n+                                    \"try\",\n+                                    format!(\"Vec<{}>\", ty_ty),\n+                                    Applicability::MachineApplicable,\n+                                );\n+                                return; // don't recurse into the type\n+                            }\n                         }\n                     }\n                 } else if match_def_path(cx.tcx, def_id, &paths::OPTION) {"}, {"sha": "be61fb6b9be613cca8bd66f622644b253af6cabd", "filename": "tests/ui/complex_types.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/2972d546021a3035a118c8e25df3e0f0ca2ef12c/tests%2Fui%2Fcomplex_types.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2972d546021a3035a118c8e25df3e0f0ca2ef12c/tests%2Fui%2Fcomplex_types.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcomplex_types.rs?ref=2972d546021a3035a118c8e25df3e0f0ca2ef12c", "patch": "@@ -1,5 +1,5 @@\n #![warn(clippy::all)]\n-#![allow(unused, clippy::needless_pass_by_value)]\n+#![allow(unused, clippy::needless_pass_by_value, clippy::vec_box)]\n #![feature(associated_type_defaults)]\n \n type Alias = Vec<Vec<Box<(u32, u32, u32, u32)>>>; // no warning here"}, {"sha": "a56dac8aa232200d14ea6d6e4577891b058f2d82", "filename": "tests/ui/vec_box_sized.fixed", "status": "added", "additions": 36, "deletions": 0, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/2972d546021a3035a118c8e25df3e0f0ca2ef12c/tests%2Fui%2Fvec_box_sized.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/2972d546021a3035a118c8e25df3e0f0ca2ef12c/tests%2Fui%2Fvec_box_sized.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fvec_box_sized.fixed?ref=2972d546021a3035a118c8e25df3e0f0ca2ef12c", "patch": "@@ -0,0 +1,36 @@\n+// run-rustfix\n+\n+#![allow(dead_code)]\n+\n+struct SizedStruct(i32);\n+struct UnsizedStruct([i32]);\n+\n+/// The following should trigger the lint\n+mod should_trigger {\n+    use super::SizedStruct;\n+\n+    struct StructWithVecBox {\n+        sized_type: Vec<SizedStruct>,\n+    }\n+\n+    struct A(Vec<SizedStruct>);\n+    struct B(Vec<Vec<u32>>);\n+}\n+\n+/// The following should not trigger the lint\n+mod should_not_trigger {\n+    use super::UnsizedStruct;\n+\n+    struct C(Vec<Box<UnsizedStruct>>);\n+\n+    struct StructWithVecBoxButItsUnsized {\n+        unsized_type: Vec<Box<UnsizedStruct>>,\n+    }\n+\n+    struct TraitVec<T: ?Sized> {\n+        // Regression test for #3720. This was causing an ICE.\n+        inner: Vec<Box<T>>,\n+    }\n+}\n+\n+fn main() {}"}, {"sha": "32d1e940f2712d40a776c48d361ce4e36a25a0b1", "filename": "tests/ui/vec_box_sized.rs", "status": "modified", "additions": 29, "deletions": 10, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/2972d546021a3035a118c8e25df3e0f0ca2ef12c/tests%2Fui%2Fvec_box_sized.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2972d546021a3035a118c8e25df3e0f0ca2ef12c/tests%2Fui%2Fvec_box_sized.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fvec_box_sized.rs?ref=2972d546021a3035a118c8e25df3e0f0ca2ef12c", "patch": "@@ -1,17 +1,36 @@\n-struct SizedStruct {\n-    _a: i32,\n-}\n+// run-rustfix\n \n-struct UnsizedStruct {\n-    _a: [i32],\n-}\n+#![allow(dead_code)]\n+\n+struct SizedStruct(i32);\n+struct UnsizedStruct([i32]);\n+\n+/// The following should trigger the lint\n+mod should_trigger {\n+    use super::SizedStruct;\n \n-struct StructWithVecBox {\n-    sized_type: Vec<Box<SizedStruct>>,\n+    struct StructWithVecBox {\n+        sized_type: Vec<Box<SizedStruct>>,\n+    }\n+\n+    struct A(Vec<Box<SizedStruct>>);\n+    struct B(Vec<Vec<Box<(u32)>>>);\n }\n \n-struct StructWithVecBoxButItsUnsized {\n-    unsized_type: Vec<Box<UnsizedStruct>>,\n+/// The following should not trigger the lint\n+mod should_not_trigger {\n+    use super::UnsizedStruct;\n+\n+    struct C(Vec<Box<UnsizedStruct>>);\n+\n+    struct StructWithVecBoxButItsUnsized {\n+        unsized_type: Vec<Box<UnsizedStruct>>,\n+    }\n+\n+    struct TraitVec<T: ?Sized> {\n+        // Regression test for #3720. This was causing an ICE.\n+        inner: Vec<Box<T>>,\n+    }\n }\n \n fn main() {}"}, {"sha": "b33880b46bd8886344aa40c0ac169b4a294d2a2d", "filename": "tests/ui/vec_box_sized.stderr", "status": "modified", "additions": 16, "deletions": 4, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/2972d546021a3035a118c8e25df3e0f0ca2ef12c/tests%2Fui%2Fvec_box_sized.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2972d546021a3035a118c8e25df3e0f0ca2ef12c/tests%2Fui%2Fvec_box_sized.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fvec_box_sized.stderr?ref=2972d546021a3035a118c8e25df3e0f0ca2ef12c", "patch": "@@ -1,10 +1,22 @@\n error: `Vec<T>` is already on the heap, the boxing is unnecessary.\n-  --> $DIR/vec_box_sized.rs:10:17\n+  --> $DIR/vec_box_sized.rs:13:21\n    |\n-LL |     sized_type: Vec<Box<SizedStruct>>,\n-   |                 ^^^^^^^^^^^^^^^^^^^^^ help: try: `Vec<SizedStruct>`\n+LL |         sized_type: Vec<Box<SizedStruct>>,\n+   |                     ^^^^^^^^^^^^^^^^^^^^^ help: try: `Vec<SizedStruct>`\n    |\n    = note: `-D clippy::vec-box` implied by `-D warnings`\n \n-error: aborting due to previous error\n+error: `Vec<T>` is already on the heap, the boxing is unnecessary.\n+  --> $DIR/vec_box_sized.rs:16:14\n+   |\n+LL |     struct A(Vec<Box<SizedStruct>>);\n+   |              ^^^^^^^^^^^^^^^^^^^^^ help: try: `Vec<SizedStruct>`\n+\n+error: `Vec<T>` is already on the heap, the boxing is unnecessary.\n+  --> $DIR/vec_box_sized.rs:17:18\n+   |\n+LL |     struct B(Vec<Vec<Box<(u32)>>>);\n+   |                  ^^^^^^^^^^^^^^^ help: try: `Vec<u32>`\n+\n+error: aborting due to 3 previous errors\n "}]}