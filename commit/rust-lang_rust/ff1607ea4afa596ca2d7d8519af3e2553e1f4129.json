{"sha": "ff1607ea4afa596ca2d7d8519af3e2553e1f4129", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZmMTYwN2VhNGFmYTU5NmNhMmQ3ZDg1MTlhZjNlMjU1M2UxZjQxMjk=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-12-05T10:33:07Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-12-05T10:33:07Z"}, "message": "Auto merge of #4880 - daxpedda:string-add, r=phansch\n\nFix false positive in `string_add`.\n\n`clippy::string_add` was popping up in macros.\nI'm not sure what clippy's general direction is in these matters, but I can change it to be external macros only too.\n\n---\n\nchangelog: Fix false positives for `string_add` in macro expansions.", "tree": {"sha": "4dce76b0ce0c017b3b4e2b5ba6961a1379ae8aee", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4dce76b0ce0c017b3b4e2b5ba6961a1379ae8aee"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ff1607ea4afa596ca2d7d8519af3e2553e1f4129", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ff1607ea4afa596ca2d7d8519af3e2553e1f4129", "html_url": "https://github.com/rust-lang/rust/commit/ff1607ea4afa596ca2d7d8519af3e2553e1f4129", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ff1607ea4afa596ca2d7d8519af3e2553e1f4129/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "374db5c0b7a8ebc92ecb35ee21e11961da6c754d", "url": "https://api.github.com/repos/rust-lang/rust/commits/374db5c0b7a8ebc92ecb35ee21e11961da6c754d", "html_url": "https://github.com/rust-lang/rust/commit/374db5c0b7a8ebc92ecb35ee21e11961da6c754d"}, {"sha": "946961d19ec48c26142907796f8e2b7567fb8a6c", "url": "https://api.github.com/repos/rust-lang/rust/commits/946961d19ec48c26142907796f8e2b7567fb8a6c", "html_url": "https://github.com/rust-lang/rust/commit/946961d19ec48c26142907796f8e2b7567fb8a6c"}], "stats": {"total": 29, "additions": 24, "deletions": 5}, "files": [{"sha": "d0f0bd6d94c144c8173a3949ffa9032028cc2993", "filename": "clippy_lints/src/strings.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/ff1607ea4afa596ca2d7d8519af3e2553e1f4129/clippy_lints%2Fsrc%2Fstrings.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ff1607ea4afa596ca2d7d8519af3e2553e1f4129/clippy_lints%2Fsrc%2Fstrings.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fstrings.rs?ref=ff1607ea4afa596ca2d7d8519af3e2553e1f4129", "patch": "@@ -1,6 +1,6 @@\n use rustc::declare_lint_pass;\n use rustc::hir::*;\n-use rustc::lint::{LateContext, LateLintPass, LintArray, LintPass};\n+use rustc::lint::{in_external_macro, LateContext, LateLintPass, LintArray, LintContext, LintPass};\n use rustc_errors::Applicability;\n use rustc_session::declare_tool_lint;\n use syntax::source_map::Spanned;\n@@ -80,6 +80,10 @@ declare_lint_pass!(StringAdd => [STRING_ADD, STRING_ADD_ASSIGN]);\n \n impl<'a, 'tcx> LateLintPass<'a, 'tcx> for StringAdd {\n     fn check_expr(&mut self, cx: &LateContext<'a, 'tcx>, e: &'tcx Expr) {\n+        if in_external_macro(cx.sess(), e.span) {\n+            return;\n+        }\n+\n         if let ExprKind::Binary(\n             Spanned {\n                 node: BinOpKind::Add, .."}, {"sha": "504d6733abfe0f5f885f06893938e1b2f5360559", "filename": "tests/ui/auxiliary/macro_rules.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ff1607ea4afa596ca2d7d8519af3e2553e1f4129/tests%2Fui%2Fauxiliary%2Fmacro_rules.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ff1607ea4afa596ca2d7d8519af3e2553e1f4129/tests%2Fui%2Fauxiliary%2Fmacro_rules.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fauxiliary%2Fmacro_rules.rs?ref=ff1607ea4afa596ca2d7d8519af3e2553e1f4129", "patch": "@@ -31,3 +31,11 @@ macro_rules! try_err {\n         }\n     };\n }\n+\n+#[macro_export]\n+macro_rules! string_add {\n+    () => {\n+        let y = \"\".to_owned();\n+        let z = y + \"...\";\n+    };\n+}"}, {"sha": "30fd17c59e518ed931dd82d8ed01c5e64865cf62", "filename": "tests/ui/string_add.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/ff1607ea4afa596ca2d7d8519af3e2553e1f4129/tests%2Fui%2Fstring_add.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ff1607ea4afa596ca2d7d8519af3e2553e1f4129/tests%2Fui%2Fstring_add.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fstring_add.rs?ref=ff1607ea4afa596ca2d7d8519af3e2553e1f4129", "patch": "@@ -1,3 +1,8 @@\n+// aux-build:macro_rules.rs\n+\n+#[macro_use]\n+extern crate macro_rules;\n+\n #[warn(clippy::string_add)]\n #[allow(clippy::string_add_assign, unused)]\n fn main() {\n@@ -16,4 +21,6 @@ fn main() {\n     let mut x = 1;\n     x = x + 1;\n     assert_eq!(2, x);\n+\n+    string_add!();\n }"}, {"sha": "3987641c75a30c04ce8dd03626eae79188722ee4", "filename": "tests/ui/string_add.stderr", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ff1607ea4afa596ca2d7d8519af3e2553e1f4129/tests%2Fui%2Fstring_add.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/ff1607ea4afa596ca2d7d8519af3e2553e1f4129/tests%2Fui%2Fstring_add.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fstring_add.stderr?ref=ff1607ea4afa596ca2d7d8519af3e2553e1f4129", "patch": "@@ -1,27 +1,27 @@\n error: manual implementation of an assign operation\n-  --> $DIR/string_add.rs:8:9\n+  --> $DIR/string_add.rs:13:9\n    |\n LL |         x = x + \".\";\n    |         ^^^^^^^^^^^ help: replace it with: `x += \".\"`\n    |\n    = note: `-D clippy::assign-op-pattern` implied by `-D warnings`\n \n error: you added something to a string. Consider using `String::push_str()` instead\n-  --> $DIR/string_add.rs:8:13\n+  --> $DIR/string_add.rs:13:13\n    |\n LL |         x = x + \".\";\n    |             ^^^^^^^\n    |\n    = note: `-D clippy::string-add` implied by `-D warnings`\n \n error: you added something to a string. Consider using `String::push_str()` instead\n-  --> $DIR/string_add.rs:12:13\n+  --> $DIR/string_add.rs:17:13\n    |\n LL |     let z = y + \"...\";\n    |             ^^^^^^^^^\n \n error: manual implementation of an assign operation\n-  --> $DIR/string_add.rs:17:5\n+  --> $DIR/string_add.rs:22:5\n    |\n LL |     x = x + 1;\n    |     ^^^^^^^^^ help: replace it with: `x += 1`"}]}