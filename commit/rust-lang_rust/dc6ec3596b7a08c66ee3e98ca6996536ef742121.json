{"sha": "dc6ec3596b7a08c66ee3e98ca6996536ef742121", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRjNmVjMzU5NmI3YTA4YzY2ZWUzZTk4Y2E2OTk2NTM2ZWY3NDIxMjE=", "commit": {"author": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2021-01-28T00:00:00Z"}, "committer": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2021-01-28T00:00:00Z"}, "message": "Avoid memory allocation when removing dead blocks\n\nUse `reachable_as_bitset` to reuse a bitset from the traversal rather\nthan allocating it seprately. Additionally check if there are any\nunreachable blocks before proceeding.", "tree": {"sha": "e7ad02205aef16d7c8cbb75ceeda77a6008961bc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e7ad02205aef16d7c8cbb75ceeda77a6008961bc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/dc6ec3596b7a08c66ee3e98ca6996536ef742121", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/dc6ec3596b7a08c66ee3e98ca6996536ef742121", "html_url": "https://github.com/rust-lang/rust/commit/dc6ec3596b7a08c66ee3e98ca6996536ef742121", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/dc6ec3596b7a08c66ee3e98ca6996536ef742121/comments", "author": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0e190206e2ff0c13d64701d9b4145bf89a2d0cab", "url": "https://api.github.com/repos/rust-lang/rust/commits/0e190206e2ff0c13d64701d9b4145bf89a2d0cab", "html_url": "https://github.com/rust-lang/rust/commit/0e190206e2ff0c13d64701d9b4145bf89a2d0cab"}], "stats": {"total": 13, "additions": 6, "deletions": 7}, "files": [{"sha": "11539d3ef30f4a9aa244b71c4df880b90fe22798", "filename": "compiler/rustc_mir/src/transform/simplify.rs", "status": "modified", "additions": 6, "deletions": 7, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/dc6ec3596b7a08c66ee3e98ca6996536ef742121/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fsimplify.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dc6ec3596b7a08c66ee3e98ca6996536ef742121/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fsimplify.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fsimplify.rs?ref=dc6ec3596b7a08c66ee3e98ca6996536ef742121", "patch": "@@ -28,7 +28,6 @@\n //! return.\n \n use crate::transform::MirPass;\n-use rustc_index::bit_set::BitSet;\n use rustc_index::vec::{Idx, IndexVec};\n use rustc_middle::mir::visit::{MutVisitor, MutatingUseContext, PlaceContext, Visitor};\n use rustc_middle::mir::*;\n@@ -288,17 +287,17 @@ impl<'a, 'tcx> CfgSimplifier<'a, 'tcx> {\n }\n \n pub fn remove_dead_blocks(body: &mut Body<'_>) {\n-    let mut seen = BitSet::new_empty(body.basic_blocks().len());\n-    for (bb, _) in traversal::preorder(body) {\n-        seen.insert(bb.index());\n+    let reachable = traversal::reachable_as_bitset(body);\n+    let num_blocks = body.basic_blocks().len();\n+    if num_blocks == reachable.count() {\n+        return;\n     }\n \n     let basic_blocks = body.basic_blocks_mut();\n-\n-    let num_blocks = basic_blocks.len();\n     let mut replacements: Vec<_> = (0..num_blocks).map(BasicBlock::new).collect();\n     let mut used_blocks = 0;\n-    for alive_index in seen.iter() {\n+    for alive_index in reachable.iter() {\n+        let alive_index = alive_index.index();\n         replacements[alive_index] = BasicBlock::new(used_blocks);\n         if alive_index != used_blocks {\n             // Swap the next alive block data with the current available slot. Since"}]}