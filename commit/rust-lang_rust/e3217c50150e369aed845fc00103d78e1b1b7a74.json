{"sha": "e3217c50150e369aed845fc00103d78e1b1b7a74", "node_id": "C_kwDOAAsO6NoAKGUzMjE3YzUwMTUwZTM2OWFlZDg0NWZjMDAxMDNkNzhlMWIxYjdhNzQ", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2022-03-18T16:38:32Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-03-18T16:38:32Z"}, "message": "Merge #11752\n\n11752: internal: Allow explicitly specifying end of fixture annotation r=Veykril a=Veykril\n\nbors r+\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>", "tree": {"sha": "53322b7e53a67c09954dfb8f6600bc767dd3f89f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/53322b7e53a67c09954dfb8f6600bc767dd3f89f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e3217c50150e369aed845fc00103d78e1b1b7a74", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJiNLWICRBK7hj4Ov3rIwAANkUIAHurwBWGcZMJ6PiOFPv7YkYL\nDv0ljgvOR0/epryXeuYRPdxwJLShOgmWNRVVuyH9KQk1QrmW5g0S+2OqI0FVwg/P\nJpYT3uft5tt4eGmiVgPEFJKf3CcaN7ix/VZmEr/2JDWCkD5ASv+Iw1OxlBuwZQb2\nATXHh6QdS+XUum6pBuJfuxsFOs3VseZkjRVfriowMdAs/7u0kmg2TEFp1jeRbB3V\nTBoENLhkJqJexeTku7IHHlmhQ5r9qFldsg41JsHJM4v1t2OdeChIQuvcicLEOONC\nGENpHTMkps5npLnNt3NhvM8gS2fB1mA7jnwkwvUtNgeLFAWaLM/iaJ9BKHETqD0=\n=E2oo\n-----END PGP SIGNATURE-----\n", "payload": "tree 53322b7e53a67c09954dfb8f6600bc767dd3f89f\nparent 97c7321cfa93973df9a9d0f3d9321a6ab5e5d87f\nparent 890f98f21f50f158d0efda9dd1a2a6f86af95d51\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1647621512 +0000\ncommitter GitHub <noreply@github.com> 1647621512 +0000\n\nMerge #11752\n\n11752: internal: Allow explicitly specifying end of fixture annotation r=Veykril a=Veykril\n\nbors r+\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e3217c50150e369aed845fc00103d78e1b1b7a74", "html_url": "https://github.com/rust-lang/rust/commit/e3217c50150e369aed845fc00103d78e1b1b7a74", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e3217c50150e369aed845fc00103d78e1b1b7a74/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "97c7321cfa93973df9a9d0f3d9321a6ab5e5d87f", "url": "https://api.github.com/repos/rust-lang/rust/commits/97c7321cfa93973df9a9d0f3d9321a6ab5e5d87f", "html_url": "https://github.com/rust-lang/rust/commit/97c7321cfa93973df9a9d0f3d9321a6ab5e5d87f"}, {"sha": "890f98f21f50f158d0efda9dd1a2a6f86af95d51", "url": "https://api.github.com/repos/rust-lang/rust/commits/890f98f21f50f158d0efda9dd1a2a6f86af95d51", "html_url": "https://github.com/rust-lang/rust/commit/890f98f21f50f158d0efda9dd1a2a6f86af95d51"}], "stats": {"total": 35, "additions": 28, "deletions": 7}, "files": [{"sha": "0fa38bb97ce9ad08af0f35908986edaa07b7739e", "filename": "crates/test_utils/src/lib.rs", "status": "modified", "additions": 28, "deletions": 7, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/e3217c50150e369aed845fc00103d78e1b1b7a74/crates%2Ftest_utils%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e3217c50150e369aed845fc00103d78e1b1b7a74/crates%2Ftest_utils%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Ftest_utils%2Fsrc%2Flib.rs?ref=e3217c50150e369aed845fc00103d78e1b1b7a74", "patch": "@@ -212,6 +212,13 @@ pub fn add_cursor(text: &str, offset: TextSize) -> String {\n /// // ^^^ first line\n /// //   | second line\n ///\n+/// Trailing whitespace is sometimes desired but usually stripped by the editor\n+/// if at the end of a line, or incorrectly sized if followed by another\n+/// annotation. In those cases the annotation can be explicitly ended with the\n+/// `$` character.\n+///\n+/// // ^^^ trailing-ws-wanted  $\n+///\n /// Annotations point to the last line that actually was long enough for the\n /// range, not counting annotations themselves. So overlapping annotations are\n /// possible:\n@@ -229,9 +236,10 @@ pub fn extract_annotations(text: &str) -> Vec<(TextRange, String)> {\n     let mut prev_line_annotations: Vec<(TextSize, usize)> = Vec::new();\n     for line in text.split_inclusive('\\n') {\n         let mut this_line_annotations = Vec::new();\n-        let line_length = if let Some(idx) = line.find(\"//\") {\n-            let annotation_offset = TextSize::of(&line[..idx + \"//\".len()]);\n-            for annotation in extract_line_annotations(&line[idx + \"//\".len()..]) {\n+        let line_length = if let Some((prefix, suffix)) = line.split_once(\"//\") {\n+            let ss_len = TextSize::of(\"//\");\n+            let annotation_offset = TextSize::of(prefix) + ss_len;\n+            for annotation in extract_line_annotations(suffix.trim_end_matches('\\n')) {\n                 match annotation {\n                     LineAnnotation::Annotation { mut range, content, file } => {\n                         range += annotation_offset;\n@@ -257,7 +265,7 @@ pub fn extract_annotations(text: &str) -> Vec<(TextRange, String)> {\n                     }\n                 }\n             }\n-            idx.try_into().unwrap()\n+            annotation_offset\n         } else {\n             TextSize::of(line)\n         };\n@@ -294,16 +302,29 @@ fn extract_line_annotations(mut line: &str) -> Vec<LineAnnotation> {\n             len = 1;\n         }\n         let range = TextRange::at(offset, len.try_into().unwrap());\n-        let next = line[len..].find(marker).map_or(line.len(), |it| it + len);\n-        let mut content = &line[len..][..next - len];\n+        let line_no_caret = &line[len..];\n+        let end_marker = line_no_caret.find(|c| c == '$');\n+        let next = line_no_caret.find(marker).map_or(line.len(), |it| it + len);\n+\n+        let mut content = match end_marker {\n+            Some(end_marker)\n+                if end_marker < next\n+                    && line_no_caret[end_marker..]\n+                        .strip_prefix(|c: char| c.is_whitespace() || c == '^')\n+                        .is_some() =>\n+            {\n+                &line_no_caret[..end_marker]\n+            }\n+            _ => line_no_caret[..next - len].trim_end(),\n+        };\n \n         let mut file = false;\n         if !continuation && content.starts_with(\"file\") {\n             file = true;\n             content = &content[\"file\".len()..];\n         }\n \n-        let content = content.trim().to_string();\n+        let content = content.trim_start().to_string();\n \n         let annotation = if continuation {\n             LineAnnotation::Continuation { offset: range.end(), content }"}]}