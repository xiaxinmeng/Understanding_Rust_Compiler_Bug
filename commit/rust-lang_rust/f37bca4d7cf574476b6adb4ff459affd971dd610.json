{"sha": "f37bca4d7cf574476b6adb4ff459affd971dd610", "node_id": "C_kwDOAAsO6NoAKGYzN2JjYTRkN2NmNTc0NDc2YjZhZGI0ZmY0NTlhZmZkOTcxZGQ2MTA", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-04-01T10:07:04Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-04-01T10:07:04Z"}, "message": "Rollup merge of #95531 - petrochenkov:metacount, r=nnethercote\n\nexpand: Do not count metavar declarations on RHS of `macro_rules`\n\nThey are 0 by definition there.\n\nAddresses https://github.com/rust-lang/rust/pull/95425#discussion_r837410476\nr? ```@nnethercote```", "tree": {"sha": "6bce9938952c517bca759cddd72dad322024bed5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6bce9938952c517bca759cddd72dad322024bed5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f37bca4d7cf574476b6adb4ff459affd971dd610", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJiRs7ICRBK7hj4Ov3rIwAAg+YIAERDLDzUOlQ9c1HaTFoJCsok\nPgWdmQ0oT6ICEahFv/2Y63tejnf62oUGAhcAd3qQMI86LKk2IBqauInZnuHTP7oX\noNBSJjfivUdU33iCzNyGM4H0GfTTjZrUtJgFf/Lk2nLiIzZlOoyGg32TmAO2l6/f\nfNFpywN/D7cu9QPluoN8nizThDMqHzCx8iOYPmNlfhDpo5RqfvHg1sTGGtJXrIYu\nlxUghTaHMPnVXgZpQ21C1vNhwYpM1IuHwYwBxDy0CjQR2GZBKyoVhyxr0UVBCWsY\nFU4V8+HJLYJCC/vtITpvSkYG2VRcaK0FouF3Cymd+queqa5W8qz+9EESKJbcQqw=\n=YegB\n-----END PGP SIGNATURE-----\n", "payload": "tree 6bce9938952c517bca759cddd72dad322024bed5\nparent c37aeb0299df2932f6404b30d6b8567cc56bfcaa\nparent 9ab4f732cb52eb07ea64a7f65038973bc4e0156c\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1648807624 +0200\ncommitter GitHub <noreply@github.com> 1648807624 +0200\n\nRollup merge of #95531 - petrochenkov:metacount, r=nnethercote\n\nexpand: Do not count metavar declarations on RHS of `macro_rules`\n\nThey are 0 by definition there.\n\nAddresses https://github.com/rust-lang/rust/pull/95425#discussion_r837410476\nr? ```@nnethercote```\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f37bca4d7cf574476b6adb4ff459affd971dd610", "html_url": "https://github.com/rust-lang/rust/commit/f37bca4d7cf574476b6adb4ff459affd971dd610", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f37bca4d7cf574476b6adb4ff459affd971dd610/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c37aeb0299df2932f6404b30d6b8567cc56bfcaa", "url": "https://api.github.com/repos/rust-lang/rust/commits/c37aeb0299df2932f6404b30d6b8567cc56bfcaa", "html_url": "https://github.com/rust-lang/rust/commit/c37aeb0299df2932f6404b30d6b8567cc56bfcaa"}, {"sha": "9ab4f732cb52eb07ea64a7f65038973bc4e0156c", "url": "https://api.github.com/repos/rust-lang/rust/commits/9ab4f732cb52eb07ea64a7f65038973bc4e0156c", "html_url": "https://github.com/rust-lang/rust/commit/9ab4f732cb52eb07ea64a7f65038973bc4e0156c"}], "stats": {"total": 25, "additions": 10, "deletions": 15}, "files": [{"sha": "0086983f3d984eb2a30784a37e7e194a34fd8e0e", "filename": "compiler/rustc_expand/src/mbe/macro_parser.rs", "status": "modified", "additions": 6, "deletions": 12, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/f37bca4d7cf574476b6adb4ff459affd971dd610/compiler%2Frustc_expand%2Fsrc%2Fmbe%2Fmacro_parser.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f37bca4d7cf574476b6adb4ff459affd971dd610/compiler%2Frustc_expand%2Fsrc%2Fmbe%2Fmacro_parser.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_expand%2Fsrc%2Fmbe%2Fmacro_parser.rs?ref=f37bca4d7cf574476b6adb4ff459affd971dd610", "patch": "@@ -263,18 +263,12 @@ crate type NamedParseResult = ParseResult<FxHashMap<MacroRulesNormalizedIdent, N\n pub(super) fn count_metavar_decls(matcher: &[TokenTree]) -> usize {\n     matcher\n         .iter()\n-        .map(|tt| {\n-            match tt {\n-                TokenTree::Delimited(_, delim) => count_metavar_decls(delim.inner_tts()),\n-                TokenTree::MetaVar(..) => 0,\n-                TokenTree::MetaVarDecl(..) => 1,\n-                // RHS meta-variable expressions eventually end-up here. `0` is returned to inform\n-                // that no meta-variable was found, because \"meta-variables\" != \"meta-variable\n-                // expressions\".\n-                TokenTree::MetaVarExpr(..) => 0,\n-                TokenTree::Sequence(_, seq) => seq.num_captures,\n-                TokenTree::Token(..) => 0,\n-            }\n+        .map(|tt| match tt {\n+            TokenTree::MetaVarDecl(..) => 1,\n+            TokenTree::Sequence(_, seq) => seq.num_captures,\n+            TokenTree::Delimited(_, delim) => count_metavar_decls(delim.inner_tts()),\n+            TokenTree::Token(..) => 0,\n+            TokenTree::MetaVar(..) | TokenTree::MetaVarExpr(..) => unreachable!(),\n         })\n         .sum()\n }"}, {"sha": "48abbd7c18e14d94d6384318108a02f250a50c33", "filename": "compiler/rustc_expand/src/mbe/quoted.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/f37bca4d7cf574476b6adb4ff459affd971dd610/compiler%2Frustc_expand%2Fsrc%2Fmbe%2Fquoted.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f37bca4d7cf574476b6adb4ff459affd971dd610/compiler%2Frustc_expand%2Fsrc%2Fmbe%2Fquoted.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_expand%2Fsrc%2Fmbe%2Fquoted.rs?ref=f37bca4d7cf574476b6adb4ff459affd971dd610", "patch": "@@ -1,4 +1,4 @@\n-use crate::mbe::macro_parser;\n+use crate::mbe::macro_parser::count_metavar_decls;\n use crate::mbe::{Delimited, KleeneOp, KleeneToken, MetaVarExpr, SequenceRepetition, TokenTree};\n \n use rustc_ast::token::{self, Token};\n@@ -211,14 +211,15 @@ fn parse_tree(\n                     let (separator, kleene) =\n                         parse_sep_and_kleene_op(&mut trees, delim_span.entire(), sess);\n                     // Count the number of captured \"names\" (i.e., named metavars)\n-                    let name_captures = macro_parser::count_metavar_decls(&sequence);\n+                    let num_captures =\n+                        if parsing_patterns { count_metavar_decls(&sequence) } else { 0 };\n                     TokenTree::Sequence(\n                         delim_span,\n                         Lrc::new(SequenceRepetition {\n                             tts: sequence,\n                             separator,\n                             kleene,\n-                            num_captures: name_captures,\n+                            num_captures,\n                         }),\n                     )\n                 }"}]}