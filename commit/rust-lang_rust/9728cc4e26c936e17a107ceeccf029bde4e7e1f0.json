{"sha": "9728cc4e26c936e17a107ceeccf029bde4e7e1f0", "node_id": "C_kwDOAAsO6NoAKDk3MjhjYzRlMjZjOTM2ZTE3YTEwN2NlZWNjZjAyOWJkZTRlN2UxZjA", "commit": {"author": {"name": "woppopo", "email": "woppopo@protonmail.com", "date": "2022-01-29T10:13:23Z"}, "committer": {"name": "woppopo", "email": "woppopo@protonmail.com", "date": "2022-01-29T10:13:23Z"}, "message": "Document about some behaviors of `const_(de)allocate` and add some tests.", "tree": {"sha": "b9b298917679b3de25e9ee41a30ade8acd5e69c2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b9b298917679b3de25e9ee41a30ade8acd5e69c2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9728cc4e26c936e17a107ceeccf029bde4e7e1f0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9728cc4e26c936e17a107ceeccf029bde4e7e1f0", "html_url": "https://github.com/rust-lang/rust/commit/9728cc4e26c936e17a107ceeccf029bde4e7e1f0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9728cc4e26c936e17a107ceeccf029bde4e7e1f0/comments", "author": {"login": "lilasta", "id": 77098789, "node_id": "MDQ6VXNlcjc3MDk4Nzg5", "avatar_url": "https://avatars.githubusercontent.com/u/77098789?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lilasta", "html_url": "https://github.com/lilasta", "followers_url": "https://api.github.com/users/lilasta/followers", "following_url": "https://api.github.com/users/lilasta/following{/other_user}", "gists_url": "https://api.github.com/users/lilasta/gists{/gist_id}", "starred_url": "https://api.github.com/users/lilasta/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lilasta/subscriptions", "organizations_url": "https://api.github.com/users/lilasta/orgs", "repos_url": "https://api.github.com/users/lilasta/repos", "events_url": "https://api.github.com/users/lilasta/events{/privacy}", "received_events_url": "https://api.github.com/users/lilasta/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lilasta", "id": 77098789, "node_id": "MDQ6VXNlcjc3MDk4Nzg5", "avatar_url": "https://avatars.githubusercontent.com/u/77098789?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lilasta", "html_url": "https://github.com/lilasta", "followers_url": "https://api.github.com/users/lilasta/followers", "following_url": "https://api.github.com/users/lilasta/following{/other_user}", "gists_url": "https://api.github.com/users/lilasta/gists{/gist_id}", "starred_url": "https://api.github.com/users/lilasta/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lilasta/subscriptions", "organizations_url": "https://api.github.com/users/lilasta/orgs", "repos_url": "https://api.github.com/users/lilasta/repos", "events_url": "https://api.github.com/users/lilasta/events{/privacy}", "received_events_url": "https://api.github.com/users/lilasta/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7a7144f4136897605842886b1ca51515e75d654e", "url": "https://api.github.com/repos/rust-lang/rust/commits/7a7144f4136897605842886b1ca51515e75d654e", "html_url": "https://github.com/rust-lang/rust/commit/7a7144f4136897605842886b1ca51515e75d654e"}], "stats": {"total": 55, "additions": 51, "deletions": 4}, "files": [{"sha": "b5228397f0a9990f10cd245c838c307dec120cfe", "filename": "library/core/src/intrinsics.rs", "status": "modified", "additions": 18, "deletions": 4, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/9728cc4e26c936e17a107ceeccf029bde4e7e1f0/library%2Fcore%2Fsrc%2Fintrinsics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9728cc4e26c936e17a107ceeccf029bde4e7e1f0/library%2Fcore%2Fsrc%2Fintrinsics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fintrinsics.rs?ref=9728cc4e26c936e17a107ceeccf029bde4e7e1f0", "patch": "@@ -1914,13 +1914,27 @@ extern \"rust-intrinsic\" {\n     #[rustc_const_unstable(feature = \"const_raw_ptr_comparison\", issue = \"53020\")]\n     pub fn ptr_guaranteed_ne<T>(ptr: *const T, other: *const T) -> bool;\n \n-    /// Allocate at compile time.\n-    /// Returns a null pointer at runtime.\n+    /// Allocates a block of memory at compile time.\n+    /// At runtime, just returns a null pointer.\n+    ///\n+    /// # Safety\n+    ///\n+    /// - The `align` argument must be a power of two.\n+    ///    - At compile time, a compile error occurs if this constraint is violated.\n+    ///    - At runtime, it is not checked.\n     #[rustc_const_unstable(feature = \"const_heap\", issue = \"79597\")]\n     pub fn const_allocate(size: usize, align: usize) -> *mut u8;\n \n-    /// Deallocate a memory which allocated by `intrinsics::const_allocate` at compile time.\n-    /// Does nothing at runtime.\n+    /// Deallocates a memory which allocated by `intrinsics::const_allocate` at compile time.\n+    /// At runtime, does nothing.\n+    ///\n+    /// # Safety\n+    ///\n+    /// - The `align` argument must be a power of two.\n+    ///    - At compile time, a compile error occurs if this constraint is violated.\n+    ///    - At runtime, it is not checked.\n+    /// - If the `ptr` is created in an another const, this intrinsic doesn't deallocate it.\n+    /// - If the `ptr` is pointing to a local variable, this intrinsic doesn't deallocate it.\n     #[rustc_const_unstable(feature = \"const_heap\", issue = \"79597\")]\n     #[cfg(not(bootstrap))]\n     pub fn const_deallocate(ptr: *mut u8, size: usize, align: usize);"}, {"sha": "407e69d41a0fa2c8073533c52717afdca0da773e", "filename": "src/test/ui/consts/const-eval/heap/alloc_intrinsic_zero_sized.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/9728cc4e26c936e17a107ceeccf029bde4e7e1f0/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fheap%2Falloc_intrinsic_zero_sized.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9728cc4e26c936e17a107ceeccf029bde4e7e1f0/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fheap%2Falloc_intrinsic_zero_sized.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fheap%2Falloc_intrinsic_zero_sized.rs?ref=9728cc4e26c936e17a107ceeccf029bde4e7e1f0", "patch": "@@ -0,0 +1,16 @@\n+// run-pass\n+#![feature(core_intrinsics)]\n+#![feature(const_heap)]\n+#![feature(inline_const)]\n+\n+use std::intrinsics;\n+\n+struct ZST;\n+\n+fn main() {\n+    const {\n+        unsafe {\n+            let _ = intrinsics::const_allocate(0, 0) as *mut ZST;\n+        }\n+    }\n+}"}, {"sha": "84fb4d2ea870f2b73802b397e7d95563eb4978dc", "filename": "src/test/ui/consts/const-eval/heap/dealloc_intrinsic_zero_sized.rs", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/9728cc4e26c936e17a107ceeccf029bde4e7e1f0/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fheap%2Fdealloc_intrinsic_zero_sized.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9728cc4e26c936e17a107ceeccf029bde4e7e1f0/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fheap%2Fdealloc_intrinsic_zero_sized.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fconst-eval%2Fheap%2Fdealloc_intrinsic_zero_sized.rs?ref=9728cc4e26c936e17a107ceeccf029bde4e7e1f0", "patch": "@@ -0,0 +1,17 @@\n+// run-pass\n+#![feature(core_intrinsics)]\n+#![feature(const_heap)]\n+#![feature(inline_const)]\n+\n+use std::intrinsics;\n+\n+fn main() {\n+    const {\n+        unsafe {\n+            let ptr1 = intrinsics::const_allocate(0, 0);\n+            let ptr2 = intrinsics::const_allocate(0, 0);\n+            intrinsics::const_deallocate(ptr1, 0, 0);\n+            intrinsics::const_deallocate(ptr2, 0, 0);\n+        }\n+    }\n+}"}]}