{"sha": "7242bda3dc6ad638392577fd43d1e30c3671ae74", "node_id": "MDY6Q29tbWl0NzI0NzEyOjcyNDJiZGEzZGM2YWQ2MzgzOTI1NzdmZDQzZDFlMzBjMzY3MWFlNzQ=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2020-05-30T01:04:15Z"}, "committer": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2020-05-30T01:04:15Z"}, "message": "Be more careful around ty::Error in generators", "tree": {"sha": "bba2cb9b08c8032597020b5f3e873f37e718b1c8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bba2cb9b08c8032597020b5f3e873f37e718b1c8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7242bda3dc6ad638392577fd43d1e30c3671ae74", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7242bda3dc6ad638392577fd43d1e30c3671ae74", "html_url": "https://github.com/rust-lang/rust/commit/7242bda3dc6ad638392577fd43d1e30c3671ae74", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7242bda3dc6ad638392577fd43d1e30c3671ae74/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4bd32c98047a809ba5fd1fac2aa044638e5f2105", "url": "https://api.github.com/repos/rust-lang/rust/commits/4bd32c98047a809ba5fd1fac2aa044638e5f2105", "html_url": "https://github.com/rust-lang/rust/commit/4bd32c98047a809ba5fd1fac2aa044638e5f2105"}], "stats": {"total": 79, "additions": 51, "deletions": 28}, "files": [{"sha": "60c040c25f97c832a82a07b49928b16b4001f770", "filename": "src/librustc_mir/transform/generator.rs", "status": "modified", "additions": 43, "deletions": 26, "changes": 69, "blob_url": "https://github.com/rust-lang/rust/blob/7242bda3dc6ad638392577fd43d1e30c3671ae74/src%2Flibrustc_mir%2Ftransform%2Fgenerator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7242bda3dc6ad638392577fd43d1e30c3671ae74/src%2Flibrustc_mir%2Ftransform%2Fgenerator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fgenerator.rs?ref=7242bda3dc6ad638392577fd43d1e30c3671ae74", "patch": "@@ -669,40 +669,33 @@ fn compute_storage_conflicts(\n     storage_conflicts\n }\n \n-fn compute_layout<'tcx>(\n+/// Validates the typeck view of the generator against the actual set of types retained between\n+/// yield points.\n+fn sanitize_witness<'tcx>(\n     tcx: TyCtxt<'tcx>,\n-    source: MirSource<'tcx>,\n+    body: &Body<'tcx>,\n+    did: DefId,\n+    witness: Ty<'tcx>,\n     upvars: &Vec<Ty<'tcx>>,\n-    interior: Ty<'tcx>,\n-    always_live_locals: &storage::AlwaysLiveLocals,\n-    movable: bool,\n-    body: &mut Body<'tcx>,\n-) -> (\n-    FxHashMap<Local, (Ty<'tcx>, VariantIdx, usize)>,\n-    GeneratorLayout<'tcx>,\n-    IndexVec<BasicBlock, Option<BitSet<Local>>>,\n+    retained: &BitSet<Local>,\n ) {\n-    // Use a liveness analysis to compute locals which are live across a suspension point\n-    let LivenessInfo {\n-        live_locals,\n-        live_locals_at_suspension_points,\n-        storage_conflicts,\n-        storage_liveness,\n-    } = locals_live_across_suspend_points(tcx, body, source, always_live_locals, movable);\n-\n-    // Erase regions from the types passed in from typeck so we can compare them with\n-    // MIR types\n     let allowed_upvars = tcx.erase_regions(upvars);\n-    let allowed = match interior.kind {\n+    let allowed = match witness.kind {\n         ty::GeneratorWitness(s) => tcx.erase_late_bound_regions(&s),\n-        _ => bug!(),\n+        _ => {\n+            tcx.sess.delay_span_bug(\n+                body.span,\n+                &format!(\"unexpected generator witness type {:?}\", witness.kind),\n+            );\n+            return;\n+        }\n     };\n \n-    let param_env = tcx.param_env(source.def_id());\n+    let param_env = tcx.param_env(did);\n \n     for (local, decl) in body.local_decls.iter_enumerated() {\n-        // Ignore locals which are internal or not live\n-        if !live_locals.contains(local) || decl.internal {\n+        // Ignore locals which are internal or not retained between yields.\n+        if !retained.contains(local) || decl.internal {\n             continue;\n         }\n         let decl_ty = tcx.normalize_erasing_regions(param_env, decl.ty);\n@@ -715,10 +708,34 @@ fn compute_layout<'tcx>(\n                 \"Broken MIR: generator contains type {} in MIR, \\\n                        but typeck only knows about {}\",\n                 decl.ty,\n-                interior\n+                witness,\n             );\n         }\n     }\n+}\n+\n+fn compute_layout<'tcx>(\n+    tcx: TyCtxt<'tcx>,\n+    source: MirSource<'tcx>,\n+    upvars: &Vec<Ty<'tcx>>,\n+    interior: Ty<'tcx>,\n+    always_live_locals: &storage::AlwaysLiveLocals,\n+    movable: bool,\n+    body: &mut Body<'tcx>,\n+) -> (\n+    FxHashMap<Local, (Ty<'tcx>, VariantIdx, usize)>,\n+    GeneratorLayout<'tcx>,\n+    IndexVec<BasicBlock, Option<BitSet<Local>>>,\n+) {\n+    // Use a liveness analysis to compute locals which are live across a suspension point\n+    let LivenessInfo {\n+        live_locals,\n+        live_locals_at_suspension_points,\n+        storage_conflicts,\n+        storage_liveness,\n+    } = locals_live_across_suspend_points(tcx, body, source, always_live_locals, movable);\n+\n+    sanitize_witness(tcx, body, source.def_id(), interior, upvars, &live_locals);\n \n     // Gather live local types and their indices.\n     let mut locals = IndexVec::<GeneratorSavedLocal, _>::new();"}, {"sha": "ca5477ef4a98622e084190baf9e2b537a0ab9949", "filename": "src/librustc_ty/needs_drop.rs", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/7242bda3dc6ad638392577fd43d1e30c3671ae74/src%2Flibrustc_ty%2Fneeds_drop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7242bda3dc6ad638392577fd43d1e30c3671ae74/src%2Flibrustc_ty%2Fneeds_drop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_ty%2Fneeds_drop.rs?ref=7242bda3dc6ad638392577fd43d1e30c3671ae74", "patch": "@@ -98,7 +98,7 @@ where\n                         }\n                     }\n \n-                    ty::Generator(_, substs, _) => {\n+                    ty::Generator(def_id, substs, _) => {\n                         let substs = substs.as_generator();\n                         for upvar_ty in substs.upvar_tys() {\n                             queue_type(self, upvar_ty);\n@@ -107,7 +107,13 @@ where\n                         let witness = substs.witness();\n                         let interior_tys = match &witness.kind {\n                             ty::GeneratorWitness(tys) => tcx.erase_late_bound_regions(tys),\n-                            _ => bug!(),\n+                            _ => {\n+                                tcx.sess.delay_span_bug(\n+                                    tcx.hir().span_if_local(def_id).unwrap_or(DUMMY_SP),\n+                                    &format!(\"unexpected generator witness type {:?}\", witness),\n+                                );\n+                                return Some(Err(AlwaysRequiresDrop));\n+                            }\n                         };\n \n                         for interior_ty in interior_tys {"}]}