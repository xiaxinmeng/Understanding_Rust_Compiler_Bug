{"sha": "57cd936c5262c3b43626618be42d7a72f71c3539", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU3Y2Q5MzZjNTI2MmMzYjQzNjI2NjE4YmU0MmQ3YTcyZjcxYzM1Mzk=", "commit": {"author": {"name": "Mikhail Rakhmanov", "email": "rakhmanov.m@gmail.com", "date": "2020-06-02T20:21:48Z"}, "committer": {"name": "Mikhail Rakhmanov", "email": "rakhmanov.m@gmail.com", "date": "2020-06-02T21:10:53Z"}, "message": "Preliminary implementation of lazy CodeAssits", "tree": {"sha": "a21852bb596fea5d1d355b3ad70f1f8e985ef3bd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a21852bb596fea5d1d355b3ad70f1f8e985ef3bd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/57cd936c5262c3b43626618be42d7a72f71c3539", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/57cd936c5262c3b43626618be42d7a72f71c3539", "html_url": "https://github.com/rust-lang/rust/commit/57cd936c5262c3b43626618be42d7a72f71c3539", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/57cd936c5262c3b43626618be42d7a72f71c3539/comments", "author": {"login": "mcrakhman", "id": 16068868, "node_id": "MDQ6VXNlcjE2MDY4ODY4", "avatar_url": "https://avatars.githubusercontent.com/u/16068868?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mcrakhman", "html_url": "https://github.com/mcrakhman", "followers_url": "https://api.github.com/users/mcrakhman/followers", "following_url": "https://api.github.com/users/mcrakhman/following{/other_user}", "gists_url": "https://api.github.com/users/mcrakhman/gists{/gist_id}", "starred_url": "https://api.github.com/users/mcrakhman/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mcrakhman/subscriptions", "organizations_url": "https://api.github.com/users/mcrakhman/orgs", "repos_url": "https://api.github.com/users/mcrakhman/repos", "events_url": "https://api.github.com/users/mcrakhman/events{/privacy}", "received_events_url": "https://api.github.com/users/mcrakhman/received_events", "type": "User", "site_admin": false}, "committer": {"login": "mcrakhman", "id": 16068868, "node_id": "MDQ6VXNlcjE2MDY4ODY4", "avatar_url": "https://avatars.githubusercontent.com/u/16068868?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mcrakhman", "html_url": "https://github.com/mcrakhman", "followers_url": "https://api.github.com/users/mcrakhman/followers", "following_url": "https://api.github.com/users/mcrakhman/following{/other_user}", "gists_url": "https://api.github.com/users/mcrakhman/gists{/gist_id}", "starred_url": "https://api.github.com/users/mcrakhman/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mcrakhman/subscriptions", "organizations_url": "https://api.github.com/users/mcrakhman/orgs", "repos_url": "https://api.github.com/users/mcrakhman/repos", "events_url": "https://api.github.com/users/mcrakhman/events{/privacy}", "received_events_url": "https://api.github.com/users/mcrakhman/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "61e8f392191037acefddc5793e814f93d01b114a", "url": "https://api.github.com/repos/rust-lang/rust/commits/61e8f392191037acefddc5793e814f93d01b114a", "html_url": "https://github.com/rust-lang/rust/commit/61e8f392191037acefddc5793e814f93d01b114a"}], "stats": {"total": 300, "additions": 215, "deletions": 85}, "files": [{"sha": "34c2d75fed2b025c5010c17d1c53408f3be02afb", "filename": "crates/ra_ide/src/lib.rs", "status": "modified", "additions": 17, "deletions": 22, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/57cd936c5262c3b43626618be42d7a72f71c3539/crates%2Fra_ide%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57cd936c5262c3b43626618be42d7a72f71c3539/crates%2Fra_ide%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Flib.rs?ref=57cd936c5262c3b43626618be42d7a72f71c3539", "patch": "@@ -77,7 +77,7 @@ pub use crate::{\n };\n \n pub use hir::Documentation;\n-pub use ra_assists::{AssistConfig, AssistId};\n+pub use ra_assists::{Assist, AssistConfig, AssistId, ResolvedAssist};\n pub use ra_db::{\n     Canceled, CrateGraph, CrateId, Edition, FileId, FilePosition, FileRange, SourceRootId,\n };\n@@ -142,14 +142,6 @@ pub struct AnalysisHost {\n     db: RootDatabase,\n }\n \n-#[derive(Debug)]\n-pub struct Assist {\n-    pub id: AssistId,\n-    pub label: String,\n-    pub group_label: Option<String>,\n-    pub source_change: SourceChange,\n-}\n-\n impl AnalysisHost {\n     pub fn new(lru_capacity: Option<usize>) -> AnalysisHost {\n         AnalysisHost { db: RootDatabase::new(lru_capacity) }\n@@ -470,20 +462,23 @@ impl Analysis {\n         self.with_db(|db| completion::completions(db, config, position).map(Into::into))\n     }\n \n-    /// Computes assists (aka code actions aka intentions) for the given\n+    /// Computes resolved assists with source changes for the given position.\n+    pub fn resolved_assists(\n+        &self,\n+        config: &AssistConfig,\n+        frange: FileRange,\n+    ) -> Cancelable<Vec<ResolvedAssist>> {\n+        self.with_db(|db| ra_assists::Assist::resolved(db, config, frange))\n+    }\n+\n+    /// Computes unresolved assists (aka code actions aka intentions) for the given\n     /// position.\n-    pub fn assists(&self, config: &AssistConfig, frange: FileRange) -> Cancelable<Vec<Assist>> {\n-        self.with_db(|db| {\n-            ra_assists::Assist::resolved(db, config, frange)\n-                .into_iter()\n-                .map(|assist| Assist {\n-                    id: assist.assist.id,\n-                    label: assist.assist.label,\n-                    group_label: assist.assist.group.map(|it| it.0),\n-                    source_change: assist.source_change,\n-                })\n-                .collect()\n-        })\n+    pub fn unresolved_assists(\n+        &self,\n+        config: &AssistConfig,\n+        frange: FileRange,\n+    ) -> Cancelable<Vec<Assist>> {\n+        self.with_db(|db| Assist::unresolved(db, config, frange))\n     }\n \n     /// Computes the set of diagnostics for the given file."}, {"sha": "9e8e7ab824e23d63eb823c4663eb125e3dc0ab82", "filename": "crates/rust-analyzer/src/config.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/57cd936c5262c3b43626618be42d7a72f71c3539/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57cd936c5262c3b43626618be42d7a72f71c3539/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs?ref=57cd936c5262c3b43626618be42d7a72f71c3539", "patch": "@@ -103,6 +103,7 @@ pub struct ClientCapsConfig {\n     pub code_action_literals: bool,\n     pub work_done_progress: bool,\n     pub code_action_group: bool,\n+    pub resolve_code_action: bool,\n }\n \n impl Default for Config {\n@@ -299,7 +300,11 @@ impl Config {\n \n             let code_action_group =\n                 experimental.get(\"codeActionGroup\").and_then(|it| it.as_bool()) == Some(true);\n-            self.client_caps.code_action_group = code_action_group\n+            self.client_caps.code_action_group = code_action_group;\n+\n+            let resolve_code_action =\n+                experimental.get(\"resolveCodeAction\").and_then(|it| it.as_bool()) == Some(true);\n+            self.client_caps.resolve_code_action = resolve_code_action;\n         }\n     }\n }"}, {"sha": "272057b47ea668cadc03335b799d010ae046f54c", "filename": "crates/rust-analyzer/src/diagnostics/snapshots/rust_analyzer__diagnostics__to_proto__tests__snap_multi_line_fix.snap", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/57cd936c5262c3b43626618be42d7a72f71c3539/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Fsnapshots%2Frust_analyzer__diagnostics__to_proto__tests__snap_multi_line_fix.snap", "raw_url": "https://github.com/rust-lang/rust/raw/57cd936c5262c3b43626618be42d7a72f71c3539/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Fsnapshots%2Frust_analyzer__diagnostics__to_proto__tests__snap_multi_line_fix.snap", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Fsnapshots%2Frust_analyzer__diagnostics__to_proto__tests__snap_multi_line_fix.snap?ref=57cd936c5262c3b43626618be42d7a72f71c3539", "patch": "@@ -65,6 +65,7 @@ expression: diag\n         fixes: [\n             CodeAction {\n                 title: \"return the expression directly\",\n+                id: None,\n                 group: None,\n                 kind: Some(\n                     \"quickfix\","}, {"sha": "9a7972ff54a4deea812a7a5c9833b0abb51fefc3", "filename": "crates/rust-analyzer/src/diagnostics/snapshots/rust_analyzer__diagnostics__to_proto__tests__snap_rustc_unused_variable.snap", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/57cd936c5262c3b43626618be42d7a72f71c3539/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Fsnapshots%2Frust_analyzer__diagnostics__to_proto__tests__snap_rustc_unused_variable.snap", "raw_url": "https://github.com/rust-lang/rust/raw/57cd936c5262c3b43626618be42d7a72f71c3539/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Fsnapshots%2Frust_analyzer__diagnostics__to_proto__tests__snap_rustc_unused_variable.snap", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Fsnapshots%2Frust_analyzer__diagnostics__to_proto__tests__snap_rustc_unused_variable.snap?ref=57cd936c5262c3b43626618be42d7a72f71c3539", "patch": "@@ -50,6 +50,7 @@ expression: diag\n         fixes: [\n             CodeAction {\n                 title: \"consider prefixing with an underscore\",\n+                id: None,\n                 group: None,\n                 kind: Some(\n                     \"quickfix\","}, {"sha": "257910e0948c5e27f69954633e7ebe1e358c3d8a", "filename": "crates/rust-analyzer/src/diagnostics/to_proto.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/57cd936c5262c3b43626618be42d7a72f71c3539/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Fto_proto.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57cd936c5262c3b43626618be42d7a72f71c3539/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Fto_proto.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics%2Fto_proto.rs?ref=57cd936c5262c3b43626618be42d7a72f71c3539", "patch": "@@ -145,6 +145,7 @@ fn map_rust_child_diagnostic(\n     } else {\n         MappedRustChildDiagnostic::SuggestedFix(lsp_ext::CodeAction {\n             title: rd.message.clone(),\n+            id: None,\n             group: None,\n             kind: Some(\"quickfix\".to_string()),\n             edit: Some(lsp_ext::SnippetWorkspaceEdit {"}, {"sha": "05b76e7c86ba3b31ba6520b79ca0a3d07caf686f", "filename": "crates/rust-analyzer/src/lsp_ext.rs", "status": "modified", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/57cd936c5262c3b43626618be42d7a72f71c3539/crates%2Frust-analyzer%2Fsrc%2Flsp_ext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57cd936c5262c3b43626618be42d7a72f71c3539/crates%2Frust-analyzer%2Fsrc%2Flsp_ext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Flsp_ext.rs?ref=57cd936c5262c3b43626618be42d7a72f71c3539", "patch": "@@ -98,6 +98,23 @@ pub struct JoinLinesParams {\n     pub ranges: Vec<Range>,\n }\n \n+pub enum ResolveCodeActionRequest {}\n+\n+impl Request for ResolveCodeActionRequest {\n+    type Params = ResolveCodeActionParams;\n+    type Result = Option<SnippetWorkspaceEdit>;\n+    const METHOD: &'static str = \"experimental/resolveCodeAction\";\n+}\n+\n+/// Params for the ResolveCodeActionRequest\n+#[derive(Debug, Eq, PartialEq, Clone, Deserialize, Serialize)]\n+#[serde(rename_all = \"camelCase\")]\n+pub struct ResolveCodeActionParams {\n+    pub code_action_params: lsp_types::CodeActionParams,\n+    pub id: String,\n+    pub label: String,\n+}\n+\n pub enum OnEnter {}\n \n impl Request for OnEnter {\n@@ -197,6 +214,8 @@ impl Request for CodeActionRequest {\n pub struct CodeAction {\n     pub title: String,\n     #[serde(skip_serializing_if = \"Option::is_none\")]\n+    pub id: Option<String>,\n+    #[serde(skip_serializing_if = \"Option::is_none\")]\n     pub group: Option<String>,\n     #[serde(skip_serializing_if = \"Option::is_none\")]\n     pub kind: Option<String>,"}, {"sha": "ad9dd4c5961799b6eb4533ff067739674aba7b7f", "filename": "crates/rust-analyzer/src/main_loop.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/57cd936c5262c3b43626618be42d7a72f71c3539/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57cd936c5262c3b43626618be42d7a72f71c3539/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs?ref=57cd936c5262c3b43626618be42d7a72f71c3539", "patch": "@@ -517,6 +517,7 @@ fn on_request(\n         .on::<lsp_ext::Runnables>(handlers::handle_runnables)?\n         .on::<lsp_ext::InlayHints>(handlers::handle_inlay_hints)?\n         .on::<lsp_ext::CodeActionRequest>(handlers::handle_code_action)?\n+        .on::<lsp_ext::ResolveCodeActionRequest>(handlers::handle_resolve_code_action)?\n         .on::<lsp_types::request::OnTypeFormatting>(handlers::handle_on_type_formatting)?\n         .on::<lsp_types::request::DocumentSymbolRequest>(handlers::handle_document_symbol)?\n         .on::<lsp_types::request::WorkspaceSymbol>(handlers::handle_workspace_symbol)?"}, {"sha": "b342f4bb7ea417b4979aefd0c605e58f6973d462", "filename": "crates/rust-analyzer/src/main_loop/handlers.rs", "status": "modified", "additions": 69, "deletions": 20, "changes": 89, "blob_url": "https://github.com/rust-lang/rust/blob/57cd936c5262c3b43626618be42d7a72f71c3539/crates%2Frust-analyzer%2Fsrc%2Fmain_loop%2Fhandlers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57cd936c5262c3b43626618be42d7a72f71c3539/crates%2Frust-analyzer%2Fsrc%2Fmain_loop%2Fhandlers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fmain_loop%2Fhandlers.rs?ref=57cd936c5262c3b43626618be42d7a72f71c3539", "patch": "@@ -693,54 +693,103 @@ pub fn handle_formatting(\n     }]))\n }\n \n-pub fn handle_code_action(\n-    world: WorldSnapshot,\n-    params: lsp_types::CodeActionParams,\n-) -> Result<Option<Vec<lsp_ext::CodeAction>>> {\n-    let _p = profile(\"handle_code_action\");\n-    // We intentionally don't support command-based actions, as those either\n-    // requires custom client-code anyway, or requires server-initiated edits.\n-    // Server initiated edits break causality, so we avoid those as well.\n-    if !world.config.client_caps.code_action_literals {\n-        return Ok(None);\n-    }\n-\n+fn handle_fixes(\n+    world: &WorldSnapshot,\n+    params: &lsp_types::CodeActionParams,\n+    res: &mut Vec<lsp_ext::CodeAction>,\n+) -> Result<()> {\n     let file_id = from_proto::file_id(&world, &params.text_document.uri)?;\n     let line_index = world.analysis().file_line_index(file_id)?;\n     let range = from_proto::text_range(&line_index, params.range);\n-    let frange = FileRange { file_id, range };\n \n     let diagnostics = world.analysis().diagnostics(file_id)?;\n-    let mut res: Vec<lsp_ext::CodeAction> = Vec::new();\n \n     let fixes_from_diagnostics = diagnostics\n         .into_iter()\n         .filter_map(|d| Some((d.range, d.fix?)))\n         .filter(|(diag_range, _fix)| diag_range.intersect(range).is_some())\n         .map(|(_range, fix)| fix);\n-\n     for fix in fixes_from_diagnostics {\n         let title = fix.label;\n         let edit = to_proto::snippet_workspace_edit(&world, fix.source_change)?;\n-        let action =\n-            lsp_ext::CodeAction { title, group: None, kind: None, edit: Some(edit), command: None };\n+        let action = lsp_ext::CodeAction {\n+            title,\n+            id: None,\n+            group: None,\n+            kind: None,\n+            edit: Some(edit),\n+            command: None,\n+        };\n         res.push(action);\n     }\n-\n     for fix in world.check_fixes.get(&file_id).into_iter().flatten() {\n         let fix_range = from_proto::text_range(&line_index, fix.range);\n         if fix_range.intersect(range).is_none() {\n             continue;\n         }\n         res.push(fix.action.clone());\n     }\n+    Ok(())\n+}\n+\n+pub fn handle_code_action(\n+    world: WorldSnapshot,\n+    params: lsp_types::CodeActionParams,\n+) -> Result<Option<Vec<lsp_ext::CodeAction>>> {\n+    let _p = profile(\"handle_code_action\");\n+    // We intentionally don't support command-based actions, as those either\n+    // requires custom client-code anyway, or requires server-initiated edits.\n+    // Server initiated edits break causality, so we avoid those as well.\n+    if !world.config.client_caps.code_action_literals {\n+        return Ok(None);\n+    }\n+\n+    let file_id = from_proto::file_id(&world, &params.text_document.uri)?;\n+    let line_index = world.analysis().file_line_index(file_id)?;\n+    let range = from_proto::text_range(&line_index, params.range);\n+    let frange = FileRange { file_id, range };\n+    let mut res: Vec<lsp_ext::CodeAction> = Vec::new();\n+\n+    handle_fixes(&world, &params, &mut res)?;\n \n-    for assist in world.analysis().assists(&world.config.assist, frange)?.into_iter() {\n-        res.push(to_proto::code_action(&world, assist)?.into());\n+    if world.config.client_caps.resolve_code_action {\n+        for assist in world.analysis().unresolved_assists(&world.config.assist, frange)?.into_iter()\n+        {\n+            res.push(to_proto::unresolved_code_action(&world, assist)?.into());\n+        }\n+    } else {\n+        for assist in world.analysis().resolved_assists(&world.config.assist, frange)?.into_iter() {\n+            res.push(to_proto::resolved_code_action(&world, assist)?.into());\n+        }\n     }\n+\n     Ok(Some(res))\n }\n \n+pub fn handle_resolve_code_action(\n+    world: WorldSnapshot,\n+    params: lsp_ext::ResolveCodeActionParams,\n+) -> Result<Option<lsp_ext::SnippetWorkspaceEdit>> {\n+    if !world.config.client_caps.resolve_code_action {\n+        return Ok(None);\n+    }\n+\n+    let _p = profile(\"handle_resolve_code_action\");\n+    let file_id = from_proto::file_id(&world, &params.code_action_params.text_document.uri)?;\n+    let line_index = world.analysis().file_line_index(file_id)?;\n+    let range = from_proto::text_range(&line_index, params.code_action_params.range);\n+    let frange = FileRange { file_id, range };\n+    let mut res: Vec<lsp_ext::CodeAction> = Vec::new();\n+\n+    for assist in world.analysis().resolved_assists(&world.config.assist, frange)?.into_iter() {\n+        res.push(to_proto::resolved_code_action(&world, assist)?.into());\n+    }\n+    Ok(res\n+        .into_iter()\n+        .find(|action| action.id.clone().unwrap() == params.id && action.title == params.label)\n+        .and_then(|action| action.edit))\n+}\n+\n pub fn handle_code_lens(\n     world: WorldSnapshot,\n     params: lsp_types::CodeLensParams,"}, {"sha": "db78c4b5c50510478b1529f56d8fa1671da4e4f6", "filename": "crates/rust-analyzer/src/to_proto.rs", "status": "modified", "additions": 35, "deletions": 4, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/57cd936c5262c3b43626618be42d7a72f71c3539/crates%2Frust-analyzer%2Fsrc%2Fto_proto.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57cd936c5262c3b43626618be42d7a72f71c3539/crates%2Frust-analyzer%2Fsrc%2Fto_proto.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fto_proto.rs?ref=57cd936c5262c3b43626618be42d7a72f71c3539", "patch": "@@ -3,8 +3,8 @@ use ra_db::{FileId, FileRange};\n use ra_ide::{\n     Assist, CompletionItem, CompletionItemKind, Documentation, FileSystemEdit, Fold, FoldKind,\n     FunctionSignature, Highlight, HighlightModifier, HighlightTag, HighlightedRange, Indel,\n-    InlayHint, InlayKind, InsertTextFormat, LineIndex, NavigationTarget, ReferenceAccess, Severity,\n-    SourceChange, SourceFileEdit, TextEdit,\n+    InlayHint, InlayKind, InsertTextFormat, LineIndex, NavigationTarget, ReferenceAccess,\n+    ResolvedAssist, Severity, SourceChange, SourceFileEdit, TextEdit,\n };\n use ra_syntax::{SyntaxKind, TextRange, TextSize};\n use ra_vfs::LineEndings;\n@@ -617,10 +617,41 @@ fn main() <fold>{\n     }\n }\n \n-pub(crate) fn code_action(world: &WorldSnapshot, assist: Assist) -> Result<lsp_ext::CodeAction> {\n+pub(crate) fn unresolved_code_action(\n+    world: &WorldSnapshot,\n+    assist: Assist,\n+) -> Result<lsp_ext::CodeAction> {\n     let res = lsp_ext::CodeAction {\n         title: assist.label,\n-        group: if world.config.client_caps.code_action_group { assist.group_label } else { None },\n+        id: Some(assist.id.0.to_owned()),\n+        group: assist.group.and_then(|it| {\n+            if world.config.client_caps.code_action_group {\n+                None\n+            } else {\n+                Some(it.0)\n+            }\n+        }),\n+        kind: Some(String::new()),\n+        edit: None,\n+        command: None,\n+    };\n+    Ok(res)\n+}\n+\n+pub(crate) fn resolved_code_action(\n+    world: &WorldSnapshot,\n+    assist: ResolvedAssist,\n+) -> Result<lsp_ext::CodeAction> {\n+    let res = lsp_ext::CodeAction {\n+        title: assist.assist.label,\n+        id: Some(assist.assist.id.0.to_owned()),\n+        group: assist.assist.group.and_then(|it| {\n+            if world.config.client_caps.code_action_group {\n+                None\n+            } else {\n+                Some(it.0)\n+            }\n+        }),\n         kind: Some(String::new()),\n         edit: Some(snippet_workspace_edit(world, assist.source_change)?),\n         command: None,"}, {"sha": "a25091f797c39c2fac64c0a64374a812ad7fea31", "filename": "editors/code/src/client.ts", "status": "modified", "additions": 40, "deletions": 36, "changes": 76, "blob_url": "https://github.com/rust-lang/rust/blob/57cd936c5262c3b43626618be42d7a72f71c3539/editors%2Fcode%2Fsrc%2Fclient.ts", "raw_url": "https://github.com/rust-lang/rust/raw/57cd936c5262c3b43626618be42d7a72f71c3539/editors%2Fcode%2Fsrc%2Fclient.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fclient.ts?ref=57cd936c5262c3b43626618be42d7a72f71c3539", "patch": "@@ -1,8 +1,11 @@\n import * as lc from 'vscode-languageclient';\n import * as vscode from 'vscode';\n+import * as ra from '../src/lsp_ext';\n+import * as Is from 'vscode-languageclient/lib/utils/is';\n \n import { CallHierarchyFeature } from 'vscode-languageclient/lib/callHierarchy.proposed';\n import { SemanticTokensFeature, DocumentSemanticsTokensSignature } from 'vscode-languageclient/lib/semanticTokens.proposed';\n+import { assert } from './util';\n \n export function createClient(serverPath: string, cwd: string): lc.LanguageClient {\n     // '.' Is the fallback if no folder is open\n@@ -32,6 +35,8 @@ export function createClient(serverPath: string, cwd: string): lc.LanguageClient\n                 if (res === undefined) throw new Error('busy');\n                 return res;\n             },\n+            // Using custom handling of CodeActions where each code action is resloved lazily\n+            // That's why we are not waiting for any command or edits\n             async provideCodeActions(document: vscode.TextDocument, range: vscode.Range, context: vscode.CodeActionContext, token: vscode.CancellationToken, _next: lc.ProvideCodeActionsSignature) {\n                 const params: lc.CodeActionParams = {\n                     textDocument: client.code2ProtocolConverter.asTextDocumentIdentifier(document),\n@@ -43,32 +48,38 @@ export function createClient(serverPath: string, cwd: string): lc.LanguageClient\n                     const result: (vscode.CodeAction | vscode.Command)[] = [];\n                     const groups = new Map<string, { index: number; items: vscode.CodeAction[] }>();\n                     for (const item of values) {\n+                        // In our case we expect to get code edits only from diagnostics\n                         if (lc.CodeAction.is(item)) {\n+                            assert(!item.command, \"We don't expect to receive commands in CodeActions\");\n                             const action = client.protocol2CodeConverter.asCodeAction(item);\n-                            const group = actionGroup(item);\n-                            if (isSnippetEdit(item) || group) {\n-                                action.command = {\n-                                    command: \"rust-analyzer.applySnippetWorkspaceEdit\",\n-                                    title: \"\",\n-                                    arguments: [action.edit],\n-                                };\n-                                action.edit = undefined;\n-                            }\n-\n-                            if (group) {\n-                                let entry = groups.get(group);\n-                                if (!entry) {\n-                                    entry = { index: result.length, items: [] };\n-                                    groups.set(group, entry);\n-                                    result.push(action);\n-                                }\n-                                entry.items.push(action);\n-                            } else {\n+                            result.push(action);\n+                            continue;\n+                        }\n+                        assert(isCodeActionWithoutEditsAndCommands(item), \"We don't expect edits or commands here\");\n+                        const action = new vscode.CodeAction(item.title);\n+                        const group = (item as any).group;\n+                        const id = (item as any).id;\n+                        const resolveParams: ra.ResolveCodeActionParams = {\n+                            id: id,\n+                            // TODO: delete after discussions if needed\n+                            label: item.title,\n+                            codeActionParams: params\n+                        };\n+                        action.command = {\n+                            command: \"rust-analyzer.resolveCodeAction\",\n+                            title: item.title,\n+                            arguments: [resolveParams],\n+                        };\n+                        if (group) {\n+                            let entry = groups.get(group);\n+                            if (!entry) {\n+                                entry = { index: result.length, items: [] };\n+                                groups.set(group, entry);\n                                 result.push(action);\n                             }\n+                            entry.items.push(action);\n                         } else {\n-                            const command = client.protocol2CodeConverter.asCommand(item);\n-                            result.push(command);\n+                            result.push(action);\n                         }\n                     }\n                     for (const [group, { index, items }] of groups) {\n@@ -80,7 +91,7 @@ export function createClient(serverPath: string, cwd: string): lc.LanguageClient\n                                 command: \"rust-analyzer.applyActionGroup\",\n                                 title: \"\",\n                                 arguments: [items.map((item) => {\n-                                    return { label: item.title, edit: item.command!!.arguments!![0] };\n+                                    return { label: item.title, arguments: item.command!!.arguments!![0] };\n                                 })],\n                             };\n                             result[index] = action;\n@@ -119,24 +130,17 @@ class ExperimentalFeatures implements lc.StaticFeature {\n         const caps: any = capabilities.experimental ?? {};\n         caps.snippetTextEdit = true;\n         caps.codeActionGroup = true;\n+        caps.resolveCodeAction = true;\n         capabilities.experimental = caps;\n     }\n     initialize(_capabilities: lc.ServerCapabilities<any>, _documentSelector: lc.DocumentSelector | undefined): void {\n     }\n }\n \n-function isSnippetEdit(action: lc.CodeAction): boolean {\n-    const documentChanges = action.edit?.documentChanges ?? [];\n-    for (const edit of documentChanges) {\n-        if (lc.TextDocumentEdit.is(edit)) {\n-            if (edit.edits.some((indel) => (indel as any).insertTextFormat === lc.InsertTextFormat.Snippet)) {\n-                return true;\n-            }\n-        }\n-    }\n-    return false;\n-}\n-\n-function actionGroup(action: lc.CodeAction): string | undefined {\n-    return (action as any).group;\n+function isCodeActionWithoutEditsAndCommands(value: any): boolean {\n+    const candidate: lc.CodeAction = value;\n+    return candidate && Is.string(candidate.title) &&\n+        (candidate.diagnostics === void 0 || Is.typedArray(candidate.diagnostics, lc.Diagnostic.is)) &&\n+        (candidate.kind === void 0 || Is.string(candidate.kind)) &&\n+        (candidate.edit === void 0 && candidate.command === void 0);\n }"}, {"sha": "3e9c3aa0e59be26f82658bd984c7f54d2f6be1a6", "filename": "editors/code/src/commands.ts", "status": "modified", "additions": 17, "deletions": 2, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/57cd936c5262c3b43626618be42d7a72f71c3539/editors%2Fcode%2Fsrc%2Fcommands.ts", "raw_url": "https://github.com/rust-lang/rust/raw/57cd936c5262c3b43626618be42d7a72f71c3539/editors%2Fcode%2Fsrc%2Fcommands.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fcommands.ts?ref=57cd936c5262c3b43626618be42d7a72f71c3539", "patch": "@@ -343,10 +343,25 @@ export function showReferences(ctx: Ctx): Cmd {\n }\n \n export function applyActionGroup(_ctx: Ctx): Cmd {\n-    return async (actions: { label: string; edit: vscode.WorkspaceEdit }[]) => {\n+    return async (actions: { label: string; arguments: ra.ResolveCodeActionParams }[]) => {\n         const selectedAction = await vscode.window.showQuickPick(actions);\n         if (!selectedAction) return;\n-        await applySnippetWorkspaceEdit(selectedAction.edit);\n+        vscode.commands.executeCommand(\n+            'rust-analyzer.resolveCodeAction',\n+            selectedAction.arguments,\n+        );\n+    };\n+}\n+\n+export function resolveCodeAction(ctx: Ctx): Cmd {\n+    const client = ctx.client;\n+    return async (params: ra.ResolveCodeActionParams) => {\n+        const item: lc.WorkspaceEdit = await client.sendRequest(ra.resolveCodeAction, params);\n+        if (!item) {\n+            return;\n+        }\n+        const edit = client.protocol2CodeConverter.asWorkspaceEdit(item);\n+        await applySnippetWorkspaceEdit(edit);\n     };\n }\n "}, {"sha": "f881bae4721ac1ffc3ea311c4eb3683e83436af4", "filename": "editors/code/src/lsp_ext.ts", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/57cd936c5262c3b43626618be42d7a72f71c3539/editors%2Fcode%2Fsrc%2Flsp_ext.ts", "raw_url": "https://github.com/rust-lang/rust/raw/57cd936c5262c3b43626618be42d7a72f71c3539/editors%2Fcode%2Fsrc%2Flsp_ext.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Flsp_ext.ts?ref=57cd936c5262c3b43626618be42d7a72f71c3539", "patch": "@@ -33,6 +33,13 @@ export const matchingBrace = new lc.RequestType<MatchingBraceParams, lc.Position\n \n export const parentModule = new lc.RequestType<lc.TextDocumentPositionParams, lc.LocationLink[], void>(\"experimental/parentModule\");\n \n+export interface ResolveCodeActionParams {\n+    id: string;\n+    label: string;\n+    codeActionParams: lc.CodeActionParams;\n+}\n+export const resolveCodeAction = new lc.RequestType<ResolveCodeActionParams, lc.WorkspaceEdit, unknown>('experimental/resolveCodeAction');\n+\n export interface JoinLinesParams {\n     textDocument: lc.TextDocumentIdentifier;\n     ranges: lc.Range[];"}, {"sha": "a92c676fa2dd7ddda1b9f5047c9ad9e58707349b", "filename": "editors/code/src/main.ts", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/57cd936c5262c3b43626618be42d7a72f71c3539/editors%2Fcode%2Fsrc%2Fmain.ts", "raw_url": "https://github.com/rust-lang/rust/raw/57cd936c5262c3b43626618be42d7a72f71c3539/editors%2Fcode%2Fsrc%2Fmain.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fmain.ts?ref=57cd936c5262c3b43626618be42d7a72f71c3539", "patch": "@@ -98,6 +98,7 @@ export async function activate(context: vscode.ExtensionContext) {\n     ctx.registerCommand('debugSingle', commands.debugSingle);\n     ctx.registerCommand('showReferences', commands.showReferences);\n     ctx.registerCommand('applySnippetWorkspaceEdit', commands.applySnippetWorkspaceEditCommand);\n+    ctx.registerCommand('resolveCodeAction', commands.resolveCodeAction);\n     ctx.registerCommand('applyActionGroup', commands.applyActionGroup);\n \n     ctx.pushCleanup(activateTaskProvider(workspaceFolder));"}]}