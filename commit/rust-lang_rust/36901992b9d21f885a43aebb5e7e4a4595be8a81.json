{"sha": "36901992b9d21f885a43aebb5e7e4a4595be8a81", "node_id": "C_kwDOAAsO6NoAKDM2OTAxOTkyYjlkMjFmODg1YTQzYWViYjVlN2U0YTQ1OTViZThhODE", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-10-06T21:55:56Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-10-06T21:55:56Z"}, "message": "Auto merge of #9601 - evantypanski:et/issue9575, r=Manishearth\n\n[`match_single_binding`] Add curlies for more cases to fix suggestion causes error\n\nFixes #9575\n\nchangelog: [`match_single_binding`]: Add curlies for scrutinees with side effects for more cases", "tree": {"sha": "4b7cc4091f537d39846111c52b676d61a2464e8a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4b7cc4091f537d39846111c52b676d61a2464e8a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/36901992b9d21f885a43aebb5e7e4a4595be8a81", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/36901992b9d21f885a43aebb5e7e4a4595be8a81", "html_url": "https://github.com/rust-lang/rust/commit/36901992b9d21f885a43aebb5e7e4a4595be8a81", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/36901992b9d21f885a43aebb5e7e4a4595be8a81/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8f1ebdd18bdecc621f16baaf779898cc08cc2766", "url": "https://api.github.com/repos/rust-lang/rust/commits/8f1ebdd18bdecc621f16baaf779898cc08cc2766", "html_url": "https://github.com/rust-lang/rust/commit/8f1ebdd18bdecc621f16baaf779898cc08cc2766"}, {"sha": "39164acf6e62a3ff55d6c210acc1095d9ccc95bb", "url": "https://api.github.com/repos/rust-lang/rust/commits/39164acf6e62a3ff55d6c210acc1095d9ccc95bb", "html_url": "https://github.com/rust-lang/rust/commit/39164acf6e62a3ff55d6c210acc1095d9ccc95bb"}], "stats": {"total": 67, "additions": 57, "deletions": 10}, "files": [{"sha": "1bf8d4e96ad49a8056a9208686c5cfd5f9acc3b1", "filename": "clippy_lints/src/matches/match_single_binding.rs", "status": "modified", "additions": 22, "deletions": 9, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/36901992b9d21f885a43aebb5e7e4a4595be8a81/clippy_lints%2Fsrc%2Fmatches%2Fmatch_single_binding.rs", "raw_url": "https://github.com/rust-lang/rust/raw/36901992b9d21f885a43aebb5e7e4a4595be8a81/clippy_lints%2Fsrc%2Fmatches%2Fmatch_single_binding.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmatches%2Fmatch_single_binding.rs?ref=36901992b9d21f885a43aebb5e7e4a4595be8a81", "patch": "@@ -58,6 +58,7 @@ pub(crate) fn check<'a>(cx: &LateContext<'a>, ex: &Expr<'a>, arms: &[Arm<'_>], e\n                         &snippet_body,\n                         &mut applicability,\n                         Some(span),\n+                        true,\n                     );\n \n                     span_lint_and_sugg(\n@@ -90,6 +91,7 @@ pub(crate) fn check<'a>(cx: &LateContext<'a>, ex: &Expr<'a>, arms: &[Arm<'_>], e\n                         &snippet_body,\n                         &mut applicability,\n                         None,\n+                        true,\n                     );\n                     (expr.span, sugg)\n                 },\n@@ -107,10 +109,14 @@ pub(crate) fn check<'a>(cx: &LateContext<'a>, ex: &Expr<'a>, arms: &[Arm<'_>], e\n         },\n         PatKind::Wild => {\n             if ex.can_have_side_effects() {\n-                let indent = \" \".repeat(indent_of(cx, expr.span).unwrap_or(0));\n-                let sugg = format!(\n-                    \"{};\\n{indent}{snippet_body}\",\n-                    snippet_with_applicability(cx, ex.span, \"..\", &mut applicability)\n+                let sugg = sugg_with_curlies(\n+                    cx,\n+                    (ex, expr),\n+                    (bind_names, matched_vars),\n+                    &snippet_body,\n+                    &mut applicability,\n+                    None,\n+                    false,\n                 );\n \n                 span_lint_and_sugg(\n@@ -169,6 +175,7 @@ fn sugg_with_curlies<'a>(\n     snippet_body: &str,\n     applicability: &mut Applicability,\n     assignment: Option<Span>,\n+    needs_var_binding: bool,\n ) -> String {\n     let mut indent = \" \".repeat(indent_of(cx, ex.span).unwrap_or(0));\n \n@@ -200,9 +207,15 @@ fn sugg_with_curlies<'a>(\n         s\n     });\n \n-    format!(\n-        \"{cbrace_start}let {} = {};\\n{indent}{assignment_str}{snippet_body}{cbrace_end}\",\n-        snippet_with_applicability(cx, bind_names, \"..\", applicability),\n-        snippet_with_applicability(cx, matched_vars, \"..\", applicability)\n-    )\n+    let scrutinee = if needs_var_binding {\n+        format!(\n+            \"let {} = {}\",\n+            snippet_with_applicability(cx, bind_names, \"..\", applicability),\n+            snippet_with_applicability(cx, matched_vars, \"..\", applicability)\n+        )\n+    } else {\n+        snippet_with_applicability(cx, matched_vars, \"..\", applicability).to_string()\n+    };\n+\n+    format!(\"{cbrace_start}{scrutinee};\\n{indent}{assignment_str}{snippet_body}{cbrace_end}\")\n }"}, {"sha": "a6e315e4773a27907382516d8e37efe5d3d8476b", "filename": "tests/ui/match_single_binding.fixed", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/36901992b9d21f885a43aebb5e7e4a4595be8a81/tests%2Fui%2Fmatch_single_binding.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/36901992b9d21f885a43aebb5e7e4a4595be8a81/tests%2Fui%2Fmatch_single_binding.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmatch_single_binding.fixed?ref=36901992b9d21f885a43aebb5e7e4a4595be8a81", "patch": "@@ -124,3 +124,12 @@ fn issue_8723() {\n \n     let _ = val;\n }\n+\n+#[allow(dead_code)]\n+fn issue_9575() {\n+    fn side_effects() {}\n+    let _ = || {\n+        side_effects();\n+        println!(\"Needs curlies\");\n+    };\n+}"}, {"sha": "cecbd703e56698cd9292ea24de374cffa03b3e47", "filename": "tests/ui/match_single_binding.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/36901992b9d21f885a43aebb5e7e4a4595be8a81/tests%2Fui%2Fmatch_single_binding.rs", "raw_url": "https://github.com/rust-lang/rust/raw/36901992b9d21f885a43aebb5e7e4a4595be8a81/tests%2Fui%2Fmatch_single_binding.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmatch_single_binding.rs?ref=36901992b9d21f885a43aebb5e7e4a4595be8a81", "patch": "@@ -140,3 +140,11 @@ fn issue_8723() {\n \n     let _ = val;\n }\n+\n+#[allow(dead_code)]\n+fn issue_9575() {\n+    fn side_effects() {}\n+    let _ = || match side_effects() {\n+        _ => println!(\"Needs curlies\"),\n+    };\n+}"}, {"sha": "2b9ec7ee7026e4a31f6fdfa7c4f06d06825acde3", "filename": "tests/ui/match_single_binding.stderr", "status": "modified", "additions": 18, "deletions": 1, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/36901992b9d21f885a43aebb5e7e4a4595be8a81/tests%2Fui%2Fmatch_single_binding.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/36901992b9d21f885a43aebb5e7e4a4595be8a81/tests%2Fui%2Fmatch_single_binding.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmatch_single_binding.stderr?ref=36901992b9d21f885a43aebb5e7e4a4595be8a81", "patch": "@@ -196,5 +196,22 @@ LL +         suf\n LL ~     };\n    |\n \n-error: aborting due to 13 previous errors\n+error: this match could be replaced by its scrutinee and body\n+  --> $DIR/match_single_binding.rs:147:16\n+   |\n+LL |       let _ = || match side_effects() {\n+   |  ________________^\n+LL | |         _ => println!(\"Needs curlies\"),\n+LL | |     };\n+   | |_____^\n+   |\n+help: consider using the scrutinee and body instead\n+   |\n+LL ~     let _ = || {\n+LL +         side_effects();\n+LL +         println!(\"Needs curlies\");\n+LL ~     };\n+   |\n+\n+error: aborting due to 14 previous errors\n "}]}