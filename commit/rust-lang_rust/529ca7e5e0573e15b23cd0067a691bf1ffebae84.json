{"sha": "529ca7e5e0573e15b23cd0067a691bf1ffebae84", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUyOWNhN2U1ZTA1NzNlMTViMjNjZDAwNjdhNjkxYmYxZmZlYmFlODQ=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-08-19T11:27:02Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-08-19T11:27:02Z"}, "message": "Merge #5643\n\n5643: Add new consuming modifier, apply consuming and mutable to methods r=matklad a=Nashenas88\n\nThis adds a new `consuming` semantic modifier for syntax highlighters.\r\n\r\nThis also emits `mutable` and `consuming` in two cases:\r\n\r\n- When a method takes `&mut self`, then it now has `function.mutable` emitted.\r\n- When a method takes `self`, and the type of `Self` is not `Copy`, then `function.consuming` is emitted.\r\n\r\nCC @flodiebold \n\nCo-authored-by: Paul Daniel Faria <Nashenas88@users.noreply.github.com>", "tree": {"sha": "0cc09513805718a7c31cadb1776ff4eb865caaef", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0cc09513805718a7c31cadb1776ff4eb865caaef"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/529ca7e5e0573e15b23cd0067a691bf1ffebae84", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfPQyGCRBK7hj4Ov3rIwAAdHIIAExtQPaQJ5+Ql7LIdL4o6KOc\n6Oij0EGuGtaRby1m6zI2IPztyhp+JQADnYkuVrauXklA5SwpKDLGTYvlMe9F/dBm\n4FQU7iKaNWOtdlc4GX1yNkwmOrPEpSOdsGnlTdoMKZR5qf//WMjYO5v193dXnoyo\nxRHANjebkAAbVvmtS6AA668Ekz6HCNmKbzKcL5NUN0EVTAUDJBChFHxTmgguAwRT\nBhUopw5TufZIGu9IR96jML4n25KJVDBQ2xfwZFZSuutjzTupMfupqM2YSK5fJmBM\ncQ0NnPjL3G26lO6fpXNmlY/S7muAhNgOL8pnZBon1cxkMGTsEG8QlPui9dcDHtU=\n=1r/0\n-----END PGP SIGNATURE-----\n", "payload": "tree 0cc09513805718a7c31cadb1776ff4eb865caaef\nparent c1cfd010096daa85f8acd6f1ea15d92097816e14\nparent 3456e2eec7c1e18734f8fa41924a83b4c676dc00\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1597836422 +0000\ncommitter GitHub <noreply@github.com> 1597836422 +0000\n\nMerge #5643\n\n5643: Add new consuming modifier, apply consuming and mutable to methods r=matklad a=Nashenas88\n\nThis adds a new `consuming` semantic modifier for syntax highlighters.\r\n\r\nThis also emits `mutable` and `consuming` in two cases:\r\n\r\n- When a method takes `&mut self`, then it now has `function.mutable` emitted.\r\n- When a method takes `self`, and the type of `Self` is not `Copy`, then `function.consuming` is emitted.\r\n\r\nCC @flodiebold \n\nCo-authored-by: Paul Daniel Faria <Nashenas88@users.noreply.github.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/529ca7e5e0573e15b23cd0067a691bf1ffebae84", "html_url": "https://github.com/rust-lang/rust/commit/529ca7e5e0573e15b23cd0067a691bf1ffebae84", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/529ca7e5e0573e15b23cd0067a691bf1ffebae84/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c1cfd010096daa85f8acd6f1ea15d92097816e14", "url": "https://api.github.com/repos/rust-lang/rust/commits/c1cfd010096daa85f8acd6f1ea15d92097816e14", "html_url": "https://github.com/rust-lang/rust/commit/c1cfd010096daa85f8acd6f1ea15d92097816e14"}, {"sha": "3456e2eec7c1e18734f8fa41924a83b4c676dc00", "url": "https://api.github.com/repos/rust-lang/rust/commits/3456e2eec7c1e18734f8fa41924a83b4c676dc00", "html_url": "https://github.com/rust-lang/rust/commit/3456e2eec7c1e18734f8fa41924a83b4c676dc00"}], "stats": {"total": 269, "additions": 220, "deletions": 49}, "files": [{"sha": "31d5276b0f596997187d5d3406f3abc9597511b9", "filename": "crates/hir/src/code_model.rs", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/529ca7e5e0573e15b23cd0067a691bf1ffebae84/crates%2Fhir%2Fsrc%2Fcode_model.rs", "raw_url": "https://github.com/rust-lang/rust/raw/529ca7e5e0573e15b23cd0067a691bf1ffebae84/crates%2Fhir%2Fsrc%2Fcode_model.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Fcode_model.rs?ref=529ca7e5e0573e15b23cd0067a691bf1ffebae84", "patch": "@@ -670,6 +670,21 @@ impl Function {\n         db.function_data(self.id).has_self_param\n     }\n \n+    pub fn mutability_of_self_param(self, db: &dyn HirDatabase) -> Option<Mutability> {\n+        let func_data = db.function_data(self.id);\n+        if !func_data.has_self_param {\n+            return None;\n+        }\n+\n+        func_data.params.first().and_then(|param| {\n+            if let TypeRef::Reference(_, mutability) = param {\n+                Some(*mutability)\n+            } else {\n+                None\n+            }\n+        })\n+    }\n+\n     pub fn params(self, db: &dyn HirDatabase) -> Vec<TypeRef> {\n         db.function_data(self.id).params.clone()\n     }"}, {"sha": "fc1c1ccd3d43d526b317e6706d124b1dad8c52a5", "filename": "crates/hir/src/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/529ca7e5e0573e15b23cd0067a691bf1ffebae84/crates%2Fhir%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/529ca7e5e0573e15b23cd0067a691bf1ffebae84/crates%2Fhir%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Flib.rs?ref=529ca7e5e0573e15b23cd0067a691bf1ffebae84", "patch": "@@ -38,7 +38,7 @@ pub use crate::{\n         Static, Struct, Trait, Type, TypeAlias, TypeParam, Union, VariantDef, Visibility,\n     },\n     has_source::HasSource,\n-    semantics::{original_range, PathResolution, Semantics, SemanticsScope},\n+    semantics::{original_range, PathResolution, SelfKind, Semantics, SemanticsScope},\n };\n \n pub use hir_def::{"}, {"sha": "aff0e73da7ebcc64b792a4fd1086e331e670d259", "filename": "crates/hir/src/semantics.rs", "status": "modified", "additions": 46, "deletions": 4, "changes": 50, "blob_url": "https://github.com/rust-lang/rust/blob/529ca7e5e0573e15b23cd0067a691bf1ffebae84/crates%2Fhir%2Fsrc%2Fsemantics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/529ca7e5e0573e15b23cd0067a691bf1ffebae84/crates%2Fhir%2Fsrc%2Fsemantics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Fsemantics.rs?ref=529ca7e5e0573e15b23cd0067a691bf1ffebae84", "patch": "@@ -6,16 +6,18 @@ use std::{cell::RefCell, fmt, iter::successors};\n \n use base_db::{FileId, FileRange};\n use hir_def::{\n+    lang_item::LangItemTarget,\n     resolver::{self, HasResolver, Resolver, TypeNs},\n-    AsMacroCall, FunctionId, TraitId, VariantId,\n+    src::HasSource,\n+    AsMacroCall, FunctionId, Lookup, TraitId, VariantId,\n };\n use hir_expand::{hygiene::Hygiene, name::AsName, ExpansionInfo};\n use hir_ty::associated_type_shorthand_candidates;\n use itertools::Itertools;\n use rustc_hash::{FxHashMap, FxHashSet};\n use syntax::{\n     algo::{find_node_at_offset, skip_trivia_token},\n-    ast, AstNode, Direction, SyntaxNode, SyntaxToken, TextRange, TextSize,\n+    ast, AstNode, Direction, SmolStr, SyntaxNode, SyntaxToken, TextRange, TextSize,\n };\n \n use crate::{\n@@ -79,6 +81,13 @@ impl PathResolution {\n     }\n }\n \n+pub enum SelfKind {\n+    Shared,\n+    Mutable,\n+    Consuming,\n+    Copied,\n+}\n+\n /// Primary API to get semantic information, like types, from syntax trees.\n pub struct Semantics<'db, DB> {\n     pub db: &'db DB,\n@@ -188,6 +197,10 @@ impl<'db, DB: HirDatabase> Semantics<'db, DB> {\n         self.imp.type_of_self(param)\n     }\n \n+    pub fn method_reciever_kind(&self, call: &ast::MethodCallExpr) -> Option<SelfKind> {\n+        self.imp.method_receiver_kind(call)\n+    }\n+\n     pub fn resolve_method_call(&self, call: &ast::MethodCallExpr) -> Option<Function> {\n         self.imp.resolve_method_call(call).map(Function::from)\n     }\n@@ -267,7 +280,7 @@ impl<'db, DB: HirDatabase> Semantics<'db, DB> {\n         self.imp.assert_contains_node(node)\n     }\n \n-    pub fn is_unsafe_method_call(&self, method_call_expr: ast::MethodCallExpr) -> bool {\n+    pub fn is_unsafe_method_call(&self, method_call_expr: &ast::MethodCallExpr) -> bool {\n         self.imp.is_unsafe_method_call(method_call_expr)\n     }\n \n@@ -410,6 +423,35 @@ impl<'db> SemanticsImpl<'db> {\n         self.analyze(param.syntax()).type_of_self(self.db, &param)\n     }\n \n+    fn method_receiver_kind(&self, call: &ast::MethodCallExpr) -> Option<SelfKind> {\n+        self.resolve_method_call(call).and_then(|func| {\n+            let lookup = func.lookup(self.db.upcast());\n+            let src = lookup.source(self.db.upcast());\n+            let param_list = src.value.param_list()?;\n+            let self_param = param_list.self_param()?;\n+            if self_param.amp_token().is_some() {\n+                return Some(if self_param.mut_token().is_some() {\n+                    SelfKind::Mutable\n+                } else {\n+                    SelfKind::Shared\n+                });\n+            }\n+\n+            let ty = self.type_of_expr(&call.expr()?)?;\n+            let krate = Function::from(func).krate(self.db)?;\n+            let lang_item = self.db.lang_item(krate.id, SmolStr::new(\"copy\"));\n+            let copy_trait = match lang_item? {\n+                LangItemTarget::TraitId(copy_trait) => Trait::from(copy_trait),\n+                _ => return None,\n+            };\n+            Some(if ty.impls_trait(self.db, copy_trait, &[]) {\n+                SelfKind::Copied\n+            } else {\n+                SelfKind::Consuming\n+            })\n+        })\n+    }\n+\n     fn resolve_method_call(&self, call: &ast::MethodCallExpr) -> Option<FunctionId> {\n         self.analyze(call.syntax()).resolve_method_call(self.db, call)\n     }\n@@ -571,7 +613,7 @@ impl<'db> SemanticsImpl<'db> {\n         InFile::new(file_id, node)\n     }\n \n-    pub fn is_unsafe_method_call(&self, method_call_expr: ast::MethodCallExpr) -> bool {\n+    pub fn is_unsafe_method_call(&self, method_call_expr: &ast::MethodCallExpr) -> bool {\n         method_call_expr\n             .expr()\n             .and_then(|expr| {"}, {"sha": "9827c68afbd0bff3d93fc0ba038b5c146ce4e758", "filename": "crates/ide/src/syntax_highlighting.rs", "status": "modified", "additions": 74, "deletions": 43, "changes": 117, "blob_url": "https://github.com/rust-lang/rust/blob/529ca7e5e0573e15b23cd0067a691bf1ffebae84/crates%2Fide%2Fsrc%2Fsyntax_highlighting.rs", "raw_url": "https://github.com/rust-lang/rust/raw/529ca7e5e0573e15b23cd0067a691bf1ffebae84/crates%2Fide%2Fsrc%2Fsyntax_highlighting.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fsyntax_highlighting.rs?ref=529ca7e5e0573e15b23cd0067a691bf1ffebae84", "patch": "@@ -4,7 +4,7 @@ mod injection;\n #[cfg(test)]\n mod tests;\n \n-use hir::{Name, Semantics, VariantDef};\n+use hir::{Mutability, Name, SelfKind, Semantics, VariantDef};\n use ide_db::{\n     defs::{classify_name, classify_name_ref, Definition, NameClass, NameRefClass},\n     RootDatabase,\n@@ -519,27 +519,29 @@ fn highlight_element(\n         }\n         NAME_REF => {\n             let name_ref = element.into_node().and_then(ast::NameRef::cast).unwrap();\n-            let possibly_unsafe = is_possibly_unsafe(&name_ref);\n-            match classify_name_ref(sema, &name_ref) {\n-                Some(name_kind) => match name_kind {\n-                    NameRefClass::ExternCrate(_) => HighlightTag::Module.into(),\n-                    NameRefClass::Definition(def) => {\n-                        if let Definition::Local(local) = &def {\n-                            if let Some(name) = local.name(db) {\n-                                let shadow_count =\n-                                    bindings_shadow_count.entry(name.clone()).or_default();\n-                                binding_hash = Some(calc_binding_hash(&name, *shadow_count))\n-                            }\n-                        };\n-                        highlight_name(sema, db, def, Some(name_ref), possibly_unsafe)\n+            highlight_func_by_name_ref(sema, &name_ref).unwrap_or_else(|| {\n+                let possibly_unsafe = is_possibly_unsafe(&name_ref);\n+                match classify_name_ref(sema, &name_ref) {\n+                    Some(name_kind) => match name_kind {\n+                        NameRefClass::ExternCrate(_) => HighlightTag::Module.into(),\n+                        NameRefClass::Definition(def) => {\n+                            if let Definition::Local(local) = &def {\n+                                if let Some(name) = local.name(db) {\n+                                    let shadow_count =\n+                                        bindings_shadow_count.entry(name.clone()).or_default();\n+                                    binding_hash = Some(calc_binding_hash(&name, *shadow_count))\n+                                }\n+                            };\n+                            highlight_name(sema, db, def, Some(name_ref), possibly_unsafe)\n+                        }\n+                        NameRefClass::FieldShorthand { .. } => HighlightTag::Field.into(),\n+                    },\n+                    None if syntactic_name_ref_highlighting => {\n+                        highlight_name_ref_by_syntax(name_ref, sema)\n                     }\n-                    NameRefClass::FieldShorthand { .. } => HighlightTag::Field.into(),\n-                },\n-                None if syntactic_name_ref_highlighting => {\n-                    highlight_name_ref_by_syntax(name_ref, sema)\n+                    None => HighlightTag::UnresolvedReference.into(),\n                 }\n-                None => HighlightTag::UnresolvedReference.into(),\n-            }\n+            })\n         }\n \n         // Simple token-based highlighting\n@@ -700,6 +702,35 @@ fn is_child_of_impl(element: &SyntaxElement) -> bool {\n     }\n }\n \n+fn highlight_func_by_name_ref(\n+    sema: &Semantics<RootDatabase>,\n+    name_ref: &ast::NameRef,\n+) -> Option<Highlight> {\n+    let parent = name_ref.syntax().parent()?;\n+    let method_call = ast::MethodCallExpr::cast(parent)?;\n+    highlight_method_call(sema, &method_call)\n+}\n+\n+fn highlight_method_call(\n+    sema: &Semantics<RootDatabase>,\n+    method_call: &ast::MethodCallExpr,\n+) -> Option<Highlight> {\n+    let func = sema.resolve_method_call(&method_call)?;\n+    let mut h = HighlightTag::Function.into();\n+    if func.is_unsafe(sema.db) || sema.is_unsafe_method_call(&method_call) {\n+        h |= HighlightModifier::Unsafe;\n+    }\n+\n+    sema.method_reciever_kind(&method_call)\n+        .map(|self_kind| match self_kind {\n+            SelfKind::Shared => h,\n+            SelfKind::Mutable => h | HighlightModifier::Mutable,\n+            SelfKind::Consuming => h | HighlightModifier::Consuming,\n+            SelfKind::Copied => h,\n+        })\n+        .or_else(|| Some(h))\n+}\n+\n fn highlight_name(\n     sema: &Semantics<RootDatabase>,\n     db: &RootDatabase,\n@@ -722,20 +753,26 @@ fn highlight_name(\n         Definition::ModuleDef(def) => match def {\n             hir::ModuleDef::Module(_) => HighlightTag::Module,\n             hir::ModuleDef::Function(func) => {\n-                let mut h = HighlightTag::Function.into();\n-                if func.is_unsafe(db) {\n-                    h |= HighlightModifier::Unsafe;\n-                } else {\n-                    let is_unsafe = name_ref\n-                        .and_then(|name_ref| name_ref.syntax().parent())\n-                        .and_then(ast::MethodCallExpr::cast)\n-                        .map(|method_call_expr| sema.is_unsafe_method_call(method_call_expr))\n-                        .unwrap_or(false);\n-                    if is_unsafe {\n-                        h |= HighlightModifier::Unsafe;\n-                    }\n-                }\n-                return h;\n+                return name_ref\n+                    .and_then(|name_ref| highlight_func_by_name_ref(sema, &name_ref))\n+                    .unwrap_or_else(|| {\n+                        let mut h = HighlightTag::Function.into();\n+                        if func.is_unsafe(db) {\n+                            h |= HighlightModifier::Unsafe;\n+                        }\n+\n+                        return if func.has_self_param(db) {\n+                            match func.mutability_of_self_param(db) {\n+                                Some(mutability) => match mutability {\n+                                    Mutability::Mut => h | HighlightModifier::Mutable,\n+                                    Mutability::Shared => h,\n+                                },\n+                                None => h,\n+                            }\n+                        } else {\n+                            h\n+                        };\n+                    });\n             }\n             hir::ModuleDef::Adt(hir::Adt::Struct(_)) => HighlightTag::Struct,\n             hir::ModuleDef::Adt(hir::Adt::Enum(_)) => HighlightTag::Enum,\n@@ -807,15 +844,9 @@ fn highlight_name_ref_by_syntax(name: ast::NameRef, sema: &Semantics<RootDatabas\n \n     match parent.kind() {\n         METHOD_CALL_EXPR => {\n-            let mut h = Highlight::new(HighlightTag::Function);\n-            let is_unsafe = ast::MethodCallExpr::cast(parent)\n-                .map(|method_call_expr| sema.is_unsafe_method_call(method_call_expr))\n-                .unwrap_or(false);\n-            if is_unsafe {\n-                h |= HighlightModifier::Unsafe;\n-            }\n-\n-            h\n+            return ast::MethodCallExpr::cast(parent)\n+                .and_then(|method_call| highlight_method_call(sema, &method_call))\n+                .unwrap_or_else(|| HighlightTag::Function.into());\n         }\n         FIELD_EXPR => {\n             let h = HighlightTag::Field;"}, {"sha": "c1b817f06cca77712e4fee98d006f86216aa9c1d", "filename": "crates/ide/src/syntax_highlighting/tags.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/529ca7e5e0573e15b23cd0067a691bf1ffebae84/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Ftags.rs", "raw_url": "https://github.com/rust-lang/rust/raw/529ca7e5e0573e15b23cd0067a691bf1ffebae84/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Ftags.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Ftags.rs?ref=529ca7e5e0573e15b23cd0067a691bf1ffebae84", "patch": "@@ -62,6 +62,7 @@ pub enum HighlightModifier {\n     Documentation,\n     Injected,\n     Mutable,\n+    Consuming,\n     Unsafe,\n }\n \n@@ -119,6 +120,7 @@ impl HighlightModifier {\n         HighlightModifier::Documentation,\n         HighlightModifier::Injected,\n         HighlightModifier::Mutable,\n+        HighlightModifier::Consuming,\n         HighlightModifier::Unsafe,\n     ];\n \n@@ -130,6 +132,7 @@ impl HighlightModifier {\n             HighlightModifier::Documentation => \"documentation\",\n             HighlightModifier::Injected => \"injected\",\n             HighlightModifier::Mutable => \"mutable\",\n+            HighlightModifier::Consuming => \"consuming\",\n             HighlightModifier::Unsafe => \"unsafe\",\n         }\n     }"}, {"sha": "ccb76f5529377cfbce0513c6ed7f122a0870149d", "filename": "crates/ide/src/syntax_highlighting/tests.rs", "status": "modified", "additions": 39, "deletions": 0, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/529ca7e5e0573e15b23cd0067a691bf1ffebae84/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/529ca7e5e0573e15b23cd0067a691bf1ffebae84/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Ftests.rs?ref=529ca7e5e0573e15b23cd0067a691bf1ffebae84", "patch": "@@ -12,6 +12,12 @@ fn test_highlighting() {\n use inner::{self as inner_mod};\n mod inner {}\n \n+// Needed for function consuming vs normal\n+pub mod marker {\n+    #[lang = \"copy\"]\n+    pub trait Copy {}\n+}\n+\n #[derive(Clone, Debug)]\n struct Foo {\n     pub x: i32,\n@@ -36,6 +42,29 @@ impl Foo {\n     fn qux(&mut self) {\n         self.x = 0;\n     }\n+\n+    fn quop(&self) -> i32 {\n+        self.x\n+    }\n+}\n+\n+#[derive(Copy, Clone)]\n+struct FooCopy {\n+    x: u32,\n+}\n+\n+impl FooCopy {\n+    fn baz(self) -> u32 {\n+        self.x\n+    }\n+\n+    fn qux(&mut self) {\n+        self.x = 0;\n+    }\n+\n+    fn quop(&self) -> u32 {\n+        self.x\n+    }\n }\n \n static mut STATIC_MUT: i32 = 0;\n@@ -87,6 +116,16 @@ fn main() {\n     let Foo { x: z, y } = Foo { x: z, y };\n \n     y;\n+\n+    let mut foo = Foo { x, y: x };\n+    foo.quop();\n+    foo.qux();\n+    foo.baz();\n+\n+    let mut copy = FooCopy { x };\n+    copy.quop();\n+    copy.qux();\n+    copy.baz();\n }\n \n enum Option<T> {"}, {"sha": "a6b79589bf72b443930e7861a9fd3d4a0f19a916", "filename": "crates/ide/test_data/highlighting.html", "status": "modified", "additions": 40, "deletions": 1, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/529ca7e5e0573e15b23cd0067a691bf1ffebae84/crates%2Fide%2Ftest_data%2Fhighlighting.html", "raw_url": "https://github.com/rust-lang/rust/raw/529ca7e5e0573e15b23cd0067a691bf1ffebae84/crates%2Fide%2Ftest_data%2Fhighlighting.html", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Ftest_data%2Fhighlighting.html?ref=529ca7e5e0573e15b23cd0067a691bf1ffebae84", "patch": "@@ -38,6 +38,12 @@\n <pre><code><span class=\"keyword\">use</span> <span class=\"module\">inner</span><span class=\"operator\">::</span><span class=\"punctuation\">{</span><span class=\"self_keyword\">self</span> <span class=\"keyword\">as</span> <span class=\"module declaration\">inner_mod</span><span class=\"punctuation\">}</span><span class=\"punctuation\">;</span>\n <span class=\"keyword\">mod</span> <span class=\"module declaration\">inner</span> <span class=\"punctuation\">{</span><span class=\"punctuation\">}</span>\n \n+<span class=\"comment\">// Needed for function consuming vs normal</span>\n+<span class=\"keyword\">pub</span> <span class=\"keyword\">mod</span> <span class=\"module declaration\">marker</span> <span class=\"punctuation\">{</span>\n+    <span class=\"attribute\">#</span><span class=\"attribute\">[</span><span class=\"function attribute\">lang</span><span class=\"attribute\"> </span><span class=\"operator\">=</span><span class=\"attribute\"> </span><span class=\"string_literal\">\"copy\"</span><span class=\"attribute\">]</span>\n+    <span class=\"keyword\">pub</span> <span class=\"keyword\">trait</span> <span class=\"trait declaration\">Copy</span> <span class=\"punctuation\">{</span><span class=\"punctuation\">}</span>\n+<span class=\"punctuation\">}</span>\n+\n <span class=\"attribute\">#</span><span class=\"attribute\">[</span><span class=\"function attribute\">derive</span><span class=\"punctuation\">(</span><span class=\"attribute\">Clone</span><span class=\"punctuation\">,</span><span class=\"attribute\"> Debug</span><span class=\"punctuation\">)</span><span class=\"attribute\">]</span>\n <span class=\"keyword\">struct</span> <span class=\"struct declaration\">Foo</span> <span class=\"punctuation\">{</span>\n     <span class=\"keyword\">pub</span> <span class=\"field declaration\">x</span><span class=\"punctuation\">:</span> <span class=\"builtin_type\">i32</span><span class=\"punctuation\">,</span>\n@@ -59,9 +65,32 @@\n         <span class=\"self_keyword\">self</span><span class=\"punctuation\">.</span><span class=\"field\">x</span>\n     <span class=\"punctuation\">}</span>\n \n-    <span class=\"keyword\">fn</span> <span class=\"function declaration\">qux</span><span class=\"punctuation\">(</span><span class=\"operator\">&</span><span class=\"keyword\">mut</span> <span class=\"self_keyword mutable\">self</span><span class=\"punctuation\">)</span> <span class=\"punctuation\">{</span>\n+    <span class=\"keyword\">fn</span> <span class=\"function declaration mutable\">qux</span><span class=\"punctuation\">(</span><span class=\"operator\">&</span><span class=\"keyword\">mut</span> <span class=\"self_keyword mutable\">self</span><span class=\"punctuation\">)</span> <span class=\"punctuation\">{</span>\n         <span class=\"self_keyword mutable\">self</span><span class=\"punctuation\">.</span><span class=\"field\">x</span> <span class=\"operator\">=</span> <span class=\"numeric_literal\">0</span><span class=\"punctuation\">;</span>\n     <span class=\"punctuation\">}</span>\n+\n+    <span class=\"keyword\">fn</span> <span class=\"function declaration\">quop</span><span class=\"punctuation\">(</span><span class=\"operator\">&</span><span class=\"self_keyword\">self</span><span class=\"punctuation\">)</span> <span class=\"operator\">-&gt;</span> <span class=\"builtin_type\">i32</span> <span class=\"punctuation\">{</span>\n+        <span class=\"self_keyword\">self</span><span class=\"punctuation\">.</span><span class=\"field\">x</span>\n+    <span class=\"punctuation\">}</span>\n+<span class=\"punctuation\">}</span>\n+\n+<span class=\"attribute\">#</span><span class=\"attribute\">[</span><span class=\"function attribute\">derive</span><span class=\"punctuation\">(</span><span class=\"attribute\">Copy</span><span class=\"punctuation\">,</span><span class=\"attribute\"> Clone</span><span class=\"punctuation\">)</span><span class=\"attribute\">]</span>\n+<span class=\"keyword\">struct</span> <span class=\"struct declaration\">FooCopy</span> <span class=\"punctuation\">{</span>\n+    <span class=\"field declaration\">x</span><span class=\"punctuation\">:</span> <span class=\"builtin_type\">u32</span><span class=\"punctuation\">,</span>\n+<span class=\"punctuation\">}</span>\n+\n+<span class=\"keyword\">impl</span> <span class=\"struct\">FooCopy</span> <span class=\"punctuation\">{</span>\n+    <span class=\"keyword\">fn</span> <span class=\"function declaration\">baz</span><span class=\"punctuation\">(</span><span class=\"self_keyword\">self</span><span class=\"punctuation\">)</span> <span class=\"operator\">-&gt;</span> <span class=\"builtin_type\">u32</span> <span class=\"punctuation\">{</span>\n+        <span class=\"self_keyword\">self</span><span class=\"punctuation\">.</span><span class=\"field\">x</span>\n+    <span class=\"punctuation\">}</span>\n+\n+    <span class=\"keyword\">fn</span> <span class=\"function declaration mutable\">qux</span><span class=\"punctuation\">(</span><span class=\"operator\">&</span><span class=\"keyword\">mut</span> <span class=\"self_keyword mutable\">self</span><span class=\"punctuation\">)</span> <span class=\"punctuation\">{</span>\n+        <span class=\"self_keyword mutable\">self</span><span class=\"punctuation\">.</span><span class=\"field\">x</span> <span class=\"operator\">=</span> <span class=\"numeric_literal\">0</span><span class=\"punctuation\">;</span>\n+    <span class=\"punctuation\">}</span>\n+\n+    <span class=\"keyword\">fn</span> <span class=\"function declaration\">quop</span><span class=\"punctuation\">(</span><span class=\"operator\">&</span><span class=\"self_keyword\">self</span><span class=\"punctuation\">)</span> <span class=\"operator\">-&gt;</span> <span class=\"builtin_type\">u32</span> <span class=\"punctuation\">{</span>\n+        <span class=\"self_keyword\">self</span><span class=\"punctuation\">.</span><span class=\"field\">x</span>\n+    <span class=\"punctuation\">}</span>\n <span class=\"punctuation\">}</span>\n \n <span class=\"keyword\">static</span> <span class=\"keyword\">mut</span> <span class=\"static declaration mutable unsafe\">STATIC_MUT</span><span class=\"punctuation\">:</span> <span class=\"builtin_type\">i32</span> <span class=\"operator\">=</span> <span class=\"numeric_literal\">0</span><span class=\"punctuation\">;</span>\n@@ -113,6 +142,16 @@\n     <span class=\"keyword\">let</span> <span class=\"struct\">Foo</span> <span class=\"punctuation\">{</span> <span class=\"field\">x</span><span class=\"punctuation\">:</span> <span class=\"variable declaration\">z</span><span class=\"punctuation\">,</span> <span class=\"field\">y</span> <span class=\"punctuation\">}</span> <span class=\"operator\">=</span> <span class=\"struct\">Foo</span> <span class=\"punctuation\">{</span> <span class=\"field\">x</span><span class=\"punctuation\">:</span> <span class=\"variable\">z</span><span class=\"punctuation\">,</span> <span class=\"field\">y</span> <span class=\"punctuation\">}</span><span class=\"punctuation\">;</span>\n \n     <span class=\"variable\">y</span><span class=\"punctuation\">;</span>\n+\n+    <span class=\"keyword\">let</span> <span class=\"keyword\">mut</span> <span class=\"variable declaration mutable\">foo</span> <span class=\"operator\">=</span> <span class=\"struct\">Foo</span> <span class=\"punctuation\">{</span> <span class=\"field\">x</span><span class=\"punctuation\">,</span> <span class=\"field\">y</span><span class=\"punctuation\">:</span> <span class=\"variable mutable\">x</span> <span class=\"punctuation\">}</span><span class=\"punctuation\">;</span>\n+    <span class=\"variable mutable\">foo</span><span class=\"punctuation\">.</span><span class=\"function\">quop</span><span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">;</span>\n+    <span class=\"variable mutable\">foo</span><span class=\"punctuation\">.</span><span class=\"function mutable\">qux</span><span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">;</span>\n+    <span class=\"variable mutable\">foo</span><span class=\"punctuation\">.</span><span class=\"function consuming\">baz</span><span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">;</span>\n+\n+    <span class=\"keyword\">let</span> <span class=\"keyword\">mut</span> <span class=\"variable declaration mutable\">copy</span> <span class=\"operator\">=</span> <span class=\"struct\">FooCopy</span> <span class=\"punctuation\">{</span> <span class=\"field\">x</span> <span class=\"punctuation\">}</span><span class=\"punctuation\">;</span>\n+    <span class=\"variable mutable\">copy</span><span class=\"punctuation\">.</span><span class=\"function\">quop</span><span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">;</span>\n+    <span class=\"variable mutable\">copy</span><span class=\"punctuation\">.</span><span class=\"function mutable\">qux</span><span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">;</span>\n+    <span class=\"variable mutable\">copy</span><span class=\"punctuation\">.</span><span class=\"function\">baz</span><span class=\"punctuation\">(</span><span class=\"punctuation\">)</span><span class=\"punctuation\">;</span>\n <span class=\"punctuation\">}</span>\n \n <span class=\"keyword\">enum</span> <span class=\"enum declaration\">Option</span><span class=\"punctuation\">&lt;</span><span class=\"type_param declaration\">T</span><span class=\"punctuation\">&gt;</span> <span class=\"punctuation\">{</span>"}, {"sha": "9db7b8af581edf57ee7f431b03400d2e319aeae6", "filename": "crates/rust-analyzer/src/semantic_tokens.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/529ca7e5e0573e15b23cd0067a691bf1ffebae84/crates%2Frust-analyzer%2Fsrc%2Fsemantic_tokens.rs", "raw_url": "https://github.com/rust-lang/rust/raw/529ca7e5e0573e15b23cd0067a691bf1ffebae84/crates%2Frust-analyzer%2Fsrc%2Fsemantic_tokens.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fsemantic_tokens.rs?ref=529ca7e5e0573e15b23cd0067a691bf1ffebae84", "patch": "@@ -75,6 +75,7 @@ define_semantic_token_modifiers![\n     (CONTROL_FLOW, \"controlFlow\"),\n     (INJECTED, \"injected\"),\n     (MUTABLE, \"mutable\"),\n+    (CONSUMING, \"consuming\"),\n     (UNSAFE, \"unsafe\"),\n     (ATTRIBUTE_MODIFIER, \"attribute\"),\n ];"}, {"sha": "a5191c16e7e06b2b20d1747ea5b0ae57f9cf8769", "filename": "crates/rust-analyzer/src/to_proto.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/529ca7e5e0573e15b23cd0067a691bf1ffebae84/crates%2Frust-analyzer%2Fsrc%2Fto_proto.rs", "raw_url": "https://github.com/rust-lang/rust/raw/529ca7e5e0573e15b23cd0067a691bf1ffebae84/crates%2Frust-analyzer%2Fsrc%2Fto_proto.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fto_proto.rs?ref=529ca7e5e0573e15b23cd0067a691bf1ffebae84", "patch": "@@ -400,6 +400,7 @@ fn semantic_token_type_and_modifiers(\n             HighlightModifier::Injected => semantic_tokens::INJECTED,\n             HighlightModifier::ControlFlow => semantic_tokens::CONTROL_FLOW,\n             HighlightModifier::Mutable => semantic_tokens::MUTABLE,\n+            HighlightModifier::Consuming => semantic_tokens::CONSUMING,\n             HighlightModifier::Unsafe => semantic_tokens::UNSAFE,\n         };\n         mods |= modifier;"}]}