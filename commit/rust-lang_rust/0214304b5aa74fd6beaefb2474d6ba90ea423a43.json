{"sha": "0214304b5aa74fd6beaefb2474d6ba90ea423a43", "node_id": "MDY6Q29tbWl0NzI0NzEyOjAyMTQzMDRiNWFhNzRmZDZiZWFlZmIyNDc0ZDZiYTkwZWE0MjNhNDM=", "commit": {"author": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-03-28T15:55:08Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2018-03-28T15:55:08Z"}, "message": "Rollup merge of #49364 - wesleywiser:incr_handle_load_failure, r=michaelwoerister\n\n[incremental] Don't panic if decoding the cache fails\n\nIf the cached data can't be loaded from disk, just issue a warning to\nthe user so they know why compilation is taking longer than usual but\ndon't fail the entire compilation since we can recover by ignorning the\non disk cache.\n\nIn the same way, if the disk cache can't be deserialized (because it has\nbeen corrupted for some reason), report the issue as a warning and\ncontinue without failing the compilation. `Decodable::decode()` tends to\npanic with various errors like \"entered unreachable code\" or \"index out\nof range\" if the input data is corrupted. Work around this by catching\npanics from the `decode()` calls and continuing without the cached data.\n\nFixes #48847", "tree": {"sha": "30f4e1912b88ddc659b439c6856e8751c5324e4e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/30f4e1912b88ddc659b439c6856e8751c5324e4e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0214304b5aa74fd6beaefb2474d6ba90ea423a43", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJau7rcCRBK7hj4Ov3rIwAAdHIIAAmG32ICyo7xE0IS8oSMUBnN\nCL/1eTnygPpyLeVc4r3PcUHpPMe3q0WfkF9FBjQh3AFRjuZgIWsXxV5aRm8uvyZ6\ns6uXfJ241Yss4LtBppIFfRABVi/WmrgeHpLEnWqECCzakkWjfPxse7AcaaeeTK50\ngsQJRt5p3em/3TErTZZQtxDIOASRtLzxjemXGZoqOnOOnIn5Uqn+iuaV5sj7UBBs\nm6X0mM0Z6NQSyUnAkP/BGuOXEGmgWf1M5QJREbl1kXP/RknvzpxaO9iOjomMTBAj\nrH+V8lo8rN0lmTa4E1j34467yD80hWApsKVIrlPLUnk2Durh/Y1veaG4YYdMJoM=\n=K7B4\n-----END PGP SIGNATURE-----\n", "payload": "tree 30f4e1912b88ddc659b439c6856e8751c5324e4e\nparent 4285e1cad486f089b047941f8b6560d3b4390c55\nparent 49fd71bea7bd3d8d11818503ca048227ffa1e758\nauthor kennytm <kennytm@gmail.com> 1522252508 +0200\ncommitter GitHub <noreply@github.com> 1522252508 +0200\n\nRollup merge of #49364 - wesleywiser:incr_handle_load_failure, r=michaelwoerister\n\n[incremental] Don't panic if decoding the cache fails\n\nIf the cached data can't be loaded from disk, just issue a warning to\nthe user so they know why compilation is taking longer than usual but\ndon't fail the entire compilation since we can recover by ignorning the\non disk cache.\n\nIn the same way, if the disk cache can't be deserialized (because it has\nbeen corrupted for some reason), report the issue as a warning and\ncontinue without failing the compilation. `Decodable::decode()` tends to\npanic with various errors like \"entered unreachable code\" or \"index out\nof range\" if the input data is corrupted. Work around this by catching\npanics from the `decode()` calls and continuing without the cached data.\n\nFixes #48847\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0214304b5aa74fd6beaefb2474d6ba90ea423a43", "html_url": "https://github.com/rust-lang/rust/commit/0214304b5aa74fd6beaefb2474d6ba90ea423a43", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0214304b5aa74fd6beaefb2474d6ba90ea423a43/comments", "author": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4285e1cad486f089b047941f8b6560d3b4390c55", "url": "https://api.github.com/repos/rust-lang/rust/commits/4285e1cad486f089b047941f8b6560d3b4390c55", "html_url": "https://github.com/rust-lang/rust/commit/4285e1cad486f089b047941f8b6560d3b4390c55"}, {"sha": "49fd71bea7bd3d8d11818503ca048227ffa1e758", "url": "https://api.github.com/repos/rust-lang/rust/commits/49fd71bea7bd3d8d11818503ca048227ffa1e758", "html_url": "https://github.com/rust-lang/rust/commit/49fd71bea7bd3d8d11818503ca048227ffa1e758"}], "stats": {"total": 9, "additions": 7, "deletions": 2}, "files": [{"sha": "c6ebc99268057c4bbfd361291e6d35cd486408a9", "filename": "src/librustc_driver/driver.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/0214304b5aa74fd6beaefb2474d6ba90ea423a43/src%2Flibrustc_driver%2Fdriver.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0214304b5aa74fd6beaefb2474d6ba90ea423a43/src%2Flibrustc_driver%2Fdriver.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Fdriver.rs?ref=0214304b5aa74fd6beaefb2474d6ba90ea423a43", "patch": "@@ -901,7 +901,9 @@ pub fn phase_2_configure_and_expand_inner<'a, F>(sess: &'a Session,\n         Some(future) => {\n             let prev_graph = time(sess, \"blocked while dep-graph loading finishes\", || {\n                 future.open()\n-                      .expect(\"Could not join with background dep_graph thread\")\n+                      .unwrap_or_else(|e| rustc_incremental::LoadResult::Error {\n+                          message: format!(\"could not decode incremental cache: {:?}\", e)\n+                      })\n                       .open(sess)\n             });\n             DepGraph::new(prev_graph)"}, {"sha": "cad72ff778b55155e816b9d78950ad6b5c3e5f3a", "filename": "src/librustc_incremental/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/0214304b5aa74fd6beaefb2474d6ba90ea423a43/src%2Flibrustc_incremental%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0214304b5aa74fd6beaefb2474d6ba90ea423a43/src%2Flibrustc_incremental%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_incremental%2Flib.rs?ref=0214304b5aa74fd6beaefb2474d6ba90ea423a43", "patch": "@@ -39,6 +39,7 @@ pub use assert_dep_graph::assert_dep_graph;\n pub use persist::dep_graph_tcx_init;\n pub use persist::load_dep_graph;\n pub use persist::load_query_result_cache;\n+pub use persist::LoadResult;\n pub use persist::save_dep_graph;\n pub use persist::save_trans_partition;\n pub use persist::save_work_products;"}, {"sha": "44d6e532f79bb4aa67b52c4446ac18dc665d4aef", "filename": "src/librustc_incremental/persist/load.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/0214304b5aa74fd6beaefb2474d6ba90ea423a43/src%2Flibrustc_incremental%2Fpersist%2Fload.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0214304b5aa74fd6beaefb2474d6ba90ea423a43/src%2Flibrustc_incremental%2Fpersist%2Fload.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_incremental%2Fpersist%2Fload.rs?ref=0214304b5aa74fd6beaefb2474d6ba90ea423a43", "patch": "@@ -89,7 +89,8 @@ impl LoadResult<PreviousDepGraph> {\n     pub fn open(self, sess: &Session) -> PreviousDepGraph {\n         match self {\n             LoadResult::Error { message } => {\n-                sess.fatal(&message) /* never returns */\n+                sess.warn(&message);\n+                PreviousDepGraph::new(SerializedDepGraph::new())\n             },\n             LoadResult::DataOutOfDate => {\n                 if let Err(err) = delete_all_session_dir_contents(sess) {"}, {"sha": "755a550b5bca31e4af3a120cd56d4b6ce22dd204", "filename": "src/librustc_incremental/persist/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/0214304b5aa74fd6beaefb2474d6ba90ea423a43/src%2Flibrustc_incremental%2Fpersist%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0214304b5aa74fd6beaefb2474d6ba90ea423a43/src%2Flibrustc_incremental%2Fpersist%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_incremental%2Fpersist%2Fmod.rs?ref=0214304b5aa74fd6beaefb2474d6ba90ea423a43", "patch": "@@ -27,6 +27,7 @@ pub use self::fs::prepare_session_directory;\n pub use self::load::dep_graph_tcx_init;\n pub use self::load::load_dep_graph;\n pub use self::load::load_query_result_cache;\n+pub use self::load::LoadResult;\n pub use self::save::save_dep_graph;\n pub use self::save::save_work_products;\n pub use self::work_product::save_trans_partition;"}]}