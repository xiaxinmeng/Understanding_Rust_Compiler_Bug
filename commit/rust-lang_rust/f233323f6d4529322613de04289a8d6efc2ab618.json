{"sha": "f233323f6d4529322613de04289a8d6efc2ab618", "node_id": "C_kwDOAAsO6NoAKGYyMzMzMjNmNmQ0NTI5MzIyNjEzZGUwNDI4OWE4ZDZlZmMyYWI2MTg", "commit": {"author": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2022-02-19T00:00:00Z"}, "committer": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2022-02-20T07:42:33Z"}, "message": "Gracefully handle non-UTF-8 string slices when pretty printing", "tree": {"sha": "69864bf4103cba1d28ef877a993962eb93979ab1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/69864bf4103cba1d28ef877a993962eb93979ab1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f233323f6d4529322613de04289a8d6efc2ab618", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f233323f6d4529322613de04289a8d6efc2ab618", "html_url": "https://github.com/rust-lang/rust/commit/f233323f6d4529322613de04289a8d6efc2ab618", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f233323f6d4529322613de04289a8d6efc2ab618/comments", "author": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "25ad89e47b5a04bdcdd36069ae12f02cc848e553", "url": "https://api.github.com/repos/rust-lang/rust/commits/25ad89e47b5a04bdcdd36069ae12f02cc848e553", "html_url": "https://github.com/rust-lang/rust/commit/25ad89e47b5a04bdcdd36069ae12f02cc848e553"}], "stats": {"total": 97, "additions": 47, "deletions": 50}, "files": [{"sha": "636b571a922c11c3179633cb13592e6b9cf79493", "filename": "compiler/rustc_middle/src/ty/print/pretty.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/f233323f6d4529322613de04289a8d6efc2ab618/compiler%2Frustc_middle%2Fsrc%2Fty%2Fprint%2Fpretty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f233323f6d4529322613de04289a8d6efc2ab618/compiler%2Frustc_middle%2Fsrc%2Fty%2Fprint%2Fpretty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fprint%2Fpretty.rs?ref=f233323f6d4529322613de04289a8d6efc2ab618", "patch": "@@ -1443,8 +1443,7 @@ pub trait PrettyPrinter<'tcx>:\n                 // relocations (we have an active `str` reference here). We don't use this\n                 // result to affect interpreter execution.\n                 let slice = data.inspect_with_uninit_and_ptr_outside_interpreter(start..end);\n-                let s = std::str::from_utf8(slice).expect(\"non utf8 str from miri\");\n-                p!(write(\"{:?}\", s));\n+                p!(write(\"{:?}\", String::from_utf8_lossy(slice)));\n                 Ok(self)\n             }\n             (ConstValue::ByRef { alloc, offset }, ty::Array(t, n)) if *t == u8_type => {"}, {"sha": "9480566897f8d1003e0d6dbd2f0416ae0868ec34", "filename": "src/test/mir-opt/const_prop/invalid_constant.main.ConstProp.diff", "status": "modified", "additions": 38, "deletions": 32, "changes": 70, "blob_url": "https://github.com/rust-lang/rust/blob/f233323f6d4529322613de04289a8d6efc2ab618/src%2Ftest%2Fmir-opt%2Fconst_prop%2Finvalid_constant.main.ConstProp.diff", "raw_url": "https://github.com/rust-lang/rust/raw/f233323f6d4529322613de04289a8d6efc2ab618/src%2Ftest%2Fmir-opt%2Fconst_prop%2Finvalid_constant.main.ConstProp.diff", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fconst_prop%2Finvalid_constant.main.ConstProp.diff?ref=f233323f6d4529322613de04289a8d6efc2ab618", "patch": "@@ -2,63 +2,69 @@\n + // MIR for `main` after ConstProp\n   \n   fn main() -> () {\n-      let mut _0: ();                      // return place in scope 0 at $DIR/invalid_constant.rs:13:11: 13:11\n-      let _1: main::InvalidChar;           // in scope 0 at $DIR/invalid_constant.rs:19:9: 19:22\n-      let mut _3: main::InvalidTag;        // in scope 0 at $DIR/invalid_constant.rs:26:25: 26:46\n-      let mut _5: main::NoVariants;        // in scope 0 at $DIR/invalid_constant.rs:33:35: 33:56\n+      let mut _0: ();                      // return place in scope 0 at $DIR/invalid_constant.rs:15:11: 15:11\n+      let _1: main::InvalidChar;           // in scope 0 at $DIR/invalid_constant.rs:21:9: 21:22\n+      let mut _3: main::InvalidTag;        // in scope 0 at $DIR/invalid_constant.rs:28:25: 28:46\n+      let mut _5: main::NoVariants;        // in scope 0 at $DIR/invalid_constant.rs:35:35: 35:56\n       scope 1 {\n-          debug _invalid_char => _1;       // in scope 1 at $DIR/invalid_constant.rs:19:9: 19:22\n-          let _2: [main::InvalidTag; 1];   // in scope 1 at $DIR/invalid_constant.rs:26:9: 26:21\n+          debug _invalid_char => _1;       // in scope 1 at $DIR/invalid_constant.rs:21:9: 21:22\n+          let _2: [main::InvalidTag; 1];   // in scope 1 at $DIR/invalid_constant.rs:28:9: 28:21\n           scope 2 {\n-              debug _invalid_tag => _2;    // in scope 2 at $DIR/invalid_constant.rs:26:9: 26:21\n-              let _4: [main::NoVariants; 1]; // in scope 2 at $DIR/invalid_constant.rs:33:9: 33:31\n+              debug _invalid_tag => _2;    // in scope 2 at $DIR/invalid_constant.rs:28:9: 28:21\n+              let _4: [main::NoVariants; 1]; // in scope 2 at $DIR/invalid_constant.rs:35:9: 35:31\n               scope 3 {\n-                  debug _enum_without_variants => _4; // in scope 3 at $DIR/invalid_constant.rs:33:9: 33:31\n+                  debug _enum_without_variants => _4; // in scope 3 at $DIR/invalid_constant.rs:35:9: 35:31\n+                  let _6: main::Str<\"\ufffd\ufffd\ufffd\">; // in scope 3 at $DIR/invalid_constant.rs:39:9: 39:22\n+                  scope 4 {\n+                      debug _non_utf8_str => _6; // in scope 4 at $DIR/invalid_constant.rs:39:9: 39:22\n+                  }\n               }\n           }\n       }\n   \n       bb0: {\n-          StorageLive(_1);                 // scope 0 at $DIR/invalid_constant.rs:19:9: 19:22\n--         _1 = const { InvalidChar { int: 0x110001 } }; // scope 0 at $DIR/invalid_constant.rs:19:25: 19:64\n-+         _1 = const InvalidChar { int: 1114113_u32, chr: {transmute(0x00110001): char} }; // scope 0 at $DIR/invalid_constant.rs:19:25: 19:64\n+          StorageLive(_1);                 // scope 0 at $DIR/invalid_constant.rs:21:9: 21:22\n+-         _1 = const { InvalidChar { int: 0x110001 } }; // scope 0 at $DIR/invalid_constant.rs:21:25: 21:64\n++         _1 = const InvalidChar { int: 1114113_u32, chr: {transmute(0x00110001): char} }; // scope 0 at $DIR/invalid_constant.rs:21:25: 21:64\n                                            // ty::Const\n                                            // + ty: main::InvalidChar\n -                                          // + val: Unevaluated(main::{constant#0}, [main::InvalidChar], None)\n +                                          // + val: Value(Scalar(0x00110001))\n                                            // mir::Constant\n-                                           // + span: $DIR/invalid_constant.rs:19:25: 19:64\n+                                           // + span: $DIR/invalid_constant.rs:21:25: 21:64\n -                                          // + literal: Const { ty: main::InvalidChar, val: Unevaluated(Unevaluated { def: WithOptConstParam { did: DefId(0:7 ~ invalid_constant[726d]::main::{constant#0}), const_param_did: None }, substs: [main::InvalidChar], promoted: None }) }\n +                                          // + literal: Const { ty: main::InvalidChar, val: Value(Scalar(0x00110001)) }\n-          StorageLive(_2);                 // scope 1 at $DIR/invalid_constant.rs:26:9: 26:21\n-          StorageLive(_3);                 // scope 1 at $DIR/invalid_constant.rs:26:25: 26:46\n-          (_3.0: u32) = const 4_u32;       // scope 1 at $DIR/invalid_constant.rs:26:25: 26:46\n--         _2 = [move _3];                  // scope 1 at $DIR/invalid_constant.rs:26:24: 26:47\n-+         _2 = [const InvalidTag { int: 4_u32, e: Scalar(0x00000004): E }]; // scope 1 at $DIR/invalid_constant.rs:26:24: 26:47\n+          StorageLive(_2);                 // scope 1 at $DIR/invalid_constant.rs:28:9: 28:21\n+          StorageLive(_3);                 // scope 1 at $DIR/invalid_constant.rs:28:25: 28:46\n+          (_3.0: u32) = const 4_u32;       // scope 1 at $DIR/invalid_constant.rs:28:25: 28:46\n+-         _2 = [move _3];                  // scope 1 at $DIR/invalid_constant.rs:28:24: 28:47\n++         _2 = [const InvalidTag { int: 4_u32, e: Scalar(0x00000004): E }]; // scope 1 at $DIR/invalid_constant.rs:28:24: 28:47\n +                                          // ty::Const\n +                                          // + ty: main::InvalidTag\n +                                          // + val: Value(Scalar(0x00000004))\n +                                          // mir::Constant\n-+                                          // + span: $DIR/invalid_constant.rs:26:24: 26:47\n++                                          // + span: $DIR/invalid_constant.rs:28:24: 28:47\n +                                          // + literal: Const { ty: main::InvalidTag, val: Value(Scalar(0x00000004)) }\n-          StorageDead(_3);                 // scope 1 at $DIR/invalid_constant.rs:26:46: 26:47\n-          StorageLive(_4);                 // scope 2 at $DIR/invalid_constant.rs:33:9: 33:31\n-          StorageLive(_5);                 // scope 2 at $DIR/invalid_constant.rs:33:35: 33:56\n-          (_5.0: u32) = const 0_u32;       // scope 2 at $DIR/invalid_constant.rs:33:35: 33:56\n--         _4 = [move _5];                  // scope 2 at $DIR/invalid_constant.rs:33:34: 33:57\n-+         _4 = [const NoVariants { int: 0_u32, empty: Scalar(<ZST>): Empty }]; // scope 2 at $DIR/invalid_constant.rs:33:34: 33:57\n+          StorageDead(_3);                 // scope 1 at $DIR/invalid_constant.rs:28:46: 28:47\n+          StorageLive(_4);                 // scope 2 at $DIR/invalid_constant.rs:35:9: 35:31\n+          StorageLive(_5);                 // scope 2 at $DIR/invalid_constant.rs:35:35: 35:56\n+          (_5.0: u32) = const 0_u32;       // scope 2 at $DIR/invalid_constant.rs:35:35: 35:56\n+-         _4 = [move _5];                  // scope 2 at $DIR/invalid_constant.rs:35:34: 35:57\n++         _4 = [const NoVariants { int: 0_u32, empty: Scalar(<ZST>): Empty }]; // scope 2 at $DIR/invalid_constant.rs:35:34: 35:57\n +                                          // ty::Const\n +                                          // + ty: main::NoVariants\n +                                          // + val: Value(Scalar(0x00000000))\n +                                          // mir::Constant\n-+                                          // + span: $DIR/invalid_constant.rs:33:34: 33:57\n++                                          // + span: $DIR/invalid_constant.rs:35:34: 35:57\n +                                          // + literal: Const { ty: main::NoVariants, val: Value(Scalar(0x00000000)) }\n-          StorageDead(_5);                 // scope 2 at $DIR/invalid_constant.rs:33:56: 33:57\n-          nop;                             // scope 0 at $DIR/invalid_constant.rs:13:11: 34:2\n-          StorageDead(_4);                 // scope 2 at $DIR/invalid_constant.rs:34:1: 34:2\n-          StorageDead(_2);                 // scope 1 at $DIR/invalid_constant.rs:34:1: 34:2\n-          StorageDead(_1);                 // scope 0 at $DIR/invalid_constant.rs:34:1: 34:2\n-          return;                          // scope 0 at $DIR/invalid_constant.rs:34:2: 34:2\n+          StorageDead(_5);                 // scope 2 at $DIR/invalid_constant.rs:35:56: 35:57\n+          StorageLive(_6);                 // scope 3 at $DIR/invalid_constant.rs:39:9: 39:22\n+          nop;                             // scope 0 at $DIR/invalid_constant.rs:15:11: 42:2\n+          StorageDead(_6);                 // scope 3 at $DIR/invalid_constant.rs:42:1: 42:2\n+          StorageDead(_4);                 // scope 2 at $DIR/invalid_constant.rs:42:1: 42:2\n+          StorageDead(_2);                 // scope 1 at $DIR/invalid_constant.rs:42:1: 42:2\n+          StorageDead(_1);                 // scope 0 at $DIR/invalid_constant.rs:42:1: 42:2\n+          return;                          // scope 0 at $DIR/invalid_constant.rs:42:2: 42:2\n       }\n   }\n   "}, {"sha": "492ef404916d49f9f04d62b909e042875357cdc2", "filename": "src/test/mir-opt/const_prop/invalid_constant.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/f233323f6d4529322613de04289a8d6efc2ab618/src%2Ftest%2Fmir-opt%2Fconst_prop%2Finvalid_constant.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f233323f6d4529322613de04289a8d6efc2ab618/src%2Ftest%2Fmir-opt%2Fconst_prop%2Finvalid_constant.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fconst_prop%2Finvalid_constant.rs?ref=f233323f6d4529322613de04289a8d6efc2ab618", "patch": "@@ -1,6 +1,8 @@\n // Verify that we can pretty print invalid constants.\n \n+#![feature(adt_const_params)]\n #![feature(inline_const)]\n+#![allow(incomplete_features)]\n \n #[derive(Copy, Clone)]\n #[repr(u32)]\n@@ -31,4 +33,10 @@ fn main() {\n         empty: Empty,\n     }\n     let _enum_without_variants = [NoVariants { int: 0 }];\n+\n+    // A non-UTF-8 string slice. Regression test for #75763 and #78520.\n+    struct Str<const S: &'static str>;\n+    let _non_utf8_str: Str::<{\n+        unsafe { std::mem::transmute::<&[u8], &str>(&[0xC0, 0xC1, 0xF5]) }\n+    }>;\n }"}, {"sha": "214a04b8a6bed5786e5c28951a038dea9063f1a7", "filename": "src/test/ui/const-generics/issues/issue-75763.rs", "status": "removed", "additions": 0, "deletions": 16, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/25ad89e47b5a04bdcdd36069ae12f02cc848e553/src%2Ftest%2Fui%2Fconst-generics%2Fissues%2Fissue-75763.rs", "raw_url": "https://github.com/rust-lang/rust/raw/25ad89e47b5a04bdcdd36069ae12f02cc848e553/src%2Ftest%2Fui%2Fconst-generics%2Fissues%2Fissue-75763.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconst-generics%2Fissues%2Fissue-75763.rs?ref=25ad89e47b5a04bdcdd36069ae12f02cc848e553", "patch": "@@ -1,16 +0,0 @@\n-// ignore-test\n-// FIXME(const_generics): This test causes an ICE after reverting #76030.\n-#![feature(adt_const_params)]\n-#![allow(incomplete_features)]\n-\n-\n-struct Bug<const S: &'static str>;\n-\n-fn main() {\n-    let b: Bug::<{\n-        unsafe {\n-            // FIXME(adt_const_params): Decide on how to deal with invalid values as const params.\n-            std::mem::transmute::<&[u8], &str>(&[0xC0, 0xC1, 0xF5])\n-        }\n-    }>;\n-}"}]}