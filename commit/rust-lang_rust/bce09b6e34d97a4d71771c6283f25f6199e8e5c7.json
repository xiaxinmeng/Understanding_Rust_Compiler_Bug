{"sha": "bce09b6e34d97a4d71771c6283f25f6199e8e5c7", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJjZTA5YjZlMzRkOTdhNGQ3MTc3MWM2MjgzZjI1ZjYxOTllOGU1Yzc=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2018-09-04T19:57:27Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2018-09-05T16:17:20Z"}, "message": "rustbuild: Tweak LLVM distribution layout\n\nThis commit tweaks the layout of a few components that we distribute to\nhopefully fix across all platforms the recent issues with LLD being unable to\nfind the LLVM shared object. In #53245 we switched to building LLVM as a dynamic\nlibrary, which means that LLVM tools by default link to LLVM dynamically rather\nthan statically. This in turn means that the tools, at runtime, need to find the\nLLVM shared library.\n\nLLVM's shared library is currently distributed as part of the rustc component.\nThis library is located, however, at `$sysroot/lib`. The LLVM tools we ship are\nin two locations:\n\n* LLD is shipped at `$sysroot/lib/rustlib/$host/bin/rust-lld`\n* Other LLVM tools are shipped at `$sysroot/bin`\n\nEach LLVM tool has an embedded rpath directive indicating where it will search\nfor dynamic libraries. This currently points to `../lib` and is presumably\ninserted by LLVM's build system. Unfortunately, though, this directive is only\ncorrect for the LLVM tools at `$sysroot/bin`, not LLD!\n\nThis commit is targeted at fixing this situation by making two changes:\n\n* LLVM tools other than LLD are moved in the distribution to\n  `$sysroot/lib/rustlib/$host/bin`. This moves them next to LLD and should\n  position them for...\n* The LLVM shared object is moved to `$sysroot/lib/rustlib/$host/lib`\n\nTogether this means that all tools should natively be able to find the shared\nobject and the shared object should be installed all the time for the various\ntools. Overall this should...\n\nCloses #53813", "tree": {"sha": "5f1f29caa392899704def94ef0a4d7ae0f409354", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5f1f29caa392899704def94ef0a4d7ae0f409354"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bce09b6e34d97a4d71771c6283f25f6199e8e5c7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bce09b6e34d97a4d71771c6283f25f6199e8e5c7", "html_url": "https://github.com/rust-lang/rust/commit/bce09b6e34d97a4d71771c6283f25f6199e8e5c7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bce09b6e34d97a4d71771c6283f25f6199e8e5c7/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1c2e17f4e3a2070a7f703f51e29c1c388ef703b6", "url": "https://api.github.com/repos/rust-lang/rust/commits/1c2e17f4e3a2070a7f703f51e29c1c388ef703b6", "html_url": "https://github.com/rust-lang/rust/commit/1c2e17f4e3a2070a7f703f51e29c1c388ef703b6"}], "stats": {"total": 6, "additions": 4, "deletions": 2}, "files": [{"sha": "c3282275f6fd48969cf35df75113b5a946189f88", "filename": "src/bootstrap/dist.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/bce09b6e34d97a4d71771c6283f25f6199e8e5c7/src%2Fbootstrap%2Fdist.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bce09b6e34d97a4d71771c6283f25f6199e8e5c7/src%2Fbootstrap%2Fdist.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fdist.rs?ref=bce09b6e34d97a4d71771c6283f25f6199e8e5c7", "patch": "@@ -1913,7 +1913,7 @@ fn maybe_install_llvm_dylib(builder: &Builder,\n                    llvm_dylib_path.display(), e);\n         });\n \n-        let dst_libdir = image.join(\"lib\");\n+        let dst_libdir = image.join(\"lib/rustlib\").join(&*target).join(\"lib\");\n         t!(fs::create_dir_all(&dst_libdir));\n \n         builder.install(&llvm_dylib_path, &dst_libdir, 0o644);\n@@ -1967,7 +1967,9 @@ impl Step for LlvmTools {\n         let src_bindir = builder\n             .llvm_out(target)\n             .join(\"bin\");\n-        let dst_bindir = image.join(\"bin\");\n+        let dst_bindir = image.join(\"lib/rustlib\")\n+            .join(&*target)\n+            .join(\"bin\");\n         t!(fs::create_dir_all(&dst_bindir));\n         for tool in LLVM_TOOLS {\n             let exe = src_bindir.join(exe(tool, &target));"}]}