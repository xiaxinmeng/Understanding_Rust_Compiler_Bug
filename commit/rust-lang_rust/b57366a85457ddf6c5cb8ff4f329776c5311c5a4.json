{"sha": "b57366a85457ddf6c5cb8ff4f329776c5311c5a4", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI1NzM2NmE4NTQ1N2RkZjZjNWNiOGZmNGYzMjk3NzZjNTMxMWM1YTQ=", "commit": {"author": {"name": "Nikita Popov", "email": "nikita.ppv@gmail.com", "date": "2018-10-13T08:52:18Z"}, "committer": {"name": "Nikita Popov", "email": "nikita.ppv@gmail.com", "date": "2018-10-13T18:06:25Z"}, "message": "Improve verify_llvm_ir config option\n\n* Make it influence the behavior of the compiled rustc, rather than\n  just the rustc build system. That is, if verify_llvm_ir=true,\n  even manual invocations of the built rustc will verify LLVM IR.\n* Enable verification of LLVM IR in CI, for non-deploy and\n  deploy-alt builds. This is similar to how LLVM assertions are\n  handled.", "tree": {"sha": "5bdc9ee23bff56bf87fc313baefc09e665217435", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5bdc9ee23bff56bf87fc313baefc09e665217435"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b57366a85457ddf6c5cb8ff4f329776c5311c5a4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b57366a85457ddf6c5cb8ff4f329776c5311c5a4", "html_url": "https://github.com/rust-lang/rust/commit/b57366a85457ddf6c5cb8ff4f329776c5311c5a4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b57366a85457ddf6c5cb8ff4f329776c5311c5a4/comments", "author": {"login": "nikic", "id": 216080, "node_id": "MDQ6VXNlcjIxNjA4MA==", "avatar_url": "https://avatars.githubusercontent.com/u/216080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikic", "html_url": "https://github.com/nikic", "followers_url": "https://api.github.com/users/nikic/followers", "following_url": "https://api.github.com/users/nikic/following{/other_user}", "gists_url": "https://api.github.com/users/nikic/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikic/subscriptions", "organizations_url": "https://api.github.com/users/nikic/orgs", "repos_url": "https://api.github.com/users/nikic/repos", "events_url": "https://api.github.com/users/nikic/events{/privacy}", "received_events_url": "https://api.github.com/users/nikic/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nikic", "id": 216080, "node_id": "MDQ6VXNlcjIxNjA4MA==", "avatar_url": "https://avatars.githubusercontent.com/u/216080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikic", "html_url": "https://github.com/nikic", "followers_url": "https://api.github.com/users/nikic/followers", "following_url": "https://api.github.com/users/nikic/following{/other_user}", "gists_url": "https://api.github.com/users/nikic/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikic/subscriptions", "organizations_url": "https://api.github.com/users/nikic/orgs", "repos_url": "https://api.github.com/users/nikic/repos", "events_url": "https://api.github.com/users/nikic/events{/privacy}", "received_events_url": "https://api.github.com/users/nikic/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e1643a8968753226dab7ab3c9fee826f097550f2", "url": "https://api.github.com/repos/rust-lang/rust/commits/e1643a8968753226dab7ab3c9fee826f097550f2", "html_url": "https://github.com/rust-lang/rust/commit/e1643a8968753226dab7ab3c9fee826f097550f2"}], "stats": {"total": 22, "additions": 14, "deletions": 8}, "files": [{"sha": "b6764c1aaeab6a22c3ef8af857c626b01529a601", "filename": "src/bootstrap/bin/rustc.rs", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b57366a85457ddf6c5cb8ff4f329776c5311c5a4/src%2Fbootstrap%2Fbin%2Frustc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b57366a85457ddf6c5cb8ff4f329776c5311c5a4/src%2Fbootstrap%2Fbin%2Frustc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbin%2Frustc.rs?ref=b57366a85457ddf6c5cb8ff4f329776c5311c5a4", "patch": "@@ -287,10 +287,6 @@ fn main() {\n         cmd.arg(\"--cfg\").arg(\"parallel_queries\");\n     }\n \n-    if env::var_os(\"RUSTC_VERIFY_LLVM_IR\").is_some() {\n-        cmd.arg(\"-Z\").arg(\"verify-llvm-ir\");\n-    }\n-\n     if env::var_os(\"RUSTC_DENY_WARNINGS\").is_some() && env::var_os(\"RUSTC_EXTERNAL_TOOL\").is_none()\n     {\n         cmd.arg(\"-Dwarnings\");"}, {"sha": "aa4e44df2ef9401d53109f404a74bc6baf3ca8cb", "filename": "src/bootstrap/builder.rs", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b57366a85457ddf6c5cb8ff4f329776c5311c5a4/src%2Fbootstrap%2Fbuilder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b57366a85457ddf6c5cb8ff4f329776c5311c5a4/src%2Fbootstrap%2Fbuilder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuilder.rs?ref=b57366a85457ddf6c5cb8ff4f329776c5311c5a4", "patch": "@@ -1000,10 +1000,6 @@ impl<'a> Builder<'a> {\n             cargo.env(\"RUSTC_BACKTRACE_ON_ICE\", \"1\");\n         }\n \n-        if self.config.rust_verify_llvm_ir {\n-            cargo.env(\"RUSTC_VERIFY_LLVM_IR\", \"1\");\n-        }\n-\n         cargo.env(\"RUSTC_VERBOSE\", self.verbosity.to_string());\n \n         // in std, we want to avoid denying warnings for stage 0 as that makes cfg's painful."}, {"sha": "69d45acdedaf9dc0859a2ecca9e315bf78eed70d", "filename": "src/bootstrap/compile.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/b57366a85457ddf6c5cb8ff4f329776c5311c5a4/src%2Fbootstrap%2Fcompile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b57366a85457ddf6c5cb8ff4f329776c5311c5a4/src%2Fbootstrap%2Fcompile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcompile.rs?ref=b57366a85457ddf6c5cb8ff4f329776c5311c5a4", "patch": "@@ -569,6 +569,9 @@ pub fn rustc_cargo_env(builder: &Builder, cargo: &mut Command) {\n     if builder.config.rustc_parallel_queries {\n         cargo.env(\"RUSTC_PARALLEL_QUERIES\", \"1\");\n     }\n+    if builder.config.rust_verify_llvm_ir {\n+        cargo.env(\"RUSTC_VERIFY_LLVM_IR\", \"1\");\n+    }\n }\n \n #[derive(Debug, Copy, Clone, PartialEq, Eq, Hash)]"}, {"sha": "42561cf95d3ac56342b9c8881e69e132f696b565", "filename": "src/ci/run.sh", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/b57366a85457ddf6c5cb8ff4f329776c5311c5a4/src%2Fci%2Frun.sh", "raw_url": "https://github.com/rust-lang/rust/raw/b57366a85457ddf6c5cb8ff4f329776c5311c5a4/src%2Fci%2Frun.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Frun.sh?ref=b57366a85457ddf6c5cb8ff4f329776c5311c5a4", "patch": "@@ -61,6 +61,7 @@ if [ \"$DEPLOY$DEPLOY_ALT\" != \"\" ]; then\n     RUST_CONFIGURE_ARGS=\"$RUST_CONFIGURE_ARGS --disable-llvm-assertions\"\n   elif [ \"$DEPLOY_ALT\" != \"\" ]; then\n     RUST_CONFIGURE_ARGS=\"$RUST_CONFIGURE_ARGS --enable-llvm-assertions\"\n+    RUST_CONFIGURE_ARGS=\"$RUST_CONFIGURE_ARGS --set rust.verify-llvm-ir\"\n   fi\n else\n   # We almost always want debug assertions enabled, but sometimes this takes too\n@@ -74,6 +75,8 @@ else\n   if [ \"$NO_LLVM_ASSERTIONS\" = \"\" ]; then\n     RUST_CONFIGURE_ARGS=\"$RUST_CONFIGURE_ARGS --enable-llvm-assertions\"\n   fi\n+\n+  RUST_CONFIGURE_ARGS=\"$RUST_CONFIGURE_ARGS --set rust.verify-llvm-ir\"\n fi\n \n if [ \"$RUST_RELEASE_CHANNEL\" = \"nightly\" ] || [ \"$DIST_REQUIRE_ALL_TOOLS\" = \"\" ]; then"}, {"sha": "bde503d86de739fa7cc5171d87a49856cd28c9d9", "filename": "src/librustc/build.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/b57366a85457ddf6c5cb8ff4f329776c5311c5a4/src%2Flibrustc%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b57366a85457ddf6c5cb8ff4f329776c5311c5a4/src%2Flibrustc%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fbuild.rs?ref=b57366a85457ddf6c5cb8ff4f329776c5311c5a4", "patch": "@@ -8,8 +8,15 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n+use std::env;\n+\n fn main() {\n     println!(\"cargo:rerun-if-changed=build.rs\");\n     println!(\"cargo:rerun-if-env-changed=CFG_LIBDIR_RELATIVE\");\n     println!(\"cargo:rerun-if-env-changed=CFG_COMPILER_HOST_TRIPLE\");\n+    println!(\"cargo:rerun-if-env-changed=RUSTC_VERIFY_LLVM_IR\");\n+\n+    if env::var_os(\"RUSTC_VERIFY_LLVM_IR\").is_some() {\n+        println!(\"cargo:rustc-cfg=always_verify_llvm_ir\");\n+    }\n }"}, {"sha": "fbe252fcfaf505f1859643aa4378cb31558c16e0", "filename": "src/librustc/session/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/b57366a85457ddf6c5cb8ff4f329776c5311c5a4/src%2Flibrustc%2Fsession%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b57366a85457ddf6c5cb8ff4f329776c5311c5a4/src%2Flibrustc%2Fsession%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fsession%2Fmod.rs?ref=b57366a85457ddf6c5cb8ff4f329776c5311c5a4", "patch": "@@ -531,6 +531,7 @@ impl Session {\n     }\n     pub fn verify_llvm_ir(&self) -> bool {\n         self.opts.debugging_opts.verify_llvm_ir\n+            || cfg!(always_verify_llvm_ir)\n     }\n     pub fn borrowck_stats(&self) -> bool {\n         self.opts.debugging_opts.borrowck_stats"}]}