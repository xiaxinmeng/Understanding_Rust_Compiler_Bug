{"sha": "ec7292ad3c35b7e3656f90988d9369fd6c55d1c9", "node_id": "MDY6Q29tbWl0NzI0NzEyOmVjNzI5MmFkM2MzNWI3ZTM2NTZmOTA5ODhkOTM2OWZkNmM1NWQxYzk=", "commit": {"author": {"name": "Gary Guo", "email": "gary@garyguo.net", "date": "2021-06-06T01:28:05Z"}, "committer": {"name": "Gary Guo", "email": "gary@garyguo.net", "date": "2021-07-02T21:52:37Z"}, "message": "core: add unstable `no_fp_fmt_parse` to disable float fmt/parse code\n\nIn some projects (e.g. kernel), floating point is forbidden. They can disable\nhardware floating point support and use `+soft-float` to avoid fp instructions\nfrom being generated, but as libcore contains the formatting code for `f32`\nand `f64`, some fp intrinsics are depended. One could define stubs for these\nintrinsics that just panic [1], but it means that if any formatting functions\nare accidentally used, mistake can only be caught during the runtime rather\nthan during compile-time or link-time, and they consume a lot of space without\nLTO.\n\nThis patch provides an unstable cfg `no_fp_fmt_parse` to disable these.\nA panicking stub is still provided for the `Debug` implementation (unfortunately)\nbecause there are some SIMD types that use `#[derive(Debug)]`.\n\n[1]: https://lkml.org/lkml/2021/4/14/1028", "tree": {"sha": "d5130abafc16b366adc1908ff279395836fd327d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d5130abafc16b366adc1908ff279395836fd327d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ec7292ad3c35b7e3656f90988d9369fd6c55d1c9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ec7292ad3c35b7e3656f90988d9369fd6c55d1c9", "html_url": "https://github.com/rust-lang/rust/commit/ec7292ad3c35b7e3656f90988d9369fd6c55d1c9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ec7292ad3c35b7e3656f90988d9369fd6c55d1c9/comments", "author": {"login": "nbdd0121", "id": 4065244, "node_id": "MDQ6VXNlcjQwNjUyNDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/4065244?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nbdd0121", "html_url": "https://github.com/nbdd0121", "followers_url": "https://api.github.com/users/nbdd0121/followers", "following_url": "https://api.github.com/users/nbdd0121/following{/other_user}", "gists_url": "https://api.github.com/users/nbdd0121/gists{/gist_id}", "starred_url": "https://api.github.com/users/nbdd0121/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nbdd0121/subscriptions", "organizations_url": "https://api.github.com/users/nbdd0121/orgs", "repos_url": "https://api.github.com/users/nbdd0121/repos", "events_url": "https://api.github.com/users/nbdd0121/events{/privacy}", "received_events_url": "https://api.github.com/users/nbdd0121/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nbdd0121", "id": 4065244, "node_id": "MDQ6VXNlcjQwNjUyNDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/4065244?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nbdd0121", "html_url": "https://github.com/nbdd0121", "followers_url": "https://api.github.com/users/nbdd0121/followers", "following_url": "https://api.github.com/users/nbdd0121/following{/other_user}", "gists_url": "https://api.github.com/users/nbdd0121/gists{/gist_id}", "starred_url": "https://api.github.com/users/nbdd0121/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nbdd0121/subscriptions", "organizations_url": "https://api.github.com/users/nbdd0121/orgs", "repos_url": "https://api.github.com/users/nbdd0121/repos", "events_url": "https://api.github.com/users/nbdd0121/events{/privacy}", "received_events_url": "https://api.github.com/users/nbdd0121/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "37647d1733c368dfb4a81f368cefa09adf6bf20d", "url": "https://api.github.com/repos/rust-lang/rust/commits/37647d1733c368dfb4a81f368cefa09adf6bf20d", "html_url": "https://github.com/rust-lang/rust/commit/37647d1733c368dfb4a81f368cefa09adf6bf20d"}], "stats": {"total": 27, "additions": 27, "deletions": 0}, "files": [{"sha": "269963400b624266aeb843d10f5738f1cd3fdcad", "filename": "library/core/src/fmt/mod.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/ec7292ad3c35b7e3656f90988d9369fd6c55d1c9/library%2Fcore%2Fsrc%2Ffmt%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ec7292ad3c35b7e3656f90988d9369fd6c55d1c9/library%2Fcore%2Fsrc%2Ffmt%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Ffmt%2Fmod.rs?ref=ec7292ad3c35b7e3656f90988d9369fd6c55d1c9", "patch": "@@ -13,7 +13,10 @@ use crate::result;\n use crate::str;\n \n mod builders;\n+#[cfg(not(no_fp_fmt_parse))]\n mod float;\n+#[cfg(no_fp_fmt_parse)]\n+mod nofloat;\n mod num;\n \n #[stable(feature = \"fmt_flags_align\", since = \"1.28.0\")]"}, {"sha": "cfb94cd9de5307dab5554043458ac20d1af4c9a5", "filename": "library/core/src/fmt/nofloat.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/ec7292ad3c35b7e3656f90988d9369fd6c55d1c9/library%2Fcore%2Fsrc%2Ffmt%2Fnofloat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ec7292ad3c35b7e3656f90988d9369fd6c55d1c9/library%2Fcore%2Fsrc%2Ffmt%2Fnofloat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Ffmt%2Fnofloat.rs?ref=ec7292ad3c35b7e3656f90988d9369fd6c55d1c9", "patch": "@@ -0,0 +1,15 @@\n+use crate::fmt::{Debug, Formatter, Result};\n+\n+macro_rules! floating {\n+    ($ty:ident) => {\n+        #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+        impl Debug for $ty {\n+            fn fmt(&self, _fmt: &mut Formatter<'_>) -> Result {\n+                panic!(\"floating point support is turned off\");\n+            }\n+        }\n+    };\n+}\n+\n+floating! { f32 }\n+floating! { f64 }"}, {"sha": "f60513a5d239a72ea187c699218c827ac98ddd3f", "filename": "library/core/src/num/mod.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/ec7292ad3c35b7e3656f90988d9369fd6c55d1c9/library%2Fcore%2Fsrc%2Fnum%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ec7292ad3c35b7e3656f90988d9369fd6c55d1c9/library%2Fcore%2Fsrc%2Fnum%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fnum%2Fmod.rs?ref=ec7292ad3c35b7e3656f90988d9369fd6c55d1c9", "patch": "@@ -25,9 +25,13 @@ macro_rules! unlikely {\n }\n \n // All these modules are technically private and only exposed for coretests:\n+#[cfg(not(no_fp_fmt_parse))]\n pub mod bignum;\n+#[cfg(not(no_fp_fmt_parse))]\n pub mod dec2flt;\n+#[cfg(not(no_fp_fmt_parse))]\n pub mod diy_float;\n+#[cfg(not(no_fp_fmt_parse))]\n pub mod flt2dec;\n pub mod fmt;\n \n@@ -44,6 +48,7 @@ mod wrapping;\n pub use wrapping::Wrapping;\n \n #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+#[cfg(not(no_fp_fmt_parse))]\n pub use dec2flt::ParseFloatError;\n \n #[stable(feature = \"rust1\", since = \"1.0.0\")]"}, {"sha": "bc4562bef3a96c728c654c7b8716eae239aac65d", "filename": "src/test/run-make-fulldeps/core-no-fp-fmt-parse/Makefile", "status": "added", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/ec7292ad3c35b7e3656f90988d9369fd6c55d1c9/src%2Ftest%2Frun-make-fulldeps%2Fcore-no-fp-fmt-parse%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/ec7292ad3c35b7e3656f90988d9369fd6c55d1c9/src%2Ftest%2Frun-make-fulldeps%2Fcore-no-fp-fmt-parse%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fcore-no-fp-fmt-parse%2FMakefile?ref=ec7292ad3c35b7e3656f90988d9369fd6c55d1c9", "patch": "@@ -0,0 +1,4 @@\n+-include ../tools.mk\n+\n+all:\n+\t$(RUSTC) --edition=2018 --crate-type=rlib ../../../../library/core/src/lib.rs --cfg no_fp_fmt_parse"}]}