{"sha": "92df638162b7ccea6f97a8e1287ed05c5c0818b4", "node_id": "MDY6Q29tbWl0NzI0NzEyOjkyZGY2MzgxNjJiN2NjZWE2Zjk3YThlMTI4N2VkMDVjNWMwODE4YjQ=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-10-31T11:51:42Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-10-31T11:51:42Z"}, "message": "Auto merge of #63803 - GuillaumeGomez:stabilize-doctest, r=ollie27,QuietMisdreavus,Mark-Simulacrum\n\n[rustdoc] stabilize cfg(doctest)\n\nFixes #62210.\n\nSince we removed rustdoc from providing cfg(test) on test runs, it's been replaced by cfg(doctest). It'd be nice to have it in not too far in the future.", "tree": {"sha": "e1ed62196fda23400c26658f3b100764abc58490", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e1ed62196fda23400c26658f3b100764abc58490"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/92df638162b7ccea6f97a8e1287ed05c5c0818b4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/92df638162b7ccea6f97a8e1287ed05c5c0818b4", "html_url": "https://github.com/rust-lang/rust/commit/92df638162b7ccea6f97a8e1287ed05c5c0818b4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/92df638162b7ccea6f97a8e1287ed05c5c0818b4/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b3a0350c2bf5d93cb734257bbddc8300bef4b851", "url": "https://api.github.com/repos/rust-lang/rust/commits/b3a0350c2bf5d93cb734257bbddc8300bef4b851", "html_url": "https://github.com/rust-lang/rust/commit/b3a0350c2bf5d93cb734257bbddc8300bef4b851"}, {"sha": "1595fdee1f9bff2901bcd3cd3fd7a22ea64cac24", "url": "https://api.github.com/repos/rust-lang/rust/commits/1595fdee1f9bff2901bcd3cd3fd7a22ea64cac24", "html_url": "https://github.com/rust-lang/rust/commit/1595fdee1f9bff2901bcd3cd3fd7a22ea64cac24"}], "stats": {"total": 106, "additions": 50, "deletions": 56}, "files": [{"sha": "bc1da5ff15a8c2de2557c5ce49720c006adab2a8", "filename": "src/doc/rustdoc/src/documentation-tests.md", "status": "modified", "additions": 46, "deletions": 0, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/92df638162b7ccea6f97a8e1287ed05c5c0818b4/src%2Fdoc%2Frustdoc%2Fsrc%2Fdocumentation-tests.md", "raw_url": "https://github.com/rust-lang/rust/raw/92df638162b7ccea6f97a8e1287ed05c5c0818b4/src%2Fdoc%2Frustdoc%2Fsrc%2Fdocumentation-tests.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Frustdoc%2Fsrc%2Fdocumentation-tests.md?ref=92df638162b7ccea6f97a8e1287ed05c5c0818b4", "patch": "@@ -379,3 +379,49 @@ However, it's preferable to use fenced code blocks over indented code blocks.\n Not only are fenced code blocks considered more idiomatic for Rust code,\n but there is no way to use directives such as `ignore` or `should_panic` with\n indented code blocks.\n+\n+### Include items only when collecting doctests\n+\n+Rustdoc's documentation tests can do some things that regular unit tests can't, so it can\n+sometimes be useful to extend your doctests with samples that wouldn't otherwise need to be in\n+documentation. To this end, Rustdoc allows you to have certain items only appear when it's\n+collecting doctests, so you can utilize doctest functionality without forcing the test to appear in\n+docs, or to find an arbitrary private item to include it on.\n+\n+When compiling a crate for use in doctests (with `--test` option), rustdoc will set `cfg(doctest)`.\n+Note that they will still link against only the public items of your crate; if you need to test\n+private items, you need to write a unit test.\n+\n+In this example, we're adding doctests that we know won't compile, to verify that our struct can\n+only take in valid data:\n+\n+```rust\n+/// We have a struct here. Remember it doesn't accept negative numbers!\n+pub struct MyStruct(pub usize);\n+\n+/// ```compile_fail\n+/// let x = my_crate::MyStruct(-5);\n+/// ```\n+#[cfg(doctest)]\n+pub struct MyStructOnlyTakesUsize;\n+```\n+\n+Note that the struct `MyStructOnlyTakesUsize` here isn't actually part of your public crate\n+API. The use of `#[cfg(doctest)]` makes sure that this struct only exists while rustdoc is\n+collecting doctests. This means that its doctest is executed when `--test` is passed to rustdoc,\n+but is hidden from the public documentation.\n+\n+Another possible use of `cfg(doctest)` is to test doctests that are included in your README file\n+without including it in your main documentation. For example, you could write this into your\n+`lib.rs` to test your README as part of your doctests:\n+\n+```rust,ignore\n+#![feature(extern_doc)]\n+\n+#[doc(include=\"../README.md\")]\n+#[cfg(doctest)]\n+pub struct ReadmeDoctests;\n+```\n+\n+This will include your README as documentation on the hidden struct `ReadmeDoctests`, which will\n+then be tested alongside the rest of your doctests."}, {"sha": "3c3e72aa3795912e5cedfa08930e439ef3dd24c8", "filename": "src/doc/rustdoc/src/unstable-features.md", "status": "modified", "additions": 0, "deletions": 30, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/92df638162b7ccea6f97a8e1287ed05c5c0818b4/src%2Fdoc%2Frustdoc%2Fsrc%2Funstable-features.md", "raw_url": "https://github.com/rust-lang/rust/raw/92df638162b7ccea6f97a8e1287ed05c5c0818b4/src%2Fdoc%2Frustdoc%2Fsrc%2Funstable-features.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Frustdoc%2Fsrc%2Funstable-features.md?ref=92df638162b7ccea6f97a8e1287ed05c5c0818b4", "patch": "@@ -211,36 +211,6 @@ pub struct BigX;\n Then, when looking for it through the `rustdoc` search, if you enter \"x\" or\n \"big\", search will show the `BigX` struct first.\n \n-### Include items only when collecting doctests\n-\n-Rustdoc's [documentation tests] can do some things that regular unit tests can't, so it can\n-sometimes be useful to extend your doctests with samples that wouldn't otherwise need to be in\n-documentation. To this end, Rustdoc allows you to have certain items only appear when it's\n-collecting doctests, so you can utilize doctest functionality without forcing the test to appear in\n-docs, or to find an arbitrary private item to include it on.\n-\n-If you add `#![feature(cfg_doctest)]` to your crate, Rustdoc will set `cfg(doctest)` when collecting\n-doctests. Note that they will still link against only the public items of your crate; if you need to\n-test private items, unit tests are still the way to go.\n-\n-In this example, we're adding doctests that we know won't compile, to verify that our struct can\n-only take in valid data:\n-\n-```rust\n-#![feature(cfg_doctest)]\n-\n-/// We have a struct here. Remember it doesn't accept negative numbers!\n-pub struct MyStruct(usize);\n-\n-/// ```compile_fail\n-/// let x = my_crate::MyStruct(-5);\n-/// ```\n-#[cfg(doctest)]\n-pub struct MyStructOnlyTakesUsize;\n-```\n-\n-[documentation tests]: documentation-tests.html\n-\n ## Unstable command-line arguments\n \n These features are enabled by passing a command-line flag to Rustdoc, but the flags in question are"}, {"sha": "a1cf2d421084ef60867468e68ce798f013aa31ab", "filename": "src/libsyntax/feature_gate/accepted.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/92df638162b7ccea6f97a8e1287ed05c5c0818b4/src%2Flibsyntax%2Ffeature_gate%2Faccepted.rs", "raw_url": "https://github.com/rust-lang/rust/raw/92df638162b7ccea6f97a8e1287ed05c5c0818b4/src%2Flibsyntax%2Ffeature_gate%2Faccepted.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Ffeature_gate%2Faccepted.rs?ref=92df638162b7ccea6f97a8e1287ed05c5c0818b4", "patch": "@@ -251,6 +251,8 @@ declare_features! (\n     (accepted, non_exhaustive, \"1.40.0\", Some(44109), None),\n     /// Allows calling constructor functions in `const fn`.\n     (accepted, const_constructor, \"1.40.0\", Some(61456), None),\n+    /// Allows the use of `#[cfg(doctest)]`, set when rustdoc is collecting doctests.\n+    (accepted, cfg_doctest, \"1.40.0\", Some(62210), None),\n \n     // -------------------------------------------------------------------------\n     // feature-group-end: accepted features"}, {"sha": "736a363bbfc0a020d94eae30a02377f82dc2f9d0", "filename": "src/libsyntax/feature_gate/active.rs", "status": "modified", "additions": 0, "deletions": 3, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/92df638162b7ccea6f97a8e1287ed05c5c0818b4/src%2Flibsyntax%2Ffeature_gate%2Factive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/92df638162b7ccea6f97a8e1287ed05c5c0818b4/src%2Flibsyntax%2Ffeature_gate%2Factive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Ffeature_gate%2Factive.rs?ref=92df638162b7ccea6f97a8e1287ed05c5c0818b4", "patch": "@@ -506,9 +506,6 @@ declare_features! (\n     /// Allows `async || body` closures.\n     (active, async_closure, \"1.37.0\", Some(62290), None),\n \n-    /// Allows the use of `#[cfg(doctest)]`; set when rustdoc is collecting doctests.\n-    (active, cfg_doctest, \"1.37.0\", Some(62210), None),\n-\n     /// Allows `[x; N]` where `x` is a constant (RFC 2203).\n     (active, const_in_array_repeat_expressions, \"1.37.0\", Some(49147), None),\n "}, {"sha": "eb811c3e0ff9b590ba03e9dabf0d1f8729ee437f", "filename": "src/libsyntax/feature_gate/builtin_attrs.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/92df638162b7ccea6f97a8e1287ed05c5c0818b4/src%2Flibsyntax%2Ffeature_gate%2Fbuiltin_attrs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/92df638162b7ccea6f97a8e1287ed05c5c0818b4/src%2Flibsyntax%2Ffeature_gate%2Fbuiltin_attrs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Ffeature_gate%2Fbuiltin_attrs.rs?ref=92df638162b7ccea6f97a8e1287ed05c5c0818b4", "patch": "@@ -31,7 +31,6 @@ const GATED_CFGS: &[(Symbol, Symbol, GateFn)] = &[\n     (sym::target_has_atomic, sym::cfg_target_has_atomic, cfg_fn!(cfg_target_has_atomic)),\n     (sym::target_has_atomic_load_store, sym::cfg_target_has_atomic, cfg_fn!(cfg_target_has_atomic)),\n     (sym::rustdoc, sym::doc_cfg, cfg_fn!(doc_cfg)),\n-    (sym::doctest, sym::cfg_doctest, cfg_fn!(cfg_doctest)),\n ];\n \n #[derive(Debug)]"}, {"sha": "587fe21f8fa738b629ab49927188e4b2b9599575", "filename": "src/test/rustdoc-ui/cfg-test.rs", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/92df638162b7ccea6f97a8e1287ed05c5c0818b4/src%2Ftest%2Frustdoc-ui%2Fcfg-test.rs", "raw_url": "https://github.com/rust-lang/rust/raw/92df638162b7ccea6f97a8e1287ed05c5c0818b4/src%2Ftest%2Frustdoc-ui%2Fcfg-test.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fcfg-test.rs?ref=92df638162b7ccea6f97a8e1287ed05c5c0818b4", "patch": "@@ -5,8 +5,6 @@\n // Crates like core have doctests gated on `cfg(not(test))` so we need to make\n // sure `cfg(test)` is not active when running `rustdoc --test`.\n \n-#![feature(cfg_doctest)]\n-\n /// this doctest will be ignored:\n ///\n /// ```"}, {"sha": "474f13cfa9843d874421d079443393d25713e688", "filename": "src/test/rustdoc-ui/cfg-test.stdout", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/92df638162b7ccea6f97a8e1287ed05c5c0818b4/src%2Ftest%2Frustdoc-ui%2Fcfg-test.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/92df638162b7ccea6f97a8e1287ed05c5c0818b4/src%2Ftest%2Frustdoc-ui%2Fcfg-test.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fcfg-test.stdout?ref=92df638162b7ccea6f97a8e1287ed05c5c0818b4", "patch": "@@ -1,7 +1,7 @@\n \n running 2 tests\n-test $DIR/cfg-test.rs - Bar (line 28) ... ok\n-test $DIR/cfg-test.rs - Foo (line 20) ... ok\n+test $DIR/cfg-test.rs - Bar (line 26) ... ok\n+test $DIR/cfg-test.rs - Foo (line 18) ... ok\n \n test result: ok. 2 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out\n "}, {"sha": "6a9d26a4bb78cbaabc2a6458a6ed71edca3eba1a", "filename": "src/test/rustdoc/cfg-doctest.rs", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/92df638162b7ccea6f97a8e1287ed05c5c0818b4/src%2Ftest%2Frustdoc%2Fcfg-doctest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/92df638162b7ccea6f97a8e1287ed05c5c0818b4/src%2Ftest%2Frustdoc%2Fcfg-doctest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fcfg-doctest.rs?ref=92df638162b7ccea6f97a8e1287ed05c5c0818b4", "patch": "@@ -1,5 +1,3 @@\n-#![feature(cfg_doctest)]\n-\n // @!has cfg_doctest/struct.SomeStruct.html\n // @!has cfg_doctest/index.html '//a/@href' 'struct.SomeStruct.html'\n "}, {"sha": "308f68bd52a79de82bf4011938a1c8547fc33626", "filename": "src/test/ui/feature-gate/feature-gate-cfg_doctest.rs", "status": "removed", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b3a0350c2bf5d93cb734257bbddc8300bef4b851/src%2Ftest%2Fui%2Ffeature-gate%2Ffeature-gate-cfg_doctest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b3a0350c2bf5d93cb734257bbddc8300bef4b851/src%2Ftest%2Fui%2Ffeature-gate%2Ffeature-gate-cfg_doctest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffeature-gate%2Ffeature-gate-cfg_doctest.rs?ref=b3a0350c2bf5d93cb734257bbddc8300bef4b851", "patch": "@@ -1,4 +0,0 @@\n-#[cfg(doctest)] //~ ERROR\n-pub struct SomeStruct;\n-\n-fn main() {}"}, {"sha": "5ab45e01e50c5cc8aa3373a29679f5f9e083be0b", "filename": "src/test/ui/feature-gate/feature-gate-cfg_doctest.stderr", "status": "removed", "additions": 0, "deletions": 12, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/b3a0350c2bf5d93cb734257bbddc8300bef4b851/src%2Ftest%2Fui%2Ffeature-gate%2Ffeature-gate-cfg_doctest.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b3a0350c2bf5d93cb734257bbddc8300bef4b851/src%2Ftest%2Fui%2Ffeature-gate%2Ffeature-gate-cfg_doctest.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffeature-gate%2Ffeature-gate-cfg_doctest.stderr?ref=b3a0350c2bf5d93cb734257bbddc8300bef4b851", "patch": "@@ -1,12 +0,0 @@\n-error[E0658]: `cfg(doctest)` is experimental and subject to change\n-  --> $DIR/feature-gate-cfg_doctest.rs:1:7\n-   |\n-LL | #[cfg(doctest)]\n-   |       ^^^^^^^\n-   |\n-   = note: for more information, see https://github.com/rust-lang/rust/issues/62210\n-   = help: add `#![feature(cfg_doctest)]` to the crate attributes to enable\n-\n-error: aborting due to previous error\n-\n-For more information about this error, try `rustc --explain E0658`."}]}