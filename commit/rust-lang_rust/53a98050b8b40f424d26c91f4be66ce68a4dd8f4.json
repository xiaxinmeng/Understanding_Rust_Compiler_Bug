{"sha": "53a98050b8b40f424d26c91f4be66ce68a4dd8f4", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUzYTk4MDUwYjhiNDBmNDI0ZDI2YzkxZjRiZTY2Y2U2OGE0ZGQ4ZjQ=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-05-16T08:33:47Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-05-16T08:33:47Z"}, "message": "Auto merge of #5602 - ebroto:issue_3430, r=phansch\n\nidentity_op: allow `1 << 0`\n\nI went for accepting `1 << 0` verbatim instead of something more general as it seems to be what everyone in the issue thread needed.\n\nchangelog: identity_op: allow `1 << 0` as it's a common pattern in bit manipulation code.\n\nFixes #3430", "tree": {"sha": "da8877d6f4af21db0bb01f00b6b5ed4ea1182d17", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/da8877d6f4af21db0bb01f00b6b5ed4ea1182d17"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/53a98050b8b40f424d26c91f4be66ce68a4dd8f4", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/53a98050b8b40f424d26c91f4be66ce68a4dd8f4", "html_url": "https://github.com/rust-lang/rust/commit/53a98050b8b40f424d26c91f4be66ce68a4dd8f4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/53a98050b8b40f424d26c91f4be66ce68a4dd8f4/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cac9ad02cf952f16bd8b00797f5bb1dbc30e692e", "url": "https://api.github.com/repos/rust-lang/rust/commits/cac9ad02cf952f16bd8b00797f5bb1dbc30e692e", "html_url": "https://github.com/rust-lang/rust/commit/cac9ad02cf952f16bd8b00797f5bb1dbc30e692e"}, {"sha": "fc8ab099c38952b91e38608c386314bde6dd2629", "url": "https://api.github.com/repos/rust-lang/rust/commits/fc8ab099c38952b91e38608c386314bde6dd2629", "html_url": "https://github.com/rust-lang/rust/commit/fc8ab099c38952b91e38608c386314bde6dd2629"}], "stats": {"total": 47, "additions": 44, "deletions": 3}, "files": [{"sha": "78e07d25f67c573cf122a36039ac487312149dd8", "filename": "clippy_lints/src/identity_op.rs", "status": "modified", "additions": 20, "deletions": 2, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/53a98050b8b40f424d26c91f4be66ce68a4dd8f4/clippy_lints%2Fsrc%2Fidentity_op.rs", "raw_url": "https://github.com/rust-lang/rust/raw/53a98050b8b40f424d26c91f4be66ce68a4dd8f4/clippy_lints%2Fsrc%2Fidentity_op.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fidentity_op.rs?ref=53a98050b8b40f424d26c91f4be66ce68a4dd8f4", "patch": "@@ -1,4 +1,5 @@\n-use rustc_hir::{BinOpKind, Expr, ExprKind};\n+use if_chain::if_chain;\n+use rustc_hir::{BinOp, BinOpKind, Expr, ExprKind};\n use rustc_lint::{LateContext, LateLintPass};\n use rustc_middle::ty;\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n@@ -32,7 +33,10 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for IdentityOp {\n         if e.span.from_expansion() {\n             return;\n         }\n-        if let ExprKind::Binary(ref cmp, ref left, ref right) = e.kind {\n+        if let ExprKind::Binary(cmp, ref left, ref right) = e.kind {\n+            if is_allowed(cx, cmp, left, right) {\n+                return;\n+            }\n             match cmp.node {\n                 BinOpKind::Add | BinOpKind::BitOr | BinOpKind::BitXor => {\n                     check(cx, left, 0, e.span, right.span);\n@@ -54,6 +58,20 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for IdentityOp {\n     }\n }\n \n+fn is_allowed(cx: &LateContext<'_, '_>, cmp: BinOp, left: &Expr<'_>, right: &Expr<'_>) -> bool {\n+    // `1 << 0` is a common pattern in bit manipulation code\n+    if_chain! {\n+        if let BinOpKind::Shl = cmp.node;\n+        if let Some(Constant::Int(0)) = constant_simple(cx, cx.tables, right);\n+        if let Some(Constant::Int(1)) = constant_simple(cx, cx.tables, left);\n+        then {\n+            return true;\n+        }\n+    }\n+\n+    false\n+}\n+\n #[allow(clippy::cast_possible_wrap)]\n fn check(cx: &LateContext<'_, '_>, e: &Expr<'_>, m: i8, span: Span, arg: Span) {\n     if let Some(Constant::Int(v)) = constant_simple(cx, cx.tables, e) {"}, {"sha": "ceaacaaf6bd706618ecac1133af2b63d9d261595", "filename": "tests/ui/identity_op.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/53a98050b8b40f424d26c91f4be66ce68a4dd8f4/tests%2Fui%2Fidentity_op.rs", "raw_url": "https://github.com/rust-lang/rust/raw/53a98050b8b40f424d26c91f4be66ce68a4dd8f4/tests%2Fui%2Fidentity_op.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fidentity_op.rs?ref=53a98050b8b40f424d26c91f4be66ce68a4dd8f4", "patch": "@@ -33,4 +33,9 @@ fn main() {\n \n     let u: u8 = 0;\n     u & 255;\n+\n+    1 << 0; // no error, this case is allowed, see issue 3430\n+    42 << 0;\n+    1 >> 0;\n+    42 >> 0;\n }"}, {"sha": "d8d44a74f9ab0fb05c1b19f7566eb2be6ad3e7be", "filename": "tests/ui/identity_op.stderr", "status": "modified", "additions": 19, "deletions": 1, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/53a98050b8b40f424d26c91f4be66ce68a4dd8f4/tests%2Fui%2Fidentity_op.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/53a98050b8b40f424d26c91f4be66ce68a4dd8f4/tests%2Fui%2Fidentity_op.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fidentity_op.stderr?ref=53a98050b8b40f424d26c91f4be66ce68a4dd8f4", "patch": "@@ -48,5 +48,23 @@ error: the operation is ineffective. Consider reducing it to `u`\n LL |     u & 255;\n    |     ^^^^^^^\n \n-error: aborting due to 8 previous errors\n+error: the operation is ineffective. Consider reducing it to `42`\n+  --> $DIR/identity_op.rs:38:5\n+   |\n+LL |     42 << 0;\n+   |     ^^^^^^^\n+\n+error: the operation is ineffective. Consider reducing it to `1`\n+  --> $DIR/identity_op.rs:39:5\n+   |\n+LL |     1 >> 0;\n+   |     ^^^^^^\n+\n+error: the operation is ineffective. Consider reducing it to `42`\n+  --> $DIR/identity_op.rs:40:5\n+   |\n+LL |     42 >> 0;\n+   |     ^^^^^^^\n+\n+error: aborting due to 11 previous errors\n "}]}