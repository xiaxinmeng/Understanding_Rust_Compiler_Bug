{"sha": "df7fd9995f10627f25ccb325f693a11b3395a73c", "node_id": "C_kwDOAAsO6NoAKGRmN2ZkOTk5NWYxMDYyN2YyNWNjYjMyNWY2OTNhMTFiMzM5NWE3M2M", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-03-23T15:17:59Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-03-23T15:17:59Z"}, "message": "Auto merge of #108221 - petrochenkov:cratecfg, r=michaelwoerister\n\nrustc_interface: Add a new query `pre_configure`\n\nIt partially expands crate attributes before the main expansion pass (without modifying the crate), and the produced preliminary crate attribute list is used for querying a few attributes that are required very early.\n\nCrate-level cfg attributes on the crate itself are then expanded normally during the main expansion pass, like attributes on any other nodes.\nThis is a continuation of https://github.com/rust-lang/rust/pull/92473 and one more step to very unstable crate-level proc macro attributes maybe actually working.\n\nPreviously crate attributes were pre-configured simultaneously with feature extraction, and then written directly into `ast::Crate`.", "tree": {"sha": "abad82c242e3e04ccfb721ea6c689283b621b8b2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/abad82c242e3e04ccfb721ea6c689283b621b8b2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/df7fd9995f10627f25ccb325f693a11b3395a73c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/df7fd9995f10627f25ccb325f693a11b3395a73c", "html_url": "https://github.com/rust-lang/rust/commit/df7fd9995f10627f25ccb325f693a11b3395a73c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/df7fd9995f10627f25ccb325f693a11b3395a73c/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "99c49d95cd7d704d2226859cfdc419c930cde9c6", "url": "https://api.github.com/repos/rust-lang/rust/commits/99c49d95cd7d704d2226859cfdc419c930cde9c6", "html_url": "https://github.com/rust-lang/rust/commit/99c49d95cd7d704d2226859cfdc419c930cde9c6"}, {"sha": "aca1b1e0b3820ae03622c37fb1b32e005d737fbf", "url": "https://api.github.com/repos/rust-lang/rust/commits/aca1b1e0b3820ae03622c37fb1b32e005d737fbf", "html_url": "https://github.com/rust-lang/rust/commit/aca1b1e0b3820ae03622c37fb1b32e005d737fbf"}], "stats": {"total": 335, "additions": 207, "deletions": 128}, "files": [{"sha": "2b6fcc169be067ee2a92555de44aaae52bf654bf", "filename": "compiler/rustc_builtin_macros/src/cmdline_attrs.rs", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/df7fd9995f10627f25ccb325f693a11b3395a73c/compiler%2Frustc_builtin_macros%2Fsrc%2Fcmdline_attrs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/df7fd9995f10627f25ccb325f693a11b3395a73c/compiler%2Frustc_builtin_macros%2Fsrc%2Fcmdline_attrs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_builtin_macros%2Fsrc%2Fcmdline_attrs.rs?ref=df7fd9995f10627f25ccb325f693a11b3395a73c", "patch": "@@ -6,7 +6,7 @@ use rustc_ast::{self as ast, AttrItem, AttrStyle};\n use rustc_session::parse::ParseSess;\n use rustc_span::FileName;\n \n-pub fn inject(mut krate: ast::Crate, parse_sess: &ParseSess, attrs: &[String]) -> ast::Crate {\n+pub fn inject(krate: &mut ast::Crate, parse_sess: &ParseSess, attrs: &[String]) {\n     for raw_attr in attrs {\n         let mut parser = rustc_parse::new_parser_from_source_str(\n             parse_sess,\n@@ -36,6 +36,4 @@ pub fn inject(mut krate: ast::Crate, parse_sess: &ParseSess, attrs: &[String]) -\n             start_span.to(end_span),\n         ));\n     }\n-\n-    krate\n }"}, {"sha": "378d5f39f4ab2ecd32f266afdcc602b49be58d24", "filename": "compiler/rustc_builtin_macros/src/proc_macro_harness.rs", "status": "modified", "additions": 5, "deletions": 7, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/df7fd9995f10627f25ccb325f693a11b3395a73c/compiler%2Frustc_builtin_macros%2Fsrc%2Fproc_macro_harness.rs", "raw_url": "https://github.com/rust-lang/rust/raw/df7fd9995f10627f25ccb325f693a11b3395a73c/compiler%2Frustc_builtin_macros%2Fsrc%2Fproc_macro_harness.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_builtin_macros%2Fsrc%2Fproc_macro_harness.rs?ref=df7fd9995f10627f25ccb325f693a11b3395a73c", "patch": "@@ -43,14 +43,14 @@ struct CollectProcMacros<'a> {\n }\n \n pub fn inject(\n+    krate: &mut ast::Crate,\n     sess: &Session,\n     resolver: &mut dyn ResolverExpand,\n-    mut krate: ast::Crate,\n     is_proc_macro_crate: bool,\n     has_proc_macro_decls: bool,\n     is_test_crate: bool,\n     handler: &rustc_errors::Handler,\n-) -> ast::Crate {\n+) {\n     let ecfg = ExpansionConfig::default(\"proc_macro\".to_string());\n     let mut cx = ExtCtxt::new(sess, ecfg, resolver, None);\n \n@@ -64,22 +64,20 @@ pub fn inject(\n     };\n \n     if has_proc_macro_decls || is_proc_macro_crate {\n-        visit::walk_crate(&mut collect, &krate);\n+        visit::walk_crate(&mut collect, krate);\n     }\n     let macros = collect.macros;\n \n     if !is_proc_macro_crate {\n-        return krate;\n+        return;\n     }\n \n     if is_test_crate {\n-        return krate;\n+        return;\n     }\n \n     let decls = mk_decls(&mut cx, &macros);\n     krate.items.push(decls);\n-\n-    krate\n }\n \n impl<'a> CollectProcMacros<'a> {"}, {"sha": "6493c6f13d54138ff2dc51830fdd210d4267eacd", "filename": "compiler/rustc_builtin_macros/src/standard_library_imports.rs", "status": "modified", "additions": 9, "deletions": 8, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/df7fd9995f10627f25ccb325f693a11b3395a73c/compiler%2Frustc_builtin_macros%2Fsrc%2Fstandard_library_imports.rs", "raw_url": "https://github.com/rust-lang/rust/raw/df7fd9995f10627f25ccb325f693a11b3395a73c/compiler%2Frustc_builtin_macros%2Fsrc%2Fstandard_library_imports.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_builtin_macros%2Fsrc%2Fstandard_library_imports.rs?ref=df7fd9995f10627f25ccb325f693a11b3395a73c", "patch": "@@ -9,17 +9,19 @@ use rustc_span::DUMMY_SP;\n use thin_vec::thin_vec;\n \n pub fn inject(\n-    mut krate: ast::Crate,\n+    krate: &mut ast::Crate,\n+    pre_configured_attrs: &[ast::Attribute],\n     resolver: &mut dyn ResolverExpand,\n     sess: &Session,\n-) -> ast::Crate {\n+) -> usize {\n+    let orig_num_items = krate.items.len();\n     let edition = sess.parse_sess.edition;\n \n     // the first name in this list is the crate name of the crate with the prelude\n-    let names: &[Symbol] = if attr::contains_name(&krate.attrs, sym::no_core) {\n-        return krate;\n-    } else if attr::contains_name(&krate.attrs, sym::no_std) {\n-        if attr::contains_name(&krate.attrs, sym::compiler_builtins) {\n+    let names: &[Symbol] = if attr::contains_name(pre_configured_attrs, sym::no_core) {\n+        return 0;\n+    } else if attr::contains_name(pre_configured_attrs, sym::no_std) {\n+        if attr::contains_name(pre_configured_attrs, sym::compiler_builtins) {\n             &[sym::core]\n         } else {\n             &[sym::core, sym::compiler_builtins]\n@@ -88,6 +90,5 @@ pub fn inject(\n     );\n \n     krate.items.insert(0, use_item);\n-\n-    krate\n+    krate.items.len() - orig_num_items\n }"}, {"sha": "43ab6c0442833d253b88ddc21be42d11051fcca6", "filename": "compiler/rustc_builtin_macros/src/test_harness.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/df7fd9995f10627f25ccb325f693a11b3395a73c/compiler%2Frustc_builtin_macros%2Fsrc%2Ftest_harness.rs", "raw_url": "https://github.com/rust-lang/rust/raw/df7fd9995f10627f25ccb325f693a11b3395a73c/compiler%2Frustc_builtin_macros%2Fsrc%2Ftest_harness.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_builtin_macros%2Fsrc%2Ftest_harness.rs?ref=df7fd9995f10627f25ccb325f693a11b3395a73c", "patch": "@@ -37,7 +37,7 @@ struct TestCtxt<'a> {\n \n /// Traverse the crate, collecting all the test functions, eliding any\n /// existing main functions, and synthesizing a main test harness\n-pub fn inject(sess: &Session, resolver: &mut dyn ResolverExpand, krate: &mut ast::Crate) {\n+pub fn inject(krate: &mut ast::Crate, sess: &Session, resolver: &mut dyn ResolverExpand) {\n     let span_diagnostic = sess.diagnostic();\n     let panic_strategy = sess.panic_strategy();\n     let platform_panic_strategy = sess.target.panic_strategy;"}, {"sha": "14d6569271eeb50a6b16411ae8bd3f7b6d21cccf", "filename": "compiler/rustc_driver_impl/src/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/df7fd9995f10627f25ccb325f693a11b3395a73c/compiler%2Frustc_driver_impl%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/df7fd9995f10627f25ccb325f693a11b3395a73c/compiler%2Frustc_driver_impl%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_driver_impl%2Fsrc%2Flib.rs?ref=df7fd9995f10627f25ccb325f693a11b3395a73c", "patch": "@@ -353,7 +353,7 @@ fn run_compiler(\n \n             {\n                 let plugins = queries.register_plugins()?;\n-                let (_, lint_store) = &*plugins.borrow();\n+                let (.., lint_store) = &*plugins.borrow();\n \n                 // Lint plugins are registered; now we can process command line flags.\n                 if sess.opts.describe_lints {"}, {"sha": "d32af10914e59c049716249c061f24b1ffa64472", "filename": "compiler/rustc_expand/src/base.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/df7fd9995f10627f25ccb325f693a11b3395a73c/compiler%2Frustc_expand%2Fsrc%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/df7fd9995f10627f25ccb325f693a11b3395a73c/compiler%2Frustc_expand%2Fsrc%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_expand%2Fsrc%2Fbase.rs?ref=df7fd9995f10627f25ccb325f693a11b3395a73c", "patch": "@@ -1002,6 +1002,7 @@ pub struct ExpansionData {\n pub struct ExtCtxt<'a> {\n     pub sess: &'a Session,\n     pub ecfg: expand::ExpansionConfig<'a>,\n+    pub num_standard_library_imports: usize,\n     pub reduced_recursion_limit: Option<Limit>,\n     pub root_path: PathBuf,\n     pub resolver: &'a mut dyn ResolverExpand,\n@@ -1030,6 +1031,7 @@ impl<'a> ExtCtxt<'a> {\n         ExtCtxt {\n             sess,\n             ecfg,\n+            num_standard_library_imports: 0,\n             reduced_recursion_limit: None,\n             resolver,\n             lint_store,"}, {"sha": "a78dc0678d5da50c126078ac4d24545ce50be249", "filename": "compiler/rustc_expand/src/config.rs", "status": "modified", "additions": 22, "deletions": 47, "changes": 69, "blob_url": "https://github.com/rust-lang/rust/blob/df7fd9995f10627f25ccb325f693a11b3395a73c/compiler%2Frustc_expand%2Fsrc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/df7fd9995f10627f25ccb325f693a11b3395a73c/compiler%2Frustc_expand%2Fsrc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_expand%2Fsrc%2Fconfig.rs?ref=df7fd9995f10627f25ccb325f693a11b3395a73c", "patch": "@@ -24,7 +24,6 @@ use rustc_session::Session;\n use rustc_span::edition::{Edition, ALL_EDITIONS};\n use rustc_span::symbol::{sym, Symbol};\n use rustc_span::{Span, DUMMY_SP};\n-use thin_vec::ThinVec;\n \n /// A folder that strips out items that do not belong in the current configuration.\n pub struct StripUnconfigured<'a> {\n@@ -37,7 +36,7 @@ pub struct StripUnconfigured<'a> {\n     pub lint_node_id: NodeId,\n }\n \n-fn get_features(sess: &Session, krate_attrs: &[ast::Attribute]) -> Features {\n+pub fn features(sess: &Session, krate_attrs: &[Attribute]) -> Features {\n     fn feature_removed(sess: &Session, span: Span, reason: Option<&str>) {\n         sess.emit_err(FeatureRemoved {\n             span,\n@@ -191,39 +190,16 @@ fn get_features(sess: &Session, krate_attrs: &[ast::Attribute]) -> Features {\n     features\n }\n \n-/// `cfg_attr`-process the crate's attributes and compute the crate's features.\n-pub fn features(\n-    sess: &Session,\n-    mut krate: ast::Crate,\n-    lint_node_id: NodeId,\n-) -> (ast::Crate, Features) {\n-    let mut strip_unconfigured =\n-        StripUnconfigured { sess, features: None, config_tokens: false, lint_node_id };\n-\n-    let unconfigured_attrs = krate.attrs.clone();\n-    let diag = &sess.parse_sess.span_diagnostic;\n-    let err_count = diag.err_count();\n-    let features = match strip_unconfigured.configure_krate_attrs(krate.attrs) {\n-        None => {\n-            // The entire crate is unconfigured.\n-            krate.attrs = ast::AttrVec::new();\n-            krate.items = ThinVec::new();\n-            Features::default()\n-        }\n-        Some(attrs) => {\n-            krate.attrs = attrs;\n-            let features = get_features(sess, &krate.attrs);\n-            if err_count == diag.err_count() {\n-                // Avoid reconfiguring malformed `cfg_attr`s.\n-                strip_unconfigured.features = Some(&features);\n-                // Run configuration again, this time with features available\n-                // so that we can perform feature-gating.\n-                strip_unconfigured.configure_krate_attrs(unconfigured_attrs);\n-            }\n-            features\n-        }\n+pub fn pre_configure_attrs(sess: &Session, attrs: &[Attribute]) -> ast::AttrVec {\n+    let strip_unconfigured = StripUnconfigured {\n+        sess,\n+        features: None,\n+        config_tokens: false,\n+        lint_node_id: ast::CRATE_NODE_ID,\n     };\n-    (krate, features)\n+    let attrs: ast::AttrVec =\n+        attrs.iter().flat_map(|attr| strip_unconfigured.process_cfg_attr(attr)).collect();\n+    if strip_unconfigured.in_cfg(&attrs) { attrs } else { ast::AttrVec::new() }\n }\n \n #[macro_export]\n@@ -254,11 +230,6 @@ impl<'a> StripUnconfigured<'a> {\n         }\n     }\n \n-    fn configure_krate_attrs(&self, mut attrs: ast::AttrVec) -> Option<ast::AttrVec> {\n-        attrs.flat_map_in_place(|attr| self.process_cfg_attr(attr));\n-        self.in_cfg(&attrs).then_some(attrs)\n-    }\n-\n     /// Performs cfg-expansion on `stream`, producing a new `AttrTokenStream`.\n     /// This is only used during the invocation of `derive` proc-macros,\n     /// which require that we cfg-expand their entire input.\n@@ -281,7 +252,7 @@ impl<'a> StripUnconfigured<'a> {\n             .iter()\n             .flat_map(|tree| match tree.clone() {\n                 AttrTokenTree::Attributes(mut data) => {\n-                    data.attrs.flat_map_in_place(|attr| self.process_cfg_attr(attr));\n+                    data.attrs.flat_map_in_place(|attr| self.process_cfg_attr(&attr));\n \n                     if self.in_cfg(&data.attrs) {\n                         data.tokens = LazyAttrTokenStream::new(\n@@ -319,12 +290,16 @@ impl<'a> StripUnconfigured<'a> {\n     /// the syntax of any `cfg_attr` is incorrect.\n     fn process_cfg_attrs<T: HasAttrs>(&self, node: &mut T) {\n         node.visit_attrs(|attrs| {\n-            attrs.flat_map_in_place(|attr| self.process_cfg_attr(attr));\n+            attrs.flat_map_in_place(|attr| self.process_cfg_attr(&attr));\n         });\n     }\n \n-    fn process_cfg_attr(&self, attr: Attribute) -> Vec<Attribute> {\n-        if attr.has_name(sym::cfg_attr) { self.expand_cfg_attr(attr, true) } else { vec![attr] }\n+    fn process_cfg_attr(&self, attr: &Attribute) -> Vec<Attribute> {\n+        if attr.has_name(sym::cfg_attr) {\n+            self.expand_cfg_attr(attr, true)\n+        } else {\n+            vec![attr.clone()]\n+        }\n     }\n \n     /// Parse and expand a single `cfg_attr` attribute into a list of attributes\n@@ -334,9 +309,9 @@ impl<'a> StripUnconfigured<'a> {\n     /// Gives a compiler warning when the `cfg_attr` contains no attributes and\n     /// is in the original source file. Gives a compiler error if the syntax of\n     /// the attribute is incorrect.\n-    pub(crate) fn expand_cfg_attr(&self, attr: Attribute, recursive: bool) -> Vec<Attribute> {\n+    pub(crate) fn expand_cfg_attr(&self, attr: &Attribute, recursive: bool) -> Vec<Attribute> {\n         let Some((cfg_predicate, expanded_attrs)) =\n-            rustc_parse::parse_cfg_attr(&attr, &self.sess.parse_sess) else {\n+            rustc_parse::parse_cfg_attr(attr, &self.sess.parse_sess) else {\n                 return vec![];\n             };\n \n@@ -365,10 +340,10 @@ impl<'a> StripUnconfigured<'a> {\n             //  `#[cfg_attr(false, cfg_attr(true, some_attr))]`.\n             expanded_attrs\n                 .into_iter()\n-                .flat_map(|item| self.process_cfg_attr(self.expand_cfg_attr_item(&attr, item)))\n+                .flat_map(|item| self.process_cfg_attr(&self.expand_cfg_attr_item(attr, item)))\n                 .collect()\n         } else {\n-            expanded_attrs.into_iter().map(|item| self.expand_cfg_attr_item(&attr, item)).collect()\n+            expanded_attrs.into_iter().map(|item| self.expand_cfg_attr_item(attr, item)).collect()\n         }\n     }\n "}, {"sha": "ec40911545f500fab659171ad0be4897e06ba010", "filename": "compiler/rustc_expand/src/expand.rs", "status": "modified", "additions": 12, "deletions": 4, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/df7fd9995f10627f25ccb325f693a11b3395a73c/compiler%2Frustc_expand%2Fsrc%2Fexpand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/df7fd9995f10627f25ccb325f693a11b3395a73c/compiler%2Frustc_expand%2Fsrc%2Fexpand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_expand%2Fsrc%2Fexpand.rs?ref=df7fd9995f10627f25ccb325f693a11b3395a73c", "patch": "@@ -1038,6 +1038,9 @@ trait InvocationCollectorNode: HasAttrs + HasNodeId + Sized {\n     ) -> Result<Self::OutputTy, Self> {\n         Ok(noop_flat_map(node, collector))\n     }\n+    fn expand_cfg_false(&mut self, collector: &mut InvocationCollector<'_, '_>, span: Span) {\n+        collector.cx.emit_err(RemoveNodeNotSupported { span, descr: Self::descr() });\n+    }\n }\n \n impl InvocationCollectorNode for P<ast::Item> {\n@@ -1378,6 +1381,11 @@ impl InvocationCollectorNode for ast::Crate {\n     fn noop_visit<V: MutVisitor>(&mut self, visitor: &mut V) {\n         noop_visit_crate(self, visitor)\n     }\n+    fn expand_cfg_false(&mut self, collector: &mut InvocationCollector<'_, '_>, _span: Span) {\n+        self.attrs.clear();\n+        // Standard prelude imports are left in the crate for backward compatibility.\n+        self.items.truncate(collector.cx.num_standard_library_imports);\n+    }\n }\n \n impl InvocationCollectorNode for P<ast::Ty> {\n@@ -1688,7 +1696,7 @@ impl<'a, 'b> InvocationCollector<'a, 'b> {\n         res\n     }\n \n-    fn expand_cfg_attr(&self, node: &mut impl HasAttrs, attr: ast::Attribute, pos: usize) {\n+    fn expand_cfg_attr(&self, node: &mut impl HasAttrs, attr: &ast::Attribute, pos: usize) {\n         node.visit_attrs(|attrs| {\n             // Repeated `insert` calls is inefficient, but the number of\n             // insertions is almost always 0 or 1 in practice.\n@@ -1712,7 +1720,7 @@ impl<'a, 'b> InvocationCollector<'a, 'b> {\n                         Default::default()\n                     }\n                     sym::cfg_attr => {\n-                        self.expand_cfg_attr(&mut node, attr, pos);\n+                        self.expand_cfg_attr(&mut node, &attr, pos);\n                         continue;\n                     }\n                     _ => {\n@@ -1756,11 +1764,11 @@ impl<'a, 'b> InvocationCollector<'a, 'b> {\n                             continue;\n                         }\n \n-                        self.cx.emit_err(RemoveNodeNotSupported { span, descr: Node::descr() });\n+                        node.expand_cfg_false(self, span);\n                         continue;\n                     }\n                     sym::cfg_attr => {\n-                        self.expand_cfg_attr(node, attr, pos);\n+                        self.expand_cfg_attr(node, &attr, pos);\n                         continue;\n                     }\n                     _ => visit_clobber(node, |node| {"}, {"sha": "7623c5f7327f84ae0c4a73c932c0738458f2c12e", "filename": "compiler/rustc_interface/src/passes.rs", "status": "modified", "additions": 32, "deletions": 29, "changes": 61, "blob_url": "https://github.com/rust-lang/rust/blob/df7fd9995f10627f25ccb325f693a11b3395a73c/compiler%2Frustc_interface%2Fsrc%2Fpasses.rs", "raw_url": "https://github.com/rust-lang/rust/raw/df7fd9995f10627f25ccb325f693a11b3395a73c/compiler%2Frustc_interface%2Fsrc%2Fpasses.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2Fsrc%2Fpasses.rs?ref=df7fd9995f10627f25ccb325f693a11b3395a73c", "patch": "@@ -3,7 +3,6 @@ use crate::interface::{Compiler, Result};\n use crate::proc_macro_decls;\n use crate::util;\n \n-use ast::CRATE_NODE_ID;\n use rustc_ast::{self as ast, visit};\n use rustc_borrowck as mir_borrowck;\n use rustc_codegen_ssa::traits::CodegenBackend;\n@@ -76,22 +75,14 @@ pub fn register_plugins<'a>(\n     sess: &'a Session,\n     metadata_loader: &'a dyn MetadataLoader,\n     register_lints: impl Fn(&Session, &mut LintStore),\n-    mut krate: ast::Crate,\n+    pre_configured_attrs: &[ast::Attribute],\n     crate_name: Symbol,\n-) -> Result<(ast::Crate, LintStore)> {\n-    krate = sess.time(\"attributes_injection\", || {\n-        rustc_builtin_macros::cmdline_attrs::inject(\n-            krate,\n-            &sess.parse_sess,\n-            &sess.opts.unstable_opts.crate_attr,\n-        )\n-    });\n-\n-    let (krate, features) = rustc_expand::config::features(sess, krate, CRATE_NODE_ID);\n+) -> Result<LintStore> {\n     // these need to be set \"early\" so that expansion sees `quote` if enabled.\n+    let features = rustc_expand::config::features(sess, pre_configured_attrs);\n     sess.init_features(features);\n \n-    let crate_types = util::collect_crate_types(sess, &krate.attrs);\n+    let crate_types = util::collect_crate_types(sess, pre_configured_attrs);\n     sess.init_crate_types(crate_types);\n \n     let stable_crate_id = StableCrateId::new(\n@@ -117,16 +108,17 @@ pub fn register_plugins<'a>(\n     let mut lint_store = rustc_lint::new_lint_store(sess.enable_internal_lints());\n     register_lints(sess, &mut lint_store);\n \n-    let registrars =\n-        sess.time(\"plugin_loading\", || plugin::load::load_plugins(sess, metadata_loader, &krate));\n+    let registrars = sess.time(\"plugin_loading\", || {\n+        plugin::load::load_plugins(sess, metadata_loader, pre_configured_attrs)\n+    });\n     sess.time(\"plugin_registration\", || {\n         let mut registry = plugin::Registry { lint_store: &mut lint_store };\n         for registrar in registrars {\n             registrar(&mut registry);\n         }\n     });\n \n-    Ok((krate, lint_store))\n+    Ok(lint_store)\n }\n \n fn pre_expansion_lint<'a>(\n@@ -173,19 +165,29 @@ impl LintStoreExpand for LintStoreExpandImpl<'_> {\n /// harness if one is to be provided, injection of a dependency on the\n /// standard library and prelude, and name resolution.\n #[instrument(level = \"trace\", skip(krate, resolver))]\n-fn configure_and_expand(mut krate: ast::Crate, resolver: &mut Resolver<'_, '_>) -> ast::Crate {\n+fn configure_and_expand(\n+    mut krate: ast::Crate,\n+    pre_configured_attrs: &[ast::Attribute],\n+    resolver: &mut Resolver<'_, '_>,\n+) -> ast::Crate {\n     let tcx = resolver.tcx();\n     let sess = tcx.sess;\n     let lint_store = unerased_lint_store(tcx);\n     let crate_name = tcx.crate_name(LOCAL_CRATE);\n-    pre_expansion_lint(sess, lint_store, tcx.registered_tools(()), &krate, crate_name);\n+    let lint_check_node = (&krate, pre_configured_attrs);\n+    pre_expansion_lint(sess, lint_store, tcx.registered_tools(()), lint_check_node, crate_name);\n     rustc_builtin_macros::register_builtin_macros(resolver);\n \n-    krate = sess.time(\"crate_injection\", || {\n-        rustc_builtin_macros::standard_library_imports::inject(krate, resolver, sess)\n+    let num_standard_library_imports = sess.time(\"crate_injection\", || {\n+        rustc_builtin_macros::standard_library_imports::inject(\n+            &mut krate,\n+            pre_configured_attrs,\n+            resolver,\n+            sess,\n+        )\n     });\n \n-    util::check_attr_crate_type(sess, &krate.attrs, &mut resolver.lint_buffer());\n+    util::check_attr_crate_type(sess, pre_configured_attrs, &mut resolver.lint_buffer());\n \n     // Expand all macros\n     krate = sess.time(\"macro_expand_crate\", || {\n@@ -222,7 +224,7 @@ fn configure_and_expand(mut krate: ast::Crate, resolver: &mut Resolver<'_, '_>)\n \n         // Create the config for macro expansion\n         let features = sess.features_untracked();\n-        let recursion_limit = get_recursion_limit(&krate.attrs, sess);\n+        let recursion_limit = get_recursion_limit(pre_configured_attrs, sess);\n         let cfg = rustc_expand::expand::ExpansionConfig {\n             features: Some(features),\n             recursion_limit,\n@@ -235,6 +237,7 @@ fn configure_and_expand(mut krate: ast::Crate, resolver: &mut Resolver<'_, '_>)\n \n         let lint_store = LintStoreExpandImpl(lint_store);\n         let mut ecx = ExtCtxt::new(sess, cfg, resolver, Some(&lint_store));\n+        ecx.num_standard_library_imports = num_standard_library_imports;\n         // Expand macros now!\n         let krate = sess.time(\"expand_crate\", || ecx.monotonic_expander().expand_crate(krate));\n \n@@ -263,7 +266,7 @@ fn configure_and_expand(mut krate: ast::Crate, resolver: &mut Resolver<'_, '_>)\n     });\n \n     sess.time(\"maybe_building_test_harness\", || {\n-        rustc_builtin_macros::test_harness::inject(sess, resolver, &mut krate)\n+        rustc_builtin_macros::test_harness::inject(&mut krate, sess, resolver)\n     });\n \n     let has_proc_macro_decls = sess.time(\"AST_validation\", || {\n@@ -287,12 +290,12 @@ fn configure_and_expand(mut krate: ast::Crate, resolver: &mut Resolver<'_, '_>)\n         sess.emit_warning(errors::ProcMacroCratePanicAbort);\n     }\n \n-    krate = sess.time(\"maybe_create_a_macro_crate\", || {\n+    sess.time(\"maybe_create_a_macro_crate\", || {\n         let is_test_crate = sess.opts.test;\n         rustc_builtin_macros::proc_macro_harness::inject(\n+            &mut krate,\n             sess,\n             resolver,\n-            krate,\n             is_proc_macro_crate,\n             has_proc_macro_decls,\n             is_test_crate,\n@@ -356,7 +359,7 @@ fn early_lint_checks(tcx: TyCtxt<'_>, (): ()) {\n         tcx.registered_tools(()),\n         Some(lint_buffer),\n         rustc_lint::BuiltinCombinedEarlyLintPass::new(),\n-        &**krate,\n+        (&**krate, &*krate.attrs),\n     )\n }\n \n@@ -557,9 +560,9 @@ fn resolver_for_lowering<'tcx>(\n ) -> &'tcx Steal<(ty::ResolverAstLowering, Lrc<ast::Crate>)> {\n     let arenas = Resolver::arenas();\n     let _ = tcx.registered_tools(()); // Uses `crate_for_resolver`.\n-    let krate = tcx.crate_for_resolver(()).steal();\n-    let mut resolver = Resolver::new(tcx, &krate, &arenas);\n-    let krate = configure_and_expand(krate, &mut resolver);\n+    let (krate, pre_configured_attrs) = tcx.crate_for_resolver(()).steal();\n+    let mut resolver = Resolver::new(tcx, &pre_configured_attrs, krate.spans.inner_span, &arenas);\n+    let krate = configure_and_expand(krate, &pre_configured_attrs, &mut resolver);\n \n     // Make sure we don't mutate the cstore from here on.\n     tcx.untracked().cstore.leak();"}, {"sha": "d2293780836d559ece0df9734940d5a0d2c83a67", "filename": "compiler/rustc_interface/src/queries.rs", "status": "modified", "additions": 32, "deletions": 11, "changes": 43, "blob_url": "https://github.com/rust-lang/rust/blob/df7fd9995f10627f25ccb325f693a11b3395a73c/compiler%2Frustc_interface%2Fsrc%2Fqueries.rs", "raw_url": "https://github.com/rust-lang/rust/raw/df7fd9995f10627f25ccb325f693a11b3395a73c/compiler%2Frustc_interface%2Fsrc%2Fqueries.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2Fsrc%2Fqueries.rs?ref=df7fd9995f10627f25ccb325f693a11b3395a73c", "patch": "@@ -88,8 +88,9 @@ pub struct Queries<'tcx> {\n \n     dep_graph_future: Query<Option<DepGraphFuture>>,\n     parse: Query<ast::Crate>,\n+    pre_configure: Query<(ast::Crate, ast::AttrVec)>,\n     crate_name: Query<Symbol>,\n-    register_plugins: Query<(ast::Crate, Lrc<LintStore>)>,\n+    register_plugins: Query<(ast::Crate, ast::AttrVec, Lrc<LintStore>)>,\n     dep_graph: Query<DepGraph>,\n     // This just points to what's in `gcx_cell`.\n     gcx: Query<&'tcx GlobalCtxt<'tcx>>,\n@@ -106,6 +107,7 @@ impl<'tcx> Queries<'tcx> {\n             hir_arena: WorkerLocal::new(|_| rustc_hir::Arena::default()),\n             dep_graph_future: Default::default(),\n             parse: Default::default(),\n+            pre_configure: Default::default(),\n             crate_name: Default::default(),\n             register_plugins: Default::default(),\n             dep_graph: Default::default(),\n@@ -133,17 +135,36 @@ impl<'tcx> Queries<'tcx> {\n             .compute(|| passes::parse(self.session()).map_err(|mut parse_error| parse_error.emit()))\n     }\n \n-    pub fn register_plugins(&self) -> Result<QueryResult<'_, (ast::Crate, Lrc<LintStore>)>> {\n+    pub fn pre_configure(&self) -> Result<QueryResult<'_, (ast::Crate, ast::AttrVec)>> {\n+        self.pre_configure.compute(|| {\n+            let mut krate = self.parse()?.steal();\n+\n+            let sess = self.session();\n+            rustc_builtin_macros::cmdline_attrs::inject(\n+                &mut krate,\n+                &sess.parse_sess,\n+                &sess.opts.unstable_opts.crate_attr,\n+            );\n+\n+            let pre_configured_attrs =\n+                rustc_expand::config::pre_configure_attrs(sess, &krate.attrs);\n+            Ok((krate, pre_configured_attrs))\n+        })\n+    }\n+\n+    pub fn register_plugins(\n+        &self,\n+    ) -> Result<QueryResult<'_, (ast::Crate, ast::AttrVec, Lrc<LintStore>)>> {\n         self.register_plugins.compute(|| {\n             let crate_name = *self.crate_name()?.borrow();\n-            let krate = self.parse()?.steal();\n+            let (krate, pre_configured_attrs) = self.pre_configure()?.steal();\n \n             let empty: &(dyn Fn(&Session, &mut LintStore) + Sync + Send) = &|_, _| {};\n-            let (krate, lint_store) = passes::register_plugins(\n+            let lint_store = passes::register_plugins(\n                 self.session(),\n                 &*self.codegen_backend().metadata_loader(),\n                 self.compiler.register_lints.as_deref().unwrap_or_else(|| empty),\n-                krate,\n+                &pre_configured_attrs,\n                 crate_name,\n             )?;\n \n@@ -154,17 +175,17 @@ impl<'tcx> Queries<'tcx> {\n             // called, which happens within passes::register_plugins().\n             self.dep_graph_future().ok();\n \n-            Ok((krate, Lrc::new(lint_store)))\n+            Ok((krate, pre_configured_attrs, Lrc::new(lint_store)))\n         })\n     }\n \n     fn crate_name(&self) -> Result<QueryResult<'_, Symbol>> {\n         self.crate_name.compute(|| {\n             Ok({\n-                let parse_result = self.parse()?;\n-                let krate = parse_result.borrow();\n+                let pre_configure_result = self.pre_configure()?;\n+                let (_, pre_configured_attrs) = &*pre_configure_result.borrow();\n                 // parse `#[crate_name]` even if `--crate-name` was passed, to make sure it matches.\n-                find_crate_name(self.session(), &krate.attrs)\n+                find_crate_name(self.session(), pre_configured_attrs)\n             })\n         })\n     }\n@@ -188,7 +209,7 @@ impl<'tcx> Queries<'tcx> {\n     pub fn global_ctxt(&'tcx self) -> Result<QueryResult<'_, &'tcx GlobalCtxt<'tcx>>> {\n         self.gcx.compute(|| {\n             let crate_name = *self.crate_name()?.borrow();\n-            let (krate, lint_store) = self.register_plugins()?.steal();\n+            let (krate, pre_configured_attrs, lint_store) = self.register_plugins()?.steal();\n \n             let sess = self.session();\n \n@@ -215,7 +236,7 @@ impl<'tcx> Queries<'tcx> {\n                 feed.crate_name(crate_name);\n \n                 let feed = tcx.feed_unit_query();\n-                feed.crate_for_resolver(tcx.arena.alloc(Steal::new(krate)));\n+                feed.crate_for_resolver(tcx.arena.alloc(Steal::new((krate, pre_configured_attrs))));\n                 feed.metadata_loader(\n                     tcx.arena.alloc(Steal::new(self.codegen_backend().metadata_loader())),\n                 );"}, {"sha": "9b0d8d6c0723b7bbc173736ee71ea6c283f033df", "filename": "compiler/rustc_lint/src/early.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/df7fd9995f10627f25ccb325f693a11b3395a73c/compiler%2Frustc_lint%2Fsrc%2Fearly.rs", "raw_url": "https://github.com/rust-lang/rust/raw/df7fd9995f10627f25ccb325f693a11b3395a73c/compiler%2Frustc_lint%2Fsrc%2Fearly.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_lint%2Fsrc%2Fearly.rs?ref=df7fd9995f10627f25ccb325f693a11b3395a73c", "patch": "@@ -341,23 +341,23 @@ pub trait EarlyCheckNode<'a>: Copy {\n         'a: 'b;\n }\n \n-impl<'a> EarlyCheckNode<'a> for &'a ast::Crate {\n+impl<'a> EarlyCheckNode<'a> for (&'a ast::Crate, &'a [ast::Attribute]) {\n     fn id(self) -> ast::NodeId {\n         ast::CRATE_NODE_ID\n     }\n     fn attrs<'b>(self) -> &'b [ast::Attribute]\n     where\n         'a: 'b,\n     {\n-        &self.attrs\n+        &self.1\n     }\n     fn check<'b, T: EarlyLintPass>(self, cx: &mut EarlyContextAndPass<'b, T>)\n     where\n         'a: 'b,\n     {\n-        lint_callback!(cx, check_crate, self);\n-        ast_visit::walk_crate(cx, self);\n-        lint_callback!(cx, check_crate_post, self);\n+        lint_callback!(cx, check_crate, self.0);\n+        ast_visit::walk_crate(cx, self.0);\n+        lint_callback!(cx, check_crate_post, self.0);\n     }\n }\n "}, {"sha": "9f16ecbdaa9334373dbddfc7eace93d48b490a5d", "filename": "compiler/rustc_middle/src/arena.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/df7fd9995f10627f25ccb325f693a11b3395a73c/compiler%2Frustc_middle%2Fsrc%2Farena.rs", "raw_url": "https://github.com/rust-lang/rust/raw/df7fd9995f10627f25ccb325f693a11b3395a73c/compiler%2Frustc_middle%2Fsrc%2Farena.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Farena.rs?ref=df7fd9995f10627f25ccb325f693a11b3395a73c", "patch": "@@ -36,7 +36,7 @@ macro_rules! arena_types {\n             )>,\n             [] output_filenames: std::sync::Arc<rustc_session::config::OutputFilenames>,\n             [] metadata_loader: rustc_data_structures::steal::Steal<Box<rustc_session::cstore::MetadataLoaderDyn>>,\n-            [] crate_for_resolver: rustc_data_structures::steal::Steal<rustc_ast::ast::Crate>,\n+            [] crate_for_resolver: rustc_data_structures::steal::Steal<(rustc_ast::Crate, rustc_ast::AttrVec)>,\n             [] resolutions: rustc_middle::ty::ResolverGlobalCtxt,\n             [decode] unsafety_check_result: rustc_middle::mir::UnsafetyCheckResult,\n             [decode] code_region: rustc_middle::mir::coverage::CodeRegion,"}, {"sha": "9203dd59a7e6382f78413c853605cbbd227af3a8", "filename": "compiler/rustc_middle/src/query/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/df7fd9995f10627f25ccb325f693a11b3395a73c/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/df7fd9995f10627f25ccb325f693a11b3395a73c/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs?ref=df7fd9995f10627f25ccb325f693a11b3395a73c", "patch": "@@ -2116,7 +2116,7 @@ rustc_queries! {\n         desc { \"raw operations for metadata file access\" }\n     }\n \n-    query crate_for_resolver((): ()) -> &'tcx Steal<rustc_ast::ast::Crate> {\n+    query crate_for_resolver((): ()) -> &'tcx Steal<(rustc_ast::Crate, rustc_ast::AttrVec)> {\n         feedable\n         no_hash\n         desc { \"the ast before macro expansion and name resolution\" }"}, {"sha": "27e5cb9f0d014fbb4b1146bb24d9e12f57262730", "filename": "compiler/rustc_plugin_impl/src/load.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/df7fd9995f10627f25ccb325f693a11b3395a73c/compiler%2Frustc_plugin_impl%2Fsrc%2Fload.rs", "raw_url": "https://github.com/rust-lang/rust/raw/df7fd9995f10627f25ccb325f693a11b3395a73c/compiler%2Frustc_plugin_impl%2Fsrc%2Fload.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_plugin_impl%2Fsrc%2Fload.rs?ref=df7fd9995f10627f25ccb325f693a11b3395a73c", "patch": "@@ -3,7 +3,7 @@\n use crate::errors::{LoadPluginError, MalformedPluginAttribute};\n use crate::Registry;\n use libloading::Library;\n-use rustc_ast::Crate;\n+use rustc_ast::Attribute;\n use rustc_metadata::locator;\n use rustc_session::cstore::MetadataLoader;\n use rustc_session::Session;\n@@ -20,11 +20,11 @@ type PluginRegistrarFn = fn(&mut Registry<'_>);\n pub fn load_plugins(\n     sess: &Session,\n     metadata_loader: &dyn MetadataLoader,\n-    krate: &Crate,\n+    attrs: &[Attribute],\n ) -> Vec<PluginRegistrarFn> {\n     let mut plugins = Vec::new();\n \n-    for attr in &krate.attrs {\n+    for attr in attrs {\n         if !attr.has_name(sym::plugin) {\n             continue;\n         }"}, {"sha": "aa50699890ccc485d8dd001f8d1080e90a2fa360", "filename": "compiler/rustc_resolve/src/lib.rs", "status": "modified", "additions": 6, "deletions": 5, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/df7fd9995f10627f25ccb325f693a11b3395a73c/compiler%2Frustc_resolve%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/df7fd9995f10627f25ccb325f693a11b3395a73c/compiler%2Frustc_resolve%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Flib.rs?ref=df7fd9995f10627f25ccb325f693a11b3395a73c", "patch": "@@ -1180,7 +1180,8 @@ impl<'tcx> Resolver<'_, 'tcx> {\n impl<'a, 'tcx> Resolver<'a, 'tcx> {\n     pub fn new(\n         tcx: TyCtxt<'tcx>,\n-        krate: &Crate,\n+        attrs: &[ast::Attribute],\n+        crate_span: Span,\n         arenas: &'a ResolverArenas<'a>,\n     ) -> Resolver<'a, 'tcx> {\n         let root_def_id = CRATE_DEF_ID.to_def_id();\n@@ -1189,8 +1190,8 @@ impl<'a, 'tcx> Resolver<'a, 'tcx> {\n             None,\n             ModuleKind::Def(DefKind::Mod, root_def_id, kw::Empty),\n             ExpnId::root(),\n-            krate.spans.inner_span,\n-            attr::contains_name(&krate.attrs, sym::no_implicit_prelude),\n+            crate_span,\n+            attr::contains_name(attrs, sym::no_implicit_prelude),\n             &mut module_map,\n         );\n         let empty_module = arenas.new_module(\n@@ -1222,9 +1223,9 @@ impl<'a, 'tcx> Resolver<'a, 'tcx> {\n             .map(|(name, _)| (Ident::from_str(name), Default::default()))\n             .collect();\n \n-        if !attr::contains_name(&krate.attrs, sym::no_core) {\n+        if !attr::contains_name(attrs, sym::no_core) {\n             extern_prelude.insert(Ident::with_dummy_span(sym::core), Default::default());\n-            if !attr::contains_name(&krate.attrs, sym::no_std) {\n+            if !attr::contains_name(attrs, sym::no_std) {\n                 extern_prelude.insert(Ident::with_dummy_span(sym::std), Default::default());\n             }\n         }"}, {"sha": "48707d37a101cd38971673889d9b1577b38a9476", "filename": "compiler/rustc_resolve/src/macros.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/df7fd9995f10627f25ccb325f693a11b3395a73c/compiler%2Frustc_resolve%2Fsrc%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/df7fd9995f10627f25ccb325f693a11b3395a73c/compiler%2Frustc_resolve%2Fsrc%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Fmacros.rs?ref=df7fd9995f10627f25ccb325f693a11b3395a73c", "patch": "@@ -112,8 +112,8 @@ fn fast_print_path(path: &ast::Path) -> Symbol {\n \n pub(crate) fn registered_tools(tcx: TyCtxt<'_>, (): ()) -> RegisteredTools {\n     let mut registered_tools = RegisteredTools::default();\n-    let krate = tcx.crate_for_resolver(()).borrow();\n-    for attr in attr::filter_by_name(&krate.attrs, sym::register_tool) {\n+    let (_, pre_configured_attrs) = &*tcx.crate_for_resolver(()).borrow();\n+    for attr in attr::filter_by_name(pre_configured_attrs, sym::register_tool) {\n         for nested_meta in attr.meta_item_list().unwrap_or_default() {\n             match nested_meta.ident() {\n                 Some(ident) => {"}, {"sha": "3c011d72b02c510f7dfb4b5946c88b1b4b1742b6", "filename": "tests/ui/cfg/auxiliary/cfg_false_lib.rs", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/df7fd9995f10627f25ccb325f693a11b3395a73c/tests%2Fui%2Fcfg%2Fauxiliary%2Fcfg_false_lib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/df7fd9995f10627f25ccb325f693a11b3395a73c/tests%2Fui%2Fcfg%2Fauxiliary%2Fcfg_false_lib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcfg%2Fauxiliary%2Fcfg_false_lib.rs?ref=df7fd9995f10627f25ccb325f693a11b3395a73c", "patch": "@@ -0,0 +1,6 @@\n+// It is unclear whether a fully unconfigured crate should link to standard library,\n+// or what its `no_std`/`no_core`/`compiler_builtins` status, more precisely.\n+// Currently the usual standard library prelude is added to such crates,\n+// and therefore they link to libstd.\n+\n+#![cfg(FALSE)]"}, {"sha": "21ea3ec79b4d61b92df102a11904e05389e1d6fe", "filename": "tests/ui/cfg/cfg-false-feature.rs", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/df7fd9995f10627f25ccb325f693a11b3395a73c/tests%2Fui%2Fcfg%2Fcfg-false-feature.rs", "raw_url": "https://github.com/rust-lang/rust/raw/df7fd9995f10627f25ccb325f693a11b3395a73c/tests%2Fui%2Fcfg%2Fcfg-false-feature.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcfg%2Fcfg-false-feature.rs?ref=df7fd9995f10627f25ccb325f693a11b3395a73c", "patch": "@@ -0,0 +1,20 @@\n+// It is unclear which features should be in effect in a fully unconfigured crate (issue #104633).\n+// Currently none on the features are in effect, so we get the feature gates reported.\n+\n+// check-pass\n+// compile-flags: --crate-type lib\n+\n+#![feature(decl_macro)]\n+#![cfg(FALSE)]\n+#![feature(box_syntax)]\n+\n+macro mac() {} //~ WARN `macro` is experimental\n+               //~| WARN unstable syntax can change at any point in the future\n+\n+trait A = Clone; //~ WARN trait aliases are experimental\n+                 //~| WARN unstable syntax can change at any point in the future\n+\n+fn main() {\n+    let box _ = Box::new(0); //~ WARN box pattern syntax is experimental\n+                             //~| WARN unstable syntax can change at any point in the future\n+}"}, {"sha": "14673fbdb14447e437eda43707ee9671bc222445", "filename": "tests/ui/cfg/cfg-false-feature.stderr", "status": "added", "additions": 35, "deletions": 0, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/df7fd9995f10627f25ccb325f693a11b3395a73c/tests%2Fui%2Fcfg%2Fcfg-false-feature.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/df7fd9995f10627f25ccb325f693a11b3395a73c/tests%2Fui%2Fcfg%2Fcfg-false-feature.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcfg%2Fcfg-false-feature.stderr?ref=df7fd9995f10627f25ccb325f693a11b3395a73c", "patch": "@@ -0,0 +1,35 @@\n+warning: trait aliases are experimental\n+  --> $DIR/cfg-false-feature.rs:14:1\n+   |\n+LL | trait A = Clone;\n+   | ^^^^^^^^^^^^^^^^\n+   |\n+   = note: see issue #41517 <https://github.com/rust-lang/rust/issues/41517> for more information\n+   = help: add `#![feature(trait_alias)]` to the crate attributes to enable\n+   = warning: unstable syntax can change at any point in the future, causing a hard error!\n+   = note: for more information, see issue #65860 <https://github.com/rust-lang/rust/issues/65860>\n+\n+warning: `macro` is experimental\n+  --> $DIR/cfg-false-feature.rs:11:1\n+   |\n+LL | macro mac() {}\n+   | ^^^^^^^^^^^^^^\n+   |\n+   = note: see issue #39412 <https://github.com/rust-lang/rust/issues/39412> for more information\n+   = help: add `#![feature(decl_macro)]` to the crate attributes to enable\n+   = warning: unstable syntax can change at any point in the future, causing a hard error!\n+   = note: for more information, see issue #65860 <https://github.com/rust-lang/rust/issues/65860>\n+\n+warning: box pattern syntax is experimental\n+  --> $DIR/cfg-false-feature.rs:18:9\n+   |\n+LL |     let box _ = Box::new(0);\n+   |         ^^^^^\n+   |\n+   = note: see issue #29641 <https://github.com/rust-lang/rust/issues/29641> for more information\n+   = help: add `#![feature(box_patterns)]` to the crate attributes to enable\n+   = warning: unstable syntax can change at any point in the future, causing a hard error!\n+   = note: for more information, see issue #65860 <https://github.com/rust-lang/rust/issues/65860>\n+\n+warning: 3 warnings emitted\n+"}, {"sha": "319ea078187c2d7bf8416ac152c1cb6d6fb24708", "filename": "tests/ui/cfg/cfg_false_no_std.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/df7fd9995f10627f25ccb325f693a11b3395a73c/tests%2Fui%2Fcfg%2Fcfg_false_no_std.rs", "raw_url": "https://github.com/rust-lang/rust/raw/df7fd9995f10627f25ccb325f693a11b3395a73c/tests%2Fui%2Fcfg%2Fcfg_false_no_std.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcfg%2Fcfg_false_no_std.rs?ref=df7fd9995f10627f25ccb325f693a11b3395a73c", "patch": "@@ -0,0 +1,11 @@\n+// Currently no error because the panic handler is supplied by libstd linked though the empty\n+// library, but the desirable behavior is unclear (see comments in cfg_false_lib.rs).\n+\n+// check-pass\n+// aux-build: cfg_false_lib.rs\n+\n+#![no_std]\n+\n+extern crate cfg_false_lib as _;\n+\n+fn main() {}"}]}