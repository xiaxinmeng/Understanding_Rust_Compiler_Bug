{"sha": "36fa12f1a4c638f4d48462bfe94721b1b843004a", "node_id": "C_kwDOAAsO6NoAKDM2ZmExMmYxYTRjNjM4ZjRkNDg0NjJiZmU5NDcyMWIxYjg0MzAwNGE", "commit": {"author": {"name": "Santiago Pastorino", "email": "spastorino@gmail.com", "date": "2022-08-18T17:26:59Z"}, "committer": {"name": "Santiago Pastorino", "email": "spastorino@gmail.com", "date": "2022-09-07T21:01:01Z"}, "message": "Allow lower_lifetime_binder receive a closure", "tree": {"sha": "4541d2b708d7f36ece1685285b079dfa26d4ed8d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4541d2b708d7f36ece1685285b079dfa26d4ed8d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/36fa12f1a4c638f4d48462bfe94721b1b843004a", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEF0ntrgrd9qf9uuThgTGiTgx5768FAmMZBo4ACgkQgTGiTgx5\n768eCQ/8D3seeqpohDGLy/58mn18eXWWxVIxHXQxsaN5CWxz9Det0Ye0tZfor51M\nbVm98oeV/1xMqMAOc1We4DZfS+8j/g4GxZKSqcHeqAM/HK6d5vm1f1G4Mm+NoGXa\n6tmQo5lxuFE311dzjbZZACk4bYUfiDJb3Dmd9cxsgj3XFtvClTJf3xfmPX9MqhKo\n3t9Wg5A3UkuTs6T7fDPMfV9favlCwM3AtB0asBYYA3SaiiFy7KrL5qIiFSVrvL9n\nEXF5OCMnmt4tvOyG9UC7XeaeyAAWlvt0+NfuJ6F4Wo7HpEf3w1cg7VGw1hGb+jBk\nHxc5rOgfJQH0O577DQ/Tf/Vr/JJO+KWVjbT7tQjvV5WRKQw3QE2cpEV2J1JyMrxS\nREdk7ZkLIlBl5HPp5tWaGxVNXed8y8cc2HwJDdPqzjVLM/dWDYQHoB4NH/65Y8Lj\nMQGbfzuJ+IzVr5LHcl5dmTYQgCj2f1UM37BQI51ez5CCu4rqt4MRGI+EAU6J2AaT\n9EM5zrDwmNtj3iWNOWmt8/QVnQKw7wivNh8wXLENZZ+ysReoDGxuEDzU8Txz/IYB\ntDDKMLTgi/4/I9A+jhkxEmky0dnc9wJY9TqaSbkex0Xw3joxPuu7C8fon8VCnyY1\nXZMNs6HQxp6wwxdDBQtreEcRrWLJhi1jH2ddLW+oa/QCcbMu4uY=\n=OIC2\n-----END PGP SIGNATURE-----", "payload": "tree 4541d2b708d7f36ece1685285b079dfa26d4ed8d\nparent 3c7278846102bb829c9a789e91bc43f0ed612943\nauthor Santiago Pastorino <spastorino@gmail.com> 1660843619 -0300\ncommitter Santiago Pastorino <spastorino@gmail.com> 1662584461 -0300\n\nAllow lower_lifetime_binder receive a closure\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/36fa12f1a4c638f4d48462bfe94721b1b843004a", "html_url": "https://github.com/rust-lang/rust/commit/36fa12f1a4c638f4d48462bfe94721b1b843004a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/36fa12f1a4c638f4d48462bfe94721b1b843004a/comments", "author": {"login": "spastorino", "id": 52642, "node_id": "MDQ6VXNlcjUyNjQy", "avatar_url": "https://avatars.githubusercontent.com/u/52642?v=4", "gravatar_id": "", "url": "https://api.github.com/users/spastorino", "html_url": "https://github.com/spastorino", "followers_url": "https://api.github.com/users/spastorino/followers", "following_url": "https://api.github.com/users/spastorino/following{/other_user}", "gists_url": "https://api.github.com/users/spastorino/gists{/gist_id}", "starred_url": "https://api.github.com/users/spastorino/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/spastorino/subscriptions", "organizations_url": "https://api.github.com/users/spastorino/orgs", "repos_url": "https://api.github.com/users/spastorino/repos", "events_url": "https://api.github.com/users/spastorino/events{/privacy}", "received_events_url": "https://api.github.com/users/spastorino/received_events", "type": "User", "site_admin": false}, "committer": {"login": "spastorino", "id": 52642, "node_id": "MDQ6VXNlcjUyNjQy", "avatar_url": "https://avatars.githubusercontent.com/u/52642?v=4", "gravatar_id": "", "url": "https://api.github.com/users/spastorino", "html_url": "https://github.com/spastorino", "followers_url": "https://api.github.com/users/spastorino/followers", "following_url": "https://api.github.com/users/spastorino/following{/other_user}", "gists_url": "https://api.github.com/users/spastorino/gists{/gist_id}", "starred_url": "https://api.github.com/users/spastorino/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/spastorino/subscriptions", "organizations_url": "https://api.github.com/users/spastorino/orgs", "repos_url": "https://api.github.com/users/spastorino/repos", "events_url": "https://api.github.com/users/spastorino/events{/privacy}", "received_events_url": "https://api.github.com/users/spastorino/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3c7278846102bb829c9a789e91bc43f0ed612943", "url": "https://api.github.com/repos/rust-lang/rust/commits/3c7278846102bb829c9a789e91bc43f0ed612943", "html_url": "https://github.com/rust-lang/rust/commit/3c7278846102bb829c9a789e91bc43f0ed612943"}], "stats": {"total": 116, "additions": 65, "deletions": 51}, "files": [{"sha": "89655eafea92da12f522eae2b11c177ca1e1ea10", "filename": "compiler/rustc_ast_lowering/src/expr.rs", "status": "modified", "additions": 32, "deletions": 31, "changes": 63, "blob_url": "https://github.com/rust-lang/rust/blob/36fa12f1a4c638f4d48462bfe94721b1b843004a/compiler%2Frustc_ast_lowering%2Fsrc%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/36fa12f1a4c638f4d48462bfe94721b1b843004a/compiler%2Frustc_ast_lowering%2Fsrc%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast_lowering%2Fsrc%2Fexpr.rs?ref=36fa12f1a4c638f4d48462bfe94721b1b843004a", "patch": "@@ -847,21 +847,22 @@ impl<'hir> LoweringContext<'_, 'hir> {\n             (body_id, generator_option)\n         });\n \n-        let bound_generic_params = self.lower_lifetime_binder(closure_id, generic_params);\n-        // Lower outside new scope to preserve `is_in_loop_condition`.\n-        let fn_decl = self.lower_fn_decl(decl, None, FnDeclKind::Closure, None);\n-\n-        let c = self.arena.alloc(hir::Closure {\n-            binder: binder_clause,\n-            capture_clause,\n-            bound_generic_params,\n-            fn_decl,\n-            body: body_id,\n-            fn_decl_span: self.lower_span(fn_decl_span),\n-            movability: generator_option,\n-        });\n+        self.lower_lifetime_binder(closure_id, generic_params, |lctx, bound_generic_params| {\n+            // Lower outside new scope to preserve `is_in_loop_condition`.\n+            let fn_decl = lctx.lower_fn_decl(decl, None, FnDeclKind::Closure, None);\n+\n+            let c = lctx.arena.alloc(hir::Closure {\n+                binder: binder_clause,\n+                capture_clause,\n+                bound_generic_params,\n+                fn_decl,\n+                body: body_id,\n+                fn_decl_span: lctx.lower_span(fn_decl_span),\n+                movability: generator_option,\n+            });\n \n-        hir::ExprKind::Closure(c)\n+            hir::ExprKind::Closure(c)\n+        })\n     }\n \n     fn generator_movability_for_fn(\n@@ -948,23 +949,23 @@ impl<'hir> LoweringContext<'_, 'hir> {\n             body_id\n         });\n \n-        let bound_generic_params = self.lower_lifetime_binder(closure_id, generic_params);\n-\n-        // We need to lower the declaration outside the new scope, because we\n-        // have to conserve the state of being inside a loop condition for the\n-        // closure argument types.\n-        let fn_decl = self.lower_fn_decl(&outer_decl, None, FnDeclKind::Closure, None);\n-\n-        let c = self.arena.alloc(hir::Closure {\n-            binder: binder_clause,\n-            capture_clause,\n-            bound_generic_params,\n-            fn_decl,\n-            body,\n-            fn_decl_span: self.lower_span(fn_decl_span),\n-            movability: None,\n-        });\n-        hir::ExprKind::Closure(c)\n+        self.lower_lifetime_binder(closure_id, generic_params, |lctx, bound_generic_params| {\n+            // We need to lower the declaration outside the new scope, because we\n+            // have to conserve the state of being inside a loop condition for the\n+            // closure argument types.\n+            let fn_decl = lctx.lower_fn_decl(&outer_decl, None, FnDeclKind::Closure, None);\n+\n+            let c = lctx.arena.alloc(hir::Closure {\n+                binder: binder_clause,\n+                capture_clause,\n+                bound_generic_params,\n+                fn_decl,\n+                body,\n+                fn_decl_span: lctx.lower_span(fn_decl_span),\n+                movability: None,\n+            });\n+            hir::ExprKind::Closure(c)\n+        })\n     }\n \n     /// Destructure the LHS of complex assignments."}, {"sha": "b8becd9b149c63851a062b522fc2f2d1d8063bca", "filename": "compiler/rustc_ast_lowering/src/lib.rs", "status": "modified", "additions": 33, "deletions": 20, "changes": 53, "blob_url": "https://github.com/rust-lang/rust/blob/36fa12f1a4c638f4d48462bfe94721b1b843004a/compiler%2Frustc_ast_lowering%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/36fa12f1a4c638f4d48462bfe94721b1b843004a/compiler%2Frustc_ast_lowering%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast_lowering%2Fsrc%2Flib.rs?ref=36fa12f1a4c638f4d48462bfe94721b1b843004a", "patch": "@@ -808,23 +808,31 @@ impl<'a, 'hir> LoweringContext<'a, 'hir> {\n     /// name resolver owing to lifetime elision; this also populates the resolver's node-id->def-id\n     /// map, so that later calls to `opt_node_id_to_def_id` that refer to these extra lifetime\n     /// parameters will be successful.\n-    #[instrument(level = \"debug\", skip(self))]\n+    #[instrument(level = \"debug\", skip(self, in_binder))]\n     #[inline]\n-    fn lower_lifetime_binder(\n+    fn lower_lifetime_binder<R>(\n         &mut self,\n         binder: NodeId,\n         generic_params: &[GenericParam],\n-    ) -> &'hir [hir::GenericParam<'hir>] {\n-        let mut generic_params: Vec<_> = self.lower_generic_params_mut(generic_params).collect();\n+        in_binder: impl FnOnce(&mut Self, &'hir [hir::GenericParam<'hir>]) -> R,\n+    ) -> R {\n         let extra_lifetimes = self.resolver.take_extra_lifetime_params(binder);\n         debug!(?extra_lifetimes);\n-        generic_params.extend(extra_lifetimes.into_iter().filter_map(|(ident, node_id, res)| {\n-            self.lifetime_res_to_generic_param(ident, node_id, res)\n-        }));\n+        let extra_lifetimes: Vec<_> = extra_lifetimes\n+            .into_iter()\n+            .filter_map(|(ident, node_id, res)| {\n+                self.lifetime_res_to_generic_param(ident, node_id, res)\n+            })\n+            .collect();\n+\n+        let generic_params: Vec<_> = self\n+            .lower_generic_params_mut(generic_params)\n+            .chain(extra_lifetimes.into_iter())\n+            .collect();\n         let generic_params = self.arena.alloc_from_iter(generic_params);\n         debug!(?generic_params);\n \n-        generic_params\n+        in_binder(self, generic_params)\n     }\n \n     fn with_dyn_type_scope<T>(&mut self, in_scope: bool, f: impl FnOnce(&mut Self) -> T) -> T {\n@@ -1233,14 +1241,15 @@ impl<'a, 'hir> LoweringContext<'a, 'hir> {\n                 hir::TyKind::Rptr(lifetime, self.lower_mt(mt, itctx))\n             }\n             TyKind::BareFn(ref f) => {\n-                let generic_params = self.lower_lifetime_binder(t.id, &f.generic_params);\n-                hir::TyKind::BareFn(self.arena.alloc(hir::BareFnTy {\n-                    generic_params,\n-                    unsafety: self.lower_unsafety(f.unsafety),\n-                    abi: self.lower_extern(f.ext),\n-                    decl: self.lower_fn_decl(&f.decl, None, FnDeclKind::Pointer, None),\n-                    param_names: self.lower_fn_params_to_names(&f.decl),\n-                }))\n+                self.lower_lifetime_binder(t.id, &f.generic_params, |lctx, generic_params| {\n+                    hir::TyKind::BareFn(lctx.arena.alloc(hir::BareFnTy {\n+                        generic_params,\n+                        unsafety: lctx.lower_unsafety(f.unsafety),\n+                        abi: lctx.lower_extern(f.ext),\n+                        decl: lctx.lower_fn_decl(&f.decl, None, FnDeclKind::Pointer, None),\n+                        param_names: lctx.lower_fn_params_to_names(&f.decl),\n+                    }))\n+                })\n             }\n             TyKind::Never => hir::TyKind::Never,\n             TyKind::Tup(ref tys) => hir::TyKind::Tup(\n@@ -2133,10 +2142,14 @@ impl<'a, 'hir> LoweringContext<'a, 'hir> {\n         p: &PolyTraitRef,\n         itctx: ImplTraitContext,\n     ) -> hir::PolyTraitRef<'hir> {\n-        let bound_generic_params =\n-            self.lower_lifetime_binder(p.trait_ref.ref_id, &p.bound_generic_params);\n-        let trait_ref = self.lower_trait_ref(&p.trait_ref, itctx);\n-        hir::PolyTraitRef { bound_generic_params, trait_ref, span: self.lower_span(p.span) }\n+        self.lower_lifetime_binder(\n+            p.trait_ref.ref_id,\n+            &p.bound_generic_params,\n+            |lctx, bound_generic_params| {\n+                let trait_ref = lctx.lower_trait_ref(&p.trait_ref, itctx);\n+                hir::PolyTraitRef { bound_generic_params, trait_ref, span: lctx.lower_span(p.span) }\n+            },\n+        )\n     }\n \n     fn lower_mt(&mut self, mt: &MutTy, itctx: ImplTraitContext) -> hir::MutTy<'hir> {"}]}