{"sha": "b9b0732d2a8bfed04d3102706f8d03ad5709b4a0", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI5YjA3MzJkMmE4YmZlZDA0ZDMxMDI3MDZmOGQwM2FkNTcwOWI0YTA=", "commit": {"author": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2017-01-09T15:13:28Z"}, "committer": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2017-01-09T18:44:41Z"}, "message": "Make unions never have needs_drop", "tree": {"sha": "d65a543887b817969802be036e0bc8153100e0d6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d65a543887b817969802be036e0bc8153100e0d6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b9b0732d2a8bfed04d3102706f8d03ad5709b4a0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b9b0732d2a8bfed04d3102706f8d03ad5709b4a0", "html_url": "https://github.com/rust-lang/rust/commit/b9b0732d2a8bfed04d3102706f8d03ad5709b4a0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b9b0732d2a8bfed04d3102706f8d03ad5709b4a0/comments", "author": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d2c795932b58d910c179236d1070e04e8cb54faf", "url": "https://api.github.com/repos/rust-lang/rust/commits/d2c795932b58d910c179236d1070e04e8cb54faf", "html_url": "https://github.com/rust-lang/rust/commit/d2c795932b58d910c179236d1070e04e8cb54faf"}], "stats": {"total": 68, "additions": 68, "deletions": 0}, "files": [{"sha": "ed5b470849c41f4ef948c095443cee2ba0e974f2", "filename": "src/librustc/ty/contents.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/b9b0732d2a8bfed04d3102706f8d03ad5709b4a0/src%2Flibrustc%2Fty%2Fcontents.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b9b0732d2a8bfed04d3102706f8d03ad5709b4a0/src%2Flibrustc%2Fty%2Fcontents.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fcontents.rs?ref=b9b0732d2a8bfed04d3102706f8d03ad5709b4a0", "patch": "@@ -235,6 +235,11 @@ impl<'a, 'tcx> ty::TyS<'tcx> {\n                             })\n                         });\n \n+                    if def.is_union() {\n+                        // unions don't have destructors regardless of the child types\n+                        res = res - TC::NeedsDrop;\n+                    }\n+\n                     if def.has_dtor() {\n                         res = res | TC::OwnsDtor;\n                     }"}, {"sha": "22f00be3066dcbeb81f0011715542b20e723a55d", "filename": "src/test/run-pass/union/union-nodrop.rs", "status": "added", "additions": 63, "deletions": 0, "changes": 63, "blob_url": "https://github.com/rust-lang/rust/blob/b9b0732d2a8bfed04d3102706f8d03ad5709b4a0/src%2Ftest%2Frun-pass%2Funion%2Funion-nodrop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b9b0732d2a8bfed04d3102706f8d03ad5709b4a0/src%2Ftest%2Frun-pass%2Funion%2Funion-nodrop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Funion%2Funion-nodrop.rs?ref=b9b0732d2a8bfed04d3102706f8d03ad5709b4a0", "patch": "@@ -0,0 +1,63 @@\n+// Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![feature(core_intrinsics)]\n+#![feature(untagged_unions)]\n+\n+#![allow(unions_with_drop_fields)]\n+#![allow(dead_code)]\n+\n+use std::intrinsics::needs_drop;\n+\n+// drop types in destructors should not require\n+// drop_types_in_const\n+static X: Option<NoDrop<Box<u8>>> = None;\n+\n+// A union that scrubs the drop glue from its inner type\n+union NoDrop<T> {inner: T}\n+\n+// Copy currently can't be implemented on drop-containing unions,\n+// this may change later\n+// https://github.com/rust-lang/rust/pull/38934#issuecomment-271219289\n+\n+// // We should be able to implement Copy for NoDrop\n+// impl<T> Copy for NoDrop<T> {}\n+// impl<T> Clone for NoDrop<T> {fn clone(&self) -> Self { *self }}\n+\n+// // We should be able to implement Copy for things using NoDrop\n+// #[derive(Copy, Clone)]\n+struct Foo {\n+    x: NoDrop<Box<u8>>\n+}\n+\n+struct Baz {\n+    x: NoDrop<Box<u8>>,\n+    y: Box<u8>,\n+}\n+\n+union ActuallyDrop<T> {inner: T}\n+\n+impl<T> Drop for ActuallyDrop<T> {\n+    fn drop(&mut self) {}\n+}\n+\n+fn main() {\n+    unsafe {\n+        // NoDrop should not make needs_drop true\n+        assert!(!needs_drop::<Foo>());\n+        assert!(!needs_drop::<NoDrop<u8>>());\n+        assert!(!needs_drop::<NoDrop<Box<u8>>>());\n+        // presence of other drop types should still work\n+        assert!(needs_drop::<Baz>());\n+        // drop impl on union itself should work\n+        assert!(needs_drop::<ActuallyDrop<u8>>());\n+        assert!(needs_drop::<ActuallyDrop<Box<u8>>>());\n+    }\n+}"}]}