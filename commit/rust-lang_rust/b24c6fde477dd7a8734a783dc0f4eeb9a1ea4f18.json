{"sha": "b24c6fde477dd7a8734a783dc0f4eeb9a1ea4f18", "node_id": "MDY6Q29tbWl0NzI0NzEyOmIyNGM2ZmRlNDc3ZGQ3YTg3MzRhNzgzZGMwZjRlZWI5YTFlYTRmMTg=", "commit": {"author": {"name": "Alexis", "email": "a.beingessner@gmail.com", "date": "2015-02-10T18:41:05Z"}, "committer": {"name": "Alexis", "email": "a.beingessner@gmail.com", "date": "2015-02-10T18:41:35Z"}, "message": "fix and macro-ify map benches, fixes #22134", "tree": {"sha": "f82704a95fc9f1c54e5c3b4befe935c2d321bf39", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f82704a95fc9f1c54e5c3b4befe935c2d321bf39"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b24c6fde477dd7a8734a783dc0f4eeb9a1ea4f18", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b24c6fde477dd7a8734a783dc0f4eeb9a1ea4f18", "html_url": "https://github.com/rust-lang/rust/commit/b24c6fde477dd7a8734a783dc0f4eeb9a1ea4f18", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b24c6fde477dd7a8734a783dc0f4eeb9a1ea4f18/comments", "author": {"login": "Gankra", "id": 1136864, "node_id": "MDQ6VXNlcjExMzY4NjQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1136864?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Gankra", "html_url": "https://github.com/Gankra", "followers_url": "https://api.github.com/users/Gankra/followers", "following_url": "https://api.github.com/users/Gankra/following{/other_user}", "gists_url": "https://api.github.com/users/Gankra/gists{/gist_id}", "starred_url": "https://api.github.com/users/Gankra/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Gankra/subscriptions", "organizations_url": "https://api.github.com/users/Gankra/orgs", "repos_url": "https://api.github.com/users/Gankra/repos", "events_url": "https://api.github.com/users/Gankra/events{/privacy}", "received_events_url": "https://api.github.com/users/Gankra/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Gankra", "id": 1136864, "node_id": "MDQ6VXNlcjExMzY4NjQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1136864?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Gankra", "html_url": "https://github.com/Gankra", "followers_url": "https://api.github.com/users/Gankra/followers", "following_url": "https://api.github.com/users/Gankra/following{/other_user}", "gists_url": "https://api.github.com/users/Gankra/gists{/gist_id}", "starred_url": "https://api.github.com/users/Gankra/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Gankra/subscriptions", "organizations_url": "https://api.github.com/users/Gankra/orgs", "repos_url": "https://api.github.com/users/Gankra/repos", "events_url": "https://api.github.com/users/Gankra/events{/privacy}", "received_events_url": "https://api.github.com/users/Gankra/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "88d8ba5ab3b1d22288b021708c3d87464e43b880", "url": "https://api.github.com/repos/rust-lang/rust/commits/88d8ba5ab3b1d22288b021708c3d87464e43b880", "html_url": "https://github.com/rust-lang/rust/commit/88d8ba5ab3b1d22288b021708c3d87464e43b880"}], "stats": {"total": 343, "additions": 120, "deletions": 223}, "files": [{"sha": "b59799b49971f45e1075682ea4b8acc717f20179", "filename": "src/libcollections/bench.rs", "status": "modified", "additions": 103, "deletions": 93, "changes": 196, "blob_url": "https://github.com/rust-lang/rust/blob/b24c6fde477dd7a8734a783dc0f4eeb9a1ea4f18/src%2Flibcollections%2Fbench.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b24c6fde477dd7a8734a783dc0f4eeb9a1ea4f18/src%2Flibcollections%2Fbench.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcollections%2Fbench.rs?ref=b24c6fde477dd7a8734a783dc0f4eeb9a1ea4f18", "patch": "@@ -8,103 +8,113 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n-use prelude::*;\n-use std::rand;\n-use std::rand::Rng;\n-use test::{Bencher, black_box};\n-\n-pub fn insert_rand_n<M, I, R>(n: usize,\n-                              map: &mut M,\n-                              b: &mut Bencher,\n-                              mut insert: I,\n-                              mut remove: R) where\n-    I: FnMut(&mut M, usize),\n-    R: FnMut(&mut M, usize),\n-{\n-    // setup\n-    let mut rng = rand::weak_rng();\n-\n-    for _ in 0..n {\n-        insert(map, rng.gen::<usize>() % n);\n-    }\n-\n-    // measure\n-    b.iter(|| {\n-        let k = rng.gen::<usize>() % n;\n-        insert(map, k);\n-        remove(map, k);\n-    });\n-    black_box(map);\n+macro_rules! map_insert_rand_bench {\n+    ($name: ident, $n: expr, $map: ident) => (\n+        #[bench]\n+        pub fn $name(b: &mut ::test::Bencher) {\n+            use std::rand;\n+            use std::rand::Rng;\n+            use test::black_box;\n+\n+            let n: usize = $n;\n+            let mut map = $map::new();\n+            // setup\n+            let mut rng = rand::weak_rng();\n+\n+            for _ in 0..n {\n+                let i = rng.gen() % n;\n+                map.insert(i, i);\n+            }\n+\n+            // measure\n+            b.iter(|| {\n+                let k = rng.gen() % n;\n+                map.insert(k, k);\n+                map.remove(&k);\n+            });\n+            black_box(map);\n+        }\n+    )\n }\n \n-pub fn insert_seq_n<M, I, R>(n: usize,\n-                             map: &mut M,\n-                             b: &mut Bencher,\n-                             mut insert: I,\n-                             mut remove: R) where\n-    I: FnMut(&mut M, usize),\n-    R: FnMut(&mut M, usize),\n-{\n-    // setup\n-    for i in 0..n {\n-        insert(map, i * 2);\n-    }\n-\n-    // measure\n-    let mut i = 1;\n-    b.iter(|| {\n-        insert(map, i);\n-        remove(map, i);\n-        i = (i + 2) % n;\n-    });\n-    black_box(map);\n+macro_rules! map_insert_seq_bench {\n+    ($name: ident, $n: expr, $map: ident) => (\n+        #[bench]\n+        pub fn $name(b: &mut ::test::Bencher) {\n+            use test::black_box;\n+\n+            let mut map = $map::new();\n+            let n: usize = $n;\n+            // setup\n+            for i in 0..n {\n+                map.insert(i * 2, i * 2);\n+            }\n+\n+            // measure\n+            let mut i = 1;\n+            b.iter(|| {\n+                map.insert(i, i);\n+                map.remove(&i);\n+                i = (i + 2) % n;\n+            });\n+            black_box(map);\n+        }\n+    )\n }\n \n-pub fn find_rand_n<M, T, I, F>(n: usize,\n-                               map: &mut M,\n-                               b: &mut Bencher,\n-                               mut insert: I,\n-                               mut find: F) where\n-    I: FnMut(&mut M, usize),\n-    F: FnMut(&M, usize) -> T,\n-{\n-    // setup\n-    let mut rng = rand::weak_rng();\n-    let mut keys: Vec<_> = (0..n).map(|_| rng.gen::<usize>() % n).collect();\n-\n-    for k in &keys {\n-        insert(map, *k);\n-    }\n-\n-    rng.shuffle(&mut keys);\n-\n-    // measure\n-    let mut i = 0;\n-    b.iter(|| {\n-        let t = find(map, keys[i]);\n-        i = (i + 1) % n;\n-        black_box(t);\n-    })\n+macro_rules! map_find_rand_bench {\n+    ($name: ident, $n: expr, $map: ident) => (\n+        #[bench]\n+        pub fn $name(b: &mut ::test::Bencher) {\n+            use std::rand;\n+            use std::rand::Rng;\n+            use test::black_box;\n+\n+            let mut map = $map::new();\n+            let n: usize = $n;\n+\n+            // setup\n+            let mut rng = rand::weak_rng();\n+            let mut keys: Vec<_> = (0..n).map(|_| rng.gen() % n).collect();\n+\n+            for &k in &keys {\n+                map.insert(k, k);\n+            }\n+\n+            rng.shuffle(&mut keys);\n+\n+            // measure\n+            let mut i = 0;\n+            b.iter(|| {\n+                let t = map.get(&keys[i]);\n+                i = (i + 1) % n;\n+                black_box(t);\n+            })\n+        }\n+    )\n }\n \n-pub fn find_seq_n<M, T, I, F>(n: usize,\n-                              map: &mut M,\n-                              b: &mut Bencher,\n-                              mut insert: I,\n-                              mut find: F) where\n-    I: FnMut(&mut M, usize),\n-    F: FnMut(&M, usize) -> T,\n-{\n-    // setup\n-    for i in 0..n {\n-        insert(map, i);\n-    }\n-\n-    // measure\n-    let mut i = 0;\n-    b.iter(|| {\n-        let x = find(map, i);\n-        i = (i + 1) % n;\n-        black_box(x);\n-    })\n+macro_rules! map_find_seq_bench {\n+    ($name: ident, $n: expr, $map: ident) => (\n+        #[bench]\n+        pub fn $name(b: &mut ::test::Bencher) {\n+            use test::black_box;\n+\n+            let mut map = $map::new();\n+            let n: usize = $n;\n+\n+            // setup\n+            for i in 0..n {\n+                map.insert(i, i);\n+            }\n+\n+            // measure\n+            let mut i = 0;\n+            b.iter(|| {\n+                let x = map.get(&i);\n+                i = (i + 1) % n;\n+                black_box(x);\n+            })\n+        }\n+    )\n }"}, {"sha": "31604bcd5b986c0aea2028747691f39f90569514", "filename": "src/libcollections/btree/map.rs", "status": "modified", "additions": 8, "deletions": 64, "changes": 72, "blob_url": "https://github.com/rust-lang/rust/blob/b24c6fde477dd7a8734a783dc0f4eeb9a1ea4f18/src%2Flibcollections%2Fbtree%2Fmap.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b24c6fde477dd7a8734a783dc0f4eeb9a1ea4f18/src%2Flibcollections%2Fbtree%2Fmap.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcollections%2Fbtree%2Fmap.rs?ref=b24c6fde477dd7a8734a783dc0f4eeb9a1ea4f18", "patch": "@@ -1843,74 +1843,18 @@ mod bench {\n     use test::{Bencher, black_box};\n \n     use super::BTreeMap;\n-    use bench::{insert_rand_n, insert_seq_n, find_rand_n, find_seq_n};\n \n-    #[bench]\n-    pub fn insert_rand_100(b: &mut Bencher) {\n-        let mut m = BTreeMap::new();\n-        insert_rand_n(100, &mut m, b,\n-                      |m, i| { m.insert(i, 1); },\n-                      |m, i| { m.remove(&i); });\n-    }\n-\n-    #[bench]\n-    pub fn insert_rand_10_000(b: &mut Bencher) {\n-        let mut m = BTreeMap::new();\n-        insert_rand_n(10_000, &mut m, b,\n-                      |m, i| { m.insert(i, 1); },\n-                      |m, i| { m.remove(&i); });\n-    }\n-\n-    // Insert seq\n-    #[bench]\n-    pub fn insert_seq_100(b: &mut Bencher) {\n-        let mut m = BTreeMap::new();\n-        insert_seq_n(100, &mut m, b,\n-                     |m, i| { m.insert(i, 1); },\n-                     |m, i| { m.remove(&i); });\n-    }\n-\n-    #[bench]\n-    pub fn insert_seq_10_000(b: &mut Bencher) {\n-        let mut m = BTreeMap::new();\n-        insert_seq_n(10_000, &mut m, b,\n-                     |m, i| { m.insert(i, 1); },\n-                     |m, i| { m.remove(&i); });\n-    }\n+    map_insert_rand_bench!{insert_rand_100,    100,    BTreeMap}\n+    map_insert_rand_bench!{insert_rand_10_000, 10_000, BTreeMap}\n \n-    // Find rand\n-    #[bench]\n-    pub fn find_rand_100(b: &mut Bencher) {\n-        let mut m = BTreeMap::new();\n-        find_rand_n(100, &mut m, b,\n-                    |m, i| { m.insert(i, 1); },\n-                    |m, i| { m.get(&i); });\n-    }\n-\n-    #[bench]\n-    pub fn find_rand_10_000(b: &mut Bencher) {\n-        let mut m = BTreeMap::new();\n-        find_rand_n(10_000, &mut m, b,\n-                    |m, i| { m.insert(i, 1); },\n-                    |m, i| { m.get(&i); });\n-    }\n+    map_insert_seq_bench!{insert_seq_100,    100,    BTreeMap}\n+    map_insert_seq_bench!{insert_seq_10_000, 10_000, BTreeMap}\n \n-    // Find seq\n-    #[bench]\n-    pub fn find_seq_100(b: &mut Bencher) {\n-        let mut m = BTreeMap::new();\n-        find_seq_n(100, &mut m, b,\n-                   |m, i| { m.insert(i, 1); },\n-                   |m, i| { m.get(&i); });\n-    }\n+    map_find_rand_bench!{find_rand_100,    100,    BTreeMap}\n+    map_find_rand_bench!{find_rand_10_000, 10_000, BTreeMap}\n \n-    #[bench]\n-    pub fn find_seq_10_000(b: &mut Bencher) {\n-        let mut m = BTreeMap::new();\n-        find_seq_n(10_000, &mut m, b,\n-                   |m, i| { m.insert(i, 1); },\n-                   |m, i| { m.get(&i); });\n-    }\n+    map_find_seq_bench!{find_seq_100,    100,    BTreeMap}\n+    map_find_seq_bench!{find_seq_10_000, 10_000, BTreeMap}\n \n     fn bench_iter(b: &mut Bencher, size: i32) {\n         let mut map = BTreeMap::<i32, i32>::new();"}, {"sha": "6b7aa2546cc48f0143e22f74747707e558d24a97", "filename": "src/libcollections/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b24c6fde477dd7a8734a783dc0f4eeb9a1ea4f18/src%2Flibcollections%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b24c6fde477dd7a8734a783dc0f4eeb9a1ea4f18/src%2Flibcollections%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcollections%2Flib.rs?ref=b24c6fde477dd7a8734a783dc0f4eeb9a1ea4f18", "patch": "@@ -101,7 +101,7 @@ pub mod btree_set {\n }\n \n \n-#[cfg(test)] mod bench;\n+#[cfg(test)] #[macro_use] mod bench;\n \n // FIXME(#14344) this shouldn't be necessary\n #[doc(hidden)]"}, {"sha": "ddd4713e4ccf8c5fef114a7a22355f3e52b77256", "filename": "src/libcollections/vec_map.rs", "status": "modified", "additions": 8, "deletions": 65, "changes": 73, "blob_url": "https://github.com/rust-lang/rust/blob/b24c6fde477dd7a8734a783dc0f4eeb9a1ea4f18/src%2Flibcollections%2Fvec_map.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b24c6fde477dd7a8734a783dc0f4eeb9a1ea4f18/src%2Flibcollections%2Fvec_map.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcollections%2Fvec_map.rs?ref=b24c6fde477dd7a8734a783dc0f4eeb9a1ea4f18", "patch": "@@ -1321,74 +1321,17 @@ mod test_map {\n \n #[cfg(test)]\n mod bench {\n-    use test::Bencher;\n     use super::VecMap;\n-    use bench::{insert_rand_n, insert_seq_n, find_rand_n, find_seq_n};\n \n-    #[bench]\n-    pub fn insert_rand_100(b: &mut Bencher) {\n-        let mut m = VecMap::new();\n-        insert_rand_n(100, &mut m, b,\n-                      |m, i| { m.insert(i, 1); },\n-                      |m, i| { m.remove(&i); });\n-    }\n-\n-    #[bench]\n-    pub fn insert_rand_10_000(b: &mut Bencher) {\n-        let mut m = VecMap::new();\n-        insert_rand_n(10_000, &mut m, b,\n-                      |m, i| { m.insert(i, 1); },\n-                      |m, i| { m.remove(&i); });\n-    }\n-\n-    // Insert seq\n-    #[bench]\n-    pub fn insert_seq_100(b: &mut Bencher) {\n-        let mut m = VecMap::new();\n-        insert_seq_n(100, &mut m, b,\n-                     |m, i| { m.insert(i, 1); },\n-                     |m, i| { m.remove(&i); });\n-    }\n-\n-    #[bench]\n-    pub fn insert_seq_10_000(b: &mut Bencher) {\n-        let mut m = VecMap::new();\n-        insert_seq_n(10_000, &mut m, b,\n-                     |m, i| { m.insert(i, 1); },\n-                     |m, i| { m.remove(&i); });\n-    }\n+    map_insert_rand_bench!{insert_rand_100,    100,    VecMap}\n+    map_insert_rand_bench!{insert_rand_10_000, 10_000, VecMap}\n \n-    // Find rand\n-    #[bench]\n-    pub fn find_rand_100(b: &mut Bencher) {\n-        let mut m = VecMap::new();\n-        find_rand_n(100, &mut m, b,\n-                    |m, i| { m.insert(i, 1); },\n-                    |m, i| { m.get(&i); });\n-    }\n-\n-    #[bench]\n-    pub fn find_rand_10_000(b: &mut Bencher) {\n-        let mut m = VecMap::new();\n-        find_rand_n(10_000, &mut m, b,\n-                    |m, i| { m.insert(i, 1); },\n-                    |m, i| { m.get(&i); });\n-    }\n+    map_insert_seq_bench!{insert_seq_100,    100,    VecMap}\n+    map_insert_seq_bench!{insert_seq_10_000, 10_000, VecMap}\n \n-    // Find seq\n-    #[bench]\n-    pub fn find_seq_100(b: &mut Bencher) {\n-        let mut m = VecMap::new();\n-        find_seq_n(100, &mut m, b,\n-                   |m, i| { m.insert(i, 1); },\n-                   |m, i| { m.get(&i); });\n-    }\n+    map_find_rand_bench!{find_rand_100,    100,    VecMap}\n+    map_find_rand_bench!{find_rand_10_000, 10_000, VecMap}\n \n-    #[bench]\n-    pub fn find_seq_10_000(b: &mut Bencher) {\n-        let mut m = VecMap::new();\n-        find_seq_n(10_000, &mut m, b,\n-                   |m, i| { m.insert(i, 1); },\n-                   |m, i| { m.get(&i); });\n-    }\n+    map_find_seq_bench!{find_seq_100,    100,    VecMap}\n+    map_find_seq_bench!{find_seq_10_000, 10_000, VecMap}\n }"}]}