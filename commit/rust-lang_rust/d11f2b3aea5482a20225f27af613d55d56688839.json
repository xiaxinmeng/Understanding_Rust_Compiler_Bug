{"sha": "d11f2b3aea5482a20225f27af613d55d56688839", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQxMWYyYjNhZWE1NDgyYTIwMjI1ZjI3YWY2MTNkNTVkNTY2ODg4Mzk=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2015-01-15T22:11:45Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2015-01-15T22:11:45Z"}, "message": "rollup merge of #21089: nikomatsakis/issue-20676-invalid-vtable-for-object\n\nSupport UFCS style calls to a method defined in `Trait` where `Self` is bound to a trait object. Fixes #20676.\n\nr? @alexcrichton", "tree": {"sha": "1e4a04ec8e139a8e51100fdad3c382be46b7de38", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1e4a04ec8e139a8e51100fdad3c382be46b7de38"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d11f2b3aea5482a20225f27af613d55d56688839", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d11f2b3aea5482a20225f27af613d55d56688839", "html_url": "https://github.com/rust-lang/rust/commit/d11f2b3aea5482a20225f27af613d55d56688839", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d11f2b3aea5482a20225f27af613d55d56688839/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0be4b9b9c50db962a134944ada672ace1c69ec7d", "url": "https://api.github.com/repos/rust-lang/rust/commits/0be4b9b9c50db962a134944ada672ace1c69ec7d", "html_url": "https://github.com/rust-lang/rust/commit/0be4b9b9c50db962a134944ada672ace1c69ec7d"}, {"sha": "d3cecbf6f6aaeb7defdfb2e5d9e2b82d02fa7528", "url": "https://api.github.com/repos/rust-lang/rust/commits/d3cecbf6f6aaeb7defdfb2e5d9e2b82d02fa7528", "html_url": "https://github.com/rust-lang/rust/commit/d3cecbf6f6aaeb7defdfb2e5d9e2b82d02fa7528"}], "stats": {"total": 62, "additions": 59, "deletions": 3}, "files": [{"sha": "0fb0dffe930fa958547c5cd2375f3b001d91c075", "filename": "src/librustc_trans/trans/meth.rs", "status": "modified", "additions": 14, "deletions": 3, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/d11f2b3aea5482a20225f27af613d55d56688839/src%2Flibrustc_trans%2Ftrans%2Fmeth.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d11f2b3aea5482a20225f27af613d55d56688839/src%2Flibrustc_trans%2Ftrans%2Fmeth.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Ftrans%2Fmeth.rs?ref=d11f2b3aea5482a20225f27af613d55d56688839", "patch": "@@ -288,6 +288,17 @@ pub fn trans_static_method_callee<'a, 'tcx>(ccx: &CrateContext<'a, 'tcx>,\n                                      param_substs,\n                                      callee_substs)\n         }\n+        traits::VtableObject(ref data) => {\n+            let trait_item_def_ids =\n+                ty::trait_item_def_ids(ccx.tcx(), trait_id);\n+            let method_offset_in_trait =\n+                trait_item_def_ids.iter()\n+                                  .position(|item| item.def_id() == method_id)\n+                                  .unwrap();\n+            let (llfn, ty) =\n+                trans_object_shim(ccx, data.object_ty, trait_id, method_offset_in_trait);\n+            immediate_rvalue(llfn, ty)\n+        }\n         _ => {\n             tcx.sess.bug(&format!(\"static call to invalid vtable: {}\",\n                                  vtbl.repr(tcx))[]);\n@@ -371,7 +382,7 @@ fn trans_monomorphized_callee<'blk, 'tcx>(bcx: Block<'blk, 'tcx>,\n             Callee { bcx: bcx, data: Fn(llfn) }\n         }\n         traits::VtableObject(ref data) => {\n-            let llfn = trans_object_shim(bcx.ccx(), data.object_ty, trait_id, n_method);\n+            let (llfn, _) = trans_object_shim(bcx.ccx(), data.object_ty, trait_id, n_method);\n             Callee { bcx: bcx, data: Fn(llfn) }\n         }\n         traits::VtableBuiltin(..) |\n@@ -540,7 +551,7 @@ pub fn trans_object_shim<'a, 'tcx>(\n     object_ty: Ty<'tcx>,\n     trait_id: ast::DefId,\n     method_offset_in_trait: uint)\n-    -> ValueRef\n+    -> (ValueRef, Ty<'tcx>)\n {\n     let _icx = push_ctxt(\"trans_object_shim\");\n     let tcx = ccx.tcx();\n@@ -667,7 +678,7 @@ pub fn trans_object_shim<'a, 'tcx>(\n \n     finish_fn(&fcx, bcx, sig.output);\n \n-    llfn\n+    (llfn, method_bare_fn_ty)\n }\n \n /// Creates a returns a dynamic vtable for the given type and vtable origin."}, {"sha": "fd99fc01a23d12810c88b6824274fa60637bcb1e", "filename": "src/test/run-pass/issue-20676.rs", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/d11f2b3aea5482a20225f27af613d55d56688839/src%2Ftest%2Frun-pass%2Fissue-20676.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d11f2b3aea5482a20225f27af613d55d56688839/src%2Ftest%2Frun-pass%2Fissue-20676.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fissue-20676.rs?ref=d11f2b3aea5482a20225f27af613d55d56688839", "patch": "@@ -0,0 +1,20 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// Regression test for #20676. Error was that we didn't support\n+// UFCS-style calls to a method in `Trait` where `Self` was bound to a\n+// trait object of type `Trait`. See also `ufcs-trait-object.rs`.\n+\n+use std::fmt;\n+\n+fn main() {\n+    let a: &fmt::Show = &1_i32;\n+    format!(\"{:?}\", a);\n+}"}, {"sha": "2ae63040d17850c373b507aeeea377fa03332a41", "filename": "src/test/run-pass/ufcs-trait-object.rs", "status": "added", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/d11f2b3aea5482a20225f27af613d55d56688839/src%2Ftest%2Frun-pass%2Fufcs-trait-object.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d11f2b3aea5482a20225f27af613d55d56688839/src%2Ftest%2Frun-pass%2Fufcs-trait-object.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fufcs-trait-object.rs?ref=d11f2b3aea5482a20225f27af613d55d56688839", "patch": "@@ -0,0 +1,25 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// Test that when you use ufcs form to invoke a trait method (on a\n+// trait object) everything works fine.\n+\n+trait Foo {\n+    fn test(&self) -> i32;\n+}\n+\n+impl Foo for i32 {\n+    fn test(&self) -> i32 { *self }\n+}\n+\n+fn main() {\n+    let a: &Foo = &22_i32;\n+    assert_eq!(Foo::test(a), 22);\n+}"}]}