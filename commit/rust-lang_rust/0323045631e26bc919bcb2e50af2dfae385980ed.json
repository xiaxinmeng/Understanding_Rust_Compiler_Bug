{"sha": "0323045631e26bc919bcb2e50af2dfae385980ed", "node_id": "MDY6Q29tbWl0NzI0NzEyOjAzMjMwNDU2MzFlMjZiYzkxOWJjYjJlNTBhZjJkZmFlMzg1OTgwZWQ=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-05-04T07:07:06Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-05-04T07:07:06Z"}, "message": "Merge #8714\n\n8714: internal: remove one more usage of the rewriter r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>", "tree": {"sha": "9eb9c5cf836fdd36ad39b6b39b47e9a1f5058494", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9eb9c5cf836fdd36ad39b6b39b47e9a1f5058494"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0323045631e26bc919bcb2e50af2dfae385980ed", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgkPKaCRBK7hj4Ov3rIwAAiiUIABXWKQ2afKBw8z+/Fm52T+BR\nxavULbglbb3wfTwm0Jz4yulX4uFWWQjCEmEDaIwRSimHIGVnDuCXFEaom0CRIEj3\nQs64l3RIrhK9xzpBxnzWXNkQggZbNCxG4IsV4ocymqfOsRshy8Oz9LHXr9N8S8ZK\ntg9XMZAgp7nPDBM4yGGqSDU5QXda6G1A8qv6pihPK9WGoF1AI31iyzpMitfWhfF9\n4VUBaGU/4HEqWnen2OiHic3A48Pk4Z+Uo2od0gka9IH4rVz9LBwA5Ki9kirlxWTj\n/O6DN4AuyYOG3lj3ntbegLyYh5KPj3vf4cRddJbt6hY554lyaBi/VTh5YOZcJcA=\n=c5ct\n-----END PGP SIGNATURE-----\n", "payload": "tree 9eb9c5cf836fdd36ad39b6b39b47e9a1f5058494\nparent 2350b3f05f96a4a9ed81dc5bde246a1ef1d0da41\nparent ae6b9c25ede237dffc6e4b8767677872b758371f\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1620112026 +0000\ncommitter GitHub <noreply@github.com> 1620112026 +0000\n\nMerge #8714\n\n8714: internal: remove one more usage of the rewriter r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0323045631e26bc919bcb2e50af2dfae385980ed", "html_url": "https://github.com/rust-lang/rust/commit/0323045631e26bc919bcb2e50af2dfae385980ed", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0323045631e26bc919bcb2e50af2dfae385980ed/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2350b3f05f96a4a9ed81dc5bde246a1ef1d0da41", "url": "https://api.github.com/repos/rust-lang/rust/commits/2350b3f05f96a4a9ed81dc5bde246a1ef1d0da41", "html_url": "https://github.com/rust-lang/rust/commit/2350b3f05f96a4a9ed81dc5bde246a1ef1d0da41"}, {"sha": "ae6b9c25ede237dffc6e4b8767677872b758371f", "url": "https://api.github.com/repos/rust-lang/rust/commits/ae6b9c25ede237dffc6e4b8767677872b758371f", "html_url": "https://github.com/rust-lang/rust/commit/ae6b9c25ede237dffc6e4b8767677872b758371f"}], "stats": {"total": 72, "additions": 49, "deletions": 23}, "files": [{"sha": "4b0bba2abceaefa0876e644cca2ecab1699b83b9", "filename": "crates/ide_assists/src/assist_context.rs", "status": "modified", "additions": 26, "deletions": 13, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/0323045631e26bc919bcb2e50af2dfae385980ed/crates%2Fide_assists%2Fsrc%2Fassist_context.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0323045631e26bc919bcb2e50af2dfae385980ed/crates%2Fide_assists%2Fsrc%2Fassist_context.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_assists%2Fsrc%2Fassist_context.rs?ref=0323045631e26bc919bcb2e50af2dfae385980ed", "patch": "@@ -185,7 +185,29 @@ pub(crate) struct AssistBuilder {\n     source_change: SourceChange,\n \n     /// Maps the original, immutable `SyntaxNode` to a `clone_for_update` twin.\n-    mutated_tree: Option<(SyntaxNode, SyntaxNode)>,\n+    mutated_tree: Option<TreeMutator>,\n+}\n+\n+pub(crate) struct TreeMutator {\n+    immutable: SyntaxNode,\n+    mutable_clone: SyntaxNode,\n+}\n+\n+impl TreeMutator {\n+    pub(crate) fn new(immutable: &SyntaxNode) -> TreeMutator {\n+        let immutable = immutable.ancestors().last().unwrap();\n+        let mutable_clone = immutable.clone_for_update();\n+        TreeMutator { immutable, mutable_clone }\n+    }\n+\n+    pub(crate) fn make_mut<N: AstNode>(&self, node: &N) -> N {\n+        N::cast(self.make_syntax_mut(node.syntax())).unwrap()\n+    }\n+\n+    pub(crate) fn make_syntax_mut(&self, node: &SyntaxNode) -> SyntaxNode {\n+        let ptr = SyntaxNodePtr::new(node);\n+        ptr.to_node(&self.mutable_clone)\n+    }\n }\n \n impl AssistBuilder {\n@@ -204,8 +226,8 @@ impl AssistBuilder {\n     }\n \n     fn commit(&mut self) {\n-        if let Some((old, new)) = self.mutated_tree.take() {\n-            algo::diff(&old, &new).into_text_edit(&mut self.edit)\n+        if let Some(tm) = self.mutated_tree.take() {\n+            algo::diff(&tm.immutable, &tm.mutable_clone).into_text_edit(&mut self.edit)\n         }\n \n         let edit = mem::take(&mut self.edit).finish();\n@@ -228,16 +250,7 @@ impl AssistBuilder {\n     /// phase, and then get their mutable couterparts using `make_mut` in the\n     /// mutable state.\n     pub(crate) fn make_mut(&mut self, node: SyntaxNode) -> SyntaxNode {\n-        let root = &self\n-            .mutated_tree\n-            .get_or_insert_with(|| {\n-                let immutable = node.ancestors().last().unwrap();\n-                let mutable = immutable.clone_for_update();\n-                (immutable, mutable)\n-            })\n-            .1;\n-        let ptr = SyntaxNodePtr::new(&&node);\n-        ptr.to_node(root)\n+        self.mutated_tree.get_or_insert_with(|| TreeMutator::new(&node)).make_syntax_mut(&node)\n     }\n \n     /// Remove specified `range` of text."}, {"sha": "93b28370caec12bb093e4b91db7e964fbbdc8a72", "filename": "crates/ide_assists/src/handlers/extract_function.rs", "status": "modified", "additions": 23, "deletions": 10, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/0323045631e26bc919bcb2e50af2dfae385980ed/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fextract_function.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0323045631e26bc919bcb2e50af2dfae385980ed/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fextract_function.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fextract_function.rs?ref=0323045631e26bc919bcb2e50af2dfae385980ed", "patch": "@@ -16,12 +16,13 @@ use syntax::{\n         edit::{AstNodeEdit, IndentLevel},\n         AstNode,\n     },\n+    ted,\n     SyntaxKind::{self, BLOCK_EXPR, BREAK_EXPR, COMMENT, PATH_EXPR, RETURN_EXPR},\n     SyntaxNode, SyntaxToken, TextRange, TextSize, TokenAtOffset, WalkEvent, T,\n };\n \n use crate::{\n-    assist_context::{AssistContext, Assists},\n+    assist_context::{AssistContext, Assists, TreeMutator},\n     AssistId,\n };\n \n@@ -1366,7 +1367,10 @@ fn rewrite_body_segment(\n \n /// change all usages to account for added `&`/`&mut` for some params\n fn fix_param_usages(ctx: &AssistContext, params: &[Param], syntax: &SyntaxNode) -> SyntaxNode {\n-    let mut rewriter = SyntaxRewriter::default();\n+    let mut usages_for_param: Vec<(&Param, Vec<ast::Expr>)> = Vec::new();\n+\n+    let tm = TreeMutator::new(syntax);\n+\n     for param in params {\n         if !param.kind().is_ref() {\n             continue;\n@@ -1376,30 +1380,39 @@ fn fix_param_usages(ctx: &AssistContext, params: &[Param], syntax: &SyntaxNode)\n         let usages = usages\n             .iter()\n             .filter(|reference| syntax.text_range().contains_range(reference.range))\n-            .filter_map(|reference| path_element_of_reference(syntax, reference));\n-        for path in usages {\n-            match path.syntax().ancestors().skip(1).find_map(ast::Expr::cast) {\n+            .filter_map(|reference| path_element_of_reference(syntax, reference))\n+            .map(|expr| tm.make_mut(&expr));\n+\n+        usages_for_param.push((param, usages.collect()));\n+    }\n+\n+    let res = tm.make_syntax_mut(syntax);\n+\n+    for (param, usages) in usages_for_param {\n+        for usage in usages {\n+            match usage.syntax().ancestors().skip(1).find_map(ast::Expr::cast) {\n                 Some(ast::Expr::MethodCallExpr(_)) | Some(ast::Expr::FieldExpr(_)) => {\n                     // do nothing\n                 }\n                 Some(ast::Expr::RefExpr(node))\n                     if param.kind() == ParamKind::MutRef && node.mut_token().is_some() =>\n                 {\n-                    rewriter.replace_ast(&node.clone().into(), &node.expr().unwrap());\n+                    ted::replace(node.syntax(), node.expr().unwrap().syntax());\n                 }\n                 Some(ast::Expr::RefExpr(node))\n                     if param.kind() == ParamKind::SharedRef && node.mut_token().is_none() =>\n                 {\n-                    rewriter.replace_ast(&node.clone().into(), &node.expr().unwrap());\n+                    ted::replace(node.syntax(), node.expr().unwrap().syntax());\n                 }\n                 Some(_) | None => {\n-                    rewriter.replace_ast(&path, &make::expr_prefix(T![*], path.clone()));\n+                    let p = &make::expr_prefix(T![*], usage.clone()).clone_for_update();\n+                    ted::replace(usage.syntax(), p.syntax())\n                 }\n-            };\n+            }\n         }\n     }\n \n-    rewriter.rewrite(syntax)\n+    res\n }\n \n fn update_external_control_flow(handler: &FlowHandler, syntax: &SyntaxNode) -> SyntaxNode {"}]}