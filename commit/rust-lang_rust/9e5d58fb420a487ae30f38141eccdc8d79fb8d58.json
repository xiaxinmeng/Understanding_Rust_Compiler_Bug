{"sha": "9e5d58fb420a487ae30f38141eccdc8d79fb8d58", "node_id": "MDY6Q29tbWl0NzI0NzEyOjllNWQ1OGZiNDIwYTQ4N2FlMzBmMzgxNDFlY2NkYzhkNzlmYjhkNTg=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-02-05T06:12:26Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-02-05T06:12:26Z"}, "message": "Auto merge of #81688 - pnkfelix:fix-llvm-version-check-in-run-make-tests, r=simulacrum\n\nUse `# min-llvm-version: 11.0` to force a minimum LLVM version\n\nUse `# min-llvm-version: 11.0` to force a minimum LLVM version, rather than ad-hoc internal solution.\n\nIn particular: the specific code to define LLVM_VERSION_11_PLUS here was, for some reason, using `$(shell ...)` with bash-specific variable replacement code. On non-bash platforms like dash, that `shell` invocation would fail, and the\nLLVM_VERSION_11_PLUS check would always fail, the test would always be ignored, and thus be treated as a \"success\" (in the sense that `--bless` would never do anything).\n\n * Note in particular that GNU Make treats the SHELL variable as a very special case: it does not inherit the value of SHELL from the user's environment. Except on Windows. See more explanation in the [GNU Make docs](https://www.gnu.org/software/make/manual/html_node/Choosing-the-Shell.html).\n * The effect of this is that these tests end up using `/bin/sh` (except on Windows) for their `$(shell ...)` invocations, and thus we see differing behaviors depending on whether your `/bin/sh` links to `/bin/dash` or to `/bin/bash`.\n\nThis was causing me a lot of pain.", "tree": {"sha": "841e0654fc71d614351d57ce4ef7842772335534", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/841e0654fc71d614351d57ce4ef7842772335534"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9e5d58fb420a487ae30f38141eccdc8d79fb8d58", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9e5d58fb420a487ae30f38141eccdc8d79fb8d58", "html_url": "https://github.com/rust-lang/rust/commit/9e5d58fb420a487ae30f38141eccdc8d79fb8d58", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9e5d58fb420a487ae30f38141eccdc8d79fb8d58/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6a388dcfbb07b3ca3d4ad3fd3902ac7e3b11b5f6", "url": "https://api.github.com/repos/rust-lang/rust/commits/6a388dcfbb07b3ca3d4ad3fd3902ac7e3b11b5f6", "html_url": "https://github.com/rust-lang/rust/commit/6a388dcfbb07b3ca3d4ad3fd3902ac7e3b11b5f6"}, {"sha": "5ce67106688664eb1bfd8abae129e7c548de0351", "url": "https://api.github.com/repos/rust-lang/rust/commits/5ce67106688664eb1bfd8abae129e7c548de0351", "html_url": "https://github.com/rust-lang/rust/commit/5ce67106688664eb1bfd8abae129e7c548de0351"}], "stats": {"total": 26, "additions": 4, "deletions": 22}, "files": [{"sha": "7d9121ee2f8347293d6accf1fa815c5ff39bf378", "filename": "src/test/run-make-fulldeps/coverage-llvmir/Makefile", "status": "modified", "additions": 1, "deletions": 5, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/9e5d58fb420a487ae30f38141eccdc8d79fb8d58/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-llvmir%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/9e5d58fb420a487ae30f38141eccdc8d79fb8d58/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-llvmir%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-llvmir%2FMakefile?ref=9e5d58fb420a487ae30f38141eccdc8d79fb8d58", "patch": "@@ -1,4 +1,5 @@\n # needs-profiler-support\n+# min-llvm-version: 11.0\n \n -include ../coverage/coverage_tools.mk\n \n@@ -48,12 +49,7 @@ else\n \t\t-DINSTR_PROF_ORDERFILE='$(DATA_SECTION_PREFIX)__llvm_orderfile'\n endif\n \n-ifeq ($(LLVM_VERSION_11_PLUS),true)\n all: test_llvm_ir\n-else\n-$(info Rust option `-Z instrument-coverage` requires LLVM 11 or higher. Test skipped.)\n-all:\n-endif\n \n test_llvm_ir:\n \t# Compile the test program with non-experimental coverage instrumentation, and generate LLVM IR"}, {"sha": "a700cf68cd9da562a4a0f3daacc0d58877bd19b2", "filename": "src/test/run-make-fulldeps/coverage-reports/Makefile", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/9e5d58fb420a487ae30f38141eccdc8d79fb8d58/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/9e5d58fb420a487ae30f38141eccdc8d79fb8d58/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2FMakefile?ref=9e5d58fb420a487ae30f38141eccdc8d79fb8d58", "patch": "@@ -1,5 +1,7 @@\n+# ignore-test Broken; accidentally silently ignored on Linux CI; FIXME(#81688)\n # needs-profiler-support\n # ignore-windows-gnu\n+# min-llvm-version: 11.0\n \n # FIXME(mati865): MinGW GCC miscompiles compiler-rt profiling library but with Clang it works\n # properly. Since we only have GCC on the CI ignore the test for now.\n@@ -67,12 +69,7 @@ ifdef RUSTC_BLESS_TEST\n DEBUG_FLAG=--debug\n endif\n \n-ifeq ($(LLVM_VERSION_11_PLUS),true)\n all: $(patsubst $(SOURCEDIR)/lib/%.rs,%,$(wildcard $(SOURCEDIR)/lib/*.rs)) $(patsubst $(SOURCEDIR)/%.rs,%,$(wildcard $(SOURCEDIR)/*.rs))\n-else\n-$(info Rust option `-Z instrument-coverage` requires LLVM 11 or higher. Test skipped.)\n-all:\n-endif\n \n # Ensure there are no `expected` results for tests that may have been removed or renamed\n .PHONY: clear_expected_if_blessed"}, {"sha": "2713e7d52ffd31cbfbd2faee8e3b182dc1140297", "filename": "src/test/run-make-fulldeps/coverage-spanview/Makefile", "status": "modified", "additions": 1, "deletions": 5, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/9e5d58fb420a487ae30f38141eccdc8d79fb8d58/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-spanview%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/9e5d58fb420a487ae30f38141eccdc8d79fb8d58/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-spanview%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-spanview%2FMakefile?ref=9e5d58fb420a487ae30f38141eccdc8d79fb8d58", "patch": "@@ -1,4 +1,5 @@\n # needs-profiler-support\n+# min-llvm-version: 11.0\n \n -include ../coverage/coverage_tools.mk\n \n@@ -20,12 +21,7 @@ For revisions in Pull Requests (PR):\n endef\n export SPANVIEW_HEADER\n \n-ifeq ($(LLVM_VERSION_11_PLUS),true)\n all: $(patsubst $(SOURCEDIR)/lib/%.rs,%,$(wildcard $(SOURCEDIR)/lib/*.rs)) $(patsubst $(SOURCEDIR)/%.rs,%,$(wildcard $(SOURCEDIR)/*.rs))\n-else\n-$(info Rust option `-Z instrument-coverage` requires LLVM 11 or higher. Test skipped.)\n-all:\n-endif\n \n # Ensure there are no `expected` results for tests that may have been removed or renamed\n .PHONY: clear_expected_if_blessed"}, {"sha": "11fd824e5272f62800fb6fff05a2af9eb18a18e5", "filename": "src/test/run-make-fulldeps/coverage/coverage_tools.mk", "status": "modified", "additions": 0, "deletions": 7, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/9e5d58fb420a487ae30f38141eccdc8d79fb8d58/src%2Ftest%2Frun-make-fulldeps%2Fcoverage%2Fcoverage_tools.mk", "raw_url": "https://github.com/rust-lang/rust/raw/9e5d58fb420a487ae30f38141eccdc8d79fb8d58/src%2Ftest%2Frun-make-fulldeps%2Fcoverage%2Fcoverage_tools.mk", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fcoverage%2Fcoverage_tools.mk?ref=9e5d58fb420a487ae30f38141eccdc8d79fb8d58", "patch": "@@ -14,10 +14,3 @@\n # Therefore, `-C link-dead-code` is no longer automatically enabled.\n \n UNAME = $(shell uname)\n-\n-# Rust option `-Z instrument-coverage` uses LLVM Coverage Mapping Format version 4,\n-# which requires LLVM 11 or greater.\n-LLVM_VERSION_11_PLUS := $(shell \\\n-\t\tLLVM_VERSION=$$(\"$(LLVM_BIN_DIR)\"/llvm-config --version) && \\\n-\t\tLLVM_VERSION_MAJOR=$${LLVM_VERSION/.*/} && \\\n-\t\t[ $$LLVM_VERSION_MAJOR -ge 11 ] && echo true || echo false)"}]}