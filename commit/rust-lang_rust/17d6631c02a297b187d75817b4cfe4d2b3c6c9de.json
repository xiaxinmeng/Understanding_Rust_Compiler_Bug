{"sha": "17d6631c02a297b187d75817b4cfe4d2b3c6c9de", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE3ZDY2MzFjMDJhMjk3YjE4N2Q3NTgxN2I0Y2ZlNGQyYjNjNmM5ZGU=", "commit": {"author": {"name": "Shotaro Yamada", "email": "sinkuu@sinkuu.xyz", "date": "2017-12-03T08:38:56Z"}, "committer": {"name": "Shotaro Yamada", "email": "sinkuu@sinkuu.xyz", "date": "2017-12-03T08:42:52Z"}, "message": "Fix MIR CopyPropagation regression", "tree": {"sha": "c0217ba883351bcf107bac78e310c1644d509449", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c0217ba883351bcf107bac78e310c1644d509449"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/17d6631c02a297b187d75817b4cfe4d2b3c6c9de", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/17d6631c02a297b187d75817b4cfe4d2b3c6c9de", "html_url": "https://github.com/rust-lang/rust/commit/17d6631c02a297b187d75817b4cfe4d2b3c6c9de", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/17d6631c02a297b187d75817b4cfe4d2b3c6c9de/comments", "author": {"login": "sinkuu", "id": 7091080, "node_id": "MDQ6VXNlcjcwOTEwODA=", "avatar_url": "https://avatars.githubusercontent.com/u/7091080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sinkuu", "html_url": "https://github.com/sinkuu", "followers_url": "https://api.github.com/users/sinkuu/followers", "following_url": "https://api.github.com/users/sinkuu/following{/other_user}", "gists_url": "https://api.github.com/users/sinkuu/gists{/gist_id}", "starred_url": "https://api.github.com/users/sinkuu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sinkuu/subscriptions", "organizations_url": "https://api.github.com/users/sinkuu/orgs", "repos_url": "https://api.github.com/users/sinkuu/repos", "events_url": "https://api.github.com/users/sinkuu/events{/privacy}", "received_events_url": "https://api.github.com/users/sinkuu/received_events", "type": "User", "site_admin": false}, "committer": {"login": "sinkuu", "id": 7091080, "node_id": "MDQ6VXNlcjcwOTEwODA=", "avatar_url": "https://avatars.githubusercontent.com/u/7091080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/sinkuu", "html_url": "https://github.com/sinkuu", "followers_url": "https://api.github.com/users/sinkuu/followers", "following_url": "https://api.github.com/users/sinkuu/following{/other_user}", "gists_url": "https://api.github.com/users/sinkuu/gists{/gist_id}", "starred_url": "https://api.github.com/users/sinkuu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/sinkuu/subscriptions", "organizations_url": "https://api.github.com/users/sinkuu/orgs", "repos_url": "https://api.github.com/users/sinkuu/repos", "events_url": "https://api.github.com/users/sinkuu/events{/privacy}", "received_events_url": "https://api.github.com/users/sinkuu/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7e251390c782d5b8d94c6e55c83572a3a7a26cb4", "url": "https://api.github.com/repos/rust-lang/rust/commits/7e251390c782d5b8d94c6e55c83572a3a7a26cb4", "html_url": "https://github.com/rust-lang/rust/commit/7e251390c782d5b8d94c6e55c83572a3a7a26cb4"}], "stats": {"total": 87, "additions": 57, "deletions": 30}, "files": [{"sha": "95fe99a1bec9f6998fe210e03b92b12d7f37fca6", "filename": "src/librustc_mir/transform/copy_prop.rs", "status": "modified", "additions": 7, "deletions": 4, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/17d6631c02a297b187d75817b4cfe4d2b3c6c9de/src%2Flibrustc_mir%2Ftransform%2Fcopy_prop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/17d6631c02a297b187d75817b4cfe4d2b3c6c9de/src%2Flibrustc_mir%2Ftransform%2Fcopy_prop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fcopy_prop.rs?ref=17d6631c02a297b187d75817b4cfe4d2b3c6c9de", "patch": "@@ -239,10 +239,13 @@ impl<'tcx> Action<'tcx> {\n         //     USE(SRC);\n         let src_def_count = src_use_info.def_count_not_including_drop();\n         // allow function arguments to be propagated\n-        if src_def_count > 1 ||\n-            (src_def_count == 0 && mir.local_kind(src_local) != LocalKind::Arg) {\n-            debug!(\"  Can't copy-propagate local: {} defs of src\",\n-                   src_use_info.def_count_not_including_drop());\n+        let is_arg = mir.local_kind(src_local) == LocalKind::Arg;\n+        if (is_arg && src_def_count != 0) || (!is_arg && src_def_count != 1) {\n+            debug!(\n+                \"  Can't copy-propagate local: {} defs of src{}\",\n+                src_def_count,\n+                if is_arg { \" (argument)\" } else { \"\" },\n+            );\n             return None\n         }\n "}, {"sha": "35bb231df5adfcad15ca8d1e76b77622cdf09c11", "filename": "src/test/mir-opt/copy_propagation_arg.rs", "status": "modified", "additions": 50, "deletions": 26, "changes": 76, "blob_url": "https://github.com/rust-lang/rust/blob/17d6631c02a297b187d75817b4cfe4d2b3c6c9de/src%2Ftest%2Fmir-opt%2Fcopy_propagation_arg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/17d6631c02a297b187d75817b4cfe4d2b3c6c9de/src%2Ftest%2Fmir-opt%2Fcopy_propagation_arg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fcopy_propagation_arg.rs?ref=17d6631c02a297b187d75817b4cfe4d2b3c6c9de", "patch": "@@ -30,42 +30,43 @@ fn baz(mut x: i32) {\n     x = x;\n }\n \n+fn arg_src(mut x: i32) -> i32 {\n+    let y = x;\n+    x = 123; // Don't propagate this assignment to `y`\n+    y\n+}\n+\n fn main() {\n     // Make sure the function actually gets instantiated.\n     foo(0);\n     bar(0);\n     baz(0);\n+    arg_src(0);\n }\n \n // END RUST SOURCE\n // START rustc.foo.CopyPropagation.before.mir\n // bb0: {\n-//     StorageLive(_2);\n-//     StorageLive(_3);\n+//     ...\n //     _3 = _1;\n //     _2 = const dummy(move _3) -> bb1;\n // }\n // bb1: {\n-//     StorageDead(_3);\n+//     ...\n //     _1 = move _2;\n-//     StorageDead(_2);\n-//     _0 = ();\n-//     return;\n+//     ...\n // }\n // END rustc.foo.CopyPropagation.before.mir\n // START rustc.foo.CopyPropagation.after.mir\n // bb0: {\n-//     StorageLive(_2);\n-//     nop;\n-//     nop;\n-//     _2 = const dummy(move _1) -> bb1;\n+//     ...\n+//     _3 = _1;\n+//     _2 = const dummy(move _3) -> bb1;\n // }\n // bb1: {\n-//     nop;\n+//     ...\n //     _1 = move _2;\n-//     StorageDead(_2);\n-//     _0 = ();\n-//     return;\n+//     ...\n // }\n // END rustc.foo.CopyPropagation.after.mir\n // START rustc.bar.CopyPropagation.before.mir\n@@ -83,15 +84,14 @@ fn main() {\n // END rustc.bar.CopyPropagation.before.mir\n // START rustc.bar.CopyPropagation.after.mir\n // bb0: {\n-//     nop;\n-//     nop;\n-//     _2 = const dummy(move _1) -> bb1;\n+//     ...\n+//     _3 = _1;\n+//     _2 = const dummy(move _3) -> bb1;\n // }\n // bb1: {\n-//     nop;\n+//     ...\n //     _1 = const 5u8;\n-//     _0 = ();\n-//     return;\n+//     ...\n // }\n // END rustc.bar.CopyPropagation.after.mir\n // START rustc.baz.CopyPropagation.before.mir\n@@ -106,11 +106,35 @@ fn main() {\n // END rustc.baz.CopyPropagation.before.mir\n // START rustc.baz.CopyPropagation.after.mir\n // bb0: {\n-//     nop;\n-//     nop;\n-//     nop;\n-//     nop;\n-//     _0 = ();\n-//     return;\n+//     ...\n+//     _2 = _1;\n+//     _1 = move _2;\n+//     ...\n // }\n // END rustc.baz.CopyPropagation.after.mir\n+// START rustc.arg_src.CopyPropagation.before.mir\n+// bb0: {\n+//       ...\n+//       _3 = _1;\n+//       _2 = move _3;\n+//       ...\n+//       _1 = const 123i32;\n+//       ...\n+//       _4 = _2;\n+//       _0 = move _4;\n+//       ...\n+//       return;\n+//   }\n+// END rustc.arg_src.CopyPropagation.before.mir\n+// START rustc.arg_src.CopyPropagation.after.mir\n+// bb0: {\n+//     ...\n+//     _3 = _1;\n+//     ...\n+//     _1 = const 123i32;\n+//     ...\n+//     _0 = move _3;\n+//     ...\n+//     return;\n+// }\n+// END rustc.arg_src.CopyPropagation.after.mir"}]}