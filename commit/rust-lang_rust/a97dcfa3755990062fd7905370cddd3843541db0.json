{"sha": "a97dcfa3755990062fd7905370cddd3843541db0", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE5N2RjZmEzNzU1OTkwMDYyZmQ3OTA1MzcwY2RkZDM4NDM1NDFkYjA=", "commit": {"author": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2020-08-28T03:17:40Z"}, "committer": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2020-08-30T17:46:19Z"}, "message": "Run cfg-stripping on generic parameters before invoking derive macros\n\nFixes #75930\n\nThis changes the tokens seen by a proc-macro. However, ising a `#[cfg]` attribute\non a generic paramter is unusual, and combining it with a proc-macro\nderive is probably even more unusual. I don't expect this to cause any\nbreakage.", "tree": {"sha": "5c32c838f77b5584c716941dadd5ebbb6b21aed3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5c32c838f77b5584c716941dadd5ebbb6b21aed3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a97dcfa3755990062fd7905370cddd3843541db0", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE7J9Gc3TfBwj2K399tAh+UQ6YsWQFAl9L5esACgkQtAh+UQ6Y\nsWTd2xAAmYyvjgmm8KFSWdJe/wG2lnfA60uMpw8VcZmd/lIGBC5D5k8FMoe6WLCM\nognwWV3VVXRfPq6LhWAIIvioy/fvdUKfxufAE4Xvn/nRE6utm/ZkGsh/xU6uSYop\nFOJzGIk4nVs6qy03OkfhHlvnOtX5Y3ka7lXRVVwh7zVqLHfK9s8+lONT7HLkOgZP\nu0WXUnri/+gKJonHPDIx+zfBaVaaC20F07kxCuNxOojkbGkZQPk/nC2zSsiTWQJY\n1RwUPLSiBLUlWikpIC9msfz2/nQ88S3wVysH4WDdzheATGmwlv/r2XuF+vrFn+iO\nWoucI0jAQA9tx24qyq1h+8VOE1hc2pOvvuT6GW/of8AfjJj60HIJn60VG2h65paw\nvoj46Ob199wuV+HvM3s9uQV+yQpVhldZqIVhsPCnHZa95Uy3SMeuN85xfLF8s0Ni\nl+z/62W1RL7nsErCebJD6frD5hs6B30oY8yFCaXEPNxy6U8MUWGroFu7UUOZTKQN\nbB9jxDdEflzj5bs59uwjA0Zoq7KytuoWStvginJy9oPUOjF+ACLjN4tDlpKHFgeI\nRc1AiJRCrAMne97qeEs+CjDDF1BicpTaO2QQOh38TlppWzp8YtEmwmrWPMhjDUk5\ny+k7mDT+0uhnbqwMp6xuHW3Bd1CNHAdUwhB9WBABBMTFsD/tupI=\n=PseR\n-----END PGP SIGNATURE-----", "payload": "tree 5c32c838f77b5584c716941dadd5ebbb6b21aed3\nparent 85fbf49ce0e2274d0acf798f6e703747674feec3\nauthor Aaron Hill <aa1ronham@gmail.com> 1598584660 -0400\ncommitter Aaron Hill <aa1ronham@gmail.com> 1598809579 -0400\n\nRun cfg-stripping on generic parameters before invoking derive macros\n\nFixes #75930\n\nThis changes the tokens seen by a proc-macro. However, ising a `#[cfg]` attribute\non a generic paramter is unusual, and combining it with a proc-macro\nderive is probably even more unusual. I don't expect this to cause any\nbreakage.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a97dcfa3755990062fd7905370cddd3843541db0", "html_url": "https://github.com/rust-lang/rust/commit/a97dcfa3755990062fd7905370cddd3843541db0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a97dcfa3755990062fd7905370cddd3843541db0/comments", "author": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "85fbf49ce0e2274d0acf798f6e703747674feec3", "url": "https://api.github.com/repos/rust-lang/rust/commits/85fbf49ce0e2274d0acf798f6e703747674feec3", "html_url": "https://github.com/rust-lang/rust/commit/85fbf49ce0e2274d0acf798f6e703747674feec3"}], "stats": {"total": 262, "additions": 258, "deletions": 4}, "files": [{"sha": "97608a389035ba58c237350dc7df22891fb8f420", "filename": "compiler/rustc_expand/src/config.rs", "status": "modified", "additions": 7, "deletions": 4, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/a97dcfa3755990062fd7905370cddd3843541db0/compiler%2Frustc_expand%2Fsrc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a97dcfa3755990062fd7905370cddd3843541db0/compiler%2Frustc_expand%2Fsrc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_expand%2Fsrc%2Fconfig.rs?ref=a97dcfa3755990062fd7905370cddd3843541db0", "patch": "@@ -403,10 +403,6 @@ impl<'a> StripUnconfigured<'a> {\n         items.flat_map_in_place(|item| self.configure(item));\n     }\n \n-    pub fn configure_generic_params(&mut self, params: &mut Vec<ast::GenericParam>) {\n-        params.flat_map_in_place(|param| self.configure(param));\n-    }\n-\n     fn configure_variant_data(&mut self, vdata: &mut ast::VariantData) {\n         match vdata {\n             ast::VariantData::Struct(fields, ..) | ast::VariantData::Tuple(fields, _) => {\n@@ -496,6 +492,13 @@ impl<'a> MutVisitor for StripUnconfigured<'a> {\n         Some(expr)\n     }\n \n+    fn flat_map_generic_param(\n+        &mut self,\n+        param: ast::GenericParam,\n+    ) -> SmallVec<[ast::GenericParam; 1]> {\n+        noop_flat_map_generic_param(configure!(self, param), self)\n+    }\n+\n     fn flat_map_stmt(&mut self, stmt: ast::Stmt) -> SmallVec<[ast::Stmt; 1]> {\n         noop_flat_map_stmt(configure!(self, stmt), self)\n     }"}, {"sha": "e0f248c67e8b39b7529fa1cd5ef35c8f781ff9c2", "filename": "src/test/ui/proc-macro/issue-75930-derive-cfg.rs", "status": "added", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/a97dcfa3755990062fd7905370cddd3843541db0/src%2Ftest%2Fui%2Fproc-macro%2Fissue-75930-derive-cfg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a97dcfa3755990062fd7905370cddd3843541db0/src%2Ftest%2Fui%2Fproc-macro%2Fissue-75930-derive-cfg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Fissue-75930-derive-cfg.rs?ref=a97dcfa3755990062fd7905370cddd3843541db0", "patch": "@@ -0,0 +1,30 @@\n+// check-pass\n+// compile-flags: -Z span-debug\n+// aux-build:test-macros.rs\n+\n+// Regression test for issue #75930\n+// Tests that we cfg-strip all targets before invoking\n+// a derive macro\n+\n+#[macro_use]\n+extern crate test_macros;\n+\n+#[derive(Print)]\n+struct Foo<#[cfg(FALSE)] A, B> {\n+    #[cfg(FALSE)] first: String,\n+    second: bool,\n+    third: [u8; {\n+        #[cfg(FALSE)] struct Bar;\n+        #[cfg(not(FALSE))] struct Inner;\n+        #[cfg(FALSE)] let a = 25;\n+        match true {\n+            #[cfg(FALSE)] true => {},\n+            false => {},\n+            _ => {}\n+        };\n+        0\n+    }],\n+    fourth: B\n+}\n+\n+fn main() {}"}, {"sha": "0371133a3f705696c658b0b1404a2d96f1a3d91a", "filename": "src/test/ui/proc-macro/issue-75930-derive-cfg.stdout", "status": "added", "additions": 221, "deletions": 0, "changes": 221, "blob_url": "https://github.com/rust-lang/rust/blob/a97dcfa3755990062fd7905370cddd3843541db0/src%2Ftest%2Fui%2Fproc-macro%2Fissue-75930-derive-cfg.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/a97dcfa3755990062fd7905370cddd3843541db0/src%2Ftest%2Fui%2Fproc-macro%2Fissue-75930-derive-cfg.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Fissue-75930-derive-cfg.stdout?ref=a97dcfa3755990062fd7905370cddd3843541db0", "patch": "@@ -0,0 +1,221 @@\n+PRINT-DERIVE INPUT (DISPLAY): struct Foo < B >\n+{\n+    second : bool, third :\n+    [u8 ;\n+     {\n+         #[cfg(not(FALSE))] struct Inner ; match true\n+         { false => { } _ => { } } ; 0\n+     }], fourth : B,\n+}\n+PRINT-DERIVE INPUT (DEBUG): TokenStream [\n+    Ident {\n+        ident: \"struct\",\n+        span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+    },\n+    Ident {\n+        ident: \"Foo\",\n+        span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+    },\n+    Punct {\n+        ch: '<',\n+        spacing: Alone,\n+        span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+    },\n+    Ident {\n+        ident: \"B\",\n+        span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+    },\n+    Punct {\n+        ch: '>',\n+        spacing: Alone,\n+        span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+    },\n+    Group {\n+        delimiter: Brace,\n+        stream: TokenStream [\n+            Ident {\n+                ident: \"second\",\n+                span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+            },\n+            Punct {\n+                ch: ':',\n+                spacing: Alone,\n+                span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+            },\n+            Ident {\n+                ident: \"bool\",\n+                span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+            },\n+            Punct {\n+                ch: ',',\n+                spacing: Alone,\n+                span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+            },\n+            Ident {\n+                ident: \"third\",\n+                span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+            },\n+            Punct {\n+                ch: ':',\n+                spacing: Alone,\n+                span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+            },\n+            Group {\n+                delimiter: Bracket,\n+                stream: TokenStream [\n+                    Ident {\n+                        ident: \"u8\",\n+                        span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+                    },\n+                    Punct {\n+                        ch: ';',\n+                        spacing: Alone,\n+                        span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+                    },\n+                    Group {\n+                        delimiter: Brace,\n+                        stream: TokenStream [\n+                            Punct {\n+                                ch: '#',\n+                                spacing: Alone,\n+                                span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+                            },\n+                            Group {\n+                                delimiter: Bracket,\n+                                stream: TokenStream [\n+                                    Ident {\n+                                        ident: \"cfg\",\n+                                        span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+                                    },\n+                                    Group {\n+                                        delimiter: Parenthesis,\n+                                        stream: TokenStream [\n+                                            Ident {\n+                                                ident: \"not\",\n+                                                span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+                                            },\n+                                            Group {\n+                                                delimiter: Parenthesis,\n+                                                stream: TokenStream [\n+                                                    Ident {\n+                                                        ident: \"FALSE\",\n+                                                        span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+                                                    },\n+                                                ],\n+                                                span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+                                            },\n+                                        ],\n+                                        span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+                                    },\n+                                ],\n+                                span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+                            },\n+                            Ident {\n+                                ident: \"struct\",\n+                                span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+                            },\n+                            Ident {\n+                                ident: \"Inner\",\n+                                span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+                            },\n+                            Punct {\n+                                ch: ';',\n+                                spacing: Alone,\n+                                span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+                            },\n+                            Ident {\n+                                ident: \"match\",\n+                                span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+                            },\n+                            Ident {\n+                                ident: \"true\",\n+                                span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+                            },\n+                            Group {\n+                                delimiter: Brace,\n+                                stream: TokenStream [\n+                                    Ident {\n+                                        ident: \"false\",\n+                                        span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+                                    },\n+                                    Punct {\n+                                        ch: '=',\n+                                        spacing: Joint,\n+                                        span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+                                    },\n+                                    Punct {\n+                                        ch: '>',\n+                                        spacing: Alone,\n+                                        span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+                                    },\n+                                    Group {\n+                                        delimiter: Brace,\n+                                        stream: TokenStream [],\n+                                        span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+                                    },\n+                                    Ident {\n+                                        ident: \"_\",\n+                                        span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+                                    },\n+                                    Punct {\n+                                        ch: '=',\n+                                        spacing: Joint,\n+                                        span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+                                    },\n+                                    Punct {\n+                                        ch: '>',\n+                                        spacing: Alone,\n+                                        span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+                                    },\n+                                    Group {\n+                                        delimiter: Brace,\n+                                        stream: TokenStream [],\n+                                        span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+                                    },\n+                                ],\n+                                span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+                            },\n+                            Punct {\n+                                ch: ';',\n+                                spacing: Alone,\n+                                span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+                            },\n+                            Literal {\n+                                kind: Integer,\n+                                symbol: \"0\",\n+                                suffix: None,\n+                                span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+                            },\n+                        ],\n+                        span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+                    },\n+                ],\n+                span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+            },\n+            Punct {\n+                ch: ',',\n+                spacing: Alone,\n+                span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+            },\n+            Ident {\n+                ident: \"fourth\",\n+                span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+            },\n+            Punct {\n+                ch: ':',\n+                spacing: Alone,\n+                span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+            },\n+            Ident {\n+                ident: \"B\",\n+                span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+            },\n+            Punct {\n+                ch: ',',\n+                spacing: Alone,\n+                span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+            },\n+        ],\n+        span: $DIR/issue-75930-derive-cfg.rs:1:1: 1:1 (#0),\n+    },\n+]"}]}