{"sha": "126d88bd12b1519847dc86a5f74d11ce5136f599", "node_id": "MDY6Q29tbWl0NzI0NzEyOjEyNmQ4OGJkMTJiMTUxOTg0N2RjODZhNWY3NGQxMWNlNTEzNmY1OTk=", "commit": {"author": {"name": "Mara Bos", "email": "m-ou.se@m-ou.se", "date": "2020-11-18T14:46:31Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-11-18T14:46:31Z"}, "message": "Rollup merge of #79114 - andjo403:nonzero_leading_trailing_zeros, r=m-ou-se\n\nadd trailing_zeros and leading_zeros to non zero types\n\nas a way towards being able to use the optimized intrinsics ctlz_nonzero and cttz_nonzero from stable.\n\nhave not crated any tracking issue if this is not a solution that is wanted", "tree": {"sha": "fa57acad3b18e45e10ff1e22e299e2705364bc1a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fa57acad3b18e45e10ff1e22e299e2705364bc1a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/126d88bd12b1519847dc86a5f74d11ce5136f599", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJftTPHCRBK7hj4Ov3rIwAAdHIIAC8PRrGEYTJFUyl9qZF6PSQW\nI2f90DVwKsf0UtktLnD5AgHJz/QdLE/u1RLMXxF59+BQeut2fTGyxYG7luseSASE\nVjo27ncBdz9hcIYWjBggxEeub1MPuYYt4gYu71Jsr5lWimw0zxLZ/7CLIp52Pa72\nSVfs837CXJrA9yZ6bSwesKLvYB6NypDGblJsWzsbNF7rpbsf5J7jd1ESGQ7l+wa4\n04uAITVvPvto0wT85xmbj8ghdTg6xLebFwFiem0lCNkDcmtdiDehozQs7y2YxWGU\nErtaC5mNbGfnmFwuecze3eUy2wfP1p5J/7huN77AObL5/gsyMh+k+eP00rae6Iw=\n=Ygi+\n-----END PGP SIGNATURE-----\n", "payload": "tree fa57acad3b18e45e10ff1e22e299e2705364bc1a\nparent f85c3f72a4448424f2a3a63fedcbb9e33287c0e7\nparent 9bbc4c16d31ec0c89aa5943fc1bfca8d8fc6f281\nauthor Mara Bos <m-ou.se@m-ou.se> 1605710791 +0100\ncommitter GitHub <noreply@github.com> 1605710791 +0100\n\nRollup merge of #79114 - andjo403:nonzero_leading_trailing_zeros, r=m-ou-se\n\nadd trailing_zeros and leading_zeros to non zero types\n\nas a way towards being able to use the optimized intrinsics ctlz_nonzero and cttz_nonzero from stable.\n\nhave not crated any tracking issue if this is not a solution that is wanted\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/126d88bd12b1519847dc86a5f74d11ce5136f599", "html_url": "https://github.com/rust-lang/rust/commit/126d88bd12b1519847dc86a5f74d11ce5136f599", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/126d88bd12b1519847dc86a5f74d11ce5136f599/comments", "author": {"login": "m-ou-se", "id": 783247, "node_id": "MDQ6VXNlcjc4MzI0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/783247?v=4", "gravatar_id": "", "url": "https://api.github.com/users/m-ou-se", "html_url": "https://github.com/m-ou-se", "followers_url": "https://api.github.com/users/m-ou-se/followers", "following_url": "https://api.github.com/users/m-ou-se/following{/other_user}", "gists_url": "https://api.github.com/users/m-ou-se/gists{/gist_id}", "starred_url": "https://api.github.com/users/m-ou-se/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/m-ou-se/subscriptions", "organizations_url": "https://api.github.com/users/m-ou-se/orgs", "repos_url": "https://api.github.com/users/m-ou-se/repos", "events_url": "https://api.github.com/users/m-ou-se/events{/privacy}", "received_events_url": "https://api.github.com/users/m-ou-se/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f85c3f72a4448424f2a3a63fedcbb9e33287c0e7", "url": "https://api.github.com/repos/rust-lang/rust/commits/f85c3f72a4448424f2a3a63fedcbb9e33287c0e7", "html_url": "https://github.com/rust-lang/rust/commit/f85c3f72a4448424f2a3a63fedcbb9e33287c0e7"}, {"sha": "9bbc4c16d31ec0c89aa5943fc1bfca8d8fc6f281", "url": "https://api.github.com/repos/rust-lang/rust/commits/9bbc4c16d31ec0c89aa5943fc1bfca8d8fc6f281", "html_url": "https://github.com/rust-lang/rust/commit/9bbc4c16d31ec0c89aa5943fc1bfca8d8fc6f281"}], "stats": {"total": 179, "additions": 178, "deletions": 1}, "files": [{"sha": "d67f9c15a1916dc218c5d27141df209076ca9659", "filename": "library/core/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/126d88bd12b1519847dc86a5f74d11ce5136f599/library%2Fcore%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/126d88bd12b1519847dc86a5f74d11ce5136f599/library%2Fcore%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Flib.rs?ref=126d88bd12b1519847dc86a5f74d11ce5136f599", "patch": "@@ -80,6 +80,7 @@\n #![feature(const_mut_refs)]\n #![feature(const_int_pow)]\n #![feature(constctlz)]\n+#![feature(const_cttz)]\n #![feature(const_panic)]\n #![feature(const_pin)]\n #![feature(const_fn)]"}, {"sha": "716b4a90e5ec279885a1647014449ccf9974d891", "filename": "library/core/src/num/nonzero.rs", "status": "modified", "additions": 74, "deletions": 0, "changes": 74, "blob_url": "https://github.com/rust-lang/rust/blob/126d88bd12b1519847dc86a5f74d11ce5136f599/library%2Fcore%2Fsrc%2Fnum%2Fnonzero.rs", "raw_url": "https://github.com/rust-lang/rust/raw/126d88bd12b1519847dc86a5f74d11ce5136f599/library%2Fcore%2Fsrc%2Fnum%2Fnonzero.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fnum%2Fnonzero.rs?ref=126d88bd12b1519847dc86a5f74d11ce5136f599", "patch": "@@ -6,6 +6,7 @@ use crate::str::FromStr;\n \n use super::from_str_radix;\n use super::{IntErrorKind, ParseIntError};\n+use crate::intrinsics;\n \n macro_rules! doc_comment {\n     ($x:expr, $($tt:tt)*) => {\n@@ -189,3 +190,76 @@ macro_rules! from_str_radix_nzint_impl {\n \n from_str_radix_nzint_impl! { NonZeroU8 NonZeroU16 NonZeroU32 NonZeroU64 NonZeroU128 NonZeroUsize\n NonZeroI8 NonZeroI16 NonZeroI32 NonZeroI64 NonZeroI128 NonZeroIsize }\n+\n+macro_rules! nonzero_leading_trailing_zeros {\n+    ( $( $Ty: ident($Uint: ty) , $LeadingTestExpr:expr ;)+ ) => {\n+        $(\n+            impl $Ty {\n+                doc_comment! {\n+                    concat!(\"Returns the number of leading zeros in the binary representation of `self`.\n+\n+On many architectures, this function can perform better than `leading_zeros()` on the underlying integer type, as special handling of zero can be avoided.\n+\n+# Examples\n+\n+Basic usage:\n+\n+```\n+#![feature(nonzero_leading_trailing_zeros)]\n+let n = std::num::\", stringify!($Ty), \"::new(\", stringify!($LeadingTestExpr), \").unwrap();\n+\n+assert_eq!(n.leading_zeros(), 0);\n+```\"),\n+                    #[unstable(feature = \"nonzero_leading_trailing_zeros\", issue = \"79143\")]\n+                    #[rustc_const_unstable(feature = \"nonzero_leading_trailing_zeros\", issue = \"79143\")]\n+                    #[inline]\n+                    pub const fn leading_zeros(self) -> u32 {\n+                        // SAFETY: since `self` can not be zero it is safe to call ctlz_nonzero\n+                        unsafe { intrinsics::ctlz_nonzero(self.0 as $Uint) as u32 }\n+                    }\n+                }\n+\n+                doc_comment! {\n+                    concat!(\"Returns the number of trailing zeros in the binary representation\n+of `self`.\n+\n+On many architectures, this function can perform better than `trailing_zeros()` on the underlying integer type, as special handling of zero can be avoided.\n+\n+# Examples\n+\n+Basic usage:\n+\n+```\n+#![feature(nonzero_leading_trailing_zeros)]\n+let n = std::num::\", stringify!($Ty), \"::new(0b0101000).unwrap();\n+\n+assert_eq!(n.trailing_zeros(), 3);\n+```\"),\n+                    #[unstable(feature = \"nonzero_leading_trailing_zeros\", issue = \"79143\")]\n+                    #[rustc_const_unstable(feature = \"nonzero_leading_trailing_zeros\", issue = \"79143\")]\n+                    #[inline]\n+                    pub const fn trailing_zeros(self) -> u32 {\n+                        // SAFETY: since `self` can not be zero it is safe to call cttz_nonzero\n+                        unsafe { intrinsics::cttz_nonzero(self.0 as $Uint) as u32 }\n+                    }\n+                }\n+\n+            }\n+        )+\n+    }\n+}\n+\n+nonzero_leading_trailing_zeros! {\n+    NonZeroU8(u8), u8::MAX;\n+    NonZeroU16(u16), u16::MAX;\n+    NonZeroU32(u32), u32::MAX;\n+    NonZeroU64(u64), u64::MAX;\n+    NonZeroU128(u128), u128::MAX;\n+    NonZeroUsize(usize), usize::MAX;\n+    NonZeroI8(u8), -1i8;\n+    NonZeroI16(u16), -1i16;\n+    NonZeroI32(u32), -1i32;\n+    NonZeroI64(u64), -1i64;\n+    NonZeroI128(u128), -1i128;\n+    NonZeroIsize(usize), -1isize;\n+}"}, {"sha": "14ef03fd53ebacbceaf5a9f37a21b6e2df0cbbec", "filename": "library/core/tests/lib.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/126d88bd12b1519847dc86a5f74d11ce5136f599/library%2Fcore%2Ftests%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/126d88bd12b1519847dc86a5f74d11ce5136f599/library%2Fcore%2Ftests%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Ftests%2Flib.rs?ref=126d88bd12b1519847dc86a5f74d11ce5136f599", "patch": "@@ -60,6 +60,8 @@\n #![feature(once_cell)]\n #![feature(unsafe_block_in_unsafe_fn)]\n #![feature(int_bits_const)]\n+#![feature(nonzero_leading_trailing_zeros)]\n+#![feature(const_option)]\n #![deny(unsafe_op_in_unsafe_fn)]\n \n extern crate test;"}, {"sha": "ca449b4350ede910479698cc7257cc64f2489d50", "filename": "library/core/tests/nonzero.rs", "status": "modified", "additions": 101, "deletions": 1, "changes": 102, "blob_url": "https://github.com/rust-lang/rust/blob/126d88bd12b1519847dc86a5f74d11ce5136f599/library%2Fcore%2Ftests%2Fnonzero.rs", "raw_url": "https://github.com/rust-lang/rust/raw/126d88bd12b1519847dc86a5f74d11ce5136f599/library%2Fcore%2Ftests%2Fnonzero.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Ftests%2Fnonzero.rs?ref=126d88bd12b1519847dc86a5f74d11ce5136f599", "patch": "@@ -1,5 +1,8 @@\n use core::convert::TryFrom;\n-use core::num::{IntErrorKind, NonZeroI32, NonZeroI8, NonZeroU32, NonZeroU8};\n+use core::num::{\n+    IntErrorKind, NonZeroI128, NonZeroI16, NonZeroI32, NonZeroI64, NonZeroI8, NonZeroIsize,\n+    NonZeroU128, NonZeroU16, NonZeroU32, NonZeroU64, NonZeroU8, NonZeroUsize,\n+};\n use core::option::Option::{self, None, Some};\n use std::mem::size_of;\n \n@@ -212,3 +215,100 @@ fn nonzero_const() {\n     const ONE: Option<NonZeroU8> = NonZeroU8::new(1);\n     assert!(ONE.is_some());\n }\n+\n+#[test]\n+fn nonzero_leading_zeros() {\n+    assert_eq!(NonZeroU8::new(1).unwrap().leading_zeros(), 7);\n+    assert_eq!(NonZeroI8::new(1).unwrap().leading_zeros(), 7);\n+    assert_eq!(NonZeroU16::new(1).unwrap().leading_zeros(), 15);\n+    assert_eq!(NonZeroI16::new(1).unwrap().leading_zeros(), 15);\n+    assert_eq!(NonZeroU32::new(1).unwrap().leading_zeros(), 31);\n+    assert_eq!(NonZeroI32::new(1).unwrap().leading_zeros(), 31);\n+    assert_eq!(NonZeroU64::new(1).unwrap().leading_zeros(), 63);\n+    assert_eq!(NonZeroI64::new(1).unwrap().leading_zeros(), 63);\n+    assert_eq!(NonZeroU128::new(1).unwrap().leading_zeros(), 127);\n+    assert_eq!(NonZeroI128::new(1).unwrap().leading_zeros(), 127);\n+    assert_eq!(NonZeroUsize::new(1).unwrap().leading_zeros(), usize::BITS - 1);\n+    assert_eq!(NonZeroIsize::new(1).unwrap().leading_zeros(), usize::BITS - 1);\n+\n+    assert_eq!(NonZeroU8::new(u8::MAX >> 2).unwrap().leading_zeros(), 2);\n+    assert_eq!(NonZeroI8::new((u8::MAX >> 2) as i8).unwrap().leading_zeros(), 2);\n+    assert_eq!(NonZeroU16::new(u16::MAX >> 2).unwrap().leading_zeros(), 2);\n+    assert_eq!(NonZeroI16::new((u16::MAX >> 2) as i16).unwrap().leading_zeros(), 2);\n+    assert_eq!(NonZeroU32::new(u32::MAX >> 2).unwrap().leading_zeros(), 2);\n+    assert_eq!(NonZeroI32::new((u32::MAX >> 2) as i32).unwrap().leading_zeros(), 2);\n+    assert_eq!(NonZeroU64::new(u64::MAX >> 2).unwrap().leading_zeros(), 2);\n+    assert_eq!(NonZeroI64::new((u64::MAX >> 2) as i64).unwrap().leading_zeros(), 2);\n+    assert_eq!(NonZeroU128::new(u128::MAX >> 2).unwrap().leading_zeros(), 2);\n+    assert_eq!(NonZeroI128::new((u128::MAX >> 2) as i128).unwrap().leading_zeros(), 2);\n+    assert_eq!(NonZeroUsize::new(usize::MAX >> 2).unwrap().leading_zeros(), 2);\n+    assert_eq!(NonZeroIsize::new((usize::MAX >> 2) as isize).unwrap().leading_zeros(), 2);\n+\n+    assert_eq!(NonZeroU8::new(u8::MAX).unwrap().leading_zeros(), 0);\n+    assert_eq!(NonZeroI8::new(-1i8).unwrap().leading_zeros(), 0);\n+    assert_eq!(NonZeroU16::new(u16::MAX).unwrap().leading_zeros(), 0);\n+    assert_eq!(NonZeroI16::new(-1i16).unwrap().leading_zeros(), 0);\n+    assert_eq!(NonZeroU32::new(u32::MAX).unwrap().leading_zeros(), 0);\n+    assert_eq!(NonZeroI32::new(-1i32).unwrap().leading_zeros(), 0);\n+    assert_eq!(NonZeroU64::new(u64::MAX).unwrap().leading_zeros(), 0);\n+    assert_eq!(NonZeroI64::new(-1i64).unwrap().leading_zeros(), 0);\n+    assert_eq!(NonZeroU128::new(u128::MAX).unwrap().leading_zeros(), 0);\n+    assert_eq!(NonZeroI128::new(-1i128).unwrap().leading_zeros(), 0);\n+    assert_eq!(NonZeroUsize::new(usize::MAX).unwrap().leading_zeros(), 0);\n+    assert_eq!(NonZeroIsize::new(-1isize).unwrap().leading_zeros(), 0);\n+\n+    const LEADING_ZEROS: u32 = NonZeroU16::new(1).unwrap().leading_zeros();\n+    assert_eq!(LEADING_ZEROS, 15);\n+}\n+\n+#[test]\n+fn nonzero_trailing_zeros() {\n+    assert_eq!(NonZeroU8::new(1).unwrap().trailing_zeros(), 0);\n+    assert_eq!(NonZeroI8::new(1).unwrap().trailing_zeros(), 0);\n+    assert_eq!(NonZeroU16::new(1).unwrap().trailing_zeros(), 0);\n+    assert_eq!(NonZeroI16::new(1).unwrap().trailing_zeros(), 0);\n+    assert_eq!(NonZeroU32::new(1).unwrap().trailing_zeros(), 0);\n+    assert_eq!(NonZeroI32::new(1).unwrap().trailing_zeros(), 0);\n+    assert_eq!(NonZeroU64::new(1).unwrap().trailing_zeros(), 0);\n+    assert_eq!(NonZeroI64::new(1).unwrap().trailing_zeros(), 0);\n+    assert_eq!(NonZeroU128::new(1).unwrap().trailing_zeros(), 0);\n+    assert_eq!(NonZeroI128::new(1).unwrap().trailing_zeros(), 0);\n+    assert_eq!(NonZeroUsize::new(1).unwrap().trailing_zeros(), 0);\n+    assert_eq!(NonZeroIsize::new(1).unwrap().trailing_zeros(), 0);\n+\n+    assert_eq!(NonZeroU8::new(1 << 2).unwrap().trailing_zeros(), 2);\n+    assert_eq!(NonZeroI8::new(1 << 2).unwrap().trailing_zeros(), 2);\n+    assert_eq!(NonZeroU16::new(1 << 2).unwrap().trailing_zeros(), 2);\n+    assert_eq!(NonZeroI16::new(1 << 2).unwrap().trailing_zeros(), 2);\n+    assert_eq!(NonZeroU32::new(1 << 2).unwrap().trailing_zeros(), 2);\n+    assert_eq!(NonZeroI32::new(1 << 2).unwrap().trailing_zeros(), 2);\n+    assert_eq!(NonZeroU64::new(1 << 2).unwrap().trailing_zeros(), 2);\n+    assert_eq!(NonZeroI64::new(1 << 2).unwrap().trailing_zeros(), 2);\n+    assert_eq!(NonZeroU128::new(1 << 2).unwrap().trailing_zeros(), 2);\n+    assert_eq!(NonZeroI128::new(1 << 2).unwrap().trailing_zeros(), 2);\n+    assert_eq!(NonZeroUsize::new(1 << 2).unwrap().trailing_zeros(), 2);\n+    assert_eq!(NonZeroIsize::new(1 << 2).unwrap().trailing_zeros(), 2);\n+\n+    assert_eq!(NonZeroU8::new(1 << 7).unwrap().trailing_zeros(), 7);\n+    assert_eq!(NonZeroI8::new(1 << 7).unwrap().trailing_zeros(), 7);\n+    assert_eq!(NonZeroU16::new(1 << 15).unwrap().trailing_zeros(), 15);\n+    assert_eq!(NonZeroI16::new(1 << 15).unwrap().trailing_zeros(), 15);\n+    assert_eq!(NonZeroU32::new(1 << 31).unwrap().trailing_zeros(), 31);\n+    assert_eq!(NonZeroI32::new(1 << 31).unwrap().trailing_zeros(), 31);\n+    assert_eq!(NonZeroU64::new(1 << 63).unwrap().trailing_zeros(), 63);\n+    assert_eq!(NonZeroI64::new(1 << 63).unwrap().trailing_zeros(), 63);\n+    assert_eq!(NonZeroU128::new(1 << 127).unwrap().trailing_zeros(), 127);\n+    assert_eq!(NonZeroI128::new(1 << 127).unwrap().trailing_zeros(), 127);\n+\n+    assert_eq!(\n+        NonZeroUsize::new(1 << (usize::BITS - 1)).unwrap().trailing_zeros(),\n+        usize::BITS - 1\n+    );\n+    assert_eq!(\n+        NonZeroIsize::new(1 << (usize::BITS - 1)).unwrap().trailing_zeros(),\n+        usize::BITS - 1\n+    );\n+\n+    const TRAILING_ZEROS: u32 = NonZeroU16::new(1 << 2).unwrap().trailing_zeros();\n+    assert_eq!(TRAILING_ZEROS, 2);\n+}"}]}