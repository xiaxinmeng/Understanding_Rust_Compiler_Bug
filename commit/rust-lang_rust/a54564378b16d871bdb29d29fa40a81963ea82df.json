{"sha": "a54564378b16d871bdb29d29fa40a81963ea82df", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE1NDU2NDM3OGIxNmQ4NzFiZGIyOWQyOWZhNDBhODE5NjNlYTgyZGY=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-03-17T21:24:51Z"}, "committer": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-03-17T21:24:51Z"}, "message": "Fix `use crate as <name>;` imports", "tree": {"sha": "cd2e2d156a93ad917adb9c2bf5b126e6e68ed6fa", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cd2e2d156a93ad917adb9c2bf5b126e6e68ed6fa"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a54564378b16d871bdb29d29fa40a81963ea82df", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a54564378b16d871bdb29d29fa40a81963ea82df", "html_url": "https://github.com/rust-lang/rust/commit/a54564378b16d871bdb29d29fa40a81963ea82df", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a54564378b16d871bdb29d29fa40a81963ea82df/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9d691530d556bdc40262585383a1b18d3a1de07e", "url": "https://api.github.com/repos/rust-lang/rust/commits/9d691530d556bdc40262585383a1b18d3a1de07e", "html_url": "https://github.com/rust-lang/rust/commit/9d691530d556bdc40262585383a1b18d3a1de07e"}], "stats": {"total": 53, "additions": 37, "deletions": 16}, "files": [{"sha": "b5ae5a9e44b9945b6908137826f6d0a47b466acf", "filename": "crates/hir_def/src/nameres/collector.rs", "status": "modified", "additions": 18, "deletions": 16, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/a54564378b16d871bdb29d29fa40a81963ea82df/crates%2Fhir_def%2Fsrc%2Fnameres%2Fcollector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a54564378b16d871bdb29d29fa40a81963ea82df/crates%2Fhir_def%2Fsrc%2Fnameres%2Fcollector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fnameres%2Fcollector.rs?ref=a54564378b16d871bdb29d29fa40a81963ea82df", "patch": "@@ -656,26 +656,28 @@ impl DefCollector<'_> {\n                 }\n             }\n         } else {\n-            match import.path.segments().last() {\n-                Some(last_segment) => {\n-                    let name = match &import.alias {\n-                        Some(ImportAlias::Alias(name)) => Some(name.clone()),\n-                        Some(ImportAlias::Underscore) => None,\n-                        None => Some(last_segment.clone()),\n-                    };\n-                    log::debug!(\"resolved import {:?} ({:?}) to {:?}\", name, import, def);\n-\n-                    // extern crates in the crate root are special-cased to insert entries into the extern prelude: rust-lang/rust#54658\n-                    if import.is_extern_crate && module_id == self.def_map.root {\n-                        if let (Some(def), Some(name)) = (def.take_types(), name.as_ref()) {\n-                            self.def_map.extern_prelude.insert(name.clone(), def);\n-                        }\n+            let name = match &import.alias {\n+                Some(ImportAlias::Alias(name)) => Some(name.clone()),\n+                Some(ImportAlias::Underscore) => None,\n+                None => match import.path.segments().last() {\n+                    Some(last_segment) => Some(last_segment.clone()),\n+                    None => {\n+                        cov_mark::hit!(bogus_paths);\n+                        return;\n                     }\n+                },\n+            };\n+\n+            log::debug!(\"resolved import {:?} ({:?}) to {:?}\", name, import, def);\n \n-                    self.update(module_id, &[(name, def)], vis, ImportType::Named);\n+            // extern crates in the crate root are special-cased to insert entries into the extern prelude: rust-lang/rust#54658\n+            if import.is_extern_crate && module_id == self.def_map.root {\n+                if let (Some(def), Some(name)) = (def.take_types(), name.as_ref()) {\n+                    self.def_map.extern_prelude.insert(name.clone(), def);\n                 }\n-                None => cov_mark::hit!(bogus_paths),\n             }\n+\n+            self.update(module_id, &[(name, def)], vis, ImportType::Named);\n         }\n     }\n "}, {"sha": "4f2e7a2f96a6787aa1a28682f5225d12f9e8d4ff", "filename": "crates/hir_def/src/nameres/tests.rs", "status": "modified", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/a54564378b16d871bdb29d29fa40a81963ea82df/crates%2Fhir_def%2Fsrc%2Fnameres%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a54564378b16d871bdb29d29fa40a81963ea82df/crates%2Fhir_def%2Fsrc%2Fnameres%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fnameres%2Ftests.rs?ref=a54564378b16d871bdb29d29fa40a81963ea82df", "patch": "@@ -713,3 +713,22 @@ pub fn f() {}\n         \"#]],\n     );\n }\n+\n+#[test]\n+fn use_crate_as() {\n+    check(\n+        r#\"\n+use crate as foo;\n+\n+use foo::bar as baz;\n+\n+fn bar() {}\n+        \"#,\n+        expect![[r#\"\n+            crate\n+            bar: v\n+            baz: v\n+            foo: t\n+        \"#]],\n+    );\n+}"}]}