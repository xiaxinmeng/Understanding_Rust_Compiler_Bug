{"sha": "224387a4de8b780dee0014ba61a6fcad20726f5f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjIyNDM4N2E0ZGU4Yjc4MGRlZTAwMTRiYTYxYTZmY2FkMjA3MjZmNWY=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-11-23T07:05:31Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-11-23T07:05:31Z"}, "message": "Merge #6606\n\n6606: Parse unsafe extern block r=lnicola a=dtolnay\n\n`unsafe extern` block is parsed successfully by rustc, which means it is usable in attribute macro input.\r\nhttps://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=6f805556f176d082d87255957f16b5f6\r\n\r\n```rust\r\n#[cfg(parse)]\r\nunsafe extern \"C++\" {\r\n    fn demo();\r\n}\r\n```\r\n\r\n```diff\r\n  SOURCE_FILE@0..52\r\n-   ERROR@0..33\r\n+   EXTERN_BLOCK@0..52\r\n      ATTR@0..13\r\n        POUND@0..1 \"#\"\r\n        L_BRACK@1..2 \"[\"\r\n        PATH@2..5\r\n          PATH_SEGMENT@2..5\r\n            NAME_REF@2..5\r\n              IDENT@2..5 \"cfg\"\r\n        TOKEN_TREE@5..12\r\n          L_PAREN@5..6 \"(\"\r\n          IDENT@6..11 \"parse\"\r\n          R_PAREN@11..12 \")\"\r\n        R_BRACK@12..13 \"]\"\r\n      WHITESPACE@13..14 \"\\n\"\r\n      UNSAFE_KW@14..20 \"unsafe\"\r\n      WHITESPACE@20..21 \" \"\r\n      ABI@21..33\r\n        EXTERN_KW@21..27 \"extern\"\r\n        WHITESPACE@27..28 \" \"\r\n        STRING@28..33 \"\\\"C++\\\"\"\r\n-   WHITESPACE@33..34 \" \"\r\n-   ERROR@34..52\r\n-     L_CURLY@34..35 \"{\"\r\n-     WHITESPACE@35..40 \"\\n    \"\r\n-     FN@40..50\r\n-       FN_KW@40..42 \"fn\"\r\n-       WHITESPACE@42..43 \" \"\r\n-       NAME@43..47\r\n-         IDENT@43..47 \"demo\"\r\n-       PARAM_LIST@47..49\r\n-         L_PAREN@47..48 \"(\"\r\n-         R_PAREN@48..49 \")\"\r\n-       SEMICOLON@49..50 \";\"\r\n-     WHITESPACE@50..51 \"\\n\"\r\n-     R_CURLY@51..52 \"}\"\r\n+     WHITESPACE@33..34 \" \"\r\n+     EXTERN_ITEM_LIST@34..52\r\n+       L_CURLY@34..35 \"{\"\r\n+       WHITESPACE@35..40 \"\\n    \"\r\n+       FN@40..50\r\n+         FN_KW@40..42 \"fn\"\r\n+         WHITESPACE@42..43 \" \"\r\n+         NAME@43..47\r\n+           IDENT@43..47 \"demo\"\r\n+         PARAM_LIST@47..49\r\n+           L_PAREN@47..48 \"(\"\r\n+           R_PAREN@48..49 \")\"\r\n+         SEMICOLON@49..50 \";\"\r\n+       WHITESPACE@50..51 \"\\n\"\r\n+       R_CURLY@51..52 \"}\"\r\n```\r\n\r\nThis is of interest for https://github.com/dtolnay/cxx.\n\nCo-authored-by: David Tolnay <dtolnay@gmail.com>", "tree": {"sha": "658935369dc3ce1601a153ad55fd2eec787c4db9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/658935369dc3ce1601a153ad55fd2eec787c4db9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/224387a4de8b780dee0014ba61a6fcad20726f5f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfu187CRBK7hj4Ov3rIwAAdHIIAAPI6sXrNWpHl1yQQsr8cfIa\n0Pd99KqACNW50Bzq8kXvZqqeGr9eabLWFMcN4uf8XXKsjp+s6aFAJTnlp5+vCJag\nFXHxEW8L2dcjwHKR4MO6bkUuOdh+Rq6TsFPpTDTDm8TvRYYTL8ySM7LC8XpLHhdK\nk0BciensFjtkREz33t+7j9mSDmp7hO+um5cjGpbtcbJt+jbCc0s3qIYjpHTmVhF4\ngFmi97Od9Ip2xWmLjJPC/otE+0SOgcQ/uLwiqKu2Dtl/8dPRfqQNvI662RNX42Oc\nwiFR0aKJ38sPvDht/GrXgN0abqXiAHmpV2cJteW6OaxH/Qy/5sdR8DEMzwhSSSw=\n=YoAO\n-----END PGP SIGNATURE-----\n", "payload": "tree 658935369dc3ce1601a153ad55fd2eec787c4db9\nparent cadf0e9fb630d04367ef2611383865963d84ab54\nparent 8a11da40a789e5d73c5c11d69ba87638ddff8676\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1606115131 +0000\ncommitter GitHub <noreply@github.com> 1606115131 +0000\n\nMerge #6606\n\n6606: Parse unsafe extern block r=lnicola a=dtolnay\n\n`unsafe extern` block is parsed successfully by rustc, which means it is usable in attribute macro input.\r\nhttps://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=6f805556f176d082d87255957f16b5f6\r\n\r\n```rust\r\n#[cfg(parse)]\r\nunsafe extern \"C++\" {\r\n    fn demo();\r\n}\r\n```\r\n\r\n```diff\r\n  SOURCE_FILE@0..52\r\n-   ERROR@0..33\r\n+   EXTERN_BLOCK@0..52\r\n      ATTR@0..13\r\n        POUND@0..1 \"#\"\r\n        L_BRACK@1..2 \"[\"\r\n        PATH@2..5\r\n          PATH_SEGMENT@2..5\r\n            NAME_REF@2..5\r\n              IDENT@2..5 \"cfg\"\r\n        TOKEN_TREE@5..12\r\n          L_PAREN@5..6 \"(\"\r\n          IDENT@6..11 \"parse\"\r\n          R_PAREN@11..12 \")\"\r\n        R_BRACK@12..13 \"]\"\r\n      WHITESPACE@13..14 \"\\n\"\r\n      UNSAFE_KW@14..20 \"unsafe\"\r\n      WHITESPACE@20..21 \" \"\r\n      ABI@21..33\r\n        EXTERN_KW@21..27 \"extern\"\r\n        WHITESPACE@27..28 \" \"\r\n        STRING@28..33 \"\\\"C++\\\"\"\r\n-   WHITESPACE@33..34 \" \"\r\n-   ERROR@34..52\r\n-     L_CURLY@34..35 \"{\"\r\n-     WHITESPACE@35..40 \"\\n    \"\r\n-     FN@40..50\r\n-       FN_KW@40..42 \"fn\"\r\n-       WHITESPACE@42..43 \" \"\r\n-       NAME@43..47\r\n-         IDENT@43..47 \"demo\"\r\n-       PARAM_LIST@47..49\r\n-         L_PAREN@47..48 \"(\"\r\n-         R_PAREN@48..49 \")\"\r\n-       SEMICOLON@49..50 \";\"\r\n-     WHITESPACE@50..51 \"\\n\"\r\n-     R_CURLY@51..52 \"}\"\r\n+     WHITESPACE@33..34 \" \"\r\n+     EXTERN_ITEM_LIST@34..52\r\n+       L_CURLY@34..35 \"{\"\r\n+       WHITESPACE@35..40 \"\\n    \"\r\n+       FN@40..50\r\n+         FN_KW@40..42 \"fn\"\r\n+         WHITESPACE@42..43 \" \"\r\n+         NAME@43..47\r\n+           IDENT@43..47 \"demo\"\r\n+         PARAM_LIST@47..49\r\n+           L_PAREN@47..48 \"(\"\r\n+           R_PAREN@48..49 \")\"\r\n+         SEMICOLON@49..50 \";\"\r\n+       WHITESPACE@50..51 \"\\n\"\r\n+       R_CURLY@51..52 \"}\"\r\n```\r\n\r\nThis is of interest for https://github.com/dtolnay/cxx.\n\nCo-authored-by: David Tolnay <dtolnay@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/224387a4de8b780dee0014ba61a6fcad20726f5f", "html_url": "https://github.com/rust-lang/rust/commit/224387a4de8b780dee0014ba61a6fcad20726f5f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/224387a4de8b780dee0014ba61a6fcad20726f5f/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cadf0e9fb630d04367ef2611383865963d84ab54", "url": "https://api.github.com/repos/rust-lang/rust/commits/cadf0e9fb630d04367ef2611383865963d84ab54", "html_url": "https://github.com/rust-lang/rust/commit/cadf0e9fb630d04367ef2611383865963d84ab54"}, {"sha": "8a11da40a789e5d73c5c11d69ba87638ddff8676", "url": "https://api.github.com/repos/rust-lang/rust/commits/8a11da40a789e5d73c5c11d69ba87638ddff8676", "html_url": "https://github.com/rust-lang/rust/commit/8a11da40a789e5d73c5c11d69ba87638ddff8676"}], "stats": {"total": 28, "additions": 25, "deletions": 3}, "files": [{"sha": "ad29b82f7785b81be5f599bba671e3f3bd19a44a", "filename": "crates/parser/src/grammar/items.rs", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/224387a4de8b780dee0014ba61a6fcad20726f5f/crates%2Fparser%2Fsrc%2Fgrammar%2Fitems.rs", "raw_url": "https://github.com/rust-lang/rust/raw/224387a4de8b780dee0014ba61a6fcad20726f5f/crates%2Fparser%2Fsrc%2Fgrammar%2Fitems.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fparser%2Fsrc%2Fgrammar%2Fitems.rs?ref=224387a4de8b780dee0014ba61a6fcad20726f5f", "patch": "@@ -112,7 +112,7 @@ pub(super) fn maybe_item(p: &mut Parser, m: Marker) -> Result<(), Marker> {\n         has_mods = true;\n     }\n \n-    if p.at(T![extern]) {\n+    if p.at(T![extern]) && p.nth(1) != T!['{'] && (p.nth(1) != STRING || p.nth(2) != T!['{']) {\n         has_mods = true;\n         abi(p);\n     }\n@@ -181,6 +181,14 @@ pub(super) fn maybe_item(p: &mut Parser, m: Marker) -> Result<(), Marker> {\n         T![type] => {\n             type_alias(p, m);\n         }\n+\n+        // unsafe extern \"C\" {}\n+        T![extern] => {\n+            abi(p);\n+            extern_item_list(p);\n+            m.complete(p, EXTERN_BLOCK);\n+        }\n+\n         _ => {\n             if !has_visibility && !has_mods {\n                 return Err(m);"}, {"sha": "87eebf18574f46afbe105d49d9bc8e9c17c162e6", "filename": "crates/syntax/test_data/parser/ok/0068_item_modifiers.rast", "status": "modified", "additions": 14, "deletions": 2, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/224387a4de8b780dee0014ba61a6fcad20726f5f/crates%2Fsyntax%2Ftest_data%2Fparser%2Fok%2F0068_item_modifiers.rast", "raw_url": "https://github.com/rust-lang/rust/raw/224387a4de8b780dee0014ba61a6fcad20726f5f/crates%2Fsyntax%2Ftest_data%2Fparser%2Fok%2F0068_item_modifiers.rast", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fsyntax%2Ftest_data%2Fparser%2Fok%2F0068_item_modifiers.rast?ref=224387a4de8b780dee0014ba61a6fcad20726f5f", "patch": "@@ -1,4 +1,4 @@\n-SOURCE_FILE@0..304\n+SOURCE_FILE@0..328\n   FN@0..17\n     ASYNC_KW@0..5 \"async\"\n     WHITESPACE@5..6 \" \"\n@@ -215,4 +215,16 @@ SOURCE_FILE@0..304\n     ASSOC_ITEM_LIST@301..303\n       L_CURLY@301..302 \"{\"\n       R_CURLY@302..303 \"}\"\n-  WHITESPACE@303..304 \"\\n\"\n+  WHITESPACE@303..305 \"\\n\\n\"\n+  EXTERN_BLOCK@305..327\n+    UNSAFE_KW@305..311 \"unsafe\"\n+    WHITESPACE@311..312 \" \"\n+    ABI@312..324\n+      EXTERN_KW@312..318 \"extern\"\n+      WHITESPACE@318..319 \" \"\n+      STRING@319..324 \"\\\"C++\\\"\"\n+    WHITESPACE@324..325 \" \"\n+    EXTERN_ITEM_LIST@325..327\n+      L_CURLY@325..326 \"{\"\n+      R_CURLY@326..327 \"}\"\n+  WHITESPACE@327..328 \"\\n\""}, {"sha": "6d27a082cb3670e68cd9f5035ebedf97451e98d1", "filename": "crates/syntax/test_data/parser/ok/0068_item_modifiers.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/224387a4de8b780dee0014ba61a6fcad20726f5f/crates%2Fsyntax%2Ftest_data%2Fparser%2Fok%2F0068_item_modifiers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/224387a4de8b780dee0014ba61a6fcad20726f5f/crates%2Fsyntax%2Ftest_data%2Fparser%2Fok%2F0068_item_modifiers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fsyntax%2Ftest_data%2Fparser%2Fok%2F0068_item_modifiers.rs?ref=224387a4de8b780dee0014ba61a6fcad20726f5f", "patch": "@@ -14,3 +14,5 @@ unsafe auto trait T {}\n unsafe impl Foo {}\n default impl Foo {}\n unsafe default impl Foo {}\n+\n+unsafe extern \"C++\" {}"}]}