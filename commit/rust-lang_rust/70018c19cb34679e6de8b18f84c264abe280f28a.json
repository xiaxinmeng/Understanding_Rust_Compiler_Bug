{"sha": "70018c19cb34679e6de8b18f84c264abe280f28a", "node_id": "C_kwDOAAsO6NoAKDcwMDE4YzE5Y2IzNDY3OWU2ZGU4YjE4Zjg0YzI2NGFiZTI4MGYyOGE", "commit": {"author": {"name": "lcnr", "email": "rust@lcnr.de", "date": "2022-02-24T07:36:29Z"}, "committer": {"name": "lcnr", "email": "rust@lcnr.de", "date": "2022-02-24T07:36:29Z"}, "message": "update auto trait lint", "tree": {"sha": "b0a661370505cb87acefd3638563ec0ed320cbc3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b0a661370505cb87acefd3638563ec0ed320cbc3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/70018c19cb34679e6de8b18f84c264abe280f28a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/70018c19cb34679e6de8b18f84c264abe280f28a", "html_url": "https://github.com/rust-lang/rust/commit/70018c19cb34679e6de8b18f84c264abe280f28a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/70018c19cb34679e6de8b18f84c264abe280f28a/comments", "author": {"login": "lcnr", "id": 29864074, "node_id": "MDQ6VXNlcjI5ODY0MDc0", "avatar_url": "https://avatars.githubusercontent.com/u/29864074?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lcnr", "html_url": "https://github.com/lcnr", "followers_url": "https://api.github.com/users/lcnr/followers", "following_url": "https://api.github.com/users/lcnr/following{/other_user}", "gists_url": "https://api.github.com/users/lcnr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lcnr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lcnr/subscriptions", "organizations_url": "https://api.github.com/users/lcnr/orgs", "repos_url": "https://api.github.com/users/lcnr/repos", "events_url": "https://api.github.com/users/lcnr/events{/privacy}", "received_events_url": "https://api.github.com/users/lcnr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lcnr", "id": 29864074, "node_id": "MDQ6VXNlcjI5ODY0MDc0", "avatar_url": "https://avatars.githubusercontent.com/u/29864074?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lcnr", "html_url": "https://github.com/lcnr", "followers_url": "https://api.github.com/users/lcnr/followers", "following_url": "https://api.github.com/users/lcnr/following{/other_user}", "gists_url": "https://api.github.com/users/lcnr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lcnr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lcnr/subscriptions", "organizations_url": "https://api.github.com/users/lcnr/orgs", "repos_url": "https://api.github.com/users/lcnr/repos", "events_url": "https://api.github.com/users/lcnr/events{/privacy}", "received_events_url": "https://api.github.com/users/lcnr/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e780264e1e5c1efa6ab76c7b17a9677f16add5e0", "url": "https://api.github.com/repos/rust-lang/rust/commits/e780264e1e5c1efa6ab76c7b17a9677f16add5e0", "html_url": "https://github.com/rust-lang/rust/commit/e780264e1e5c1efa6ab76c7b17a9677f16add5e0"}], "stats": {"total": 40, "additions": 33, "deletions": 7}, "files": [{"sha": "811136a7eb4ee573aeb6237f2592fef392e387de", "filename": "compiler/rustc_typeck/src/coherence/orphan.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/70018c19cb34679e6de8b18f84c264abe280f28a/compiler%2Frustc_typeck%2Fsrc%2Fcoherence%2Forphan.rs", "raw_url": "https://github.com/rust-lang/rust/raw/70018c19cb34679e6de8b18f84c264abe280f28a/compiler%2Frustc_typeck%2Fsrc%2Fcoherence%2Forphan.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcoherence%2Forphan.rs?ref=70018c19cb34679e6de8b18f84c264abe280f28a", "patch": "@@ -439,6 +439,7 @@ fn fast_reject_auto_impl<'tcx>(tcx: TyCtxt<'tcx>, trait_def_id: DefId, self_ty:\n             }\n \n             match t.kind() {\n+                ty::Adt(def, substs) if def.is_phantom_data() => substs.super_visit_with(self),\n                 ty::Adt(def, substs) => {\n                     // @lcnr: This is the only place where cycles can happen. We avoid this\n                     // by only visiting each `DefId` once."}, {"sha": "1574a7e02e97fd7b5548217d8491ab86543e53eb", "filename": "src/test/ui/auto-traits/suspicious-impls-lint.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/70018c19cb34679e6de8b18f84c264abe280f28a/src%2Ftest%2Fui%2Fauto-traits%2Fsuspicious-impls-lint.rs", "raw_url": "https://github.com/rust-lang/rust/raw/70018c19cb34679e6de8b18f84c264abe280f28a/src%2Ftest%2Fui%2Fauto-traits%2Fsuspicious-impls-lint.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fauto-traits%2Fsuspicious-impls-lint.rs?ref=70018c19cb34679e6de8b18f84c264abe280f28a", "patch": "@@ -1,5 +1,7 @@\n #![deny(suspicious_auto_trait_impls)]\n \n+use std::marker::PhantomData;\n+\n struct MayImplementSendOk<T>(T);\n unsafe impl<T: Send> Send for MayImplementSendOk<T> {} // ok\n \n@@ -31,4 +33,12 @@ unsafe impl<T: Send> Send for TwoParamsSame<T, T> {}\n //~^ ERROR\n //~| WARNING this will change its meaning\n \n+pub struct WithPhantomDataNonSend<T, U>(PhantomData<*const T>, U);\n+unsafe impl<T> Send for WithPhantomDataNonSend<T, i8> {} // ok\n+\n+pub struct WithPhantomDataSend<T, U>(PhantomData<T>, U);\n+unsafe impl<T> Send for WithPhantomDataSend<*const T, i8> {}\n+//~^ ERROR\n+//~| WARNING this will change its meaning\n+\n fn main() {}"}, {"sha": "084bfef49c029f5727cc3cdad9605df8de37491e", "filename": "src/test/ui/auto-traits/suspicious-impls-lint.stderr", "status": "modified", "additions": 22, "deletions": 7, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/70018c19cb34679e6de8b18f84c264abe280f28a/src%2Ftest%2Fui%2Fauto-traits%2Fsuspicious-impls-lint.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/70018c19cb34679e6de8b18f84c264abe280f28a/src%2Ftest%2Fui%2Fauto-traits%2Fsuspicious-impls-lint.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fauto-traits%2Fsuspicious-impls-lint.stderr?ref=70018c19cb34679e6de8b18f84c264abe280f28a", "patch": "@@ -1,5 +1,5 @@\n error: cross-crate traits with a default impl, like `Send`, should not be specialized\n-  --> $DIR/suspicious-impls-lint.rs:7:1\n+  --> $DIR/suspicious-impls-lint.rs:9:1\n    |\n LL | unsafe impl<T: Send> Send for MayImplementSendErr<&T> {}\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n@@ -12,41 +12,56 @@ LL | #![deny(suspicious_auto_trait_impls)]\n    = warning: this will change its meaning in a future release!\n    = note: for more information, see issue #93367 <https://github.com/rust-lang/rust/issues/93367>\n note: try using the same sequence of generic parameters as the struct definition\n-  --> $DIR/suspicious-impls-lint.rs:6:1\n+  --> $DIR/suspicious-impls-lint.rs:8:1\n    |\n LL | struct MayImplementSendErr<T>(T);\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    = note: `&T` is not a generic parameter\n \n error: cross-crate traits with a default impl, like `Send`, should not be specialized\n-  --> $DIR/suspicious-impls-lint.rs:19:1\n+  --> $DIR/suspicious-impls-lint.rs:21:1\n    |\n LL | unsafe impl Send for ContainsVec<i32> {}\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |\n    = warning: this will change its meaning in a future release!\n    = note: for more information, see issue #93367 <https://github.com/rust-lang/rust/issues/93367>\n note: try using the same sequence of generic parameters as the struct definition\n-  --> $DIR/suspicious-impls-lint.rs:18:1\n+  --> $DIR/suspicious-impls-lint.rs:20:1\n    |\n LL | struct ContainsVec<T>(Vec<T>);\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    = note: `i32` is not a generic parameter\n \n error: cross-crate traits with a default impl, like `Send`, should not be specialized\n-  --> $DIR/suspicious-impls-lint.rs:30:1\n+  --> $DIR/suspicious-impls-lint.rs:32:1\n    |\n LL | unsafe impl<T: Send> Send for TwoParamsSame<T, T> {}\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |\n    = warning: this will change its meaning in a future release!\n    = note: for more information, see issue #93367 <https://github.com/rust-lang/rust/issues/93367>\n note: try using the same sequence of generic parameters as the struct definition\n-  --> $DIR/suspicious-impls-lint.rs:29:1\n+  --> $DIR/suspicious-impls-lint.rs:31:1\n    |\n LL | struct TwoParamsSame<T, U>(T, U);\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    = note: `T` is mentioned multiple times\n \n-error: aborting due to 3 previous errors\n+error: cross-crate traits with a default impl, like `Send`, should not be specialized\n+  --> $DIR/suspicious-impls-lint.rs:40:1\n+   |\n+LL | unsafe impl<T> Send for WithPhantomDataSend<*const T, i8> {}\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+   = warning: this will change its meaning in a future release!\n+   = note: for more information, see issue #93367 <https://github.com/rust-lang/rust/issues/93367>\n+note: try using the same sequence of generic parameters as the struct definition\n+  --> $DIR/suspicious-impls-lint.rs:39:1\n+   |\n+LL | pub struct WithPhantomDataSend<T, U>(PhantomData<T>, U);\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   = note: `*const T` is not a generic parameter\n+\n+error: aborting due to 4 previous errors\n "}]}