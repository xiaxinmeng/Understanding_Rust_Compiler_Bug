{"sha": "5873fe8851ef9815344ddb665c60e48a71413109", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU4NzNmZTg4NTFlZjk4MTUzNDRkZGI2NjVjNjBlNDhhNzE0MTMxMDk=", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2020-12-17T10:36:54Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-12-17T10:36:54Z"}, "message": "Rollup merge of #80047 - jyn514:more-symbols, r=GuillaumeGomez\n\nUse more symbols in rustdoc\n\nBuilds on https://github.com/rust-lang/rust/pull/80044 and should not be merged before.\n\nI want to test if this is actually faster before merging it, there was a lot of `to_string()` calls so I'm not sure it will actually help. That means I have to wait for 80044 to get merged before running perf.\n\nr? `@ghost`", "tree": {"sha": "8498f4f5665b8f56fb3fbba20705628a6008d34d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8498f4f5665b8f56fb3fbba20705628a6008d34d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5873fe8851ef9815344ddb665c60e48a71413109", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJf2zTHCRBK7hj4Ov3rIwAAdHIIAAiy74JELJzrJeYI7ibpjPB7\nxwClIAVLRn+fPofTX3aM8tH4up9AhuPZcRfgdfVWoYicfxQIpAyMJ+pS+3P2k83E\n0kqQXFFLUdr3pBxv1qKoj25XJVPOh7i0VCfMpad31Sm/bPmiAV1IvyZQHPRuNkYN\nCBJzzJUteNyHN7jDIQS+c9BCOs4jBcHfIaXPYKiar7R1TpgV8QTRCmjtKbg7aiLH\nSpHbjIN1B7ZbeG3Cc+h4IwaULKF9LET/DU/1Xu1DY/FhYQeKD0l2h3aK3l3daP55\n35ORJ7lZBZyGfCIyMpmDt9fRKo0nFFKqIPE4y/xAn8S5Hyx1R9xLqL6ixEDqWzo=\n=Fizt\n-----END PGP SIGNATURE-----\n", "payload": "tree 8498f4f5665b8f56fb3fbba20705628a6008d34d\nparent 1f5d8de0627738ee7b0d5bcf5bcc9080a519f2f0\nparent 7ee8e1816f6603502e36b105990bca0f7e440816\nauthor Guillaume Gomez <guillaume1.gomez@gmail.com> 1608201414 +0100\ncommitter GitHub <noreply@github.com> 1608201414 +0100\n\nRollup merge of #80047 - jyn514:more-symbols, r=GuillaumeGomez\n\nUse more symbols in rustdoc\n\nBuilds on https://github.com/rust-lang/rust/pull/80044 and should not be merged before.\n\nI want to test if this is actually faster before merging it, there was a lot of `to_string()` calls so I'm not sure it will actually help. That means I have to wait for 80044 to get merged before running perf.\n\nr? `@ghost`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5873fe8851ef9815344ddb665c60e48a71413109", "html_url": "https://github.com/rust-lang/rust/commit/5873fe8851ef9815344ddb665c60e48a71413109", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5873fe8851ef9815344ddb665c60e48a71413109/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1f5d8de0627738ee7b0d5bcf5bcc9080a519f2f0", "url": "https://api.github.com/repos/rust-lang/rust/commits/1f5d8de0627738ee7b0d5bcf5bcc9080a519f2f0", "html_url": "https://github.com/rust-lang/rust/commit/1f5d8de0627738ee7b0d5bcf5bcc9080a519f2f0"}, {"sha": "7ee8e1816f6603502e36b105990bca0f7e440816", "url": "https://api.github.com/repos/rust-lang/rust/commits/7ee8e1816f6603502e36b105990bca0f7e440816", "html_url": "https://github.com/rust-lang/rust/commit/7ee8e1816f6603502e36b105990bca0f7e440816"}], "stats": {"total": 59, "additions": 29, "deletions": 30}, "files": [{"sha": "1f3482d6200cb27a0b91bb9095b28be74df9959b", "filename": "src/librustdoc/clean/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/5873fe8851ef9815344ddb665c60e48a71413109/src%2Flibrustdoc%2Fclean%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5873fe8851ef9815344ddb665c60e48a71413109/src%2Flibrustdoc%2Fclean%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Fmod.rs?ref=5873fe8851ef9815344ddb665c60e48a71413109", "patch": "@@ -207,7 +207,7 @@ impl Clean<ExternalCrate> for CrateNum {\n         };\n \n         ExternalCrate {\n-            name: cx.tcx.crate_name(*self).to_string(),\n+            name: cx.tcx.crate_name(*self),\n             src: krate_src,\n             attrs: cx.tcx.get_attrs(root).clean(cx),\n             primitives,"}, {"sha": "8c216598723cddff20d97bd2133c7ad68ae2828c", "filename": "src/librustdoc/clean/types.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/5873fe8851ef9815344ddb665c60e48a71413109/src%2Flibrustdoc%2Fclean%2Ftypes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5873fe8851ef9815344ddb665c60e48a71413109/src%2Flibrustdoc%2Fclean%2Ftypes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Ftypes.rs?ref=5873fe8851ef9815344ddb665c60e48a71413109", "patch": "@@ -51,7 +51,7 @@ thread_local!(crate static MAX_DEF_ID: RefCell<FxHashMap<CrateNum, DefId>> = Def\n \n #[derive(Clone, Debug)]\n crate struct Crate {\n-    crate name: String,\n+    crate name: Symbol,\n     crate version: Option<String>,\n     crate src: FileName,\n     crate module: Option<Item>,\n@@ -66,7 +66,7 @@ crate struct Crate {\n \n #[derive(Clone, Debug)]\n crate struct ExternalCrate {\n-    crate name: String,\n+    crate name: Symbol,\n     crate src: FileName,\n     crate attrs: Attributes,\n     crate primitives: Vec<(DefId, PrimitiveType)>,"}, {"sha": "77a3e9fa9549b4780de2dcc898c0fadd18579a34", "filename": "src/librustdoc/formats/cache.rs", "status": "modified", "additions": 6, "deletions": 5, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/5873fe8851ef9815344ddb665c60e48a71413109/src%2Flibrustdoc%2Fformats%2Fcache.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5873fe8851ef9815344ddb665c60e48a71413109/src%2Flibrustdoc%2Fformats%2Fcache.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fformats%2Fcache.rs?ref=5873fe8851ef9815344ddb665c60e48a71413109", "patch": "@@ -8,6 +8,7 @@ use rustc_data_structures::fx::{FxHashMap, FxHashSet};\n use rustc_hir::def_id::{CrateNum, DefId, CRATE_DEF_INDEX};\n use rustc_middle::middle::privacy::AccessLevels;\n use rustc_span::source_map::FileName;\n+use rustc_span::Symbol;\n \n use crate::clean::{self, GetDefId};\n use crate::config::RenderInfo;\n@@ -74,7 +75,7 @@ crate struct Cache {\n     crate implementors: FxHashMap<DefId, Vec<Impl>>,\n \n     /// Cache of where external crate documentation can be found.\n-    crate extern_locations: FxHashMap<CrateNum, (String, PathBuf, ExternalLocation)>,\n+    crate extern_locations: FxHashMap<CrateNum, (Symbol, PathBuf, ExternalLocation)>,\n \n     /// Cache of where documentation for primitives can be found.\n     crate primitive_locations: FxHashMap<clean::PrimitiveType, DefId>,\n@@ -173,10 +174,10 @@ impl Cache {\n                 },\n                 _ => PathBuf::new(),\n             };\n-            let extern_url = extern_html_root_urls.get(&e.name).map(|u| &**u);\n+            let extern_url = extern_html_root_urls.get(&*e.name.as_str()).map(|u| &**u);\n             cache\n                 .extern_locations\n-                .insert(n, (e.name.clone(), src_root, extern_location(e, extern_url, &dst)));\n+                .insert(n, (e.name, src_root, extern_location(e, extern_url, &dst)));\n \n             let did = DefId { krate: n, index: CRATE_DEF_INDEX };\n             cache.external_paths.insert(did, (vec![e.name.to_string()], ItemType::Module));\n@@ -195,7 +196,7 @@ impl Cache {\n             cache.primitive_locations.insert(prim, def_id);\n         }\n \n-        cache.stack.push(krate.name.clone());\n+        cache.stack.push(krate.name.to_string());\n         krate = cache.fold_crate(krate);\n \n         for (trait_did, dids, impl_) in cache.orphan_trait_impls.drain(..) {\n@@ -340,7 +341,7 @@ impl DocFolder for Cache {\n \n         // Keep track of the fully qualified path for this item.\n         let pushed = match item.name {\n-            Some(ref n) if !n.is_empty() => {\n+            Some(n) if !n.is_empty() => {\n                 self.stack.push(n.to_string());\n                 true\n             }"}, {"sha": "f61919d78a0922bb4457a54d4c84f25a6d823ec1", "filename": "src/librustdoc/formats/renderer.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/5873fe8851ef9815344ddb665c60e48a71413109/src%2Flibrustdoc%2Fformats%2Frenderer.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5873fe8851ef9815344ddb665c60e48a71413109/src%2Flibrustdoc%2Fformats%2Frenderer.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fformats%2Frenderer.rs?ref=5873fe8851ef9815344ddb665c60e48a71413109", "patch": "@@ -3,7 +3,6 @@ use std::sync::Arc;\n use rustc_data_structures::sync::Lrc;\n use rustc_session::Session;\n use rustc_span::edition::Edition;\n-use rustc_span::Symbol;\n \n use crate::clean;\n use crate::config::{RenderInfo, RenderOptions};\n@@ -76,7 +75,7 @@ crate fn run_format<T: FormatRenderer>(\n         None => return Ok(()),\n     };\n \n-    item.name = Some(Symbol::intern(&krate.name));\n+    item.name = Some(krate.name);\n \n     // Render the crate documentation\n     let mut work = vec![(format_renderer.clone(), item)];"}, {"sha": "9d3e31104cede75b57d6291c22a775fac3dd0290", "filename": "src/librustdoc/html/render/cache.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/5873fe8851ef9815344ddb665c60e48a71413109/src%2Flibrustdoc%2Fhtml%2Frender%2Fcache.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5873fe8851ef9815344ddb665c60e48a71413109/src%2Flibrustdoc%2Fhtml%2Frender%2Fcache.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fcache.rs?ref=5873fe8851ef9815344ddb665c60e48a71413109", "patch": "@@ -31,7 +31,7 @@ crate fn extern_location(\n ) -> ExternalLocation {\n     use ExternalLocation::*;\n     // See if there's documentation generated into the local directory\n-    let local_location = dst.join(&e.name);\n+    let local_location = dst.join(&*e.name.as_str());\n     if local_location.is_dir() {\n         return Local;\n     }"}, {"sha": "a775c85435cb8dedb71effb838055ca623955446", "filename": "src/librustdoc/html/render/mod.rs", "status": "modified", "additions": 16, "deletions": 12, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/5873fe8851ef9815344ddb665c60e48a71413109/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5873fe8851ef9815344ddb665c60e48a71413109/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs?ref=5873fe8851ef9815344ddb665c60e48a71413109", "patch": "@@ -418,14 +418,15 @@ impl FormatRenderer for Context {\n         // If user passed in `--playground-url` arg, we fill in crate name here\n         let mut playground = None;\n         if let Some(url) = playground_url {\n-            playground = Some(markdown::Playground { crate_name: Some(krate.name.clone()), url });\n+            playground =\n+                Some(markdown::Playground { crate_name: Some(krate.name.to_string()), url });\n         }\n         let mut layout = layout::Layout {\n             logo: String::new(),\n             favicon: String::new(),\n             external_html,\n             default_settings,\n-            krate: krate.name.clone(),\n+            krate: krate.name.to_string(),\n             css_file_extension: extension_css,\n             generate_search_filter,\n         };\n@@ -445,7 +446,7 @@ impl FormatRenderer for Context {\n                     }\n                     (sym::html_playground_url, Some(s)) => {\n                         playground = Some(markdown::Playground {\n-                            crate_name: Some(krate.name.clone()),\n+                            crate_name: Some(krate.name.to_string()),\n                             url: s.to_string(),\n                         });\n                     }\n@@ -530,7 +531,7 @@ impl FormatRenderer for Context {\n     }\n \n     fn after_krate(&mut self, krate: &clean::Crate, cache: &Cache) -> Result<(), Error> {\n-        let final_file = self.dst.join(&krate.name).join(\"all.html\");\n+        let final_file = self.dst.join(&*krate.name.as_str()).join(\"all.html\");\n         let settings_file = self.dst.join(\"settings.html\");\n         let crate_name = krate.name.clone();\n \n@@ -1019,7 +1020,8 @@ themePicker.onblur = handleThemeButtonsBlur;\n         }\n \n         let dst = cx.dst.join(&format!(\"source-files{}.js\", cx.shared.resource_suffix));\n-        let (mut all_sources, _krates) = try_err!(collect(&dst, &krate.name, \"sourcesIndex\"), &dst);\n+        let (mut all_sources, _krates) =\n+            try_err!(collect(&dst, &krate.name.as_str(), \"sourcesIndex\"), &dst);\n         all_sources.push(format!(\n             \"sourcesIndex[\\\"{}\\\"] = {};\",\n             &krate.name,\n@@ -1035,7 +1037,7 @@ themePicker.onblur = handleThemeButtonsBlur;\n \n     // Update the search index\n     let dst = cx.dst.join(&format!(\"search-index{}.js\", cx.shared.resource_suffix));\n-    let (mut all_indexes, mut krates) = try_err!(collect_json(&dst, &krate.name), &dst);\n+    let (mut all_indexes, mut krates) = try_err!(collect_json(&dst, &krate.name.as_str()), &dst);\n     all_indexes.push(search_index);\n \n     // Sort the indexes by crate so the file will be generated identically even\n@@ -1070,7 +1072,7 @@ themePicker.onblur = handleThemeButtonsBlur;\n                 extra_scripts: &[],\n                 static_extra_scripts: &[],\n             };\n-            krates.push(krate.name.clone());\n+            krates.push(krate.name.to_string());\n             krates.sort();\n             krates.dedup();\n \n@@ -1162,7 +1164,7 @@ themePicker.onblur = handleThemeButtonsBlur;\n         mydst.push(&format!(\"{}.{}.js\", remote_item_type, remote_path[remote_path.len() - 1]));\n \n         let (mut all_implementors, _) =\n-            try_err!(collect(&mydst, &krate.name, \"implementors\"), &mydst);\n+            try_err!(collect(&mydst, &krate.name.as_str(), \"implementors\"), &mydst);\n         all_implementors.push(implementors);\n         // Sort the implementors by crate so the file will be generated\n         // identically even with rustdoc running in parallel.\n@@ -1648,16 +1650,17 @@ impl Context {\n         };\n         let file = &file;\n \n+        let symbol;\n         let (krate, path) = if cnum == LOCAL_CRATE {\n             if let Some(path) = self.shared.local_sources.get(file) {\n-                (&self.shared.layout.krate, path)\n+                (self.shared.layout.krate.as_str(), path)\n             } else {\n                 return None;\n             }\n         } else {\n             let (krate, src_root) = match *cache.extern_locations.get(&cnum)? {\n-                (ref name, ref src, ExternalLocation::Local) => (name, src),\n-                (ref name, ref src, ExternalLocation::Remote(ref s)) => {\n+                (name, ref src, ExternalLocation::Local) => (name, src),\n+                (name, ref src, ExternalLocation::Remote(ref s)) => {\n                     root = s.to_string();\n                     (name, src)\n                 }\n@@ -1671,7 +1674,8 @@ impl Context {\n             let mut fname = file.file_name().expect(\"source has no filename\").to_os_string();\n             fname.push(\".html\");\n             path.push_str(&fname.to_string_lossy());\n-            (krate, &path)\n+            symbol = krate.as_str();\n+            (&*symbol, &path)\n         };\n \n         let loline = item.source.lo(self.sess()).line;"}, {"sha": "b6c3300906bfd569cf0d1aa5f86198b0332528a7", "filename": "src/librustdoc/html/sources.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/5873fe8851ef9815344ddb665c60e48a71413109/src%2Flibrustdoc%2Fhtml%2Fsources.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5873fe8851ef9815344ddb665c60e48a71413109/src%2Flibrustdoc%2Fhtml%2Fsources.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fsources.rs?ref=5873fe8851ef9815344ddb665c60e48a71413109", "patch": "@@ -19,7 +19,7 @@ crate fn render(\n     krate: clean::Crate,\n ) -> Result<clean::Crate, Error> {\n     info!(\"emitting source files\");\n-    let dst = dst.join(\"src\").join(&krate.name);\n+    let dst = dst.join(\"src\").join(&*krate.name.as_str());\n     scx.ensure_dir(&dst)?;\n     let mut folder = SourceCollector { dst, scx };\n     Ok(folder.fold_crate(krate))"}, {"sha": "7af26558b76ecb3fbdce9523eb1b825df021e247", "filename": "src/librustdoc/json/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/5873fe8851ef9815344ddb665c60e48a71413109/src%2Flibrustdoc%2Fjson%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5873fe8851ef9815344ddb665c60e48a71413109/src%2Flibrustdoc%2Fjson%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fjson%2Fmod.rs?ref=5873fe8851ef9815344ddb665c60e48a71413109", "patch": "@@ -223,7 +223,7 @@ impl FormatRenderer for JsonRenderer {\n                     (\n                         k.as_u32(),\n                         types::ExternalCrate {\n-                            name: v.0.clone(),\n+                            name: v.0.to_string(),\n                             html_root_url: match &v.2 {\n                                 ExternalLocation::Remote(s) => Some(s.clone()),\n                                 _ => None,"}, {"sha": "24045b4e29dc93c03da3f1661d97ef4695bd51fc", "filename": "src/librustdoc/lib.rs", "status": "modified", "additions": 0, "deletions": 5, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/5873fe8851ef9815344ddb665c60e48a71413109/src%2Flibrustdoc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5873fe8851ef9815344ddb665c60e48a71413109/src%2Flibrustdoc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Flib.rs?ref=5873fe8851ef9815344ddb665c60e48a71413109", "patch": "@@ -519,17 +519,12 @@ fn main_options(options: config::Options) -> MainResult {\n     // compiler all the way through the analysis passes. The rustdoc output is\n     // then generated from the cleaned AST of the crate. This runs all the\n     // plug/cleaning passes.\n-    let crate_name = options.crate_name.clone();\n     let crate_version = options.crate_version.clone();\n     let output_format = options.output_format;\n     let (mut krate, renderinfo, renderopts, sess) = core::run_core(options);\n \n     info!(\"finished with rustc\");\n \n-    if let Some(name) = crate_name {\n-        krate.name = name\n-    }\n-\n     krate.version = crate_version;\n \n     if show_coverage {"}]}