{"sha": "50d76d647191bdff875e854ed2ee2282ab274a09", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUwZDc2ZDY0NzE5MWJkZmY4NzVlODU0ZWQyZWUyMjgyYWIyNzRhMDk=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2020-01-11T11:36:14Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-01-11T11:36:14Z"}, "message": "Rollup merge of #68114 - ecstatic-morse:fix-feature-gating, r=Centril\n\nDon't require `allow_internal_unstable` unless `staged_api` is enabled.\n\n#63770 changed `qualify_min_const_fn` to require `allow_internal_unstable` for *all* crates that used an unstable feature, regardless of whether `staged_api` was enabled or the `fn` that used that feature was stably const. In practice, this meant that every crate in the ecosystem that wanted to use nightly features added `#![feature(const_fn)]`, which skips `qualify_min_const_fn` entirely.\n\nAfter this PR, crates that do not have `#![feature(staged_api)]` will only need to enable the feature they are interested in. For example, `#![feature(const_if_match)]` will be enough to enable `if` and `match` in constants. Crates with `staged_api` (e.g., `libstd`) require `#[allow_internal_unstable]` to be added to a function if it uses nightly features unless that function is also marked `#[rustc_const_unstable]`. This prevents proliferation of `#[allow_internal_unstable]` into functions that are not callable in a `const` context on stable.\n\nr? @oli-obk (author of #63770)\ncc @Centril", "tree": {"sha": "12e19976ffaa3e72ec450b2947d02b57a511a956", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/12e19976ffaa3e72ec450b2947d02b57a511a956"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/50d76d647191bdff875e854ed2ee2282ab274a09", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJeGbMuCRBK7hj4Ov3rIwAAdHIIAFZ+ZNvsAtDzJfw7LKKso63x\nv+cSu89Hf98QS15iODf1WaGbPlJTwD+1U9plsjVAQk6PeSQaGO2NbeHlfIV/g2Vs\nDsYmVGbw/JNsddsx+7LkUDRD5VrgiJBjWmkBEQwOVUwM5Mh6zMUgfUKmBKX0ob0j\nFJ22t0Sp9Nm9nZnm5dai4zEv8pMJ3jefyXF9QDhNExJI9K5T5DPc8ThDPUWamQV5\nSJRw4p0z5mWb3/hJJMaiS8aYYHyecz5Nsrg9DufGHW6JWB+LsNYX6tzlYcHd416x\nkg+NTsZobBh+4eCkY7AuldSnSKZZUEoVG4dqgFTY8JF7T5vwRgkfo58AjTMd7u4=\n=Gjxc\n-----END PGP SIGNATURE-----\n", "payload": "tree 12e19976ffaa3e72ec450b2947d02b57a511a956\nparent f02f338ee064cf78e0b2234cbbfcaf43c451217d\nparent fc30825c8b22d93419a087fcec1817108d9b694b\nauthor Mazdak Farrokhzad <twingoow@gmail.com> 1578742574 +0100\ncommitter GitHub <noreply@github.com> 1578742574 +0100\n\nRollup merge of #68114 - ecstatic-morse:fix-feature-gating, r=Centril\n\nDon't require `allow_internal_unstable` unless `staged_api` is enabled.\n\n#63770 changed `qualify_min_const_fn` to require `allow_internal_unstable` for *all* crates that used an unstable feature, regardless of whether `staged_api` was enabled or the `fn` that used that feature was stably const. In practice, this meant that every crate in the ecosystem that wanted to use nightly features added `#![feature(const_fn)]`, which skips `qualify_min_const_fn` entirely.\n\nAfter this PR, crates that do not have `#![feature(staged_api)]` will only need to enable the feature they are interested in. For example, `#![feature(const_if_match)]` will be enough to enable `if` and `match` in constants. Crates with `staged_api` (e.g., `libstd`) require `#[allow_internal_unstable]` to be added to a function if it uses nightly features unless that function is also marked `#[rustc_const_unstable]`. This prevents proliferation of `#[allow_internal_unstable]` into functions that are not callable in a `const` context on stable.\n\nr? @oli-obk (author of #63770)\ncc @Centril\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/50d76d647191bdff875e854ed2ee2282ab274a09", "html_url": "https://github.com/rust-lang/rust/commit/50d76d647191bdff875e854ed2ee2282ab274a09", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/50d76d647191bdff875e854ed2ee2282ab274a09/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f02f338ee064cf78e0b2234cbbfcaf43c451217d", "url": "https://api.github.com/repos/rust-lang/rust/commits/f02f338ee064cf78e0b2234cbbfcaf43c451217d", "html_url": "https://github.com/rust-lang/rust/commit/f02f338ee064cf78e0b2234cbbfcaf43c451217d"}, {"sha": "fc30825c8b22d93419a087fcec1817108d9b694b", "url": "https://api.github.com/repos/rust-lang/rust/commits/fc30825c8b22d93419a087fcec1817108d9b694b", "html_url": "https://github.com/rust-lang/rust/commit/fc30825c8b22d93419a087fcec1817108d9b694b"}], "stats": {"total": 107, "additions": 66, "deletions": 41}, "files": [{"sha": "6c4956663841c21ce1217981d2f75ca3ddae862b", "filename": "src/libcore/lib.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/50d76d647191bdff875e854ed2ee2282ab274a09/src%2Flibcore%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50d76d647191bdff875e854ed2ee2282ab274a09/src%2Flibcore%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Flib.rs?ref=50d76d647191bdff875e854ed2ee2282ab274a09", "patch": "@@ -70,7 +70,6 @@\n #![feature(bound_cloned)]\n #![feature(cfg_target_has_atomic)]\n #![feature(concat_idents)]\n-#![feature(const_fn)]\n #![feature(const_if_match)]\n #![feature(const_panic)]\n #![feature(const_fn_union)]"}, {"sha": "86cf6fc104c8390bc19e5a3baa4c6bfabd94763d", "filename": "src/libcore/tests/lib.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/50d76d647191bdff875e854ed2ee2282ab274a09/src%2Flibcore%2Ftests%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50d76d647191bdff875e854ed2ee2282ab274a09/src%2Flibcore%2Ftests%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Ftests%2Flib.rs?ref=50d76d647191bdff875e854ed2ee2282ab274a09", "patch": "@@ -31,7 +31,6 @@\n #![feature(slice_internals)]\n #![feature(slice_partition_dedup)]\n #![feature(int_error_matching)]\n-#![feature(const_fn)]\n #![feature(array_value_iter)]\n #![feature(iter_partition_in_place)]\n #![feature(iter_is_partitioned)]"}, {"sha": "c51db695a5b1581efd9e7bdd7c81bcffe34edfb6", "filename": "src/libproc_macro/lib.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/50d76d647191bdff875e854ed2ee2282ab274a09/src%2Flibproc_macro%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50d76d647191bdff875e854ed2ee2282ab274a09/src%2Flibproc_macro%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibproc_macro%2Flib.rs?ref=50d76d647191bdff875e854ed2ee2282ab274a09", "patch": "@@ -21,7 +21,6 @@\n #![feature(nll)]\n #![feature(staged_api)]\n #![feature(allow_internal_unstable)]\n-#![feature(const_fn)]\n #![feature(decl_macro)]\n #![feature(extern_types)]\n #![feature(in_band_lifetimes)]"}, {"sha": "3c0160a04527e1381e31d8195bc695aba7b33ac4", "filename": "src/librustc/lib.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/50d76d647191bdff875e854ed2ee2282ab274a09/src%2Flibrustc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50d76d647191bdff875e854ed2ee2282ab274a09/src%2Flibrustc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Flib.rs?ref=50d76d647191bdff875e854ed2ee2282ab274a09", "patch": "@@ -31,7 +31,6 @@\n #![feature(bool_to_option)]\n #![feature(box_patterns)]\n #![feature(box_syntax)]\n-#![feature(const_fn)]\n #![feature(const_transmute)]\n #![feature(core_intrinsics)]\n #![feature(drain_filter)]"}, {"sha": "f54fa291bd6e81e7c3620a8f044864ebdf37d345", "filename": "src/librustc_hir/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/50d76d647191bdff875e854ed2ee2282ab274a09/src%2Flibrustc_hir%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50d76d647191bdff875e854ed2ee2282ab274a09/src%2Flibrustc_hir%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_hir%2Flib.rs?ref=50d76d647191bdff875e854ed2ee2282ab274a09", "patch": "@@ -3,7 +3,7 @@\n //! [rustc guide]: https://rust-lang.github.io/rustc-guide/hir.html\n \n #![feature(crate_visibility_modifier)]\n-#![feature(const_fn)]\n+#![feature(const_fn)] // For the unsizing cast on `&[]`\n #![feature(in_band_lifetimes)]\n #![feature(specialization)]\n #![recursion_limit = \"256\"]"}, {"sha": "d2565bf9c63d427270bd8b2eb45003b94000c6c5", "filename": "src/librustc_mir/lib.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/50d76d647191bdff875e854ed2ee2282ab274a09/src%2Flibrustc_mir%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50d76d647191bdff875e854ed2ee2282ab274a09/src%2Flibrustc_mir%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Flib.rs?ref=50d76d647191bdff875e854ed2ee2282ab274a09", "patch": "@@ -13,7 +13,6 @@ Rust MIR: a lowered representation of Rust. Also: an experiment!\n #![feature(box_syntax)]\n #![feature(crate_visibility_modifier)]\n #![feature(core_intrinsics)]\n-#![feature(const_fn)]\n #![feature(decl_macro)]\n #![feature(drain_filter)]\n #![feature(exhaustive_patterns)]"}, {"sha": "c2c1625001d0f1c452ce5f62c94ced0e07897768", "filename": "src/librustc_mir/transform/qualify_min_const_fn.rs", "status": "modified", "additions": 15, "deletions": 1, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/50d76d647191bdff875e854ed2ee2282ab274a09/src%2Flibrustc_mir%2Ftransform%2Fqualify_min_const_fn.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50d76d647191bdff875e854ed2ee2282ab274a09/src%2Flibrustc_mir%2Ftransform%2Fqualify_min_const_fn.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fqualify_min_const_fn.rs?ref=50d76d647191bdff875e854ed2ee2282ab274a09", "patch": "@@ -281,8 +281,22 @@ fn check_place(\n     Ok(())\n }\n \n-/// Returns whether `allow_internal_unstable(..., <feature_gate>, ...)` is present.\n+/// Returns `true` if the given feature gate is allowed within the function with the given `DefId`.\n fn feature_allowed(tcx: TyCtxt<'tcx>, def_id: DefId, feature_gate: Symbol) -> bool {\n+    // All features require that the corresponding gate be enabled,\n+    // even if the function has `#[allow_internal_unstable(the_gate)]`.\n+    if !tcx.features().enabled(feature_gate) {\n+        return false;\n+    }\n+\n+    // If this crate is not using stability attributes, or this function is not claiming to be a\n+    // stable `const fn`, that is all that is required.\n+    if !tcx.features().staged_api || tcx.has_attr(def_id, sym::rustc_const_unstable) {\n+        return true;\n+    }\n+\n+    // However, we cannot allow stable `const fn`s to use unstable features without an explicit\n+    // opt-in via `allow_internal_unstable`.\n     attr::allow_internal_unstable(&tcx.get_attrs(def_id), &tcx.sess.diagnostic())\n         .map_or(false, |mut features| features.any(|name| name == feature_gate))\n }"}, {"sha": "1dc7fc5aa3ad1aec7fa4b33d7cbbfdcf225ef5e7", "filename": "src/librustc_span/lib.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/50d76d647191bdff875e854ed2ee2282ab274a09/src%2Flibrustc_span%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50d76d647191bdff875e854ed2ee2282ab274a09/src%2Flibrustc_span%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_span%2Flib.rs?ref=50d76d647191bdff875e854ed2ee2282ab274a09", "patch": "@@ -5,7 +5,6 @@\n //! This API is completely unstable and subject to change.\n \n #![doc(html_root_url = \"https://doc.rust-lang.org/nightly/\")]\n-#![feature(const_fn)]\n #![feature(crate_visibility_modifier)]\n #![feature(nll)]\n #![feature(optin_builtin_traits)]"}, {"sha": "0fcbd4e0b58c61f7fd9fac0c5184a47708f8989d", "filename": "src/librustdoc/lib.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/50d76d647191bdff875e854ed2ee2282ab274a09/src%2Flibrustdoc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50d76d647191bdff875e854ed2ee2282ab274a09/src%2Flibrustdoc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Flib.rs?ref=50d76d647191bdff875e854ed2ee2282ab274a09", "patch": "@@ -12,7 +12,6 @@\n #![feature(test)]\n #![feature(ptr_offset_from)]\n #![feature(crate_visibility_modifier)]\n-#![feature(const_fn)]\n #![feature(drain_filter)]\n #![feature(never_type)]\n #![feature(unicode_internals)]"}, {"sha": "0184a3214b5b4985748e5d17f6e99f4d52be8f35", "filename": "src/libsyntax/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/50d76d647191bdff875e854ed2ee2282ab274a09/src%2Flibsyntax%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50d76d647191bdff875e854ed2ee2282ab274a09/src%2Flibsyntax%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Flib.rs?ref=50d76d647191bdff875e854ed2ee2282ab274a09", "patch": "@@ -7,7 +7,7 @@\n #![doc(html_root_url = \"https://doc.rust-lang.org/nightly/\", test(attr(deny(warnings))))]\n #![feature(bool_to_option)]\n #![feature(box_syntax)]\n-#![feature(const_fn)]\n+#![feature(const_fn)] // For the `transmute` in `P::new`\n #![feature(const_transmute)]\n #![feature(crate_visibility_modifier)]\n #![feature(label_break_value)]"}, {"sha": "99006a20b1bcba56dfe6275b847724ea47185cc1", "filename": "src/test/ui/consts/const-mut-refs/const_mut_refs.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/50d76d647191bdff875e854ed2ee2282ab274a09/src%2Ftest%2Fui%2Fconsts%2Fconst-mut-refs%2Fconst_mut_refs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50d76d647191bdff875e854ed2ee2282ab274a09/src%2Ftest%2Fui%2Fconsts%2Fconst-mut-refs%2Fconst_mut_refs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fconst-mut-refs%2Fconst_mut_refs.rs?ref=50d76d647191bdff875e854ed2ee2282ab274a09", "patch": "@@ -1,7 +1,6 @@\n // run-pass\n \n #![feature(const_mut_refs)]\n-#![feature(const_fn)]\n \n struct Foo {\n     x: usize"}, {"sha": "6bbbdd972a26c102b243a275b71352ed823d4815", "filename": "src/test/ui/consts/control-flow/exhaustive-c-like-enum-match.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/50d76d647191bdff875e854ed2ee2282ab274a09/src%2Ftest%2Fui%2Fconsts%2Fcontrol-flow%2Fexhaustive-c-like-enum-match.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50d76d647191bdff875e854ed2ee2282ab274a09/src%2Ftest%2Fui%2Fconsts%2Fcontrol-flow%2Fexhaustive-c-like-enum-match.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fcontrol-flow%2Fexhaustive-c-like-enum-match.rs?ref=50d76d647191bdff875e854ed2ee2282ab274a09", "patch": "@@ -3,7 +3,6 @@\n // check-pass\n \n #![feature(const_if_match)]\n-#![feature(const_fn)]\n \n enum E {\n     A,"}, {"sha": "21e3f2af15ad6280ce4ca9b38300f7a023126f5f", "filename": "src/test/ui/consts/control-flow/feature-gate-const-if-match.if_match.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/50d76d647191bdff875e854ed2ee2282ab274a09/src%2Ftest%2Fui%2Fconsts%2Fcontrol-flow%2Ffeature-gate-const-if-match.if_match.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/50d76d647191bdff875e854ed2ee2282ab274a09/src%2Ftest%2Fui%2Fconsts%2Fcontrol-flow%2Ffeature-gate-const-if-match.if_match.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fcontrol-flow%2Ffeature-gate-const-if-match.if_match.stderr?ref=50d76d647191bdff875e854ed2ee2282ab274a09", "patch": "@@ -1,5 +1,5 @@\n error: fatal error triggered by #[rustc_error]\n-  --> $DIR/feature-gate-const-if-match.rs:109:1\n+  --> $DIR/feature-gate-const-if-match.rs:108:1\n    |\n LL | / fn main() {\n LL | |     let _ = [0; {"}, {"sha": "00576d50ac66b46f3af78f3fc08de759b9436ea6", "filename": "src/test/ui/consts/control-flow/feature-gate-const-if-match.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/50d76d647191bdff875e854ed2ee2282ab274a09/src%2Ftest%2Fui%2Fconsts%2Fcontrol-flow%2Ffeature-gate-const-if-match.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50d76d647191bdff875e854ed2ee2282ab274a09/src%2Ftest%2Fui%2Fconsts%2Fcontrol-flow%2Ffeature-gate-const-if-match.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fcontrol-flow%2Ffeature-gate-const-if-match.rs?ref=50d76d647191bdff875e854ed2ee2282ab274a09", "patch": "@@ -6,7 +6,6 @@\n \n #![feature(rustc_attrs)]\n #![cfg_attr(if_match, feature(const_if_match))]\n-#![feature(const_fn)]\n \n const _: i32 = if true { //[stock]~ ERROR `if` is not allowed in a `const`\n     5"}, {"sha": "d3c6a51923ffb54317d6315399c92c61ba520b6e", "filename": "src/test/ui/consts/control-flow/feature-gate-const-if-match.stock.stderr", "status": "modified", "additions": 25, "deletions": 25, "changes": 50, "blob_url": "https://github.com/rust-lang/rust/blob/50d76d647191bdff875e854ed2ee2282ab274a09/src%2Ftest%2Fui%2Fconsts%2Fcontrol-flow%2Ffeature-gate-const-if-match.stock.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/50d76d647191bdff875e854ed2ee2282ab274a09/src%2Ftest%2Fui%2Fconsts%2Fcontrol-flow%2Ffeature-gate-const-if-match.stock.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fcontrol-flow%2Ffeature-gate-const-if-match.stock.stderr?ref=50d76d647191bdff875e854ed2ee2282ab274a09", "patch": "@@ -1,5 +1,5 @@\n error[E0658]: `if` is not allowed in a `const`\n-  --> $DIR/feature-gate-const-if-match.rs:11:16\n+  --> $DIR/feature-gate-const-if-match.rs:10:16\n    |\n LL |   const _: i32 = if true {\n    |  ________________^\n@@ -13,7 +13,7 @@ LL | | };\n    = help: add `#![feature(const_if_match)]` to the crate attributes to enable\n \n error[E0658]: `if` is not allowed in a `const`\n-  --> $DIR/feature-gate-const-if-match.rs:17:16\n+  --> $DIR/feature-gate-const-if-match.rs:16:16\n    |\n LL |   const _: i32 = if let Some(true) = Some(false) {\n    |  ________________^\n@@ -27,7 +27,7 @@ LL | | };\n    = help: add `#![feature(const_if_match)]` to the crate attributes to enable\n \n error[E0658]: `match` is not allowed in a `const`\n-  --> $DIR/feature-gate-const-if-match.rs:23:16\n+  --> $DIR/feature-gate-const-if-match.rs:22:16\n    |\n LL |   const _: i32 = match 1 {\n    |  ________________^\n@@ -41,7 +41,7 @@ LL | | };\n    = help: add `#![feature(const_if_match)]` to the crate attributes to enable\n \n error[E0658]: `if` is not allowed in a `static`\n-  --> $DIR/feature-gate-const-if-match.rs:30:13\n+  --> $DIR/feature-gate-const-if-match.rs:29:13\n    |\n LL |     let x = if true { 0 } else { 1 };\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n@@ -50,7 +50,7 @@ LL |     let x = if true { 0 } else { 1 };\n    = help: add `#![feature(const_if_match)]` to the crate attributes to enable\n \n error[E0658]: `match` is not allowed in a `static`\n-  --> $DIR/feature-gate-const-if-match.rs:32:13\n+  --> $DIR/feature-gate-const-if-match.rs:31:13\n    |\n LL |     let x = match x { 0 => 1, _ => 0 };\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^\n@@ -59,7 +59,7 @@ LL |     let x = match x { 0 => 1, _ => 0 };\n    = help: add `#![feature(const_if_match)]` to the crate attributes to enable\n \n error[E0658]: `if` is not allowed in a `static`\n-  --> $DIR/feature-gate-const-if-match.rs:34:5\n+  --> $DIR/feature-gate-const-if-match.rs:33:5\n    |\n LL |     if let Some(x) = Some(x) { x } else { 1 }\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n@@ -68,7 +68,7 @@ LL |     if let Some(x) = Some(x) { x } else { 1 }\n    = help: add `#![feature(const_if_match)]` to the crate attributes to enable\n \n error[E0658]: `if` is not allowed in a `static mut`\n-  --> $DIR/feature-gate-const-if-match.rs:39:13\n+  --> $DIR/feature-gate-const-if-match.rs:38:13\n    |\n LL |     let x = if true { 0 } else { 1 };\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^\n@@ -77,7 +77,7 @@ LL |     let x = if true { 0 } else { 1 };\n    = help: add `#![feature(const_if_match)]` to the crate attributes to enable\n \n error[E0658]: `match` is not allowed in a `static mut`\n-  --> $DIR/feature-gate-const-if-match.rs:41:13\n+  --> $DIR/feature-gate-const-if-match.rs:40:13\n    |\n LL |     let x = match x { 0 => 1, _ => 0 };\n    |             ^^^^^^^^^^^^^^^^^^^^^^^^^^\n@@ -86,7 +86,7 @@ LL |     let x = match x { 0 => 1, _ => 0 };\n    = help: add `#![feature(const_if_match)]` to the crate attributes to enable\n \n error[E0658]: `if` is not allowed in a `static mut`\n-  --> $DIR/feature-gate-const-if-match.rs:43:5\n+  --> $DIR/feature-gate-const-if-match.rs:42:5\n    |\n LL |     if let Some(x) = Some(x) { x } else { 1 }\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n@@ -95,7 +95,7 @@ LL |     if let Some(x) = Some(x) { x } else { 1 }\n    = help: add `#![feature(const_if_match)]` to the crate attributes to enable\n \n error[E0658]: `if` is not allowed in a `const fn`\n-  --> $DIR/feature-gate-const-if-match.rs:48:5\n+  --> $DIR/feature-gate-const-if-match.rs:47:5\n    |\n LL |     if true { 5 } else { 6 }\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^\n@@ -104,7 +104,7 @@ LL |     if true { 5 } else { 6 }\n    = help: add `#![feature(const_if_match)]` to the crate attributes to enable\n \n error[E0658]: `if` is not allowed in a `const fn`\n-  --> $DIR/feature-gate-const-if-match.rs:52:5\n+  --> $DIR/feature-gate-const-if-match.rs:51:5\n    |\n LL | /     if let Some(true) = a {\n LL | |         0\n@@ -117,7 +117,7 @@ LL | |     }\n    = help: add `#![feature(const_if_match)]` to the crate attributes to enable\n \n error[E0658]: `match` is not allowed in a `const fn`\n-  --> $DIR/feature-gate-const-if-match.rs:60:5\n+  --> $DIR/feature-gate-const-if-match.rs:59:5\n    |\n LL | /     match i {\n LL | |         i if i > 10 => i,\n@@ -130,7 +130,7 @@ LL | |     }\n    = help: add `#![feature(const_if_match)]` to the crate attributes to enable\n \n error[E0658]: `if` is not allowed in a `const fn`\n-  --> $DIR/feature-gate-const-if-match.rs:91:17\n+  --> $DIR/feature-gate-const-if-match.rs:90:17\n    |\n LL |         let x = if y { 0 } else { 1 };\n    |                 ^^^^^^^^^^^^^^^^^^^^^\n@@ -139,7 +139,7 @@ LL |         let x = if y { 0 } else { 1 };\n    = help: add `#![feature(const_if_match)]` to the crate attributes to enable\n \n error[E0658]: `match` is not allowed in a `const fn`\n-  --> $DIR/feature-gate-const-if-match.rs:93:17\n+  --> $DIR/feature-gate-const-if-match.rs:92:17\n    |\n LL |         let x = match x { 0 => 1, _ => 0 };\n    |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^\n@@ -148,7 +148,7 @@ LL |         let x = match x { 0 => 1, _ => 0 };\n    = help: add `#![feature(const_if_match)]` to the crate attributes to enable\n \n error[E0658]: `if` is not allowed in a `const fn`\n-  --> $DIR/feature-gate-const-if-match.rs:95:9\n+  --> $DIR/feature-gate-const-if-match.rs:94:9\n    |\n LL |         if let Some(x) = Some(x) { x } else { 1 }\n    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n@@ -157,7 +157,7 @@ LL |         if let Some(x) = Some(x) { x } else { 1 }\n    = help: add `#![feature(const_if_match)]` to the crate attributes to enable\n \n error[E0658]: `if` is not allowed in a `const`\n-  --> $DIR/feature-gate-const-if-match.rs:111:17\n+  --> $DIR/feature-gate-const-if-match.rs:110:17\n    |\n LL |         let x = if false { 0 } else { 1 };\n    |                 ^^^^^^^^^^^^^^^^^^^^^^^^^\n@@ -166,7 +166,7 @@ LL |         let x = if false { 0 } else { 1 };\n    = help: add `#![feature(const_if_match)]` to the crate attributes to enable\n \n error[E0658]: `match` is not allowed in a `const`\n-  --> $DIR/feature-gate-const-if-match.rs:113:17\n+  --> $DIR/feature-gate-const-if-match.rs:112:17\n    |\n LL |         let x = match x { 0 => 1, _ => 0 };\n    |                 ^^^^^^^^^^^^^^^^^^^^^^^^^^\n@@ -175,7 +175,7 @@ LL |         let x = match x { 0 => 1, _ => 0 };\n    = help: add `#![feature(const_if_match)]` to the crate attributes to enable\n \n error[E0658]: `if` is not allowed in a `const`\n-  --> $DIR/feature-gate-const-if-match.rs:115:9\n+  --> $DIR/feature-gate-const-if-match.rs:114:9\n    |\n LL |         if let Some(x) = Some(x) { x } else { 1 }\n    |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n@@ -184,7 +184,7 @@ LL |         if let Some(x) = Some(x) { x } else { 1 }\n    = help: add `#![feature(const_if_match)]` to the crate attributes to enable\n \n error[E0658]: `if` is not allowed in a `const`\n-  --> $DIR/feature-gate-const-if-match.rs:68:21\n+  --> $DIR/feature-gate-const-if-match.rs:67:21\n    |\n LL |     const IF: i32 = if true { 5 } else { 6 };\n    |                     ^^^^^^^^^^^^^^^^^^^^^^^^\n@@ -193,7 +193,7 @@ LL |     const IF: i32 = if true { 5 } else { 6 };\n    = help: add `#![feature(const_if_match)]` to the crate attributes to enable\n \n error[E0658]: `if` is not allowed in a `const`\n-  --> $DIR/feature-gate-const-if-match.rs:71:25\n+  --> $DIR/feature-gate-const-if-match.rs:70:25\n    |\n LL |     const IF_LET: i32 = if let Some(true) = None { 5 } else { 6 };\n    |                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n@@ -202,7 +202,7 @@ LL |     const IF_LET: i32 = if let Some(true) = None { 5 } else { 6 };\n    = help: add `#![feature(const_if_match)]` to the crate attributes to enable\n \n error[E0658]: `match` is not allowed in a `const`\n-  --> $DIR/feature-gate-const-if-match.rs:74:24\n+  --> $DIR/feature-gate-const-if-match.rs:73:24\n    |\n LL |     const MATCH: i32 = match 0 { 1 => 2, _ => 0 };\n    |                        ^^^^^^^^^^^^^^^^^^^^^^^^^^\n@@ -211,7 +211,7 @@ LL |     const MATCH: i32 = match 0 { 1 => 2, _ => 0 };\n    = help: add `#![feature(const_if_match)]` to the crate attributes to enable\n \n error[E0658]: `if` is not allowed in a `const`\n-  --> $DIR/feature-gate-const-if-match.rs:79:21\n+  --> $DIR/feature-gate-const-if-match.rs:78:21\n    |\n LL |     const IF: i32 = if true { 5 } else { 6 };\n    |                     ^^^^^^^^^^^^^^^^^^^^^^^^\n@@ -220,7 +220,7 @@ LL |     const IF: i32 = if true { 5 } else { 6 };\n    = help: add `#![feature(const_if_match)]` to the crate attributes to enable\n \n error[E0658]: `if` is not allowed in a `const`\n-  --> $DIR/feature-gate-const-if-match.rs:82:25\n+  --> $DIR/feature-gate-const-if-match.rs:81:25\n    |\n LL |     const IF_LET: i32 = if let Some(true) = None { 5 } else { 6 };\n    |                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n@@ -229,7 +229,7 @@ LL |     const IF_LET: i32 = if let Some(true) = None { 5 } else { 6 };\n    = help: add `#![feature(const_if_match)]` to the crate attributes to enable\n \n error[E0658]: `match` is not allowed in a `const`\n-  --> $DIR/feature-gate-const-if-match.rs:85:24\n+  --> $DIR/feature-gate-const-if-match.rs:84:24\n    |\n LL |     const MATCH: i32 = match 0 { 1 => 2, _ => 0 };\n    |                        ^^^^^^^^^^^^^^^^^^^^^^^^^^\n@@ -238,7 +238,7 @@ LL |     const MATCH: i32 = match 0 { 1 => 2, _ => 0 };\n    = help: add `#![feature(const_if_match)]` to the crate attributes to enable\n \n error[E0019]: constant contains unimplemented expression type\n-  --> $DIR/feature-gate-const-if-match.rs:115:21\n+  --> $DIR/feature-gate-const-if-match.rs:114:21\n    |\n LL |         if let Some(x) = Some(x) { x } else { 1 }\n    |                     ^"}, {"sha": "8cee2a54f56d3e4c08b1aeeeb272a068e9364959", "filename": "src/test/ui/consts/control-flow/short-circuit-let.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/50d76d647191bdff875e854ed2ee2282ab274a09/src%2Ftest%2Fui%2Fconsts%2Fcontrol-flow%2Fshort-circuit-let.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50d76d647191bdff875e854ed2ee2282ab274a09/src%2Ftest%2Fui%2Fconsts%2Fcontrol-flow%2Fshort-circuit-let.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fcontrol-flow%2Fshort-circuit-let.rs?ref=50d76d647191bdff875e854ed2ee2282ab274a09", "patch": "@@ -4,7 +4,6 @@\n \n #![feature(const_if_match)]\n #![feature(const_panic)]\n-#![feature(const_fn)]\n \n const X: i32 = {\n     let mut x = 0;"}, {"sha": "823605ff034f10c8ca1c25bb2b53c6da78c021c8", "filename": "src/test/ui/consts/control-flow/single_variant_match_ice.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/50d76d647191bdff875e854ed2ee2282ab274a09/src%2Ftest%2Fui%2Fconsts%2Fcontrol-flow%2Fsingle_variant_match_ice.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50d76d647191bdff875e854ed2ee2282ab274a09/src%2Ftest%2Fui%2Fconsts%2Fcontrol-flow%2Fsingle_variant_match_ice.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Fcontrol-flow%2Fsingle_variant_match_ice.rs?ref=50d76d647191bdff875e854ed2ee2282ab274a09", "patch": "@@ -1,6 +1,6 @@\n // check-pass\n \n-#![feature(const_if_match, const_fn)]\n+#![feature(const_if_match)]\n \n enum Foo {\n     Prob,"}, {"sha": "ce306c845175af061075edcc003316362fb70775", "filename": "src/test/ui/internal/internal-unstable-const.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/50d76d647191bdff875e854ed2ee2282ab274a09/src%2Ftest%2Fui%2Finternal%2Finternal-unstable-const.rs", "raw_url": "https://github.com/rust-lang/rust/raw/50d76d647191bdff875e854ed2ee2282ab274a09/src%2Ftest%2Fui%2Finternal%2Finternal-unstable-const.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Finternal%2Finternal-unstable-const.rs?ref=50d76d647191bdff875e854ed2ee2282ab274a09", "patch": "@@ -0,0 +1,10 @@\n+#![feature(staged_api)]\n+#![feature(const_if_match)]\n+\n+#[stable(feature = \"rust1\", since = \"1.0.0\")]\n+#[rustc_const_stable(feature = \"rust1\", since = \"1.0.0\")]\n+const fn foo() -> i32 {\n+    if true { 4 } else { 5 } //~ loops and conditional expressions are not stable in const fn\n+}\n+\n+fn main() {}"}, {"sha": "58bbe798b00b6ab89ad73ea4ce78390c9ce45ba0", "filename": "src/test/ui/internal/internal-unstable-const.stderr", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/50d76d647191bdff875e854ed2ee2282ab274a09/src%2Ftest%2Fui%2Finternal%2Finternal-unstable-const.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/50d76d647191bdff875e854ed2ee2282ab274a09/src%2Ftest%2Fui%2Finternal%2Finternal-unstable-const.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Finternal%2Finternal-unstable-const.stderr?ref=50d76d647191bdff875e854ed2ee2282ab274a09", "patch": "@@ -0,0 +1,12 @@\n+error[E0723]: loops and conditional expressions are not stable in const fn\n+  --> $DIR/internal-unstable-const.rs:7:5\n+   |\n+LL |     if true { 4 } else { 5 }\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+   = note: for more information, see issue https://github.com/rust-lang/rust/issues/57563\n+   = help: add `#![feature(const_fn)]` to the crate attributes to enable\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0723`."}]}