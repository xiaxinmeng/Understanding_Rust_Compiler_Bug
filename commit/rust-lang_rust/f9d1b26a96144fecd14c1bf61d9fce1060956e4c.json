{"sha": "f9d1b26a96144fecd14c1bf61d9fce1060956e4c", "node_id": "C_kwDOAAsO6NoAKGY5ZDFiMjZhOTYxNDRmZWNkMTRjMWJmNjFkOWZjZTEwNjA5NTZlNGM", "commit": {"author": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2022-08-11T15:12:25Z"}, "committer": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2022-08-22T12:55:13Z"}, "message": "Replace crossbeam with std's scoped threads", "tree": {"sha": "b5faaa041e6fe425527b74c3e3185ca7b1c1fedf", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b5faaa041e6fe425527b74c3e3185ca7b1c1fedf"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f9d1b26a96144fecd14c1bf61d9fce1060956e4c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f9d1b26a96144fecd14c1bf61d9fce1060956e4c", "html_url": "https://github.com/rust-lang/rust/commit/f9d1b26a96144fecd14c1bf61d9fce1060956e4c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f9d1b26a96144fecd14c1bf61d9fce1060956e4c/comments", "author": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "dea163970a94f05d56e482c423df1cd379c8735c", "url": "https://api.github.com/repos/rust-lang/rust/commits/dea163970a94f05d56e482c423df1cd379c8735c", "html_url": "https://github.com/rust-lang/rust/commit/dea163970a94f05d56e482c423df1cd379c8735c"}], "stats": {"total": 43, "additions": 6, "deletions": 37}, "files": [{"sha": "ff9948d03cb9fb0646d701d2e94560ccd4251e94", "filename": "Cargo.lock", "status": "modified", "additions": 0, "deletions": 25, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/f9d1b26a96144fecd14c1bf61d9fce1060956e4c/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/f9d1b26a96144fecd14c1bf61d9fce1060956e4c/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=f9d1b26a96144fecd14c1bf61d9fce1060956e4c", "patch": "@@ -247,20 +247,6 @@ dependencies = [\n  \"cfg-if\",\n ]\n \n-[[package]]\n-name = \"crossbeam\"\n-version = \"0.8.2\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"2801af0d36612ae591caa9568261fddce32ce6e08a7275ea334a06a4ad021a2c\"\n-dependencies = [\n- \"cfg-if\",\n- \"crossbeam-channel\",\n- \"crossbeam-deque\",\n- \"crossbeam-epoch\",\n- \"crossbeam-queue\",\n- \"crossbeam-utils\",\n-]\n-\n [[package]]\n name = \"crossbeam-channel\"\n version = \"0.5.6\"\n@@ -296,16 +282,6 @@ dependencies = [\n  \"scopeguard\",\n ]\n \n-[[package]]\n-name = \"crossbeam-queue\"\n-version = \"0.3.6\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"1cd42583b04998a5363558e5f9291ee5a5ff6b49944332103f251e7479a82aa7\"\n-dependencies = [\n- \"cfg-if\",\n- \"crossbeam-utils\",\n-]\n-\n [[package]]\n name = \"crossbeam-utils\"\n version = \"0.8.11\"\n@@ -1178,7 +1154,6 @@ dependencies = [\n name = \"proc-macro-srv\"\n version = \"0.0.0\"\n dependencies = [\n- \"crossbeam\",\n  \"expect-test\",\n  \"libloading\",\n  \"mbe\","}, {"sha": "e39026ac70bfd52e4d78b7b6a08a85d6938306ac", "filename": "crates/proc-macro-srv/Cargo.toml", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/f9d1b26a96144fecd14c1bf61d9fce1060956e4c/crates%2Fproc-macro-srv%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/f9d1b26a96144fecd14c1bf61d9fce1060956e4c/crates%2Fproc-macro-srv%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproc-macro-srv%2FCargo.toml?ref=f9d1b26a96144fecd14c1bf61d9fce1060956e4c", "patch": "@@ -24,7 +24,6 @@ tt = { path = \"../tt\", version = \"0.0.0\" }\n mbe = { path = \"../mbe\", version = \"0.0.0\" }\n paths = { path = \"../paths\", version = \"0.0.0\" }\n proc-macro-api = { path = \"../proc-macro-api\", version = \"0.0.0\" }\n-crossbeam = \"0.8.1\"\n \n [dev-dependencies]\n expect-test = \"1.4.0\""}, {"sha": "3679bfc43c980a85a40909698dbe9fc7f27f9715", "filename": "crates/proc-macro-srv/src/lib.rs", "status": "modified", "additions": 6, "deletions": 11, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/f9d1b26a96144fecd14c1bf61d9fce1060956e4c/crates%2Fproc-macro-srv%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f9d1b26a96144fecd14c1bf61d9fce1060956e4c/crates%2Fproc-macro-srv%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproc-macro-srv%2Fsrc%2Flib.rs?ref=f9d1b26a96144fecd14c1bf61d9fce1060956e4c", "patch": "@@ -26,6 +26,7 @@ use std::{\n     ffi::OsString,\n     fs,\n     path::{Path, PathBuf},\n+    thread,\n     time::SystemTime,\n };\n \n@@ -65,18 +66,16 @@ impl ProcMacroSrv {\n \n         let macro_body = task.macro_body.to_subtree();\n         let attributes = task.attributes.map(|it| it.to_subtree());\n-        // FIXME: replace this with std's scoped threads once they stabilize\n-        // (then remove dependency on crossbeam)\n-        let result = crossbeam::scope(|s| {\n-            let res = match s\n-                .builder()\n+        let result = thread::scope(|s| {\n+            let thread = thread::Builder::new()\n                 .stack_size(EXPANDER_STACK_SIZE)\n                 .name(task.macro_name.clone())\n-                .spawn(|_| {\n+                .spawn_scoped(s, || {\n                     expander\n                         .expand(&task.macro_name, &macro_body, attributes.as_ref())\n                         .map(|it| FlatTree::new(&it))\n-                }) {\n+                });\n+            let res = match thread {\n                 Ok(handle) => handle.join(),\n                 Err(e) => std::panic::resume_unwind(Box::new(e)),\n             };\n@@ -86,10 +85,6 @@ impl ProcMacroSrv {\n                 Err(e) => std::panic::resume_unwind(e),\n             }\n         });\n-        let result = match result {\n-            Ok(result) => result,\n-            Err(e) => std::panic::resume_unwind(e),\n-        };\n \n         prev_env.rollback();\n "}]}