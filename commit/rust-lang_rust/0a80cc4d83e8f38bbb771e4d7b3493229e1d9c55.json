{"sha": "0a80cc4d83e8f38bbb771e4d7b3493229e1d9c55", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBhODBjYzRkODNlOGYzOGJiYjc3MWU0ZDdiMzQ5MzIyOWUxZDljNTU=", "commit": {"author": {"name": "Paul Trojahn", "email": "paul.trojahn@gmail.com", "date": "2021-05-21T19:01:27Z"}, "committer": {"name": "Paul Trojahn", "email": "paul.trojahn@gmail.com", "date": "2021-05-23T16:36:23Z"}, "message": "Replace Local::new(1) with CAPTURE_STRUCT_LOCAL", "tree": {"sha": "0c1b111e00231ad11c9bd25d2581ea4393eb44d2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0c1b111e00231ad11c9bd25d2581ea4393eb44d2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0a80cc4d83e8f38bbb771e4d7b3493229e1d9c55", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0a80cc4d83e8f38bbb771e4d7b3493229e1d9c55", "html_url": "https://github.com/rust-lang/rust/commit/0a80cc4d83e8f38bbb771e4d7b3493229e1d9c55", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0a80cc4d83e8f38bbb771e4d7b3493229e1d9c55/comments", "author": {"login": "ptrojahn", "id": 45311997, "node_id": "MDQ6VXNlcjQ1MzExOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/45311997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ptrojahn", "html_url": "https://github.com/ptrojahn", "followers_url": "https://api.github.com/users/ptrojahn/followers", "following_url": "https://api.github.com/users/ptrojahn/following{/other_user}", "gists_url": "https://api.github.com/users/ptrojahn/gists{/gist_id}", "starred_url": "https://api.github.com/users/ptrojahn/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ptrojahn/subscriptions", "organizations_url": "https://api.github.com/users/ptrojahn/orgs", "repos_url": "https://api.github.com/users/ptrojahn/repos", "events_url": "https://api.github.com/users/ptrojahn/events{/privacy}", "received_events_url": "https://api.github.com/users/ptrojahn/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ptrojahn", "id": 45311997, "node_id": "MDQ6VXNlcjQ1MzExOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/45311997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ptrojahn", "html_url": "https://github.com/ptrojahn", "followers_url": "https://api.github.com/users/ptrojahn/followers", "following_url": "https://api.github.com/users/ptrojahn/following{/other_user}", "gists_url": "https://api.github.com/users/ptrojahn/gists{/gist_id}", "starred_url": "https://api.github.com/users/ptrojahn/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ptrojahn/subscriptions", "organizations_url": "https://api.github.com/users/ptrojahn/orgs", "repos_url": "https://api.github.com/users/ptrojahn/repos", "events_url": "https://api.github.com/users/ptrojahn/events{/privacy}", "received_events_url": "https://api.github.com/users/ptrojahn/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3e827cc21e0734edd26170e8d1481f0d66a1426b", "url": "https://api.github.com/repos/rust-lang/rust/commits/3e827cc21e0734edd26170e8d1481f0d66a1426b", "html_url": "https://github.com/rust-lang/rust/commit/3e827cc21e0734edd26170e8d1481f0d66a1426b"}], "stats": {"total": 39, "additions": 20, "deletions": 19}, "files": [{"sha": "0706a057dd0c6d6d335989d6ce9663e1ab85b18d", "filename": "compiler/rustc_middle/src/ty/closure.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/0a80cc4d83e8f38bbb771e4d7b3493229e1d9c55/compiler%2Frustc_middle%2Fsrc%2Fty%2Fclosure.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0a80cc4d83e8f38bbb771e4d7b3493229e1d9c55/compiler%2Frustc_middle%2Fsrc%2Fty%2Fclosure.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fclosure.rs?ref=0a80cc4d83e8f38bbb771e4d7b3493229e1d9c55", "patch": "@@ -1,7 +1,7 @@\n use crate::hir::place::{\n     Place as HirPlace, PlaceBase as HirPlaceBase, ProjectionKind as HirProjectionKind,\n };\n-use crate::ty;\n+use crate::{mir, ty};\n \n use rustc_data_structures::fx::{FxHashMap, FxIndexMap};\n use rustc_hir as hir;\n@@ -12,6 +12,10 @@ use super::{Ty, TyCtxt};\n \n use self::BorrowKind::*;\n \n+// Captures are represented using fields inside a structure.\n+// This represents accessing self in the closure structure\n+pub const CAPTURE_STRUCT_LOCAL: mir::Local = mir::Local::from_u32(1);\n+\n #[derive(\n     Clone,\n     Copy,"}, {"sha": "8b0761889b83453b9d205d5418a57f4e14bb01e5", "filename": "compiler/rustc_mir/src/borrow_check/diagnostics/conflict_errors.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/0a80cc4d83e8f38bbb771e4d7b3493229e1d9c55/compiler%2Frustc_mir%2Fsrc%2Fborrow_check%2Fdiagnostics%2Fconflict_errors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0a80cc4d83e8f38bbb771e4d7b3493229e1d9c55/compiler%2Frustc_mir%2Fsrc%2Fborrow_check%2Fdiagnostics%2Fconflict_errors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Fborrow_check%2Fdiagnostics%2Fconflict_errors.rs?ref=0a80cc4d83e8f38bbb771e4d7b3493229e1d9c55", "patch": "@@ -4,10 +4,9 @@ use rustc_errors::{Applicability, DiagnosticBuilder};\n use rustc_hir as hir;\n use rustc_hir::def_id::DefId;\n use rustc_hir::{AsyncGeneratorKind, GeneratorKind};\n-use rustc_index::vec::Idx;\n use rustc_middle::mir::{\n     self, AggregateKind, BindingForm, BorrowKind, ClearCrossCrate, ConstraintCategory,\n-    FakeReadCause, Local, LocalDecl, LocalInfo, LocalKind, Location, Operand, Place, PlaceRef,\n+    FakeReadCause, LocalDecl, LocalInfo, LocalKind, Location, Operand, Place, PlaceRef,\n     ProjectionElem, Rvalue, Statement, StatementKind, Terminator, TerminatorKind, VarBindingForm,\n };\n use rustc_middle::ty::{self, suggest_constraining_type_param, Ty, TypeFoldable};\n@@ -1274,7 +1273,9 @@ impl<'cx, 'tcx> MirBorrowckCtxt<'cx, 'tcx> {\n                         bug!(\"temporary or return pointer with a name\")\n                     }\n                     LocalKind::Var => \"local variable \",\n-                    LocalKind::Arg if !self.upvars.is_empty() && local == Local::new(1) => {\n+                    LocalKind::Arg\n+                        if !self.upvars.is_empty() && local == ty::CAPTURE_STRUCT_LOCAL =>\n+                    {\n                         \"variable captured by `move` \"\n                     }\n                     LocalKind::Arg => \"function parameter \","}, {"sha": "d2b156610476c9f561d8f6dd4a85cd6e087aa652", "filename": "compiler/rustc_mir/src/borrow_check/diagnostics/mutability_errors.rs", "status": "modified", "additions": 7, "deletions": 8, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/0a80cc4d83e8f38bbb771e4d7b3493229e1d9c55/compiler%2Frustc_mir%2Fsrc%2Fborrow_check%2Fdiagnostics%2Fmutability_errors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0a80cc4d83e8f38bbb771e4d7b3493229e1d9c55/compiler%2Frustc_mir%2Fsrc%2Fborrow_check%2Fdiagnostics%2Fmutability_errors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Fborrow_check%2Fdiagnostics%2Fmutability_errors.rs?ref=0a80cc4d83e8f38bbb771e4d7b3493229e1d9c55", "patch": "@@ -1,6 +1,5 @@\n use rustc_hir as hir;\n use rustc_hir::Node;\n-use rustc_index::vec::Idx;\n use rustc_middle::hir::map::Map;\n use rustc_middle::mir::{Mutability, Place, PlaceRef, ProjectionElem};\n use rustc_middle::ty::{self, Ty, TyCtxt};\n@@ -115,12 +114,14 @@ impl<'a, 'tcx> MirBorrowckCtxt<'a, 'tcx> {\n                 }\n             }\n             PlaceRef { local: _, projection: [proj_base @ .., ProjectionElem::Deref] } => {\n-                if the_place_err.local == Local::new(1)\n+                if the_place_err.local == ty::CAPTURE_STRUCT_LOCAL\n                     && proj_base.is_empty()\n                     && !self.upvars.is_empty()\n                 {\n                     item_msg = format!(\"`{}`\", access_place_desc.unwrap());\n-                    debug_assert!(self.body.local_decls[Local::new(1)].ty.is_region_ptr());\n+                    debug_assert!(\n+                        self.body.local_decls[ty::CAPTURE_STRUCT_LOCAL].ty.is_region_ptr()\n+                    );\n                     debug_assert!(is_closure_or_generator(\n                         Place::ty_from(\n                             the_place_err.local,\n@@ -478,11 +479,9 @@ impl<'a, 'tcx> MirBorrowckCtxt<'a, 'tcx> {\n                 }\n             }\n \n-            PlaceRef {\n-                local,\n-                projection: [ProjectionElem::Deref],\n-                // FIXME document what is this 1 magic number about\n-            } if local == Local::new(1) && !self.upvars.is_empty() => {\n+            PlaceRef { local, projection: [ProjectionElem::Deref] }\n+                if local == ty::CAPTURE_STRUCT_LOCAL && !self.upvars.is_empty() =>\n+            {\n                 self.expected_fn_found_fn_mut_call(&mut err, span, act);\n             }\n "}, {"sha": "6ae62276e4bb4a1d0359ebb94c804249d62a1239", "filename": "compiler/rustc_mir_build/src/build/expr/as_place.rs", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/0a80cc4d83e8f38bbb771e4d7b3493229e1d9c55/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fexpr%2Fas_place.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0a80cc4d83e8f38bbb771e4d7b3493229e1d9c55/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fexpr%2Fas_place.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fexpr%2Fas_place.rs?ref=0a80cc4d83e8f38bbb771e4d7b3493229e1d9c55", "patch": "@@ -209,9 +209,7 @@ fn to_upvars_resolved_place_builder<'a, 'tcx>(\n     match from_builder.base {\n         PlaceBase::Local(_) => Ok(from_builder),\n         PlaceBase::Upvar { var_hir_id, closure_def_id, closure_kind } => {\n-            // Captures are represented using fields inside a structure.\n-            // This represents accessing self in the closure structure\n-            let mut upvar_resolved_place_builder = PlaceBuilder::from(Local::new(1));\n+            let mut upvar_resolved_place_builder = PlaceBuilder::from(ty::CAPTURE_STRUCT_LOCAL);\n             match closure_kind {\n                 ty::ClosureKind::Fn | ty::ClosureKind::FnMut => {\n                     upvar_resolved_place_builder = upvar_resolved_place_builder.deref();"}, {"sha": "f7adacdb791a976b740f3cd0018a9f3d783c31cc", "filename": "compiler/rustc_mir_build/src/build/expr/as_rvalue.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0a80cc4d83e8f38bbb771e4d7b3493229e1d9c55/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fexpr%2Fas_rvalue.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0a80cc4d83e8f38bbb771e4d7b3493229e1d9c55/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fexpr%2Fas_rvalue.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fexpr%2Fas_rvalue.rs?ref=0a80cc4d83e8f38bbb771e4d7b3493229e1d9c55", "patch": "@@ -433,7 +433,7 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n                     } => {\n                         // Not in a closure\n                         debug_assert!(\n-                            local == Local::new(1),\n+                            local == ty::CAPTURE_STRUCT_LOCAL,\n                             \"Expected local to be Local(1), found {:?}\",\n                             local\n                         );"}, {"sha": "963964f404cadbc5ed74e5d2f0d5e8eb8e732fce", "filename": "compiler/rustc_mir_build/src/build/mod.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/0a80cc4d83e8f38bbb771e4d7b3493229e1d9c55/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0a80cc4d83e8f38bbb771e4d7b3493229e1d9c55/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fmod.rs?ref=0a80cc4d83e8f38bbb771e4d7b3493229e1d9c55", "patch": "@@ -896,9 +896,8 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n         // the given closure and use the necessary information to create upvar\n         // debuginfo and to fill `self.upvar_mutbls`.\n         if hir_typeck_results.closure_min_captures.get(&fn_def_id).is_some() {\n-            let closure_env_arg = Local::new(1);\n             let mut closure_env_projs = vec![];\n-            let mut closure_ty = self.local_decls[closure_env_arg].ty;\n+            let mut closure_ty = self.local_decls[ty::CAPTURE_STRUCT_LOCAL].ty;\n             if let ty::Ref(_, ty, _) = closure_ty.kind() {\n                 closure_env_projs.push(ProjectionElem::Deref);\n                 closure_ty = ty;\n@@ -944,7 +943,7 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n                         name,\n                         source_info: SourceInfo::outermost(tcx_hir.span(var_id)),\n                         value: VarDebugInfoContents::Place(Place {\n-                            local: closure_env_arg,\n+                            local: ty::CAPTURE_STRUCT_LOCAL,\n                             projection: tcx.intern_place_elems(&projs),\n                         }),\n                     });"}]}