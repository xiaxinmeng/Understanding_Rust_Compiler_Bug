{"sha": "6c92656624b3e3c00748fd8b41d925787110a638", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZjOTI2NTY2MjRiM2UzYzAwNzQ4ZmQ4YjQxZDkyNTc4NzExMGE2Mzg=", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2021-08-10T19:18:39Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-08-10T19:18:39Z"}, "message": "Rollup merge of #87854 - BoxyUwU:var-None, r=oli-obk\n\ncorrectly handle enum variants in `opt_const_param_of`\n\nFixes #87542\n\n`opt_const_param_of` was returning `None` for args on an enum variant `Enum::Variant::<10>` because we called `generics_of` on the enum variant which has no generics.\n\nr? `@oli-obk`", "tree": {"sha": "b7e4f2cff7b6c6f3224289bb8b232fa39d75084f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b7e4f2cff7b6c6f3224289bb8b232fa39d75084f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6c92656624b3e3c00748fd8b41d925787110a638", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhEtEPCRBK7hj4Ov3rIwAAd6kIAJEn4mxO/K1Ye2waSYRDpGBK\nc+zZqrnkoC7YhPLkFmiSjGnXskD5dNuz9gTYkC5h2gFK0rdwm2SOBTzeFCQ07HHd\nSgaESzIOFU6PtJbPdMNFzgdGhGHL99l889Rq820QFt8LRF6Z3IAOiSAQW0CaCeqI\nwoxBuuLKDa7SkUZVTnloKce+asfIDRPVVRAKRqApiTn2hffKyfvmC/DNYg+NgL3k\nt4yFhU1eknbrszexdNtbJc83hVr7IO0RJDxTOQUUACyWuY/coEsoPJrfqMNIG4x4\n4OPMgtSmjt+ovqPZOVIlM9GPJ7FsBn4TS5tCAhSzIkAqPljTDxaj0ECtvQqKHyg=\n=Uujo\n-----END PGP SIGNATURE-----\n", "payload": "tree b7e4f2cff7b6c6f3224289bb8b232fa39d75084f\nparent 6412bf98ea65cb0f50959c857088fd77cdc2980f\nparent 5f61271e382cfab7159a6dedcf673cafaab51e5a\nauthor Yuki Okushi <jtitor@2k36.org> 1628623119 +0900\ncommitter GitHub <noreply@github.com> 1628623119 +0900\n\nRollup merge of #87854 - BoxyUwU:var-None, r=oli-obk\n\ncorrectly handle enum variants in `opt_const_param_of`\n\nFixes #87542\n\n`opt_const_param_of` was returning `None` for args on an enum variant `Enum::Variant::<10>` because we called `generics_of` on the enum variant which has no generics.\n\nr? `@oli-obk`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6c92656624b3e3c00748fd8b41d925787110a638", "html_url": "https://github.com/rust-lang/rust/commit/6c92656624b3e3c00748fd8b41d925787110a638", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6c92656624b3e3c00748fd8b41d925787110a638/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6412bf98ea65cb0f50959c857088fd77cdc2980f", "url": "https://api.github.com/repos/rust-lang/rust/commits/6412bf98ea65cb0f50959c857088fd77cdc2980f", "html_url": "https://github.com/rust-lang/rust/commit/6412bf98ea65cb0f50959c857088fd77cdc2980f"}, {"sha": "5f61271e382cfab7159a6dedcf673cafaab51e5a", "url": "https://api.github.com/repos/rust-lang/rust/commits/5f61271e382cfab7159a6dedcf673cafaab51e5a", "html_url": "https://github.com/rust-lang/rust/commit/5f61271e382cfab7159a6dedcf673cafaab51e5a"}], "stats": {"total": 31, "additions": 29, "deletions": 2}, "files": [{"sha": "b9483d6f987602c665b5867facaccbd1b12851e8", "filename": "compiler/rustc_typeck/src/collect/type_of.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/6c92656624b3e3c00748fd8b41d925787110a638/compiler%2Frustc_typeck%2Fsrc%2Fcollect%2Ftype_of.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6c92656624b3e3c00748fd8b41d925787110a638/compiler%2Frustc_typeck%2Fsrc%2Fcollect%2Ftype_of.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcollect%2Ftype_of.rs?ref=6c92656624b3e3c00748fd8b41d925787110a638", "patch": "@@ -190,8 +190,12 @@ pub(super) fn opt_const_param_of(tcx: TyCtxt<'_>, def_id: LocalDefId) -> Option<\n                 // Try to use the segment resolution if it is valid, otherwise we\n                 // default to the path resolution.\n                 let res = segment.res.filter(|&r| r != Res::Err).unwrap_or(path.res);\n+                use def::CtorOf;\n                 let generics = match res {\n-                    Res::Def(DefKind::Ctor(..), def_id) => {\n+                    Res::Def(DefKind::Ctor(CtorOf::Variant, _), def_id) => tcx.generics_of(\n+                        tcx.parent(def_id).and_then(|def_id| tcx.parent(def_id)).unwrap(),\n+                    ),\n+                    Res::Def(DefKind::Variant | DefKind::Ctor(CtorOf::Struct, _), def_id) => {\n                         tcx.generics_of(tcx.parent(def_id).unwrap())\n                     }\n                     // Other `DefKind`s don't have generics and would ICE when calling\n@@ -200,7 +204,6 @@ pub(super) fn opt_const_param_of(tcx: TyCtxt<'_>, def_id: LocalDefId) -> Option<\n                         DefKind::Struct\n                         | DefKind::Union\n                         | DefKind::Enum\n-                        | DefKind::Variant\n                         | DefKind::Trait\n                         | DefKind::OpaqueTy\n                         | DefKind::TyAlias"}, {"sha": "5c6c4a8efac155cad375fd5fde59df1e926e6ae7", "filename": "src/test/ui/const-generics/enum-variants.rs", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/6c92656624b3e3c00748fd8b41d925787110a638/src%2Ftest%2Fui%2Fconst-generics%2Fenum-variants.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6c92656624b3e3c00748fd8b41d925787110a638/src%2Ftest%2Fui%2Fconst-generics%2Fenum-variants.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconst-generics%2Fenum-variants.rs?ref=6c92656624b3e3c00748fd8b41d925787110a638", "patch": "@@ -0,0 +1,24 @@\n+// check-pass\n+enum Foo<const N: usize> {\n+    Variant,\n+    Variant2(),\n+    Variant3{},\n+}\n+\n+struct Bar<const N: usize>;\n+struct Bar2<const N: usize>();\n+struct Bar3<const N: usize> {}\n+\n+fn main() {\n+    let _ = Foo::Variant::<1>;\n+    let _ = Foo::Variant2::<1>();\n+    let _ = Foo::Variant3::<1>{};\n+\n+    let _ = Foo::<1>::Variant;\n+    let _ = Foo::<1>::Variant2();\n+    let _ = Foo::<1>::Variant3{};\n+\n+    let _ = Bar::<1>;\n+    let _ = Bar2::<1>();\n+    let _ = Bar3::<1>{};\n+}"}]}