{"sha": "6eb50729291c64acf0d6588dd632e9792508ca31", "node_id": "C_kwDOAAsO6NoAKDZlYjUwNzI5MjkxYzY0YWNmMGQ2NTg4ZGQ2MzJlOTc5MjUwOGNhMzE", "commit": {"author": {"name": "Nikita Popov", "email": "nikita.ppv@gmail.com", "date": "2021-12-19T16:36:48Z"}, "committer": {"name": "Nikita Popov", "email": "nikita.ppv@gmail.com", "date": "2021-12-19T16:39:43Z"}, "message": "Actually set IMAGE_SCN_LNK_REMOVE for .rmeta\n\nThe code intended to set the IMAGE_SCN_LNK_REMOVE flag for the\n.rmeta section, however the value of this flag was set to zero.\nInstead use the actual value provided by the object crate.\n\nThis dates back to the original introduction of this code in\nPR #84449, so we were never setting this flag. As I'm not on\nWindows, I'm not sure whether that means we were embedding .rmeta\ninto executables, or whether the section ended up getting stripped\nfor some other reason.", "tree": {"sha": "b0040998b85128698f76dc7e3aca66b00d8e1689", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b0040998b85128698f76dc7e3aca66b00d8e1689"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6eb50729291c64acf0d6588dd632e9792508ca31", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6eb50729291c64acf0d6588dd632e9792508ca31", "html_url": "https://github.com/rust-lang/rust/commit/6eb50729291c64acf0d6588dd632e9792508ca31", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6eb50729291c64acf0d6588dd632e9792508ca31/comments", "author": {"login": "nikic", "id": 216080, "node_id": "MDQ6VXNlcjIxNjA4MA==", "avatar_url": "https://avatars.githubusercontent.com/u/216080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikic", "html_url": "https://github.com/nikic", "followers_url": "https://api.github.com/users/nikic/followers", "following_url": "https://api.github.com/users/nikic/following{/other_user}", "gists_url": "https://api.github.com/users/nikic/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikic/subscriptions", "organizations_url": "https://api.github.com/users/nikic/orgs", "repos_url": "https://api.github.com/users/nikic/repos", "events_url": "https://api.github.com/users/nikic/events{/privacy}", "received_events_url": "https://api.github.com/users/nikic/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nikic", "id": 216080, "node_id": "MDQ6VXNlcjIxNjA4MA==", "avatar_url": "https://avatars.githubusercontent.com/u/216080?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikic", "html_url": "https://github.com/nikic", "followers_url": "https://api.github.com/users/nikic/followers", "following_url": "https://api.github.com/users/nikic/following{/other_user}", "gists_url": "https://api.github.com/users/nikic/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikic/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikic/subscriptions", "organizations_url": "https://api.github.com/users/nikic/orgs", "repos_url": "https://api.github.com/users/nikic/repos", "events_url": "https://api.github.com/users/nikic/events{/privacy}", "received_events_url": "https://api.github.com/users/nikic/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "41c3017c82bbc16842cc3bc1afa904e6910e293c", "url": "https://api.github.com/repos/rust-lang/rust/commits/41c3017c82bbc16842cc3bc1afa904e6910e293c", "html_url": "https://github.com/rust-lang/rust/commit/41c3017c82bbc16842cc3bc1afa904e6910e293c"}], "stats": {"total": 11, "additions": 5, "deletions": 6}, "files": [{"sha": "a442290f39db8a86ca3e3773b60afecbad864f12", "filename": "compiler/rustc_codegen_ssa/src/back/metadata.rs", "status": "modified", "additions": 5, "deletions": 6, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/6eb50729291c64acf0d6588dd632e9792508ca31/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Fmetadata.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6eb50729291c64acf0d6588dd632e9792508ca31/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Fmetadata.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Fmetadata.rs?ref=6eb50729291c64acf0d6588dd632e9792508ca31", "patch": "@@ -6,8 +6,8 @@ use std::path::Path;\n \n use object::write::{self, StandardSegment, Symbol, SymbolSection};\n use object::{\n-    elf, Architecture, BinaryFormat, Endianness, FileFlags, Object, ObjectSection, SectionFlags,\n-    SectionKind, SymbolFlags, SymbolKind, SymbolScope,\n+    elf, pe, Architecture, BinaryFormat, Endianness, FileFlags, Object, ObjectSection,\n+    SectionFlags, SectionKind, SymbolFlags, SymbolKind, SymbolScope,\n };\n \n use snap::write::FrameEncoder;\n@@ -216,13 +216,12 @@ pub fn create_rmeta_file(sess: &Session, metadata: &[u8]) -> Vec<u8> {\n     );\n     match file.format() {\n         BinaryFormat::Coff => {\n-            const IMAGE_SCN_LNK_REMOVE: u32 = 0;\n             file.section_mut(section).flags =\n-                SectionFlags::Coff { characteristics: IMAGE_SCN_LNK_REMOVE };\n+                SectionFlags::Coff { characteristics: pe::IMAGE_SCN_LNK_REMOVE };\n         }\n         BinaryFormat::Elf => {\n-            const SHF_EXCLUDE: u64 = 0x80000000;\n-            file.section_mut(section).flags = SectionFlags::Elf { sh_flags: SHF_EXCLUDE };\n+            file.section_mut(section).flags =\n+                SectionFlags::Elf { sh_flags: elf::SHF_EXCLUDE as u64 };\n         }\n         _ => {}\n     };"}]}