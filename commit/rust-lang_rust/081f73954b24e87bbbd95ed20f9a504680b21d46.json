{"sha": "081f73954b24e87bbbd95ed20f9a504680b21d46", "node_id": "C_kwDOAAsO6NoAKDA4MWY3Mzk1NGIyNGU4N2JiYmQ5NWVkMjBmOWE1MDQ2ODBiMjFkNDY", "commit": {"author": {"name": "TennyZhuang", "email": "zty0826@gmail.com", "date": "2022-10-02T09:12:08Z"}, "committer": {"name": "TennyZhuang", "email": "zty0826@gmail.com", "date": "2022-10-02T15:02:11Z"}, "message": "let unnecessary_cast work for trivial non_literal expressions\n\nSigned-off-by: TennyZhuang <zty0826@gmail.com>", "tree": {"sha": "a8cf7ca73ce92e1b88a583f45d7f3771e3afe4da", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a8cf7ca73ce92e1b88a583f45d7f3771e3afe4da"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/081f73954b24e87bbbd95ed20f9a504680b21d46", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/081f73954b24e87bbbd95ed20f9a504680b21d46", "html_url": "https://github.com/rust-lang/rust/commit/081f73954b24e87bbbd95ed20f9a504680b21d46", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/081f73954b24e87bbbd95ed20f9a504680b21d46/comments", "author": {"login": "TennyZhuang", "id": 9161438, "node_id": "MDQ6VXNlcjkxNjE0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/9161438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/TennyZhuang", "html_url": "https://github.com/TennyZhuang", "followers_url": "https://api.github.com/users/TennyZhuang/followers", "following_url": "https://api.github.com/users/TennyZhuang/following{/other_user}", "gists_url": "https://api.github.com/users/TennyZhuang/gists{/gist_id}", "starred_url": "https://api.github.com/users/TennyZhuang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/TennyZhuang/subscriptions", "organizations_url": "https://api.github.com/users/TennyZhuang/orgs", "repos_url": "https://api.github.com/users/TennyZhuang/repos", "events_url": "https://api.github.com/users/TennyZhuang/events{/privacy}", "received_events_url": "https://api.github.com/users/TennyZhuang/received_events", "type": "User", "site_admin": false}, "committer": {"login": "TennyZhuang", "id": 9161438, "node_id": "MDQ6VXNlcjkxNjE0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/9161438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/TennyZhuang", "html_url": "https://github.com/TennyZhuang", "followers_url": "https://api.github.com/users/TennyZhuang/followers", "following_url": "https://api.github.com/users/TennyZhuang/following{/other_user}", "gists_url": "https://api.github.com/users/TennyZhuang/gists{/gist_id}", "starred_url": "https://api.github.com/users/TennyZhuang/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/TennyZhuang/subscriptions", "organizations_url": "https://api.github.com/users/TennyZhuang/orgs", "repos_url": "https://api.github.com/users/TennyZhuang/repos", "events_url": "https://api.github.com/users/TennyZhuang/events{/privacy}", "received_events_url": "https://api.github.com/users/TennyZhuang/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ac12011315e0447cf7294102a342793c1d8c7cb8", "url": "https://api.github.com/repos/rust-lang/rust/commits/ac12011315e0447cf7294102a342793c1d8c7cb8", "html_url": "https://github.com/rust-lang/rust/commit/ac12011315e0447cf7294102a342793c1d8c7cb8"}], "stats": {"total": 39, "additions": 37, "deletions": 2}, "files": [{"sha": "071fab1165d4d8354232627be65db7f2a026800b", "filename": "clippy_lints/src/casts/unnecessary_cast.rs", "status": "modified", "additions": 14, "deletions": 1, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/081f73954b24e87bbbd95ed20f9a504680b21d46/clippy_lints%2Fsrc%2Fcasts%2Funnecessary_cast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/081f73954b24e87bbbd95ed20f9a504680b21d46/clippy_lints%2Fsrc%2Fcasts%2Funnecessary_cast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fcasts%2Funnecessary_cast.rs?ref=081f73954b24e87bbbd95ed20f9a504680b21d46", "patch": "@@ -31,8 +31,10 @@ pub(super) fn check<'tcx>(\n         }\n     }\n \n+    let cast_str = snippet_opt(cx, cast_expr.span).unwrap_or_default();\n+\n     if let Some(lit) = get_numeric_literal(cast_expr) {\n-        let literal_str = snippet_opt(cx, cast_expr.span).unwrap_or_default();\n+        let literal_str = cast_str;\n \n         if_chain! {\n             if let LitKind::Int(n, _) = lit.node;\n@@ -81,6 +83,17 @@ pub(super) fn check<'tcx>(\n                 }\n             },\n         }\n+    } else if cast_from.kind() == cast_to.kind() && !in_external_macro(cx.sess(), expr.span) {\n+        span_lint_and_sugg(\n+            cx,\n+            UNNECESSARY_CAST,\n+            expr.span,\n+            &format!(\"casting to the same type is unnecessary (`{cast_from}` -> `{cast_to}`)\"),\n+            \"try\",\n+            cast_str,\n+            Applicability::MachineApplicable,\n+        );\n+        return true;\n     }\n \n     false"}, {"sha": "94dc96427263cf36102800d5e04b25c608830eee", "filename": "tests/ui/unnecessary_cast.fixed", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/081f73954b24e87bbbd95ed20f9a504680b21d46/tests%2Fui%2Funnecessary_cast.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/081f73954b24e87bbbd95ed20f9a504680b21d46/tests%2Fui%2Funnecessary_cast.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Funnecessary_cast.fixed?ref=081f73954b24e87bbbd95ed20f9a504680b21d46", "patch": "@@ -103,4 +103,12 @@ mod fixable {\n         #[allow(clippy::precedence)]\n         let _: f64 = -8.0_f64.exp(); // should suggest `-8.0_f64.exp()` here not to change code behavior\n     }\n+\n+    fn issue_9562_non_literal() {\n+        fn foo() -> f32 {\n+            0.\n+        }\n+\n+        let _num = foo();\n+    }\n }"}, {"sha": "e5150256f69ac49e5dbd465c616484352e5b5297", "filename": "tests/ui/unnecessary_cast.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/081f73954b24e87bbbd95ed20f9a504680b21d46/tests%2Fui%2Funnecessary_cast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/081f73954b24e87bbbd95ed20f9a504680b21d46/tests%2Fui%2Funnecessary_cast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Funnecessary_cast.rs?ref=081f73954b24e87bbbd95ed20f9a504680b21d46", "patch": "@@ -103,4 +103,12 @@ mod fixable {\n         #[allow(clippy::precedence)]\n         let _: f64 = -(8.0 as f64).exp(); // should suggest `-8.0_f64.exp()` here not to change code behavior\n     }\n+\n+    fn issue_9562_non_literal() {\n+        fn foo() -> f32 {\n+            0.\n+        }\n+\n+        let _num = foo() as f32;\n+    }\n }"}, {"sha": "e5c3dd5e53f876e2489d702319694058069fd6d4", "filename": "tests/ui/unnecessary_cast.stderr", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/081f73954b24e87bbbd95ed20f9a504680b21d46/tests%2Fui%2Funnecessary_cast.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/081f73954b24e87bbbd95ed20f9a504680b21d46/tests%2Fui%2Funnecessary_cast.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Funnecessary_cast.stderr?ref=081f73954b24e87bbbd95ed20f9a504680b21d46", "patch": "@@ -174,5 +174,11 @@ error: casting float literal to `f64` is unnecessary\n LL |         let _: f64 = -(8.0 as f64).exp(); // should suggest `-8.0_f64.exp()` here not to change code behavior\n    |                       ^^^^^^^^^^^^ help: try: `8.0_f64`\n \n-error: aborting due to 29 previous errors\n+error: casting to the same type is unnecessary (`f32` -> `f32`)\n+  --> $DIR/unnecessary_cast.rs:112:20\n+   |\n+LL |         let _num = foo() as f32;\n+   |                    ^^^^^^^^^^^^ help: try: `foo()`\n+\n+error: aborting due to 30 previous errors\n "}]}