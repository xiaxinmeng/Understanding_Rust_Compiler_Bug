{"sha": "955064b6aaa5c24e980328f9d9fbe731cc29636c", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk1NTA2NGI2YWFhNWMyNGU5ODAzMjhmOWQ5ZmJlNzMxY2MyOTYzNmM=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-06-01T19:33:14Z"}, "committer": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-06-01T19:34:08Z"}, "message": "Implement `#[rustc_skip_array_during_method_dispatch]`", "tree": {"sha": "533c9942faa54bb7859c0fb986c5699847c7cea2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/533c9942faa54bb7859c0fb986c5699847c7cea2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/955064b6aaa5c24e980328f9d9fbe731cc29636c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/955064b6aaa5c24e980328f9d9fbe731cc29636c", "html_url": "https://github.com/rust-lang/rust/commit/955064b6aaa5c24e980328f9d9fbe731cc29636c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/955064b6aaa5c24e980328f9d9fbe731cc29636c/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "dbdfeeeff91b5e42d8687df09dda1d29f99b34f8", "url": "https://api.github.com/repos/rust-lang/rust/commits/dbdfeeeff91b5e42d8687df09dda1d29f99b34f8", "html_url": "https://github.com/rust-lang/rust/commit/dbdfeeeff91b5e42d8687df09dda1d29f99b34f8"}], "stats": {"total": 79, "additions": 77, "deletions": 2}, "files": [{"sha": "2f06a6e29accb4c4c80bdc2610e18712b02695b8", "filename": "crates/hir_def/src/data.rs", "status": "modified", "additions": 13, "deletions": 1, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/955064b6aaa5c24e980328f9d9fbe731cc29636c/crates%2Fhir_def%2Fsrc%2Fdata.rs", "raw_url": "https://github.com/rust-lang/rust/raw/955064b6aaa5c24e980328f9d9fbe731cc29636c/crates%2Fhir_def%2Fsrc%2Fdata.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fdata.rs?ref=955064b6aaa5c24e980328f9d9fbe731cc29636c", "patch": "@@ -143,6 +143,7 @@ pub struct TraitData {\n     pub is_auto: bool,\n     pub is_unsafe: bool,\n     pub visibility: RawVisibility,\n+    pub skip_array_during_method_dispatch: bool,\n }\n \n impl TraitData {\n@@ -157,6 +158,10 @@ impl TraitData {\n         let container = AssocContainerId::TraitId(tr);\n         let visibility = item_tree[tr_def.visibility].clone();\n         let mut expander = Expander::new(db, tr_loc.id.file_id(), module_id);\n+        let skip_array_during_method_dispatch = item_tree\n+            .attrs(db, tr_loc.container.krate(), ModItem::from(tr_loc.id.value).into())\n+            .by_key(\"rustc_skip_array_during_method_dispatch\")\n+            .exists();\n \n         let items = collect_items(\n             db,\n@@ -168,7 +173,14 @@ impl TraitData {\n             100,\n         );\n \n-        Arc::new(TraitData { name, items, is_auto, is_unsafe, visibility })\n+        Arc::new(TraitData {\n+            name,\n+            items,\n+            is_auto,\n+            is_unsafe,\n+            visibility,\n+            skip_array_during_method_dispatch,\n+        })\n     }\n \n     pub fn associated_types(&self) -> impl Iterator<Item = TypeAliasId> + '_ {"}, {"sha": "a23527f7df253837510a1f5a625c07cea4cae755", "filename": "crates/hir_ty/src/method_resolution.rs", "status": "modified", "additions": 15, "deletions": 1, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/955064b6aaa5c24e980328f9d9fbe731cc29636c/crates%2Fhir_ty%2Fsrc%2Fmethod_resolution.rs", "raw_url": "https://github.com/rust-lang/rust/raw/955064b6aaa5c24e980328f9d9fbe731cc29636c/crates%2Fhir_ty%2Fsrc%2Fmethod_resolution.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Fmethod_resolution.rs?ref=955064b6aaa5c24e980328f9d9fbe731cc29636c", "patch": "@@ -5,7 +5,7 @@\n use std::{iter, sync::Arc};\n \n use arrayvec::ArrayVec;\n-use base_db::CrateId;\n+use base_db::{CrateId, Edition};\n use chalk_ir::{cast::Cast, Mutability, UniverseIndex};\n use hir_def::{\n     lang_item::LangItemTarget, nameres::DefMap, AssocContainerId, AssocItemId, FunctionId,\n@@ -639,6 +639,7 @@ fn iterate_trait_method_candidates(\n     receiver_ty: Option<&Canonical<Ty>>,\n     callback: &mut dyn FnMut(&Ty, AssocItemId) -> bool,\n ) -> bool {\n+    let receiver_is_array = matches!(self_ty.value.kind(&Interner), chalk_ir::TyKind::Array(..));\n     // if ty is `dyn Trait`, the trait doesn't need to be in scope\n     let inherent_trait =\n         self_ty.value.dyn_trait().into_iter().flat_map(|t| all_super_traits(db.upcast(), t));\n@@ -655,6 +656,19 @@ fn iterate_trait_method_candidates(\n     'traits: for t in traits {\n         let data = db.trait_data(t);\n \n+        // Traits annotated with `#[rustc_skip_array_during_method_dispatch]` are skipped during\n+        // method resolution, if the receiver is an array, and we're compiling for editions before\n+        // 2021.\n+        // This is to make `[a].into_iter()` not break code with the new `IntoIterator` impl for\n+        // arrays.\n+        if data.skip_array_during_method_dispatch && receiver_is_array {\n+            // FIXME: this should really be using the edition of the method name's span, in case it\n+            // comes from a macro\n+            if db.crate_graph()[krate].edition < Edition::Edition2021 {\n+                continue;\n+            }\n+        }\n+\n         // we'll be lazy about checking whether the type implements the\n         // trait, but if we find out it doesn't, we'll skip the rest of the\n         // iteration"}, {"sha": "f26b2c8a79c04641b04693ab2d8a5d899f4aa2b5", "filename": "crates/hir_ty/src/tests/method_resolution.rs", "status": "modified", "additions": 49, "deletions": 0, "changes": 49, "blob_url": "https://github.com/rust-lang/rust/blob/955064b6aaa5c24e980328f9d9fbe731cc29636c/crates%2Fhir_ty%2Fsrc%2Ftests%2Fmethod_resolution.rs", "raw_url": "https://github.com/rust-lang/rust/raw/955064b6aaa5c24e980328f9d9fbe731cc29636c/crates%2Fhir_ty%2Fsrc%2Ftests%2Fmethod_resolution.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Ftests%2Fmethod_resolution.rs?ref=955064b6aaa5c24e980328f9d9fbe731cc29636c", "patch": "@@ -1349,3 +1349,52 @@ fn f() {\n     \"#,\n     );\n }\n+\n+#[test]\n+fn skip_array_during_method_dispatch() {\n+    check_types(\n+        r#\"\n+//- /main2018.rs crate:main2018 deps:core\n+use core::IntoIterator;\n+\n+fn f() {\n+    let v = [4].into_iter();\n+    v;\n+  //^ &i32\n+\n+    let a = [0, 1].into_iter();\n+    a;\n+  //^ &i32\n+}\n+\n+//- /main2021.rs crate:main2021 deps:core edition:2021\n+use core::IntoIterator;\n+\n+fn f() {\n+    let v = [4].into_iter();\n+    v;\n+  //^ i32\n+\n+    let a = [0, 1].into_iter();\n+    a;\n+  //^ &i32\n+}\n+\n+//- /core.rs crate:core\n+#[rustc_skip_array_during_method_dispatch]\n+pub trait IntoIterator {\n+    type Out;\n+    fn into_iter(self) -> Self::Out;\n+}\n+\n+impl<T> IntoIterator for [T; 1] {\n+    type Out = T;\n+    fn into_iter(self) -> Self::Out {}\n+}\n+impl<'a, T> IntoIterator for &'a [T] {\n+    type Out = &'a T;\n+    fn into_iter(self) -> Self::Out {}\n+}\n+    \"#,\n+    );\n+}"}]}