{"sha": "996c6b7964a5d587f253a9b469cb00e20dc1b5fe", "node_id": "C_kwDOAAsO6NoAKDk5NmM2Yjc5NjRhNWQ1ODdmMjUzYTliNDY5Y2IwMGUyMGRjMWI1ZmU", "commit": {"author": {"name": "flip1995", "email": "philipp.krones@embecosm.com", "date": "2022-04-21T13:16:02Z"}, "committer": {"name": "Philipp Krones", "email": "hello@philkrones.com", "date": "2022-06-14T12:50:52Z"}, "message": "Add test for VFE optimization", "tree": {"sha": "846341616557faf0348e6e47a93e897c6c72e8d1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/846341616557faf0348e6e47a93e897c6c72e8d1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/996c6b7964a5d587f253a9b469cb00e20dc1b5fe", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEij1UXJ/PQTcb99vTHKDfKvWdaKUFAmKohCwACgkQHKDfKvWd\naKUchBAAmcudJ4cHpPsi9y52lnC3r5t4C/J4P2cXw3gU9Y+BQx4sjwNGKLssKHmS\nAKeAJUlFZTtg1dPhf4Hr5aptDO4DwvOvAzyjoJKZvitIckTLEPGXoVGVmbGCq5O2\n8zXWj2pevAD8PjfsJlTv52qOK9HoSQk4Ask1LCPR3hLyo2/63PuvB0Zowga9BFKs\n2M0hIB2QkdG/IveQuIXg8Woqks9+S6K9cQo1z3P7inyerNMiDGL1XD+PAJHbzqKJ\nXz9atMfMsLHVWZr8nEwHjJRbYwVsohRrmmwG5M+FNvi/8M3jv9icVEZHCv+twnvH\ncGyjyLjonsR5+Ba7rGx0AhEmyRbtT4VJd/+lmT1aov4o9j+shfSjr7bWQtAZsaUw\nV4ZfK6F8GRyIDUoJsWmbz2fWrbuNekxbirwC85j2/SIvLtjmy/6B5nizmNh3keTS\nEC7R3rOawH6POM6gggx0dxoUS7BlhQh97sWpcA4Ct+h6e6FVbwRBaMuI/yF6ZveG\nVDnXkz8N5EjZ8cLUV4Sd7l1z9CWEZLFqgS3997COdB+fQ7EF4UX0FRdvfusCG3TX\nk384C90aZS0idM5AxuC7x4b2wk9hprWZDco22T3tTkJW6Dg3uKHsbfFHnZs6dBHy\nAQr5rf7hHEPPXvjdfQcOyLo+Tx5rctPl1Kghe4Vsc+eN+wmxZU4=\n=3fR9\n-----END PGP SIGNATURE-----", "payload": "tree 846341616557faf0348e6e47a93e897c6c72e8d1\nparent e96e6e2c89265613e136369ccf314c408e1eb002\nauthor flip1995 <philipp.krones@embecosm.com> 1650546962 +0100\ncommitter Philipp Krones <hello@philkrones.com> 1655211052 +0200\n\nAdd test for VFE optimization\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/996c6b7964a5d587f253a9b469cb00e20dc1b5fe", "html_url": "https://github.com/rust-lang/rust/commit/996c6b7964a5d587f253a9b469cb00e20dc1b5fe", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/996c6b7964a5d587f253a9b469cb00e20dc1b5fe/comments", "author": {"login": "flip1995", "id": 9744647, "node_id": "MDQ6VXNlcjk3NDQ2NDc=", "avatar_url": "https://avatars.githubusercontent.com/u/9744647?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flip1995", "html_url": "https://github.com/flip1995", "followers_url": "https://api.github.com/users/flip1995/followers", "following_url": "https://api.github.com/users/flip1995/following{/other_user}", "gists_url": "https://api.github.com/users/flip1995/gists{/gist_id}", "starred_url": "https://api.github.com/users/flip1995/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flip1995/subscriptions", "organizations_url": "https://api.github.com/users/flip1995/orgs", "repos_url": "https://api.github.com/users/flip1995/repos", "events_url": "https://api.github.com/users/flip1995/events{/privacy}", "received_events_url": "https://api.github.com/users/flip1995/received_events", "type": "User", "site_admin": false}, "committer": {"login": "flip1995", "id": 9744647, "node_id": "MDQ6VXNlcjk3NDQ2NDc=", "avatar_url": "https://avatars.githubusercontent.com/u/9744647?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flip1995", "html_url": "https://github.com/flip1995", "followers_url": "https://api.github.com/users/flip1995/followers", "following_url": "https://api.github.com/users/flip1995/following{/other_user}", "gists_url": "https://api.github.com/users/flip1995/gists{/gist_id}", "starred_url": "https://api.github.com/users/flip1995/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flip1995/subscriptions", "organizations_url": "https://api.github.com/users/flip1995/orgs", "repos_url": "https://api.github.com/users/flip1995/repos", "events_url": "https://api.github.com/users/flip1995/events{/privacy}", "received_events_url": "https://api.github.com/users/flip1995/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e96e6e2c89265613e136369ccf314c408e1eb002", "url": "https://api.github.com/repos/rust-lang/rust/commits/e96e6e2c89265613e136369ccf314c408e1eb002", "html_url": "https://github.com/rust-lang/rust/commit/e96e6e2c89265613e136369ccf314c408e1eb002"}], "stats": {"total": 99, "additions": 99, "deletions": 0}, "files": [{"sha": "46f96d505b8825d3750e9fe9da837025508c944e", "filename": "src/test/codegen/virtual-function-elimination.rs", "status": "added", "additions": 99, "deletions": 0, "changes": 99, "blob_url": "https://github.com/rust-lang/rust/blob/996c6b7964a5d587f253a9b469cb00e20dc1b5fe/src%2Ftest%2Fcodegen%2Fvirtual-function-elimination.rs", "raw_url": "https://github.com/rust-lang/rust/raw/996c6b7964a5d587f253a9b469cb00e20dc1b5fe/src%2Ftest%2Fcodegen%2Fvirtual-function-elimination.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fvirtual-function-elimination.rs?ref=996c6b7964a5d587f253a9b469cb00e20dc1b5fe", "patch": "@@ -0,0 +1,99 @@\n+// compile-flags: -Zvirtual-function-elimination -Clto -O -Csymbol-mangling-version=v0\n+\n+// CHECK: @vtable.0 = {{.*}}, !type ![[TYPE0:[0-9]+]], !vcall_visibility ![[VCALL_VIS0:[0-9]+]]\n+// CHECK: @vtable.1 = {{.*}}, !type ![[TYPE1:[0-9]+]], !vcall_visibility ![[VCALL_VIS0:[0-9]+]]\n+// CHECK: @vtable.2 = {{.*}}, !type ![[TYPE2:[0-9]+]], !vcall_visibility ![[VCALL_VIS2:[0-9]+]]\n+\n+#![crate_type = \"lib\"]\n+#![allow(incomplete_features)]\n+#![feature(unsized_locals)]\n+\n+use std::rc::Rc;\n+\n+trait T {\n+    // CHECK-LABEL: ; <virtual_function_elimination::S as virtual_function_elimination::T>::used\n+    fn used(&self) -> i32 {\n+        1\n+    }\n+    // CHECK-LABEL: ; <virtual_function_elimination::S as virtual_function_elimination::T>::used_through_sub_trait\n+    fn used_through_sub_trait(&self) -> i32 {\n+        3\n+    }\n+    // CHECK-LABEL: ; <virtual_function_elimination::S as virtual_function_elimination::T>::by_rc\n+    fn by_rc(self: Rc<Self>) -> i32 {\n+        self.used() + self.used()\n+    }\n+    // CHECK-LABEL-NOT: {{.*}}::unused\n+    fn unused(&self) -> i32 {\n+        2\n+    }\n+    // CHECK-LABEL-NOT: {{.*}}::by_rc_unused\n+    fn by_rc_unused(self: Rc<Self>) -> i32 {\n+        self.by_rc()\n+    }\n+}\n+\n+trait U: T {\n+    // CHECK-LABEL: ; <virtual_function_elimination::S as virtual_function_elimination::U>::subtrait_used\n+    fn subtrait_used(&self) -> i32 {\n+        4\n+    }\n+    // CHECK-LABEL-NOT: {{.*}}::subtrait_unused\n+    fn subtrait_unused(&self) -> i32 {\n+        5\n+    }\n+}\n+\n+pub trait V {\n+    // CHECK-LABEL: ; <virtual_function_elimination::S as virtual_function_elimination::V>::public_function\n+    fn public_function(&self) -> i32;\n+}\n+\n+#[derive(Copy, Clone)]\n+struct S;\n+\n+impl T for S {}\n+\n+impl U for S {}\n+\n+impl V for S {\n+    fn public_function(&self) -> i32 {\n+        6\n+    }\n+}\n+\n+fn taking_t(t: &dyn T) -> i32 {\n+    // CHECK: @llvm.type.checked.load({{.*}}, i32 24, metadata !\"[[MANGLED_TYPE0:[0-9a-zA-Z_]+]]\")\n+    t.used()\n+}\n+\n+fn taking_rc_t(t: Rc<dyn T>) -> i32 {\n+    // CHECK: @llvm.type.checked.load({{.*}}, i32 40, metadata !\"[[MANGLED_TYPE0:[0-9a-zA-Z_]+]]\")\n+    t.by_rc()\n+}\n+\n+fn taking_u(u: &dyn U) -> i32 {\n+    // CHECK: @llvm.type.checked.load({{.*}}, i32 64, metadata !\"[[MANGLED_TYPE1:[0-9a-zA-Z_]+]]\")\n+    // CHECK: @llvm.type.checked.load({{.*}}, i32 24, metadata !\"[[MANGLED_TYPE1:[0-9a-zA-Z_]+]]\")\n+    // CHECK: @llvm.type.checked.load({{.*}}, i32 32, metadata !\"[[MANGLED_TYPE1:[0-9a-zA-Z_]+]]\")\n+    u.subtrait_used() + u.used() + u.used_through_sub_trait()\n+}\n+\n+pub fn taking_v(v: &dyn V) -> i32 {\n+    // CHECK: @llvm.type.checked.load({{.*}}, i32 24, metadata !\"NtCsfRpWlKdQPZn_28virtual_function_elimination1V\")\n+    v.public_function()\n+}\n+\n+pub fn main() {\n+    let s = S;\n+    taking_t(&s);\n+    taking_rc_t(Rc::new(s));\n+    taking_u(&s);\n+    taking_v(&s);\n+}\n+\n+// CHECK: ![[TYPE0]] = !{i64 0, !\"[[MANGLED_TYPE0]]\"}\n+// CHECK: ![[VCALL_VIS0]] = !{i64 2}\n+// CHECK: ![[TYPE1]] = !{i64 0, !\"[[MANGLED_TYPE1]]\"}\n+// CHECK: ![[TYPE2]] = !{i64 0, !\"NtCsfRpWlKdQPZn_28virtual_function_elimination1V\"}\n+// CHECK: ![[VCALL_VIS2]] = !{i64 1}"}]}