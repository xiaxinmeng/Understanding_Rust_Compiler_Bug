{"sha": "dd33766e4a9a918058c3447d42491e874e21f7cc", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRkMzM3NjZlNGE5YTkxODA1OGMzNDQ3ZDQyNDkxZTg3NGUyMWY3Y2M=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-09-13T05:16:36Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-09-13T05:16:36Z"}, "message": "Auto merge of #76585 - Aaron1011:ignore-vert-plus, r=petrochenkov\n\nIgnore `|` and `+` tokens during proc-macro pretty-print check\n\nFixes #76182\n\nThis is an alternative to PR #76188\n\nThese tokens are not preserved in the AST in certain cases\n(e.g. a leading `|` in a pattern or a trailing `+` in a trait bound).\n\nThis PR ignores them entirely during the pretty-print/reparse check\nto avoid spuriously using the re-parsed tokenstream.", "tree": {"sha": "df723bb28d00423ba8732523ffb549277f235f83", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/df723bb28d00423ba8732523ffb549277f235f83"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/dd33766e4a9a918058c3447d42491e874e21f7cc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/dd33766e4a9a918058c3447d42491e874e21f7cc", "html_url": "https://github.com/rust-lang/rust/commit/dd33766e4a9a918058c3447d42491e874e21f7cc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/dd33766e4a9a918058c3447d42491e874e21f7cc/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "04b72b469781b811655b0d5eb7d4c3c53fe1241d", "url": "https://api.github.com/repos/rust-lang/rust/commits/04b72b469781b811655b0d5eb7d4c3c53fe1241d", "html_url": "https://github.com/rust-lang/rust/commit/04b72b469781b811655b0d5eb7d4c3c53fe1241d"}, {"sha": "283d4c4d148c8c53a8b197c4ff0a9f79a1690eb2", "url": "https://api.github.com/repos/rust-lang/rust/commits/283d4c4d148c8c53a8b197c4ff0a9f79a1690eb2", "html_url": "https://github.com/rust-lang/rust/commit/283d4c4d148c8c53a8b197c4ff0a9f79a1690eb2"}], "stats": {"total": 155, "additions": 155, "deletions": 0}, "files": [{"sha": "0becdf24c532be6ab438641ba27847f884004688", "filename": "compiler/rustc_parse/src/lib.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/dd33766e4a9a918058c3447d42491e874e21f7cc/compiler%2Frustc_parse%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dd33766e4a9a918058c3447d42491e874e21f7cc/compiler%2Frustc_parse%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse%2Fsrc%2Flib.rs?ref=dd33766e4a9a918058c3447d42491e874e21f7cc", "patch": "@@ -364,6 +364,12 @@ pub fn tokenstream_probably_equal_for_proc_macro(\n                 | token::CloseDelim(DelimToken::NoDelim)\n                 // The pretty printer collapses many semicolons into one.\n                 | token::Semi\n+                // We don't preserve leading `|` tokens in patterns, so\n+                // we ignore them entirely\n+                | token::BinOp(token::BinOpToken::Or)\n+                // We don't preserve trailing '+' tokens in trait bounds,\n+                // so we ignore them entirely\n+                | token::BinOp(token::BinOpToken::Plus)\n                 // The pretty printer can turn `$crate` into `::crate_name`\n                 | token::ModSep = token.kind {\n                 return false;"}, {"sha": "7d31de1d22df2f40db3e769855255c575be21132", "filename": "src/test/ui/proc-macro/issue-76182-leading-vert-pat.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/dd33766e4a9a918058c3447d42491e874e21f7cc/src%2Ftest%2Fui%2Fproc-macro%2Fissue-76182-leading-vert-pat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dd33766e4a9a918058c3447d42491e874e21f7cc/src%2Ftest%2Fui%2Fproc-macro%2Fissue-76182-leading-vert-pat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Fissue-76182-leading-vert-pat.rs?ref=dd33766e4a9a918058c3447d42491e874e21f7cc", "patch": "@@ -0,0 +1,16 @@\n+// check-pass\n+// aux-build:test-macros.rs\n+// compile-flags: -Z span-debug\n+//\n+// Regression test for issue #76182\n+// Tests that we properly handle patterns with a leading vert\n+\n+#![no_std] // Don't load unnecessary hygiene information from std\n+extern crate std;\n+\n+extern crate test_macros;\n+\n+#[test_macros::print_attr]\n+fn main() {\n+    match () { | () => () }\n+}"}, {"sha": "5493f9c7b606bf57e3cffc3e6b8e92ca93f8e343", "filename": "src/test/ui/proc-macro/issue-76182-leading-vert-pat.stdout", "status": "added", "additions": 62, "deletions": 0, "changes": 62, "blob_url": "https://github.com/rust-lang/rust/blob/dd33766e4a9a918058c3447d42491e874e21f7cc/src%2Ftest%2Fui%2Fproc-macro%2Fissue-76182-leading-vert-pat.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/dd33766e4a9a918058c3447d42491e874e21f7cc/src%2Ftest%2Fui%2Fproc-macro%2Fissue-76182-leading-vert-pat.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Fissue-76182-leading-vert-pat.stdout?ref=dd33766e4a9a918058c3447d42491e874e21f7cc", "patch": "@@ -0,0 +1,62 @@\n+PRINT-ATTR INPUT (DISPLAY): fn main() { match() { | () => () } }\n+PRINT-ATTR INPUT (DEBUG): TokenStream [\n+    Ident {\n+        ident: \"fn\",\n+        span: $DIR/issue-76182-leading-vert-pat.rs:14:1: 14:3 (#0),\n+    },\n+    Ident {\n+        ident: \"main\",\n+        span: $DIR/issue-76182-leading-vert-pat.rs:14:4: 14:8 (#0),\n+    },\n+    Group {\n+        delimiter: Parenthesis,\n+        stream: TokenStream [],\n+        span: $DIR/issue-76182-leading-vert-pat.rs:14:8: 14:10 (#0),\n+    },\n+    Group {\n+        delimiter: Brace,\n+        stream: TokenStream [\n+            Ident {\n+                ident: \"match\",\n+                span: $DIR/issue-76182-leading-vert-pat.rs:15:5: 15:10 (#0),\n+            },\n+            Group {\n+                delimiter: Parenthesis,\n+                stream: TokenStream [],\n+                span: $DIR/issue-76182-leading-vert-pat.rs:15:11: 15:13 (#0),\n+            },\n+            Group {\n+                delimiter: Brace,\n+                stream: TokenStream [\n+                    Punct {\n+                        ch: '|',\n+                        spacing: Alone,\n+                        span: $DIR/issue-76182-leading-vert-pat.rs:15:16: 15:17 (#0),\n+                    },\n+                    Group {\n+                        delimiter: Parenthesis,\n+                        stream: TokenStream [],\n+                        span: $DIR/issue-76182-leading-vert-pat.rs:15:18: 15:20 (#0),\n+                    },\n+                    Punct {\n+                        ch: '=',\n+                        spacing: Joint,\n+                        span: $DIR/issue-76182-leading-vert-pat.rs:15:21: 15:23 (#0),\n+                    },\n+                    Punct {\n+                        ch: '>',\n+                        spacing: Alone,\n+                        span: $DIR/issue-76182-leading-vert-pat.rs:15:21: 15:23 (#0),\n+                    },\n+                    Group {\n+                        delimiter: Parenthesis,\n+                        stream: TokenStream [],\n+                        span: $DIR/issue-76182-leading-vert-pat.rs:15:24: 15:26 (#0),\n+                    },\n+                ],\n+                span: $DIR/issue-76182-leading-vert-pat.rs:15:14: 15:28 (#0),\n+            },\n+        ],\n+        span: $DIR/issue-76182-leading-vert-pat.rs:14:11: 16:2 (#0),\n+    },\n+]"}, {"sha": "4f61de47d85459a525934983f99366ddbf4abdb9", "filename": "src/test/ui/proc-macro/trailing-plus.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/dd33766e4a9a918058c3447d42491e874e21f7cc/src%2Ftest%2Fui%2Fproc-macro%2Ftrailing-plus.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dd33766e4a9a918058c3447d42491e874e21f7cc/src%2Ftest%2Fui%2Fproc-macro%2Ftrailing-plus.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Ftrailing-plus.rs?ref=dd33766e4a9a918058c3447d42491e874e21f7cc", "patch": "@@ -0,0 +1,14 @@\n+// check-pass\n+// aux-build:test-macros.rs\n+// compile-flags: -Z span-debug\n+\n+#![no_std] // Don't load unnecessary hygiene information from std\n+extern crate std;\n+\n+extern crate test_macros;\n+\n+#[test_macros::print_attr]\n+fn foo<T>() where T: Copy + {\n+}\n+\n+fn main() {}"}, {"sha": "d60f400af2bb9c06839d35949056310cdf262a81", "filename": "src/test/ui/proc-macro/trailing-plus.stdout", "status": "added", "additions": 57, "deletions": 0, "changes": 57, "blob_url": "https://github.com/rust-lang/rust/blob/dd33766e4a9a918058c3447d42491e874e21f7cc/src%2Ftest%2Fui%2Fproc-macro%2Ftrailing-plus.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/dd33766e4a9a918058c3447d42491e874e21f7cc/src%2Ftest%2Fui%2Fproc-macro%2Ftrailing-plus.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Ftrailing-plus.stdout?ref=dd33766e4a9a918058c3447d42491e874e21f7cc", "patch": "@@ -0,0 +1,57 @@\n+PRINT-ATTR INPUT (DISPLAY): fn foo < T > () where T : Copy + { }\n+PRINT-ATTR INPUT (DEBUG): TokenStream [\n+    Ident {\n+        ident: \"fn\",\n+        span: $DIR/trailing-plus.rs:11:1: 11:3 (#0),\n+    },\n+    Ident {\n+        ident: \"foo\",\n+        span: $DIR/trailing-plus.rs:11:4: 11:7 (#0),\n+    },\n+    Punct {\n+        ch: '<',\n+        spacing: Alone,\n+        span: $DIR/trailing-plus.rs:11:7: 11:8 (#0),\n+    },\n+    Ident {\n+        ident: \"T\",\n+        span: $DIR/trailing-plus.rs:11:8: 11:9 (#0),\n+    },\n+    Punct {\n+        ch: '>',\n+        spacing: Alone,\n+        span: $DIR/trailing-plus.rs:11:9: 11:10 (#0),\n+    },\n+    Group {\n+        delimiter: Parenthesis,\n+        stream: TokenStream [],\n+        span: $DIR/trailing-plus.rs:11:10: 11:12 (#0),\n+    },\n+    Ident {\n+        ident: \"where\",\n+        span: $DIR/trailing-plus.rs:11:13: 11:18 (#0),\n+    },\n+    Ident {\n+        ident: \"T\",\n+        span: $DIR/trailing-plus.rs:11:19: 11:20 (#0),\n+    },\n+    Punct {\n+        ch: ':',\n+        spacing: Alone,\n+        span: $DIR/trailing-plus.rs:11:20: 11:21 (#0),\n+    },\n+    Ident {\n+        ident: \"Copy\",\n+        span: $DIR/trailing-plus.rs:11:22: 11:26 (#0),\n+    },\n+    Punct {\n+        ch: '+',\n+        spacing: Alone,\n+        span: $DIR/trailing-plus.rs:11:27: 11:28 (#0),\n+    },\n+    Group {\n+        delimiter: Brace,\n+        stream: TokenStream [],\n+        span: $DIR/trailing-plus.rs:11:29: 12:2 (#0),\n+    },\n+]"}]}