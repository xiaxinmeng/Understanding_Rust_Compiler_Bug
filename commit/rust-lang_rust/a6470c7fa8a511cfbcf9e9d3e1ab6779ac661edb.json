{"sha": "a6470c7fa8a511cfbcf9e9d3e1ab6779ac661edb", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE2NDcwYzdmYThhNTExY2ZiY2Y5ZTlkM2UxYWI2Nzc5YWM2NjFlZGI=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-07-16T06:44:10Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-07-16T06:44:10Z"}, "message": "Auto merge of #86662 - mockersf:fix-86620-link-unknown-location, r=jyn514\n\nfix dead link for method in trait of blanket impl from third party crate\n\nfix #86620\n\n* changes `href` method to raise the actual error it had instead of an `Option`\n* set the href link correctly in case of an error\n\nI did not manage to make a small reproducer, I think it happens in a situation where\n* crate A expose a trait with a blanket impl\n* crate B use the trait from crate A\n* crate C use types from crate B\n* building docs for crate C without dependencies\n\nr? `@jyn514`", "tree": {"sha": "0e336fb7e40ac0eb14ff61b2962b559408d4b4c4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0e336fb7e40ac0eb14ff61b2962b559408d4b4c4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a6470c7fa8a511cfbcf9e9d3e1ab6779ac661edb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a6470c7fa8a511cfbcf9e9d3e1ab6779ac661edb", "html_url": "https://github.com/rust-lang/rust/commit/a6470c7fa8a511cfbcf9e9d3e1ab6779ac661edb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a6470c7fa8a511cfbcf9e9d3e1ab6779ac661edb/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "057050a95bdfc5849a893208c53c7b2a081c6808", "url": "https://api.github.com/repos/rust-lang/rust/commits/057050a95bdfc5849a893208c53c7b2a081c6808", "html_url": "https://github.com/rust-lang/rust/commit/057050a95bdfc5849a893208c53c7b2a081c6808"}, {"sha": "450c28a45e387fb54bbc84cf88c3556f93bcf1b8", "url": "https://api.github.com/repos/rust-lang/rust/commits/450c28a45e387fb54bbc84cf88c3556f93bcf1b8", "html_url": "https://github.com/rust-lang/rust/commit/450c28a45e387fb54bbc84cf88c3556f93bcf1b8"}], "stats": {"total": 102, "additions": 71, "deletions": 31}, "files": [{"sha": "859746b6a2df77f8cc4e082bd557b4674b0d6203", "filename": "src/librustdoc/clean/types.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a6470c7fa8a511cfbcf9e9d3e1ab6779ac661edb/src%2Flibrustdoc%2Fclean%2Ftypes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a6470c7fa8a511cfbcf9e9d3e1ab6779ac661edb/src%2Flibrustdoc%2Fclean%2Ftypes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Ftypes.rs?ref=a6470c7fa8a511cfbcf9e9d3e1ab6779ac661edb", "patch": "@@ -459,7 +459,7 @@ impl Item {\n             .filter_map(|ItemLink { link: s, link_text, did, ref fragment }| {\n                 match did {\n                     Some(did) => {\n-                        if let Some((mut href, ..)) = href(did.clone(), cx) {\n+                        if let Ok((mut href, ..)) = href(did.clone(), cx) {\n                             if let Some(ref fragment) = *fragment {\n                                 href.push('#');\n                                 href.push_str(fragment);"}, {"sha": "08499cef33ef19cb23564159e605f7408587341c", "filename": "src/librustdoc/html/format.rs", "status": "modified", "additions": 37, "deletions": 22, "changes": 59, "blob_url": "https://github.com/rust-lang/rust/blob/a6470c7fa8a511cfbcf9e9d3e1ab6779ac661edb/src%2Flibrustdoc%2Fhtml%2Fformat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a6470c7fa8a511cfbcf9e9d3e1ab6779ac661edb/src%2Flibrustdoc%2Fhtml%2Fformat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fformat.rs?ref=a6470c7fa8a511cfbcf9e9d3e1ab6779ac661edb", "patch": "@@ -472,15 +472,27 @@ impl clean::GenericArgs {\n     }\n }\n \n-crate fn href(did: DefId, cx: &Context<'_>) -> Option<(String, ItemType, Vec<String>)> {\n+// Possible errors when computing href link source for a `DefId`\n+crate enum HrefError {\n+    /// This item is known to rustdoc, but from a crate that does not have documentation generated.\n+    ///\n+    /// This can only happen for non-local items.\n+    DocumentationNotBuilt,\n+    /// This can only happen for non-local items when `--document-private-items` is not passed.\n+    Private,\n+    // Not in external cache, href link should be in same page\n+    NotInExternalCache,\n+}\n+\n+crate fn href(did: DefId, cx: &Context<'_>) -> Result<(String, ItemType, Vec<String>), HrefError> {\n     let cache = &cx.cache();\n     let relative_to = &cx.current;\n     fn to_module_fqp(shortty: ItemType, fqp: &[String]) -> &[String] {\n         if shortty == ItemType::Module { &fqp[..] } else { &fqp[..fqp.len() - 1] }\n     }\n \n     if !did.is_local() && !cache.access_levels.is_public(did) && !cache.document_private {\n-        return None;\n+        return Err(HrefError::Private);\n     }\n \n     let (fqp, shortty, mut url_parts) = match cache.paths.get(&did) {\n@@ -489,22 +501,25 @@ crate fn href(did: DefId, cx: &Context<'_>) -> Option<(String, ItemType, Vec<Str\n             href_relative_parts(module_fqp, relative_to)\n         }),\n         None => {\n-            let &(ref fqp, shortty) = cache.external_paths.get(&did)?;\n-            let module_fqp = to_module_fqp(shortty, fqp);\n-            (\n-                fqp,\n-                shortty,\n-                match cache.extern_locations[&did.krate] {\n-                    ExternalLocation::Remote(ref s) => {\n-                        let s = s.trim_end_matches('/');\n-                        let mut s = vec![&s[..]];\n-                        s.extend(module_fqp[..].iter().map(String::as_str));\n-                        s\n-                    }\n-                    ExternalLocation::Local => href_relative_parts(module_fqp, relative_to),\n-                    ExternalLocation::Unknown => return None,\n-                },\n-            )\n+            if let Some(&(ref fqp, shortty)) = cache.external_paths.get(&did) {\n+                let module_fqp = to_module_fqp(shortty, fqp);\n+                (\n+                    fqp,\n+                    shortty,\n+                    match cache.extern_locations[&did.krate] {\n+                        ExternalLocation::Remote(ref s) => {\n+                            let s = s.trim_end_matches('/');\n+                            let mut s = vec![&s[..]];\n+                            s.extend(module_fqp[..].iter().map(String::as_str));\n+                            s\n+                        }\n+                        ExternalLocation::Local => href_relative_parts(module_fqp, relative_to),\n+                        ExternalLocation::Unknown => return Err(HrefError::DocumentationNotBuilt),\n+                    },\n+                )\n+            } else {\n+                return Err(HrefError::NotInExternalCache);\n+            }\n         }\n     };\n     let last = &fqp.last().unwrap()[..];\n@@ -518,7 +533,7 @@ crate fn href(did: DefId, cx: &Context<'_>) -> Option<(String, ItemType, Vec<Str\n             url_parts.push(&filename);\n         }\n     }\n-    Some((url_parts.join(\"/\"), shortty, fqp.to_vec()))\n+    Ok((url_parts.join(\"/\"), shortty, fqp.to_vec()))\n }\n \n /// Both paths should only be modules.\n@@ -567,7 +582,7 @@ fn resolved_path<'a, 'cx: 'a>(\n         write!(w, \"{}{:#}\", &last.name, last.args.print(cx))?;\n     } else {\n         let path = if use_absolute {\n-            if let Some((_, _, fqp)) = href(did, cx) {\n+            if let Ok((_, _, fqp)) = href(did, cx) {\n                 format!(\n                     \"{}::{}\",\n                     fqp[..fqp.len() - 1].join(\"::\"),\n@@ -675,7 +690,7 @@ crate fn anchor<'a, 'cx: 'a>(\n ) -> impl fmt::Display + 'a {\n     let parts = href(did.into(), cx);\n     display_fn(move |f| {\n-        if let Some((url, short_ty, fqp)) = parts {\n+        if let Ok((url, short_ty, fqp)) = parts {\n             write!(\n                 f,\n                 r#\"<a class=\"{}\" href=\"{}\" title=\"{} {}\">{}</a>\"#,\n@@ -907,7 +922,7 @@ fn fmt_type<'cx>(\n                 //        look at).\n                 box clean::ResolvedPath { did, .. } => {\n                     match href(did.into(), cx) {\n-                        Some((ref url, _, ref path)) if !f.alternate() => {\n+                        Ok((ref url, _, ref path)) if !f.alternate() => {\n                             write!(\n                                 f,\n                                 \"<a class=\\\"type\\\" href=\\\"{url}#{shortty}.{name}\\\" \\"}, {"sha": "7de023cabeff5f10e83154531228c1e288ffe5c6", "filename": "src/librustdoc/html/render/mod.rs", "status": "modified", "additions": 11, "deletions": 8, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/a6470c7fa8a511cfbcf9e9d3e1ab6779ac661edb/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a6470c7fa8a511cfbcf9e9d3e1ab6779ac661edb/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs?ref=a6470c7fa8a511cfbcf9e9d3e1ab6779ac661edb", "patch": "@@ -62,7 +62,7 @@ use crate::formats::{AssocItemRender, Impl, RenderMode};\n use crate::html::escape::Escape;\n use crate::html::format::{\n     href, print_abi_with_space, print_constness_with_space, print_default_space,\n-    print_generic_bounds, print_where_clause, Buffer, PrintWithSpace,\n+    print_generic_bounds, print_where_clause, Buffer, HrefError, PrintWithSpace,\n };\n use crate::html::markdown::{Markdown, MarkdownHtml, MarkdownSummaryLine};\n \n@@ -856,8 +856,8 @@ fn render_assoc_item(\n     ) {\n         let name = meth.name.as_ref().unwrap();\n         let href = match link {\n-            AssocItemLink::Anchor(Some(ref id)) => format!(\"#{}\", id),\n-            AssocItemLink::Anchor(None) => format!(\"#{}.{}\", meth.type_(), name),\n+            AssocItemLink::Anchor(Some(ref id)) => Some(format!(\"#{}\", id)),\n+            AssocItemLink::Anchor(None) => Some(format!(\"#{}.{}\", meth.type_(), name)),\n             AssocItemLink::GotoSource(did, provided_methods) => {\n                 // We're creating a link from an impl-item to the corresponding\n                 // trait-item and need to map the anchored type accordingly.\n@@ -867,9 +867,11 @@ fn render_assoc_item(\n                     ItemType::TyMethod\n                 };\n \n-                href(did.expect_def_id(), cx)\n-                    .map(|p| format!(\"{}#{}.{}\", p.0, ty, name))\n-                    .unwrap_or_else(|| format!(\"#{}.{}\", ty, name))\n+                match (href(did.expect_def_id(), cx), ty) {\n+                    (Ok(p), ty) => Some(format!(\"{}#{}.{}\", p.0, ty, name)),\n+                    (Err(HrefError::DocumentationNotBuilt), ItemType::TyMethod) => None,\n+                    (Err(_), ty) => Some(format!(\"#{}.{}\", ty, name)),\n+                }\n             }\n         };\n         let vis = meth.visibility.print_with_space(meth.def_id, cx).to_string();\n@@ -904,7 +906,7 @@ fn render_assoc_item(\n         w.reserve(header_len + \"<a href=\\\"\\\" class=\\\"fnname\\\">{\".len() + \"</a>\".len());\n         write!(\n             w,\n-            \"{indent}{vis}{constness}{asyncness}{unsafety}{defaultness}{abi}fn <a href=\\\"{href}\\\" class=\\\"fnname\\\">{name}</a>\\\n+            \"{indent}{vis}{constness}{asyncness}{unsafety}{defaultness}{abi}fn <a {href} class=\\\"fnname\\\">{name}</a>\\\n              {generics}{decl}{notable_traits}{where_clause}\",\n             indent = indent_str,\n             vis = vis,\n@@ -913,7 +915,8 @@ fn render_assoc_item(\n             unsafety = unsafety,\n             defaultness = defaultness,\n             abi = abi,\n-            href = href,\n+            // links without a href are valid - https://www.w3schools.com/tags/att_a_href.asp\n+            href = href.map(|href| format!(\"href=\\\"{}\\\"\", href)).unwrap_or_else(|| \"\".to_string()),\n             name = name,\n             generics = g.print(cx),\n             decl = d.full_print(header_len, indent, header.asyncness, cx),"}, {"sha": "f6debf6fb4e6317a9978cc0d481571f8505e712e", "filename": "src/test/rustdoc/auxiliary/issue-86620-1.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/a6470c7fa8a511cfbcf9e9d3e1ab6779ac661edb/src%2Ftest%2Frustdoc%2Fauxiliary%2Fissue-86620-1.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a6470c7fa8a511cfbcf9e9d3e1ab6779ac661edb/src%2Ftest%2Frustdoc%2Fauxiliary%2Fissue-86620-1.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fauxiliary%2Fissue-86620-1.rs?ref=a6470c7fa8a511cfbcf9e9d3e1ab6779ac661edb", "patch": "@@ -0,0 +1,11 @@\n+#![crate_name = \"issue_86620_1\"]\n+\n+pub trait VZip {\n+    fn vzip() -> usize;\n+}\n+\n+impl<T> VZip for T {\n+    fn vzip() -> usize {\n+        0\n+    }\n+}"}, {"sha": "efa2025b4b9c229d8d199426528597c34c016a88", "filename": "src/test/rustdoc/extern-default-method.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/a6470c7fa8a511cfbcf9e9d3e1ab6779ac661edb/src%2Ftest%2Frustdoc%2Fextern-default-method.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a6470c7fa8a511cfbcf9e9d3e1ab6779ac661edb/src%2Ftest%2Frustdoc%2Fextern-default-method.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fextern-default-method.rs?ref=a6470c7fa8a511cfbcf9e9d3e1ab6779ac661edb", "patch": "@@ -4,4 +4,6 @@\n extern crate rustdoc_extern_default_method as ext;\n \n // @count extern_default_method/struct.Struct.html '//*[@id=\"method.provided\"]' 1\n+// @has extern_default_method/struct.Struct.html '//div[@id=\"method.provided\"]//a[@class=\"fnname\"]/@href' #method.provided\n+// @has extern_default_method/struct.Struct.html '//div[@id=\"method.provided\"]//a[@class=\"anchor\"]/@href' #method.provided\n pub use ext::Struct;"}, {"sha": "b14e266f7f98d78a1edc2c18e446a8d3ee357d7b", "filename": "src/test/rustdoc/issue-86620.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/a6470c7fa8a511cfbcf9e9d3e1ab6779ac661edb/src%2Ftest%2Frustdoc%2Fissue-86620.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a6470c7fa8a511cfbcf9e9d3e1ab6779ac661edb/src%2Ftest%2Frustdoc%2Fissue-86620.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fissue-86620.rs?ref=a6470c7fa8a511cfbcf9e9d3e1ab6779ac661edb", "patch": "@@ -0,0 +1,9 @@\n+// aux-build:issue-86620-1.rs\n+\n+extern crate issue_86620_1;\n+\n+use issue_86620_1::*;\n+\n+// @!has issue_86620/struct.S.html '//div[@id=\"method.vzip\"]//a[@class=\"fnname\"]/@href' #tymethod.vzip\n+// @has issue_86620/struct.S.html '//div[@id=\"method.vzip\"]//a[@class=\"anchor\"]/@href' #method.vzip\n+pub struct S;"}]}