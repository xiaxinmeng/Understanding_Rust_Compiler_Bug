{"sha": "0b969a9d68b29fa53fb0595beb319036210d9e73", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBiOTY5YTlkNjhiMjlmYTUzZmIwNTk1YmViMzE5MDM2MjEwZDllNzM=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2018-07-11T21:25:29Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2018-07-12T21:10:39Z"}, "message": "rustc: Lint against `#[macro_use]` in 2018 idioms\n\nThis commit adds a lint to the compiler to warn against the `#[macro_use]`\ndirective as part of the `rust_2018_idioms` lint. This lint is turned off by\ndefault and is only enabled when the `use_extern_macros` feature is also\nenabled.\n\nThe lint here isn't fully fleshed out as it's just a simple warning rather than\nsuggestions of how to actually import the macro, but hopefully it's a good base\nto start from!\n\ncc #52043", "tree": {"sha": "991a58dd2f2715261bbb5dd701a7ca2b9975bec4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/991a58dd2f2715261bbb5dd701a7ca2b9975bec4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0b969a9d68b29fa53fb0595beb319036210d9e73", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0b969a9d68b29fa53fb0595beb319036210d9e73", "html_url": "https://github.com/rust-lang/rust/commit/0b969a9d68b29fa53fb0595beb319036210d9e73", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0b969a9d68b29fa53fb0595beb319036210d9e73/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6cc42a4488d5dbc4c4109ed4a2f2ea81efa77f86", "url": "https://api.github.com/repos/rust-lang/rust/commits/6cc42a4488d5dbc4c4109ed4a2f2ea81efa77f86", "html_url": "https://github.com/rust-lang/rust/commit/6cc42a4488d5dbc4c4109ed4a2f2ea81efa77f86"}], "stats": {"total": 100, "additions": 99, "deletions": 1}, "files": [{"sha": "a46b31206224732568d9094dacb59c764fe8aff2", "filename": "src/librustc/lint/builtin.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/0b969a9d68b29fa53fb0595beb319036210d9e73/src%2Flibrustc%2Flint%2Fbuiltin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0b969a9d68b29fa53fb0595beb319036210d9e73/src%2Flibrustc%2Flint%2Fbuiltin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Flint%2Fbuiltin.rs?ref=0b969a9d68b29fa53fb0595beb319036210d9e73", "patch": "@@ -322,6 +322,13 @@ declare_lint! {\n     \"detects proc macro derives using inaccessible names from parent modules\"\n }\n \n+declare_lint! {\n+    pub MACRO_USE_EXTERN_CRATE,\n+    Allow,\n+    \"the `#[macro_use]` attribute is now deprecated in favor of using macros \\\n+     via the module system\"\n+}\n+\n /// Does nothing as a lint pass, but registers some `Lint`s\n /// which are used by other parts of the compiler.\n #[derive(Copy, Clone)]\n@@ -379,6 +386,7 @@ impl LintPass for HardwiredLints {\n             INTRA_DOC_LINK_RESOLUTION_FAILURE,\n             WHERE_CLAUSES_OBJECT_SAFETY,\n             PROC_MACRO_DERIVE_RESOLUTION_FALLBACK,\n+            MACRO_USE_EXTERN_CRATE,\n         )\n     }\n }"}, {"sha": "5348a47eed628cd080f8d5dda578d29ba8e0328d", "filename": "src/librustc_lint/lib.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0b969a9d68b29fa53fb0595beb319036210d9e73/src%2Flibrustc_lint%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0b969a9d68b29fa53fb0595beb319036210d9e73/src%2Flibrustc_lint%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_lint%2Flib.rs?ref=0b969a9d68b29fa53fb0595beb319036210d9e73", "patch": "@@ -43,6 +43,7 @@ extern crate syntax_pos;\n use rustc::lint;\n use rustc::lint::{LateContext, LateLintPass, LintPass, LintArray};\n use rustc::lint::builtin::{BARE_TRAIT_OBJECTS, ABSOLUTE_PATHS_NOT_STARTING_WITH_CRATE};\n+use rustc::lint::builtin::MACRO_USE_EXTERN_CRATE;\n use rustc::session;\n use rustc::util;\n use rustc::hir;\n@@ -179,6 +180,7 @@ pub fn register_builtins(store: &mut lint::LintStore, sess: Option<&Session>) {\n                     BARE_TRAIT_OBJECTS,\n                     UNREACHABLE_PUB,\n                     UNUSED_EXTERN_CRATES,\n+                    MACRO_USE_EXTERN_CRATE,\n                     ELLIPSIS_INCLUSIVE_RANGE_PATTERNS);\n \n     // Guidelines for creating a future incompatibility lint:"}, {"sha": "ef24a201e0f5b2fe668307ec7409a7f24e58344d", "filename": "src/librustc_resolve/check_unused.rs", "status": "modified", "additions": 16, "deletions": 1, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/0b969a9d68b29fa53fb0595beb319036210d9e73/src%2Flibrustc_resolve%2Fcheck_unused.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0b969a9d68b29fa53fb0595beb319036210d9e73/src%2Flibrustc_resolve%2Fcheck_unused.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_resolve%2Fcheck_unused.rs?ref=0b969a9d68b29fa53fb0595beb319036210d9e73", "patch": "@@ -129,7 +129,22 @@ pub fn check_crate(resolver: &mut Resolver, krate: &ast::Crate) {\n         match directive.subclass {\n             _ if directive.used.get() ||\n                  directive.vis.get() == ty::Visibility::Public ||\n-                 directive.span.is_dummy() => {}\n+                 directive.span.is_dummy() => {\n+                if let ImportDirectiveSubclass::MacroUse = directive.subclass {\n+                    if resolver.session.features_untracked().use_extern_macros &&\n+                        !directive.span.is_dummy() {\n+                        resolver.session.buffer_lint(\n+                            lint::builtin::MACRO_USE_EXTERN_CRATE,\n+                            directive.id,\n+                            directive.span,\n+                            \"deprecated `#[macro_use]` directive used to \\\n+                             import macros should be replaced at use sites \\\n+                             with a `use` statement to import the macro \\\n+                             instead\",\n+                        );\n+                    }\n+                }\n+            }\n             ImportDirectiveSubclass::ExternCrate(_) => {\n                 resolver.maybe_unused_extern_crates.push((directive.id, directive.span));\n             }"}, {"sha": "9487fd808cdfd4ae711b4dedc352f0bcbcf5a642", "filename": "src/test/ui/rust-2018/auxiliary/macro-use-warned-against.rs", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/0b969a9d68b29fa53fb0595beb319036210d9e73/src%2Ftest%2Fui%2Frust-2018%2Fauxiliary%2Fmacro-use-warned-against.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0b969a9d68b29fa53fb0595beb319036210d9e73/src%2Ftest%2Fui%2Frust-2018%2Fauxiliary%2Fmacro-use-warned-against.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frust-2018%2Fauxiliary%2Fmacro-use-warned-against.rs?ref=0b969a9d68b29fa53fb0595beb319036210d9e73", "patch": "@@ -0,0 +1,12 @@\n+// Copyright 2012-2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#[macro_export]\n+macro_rules! foo { () => () }"}, {"sha": "6391db85dc5134bdf64adad0dd08d3289261add7", "filename": "src/test/ui/rust-2018/auxiliary/macro-use-warned-against2.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/0b969a9d68b29fa53fb0595beb319036210d9e73/src%2Ftest%2Fui%2Frust-2018%2Fauxiliary%2Fmacro-use-warned-against2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0b969a9d68b29fa53fb0595beb319036210d9e73/src%2Ftest%2Fui%2Frust-2018%2Fauxiliary%2Fmacro-use-warned-against2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frust-2018%2Fauxiliary%2Fmacro-use-warned-against2.rs?ref=0b969a9d68b29fa53fb0595beb319036210d9e73", "patch": "@@ -0,0 +1,10 @@\n+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+"}, {"sha": "f7a6b560280800892b5c2c58766f6e03539b1011", "filename": "src/test/ui/rust-2018/macro-use-warned-against.rs", "status": "added", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/0b969a9d68b29fa53fb0595beb319036210d9e73/src%2Ftest%2Fui%2Frust-2018%2Fmacro-use-warned-against.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0b969a9d68b29fa53fb0595beb319036210d9e73/src%2Ftest%2Fui%2Frust-2018%2Fmacro-use-warned-against.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frust-2018%2Fmacro-use-warned-against.rs?ref=0b969a9d68b29fa53fb0595beb319036210d9e73", "patch": "@@ -0,0 +1,25 @@\n+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// aux-build:macro-use-warned-against.rs\n+// aux-build:macro-use-warned-against2.rs\n+// compile-pass\n+\n+#![warn(rust_2018_idioms, unused)]\n+#![feature(use_extern_macros)]\n+\n+#[macro_use] //~ WARN should be replaced at use sites with a `use` statement\n+extern crate macro_use_warned_against;\n+#[macro_use] //~ WARN unused `#[macro_use]`\n+extern crate macro_use_warned_against2;\n+\n+fn main() {\n+    foo!();\n+}"}, {"sha": "bebad31510f566e5849104bef3e73fc84cc9e092", "filename": "src/test/ui/rust-2018/macro-use-warned-against.stderr", "status": "added", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/0b969a9d68b29fa53fb0595beb319036210d9e73/src%2Ftest%2Fui%2Frust-2018%2Fmacro-use-warned-against.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/0b969a9d68b29fa53fb0595beb319036210d9e73/src%2Ftest%2Fui%2Frust-2018%2Fmacro-use-warned-against.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Frust-2018%2Fmacro-use-warned-against.stderr?ref=0b969a9d68b29fa53fb0595beb319036210d9e73", "patch": "@@ -0,0 +1,26 @@\n+warning: deprecated `#[macro_use]` directive used to import macros should be replaced at use sites with a `use` statement to import the macro instead\n+  --> $DIR/macro-use-warned-against.rs:18:1\n+   |\n+LL | #[macro_use] //~ WARN should be replaced at use sites with a `use` statement\n+   | ^^^^^^^^^^^^\n+   |\n+note: lint level defined here\n+  --> $DIR/macro-use-warned-against.rs:15:9\n+   |\n+LL | #![warn(rust_2018_idioms, unused)]\n+   |         ^^^^^^^^^^^^^^^^\n+   = note: #[warn(macro_use_extern_crate)] implied by #[warn(rust_2018_idioms)]\n+\n+warning: unused `#[macro_use]` import\n+  --> $DIR/macro-use-warned-against.rs:20:1\n+   |\n+LL | #[macro_use] //~ WARN unused `#[macro_use]`\n+   | ^^^^^^^^^^^^\n+   |\n+note: lint level defined here\n+  --> $DIR/macro-use-warned-against.rs:15:27\n+   |\n+LL | #![warn(rust_2018_idioms, unused)]\n+   |                           ^^^^^^\n+   = note: #[warn(unused_imports)] implied by #[warn(unused)]\n+"}]}