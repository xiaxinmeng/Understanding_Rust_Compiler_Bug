{"sha": "8c2413c4c609127db344044d6740c9de03aa7ce2", "node_id": "C_kwDOAAsO6NoAKDhjMjQxM2M0YzYwOTEyN2RiMzQ0MDQ0ZDY3NDBjOWRlMDNhYTdjZTI", "commit": {"author": {"name": "Peter Medus", "email": "16763503+Facel3ss1@users.noreply.github.com", "date": "2022-08-19T17:29:33Z"}, "committer": {"name": "Peter Medus", "email": "16763503+Facel3ss1@users.noreply.github.com", "date": "2022-08-22T15:35:05Z"}, "message": "Migrate rustc_plugin_impl to SessionDiagnostic", "tree": {"sha": "dd65219d3d2e2cc5e20699052da2fdc3cf87120a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/dd65219d3d2e2cc5e20699052da2fdc3cf87120a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8c2413c4c609127db344044d6740c9de03aa7ce2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8c2413c4c609127db344044d6740c9de03aa7ce2", "html_url": "https://github.com/rust-lang/rust/commit/8c2413c4c609127db344044d6740c9de03aa7ce2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8c2413c4c609127db344044d6740c9de03aa7ce2/comments", "author": {"login": "Facel3ss1", "id": 16763503, "node_id": "MDQ6VXNlcjE2NzYzNTAz", "avatar_url": "https://avatars.githubusercontent.com/u/16763503?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Facel3ss1", "html_url": "https://github.com/Facel3ss1", "followers_url": "https://api.github.com/users/Facel3ss1/followers", "following_url": "https://api.github.com/users/Facel3ss1/following{/other_user}", "gists_url": "https://api.github.com/users/Facel3ss1/gists{/gist_id}", "starred_url": "https://api.github.com/users/Facel3ss1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Facel3ss1/subscriptions", "organizations_url": "https://api.github.com/users/Facel3ss1/orgs", "repos_url": "https://api.github.com/users/Facel3ss1/repos", "events_url": "https://api.github.com/users/Facel3ss1/events{/privacy}", "received_events_url": "https://api.github.com/users/Facel3ss1/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Facel3ss1", "id": 16763503, "node_id": "MDQ6VXNlcjE2NzYzNTAz", "avatar_url": "https://avatars.githubusercontent.com/u/16763503?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Facel3ss1", "html_url": "https://github.com/Facel3ss1", "followers_url": "https://api.github.com/users/Facel3ss1/followers", "following_url": "https://api.github.com/users/Facel3ss1/following{/other_user}", "gists_url": "https://api.github.com/users/Facel3ss1/gists{/gist_id}", "starred_url": "https://api.github.com/users/Facel3ss1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Facel3ss1/subscriptions", "organizations_url": "https://api.github.com/users/Facel3ss1/orgs", "repos_url": "https://api.github.com/users/Facel3ss1/repos", "events_url": "https://api.github.com/users/Facel3ss1/events{/privacy}", "received_events_url": "https://api.github.com/users/Facel3ss1/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a8a33cf27166d3eabaffc58ed3799e054af3b0c6", "url": "https://api.github.com/repos/rust-lang/rust/commits/a8a33cf27166d3eabaffc58ed3799e054af3b0c6", "html_url": "https://github.com/rust-lang/rust/commit/a8a33cf27166d3eabaffc58ed3799e054af3b0c6"}], "stats": {"total": 46, "additions": 35, "deletions": 11}, "files": [{"sha": "a2037bb799a4c4593e63ddd4a6e41196dcf18b7b", "filename": "Cargo.lock", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/8c2413c4c609127db344044d6740c9de03aa7ce2/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/8c2413c4c609127db344044d6740c9de03aa7ce2/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=8c2413c4c609127db344044d6740c9de03aa7ce2", "patch": "@@ -4321,6 +4321,7 @@ dependencies = [\n  \"rustc_ast\",\n  \"rustc_errors\",\n  \"rustc_lint\",\n+ \"rustc_macros\",\n  \"rustc_metadata\",\n  \"rustc_session\",\n  \"rustc_span\","}, {"sha": "8db32a42c1deac0c1a01520c4e0cfe607c85b028", "filename": "compiler/rustc_error_messages/locales/en-US/plugin_impl.ftl", "status": "added", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/8c2413c4c609127db344044d6740c9de03aa7ce2/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fplugin_impl.ftl", "raw_url": "https://github.com/rust-lang/rust/raw/8c2413c4c609127db344044d6740c9de03aa7ce2/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fplugin_impl.ftl", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_error_messages%2Flocales%2Fen-US%2Fplugin_impl.ftl?ref=8c2413c4c609127db344044d6740c9de03aa7ce2", "patch": "@@ -0,0 +1,4 @@\n+plugin_impl_load_plugin_error = {$msg}\n+\n+plugin_impl_malformed_plugin_attribute = malformed `plugin` attribute\n+    .label = malformed attribute"}, {"sha": "3e66d12bb37ecdd0c0f8b28526bc622251fe2e20", "filename": "compiler/rustc_error_messages/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/8c2413c4c609127db344044d6740c9de03aa7ce2/compiler%2Frustc_error_messages%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8c2413c4c609127db344044d6740c9de03aa7ce2/compiler%2Frustc_error_messages%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_error_messages%2Fsrc%2Flib.rs?ref=8c2413c4c609127db344044d6740c9de03aa7ce2", "patch": "@@ -41,6 +41,7 @@ fluent_messages! {\n     lint => \"../locales/en-US/lint.ftl\",\n     parser => \"../locales/en-US/parser.ftl\",\n     passes => \"../locales/en-US/passes.ftl\",\n+    plugin_impl => \"../locales/en-US/plugin_impl.ftl\",\n     privacy => \"../locales/en-US/privacy.ftl\",\n     typeck => \"../locales/en-US/typeck.ftl\",\n }"}, {"sha": "c409b6c3e5440716e5512b3c8acb9d24071932d2", "filename": "compiler/rustc_plugin_impl/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/8c2413c4c609127db344044d6740c9de03aa7ce2/compiler%2Frustc_plugin_impl%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/8c2413c4c609127db344044d6740c9de03aa7ce2/compiler%2Frustc_plugin_impl%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_plugin_impl%2FCargo.toml?ref=8c2413c4c609127db344044d6740c9de03aa7ce2", "patch": "@@ -11,6 +11,7 @@ doctest = false\n libloading = \"0.7.1\"\n rustc_errors = { path = \"../rustc_errors\" }\n rustc_lint = { path = \"../rustc_lint\" }\n+rustc_macros = { path = \"../rustc_macros\" }\n rustc_metadata = { path = \"../rustc_metadata\" }\n rustc_ast = { path = \"../rustc_ast\" }\n rustc_session = { path = \"../rustc_session\" }"}, {"sha": "2bdb6e4feca9dbb356c7fb36536542be34f81419", "filename": "compiler/rustc_plugin_impl/src/errors.rs", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/8c2413c4c609127db344044d6740c9de03aa7ce2/compiler%2Frustc_plugin_impl%2Fsrc%2Ferrors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8c2413c4c609127db344044d6740c9de03aa7ce2/compiler%2Frustc_plugin_impl%2Fsrc%2Ferrors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_plugin_impl%2Fsrc%2Ferrors.rs?ref=8c2413c4c609127db344044d6740c9de03aa7ce2", "patch": "@@ -0,0 +1,20 @@\n+//! Errors emitted by plugin_impl\n+\n+use rustc_macros::SessionDiagnostic;\n+use rustc_span::Span;\n+\n+#[derive(SessionDiagnostic)]\n+#[diag(plugin_impl::load_plugin_error)]\n+pub struct LoadPluginError {\n+    #[primary_span]\n+    pub span: Span,\n+    pub msg: String,\n+}\n+\n+#[derive(SessionDiagnostic)]\n+#[diag(plugin_impl::malformed_plugin_attribute, code = \"E0498\")]\n+pub struct MalformedPluginAttribute {\n+    #[primary_span]\n+    #[label]\n+    pub span: Span,\n+}"}, {"sha": "9ac27c65da82e3f504ad78e495ef79a6665ef191", "filename": "compiler/rustc_plugin_impl/src/lib.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/8c2413c4c609127db344044d6740c9de03aa7ce2/compiler%2Frustc_plugin_impl%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8c2413c4c609127db344044d6740c9de03aa7ce2/compiler%2Frustc_plugin_impl%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_plugin_impl%2Fsrc%2Flib.rs?ref=8c2413c4c609127db344044d6740c9de03aa7ce2", "patch": "@@ -8,9 +8,12 @@\n \n #![doc(html_root_url = \"https://doc.rust-lang.org/nightly/nightly-rustc/\")]\n #![recursion_limit = \"256\"]\n+#![deny(rustc::untranslatable_diagnostic)]\n+#![deny(rustc::diagnostic_outside_of_impl)]\n \n use rustc_lint::LintStore;\n \n+mod errors;\n pub mod load;\n \n /// Structure used to register plugins."}, {"sha": "8e75e969ae032064d832dfb6eda2164c3078c752", "filename": "compiler/rustc_plugin_impl/src/load.rs", "status": "modified", "additions": 5, "deletions": 11, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/8c2413c4c609127db344044d6740c9de03aa7ce2/compiler%2Frustc_plugin_impl%2Fsrc%2Fload.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8c2413c4c609127db344044d6740c9de03aa7ce2/compiler%2Frustc_plugin_impl%2Fsrc%2Fload.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_plugin_impl%2Fsrc%2Fload.rs?ref=8c2413c4c609127db344044d6740c9de03aa7ce2", "patch": "@@ -1,29 +1,21 @@\n //! Used by `rustc` when loading a plugin.\n \n+use crate::errors::{LoadPluginError, MalformedPluginAttribute};\n use crate::Registry;\n use libloading::Library;\n use rustc_ast::Crate;\n-use rustc_errors::struct_span_err;\n use rustc_metadata::locator;\n use rustc_session::cstore::MetadataLoader;\n use rustc_session::Session;\n use rustc_span::symbol::{sym, Ident};\n-use rustc_span::Span;\n \n-use std::borrow::ToOwned;\n use std::env;\n use std::mem;\n use std::path::PathBuf;\n \n /// Pointer to a registrar function.\n type PluginRegistrarFn = fn(&mut Registry<'_>);\n \n-fn call_malformed_plugin_attribute(sess: &Session, span: Span) {\n-    struct_span_err!(sess, span, E0498, \"malformed `plugin` attribute\")\n-        .span_label(span, \"malformed attribute\")\n-        .emit();\n-}\n-\n /// Read plugin metadata and dynamically load registrar functions.\n pub fn load_plugins(\n     sess: &Session,\n@@ -42,7 +34,9 @@ pub fn load_plugins(\n                 Some(ident) if plugin.is_word() => {\n                     load_plugin(&mut plugins, sess, metadata_loader, ident)\n                 }\n-                _ => call_malformed_plugin_attribute(sess, plugin.span()),\n+                _ => {\n+                    sess.emit_err(MalformedPluginAttribute { span: plugin.span() });\n+                }\n             }\n         }\n     }\n@@ -60,7 +54,7 @@ fn load_plugin(\n     let fun = dylink_registrar(lib).unwrap_or_else(|err| {\n         // This is fatal: there are almost certainly macros we need inside this crate, so\n         // continuing would spew \"macro undefined\" errors.\n-        sess.span_fatal(ident.span, &err.to_string());\n+        sess.emit_fatal(LoadPluginError { span: ident.span, msg: err.to_string() });\n     });\n     plugins.push(fun);\n }"}]}