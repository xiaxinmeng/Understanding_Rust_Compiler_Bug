{"sha": "438826fd1a9a119d00992ede948cdd479431ecbb", "node_id": "C_kwDOAAsO6NoAKDQzODgyNmZkMWE5YTExOWQwMDk5MmVkZTk0OGNkZDQ3OTQzMWVjYmI", "commit": {"author": {"name": "cynecx", "email": "me@cynecx.net", "date": "2022-02-08T22:51:17Z"}, "committer": {"name": "cynecx", "email": "me@cynecx.net", "date": "2022-02-08T22:51:17Z"}, "message": "add more tests and make used(linker/compiler) mutually exclusive", "tree": {"sha": "c7477627b59fff475ee3641e012f52d845daea82", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c7477627b59fff475ee3641e012f52d845daea82"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/438826fd1a9a119d00992ede948cdd479431ecbb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/438826fd1a9a119d00992ede948cdd479431ecbb", "html_url": "https://github.com/rust-lang/rust/commit/438826fd1a9a119d00992ede948cdd479431ecbb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/438826fd1a9a119d00992ede948cdd479431ecbb/comments", "author": {"login": "cynecx", "id": 5961244, "node_id": "MDQ6VXNlcjU5NjEyNDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/5961244?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cynecx", "html_url": "https://github.com/cynecx", "followers_url": "https://api.github.com/users/cynecx/followers", "following_url": "https://api.github.com/users/cynecx/following{/other_user}", "gists_url": "https://api.github.com/users/cynecx/gists{/gist_id}", "starred_url": "https://api.github.com/users/cynecx/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cynecx/subscriptions", "organizations_url": "https://api.github.com/users/cynecx/orgs", "repos_url": "https://api.github.com/users/cynecx/repos", "events_url": "https://api.github.com/users/cynecx/events{/privacy}", "received_events_url": "https://api.github.com/users/cynecx/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cynecx", "id": 5961244, "node_id": "MDQ6VXNlcjU5NjEyNDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/5961244?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cynecx", "html_url": "https://github.com/cynecx", "followers_url": "https://api.github.com/users/cynecx/followers", "following_url": "https://api.github.com/users/cynecx/following{/other_user}", "gists_url": "https://api.github.com/users/cynecx/gists{/gist_id}", "starred_url": "https://api.github.com/users/cynecx/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cynecx/subscriptions", "organizations_url": "https://api.github.com/users/cynecx/orgs", "repos_url": "https://api.github.com/users/cynecx/repos", "events_url": "https://api.github.com/users/cynecx/events{/privacy}", "received_events_url": "https://api.github.com/users/cynecx/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e075586d4fd428374a788eecc391e23ec4a17b46", "url": "https://api.github.com/repos/rust-lang/rust/commits/e075586d4fd428374a788eecc391e23ec4a17b46", "html_url": "https://github.com/rust-lang/rust/commit/e075586d4fd428374a788eecc391e23ec4a17b46"}], "stats": {"total": 92, "additions": 88, "deletions": 4}, "files": [{"sha": "479a08e43c01a78b64110a0785280942195bc311", "filename": "compiler/rustc_passes/src/check_attr.rs", "status": "modified", "additions": 34, "deletions": 0, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/438826fd1a9a119d00992ede948cdd479431ecbb/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/438826fd1a9a119d00992ede948cdd479431ecbb/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs?ref=438826fd1a9a119d00992ede948cdd479431ecbb", "patch": "@@ -1741,12 +1741,46 @@ impl CheckAttrVisitor<'_> {\n     }\n \n     fn check_used(&self, attrs: &[Attribute], target: Target) {\n+        let mut used_linker_span = None;\n+        let mut used_compiler_span = None;\n         for attr in attrs {\n             if attr.has_name(sym::used) && target != Target::Static {\n                 self.tcx\n                     .sess\n                     .span_err(attr.span, \"attribute must be applied to a `static` variable\");\n             }\n+            let inner = attr.meta_item_list();\n+            match inner.as_deref() {\n+                Some([item]) if item.has_name(sym::linker) => {\n+                    if used_linker_span.is_none() {\n+                        used_linker_span = Some(attr.span);\n+                    }\n+                }\n+                Some([item]) if item.has_name(sym::compiler) => {\n+                    if used_compiler_span.is_none() {\n+                        used_compiler_span = Some(attr.span);\n+                    }\n+                }\n+                Some(_) => {\n+                    // This error case is handled in rustc_typeck::collect.\n+                }\n+                None => {\n+                    // Default case (compiler) when arg isn't defined.\n+                    if used_compiler_span.is_none() {\n+                        used_compiler_span = Some(attr.span);\n+                    }\n+                }\n+            }\n+        }\n+        if let (Some(linker_span), Some(compiler_span)) = (used_linker_span, used_compiler_span) {\n+            let spans = vec![linker_span, compiler_span];\n+            self.tcx\n+                .sess\n+                .struct_span_err(\n+                    spans,\n+                    \"`used(compiler)` and `used(linker)` can't be used together\",\n+                )\n+                .emit();\n         }\n     }\n "}, {"sha": "2a280ff97e96dc047bd6ed7b05aca094ae736b1a", "filename": "compiler/rustc_typeck/src/collect.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/438826fd1a9a119d00992ede948cdd479431ecbb/compiler%2Frustc_typeck%2Fsrc%2Fcollect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/438826fd1a9a119d00992ede948cdd479431ecbb/compiler%2Frustc_typeck%2Fsrc%2Fcollect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcollect.rs?ref=438826fd1a9a119d00992ede948cdd479431ecbb", "patch": "@@ -1,3 +1,4 @@\n+// ignore-tidy-filelength\n //! \"Collection\" is the process of determining the type and other external\n //! details of each item in Rust. Collection is specifically concerned\n //! with *inter-procedural* things -- for example, for a function"}, {"sha": "5bff50a40d4e8e813f2edf40ae4fd713a4da8aa1", "filename": "src/test/codegen/used_with_arg.rs", "status": "modified", "additions": 2, "deletions": 4, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/438826fd1a9a119d00992ede948cdd479431ecbb/src%2Ftest%2Fcodegen%2Fused_with_arg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/438826fd1a9a119d00992ede948cdd479431ecbb/src%2Ftest%2Fcodegen%2Fused_with_arg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fused_with_arg.rs?ref=438826fd1a9a119d00992ede948cdd479431ecbb", "patch": "@@ -1,12 +1,10 @@\n-// compile-flags: -O\n-\n #![crate_type = \"lib\"]\n #![feature(used_with_arg)]\n \n-// CHECK: @llvm.used = appending global [1 x i8*]\n+// CHECK: @llvm.used = appending global [1 x i8*]{{.*}}USED_LINKER\n #[used(linker)]\n static mut USED_LINKER: [usize; 1] = [0];\n \n-// CHECK-NEXT: @llvm.compiler.used = appending global [1 x i8*]\n+// CHECK-NEXT: @llvm.compiler.used = appending global [1 x i8*]{{.*}}USED_COMPILER\n #[used(compiler)]\n static mut USED_COMPILER: [usize; 1] = [0];"}, {"sha": "ad80ff53f0ef0766dea85ebf3cd7ac6c4ee44232", "filename": "src/test/ui/used_with_arg.rs", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/438826fd1a9a119d00992ede948cdd479431ecbb/src%2Ftest%2Fui%2Fused_with_arg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/438826fd1a9a119d00992ede948cdd479431ecbb/src%2Ftest%2Fui%2Fused_with_arg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fused_with_arg.rs?ref=438826fd1a9a119d00992ede948cdd479431ecbb", "patch": "@@ -0,0 +1,19 @@\n+#![feature(used_with_arg)]\n+\n+#[used(linker)]\n+static mut USED_LINKER: [usize; 1] = [0];\n+\n+#[used(compiler)]\n+static mut USED_COMPILER: [usize; 1] = [0];\n+\n+#[used(compiler)] //~ ERROR `used(compiler)` and `used(linker)` can't be used together\n+#[used(linker)]\n+static mut USED_COMPILER_LINKER2: [usize; 1] = [0];\n+\n+#[used(compiler)] //~ ERROR `used(compiler)` and `used(linker)` can't be used together\n+#[used(linker)]\n+#[used(compiler)]\n+#[used(linker)]\n+static mut USED_COMPILER_LINKER3: [usize; 1] = [0];\n+\n+fn main() {}"}, {"sha": "440e5c4a5a020ed97b722cf40d572e0dedc5109e", "filename": "src/test/ui/used_with_arg.stderr", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/438826fd1a9a119d00992ede948cdd479431ecbb/src%2Ftest%2Fui%2Fused_with_arg.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/438826fd1a9a119d00992ede948cdd479431ecbb/src%2Ftest%2Fui%2Fused_with_arg.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fused_with_arg.stderr?ref=438826fd1a9a119d00992ede948cdd479431ecbb", "patch": "@@ -0,0 +1,18 @@\n+error: `used(compiler)` and `used(linker)` can't be used together\n+  --> $DIR/used_with_arg.rs:9:1\n+   |\n+LL | #[used(compiler)]\n+   | ^^^^^^^^^^^^^^^^^\n+LL | #[used(linker)]\n+   | ^^^^^^^^^^^^^^^\n+\n+error: `used(compiler)` and `used(linker)` can't be used together\n+  --> $DIR/used_with_arg.rs:13:1\n+   |\n+LL | #[used(compiler)]\n+   | ^^^^^^^^^^^^^^^^^\n+LL | #[used(linker)]\n+   | ^^^^^^^^^^^^^^^\n+\n+error: aborting due to 2 previous errors\n+"}, {"sha": "2e17fcfd7a4933cbcb31cfaf6dcea30f19f425b8", "filename": "src/test/ui/used_with_multi_args.rs", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/438826fd1a9a119d00992ede948cdd479431ecbb/src%2Ftest%2Fui%2Fused_with_multi_args.rs", "raw_url": "https://github.com/rust-lang/rust/raw/438826fd1a9a119d00992ede948cdd479431ecbb/src%2Ftest%2Fui%2Fused_with_multi_args.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fused_with_multi_args.rs?ref=438826fd1a9a119d00992ede948cdd479431ecbb", "patch": "@@ -0,0 +1,6 @@\n+#![feature(used_with_arg)]\n+\n+#[used(compiler, linker)] //~ expected `used`, `used(compiler)` or `used(linker)`\n+static mut USED_COMPILER_LINKER: [usize; 1] = [0];\n+\n+fn main() {}"}, {"sha": "c93aafcfc7cce0f7323dfea20b37559ef921314b", "filename": "src/test/ui/used_with_multi_args.stderr", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/438826fd1a9a119d00992ede948cdd479431ecbb/src%2Ftest%2Fui%2Fused_with_multi_args.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/438826fd1a9a119d00992ede948cdd479431ecbb/src%2Ftest%2Fui%2Fused_with_multi_args.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fused_with_multi_args.stderr?ref=438826fd1a9a119d00992ede948cdd479431ecbb", "patch": "@@ -0,0 +1,8 @@\n+error: expected `used`, `used(compiler)` or `used(linker)`\n+  --> $DIR/used_with_multi_args.rs:3:1\n+   |\n+LL | #[used(compiler, linker)]\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: aborting due to previous error\n+"}]}