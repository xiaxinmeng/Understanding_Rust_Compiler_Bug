{"sha": "80061ecb1d11afd7c450673676e7708f85b73f12", "node_id": "MDY6Q29tbWl0NzI0NzEyOjgwMDYxZWNiMWQxMWFmZDdjNDUwNjczNjc2ZTc3MDhmODViNzNmMTI=", "commit": {"author": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2013-05-08T06:01:02Z"}, "committer": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2013-05-08T06:01:05Z"}, "message": "rt: Remove rust_call_nullary_fn\n\nThere's no need to delegate to C to call the Rust main function.", "tree": {"sha": "06baea351f5d1f1b8818dcb8ca6c2b1c6c4a2f4d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/06baea351f5d1f1b8818dcb8ca6c2b1c6c4a2f4d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/80061ecb1d11afd7c450673676e7708f85b73f12", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/80061ecb1d11afd7c450673676e7708f85b73f12", "html_url": "https://github.com/rust-lang/rust/commit/80061ecb1d11afd7c450673676e7708f85b73f12", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/80061ecb1d11afd7c450673676e7708f85b73f12/comments", "author": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3c4b32cdbe7304e6bd033ff6bb4b23a1f18e8af0", "url": "https://api.github.com/repos/rust-lang/rust/commits/3c4b32cdbe7304e6bd033ff6bb4b23a1f18e8af0", "html_url": "https://github.com/rust-lang/rust/commit/3c4b32cdbe7304e6bd033ff6bb4b23a1f18e8af0"}], "stats": {"total": 33, "additions": 19, "deletions": 14}, "files": [{"sha": "25f6c870654a63ea31be4f4aa7a29bf9c21b9847", "filename": "src/libcore/rt/mod.rs", "status": "modified", "additions": 19, "deletions": 6, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/80061ecb1d11afd7c450673676e7708f85b73f12/src%2Flibcore%2Frt%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80061ecb1d11afd7c450673676e7708f85b73f12/src%2Flibcore%2Frt%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Frt%2Fmod.rs?ref=80061ecb1d11afd7c450673676e7708f85b73f12", "patch": "@@ -38,22 +38,35 @@ mod local_heap;\n pub mod test;\n \n pub fn start(main: *u8, _argc: int, _argv: **c_char, _crate_map: *u8) -> int {\n+\n     use self::sched::{Scheduler, Task};\n     use self::uvio::UvEventLoop;\n+    use sys::Closure;\n+    use ptr;\n+    use cast;\n \n     let loop_ = ~UvEventLoop::new();\n     let mut sched = ~Scheduler::new(loop_);\n+\n     let main_task = ~do Task::new(&mut sched.stack_pool) {\n-        // XXX: Can't call a C function pointer from Rust yet\n-        unsafe { rust_call_nullary_fn(main) };\n+\n+        unsafe {\n+            // `main` is an `fn() -> ()` that doesn't take an environment\n+            // XXX: Could also call this as an `extern \"Rust\" fn` once they work\n+            let main = Closure {\n+                code: main as *(),\n+                env: ptr::null(),\n+            };\n+            let mainfn: &fn() = cast::transmute(main);\n+\n+            mainfn();\n+        }\n     };\n+\n     sched.task_queue.push_back(main_task);\n     sched.run();\n-    return 0;\n \n-    extern {\n-        fn rust_call_nullary_fn(f: *u8);\n-    }\n+    return 0;\n }\n \n /// Possible contexts in which Rust code may be executing."}, {"sha": "24666b95f0d3c6f811022da27708496d94c235c7", "filename": "src/rt/rust_builtin.cpp", "status": "modified", "additions": 0, "deletions": 7, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/80061ecb1d11afd7c450673676e7708f85b73f12/src%2Frt%2Frust_builtin.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/80061ecb1d11afd7c450673676e7708f85b73f12/src%2Frt%2Frust_builtin.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_builtin.cpp?ref=80061ecb1d11afd7c450673676e7708f85b73f12", "patch": "@@ -830,13 +830,6 @@ rust_get_rt_env() {\n     return task->kernel->env;\n }\n \n-typedef void *(*nullary_fn)();\n-\n-extern \"C\" CDECL void\n-rust_call_nullary_fn(nullary_fn f) {\n-    f();\n-}\n-\n #ifndef _WIN32\n pthread_key_t sched_key;\n #else"}, {"sha": "6be41251f1bd986ecb6879d8a090abaa6b209bc8", "filename": "src/rt/rustrt.def.in", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/80061ecb1d11afd7c450673676e7708f85b73f12/src%2Frt%2Frustrt.def.in", "raw_url": "https://github.com/rust-lang/rust/raw/80061ecb1d11afd7c450673676e7708f85b73f12/src%2Frt%2Frustrt.def.in", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frustrt.def.in?ref=80061ecb1d11afd7c450673676e7708f85b73f12", "patch": "@@ -222,7 +222,6 @@ rust_uv_ip4_addrp\n rust_uv_ip6_addrp\n rust_uv_free_ip4_addr\n rust_uv_free_ip6_addr\n-rust_call_nullary_fn\n rust_initialize_global_state\n rust_dbg_next_port\n rust_new_memory_region"}]}