{"sha": "d326a4b4c9176193ff0ac445ec14ac50bd081f04", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQzMjZhNGI0YzkxNzYxOTNmZjBhYzQ0NWVjMTRhYzUwYmQwODFmMDQ=", "commit": {"author": {"name": "Joshua Nelson", "email": "jyn514@gmail.com", "date": "2021-04-22T19:23:30Z"}, "committer": {"name": "Joshua Nelson", "email": "jyn514@gmail.com", "date": "2021-04-25T16:45:31Z"}, "message": "Give a better error when std or core are missing\n\n- Suggest using `rustup target add` if `RUSTUP_HOME` is set. I don't know if there's any precedent for doing this, but it seems harmless enough and it will be a big help.\n- Add a note about `#![no_std]` if `std` is missing but not core\n- On nightly, suggest using `cargo build -Z build-std` if `CARGO` is set\n- Add a note that std may be unsupported if `std` is missing but not core\n- Don't suggest `#![no_std]` when the load isn't injected by the\n  compiler", "tree": {"sha": "eec1661c411b0c095a42875afe9e45be65d7ceac", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/eec1661c411b0c095a42875afe9e45be65d7ceac"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d326a4b4c9176193ff0ac445ec14ac50bd081f04", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d326a4b4c9176193ff0ac445ec14ac50bd081f04", "html_url": "https://github.com/rust-lang/rust/commit/d326a4b4c9176193ff0ac445ec14ac50bd081f04", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d326a4b4c9176193ff0ac445ec14ac50bd081f04/comments", "author": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7e11f3a8f3c1b2683125e7def0acb68a6d684f92", "url": "https://api.github.com/repos/rust-lang/rust/commits/7e11f3a8f3c1b2683125e7def0acb68a6d684f92", "html_url": "https://github.com/rust-lang/rust/commit/7e11f3a8f3c1b2683125e7def0acb68a6d684f92"}], "stats": {"total": 68, "additions": 63, "deletions": 5}, "files": [{"sha": "e9ae22f8cedbc47926fd0ed4aa39e9ae0469fa10", "filename": "compiler/rustc_metadata/src/creader.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/d326a4b4c9176193ff0ac445ec14ac50bd081f04/compiler%2Frustc_metadata%2Fsrc%2Fcreader.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d326a4b4c9176193ff0ac445ec14ac50bd081f04/compiler%2Frustc_metadata%2Fsrc%2Fcreader.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_metadata%2Fsrc%2Fcreader.rs?ref=d326a4b4c9176193ff0ac445ec14ac50bd081f04", "patch": "@@ -511,8 +511,11 @@ impl<'a> CrateLoader<'a> {\n         if dep.is_none() {\n             self.used_extern_options.insert(name);\n         }\n-        self.maybe_resolve_crate(name, dep_kind, dep)\n-            .unwrap_or_else(|err| err.report(self.sess, span))\n+        self.maybe_resolve_crate(name, dep_kind, dep).unwrap_or_else(|err| {\n+            let missing_core =\n+                self.maybe_resolve_crate(sym::core, CrateDepKind::Explicit, None).is_err();\n+            err.report(&self.sess, span, missing_core)\n+        })\n     }\n \n     fn maybe_resolve_crate<'b>("}, {"sha": "6e7360950908e9dbd164ff0c7f7ecfebb93f4b91", "filename": "compiler/rustc_metadata/src/locator.rs", "status": "modified", "additions": 34, "deletions": 3, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/d326a4b4c9176193ff0ac445ec14ac50bd081f04/compiler%2Frustc_metadata%2Fsrc%2Flocator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d326a4b4c9176193ff0ac445ec14ac50bd081f04/compiler%2Frustc_metadata%2Fsrc%2Flocator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_metadata%2Fsrc%2Flocator.rs?ref=d326a4b4c9176193ff0ac445ec14ac50bd081f04", "patch": "@@ -790,7 +790,8 @@ pub fn find_plugin_registrar(\n ) -> (PathBuf, CrateDisambiguator) {\n     match find_plugin_registrar_impl(sess, metadata_loader, name) {\n         Ok(res) => res,\n-        Err(err) => err.report(sess, span),\n+        // `core` is always available if we got as far as loading plugins.\n+        Err(err) => err.report(sess, span, false),\n     }\n }\n \n@@ -883,7 +884,7 @@ crate enum CrateError {\n }\n \n impl CrateError {\n-    crate fn report(self, sess: &Session, span: Span) -> ! {\n+    crate fn report(self, sess: &Session, span: Span, missing_core: bool) -> ! {\n         let mut err = match self {\n             CrateError::NonAsciiName(crate_name) => sess.struct_span_err(\n                 span,\n@@ -1068,7 +1069,37 @@ impl CrateError {\n                     if (crate_name == sym::std || crate_name == sym::core)\n                         && locator.triple != TargetTriple::from_triple(config::host_triple())\n                     {\n-                        err.note(&format!(\"the `{}` target may not be installed\", locator.triple));\n+                        if missing_core {\n+                            err.note(&format!(\n+                                \"the `{}` target may not be installed\",\n+                                locator.triple\n+                            ));\n+                        } else {\n+                            err.note(&format!(\n+                                \"the `{}` target may not support the standard library\",\n+                                locator.triple\n+                            ));\n+                        }\n+                        if missing_core && std::env::var(\"RUSTUP_HOME\").is_ok() {\n+                            err.help(&format!(\n+                                \"consider downloading the target with `rustup target add {}`\",\n+                                locator.triple\n+                            ));\n+                        }\n+                        // Suggest using #![no_std]. #[no_core] is unstable and not really supported anyway.\n+                        // NOTE: this is a dummy span if `extern crate std` was injected by the compiler.\n+                        // If it's not a dummy, that means someone added `extern crate std` explicitly and `#![no_std]` won't help.\n+                        if !missing_core && span.is_dummy() {\n+                            let current_crate =\n+                                sess.opts.crate_name.as_deref().unwrap_or(\"<unknown>\");\n+                            err.note(&format!(\n+                                \"`std` is required by `{}` because it does not declare `#![no_std]`\",\n+                                current_crate\n+                            ));\n+                        }\n+                        if sess.is_nightly_build() && std::env::var(\"CARGO\").is_ok() {\n+                            err.help(\"consider building the standard library from source with `cargo build -Zbuild-std`\");\n+                        }\n                     } else if crate_name == sym::profiler_builtins {\n                         err.note(&\"the compiler may have been built without the profiler runtime\");\n                     }"}, {"sha": "442a7c01e5a69421da5a91fe10f859624c202912", "filename": "src/test/ui/crate-loading/missing-std.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/d326a4b4c9176193ff0ac445ec14ac50bd081f04/src%2Ftest%2Fui%2Fcrate-loading%2Fmissing-std.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d326a4b4c9176193ff0ac445ec14ac50bd081f04/src%2Ftest%2Fui%2Fcrate-loading%2Fmissing-std.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcrate-loading%2Fmissing-std.rs?ref=d326a4b4c9176193ff0ac445ec14ac50bd081f04", "patch": "@@ -0,0 +1,11 @@\n+// compile-flags: --target x86_64-unknown-uefi\n+// rustc-env:CARGO=/usr/bin/cargo\n+// rustc-env:RUSTUP_HOME=/home/bors/.rustup\n+#![no_core]\n+extern crate core;\n+//~^ ERROR can't find crate for `core`\n+//~| NOTE can't find crate\n+//~| NOTE target may not be installed\n+//~| HELP consider building the standard library from source with `cargo build -Zbuild-std`\n+//~| HELP consider downloading the target with `rustup target add x86_64-unknown-uefi`\n+fn main() {}"}, {"sha": "25808efdfa6993e94c45af96bfd0878e1598f4ad", "filename": "src/test/ui/crate-loading/missing-std.stderr", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/d326a4b4c9176193ff0ac445ec14ac50bd081f04/src%2Ftest%2Fui%2Fcrate-loading%2Fmissing-std.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d326a4b4c9176193ff0ac445ec14ac50bd081f04/src%2Ftest%2Fui%2Fcrate-loading%2Fmissing-std.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcrate-loading%2Fmissing-std.stderr?ref=d326a4b4c9176193ff0ac445ec14ac50bd081f04", "patch": "@@ -0,0 +1,13 @@\n+error[E0463]: can't find crate for `core`\n+  --> $DIR/missing-std.rs:5:1\n+   |\n+LL | extern crate core;\n+   | ^^^^^^^^^^^^^^^^^^ can't find crate\n+   |\n+   = note: the `x86_64-unknown-uefi` target may not be installed\n+   = help: consider downloading the target with `rustup target add x86_64-unknown-uefi`\n+   = help: consider building the standard library from source with `cargo build -Zbuild-std`\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0463`."}]}