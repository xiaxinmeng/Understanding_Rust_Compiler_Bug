{"sha": "b2ea6c86ae8b9f8845aaff5a1453e4f5ceb53d59", "node_id": "MDY6Q29tbWl0NzI0NzEyOmIyZWE2Yzg2YWU4YjlmODg0NWFhZmY1YTE0NTNlNGY1Y2ViNTNkNTk=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-03-08T23:24:16Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-03-08T23:24:16Z"}, "message": "Auto merge of #58985 - dlrobertson:fix_58980, r=alexreg\n\nFix segfaults in release build C-variadic fns\n\n`va_start` and `va_end` must be called to initialize/cleanup the\n\"spoofed\" `VaList` in a Rust defined C-variadic function even  if\nthe `VaList` is not used.\n\nr? @alexreg\nFixes: #58980", "tree": {"sha": "60ee2aa363847a0f2b1d94e0769f212542b4f0b5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/60ee2aa363847a0f2b1d94e0769f212542b4f0b5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b2ea6c86ae8b9f8845aaff5a1453e4f5ceb53d59", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b2ea6c86ae8b9f8845aaff5a1453e4f5ceb53d59", "html_url": "https://github.com/rust-lang/rust/commit/b2ea6c86ae8b9f8845aaff5a1453e4f5ceb53d59", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b2ea6c86ae8b9f8845aaff5a1453e4f5ceb53d59/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2a65cbeea78c2c79b1030a0012cdea475104a44f", "url": "https://api.github.com/repos/rust-lang/rust/commits/2a65cbeea78c2c79b1030a0012cdea475104a44f", "html_url": "https://github.com/rust-lang/rust/commit/2a65cbeea78c2c79b1030a0012cdea475104a44f"}, {"sha": "1d72037dd39e3e53172d7605f22851b75f4e1a1b", "url": "https://api.github.com/repos/rust-lang/rust/commits/1d72037dd39e3e53172d7605f22851b75f4e1a1b", "html_url": "https://github.com/rust-lang/rust/commit/1d72037dd39e3e53172d7605f22851b75f4e1a1b"}], "stats": {"total": 36, "additions": 27, "deletions": 9}, "files": [{"sha": "35fd30f34ad24e2a248224ff8fc6e73ce99cb3f7", "filename": "src/librustc_codegen_ssa/mir/block.rs", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/b2ea6c86ae8b9f8845aaff5a1453e4f5ceb53d59/src%2Flibrustc_codegen_ssa%2Fmir%2Fblock.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b2ea6c86ae8b9f8845aaff5a1453e4f5ceb53d59/src%2Flibrustc_codegen_ssa%2Fmir%2Fblock.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fmir%2Fblock.rs?ref=b2ea6c86ae8b9f8845aaff5a1453e4f5ceb53d59", "patch": "@@ -233,8 +233,13 @@ impl<'a, 'tcx: 'a, Bx: BuilderMethods<'a, 'tcx>> FunctionCx<'a, 'tcx, Bx> {\n         mut bx: Bx,\n     ) {\n         if self.fn_ty.c_variadic {\n-            if let Some(va_list) = self.va_list_ref {\n-                bx.va_end(va_list.llval);\n+            match self.va_list_ref {\n+                Some(va_list) => {\n+                    bx.va_end(va_list.llval);\n+                }\n+                None => {\n+                    bug!(\"C-variadic function must have a `va_list_ref`\");\n+                }\n             }\n         }\n         let llval = match self.fn_ty.ret.mode {"}, {"sha": "c1b7502cd8fb2fe27f9203a5ac7eb47c22e1f647", "filename": "src/librustc_codegen_ssa/mir/mod.rs", "status": "modified", "additions": 1, "deletions": 7, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/b2ea6c86ae8b9f8845aaff5a1453e4f5ceb53d59/src%2Flibrustc_codegen_ssa%2Fmir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b2ea6c86ae8b9f8845aaff5a1453e4f5ceb53d59/src%2Flibrustc_codegen_ssa%2Fmir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fmir%2Fmod.rs?ref=b2ea6c86ae8b9f8845aaff5a1453e4f5ceb53d59", "patch": "@@ -532,13 +532,7 @@ fn arg_local_refs<'a, 'tcx: 'a, Bx: BuilderMethods<'a, 'tcx>>(\n                 PassMode::Ignore(IgnoreMode::Zst) => {\n                     return local(OperandRef::new_zst(bx.cx(), arg.layout));\n                 }\n-                PassMode::Ignore(IgnoreMode::CVarArgs) => {\n-                    let backend_type = bx.cx().immediate_backend_type(arg.layout);\n-                    return local(OperandRef {\n-                        val: OperandValue::Immediate(bx.cx().const_undef(backend_type)),\n-                        layout: arg.layout,\n-                    });\n-                }\n+                PassMode::Ignore(IgnoreMode::CVarArgs) => {}\n                 PassMode::Direct(_) => {\n                     let llarg = bx.get_param(bx.llfn(), llarg_idx as c_uint);\n                     bx.set_value_name(llarg, &name);"}, {"sha": "8594d309b0a5aa743434ed3fae201c00a02e3b7c", "filename": "src/test/codegen/c-variadic-opt.rs", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/b2ea6c86ae8b9f8845aaff5a1453e4f5ceb53d59/src%2Ftest%2Fcodegen%2Fc-variadic-opt.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b2ea6c86ae8b9f8845aaff5a1453e4f5ceb53d59/src%2Ftest%2Fcodegen%2Fc-variadic-opt.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fc-variadic-opt.rs?ref=b2ea6c86ae8b9f8845aaff5a1453e4f5ceb53d59", "patch": "@@ -0,0 +1,19 @@\n+// compile-flags: -C opt-level=3\n+\n+#![crate_type = \"lib\"]\n+#![feature(c_variadic)]\n+#![no_std]\n+use core::ffi::VaList;\n+\n+extern \"C\" {\n+    fn vprintf(fmt: *const i8, ap: VaList) -> i32;\n+}\n+\n+// Ensure that `va_start` and `va_end` are properly injected even\n+// when the \"spoofed\" `VaList` is not used.\n+#[no_mangle]\n+pub unsafe extern \"C\" fn c_variadic_no_use(fmt: *const i8, mut ap: ...) -> i32 {\n+    // CHECK: call void @llvm.va_start\n+    vprintf(fmt, ap)\n+    // CHECK: call void @llvm.va_end\n+}"}]}