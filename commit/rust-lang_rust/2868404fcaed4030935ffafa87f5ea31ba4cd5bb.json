{"sha": "2868404fcaed4030935ffafa87f5ea31ba4cd5bb", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI4Njg0MDRmY2FlZDQwMzA5MzVmZmFmYTg3ZjVlYTMxYmE0Y2Q1YmI=", "commit": {"author": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2015-01-13T21:03:07Z"}, "committer": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2015-01-14T21:35:14Z"}, "message": "Normalize associated types in the type_is_newtype_immediate pass. Fixes #21010.", "tree": {"sha": "492a392f73d0b21b6c3e66ce9de1b884c3fd6bd1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/492a392f73d0b21b6c3e66ce9de1b884c3fd6bd1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2868404fcaed4030935ffafa87f5ea31ba4cd5bb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2868404fcaed4030935ffafa87f5ea31ba4cd5bb", "html_url": "https://github.com/rust-lang/rust/commit/2868404fcaed4030935ffafa87f5ea31ba4cd5bb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2868404fcaed4030935ffafa87f5ea31ba4cd5bb/comments", "author": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ff6085f401844bc5cb07b804f0d2258bb5c2b9a8", "url": "https://api.github.com/repos/rust-lang/rust/commits/ff6085f401844bc5cb07b804f0d2258bb5c2b9a8", "html_url": "https://github.com/rust-lang/rust/commit/ff6085f401844bc5cb07b804f0d2258bb5c2b9a8"}], "stats": {"total": 43, "additions": 39, "deletions": 4}, "files": [{"sha": "3eee4637de1995322030c5224f7d65de8cf50946", "filename": "src/librustc_trans/trans/common.rs", "status": "modified", "additions": 7, "deletions": 4, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/2868404fcaed4030935ffafa87f5ea31ba4cd5bb/src%2Flibrustc_trans%2Ftrans%2Fcommon.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2868404fcaed4030935ffafa87f5ea31ba4cd5bb/src%2Flibrustc_trans%2Ftrans%2Fcommon.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Ftrans%2Fcommon.rs?ref=2868404fcaed4030935ffafa87f5ea31ba4cd5bb", "patch": "@@ -217,12 +217,15 @@ pub fn type_needs_drop<'tcx>(cx: &ty::ctxt<'tcx>,\n     ty::type_contents(cx, ty).needs_drop(cx)\n }\n \n-fn type_is_newtype_immediate<'a, 'tcx>(ccx: &CrateContext<'a, 'tcx>,\n-                                   ty: Ty<'tcx>) -> bool {\n+fn type_is_newtype_immediate<'a, 'tcx>(ccx: &CrateContext<'a, 'tcx>, ty: Ty<'tcx>) -> bool {\n     match ty.sty {\n         ty::ty_struct(def_id, substs) => {\n-            let fields = ty::struct_fields(ccx.tcx(), def_id, substs);\n-            fields.len() == 1 && type_is_immediate(ccx, fields[0].mt.ty)\n+            let fields = ty::lookup_struct_fields(ccx.tcx(), def_id);\n+            fields.len() == 1 && {\n+                let ty = ty::lookup_field_type(ccx.tcx(), def_id, fields[0].id, substs);\n+                let ty = monomorphize::normalize_associated_type(ccx.tcx(), &ty);\n+                type_is_immediate(ccx, ty)\n+            }\n         }\n         _ => false\n     }"}, {"sha": "c517f61de0c16d076ba2087c8dde81e891013c3c", "filename": "src/test/run-pass/associated-types-normalize-unifield-struct.rs", "status": "added", "additions": 32, "deletions": 0, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/2868404fcaed4030935ffafa87f5ea31ba4cd5bb/src%2Ftest%2Frun-pass%2Fassociated-types-normalize-unifield-struct.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2868404fcaed4030935ffafa87f5ea31ba4cd5bb/src%2Ftest%2Frun-pass%2Fassociated-types-normalize-unifield-struct.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fassociated-types-normalize-unifield-struct.rs?ref=2868404fcaed4030935ffafa87f5ea31ba4cd5bb", "patch": "@@ -0,0 +1,32 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// Regression test for issue #21010: Normalize associated types in\n+// various special paths in the `type_is_immediate` function.\n+\n+#![allow(unstable)]\n+\n+pub trait OffsetState: Sized {}\n+pub trait Offset { type State: OffsetState; }\n+\n+#[derive(Copy)] pub struct X;\n+impl Offset for X { type State = Y; }\n+\n+#[derive(Copy)] pub struct Y;\n+impl OffsetState for Y {}\n+\n+pub fn now() -> DateTime<X> { from_utc(Y) }\n+\n+pub struct DateTime<Off: Offset> { pub offset: Off::State }\n+pub fn from_utc<Off: Offset>(offset: Off::State) -> DateTime<Off> { DateTime { offset: offset } }\n+\n+pub fn main() {\n+    let _x = now();\n+}"}]}