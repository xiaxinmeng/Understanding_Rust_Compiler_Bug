{"sha": "f51111aacbbfbbf680efc115f8feb1e815309853", "node_id": "C_kwDOAAsO6NoAKGY1MTExMWFhY2JiZmJiZjY4MGVmYzExNWY4ZmViMWU4MTUzMDk4NTM", "commit": {"author": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2023-01-02T22:16:09Z"}, "committer": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2023-01-02T22:16:09Z"}, "message": "Write down adjustments introduced by binary operators", "tree": {"sha": "55120e88f25f40865b7484e296bd30759bd0d0dc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/55120e88f25f40865b7484e296bd30759bd0d0dc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f51111aacbbfbbf680efc115f8feb1e815309853", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f51111aacbbfbbf680efc115f8feb1e815309853", "html_url": "https://github.com/rust-lang/rust/commit/f51111aacbbfbbf680efc115f8feb1e815309853", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f51111aacbbfbbf680efc115f8feb1e815309853/comments", "author": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "17cc78f169538538a10e11251562e0fde8ed4958", "url": "https://api.github.com/repos/rust-lang/rust/commits/17cc78f169538538a10e11251562e0fde8ed4958", "html_url": "https://github.com/rust-lang/rust/commit/17cc78f169538538a10e11251562e0fde8ed4958"}], "stats": {"total": 103, "additions": 84, "deletions": 19}, "files": [{"sha": "2e5c4244109fd7c7fb52958f27300c88ae139cdc", "filename": "crates/hir-ty/src/infer/expr.rs", "status": "modified", "additions": 30, "deletions": 6, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/f51111aacbbfbbf680efc115f8feb1e815309853/crates%2Fhir-ty%2Fsrc%2Finfer%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f51111aacbbfbbf680efc115f8feb1e815309853/crates%2Fhir-ty%2Fsrc%2Finfer%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-ty%2Fsrc%2Finfer%2Fexpr.rs?ref=f51111aacbbfbbf680efc115f8feb1e815309853", "patch": "@@ -6,7 +6,7 @@ use std::{\n };\n \n use chalk_ir::{\n-    cast::Cast, fold::Shift, DebruijnIndex, GenericArgData, Mutability, TyVariableKind,\n+    cast::Cast, fold::Shift, DebruijnIndex, GenericArgData, Mutability, TyKind, TyVariableKind,\n };\n use hir_def::{\n     expr::{\n@@ -34,8 +34,8 @@ use crate::{\n     primitive::{self, UintTy},\n     static_lifetime, to_chalk_trait_id,\n     utils::{generics, Generics},\n-    AdtId, Binders, CallableDefId, FnPointer, FnSig, FnSubst, Interner, Rawness, Scalar,\n-    Substitution, TraitRef, Ty, TyBuilder, TyExt, TyKind,\n+    Adjust, Adjustment, AdtId, AutoBorrow, Binders, CallableDefId, FnPointer, FnSig, FnSubst,\n+    Interner, Rawness, Scalar, Substitution, TraitRef, Ty, TyBuilder, TyExt,\n };\n \n use super::{\n@@ -1038,14 +1038,38 @@ impl<'a> InferenceContext<'a> {\n         self.infer_expr_coerce(rhs, &Expectation::has_type(rhs_ty.clone()));\n \n         let ret_ty = match method_ty.callable_sig(self.db) {\n-            Some(sig) => sig.ret().clone(),\n+            Some(sig) => {\n+                let p_left = &sig.params()[0];\n+                if matches!(op, BinaryOp::CmpOp(..) | BinaryOp::Assignment { .. }) {\n+                    if let &TyKind::Ref(mtbl, _, _) = p_left.kind(Interner) {\n+                        self.write_expr_adj(\n+                            lhs,\n+                            vec![Adjustment {\n+                                kind: Adjust::Borrow(AutoBorrow::Ref(mtbl)),\n+                                target: p_left.clone(),\n+                            }],\n+                        );\n+                    }\n+                }\n+                let p_right = &sig.params()[1];\n+                if matches!(op, BinaryOp::CmpOp(..)) {\n+                    if let &TyKind::Ref(mtbl, _, _) = p_right.kind(Interner) {\n+                        self.write_expr_adj(\n+                            rhs,\n+                            vec![Adjustment {\n+                                kind: Adjust::Borrow(AutoBorrow::Ref(mtbl)),\n+                                target: p_right.clone(),\n+                            }],\n+                        );\n+                    }\n+                }\n+                sig.ret().clone()\n+            }\n             None => self.err_ty(),\n         };\n \n         let ret_ty = self.normalize_associated_types_in(ret_ty);\n \n-        // FIXME: record autoref adjustments\n-\n         // use knowledge of built-in binary ops, which can sometimes help inference\n         if let Some(builtin_rhs) = self.builtin_binary_op_rhs_expectation(op, lhs_ty.clone()) {\n             self.unify(&builtin_rhs, &rhs_ty);"}, {"sha": "ba5d9c2412670851fc255c0bad858b70e88644b8", "filename": "crates/hir-ty/src/tests.rs", "status": "modified", "additions": 14, "deletions": 13, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/f51111aacbbfbbf680efc115f8feb1e815309853/crates%2Fhir-ty%2Fsrc%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f51111aacbbfbbf680efc115f8feb1e815309853/crates%2Fhir-ty%2Fsrc%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-ty%2Fsrc%2Ftests.rs?ref=f51111aacbbfbbf680efc115f8feb1e815309853", "patch": "@@ -94,11 +94,12 @@ fn check_impl(ra_fixture: &str, allow_none: bool, only_types: bool, display_sour\n                 types.insert(file_range, expected.trim_start_matches(\"type: \").to_string());\n             } else if expected.starts_with(\"expected\") {\n                 mismatches.insert(file_range, expected);\n-            } else if expected.starts_with(\"adjustments: \") {\n+            } else if expected.starts_with(\"adjustments:\") {\n                 adjustments.insert(\n                     file_range,\n                     expected\n-                        .trim_start_matches(\"adjustments: \")\n+                        .trim_start_matches(\"adjustments:\")\n+                        .trim()\n                         .split(',')\n                         .map(|it| it.trim().to_string())\n                         .filter(|it| !it.is_empty())\n@@ -176,17 +177,17 @@ fn check_impl(ra_fixture: &str, allow_none: bool, only_types: bool, display_sour\n                 assert_eq!(actual, expected);\n             }\n             if let Some(expected) = adjustments.remove(&range) {\n-                if let Some(adjustments) = inference_result.expr_adjustments.get(&expr) {\n-                    assert_eq!(\n-                        expected,\n-                        adjustments\n-                            .iter()\n-                            .map(|Adjustment { kind, .. }| format!(\"{kind:?}\"))\n-                            .collect::<Vec<_>>()\n-                    );\n-                } else {\n-                    panic!(\"expected {expected:?} adjustments, found none\");\n-                }\n+                let adjustments = inference_result\n+                    .expr_adjustments\n+                    .get(&expr)\n+                    .map_or_else(Default::default, |it| &**it);\n+                assert_eq!(\n+                    expected,\n+                    adjustments\n+                        .iter()\n+                        .map(|Adjustment { kind, .. }| format!(\"{kind:?}\"))\n+                        .collect::<Vec<_>>()\n+                );\n             }\n         }\n "}, {"sha": "3e110abaf4b181875099b907be99dae93ab65ed9", "filename": "crates/hir-ty/src/tests/coercion.rs", "status": "modified", "additions": 34, "deletions": 0, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/f51111aacbbfbbf680efc115f8feb1e815309853/crates%2Fhir-ty%2Fsrc%2Ftests%2Fcoercion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f51111aacbbfbbf680efc115f8feb1e815309853/crates%2Fhir-ty%2Fsrc%2Ftests%2Fcoercion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-ty%2Fsrc%2Ftests%2Fcoercion.rs?ref=f51111aacbbfbbf680efc115f8feb1e815309853", "patch": "@@ -807,3 +807,37 @@ fn main() {\n         \"#,\n     );\n }\n+\n+#[test]\n+fn adjust_comparison_arguments() {\n+    check_no_mismatches(\n+        r\"\n+//- minicore: eq\n+struct Struct;\n+impl core::cmp::PartialEq for Struct {\n+    fn eq(&self, other: &Self) -> bool { true }\n+}\n+fn test() {\n+    Struct == Struct;\n+ // ^^^^^^ adjustments: Borrow(Ref(Not))\n+           // ^^^^^^ adjustments: Borrow(Ref(Not))\n+}\",\n+    );\n+}\n+\n+#[test]\n+fn adjust_assign_lhs() {\n+    check_no_mismatches(\n+        r\"\n+//- minicore: add\n+struct Struct;\n+impl core::ops::AddAssign for Struct {\n+    fn add_assign(&mut self, other: Self) {}\n+}\n+fn test() {\n+    Struct += Struct;\n+ // ^^^^^^ adjustments: Borrow(Ref(Mut))\n+           // ^^^^^^ adjustments:\n+}\",\n+    );\n+}"}, {"sha": "3ca63fcab90d603e93ed7b04db69fa0fd6aaac7a", "filename": "crates/test-utils/src/minicore.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/f51111aacbbfbbf680efc115f8feb1e815309853/crates%2Ftest-utils%2Fsrc%2Fminicore.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f51111aacbbfbbf680efc115f8feb1e815309853/crates%2Ftest-utils%2Fsrc%2Fminicore.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Ftest-utils%2Fsrc%2Fminicore.rs?ref=f51111aacbbfbbf680efc115f8feb1e815309853", "patch": "@@ -382,6 +382,12 @@ pub mod ops {\n         type Output;\n         fn add(self, rhs: Rhs) -> Self::Output;\n     }\n+\n+    #[lang = \"add_assign\"]\n+    #[const_trait]\n+    pub trait AddAssign<Rhs = Self> {\n+        fn add_assign(&mut self, rhs: Rhs);\n+    }\n     // endregion:add\n \n     // region:generator"}]}