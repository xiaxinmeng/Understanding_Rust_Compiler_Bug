{"sha": "adcbe49b16dff960600b5d54171d38d6b556d228", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFkY2JlNDliMTZkZmY5NjA2MDBiNWQ1NDE3MWQzOGQ2YjU1NmQyMjg=", "commit": {"author": {"name": "Tyson Nottingham", "email": "tgnottingham@gmail.com", "date": "2021-03-11T19:22:47Z"}, "committer": {"name": "Tyson Nottingham", "email": "tgnottingham@gmail.com", "date": "2021-03-13T01:34:14Z"}, "message": "rustc_query_system: simplify QueryCache::iter\n\nMinor cleanup to reduce a small amount of complexity and code bloat.\nReduces the number of mono items in rustc_query_impl by 15%.", "tree": {"sha": "ddd96dd1d30114ec5f09de7e8ab88c8c12a3597a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ddd96dd1d30114ec5f09de7e8ab88c8c12a3597a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/adcbe49b16dff960600b5d54171d38d6b556d228", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/adcbe49b16dff960600b5d54171d38d6b556d228", "html_url": "https://github.com/rust-lang/rust/commit/adcbe49b16dff960600b5d54171d38d6b556d228", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/adcbe49b16dff960600b5d54171d38d6b556d228/comments", "author": {"login": "tgnottingham", "id": 3668166, "node_id": "MDQ6VXNlcjM2NjgxNjY=", "avatar_url": "https://avatars.githubusercontent.com/u/3668166?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tgnottingham", "html_url": "https://github.com/tgnottingham", "followers_url": "https://api.github.com/users/tgnottingham/followers", "following_url": "https://api.github.com/users/tgnottingham/following{/other_user}", "gists_url": "https://api.github.com/users/tgnottingham/gists{/gist_id}", "starred_url": "https://api.github.com/users/tgnottingham/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tgnottingham/subscriptions", "organizations_url": "https://api.github.com/users/tgnottingham/orgs", "repos_url": "https://api.github.com/users/tgnottingham/repos", "events_url": "https://api.github.com/users/tgnottingham/events{/privacy}", "received_events_url": "https://api.github.com/users/tgnottingham/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tgnottingham", "id": 3668166, "node_id": "MDQ6VXNlcjM2NjgxNjY=", "avatar_url": "https://avatars.githubusercontent.com/u/3668166?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tgnottingham", "html_url": "https://github.com/tgnottingham", "followers_url": "https://api.github.com/users/tgnottingham/followers", "following_url": "https://api.github.com/users/tgnottingham/following{/other_user}", "gists_url": "https://api.github.com/users/tgnottingham/gists{/gist_id}", "starred_url": "https://api.github.com/users/tgnottingham/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tgnottingham/subscriptions", "organizations_url": "https://api.github.com/users/tgnottingham/orgs", "repos_url": "https://api.github.com/users/tgnottingham/repos", "events_url": "https://api.github.com/users/tgnottingham/events{/privacy}", "received_events_url": "https://api.github.com/users/tgnottingham/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "45b3c28518e4c45dfd12bc2c4400c0d0e9639927", "url": "https://api.github.com/repos/rust-lang/rust/commits/45b3c28518e4c45dfd12bc2c4400c0d0e9639927", "html_url": "https://github.com/rust-lang/rust/commit/45b3c28518e4c45dfd12bc2c4400c0d0e9639927"}], "stats": {"total": 39, "additions": 17, "deletions": 22}, "files": [{"sha": "001bf3b216b1b014c8b765ec3a2a6afdca8f65ac", "filename": "compiler/rustc_query_system/src/query/caches.rs", "status": "modified", "additions": 15, "deletions": 20, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/adcbe49b16dff960600b5d54171d38d6b556d228/compiler%2Frustc_query_system%2Fsrc%2Fquery%2Fcaches.rs", "raw_url": "https://github.com/rust-lang/rust/raw/adcbe49b16dff960600b5d54171d38d6b556d228/compiler%2Frustc_query_system%2Fsrc%2Fquery%2Fcaches.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_query_system%2Fsrc%2Fquery%2Fcaches.rs?ref=adcbe49b16dff960600b5d54171d38d6b556d228", "patch": "@@ -49,12 +49,11 @@ pub trait QueryCache: QueryStorage {\n         index: DepNodeIndex,\n     ) -> Self::Stored;\n \n-    fn iter<R, L>(\n+    fn iter<R>(\n         &self,\n-        shards: &Sharded<L>,\n-        get_shard: impl Fn(&mut L) -> &mut Self::Sharded,\n+        shards: &Sharded<Self::Sharded>,\n         f: impl for<'a> FnOnce(\n-            Box<dyn Iterator<Item = (&'a Self::Key, &'a Self::Value, DepNodeIndex)> + 'a>,\n+            &'a mut dyn Iterator<Item = (&'a Self::Key, &'a Self::Value, DepNodeIndex)>,\n         ) -> R,\n     ) -> R;\n }\n@@ -125,16 +124,14 @@ where\n         value\n     }\n \n-    fn iter<R, L>(\n+    fn iter<R>(\n         &self,\n-        shards: &Sharded<L>,\n-        get_shard: impl Fn(&mut L) -> &mut Self::Sharded,\n-        f: impl for<'a> FnOnce(Box<dyn Iterator<Item = (&'a K, &'a V, DepNodeIndex)> + 'a>) -> R,\n+        shards: &Sharded<Self::Sharded>,\n+        f: impl for<'a> FnOnce(&'a mut dyn Iterator<Item = (&'a K, &'a V, DepNodeIndex)>) -> R,\n     ) -> R {\n-        let mut shards = shards.lock_shards();\n-        let mut shards: Vec<_> = shards.iter_mut().map(|shard| get_shard(shard)).collect();\n-        let results = shards.iter_mut().flat_map(|shard| shard.iter()).map(|(k, v)| (k, &v.0, v.1));\n-        f(Box::new(results))\n+        let shards = shards.lock_shards();\n+        let mut results = shards.iter().flat_map(|shard| shard.iter()).map(|(k, v)| (k, &v.0, v.1));\n+        f(&mut results)\n     }\n }\n \n@@ -210,15 +207,13 @@ where\n         &value.0\n     }\n \n-    fn iter<R, L>(\n+    fn iter<R>(\n         &self,\n-        shards: &Sharded<L>,\n-        get_shard: impl Fn(&mut L) -> &mut Self::Sharded,\n-        f: impl for<'a> FnOnce(Box<dyn Iterator<Item = (&'a K, &'a V, DepNodeIndex)> + 'a>) -> R,\n+        shards: &Sharded<Self::Sharded>,\n+        f: impl for<'a> FnOnce(&'a mut dyn Iterator<Item = (&'a K, &'a V, DepNodeIndex)>) -> R,\n     ) -> R {\n-        let mut shards = shards.lock_shards();\n-        let mut shards: Vec<_> = shards.iter_mut().map(|shard| get_shard(shard)).collect();\n-        let results = shards.iter_mut().flat_map(|shard| shard.iter()).map(|(k, v)| (k, &v.0, v.1));\n-        f(Box::new(results))\n+        let shards = shards.lock_shards();\n+        let mut results = shards.iter().flat_map(|shard| shard.iter()).map(|(k, v)| (k, &v.0, v.1));\n+        f(&mut results)\n     }\n }"}, {"sha": "c3e92b87c27d2bf26fbb9aced7491e3f5c2912dd", "filename": "compiler/rustc_query_system/src/query/plumbing.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/adcbe49b16dff960600b5d54171d38d6b556d228/compiler%2Frustc_query_system%2Fsrc%2Fquery%2Fplumbing.rs", "raw_url": "https://github.com/rust-lang/rust/raw/adcbe49b16dff960600b5d54171d38d6b556d228/compiler%2Frustc_query_system%2Fsrc%2Fquery%2Fplumbing.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_query_system%2Fsrc%2Fquery%2Fplumbing.rs?ref=adcbe49b16dff960600b5d54171d38d6b556d228", "patch": "@@ -76,10 +76,10 @@ impl<C: QueryCache> QueryCacheStore<C> {\n     pub fn iter_results<R>(\n         &self,\n         f: impl for<'a> FnOnce(\n-            Box<dyn Iterator<Item = (&'a C::Key, &'a C::Value, DepNodeIndex)> + 'a>,\n+            &'a mut dyn Iterator<Item = (&'a C::Key, &'a C::Value, DepNodeIndex)>,\n         ) -> R,\n     ) -> R {\n-        self.cache.iter(&self.shards, |shard| &mut *shard, f)\n+        self.cache.iter(&self.shards, f)\n     }\n }\n "}]}