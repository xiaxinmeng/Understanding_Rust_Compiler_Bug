{"sha": "bca9e90f9f190ed94033d674f195b141dbaf5ec6", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJjYTllOTBmOWYxOTBlZDk0MDMzZDY3NGYxOTViMTQxZGJhZjVlYzY=", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2020-06-15T07:57:37Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-06-15T07:57:37Z"}, "message": "Rollup merge of #73353 - davidtwco:issue-73003-non-structural-match-ty-closures, r=varkor\n\nstructural_match: non-structural-match ty closures\n\nFixes #73003.\n\nThis PR adds a `Closure` variant to `NonStructuralMatchTy` in `structural_match`, fixing an ICE which can occur when `impl_trait_in_bindings` is used with constants.", "tree": {"sha": "ee93f480df9d8ad03f2db0ba17150ae98d54072a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ee93f480df9d8ad03f2db0ba17150ae98d54072a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bca9e90f9f190ed94033d674f195b141dbaf5ec6", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJe5ynxCRBK7hj4Ov3rIwAAdHIIAKZ55t2ro3STVg0ST5SjUvu7\nWPMSunaKqmcuQWFQZFtAMxM2gJUWB8ZJCAcOKl86wyAj3mJKCzr2NE0MZXCrpWVv\nTYG47Zx0oJnXaPR16+whMomeNPuf7bYGjta5JZztuKzMfXIiyoVGsOeJFw0YZ1V3\nvkHoBpK194xh1pIezFfIYicGK+XGeA+Ce9FZOKyTV5rqEdI2PQmJynShhrnTvV1y\nH28NLB8Dgd8oAX1lClrGjPvov4EYOZ0Xo2N7DhOt/LdCBwxl2tVugP0w4SVmfCIW\n6zhmU+o3AosRE8dENJd+62zDSDe15uH8kONg9lv1fi0iiOjIrBR3kO4fKiXUPh0=\n=ChcN\n-----END PGP SIGNATURE-----\n", "payload": "tree ee93f480df9d8ad03f2db0ba17150ae98d54072a\nparent 192e9bde804932f7c35d366d9fc939d7b3adafa3\nparent 79e08bbc9949001306ce1014432efff3b1ecaf11\nauthor Ralf Jung <post@ralfj.de> 1592207857 +0200\ncommitter GitHub <noreply@github.com> 1592207857 +0200\n\nRollup merge of #73353 - davidtwco:issue-73003-non-structural-match-ty-closures, r=varkor\n\nstructural_match: non-structural-match ty closures\n\nFixes #73003.\n\nThis PR adds a `Closure` variant to `NonStructuralMatchTy` in `structural_match`, fixing an ICE which can occur when `impl_trait_in_bindings` is used with constants.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bca9e90f9f190ed94033d674f195b141dbaf5ec6", "html_url": "https://github.com/rust-lang/rust/commit/bca9e90f9f190ed94033d674f195b141dbaf5ec6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bca9e90f9f190ed94033d674f195b141dbaf5ec6/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "192e9bde804932f7c35d366d9fc939d7b3adafa3", "url": "https://api.github.com/repos/rust-lang/rust/commits/192e9bde804932f7c35d366d9fc939d7b3adafa3", "html_url": "https://github.com/rust-lang/rust/commit/192e9bde804932f7c35d366d9fc939d7b3adafa3"}, {"sha": "79e08bbc9949001306ce1014432efff3b1ecaf11", "url": "https://api.github.com/repos/rust-lang/rust/commits/79e08bbc9949001306ce1014432efff3b1ecaf11", "html_url": "https://github.com/rust-lang/rust/commit/79e08bbc9949001306ce1014432efff3b1ecaf11"}], "stats": {"total": 29, "additions": 28, "deletions": 1}, "files": [{"sha": "087c2c064cfaf3c57f4de92a1911f85905ff2b4b", "filename": "src/librustc_mir_build/hair/pattern/const_to_pat.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/bca9e90f9f190ed94033d674f195b141dbaf5ec6/src%2Flibrustc_mir_build%2Fhair%2Fpattern%2Fconst_to_pat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bca9e90f9f190ed94033d674f195b141dbaf5ec6/src%2Flibrustc_mir_build%2Fhair%2Fpattern%2Fconst_to_pat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir_build%2Fhair%2Fpattern%2Fconst_to_pat.rs?ref=bca9e90f9f190ed94033d674f195b141dbaf5ec6", "patch": "@@ -130,6 +130,9 @@ impl<'a, 'tcx> ConstToPat<'a, 'tcx> {\n                     traits::NonStructuralMatchTy::Generator => {\n                         \"generators cannot be used in patterns\".to_string()\n                     }\n+                    traits::NonStructuralMatchTy::Closure => {\n+                        \"closures cannot be used in patterns\".to_string()\n+                    }\n                     traits::NonStructuralMatchTy::Param => {\n                         bug!(\"use of a constant whose type is a parameter inside a pattern\")\n                     }"}, {"sha": "c4deb639140ca3119191d60e7376e4526f70395c", "filename": "src/librustc_trait_selection/traits/structural_match.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/bca9e90f9f190ed94033d674f195b141dbaf5ec6/src%2Flibrustc_trait_selection%2Ftraits%2Fstructural_match.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bca9e90f9f190ed94033d674f195b141dbaf5ec6/src%2Flibrustc_trait_selection%2Ftraits%2Fstructural_match.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trait_selection%2Ftraits%2Fstructural_match.rs?ref=bca9e90f9f190ed94033d674f195b141dbaf5ec6", "patch": "@@ -18,6 +18,7 @@ pub enum NonStructuralMatchTy<'tcx> {\n     Opaque,\n     Generator,\n     Projection,\n+    Closure,\n }\n \n /// This method traverses the structure of `ty`, trying to find an\n@@ -162,6 +163,10 @@ impl<'a, 'tcx> TypeVisitor<'tcx> for Search<'a, 'tcx> {\n                 self.found = Some(NonStructuralMatchTy::Generator);\n                 return true; // Stop visiting.\n             }\n+            ty::Closure(..) => {\n+                self.found = Some(NonStructuralMatchTy::Closure);\n+                return true; // Stop visiting.\n+            }\n             ty::RawPtr(..) => {\n                 // structural-match ignores substructure of\n                 // `*const _`/`*mut _`, so skip `super_visit_with`.\n@@ -211,7 +216,7 @@ impl<'a, 'tcx> TypeVisitor<'tcx> for Search<'a, 'tcx> {\n                 ty.super_visit_with(self);\n                 return false;\n             }\n-            ty::Closure(..) | ty::Infer(_) | ty::Placeholder(_) | ty::Bound(..) => {\n+            ty::Infer(_) | ty::Placeholder(_) | ty::Bound(..) => {\n                 bug!(\"unexpected type during structural-match checking: {:?}\", ty);\n             }\n             ty::Error => {"}, {"sha": "fd8fe5f48dfa23aa1a2a1a050e6b84e43f53b896", "filename": "src/test/ui/impl-trait-in-bindings-issue-73003.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/bca9e90f9f190ed94033d674f195b141dbaf5ec6/src%2Ftest%2Fui%2Fimpl-trait-in-bindings-issue-73003.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bca9e90f9f190ed94033d674f195b141dbaf5ec6/src%2Ftest%2Fui%2Fimpl-trait-in-bindings-issue-73003.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fimpl-trait-in-bindings-issue-73003.rs?ref=bca9e90f9f190ed94033d674f195b141dbaf5ec6", "patch": "@@ -0,0 +1,8 @@\n+// check-pass\n+\n+#![feature(impl_trait_in_bindings)]\n+//~^ WARN the feature `impl_trait_in_bindings` is incomplete\n+\n+const _: impl Fn() = ||();\n+\n+fn main() {}"}, {"sha": "715671c8add834eee7f379d64fb6d6317ee70320", "filename": "src/test/ui/impl-trait-in-bindings-issue-73003.stderr", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/bca9e90f9f190ed94033d674f195b141dbaf5ec6/src%2Ftest%2Fui%2Fimpl-trait-in-bindings-issue-73003.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/bca9e90f9f190ed94033d674f195b141dbaf5ec6/src%2Ftest%2Fui%2Fimpl-trait-in-bindings-issue-73003.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fimpl-trait-in-bindings-issue-73003.stderr?ref=bca9e90f9f190ed94033d674f195b141dbaf5ec6", "patch": "@@ -0,0 +1,11 @@\n+warning: the feature `impl_trait_in_bindings` is incomplete and may not be safe to use and/or cause compiler crashes\n+  --> $DIR/impl-trait-in-bindings-issue-73003.rs:3:12\n+   |\n+LL | #![feature(impl_trait_in_bindings)]\n+   |            ^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+   = note: `#[warn(incomplete_features)]` on by default\n+   = note: see issue #63065 <https://github.com/rust-lang/rust/issues/63065> for more information\n+\n+warning: 1 warning emitted\n+"}]}