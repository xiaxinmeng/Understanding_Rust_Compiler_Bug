{"sha": "8509819aef02c28c3f636dc04ad7b6087f7dc334", "node_id": "C_kwDOAAsO6NoAKDg1MDk4MTlhZWYwMmMyOGMzZjYzNmRjMDRhZDdiNjA4N2Y3ZGMzMzQ", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-09-25T22:23:36Z"}, "committer": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-10-20T17:31:01Z"}, "message": "Elaborate supertrait bounds when triggering unused_must_use on impl Trait", "tree": {"sha": "cfff3bcc6dbc2fcb71ec48696390cca67469d1ba", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cfff3bcc6dbc2fcb71ec48696390cca67469d1ba"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8509819aef02c28c3f636dc04ad7b6087f7dc334", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8509819aef02c28c3f636dc04ad7b6087f7dc334", "html_url": "https://github.com/rust-lang/rust/commit/8509819aef02c28c3f636dc04ad7b6087f7dc334", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8509819aef02c28c3f636dc04ad7b6087f7dc334/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "542febd2d383b5082277c7d165b098c0a3b513f6", "url": "https://api.github.com/repos/rust-lang/rust/commits/542febd2d383b5082277c7d165b098c0a3b513f6", "html_url": "https://github.com/rust-lang/rust/commit/542febd2d383b5082277c7d165b098c0a3b513f6"}], "stats": {"total": 34, "additions": 32, "deletions": 2}, "files": [{"sha": "36657909b19eeedc01ad294d567198108c290281", "filename": "compiler/rustc_lint/src/unused.rs", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/8509819aef02c28c3f636dc04ad7b6087f7dc334/compiler%2Frustc_lint%2Fsrc%2Funused.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8509819aef02c28c3f636dc04ad7b6087f7dc334/compiler%2Frustc_lint%2Fsrc%2Funused.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_lint%2Fsrc%2Funused.rs?ref=8509819aef02c28c3f636dc04ad7b6087f7dc334", "patch": "@@ -7,6 +7,7 @@ use rustc_errors::{fluent, pluralize, Applicability, MultiSpan};\n use rustc_hir as hir;\n use rustc_hir::def::{DefKind, Res};\n use rustc_hir::def_id::DefId;\n+use rustc_infer::traits::util::elaborate_predicates_with_span;\n use rustc_middle::ty::adjustment;\n use rustc_middle::ty::{self, Ty};\n use rustc_span::symbol::Symbol;\n@@ -204,10 +205,13 @@ impl<'tcx> LateLintPass<'tcx> for UnusedResults {\n                 ty::Adt(def, _) => check_must_use_def(cx, def.did(), span, descr_pre, descr_post),\n                 ty::Opaque(def, _) => {\n                     let mut has_emitted = false;\n-                    for &(predicate, _) in cx.tcx.explicit_item_bounds(def) {\n+                    for obligation in elaborate_predicates_with_span(\n+                        cx.tcx,\n+                        cx.tcx.explicit_item_bounds(def).iter().cloned(),\n+                    ) {\n                         // We only look at the `DefId`, so it is safe to skip the binder here.\n                         if let ty::PredicateKind::Trait(ref poly_trait_predicate) =\n-                            predicate.kind().skip_binder()\n+                            obligation.predicate.kind().skip_binder()\n                         {\n                             let def_id = poly_trait_predicate.trait_ref.def_id;\n                             let descr_pre ="}, {"sha": "64a8e5204579c679605994794cff50038ab58db1", "filename": "src/test/ui/lint/unused/unused-supertrait.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/8509819aef02c28c3f636dc04ad7b6087f7dc334/src%2Ftest%2Fui%2Flint%2Funused%2Funused-supertrait.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8509819aef02c28c3f636dc04ad7b6087f7dc334/src%2Ftest%2Fui%2Flint%2Funused%2Funused-supertrait.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Funused%2Funused-supertrait.rs?ref=8509819aef02c28c3f636dc04ad7b6087f7dc334", "patch": "@@ -0,0 +1,11 @@\n+#![deny(unused_must_use)]\n+\n+fn it() -> impl ExactSizeIterator<Item = ()> {\n+    let x: Box<dyn ExactSizeIterator<Item = ()>> = todo!();\n+    x\n+}\n+\n+fn main() {\n+    it();\n+    //~^ ERROR unused implementer of `Iterator` that must be used\n+}"}, {"sha": "d2f8c0078481772043877e24c2d25be388e30c3f", "filename": "src/test/ui/lint/unused/unused-supertrait.stderr", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/8509819aef02c28c3f636dc04ad7b6087f7dc334/src%2Ftest%2Fui%2Flint%2Funused%2Funused-supertrait.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/8509819aef02c28c3f636dc04ad7b6087f7dc334/src%2Ftest%2Fui%2Flint%2Funused%2Funused-supertrait.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Funused%2Funused-supertrait.stderr?ref=8509819aef02c28c3f636dc04ad7b6087f7dc334", "patch": "@@ -0,0 +1,15 @@\n+error: unused implementer of `Iterator` that must be used\n+  --> $DIR/unused-supertrait.rs:9:5\n+   |\n+LL |     it();\n+   |     ^^^^^\n+   |\n+   = note: iterators are lazy and do nothing unless consumed\n+note: the lint level is defined here\n+  --> $DIR/unused-supertrait.rs:1:9\n+   |\n+LL | #![deny(unused_must_use)]\n+   |         ^^^^^^^^^^^^^^^\n+\n+error: aborting due to previous error\n+"}]}