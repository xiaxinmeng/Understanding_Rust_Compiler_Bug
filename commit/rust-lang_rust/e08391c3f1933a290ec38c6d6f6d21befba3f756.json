{"sha": "e08391c3f1933a290ec38c6d6f6d21befba3f756", "node_id": "MDY6Q29tbWl0NzI0NzEyOmUwODM5MWMzZjE5MzNhMjkwZWMzOGM2ZDZmNmQyMWJlZmJhM2Y3NTY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-10-03T11:26:32Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-10-03T11:26:32Z"}, "message": "auto merge of #9699 : thestinger/rust/immediate, r=huonw,luqmana\n\n    struct Foo;\r\n    fn foo() -> Foo { Foo }\r\n\r\nBefore:\r\n\r\n    ; Function Attrs: nounwind readnone uwtable\r\n    define void @_ZN3foo18he8ca29755dedebbaf4v0.0E(%struct.Foo* noalias nocapture sret, { i64, %tydesc*, i8*, i8*, i8 }* nocapture) #0 {\r\n    \"function top level\":\r\n      ret void\r\n    }\r\n\r\nAfter:\r\n\r\n    ; Function Attrs: nounwind readnone uwtable\r\n    define %struct.Foo @_ZN3foo18he8ca29755dedebbaf4v0.0E({ i64, %tydesc*, i8*, i8*, i8 }* nocapture readnone) #0 {\r\n    \"function top level\":\r\n      ret %struct.Foo undef\r\n    }", "tree": {"sha": "0a84e7dcd826f3e20554d1985ac3322492093a69", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0a84e7dcd826f3e20554d1985ac3322492093a69"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e08391c3f1933a290ec38c6d6f6d21befba3f756", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e08391c3f1933a290ec38c6d6f6d21befba3f756", "html_url": "https://github.com/rust-lang/rust/commit/e08391c3f1933a290ec38c6d6f6d21befba3f756", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e08391c3f1933a290ec38c6d6f6d21befba3f756/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6d598989f62c15b6093cdaf116f2f6318ed1b95c", "url": "https://api.github.com/repos/rust-lang/rust/commits/6d598989f62c15b6093cdaf116f2f6318ed1b95c", "html_url": "https://github.com/rust-lang/rust/commit/6d598989f62c15b6093cdaf116f2f6318ed1b95c"}, {"sha": "f504461a40d0f6fd88983be6d744c8d62b430506", "url": "https://api.github.com/repos/rust-lang/rust/commits/f504461a40d0f6fd88983be6d744c8d62b430506", "html_url": "https://github.com/rust-lang/rust/commit/f504461a40d0f6fd88983be6d744c8d62b430506"}], "stats": {"total": 23, "additions": 14, "deletions": 9}, "files": [{"sha": "ddfcd2630fadb3018b3b90cb987cc791863f21f1", "filename": "src/librustc/middle/trans/common.rs", "status": "modified", "additions": 3, "deletions": 4, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/e08391c3f1933a290ec38c6d6f6d21befba3f756/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcommon.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e08391c3f1933a290ec38c6d6f6d21befba3f756/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcommon.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fcommon.rs?ref=e08391c3f1933a290ec38c6d6f6d21befba3f756", "patch": "@@ -69,12 +69,11 @@ pub fn type_is_immediate(ccx: &mut CrateContext, ty: ty::t) -> bool {\n     if simple {\n         return true;\n     }\n-    // FIXME: #9651: C-like enums should also be immediate\n-    if ty::type_is_c_like_enum(ccx.tcx, ty) {\n-        return false;\n-    }\n     match ty::get(ty).sty {\n         // FIXME: #9651: small `ty_struct` should also be immediate\n+        ty::ty_struct(def_id, ref substs) => {\n+            ty::struct_fields(tcx, def_id, substs).is_empty()\n+        }\n         ty::ty_enum(*) | ty::ty_tup(*) => {\n             let llty = sizing_type_of(ccx, ty);\n             llsize_of_alloc(ccx, llty) <= llsize_of_alloc(ccx, ccx.int_type)"}, {"sha": "098f0e3db7c90f7fd8a12cdb5591f3a7c195f0c1", "filename": "src/librustc/middle/trans/expr.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/e08391c3f1933a290ec38c6d6f6d21befba3f756/src%2Flibrustc%2Fmiddle%2Ftrans%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e08391c3f1933a290ec38c6d6f6d21befba3f756/src%2Flibrustc%2Fmiddle%2Ftrans%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fexpr.rs?ref=e08391c3f1933a290ec38c6d6f6d21befba3f756", "patch": "@@ -1727,7 +1727,9 @@ fn trans_imm_cast(bcx: @mut Block, expr: &ast::Expr,\n             (cast_enum, cast_float) => {\n                 let bcx = bcx;\n                 let repr = adt::represent_type(ccx, t_in);\n-                let lldiscrim_a = adt::trans_get_discr(bcx, repr, llexpr);\n+                let slot = Alloca(bcx, ll_t_in, \"\");\n+                Store(bcx, llexpr, slot);\n+                let lldiscrim_a = adt::trans_get_discr(bcx, repr, slot);\n                 match k_out {\n                     cast_integral => int_cast(bcx, ll_t_out,\n                                               val_ty(lldiscrim_a),"}, {"sha": "4676af3d808c6453045eef44095dac9d9fc96458", "filename": "src/librustc/middle/trans/foreign.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e08391c3f1933a290ec38c6d6f6d21befba3f756/src%2Flibrustc%2Fmiddle%2Ftrans%2Fforeign.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e08391c3f1933a290ec38c6d6f6d21befba3f756/src%2Flibrustc%2Fmiddle%2Ftrans%2Fforeign.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fforeign.rs?ref=e08391c3f1933a290ec38c6d6f6d21befba3f756", "patch": "@@ -222,7 +222,7 @@ pub fn trans_native_call(bcx: @mut Block,\n         // Ensure that we always have the Rust value indirectly,\n         // because it makes bitcasting easier.\n         if !rust_indirect {\n-            let scratch = base::alloca(bcx, arg_tys[i].ty, \"__arg\");\n+            let scratch = base::alloca(bcx, type_of::type_of(ccx, fn_sig.inputs[i]), \"__arg\");\n             Store(bcx, llarg_rust, scratch);\n             llarg_rust = scratch;\n         }"}, {"sha": "f081bef69faae971ae6e1a4943b07d811f72ac2f", "filename": "src/librustc/middle/trans/intrinsic.rs", "status": "modified", "additions": 7, "deletions": 3, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/e08391c3f1933a290ec38c6d6f6d21befba3f756/src%2Flibrustc%2Fmiddle%2Ftrans%2Fintrinsic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e08391c3f1933a290ec38c6d6f6d21befba3f756/src%2Flibrustc%2Fmiddle%2Ftrans%2Fintrinsic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fintrinsic.rs?ref=e08391c3f1933a290ec38c6d6f6d21befba3f756", "patch": "@@ -12,7 +12,7 @@\n \n use back::{abi};\n use lib::llvm::{SequentiallyConsistent, Acquire, Release, Xchg};\n-use lib::llvm::{ValueRef, Pointer};\n+use lib::llvm::{ValueRef, Pointer, Array, Struct};\n use lib;\n use middle::trans::base::*;\n use middle::trans::build::*;\n@@ -333,8 +333,12 @@ pub fn trans_intrinsic(ccx: @mut CrateContext,\n                             (Pointer, other) | (other, Pointer) if other != Pointer => {\n                                 let tmp = Alloca(bcx, llouttype, \"\");\n                                 Store(bcx, llsrcval, PointerCast(bcx, tmp, llintype.ptr_to()));\n-                                let ll_load = Load(bcx, tmp);\n-                                Ret(bcx, ll_load);\n+                                Ret(bcx, Load(bcx, tmp));\n+                            }\n+                            (Array, _) | (_, Array) | (Struct, _) | (_, Struct) => {\n+                                let tmp = Alloca(bcx, llouttype, \"\");\n+                                Store(bcx, llsrcval, PointerCast(bcx, tmp, llintype.ptr_to()));\n+                                Ret(bcx, Load(bcx, tmp));\n                             }\n                             _ => {\n                                 let llbitcast = BitCast(bcx, llsrcval, llouttype);"}]}