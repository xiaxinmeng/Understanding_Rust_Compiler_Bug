{"sha": "6e582cadc3c7f7d0eeb590d73b65bbed2360e866", "node_id": "C_kwDOAAsO6NoAKDZlNTgyY2FkYzNjN2Y3ZDBlZWI1OTBkNzNiNjViYmVkMjM2MGU4NjY", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-11-04T05:40:31Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-11-04T05:40:31Z"}, "message": "Rollup merge of #103892 - compiler-errors:afit-rustdoc, r=GuillaumeGomez\n\nProperly render asyncness for trait fns without default body\n\nWe weren't properly desugaring async fns in traits unless they had default bodies (in which case rustdoc treats them much like they came from an impl).\n\ncc ```@yoshuawuyts``` should help with https://rust-lang.zulipchat.com/#narrow/stream/330606-wg-async.2Fasync-fn-in-trait-impl/topic/type.20inside.20.60async.20fn.60.20body.20must.20be.20known.20in.20this.20context/near/306894869", "tree": {"sha": "6289c75e3fc0b225e34653f8a3780a447ce41583", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6289c75e3fc0b225e34653f8a3780a447ce41583"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6e582cadc3c7f7d0eeb590d73b65bbed2360e866", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjZKXPCRBK7hj4Ov3rIwAAS70IAHLgnl+PrNAgRAfH3hgXekip\n8rZtg1q/5bnFt0OhAo/M0Kxrg20ZdDAOr3xFqCkBMqhGoH8Gv96xS8CRh2PfRO8G\nOhs60NLehIrIJ9aHlbyYemx1ka5O1rerp6//JwieBzNjA3UtNEb09iAF6Jx3fJDf\nCPd2rb5DxY27MrMqsBZ/jkeK0xR6reTzw9qRjCoDXiFHSWtbAhUM0b0XMCgQVXwA\nL6BrpaKNTKYVfi/jCLEX0RfFuXEmOt0A+jPa50EyHbrbUX4tCym9FSV0qZeB++5v\nsKljNru77TTG8CNyZ+XvrwBK8Xn0vTIwWqcFwesQqy9u/wmzUKst1qUvdwBmjRQ=\n=jjFR\n-----END PGP SIGNATURE-----\n", "payload": "tree 6289c75e3fc0b225e34653f8a3780a447ce41583\nparent 14fdfcb38c45a563c710fa3397a2f2f3e2b6f3a4\nparent 59be5151287e29d5340d6189dea2f18206f51e02\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1667540431 +0100\ncommitter GitHub <noreply@github.com> 1667540431 +0100\n\nRollup merge of #103892 - compiler-errors:afit-rustdoc, r=GuillaumeGomez\n\nProperly render asyncness for trait fns without default body\n\nWe weren't properly desugaring async fns in traits unless they had default bodies (in which case rustdoc treats them much like they came from an impl).\n\ncc ```@yoshuawuyts``` should help with https://rust-lang.zulipchat.com/#narrow/stream/330606-wg-async.2Fasync-fn-in-trait-impl/topic/type.20inside.20.60async.20fn.60.20body.20must.20be.20known.20in.20this.20context/near/306894869\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6e582cadc3c7f7d0eeb590d73b65bbed2360e866", "html_url": "https://github.com/rust-lang/rust/commit/6e582cadc3c7f7d0eeb590d73b65bbed2360e866", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6e582cadc3c7f7d0eeb590d73b65bbed2360e866/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "14fdfcb38c45a563c710fa3397a2f2f3e2b6f3a4", "url": "https://api.github.com/repos/rust-lang/rust/commits/14fdfcb38c45a563c710fa3397a2f2f3e2b6f3a4", "html_url": "https://github.com/rust-lang/rust/commit/14fdfcb38c45a563c710fa3397a2f2f3e2b6f3a4"}, {"sha": "59be5151287e29d5340d6189dea2f18206f51e02", "url": "https://api.github.com/repos/rust-lang/rust/commits/59be5151287e29d5340d6189dea2f18206f51e02", "html_url": "https://github.com/rust-lang/rust/commit/59be5151287e29d5340d6189dea2f18206f51e02"}], "stats": {"total": 53, "additions": 35, "deletions": 18}, "files": [{"sha": "99d3bda6ebfff7308b01b3acd4aaa3410013aab7", "filename": "compiler/rustc_ty_utils/src/ty.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/6e582cadc3c7f7d0eeb590d73b65bbed2360e866/compiler%2Frustc_ty_utils%2Fsrc%2Fty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6e582cadc3c7f7d0eeb590d73b65bbed2360e866/compiler%2Frustc_ty_utils%2Fsrc%2Fty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ty_utils%2Fsrc%2Fty.rs?ref=6e582cadc3c7f7d0eeb590d73b65bbed2360e866", "patch": "@@ -413,7 +413,7 @@ fn issue33140_self_ty(tcx: TyCtxt<'_>, def_id: DefId) -> Option<Ty<'_>> {\n /// Check if a function is async.\n fn asyncness(tcx: TyCtxt<'_>, def_id: DefId) -> hir::IsAsync {\n     let node = tcx.hir().get_by_def_id(def_id.expect_local());\n-    if let Some(fn_kind) = node.fn_kind() { fn_kind.asyncness() } else { hir::IsAsync::NotAsync }\n+    node.fn_sig().map_or(hir::IsAsync::NotAsync, |sig| sig.header.asyncness)\n }\n \n /// Don't call this directly: use ``tcx.conservative_is_privately_uninhabited`` instead."}, {"sha": "d52b9a8e3fc62c6f8f8736817a039f797a4934a3", "filename": "src/librustdoc/clean/mod.rs", "status": "modified", "additions": 19, "deletions": 13, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/6e582cadc3c7f7d0eeb590d73b65bbed2360e866/src%2Flibrustdoc%2Fclean%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6e582cadc3c7f7d0eeb590d73b65bbed2360e866/src%2Flibrustdoc%2Fclean%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Fmod.rs?ref=6e582cadc3c7f7d0eeb590d73b65bbed2360e866", "patch": "@@ -880,7 +880,7 @@ fn clean_fn_or_proc_macro<'tcx>(\n             ProcMacroItem(ProcMacro { kind, helpers })\n         }\n         None => {\n-            let mut func = clean_function(cx, sig, generics, body_id);\n+            let mut func = clean_function(cx, sig, generics, FunctionArgs::Body(body_id));\n             clean_fn_decl_legacy_const_generics(&mut func, attrs);\n             FunctionItem(func)\n         }\n@@ -917,16 +917,28 @@ fn clean_fn_decl_legacy_const_generics(func: &mut Function, attrs: &[ast::Attrib\n     }\n }\n \n+enum FunctionArgs<'tcx> {\n+    Body(hir::BodyId),\n+    Names(&'tcx [Ident]),\n+}\n+\n fn clean_function<'tcx>(\n     cx: &mut DocContext<'tcx>,\n     sig: &hir::FnSig<'tcx>,\n     generics: &hir::Generics<'tcx>,\n-    body_id: hir::BodyId,\n+    args: FunctionArgs<'tcx>,\n ) -> Box<Function> {\n     let (generics, decl) = enter_impl_trait(cx, |cx| {\n         // NOTE: generics must be cleaned before args\n         let generics = clean_generics(generics, cx);\n-        let args = clean_args_from_types_and_body_id(cx, sig.decl.inputs, body_id);\n+        let args = match args {\n+            FunctionArgs::Body(body_id) => {\n+                clean_args_from_types_and_body_id(cx, sig.decl.inputs, body_id)\n+            }\n+            FunctionArgs::Names(names) => {\n+                clean_args_from_types_and_names(cx, sig.decl.inputs, names)\n+            }\n+        };\n         let mut decl = clean_fn_decl_with_args(cx, sig.decl, args);\n         if sig.header.is_async() {\n             decl.output = decl.sugared_async_return_type();\n@@ -1051,18 +1063,12 @@ fn clean_trait_item<'tcx>(trait_item: &hir::TraitItem<'tcx>, cx: &mut DocContext\n             ),\n             hir::TraitItemKind::Const(ty, None) => TyAssocConstItem(clean_ty(ty, cx)),\n             hir::TraitItemKind::Fn(ref sig, hir::TraitFn::Provided(body)) => {\n-                let m = clean_function(cx, sig, trait_item.generics, body);\n+                let m = clean_function(cx, sig, trait_item.generics, FunctionArgs::Body(body));\n                 MethodItem(m, None)\n             }\n             hir::TraitItemKind::Fn(ref sig, hir::TraitFn::Required(names)) => {\n-                let (generics, decl) = enter_impl_trait(cx, |cx| {\n-                    // NOTE: generics must be cleaned before args\n-                    let generics = clean_generics(trait_item.generics, cx);\n-                    let args = clean_args_from_types_and_names(cx, sig.decl.inputs, names);\n-                    let decl = clean_fn_decl_with_args(cx, sig.decl, args);\n-                    (generics, decl)\n-                });\n-                TyMethodItem(Box::new(Function { decl, generics }))\n+                let m = clean_function(cx, sig, trait_item.generics, FunctionArgs::Names(names));\n+                TyMethodItem(m)\n             }\n             hir::TraitItemKind::Type(bounds, Some(default)) => {\n                 let generics = enter_impl_trait(cx, |cx| clean_generics(trait_item.generics, cx));\n@@ -1099,7 +1105,7 @@ pub(crate) fn clean_impl_item<'tcx>(\n                 AssocConstItem(clean_ty(ty, cx), default)\n             }\n             hir::ImplItemKind::Fn(ref sig, body) => {\n-                let m = clean_function(cx, sig, impl_.generics, body);\n+                let m = clean_function(cx, sig, impl_.generics, FunctionArgs::Body(body));\n                 let defaultness = cx.tcx.impl_defaultness(impl_.owner_id);\n                 MethodItem(m, Some(defaultness))\n             }"}, {"sha": "f1eb438b199cea96db69ecf67bf9aea4c0a65149", "filename": "src/librustdoc/clean/types.rs", "status": "modified", "additions": 1, "deletions": 4, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/6e582cadc3c7f7d0eeb590d73b65bbed2360e866/src%2Flibrustdoc%2Fclean%2Ftypes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6e582cadc3c7f7d0eeb590d73b65bbed2360e866/src%2Flibrustdoc%2Fclean%2Ftypes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Ftypes.rs?ref=6e582cadc3c7f7d0eeb590d73b65bbed2360e866", "patch": "@@ -694,13 +694,10 @@ impl Item {\n                     asyncness: hir::IsAsync::NotAsync,\n                 }\n             }\n-            ItemKind::FunctionItem(_) | ItemKind::MethodItem(_, _) => {\n+            ItemKind::FunctionItem(_) | ItemKind::MethodItem(_, _) | ItemKind::TyMethodItem(_) => {\n                 let def_id = self.item_id.as_def_id().unwrap();\n                 build_fn_header(def_id, tcx, tcx.asyncness(def_id))\n             }\n-            ItemKind::TyMethodItem(_) => {\n-                build_fn_header(self.item_id.as_def_id().unwrap(), tcx, hir::IsAsync::NotAsync)\n-            }\n             _ => return None,\n         };\n         Some(header)"}, {"sha": "2578bc8f7a1668375716a28ad5744448e0dc2245", "filename": "src/test/rustdoc/async-trait-sig.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/6e582cadc3c7f7d0eeb590d73b65bbed2360e866/src%2Ftest%2Frustdoc%2Fasync-trait-sig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6e582cadc3c7f7d0eeb590d73b65bbed2360e866/src%2Ftest%2Frustdoc%2Fasync-trait-sig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fasync-trait-sig.rs?ref=6e582cadc3c7f7d0eeb590d73b65bbed2360e866", "patch": "@@ -0,0 +1,14 @@\n+// edition:2021\n+\n+#![feature(async_fn_in_trait)]\n+#![allow(incomplete_features)]\n+\n+pub trait Foo {\n+    // @has async_trait_sig/trait.Foo.html '//h4[@class=\"code-header\"]' \"async fn bar() -> i32\"\n+    async fn bar() -> i32;\n+\n+    // @has async_trait_sig/trait.Foo.html '//h4[@class=\"code-header\"]' \"async fn baz() -> i32\"\n+    async fn baz() -> i32 {\n+        1\n+    }\n+}"}]}