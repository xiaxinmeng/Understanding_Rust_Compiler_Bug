{"sha": "42b4c49b450decbc68f5caabb8f12a2da0ccccc0", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQyYjRjNDliNDUwZGVjYmM2OGY1Y2FhYmI4ZjEyYTJkYTBjY2NjYzA=", "commit": {"author": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-05-22T16:26:11Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2018-05-22T16:26:11Z"}, "message": "Rollup merge of #50875 - QuietMisdreavus:short-features, r=GuillaumeGomez\n\nrustdoc: use \"short form\" doc(cfg) printing even when combined with other conditionals\n\nFixes https://github.com/rust-lang/rust/issues/49334\n\nThe original \"short form\" printing was introduced when `target_feature` was added to the `doc(cfg)` handling. However, it didn't properly propagate the \"short form\" indicator if the cfg was a combination of multiple conditionals, so the linked issue happened. This changes the handling to use a bool in the original `Html` wrapper, rather than a separate wrapper struct that defers to the original one.", "tree": {"sha": "7d752d4c59f0ab8eccae569bb027cb9c296e2e55", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7d752d4c59f0ab8eccae569bb027cb9c296e2e55"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/42b4c49b450decbc68f5caabb8f12a2da0ccccc0", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJbBESjCRBK7hj4Ov3rIwAAdHIIAKN2jSEIj5lqrBgx7j6uCkql\n8DTzkC2B7Iruw7Uyd0HEzua+EV6bYEnqIbx/0xgG32jEGJ1cU2GiA+tTUs6+aZBa\nO61m3EoJnjl3PK80+4gq/qHiFsiXDLpvF+DZgKc2Md6tzSu0cOUEs4R+hibO88Pw\nN8pUCh7nHb8BgzcwhWfJEHpdIhiqiaw/xO9o5mlCYTtt7k4vsr4DbtorPgprVk0y\ndL6jUe5KZUbo9rKidtFRUeNIfDs5uu/s+KjgJNSJ2CCT8Y5ebDJlOWTzi6sKRabC\n5HFU08OGJCclNbHtP/49uvuvCZTcGJc2ZKPTB1aRSnIpp1HNHR62oeI+zpUwjhc=\n=hjau\n-----END PGP SIGNATURE-----\n", "payload": "tree 7d752d4c59f0ab8eccae569bb027cb9c296e2e55\nparent e7e3261121c2a600da27d89906c8734d8a346852\nparent d8265621d8d90cc6a37e7322c34e1969db0a26bf\nauthor kennytm <kennytm@gmail.com> 1527006371 +0800\ncommitter GitHub <noreply@github.com> 1527006371 +0800\n\nRollup merge of #50875 - QuietMisdreavus:short-features, r=GuillaumeGomez\n\nrustdoc: use \"short form\" doc(cfg) printing even when combined with other conditionals\n\nFixes https://github.com/rust-lang/rust/issues/49334\n\nThe original \"short form\" printing was introduced when `target_feature` was added to the `doc(cfg)` handling. However, it didn't properly propagate the \"short form\" indicator if the cfg was a combination of multiple conditionals, so the linked issue happened. This changes the handling to use a bool in the original `Html` wrapper, rather than a separate wrapper struct that defers to the original one.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/42b4c49b450decbc68f5caabb8f12a2da0ccccc0", "html_url": "https://github.com/rust-lang/rust/commit/42b4c49b450decbc68f5caabb8f12a2da0ccccc0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/42b4c49b450decbc68f5caabb8f12a2da0ccccc0/comments", "author": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e7e3261121c2a600da27d89906c8734d8a346852", "url": "https://api.github.com/repos/rust-lang/rust/commits/e7e3261121c2a600da27d89906c8734d8a346852", "html_url": "https://github.com/rust-lang/rust/commit/e7e3261121c2a600da27d89906c8734d8a346852"}, {"sha": "d8265621d8d90cc6a37e7322c34e1969db0a26bf", "url": "https://api.github.com/repos/rust-lang/rust/commits/d8265621d8d90cc6a37e7322c34e1969db0a26bf", "html_url": "https://github.com/rust-lang/rust/commit/d8265621d8d90cc6a37e7322c34e1969db0a26bf"}], "stats": {"total": 52, "additions": 30, "deletions": 22}, "files": [{"sha": "dceb04a7daa2babf33b510563635d948da08a63a", "filename": "src/librustdoc/clean/cfg.rs", "status": "modified", "additions": 30, "deletions": 22, "changes": 52, "blob_url": "https://github.com/rust-lang/rust/blob/42b4c49b450decbc68f5caabb8f12a2da0ccccc0/src%2Flibrustdoc%2Fclean%2Fcfg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/42b4c49b450decbc68f5caabb8f12a2da0ccccc0/src%2Flibrustdoc%2Fclean%2Fcfg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Fcfg.rs?ref=42b4c49b450decbc68f5caabb8f12a2da0ccccc0", "patch": "@@ -138,7 +138,7 @@ impl Cfg {\n \n     /// Renders the configuration for human display, as a short HTML description.\n     pub(crate) fn render_short_html(&self) -> String {\n-        let mut msg = ShortHtml(self).to_string();\n+        let mut msg = Html(self, true).to_string();\n         if self.should_capitalize_first_letter() {\n             if let Some(i) = msg.find(|c: char| c.is_ascii_alphanumeric()) {\n                 msg[i .. i+1].make_ascii_uppercase();\n@@ -155,7 +155,7 @@ impl Cfg {\n             \"on\"\n         };\n \n-        let mut msg = format!(\"This is supported {} <strong>{}</strong>\", on, Html(self));\n+        let mut msg = format!(\"This is supported {} <strong>{}</strong>\", on, Html(self, false));\n         if self.should_append_only_to_description() {\n             msg.push_str(\" only\");\n         }\n@@ -265,7 +265,9 @@ impl ops::BitOr for Cfg {\n     }\n }\n \n-struct Html<'a>(&'a Cfg);\n+/// Pretty-print wrapper for a `Cfg`. Also indicates whether the \"short-form\" rendering should be\n+/// used.\n+struct Html<'a>(&'a Cfg, bool);\n \n fn write_with_opt_paren<T: fmt::Display>(\n     fmt: &mut fmt::Formatter,\n@@ -295,12 +297,12 @@ impl<'a> fmt::Display for Html<'a> {\n                     };\n                     for (i, sub_cfg) in sub_cfgs.iter().enumerate() {\n                         fmt.write_str(if i == 0 { \"neither \" } else { separator })?;\n-                        write_with_opt_paren(fmt, !sub_cfg.is_all(), Html(sub_cfg))?;\n+                        write_with_opt_paren(fmt, !sub_cfg.is_all(), Html(sub_cfg, self.1))?;\n                     }\n                     Ok(())\n                 }\n-                ref simple @ Cfg::Cfg(..) => write!(fmt, \"non-{}\", Html(simple)),\n-                ref c => write!(fmt, \"not ({})\", Html(c)),\n+                ref simple @ Cfg::Cfg(..) => write!(fmt, \"non-{}\", Html(simple, self.1)),\n+                ref c => write!(fmt, \"not ({})\", Html(c, self.1)),\n             },\n \n             Cfg::Any(ref sub_cfgs) => {\n@@ -313,7 +315,7 @@ impl<'a> fmt::Display for Html<'a> {\n                     if i != 0 {\n                         fmt.write_str(separator)?;\n                     }\n-                    write_with_opt_paren(fmt, !sub_cfg.is_all(), Html(sub_cfg))?;\n+                    write_with_opt_paren(fmt, !sub_cfg.is_all(), Html(sub_cfg, self.1))?;\n                 }\n                 Ok(())\n             },\n@@ -323,7 +325,7 @@ impl<'a> fmt::Display for Html<'a> {\n                     if i != 0 {\n                         fmt.write_str(\" and \")?;\n                     }\n-                    write_with_opt_paren(fmt, !sub_cfg.is_simple(), Html(sub_cfg))?;\n+                    write_with_opt_paren(fmt, !sub_cfg.is_simple(), Html(sub_cfg, self.1))?;\n                 }\n                 Ok(())\n             },\n@@ -390,7 +392,11 @@ impl<'a> fmt::Display for Html<'a> {\n                     (\"target_endian\", Some(endian)) => return write!(fmt, \"{}-endian\", endian),\n                     (\"target_pointer_width\", Some(bits)) => return write!(fmt, \"{}-bit\", bits),\n                     (\"target_feature\", Some(feat)) =>\n-                        return write!(fmt, \"target feature <code>{}</code>\", feat),\n+                        if self.1 {\n+                            return write!(fmt, \"<code>{}</code>\", feat);\n+                        } else {\n+                            return write!(fmt, \"target feature <code>{}</code>\", feat);\n+                        },\n                     _ => \"\",\n                 };\n                 if !human_readable.is_empty() {\n@@ -405,19 +411,6 @@ impl<'a> fmt::Display for Html<'a> {\n     }\n }\n \n-struct ShortHtml<'a>(&'a Cfg);\n-\n-impl<'a> fmt::Display for ShortHtml<'a> {\n-    fn fmt(&self, fmt: &mut fmt::Formatter) -> fmt::Result {\n-        match *self.0 {\n-            Cfg::Cfg(ref name, Some(ref vendor)) if name == &\"target_feature\" => {\n-                write!(fmt, \"<code>{}</code>\", vendor)\n-            },\n-            ref cfg => write!(fmt, \"{}\", Html(cfg)),\n-        }\n-    }\n-}\n-\n #[cfg(test)]\n mod test {\n     use super::Cfg;\n@@ -740,6 +733,13 @@ mod test {\n                 name_value_cfg(\"target_feature\", \"sse2\").render_short_html(),\n                 \"<code>sse2</code>\"\n             );\n+            assert_eq!(\n+                (\n+                    name_value_cfg(\"target_arch\", \"x86_64\") &\n+                    name_value_cfg(\"target_feature\", \"sse2\")\n+                ).render_short_html(),\n+                \"x86-64 and <code>sse2</code>\"\n+            );\n         })\n     }\n \n@@ -818,6 +818,14 @@ mod test {\n                 name_value_cfg(\"target_feature\", \"sse2\").render_long_html(),\n                 \"This is supported with <strong>target feature <code>sse2</code></strong> only.\"\n             );\n+            assert_eq!(\n+                (\n+                    name_value_cfg(\"target_arch\", \"x86_64\") &\n+                    name_value_cfg(\"target_feature\", \"sse2\")\n+                ).render_long_html(),\n+                \"This is supported on <strong>x86-64 and target feature \\\n+                <code>sse2</code></strong> only.\"\n+            );\n         })\n     }\n }"}]}