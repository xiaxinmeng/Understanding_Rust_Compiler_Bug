{"sha": "fcf7ecd1d709c3a4ecc652349763710914271fb0", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZjZjdlY2QxZDcwOWMzYTRlY2M2NTIzNDk3NjM3MTA5MTQyNzFmYjA=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2015-05-11T21:07:42Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2015-05-19T17:52:57Z"}, "message": "mk: Add build system support for cl.exe\n\nWe have a number of support C/C++ files in Rust that we link into the standard\nlibrary and other various locations, and these all need to be built with cl.exe\ninstead of gcc.exe when targeting MSVC. This commit adds helper macros for this\nfunctionality to use different sets of programs/flags/invocations on MSVC than\non GNU-like platforms.", "tree": {"sha": "e84f9a6d0945b8a0866de2dd4ef4117937c8d3b6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e84f9a6d0945b8a0866de2dd4ef4117937c8d3b6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fcf7ecd1d709c3a4ecc652349763710914271fb0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fcf7ecd1d709c3a4ecc652349763710914271fb0", "html_url": "https://github.com/rust-lang/rust/commit/fcf7ecd1d709c3a4ecc652349763710914271fb0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fcf7ecd1d709c3a4ecc652349763710914271fb0/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b56d47cc80a7df471c0e2f96fa62a3e3983972ec", "url": "https://api.github.com/repos/rust-lang/rust/commits/b56d47cc80a7df471c0e2f96fa62a3e3983972ec", "html_url": "https://github.com/rust-lang/rust/commit/b56d47cc80a7df471c0e2f96fa62a3e3983972ec"}], "stats": {"total": 25, "additions": 20, "deletions": 5}, "files": [{"sha": "53fb8138916f557d20cb09d01d21f0d4e331c907", "filename": "mk/platform.mk", "status": "modified", "additions": 17, "deletions": 2, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/fcf7ecd1d709c3a4ecc652349763710914271fb0/mk%2Fplatform.mk", "raw_url": "https://github.com/rust-lang/rust/raw/fcf7ecd1d709c3a4ecc652349763710914271fb0/mk%2Fplatform.mk", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/mk%2Fplatform.mk?ref=fcf7ecd1d709c3a4ecc652349763710914271fb0", "patch": "@@ -133,6 +133,21 @@ endef\n $(foreach target,$(CFG_TARGET), \\\n   $(eval $(call FILTER_FLAGS,$(target))))\n \n+# Configure various macros to pass gcc or cl.exe style arguments\n+define CC_MACROS\n+  CFG_CC_INCLUDE_$(1)=-I $$(1)\n+  ifeq ($$(findstring msvc,$(1)),msvc)\n+    CFG_CC_OUTPUT_$(1)=-Fo:$$(1)\n+    CFG_CREATE_ARCHIVE_$(1)=$$(AR_$(1)) -OUT:$$(1)\n+  else\n+    CFG_CC_OUTPUT_$(1)=-o $$(1)\n+    CFG_CREATE_ARCHIVE_$(1)=$$(AR_$(1)) crus $$(1)\n+  endif\n+endef\n+\n+$(foreach target,$(CFG_TARGET), \\\n+  $(eval $(call CC_MACROS,$(target))))\n+\n \n ifeq ($(CFG_CCACHE_CPP2),1)\n   CCACHE_CPP2=1\n@@ -163,7 +178,7 @@ define CFG_MAKE_TOOLCHAIN\n   CFG_COMPILE_C_$(1) = $$(CC_$(1)) \\\n         $$(CFG_GCCISH_CFLAGS) \\\n         $$(CFG_GCCISH_CFLAGS_$(1)) \\\n-        -c -o $$(1) $$(2)\n+        -c $$(call CFG_CC_OUTPUT_$(1),$$(1)) $$(2)\n   CFG_LINK_C_$(1) = $$(CC_$(1)) \\\n         $$(CFG_GCCISH_LINK_FLAGS) -o $$(1) \\\n         $$(CFG_GCCISH_LINK_FLAGS_$(1)) \\\n@@ -174,7 +189,7 @@ define CFG_MAKE_TOOLCHAIN\n         $$(CFG_GCCISH_CXXFLAGS) \\\n         $$(CFG_GCCISH_CFLAGS_$(1)) \\\n         $$(CFG_GCCISH_CXXFLAGS_$(1)) \\\n-        -c -o $$(1) $$(2)\n+        -c $$(call CFG_CC_OUTPUT_$(1),$$(1)) $$(2)\n   CFG_LINK_CXX_$(1) = $$(CXX_$(1)) \\\n         $$(CFG_GCCISH_LINK_FLAGS) -o $$(1) \\\n         $$(CFG_GCCISH_LINK_FLAGS_$(1)) \\"}, {"sha": "3d3e4c8866c6e7ad8ed371aec318a88aac196687", "filename": "mk/rt.mk", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/fcf7ecd1d709c3a4ecc652349763710914271fb0/mk%2Frt.mk", "raw_url": "https://github.com/rust-lang/rust/raw/fcf7ecd1d709c3a4ecc652349763710914271fb0/mk%2Frt.mk", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/mk%2Frt.mk?ref=fcf7ecd1d709c3a4ecc652349763710914271fb0", "patch": "@@ -81,8 +81,8 @@ $$(RT_OUTPUT_DIR_$(1))/%.o: $(S)src/rt/%.c $$(MKFILE_DEPS)\n \t@mkdir -p $$(@D)\n \t@$$(call E, compile: $$@)\n \t$$(Q)$$(call CFG_COMPILE_C_$(1), $$@, \\\n-\t\t-I $$(S)src/rt/hoedown/src \\\n-\t\t-I $$(S)src/rt \\\n+\t\t$$(call CFG_CC_INCLUDE_$(1),$$(S)src/rt/hoedown/src) \\\n+\t\t$$(call CFG_CC_INCLUDE_$(1),$$(S)src/rt) \\\n                  $$(RUNTIME_CFLAGS_$(1))) $$<\n \n $$(RT_OUTPUT_DIR_$(1))/%.o: $(S)src/rt/%.S $$(MKFILE_DEPS) \\\n@@ -109,7 +109,7 @@ OBJS_$(2)_$(1) := $$(OBJS_$(2)_$(1):.S=.o)\n NATIVE_$(2)_$(1) := $$(call CFG_STATIC_LIB_NAME_$(1),$(2))\n $$(RT_OUTPUT_DIR_$(1))/$$(NATIVE_$(2)_$(1)): $$(OBJS_$(2)_$(1))\n \t@$$(call E, link: $$@)\n-\t$$(Q)$$(AR_$(1)) rcs $$@ $$^\n+\t$$(Q)$$(call CFG_CREATE_ARCHIVE_$(1),$$@) $$^\n \n endef\n "}]}