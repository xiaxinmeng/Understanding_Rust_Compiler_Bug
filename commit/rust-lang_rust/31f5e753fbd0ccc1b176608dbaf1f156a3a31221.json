{"sha": "31f5e753fbd0ccc1b176608dbaf1f156a3a31221", "node_id": "C_kwDOAAsO6NoAKDMxZjVlNzUzZmJkMGNjYzFiMTc2NjA4ZGJhZjFmMTU2YTNhMzEyMjE", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-12-28T13:40:00Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-12-28T13:40:00Z"}, "message": "Rollup merge of #106172 - estebank:suggest-impl-trait, r=compiler-errors\n\nSuggest `impl Iterator` when possible for `_` return type\n\nAddress #106096.", "tree": {"sha": "827ee55703b6c499e27c2ebf81283e5f300ba706", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/827ee55703b6c499e27c2ebf81283e5f300ba706"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/31f5e753fbd0ccc1b176608dbaf1f156a3a31221", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjrEcwCRBK7hj4Ov3rIwAAg3cIAH0JVhbtkiG4/ju0txCAmyou\nYHxuVgge1sbSVHYfWRAuAXZz3c2eqOumh5yXcwFofn58qIpLriCw4VtUk+FZrEj5\n6ge/FlxoRmbmUO4Se3tHkRX6ArXWnoG3k+p5afFiQskvO4HdkELEBI+5v2/WPrCt\nAXeRfDDvsoIxXnDwfNKBuKul8aaDroCa+iBkwbr3MxuHlq7/AgJWT/Z8T0Ko19Td\nWen8Dx3AoxCYANkSMcbtCr+IM3mqfedq0mGMHAlfX1/XL20fxgCEXmoHwSoJJEQU\nyXBO1IwTHTVk8zxL9OobogM+OQiQHT/ofLssYT8vU8pFmbOEREFrxT7ugbrD3j8=\n=1TEf\n-----END PGP SIGNATURE-----\n", "payload": "tree 827ee55703b6c499e27c2ebf81283e5f300ba706\nparent f33ea418e2f3b59421af3ab2e571abb34c730d9f\nparent b400bde52a2508f966133c8cf9445ce570f08248\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1672234800 +0100\ncommitter GitHub <noreply@github.com> 1672234800 +0100\n\nRollup merge of #106172 - estebank:suggest-impl-trait, r=compiler-errors\n\nSuggest `impl Iterator` when possible for `_` return type\n\nAddress #106096.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/31f5e753fbd0ccc1b176608dbaf1f156a3a31221", "html_url": "https://github.com/rust-lang/rust/commit/31f5e753fbd0ccc1b176608dbaf1f156a3a31221", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/31f5e753fbd0ccc1b176608dbaf1f156a3a31221/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f33ea418e2f3b59421af3ab2e571abb34c730d9f", "url": "https://api.github.com/repos/rust-lang/rust/commits/f33ea418e2f3b59421af3ab2e571abb34c730d9f", "html_url": "https://github.com/rust-lang/rust/commit/f33ea418e2f3b59421af3ab2e571abb34c730d9f"}, {"sha": "b400bde52a2508f966133c8cf9445ce570f08248", "url": "https://api.github.com/repos/rust-lang/rust/commits/b400bde52a2508f966133c8cf9445ce570f08248", "html_url": "https://github.com/rust-lang/rust/commit/b400bde52a2508f966133c8cf9445ce570f08248"}], "stats": {"total": 111, "additions": 101, "deletions": 10}, "files": [{"sha": "9e46968c408197fff3b87b99809ec66fc05d0a28", "filename": "compiler/rustc_hir_analysis/src/collect.rs", "status": "modified", "additions": 60, "deletions": 1, "changes": 61, "blob_url": "https://github.com/rust-lang/rust/blob/31f5e753fbd0ccc1b176608dbaf1f156a3a31221/compiler%2Frustc_hir_analysis%2Fsrc%2Fcollect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/31f5e753fbd0ccc1b176608dbaf1f156a3a31221/compiler%2Frustc_hir_analysis%2Fsrc%2Fcollect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_analysis%2Fsrc%2Fcollect.rs?ref=31f5e753fbd0ccc1b176608dbaf1f156a3a31221", "patch": "@@ -24,14 +24,18 @@ use rustc_hir as hir;\n use rustc_hir::def_id::{DefId, LocalDefId};\n use rustc_hir::intravisit::{self, Visitor};\n use rustc_hir::{GenericParamKind, Node};\n+use rustc_infer::infer::type_variable::{TypeVariableOrigin, TypeVariableOriginKind};\n+use rustc_infer::infer::TyCtxtInferExt;\n use rustc_middle::hir::nested_filter;\n use rustc_middle::ty::query::Providers;\n use rustc_middle::ty::util::{Discr, IntTypeExt};\n use rustc_middle::ty::{self, AdtKind, Const, IsSuggestable, ToPredicate, Ty, TyCtxt};\n use rustc_span::symbol::{kw, sym, Ident, Symbol};\n use rustc_span::Span;\n use rustc_target::spec::abi;\n+use rustc_trait_selection::infer::InferCtxtExt;\n use rustc_trait_selection::traits::error_reporting::suggestions::NextTypeParamName;\n+use rustc_trait_selection::traits::ObligationCtxt;\n use std::iter;\n \n mod generics_of;\n@@ -1224,7 +1228,17 @@ fn infer_return_ty_for_fn_sig<'tcx>(\n                 // to prevent the user from getting a papercut while trying to use the unique closure\n                 // syntax (e.g. `[closure@src/lib.rs:2:5: 2:9]`).\n                 diag.help(\"consider using an `Fn`, `FnMut`, or `FnOnce` trait bound\");\n-                diag.note(\"for more information on `Fn` traits and closure types, see https://doc.rust-lang.org/book/ch13-01-closures.html\");\n+                diag.note(\n+                    \"for more information on `Fn` traits and closure types, see \\\n+                     https://doc.rust-lang.org/book/ch13-01-closures.html\",\n+                );\n+            } else if let Some(i_ty) = suggest_impl_iterator(tcx, ret_ty, ty.span, hir_id, def_id) {\n+                diag.span_suggestion(\n+                    ty.span,\n+                    \"replace with an appropriate return type\",\n+                    format!(\"impl Iterator<Item = {}>\", i_ty),\n+                    Applicability::MachineApplicable,\n+                );\n             }\n             diag.emit();\n \n@@ -1242,6 +1256,51 @@ fn infer_return_ty_for_fn_sig<'tcx>(\n     }\n }\n \n+fn suggest_impl_iterator<'tcx>(\n+    tcx: TyCtxt<'tcx>,\n+    ret_ty: Ty<'tcx>,\n+    span: Span,\n+    hir_id: hir::HirId,\n+    def_id: LocalDefId,\n+) -> Option<Ty<'tcx>> {\n+    let Some(iter_trait) = tcx.get_diagnostic_item(sym::Iterator) else { return None; };\n+    let Some(iterator_item) = tcx.get_diagnostic_item(sym::IteratorItem) else { return None; };\n+    if !tcx\n+        .infer_ctxt()\n+        .build()\n+        .type_implements_trait(iter_trait, [ret_ty], tcx.param_env(def_id))\n+        .must_apply_modulo_regions()\n+    {\n+        return None;\n+    }\n+    let infcx = tcx.infer_ctxt().build();\n+    let ocx = ObligationCtxt::new_in_snapshot(&infcx);\n+    // Find the type of `Iterator::Item`.\n+    let origin = TypeVariableOrigin { kind: TypeVariableOriginKind::TypeInference, span };\n+    let ty_var = infcx.next_ty_var(origin);\n+    let projection = ty::Binder::dummy(ty::PredicateKind::Clause(ty::Clause::Projection(\n+        ty::ProjectionPredicate {\n+            projection_ty: tcx.mk_alias_ty(iterator_item, tcx.mk_substs([ret_ty.into()].iter())),\n+            term: ty_var.into(),\n+        },\n+    )));\n+    // Add `<ret_ty as Iterator>::Item = _` obligation.\n+    ocx.register_obligation(crate::traits::Obligation::misc(\n+        tcx,\n+        span,\n+        hir_id,\n+        tcx.param_env(def_id),\n+        projection,\n+    ));\n+    if ocx.select_where_possible().is_empty()\n+        && let item_ty = infcx.resolve_vars_if_possible(ty_var)\n+        && item_ty.is_suggestable(tcx, false)\n+    {\n+        return Some(item_ty);\n+    }\n+    None\n+}\n+\n fn impl_trait_ref(tcx: TyCtxt<'_>, def_id: DefId) -> Option<ty::TraitRef<'_>> {\n     let icx = ItemCtxt::new(tcx, def_id);\n     let item = tcx.hir().expect_item(def_id.expect_local());"}, {"sha": "4bd55a5483147e6c3709f91239dbf31a132c7790", "filename": "compiler/rustc_hir_analysis/src/collect/type_of.rs", "status": "modified", "additions": 7, "deletions": 6, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/31f5e753fbd0ccc1b176608dbaf1f156a3a31221/compiler%2Frustc_hir_analysis%2Fsrc%2Fcollect%2Ftype_of.rs", "raw_url": "https://github.com/rust-lang/rust/raw/31f5e753fbd0ccc1b176608dbaf1f156a3a31221/compiler%2Frustc_hir_analysis%2Fsrc%2Fcollect%2Ftype_of.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_analysis%2Fsrc%2Fcollect%2Ftype_of.rs?ref=31f5e753fbd0ccc1b176608dbaf1f156a3a31221", "patch": "@@ -5,6 +5,7 @@ use rustc_hir::intravisit;\n use rustc_hir::intravisit::Visitor;\n use rustc_hir::{HirId, Node};\n use rustc_middle::hir::nested_filter;\n+use rustc_middle::ty::print::with_forced_trimmed_paths;\n use rustc_middle::ty::subst::InternalSubsts;\n use rustc_middle::ty::util::IntTypeExt;\n use rustc_middle::ty::{self, DefIdTree, Ty, TyCtxt, TypeFolder, TypeSuperFoldable, TypeVisitable};\n@@ -907,10 +908,10 @@ fn infer_placeholder_type<'a>(\n                         Applicability::MachineApplicable,\n                     );\n                 } else {\n-                    err.span_note(\n+                    with_forced_trimmed_paths!(err.span_note(\n                         tcx.hir().body(body_id).value.span,\n-                        &format!(\"however, the inferred type `{}` cannot be named\", ty),\n-                    );\n+                        &format!(\"however, the inferred type `{ty}` cannot be named\"),\n+                    ));\n                 }\n             }\n \n@@ -931,10 +932,10 @@ fn infer_placeholder_type<'a>(\n                         Applicability::MaybeIncorrect,\n                     );\n                 } else {\n-                    diag.span_note(\n+                    with_forced_trimmed_paths!(diag.span_note(\n                         tcx.hir().body(body_id).value.span,\n-                        &format!(\"however, the inferred type `{}` cannot be named\", ty),\n-                    );\n+                        &format!(\"however, the inferred type `{ty}` cannot be named\"),\n+                    ));\n                 }\n             }\n "}, {"sha": "c450c4da9a883a2df2097e705773dbf2fa86622e", "filename": "compiler/rustc_span/src/symbol.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/31f5e753fbd0ccc1b176608dbaf1f156a3a31221/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs", "raw_url": "https://github.com/rust-lang/rust/raw/31f5e753fbd0ccc1b176608dbaf1f156a3a31221/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs?ref=31f5e753fbd0ccc1b176608dbaf1f156a3a31221", "patch": "@@ -213,6 +213,7 @@ symbols! {\n         Is,\n         ItemContext,\n         Iterator,\n+        IteratorItem,\n         Layout,\n         Left,\n         LinkedList,"}, {"sha": "b4863bb2589fd46615c3da132d27f5dad29bc706", "filename": "library/core/src/iter/traits/iterator.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/31f5e753fbd0ccc1b176608dbaf1f156a3a31221/library%2Fcore%2Fsrc%2Fiter%2Ftraits%2Fiterator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/31f5e753fbd0ccc1b176608dbaf1f156a3a31221/library%2Fcore%2Fsrc%2Fiter%2Ftraits%2Fiterator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fiter%2Ftraits%2Fiterator.rs?ref=31f5e753fbd0ccc1b176608dbaf1f156a3a31221", "patch": "@@ -66,6 +66,7 @@ fn _assert_is_object_safe(_: &dyn Iterator<Item = ()>) {}\n #[must_use = \"iterators are lazy and do nothing unless consumed\"]\n pub trait Iterator {\n     /// The type of the elements being iterated over.\n+    #[rustc_diagnostic_item = \"IteratorItem\"]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n     type Item;\n "}, {"sha": "24bedb5297b1fe9241d4992471c5e2773d859a02", "filename": "src/test/ui/suggestions/unnamable-types.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/31f5e753fbd0ccc1b176608dbaf1f156a3a31221/src%2Ftest%2Fui%2Fsuggestions%2Funnamable-types.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/31f5e753fbd0ccc1b176608dbaf1f156a3a31221/src%2Ftest%2Fui%2Fsuggestions%2Funnamable-types.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggestions%2Funnamable-types.stderr?ref=31f5e753fbd0ccc1b176608dbaf1f156a3a31221", "patch": "@@ -19,7 +19,7 @@ error[E0121]: the placeholder `_` is not allowed within types on item signatures\n LL | const C: _ = || 42;\n    |          ^ not allowed in type signatures\n    |\n-note: however, the inferred type `[closure@$DIR/unnamable-types.rs:17:14: 17:16]` cannot be named\n+note: however, the inferred type `[closure@unnamable-types.rs:17:14]` cannot be named\n   --> $DIR/unnamable-types.rs:17:14\n    |\n LL | const C: _ = || 42;\n@@ -31,7 +31,7 @@ error: missing type for `const` item\n LL | const D = S { t: { let i = 0; move || -> i32 { i } } };\n    |        ^\n    |\n-note: however, the inferred type `S<[closure@$DIR/unnamable-types.rs:23:31: 23:45]>` cannot be named\n+note: however, the inferred type `S<[closure@unnamable-types.rs:23:31]>` cannot be named\n   --> $DIR/unnamable-types.rs:23:11\n    |\n LL | const D = S { t: { let i = 0; move || -> i32 { i } } };"}, {"sha": "b96c5271339598331be6f2479780a645b9f9a32c", "filename": "src/test/ui/typeck/typeck_type_placeholder_item.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/31f5e753fbd0ccc1b176608dbaf1f156a3a31221/src%2Ftest%2Fui%2Ftypeck%2Ftypeck_type_placeholder_item.rs", "raw_url": "https://github.com/rust-lang/rust/raw/31f5e753fbd0ccc1b176608dbaf1f156a3a31221/src%2Ftest%2Fui%2Ftypeck%2Ftypeck_type_placeholder_item.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Ftypeck_type_placeholder_item.rs?ref=31f5e753fbd0ccc1b176608dbaf1f156a3a31221", "patch": "@@ -220,3 +220,11 @@ fn value() -> Option<&'static _> {\n \n const _: Option<_> = map(value);\n //~^ ERROR the placeholder `_` is not allowed within types on item signatures for constants\n+\n+fn evens_squared(n: usize) -> _ {\n+//~^ ERROR the placeholder `_` is not allowed within types on item signatures for return types\n+    (1..n).filter(|x| x % 2 == 0).map(|x| x * x)\n+}\n+\n+const _: _ = (1..10).filter(|x| x % 2 == 0).map(|x| x * x);\n+//~^ ERROR the placeholder `_` is not allowed within types on item signatures for constants"}, {"sha": "bc02547c65eb8d89f4954ea75a31166f7d5de7b1", "filename": "src/test/ui/typeck/typeck_type_placeholder_item.stderr", "status": "modified", "additions": 22, "deletions": 1, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/31f5e753fbd0ccc1b176608dbaf1f156a3a31221/src%2Ftest%2Fui%2Ftypeck%2Ftypeck_type_placeholder_item.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/31f5e753fbd0ccc1b176608dbaf1f156a3a31221/src%2Ftest%2Fui%2Ftypeck%2Ftypeck_type_placeholder_item.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Ftypeck_type_placeholder_item.stderr?ref=31f5e753fbd0ccc1b176608dbaf1f156a3a31221", "patch": "@@ -428,6 +428,27 @@ LL | const _: Option<_> = map(value);\n    |          not allowed in type signatures\n    |          help: replace with the correct type: `Option<u8>`\n \n+error[E0121]: the placeholder `_` is not allowed within types on item signatures for return types\n+  --> $DIR/typeck_type_placeholder_item.rs:224:31\n+   |\n+LL | fn evens_squared(n: usize) -> _ {\n+   |                               ^\n+   |                               |\n+   |                               not allowed in type signatures\n+   |                               help: replace with an appropriate return type: `impl Iterator<Item = usize>`\n+\n+error[E0121]: the placeholder `_` is not allowed within types on item signatures for constants\n+  --> $DIR/typeck_type_placeholder_item.rs:229:10\n+   |\n+LL | const _: _ = (1..10).filter(|x| x % 2 == 0).map(|x| x * x);\n+   |          ^ not allowed in type signatures\n+   |\n+note: however, the inferred type `Map<Filter<Range<i32>, [closure@typeck_type_placeholder_item.rs:229:29]>, [closure@typeck_type_placeholder_item.rs:229:49]>` cannot be named\n+  --> $DIR/typeck_type_placeholder_item.rs:229:14\n+   |\n+LL | const _: _ = (1..10).filter(|x| x % 2 == 0).map(|x| x * x);\n+   |              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n error[E0121]: the placeholder `_` is not allowed within types on item signatures for functions\n   --> $DIR/typeck_type_placeholder_item.rs:140:31\n    |\n@@ -636,7 +657,7 @@ LL |     const D: _ = 42;\n    |              not allowed in type signatures\n    |              help: replace with the correct type: `i32`\n \n-error: aborting due to 69 previous errors\n+error: aborting due to 71 previous errors\n \n Some errors have detailed explanations: E0121, E0282, E0403.\n For more information about an error, try `rustc --explain E0121`."}]}