{"sha": "03da9dbea05a87b9cdf17668881cbc473dcaf237", "node_id": "C_kwDOAAsO6NoAKDAzZGE5ZGJlYTA1YTg3YjljZGYxNzY2ODg4MWNiYzQ3M2RjYWYyMzc", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-04-28T20:56:46Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-04-28T20:56:46Z"}, "message": "Rollup merge of #110944 - RalfJung:offset, r=compiler-errors\n\nshare BinOp::Offset between CTFE and Miri\n\nr? ``@oli-obk``", "tree": {"sha": "2870392f1aae7bbf72f9d752a71f4155cf38d457", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2870392f1aae7bbf72f9d752a71f4155cf38d457"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/03da9dbea05a87b9cdf17668881cbc473dcaf237", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkTDMOCRBK7hj4Ov3rIwAAcqoIAK6yLm3cEEMPd8FZdy3yISPq\nuyAER+FyrhT08uBdqpHDVbKFVYot8151Iu/4LXVBrHjDqhigXqMzCpQ4dR8cm9oO\nI4C7YfvG5igqQUSGUohZ9JioxRiQSweoF/+F3/408nd7Ccr76nn8OC6+7lUIa5wQ\ndvu9nf3N9pKhwbxRDcbaJt4iSkOkzo1cHpM8v+uiWOpkrmFmN3fGfFPvSd41V+g8\nGs5UADH745PtvTJ7RwnJ02QoBktcP8/rVWbByeODx3n+H6ErsxfTk/DZIVtS7E38\nNaKM6o+hXmKlyjTJkV/x1NZCgog6jdPyTj0zbC9pC/LoJq3cCuR9LlMyif6Sb2s=\n=59ER\n-----END PGP SIGNATURE-----\n", "payload": "tree 2870392f1aae7bbf72f9d752a71f4155cf38d457\nparent 37076ebbe51cd5fe3c6013dc47870ded9efdf497\nparent 586d17d330fa320deb1c2d738fb90d1235a7ade1\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1682715406 +0200\ncommitter GitHub <noreply@github.com> 1682715406 +0200\n\nRollup merge of #110944 - RalfJung:offset, r=compiler-errors\n\nshare BinOp::Offset between CTFE and Miri\n\nr? ``@oli-obk``\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/03da9dbea05a87b9cdf17668881cbc473dcaf237", "html_url": "https://github.com/rust-lang/rust/commit/03da9dbea05a87b9cdf17668881cbc473dcaf237", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/03da9dbea05a87b9cdf17668881cbc473dcaf237/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "37076ebbe51cd5fe3c6013dc47870ded9efdf497", "url": "https://api.github.com/repos/rust-lang/rust/commits/37076ebbe51cd5fe3c6013dc47870ded9efdf497", "html_url": "https://github.com/rust-lang/rust/commit/37076ebbe51cd5fe3c6013dc47870ded9efdf497"}, {"sha": "586d17d330fa320deb1c2d738fb90d1235a7ade1", "url": "https://api.github.com/repos/rust-lang/rust/commits/586d17d330fa320deb1c2d738fb90d1235a7ade1", "html_url": "https://github.com/rust-lang/rust/commit/586d17d330fa320deb1c2d738fb90d1235a7ade1"}], "stats": {"total": 54, "additions": 29, "deletions": 25}, "files": [{"sha": "814b67b46ec7a239e726a45add6304d62f662d03", "filename": "compiler/rustc_const_eval/src/const_eval/machine.rs", "status": "modified", "additions": 4, "deletions": 13, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/03da9dbea05a87b9cdf17668881cbc473dcaf237/compiler%2Frustc_const_eval%2Fsrc%2Fconst_eval%2Fmachine.rs", "raw_url": "https://github.com/rust-lang/rust/raw/03da9dbea05a87b9cdf17668881cbc473dcaf237/compiler%2Frustc_const_eval%2Fsrc%2Fconst_eval%2Fmachine.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Fconst_eval%2Fmachine.rs?ref=03da9dbea05a87b9cdf17668881cbc473dcaf237", "patch": "@@ -559,20 +559,11 @@ impl<'mir, 'tcx> interpret::Machine<'mir, 'tcx> for CompileTimeInterpreter<'mir,\n     }\n \n     fn binary_ptr_op(\n-        ecx: &InterpCx<'mir, 'tcx, Self>,\n-        bin_op: mir::BinOp,\n-        left: &ImmTy<'tcx>,\n-        right: &ImmTy<'tcx>,\n+        _ecx: &InterpCx<'mir, 'tcx, Self>,\n+        _bin_op: mir::BinOp,\n+        _left: &ImmTy<'tcx>,\n+        _right: &ImmTy<'tcx>,\n     ) -> InterpResult<'tcx, (Scalar, bool, Ty<'tcx>)> {\n-        if bin_op == mir::BinOp::Offset {\n-            let ptr = left.to_scalar().to_pointer(ecx)?;\n-            let offset_count = right.to_scalar().to_target_isize(ecx)?;\n-            let pointee_ty = left.layout.ty.builtin_deref(true).unwrap().ty;\n-\n-            let offset_ptr = ecx.ptr_offset_inbounds(ptr, pointee_ty, offset_count)?;\n-            return Ok((Scalar::from_maybe_pointer(offset_ptr, ecx), false, left.layout.ty));\n-        }\n-\n         throw_unsup_format!(\"pointer arithmetic or comparison is not supported at compile-time\");\n     }\n "}, {"sha": "7186148daf0ba80c8f73abcf1abe28db2698a136", "filename": "compiler/rustc_const_eval/src/interpret/operator.rs", "status": "modified", "additions": 25, "deletions": 1, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/03da9dbea05a87b9cdf17668881cbc473dcaf237/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Foperator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/03da9dbea05a87b9cdf17668881cbc473dcaf237/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Foperator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Finterpret%2Foperator.rs?ref=03da9dbea05a87b9cdf17668881cbc473dcaf237", "patch": "@@ -299,6 +299,30 @@ impl<'mir, 'tcx: 'mir, M: Machine<'mir, 'tcx>> InterpCx<'mir, 'tcx, M> {\n         Ok((val, false, ty))\n     }\n \n+    fn binary_ptr_op(\n+        &self,\n+        bin_op: mir::BinOp,\n+        left: &ImmTy<'tcx, M::Provenance>,\n+        right: &ImmTy<'tcx, M::Provenance>,\n+    ) -> InterpResult<'tcx, (Scalar<M::Provenance>, bool, Ty<'tcx>)> {\n+        use rustc_middle::mir::BinOp::*;\n+\n+        match bin_op {\n+            // Pointer ops that are always supported.\n+            Offset => {\n+                let ptr = left.to_scalar().to_pointer(self)?;\n+                let offset_count = right.to_scalar().to_target_isize(self)?;\n+                let pointee_ty = left.layout.ty.builtin_deref(true).unwrap().ty;\n+\n+                let offset_ptr = self.ptr_offset_inbounds(ptr, pointee_ty, offset_count)?;\n+                Ok((Scalar::from_maybe_pointer(offset_ptr, self), false, left.layout.ty))\n+            }\n+\n+            // Fall back to machine hook so Miri can support more pointer ops.\n+            _ => M::binary_ptr_op(self, bin_op, left, right),\n+        }\n+    }\n+\n     /// Returns the result of the specified operation, whether it overflowed, and\n     /// the result type.\n     pub fn overflowing_binary_op(\n@@ -368,7 +392,7 @@ impl<'mir, 'tcx: 'mir, M: Machine<'mir, 'tcx>> InterpCx<'mir, 'tcx, M> {\n                     right.layout.ty\n                 );\n \n-                M::binary_ptr_op(self, bin_op, left, right)\n+                self.binary_ptr_op(bin_op, left, right)\n             }\n             _ => span_bug!(\n                 self.cur_span(),"}, {"sha": "368aa2bacdc8ca4673473965cabf35dbcd03aa0a", "filename": "src/tools/miri/src/operator.rs", "status": "modified", "additions": 0, "deletions": 11, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/03da9dbea05a87b9cdf17668881cbc473dcaf237/src%2Ftools%2Fmiri%2Fsrc%2Foperator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/03da9dbea05a87b9cdf17668881cbc473dcaf237/src%2Ftools%2Fmiri%2Fsrc%2Foperator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fmiri%2Fsrc%2Foperator.rs?ref=03da9dbea05a87b9cdf17668881cbc473dcaf237", "patch": "@@ -53,17 +53,6 @@ impl<'mir, 'tcx> EvalContextExt<'tcx> for super::MiriInterpCx<'mir, 'tcx> {\n                 (Scalar::from_bool(res), false, self.tcx.types.bool)\n             }\n \n-            Offset => {\n-                assert!(left.layout.ty.is_unsafe_ptr());\n-                let ptr = left.to_scalar().to_pointer(self)?;\n-                let offset = right.to_scalar().to_target_isize(self)?;\n-\n-                let pointee_ty =\n-                    left.layout.ty.builtin_deref(true).expect(\"Offset called on non-ptr type\").ty;\n-                let ptr = self.ptr_offset_inbounds(ptr, pointee_ty, offset)?;\n-                (Scalar::from_maybe_pointer(ptr, self), false, left.layout.ty)\n-            }\n-\n             // Some more operations are possible with atomics.\n             // The return value always has the provenance of the *left* operand.\n             Add | Sub | BitOr | BitAnd | BitXor => {"}]}