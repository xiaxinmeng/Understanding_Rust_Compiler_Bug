{"sha": "298f1397982a4e7cf718931bff399fcc6bffd9e1", "node_id": "C_kwDOAAsO6NoAKDI5OGYxMzk3OTgyYTRlN2NmNzE4OTMxYmZmMzk5ZmNjNmJmZmQ5ZTE", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-02-12T21:57:49Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-02-12T21:57:49Z"}, "message": "Auto merge of #10317 - m-ou-se:suspicious-command-arg-space, r=Manishearth\n\nAdd `suspicious_command_arg_space` lint\n\nFixes #10316\n\n---\n\nchangelog: New lint: [`suspicious_command_arg_space`]\n[#10317](https://github.com/rust-lang/rust-clippy/pull/10317)\n<!-- changelog_checked -->", "tree": {"sha": "7b0d5212a0d700529e2e4e6dd56869b4904ea9e0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7b0d5212a0d700529e2e4e6dd56869b4904ea9e0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/298f1397982a4e7cf718931bff399fcc6bffd9e1", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/298f1397982a4e7cf718931bff399fcc6bffd9e1", "html_url": "https://github.com/rust-lang/rust/commit/298f1397982a4e7cf718931bff399fcc6bffd9e1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/298f1397982a4e7cf718931bff399fcc6bffd9e1/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6f353fdf0a4ea505dd70c315478e29dce5e873e0", "url": "https://api.github.com/repos/rust-lang/rust/commits/6f353fdf0a4ea505dd70c315478e29dce5e873e0", "html_url": "https://github.com/rust-lang/rust/commit/6f353fdf0a4ea505dd70c315478e29dce5e873e0"}, {"sha": "1f77866991568557e69e2135369ab2a512052a6b", "url": "https://api.github.com/repos/rust-lang/rust/commits/1f77866991568557e69e2135369ab2a512052a6b", "html_url": "https://github.com/rust-lang/rust/commit/1f77866991568557e69e2135369ab2a512052a6b"}], "stats": {"total": 108, "additions": 108, "deletions": 0}, "files": [{"sha": "30727beb8e7ffd124841e4dabcfd90d5caa50f2a", "filename": "CHANGELOG.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/298f1397982a4e7cf718931bff399fcc6bffd9e1/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/298f1397982a4e7cf718931bff399fcc6bffd9e1/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=298f1397982a4e7cf718931bff399fcc6bffd9e1", "patch": "@@ -4764,6 +4764,7 @@ Released 2018-09-13\n [`suboptimal_flops`]: https://rust-lang.github.io/rust-clippy/master/index.html#suboptimal_flops\n [`suspicious_arithmetic_impl`]: https://rust-lang.github.io/rust-clippy/master/index.html#suspicious_arithmetic_impl\n [`suspicious_assignment_formatting`]: https://rust-lang.github.io/rust-clippy/master/index.html#suspicious_assignment_formatting\n+[`suspicious_command_arg_space`]: https://rust-lang.github.io/rust-clippy/master/index.html#suspicious_command_arg_space\n [`suspicious_else_formatting`]: https://rust-lang.github.io/rust-clippy/master/index.html#suspicious_else_formatting\n [`suspicious_map`]: https://rust-lang.github.io/rust-clippy/master/index.html#suspicious_map\n [`suspicious_op_assign_impl`]: https://rust-lang.github.io/rust-clippy/master/index.html#suspicious_op_assign_impl"}, {"sha": "c1feabf05aafdfddc3f2020e838fd9ed10035004", "filename": "clippy_lints/src/declared_lints.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/298f1397982a4e7cf718931bff399fcc6bffd9e1/clippy_lints%2Fsrc%2Fdeclared_lints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/298f1397982a4e7cf718931bff399fcc6bffd9e1/clippy_lints%2Fsrc%2Fdeclared_lints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fdeclared_lints.rs?ref=298f1397982a4e7cf718931bff399fcc6bffd9e1", "patch": "@@ -378,6 +378,7 @@ pub(crate) static LINTS: &[&crate::LintInfo] = &[\n     crate::methods::SKIP_WHILE_NEXT_INFO,\n     crate::methods::STABLE_SORT_PRIMITIVE_INFO,\n     crate::methods::STRING_EXTEND_CHARS_INFO,\n+    crate::methods::SUSPICIOUS_COMMAND_ARG_SPACE_INFO,\n     crate::methods::SUSPICIOUS_MAP_INFO,\n     crate::methods::SUSPICIOUS_SPLITN_INFO,\n     crate::methods::SUSPICIOUS_TO_OWNED_INFO,"}, {"sha": "d8c018f7591a95d3b6174c64d30826d821eaaf72", "filename": "clippy_lints/src/methods/mod.rs", "status": "modified", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/298f1397982a4e7cf718931bff399fcc6bffd9e1/clippy_lints%2Fsrc%2Fmethods%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/298f1397982a4e7cf718931bff399fcc6bffd9e1/clippy_lints%2Fsrc%2Fmethods%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmethods%2Fmod.rs?ref=298f1397982a4e7cf718931bff399fcc6bffd9e1", "patch": "@@ -80,6 +80,7 @@ mod skip_while_next;\n mod stable_sort_primitive;\n mod str_splitn;\n mod string_extend_chars;\n+mod suspicious_command_arg_space;\n mod suspicious_map;\n mod suspicious_splitn;\n mod suspicious_to_owned;\n@@ -3162,6 +3163,32 @@ declare_clippy_lint! {\n     \"collecting an iterator when collect is not needed\"\n }\n \n+declare_clippy_lint! {\n+    /// ### What it does\n+    ///\n+    /// Checks for `Command::arg()` invocations that look like they\n+    /// should be multiple arguments instead, such as `arg(\"-t ext2\")`.\n+    ///\n+    /// ### Why is this bad?\n+    ///\n+    /// `Command::arg()` does not split arguments by space. An argument like `arg(\"-t ext2\")`\n+    /// will be passed as a single argument to the command,\n+    /// which is likely not what was intended.\n+    ///\n+    /// ### Example\n+    /// ```rust\n+    /// std::process::Command::new(\"echo\").arg(\"-n hello\").spawn().unwrap();\n+    /// ```\n+    /// Use instead:\n+    /// ```rust\n+    /// std::process::Command::new(\"echo\").args([\"-n\", \"hello\"]).spawn().unwrap();\n+    /// ```\n+    #[clippy::version = \"1.67.0\"]\n+    pub SUSPICIOUS_COMMAND_ARG_SPACE,\n+    suspicious,\n+    \"single command line argument that looks like it should be multiple arguments\"\n+}\n+\n pub struct Methods {\n     avoid_breaking_exported_api: bool,\n     msrv: Msrv,\n@@ -3289,6 +3316,7 @@ impl_lint_pass!(Methods => [\n     SEEK_FROM_CURRENT,\n     SEEK_TO_START_INSTEAD_OF_REWIND,\n     NEEDLESS_COLLECT,\n+    SUSPICIOUS_COMMAND_ARG_SPACE,\n ]);\n \n /// Extracts a method call name, args, and `Span` of the method name.\n@@ -3496,6 +3524,9 @@ impl Methods {\n                         unnecessary_lazy_eval::check(cx, expr, recv, arg, \"and\");\n                     }\n                 },\n+                (\"arg\", [arg]) => {\n+                    suspicious_command_arg_space::check(cx, recv, arg, span);\n+                }\n                 (\"as_deref\" | \"as_deref_mut\", []) => {\n                     needless_option_as_deref::check(cx, expr, recv, name);\n                 },"}, {"sha": "73632c5a357ddf0f042fcea5efdd9f8ef3fbccbb", "filename": "clippy_lints/src/methods/suspicious_command_arg_space.rs", "status": "added", "additions": 39, "deletions": 0, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/298f1397982a4e7cf718931bff399fcc6bffd9e1/clippy_lints%2Fsrc%2Fmethods%2Fsuspicious_command_arg_space.rs", "raw_url": "https://github.com/rust-lang/rust/raw/298f1397982a4e7cf718931bff399fcc6bffd9e1/clippy_lints%2Fsrc%2Fmethods%2Fsuspicious_command_arg_space.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmethods%2Fsuspicious_command_arg_space.rs?ref=298f1397982a4e7cf718931bff399fcc6bffd9e1", "patch": "@@ -0,0 +1,39 @@\n+use clippy_utils::diagnostics::span_lint_and_then;\n+use clippy_utils::paths;\n+use clippy_utils::ty::match_type;\n+use rustc_ast as ast;\n+use rustc_errors::{Applicability, Diagnostic};\n+use rustc_hir as hir;\n+use rustc_lint::LateContext;\n+use rustc_span::Span;\n+\n+use super::SUSPICIOUS_COMMAND_ARG_SPACE;\n+\n+pub(super) fn check<'tcx>(cx: &LateContext<'tcx>, recv: &'tcx hir::Expr<'_>, arg: &'tcx hir::Expr<'_>, span: Span) {\n+    let ty = cx.typeck_results().expr_ty(recv).peel_refs();\n+\n+    if match_type(cx, ty, &paths::STD_PROCESS_COMMAND)\n+        && let hir::ExprKind::Lit(lit) = &arg.kind\n+        && let ast::LitKind::Str(s, _) = &lit.node\n+        && let Some((arg1, arg2)) = s.as_str().split_once(' ')\n+        && arg1.starts_with('-')\n+        && arg1.chars().all(|c| c.is_ascii_alphanumeric() || c == '_' || c == '-')\n+    {\n+        span_lint_and_then(\n+            cx,\n+            SUSPICIOUS_COMMAND_ARG_SPACE,\n+            arg.span,\n+            \"single argument that looks like it should be multiple arguments\",\n+            |diag: &mut Diagnostic| {\n+                diag.multipart_suggestion_verbose(\n+                    \"consider splitting the argument\",\n+                    vec![\n+                        (span, \"args\".to_string()),\n+                        (arg.span, format!(\"[{arg1:?}, {arg2:?}]\")),\n+                    ],\n+                    Applicability::MaybeIncorrect,\n+                );\n+            }\n+        );\n+    }\n+}"}, {"sha": "4aae0f7284e4d96f7110d5ac9bab954cd2924730", "filename": "clippy_utils/src/paths.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/298f1397982a4e7cf718931bff399fcc6bffd9e1/clippy_utils%2Fsrc%2Fpaths.rs", "raw_url": "https://github.com/rust-lang/rust/raw/298f1397982a4e7cf718931bff399fcc6bffd9e1/clippy_utils%2Fsrc%2Fpaths.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_utils%2Fsrc%2Fpaths.rs?ref=298f1397982a4e7cf718931bff399fcc6bffd9e1", "patch": "@@ -115,6 +115,7 @@ pub const STD_FS_CREATE_DIR: [&str; 3] = [\"std\", \"fs\", \"create_dir\"];\n pub const STD_IO_SEEK: [&str; 3] = [\"std\", \"io\", \"Seek\"];\n pub const STD_IO_SEEK_FROM_CURRENT: [&str; 4] = [\"std\", \"io\", \"SeekFrom\", \"Current\"];\n pub const STD_IO_SEEKFROM_START: [&str; 4] = [\"std\", \"io\", \"SeekFrom\", \"Start\"];\n+pub const STD_PROCESS_COMMAND: [&str; 3] = [\"std\", \"process\", \"Command\"];\n pub const STRING_AS_MUT_STR: [&str; 4] = [\"alloc\", \"string\", \"String\", \"as_mut_str\"];\n pub const STRING_AS_STR: [&str; 4] = [\"alloc\", \"string\", \"String\", \"as_str\"];\n pub const STRING_NEW: [&str; 4] = [\"alloc\", \"string\", \"String\", \"new\"];"}, {"sha": "bdc6113a250015a31f1e56693344a1f524a32906", "filename": "tests/ui/suspicious_command_arg_space.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/298f1397982a4e7cf718931bff399fcc6bffd9e1/tests%2Fui%2Fsuspicious_command_arg_space.rs", "raw_url": "https://github.com/rust-lang/rust/raw/298f1397982a4e7cf718931bff399fcc6bffd9e1/tests%2Fui%2Fsuspicious_command_arg_space.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fsuspicious_command_arg_space.rs?ref=298f1397982a4e7cf718931bff399fcc6bffd9e1", "patch": "@@ -0,0 +1,10 @@\n+fn main() {\n+    // Things it should warn about:\n+    std::process::Command::new(\"echo\").arg(\"-n hello\").spawn().unwrap();\n+    std::process::Command::new(\"cat\").arg(\"--number file\").spawn().unwrap();\n+\n+    // Things it should not warn about:\n+    std::process::Command::new(\"echo\").arg(\"hello world\").spawn().unwrap();\n+    std::process::Command::new(\"a\").arg(\"--fmt=%a %b %c\").spawn().unwrap();\n+    std::process::Command::new(\"b\").arg(\"-ldflags=-s -w\").spawn().unwrap();\n+}"}, {"sha": "9bc0ca93aec9ec0b6e28a3c180e704a1a81ed78e", "filename": "tests/ui/suspicious_command_arg_space.stderr", "status": "added", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/298f1397982a4e7cf718931bff399fcc6bffd9e1/tests%2Fui%2Fsuspicious_command_arg_space.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/298f1397982a4e7cf718931bff399fcc6bffd9e1/tests%2Fui%2Fsuspicious_command_arg_space.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fsuspicious_command_arg_space.stderr?ref=298f1397982a4e7cf718931bff399fcc6bffd9e1", "patch": "@@ -0,0 +1,25 @@\n+error: single argument that looks like it should be multiple arguments\n+  --> $DIR/suspicious_command_arg_space.rs:3:44\n+   |\n+LL |     std::process::Command::new(\"echo\").arg(\"-n hello\").spawn().unwrap();\n+   |                                            ^^^^^^^^^^\n+   |\n+   = note: `-D clippy::suspicious-command-arg-space` implied by `-D warnings`\n+help: consider splitting the argument\n+   |\n+LL |     std::process::Command::new(\"echo\").args([\"-n\", \"hello\"]).spawn().unwrap();\n+   |                                        ~~~~ ~~~~~~~~~~~~~~~\n+\n+error: single argument that looks like it should be multiple arguments\n+  --> $DIR/suspicious_command_arg_space.rs:4:43\n+   |\n+LL |     std::process::Command::new(\"cat\").arg(\"--number file\").spawn().unwrap();\n+   |                                           ^^^^^^^^^^^^^^^\n+   |\n+help: consider splitting the argument\n+   |\n+LL |     std::process::Command::new(\"cat\").args([\"--number\", \"file\"]).spawn().unwrap();\n+   |                                       ~~~~ ~~~~~~~~~~~~~~~~~~~~\n+\n+error: aborting due to 2 previous errors\n+"}]}