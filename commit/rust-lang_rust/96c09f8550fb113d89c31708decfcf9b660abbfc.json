{"sha": "96c09f8550fb113d89c31708decfcf9b660abbfc", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk2YzA5Zjg1NTBmYjExM2Q4OWMzMTcwOGRlY2ZjZjliNjYwYWJiZmM=", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2017-08-11T08:20:18Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2017-08-11T08:20:18Z"}, "message": "Rollup merge of #43650 - RalfJung:mir-validate, r=arielb1\n\ntest MIR validation statements in closures\n\nr? @nikomatsakis", "tree": {"sha": "7d6e9298bffd3949bd4cf64a8757d6078f724868", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7d6e9298bffd3949bd4cf64a8757d6078f724868"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/96c09f8550fb113d89c31708decfcf9b660abbfc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/96c09f8550fb113d89c31708decfcf9b660abbfc", "html_url": "https://github.com/rust-lang/rust/commit/96c09f8550fb113d89c31708decfcf9b660abbfc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/96c09f8550fb113d89c31708decfcf9b660abbfc/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "643231313adf3c587dbada0c23001c1d573124fb", "url": "https://api.github.com/repos/rust-lang/rust/commits/643231313adf3c587dbada0c23001c1d573124fb", "html_url": "https://github.com/rust-lang/rust/commit/643231313adf3c587dbada0c23001c1d573124fb"}, {"sha": "21a707ee97e8d274acf0359a3c3e33050245056e", "url": "https://api.github.com/repos/rust-lang/rust/commits/21a707ee97e8d274acf0359a3c3e33050245056e", "html_url": "https://github.com/rust-lang/rust/commit/21a707ee97e8d274acf0359a3c3e33050245056e"}], "stats": {"total": 82, "additions": 71, "deletions": 11}, "files": [{"sha": "677c92ea71b7a78a64241da9c9fe7cd7afe13c39", "filename": "src/test/mir-opt/validate_1.rs", "status": "modified", "additions": 23, "deletions": 5, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/96c09f8550fb113d89c31708decfcf9b660abbfc/src%2Ftest%2Fmir-opt%2Fvalidate_1.rs", "raw_url": "https://github.com/rust-lang/rust/raw/96c09f8550fb113d89c31708decfcf9b660abbfc/src%2Ftest%2Fmir-opt%2Fvalidate_1.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fvalidate_1.rs?ref=96c09f8550fb113d89c31708decfcf9b660abbfc", "patch": "@@ -9,7 +9,7 @@\n // except according to those terms.\n \n // ignore-tidy-linelength\n-// compile-flags: -Z verbose -Z mir-emit-validate=1\n+// compile-flags: -Z verbose -Z mir-emit-validate=1 -Z span_free_formats\n \n struct Test(i32);\n \n@@ -20,16 +20,13 @@ impl Test {\n \n fn main() {\n     let mut x = 0;\n-    Test(0).foo(&mut x);\n+    Test(0).foo(&mut x); // just making sure we do not panic when there is a tuple struct ctor\n \n     // Also test closures\n     let c = |x: &mut i32| { let y = &*x; *y };\n     c(&mut x);\n }\n \n-// FIXME: Also test code generated inside the closure, make sure it has validation.  Unfortunately,\n-// the interesting lines of code also contain name of the source file, so we cannot test for it.\n-\n // END RUST SOURCE\n // START rustc.node12.EraseRegions.after.mir\n //     bb0: {\n@@ -57,3 +54,24 @@ fn main() {\n //     }\n // }\n // END rustc.node23.EraseRegions.after.mir\n+// START rustc.node50.EraseRegions.after.mir\n+// fn main::{{closure}}(_1: &ReErased [closure@NodeId(50)], _2: &ReErased mut i32) -> i32 {\n+//     bb0: {\n+//         Validate(Acquire, [_1: &ReFree(DefId { krate: CrateNum(0), node: DefIndex(2147483663) => validate_1/8cd878b::main[0]::{{closure}}[0] }, \"BrEnv\") [closure@NodeId(50)], _2: &ReFree(DefId { krate: CrateNum(0), node: DefIndex(2147483663) => validate_1/8cd878b::main[0]::{{closure}}[0] }, BrAnon(1)) mut i32]);\n+//         StorageLive(_3);\n+//         _3 = _2;\n+//         StorageLive(_4);\n+//         Validate(Suspend(ReScope(Remainder(BlockRemainder { block: NodeId(41), first_statement_index: 0 }))), [(*_3): i32]);\n+//         _4 = &ReErased (*_3);\n+//         Validate(Acquire, [(*_4): i32/ReScope(Remainder(BlockRemainder { block: NodeId(41), first_statement_index: 0 })) (imm)]);\n+//         StorageLive(_5);\n+//         _5 = (*_4);\n+//         _0 = _5;\n+//         StorageDead(_5);\n+//         StorageDead(_4);\n+//         EndRegion(ReScope(Remainder(BlockRemainder { block: NodeId(41), first_statement_index: 0 })));\n+//         StorageDead(_3);\n+//         return;\n+//     }\n+// }\n+// END rustc.node50.EraseRegions.after.mir"}, {"sha": "2ee459d6809c55d771eccf02872a0631b5f5286f", "filename": "src/test/mir-opt/validate_4.rs", "status": "modified", "additions": 24, "deletions": 1, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/96c09f8550fb113d89c31708decfcf9b660abbfc/src%2Ftest%2Fmir-opt%2Fvalidate_4.rs", "raw_url": "https://github.com/rust-lang/rust/raw/96c09f8550fb113d89c31708decfcf9b660abbfc/src%2Ftest%2Fmir-opt%2Fvalidate_4.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fvalidate_4.rs?ref=96c09f8550fb113d89c31708decfcf9b660abbfc", "patch": "@@ -9,7 +9,7 @@\n // except according to those terms.\n \n // ignore-tidy-linelength\n-// compile-flags: -Z verbose -Z mir-emit-validate=1\n+// compile-flags: -Z verbose -Z mir-emit-validate=1 -Z span_free_formats\n \n // Make sure unsafe fns and fns with an unsafe block only get restricted validation.\n \n@@ -45,6 +45,19 @@ fn main() {\n //     }\n // }\n // END rustc.node4.EraseRegions.after.mir\n+// START rustc.node22.EraseRegions.after.mir\n+// fn write_42::{{closure}}(_1: &ReErased [closure@NodeId(22)], _2: *mut i32) -> () {\n+//     bb0: {\n+//         Validate(Acquire, [_1: &ReFree(DefId { krate: CrateNum(0), node: DefIndex(2147483659) => validate_4/8cd878b::write_42[0]::{{closure}}[0] }, \"BrEnv\") [closure@NodeId(22)], _2: *mut i32]);\n+//         Validate(Release, [_1: &ReFree(DefId { krate: CrateNum(0), node: DefIndex(2147483659) => validate_4/8cd878b::write_42[0]::{{closure}}[0] }, \"BrEnv\") [closure@NodeId(22)], _2: *mut i32]);\n+//         StorageLive(_3);\n+//         _3 = _2;\n+//         (*_3) = const 23i32;\n+//         StorageDead(_3);\n+//         return;\n+//     }\n+// }\n+// END rustc.node22.EraseRegions.after.mir\n // START rustc.node31.EraseRegions.after.mir\n // fn test(_1: &ReErased mut i32) -> () {\n //     bb0: {\n@@ -58,3 +71,13 @@ fn main() {\n //     }\n // }\n // END rustc.node31.EraseRegions.after.mir\n+// START rustc.node60.EraseRegions.after.mir\n+// fn main::{{closure}}(_1: &ReErased [closure@NodeId(60)], _2: &ReErased mut i32) -> bool {\n+//     bb0: {\n+//         Validate(Acquire, [_1: &ReFree(DefId { krate: CrateNum(0), node: DefIndex(2147483663) => validate_4/8cd878b::main[0]::{{closure}}[0] }, \"BrEnv\") [closure@NodeId(60)], _2: &ReFree(DefId { krate: CrateNum(0), node: DefIndex(2147483663) => validate_4/8cd878b::main[0]::{{closure}}[0] }, BrAnon(1)) mut i32]);\n+//         Validate(Release, [_1: &ReFree(DefId { krate: CrateNum(0), node: DefIndex(2147483663) => validate_4/8cd878b::main[0]::{{closure}}[0] }, \"BrEnv\") [closure@NodeId(60)], _2: &ReFree(DefId { krate: CrateNum(0), node: DefIndex(2147483663) => validate_4/8cd878b::main[0]::{{closure}}[0] }, BrAnon(1)) mut i32]);\n+//         StorageLive(_3);\n+//         _0 = const write_42(_4) -> bb1;\n+//     }\n+// }\n+// END rustc.node60.EraseRegions.after.mir"}, {"sha": "0182e6e2964452c5627f49503ace6d7b5eff7498", "filename": "src/test/mir-opt/validate_5.rs", "status": "modified", "additions": 24, "deletions": 5, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/96c09f8550fb113d89c31708decfcf9b660abbfc/src%2Ftest%2Fmir-opt%2Fvalidate_5.rs", "raw_url": "https://github.com/rust-lang/rust/raw/96c09f8550fb113d89c31708decfcf9b660abbfc/src%2Ftest%2Fmir-opt%2Fvalidate_5.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fvalidate_5.rs?ref=96c09f8550fb113d89c31708decfcf9b660abbfc", "patch": "@@ -9,9 +9,9 @@\n // except according to those terms.\n \n // ignore-tidy-linelength\n-// compile-flags: -Z verbose -Z mir-emit-validate=2\n+// compile-flags: -Z verbose -Z mir-emit-validate=2 -Z span_free_formats\n \n-// Make sure unsafe fns and fns with an unsafe block only get full validation.\n+// Make sure unsafe fns and fns with an unsafe block still get full validation.\n \n unsafe fn write_42(x: *mut i32) -> bool {\n     *x = 42;\n@@ -26,12 +26,12 @@ fn main() {\n     test(&mut 0);\n \n     let test_closure = unsafe { |x: &mut i32| write_42(x) };\n+    // Note that validation will fail if this is executed: The closure keeps the lock on\n+    // x, so the write in write_42 fails.  This test just checks code generation,\n+    // so the UB doesn't matter.\n     test_closure(&mut 0);\n }\n \n-// FIXME: Also test code generated inside the closure, make sure it has validation.  Unfortunately,\n-// the interesting lines of code also contain name of the source file, so we cannot test for it.\n-\n // END RUST SOURCE\n // START rustc.node17.EraseRegions.after.mir\n // fn test(_1: &ReErased mut i32) -> () {\n@@ -42,3 +42,22 @@ fn main() {\n //     }\n // }\n // END rustc.node17.EraseRegions.after.mir\n+// START rustc.node46.EraseRegions.after.mir\n+// fn main::{{closure}}(_1: &ReErased [closure@NodeId(46)], _2: &ReErased mut i32) -> bool {\n+//     bb0: {\n+//         Validate(Acquire, [_1: &ReFree(DefId { krate: CrateNum(0), node: DefIndex(2147483660) => validate_5/8cd878b::main[0]::{{closure}}[0] }, \"BrEnv\") [closure@NodeId(46)], _2: &ReFree(DefId { krate: CrateNum(0), node: DefIndex(2147483660) => validate_5/8cd878b::main[0]::{{closure}}[0] }, BrAnon(1)) mut i32]);\n+//         StorageLive(_3);\n+//         _3 = _2;\n+//         StorageLive(_4);\n+//         StorageLive(_5);\n+//         Validate(Suspend(ReScope(Misc(NodeId(44)))), [(*_3): i32]);\n+//         _5 = &ReErased mut (*_3);\n+//         Validate(Acquire, [(*_5): i32/ReScope(Misc(NodeId(44)))]);\n+//         _4 = _5 as *mut i32 (Misc);\n+//         StorageDead(_5);\n+//         EndRegion(ReScope(Misc(NodeId(44))));\n+//         Validate(Release, [_0: bool, _4: *mut i32]);\n+//         _0 = const write_42(_4) -> bb1;\n+//     }\n+// }\n+// END rustc.node46.EraseRegions.after.mir"}]}