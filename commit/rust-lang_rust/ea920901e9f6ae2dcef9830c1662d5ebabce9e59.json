{"sha": "ea920901e9f6ae2dcef9830c1662d5ebabce9e59", "node_id": "C_kwDOAAsO6NoAKGVhOTIwOTAxZTlmNmFlMmRjZWY5ODMwYzE2NjJkNWViYWJjZTllNTk", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2023-04-05T22:18:29Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-04-05T22:18:29Z"}, "message": "Rollup merge of #109909 - clubby789:import-tool-mod, r=petrochenkov\n\nDeny `use`ing tool paths\n\nFixes #109853\nFixes #109147", "tree": {"sha": "5dd7a72cc7796dcfdae2968c6288137e04d81384", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5dd7a72cc7796dcfdae2968c6288137e04d81384"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ea920901e9f6ae2dcef9830c1662d5ebabce9e59", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkLfO1CRBK7hj4Ov3rIwAASDkIADLgIysAR/j1TF5Hv8D7RVBv\nOeCDynUY52zpIIccOhk50ooOnScXCu3/nM43f4PHVuZBezLak/LcIDJ0P9fNZyQ7\nPSgCTeb88suuS/QORzruplFDHEy/vDpMwI+VCStoswBHoRKjsmt0JjsUpNOkexnZ\nmoJ7mPeVveUIjxTuuA0QrOxxZaebc5wa8yi7u9Nf/j3nJrw0qJMmZ2rgXg3pykOd\nGx5cEJps4RHElSETK7bas3dmWv4P1sIU1yjYFEysjB5J+9aUarpoQT62OlK8Vge0\nspMkI+goL24iE59XXC80o2C1O1nCcs9vQBO5iW666kxb6OqPdVDYrWOpgCJS13A=\n=axYM\n-----END PGP SIGNATURE-----\n", "payload": "tree 5dd7a72cc7796dcfdae2968c6288137e04d81384\nparent 2e486be8d29d198d48bc26bfce5712a4822814f5\nparent ebde2ab363ea4cfff4fbb58ef821f3bcebc351a5\nauthor Yuki Okushi <jtitor@2k36.org> 1680733109 +0900\ncommitter GitHub <noreply@github.com> 1680733109 +0900\n\nRollup merge of #109909 - clubby789:import-tool-mod, r=petrochenkov\n\nDeny `use`ing tool paths\n\nFixes #109853\nFixes #109147\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ea920901e9f6ae2dcef9830c1662d5ebabce9e59", "html_url": "https://github.com/rust-lang/rust/commit/ea920901e9f6ae2dcef9830c1662d5ebabce9e59", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ea920901e9f6ae2dcef9830c1662d5ebabce9e59/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2e486be8d29d198d48bc26bfce5712a4822814f5", "url": "https://api.github.com/repos/rust-lang/rust/commits/2e486be8d29d198d48bc26bfce5712a4822814f5", "html_url": "https://github.com/rust-lang/rust/commit/2e486be8d29d198d48bc26bfce5712a4822814f5"}, {"sha": "ebde2ab363ea4cfff4fbb58ef821f3bcebc351a5", "url": "https://api.github.com/repos/rust-lang/rust/commits/ebde2ab363ea4cfff4fbb58ef821f3bcebc351a5", "html_url": "https://github.com/rust-lang/rust/commit/ebde2ab363ea4cfff4fbb58ef821f3bcebc351a5"}], "stats": {"total": 48, "additions": 37, "deletions": 11}, "files": [{"sha": "2199ceee532614cedfcddb1da8fb7e596f2fdeec", "filename": "compiler/rustc_resolve/messages.ftl", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/ea920901e9f6ae2dcef9830c1662d5ebabce9e59/compiler%2Frustc_resolve%2Fmessages.ftl", "raw_url": "https://github.com/rust-lang/rust/raw/ea920901e9f6ae2dcef9830c1662d5ebabce9e59/compiler%2Frustc_resolve%2Fmessages.ftl", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fmessages.ftl?ref=ea920901e9f6ae2dcef9830c1662d5ebabce9e59", "patch": "@@ -207,5 +207,9 @@ resolve_expected_found =\n resolve_indeterminate =\n     cannot determine resolution for the visibility\n \n+resolve_tool_module_imported =\n+    cannot use a tool module through an import\n+    .note = the tool module imported here\n+\n resolve_module_only =\n     visibility must resolve to a module"}, {"sha": "07aaaa1eb7f600c0d48e1b0a8346e1397b8f8713", "filename": "compiler/rustc_resolve/src/errors.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/ea920901e9f6ae2dcef9830c1662d5ebabce9e59/compiler%2Frustc_resolve%2Fsrc%2Ferrors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ea920901e9f6ae2dcef9830c1662d5ebabce9e59/compiler%2Frustc_resolve%2Fsrc%2Ferrors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Ferrors.rs?ref=ea920901e9f6ae2dcef9830c1662d5ebabce9e59", "patch": "@@ -469,6 +469,15 @@ pub(crate) struct ExpectedFound {\n #[diag(resolve_indeterminate, code = \"E0578\")]\n pub(crate) struct Indeterminate(#[primary_span] pub(crate) Span);\n \n+#[derive(Diagnostic)]\n+#[diag(resolve_tool_module_imported)]\n+pub(crate) struct ToolModuleImported {\n+    #[primary_span]\n+    pub(crate) span: Span,\n+    #[note]\n+    pub(crate) import: Span,\n+}\n+\n #[derive(Diagnostic)]\n #[diag(resolve_module_only)]\n pub(crate) struct ModuleOnly(#[primary_span] pub(crate) Span);"}, {"sha": "5a56d7b99a978da3c62b9329efd0fb593b5c40d4", "filename": "compiler/rustc_resolve/src/ident.rs", "status": "modified", "additions": 7, "deletions": 11, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/ea920901e9f6ae2dcef9830c1662d5ebabce9e59/compiler%2Frustc_resolve%2Fsrc%2Fident.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ea920901e9f6ae2dcef9830c1662d5ebabce9e59/compiler%2Frustc_resolve%2Fsrc%2Fident.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Fident.rs?ref=ea920901e9f6ae2dcef9830c1662d5ebabce9e59", "patch": "@@ -17,7 +17,7 @@ use crate::late::{\n     ConstantHasGenerics, ConstantItemKind, HasGenericParams, PathSource, Rib, RibKind,\n };\n use crate::macros::{sub_namespace_match, MacroRulesScope};\n-use crate::{AmbiguityError, AmbiguityErrorMisc, AmbiguityKind, Determinacy, Finalize};\n+use crate::{errors, AmbiguityError, AmbiguityErrorMisc, AmbiguityKind, Determinacy, Finalize};\n use crate::{Import, ImportKind, LexicalScopeBinding, Module, ModuleKind, ModuleOrUniformRoot};\n use crate::{NameBinding, NameBindingKind, ParentScope, PathResult, PrivacyError, Res};\n use crate::{ResolutionError, Resolver, Scope, ScopeSet, Segment, ToNameBinding, Weak};\n@@ -1364,7 +1364,7 @@ impl<'a, 'tcx> Resolver<'a, 'tcx> {\n                 }\n             };\n \n-            let is_last = i == path.len() - 1;\n+            let is_last = i + 1 == path.len();\n             let ns = if is_last { opt_ns.unwrap_or(TypeNS) } else { TypeNS };\n             let name = ident.name;\n \n@@ -1501,16 +1501,12 @@ impl<'a, 'tcx> Resolver<'a, 'tcx> {\n                     if let Some(next_module) = binding.module() {\n                         module = Some(ModuleOrUniformRoot::Module(next_module));\n                         record_segment_res(self, res);\n-                    } else if res == Res::ToolMod && i + 1 != path.len() {\n+                    } else if res == Res::ToolMod && !is_last && opt_ns.is_some() {\n                         if binding.is_import() {\n-                            self.tcx\n-                                .sess\n-                                .struct_span_err(\n-                                    ident.span,\n-                                    \"cannot use a tool module through an import\",\n-                                )\n-                                .span_note(binding.span, \"the tool module imported here\")\n-                                .emit();\n+                            self.tcx.sess.emit_err(errors::ToolModuleImported {\n+                                span: ident.span,\n+                                import: binding.span,\n+                            });\n                         }\n                         let res = Res::NonMacroAttr(NonMacroAttrKind::Tool);\n                         return PathResult::NonModule(PartialRes::new(res));"}, {"sha": "971993332f540b2a6aa1e9c3b835b5be1409e39c", "filename": "tests/ui/resolve/tool-import.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ea920901e9f6ae2dcef9830c1662d5ebabce9e59/tests%2Fui%2Fresolve%2Ftool-import.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ea920901e9f6ae2dcef9830c1662d5ebabce9e59/tests%2Fui%2Fresolve%2Ftool-import.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fresolve%2Ftool-import.rs?ref=ea920901e9f6ae2dcef9830c1662d5ebabce9e59", "patch": "@@ -0,0 +1,8 @@\n+// edition: 2018\n+\n+use clippy::time::Instant;\n+//~^ `clippy` is a tool module\n+\n+fn main() {\n+    Instant::now();\n+}"}, {"sha": "d3bdfc93d49234a13d575bfdfb26c3313760fe7d", "filename": "tests/ui/resolve/tool-import.stderr", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/ea920901e9f6ae2dcef9830c1662d5ebabce9e59/tests%2Fui%2Fresolve%2Ftool-import.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/ea920901e9f6ae2dcef9830c1662d5ebabce9e59/tests%2Fui%2Fresolve%2Ftool-import.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fresolve%2Ftool-import.stderr?ref=ea920901e9f6ae2dcef9830c1662d5ebabce9e59", "patch": "@@ -0,0 +1,9 @@\n+error[E0433]: failed to resolve: `clippy` is a tool module, not a module\n+  --> $DIR/tool-import.rs:3:5\n+   |\n+LL | use clippy::time::Instant;\n+   |     ^^^^^^ `clippy` is a tool module, not a module\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0433`."}]}