{"sha": "5a5f4993ad46cd37c731cbcadc4834d92d229224", "node_id": "C_kwDOAAsO6NoAKDVhNWY0OTkzYWQ0NmNkMzdjNzMxY2JjYWRjNDgzNGQ5MmQyMjkyMjQ", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-08-03T20:30:45Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-08-03T20:30:45Z"}, "message": "Rollup merge of #100068 - dcsommer:master, r=petrochenkov\n\nFix backwards-compatibility check for tests with `+whole-archive`\n\nFixes #100066", "tree": {"sha": "6a9653ea2b23b64072e6fa32ee877b7c71059e97", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6a9653ea2b23b64072e6fa32ee877b7c71059e97"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5a5f4993ad46cd37c731cbcadc4834d92d229224", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJi6tr1CRBK7hj4Ov3rIwAAelUIAJyuprkZS4EMqFM9JXeWMuMS\nw59hmdzbF7QlCLkELjiOJ2qfNk65xvqIYi2MszGreVj9OQRWBIXI8jAC5pZeOpjX\nsiSn/cLHlmVolG3rOeAQDQ3N14tMUNAFik7LZYVgFDu/jE4zFOu+QiLknGfuQ8Bw\nNFa0DclulNrxRyiPeU+to8/9oINPPED/HQqka2spzKurbAt0c+snffHUVheLQCU6\ns0CrW5WZ6ztj9DASOoXwMKC9QUQPw8fgDBj0XSW/fYaicFD8xHMG1IjyR1HVswZT\nWXZFB6p5+cg8i68ExNy17huo7DHmFdWBmglD1lxrLKlyJz69hNiFlz+EX4gNdE4=\n=fib0\n-----END PGP SIGNATURE-----\n", "payload": "tree 6a9653ea2b23b64072e6fa32ee877b7c71059e97\nparent 6a987f5e37f33341156a51c256828e71c7f16a73\nparent 9cf556dca9e4fb731035a51e75974c78d52295ce\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1659558645 +0200\ncommitter GitHub <noreply@github.com> 1659558645 +0200\n\nRollup merge of #100068 - dcsommer:master, r=petrochenkov\n\nFix backwards-compatibility check for tests with `+whole-archive`\n\nFixes #100066\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5a5f4993ad46cd37c731cbcadc4834d92d229224", "html_url": "https://github.com/rust-lang/rust/commit/5a5f4993ad46cd37c731cbcadc4834d92d229224", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5a5f4993ad46cd37c731cbcadc4834d92d229224/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6a987f5e37f33341156a51c256828e71c7f16a73", "url": "https://api.github.com/repos/rust-lang/rust/commits/6a987f5e37f33341156a51c256828e71c7f16a73", "html_url": "https://github.com/rust-lang/rust/commit/6a987f5e37f33341156a51c256828e71c7f16a73"}, {"sha": "9cf556dca9e4fb731035a51e75974c78d52295ce", "url": "https://api.github.com/repos/rust-lang/rust/commits/9cf556dca9e4fb731035a51e75974c78d52295ce", "html_url": "https://github.com/rust-lang/rust/commit/9cf556dca9e4fb731035a51e75974c78d52295ce"}], "stats": {"total": 35, "additions": 31, "deletions": 4}, "files": [{"sha": "326dce8011eae6c7c55b335abbad645d64d92a56", "filename": "compiler/rustc_codegen_ssa/src/back/link.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/5a5f4993ad46cd37c731cbcadc4834d92d229224/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5a5f4993ad46cd37c731cbcadc4834d92d229224/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs?ref=5a5f4993ad46cd37c731cbcadc4834d92d229224", "patch": "@@ -2267,7 +2267,7 @@ fn add_local_native_libraries(\n                     // be added explicitly if necessary, see the error in `fn link_rlib`) compiled\n                     // as an executable due to `--test`. Use whole-archive implicitly, like before\n                     // the introduction of native lib modifiers.\n-                    || (bundle != Some(false) && sess.opts.test)\n+                    || (whole_archive == None && bundle != Some(false) && sess.opts.test)\n                 {\n                     cmd.link_whole_staticlib(\n                         name,"}, {"sha": "967cb065cad1aaeae17d0d20c31911b665b296ea", "filename": "src/test/run-make/native-link-modifier-whole-archive/Makefile", "status": "modified", "additions": 16, "deletions": 3, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/5a5f4993ad46cd37c731cbcadc4834d92d229224/src%2Ftest%2Frun-make%2Fnative-link-modifier-whole-archive%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/5a5f4993ad46cd37c731cbcadc4834d92d229224/src%2Ftest%2Frun-make%2Fnative-link-modifier-whole-archive%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fnative-link-modifier-whole-archive%2FMakefile?ref=5a5f4993ad46cd37c731cbcadc4834d92d229224", "patch": "@@ -1,7 +1,7 @@\n # ignore-cross-compile -- compiling C++ code does not work well when cross-compiling\n \n-# This test case makes sure that native libraries are linked with --whole-archive semantics\n-# when the `-bundle,+whole-archive` modifiers are applied to them.\n+# This test case makes sure that native libraries are linked with appropriate semantics\n+# when the `[+-]bundle,[+-]whole-archive` modifiers are applied to them.\n #\n # The test works by checking that the resulting executables produce the expected output,\n # part of which is emitted by otherwise unreferenced C code. If +whole-archive didn't work\n@@ -10,15 +10,28 @@\n \n -include ../../run-make-fulldeps/tools.mk\n \n-all: $(TMPDIR)/$(call BIN,directly_linked) $(TMPDIR)/$(call BIN,indirectly_linked) $(TMPDIR)/$(call BIN,indirectly_linked_via_attr)\n+all: $(TMPDIR)/$(call BIN,directly_linked) \\\n+     $(TMPDIR)/$(call BIN,directly_linked_test_plus_whole_archive) \\\n+     $(TMPDIR)/$(call BIN,directly_linked_test_minus_whole_archive) \\\n+     $(TMPDIR)/$(call BIN,indirectly_linked) \\\n+     $(TMPDIR)/$(call BIN,indirectly_linked_via_attr)\n \t$(call RUN,directly_linked) | $(CGREP) 'static-initializer.directly_linked.'\n+\t$(call RUN,directly_linked_test_plus_whole_archive) --nocapture | $(CGREP) 'static-initializer.'\n+\t$(call RUN,directly_linked_test_minus_whole_archive) --nocapture | $(CGREP) -v 'static-initializer.'\n \t$(call RUN,indirectly_linked) | $(CGREP) 'static-initializer.indirectly_linked.'\n \t$(call RUN,indirectly_linked_via_attr) | $(CGREP) 'static-initializer.native_lib_in_src.'\n \n # Native lib linked directly into executable\n $(TMPDIR)/$(call BIN,directly_linked): $(call NATIVE_STATICLIB,c_static_lib_with_constructor)\n \t$(RUSTC) directly_linked.rs -l static:+whole-archive=c_static_lib_with_constructor\n \n+# Native lib linked into test executable, +whole-archive\n+$(TMPDIR)/$(call BIN,directly_linked_test_plus_whole_archive): $(call NATIVE_STATICLIB,c_static_lib_with_constructor)\n+\t$(RUSTC) directly_linked_test_plus_whole_archive.rs --test -l static:+whole-archive=c_static_lib_with_constructor\n+# Native lib linked into test executable, -whole-archive\n+$(TMPDIR)/$(call BIN,directly_linked_test_minus_whole_archive): $(call NATIVE_STATICLIB,c_static_lib_with_constructor)\n+\t$(RUSTC) directly_linked_test_minus_whole_archive.rs --test -l static:-whole-archive=c_static_lib_with_constructor\n+\n # Native lib linked into RLIB via `-l static:-bundle,+whole-archive`, RLIB linked into executable\n $(TMPDIR)/$(call BIN,indirectly_linked): $(TMPDIR)/librlib_with_cmdline_native_lib.rlib\n \t$(RUSTC) indirectly_linked.rs"}, {"sha": "20ed8d9d4cd1091316e226a696838bedede69b01", "filename": "src/test/run-make/native-link-modifier-whole-archive/directly_linked_test_minus_whole_archive.rs", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/5a5f4993ad46cd37c731cbcadc4834d92d229224/src%2Ftest%2Frun-make%2Fnative-link-modifier-whole-archive%2Fdirectly_linked_test_minus_whole_archive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5a5f4993ad46cd37c731cbcadc4834d92d229224/src%2Ftest%2Frun-make%2Fnative-link-modifier-whole-archive%2Fdirectly_linked_test_minus_whole_archive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fnative-link-modifier-whole-archive%2Fdirectly_linked_test_minus_whole_archive.rs?ref=5a5f4993ad46cd37c731cbcadc4834d92d229224", "patch": "@@ -0,0 +1,7 @@\n+use std::io::Write;\n+\n+#[test]\n+fn test_thing() {\n+    print!(\"ran the test\");\n+    std::io::stdout().flush().unwrap();\n+}"}, {"sha": "20ed8d9d4cd1091316e226a696838bedede69b01", "filename": "src/test/run-make/native-link-modifier-whole-archive/directly_linked_test_plus_whole_archive.rs", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/5a5f4993ad46cd37c731cbcadc4834d92d229224/src%2Ftest%2Frun-make%2Fnative-link-modifier-whole-archive%2Fdirectly_linked_test_plus_whole_archive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5a5f4993ad46cd37c731cbcadc4834d92d229224/src%2Ftest%2Frun-make%2Fnative-link-modifier-whole-archive%2Fdirectly_linked_test_plus_whole_archive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fnative-link-modifier-whole-archive%2Fdirectly_linked_test_plus_whole_archive.rs?ref=5a5f4993ad46cd37c731cbcadc4834d92d229224", "patch": "@@ -0,0 +1,7 @@\n+use std::io::Write;\n+\n+#[test]\n+fn test_thing() {\n+    print!(\"ran the test\");\n+    std::io::stdout().flush().unwrap();\n+}"}]}