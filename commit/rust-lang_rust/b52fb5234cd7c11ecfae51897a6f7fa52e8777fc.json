{"sha": "b52fb5234cd7c11ecfae51897a6f7fa52e8777fc", "node_id": "C_kwDOAAsO6NoAKGI1MmZiNTIzNGNkN2MxMWVjZmFlNTE4OTdhNmY3ZmE1MmU4Nzc3ZmM", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-09-08T23:48:08Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-09-08T23:48:08Z"}, "message": "Auto merge of #9446 - mikerite:fix-9431-2, r=giraffate\n\nFix `range_{plus,minus}_one` bad suggestions\n\nFixes #9431.\n\nThe current `range_plus_one` and `range_minus_one` suggestions are completely incorrect when macros are involved.\n\nThis commit resolves this by disabling the lints for any range expression that is expanded from a macro. The reasons for this are that it is very difficult to create a correct suggestion in this case and that false negatives are less important for pedantic lints.\n\nchangelog: Fix `range_{plus,minus}_one` bad suggestions", "tree": {"sha": "d561d2db54c189850087bff9df77ccda30ba8424", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d561d2db54c189850087bff9df77ccda30ba8424"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b52fb5234cd7c11ecfae51897a6f7fa52e8777fc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b52fb5234cd7c11ecfae51897a6f7fa52e8777fc", "html_url": "https://github.com/rust-lang/rust/commit/b52fb5234cd7c11ecfae51897a6f7fa52e8777fc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b52fb5234cd7c11ecfae51897a6f7fa52e8777fc/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "32fa80dda57f3c468bb290657eb04720144506ab", "url": "https://api.github.com/repos/rust-lang/rust/commits/32fa80dda57f3c468bb290657eb04720144506ab", "html_url": "https://github.com/rust-lang/rust/commit/32fa80dda57f3c468bb290657eb04720144506ab"}, {"sha": "a6d8afd958e35cb0f424de8be11c42116133e23a", "url": "https://api.github.com/repos/rust-lang/rust/commits/a6d8afd958e35cb0f424de8be11c42116133e23a", "html_url": "https://github.com/rust-lang/rust/commit/a6d8afd958e35cb0f424de8be11c42116133e23a"}], "stats": {"total": 67, "additions": 50, "deletions": 17}, "files": [{"sha": "918d624eec6fa852da2d6767b4c2eef29f5cb7ed", "filename": "clippy_lints/src/ranges.rs", "status": "modified", "additions": 3, "deletions": 8, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/b52fb5234cd7c11ecfae51897a6f7fa52e8777fc/clippy_lints%2Fsrc%2Franges.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52fb5234cd7c11ecfae51897a6f7fa52e8777fc/clippy_lints%2Fsrc%2Franges.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Franges.rs?ref=b52fb5234cd7c11ecfae51897a6f7fa52e8777fc", "patch": "@@ -350,21 +350,15 @@ fn check_range_bounds<'a>(cx: &'a LateContext<'_>, ex: &'a Expr<'_>) -> Option<R\n // exclusive range plus one: `x..(y+1)`\n fn check_exclusive_range_plus_one(cx: &LateContext<'_>, expr: &Expr<'_>) {\n     if_chain! {\n+        if expr.span.can_be_used_for_suggestions();\n         if let Some(higher::Range {\n             start,\n             end: Some(end),\n             limits: RangeLimits::HalfOpen\n         }) = higher::Range::hir(expr);\n         if let Some(y) = y_plus_one(cx, end);\n         then {\n-            let span = if expr.span.from_expansion() {\n-                expr.span\n-                    .ctxt()\n-                    .outer_expn_data()\n-                    .call_site\n-            } else {\n-                expr.span\n-            };\n+            let span = expr.span;\n             span_lint_and_then(\n                 cx,\n                 RANGE_PLUS_ONE,\n@@ -399,6 +393,7 @@ fn check_exclusive_range_plus_one(cx: &LateContext<'_>, expr: &Expr<'_>) {\n // inclusive range minus one: `x..=(y-1)`\n fn check_inclusive_range_minus_one(cx: &LateContext<'_>, expr: &Expr<'_>) {\n     if_chain! {\n+        if expr.span.can_be_used_for_suggestions();\n         if let Some(higher::Range { start, end: Some(end), limits: RangeLimits::Closed }) = higher::Range::hir(expr);\n         if let Some(y) = y_minus_one(cx, end);\n         then {"}, {"sha": "a16a3e54d45eadaaf8025b6eadb94b4a2847076d", "filename": "tests/ui/range_plus_minus_one.fixed", "status": "modified", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/b52fb5234cd7c11ecfae51897a6f7fa52e8777fc/tests%2Fui%2Frange_plus_minus_one.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/b52fb5234cd7c11ecfae51897a6f7fa52e8777fc/tests%2Fui%2Frange_plus_minus_one.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Frange_plus_minus_one.fixed?ref=b52fb5234cd7c11ecfae51897a6f7fa52e8777fc", "patch": "@@ -6,6 +6,22 @@ fn f() -> usize {\n     42\n }\n \n+macro_rules! macro_plus_one {\n+    ($m: literal) => {\n+        for i in 0..$m + 1 {\n+            println!(\"{}\", i);\n+        }\n+    };\n+}\n+\n+macro_rules! macro_minus_one {\n+    ($m: literal) => {\n+        for i in 0..=$m - 1 {\n+            println!(\"{}\", i);\n+        }\n+    };\n+}\n+\n #[warn(clippy::range_plus_one)]\n #[warn(clippy::range_minus_one)]\n fn main() {\n@@ -39,4 +55,7 @@ fn main() {\n \n     let mut vec: Vec<()> = std::vec::Vec::new();\n     vec.drain(..);\n+\n+    macro_plus_one!(5);\n+    macro_minus_one!(5);\n }"}, {"sha": "bd6cb4d21be51b653e54e6c42eb2148688175729", "filename": "tests/ui/range_plus_minus_one.rs", "status": "modified", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/b52fb5234cd7c11ecfae51897a6f7fa52e8777fc/tests%2Fui%2Frange_plus_minus_one.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b52fb5234cd7c11ecfae51897a6f7fa52e8777fc/tests%2Fui%2Frange_plus_minus_one.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Frange_plus_minus_one.rs?ref=b52fb5234cd7c11ecfae51897a6f7fa52e8777fc", "patch": "@@ -6,6 +6,22 @@ fn f() -> usize {\n     42\n }\n \n+macro_rules! macro_plus_one {\n+    ($m: literal) => {\n+        for i in 0..$m + 1 {\n+            println!(\"{}\", i);\n+        }\n+    };\n+}\n+\n+macro_rules! macro_minus_one {\n+    ($m: literal) => {\n+        for i in 0..=$m - 1 {\n+            println!(\"{}\", i);\n+        }\n+    };\n+}\n+\n #[warn(clippy::range_plus_one)]\n #[warn(clippy::range_minus_one)]\n fn main() {\n@@ -39,4 +55,7 @@ fn main() {\n \n     let mut vec: Vec<()> = std::vec::Vec::new();\n     vec.drain(..);\n+\n+    macro_plus_one!(5);\n+    macro_minus_one!(5);\n }"}, {"sha": "0223696243b20c75e41e68840d3e05be1f3a83c7", "filename": "tests/ui/range_plus_minus_one.stderr", "status": "modified", "additions": 9, "deletions": 9, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/b52fb5234cd7c11ecfae51897a6f7fa52e8777fc/tests%2Fui%2Frange_plus_minus_one.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/b52fb5234cd7c11ecfae51897a6f7fa52e8777fc/tests%2Fui%2Frange_plus_minus_one.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Frange_plus_minus_one.stderr?ref=b52fb5234cd7c11ecfae51897a6f7fa52e8777fc", "patch": "@@ -1,57 +1,57 @@\n error: an inclusive range would be more readable\n-  --> $DIR/range_plus_minus_one.rs:15:14\n+  --> $DIR/range_plus_minus_one.rs:31:14\n    |\n LL |     for _ in 0..3 + 1 {}\n    |              ^^^^^^^^ help: use: `0..=3`\n    |\n    = note: `-D clippy::range-plus-one` implied by `-D warnings`\n \n error: an inclusive range would be more readable\n-  --> $DIR/range_plus_minus_one.rs:18:14\n+  --> $DIR/range_plus_minus_one.rs:34:14\n    |\n LL |     for _ in 0..1 + 5 {}\n    |              ^^^^^^^^ help: use: `0..=5`\n \n error: an inclusive range would be more readable\n-  --> $DIR/range_plus_minus_one.rs:21:14\n+  --> $DIR/range_plus_minus_one.rs:37:14\n    |\n LL |     for _ in 1..1 + 1 {}\n    |              ^^^^^^^^ help: use: `1..=1`\n \n error: an inclusive range would be more readable\n-  --> $DIR/range_plus_minus_one.rs:27:14\n+  --> $DIR/range_plus_minus_one.rs:43:14\n    |\n LL |     for _ in 0..(1 + f()) {}\n    |              ^^^^^^^^^^^^ help: use: `0..=f()`\n \n error: an exclusive range would be more readable\n-  --> $DIR/range_plus_minus_one.rs:31:13\n+  --> $DIR/range_plus_minus_one.rs:47:13\n    |\n LL |     let _ = ..=11 - 1;\n    |             ^^^^^^^^^ help: use: `..11`\n    |\n    = note: `-D clippy::range-minus-one` implied by `-D warnings`\n \n error: an exclusive range would be more readable\n-  --> $DIR/range_plus_minus_one.rs:32:13\n+  --> $DIR/range_plus_minus_one.rs:48:13\n    |\n LL |     let _ = ..=(11 - 1);\n    |             ^^^^^^^^^^^ help: use: `..11`\n \n error: an inclusive range would be more readable\n-  --> $DIR/range_plus_minus_one.rs:33:13\n+  --> $DIR/range_plus_minus_one.rs:49:13\n    |\n LL |     let _ = (1..11 + 1);\n    |             ^^^^^^^^^^^ help: use: `(1..=11)`\n \n error: an inclusive range would be more readable\n-  --> $DIR/range_plus_minus_one.rs:34:13\n+  --> $DIR/range_plus_minus_one.rs:50:13\n    |\n LL |     let _ = (f() + 1)..(f() + 1);\n    |             ^^^^^^^^^^^^^^^^^^^^ help: use: `((f() + 1)..=f())`\n \n error: an inclusive range would be more readable\n-  --> $DIR/range_plus_minus_one.rs:38:14\n+  --> $DIR/range_plus_minus_one.rs:54:14\n    |\n LL |     for _ in 1..ONE + ONE {}\n    |              ^^^^^^^^^^^^ help: use: `1..=ONE`"}]}