{"sha": "ae2a720e92f78e76db5b7c1d6308fcd87d5c5281", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFlMmE3MjBlOTJmNzhlNzZkYjViN2MxZDYzMDhmY2Q4N2Q1YzUyODE=", "commit": {"author": {"name": "Tyler Mandry", "email": "tmandry@gmail.com", "date": "2019-10-06T04:54:51Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-10-06T04:54:51Z"}, "message": "Rollup merge of #64765 - alexcrichton:less-check-backtrace, r=sfackler\n\nstd: Reduce checks for `feature = \"backtrace\"`\n\nThis is a stylistic change to libstd to reduce the number of checks of\n`feature = \"backtrace\"` now that we unconditionally depend on the\n`backtrace` crate and rely on it having an empty implementation.\notherwise.", "tree": {"sha": "20d99bfa7847537fbe2d967fd32e9e63f6148660", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/20d99bfa7847537fbe2d967fd32e9e63f6148660"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ae2a720e92f78e76db5b7c1d6308fcd87d5c5281", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJdmXObCRBK7hj4Ov3rIwAAdHIIAKWPEZDFHd9qcEGCeX4GzO6K\n0c+VCYoup0W0fRI/KsB/tjqEikNYL+ckXBwKdlwIxFDQ2KZkqAasvYfTD8YzPpjN\nIUb93PTjrQT8dgckpwQXOUUiPhnUbAZHGpv8aEHk16/gAXZ/9LQBLFBTZ/iFMYD1\nHX5u7CAgRhNv5QCRy9ydfjwYJ5/rJZT2VvCf2hfWXeyZKg9gk7vN1W+f93JMEvim\n21wGgpQzgkC/anHeokXkPlZGF0WsUBzbu+Rlsnex2XvRwznvzatRXuOhhXpAKsSw\neRXr5kPF2IMLsg8nwM4Lp7EKvZAy0T0pZM6ZAHzPX1rt7yMi3aUqBN7mYk4kYAg=\n=OZr/\n-----END PGP SIGNATURE-----\n", "payload": "tree 20d99bfa7847537fbe2d967fd32e9e63f6148660\nparent 019b5b5f96e89debb0a3f3a71f1454c73966af25\nparent 1d06058a77beffb6347c77b51e12889b7bd9fc76\nauthor Tyler Mandry <tmandry@gmail.com> 1570337691 -0700\ncommitter GitHub <noreply@github.com> 1570337691 -0700\n\nRollup merge of #64765 - alexcrichton:less-check-backtrace, r=sfackler\n\nstd: Reduce checks for `feature = \"backtrace\"`\n\nThis is a stylistic change to libstd to reduce the number of checks of\n`feature = \"backtrace\"` now that we unconditionally depend on the\n`backtrace` crate and rely on it having an empty implementation.\notherwise.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ae2a720e92f78e76db5b7c1d6308fcd87d5c5281", "html_url": "https://github.com/rust-lang/rust/commit/ae2a720e92f78e76db5b7c1d6308fcd87d5c5281", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ae2a720e92f78e76db5b7c1d6308fcd87d5c5281/comments", "author": {"login": "tmandry", "id": 2280544, "node_id": "MDQ6VXNlcjIyODA1NDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/2280544?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmandry", "html_url": "https://github.com/tmandry", "followers_url": "https://api.github.com/users/tmandry/followers", "following_url": "https://api.github.com/users/tmandry/following{/other_user}", "gists_url": "https://api.github.com/users/tmandry/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmandry/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmandry/subscriptions", "organizations_url": "https://api.github.com/users/tmandry/orgs", "repos_url": "https://api.github.com/users/tmandry/repos", "events_url": "https://api.github.com/users/tmandry/events{/privacy}", "received_events_url": "https://api.github.com/users/tmandry/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "019b5b5f96e89debb0a3f3a71f1454c73966af25", "url": "https://api.github.com/repos/rust-lang/rust/commits/019b5b5f96e89debb0a3f3a71f1454c73966af25", "html_url": "https://github.com/rust-lang/rust/commit/019b5b5f96e89debb0a3f3a71f1454c73966af25"}, {"sha": "1d06058a77beffb6347c77b51e12889b7bd9fc76", "url": "https://api.github.com/repos/rust-lang/rust/commits/1d06058a77beffb6347c77b51e12889b7bd9fc76", "html_url": "https://github.com/rust-lang/rust/commit/1d06058a77beffb6347c77b51e12889b7bd9fc76"}], "stats": {"total": 100, "additions": 50, "deletions": 50}, "files": [{"sha": "638ce1679b8e98dc0c4db2f37b0462f9516d4a8c", "filename": "src/libstd/panicking.rs", "status": "modified", "additions": 15, "deletions": 19, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/ae2a720e92f78e76db5b7c1d6308fcd87d5c5281/src%2Flibstd%2Fpanicking.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ae2a720e92f78e76db5b7c1d6308fcd87d5c5281/src%2Flibstd%2Fpanicking.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fpanicking.rs?ref=ae2a720e92f78e76db5b7c1d6308fcd87d5c5281", "patch": "@@ -15,9 +15,11 @@ use crate::intrinsics;\n use crate::mem;\n use crate::ptr;\n use crate::raw;\n+use crate::sync::atomic::{AtomicBool, Ordering};\n use crate::sys::stdio::panic_output;\n use crate::sys_common::rwlock::RWLock;\n-use crate::sys_common::{thread_info, util, backtrace};\n+use crate::sys_common::{thread_info, util};\n+use crate::sys_common::backtrace::{self, RustBacktrace};\n use crate::thread;\n \n #[cfg(not(test))]\n@@ -158,16 +160,10 @@ pub fn take_hook() -> Box<dyn Fn(&PanicInfo<'_>) + 'static + Sync + Send> {\n fn default_hook(info: &PanicInfo<'_>) {\n     // If this is a double panic, make sure that we print a backtrace\n     // for this panic. Otherwise only print it if logging is enabled.\n-    let log_backtrace = if cfg!(feature = \"backtrace\") {\n-        let panics = update_panic_count(0);\n-\n-        if panics >= 2 {\n-            Some(backtrace_rs::PrintFmt::Full)\n-        } else {\n-            backtrace::log_enabled()\n-        }\n+    let backtrace_env = if update_panic_count(0) >= 2 {\n+        RustBacktrace::Print(backtrace_rs::PrintFmt::Full)\n     } else {\n-        None\n+        backtrace::rust_backtrace_env()\n     };\n \n     // The current implementation always returns `Some`.\n@@ -187,16 +183,16 @@ fn default_hook(info: &PanicInfo<'_>) {\n         let _ = writeln!(err, \"thread '{}' panicked at '{}', {}\",\n                          name, msg, location);\n \n-        if cfg!(feature = \"backtrace\") {\n-            use crate::sync::atomic::{AtomicBool, Ordering};\n-\n-            static FIRST_PANIC: AtomicBool = AtomicBool::new(true);\n+        static FIRST_PANIC: AtomicBool = AtomicBool::new(true);\n \n-            if let Some(format) = log_backtrace {\n-                let _ = backtrace::print(err, format);\n-            } else if FIRST_PANIC.compare_and_swap(true, false, Ordering::SeqCst) {\n-                let _ = writeln!(err, \"note: run with `RUST_BACKTRACE=1` \\\n-                                       environment variable to display a backtrace.\");\n+        match backtrace_env {\n+            RustBacktrace::Print(format) => drop(backtrace::print(err, format)),\n+            RustBacktrace::Disabled => {}\n+            RustBacktrace::RuntimeDisabled => {\n+                if FIRST_PANIC.swap(false, Ordering::SeqCst) {\n+                    let _ = writeln!(err, \"note: run with `RUST_BACKTRACE=1` \\\n+                                           environment variable to display a backtrace.\");\n+                }\n             }\n         }\n     };"}, {"sha": "63e35d5ed919a294fa1c191479b008650b363aac", "filename": "src/libstd/rt.rs", "status": "modified", "additions": 0, "deletions": 3, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/ae2a720e92f78e76db5b7c1d6308fcd87d5c5281/src%2Flibstd%2Frt.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ae2a720e92f78e76db5b7c1d6308fcd87d5c5281/src%2Flibstd%2Frt.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Frt.rs?ref=ae2a720e92f78e76db5b7c1d6308fcd87d5c5281", "patch": "@@ -44,12 +44,9 @@ fn lang_start_internal(main: &(dyn Fn() -> i32 + Sync + crate::panic::RefUnwindS\n         sys::args::init(argc, argv);\n \n         // Let's run some code!\n-        #[cfg(feature = \"backtrace\")]\n         let exit_code = panic::catch_unwind(|| {\n             sys_common::backtrace::__rust_begin_short_backtrace(move || main())\n         });\n-        #[cfg(not(feature = \"backtrace\"))]\n-        let exit_code = panic::catch_unwind(move || main());\n \n         sys_common::cleanup();\n         exit_code.unwrap_or(101) as isize"}, {"sha": "9c406ec39cc45a3afebe9154db865346318337a2", "filename": "src/libstd/sys_common/backtrace.rs", "status": "modified", "additions": 35, "deletions": 25, "changes": 60, "blob_url": "https://github.com/rust-lang/rust/blob/ae2a720e92f78e76db5b7c1d6308fcd87d5c5281/src%2Flibstd%2Fsys_common%2Fbacktrace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ae2a720e92f78e76db5b7c1d6308fcd87d5c5281/src%2Flibstd%2Fsys_common%2Fbacktrace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys_common%2Fbacktrace.rs?ref=ae2a720e92f78e76db5b7c1d6308fcd87d5c5281", "patch": "@@ -7,6 +7,7 @@ use crate::io;\n use crate::borrow::Cow;\n use crate::io::prelude::*;\n use crate::path::{self, Path, PathBuf};\n+use crate::sync::atomic::{self, Ordering};\n use crate::sys::mutex::Mutex;\n \n use backtrace_rs::{BacktraceFmt, BytesOrWideString, PrintFmt};\n@@ -115,8 +116,10 @@ unsafe fn _print_fmt(fmt: &mut fmt::Formatter<'_>, print_fmt: PrintFmt) -> fmt::\n     Ok(())\n }\n \n-/// Fixed frame used to clean the backtrace with `RUST_BACKTRACE=1`.\n-#[inline(never)]\n+/// Fixed frame used to clean the backtrace with `RUST_BACKTRACE=1`. Note that\n+/// this is only inline(never) when backtraces in libstd are enabled, otherwise\n+/// it's fine to optimize away.\n+#[cfg_attr(feature = \"backtrace\", inline(never))]\n pub fn __rust_begin_short_backtrace<F, T>(f: F) -> T\n where\n     F: FnOnce() -> T,\n@@ -126,42 +129,49 @@ where\n     f()\n }\n \n+pub enum RustBacktrace {\n+    Print(PrintFmt),\n+    Disabled,\n+    RuntimeDisabled,\n+}\n+\n // For now logging is turned off by default, and this function checks to see\n // whether the magical environment variable is present to see if it's turned on.\n-pub fn log_enabled() -> Option<PrintFmt> {\n-    use crate::sync::atomic::{self, Ordering};\n+pub fn rust_backtrace_env() -> RustBacktrace {\n+    // If the `backtrace` feature of this crate isn't enabled quickly return\n+    // `None` so this can be constant propagated all over the place to turn\n+    // optimize away callers.\n+    if !cfg!(feature = \"backtrace\") {\n+        return RustBacktrace::Disabled;\n+    }\n \n     // Setting environment variables for Fuchsia components isn't a standard\n     // or easily supported workflow. For now, always display backtraces.\n     if cfg!(target_os = \"fuchsia\") {\n-        return Some(PrintFmt::Full);\n+        return RustBacktrace::Print(PrintFmt::Full);\n     }\n \n     static ENABLED: atomic::AtomicIsize = atomic::AtomicIsize::new(0);\n     match ENABLED.load(Ordering::SeqCst) {\n         0 => {}\n-        1 => return None,\n-        2 => return Some(PrintFmt::Short),\n-        _ => return Some(PrintFmt::Full),\n+        1 => return RustBacktrace::RuntimeDisabled,\n+        2 => return RustBacktrace::Print(PrintFmt::Short),\n+        _ => return RustBacktrace::Print(PrintFmt::Full),\n     }\n \n-    let val = env::var_os(\"RUST_BACKTRACE\").and_then(|x| {\n-        if &x == \"0\" {\n-            None\n-        } else if &x == \"full\" {\n-            Some(PrintFmt::Full)\n-        } else {\n-            Some(PrintFmt::Short)\n-        }\n-    });\n-    ENABLED.store(\n-        match val {\n-            Some(v) => v as isize,\n-            None => 1,\n-        },\n-        Ordering::SeqCst,\n-    );\n-    val\n+    let (format, cache) = env::var_os(\"RUST_BACKTRACE\")\n+        .map(|x| {\n+            if &x == \"0\" {\n+                (RustBacktrace::RuntimeDisabled, 1)\n+            } else if &x == \"full\" {\n+                (RustBacktrace::Print(PrintFmt::Full), 3)\n+            } else {\n+                (RustBacktrace::Print(PrintFmt::Short), 2)\n+            }\n+        })\n+        .unwrap_or((RustBacktrace::RuntimeDisabled, 1));\n+    ENABLED.store(cache, Ordering::SeqCst);\n+    format\n }\n \n /// Prints the filename of the backtrace frame."}, {"sha": "0ffa6ace2e4d2ea73ce1824b2149152c2bd90b70", "filename": "src/libstd/thread/mod.rs", "status": "modified", "additions": 0, "deletions": 3, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/ae2a720e92f78e76db5b7c1d6308fcd87d5c5281/src%2Flibstd%2Fthread%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ae2a720e92f78e76db5b7c1d6308fcd87d5c5281/src%2Flibstd%2Fthread%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fthread%2Fmod.rs?ref=ae2a720e92f78e76db5b7c1d6308fcd87d5c5281", "patch": "@@ -465,12 +465,9 @@ impl Builder {\n             }\n \n             thread_info::set(imp::guard::current(), their_thread);\n-            #[cfg(feature = \"backtrace\")]\n             let try_result = panic::catch_unwind(panic::AssertUnwindSafe(|| {\n                 crate::sys_common::backtrace::__rust_begin_short_backtrace(f)\n             }));\n-            #[cfg(not(feature = \"backtrace\"))]\n-            let try_result = panic::catch_unwind(panic::AssertUnwindSafe(f));\n             *their_packet.get() = Some(try_result);\n         };\n "}]}