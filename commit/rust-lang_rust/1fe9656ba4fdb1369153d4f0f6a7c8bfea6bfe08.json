{"sha": "1fe9656ba4fdb1369153d4f0f6a7c8bfea6bfe08", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFmZTk2NTZiYTRmZGIxMzY5MTUzZDRmMGY2YTdjOGJmZWE2YmZlMDg=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-11-27T09:47:18Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-11-27T09:47:18Z"}, "message": "Decouple", "tree": {"sha": "1b8a22d7991901808f1801c25feaaeaf141901b5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1b8a22d7991901808f1801c25feaaeaf141901b5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1fe9656ba4fdb1369153d4f0f6a7c8bfea6bfe08", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1fe9656ba4fdb1369153d4f0f6a7c8bfea6bfe08", "html_url": "https://github.com/rust-lang/rust/commit/1fe9656ba4fdb1369153d4f0f6a7c8bfea6bfe08", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1fe9656ba4fdb1369153d4f0f6a7c8bfea6bfe08/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "825049bc6247f6d596910cd99f76f891d5435a86", "url": "https://api.github.com/repos/rust-lang/rust/commits/825049bc6247f6d596910cd99f76f891d5435a86", "html_url": "https://github.com/rust-lang/rust/commit/825049bc6247f6d596910cd99f76f891d5435a86"}], "stats": {"total": 56, "additions": 32, "deletions": 24}, "files": [{"sha": "76189a60b14e1e4381f5500681ebd978d7aa5820", "filename": "crates/ra_hir/src/ty/traits.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/1fe9656ba4fdb1369153d4f0f6a7c8bfea6bfe08/crates%2Fra_hir%2Fsrc%2Fty%2Ftraits.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1fe9656ba4fdb1369153d4f0f6a7c8bfea6bfe08/crates%2Fra_hir%2Fsrc%2Fty%2Ftraits.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fty%2Ftraits.rs?ref=1fe9656ba4fdb1369153d4f0f6a7c8bfea6bfe08", "patch": "@@ -8,7 +8,7 @@ use ra_db::{impl_intern_key, salsa, CrateId};\n use ra_prof::profile;\n use rustc_hash::FxHashSet;\n \n-use crate::{db::HirDatabase, ImplBlock};\n+use crate::db::HirDatabase;\n \n use super::{Canonical, GenericPredicate, HirDisplay, ProjectionTy, TraitRef, Ty, TypeWalk};\n \n@@ -302,7 +302,7 @@ pub struct ClosureFnTraitImplData {\n #[derive(Debug, Clone, PartialEq, Eq, Hash)]\n pub enum Impl {\n     /// A normal impl from an impl block.\n-    ImplBlock(ImplBlock),\n+    ImplBlock(ImplId),\n     /// Closure types implement the Fn traits synthetically.\n     ClosureFnTraitImpl(ClosureFnTraitImplData),\n }"}, {"sha": "67ac5422cf9f0d31a356089c1b0593ec9debc6fa", "filename": "crates/ra_hir/src/ty/traits/chalk.rs", "status": "modified", "additions": 30, "deletions": 22, "changes": 52, "blob_url": "https://github.com/rust-lang/rust/blob/1fe9656ba4fdb1369153d4f0f6a7c8bfea6bfe08/crates%2Fra_hir%2Fsrc%2Fty%2Ftraits%2Fchalk.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1fe9656ba4fdb1369153d4f0f6a7c8bfea6bfe08/crates%2Fra_hir%2Fsrc%2Fty%2Ftraits%2Fchalk.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fty%2Ftraits%2Fchalk.rs?ref=1fe9656ba4fdb1369153d4f0f6a7c8bfea6bfe08", "patch": "@@ -4,15 +4,15 @@ use std::sync::Arc;\n use log::debug;\n \n use chalk_ir::{\n-    cast::Cast, family::ChalkIr, Identifier, ImplId, Parameter, PlaceholderIndex, TypeId,\n-    TypeKindId, TypeName, UniverseIndex,\n+    cast::Cast, family::ChalkIr, Identifier, Parameter, PlaceholderIndex, TypeId, TypeKindId,\n+    TypeName, UniverseIndex,\n };\n use chalk_rust_ir::{AssociatedTyDatum, AssociatedTyValue, ImplDatum, StructDatum, TraitDatum};\n use ra_db::CrateId;\n \n use hir_def::{\n-    lang_item::LangItemTarget, resolver::HasResolver, AstItemDef, ContainerId, GenericDefId,\n-    Lookup, TraitId, TypeAliasId,\n+    lang_item::LangItemTarget, resolver::HasResolver, AssocItemId, AstItemDef, ContainerId,\n+    GenericDefId, ImplId, Lookup, TraitId, TypeAliasId,\n };\n use hir_expand::name;\n \n@@ -23,7 +23,6 @@ use crate::{\n     db::HirDatabase,\n     ty::display::HirDisplay,\n     ty::{ApplicationTy, GenericPredicate, ProjectionTy, Substs, TraitRef, Ty, TypeCtor, TypeWalk},\n-    ImplBlock,\n };\n \n /// This represents a trait whose name we could not resolve.\n@@ -435,14 +434,14 @@ where\n     fn struct_datum(&self, struct_id: chalk_ir::StructId) -> Arc<StructDatum<ChalkIr>> {\n         self.db.struct_datum(self.krate, struct_id)\n     }\n-    fn impl_datum(&self, impl_id: ImplId) -> Arc<ImplDatum<ChalkIr>> {\n+    fn impl_datum(&self, impl_id: chalk_ir::ImplId) -> Arc<ImplDatum<ChalkIr>> {\n         self.db.impl_datum(self.krate, impl_id)\n     }\n     fn impls_for_trait(\n         &self,\n         trait_id: chalk_ir::TraitId,\n         parameters: &[Parameter<ChalkIr>],\n-    ) -> Vec<ImplId> {\n+    ) -> Vec<chalk_ir::ImplId> {\n         debug!(\"impls_for_trait {:?}\", trait_id);\n         if trait_id == UNKNOWN_TRAIT {\n             return Vec::new();\n@@ -614,7 +613,7 @@ pub(crate) fn struct_datum_query(\n pub(crate) fn impl_datum_query(\n     db: &impl HirDatabase,\n     krate: CrateId,\n-    impl_id: ImplId,\n+    impl_id: chalk_ir::ImplId,\n ) -> Arc<ImplDatum<ChalkIr>> {\n     let _p = ra_prof::profile(\"impl_datum\");\n     debug!(\"impl_datum {:?}\", impl_id);\n@@ -629,23 +628,31 @@ pub(crate) fn impl_datum_query(\n fn impl_block_datum(\n     db: &impl HirDatabase,\n     krate: CrateId,\n+    chalk_id: chalk_ir::ImplId,\n     impl_id: ImplId,\n-    impl_block: ImplBlock,\n ) -> Option<Arc<ImplDatum<ChalkIr>>> {\n-    let generic_params = db.generic_params(impl_block.id.into());\n+    let impl_data = db.impl_data(impl_id);\n+    let resolver = impl_id.resolver(db);\n+    let target_ty = Ty::from_hir(db, &resolver, &impl_data.target_type);\n+\n+    // `CoerseUnsized` has one generic parameter for the target type.\n+    let trait_ref =\n+        TraitRef::from_hir(db, &resolver, impl_data.target_trait.as_ref()?, Some(target_ty))?;\n+\n+    let generic_params = db.generic_params(impl_id.into());\n     let bound_vars = Substs::bound_vars(&generic_params);\n-    let trait_ref = impl_block.target_trait_ref(db)?.subst(&bound_vars);\n+    let trait_ref = trait_ref.subst(&bound_vars);\n     let trait_ = trait_ref.trait_;\n-    let impl_type = if impl_block.krate(db).crate_id == krate {\n+    let impl_type = if impl_id.module(db).krate == krate {\n         chalk_rust_ir::ImplType::Local\n     } else {\n         chalk_rust_ir::ImplType::External\n     };\n-    let where_clauses = convert_where_clauses(db, impl_block.id.into(), &bound_vars);\n-    let negative = impl_block.is_negative(db);\n+    let where_clauses = convert_where_clauses(db, impl_id.into(), &bound_vars);\n+    let negative = impl_data.is_negative;\n     debug!(\n         \"impl {:?}: {}{} where {:?}\",\n-        impl_id,\n+        chalk_id,\n         if negative { \"!\" } else { \"\" },\n         trait_ref.display(db),\n         where_clauses\n@@ -660,18 +667,19 @@ fn impl_block_datum(\n \n     let impl_datum_bound = chalk_rust_ir::ImplDatumBound { trait_ref, where_clauses };\n     let trait_data = db.trait_data(trait_);\n-    let associated_ty_value_ids = impl_block\n-        .items(db)\n-        .into_iter()\n+    let associated_ty_value_ids = impl_data\n+        .items\n+        .iter()\n         .filter_map(|item| match item {\n-            crate::AssocItem::TypeAlias(type_alias) => Some(type_alias),\n+            AssocItemId::TypeAliasId(type_alias) => Some(*type_alias),\n             _ => None,\n         })\n-        .filter(|type_alias| {\n+        .filter(|&type_alias| {\n             // don't include associated types that don't exist in the trait\n-            trait_data.associated_type_by_name(&type_alias.name(db)).is_some()\n+            let name = &db.type_alias_data(type_alias).name;\n+            trait_data.associated_type_by_name(name).is_some()\n         })\n-        .map(|type_alias| AssocTyValue::TypeAlias(type_alias.id).to_chalk(db))\n+        .map(|type_alias| AssocTyValue::TypeAlias(type_alias).to_chalk(db))\n         .collect();\n     debug!(\"impl_datum: {:?}\", impl_datum_bound);\n     let impl_datum = ImplDatum {"}]}