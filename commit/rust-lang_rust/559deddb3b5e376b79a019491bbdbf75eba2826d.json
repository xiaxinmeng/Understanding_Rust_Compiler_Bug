{"sha": "559deddb3b5e376b79a019491bbdbf75eba2826d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU1OWRlZGRiM2I1ZTM3NmI3OWEwMTk0OTFiYmRiZjc1ZWJhMjgyNmQ=", "commit": {"author": {"name": "Jason Newcomb", "email": "jsnewcomb@pm.me", "date": "2021-04-15T15:49:45Z"}, "committer": {"name": "Jason Newcomb", "email": "jsnewcomb@pm.me", "date": "2021-04-16T19:24:46Z"}, "message": "Allow allman style braces in `suspicious_else_formatting`", "tree": {"sha": "7e415e3d73b662451e1a89f2264f04afbd85b095", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7e415e3d73b662451e1a89f2264f04afbd85b095"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/559deddb3b5e376b79a019491bbdbf75eba2826d", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\nComment: Created with Krypton\n\niF4EABYKAAYFAmB55I0ACgkQ2lnoZDo37Qbr/wEAnJVaOnTK+p4vY0FdvD3FLr1/\nEV564vDEYk3PqGlN23wA/2IR1Wcav7DrBtUD4KidYuqRxYEr3Ss4YZGtgwi/IKYI\n=V+F6\n-----END PGP SIGNATURE-----", "payload": "tree 7e415e3d73b662451e1a89f2264f04afbd85b095\nparent 586a99348c6a6f5309e82b340193067b7d76e37c\nauthor Jason Newcomb <jsnewcomb@pm.me> 1618501785 -0400\ncommitter Jason Newcomb <jsnewcomb@pm.me> 1618601086 -0400\n\nAllow allman style braces in `suspicious_else_formatting`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/559deddb3b5e376b79a019491bbdbf75eba2826d", "html_url": "https://github.com/rust-lang/rust/commit/559deddb3b5e376b79a019491bbdbf75eba2826d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/559deddb3b5e376b79a019491bbdbf75eba2826d/comments", "author": {"login": "Jarcho", "id": 7761774, "node_id": "MDQ6VXNlcjc3NjE3NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/7761774?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Jarcho", "html_url": "https://github.com/Jarcho", "followers_url": "https://api.github.com/users/Jarcho/followers", "following_url": "https://api.github.com/users/Jarcho/following{/other_user}", "gists_url": "https://api.github.com/users/Jarcho/gists{/gist_id}", "starred_url": "https://api.github.com/users/Jarcho/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Jarcho/subscriptions", "organizations_url": "https://api.github.com/users/Jarcho/orgs", "repos_url": "https://api.github.com/users/Jarcho/repos", "events_url": "https://api.github.com/users/Jarcho/events{/privacy}", "received_events_url": "https://api.github.com/users/Jarcho/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Jarcho", "id": 7761774, "node_id": "MDQ6VXNlcjc3NjE3NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/7761774?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Jarcho", "html_url": "https://github.com/Jarcho", "followers_url": "https://api.github.com/users/Jarcho/followers", "following_url": "https://api.github.com/users/Jarcho/following{/other_user}", "gists_url": "https://api.github.com/users/Jarcho/gists{/gist_id}", "starred_url": "https://api.github.com/users/Jarcho/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Jarcho/subscriptions", "organizations_url": "https://api.github.com/users/Jarcho/orgs", "repos_url": "https://api.github.com/users/Jarcho/repos", "events_url": "https://api.github.com/users/Jarcho/events{/privacy}", "received_events_url": "https://api.github.com/users/Jarcho/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "586a99348c6a6f5309e82b340193067b7d76e37c", "url": "https://api.github.com/repos/rust-lang/rust/commits/586a99348c6a6f5309e82b340193067b7d76e37c", "html_url": "https://github.com/rust-lang/rust/commit/586a99348c6a6f5309e82b340193067b7d76e37c"}], "stats": {"total": 82, "additions": 67, "deletions": 15}, "files": [{"sha": "3bd6a09d3653aeb0a60887d8df220196f910d16b", "filename": "clippy_lints/src/formatting.rs", "status": "modified", "additions": 15, "deletions": 2, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/559deddb3b5e376b79a019491bbdbf75eba2826d/clippy_lints%2Fsrc%2Fformatting.rs", "raw_url": "https://github.com/rust-lang/rust/raw/559deddb3b5e376b79a019491bbdbf75eba2826d/clippy_lints%2Fsrc%2Fformatting.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fformatting.rs?ref=559deddb3b5e376b79a019491bbdbf75eba2826d", "patch": "@@ -215,9 +215,22 @@ fn check_else(cx: &EarlyContext<'_>, expr: &Expr) {\n         // the snippet should look like \" else \\n    \" with maybe comments anywhere\n         // it\u2019s bad when there is a \u2018\\n\u2019 after the \u201celse\u201d\n         if let Some(else_snippet) = snippet_opt(cx, else_span);\n-        if let Some(else_pos) = else_snippet.find(\"else\");\n-        if else_snippet[else_pos..].contains('\\n');\n+        if let Some((pre_else, post_else)) = else_snippet.split_once(\"else\");\n+        if let Some((_, post_else_post_eol)) = post_else.split_once('\\n');\n+\n         then {\n+            // Allow allman style braces `} \\n else \\n {`\n+            if_chain! {\n+                if is_block(else_);\n+                if let Some((_, pre_else_post_eol)) = pre_else.split_once('\\n');\n+                // Exactly one eol before and after the else\n+                if !pre_else_post_eol.contains('\\n');\n+                if !post_else_post_eol.contains('\\n');\n+                then {\n+                    return;\n+                }\n+            }\n+\n             let else_desc = if is_if(else_) { \"if\" } else { \"{..}\" };\n             span_lint_and_note(\n                 cx,"}, {"sha": "547615b10d9fb11741e2d9e59a1dbc2cc26f53cd", "filename": "tests/ui/suspicious_else_formatting.rs", "status": "modified", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/559deddb3b5e376b79a019491bbdbf75eba2826d/tests%2Fui%2Fsuspicious_else_formatting.rs", "raw_url": "https://github.com/rust-lang/rust/raw/559deddb3b5e376b79a019491bbdbf75eba2826d/tests%2Fui%2Fsuspicious_else_formatting.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fsuspicious_else_formatting.rs?ref=559deddb3b5e376b79a019491bbdbf75eba2826d", "patch": "@@ -40,6 +40,7 @@ fn main() {\n     {\n     }\n \n+    // This is fine, though weird. Allman style braces on the else.\n     if foo() {\n     }\n     else\n@@ -76,4 +77,29 @@ fn main() {\n     }\n     if foo() {\n     }\n+\n+    // Almost Allman style braces. Lint these.\n+    if foo() {\n+    }\n+\n+    else\n+    {\n+\n+    }\n+\n+    if foo() {\n+    }\n+    else\n+\n+    {\n+\n+    }\n+\n+    // #3864 - Allman style braces\n+    if foo()\n+    {\n+    }\n+    else\n+    {\n+    }\n }"}, {"sha": "d8d67b4138ab3b95c9f107c4265ead6548416846", "filename": "tests/ui/suspicious_else_formatting.stderr", "status": "modified", "additions": 26, "deletions": 13, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/559deddb3b5e376b79a019491bbdbf75eba2826d/tests%2Fui%2Fsuspicious_else_formatting.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/559deddb3b5e376b79a019491bbdbf75eba2826d/tests%2Fui%2Fsuspicious_else_formatting.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fsuspicious_else_formatting.stderr?ref=559deddb3b5e376b79a019491bbdbf75eba2826d", "patch": "@@ -41,37 +41,50 @@ LL | |     {\n    |\n    = note: to remove this lint, remove the `else` or remove the new line between `else` and `{..}`\n \n-error: this is an `else {..}` but the formatting might hide it\n-  --> $DIR/suspicious_else_formatting.rs:44:6\n+error: this is an `else if` but the formatting might hide it\n+  --> $DIR/suspicious_else_formatting.rs:51:6\n    |\n-LL |       }\n+LL |       } else\n    |  ______^\n-LL | |     else\n-LL | |     {\n+LL | |     if foo() { // the span of the above error should continue here\n    | |____^\n    |\n-   = note: to remove this lint, remove the `else` or remove the new line between `else` and `{..}`\n+   = note: to remove this lint, remove the `else` or remove the new line between `else` and `if`\n \n error: this is an `else if` but the formatting might hide it\n-  --> $DIR/suspicious_else_formatting.rs:50:6\n+  --> $DIR/suspicious_else_formatting.rs:56:6\n    |\n-LL |       } else\n+LL |       }\n    |  ______^\n+LL | |     else\n LL | |     if foo() { // the span of the above error should continue here\n    | |____^\n    |\n    = note: to remove this lint, remove the `else` or remove the new line between `else` and `if`\n \n-error: this is an `else if` but the formatting might hide it\n-  --> $DIR/suspicious_else_formatting.rs:55:6\n+error: this is an `else {..}` but the formatting might hide it\n+  --> $DIR/suspicious_else_formatting.rs:83:6\n    |\n LL |       }\n    |  ______^\n+LL | |\n LL | |     else\n-LL | |     if foo() { // the span of the above error should continue here\n+LL | |     {\n    | |____^\n    |\n-   = note: to remove this lint, remove the `else` or remove the new line between `else` and `if`\n+   = note: to remove this lint, remove the `else` or remove the new line between `else` and `{..}`\n+\n+error: this is an `else {..}` but the formatting might hide it\n+  --> $DIR/suspicious_else_formatting.rs:91:6\n+   |\n+LL |       }\n+   |  ______^\n+LL | |     else\n+LL | |\n+LL | |     {\n+   | |____^\n+   |\n+   = note: to remove this lint, remove the `else` or remove the new line between `else` and `{..}`\n \n-error: aborting due to 8 previous errors\n+error: aborting due to 9 previous errors\n "}]}