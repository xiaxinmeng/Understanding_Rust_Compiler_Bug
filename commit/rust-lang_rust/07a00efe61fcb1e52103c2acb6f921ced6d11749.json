{"sha": "07a00efe61fcb1e52103c2acb6f921ced6d11749", "node_id": "C_kwDOAAsO6NoAKDA3YTAwZWZlNjFmY2IxZTUyMTAzYzJhY2I2ZjkyMWNlZDZkMTE3NDk", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume.gomez@huawei.com", "date": "2021-12-19T14:10:36Z"}, "committer": {"name": "Guillaume Gomez", "email": "guillaume.gomez@huawei.com", "date": "2021-12-19T14:48:57Z"}, "message": "Don't emit RETURN_SELF_NOT_MUST_USE lint if `Self` already is marked as `#[must_use]`", "tree": {"sha": "1d235940fe432dbfa63e7dc638c754725d29477a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1d235940fe432dbfa63e7dc638c754725d29477a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/07a00efe61fcb1e52103c2acb6f921ced6d11749", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/07a00efe61fcb1e52103c2acb6f921ced6d11749", "html_url": "https://github.com/rust-lang/rust/commit/07a00efe61fcb1e52103c2acb6f921ced6d11749", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/07a00efe61fcb1e52103c2acb6f921ced6d11749/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4da55202050818d7bb2ac5d4eabdf8dd1a1b7ff9", "url": "https://api.github.com/repos/rust-lang/rust/commits/4da55202050818d7bb2ac5d4eabdf8dd1a1b7ff9", "html_url": "https://github.com/rust-lang/rust/commit/4da55202050818d7bb2ac5d4eabdf8dd1a1b7ff9"}], "stats": {"total": 21, "additions": 16, "deletions": 5}, "files": [{"sha": "b57ec96bc7e6d101a41d53aa1622bca70cd473cf", "filename": "clippy_lints/src/return_self_not_must_use.rs", "status": "modified", "additions": 6, "deletions": 5, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/07a00efe61fcb1e52103c2acb6f921ced6d11749/clippy_lints%2Fsrc%2Freturn_self_not_must_use.rs", "raw_url": "https://github.com/rust-lang/rust/raw/07a00efe61fcb1e52103c2acb6f921ced6d11749/clippy_lints%2Fsrc%2Freturn_self_not_must_use.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Freturn_self_not_must_use.rs?ref=07a00efe61fcb1e52103c2acb6f921ced6d11749", "patch": "@@ -1,4 +1,5 @@\n-use clippy_utils::{diagnostics::span_lint, must_use_attr, nth_arg, return_ty};\n+use clippy_utils::ty::is_must_use_ty;\n+use clippy_utils::{diagnostics::span_lint, nth_arg, return_ty};\n use rustc_hir::def_id::LocalDefId;\n use rustc_hir::intravisit::FnKind;\n use rustc_hir::{Body, FnDecl, HirId, TraitItem, TraitItemKind};\n@@ -50,16 +51,18 @@ fn check_method(cx: &LateContext<'tcx>, decl: &'tcx FnDecl<'tcx>, fn_def: LocalD\n         if decl.implicit_self.has_implicit_self();\n         // We only show this warning for public exported methods.\n         if cx.access_levels.is_exported(fn_def);\n+        // We don't want to emit this lint if the `#[must_use]` attribute is already there.\n+        if !cx.tcx.hir().attrs(hir_id).iter().any(|attr| attr.has_name(sym::must_use));\n         if cx.tcx.visibility(fn_def.to_def_id()).is_public();\n-        // No need to warn if the attribute is already present.\n-        if must_use_attr(cx.tcx.hir().attrs(hir_id)).is_none();\n         let ret_ty = return_ty(cx, hir_id);\n         let self_arg = nth_arg(cx, hir_id, 0);\n         // If `Self` has the same type as the returned type, then we want to warn.\n         //\n         // For this check, we don't want to remove the reference on the returned type because if\n         // there is one, we shouldn't emit a warning!\n         if self_arg.peel_refs() == ret_ty;\n+        // If `Self` is already marked as `#[must_use]`, no need for the attribute here.\n+        if !is_must_use_ty(cx, ret_ty);\n \n         then {\n             span_lint(\n@@ -86,8 +89,6 @@ impl<'tcx> LateLintPass<'tcx> for ReturnSelfNotMustUse {\n             // We are only interested in methods, not in functions or associated functions.\n             if matches!(kind, FnKind::Method(_, _, _));\n             if let Some(fn_def) = cx.tcx.hir().opt_local_def_id(hir_id);\n-            // We don't want to emit this lint if the `#[must_use]` attribute is already there.\n-            if !cx.tcx.hir().attrs(hir_id).iter().any(|attr| attr.has_name(sym::must_use));\n             if let Some(impl_def) = cx.tcx.impl_of_method(fn_def.to_def_id());\n             // We don't want this method to be te implementation of a trait because the\n             // `#[must_use]` should be put on the trait definition directly."}, {"sha": "7dd5742dae9f213d5038af6d0422b6b201342db6", "filename": "tests/ui/return_self_not_must_use.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/07a00efe61fcb1e52103c2acb6f921ced6d11749/tests%2Fui%2Freturn_self_not_must_use.rs", "raw_url": "https://github.com/rust-lang/rust/raw/07a00efe61fcb1e52103c2acb6f921ced6d11749/tests%2Fui%2Freturn_self_not_must_use.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Freturn_self_not_must_use.rs?ref=07a00efe61fcb1e52103c2acb6f921ced6d11749", "patch": "@@ -45,3 +45,13 @@ impl Whatever for Bar {\n         self\n     }\n }\n+\n+#[must_use]\n+pub struct Foo;\n+\n+impl Foo {\n+    // There should be no warning here! (`Foo` already implements `#[must_use]`)\n+    fn foo(&self) -> Self {\n+        Self\n+    }\n+}"}]}