{"sha": "5436f859e46de9057260269049865b6cdb1d9ddd", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU0MzZmODU5ZTQ2ZGU5MDU3MjYwMjY5MDQ5ODY1YjZjZGIxZDlkZGQ=", "commit": {"author": {"name": "gaurikholkar", "email": "f2013002@goa.bits-pilani.ac.in", "date": "2017-04-15T04:04:37Z"}, "committer": {"name": "gaurikholkar", "email": "f2013002@goa.bits-pilani.ac.in", "date": "2017-04-28T08:31:42Z"}, "message": "Disable ref hint for pattern in let and adding ui-tests.", "tree": {"sha": "2128218b5a8833c2514efcf919d189bd0257d575", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2128218b5a8833c2514efcf919d189bd0257d575"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5436f859e46de9057260269049865b6cdb1d9ddd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5436f859e46de9057260269049865b6cdb1d9ddd", "html_url": "https://github.com/rust-lang/rust/commit/5436f859e46de9057260269049865b6cdb1d9ddd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5436f859e46de9057260269049865b6cdb1d9ddd/comments", "author": {"login": "gaurikholkar", "id": 117768111, "node_id": "U_kgDOBwT_rw", "avatar_url": "https://avatars.githubusercontent.com/u/117768111?v=4", "gravatar_id": "", "url": "https://api.github.com/users/gaurikholkar", "html_url": "https://github.com/gaurikholkar", "followers_url": "https://api.github.com/users/gaurikholkar/followers", "following_url": "https://api.github.com/users/gaurikholkar/following{/other_user}", "gists_url": "https://api.github.com/users/gaurikholkar/gists{/gist_id}", "starred_url": "https://api.github.com/users/gaurikholkar/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/gaurikholkar/subscriptions", "organizations_url": "https://api.github.com/users/gaurikholkar/orgs", "repos_url": "https://api.github.com/users/gaurikholkar/repos", "events_url": "https://api.github.com/users/gaurikholkar/events{/privacy}", "received_events_url": "https://api.github.com/users/gaurikholkar/received_events", "type": "User", "site_admin": false}, "committer": {"login": "gaurikholkar", "id": 117768111, "node_id": "U_kgDOBwT_rw", "avatar_url": "https://avatars.githubusercontent.com/u/117768111?v=4", "gravatar_id": "", "url": "https://api.github.com/users/gaurikholkar", "html_url": "https://github.com/gaurikholkar", "followers_url": "https://api.github.com/users/gaurikholkar/followers", "following_url": "https://api.github.com/users/gaurikholkar/following{/other_user}", "gists_url": "https://api.github.com/users/gaurikholkar/gists{/gist_id}", "starred_url": "https://api.github.com/users/gaurikholkar/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/gaurikholkar/subscriptions", "organizations_url": "https://api.github.com/users/gaurikholkar/orgs", "repos_url": "https://api.github.com/users/gaurikholkar/repos", "events_url": "https://api.github.com/users/gaurikholkar/events{/privacy}", "received_events_url": "https://api.github.com/users/gaurikholkar/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ace517da0d1e356aa5b42f4cdee6854538591ef2", "url": "https://api.github.com/repos/rust-lang/rust/commits/ace517da0d1e356aa5b42f4cdee6854538591ef2", "html_url": "https://github.com/rust-lang/rust/commit/ace517da0d1e356aa5b42f4cdee6854538591ef2"}], "stats": {"total": 152, "additions": 132, "deletions": 20}, "files": [{"sha": "1948dd909f470b21b48f5b11a6dc2c1594d5e6b5", "filename": "src/librustc/hir/map/mod.rs", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/5436f859e46de9057260269049865b6cdb1d9ddd/src%2Flibrustc%2Fhir%2Fmap%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5436f859e46de9057260269049865b6cdb1d9ddd/src%2Flibrustc%2Fhir%2Fmap%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Fmap%2Fmod.rs?ref=5436f859e46de9057260269049865b6cdb1d9ddd", "patch": "@@ -95,6 +95,14 @@ enum MapEntry<'hir> {\n     RootCrate,\n }\n \n+/// Represents the kind of pattern\n+#[derive(Debug, Clone, Copy)]\n+pub enum PatternSource<'hir> {\n+    MatchExpr(&'hir Expr),\n+    LetDecl(&'hir Local),\n+    Other,\n+}\n+\n impl<'hir> Clone for MapEntry<'hir> {\n     fn clone(&self) -> MapEntry<'hir> {\n         *self\n@@ -637,7 +645,7 @@ impl<'hir> Map<'hir> {\n             Err(id) => id,\n         }\n     }\n-\n+    \n     /// Returns the nearest enclosing scope. A scope is an item or block.\n     /// FIXME it is not clear to me that all items qualify as scopes - statics\n     /// and associated types probably shouldn't, for example. Behaviour in this"}, {"sha": "18c9858e8d6b51a3fbdf3bc43835cf9628c847db", "filename": "src/librustc_borrowck/borrowck/gather_loans/gather_moves.rs", "status": "modified", "additions": 48, "deletions": 5, "changes": 53, "blob_url": "https://github.com/rust-lang/rust/blob/5436f859e46de9057260269049865b6cdb1d9ddd/src%2Flibrustc_borrowck%2Fborrowck%2Fgather_loans%2Fgather_moves.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5436f859e46de9057260269049865b6cdb1d9ddd/src%2Flibrustc_borrowck%2Fborrowck%2Fgather_loans%2Fgather_moves.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_borrowck%2Fborrowck%2Fgather_loans%2Fgather_moves.rs?ref=5436f859e46de9057260269049865b6cdb1d9ddd", "patch": "@@ -23,13 +23,47 @@ use rustc::ty::{self, Ty};\n use std::rc::Rc;\n use syntax::ast;\n use syntax_pos::Span;\n-use rustc::hir::{self, PatKind};\n+use rustc::hir::*;\n+use rustc::hir::map::Node::*;\n+use rustc::hir::map::{PatternSource};\n \n struct GatherMoveInfo<'tcx> {\n     id: ast::NodeId,\n     kind: MoveKind,\n     cmt: mc::cmt<'tcx>,\n-    span_path_opt: Option<MoveSpanAndPath>\n+    span_path_opt: Option<MoveSpanAndPath<'tcx>>\n+}\n+\n+/// Returns the kind of the Pattern\n+fn get_pattern_source<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>, pat: &Pat) -> PatternSource<'tcx> {\n+\n+    let parent = tcx.hir.get_parent_node(pat.id);\n+\n+    match tcx.hir.get(parent) {\n+        NodeExpr(ref e) => {\n+            // the enclosing expression must be a `match` or something else\n+            assert!(match e.node {\n+                        ExprMatch(..) => true,\n+                        _ => return PatternSource::Other,\n+                    });\n+            PatternSource::MatchExpr(e)\n+        }\n+        NodeStmt(ref s) => {\n+            // the enclosing statement must be a `let` or something else\n+            match s.node {\n+                StmtDecl(ref decl, _) => {\n+                    match decl.node {\n+                        DeclLocal(ref local) => PatternSource::LetDecl(local),\n+                        _ => return PatternSource::Other,\n+                    }\n+                }\n+                _ => return PatternSource::Other,\n+            }\n+        }\n+\n+        _ => return PatternSource::Other,\n+\n+    }\n }\n \n pub fn gather_decl<'a, 'tcx>(bccx: &BorrowckCtxt<'a, 'tcx>,\n@@ -95,11 +129,15 @@ pub fn gather_move_from_pat<'a, 'tcx>(bccx: &BorrowckCtxt<'a, 'tcx>,\n                                       move_error_collector: &mut MoveErrorCollector<'tcx>,\n                                       move_pat: &hir::Pat,\n                                       cmt: mc::cmt<'tcx>) {\n+    let source = get_pattern_source(bccx.tcx,move_pat);\n     let pat_span_path_opt = match move_pat.node {\n         PatKind::Binding(_, _, ref path1, _) => {\n-            Some(MoveSpanAndPath{span: move_pat.span,\n-                                 name: path1.node})\n-        },\n+            Some(MoveSpanAndPath {\n+                     span: move_pat.span,\n+                     name: path1.node,\n+                     pat_source: source,\n+                 })\n+        }\n         _ => None,\n     };\n     let move_info = GatherMoveInfo {\n@@ -108,6 +146,11 @@ pub fn gather_move_from_pat<'a, 'tcx>(bccx: &BorrowckCtxt<'a, 'tcx>,\n         cmt: cmt,\n         span_path_opt: pat_span_path_opt,\n     };\n+\n+    debug!(\"gather_move_from_pat: move_pat={:?} source={:?}\",\n+           move_pat,\n+           source);\n+\n     gather_move(bccx, move_data, move_error_collector, move_info);\n }\n "}, {"sha": "f047374cab2563c15a2fa29e7cb2d26beb8e5f5b", "filename": "src/librustc_borrowck/borrowck/gather_loans/move_error.rs", "status": "modified", "additions": 23, "deletions": 11, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/5436f859e46de9057260269049865b6cdb1d9ddd/src%2Flibrustc_borrowck%2Fborrowck%2Fgather_loans%2Fmove_error.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5436f859e46de9057260269049865b6cdb1d9ddd/src%2Flibrustc_borrowck%2Fborrowck%2Fgather_loans%2Fmove_error.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_borrowck%2Fborrowck%2Fgather_loans%2Fmove_error.rs?ref=5436f859e46de9057260269049865b6cdb1d9ddd", "patch": "@@ -17,6 +17,7 @@ use rustc::ty;\n use syntax::ast;\n use syntax_pos;\n use errors::DiagnosticBuilder;\n+use rustc::hir::map::PatternSource;\n \n pub struct MoveErrorCollector<'tcx> {\n     errors: Vec<MoveError<'tcx>>\n@@ -40,12 +41,12 @@ impl<'tcx> MoveErrorCollector<'tcx> {\n \n pub struct MoveError<'tcx> {\n     move_from: mc::cmt<'tcx>,\n-    move_to: Option<MoveSpanAndPath>\n+    move_to: Option<MoveSpanAndPath<'tcx>>\n }\n \n impl<'tcx> MoveError<'tcx> {\n     pub fn with_move_info(move_from: mc::cmt<'tcx>,\n-                          move_to: Option<MoveSpanAndPath>)\n+                          move_to: Option<MoveSpanAndPath<'tcx>>)\n                           -> MoveError<'tcx> {\n         MoveError {\n             move_from: move_from,\n@@ -55,32 +56,43 @@ impl<'tcx> MoveError<'tcx> {\n }\n \n #[derive(Clone)]\n-pub struct MoveSpanAndPath {\n+pub struct MoveSpanAndPath<'tcx> {\n     pub span: syntax_pos::Span,\n     pub name: ast::Name,\n+    pub pat_source: PatternSource<'tcx>,\n }\n \n pub struct GroupedMoveErrors<'tcx> {\n     move_from: mc::cmt<'tcx>,\n-    move_to_places: Vec<MoveSpanAndPath>\n+    move_to_places: Vec<MoveSpanAndPath<'tcx>>\n }\n \n-fn report_move_errors<'a, 'tcx>(bccx: &BorrowckCtxt<'a, 'tcx>,\n-                                errors: &Vec<MoveError<'tcx>>) {\n+fn report_move_errors<'a, 'tcx>(bccx: &BorrowckCtxt<'a, 'tcx>, errors: &Vec<MoveError<'tcx>>) {\n     let grouped_errors = group_errors_with_same_origin(errors);\n     for error in &grouped_errors {\n         let mut err = report_cannot_move_out_of(bccx, error.move_from.clone());\n         let mut is_first_note = true;\n-        for move_to in &error.move_to_places {\n-            err = note_move_destination(err, move_to.span, move_to.name, is_first_note);\n-            is_first_note = false;\n+\t\n+\tif let Some(pattern_source) = error.move_to_places.get(0){\n+ \n+        match pattern_source.pat_source {\n+            PatternSource::LetDecl(_) => {}\n+            _ => {\n+                for move_to in &error.move_to_places {\n+\n+                    err = note_move_destination(err, move_to.span, move_to.name, is_first_note);\n+                    is_first_note = false;\n+                }\n+            }\n         }\n+    }\n         if let NoteClosureEnv(upvar_id) = error.move_from.note {\n-            err.span_label(bccx.tcx.hir.span(upvar_id.var_id), &\"captured outer variable\");\n+            err.span_label(bccx.tcx.hir.span(upvar_id.var_id), &\"captured   outer variable\");\n         }\n         err.emit();\n+\t\n+\t}\n     }\n-}\n \n fn group_errors_with_same_origin<'tcx>(errors: &Vec<MoveError<'tcx>>)\n                                        -> Vec<GroupedMoveErrors<'tcx>> {"}, {"sha": "98bb6b14b945c37fa9c6d8614fc0d6033b0af985", "filename": "src/test/compile-fail/borrowck/borrowck-vec-pattern-nesting.rs", "status": "modified", "additions": 0, "deletions": 3, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/5436f859e46de9057260269049865b6cdb1d9ddd/src%2Ftest%2Fcompile-fail%2Fborrowck%2Fborrowck-vec-pattern-nesting.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5436f859e46de9057260269049865b6cdb1d9ddd/src%2Ftest%2Fcompile-fail%2Fborrowck%2Fborrowck-vec-pattern-nesting.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fborrowck%2Fborrowck-vec-pattern-nesting.rs?ref=5436f859e46de9057260269049865b6cdb1d9ddd", "patch": "@@ -54,7 +54,6 @@ fn c() {\n         _ => {}\n     }\n     let a = vec[0]; //~ ERROR cannot move out\n-    //~^ NOTE to prevent move\n     //~| cannot move out of here\n }\n \n@@ -68,7 +67,6 @@ fn d() {\n         _ => {}\n     }\n     let a = vec[0]; //~ ERROR cannot move out\n-    //~^ NOTE to prevent move\n     //~| cannot move out of here\n }\n \n@@ -84,7 +82,6 @@ fn e() {\n         _ => {}\n     }\n     let a = vec[0]; //~ ERROR cannot move out\n-    //~^ NOTE to prevent move\n     //~| cannot move out of here\n }\n "}, {"sha": "fd42abc752e490c133d790344f87e765b41aa1bf", "filename": "src/test/ui/issue-40402-ref-hints/issue-40402-1.rs", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/5436f859e46de9057260269049865b6cdb1d9ddd/src%2Ftest%2Fui%2Fissue-40402-ref-hints%2Fissue-40402-1.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5436f859e46de9057260269049865b6cdb1d9ddd/src%2Ftest%2Fui%2Fissue-40402-ref-hints%2Fissue-40402-1.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissue-40402-ref-hints%2Fissue-40402-1.rs?ref=5436f859e46de9057260269049865b6cdb1d9ddd", "patch": "@@ -0,0 +1,19 @@\n+// Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+struct Foo {\n+    pub v: Vec<String>,\n+}\n+\n+fn main() {\n+    let mut f = Foo { v: Vec::new() };\n+    f.v.push(\"hello\".to_string());\n+    let e = f.v[0];\n+}"}, {"sha": "03b5beee2a4179f9cb89efe5677a9d836e6f254f", "filename": "src/test/ui/issue-40402-ref-hints/issue-40402-1.stderr", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/5436f859e46de9057260269049865b6cdb1d9ddd/src%2Ftest%2Fui%2Fissue-40402-ref-hints%2Fissue-40402-1.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/5436f859e46de9057260269049865b6cdb1d9ddd/src%2Ftest%2Fui%2Fissue-40402-ref-hints%2Fissue-40402-1.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissue-40402-ref-hints%2Fissue-40402-1.stderr?ref=5436f859e46de9057260269049865b6cdb1d9ddd", "patch": "@@ -0,0 +1,8 @@\n+error[E0507]: cannot move out of indexed content\n+  --> $DIR/issue-40402-1.rs:18:13\n+   |\n+18 |     let e = f.v[0];\n+   |             ^^^^^^ cannot move out of indexed content\n+\n+error: aborting due to previous error\n+"}, {"sha": "0879614243fb2bca3a329298e87b236db70b78b6", "filename": "src/test/ui/issue-40402-ref-hints/issue-40402-2.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/5436f859e46de9057260269049865b6cdb1d9ddd/src%2Ftest%2Fui%2Fissue-40402-ref-hints%2Fissue-40402-2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5436f859e46de9057260269049865b6cdb1d9ddd/src%2Ftest%2Fui%2Fissue-40402-ref-hints%2Fissue-40402-2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissue-40402-ref-hints%2Fissue-40402-2.rs?ref=5436f859e46de9057260269049865b6cdb1d9ddd", "patch": "@@ -0,0 +1,14 @@\n+// Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+fn main() {\n+    let x = vec![(String::new(), String::new())];\n+    let (a, b) = x[0];\n+}"}, {"sha": "ab72590001519c951abebca5ad47aba91ab90d71", "filename": "src/test/ui/issue-40402-ref-hints/issue-40402-2.stderr", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/5436f859e46de9057260269049865b6cdb1d9ddd/src%2Ftest%2Fui%2Fissue-40402-ref-hints%2Fissue-40402-2.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/5436f859e46de9057260269049865b6cdb1d9ddd/src%2Ftest%2Fui%2Fissue-40402-ref-hints%2Fissue-40402-2.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissue-40402-ref-hints%2Fissue-40402-2.stderr?ref=5436f859e46de9057260269049865b6cdb1d9ddd", "patch": "@@ -0,0 +1,11 @@\n+error[E0507]: cannot move out of indexed content\n+  --> $DIR/issue-40402-2.rs:13:18\n+   |\n+13 |     let (a, b) = x[0];\n+   |          -  -    ^^^^ cannot move out of indexed content\n+   |          |  |\n+   |          |  ...and here (use `ref b` or `ref mut b`)\n+   |          hint: to prevent move, use `ref a` or `ref mut a`\n+\n+error: aborting due to previous error\n+"}]}