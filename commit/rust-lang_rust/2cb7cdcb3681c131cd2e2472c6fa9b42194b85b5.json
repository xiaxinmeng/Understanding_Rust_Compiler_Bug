{"sha": "2cb7cdcb3681c131cd2e2472c6fa9b42194b85b5", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJjYjdjZGNiMzY4MWMxMzFjZDJlMjQ3MmM2ZmE5YjQyMTk0Yjg1YjU=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-01-08T16:47:27Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-01-08T16:47:27Z"}, "message": "Auto merge of #57429 - alexcrichton:fix-dist, r=Mark-Simulacrum\n\nBuild LLVM with -static-libstdc++ on dist builds\n\nThis commit is intended on fixing a regression from #57286 where the\ndistributed LLVM shared library unfortunately depends on a dynamic copy\nof libstdc++, meaning we're no longer as binary compatible as we\nthought! This tweaks the build of LLVM as out distribution is slightly\ndifferent now, and is hoped to fix the issue.\n\nCloses #57426", "tree": {"sha": "1b941fc09422193391c503f59b2a7bc990c35fe4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1b941fc09422193391c503f59b2a7bc990c35fe4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2cb7cdcb3681c131cd2e2472c6fa9b42194b85b5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2cb7cdcb3681c131cd2e2472c6fa9b42194b85b5", "html_url": "https://github.com/rust-lang/rust/commit/2cb7cdcb3681c131cd2e2472c6fa9b42194b85b5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2cb7cdcb3681c131cd2e2472c6fa9b42194b85b5/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b8c8f0bdf62728198696cab7d00a8fdc3ee381d3", "url": "https://api.github.com/repos/rust-lang/rust/commits/b8c8f0bdf62728198696cab7d00a8fdc3ee381d3", "html_url": "https://github.com/rust-lang/rust/commit/b8c8f0bdf62728198696cab7d00a8fdc3ee381d3"}, {"sha": "d58555323ff5b6aaf7b95876f256a6f1d2fe0e03", "url": "https://api.github.com/repos/rust-lang/rust/commits/d58555323ff5b6aaf7b95876f256a6f1d2fe0e03", "html_url": "https://github.com/rust-lang/rust/commit/d58555323ff5b6aaf7b95876f256a6f1d2fe0e03"}], "stats": {"total": 16, "additions": 8, "deletions": 8}, "files": [{"sha": "7ddfc385fc0fe9afd8af391d5601d774997657d5", "filename": "src/bootstrap/native.rs", "status": "modified", "additions": 8, "deletions": 8, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/2cb7cdcb3681c131cd2e2472c6fa9b42194b85b5/src%2Fbootstrap%2Fnative.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2cb7cdcb3681c131cd2e2472c6fa9b42194b85b5/src%2Fbootstrap%2Fnative.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fnative.rs?ref=2cb7cdcb3681c131cd2e2472c6fa9b42194b85b5", "patch": "@@ -235,7 +235,7 @@ impl Step for Llvm {\n             cfg.define(\"PYTHON_EXECUTABLE\", python);\n         }\n \n-        configure_cmake(builder, target, &mut cfg, false);\n+        configure_cmake(builder, target, &mut cfg);\n \n         // FIXME: we don't actually need to build all LLVM tools and all LLVM\n         //        libraries here, e.g., we just want a few components and a few\n@@ -277,8 +277,7 @@ fn check_llvm_version(builder: &Builder, llvm_config: &Path) {\n \n fn configure_cmake(builder: &Builder,\n                    target: Interned<String>,\n-                   cfg: &mut cmake::Config,\n-                   building_dist_binaries: bool) {\n+                   cfg: &mut cmake::Config) {\n     if builder.config.ninja {\n         cfg.generator(\"Ninja\");\n     }\n@@ -363,10 +362,11 @@ fn configure_cmake(builder: &Builder,\n     cfg.build_arg(\"-j\").build_arg(builder.jobs().to_string());\n     cfg.define(\"CMAKE_C_FLAGS\", builder.cflags(target, GitRepo::Llvm).join(\" \"));\n     let mut cxxflags = builder.cflags(target, GitRepo::Llvm).join(\" \");\n-    if building_dist_binaries {\n-        if builder.config.llvm_static_stdcpp && !target.contains(\"windows\") {\n-            cxxflags.push_str(\" -static-libstdc++\");\n-        }\n+    if builder.config.llvm_static_stdcpp &&\n+        !target.contains(\"windows\") &&\n+        !target.contains(\"netbsd\")\n+    {\n+        cxxflags.push_str(\" -static-libstdc++\");\n     }\n     cfg.define(\"CMAKE_CXX_FLAGS\", cxxflags);\n     if let Some(ar) = builder.ar(target) {\n@@ -431,7 +431,7 @@ impl Step for Lld {\n         t!(fs::create_dir_all(&out_dir));\n \n         let mut cfg = cmake::Config::new(builder.src.join(\"src/tools/lld\"));\n-        configure_cmake(builder, target, &mut cfg, true);\n+        configure_cmake(builder, target, &mut cfg);\n \n         // This is an awful, awful hack. Discovered when we migrated to using\n         // clang-cl to compile LLVM/LLD it turns out that LLD, when built out of"}]}