{"sha": "21e5224484b9214648826e1b15aa9150c79a407c", "node_id": "MDY6Q29tbWl0NzI0NzEyOjIxZTUyMjQ0ODRiOTIxNDY0ODgyNmUxYjE1YWE5MTUwYzc5YTQwN2M=", "commit": {"author": {"name": "Kirill Bulatov", "email": "mail4score@gmail.com", "date": "2020-07-27T15:45:08Z"}, "committer": {"name": "Kirill Bulatov", "email": "mail4score@gmail.com", "date": "2020-08-11T12:09:08Z"}, "message": "Custom ranges for missing fields", "tree": {"sha": "39825273cf9d97796ef9e1705004c1171d32efab", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/39825273cf9d97796ef9e1705004c1171d32efab"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/21e5224484b9214648826e1b15aa9150c79a407c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/21e5224484b9214648826e1b15aa9150c79a407c", "html_url": "https://github.com/rust-lang/rust/commit/21e5224484b9214648826e1b15aa9150c79a407c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/21e5224484b9214648826e1b15aa9150c79a407c/comments", "author": {"login": "SomeoneToIgnore", "id": 2690773, "node_id": "MDQ6VXNlcjI2OTA3NzM=", "avatar_url": "https://avatars.githubusercontent.com/u/2690773?v=4", "gravatar_id": "", "url": "https://api.github.com/users/SomeoneToIgnore", "html_url": "https://github.com/SomeoneToIgnore", "followers_url": "https://api.github.com/users/SomeoneToIgnore/followers", "following_url": "https://api.github.com/users/SomeoneToIgnore/following{/other_user}", "gists_url": "https://api.github.com/users/SomeoneToIgnore/gists{/gist_id}", "starred_url": "https://api.github.com/users/SomeoneToIgnore/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/SomeoneToIgnore/subscriptions", "organizations_url": "https://api.github.com/users/SomeoneToIgnore/orgs", "repos_url": "https://api.github.com/users/SomeoneToIgnore/repos", "events_url": "https://api.github.com/users/SomeoneToIgnore/events{/privacy}", "received_events_url": "https://api.github.com/users/SomeoneToIgnore/received_events", "type": "User", "site_admin": false}, "committer": {"login": "SomeoneToIgnore", "id": 2690773, "node_id": "MDQ6VXNlcjI2OTA3NzM=", "avatar_url": "https://avatars.githubusercontent.com/u/2690773?v=4", "gravatar_id": "", "url": "https://api.github.com/users/SomeoneToIgnore", "html_url": "https://github.com/SomeoneToIgnore", "followers_url": "https://api.github.com/users/SomeoneToIgnore/followers", "following_url": "https://api.github.com/users/SomeoneToIgnore/following{/other_user}", "gists_url": "https://api.github.com/users/SomeoneToIgnore/gists{/gist_id}", "starred_url": "https://api.github.com/users/SomeoneToIgnore/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/SomeoneToIgnore/subscriptions", "organizations_url": "https://api.github.com/users/SomeoneToIgnore/orgs", "repos_url": "https://api.github.com/users/SomeoneToIgnore/repos", "events_url": "https://api.github.com/users/SomeoneToIgnore/events{/privacy}", "received_events_url": "https://api.github.com/users/SomeoneToIgnore/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "26e102a567aadcf86f2e5b575cb6b915991ba088", "url": "https://api.github.com/repos/rust-lang/rust/commits/26e102a567aadcf86f2e5b575cb6b915991ba088", "html_url": "https://github.com/rust-lang/rust/commit/26e102a567aadcf86f2e5b575cb6b915991ba088"}], "stats": {"total": 64, "additions": 56, "deletions": 8}, "files": [{"sha": "e889f070fad702365733484611a918f577df025e", "filename": "crates/ra_hir_expand/src/diagnostics.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/21e5224484b9214648826e1b15aa9150c79a407c/crates%2Fra_hir_expand%2Fsrc%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/21e5224484b9214648826e1b15aa9150c79a407c/crates%2Fra_hir_expand%2Fsrc%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_expand%2Fsrc%2Fdiagnostics.rs?ref=21e5224484b9214648826e1b15aa9150c79a407c", "patch": "@@ -36,8 +36,9 @@ pub trait AstDiagnostic {\n \n impl dyn Diagnostic {\n     pub fn syntax_node(&self, db: &impl AstDatabase) -> SyntaxNode {\n-        let node = db.parse_or_expand(self.source().file_id).unwrap();\n-        self.source().value.to_node(&node)\n+        let source = self.source();\n+        let node = db.parse_or_expand(source.file_id).unwrap();\n+        source.value.to_node(&node)\n     }\n \n     pub fn downcast_ref<D: Diagnostic>(&self) -> Option<&D> {"}, {"sha": "a5b00ed4859c1573c804bc749fdef8e183580278", "filename": "crates/ra_hir_ty/src/diagnostics.rs", "status": "modified", "additions": 48, "deletions": 4, "changes": 52, "blob_url": "https://github.com/rust-lang/rust/blob/21e5224484b9214648826e1b15aa9150c79a407c/crates%2Fra_hir_ty%2Fsrc%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/21e5224484b9214648826e1b15aa9150c79a407c/crates%2Fra_hir_ty%2Fsrc%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_ty%2Fsrc%2Fdiagnostics.rs?ref=21e5224484b9214648826e1b15aa9150c79a407c", "patch": "@@ -9,7 +9,7 @@ use hir_def::DefWithBodyId;\n use hir_expand::diagnostics::{AstDiagnostic, Diagnostic, DiagnosticSink};\n use hir_expand::{db::AstDatabase, name::Name, HirFileId, InFile};\n use ra_prof::profile;\n-use ra_syntax::{ast, AstNode, AstPtr, SyntaxNodePtr};\n+use ra_syntax::{ast, AstNode, AstPtr, SyntaxNode, SyntaxNodePtr};\n use stdx::format_to;\n \n use crate::db::HirDatabase;\n@@ -61,6 +61,17 @@ pub struct MissingFields {\n     pub file: HirFileId,\n     pub field_list: AstPtr<ast::RecordExprFieldList>,\n     pub missed_fields: Vec<Name>,\n+    pub list_parent_path: Option<AstPtr<ast::Path>>,\n+}\n+\n+impl MissingFields {\n+    fn root(&self, db: &dyn AstDatabase) -> SyntaxNode {\n+        db.parse_or_expand(self.file).unwrap()\n+    }\n+\n+    pub fn list_parent_ast(&self, db: &dyn AstDatabase) -> Option<ast::Path> {\n+        self.list_parent_path.as_ref().map(|path| path.to_node(&self.root(db)))\n+    }\n }\n \n impl Diagnostic for MissingFields {\n@@ -83,9 +94,7 @@ impl AstDiagnostic for MissingFields {\n     type AST = ast::RecordExprFieldList;\n \n     fn ast(&self, db: &dyn AstDatabase) -> Self::AST {\n-        let root = db.parse_or_expand(self.source().file_id).unwrap();\n-        let node = self.source().value.to_node(&root);\n-        ast::RecordExprFieldList::cast(node).unwrap()\n+        self.field_list.to_node(&self.root(db))\n     }\n }\n \n@@ -318,6 +327,41 @@ mod tests {\n         assert_eq!(annotations, actual);\n     }\n \n+    #[test]\n+    fn structure_name_highlighted_for_missing_fields() {\n+        check_diagnostics(\n+            r#\"\n+struct Beefy {\n+    one: i32,\n+    two: i32,\n+    three: i32,\n+    four: i32,\n+    five: i32,\n+    six: i32,\n+    seven: i32,\n+    eight: i32,\n+    nine: i32,\n+    ten: i32,\n+}\n+fn baz() {\n+    let zz = Beefy {\n+           //^^^^^... Missing structure fields:\n+           //    |    - seven\n+        one: (),\n+        two: (),\n+        three: (),\n+        four: (),\n+        five: (),\n+        six: (),\n+        eight: (),\n+        nine: (),\n+        ten: (),\n+    };\n+}\n+\"#,\n+        );\n+    }\n+\n     #[test]\n     fn no_such_field_diagnostics() {\n         check_diagnostics("}, {"sha": "3c37fc58e924157c15a6fd77969c48d27e66b649", "filename": "crates/ra_hir_ty/src/diagnostics/expr.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/21e5224484b9214648826e1b15aa9150c79a407c/crates%2Fra_hir_ty%2Fsrc%2Fdiagnostics%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/21e5224484b9214648826e1b15aa9150c79a407c/crates%2Fra_hir_ty%2Fsrc%2Fdiagnostics%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_ty%2Fsrc%2Fdiagnostics%2Fexpr.rs?ref=21e5224484b9214648826e1b15aa9150c79a407c", "patch": "@@ -111,6 +111,7 @@ impl<'a, 'b> ExprValidator<'a, 'b> {\n                         file: source_ptr.file_id,\n                         field_list: AstPtr::new(&field_list),\n                         missed_fields,\n+                        list_parent_path: record_lit.path().map(|path| AstPtr::new(&path)),\n                     })\n                 }\n             }"}, {"sha": "7ae4bda0b8e99914fa38137651166a98d068818d", "filename": "crates/ra_ide/src/diagnostics.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/21e5224484b9214648826e1b15aa9150c79a407c/crates%2Fra_ide%2Fsrc%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/21e5224484b9214648826e1b15aa9150c79a407c/crates%2Fra_ide%2Fsrc%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fdiagnostics.rs?ref=21e5224484b9214648826e1b15aa9150c79a407c", "patch": "@@ -100,8 +100,10 @@ pub(crate) fn diagnostics(\n             };\n \n             res.borrow_mut().push(Diagnostic {\n-                // TODO kb use a smaller range here\n-                range,\n+                range: d\n+                    .list_parent_ast(db)\n+                    .map(|path| path.syntax().text_range())\n+                    .unwrap_or(range),\n                 message: d.message(),\n                 severity: Severity::Error,\n                 fix,"}]}