{"sha": "37304cda63d74b1a16f249853623960a003392c9", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM3MzA0Y2RhNjNkNzRiMWExNmYyNDk4NTM2MjM5NjBhMDAzMzkyYzk=", "commit": {"author": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2019-11-23T19:28:45Z"}, "committer": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2019-11-28T17:59:56Z"}, "message": "rustc_metadata: Privatize `CrateMetadata::dependencies`", "tree": {"sha": "daa4c66dcd3bfca7facd9caed77311e3186f16c3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/daa4c66dcd3bfca7facd9caed77311e3186f16c3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/37304cda63d74b1a16f249853623960a003392c9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/37304cda63d74b1a16f249853623960a003392c9", "html_url": "https://github.com/rust-lang/rust/commit/37304cda63d74b1a16f249853623960a003392c9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/37304cda63d74b1a16f249853623960a003392c9/comments", "author": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "committer": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0525cf9d6895027e2b7cd361784db4965f97a6ed", "url": "https://api.github.com/repos/rust-lang/rust/commits/0525cf9d6895027e2b7cd361784db4965f97a6ed", "html_url": "https://github.com/rust-lang/rust/commit/0525cf9d6895027e2b7cd361784db4965f97a6ed"}], "stats": {"total": 18, "additions": 13, "deletions": 5}, "files": [{"sha": "c537d9669095fdcf1b880e31f1773543a757ad5d", "filename": "src/librustc_metadata/creader.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/37304cda63d74b1a16f249853623960a003392c9/src%2Flibrustc_metadata%2Fcreader.rs", "raw_url": "https://github.com/rust-lang/rust/raw/37304cda63d74b1a16f249853623960a003392c9/src%2Flibrustc_metadata%2Fcreader.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Fcreader.rs?ref=37304cda63d74b1a16f249853623960a003392c9", "patch": "@@ -428,7 +428,7 @@ impl<'a> CrateLoader<'a> {\n \n         // Propagate the extern crate info to dependencies.\n         extern_crate.dependency_of = cnum;\n-        for &dep_cnum in cmeta.dependencies.borrow().iter() {\n+        for &dep_cnum in cmeta.dependencies().iter() {\n             self.update_extern_crate(dep_cnum, extern_crate, visited);\n         }\n     }\n@@ -829,7 +829,7 @@ impl<'a> CrateLoader<'a> {\n             }\n \n             info!(\"injecting a dep from {} to {}\", cnum, krate);\n-            data.dependencies.borrow_mut().push(krate);\n+            data.add_dependency(krate);\n         });\n     }\n "}, {"sha": "aac286427250d6be2e71de90427fdffdbb7fb4e9", "filename": "src/librustc_metadata/cstore.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/37304cda63d74b1a16f249853623960a003392c9/src%2Flibrustc_metadata%2Fcstore.rs", "raw_url": "https://github.com/rust-lang/rust/raw/37304cda63d74b1a16f249853623960a003392c9/src%2Flibrustc_metadata%2Fcstore.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Fcstore.rs?ref=37304cda63d74b1a16f249853623960a003392c9", "patch": "@@ -66,7 +66,7 @@ impl CStore {\n     fn push_dependencies_in_postorder(&self, deps: &mut Vec<CrateNum>, cnum: CrateNum) {\n         if !deps.contains(&cnum) {\n             let data = self.get_crate_data(cnum);\n-            for &dep in data.dependencies.borrow().iter() {\n+            for &dep in data.dependencies().iter() {\n                 if dep != cnum {\n                     self.push_dependencies_in_postorder(deps, dep);\n                 }"}, {"sha": "7e7238164c632c88fecead9291a4fa8b04a6db41", "filename": "src/librustc_metadata/rmeta/decoder.rs", "status": "modified", "additions": 10, "deletions": 2, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/37304cda63d74b1a16f249853623960a003392c9/src%2Flibrustc_metadata%2Frmeta%2Fdecoder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/37304cda63d74b1a16f249853623960a003392c9/src%2Flibrustc_metadata%2Frmeta%2Fdecoder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Frmeta%2Fdecoder.rs?ref=37304cda63d74b1a16f249853623960a003392c9", "patch": "@@ -4,7 +4,7 @@ use crate::rmeta::*;\n use crate::rmeta::table::{FixedSizeEncoding, Table};\n \n use rustc_index::vec::{Idx, IndexVec};\n-use rustc_data_structures::sync::{Lrc, Lock, Once, AtomicCell};\n+use rustc_data_structures::sync::{Lrc, Lock, LockGuard, Once, AtomicCell};\n use rustc::hir::map::{DefKey, DefPath, DefPathData, DefPathHash};\n use rustc::hir::map::definitions::DefPathTable;\n use rustc::hir;\n@@ -97,7 +97,7 @@ crate struct CrateMetadata {\n     /// IDs as they are seen from the current compilation session.\n     cnum_map: CrateNumMap,\n     /// Same ID set as `cnum_map` plus maybe some injected crates like panic runtime.\n-    crate dependencies: Lock<Vec<CrateNum>>,\n+    dependencies: Lock<Vec<CrateNum>>,\n     /// How to link (or not link) this crate to the currently compiled crate.\n     crate dep_kind: Lock<DepKind>,\n     /// Filesystem location of this crate.\n@@ -1517,6 +1517,14 @@ impl<'a, 'tcx> CrateMetadata {\n \n         dep_node_index\n     }\n+\n+    crate fn dependencies(&self) -> LockGuard<'_, Vec<CrateNum>> {\n+        self.dependencies.borrow()\n+    }\n+\n+    crate fn add_dependency(&self, cnum: CrateNum) {\n+        self.dependencies.borrow_mut().push(cnum);\n+    }\n }\n \n // Cannot be implemented on 'ProcMacro', as libproc_macro"}]}