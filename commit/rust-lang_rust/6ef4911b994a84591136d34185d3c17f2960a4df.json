{"sha": "6ef4911b994a84591136d34185d3c17f2960a4df", "node_id": "C_kwDOAAsO6NoAKDZlZjQ5MTFiOTk0YTg0NTkxMTM2ZDM0MTg1ZDNjMTdmMjk2MGE0ZGY", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2022-05-22T02:53:07Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-05-22T02:53:07Z"}, "message": "Rollup merge of #97236 - cjgillot:recover-lifetime-res, r=jackh726\n\nRecover when resolution did not resolve lifetimes.\n\nThis can happen for items inside a foreign fn's body, which are not visited at all.\n\nFixes https://github.com/rust-lang/rust/issues/97193\nFixes https://github.com/rust-lang/rust/issues/97194", "tree": {"sha": "389bdb2978d957a7ec3f9e82ae3771adbbd36a83", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/389bdb2978d957a7ec3f9e82ae3771adbbd36a83"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6ef4911b994a84591136d34185d3c17f2960a4df", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJiiaWTCRBK7hj4Ov3rIwAADooIAH+8I9/geawoWEi6TOnGkyZz\nwej8nIicYlkAzdDKRW7ef4hzQyNpDZcSeOSt5v5VCxQ6jxOlUUdk0KalxtmyQkod\naL886ZEn1WEDOlIN0x1UAiVK84pugmxtoVdLQUsHTBCpjnBaqGRv+TQPKLNNc4J3\nYAWX6kvSMaqQB+wycMRYqgLzroCx4KG3I0PaFa0SIvs4DDrYizk58YDTqxPipdmS\nvlztaMhYs7biIniL3VuTEvWpilnAx+ue+jD90XVF4m16dQ5YACaZUutFlq2ok4t5\nBxthna0t9BBJzBUTorN6gYzTkzdw/Yo16hzetHEL9EZUGJISZgxeHnN5dCdvTFk=\n=XOBb\n-----END PGP SIGNATURE-----\n", "payload": "tree 389bdb2978d957a7ec3f9e82ae3771adbbd36a83\nparent c7c5980e900bb8321a33f86b0bf70b5280780c98\nparent 075429f76b51b7dcc1875319412d1290fe263976\nauthor Yuki Okushi <jtitor@2k36.org> 1653187987 +0900\ncommitter GitHub <noreply@github.com> 1653187987 +0900\n\nRollup merge of #97236 - cjgillot:recover-lifetime-res, r=jackh726\n\nRecover when resolution did not resolve lifetimes.\n\nThis can happen for items inside a foreign fn's body, which are not visited at all.\n\nFixes https://github.com/rust-lang/rust/issues/97193\nFixes https://github.com/rust-lang/rust/issues/97194\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6ef4911b994a84591136d34185d3c17f2960a4df", "html_url": "https://github.com/rust-lang/rust/commit/6ef4911b994a84591136d34185d3c17f2960a4df", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6ef4911b994a84591136d34185d3c17f2960a4df/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c7c5980e900bb8321a33f86b0bf70b5280780c98", "url": "https://api.github.com/repos/rust-lang/rust/commits/c7c5980e900bb8321a33f86b0bf70b5280780c98", "html_url": "https://github.com/rust-lang/rust/commit/c7c5980e900bb8321a33f86b0bf70b5280780c98"}, {"sha": "075429f76b51b7dcc1875319412d1290fe263976", "url": "https://api.github.com/repos/rust-lang/rust/commits/075429f76b51b7dcc1875319412d1290fe263976", "html_url": "https://github.com/rust-lang/rust/commit/075429f76b51b7dcc1875319412d1290fe263976"}], "stats": {"total": 103, "additions": 92, "deletions": 11}, "files": [{"sha": "2a7f534bdd9494ead32a10ab438816e8d57d5643", "filename": "compiler/rustc_ast_lowering/src/lib.rs", "status": "modified", "additions": 9, "deletions": 11, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/6ef4911b994a84591136d34185d3c17f2960a4df/compiler%2Frustc_ast_lowering%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6ef4911b994a84591136d34185d3c17f2960a4df/compiler%2Frustc_ast_lowering%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast_lowering%2Fsrc%2Flib.rs?ref=6ef4911b994a84591136d34185d3c17f2960a4df", "patch": "@@ -1168,15 +1168,16 @@ impl<'a, 'hir> LoweringContext<'a, 'hir> {\n             TyKind::Ptr(ref mt) => hir::TyKind::Ptr(self.lower_mt(mt, itctx)),\n             TyKind::Rptr(ref region, ref mt) => {\n                 let region = region.unwrap_or_else(|| {\n-                    let Some(LifetimeRes::ElidedAnchor { start, end }) = self.resolver.get_lifetime_res(t.id) else {\n-                        panic!()\n+                    let id = if let Some(LifetimeRes::ElidedAnchor { start, end }) =\n+                        self.resolver.get_lifetime_res(t.id)\n+                    {\n+                        debug_assert_eq!(start.plus(1), end);\n+                        start\n+                    } else {\n+                        self.resolver.next_node_id()\n                     };\n-                    debug_assert_eq!(start.plus(1), end);\n                     let span = self.sess.source_map().next_point(t.span.shrink_to_lo());\n-                    Lifetime {\n-                        ident: Ident::new(kw::UnderscoreLifetime, span),\n-                        id: start,\n-                    }\n+                    Lifetime { ident: Ident::new(kw::UnderscoreLifetime, span), id }\n                 });\n                 let lifetime = self.lower_lifetime(&region);\n                 hir::TyKind::Rptr(lifetime, self.lower_mt(mt, itctx))\n@@ -1835,10 +1836,7 @@ impl<'a, 'hir> LoweringContext<'a, 'hir> {\n     fn lower_lifetime(&mut self, l: &Lifetime) -> hir::Lifetime {\n         let span = self.lower_span(l.ident.span);\n         let ident = self.lower_ident(l.ident);\n-        let res = self\n-            .resolver\n-            .get_lifetime_res(l.id)\n-            .unwrap_or_else(|| panic!(\"Missing resolution for lifetime {:?} at {:?}\", l, span));\n+        let res = self.resolver.get_lifetime_res(l.id).unwrap_or(LifetimeRes::Error);\n         self.new_named_lifetime_with_res(l.id, span, ident, res)\n     }\n "}, {"sha": "6c82c29dd9d4871f69642d52dcecf9f3c10c1513", "filename": "src/test/ui/lifetimes/issue-97193.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/6ef4911b994a84591136d34185d3c17f2960a4df/src%2Ftest%2Fui%2Flifetimes%2Fissue-97193.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6ef4911b994a84591136d34185d3c17f2960a4df/src%2Ftest%2Fui%2Flifetimes%2Fissue-97193.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flifetimes%2Fissue-97193.rs?ref=6ef4911b994a84591136d34185d3c17f2960a4df", "patch": "@@ -0,0 +1,9 @@\n+extern \"C\" {\n+    fn a(&mut self) {\n+        //~^ ERROR incorrect function inside `extern` block\n+        //~| ERROR `self` parameter is only allowed in associated functions\n+        fn b(buf: &Self) {}\n+    }\n+}\n+\n+fn main() {}"}, {"sha": "21be543ccf9ce519bae2c9da6df398af20f97f5c", "filename": "src/test/ui/lifetimes/issue-97193.stderr", "status": "added", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/6ef4911b994a84591136d34185d3c17f2960a4df/src%2Ftest%2Fui%2Flifetimes%2Fissue-97193.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/6ef4911b994a84591136d34185d3c17f2960a4df/src%2Ftest%2Fui%2Flifetimes%2Fissue-97193.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flifetimes%2Fissue-97193.stderr?ref=6ef4911b994a84591136d34185d3c17f2960a4df", "patch": "@@ -0,0 +1,28 @@\n+error: incorrect function inside `extern` block\n+  --> $DIR/issue-97193.rs:2:8\n+   |\n+LL |   extern \"C\" {\n+   |   ---------- `extern` blocks define existing foreign functions and functions inside of them cannot have a body\n+LL |       fn a(&mut self) {\n+   |  ________^____________-\n+   | |        |\n+   | |        cannot have a body\n+LL | |\n+LL | |\n+LL | |         fn b(buf: &Self) {}\n+LL | |     }\n+   | |_____- help: remove the invalid body: `;`\n+   |\n+   = help: you might have meant to write a function accessible through FFI, which can be done by writing `extern fn` outside of the `extern` block\n+   = note: for more information, visit https://doc.rust-lang.org/std/keyword.extern.html\n+\n+error: `self` parameter is only allowed in associated functions\n+  --> $DIR/issue-97193.rs:2:10\n+   |\n+LL |     fn a(&mut self) {\n+   |          ^^^^^^^^^ not semantically valid as function parameter\n+   |\n+   = note: associated functions are those in `impl` or `trait` definitions\n+\n+error: aborting due to 2 previous errors\n+"}, {"sha": "accb4a9983071ee995d6527f1ec7d1a0136825e4", "filename": "src/test/ui/lifetimes/issue-97194.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/6ef4911b994a84591136d34185d3c17f2960a4df/src%2Ftest%2Fui%2Flifetimes%2Fissue-97194.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6ef4911b994a84591136d34185d3c17f2960a4df/src%2Ftest%2Fui%2Flifetimes%2Fissue-97194.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flifetimes%2Fissue-97194.rs?ref=6ef4911b994a84591136d34185d3c17f2960a4df", "patch": "@@ -0,0 +1,10 @@\n+extern \"C\" {\n+    fn bget(&self, index: [usize; Self::DIM]) -> bool {\n+        //~^ ERROR incorrect function inside `extern` block\n+        //~| ERROR `self` parameter is only allowed in associated functions\n+        //~| ERROR use of undeclared type `Self`\n+        type T<'a> = &'a str;\n+    }\n+}\n+\n+fn main() {}"}, {"sha": "15ad5aadf9fddc3967fec9b26afb3421aa61ee06", "filename": "src/test/ui/lifetimes/issue-97194.stderr", "status": "added", "additions": 36, "deletions": 0, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/6ef4911b994a84591136d34185d3c17f2960a4df/src%2Ftest%2Fui%2Flifetimes%2Fissue-97194.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/6ef4911b994a84591136d34185d3c17f2960a4df/src%2Ftest%2Fui%2Flifetimes%2Fissue-97194.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flifetimes%2Fissue-97194.stderr?ref=6ef4911b994a84591136d34185d3c17f2960a4df", "patch": "@@ -0,0 +1,36 @@\n+error: incorrect function inside `extern` block\n+  --> $DIR/issue-97194.rs:2:8\n+   |\n+LL |   extern \"C\" {\n+   |   ---------- `extern` blocks define existing foreign functions and functions inside of them cannot have a body\n+LL |       fn bget(&self, index: [usize; Self::DIM]) -> bool {\n+   |  ________^^^^___________________________________________-\n+   | |        |\n+   | |        cannot have a body\n+LL | |\n+LL | |\n+LL | |\n+LL | |         type T<'a> = &'a str;\n+LL | |     }\n+   | |_____- help: remove the invalid body: `;`\n+   |\n+   = help: you might have meant to write a function accessible through FFI, which can be done by writing `extern fn` outside of the `extern` block\n+   = note: for more information, visit https://doc.rust-lang.org/std/keyword.extern.html\n+\n+error: `self` parameter is only allowed in associated functions\n+  --> $DIR/issue-97194.rs:2:13\n+   |\n+LL |     fn bget(&self, index: [usize; Self::DIM]) -> bool {\n+   |             ^^^^^ not semantically valid as function parameter\n+   |\n+   = note: associated functions are those in `impl` or `trait` definitions\n+\n+error[E0433]: failed to resolve: use of undeclared type `Self`\n+  --> $DIR/issue-97194.rs:2:35\n+   |\n+LL |     fn bget(&self, index: [usize; Self::DIM]) -> bool {\n+   |                                   ^^^^ use of undeclared type `Self`\n+\n+error: aborting due to 3 previous errors\n+\n+For more information about this error, try `rustc --explain E0433`."}]}