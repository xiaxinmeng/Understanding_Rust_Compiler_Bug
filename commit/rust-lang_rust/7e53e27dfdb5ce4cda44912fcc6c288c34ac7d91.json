{"sha": "7e53e27dfdb5ce4cda44912fcc6c288c34ac7d91", "node_id": "C_kwDOAAsO6NoAKDdlNTNlMjdkZmRiNWNlNGNkYTQ0OTEyZmNjNmMyODhjMzRhYzdkOTE", "commit": {"author": {"name": "Krishna Sundarram", "email": "krishnasundarram@monzo.com", "date": "2023-02-16T16:41:04Z"}, "committer": {"name": "Krishna Sundarram", "email": "krishnasundarram@monzo.com", "date": "2023-02-16T17:05:21Z"}, "message": "Stop bytes_nth from suggesting code that does not compile", "tree": {"sha": "842487fc6e2b82629145eb48caa483ae0adc3a7e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/842487fc6e2b82629145eb48caa483ae0adc3a7e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7e53e27dfdb5ce4cda44912fcc6c288c34ac7d91", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7e53e27dfdb5ce4cda44912fcc6c288c34ac7d91", "html_url": "https://github.com/rust-lang/rust/commit/7e53e27dfdb5ce4cda44912fcc6c288c34ac7d91", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7e53e27dfdb5ce4cda44912fcc6c288c34ac7d91/comments", "author": {"login": "nindalf", "id": 1257998, "node_id": "MDQ6VXNlcjEyNTc5OTg=", "avatar_url": "https://avatars.githubusercontent.com/u/1257998?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nindalf", "html_url": "https://github.com/nindalf", "followers_url": "https://api.github.com/users/nindalf/followers", "following_url": "https://api.github.com/users/nindalf/following{/other_user}", "gists_url": "https://api.github.com/users/nindalf/gists{/gist_id}", "starred_url": "https://api.github.com/users/nindalf/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nindalf/subscriptions", "organizations_url": "https://api.github.com/users/nindalf/orgs", "repos_url": "https://api.github.com/users/nindalf/repos", "events_url": "https://api.github.com/users/nindalf/events{/privacy}", "received_events_url": "https://api.github.com/users/nindalf/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nindalf", "id": 1257998, "node_id": "MDQ6VXNlcjEyNTc5OTg=", "avatar_url": "https://avatars.githubusercontent.com/u/1257998?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nindalf", "html_url": "https://github.com/nindalf", "followers_url": "https://api.github.com/users/nindalf/followers", "following_url": "https://api.github.com/users/nindalf/following{/other_user}", "gists_url": "https://api.github.com/users/nindalf/gists{/gist_id}", "starred_url": "https://api.github.com/users/nindalf/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nindalf/subscriptions", "organizations_url": "https://api.github.com/users/nindalf/orgs", "repos_url": "https://api.github.com/users/nindalf/repos", "events_url": "https://api.github.com/users/nindalf/events{/privacy}", "received_events_url": "https://api.github.com/users/nindalf/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "52c8b536c954bc543290f36f2d90f3e75facaa0b", "url": "https://api.github.com/repos/rust-lang/rust/commits/52c8b536c954bc543290f36f2d90f3e75facaa0b", "html_url": "https://github.com/rust-lang/rust/commit/52c8b536c954bc543290f36f2d90f3e75facaa0b"}], "stats": {"total": 60, "additions": 38, "deletions": 22}, "files": [{"sha": "c5fc145b28908417afda5aeb4f3919edcbcdb0a1", "filename": "clippy_lints/src/methods/bytes_nth.rs", "status": "modified", "additions": 29, "deletions": 13, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/7e53e27dfdb5ce4cda44912fcc6c288c34ac7d91/clippy_lints%2Fsrc%2Fmethods%2Fbytes_nth.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7e53e27dfdb5ce4cda44912fcc6c288c34ac7d91/clippy_lints%2Fsrc%2Fmethods%2Fbytes_nth.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmethods%2Fbytes_nth.rs?ref=7e53e27dfdb5ce4cda44912fcc6c288c34ac7d91", "patch": "@@ -5,6 +5,8 @@ use rustc_errors::Applicability;\n use rustc_hir::{Expr, LangItem};\n use rustc_lint::LateContext;\n \n+use crate::methods::method_call;\n+\n use super::BYTES_NTH;\n \n pub(super) fn check<'tcx>(cx: &LateContext<'tcx>, expr: &Expr<'_>, recv: &'tcx Expr<'tcx>, n_arg: &'tcx Expr<'tcx>) {\n@@ -16,18 +18,32 @@ pub(super) fn check<'tcx>(cx: &LateContext<'tcx>, expr: &Expr<'_>, recv: &'tcx E\n     } else {\n         return;\n     };\n+\n     let mut applicability = Applicability::MachineApplicable;\n-    span_lint_and_sugg(\n-        cx,\n-        BYTES_NTH,\n-        expr.span,\n-        &format!(\"called `.bytes().nth()` on a `{caller_type}`\"),\n-        \"try\",\n-        format!(\n-            \"{}.as_bytes().get({})\",\n-            snippet_with_applicability(cx, recv.span, \"..\", &mut applicability),\n-            snippet_with_applicability(cx, n_arg.span, \"..\", &mut applicability)\n-        ),\n-        applicability,\n-    );\n+    let receiver = snippet_with_applicability(cx, recv.span, \"..\", &mut applicability);\n+    let n = snippet_with_applicability(cx, n_arg.span, \"..\", &mut applicability);\n+\n+    if let Some(parent) = clippy_utils::get_parent_expr(cx, expr)\n+      && let Some((name, _, _, _, _)) = method_call(parent)\n+      && name == \"unwrap\" {\n+        span_lint_and_sugg(\n+            cx,\n+            BYTES_NTH,\n+            parent.span,\n+            &format!(\"called `.bytes().nth().unwrap()` on a `{caller_type}`\"),\n+            \"try\",\n+            format!(\"{receiver}.as_bytes()[{n}]\",),\n+            applicability\n+        );\n+    } else {\n+        span_lint_and_sugg(\n+            cx,\n+            BYTES_NTH,\n+            expr.span,\n+            &format!(\"called `.bytes().nth()` on a `{caller_type}`\"),\n+            \"try\",\n+            format!(\"{receiver}.as_bytes().get({n}).copied()\"), \n+            applicability\n+        );\n+    };\n }"}, {"sha": "a35c679afb71f37739b7e0b60dcfa70092a54e06", "filename": "tests/ui/bytes_nth.fixed", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/7e53e27dfdb5ce4cda44912fcc6c288c34ac7d91/tests%2Fui%2Fbytes_nth.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/7e53e27dfdb5ce4cda44912fcc6c288c34ac7d91/tests%2Fui%2Fbytes_nth.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fbytes_nth.fixed?ref=7e53e27dfdb5ce4cda44912fcc6c288c34ac7d91", "patch": "@@ -5,7 +5,7 @@\n \n fn main() {\n     let s = String::from(\"String\");\n-    let _ = s.as_bytes().get(3);\n-    let _ = &s.as_bytes().get(3);\n-    let _ = s[..].as_bytes().get(3);\n+    let _ = s.as_bytes().get(3).copied();\n+    let _ = &s.as_bytes()[3];\n+    let _ = s[..].as_bytes().get(3).copied();\n }"}, {"sha": "1ecffea53035e3e308333f6b1539a901b7746286", "filename": "tests/ui/bytes_nth.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/7e53e27dfdb5ce4cda44912fcc6c288c34ac7d91/tests%2Fui%2Fbytes_nth.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7e53e27dfdb5ce4cda44912fcc6c288c34ac7d91/tests%2Fui%2Fbytes_nth.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fbytes_nth.rs?ref=7e53e27dfdb5ce4cda44912fcc6c288c34ac7d91", "patch": "@@ -6,6 +6,6 @@\n fn main() {\n     let s = String::from(\"String\");\n     let _ = s.bytes().nth(3);\n-    let _ = &s.bytes().nth(3);\n+    let _ = &s.bytes().nth(3).unwrap();\n     let _ = s[..].bytes().nth(3);\n }"}, {"sha": "e8b15027829e38e4e0a9d851fe8e0be45a4cf264", "filename": "tests/ui/bytes_nth.stderr", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/7e53e27dfdb5ce4cda44912fcc6c288c34ac7d91/tests%2Fui%2Fbytes_nth.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/7e53e27dfdb5ce4cda44912fcc6c288c34ac7d91/tests%2Fui%2Fbytes_nth.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fbytes_nth.stderr?ref=7e53e27dfdb5ce4cda44912fcc6c288c34ac7d91", "patch": "@@ -2,21 +2,21 @@ error: called `.bytes().nth()` on a `String`\n   --> $DIR/bytes_nth.rs:8:13\n    |\n LL |     let _ = s.bytes().nth(3);\n-   |             ^^^^^^^^^^^^^^^^ help: try: `s.as_bytes().get(3)`\n+   |             ^^^^^^^^^^^^^^^^ help: try: `s.as_bytes().get(3).copied()`\n    |\n    = note: `-D clippy::bytes-nth` implied by `-D warnings`\n \n-error: called `.bytes().nth()` on a `String`\n+error: called `.bytes().nth().unwrap()` on a `String`\n   --> $DIR/bytes_nth.rs:9:14\n    |\n-LL |     let _ = &s.bytes().nth(3);\n-   |              ^^^^^^^^^^^^^^^^ help: try: `s.as_bytes().get(3)`\n+LL |     let _ = &s.bytes().nth(3).unwrap();\n+   |              ^^^^^^^^^^^^^^^^^^^^^^^^^ help: try: `s.as_bytes()[3]`\n \n error: called `.bytes().nth()` on a `str`\n   --> $DIR/bytes_nth.rs:10:13\n    |\n LL |     let _ = s[..].bytes().nth(3);\n-   |             ^^^^^^^^^^^^^^^^^^^^ help: try: `s[..].as_bytes().get(3)`\n+   |             ^^^^^^^^^^^^^^^^^^^^ help: try: `s[..].as_bytes().get(3).copied()`\n \n error: aborting due to 3 previous errors\n "}]}