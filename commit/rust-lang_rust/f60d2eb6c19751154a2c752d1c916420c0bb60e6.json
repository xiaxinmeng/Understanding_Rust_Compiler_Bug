{"sha": "f60d2eb6c19751154a2c752d1c916420c0bb60e6", "node_id": "C_kwDOAAsO6NoAKGY2MGQyZWI2YzE5NzUxMTU0YTJjNzUyZDFjOTE2NDIwYzBiYjYwZTY", "commit": {"author": {"name": "John K\u00e5re Alsaker", "email": "john.kare.alsaker@gmail.com", "date": "2023-02-06T05:32:34Z"}, "committer": {"name": "John K\u00e5re Alsaker", "email": "john.kare.alsaker@gmail.com", "date": "2023-03-21T17:18:25Z"}, "message": "Add `-Z time-passes-format` to allow specifying a JSON output for `-Z time-passes`", "tree": {"sha": "33b21a24ce8fe672e284c4671080084a887f2162", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/33b21a24ce8fe672e284c4671080084a887f2162"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f60d2eb6c19751154a2c752d1c916420c0bb60e6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f60d2eb6c19751154a2c752d1c916420c0bb60e6", "html_url": "https://github.com/rust-lang/rust/commit/f60d2eb6c19751154a2c752d1c916420c0bb60e6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f60d2eb6c19751154a2c752d1c916420c0bb60e6/comments", "author": {"login": "Zoxc", "id": 25784, "node_id": "MDQ6VXNlcjI1Nzg0", "avatar_url": "https://avatars.githubusercontent.com/u/25784?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Zoxc", "html_url": "https://github.com/Zoxc", "followers_url": "https://api.github.com/users/Zoxc/followers", "following_url": "https://api.github.com/users/Zoxc/following{/other_user}", "gists_url": "https://api.github.com/users/Zoxc/gists{/gist_id}", "starred_url": "https://api.github.com/users/Zoxc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Zoxc/subscriptions", "organizations_url": "https://api.github.com/users/Zoxc/orgs", "repos_url": "https://api.github.com/users/Zoxc/repos", "events_url": "https://api.github.com/users/Zoxc/events{/privacy}", "received_events_url": "https://api.github.com/users/Zoxc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Zoxc", "id": 25784, "node_id": "MDQ6VXNlcjI1Nzg0", "avatar_url": "https://avatars.githubusercontent.com/u/25784?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Zoxc", "html_url": "https://github.com/Zoxc", "followers_url": "https://api.github.com/users/Zoxc/followers", "following_url": "https://api.github.com/users/Zoxc/following{/other_user}", "gists_url": "https://api.github.com/users/Zoxc/gists{/gist_id}", "starred_url": "https://api.github.com/users/Zoxc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Zoxc/subscriptions", "organizations_url": "https://api.github.com/users/Zoxc/orgs", "repos_url": "https://api.github.com/users/Zoxc/repos", "events_url": "https://api.github.com/users/Zoxc/events{/privacy}", "received_events_url": "https://api.github.com/users/Zoxc/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b0dc15c61ba38ad86aa9d565f99189db4a91f4c4", "url": "https://api.github.com/repos/rust-lang/rust/commits/b0dc15c61ba38ad86aa9d565f99189db4a91f4c4", "html_url": "https://github.com/rust-lang/rust/commit/b0dc15c61ba38ad86aa9d565f99189db4a91f4c4"}], "stats": {"total": 132, "additions": 105, "deletions": 27}, "files": [{"sha": "e5eae1a83c14e1aee04457d1a84107ee632bfec4", "filename": "Cargo.lock", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/f60d2eb6c19751154a2c752d1c916420c0bb60e6/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/f60d2eb6c19751154a2c752d1c916420c0bb60e6/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=f60d2eb6c19751154a2c752d1c916420c0bb60e6", "patch": "@@ -4523,6 +4523,7 @@ dependencies = [\n  \"rustc_index\",\n  \"rustc_macros\",\n  \"rustc_serialize\",\n+ \"serde_json\",\n  \"smallvec\",\n  \"stable_deref_trait\",\n  \"stacker\","}, {"sha": "a109633520ab9260109b555a7165dcbf2d3adc63", "filename": "compiler/rustc_codegen_ssa/src/base.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f60d2eb6c19751154a2c752d1c916420c0bb60e6/compiler%2Frustc_codegen_ssa%2Fsrc%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f60d2eb6c19751154a2c752d1c916420c0bb60e6/compiler%2Frustc_codegen_ssa%2Fsrc%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fbase.rs?ref=f60d2eb6c19751154a2c752d1c916420c0bb60e6", "patch": "@@ -786,6 +786,8 @@ pub fn codegen_crate<B: ExtraBackendMethods>(\n             total_codegen_time,\n             start_rss.unwrap(),\n             end_rss,\n+            tcx.sess.opts.unstable_opts.time_passes_format,\n+            true,\n         );\n     }\n "}, {"sha": "056ee1f63be0311799a7a49c484e9454c4006347", "filename": "compiler/rustc_data_structures/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/f60d2eb6c19751154a2c752d1c916420c0bb60e6/compiler%2Frustc_data_structures%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/f60d2eb6c19751154a2c752d1c916420c0bb60e6/compiler%2Frustc_data_structures%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_data_structures%2FCargo.toml?ref=f60d2eb6c19751154a2c752d1c916420c0bb60e6", "patch": "@@ -21,6 +21,7 @@ rustc-hash = \"1.1.0\"\n rustc_index = { path = \"../rustc_index\", package = \"rustc_index\" }\n rustc_macros = { path = \"../rustc_macros\" }\n rustc_serialize = { path = \"../rustc_serialize\" }\n+serde_json = \"1.0.59\"\n smallvec = { version = \"1.8.1\", features = [\n     \"const_generics\",\n     \"union\","}, {"sha": "513df666d0da1bf646056f43e5a701f5ff73effc", "filename": "compiler/rustc_data_structures/src/graph/scc/tests.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/f60d2eb6c19751154a2c752d1c916420c0bb60e6/compiler%2Frustc_data_structures%2Fsrc%2Fgraph%2Fscc%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f60d2eb6c19751154a2c752d1c916420c0bb60e6/compiler%2Frustc_data_structures%2Fsrc%2Fgraph%2Fscc%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_data_structures%2Fsrc%2Fgraph%2Fscc%2Ftests.rs?ref=f60d2eb6c19751154a2c752d1c916420c0bb60e6", "patch": "@@ -56,7 +56,7 @@ fn test_three_sccs() {\n     assert_eq!(sccs.scc(1), 0);\n     assert_eq!(sccs.scc(2), 0);\n     assert_eq!(sccs.scc(3), 2);\n-    assert_eq!(sccs.successors(0), &[]);\n+    assert_eq!(sccs.successors(0), &[] as &[usize]);\n     assert_eq!(sccs.successors(1), &[0]);\n     assert_eq!(sccs.successors(2), &[0]);\n }\n@@ -113,7 +113,7 @@ fn test_find_state_2() {\n     assert_eq!(sccs.scc(2), 0);\n     assert_eq!(sccs.scc(3), 0);\n     assert_eq!(sccs.scc(4), 0);\n-    assert_eq!(sccs.successors(0), &[]);\n+    assert_eq!(sccs.successors(0), &[] as &[usize]);\n }\n \n #[test]\n@@ -138,7 +138,7 @@ fn test_find_state_3() {\n     assert_eq!(sccs.scc(3), 0);\n     assert_eq!(sccs.scc(4), 0);\n     assert_eq!(sccs.scc(5), 1);\n-    assert_eq!(sccs.successors(0), &[]);\n+    assert_eq!(sccs.successors(0), &[] as &[usize]);\n     assert_eq!(sccs.successors(1), &[0]);\n }\n "}, {"sha": "7c866da60090f9541c333c138f773396c2e4be0c", "filename": "compiler/rustc_data_structures/src/graph/vec_graph/tests.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/f60d2eb6c19751154a2c752d1c916420c0bb60e6/compiler%2Frustc_data_structures%2Fsrc%2Fgraph%2Fvec_graph%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f60d2eb6c19751154a2c752d1c916420c0bb60e6/compiler%2Frustc_data_structures%2Fsrc%2Fgraph%2Fvec_graph%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_data_structures%2Fsrc%2Fgraph%2Fvec_graph%2Ftests.rs?ref=f60d2eb6c19751154a2c752d1c916420c0bb60e6", "patch": "@@ -27,11 +27,11 @@ fn successors() {\n     let graph = create_graph();\n     assert_eq!(graph.successors(0), &[1]);\n     assert_eq!(graph.successors(1), &[2, 3]);\n-    assert_eq!(graph.successors(2), &[]);\n+    assert_eq!(graph.successors(2), &[] as &[usize]);\n     assert_eq!(graph.successors(3), &[4]);\n-    assert_eq!(graph.successors(4), &[]);\n+    assert_eq!(graph.successors(4), &[] as &[usize]);\n     assert_eq!(graph.successors(5), &[1]);\n-    assert_eq!(graph.successors(6), &[]);\n+    assert_eq!(graph.successors(6), &[] as &[usize]);\n }\n \n #[test]"}, {"sha": "87b74903d5125045b1144df86edc2d81266a2c7a", "filename": "compiler/rustc_data_structures/src/profiling.rs", "status": "modified", "additions": 59, "deletions": 13, "changes": 72, "blob_url": "https://github.com/rust-lang/rust/blob/f60d2eb6c19751154a2c752d1c916420c0bb60e6/compiler%2Frustc_data_structures%2Fsrc%2Fprofiling.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f60d2eb6c19751154a2c752d1c916420c0bb60e6/compiler%2Frustc_data_structures%2Fsrc%2Fprofiling.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_data_structures%2Fsrc%2Fprofiling.rs?ref=f60d2eb6c19751154a2c752d1c916420c0bb60e6", "patch": "@@ -97,6 +97,7 @@ use std::time::{Duration, Instant};\n pub use measureme::EventId;\n use measureme::{EventIdBuilder, Profiler, SerializableString, StringId};\n use parking_lot::RwLock;\n+use serde_json::json;\n use smallvec::SmallVec;\n \n bitflags::bitflags! {\n@@ -145,6 +146,15 @@ const EVENT_FILTERS_BY_NAME: &[(&str, EventFilter)] = &[\n /// Something that uniquely identifies a query invocation.\n pub struct QueryInvocationId(pub u32);\n \n+/// Which format to use for `-Z time-passes`\n+#[derive(Clone, Copy, PartialEq, Hash, Debug)]\n+pub enum TimePassesFormat {\n+    /// Emit human readable text\n+    Text,\n+    /// Emit structured JSON\n+    Json,\n+}\n+\n /// A reference to the SelfProfiler. It can be cloned and sent across thread\n /// boundaries at will.\n #[derive(Clone)]\n@@ -158,14 +168,14 @@ pub struct SelfProfilerRef {\n     // actually enabled.\n     event_filter_mask: EventFilter,\n \n-    // Print verbose generic activities to stderr?\n-    print_verbose_generic_activities: bool,\n+    // Print verbose generic activities to stderr.\n+    print_verbose_generic_activities: Option<TimePassesFormat>,\n }\n \n impl SelfProfilerRef {\n     pub fn new(\n         profiler: Option<Arc<SelfProfiler>>,\n-        print_verbose_generic_activities: bool,\n+        print_verbose_generic_activities: Option<TimePassesFormat>,\n     ) -> SelfProfilerRef {\n         // If there is no SelfProfiler then the filter mask is set to NONE,\n         // ensuring that nothing ever tries to actually access it.\n@@ -207,9 +217,10 @@ impl SelfProfilerRef {\n     /// a measureme event, \"verbose\" generic activities also print a timing entry to\n     /// stderr if the compiler is invoked with -Ztime-passes.\n     pub fn verbose_generic_activity(&self, event_label: &'static str) -> VerboseTimingGuard<'_> {\n-        let message = self.print_verbose_generic_activities.then(|| event_label.to_owned());\n+        let message_and_format =\n+            self.print_verbose_generic_activities.map(|format| (event_label.to_owned(), format));\n \n-        VerboseTimingGuard::start(message, self.generic_activity(event_label))\n+        VerboseTimingGuard::start(message_and_format, self.generic_activity(event_label), false)\n     }\n \n     /// Like `verbose_generic_activity`, but with an extra arg.\n@@ -221,11 +232,26 @@ impl SelfProfilerRef {\n     where\n         A: Borrow<str> + Into<String>,\n     {\n-        let message = self\n+        let message_and_format = self\n             .print_verbose_generic_activities\n-            .then(|| format!(\"{}({})\", event_label, event_arg.borrow()));\n+            .map(|format| (format!(\"{}({})\", event_label, event_arg.borrow()), format));\n \n-        VerboseTimingGuard::start(message, self.generic_activity_with_arg(event_label, event_arg))\n+        VerboseTimingGuard::start(\n+            message_and_format,\n+            self.generic_activity_with_arg(event_label, event_arg),\n+            false,\n+        )\n+    }\n+\n+    /// Like `verbose_generic_activity`, but `event_label` must be unique for a rustc session.\n+    pub fn unique_verbose_generic_activity(\n+        &self,\n+        event_label: &'static str,\n+    ) -> VerboseTimingGuard<'_> {\n+        let message_and_format =\n+            self.print_verbose_generic_activities.map(|format| (event_label.to_owned(), format));\n+\n+        VerboseTimingGuard::start(message_and_format, self.generic_activity(event_label), true)\n     }\n \n     /// Start profiling a generic activity. Profiling continues until the\n@@ -705,15 +731,21 @@ impl<'a> TimingGuard<'a> {\n \n #[must_use]\n pub struct VerboseTimingGuard<'a> {\n-    start_and_message: Option<(Instant, Option<usize>, String)>,\n+    start_and_message: Option<(Instant, Option<usize>, String, TimePassesFormat, bool)>,\n     _guard: TimingGuard<'a>,\n }\n \n impl<'a> VerboseTimingGuard<'a> {\n-    pub fn start(message: Option<String>, _guard: TimingGuard<'a>) -> Self {\n+    pub fn start(\n+        message_and_format: Option<(String, TimePassesFormat)>,\n+        _guard: TimingGuard<'a>,\n+        unique: bool,\n+    ) -> Self {\n         VerboseTimingGuard {\n             _guard,\n-            start_and_message: message.map(|msg| (Instant::now(), get_resident_set_size(), msg)),\n+            start_and_message: message_and_format.map(|(msg, format)| {\n+                (Instant::now(), get_resident_set_size(), msg, format, unique)\n+            }),\n         }\n     }\n \n@@ -726,10 +758,10 @@ impl<'a> VerboseTimingGuard<'a> {\n \n impl Drop for VerboseTimingGuard<'_> {\n     fn drop(&mut self) {\n-        if let Some((start_time, start_rss, ref message)) = self.start_and_message {\n+        if let Some((start_time, start_rss, ref message, format, unique)) = self.start_and_message {\n             let end_rss = get_resident_set_size();\n             let dur = start_time.elapsed();\n-            print_time_passes_entry(message, dur, start_rss, end_rss);\n+            print_time_passes_entry(message, dur, start_rss, end_rss, format, unique);\n         }\n     }\n }\n@@ -739,7 +771,21 @@ pub fn print_time_passes_entry(\n     dur: Duration,\n     start_rss: Option<usize>,\n     end_rss: Option<usize>,\n+    format: TimePassesFormat,\n+    unique: bool,\n ) {\n+    if format == TimePassesFormat::Json {\n+        let json = json!({\n+            \"pass\": what,\n+            \"time\": dur.as_secs_f64(),\n+            \"rss_start\": start_rss,\n+            \"rss_end\": end_rss,\n+            \"unique\": unique,\n+        });\n+        eprintln!(\"time: {}\", json.to_string());\n+        return;\n+    }\n+\n     // Print the pass if its duration is greater than 5 ms, or it changed the\n     // measured RSS.\n     let is_notable = || {"}, {"sha": "d44bd7fdb1851ee5479055d0da209a8e153c3fed", "filename": "compiler/rustc_driver_impl/src/lib.rs", "status": "modified", "additions": 8, "deletions": 5, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/f60d2eb6c19751154a2c752d1c916420c0bb60e6/compiler%2Frustc_driver_impl%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f60d2eb6c19751154a2c752d1c916420c0bb60e6/compiler%2Frustc_driver_impl%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_driver_impl%2Fsrc%2Flib.rs?ref=f60d2eb6c19751154a2c752d1c916420c0bb60e6", "patch": "@@ -20,7 +20,9 @@ pub extern crate rustc_plugin_impl as plugin;\n \n use rustc_ast as ast;\n use rustc_codegen_ssa::{traits::CodegenBackend, CodegenErrors, CodegenResults};\n-use rustc_data_structures::profiling::{get_resident_set_size, print_time_passes_entry};\n+use rustc_data_structures::profiling::{\n+    get_resident_set_size, print_time_passes_entry, TimePassesFormat,\n+};\n use rustc_data_structures::sync::SeqCst;\n use rustc_errors::registry::{InvalidErrorCode, Registry};\n use rustc_errors::{\n@@ -161,7 +163,7 @@ pub trait Callbacks {\n \n #[derive(Default)]\n pub struct TimePassesCallbacks {\n-    time_passes: bool,\n+    time_passes: Option<TimePassesFormat>,\n }\n \n impl Callbacks for TimePassesCallbacks {\n@@ -171,7 +173,8 @@ impl Callbacks for TimePassesCallbacks {\n         // If a --print=... option has been given, we don't print the \"total\"\n         // time because it will mess up the --print output. See #64339.\n         //\n-        self.time_passes = config.opts.prints.is_empty() && config.opts.unstable_opts.time_passes;\n+        self.time_passes = (config.opts.prints.is_empty() && config.opts.unstable_opts.time_passes)\n+            .then(|| config.opts.unstable_opts.time_passes_format);\n         config.opts.trimmed_def_paths = TrimmedDefPaths::GoodPath;\n     }\n }\n@@ -1354,9 +1357,9 @@ pub fn main() -> ! {\n         RunCompiler::new(&args, &mut callbacks).run()\n     });\n \n-    if callbacks.time_passes {\n+    if let Some(format) = callbacks.time_passes {\n         let end_rss = get_resident_set_size();\n-        print_time_passes_entry(\"total\", start_time.elapsed(), start_rss, end_rss);\n+        print_time_passes_entry(\"total\", start_time.elapsed(), start_rss, end_rss, format, true);\n     }\n \n     process::exit(exit_code)"}, {"sha": "eb5990507fb6dc1eb93ff3bc9c22af025141e724", "filename": "compiler/rustc_interface/src/tests.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f60d2eb6c19751154a2c752d1c916420c0bb60e6/compiler%2Frustc_interface%2Fsrc%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f60d2eb6c19751154a2c752d1c916420c0bb60e6/compiler%2Frustc_interface%2Fsrc%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2Fsrc%2Ftests.rs?ref=f60d2eb6c19751154a2c752d1c916420c0bb60e6", "patch": "@@ -2,6 +2,7 @@\n use crate::interface::parse_cfgspecs;\n \n use rustc_data_structures::fx::FxHashSet;\n+use rustc_data_structures::profiling::TimePassesFormat;\n use rustc_errors::{emitter::HumanReadableErrorType, registry, ColorConfig};\n use rustc_session::config::rustc_optgroups;\n use rustc_session::config::Input;\n@@ -699,6 +700,7 @@ fn test_unstable_options_tracking_hash() {\n     untracked!(threads, 99);\n     untracked!(time_llvm_passes, true);\n     untracked!(time_passes, true);\n+    untracked!(time_passes_format, TimePassesFormat::Json);\n     untracked!(trace_macros, true);\n     untracked!(track_diagnostics, true);\n     untracked!(trim_diagnostic_paths, false);"}, {"sha": "c75af48e80af47e79797f05c773ea84869e7dfc2", "filename": "compiler/rustc_session/src/options.rs", "status": "modified", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/f60d2eb6c19751154a2c752d1c916420c0bb60e6/compiler%2Frustc_session%2Fsrc%2Foptions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f60d2eb6c19751154a2c752d1c916420c0bb60e6/compiler%2Frustc_session%2Fsrc%2Foptions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Foptions.rs?ref=f60d2eb6c19751154a2c752d1c916420c0bb60e6", "patch": "@@ -4,6 +4,7 @@ use crate::early_error;\n use crate::lint;\n use crate::search_paths::SearchPath;\n use crate::utils::NativeLib;\n+use rustc_data_structures::profiling::TimePassesFormat;\n use rustc_errors::{LanguageIdentifier, TerminalUrl};\n use rustc_target::spec::{CodeModel, LinkerFlavorCli, MergeFunctions, PanicStrategy, SanitizerSet};\n use rustc_target::spec::{\n@@ -365,6 +366,7 @@ mod desc {\n     pub const parse_number: &str = \"a number\";\n     pub const parse_opt_number: &str = parse_number;\n     pub const parse_threads: &str = parse_number;\n+    pub const parse_time_passes_format: &str = \"`text` (default) or `json`\";\n     pub const parse_passes: &str = \"a space-separated list of passes, or `all`\";\n     pub const parse_panic_strategy: &str = \"either `unwind` or `abort`\";\n     pub const parse_opt_panic_strategy: &str = parse_panic_strategy;\n@@ -829,6 +831,21 @@ mod parse {\n         true\n     }\n \n+    pub(crate) fn parse_time_passes_format(slot: &mut TimePassesFormat, v: Option<&str>) -> bool {\n+        match v {\n+            None => true,\n+            Some(\"json\") => {\n+                *slot = TimePassesFormat::Json;\n+                true\n+            }\n+            Some(\"text\") => {\n+                *slot = TimePassesFormat::Text;\n+                true\n+            }\n+            Some(_) => false,\n+        }\n+    }\n+\n     pub(crate) fn parse_dump_mono_stats(slot: &mut DumpMonoStatsFormat, v: Option<&str>) -> bool {\n         match v {\n             None => true,\n@@ -1709,6 +1726,8 @@ options! {\n         \"measure time of each LLVM pass (default: no)\"),\n     time_passes: bool = (false, parse_bool, [UNTRACKED],\n         \"measure time of each rustc pass (default: no)\"),\n+    time_passes_format: TimePassesFormat = (TimePassesFormat::Text, parse_time_passes_format, [UNTRACKED],\n+        \"the format to use for -Z time-passes (`text` (default) or `json`)\"),\n     tiny_const_eval_limit: bool = (false, parse_bool, [TRACKED],\n         \"sets a tiny, non-configurable limit for const eval; useful for compiler tests\"),\n     #[rustc_lint_opt_deny_field_access(\"use `Session::tls_model` instead of this field\")]"}, {"sha": "1a3fdc7f437c8a5e6819619348041534e4ffdb84", "filename": "compiler/rustc_session/src/session.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/f60d2eb6c19751154a2c752d1c916420c0bb60e6/compiler%2Frustc_session%2Fsrc%2Fsession.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f60d2eb6c19751154a2c752d1c916420c0bb60e6/compiler%2Frustc_session%2Fsrc%2Fsession.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Fsession.rs?ref=f60d2eb6c19751154a2c752d1c916420c0bb60e6", "patch": "@@ -1487,7 +1487,10 @@ pub fn build_session(\n         CguReuseTracker::new_disabled()\n     };\n \n-    let prof = SelfProfilerRef::new(self_profiler, sopts.unstable_opts.time_passes);\n+    let prof = SelfProfilerRef::new(\n+        self_profiler,\n+        sopts.unstable_opts.time_passes.then(|| sopts.unstable_opts.time_passes_format),\n+    );\n \n     let ctfe_backtrace = Lock::new(match env::var(\"RUSTC_CTFE_BACKTRACE\") {\n         Ok(ref val) if val == \"immediate\" => CtfeBacktrace::Immediate,"}, {"sha": "a7feb2794c4f6686909fcece2a5afe23114b6ffc", "filename": "compiler/rustc_session/src/utils.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f60d2eb6c19751154a2c752d1c916420c0bb60e6/compiler%2Frustc_session%2Fsrc%2Futils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f60d2eb6c19751154a2c752d1c916420c0bb60e6/compiler%2Frustc_session%2Fsrc%2Futils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Futils.rs?ref=f60d2eb6c19751154a2c752d1c916420c0bb60e6", "patch": "@@ -4,10 +4,10 @@ use std::path::{Path, PathBuf};\n \n impl Session {\n     pub fn timer(&self, what: &'static str) -> VerboseTimingGuard<'_> {\n-        self.prof.verbose_generic_activity(what)\n+        self.prof.unique_verbose_generic_activity(what)\n     }\n     pub fn time<R>(&self, what: &'static str, f: impl FnOnce() -> R) -> R {\n-        self.prof.verbose_generic_activity(what).run(f)\n+        self.prof.unique_verbose_generic_activity(what).run(f)\n     }\n }\n "}, {"sha": "72f5f933d8db4ad7c1f48f1c360b0d0cafb4916a", "filename": "tests/rustdoc-ui/z-help.stdout", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/f60d2eb6c19751154a2c752d1c916420c0bb60e6/tests%2Frustdoc-ui%2Fz-help.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/f60d2eb6c19751154a2c752d1c916420c0bb60e6/tests%2Frustdoc-ui%2Fz-help.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frustdoc-ui%2Fz-help.stdout?ref=f60d2eb6c19751154a2c752d1c916420c0bb60e6", "patch": "@@ -183,6 +183,7 @@\n     -Z                               threads=val -- use a thread pool with N threads\n     -Z                      time-llvm-passes=val -- measure time of each LLVM pass (default: no)\n     -Z                           time-passes=val -- measure time of each rustc pass (default: no)\n+    -Z                    time-passes-format=val -- the format to use for -Z time-passes (`text` (default) or `json`)\n     -Z                 tiny-const-eval-limit=val -- sets a tiny, non-configurable limit for const eval; useful for compiler tests\n     -Z                             tls-model=val -- choose the TLS model to use (`rustc --print tls-models` for details)\n     -Z                          trace-macros=val -- for every macro invocation, print its name and arguments (default: no)"}]}