{"sha": "4af28c98fac5bc36a93527b79c77081eedfb554b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRhZjI4Yzk4ZmFjNWJjMzZhOTM1MjdiNzljNzcwODFlZWRmYjU1NGI=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-02-15T20:46:23Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-02-15T20:46:23Z"}, "message": "auto merge of #12296 : dotdash/rust/byval_noalias, r=cmr\n\nFunction parameters that are to be passed by value but don't fit into a\r\nsingle register are currently passed by creating a copy on the stack and\r\npassing a pointer to that copy to the callee. Since the copy is made\r\njust for the function call, there are no aliases.\r\n\r\nFor example, this sometimes allows LLVM to eliminate unnecessary calls\r\nto drop glue. Given\r\n\r\n````rust\r\nstruct Foo {\r\n    a: int,\r\n    b: Option<~str>,\r\n}\r\n\r\nextern {\r\n    fn eat(eat: Option<~str>);\r\n}\r\n\r\npub fn foo(v: Foo) {\r\n    match v {\r\n        Foo { a: _, b } => unsafe { eat(b) }\r\n    }\r\n}\r\n````\r\n\r\nLLVM currently can't eliminate the drop call for the string, because it\r\nonly sees a _pointer_ to Foo, for which it has to expect an alias. So we\r\nget:\r\n\r\n````llvm\r\n; Function Attrs: uwtable\r\ndefine void @_ZN3foo20h9f32c90ae7201edbxaa4v0.0E(%struct.Foo* nocapture) unnamed_addr #0 {\r\n\"_ZN34std..option..Option$LT$$UP$str$GT$9glue_drop17hc39b3015f3b9c69dE.exit\":\r\n  %1 = getelementptr inbounds %struct.Foo* %0, i64 0, i32 1, i32 0\r\n  %2 = load { i64, i64, [0 x i8] }** %1, align 8\r\n  store { i64, i64, [0 x i8] }* null, { i64, i64, [0 x i8] }** %1, align 8\r\n  %3 = ptrtoint { i64, i64, [0 x i8] }* %2 to i64\r\n  %.fca.0.insert = insertvalue { i64 } undef, i64 %3, 0\r\n  tail call void @eat({ i64 } %.fca.0.insert)\r\n  %4 = load { i64, i64, [0 x i8] }** %1, align 8\r\n  %5 = icmp eq { i64, i64, [0 x i8] }* %4, null\r\n  br i1 %5, label %_ZN3Foo9glue_drop17hf611996539d3036fE.exit, label %\"_ZN8_$UP$str9glue_drop17h15dbdbe2b8897a98E.exit.i.i\"\r\n\r\n\"_ZN8_$UP$str9glue_drop17h15dbdbe2b8897a98E.exit.i.i\": ; preds = %\"_ZN34std..option..Option$LT$$UP$str$GT$9glue_drop17hc39b3015f3b9c69dE.exit\"\r\n  %6 = bitcast { i64, i64, [0 x i8] }* %4 to i8*\r\n  tail call void @free(i8* %6) #1\r\n  br label %_ZN3Foo9glue_drop17hf611996539d3036fE.exit\r\n\r\n_ZN3Foo9glue_drop17hf611996539d3036fE.exit:       ; preds = %\"_ZN34std..option..Option$LT$$UP$str$GT$9glue_drop17hc39b3015f3b9c69dE.exit\", %\"_ZN8_$UP$str9glue_drop17h15dbdbe2b8897a98E.exit.i.i\"\r\n  ret void\r\n}\r\n````\r\n\r\nBut with the `noalias` attribute, it can safely optimize that to:\r\n\r\n````llvm\r\ndefine void @_ZN3foo20hd28431f929f0d6c4xaa4v0.0E(%struct.Foo* noalias nocapture) unnamed_addr #0 {\r\n_ZN3Foo9glue_drop17he9afbc09d4e9c851E.exit:\r\n  %1 = getelementptr inbounds %struct.Foo* %0, i64 0, i32 1, i32 0\r\n  %2 = load { i64, i64, [0 x i8] }** %1, align 8\r\n  store { i64, i64, [0 x i8] }* null, { i64, i64, [0 x i8] }** %1, align 8\r\n  %3 = ptrtoint { i64, i64, [0 x i8] }* %2 to i64\r\n  %.fca.0.insert = insertvalue { i64 } undef, i64 %3, 0\r\n  tail call void @eat({ i64 } %.fca.0.insert)\r\n  ret void\r\n}\r\n````", "tree": {"sha": "cdc91ef488c6f37b0920fd878ab386d8b2df8bf4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cdc91ef488c6f37b0920fd878ab386d8b2df8bf4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4af28c98fac5bc36a93527b79c77081eedfb554b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4af28c98fac5bc36a93527b79c77081eedfb554b", "html_url": "https://github.com/rust-lang/rust/commit/4af28c98fac5bc36a93527b79c77081eedfb554b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4af28c98fac5bc36a93527b79c77081eedfb554b/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "adea48abb730bfcfdc7008f6bc5964ed5b1e7ca6", "url": "https://api.github.com/repos/rust-lang/rust/commits/adea48abb730bfcfdc7008f6bc5964ed5b1e7ca6", "html_url": "https://github.com/rust-lang/rust/commit/adea48abb730bfcfdc7008f6bc5964ed5b1e7ca6"}, {"sha": "500d29b589a608357c1b82e4203dc1b77454c78c", "url": "https://api.github.com/repos/rust-lang/rust/commits/500d29b589a608357c1b82e4203dc1b77454c78c", "html_url": "https://github.com/rust-lang/rust/commit/500d29b589a608357c1b82e4203dc1b77454c78c"}], "stats": {"total": 10, "additions": 9, "deletions": 1}, "files": [{"sha": "dc8e786fba24e2a06befd7e2ce97b2ba8d3734e2", "filename": "src/librustc/middle/trans/base.rs", "status": "modified", "additions": 9, "deletions": 1, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/4af28c98fac5bc36a93527b79c77081eedfb554b/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4af28c98fac5bc36a93527b79c77081eedfb554b/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fbase.rs?ref=4af28c98fac5bc36a93527b79c77081eedfb554b", "patch": "@@ -273,7 +273,15 @@ pub fn decl_rust_fn(ccx: &CrateContext, has_env: bool,\n                     llvm::LLVMAddAttribute(llarg, lib::llvm::NoAliasAttribute as c_uint);\n                 }\n             }\n-            _ => {}\n+            _ => {\n+                // For non-immediate arguments the callee gets its own copy of\n+                // the value on the stack, so there are no aliases\n+                if !type_is_immediate(ccx, arg_ty) {\n+                    unsafe {\n+                        llvm::LLVMAddAttribute(llarg, lib::llvm::NoAliasAttribute as c_uint);\n+                    }\n+                }\n+            }\n         }\n     }\n "}]}