{"sha": "071186f8e29792f7211a0249b454db9ef40f6605", "node_id": "C_kwDOAAsO6NoAKDA3MTE4NmY4ZTI5NzkyZjcyMTFhMDI0OWI0NTRkYjllZjQwZjY2MDU", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2022-02-22T08:56:34Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-02-22T08:56:34Z"}, "message": "Merge #11525\n\n11525: fix(assist): Drop generic args in path before insert use in `replace_qualified_name_with_use` r=Veykril a=tysg\n\nFixes #11505. also removed an unnecessary `clone_for_update` call.\n\nCo-authored-by: Tianyi Song <42670338+tysg@users.noreply.github.com>", "tree": {"sha": "847183aaf3161dfd0a6a24a4a88497395bd28d1c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/847183aaf3161dfd0a6a24a4a88497395bd28d1c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/071186f8e29792f7211a0249b454db9ef40f6605", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJiFKVCCRBK7hj4Ov3rIwAAS54IAEGzHvTcefeZJaxm1t93tg5d\nXozO59JyzsrrPLreEC8iLxd1cGq7XCN+EVXzjPgzoqC4i6s6ZxxkmdGsrWpR7DSE\n97145tComJYIoh8L7cNWmzNoC8N7fCj+g0zQ/pbqRDXIK+i27eAttZ10pcwd24eE\n1Q7LCVnF0SzCAOv9jaxUtkxBkqRv8qckQ0k9w0i920z+M4vz2bg03oJ15oJUnfO6\n6kBSy4EzXpiUD0P82p+VmhZoDAY3xKUIuljU8y1v2O+FUmMs35VVgTlfNjqhkMLm\nQeZZHa6Oi2bEc1ipcy5Fly4jL6EB6s55Ts+0/1W0VEW6azw4eD/7Nh2QIu7NjAQ=\n=pmr/\n-----END PGP SIGNATURE-----\n", "payload": "tree 847183aaf3161dfd0a6a24a4a88497395bd28d1c\nparent 81af96d77a4940a6783b714072f7484a8545cdc0\nparent 1c3d6725e28e3e85acb804799e7daca02daeae86\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1645520194 +0000\ncommitter GitHub <noreply@github.com> 1645520194 +0000\n\nMerge #11525\n\n11525: fix(assist): Drop generic args in path before insert use in `replace_qualified_name_with_use` r=Veykril a=tysg\n\nFixes #11505. also removed an unnecessary `clone_for_update` call.\n\nCo-authored-by: Tianyi Song <42670338+tysg@users.noreply.github.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/071186f8e29792f7211a0249b454db9ef40f6605", "html_url": "https://github.com/rust-lang/rust/commit/071186f8e29792f7211a0249b454db9ef40f6605", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/071186f8e29792f7211a0249b454db9ef40f6605/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "81af96d77a4940a6783b714072f7484a8545cdc0", "url": "https://api.github.com/repos/rust-lang/rust/commits/81af96d77a4940a6783b714072f7484a8545cdc0", "html_url": "https://github.com/rust-lang/rust/commit/81af96d77a4940a6783b714072f7484a8545cdc0"}, {"sha": "1c3d6725e28e3e85acb804799e7daca02daeae86", "url": "https://api.github.com/repos/rust-lang/rust/commits/1c3d6725e28e3e85acb804799e7daca02daeae86", "html_url": "https://github.com/rust-lang/rust/commit/1c3d6725e28e3e85acb804799e7daca02daeae86"}], "stats": {"total": 46, "additions": 44, "deletions": 2}, "files": [{"sha": "71c674a8dd745fdad9641239d8290f6941c9c90c", "filename": "crates/ide_assists/src/handlers/replace_qualified_name_with_use.rs", "status": "modified", "additions": 44, "deletions": 2, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/071186f8e29792f7211a0249b454db9ef40f6605/crates%2Fide_assists%2Fsrc%2Fhandlers%2Freplace_qualified_name_with_use.rs", "raw_url": "https://github.com/rust-lang/rust/raw/071186f8e29792f7211a0249b454db9ef40f6605/crates%2Fide_assists%2Fsrc%2Fhandlers%2Freplace_qualified_name_with_use.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_assists%2Fsrc%2Fhandlers%2Freplace_qualified_name_with_use.rs?ref=071186f8e29792f7211a0249b454db9ef40f6605", "patch": "@@ -84,7 +84,8 @@ pub(crate) fn replace_qualified_name_with_use(\n                 ImportScope::Module(it) => ImportScope::Module(builder.make_mut(it)),\n                 ImportScope::Block(it) => ImportScope::Block(builder.make_mut(it)),\n             };\n-            shorten_paths(scope.as_syntax_node(), &path.clone_for_update());\n+            shorten_paths(scope.as_syntax_node(), &path);\n+            let path = drop_generic_args(&path);\n             // stick the found import in front of the to be replaced path\n             let path = match path_to_qualifier.and_then(|it| mod_path_to_ast(&it).qualifier()) {\n                 Some(qualifier) => make::path_concat(qualifier, path),\n@@ -95,7 +96,17 @@ pub(crate) fn replace_qualified_name_with_use(\n     )\n }\n \n-/// Adds replacements to `re` that shorten `path` in all descendants of `node`.\n+fn drop_generic_args(path: &ast::Path) -> ast::Path {\n+    let path = path.clone_for_update();\n+    if let Some(segment) = path.segment() {\n+        if let Some(generic_args) = segment.generic_arg_list() {\n+            ted::remove(generic_args.syntax());\n+        }\n+    }\n+    path\n+}\n+\n+/// Mutates `node` to shorten `path` in all descendants of `node`.\n fn shorten_paths(node: &SyntaxNode, path: &ast::Path) {\n     for child in node.children() {\n         match_ast! {\n@@ -389,6 +400,37 @@ mod std {\n fn main() {\n     drop(0);\n }\n+\",\n+        );\n+    }\n+\n+    #[test]\n+    fn replace_should_drop_generic_args_in_use() {\n+        check_assist(\n+            replace_qualified_name_with_use,\n+            r\"\n+mod std {\n+    pub mod mem {\n+        pub fn drop<T>(_: T) {}\n+    }\n+}\n+\n+fn main() {\n+    std::mem::drop::<usize>$0(0);\n+}\n+\",\n+            r\"\n+use std::mem::drop;\n+\n+mod std {\n+    pub mod mem {\n+        pub fn drop<T>(_: T) {}\n+    }\n+}\n+\n+fn main() {\n+    drop::<usize>(0);\n+}\n \",\n         );\n     }"}]}