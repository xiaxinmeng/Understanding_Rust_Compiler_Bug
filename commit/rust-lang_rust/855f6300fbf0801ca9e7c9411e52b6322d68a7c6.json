{"sha": "855f6300fbf0801ca9e7c9411e52b6322d68a7c6", "node_id": "C_kwDOAAsO6NoAKDg1NWY2MzAwZmJmMDgwMWNhOWU3Yzk0MTFlNTJiNjMyMmQ2OGE3YzY", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-01-04T15:34:15Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-01-04T15:34:15Z"}, "message": "Rollup merge of #92107 - nikic:rmeta-lnk-remove, r=nagisa\n\nActually set IMAGE_SCN_LNK_REMOVE for .rmeta\n\nThe code intended to set the IMAGE_SCN_LNK_REMOVE flag for the\n.rmeta section, however the value of this flag was set to zero.\nInstead use the actual value provided by the object crate.\n\nThis dates back to the original introduction of this code in\nPR #84449, so we were never setting this flag. As I'm not on\nWindows, I'm not sure whether that means we were embedding .rmeta\ninto executables, or whether the section ended up getting stripped\nfor some other reason.", "tree": {"sha": "5e5ab01e7e421350e76545c762bc3762aca2311c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5e5ab01e7e421350e76545c762bc3762aca2311c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/855f6300fbf0801ca9e7c9411e52b6322d68a7c6", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJh1Gj4CRBK7hj4Ov3rIwAAnNwIACsxqjaz7v8tRAGNwVH+pn5t\nN5Yo+YNUV0ENioVNXccaed11GEjQaz/UEsLm6irXvkt1mHFe9Z6oIBEVBD/yX9zg\neVm9Fp1H9E/AuTlIes5t3+L+WLXgJ+AfXdZoHmggMeSlLYxxyYvfg9o/thgtdGxB\nuZ0jMW9/tnZ2YFsQnWU2aawCE4WeMGw0Nz6dGbG0e7YnoCSwW3ky2KuPgmyJbTvM\n3WNkttHQzQgkZEgzF4yfY8b0EBMvU9jMWevLOnHDuwbApnkwW/ToMDkv3so/1ybs\niGVGzlu2AH9vl9XEEqrE+Y+37ee235ytTj/x20tj/on8J3tjWuKA/wSc5UJzQVA=\n=BRBO\n-----END PGP SIGNATURE-----\n", "payload": "tree 5e5ab01e7e421350e76545c762bc3762aca2311c\nparent c7125ba0fa4e9abe826f004a023c0bf3678a8963\nparent 6eb50729291c64acf0d6588dd632e9792508ca31\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1641310455 +0100\ncommitter GitHub <noreply@github.com> 1641310455 +0100\n\nRollup merge of #92107 - nikic:rmeta-lnk-remove, r=nagisa\n\nActually set IMAGE_SCN_LNK_REMOVE for .rmeta\n\nThe code intended to set the IMAGE_SCN_LNK_REMOVE flag for the\n.rmeta section, however the value of this flag was set to zero.\nInstead use the actual value provided by the object crate.\n\nThis dates back to the original introduction of this code in\nPR #84449, so we were never setting this flag. As I'm not on\nWindows, I'm not sure whether that means we were embedding .rmeta\ninto executables, or whether the section ended up getting stripped\nfor some other reason.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/855f6300fbf0801ca9e7c9411e52b6322d68a7c6", "html_url": "https://github.com/rust-lang/rust/commit/855f6300fbf0801ca9e7c9411e52b6322d68a7c6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/855f6300fbf0801ca9e7c9411e52b6322d68a7c6/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c7125ba0fa4e9abe826f004a023c0bf3678a8963", "url": "https://api.github.com/repos/rust-lang/rust/commits/c7125ba0fa4e9abe826f004a023c0bf3678a8963", "html_url": "https://github.com/rust-lang/rust/commit/c7125ba0fa4e9abe826f004a023c0bf3678a8963"}, {"sha": "6eb50729291c64acf0d6588dd632e9792508ca31", "url": "https://api.github.com/repos/rust-lang/rust/commits/6eb50729291c64acf0d6588dd632e9792508ca31", "html_url": "https://github.com/rust-lang/rust/commit/6eb50729291c64acf0d6588dd632e9792508ca31"}], "stats": {"total": 11, "additions": 5, "deletions": 6}, "files": [{"sha": "79c24f0f17280ac73821d47a532f467fa5cf5656", "filename": "compiler/rustc_codegen_ssa/src/back/metadata.rs", "status": "modified", "additions": 5, "deletions": 6, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/855f6300fbf0801ca9e7c9411e52b6322d68a7c6/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Fmetadata.rs", "raw_url": "https://github.com/rust-lang/rust/raw/855f6300fbf0801ca9e7c9411e52b6322d68a7c6/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Fmetadata.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Fmetadata.rs?ref=855f6300fbf0801ca9e7c9411e52b6322d68a7c6", "patch": "@@ -6,8 +6,8 @@ use std::path::Path;\n \n use object::write::{self, StandardSegment, Symbol, SymbolSection};\n use object::{\n-    elf, Architecture, BinaryFormat, Endianness, FileFlags, Object, ObjectSection, SectionFlags,\n-    SectionKind, SymbolFlags, SymbolKind, SymbolScope,\n+    elf, pe, Architecture, BinaryFormat, Endianness, FileFlags, Object, ObjectSection,\n+    SectionFlags, SectionKind, SymbolFlags, SymbolKind, SymbolScope,\n };\n \n use snap::write::FrameEncoder;\n@@ -216,13 +216,12 @@ pub fn create_rmeta_file(sess: &Session, metadata: &[u8]) -> Vec<u8> {\n     );\n     match file.format() {\n         BinaryFormat::Coff => {\n-            const IMAGE_SCN_LNK_REMOVE: u32 = 0;\n             file.section_mut(section).flags =\n-                SectionFlags::Coff { characteristics: IMAGE_SCN_LNK_REMOVE };\n+                SectionFlags::Coff { characteristics: pe::IMAGE_SCN_LNK_REMOVE };\n         }\n         BinaryFormat::Elf => {\n-            const SHF_EXCLUDE: u64 = 0x80000000;\n-            file.section_mut(section).flags = SectionFlags::Elf { sh_flags: SHF_EXCLUDE };\n+            file.section_mut(section).flags =\n+                SectionFlags::Elf { sh_flags: elf::SHF_EXCLUDE as u64 };\n         }\n         _ => {}\n     };"}]}