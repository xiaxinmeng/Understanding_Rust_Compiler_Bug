{"sha": "bff8a86698195ba2d2798405d3535efdce2fccef", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJmZjhhODY2OTgxOTViYTJkMjc5ODQwNWQzNTM1ZWZkY2UyZmNjZWY=", "commit": {"author": {"name": "David Wood", "email": "david@davidtw.co", "date": "2019-05-16T21:00:27Z"}, "committer": {"name": "David Wood", "email": "david@davidtw.co", "date": "2019-05-17T08:12:40Z"}, "message": "Checking generic args after late bound region err.\n\nThis commit fixes an ICE that occurs when a late bound region error is\nemitted and that resulted in the rest of the generic arguments of a\nfunction not being checked.\n\nFor example, you could specify a generic type parameter `T` in a function\ncall `foo<'_, T>()` to a function that doesn't have a generic type\nparameter.\n\nSince an error wasn't emitted from the function, compilation\ncontinued to parts of typeck that didn't expect a generic type argument\nin a call for a function that didn't have any generic type arguments.", "tree": {"sha": "4791a63441241e5de62c85e26b992d4868a2d70c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4791a63441241e5de62c85e26b992d4868a2d70c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bff8a86698195ba2d2798405d3535efdce2fccef", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIyBAABCgAdFiEEWwgxPGhT5b/6kagXAXYLT59T8VQFAlzebPgACgkQAXYLT59T\n8VSZoQ/4+pb3fuktBrpZ+eVPzKTSq7RGe95MARwG3AwA+JDw5KBBMORkPd5FyT30\nBncy22pnoYy/GUzKPUt+xNcPNNeZ7wiHIcn1IEisGi8uLnBLxrrmVEXJu8RuY96v\nDLqCX01cBy/A3SBPYCzvQ38Lqx/OasncrpAnSExpckfj2aerzqVxyMTqjJ6lJxeI\nPQ7ad70RJVhWZkOPPpg24BNCgXd3oEMAbTBc21T8Y/q5A4yGIy+szHaScu//t1Bn\ntYyURRJWm4uYFJ1Um/D2GdiEMA8UT6+Ji23yrVpVubp1EhEPUAnUUFRViSu1Fjwz\nXvGrIQD2pe+LD7ztF3BGPH1aqVvD+hexBKoz+0HDR0JKbe+hpQKHbhI8zepF79ss\nJrTpWjk2JtaHD+mMdEzRIB2joDwkUI1/HbSQYJjZeew+pJihvQjjvqE/5hEuyoVC\nt2UhRPxe4blJfGb00iUz8VrvjpJe/fDde75uExQOnAQtDgi1id6INuEsMiTpXhzf\n7JNr8sfqcItIM17nLS5JXyuzUqQRqYOKavTsUDn7prgBwcB5z3UlsQhL6oFlz7kq\nzMcu+NZw87jvV0VBKti93YMb+zz6LiEx/BtQwiLkOdfvWkdLDpBiPPlnhsSGwarp\ntmL33MzMPltGD1uJOl9QUwxNnaIeBTR/SiRMF17wT43vHWrlAQ==\n=GLQ9\n-----END PGP SIGNATURE-----", "payload": "tree 4791a63441241e5de62c85e26b992d4868a2d70c\nparent 7158ed9cbea805adf8161d3deaadba2f85b7692e\nauthor David Wood <david@davidtw.co> 1558040427 +0100\ncommitter David Wood <david@davidtw.co> 1558080760 +0100\n\nChecking generic args after late bound region err.\n\nThis commit fixes an ICE that occurs when a late bound region error is\nemitted and that resulted in the rest of the generic arguments of a\nfunction not being checked.\n\nFor example, you could specify a generic type parameter `T` in a function\ncall `foo<'_, T>()` to a function that doesn't have a generic type\nparameter.\n\nSince an error wasn't emitted from the function, compilation\ncontinued to parts of typeck that didn't expect a generic type argument\nin a call for a function that didn't have any generic type arguments.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bff8a86698195ba2d2798405d3535efdce2fccef", "html_url": "https://github.com/rust-lang/rust/commit/bff8a86698195ba2d2798405d3535efdce2fccef", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bff8a86698195ba2d2798405d3535efdce2fccef/comments", "author": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "committer": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7158ed9cbea805adf8161d3deaadba2f85b7692e", "url": "https://api.github.com/repos/rust-lang/rust/commits/7158ed9cbea805adf8161d3deaadba2f85b7692e", "html_url": "https://github.com/rust-lang/rust/commit/7158ed9cbea805adf8161d3deaadba2f85b7692e"}], "stats": {"total": 57, "additions": 52, "deletions": 5}, "files": [{"sha": "4b052aec5fc2f3be0472421fb253bd40a803d394", "filename": "src/librustc_typeck/astconv.rs", "status": "modified", "additions": 7, "deletions": 5, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/bff8a86698195ba2d2798405d3535efdce2fccef/src%2Flibrustc_typeck%2Fastconv.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bff8a86698195ba2d2798405d3535efdce2fccef/src%2Flibrustc_typeck%2Fastconv.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fastconv.rs?ref=bff8a86698195ba2d2798405d3535efdce2fccef", "patch": "@@ -290,6 +290,7 @@ impl<'o, 'gcx: 'tcx, 'tcx> dyn AstConv<'gcx, 'tcx> + 'o {\n         }\n \n         // Prohibit explicit lifetime arguments if late-bound lifetime parameters are present.\n+        let mut reported_late_bound_region_err = None;\n         if !infer_lifetimes {\n             if let Some(span_late) = def.has_late_bound_regions {\n                 let msg = \"cannot specify lifetime arguments explicitly \\\n@@ -301,13 +302,13 @@ impl<'o, 'gcx: 'tcx, 'tcx> dyn AstConv<'gcx, 'tcx> + 'o {\n                     let mut err = tcx.sess.struct_span_err(span, msg);\n                     err.span_note(span_late, note);\n                     err.emit();\n-                    return (true, None);\n+                    reported_late_bound_region_err = Some(true);\n                 } else {\n                     let mut multispan = MultiSpan::from_span(span);\n                     multispan.push_span_label(span_late, note.to_string());\n                     tcx.lint_hir(lint::builtin::LATE_BOUND_LIFETIME_ARGUMENTS,\n                                  args.args[0].id(), multispan, msg);\n-                    return (false, None);\n+                    reported_late_bound_region_err = Some(false);\n                 }\n             }\n         }\n@@ -325,7 +326,7 @@ impl<'o, 'gcx: 'tcx, 'tcx> dyn AstConv<'gcx, 'tcx> + 'o {\n             // For kinds without defaults (i.e., lifetimes), `required == permitted`.\n             // For other kinds (i.e., types), `permitted` may be greater than `required`.\n             if required <= provided && provided <= permitted {\n-                return (false, None);\n+                return (reported_late_bound_region_err.unwrap_or(false), None);\n             }\n \n             // Unfortunately lifetime and type parameter mismatches are typically styled\n@@ -380,7 +381,8 @@ impl<'o, 'gcx: 'tcx, 'tcx> dyn AstConv<'gcx, 'tcx> + 'o {\n              potential_assoc_types)\n         };\n \n-        if !infer_lifetimes || arg_counts.lifetimes > param_counts.lifetimes {\n+        if reported_late_bound_region_err.is_none()\n+            && (!infer_lifetimes || arg_counts.lifetimes > param_counts.lifetimes) {\n             check_kind_count(\n                 \"lifetime\",\n                 param_counts.lifetimes,\n@@ -410,7 +412,7 @@ impl<'o, 'gcx: 'tcx, 'tcx> dyn AstConv<'gcx, 'tcx> + 'o {\n                 arg_counts.lifetimes,\n             )\n         } else {\n-            (false, None)\n+            (reported_late_bound_region_err.unwrap_or(false), None)\n         }\n     }\n "}, {"sha": "d6a0189c3e042230787819ca6512c6f621bd91bc", "filename": "src/test/ui/issue-60622.rs", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/bff8a86698195ba2d2798405d3535efdce2fccef/src%2Ftest%2Fui%2Fissue-60622.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bff8a86698195ba2d2798405d3535efdce2fccef/src%2Ftest%2Fui%2Fissue-60622.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissue-60622.rs?ref=bff8a86698195ba2d2798405d3535efdce2fccef", "patch": "@@ -0,0 +1,18 @@\n+// ignore-tidy-linelength\n+\n+#![deny(warnings)]\n+\n+struct Borked {}\n+\n+impl Borked {\n+    fn a(&self) {}\n+}\n+\n+fn run_wild<T>(b: &Borked) {\n+    b.a::<'_, T>();\n+    //~^ ERROR cannot specify lifetime arguments explicitly if late bound lifetime parameters are present\n+    //~^^ ERROR wrong number of type arguments: expected 0, found 1\n+    //~^^^ WARN this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n+}\n+\n+fn main() {}"}, {"sha": "0c337c315f161741f5c796d11261491de8a32224", "filename": "src/test/ui/issue-60622.stderr", "status": "added", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/bff8a86698195ba2d2798405d3535efdce2fccef/src%2Ftest%2Fui%2Fissue-60622.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/bff8a86698195ba2d2798405d3535efdce2fccef/src%2Ftest%2Fui%2Fissue-60622.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissue-60622.stderr?ref=bff8a86698195ba2d2798405d3535efdce2fccef", "patch": "@@ -0,0 +1,27 @@\n+error: cannot specify lifetime arguments explicitly if late bound lifetime parameters are present\n+  --> $DIR/issue-60622.rs:12:11\n+   |\n+LL |     fn a(&self) {}\n+   |          - the late bound lifetime parameter is introduced here\n+...\n+LL |     b.a::<'_, T>();\n+   |           ^^\n+   |\n+note: lint level defined here\n+  --> $DIR/issue-60622.rs:3:9\n+   |\n+LL | #![deny(warnings)]\n+   |         ^^^^^^^^\n+   = note: #[deny(late_bound_lifetime_arguments)] implied by #[deny(warnings)]\n+   = warning: this was previously accepted by the compiler but is being phased out; it will become a hard error in a future release!\n+   = note: for more information, see issue #42868 <https://github.com/rust-lang/rust/issues/42868>\n+\n+error[E0107]: wrong number of type arguments: expected 0, found 1\n+  --> $DIR/issue-60622.rs:12:15\n+   |\n+LL |     b.a::<'_, T>();\n+   |               ^ unexpected type argument\n+\n+error: aborting due to 2 previous errors\n+\n+For more information about this error, try `rustc --explain E0107`."}]}