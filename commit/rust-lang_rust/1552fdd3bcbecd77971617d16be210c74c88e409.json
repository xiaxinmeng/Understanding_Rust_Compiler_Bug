{"sha": "1552fdd3bcbecd77971617d16be210c74c88e409", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE1NTJmZGQzYmNiZWNkNzc5NzE2MTdkMTZiZTIxMGM3NGM4OGU0MDk=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-05-13T17:37:52Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-05-13T17:37:52Z"}, "message": "Merge #8814\n\n8814: fix: Keep doc comments and outer attrs on \"Move module to file\" assist r=Veykril a=Jesse-Bakker\n\nFixes #8804\n\n\nCo-authored-by: Jesse Bakker <github@jessebakker.com>", "tree": {"sha": "72f7974fb3bcffc421ca0bf39b97908cc1855736", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/72f7974fb3bcffc421ca0bf39b97908cc1855736"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1552fdd3bcbecd77971617d16be210c74c88e409", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgnWPwCRBK7hj4Ov3rIwAAlsQIAHgM/zfYF2rC6Nl4UZRltO5u\nI4OL4FEvvzyr2lPt5i7ZFfy7cdfo2iRqGENVOYPDyOqd5mqN3xtVD/4ov32D/+kP\ncfyDW3NJyXDNskBQlF3B26xVpxV+T+sWCtom3PnUxoq6RgK/Vsu7fGTd3OaKRZz8\ne9IC1rY8Q4i3tZfHTd1x5Kb0yfWwuIRpy5VzD+W2EnjgYeEfFZjssIoPISS5AGCd\nr/cdxpbgyZHlogPygVVTWc1njOMn6K6MZ389fjxHkbDA6nq+1VJ5OX3lkyu0sN+w\nyUmD2VFBjI7DPXDg7q/2tIsoWvkTZgQg9PPtizYqWpH9Av7A8nlP+2kbfXiZFhg=\n=jfGc\n-----END PGP SIGNATURE-----\n", "payload": "tree 72f7974fb3bcffc421ca0bf39b97908cc1855736\nparent 908cd23f81d94bc53e318089fd8bd52e27906f19\nparent 8c95b205a27a27bed6434644e8016caa49aeffc1\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1620927472 +0000\ncommitter GitHub <noreply@github.com> 1620927472 +0000\n\nMerge #8814\n\n8814: fix: Keep doc comments and outer attrs on \"Move module to file\" assist r=Veykril a=Jesse-Bakker\n\nFixes #8804\n\n\nCo-authored-by: Jesse Bakker <github@jessebakker.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1552fdd3bcbecd77971617d16be210c74c88e409", "html_url": "https://github.com/rust-lang/rust/commit/1552fdd3bcbecd77971617d16be210c74c88e409", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1552fdd3bcbecd77971617d16be210c74c88e409/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "908cd23f81d94bc53e318089fd8bd52e27906f19", "url": "https://api.github.com/repos/rust-lang/rust/commits/908cd23f81d94bc53e318089fd8bd52e27906f19", "html_url": "https://github.com/rust-lang/rust/commit/908cd23f81d94bc53e318089fd8bd52e27906f19"}, {"sha": "8c95b205a27a27bed6434644e8016caa49aeffc1", "url": "https://api.github.com/repos/rust-lang/rust/commits/8c95b205a27a27bed6434644e8016caa49aeffc1", "html_url": "https://github.com/rust-lang/rust/commit/8c95b205a27a27bed6434644e8016caa49aeffc1"}], "stats": {"total": 38, "additions": 33, "deletions": 5}, "files": [{"sha": "93f702c556881af6d55197a2c519072194298765", "filename": "crates/ide_assists/src/handlers/move_module_to_file.rs", "status": "modified", "additions": 33, "deletions": 5, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/1552fdd3bcbecd77971617d16be210c74c88e409/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fmove_module_to_file.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1552fdd3bcbecd77971617d16be210c74c88e409/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fmove_module_to_file.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fmove_module_to_file.rs?ref=1552fdd3bcbecd77971617d16be210c74c88e409", "patch": "@@ -1,4 +1,4 @@\n-use ast::{edit::IndentLevel, VisibilityOwner};\n+use ast::edit::IndentLevel;\n use ide_db::base_db::AnchoredPathBuf;\n use stdx::format_to;\n use syntax::{\n@@ -60,12 +60,18 @@ pub(crate) fn move_module_to_file(acc: &mut Assists, ctx: &AssistContext) -> Opt\n             };\n \n             let mut buf = String::new();\n-            if let Some(v) = module_ast.visibility() {\n-                format_to!(buf, \"{} \", v);\n-            }\n             format_to!(buf, \"mod {};\", module_name);\n \n-            builder.replace(module_ast.syntax().text_range(), buf);\n+            let replacement_start = if let Some(mod_token) = module_ast.mod_token() {\n+                mod_token.text_range().start()\n+            } else {\n+                module_ast.syntax().text_range().start()\n+            };\n+\n+            builder.replace(\n+                TextRange::new(replacement_start, module_ast.syntax().text_range().end()),\n+                buf,\n+            );\n \n             let dst = AnchoredPathBuf { anchor: ctx.frange.file_id, path };\n             builder.create_file(dst, contents);\n@@ -184,4 +190,26 @@ pub(crate) mod tests;\n         cov_mark::check!(available_before_curly);\n         check_assist_not_applicable(move_module_to_file, r#\"mod m { $0 }\"#);\n     }\n+\n+    #[test]\n+    fn keep_outer_comments_and_attributes() {\n+        check_assist(\n+            move_module_to_file,\n+            r#\"\n+/// doc comment\n+#[attribute]\n+mod $0tests {\n+    #[test] fn t() {}\n+}\n+\"#,\n+            r#\"\n+//- /main.rs\n+/// doc comment\n+#[attribute]\n+mod tests;\n+//- /tests.rs\n+#[test] fn t() {}\n+\"#,\n+        );\n+    }\n }"}]}