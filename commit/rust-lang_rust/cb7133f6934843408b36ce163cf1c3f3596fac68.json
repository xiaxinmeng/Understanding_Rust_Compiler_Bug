{"sha": "cb7133f6934843408b36ce163cf1c3f3596fac68", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNiNzEzM2Y2OTM0ODQzNDA4YjM2Y2UxNjNjZjFjM2YzNTk2ZmFjNjg=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2021-04-02T17:57:35Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-04-02T17:57:35Z"}, "message": "Rollup merge of #83771 - asomers:stack_overflow_freebsd, r=dtolnay\n\nFix stack overflow detection on FreeBSD 11.1+\n\nBeginning with FreeBSD 10.4 and 11.1, there is one guard page by\ndefault.  And the stack autoresizes, so if Rust allocates its own guard\npage, then FreeBSD's will simply move up one page.  The best solution is\nto just use the OS's guard page.", "tree": {"sha": "081a410167ea3b52f6e2562e20e161691b9993f5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/081a410167ea3b52f6e2562e20e161691b9993f5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cb7133f6934843408b36ce163cf1c3f3596fac68", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgZ1sQCRBK7hj4Ov3rIwAAdHIIAHy5XM0WYXgnfnrs9cK4EGG/\nJoMfxHc8LBlFfgTAiKR8d29xQkV7fqWJB9XlbeLsyZBVBuvwIgUPU1D3w0EHqKkX\nKdYZraKjY1R91pn9+SEyCoFxvckwRplWZc7YtC/hjmrJl7UdSunp+x5mIuU/V9hx\nCS67sp+aXF1uiAhKDLl9biXTc0y5kglmWR7W4Jq1Y4SVNRLgjojVmeqYXgMbLF2n\n6RqauDEJ2TOnA0fVEmeFMXDyH4HPXP17J0/dgBNbmkFPcW6JXrVcB5x0TyH+rlyM\n61UgZ5ia7goG0Rs4jd0j8PJNYwNzC5EZ0EvlTIhUCds+gsMAVz4DOLhEbNjhQuU=\n=cv+A\n-----END PGP SIGNATURE-----\n", "payload": "tree 081a410167ea3b52f6e2562e20e161691b9993f5\nparent eed73c6e4d21e25cd553fe06a24e5200714bc0ab\nparent ca14abbab1821d20d4d326af2acec916ccc0806e\nauthor Dylan DPC <dylan.dpc@gmail.com> 1617386255 +0200\ncommitter GitHub <noreply@github.com> 1617386255 +0200\n\nRollup merge of #83771 - asomers:stack_overflow_freebsd, r=dtolnay\n\nFix stack overflow detection on FreeBSD 11.1+\n\nBeginning with FreeBSD 10.4 and 11.1, there is one guard page by\ndefault.  And the stack autoresizes, so if Rust allocates its own guard\npage, then FreeBSD's will simply move up one page.  The best solution is\nto just use the OS's guard page.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cb7133f6934843408b36ce163cf1c3f3596fac68", "html_url": "https://github.com/rust-lang/rust/commit/cb7133f6934843408b36ce163cf1c3f3596fac68", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cb7133f6934843408b36ce163cf1c3f3596fac68/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "eed73c6e4d21e25cd553fe06a24e5200714bc0ab", "url": "https://api.github.com/repos/rust-lang/rust/commits/eed73c6e4d21e25cd553fe06a24e5200714bc0ab", "html_url": "https://github.com/rust-lang/rust/commit/eed73c6e4d21e25cd553fe06a24e5200714bc0ab"}, {"sha": "ca14abbab1821d20d4d326af2acec916ccc0806e", "url": "https://api.github.com/repos/rust-lang/rust/commits/ca14abbab1821d20d4d326af2acec916ccc0806e", "html_url": "https://github.com/rust-lang/rust/commit/ca14abbab1821d20d4d326af2acec916ccc0806e"}], "stats": {"total": 23, "additions": 16, "deletions": 7}, "files": [{"sha": "b8f43caec32a3962e219cd6bbc0c7521a9bde4fc", "filename": "library/std/src/sys/unix/thread.rs", "status": "modified", "additions": 16, "deletions": 7, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/cb7133f6934843408b36ce163cf1c3f3596fac68/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fthread.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cb7133f6934843408b36ce163cf1c3f3596fac68/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fthread.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fthread.rs?ref=cb7133f6934843408b36ce163cf1c3f3596fac68", "patch": "@@ -343,6 +343,20 @@ pub mod guard {\n             // it can eventually grow to. It cannot be used to determine\n             // the position of kernel's stack guard.\n             None\n+        } else if cfg!(target_os = \"freebsd\") {\n+            // FreeBSD's stack autogrows, and optionally includes a guard page\n+            // at the bottom.  If we try to remap the bottom of the stack\n+            // ourselves, FreeBSD's guard page moves upwards.  So we'll just use\n+            // the builtin guard page.\n+            let stackaddr = get_stack_start_aligned()?;\n+            let guardaddr = stackaddr as usize;\n+            // Technically the number of guard pages is tunable and controlled\n+            // by the security.bsd.stack_guard_page sysctl, but there are\n+            // few reasons to change it from the default.  The default value has\n+            // been 1 ever since FreeBSD 11.1 and 10.4.\n+            const GUARD_PAGES: usize = 1;\n+            let guard = guardaddr..guardaddr + GUARD_PAGES * page_size;\n+            Some(guard)\n         } else {\n             // Reallocate the last page of the stack.\n             // This ensures SIGBUS will be raised on\n@@ -371,9 +385,8 @@ pub mod guard {\n             }\n \n             let guardaddr = stackaddr as usize;\n-            let offset = if cfg!(target_os = \"freebsd\") { 2 } else { 1 };\n \n-            Some(guardaddr..guardaddr + offset * page_size)\n+            Some(guardaddr..guardaddr + page_size)\n         }\n     }\n \n@@ -417,11 +430,7 @@ pub mod guard {\n             assert_eq!(libc::pthread_attr_getstack(&attr, &mut stackaddr, &mut size), 0);\n \n             let stackaddr = stackaddr as usize;\n-            ret = if cfg!(target_os = \"freebsd\") {\n-                // FIXME does freebsd really fault *below* the guard addr?\n-                let guardaddr = stackaddr - guardsize;\n-                Some(guardaddr - PAGE_SIZE.load(Ordering::Relaxed)..guardaddr)\n-            } else if cfg!(target_os = \"netbsd\") {\n+            ret = if cfg!(any(target_os = \"freebsd\", target_os = \"netbsd\")) {\n                 Some(stackaddr - guardsize..stackaddr)\n             } else if cfg!(all(target_os = \"linux\", target_env = \"musl\")) {\n                 Some(stackaddr - guardsize..stackaddr)"}]}