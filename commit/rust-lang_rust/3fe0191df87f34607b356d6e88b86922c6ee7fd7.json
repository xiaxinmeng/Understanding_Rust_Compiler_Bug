{"sha": "3fe0191df87f34607b356d6e88b86922c6ee7fd7", "node_id": "C_kwDOAAsO6NoAKDNmZTAxOTFkZjg3ZjM0NjA3YjM1NmQ2ZTg4Yjg2OTIyYzZlZTdmZDc", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2022-07-05T21:43:32Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-07-05T21:43:32Z"}, "message": "Rollup merge of #98880 - topjohnwu:macos-dylib-cross, r=jyn514\n\nProper macOS libLLVM symlink when cross compiling\n\nFollow up of #98418\n\nWhen cross compiling on macOS with `llvm.link-shared` enabled, the symlink creation will fail after compiling LLVM for the target architecture, because it will attempt to create the symlink in the host LLVM directory, which was already created when being built.\n\nThis commit changes the symlink path to the actual LLVM output.\n\nr? `@jyn514`", "tree": {"sha": "5f5359c5b0daaae2b1c033484fc803d711e136fb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5f5359c5b0daaae2b1c033484fc803d711e136fb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3fe0191df87f34607b356d6e88b86922c6ee7fd7", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJixLCECRBK7hj4Ov3rIwAAd40IAAsXfxJ6v/dsAQ6SZQ1hVB6X\nG1/VqRSwCcyTRnmB7aD4G5fWMJ6eAEXFgOiiDsqRT55ifcDx3GUgQ3l7Kx8Qan+0\nlHE627wNRkO+Ko7eaqwq/d9DizYuFL83nw5mAG5sAZVmjdesIudX82o51i5MUyGg\nalVnpchpm43/fT5xqsWq5wD0/oT3C1EMSuYSICrMnEFVsN5Sm2mo6x8fM2WHVzop\n0ZlVCTlzMJ4ksHB8agiM14qsrUINg+a3Nrv96DoTItGSUtI9JAlmd/4TcEzMEajW\nWJMUsaywaF4LNj7+MkQPFrPut0KYEgbJtOmq/Dtqq9CuZn3rI4QAYcR3ShyLn0c=\n=IMBH\n-----END PGP SIGNATURE-----\n", "payload": "tree 5f5359c5b0daaae2b1c033484fc803d711e136fb\nparent 4986379d7910d4f87beb2a4a0d17127cc074df0e\nparent 22b4ea4813a7aa5fc2ee454fca50853fdc47ba3e\nauthor Guillaume Gomez <guillaume1.gomez@gmail.com> 1657057412 +0200\ncommitter GitHub <noreply@github.com> 1657057412 +0200\n\nRollup merge of #98880 - topjohnwu:macos-dylib-cross, r=jyn514\n\nProper macOS libLLVM symlink when cross compiling\n\nFollow up of #98418\n\nWhen cross compiling on macOS with `llvm.link-shared` enabled, the symlink creation will fail after compiling LLVM for the target architecture, because it will attempt to create the symlink in the host LLVM directory, which was already created when being built.\n\nThis commit changes the symlink path to the actual LLVM output.\n\nr? `@jyn514`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3fe0191df87f34607b356d6e88b86922c6ee7fd7", "html_url": "https://github.com/rust-lang/rust/commit/3fe0191df87f34607b356d6e88b86922c6ee7fd7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3fe0191df87f34607b356d6e88b86922c6ee7fd7/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4986379d7910d4f87beb2a4a0d17127cc074df0e", "url": "https://api.github.com/repos/rust-lang/rust/commits/4986379d7910d4f87beb2a4a0d17127cc074df0e", "html_url": "https://github.com/rust-lang/rust/commit/4986379d7910d4f87beb2a4a0d17127cc074df0e"}, {"sha": "22b4ea4813a7aa5fc2ee454fca50853fdc47ba3e", "url": "https://api.github.com/repos/rust-lang/rust/commits/22b4ea4813a7aa5fc2ee454fca50853fdc47ba3e", "html_url": "https://github.com/rust-lang/rust/commit/22b4ea4813a7aa5fc2ee454fca50853fdc47ba3e"}], "stats": {"total": 14, "additions": 6, "deletions": 8}, "files": [{"sha": "503a2fc469e5d53fc35663fa4bb714fd66b4b4d4", "filename": "src/bootstrap/native.rs", "status": "modified", "additions": 6, "deletions": 8, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/3fe0191df87f34607b356d6e88b86922c6ee7fd7/src%2Fbootstrap%2Fnative.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3fe0191df87f34607b356d6e88b86922c6ee7fd7/src%2Fbootstrap%2Fnative.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fnative.rs?ref=3fe0191df87f34607b356d6e88b86922c6ee7fd7", "patch": "@@ -487,16 +487,14 @@ impl Step for Llvm {\n             let version = output(cmd.arg(\"--version\"));\n             let major = version.split('.').next().unwrap();\n             let lib_name = match llvm_version_suffix {\n-                Some(s) => format!(\"lib/libLLVM-{}{}.dylib\", major, s),\n-                None => format!(\"lib/libLLVM-{}.dylib\", major),\n+                Some(s) => format!(\"libLLVM-{}{}.dylib\", major, s),\n+                None => format!(\"libLLVM-{}.dylib\", major),\n             };\n \n-            // The reason why we build the library path from llvm-config is because\n-            // the output of llvm-config depends on its location in the file system.\n-            // Make sure we create the symlink exactly where it's needed.\n-            let llvm_base = build_llvm_config.parent().unwrap().parent().unwrap();\n-            let lib_llvm = llvm_base.join(lib_name);\n-            t!(builder.symlink_file(\"libLLVM.dylib\", &lib_llvm));\n+            let lib_llvm = out_dir.join(\"build\").join(\"lib\").join(lib_name);\n+            if !lib_llvm.exists() {\n+                t!(builder.symlink_file(\"libLLVM.dylib\", &lib_llvm));\n+            }\n         }\n \n         t!(stamp.write());"}]}