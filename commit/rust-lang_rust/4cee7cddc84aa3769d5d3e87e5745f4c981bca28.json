{"sha": "4cee7cddc84aa3769d5d3e87e5745f4c981bca28", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRjZWU3Y2RkYzg0YWEzNzY5ZDVkM2U4N2U1NzQ1ZjRjOTgxYmNhMjg=", "commit": {"author": {"name": "Veetaha", "email": "gerzoh1@gmail.com", "date": "2020-02-22T18:58:00Z"}, "committer": {"name": "Veetaha", "email": "gerzoh1@gmail.com", "date": "2020-02-23T13:49:09Z"}, "message": "vscode: gracefully handle cancellation errors", "tree": {"sha": "f8b98268925cf01e2cc74a9e12fac81a460c1eff", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f8b98268925cf01e2cc74a9e12fac81a460c1eff"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4cee7cddc84aa3769d5d3e87e5745f4c981bca28", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4cee7cddc84aa3769d5d3e87e5745f4c981bca28", "html_url": "https://github.com/rust-lang/rust/commit/4cee7cddc84aa3769d5d3e87e5745f4c981bca28", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4cee7cddc84aa3769d5d3e87e5745f4c981bca28/comments", "author": null, "committer": null, "parents": [{"sha": "838ad6bcfb2a82c030e18d019b8a06752f0fc828", "url": "https://api.github.com/repos/rust-lang/rust/commits/838ad6bcfb2a82c030e18d019b8a06752f0fc828", "html_url": "https://github.com/rust-lang/rust/commit/838ad6bcfb2a82c030e18d019b8a06752f0fc828"}], "stats": {"total": 104, "additions": 60, "deletions": 44}, "files": [{"sha": "43540e0d8ea3f4a7cd92e989e55b95c869f8001d", "filename": "editors/code/src/ctx.ts", "status": "modified", "additions": 0, "deletions": 21, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/4cee7cddc84aa3769d5d3e87e5745f4c981bca28/editors%2Fcode%2Fsrc%2Fctx.ts", "raw_url": "https://github.com/rust-lang/rust/raw/4cee7cddc84aa3769d5d3e87e5745f4c981bca28/editors%2Fcode%2Fsrc%2Fctx.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fctx.ts?ref=4cee7cddc84aa3769d5d3e87e5745f4c981bca28", "patch": "@@ -52,24 +52,3 @@ export interface Disposable {\n     dispose(): void;\n }\n export type Cmd = (...args: any[]) => unknown;\n-\n-export async function sendRequestWithRetry<R>(\n-    client: lc.LanguageClient,\n-    method: string,\n-    param: unknown,\n-    token?: vscode.CancellationToken,\n-): Promise<R> {\n-    for (const delay of [2, 4, 6, 8, 10, null]) {\n-        try {\n-            return await (token ? client.sendRequest(method, param, token) : client.sendRequest(method, param));\n-        } catch (err) {\n-            if (delay === null || err.code !== lc.ErrorCodes.ContentModified) {\n-                throw err;\n-            }\n-            await sleep(10 * (1 << delay));\n-        }\n-    }\n-    throw 'unreachable';\n-}\n-\n-const sleep = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));"}, {"sha": "77b4a1a68b86de1f2db99e707a2cdecb1ea7f2d9", "filename": "editors/code/src/highlighting.ts", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/4cee7cddc84aa3769d5d3e87e5745f4c981bca28/editors%2Fcode%2Fsrc%2Fhighlighting.ts", "raw_url": "https://github.com/rust-lang/rust/raw/4cee7cddc84aa3769d5d3e87e5745f4c981bca28/editors%2Fcode%2Fsrc%2Fhighlighting.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fhighlighting.ts?ref=4cee7cddc84aa3769d5d3e87e5745f4c981bca28", "patch": "@@ -3,7 +3,8 @@ import * as lc from 'vscode-languageclient';\n \n import { ColorTheme, TextMateRuleSettings } from './color_theme';\n \n-import { Ctx, sendRequestWithRetry } from './ctx';\n+import { Ctx } from './ctx';\n+import { sendRequestWithRetry } from './util';\n \n export function activateHighlighting(ctx: Ctx) {\n     const highlighter = new Highlighter(ctx);"}, {"sha": "5f9229efbced64fc4e2dcb932cc1e275625cb523", "filename": "editors/code/src/inlay_hints.ts", "status": "modified", "additions": 18, "deletions": 22, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/4cee7cddc84aa3769d5d3e87e5745f4c981bca28/editors%2Fcode%2Fsrc%2Finlay_hints.ts", "raw_url": "https://github.com/rust-lang/rust/raw/4cee7cddc84aa3769d5d3e87e5745f4c981bca28/editors%2Fcode%2Fsrc%2Finlay_hints.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Finlay_hints.ts?ref=4cee7cddc84aa3769d5d3e87e5745f4c981bca28", "patch": "@@ -1,8 +1,8 @@\n import * as vscode from 'vscode';\n import * as lc from 'vscode-languageclient';\n \n-import { Ctx, sendRequestWithRetry } from './ctx';\n-import { log } from './util';\n+import { Ctx } from './ctx';\n+import { log, sendRequestWithRetry } from './util';\n \n export function activateInlayHints(ctx: Ctx) {\n     const hintsUpdater = new HintsUpdater(ctx);\n@@ -152,28 +152,24 @@ class HintsUpdater {\n     }\n \n     private async queryHints(documentUri: string): Promise<InlayHint[] | null> {\n-        const client = this.ctx.client;\n-        if (!client) return null;\n+        this.pending.get(documentUri)?.cancel();\n \n-        const request: InlayHintsParams = {\n-            textDocument: { uri: documentUri },\n-        };\n         const tokenSource = new vscode.CancellationTokenSource();\n-        const prevHintsRequest = this.pending.get(documentUri);\n-        prevHintsRequest?.cancel();\n-\n         this.pending.set(documentUri, tokenSource);\n-        try {\n-            return await sendRequestWithRetry<InlayHint[] | null>(\n-                client,\n-                'rust-analyzer/inlayHints',\n-                request,\n-                tokenSource.token,\n-            );\n-        } finally {\n-            if (!tokenSource.token.isCancellationRequested) {\n-                this.pending.delete(documentUri);\n-            }\n-        }\n+\n+        const request: InlayHintsParams = { textDocument: { uri: documentUri } };\n+\n+        return sendRequestWithRetry<InlayHint[]>(\n+            this.ctx.client,\n+            'rust-analyzer/inlayHints',\n+            request,\n+            tokenSource.token\n+        )\n+            .catch(_ => null)\n+            .finally(() => {\n+                if (!tokenSource.token.isCancellationRequested) {\n+                    this.pending.delete(documentUri);\n+                }\n+            });\n     }\n }"}, {"sha": "2f18f85a39251414f926e2643380524f6ce78500", "filename": "editors/code/src/util.ts", "status": "modified", "additions": 40, "deletions": 0, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/4cee7cddc84aa3769d5d3e87e5745f4c981bca28/editors%2Fcode%2Fsrc%2Futil.ts", "raw_url": "https://github.com/rust-lang/rust/raw/4cee7cddc84aa3769d5d3e87e5745f4c981bca28/editors%2Fcode%2Fsrc%2Futil.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Futil.ts?ref=4cee7cddc84aa3769d5d3e87e5745f4c981bca28", "patch": "@@ -1,3 +1,6 @@\n+import * as lc from \"vscode-languageclient\";\n+import * as vscode from \"vscode\";\n+\n let enabled: boolean = false;\n \n export const log = {\n@@ -16,3 +19,40 @@ export const log = {\n         enabled = yes;\n     }\n };\n+\n+export async function sendRequestWithRetry<R>(\n+    client: lc.LanguageClient,\n+    method: string,\n+    param: unknown,\n+    token?: vscode.CancellationToken,\n+): Promise<R> {\n+    for (const delay of [2, 4, 6, 8, 10, null]) {\n+        try {\n+            return await (token\n+                ? client.sendRequest(method, param, token)\n+                : client.sendRequest(method, param)\n+            );\n+        } catch (error) {\n+            if (delay === null) {\n+                log.error(\"LSP request timed out\", { method, param, error });\n+                throw error;\n+            }\n+\n+            if (error.code === lc.ErrorCodes.RequestCancelled) {\n+                throw error;\n+            }\n+\n+            if (error.code !== lc.ErrorCodes.ContentModified) {\n+                log.error(\"LSP request failed\", { method, param, error });\n+                throw error;\n+            }\n+\n+            await sleep(10 * (1 << delay));\n+        }\n+    }\n+    throw 'unreachable';\n+}\n+\n+function sleep(ms: number) {\n+    return new Promise(resolve => setTimeout(resolve, ms));\n+}"}]}