{"sha": "522bc5f817696c113a03a462a5dbec794263dfcb", "node_id": "C_kwDOAAsO6NoAKDUyMmJjNWY4MTc2OTZjMTEzYTAzYTQ2MmE1ZGJlYzc5NDI2M2RmY2I", "commit": {"author": {"name": "Kyle Matsuda", "email": "kyle.yoshio.matsuda@gmail.com", "date": "2023-04-17T17:46:01Z"}, "committer": {"name": "Kyle Matsuda", "email": "kyle.yoshio.matsuda@gmail.com", "date": "2023-04-18T22:33:06Z"}, "message": "add EarlyBinder to return type of collect_return_position_impl_trait_in_trait_tys query; remove bound_X version", "tree": {"sha": "c08e2be0887fdeb85466cf0ed914cd6ebc8d5f84", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c08e2be0887fdeb85466cf0ed914cd6ebc8d5f84"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/522bc5f817696c113a03a462a5dbec794263dfcb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/522bc5f817696c113a03a462a5dbec794263dfcb", "html_url": "https://github.com/rust-lang/rust/commit/522bc5f817696c113a03a462a5dbec794263dfcb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/522bc5f817696c113a03a462a5dbec794263dfcb/comments", "author": {"login": "kylematsuda", "id": 17287790, "node_id": "MDQ6VXNlcjE3Mjg3Nzkw", "avatar_url": "https://avatars.githubusercontent.com/u/17287790?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kylematsuda", "html_url": "https://github.com/kylematsuda", "followers_url": "https://api.github.com/users/kylematsuda/followers", "following_url": "https://api.github.com/users/kylematsuda/following{/other_user}", "gists_url": "https://api.github.com/users/kylematsuda/gists{/gist_id}", "starred_url": "https://api.github.com/users/kylematsuda/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kylematsuda/subscriptions", "organizations_url": "https://api.github.com/users/kylematsuda/orgs", "repos_url": "https://api.github.com/users/kylematsuda/repos", "events_url": "https://api.github.com/users/kylematsuda/events{/privacy}", "received_events_url": "https://api.github.com/users/kylematsuda/received_events", "type": "User", "site_admin": false}, "committer": {"login": "kylematsuda", "id": 17287790, "node_id": "MDQ6VXNlcjE3Mjg3Nzkw", "avatar_url": "https://avatars.githubusercontent.com/u/17287790?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kylematsuda", "html_url": "https://github.com/kylematsuda", "followers_url": "https://api.github.com/users/kylematsuda/followers", "following_url": "https://api.github.com/users/kylematsuda/following{/other_user}", "gists_url": "https://api.github.com/users/kylematsuda/gists{/gist_id}", "starred_url": "https://api.github.com/users/kylematsuda/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kylematsuda/subscriptions", "organizations_url": "https://api.github.com/users/kylematsuda/orgs", "repos_url": "https://api.github.com/users/kylematsuda/repos", "events_url": "https://api.github.com/users/kylematsuda/events{/privacy}", "received_events_url": "https://api.github.com/users/kylematsuda/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "de96f3d8735b70d5dc1ca178aaee198b329b8f3d", "url": "https://api.github.com/repos/rust-lang/rust/commits/de96f3d8735b70d5dc1ca178aaee198b329b8f3d", "html_url": "https://github.com/rust-lang/rust/commit/de96f3d8735b70d5dc1ca178aaee198b329b8f3d"}], "stats": {"total": 38, "additions": 18, "deletions": 20}, "files": [{"sha": "fe87aae8ed1110810aa1a718825f2df102448498", "filename": "compiler/rustc_hir_analysis/src/check/compare_impl_item.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/522bc5f817696c113a03a462a5dbec794263dfcb/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fcompare_impl_item.rs", "raw_url": "https://github.com/rust-lang/rust/raw/522bc5f817696c113a03a462a5dbec794263dfcb/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fcompare_impl_item.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fcompare_impl_item.rs?ref=522bc5f817696c113a03a462a5dbec794263dfcb", "patch": "@@ -579,7 +579,7 @@ fn compare_asyncness<'tcx>(\n pub(super) fn collect_return_position_impl_trait_in_trait_tys<'tcx>(\n     tcx: TyCtxt<'tcx>,\n     impl_m_def_id: LocalDefId,\n-) -> Result<&'tcx FxHashMap<DefId, Ty<'tcx>>, ErrorGuaranteed> {\n+) -> Result<&'tcx FxHashMap<DefId, ty::EarlyBinder<Ty<'tcx>>>, ErrorGuaranteed> {\n     let impl_m = tcx.opt_associated_item(impl_m_def_id.to_def_id()).unwrap();\n     let trait_m = tcx.opt_associated_item(impl_m.trait_item_def_id.unwrap()).unwrap();\n     let impl_trait_ref =\n@@ -782,14 +782,14 @@ pub(super) fn collect_return_position_impl_trait_in_trait_tys<'tcx>(\n                     })\n                 });\n                 debug!(%ty);\n-                collected_tys.insert(def_id, ty);\n+                collected_tys.insert(def_id, ty::EarlyBinder(ty));\n             }\n             Err(err) => {\n                 let reported = tcx.sess.delay_span_bug(\n                     return_span,\n                     format!(\"could not fully resolve: {ty} => {err:?}\"),\n                 );\n-                collected_tys.insert(def_id, tcx.ty_error(reported));\n+                collected_tys.insert(def_id, ty::EarlyBinder(tcx.ty_error(reported)));\n             }\n         }\n     }"}, {"sha": "f82fad474224be20ee4bdccf7a025590596504e5", "filename": "compiler/rustc_hir_analysis/src/collect/type_of.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/522bc5f817696c113a03a462a5dbec794263dfcb/compiler%2Frustc_hir_analysis%2Fsrc%2Fcollect%2Ftype_of.rs", "raw_url": "https://github.com/rust-lang/rust/raw/522bc5f817696c113a03a462a5dbec794263dfcb/compiler%2Frustc_hir_analysis%2Fsrc%2Fcollect%2Ftype_of.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_analysis%2Fsrc%2Fcollect%2Ftype_of.rs?ref=522bc5f817696c113a03a462a5dbec794263dfcb", "patch": "@@ -251,7 +251,7 @@ pub(super) fn type_of(tcx: TyCtxt<'_>, def_id: LocalDefId) -> ty::EarlyBinder<Ty\n         match tcx.collect_return_position_impl_trait_in_trait_tys(fn_def_id) {\n             Ok(map) => {\n                 let assoc_item = tcx.associated_item(def_id);\n-                return ty::EarlyBinder(map[&assoc_item.trait_item_def_id.unwrap()]);\n+                return map[&assoc_item.trait_item_def_id.unwrap()];\n             }\n             Err(_) => {\n                 return ty::EarlyBinder(tcx.ty_error_with_message("}, {"sha": "a6a34765324fe0929d2f0e7f23137fafa0f46bf4", "filename": "compiler/rustc_metadata/src/rmeta/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/522bc5f817696c113a03a462a5dbec794263dfcb/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/522bc5f817696c113a03a462a5dbec794263dfcb/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fmod.rs?ref=522bc5f817696c113a03a462a5dbec794263dfcb", "patch": "@@ -416,7 +416,7 @@ define_tables! {\n     macro_definition: Table<DefIndex, LazyValue<ast::DelimArgs>>,\n     proc_macro: Table<DefIndex, MacroKind>,\n     deduced_param_attrs: Table<DefIndex, LazyArray<DeducedParamAttrs>>,\n-    trait_impl_trait_tys: Table<DefIndex, LazyValue<FxHashMap<DefId, Ty<'static>>>>,\n+    trait_impl_trait_tys: Table<DefIndex, LazyValue<FxHashMap<DefId, ty::EarlyBinder<Ty<'static>>>>>,\n     doc_link_resolutions: Table<DefIndex, LazyValue<DocLinkResMap>>,\n     doc_link_traits_in_scope: Table<DefIndex, LazyArray<DefId>>,\n }"}, {"sha": "60d7cf59d04702d675cca287076532adf4c278d7", "filename": "compiler/rustc_middle/src/arena.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/522bc5f817696c113a03a462a5dbec794263dfcb/compiler%2Frustc_middle%2Fsrc%2Farena.rs", "raw_url": "https://github.com/rust-lang/rust/raw/522bc5f817696c113a03a462a5dbec794263dfcb/compiler%2Frustc_middle%2Fsrc%2Farena.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Farena.rs?ref=522bc5f817696c113a03a462a5dbec794263dfcb", "patch": "@@ -114,7 +114,11 @@ macro_rules! arena_types {\n \n             [] dep_kind: rustc_middle::dep_graph::DepKindStruct<'tcx>,\n \n-            [decode] trait_impl_trait_tys: rustc_data_structures::fx::FxHashMap<rustc_hir::def_id::DefId, rustc_middle::ty::Ty<'tcx>>,\n+            [decode] trait_impl_trait_tys:\n+                rustc_data_structures::fx::FxHashMap<\n+                    rustc_hir::def_id::DefId,\n+                    rustc_middle::ty::EarlyBinder<rustc_middle::ty::Ty<'tcx>>\n+                >,\n             [] bit_set_u32: rustc_index::bit_set::BitSet<u32>,\n             [] external_constraints: rustc_middle::traits::solve::ExternalConstraintsData<'tcx>,\n             [decode] doc_link_resolutions: rustc_hir::def::DocLinkResMap,"}, {"sha": "7e26e05025ff15592c6e14d4dbc3d82e9a76fc7d", "filename": "compiler/rustc_middle/src/query/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/522bc5f817696c113a03a462a5dbec794263dfcb/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/522bc5f817696c113a03a462a5dbec794263dfcb/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs?ref=522bc5f817696c113a03a462a5dbec794263dfcb", "patch": "@@ -181,7 +181,7 @@ rustc_queries! {\n     }\n \n     query collect_return_position_impl_trait_in_trait_tys(key: DefId)\n-        -> Result<&'tcx FxHashMap<DefId, Ty<'tcx>>, ErrorGuaranteed>\n+        -> Result<&'tcx FxHashMap<DefId, ty::EarlyBinder<Ty<'tcx>>>, ErrorGuaranteed>\n     {\n         desc { \"comparing an impl and trait method signature, inferring any hidden `impl Trait` types in the process\" }\n         cache_on_disk_if { key.is_local() }"}, {"sha": "dab5baae5ee871f2b63e77f954f017352a5bb0e9", "filename": "compiler/rustc_middle/src/ty/util.rs", "status": "modified", "additions": 0, "deletions": 7, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/522bc5f817696c113a03a462a5dbec794263dfcb/compiler%2Frustc_middle%2Fsrc%2Fty%2Futil.rs", "raw_url": "https://github.com/rust-lang/rust/raw/522bc5f817696c113a03a462a5dbec794263dfcb/compiler%2Frustc_middle%2Fsrc%2Fty%2Futil.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Futil.rs?ref=522bc5f817696c113a03a462a5dbec794263dfcb", "patch": "@@ -694,13 +694,6 @@ impl<'tcx> TyCtxt<'tcx> {\n         if visitor.found_recursion { Err(expanded_type) } else { Ok(expanded_type) }\n     }\n \n-    pub fn bound_return_position_impl_trait_in_trait_tys(\n-        self,\n-        def_id: DefId,\n-    ) -> ty::EarlyBinder<Result<&'tcx FxHashMap<DefId, Ty<'tcx>>, ErrorGuaranteed>> {\n-        ty::EarlyBinder(self.collect_return_position_impl_trait_in_trait_tys(def_id))\n-    }\n-\n     pub fn bound_explicit_item_bounds(\n         self,\n         def_id: DefId,"}, {"sha": "4ff72fee0863ed935abf0f47a1dd869098989124", "filename": "compiler/rustc_query_impl/src/on_disk_cache.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/522bc5f817696c113a03a462a5dbec794263dfcb/compiler%2Frustc_query_impl%2Fsrc%2Fon_disk_cache.rs", "raw_url": "https://github.com/rust-lang/rust/raw/522bc5f817696c113a03a462a5dbec794263dfcb/compiler%2Frustc_query_impl%2Fsrc%2Fon_disk_cache.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_query_impl%2Fsrc%2Fon_disk_cache.rs?ref=522bc5f817696c113a03a462a5dbec794263dfcb", "patch": "@@ -806,7 +806,9 @@ impl<'a, 'tcx> Decodable<CacheDecoder<'a, 'tcx>> for &'tcx UnordSet<LocalDefId>\n     }\n }\n \n-impl<'a, 'tcx> Decodable<CacheDecoder<'a, 'tcx>> for &'tcx FxHashMap<DefId, Ty<'tcx>> {\n+impl<'a, 'tcx> Decodable<CacheDecoder<'a, 'tcx>>\n+    for &'tcx FxHashMap<DefId, ty::EarlyBinder<Ty<'tcx>>>\n+{\n     fn decode(d: &mut CacheDecoder<'a, 'tcx>) -> Self {\n         RefDecodable::decode(d)\n     }"}, {"sha": "5e042ffc6036744d89064a12f93b152ef7b70f1e", "filename": "compiler/rustc_trait_selection/src/traits/project.rs", "status": "modified", "additions": 4, "deletions": 5, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/522bc5f817696c113a03a462a5dbec794263dfcb/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fproject.rs", "raw_url": "https://github.com/rust-lang/rust/raw/522bc5f817696c113a03a462a5dbec794263dfcb/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fproject.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fproject.rs?ref=522bc5f817696c113a03a462a5dbec794263dfcb", "patch": "@@ -2277,11 +2277,10 @@ fn confirm_impl_trait_in_trait_candidate<'tcx>(\n         obligation.param_env,\n         cause.clone(),\n         obligation.recursion_depth + 1,\n-        tcx.bound_return_position_impl_trait_in_trait_tys(impl_fn_def_id)\n-            .map_bound(|tys| {\n-                tys.map_or_else(|guar| tcx.ty_error(guar), |tys| tys[&obligation.predicate.def_id])\n-            })\n-            .subst(tcx, impl_fn_substs),\n+        tcx.collect_return_position_impl_trait_in_trait_tys(impl_fn_def_id).map_or_else(\n+            |guar| tcx.ty_error(guar),\n+            |tys| tys[&obligation.predicate.def_id].subst(tcx, impl_fn_substs),\n+        ),\n         &mut obligations,\n     );\n "}]}