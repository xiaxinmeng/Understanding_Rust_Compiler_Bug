{"sha": "dca88612b96db761f86ab66d85836baf0e804910", "node_id": "C_kwDOAAsO6NoAKGRjYTg4NjEyYjk2ZGI3NjFmODZhYjY2ZDg1ODM2YmFmMGU4MDQ5MTA", "commit": {"author": {"name": "David Wood", "email": "david.wood@huawei.com", "date": "2022-04-27T04:59:48Z"}, "committer": {"name": "David Wood", "email": "david.wood@huawei.com", "date": "2022-04-29T01:12:10Z"}, "message": "macros: add interop between diagnostic derives\n\nAdd `#[subdiagnostic]` field attribute to the diagnostic derive which\nis applied to fields that have types which use the subdiagnostic derive.\n\nSigned-off-by: David Wood <david.wood@huawei.com>", "tree": {"sha": "f101647c89de3247357a3d5a6db8f63f63528fcd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f101647c89de3247357a3d5a6db8f63f63528fcd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/dca88612b96db761f86ab66d85836baf0e804910", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/dca88612b96db761f86ab66d85836baf0e804910", "html_url": "https://github.com/rust-lang/rust/commit/dca88612b96db761f86ab66d85836baf0e804910", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/dca88612b96db761f86ab66d85836baf0e804910/comments", "author": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "committer": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e5d9371b302ff0d368ea6e075769eb4b2709b2ba", "url": "https://api.github.com/repos/rust-lang/rust/commits/e5d9371b302ff0d368ea6e075769eb4b2709b2ba", "html_url": "https://github.com/rust-lang/rust/commit/e5d9371b302ff0d368ea6e075769eb4b2709b2ba"}], "stats": {"total": 19, "additions": 16, "deletions": 3}, "files": [{"sha": "f49166433faad545b45e4b7cdeb3f7850a371ed4", "filename": "compiler/rustc_macros/src/diagnostics/diagnostic.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/dca88612b96db761f86ab66d85836baf0e804910/compiler%2Frustc_macros%2Fsrc%2Fdiagnostics%2Fdiagnostic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dca88612b96db761f86ab66d85836baf0e804910/compiler%2Frustc_macros%2Fsrc%2Fdiagnostics%2Fdiagnostic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_macros%2Fsrc%2Fdiagnostics%2Fdiagnostic.rs?ref=dca88612b96db761f86ab66d85836baf0e804910", "patch": "@@ -404,9 +404,10 @@ impl SessionDiagnosticDeriveBuilder {\n                     report_error_if_not_applied_to_span(attr, &info)?;\n                     Ok(self.add_subdiagnostic(field_binding, name, name))\n                 }\n+                \"subdiagnostic\" => Ok(quote! { #diag.subdiagnostic(*#field_binding); }),\n                 _ => throw_invalid_attr!(attr, &meta, |diag| {\n                     diag\n-                        .help(\"only `skip_arg`, `primary_span`, `label`, `note` and `help` are valid field attributes\")\n+                        .help(\"only `skip_arg`, `primary_span`, `label`, `note`, `help` and `subdiagnostic` are valid field attributes\")\n                 }),\n             },\n             Meta::NameValue(MetaNameValue { lit: syn::Lit::Str(ref s), .. }) => match name {"}, {"sha": "b01e01414e878cd725b893f40178278bfe195187", "filename": "compiler/rustc_macros/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/dca88612b96db761f86ab66d85836baf0e804910/compiler%2Frustc_macros%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dca88612b96db761f86ab66d85836baf0e804910/compiler%2Frustc_macros%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_macros%2Fsrc%2Flib.rs?ref=dca88612b96db761f86ab66d85836baf0e804910", "patch": "@@ -73,6 +73,7 @@ decl_derive!(\n         skip_arg,\n         primary_span,\n         label,\n+        subdiagnostic,\n         suggestion,\n         suggestion_short,\n         suggestion_hidden,"}, {"sha": "efbf78ac87d73a34e571742254a07b6ac10d458d", "filename": "src/test/ui-fulldeps/session-diagnostic/diagnostic-derive.rs", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/dca88612b96db761f86ab66d85836baf0e804910/src%2Ftest%2Fui-fulldeps%2Fsession-diagnostic%2Fdiagnostic-derive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dca88612b96db761f86ab66d85836baf0e804910/src%2Ftest%2Fui-fulldeps%2Fsession-diagnostic%2Fdiagnostic-derive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui-fulldeps%2Fsession-diagnostic%2Fdiagnostic-derive.rs?ref=dca88612b96db761f86ab66d85836baf0e804910", "patch": "@@ -15,7 +15,7 @@ use rustc_span::symbol::Ident;\n use rustc_span::Span;\n \n extern crate rustc_macros;\n-use rustc_macros::SessionDiagnostic;\n+use rustc_macros::{SessionDiagnostic, SessionSubdiagnostic};\n \n extern crate rustc_middle;\n use rustc_middle::ty::Ty;\n@@ -463,3 +463,14 @@ struct NoApplicability {\n     #[suggestion(message = \"bar\", code = \"...\")]\n     suggestion: Span,\n }\n+\n+#[derive(SessionSubdiagnostic)]\n+#[note(slug = \"note\")]\n+struct Note;\n+\n+#[derive(SessionDiagnostic)]\n+#[error(slug = \"subdiagnostic\")]\n+struct Subdiagnostic {\n+    #[subdiagnostic]\n+    note: Note,\n+}"}, {"sha": "b1738b60bc0d39ca9718b5e0406f1af879958aba", "filename": "src/test/ui-fulldeps/session-diagnostic/diagnostic-derive.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/dca88612b96db761f86ab66d85836baf0e804910/src%2Ftest%2Fui-fulldeps%2Fsession-diagnostic%2Fdiagnostic-derive.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/dca88612b96db761f86ab66d85836baf0e804910/src%2Ftest%2Fui-fulldeps%2Fsession-diagnostic%2Fdiagnostic-derive.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui-fulldeps%2Fsession-diagnostic%2Fdiagnostic-derive.stderr?ref=dca88612b96db761f86ab66d85836baf0e804910", "patch": "@@ -211,7 +211,7 @@ error: `#[nonsense]` is not a valid attribute\n LL |     #[nonsense]\n    |     ^^^^^^^^^^^\n    |\n-   = help: only `skip_arg`, `primary_span`, `label`, `note` and `help` are valid field attributes\n+   = help: only `skip_arg`, `primary_span`, `label`, `note`, `help` and `subdiagnostic` are valid field attributes\n \n error: the `#[label = ...]` attribute can only be applied to fields of type `Span`\n   --> $DIR/diagnostic-derive.rs:156:5"}]}