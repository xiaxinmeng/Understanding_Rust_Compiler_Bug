{"sha": "118a2113c148ce6806732094c70fb030139b26ac", "node_id": "MDY6Q29tbWl0NzI0NzEyOjExOGEyMTEzYzE0OGNlNjgwNjczMjA5NGM3MGZiMDMwMTM5YjI2YWM=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-05-29T11:35:02Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-05-29T11:37:04Z"}, "message": "trigger garbage collection *after* requests, not before", "tree": {"sha": "067e1576e3794633ceb8045edc5188a0a015f97f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/067e1576e3794633ceb8045edc5188a0a015f97f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/118a2113c148ce6806732094c70fb030139b26ac", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/118a2113c148ce6806732094c70fb030139b26ac", "html_url": "https://github.com/rust-lang/rust/commit/118a2113c148ce6806732094c70fb030139b26ac", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/118a2113c148ce6806732094c70fb030139b26ac/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6a1e3e59cb06b8372be00f9f4277e20d06c9050a", "url": "https://api.github.com/repos/rust-lang/rust/commits/6a1e3e59cb06b8372be00f9f4277e20d06c9050a", "html_url": "https://github.com/rust-lang/rust/commit/6a1e3e59cb06b8372be00f9f4277e20d06c9050a"}], "stats": {"total": 7, "additions": 5, "deletions": 2}, "files": [{"sha": "d406faf6cc58b80b54332b1b1d59da981b0a9b53", "filename": "crates/ra_lsp_server/src/main_loop.rs", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/118a2113c148ce6806732094c70fb030139b26ac/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/118a2113c148ce6806732094c70fb030139b26ac/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop.rs?ref=118a2113c148ce6806732094c70fb030139b26ac", "patch": "@@ -171,7 +171,6 @@ fn main_loop_inner(\n     let (libdata_sender, libdata_receiver) = unbounded();\n     loop {\n         let _p = profile(\"loop_turn\");\n-        state.maybe_collect_garbage();\n \n         log::trace!(\"selecting\");\n         let event = select! {\n@@ -193,13 +192,17 @@ fn main_loop_inner(\n         }\n         let mut state_changed = false;\n         match event {\n-            Event::Task(task) => on_task(task, msg_sender, pending_requests),\n+            Event::Task(task) => {\n+                on_task(task, msg_sender, pending_requests);\n+                state.maybe_collect_garbage();\n+            }\n             Event::Vfs(task) => {\n                 state.vfs.write().handle_task(task);\n                 state_changed = true;\n             }\n             Event::Lib(lib) => {\n                 state.add_lib(lib);\n+                state.maybe_collect_garbage();\n                 in_flight_libraries -= 1;\n             }\n             Event::Msg(msg) => match msg {"}]}