{"sha": "278ab1905ce5352db4ccee6e02b85fafc39beeea", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI3OGFiMTkwNWNlNTM1MmRiNGNjZWU2ZTAyYjg1ZmFmYzM5YmVlZWE=", "commit": {"author": {"name": "flip1995", "email": "hello@philkrones.com", "date": "2019-04-05T21:04:56Z"}, "committer": {"name": "flip1995", "email": "hello@philkrones.com", "date": "2019-04-05T21:04:56Z"}, "message": "Move match_path from DefId to lint::LateContext", "tree": {"sha": "da51b68c42f0733455af75cd341c30477843b082", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/da51b68c42f0733455af75cd341c30477843b082"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/278ab1905ce5352db4ccee6e02b85fafc39beeea", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEZxoS6lESXlRGMHWcaTCGhp1QZjcFAlynwvgACgkQaTCGhp1Q\nZjcPfQ//dZ7Ma1+0336dYRxVnPInHKm/rj0c3veEstTuwtfvtnQU+sygrleuawB4\nAmI+0JDzcIRl0dnyrEsYEO7gM8t8YIEFeazs/tepLj19qhPVBA/a7eqnWc+JM5OD\nBpif0w4AVswDgoWMNXaAA0CqZnGWW4yIYJ2yZjfZZ/V7UyiTV+f3hd2yAq0JKUxn\n9YKqiM2n6SCqqtq9dGWVNOynXb5xbzAJ4A/T4J8SiWt61Et27ILM+z7Sf/GMRxe0\ndQLac96DyesXgLsJTHD7QSYqE6cZB4LvmpewqURKt3S38oKLHV/AYATHYZIq4OIa\npO1pKZNXMvxHbFBGWy07/DRZltzMmnB0dQkamTOVnwqI6p3W8wKOGVz+QnaCuyUD\nw+AVDeEdhq8TUMqepKgbWS9WEljONgMRup4zujIwCI8h9LW0XDYIL3RmS29N7u7l\nk2SAhrU0uBbPj9o7Ik5jpKaLMT5a0MY4vTEW5YzHBsBIYjD8w2ry20NxkmP5br3P\nlrO+hLIYd0LJrBmHSn51ha0eKwi83mJsmHwpvfJirZ3/H2FFp2vJ34EECu15dD4r\n4JPIajcyde9Fv5kBR09uUhrBuKRygN+JsBSBuQI8S3S2dfkrvZ6xRK5azW8QageQ\nmbvOkCGuU6u1m4JyAQF9bH6tgb5WxhfMoaQT6/jumUU7uFwqBoc=\n=H6tJ\n-----END PGP SIGNATURE-----", "payload": "tree da51b68c42f0733455af75cd341c30477843b082\nparent acd8dd6a50d505057a7d7ad8d0d7a4c2bd274200\nauthor flip1995 <hello@philkrones.com> 1554498296 +0200\ncommitter flip1995 <hello@philkrones.com> 1554498296 +0200\n\nMove match_path from DefId to lint::LateContext\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/278ab1905ce5352db4ccee6e02b85fafc39beeea", "html_url": "https://github.com/rust-lang/rust/commit/278ab1905ce5352db4ccee6e02b85fafc39beeea", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/278ab1905ce5352db4ccee6e02b85fafc39beeea/comments", "author": {"login": "flip1995", "id": 9744647, "node_id": "MDQ6VXNlcjk3NDQ2NDc=", "avatar_url": "https://avatars.githubusercontent.com/u/9744647?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flip1995", "html_url": "https://github.com/flip1995", "followers_url": "https://api.github.com/users/flip1995/followers", "following_url": "https://api.github.com/users/flip1995/following{/other_user}", "gists_url": "https://api.github.com/users/flip1995/gists{/gist_id}", "starred_url": "https://api.github.com/users/flip1995/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flip1995/subscriptions", "organizations_url": "https://api.github.com/users/flip1995/orgs", "repos_url": "https://api.github.com/users/flip1995/repos", "events_url": "https://api.github.com/users/flip1995/events{/privacy}", "received_events_url": "https://api.github.com/users/flip1995/received_events", "type": "User", "site_admin": false}, "committer": {"login": "flip1995", "id": 9744647, "node_id": "MDQ6VXNlcjk3NDQ2NDc=", "avatar_url": "https://avatars.githubusercontent.com/u/9744647?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flip1995", "html_url": "https://github.com/flip1995", "followers_url": "https://api.github.com/users/flip1995/followers", "following_url": "https://api.github.com/users/flip1995/following{/other_user}", "gists_url": "https://api.github.com/users/flip1995/gists{/gist_id}", "starred_url": "https://api.github.com/users/flip1995/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flip1995/subscriptions", "organizations_url": "https://api.github.com/users/flip1995/orgs", "repos_url": "https://api.github.com/users/flip1995/repos", "events_url": "https://api.github.com/users/flip1995/events{/privacy}", "received_events_url": "https://api.github.com/users/flip1995/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "acd8dd6a50d505057a7d7ad8d0d7a4c2bd274200", "url": "https://api.github.com/repos/rust-lang/rust/commits/acd8dd6a50d505057a7d7ad8d0d7a4c2bd274200", "html_url": "https://github.com/rust-lang/rust/commit/acd8dd6a50d505057a7d7ad8d0d7a4c2bd274200"}], "stats": {"total": 221, "additions": 114, "deletions": 107}, "files": [{"sha": "8536f38e48c6d5e0b3483ff9aa65aee8a98b3518", "filename": "src/librustc/hir/def_id.rs", "status": "modified", "additions": 2, "deletions": 104, "changes": 106, "blob_url": "https://github.com/rust-lang/rust/blob/278ab1905ce5352db4ccee6e02b85fafc39beeea/src%2Flibrustc%2Fhir%2Fdef_id.rs", "raw_url": "https://github.com/rust-lang/rust/raw/278ab1905ce5352db4ccee6e02b85fafc39beeea/src%2Flibrustc%2Fhir%2Fdef_id.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fhir%2Fdef_id.rs?ref=278ab1905ce5352db4ccee6e02b85fafc39beeea", "patch": "@@ -1,10 +1,9 @@\n-use crate::ty::{self, print::Printer, subst::Kind, Ty, TyCtxt};\n-use crate::hir::map::definitions::{DisambiguatedDefPathData, FIRST_FREE_HIGH_DEF_INDEX};\n+use crate::ty::{self, TyCtxt};\n+use crate::hir::map::definitions::FIRST_FREE_HIGH_DEF_INDEX;\n use rustc_data_structures::indexed_vec::Idx;\n use serialize;\n use std::fmt;\n use std::u32;\n-use syntax::symbol::{LocalInternedString, Symbol};\n \n newtype_index! {\n     pub struct CrateId {\n@@ -252,107 +251,6 @@ impl DefId {\n             format!(\"module `{}`\", tcx.def_path_str(*self))\n         }\n     }\n-\n-    /// Check if a `DefId`'s path matches the given absolute type path usage.\n-    // Uplifted from rust-lang/rust-clippy\n-    pub fn match_path<'a, 'tcx>(self, tcx: TyCtxt<'a, 'tcx, 'tcx>, path: &[&str]) -> bool {\n-        pub struct AbsolutePathPrinter<'a, 'tcx> {\n-            pub tcx: TyCtxt<'a, 'tcx, 'tcx>,\n-        }\n-\n-        impl<'tcx> Printer<'tcx, 'tcx> for AbsolutePathPrinter<'_, 'tcx> {\n-            type Error = !;\n-\n-            type Path = Vec<LocalInternedString>;\n-            type Region = ();\n-            type Type = ();\n-            type DynExistential = ();\n-\n-            fn tcx<'a>(&'a self) -> TyCtxt<'a, 'tcx, 'tcx> {\n-                self.tcx\n-            }\n-\n-            fn print_region(self, _region: ty::Region<'_>) -> Result<Self::Region, Self::Error> {\n-                Ok(())\n-            }\n-\n-            fn print_type(self, _ty: Ty<'tcx>) -> Result<Self::Type, Self::Error> {\n-                Ok(())\n-            }\n-\n-            fn print_dyn_existential(\n-                self,\n-                _predicates: &'tcx ty::List<ty::ExistentialPredicate<'tcx>>,\n-                ) -> Result<Self::DynExistential, Self::Error> {\n-                Ok(())\n-            }\n-\n-            fn path_crate(self, cnum: CrateNum) -> Result<Self::Path, Self::Error> {\n-                Ok(vec![self.tcx.original_crate_name(cnum).as_str()])\n-            }\n-\n-            fn path_qualified(\n-                self,\n-                self_ty: Ty<'tcx>,\n-                trait_ref: Option<ty::TraitRef<'tcx>>,\n-                ) -> Result<Self::Path, Self::Error> {\n-                if trait_ref.is_none() {\n-                    if let ty::Adt(def, substs) = self_ty.sty {\n-                        return self.print_def_path(def.did, substs);\n-                    }\n-                }\n-\n-                // This shouldn't ever be needed, but just in case:\n-                Ok(vec![match trait_ref {\n-                    Some(trait_ref) => Symbol::intern(&format!(\"{:?}\", trait_ref)).as_str(),\n-                    None => Symbol::intern(&format!(\"<{}>\", self_ty)).as_str(),\n-                }])\n-            }\n-\n-            fn path_append_impl(\n-                self,\n-                print_prefix: impl FnOnce(Self) -> Result<Self::Path, Self::Error>,\n-                _disambiguated_data: &DisambiguatedDefPathData,\n-                self_ty: Ty<'tcx>,\n-                trait_ref: Option<ty::TraitRef<'tcx>>,\n-                ) -> Result<Self::Path, Self::Error> {\n-                let mut path = print_prefix(self)?;\n-\n-                // This shouldn't ever be needed, but just in case:\n-                path.push(match trait_ref {\n-                    Some(trait_ref) => {\n-                        Symbol::intern(&format!(\"<impl {} for {}>\", trait_ref, self_ty)).as_str()\n-                    },\n-                    None => Symbol::intern(&format!(\"<impl {}>\", self_ty)).as_str(),\n-                });\n-\n-                Ok(path)\n-            }\n-\n-            fn path_append(\n-                self,\n-                print_prefix: impl FnOnce(Self) -> Result<Self::Path, Self::Error>,\n-                disambiguated_data: &DisambiguatedDefPathData,\n-                ) -> Result<Self::Path, Self::Error> {\n-                let mut path = print_prefix(self)?;\n-                path.push(disambiguated_data.data.as_interned_str().as_str());\n-                Ok(path)\n-            }\n-\n-            fn path_generic_args(\n-                self,\n-                print_prefix: impl FnOnce(Self) -> Result<Self::Path, Self::Error>,\n-                _args: &[Kind<'tcx>],\n-                ) -> Result<Self::Path, Self::Error> {\n-                print_prefix(self)\n-            }\n-        }\n-\n-        let names = AbsolutePathPrinter { tcx }.print_def_path(self, &[]).unwrap();\n-\n-        names.len() == path.len()\n-            && names.into_iter().zip(path.iter()).all(|(a, &b)| *a == *b)\n-    }\n }\n \n impl serialize::UseSpecializedEncodable for DefId {}"}, {"sha": "15ea6403e38bab7f7b85c4848a4f69e629fc5966", "filename": "src/librustc/lint/context.rs", "status": "modified", "additions": 111, "deletions": 2, "changes": 113, "blob_url": "https://github.com/rust-lang/rust/blob/278ab1905ce5352db4ccee6e02b85fafc39beeea/src%2Flibrustc%2Flint%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/278ab1905ce5352db4ccee6e02b85fafc39beeea/src%2Flibrustc%2Flint%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Flint%2Fcontext.rs?ref=278ab1905ce5352db4ccee6e02b85fafc39beeea", "patch": "@@ -25,7 +25,7 @@ use crate::lint::levels::{LintLevelSets, LintLevelsBuilder};\n use crate::middle::privacy::AccessLevels;\n use crate::rustc_serialize::{Decoder, Decodable, Encoder, Encodable};\n use crate::session::{config, early_error, Session};\n-use crate::ty::{self, TyCtxt, Ty};\n+use crate::ty::{self, print::Printer, subst::Kind, TyCtxt, Ty};\n use crate::ty::layout::{LayoutError, LayoutOf, TyLayout};\n use crate::util::nodemap::FxHashMap;\n use crate::util::common::time;\n@@ -36,9 +36,10 @@ use syntax::edition;\n use syntax_pos::{MultiSpan, Span, symbol::{LocalInternedString, Symbol}};\n use errors::DiagnosticBuilder;\n use crate::hir;\n-use crate::hir::def_id::{DefId, LOCAL_CRATE};\n+use crate::hir::def_id::{CrateNum, DefId, LOCAL_CRATE};\n use crate::hir::intravisit as hir_visit;\n use crate::hir::intravisit::Visitor;\n+use crate::hir::map::{definitions::DisambiguatedDefPathData, DefPathData};\n use syntax::util::lev_distance::find_best_match_for_name;\n use syntax::visit as ast_visit;\n \n@@ -752,6 +753,114 @@ impl<'a, 'tcx> LateContext<'a, 'tcx> {\n     pub fn current_lint_root(&self) -> hir::HirId {\n         self.last_node_with_lint_attrs\n     }\n+\n+    /// Check if a `DefId`'s path matches the given absolute type path usage.\n+    // Uplifted from rust-lang/rust-clippy\n+    pub fn match_path(&self, def_id: DefId, path: &[&str]) -> bool {\n+        pub struct AbsolutePathPrinter<'a, 'tcx> {\n+            pub tcx: TyCtxt<'a, 'tcx, 'tcx>,\n+        }\n+\n+        impl<'tcx> Printer<'tcx, 'tcx> for AbsolutePathPrinter<'_, 'tcx> {\n+            type Error = !;\n+\n+            type Path = Vec<LocalInternedString>;\n+            type Region = ();\n+            type Type = ();\n+            type DynExistential = ();\n+\n+            fn tcx<'a>(&'a self) -> TyCtxt<'a, 'tcx, 'tcx> {\n+                self.tcx\n+            }\n+\n+            fn print_region(self, _region: ty::Region<'_>) -> Result<Self::Region, Self::Error> {\n+                Ok(())\n+            }\n+\n+            fn print_type(self, _ty: Ty<'tcx>) -> Result<Self::Type, Self::Error> {\n+                Ok(())\n+            }\n+\n+            fn print_dyn_existential(\n+                self,\n+                _predicates: &'tcx ty::List<ty::ExistentialPredicate<'tcx>>,\n+                ) -> Result<Self::DynExistential, Self::Error> {\n+                Ok(())\n+            }\n+\n+            fn path_crate(self, cnum: CrateNum) -> Result<Self::Path, Self::Error> {\n+                Ok(vec![self.tcx.original_crate_name(cnum).as_str()])\n+            }\n+\n+            fn path_qualified(\n+                self,\n+                self_ty: Ty<'tcx>,\n+                trait_ref: Option<ty::TraitRef<'tcx>>,\n+                ) -> Result<Self::Path, Self::Error> {\n+                if trait_ref.is_none() {\n+                    if let ty::Adt(def, substs) = self_ty.sty {\n+                        return self.print_def_path(def.did, substs);\n+                    }\n+                }\n+\n+                // This shouldn't ever be needed, but just in case:\n+                Ok(vec![match trait_ref {\n+                    Some(trait_ref) => Symbol::intern(&format!(\"{:?}\", trait_ref)).as_str(),\n+                    None => Symbol::intern(&format!(\"<{}>\", self_ty)).as_str(),\n+                }])\n+            }\n+\n+            fn path_append_impl(\n+                self,\n+                print_prefix: impl FnOnce(Self) -> Result<Self::Path, Self::Error>,\n+                _disambiguated_data: &DisambiguatedDefPathData,\n+                self_ty: Ty<'tcx>,\n+                trait_ref: Option<ty::TraitRef<'tcx>>,\n+                ) -> Result<Self::Path, Self::Error> {\n+                let mut path = print_prefix(self)?;\n+\n+                // This shouldn't ever be needed, but just in case:\n+                path.push(match trait_ref {\n+                    Some(trait_ref) => {\n+                        Symbol::intern(&format!(\"<impl {} for {}>\", trait_ref, self_ty)).as_str()\n+                    },\n+                    None => Symbol::intern(&format!(\"<impl {}>\", self_ty)).as_str(),\n+                });\n+\n+                Ok(path)\n+            }\n+\n+            fn path_append(\n+                self,\n+                print_prefix: impl FnOnce(Self) -> Result<Self::Path, Self::Error>,\n+                disambiguated_data: &DisambiguatedDefPathData,\n+                ) -> Result<Self::Path, Self::Error> {\n+                let mut path = print_prefix(self)?;\n+\n+                // Skip `::{{constructor}}` on tuple/unit structs.\n+                match disambiguated_data.data {\n+                    DefPathData::Ctor => return Ok(path),\n+                    _ => {}\n+                }\n+\n+                path.push(disambiguated_data.data.as_interned_str().as_str());\n+                Ok(path)\n+            }\n+\n+            fn path_generic_args(\n+                self,\n+                print_prefix: impl FnOnce(Self) -> Result<Self::Path, Self::Error>,\n+                _args: &[Kind<'tcx>],\n+                ) -> Result<Self::Path, Self::Error> {\n+                print_prefix(self)\n+            }\n+        }\n+\n+        let names = AbsolutePathPrinter { tcx: self.tcx }.print_def_path(def_id, &[]).unwrap();\n+\n+        names.len() == path.len()\n+            && names.into_iter().zip(path.iter()).all(|(a, &b)| *a == *b)\n+    }\n }\n \n impl<'a, 'tcx> LayoutOf for LateContext<'a, 'tcx> {"}, {"sha": "0bafa93011ec4d1be96dc8d9250d38cebd7b0d0a", "filename": "src/librustc/lint/internal.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/278ab1905ce5352db4ccee6e02b85fafc39beeea/src%2Flibrustc%2Flint%2Finternal.rs", "raw_url": "https://github.com/rust-lang/rust/raw/278ab1905ce5352db4ccee6e02b85fafc39beeea/src%2Flibrustc%2Flint%2Finternal.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Flint%2Finternal.rs?ref=278ab1905ce5352db4ccee6e02b85fafc39beeea", "patch": "@@ -100,7 +100,7 @@ fn lint_ty_kind_usage(cx: &LateContext<'_, '_>, segment: &PathSegment) -> bool {\n     if segment.ident.as_str() == \"TyKind\" {\n         if let Some(def) = segment.def {\n             if let Some(did) = def.opt_def_id() {\n-                return did.match_path(cx.tcx, &[\"rustc\", \"ty\", \"sty\", \"TyKind\"]);\n+                return cx.match_path(did, &[\"rustc\", \"ty\", \"sty\", \"TyKind\"]);\n             }\n         }\n     }"}]}