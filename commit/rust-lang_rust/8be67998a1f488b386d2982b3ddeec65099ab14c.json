{"sha": "8be67998a1f488b386d2982b3ddeec65099ab14c", "node_id": "MDY6Q29tbWl0NzI0NzEyOjhiZTY3OTk4YTFmNDg4YjM4NmQyOTgyYjNkZGVlYzY1MDk5YWIxNGM=", "commit": {"author": {"name": "Scott McMurray", "email": "scottmcm@users.noreply.github.com", "date": "2021-05-23T06:47:12Z"}, "committer": {"name": "Scott McMurray", "email": "scottmcm@users.noreply.github.com", "date": "2021-05-23T14:18:02Z"}, "message": "Extend rustc_on_implemented to improve a ?-on-ControlFlow error message", "tree": {"sha": "5d57b987da96a4809f9a3bfa9c3ca11b22030806", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5d57b987da96a4809f9a3bfa9c3ca11b22030806"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8be67998a1f488b386d2982b3ddeec65099ab14c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8be67998a1f488b386d2982b3ddeec65099ab14c", "html_url": "https://github.com/rust-lang/rust/commit/8be67998a1f488b386d2982b3ddeec65099ab14c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8be67998a1f488b386d2982b3ddeec65099ab14c/comments", "author": {"login": "scottmcm", "id": 18526288, "node_id": "MDQ6VXNlcjE4NTI2Mjg4", "avatar_url": "https://avatars.githubusercontent.com/u/18526288?v=4", "gravatar_id": "", "url": "https://api.github.com/users/scottmcm", "html_url": "https://github.com/scottmcm", "followers_url": "https://api.github.com/users/scottmcm/followers", "following_url": "https://api.github.com/users/scottmcm/following{/other_user}", "gists_url": "https://api.github.com/users/scottmcm/gists{/gist_id}", "starred_url": "https://api.github.com/users/scottmcm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/scottmcm/subscriptions", "organizations_url": "https://api.github.com/users/scottmcm/orgs", "repos_url": "https://api.github.com/users/scottmcm/repos", "events_url": "https://api.github.com/users/scottmcm/events{/privacy}", "received_events_url": "https://api.github.com/users/scottmcm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "scottmcm", "id": 18526288, "node_id": "MDQ6VXNlcjE4NTI2Mjg4", "avatar_url": "https://avatars.githubusercontent.com/u/18526288?v=4", "gravatar_id": "", "url": "https://api.github.com/users/scottmcm", "html_url": "https://github.com/scottmcm", "followers_url": "https://api.github.com/users/scottmcm/followers", "following_url": "https://api.github.com/users/scottmcm/following{/other_user}", "gists_url": "https://api.github.com/users/scottmcm/gists{/gist_id}", "starred_url": "https://api.github.com/users/scottmcm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/scottmcm/subscriptions", "organizations_url": "https://api.github.com/users/scottmcm/orgs", "repos_url": "https://api.github.com/users/scottmcm/repos", "events_url": "https://api.github.com/users/scottmcm/events{/privacy}", "received_events_url": "https://api.github.com/users/scottmcm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3bcaeb0bf9e1c29d18abc32928fd2f23d1bed0bd", "url": "https://api.github.com/repos/rust-lang/rust/commits/3bcaeb0bf9e1c29d18abc32928fd2f23d1bed0bd", "html_url": "https://github.com/rust-lang/rust/commit/3bcaeb0bf9e1c29d18abc32928fd2f23d1bed0bd"}], "stats": {"total": 62, "additions": 47, "deletions": 15}, "files": [{"sha": "0ca0245a203d1ef0f90c9edc2ce2da20aadaff0b", "filename": "compiler/rustc_trait_selection/src/traits/error_reporting/on_unimplemented.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/8be67998a1f488b386d2982b3ddeec65099ab14c/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fon_unimplemented.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8be67998a1f488b386d2982b3ddeec65099ab14c/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fon_unimplemented.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fon_unimplemented.rs?ref=8be67998a1f488b386d2982b3ddeec65099ab14c", "patch": "@@ -186,6 +186,15 @@ impl<'a, 'tcx> InferCtxtExt<'tcx> for InferCtxt<'a, 'tcx> {\n                 };\n                 let name = param.name;\n                 flags.push((name, Some(value)));\n+\n+                if let GenericParamDefKind::Type { .. } = param.kind {\n+                    let param_ty = trait_ref.substs[param.index as usize].expect_ty();\n+                    if let Some(def) = param_ty.ty_adt_def() {\n+                        // We also want to be able to select the parameter's\n+                        // original signature with no type arguments resolved\n+                        flags.push((name, Some(self.tcx.type_of(def.did).to_string())));\n+                    }\n+                }\n             }\n \n             if let Some(true) = self_ty.ty_adt_def().map(|def| def.did.is_local()) {"}, {"sha": "1d9bc452618e2db93b5c551da8fe3e24d1181d7f", "filename": "library/core/src/ops/try_trait.rs", "status": "modified", "additions": 27, "deletions": 2, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/8be67998a1f488b386d2982b3ddeec65099ab14c/library%2Fcore%2Fsrc%2Fops%2Ftry_trait.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8be67998a1f488b386d2982b3ddeec65099ab14c/library%2Fcore%2Fsrc%2Fops%2Ftry_trait.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fops%2Ftry_trait.rs?ref=8be67998a1f488b386d2982b3ddeec65099ab14c", "patch": "@@ -254,6 +254,18 @@ pub trait Try: FromResidual {\n         label = \"this `?` produces `{R}`, which is incompatible with `{Self}`\",\n         enclosing_scope = \"this function returns a `Result`\"\n     ),\n+    on(\n+        all(\n+            from_method = \"from_residual\",\n+            from_desugaring = \"QuestionMark\",\n+            _Self = \"std::option::Option<T>\",\n+            R = \"std::result::Result<T, E>\",\n+        ),\n+        message = \"the `?` operator can only be used on `Option`s, not `Result`s, \\\n+            in {ItemContext} that returns `Option`\",\n+        label = \"use `.ok()?` if you want to discard the `{R}` error information\",\n+        enclosing_scope = \"this function returns an `Option`\"\n+    ),\n     on(\n         all(\n             from_method = \"from_residual\",\n@@ -272,13 +284,26 @@ pub trait Try: FromResidual {\n             from_method = \"from_residual\",\n             from_desugaring = \"QuestionMark\",\n             _Self = \"std::ops::ControlFlow<B, C>\",\n+            R = \"std::ops::ControlFlow<B, C>\",\n         ),\n-        message = \"the `?` operator can only be used on `ControlFlow<B, _>`s \\\n-            in {ItemContext} that returns `ControlFlow<B, _>`\",\n+        message = \"the `?` operator in {ItemContext} that returns `ControlFlow<B, _>` \\\n+            can only be used on other `ControlFlow<B, _>`s (with the same Break type)\",\n         label = \"this `?` produces `{R}`, which is incompatible with `{Self}`\",\n         enclosing_scope = \"this function returns a `ControlFlow`\",\n         note = \"unlike `Result`, there's no `From`-conversion performed for `ControlFlow`\"\n     ),\n+    on(\n+        all(\n+            from_method = \"from_residual\",\n+            from_desugaring = \"QuestionMark\",\n+            _Self = \"std::ops::ControlFlow<B, C>\",\n+            // `R` is not a `ControlFlow`, as that case was matched previously\n+        ),\n+        message = \"the `?` operator can only be used on `ControlFlow`s \\\n+            in {ItemContext} that returns `ControlFlow`\",\n+        label = \"this `?` produces `{R}`, which is incompatible with `{Self}`\",\n+        enclosing_scope = \"this function returns a `ControlFlow`\",\n+    ),\n     on(\n         all(\n             from_method = \"from_residual\","}, {"sha": "385f5510fb414ea79aea2857d339dcceedaafb56", "filename": "src/test/ui/try-trait/bad-interconversion.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/8be67998a1f488b386d2982b3ddeec65099ab14c/src%2Ftest%2Fui%2Ftry-trait%2Fbad-interconversion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8be67998a1f488b386d2982b3ddeec65099ab14c/src%2Ftest%2Fui%2Ftry-trait%2Fbad-interconversion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftry-trait%2Fbad-interconversion.rs?ref=8be67998a1f488b386d2982b3ddeec65099ab14c", "patch": "@@ -20,7 +20,7 @@ fn control_flow_to_result() -> Result<u64, String> {\n \n fn result_to_option() -> Option<u16> {\n     Some(Err(\"hello\")?)\n-    //~^ ERROR the `?` operator can only be used on `Option`s in a function that returns `Option`\n+    //~^ ERROR the `?` operator can only be used on `Option`s, not `Result`s, in a function that returns `Option`\n }\n \n fn control_flow_to_option() -> Option<u64> {\n@@ -30,18 +30,18 @@ fn control_flow_to_option() -> Option<u64> {\n \n fn result_to_control_flow() -> ControlFlow<String> {\n     ControlFlow::Continue(Err(\"hello\")?)\n-    //~^ ERROR the `?` operator can only be used on `ControlFlow<B, _>`s in a function that returns `ControlFlow<B, _>`\n+    //~^ ERROR the `?` operator can only be used on `ControlFlow`s in a function that returns `ControlFlow`\n }\n \n fn option_to_control_flow() -> ControlFlow<u64> {\n     Some(3)?;\n-    //~^ ERROR the `?` operator can only be used on `ControlFlow<B, _>`s in a function that returns `ControlFlow<B, _>`\n+    //~^ ERROR the `?` operator can only be used on `ControlFlow`s in a function that returns `ControlFlow`\n     ControlFlow::Break(10)\n }\n \n fn control_flow_to_control_flow() -> ControlFlow<i64> {\n     ControlFlow::Break(4_u8)?;\n-    //~^ ERROR the `?` operator can only be used on `ControlFlow<B, _>`s in a function that returns `ControlFlow<B, _>`\n+    //~^ ERROR the `?` operator in a function that returns `ControlFlow<B, _>` can only be used on other `ControlFlow<B, _>`s\n     ControlFlow::Continue(())\n }\n "}, {"sha": "f5b315c25193377cf0987c90ff30a65e92e41be1", "filename": "src/test/ui/try-trait/bad-interconversion.stderr", "status": "modified", "additions": 5, "deletions": 7, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/8be67998a1f488b386d2982b3ddeec65099ab14c/src%2Ftest%2Fui%2Ftry-trait%2Fbad-interconversion.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/8be67998a1f488b386d2982b3ddeec65099ab14c/src%2Ftest%2Fui%2Ftry-trait%2Fbad-interconversion.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftry-trait%2Fbad-interconversion.stderr?ref=8be67998a1f488b386d2982b3ddeec65099ab14c", "patch": "@@ -40,12 +40,12 @@ LL | | }\n    = help: the trait `FromResidual<ControlFlow<{integer}, Infallible>>` is not implemented for `Result<u64, String>`\n    = note: required by `from_residual`\n \n-error[E0277]: the `?` operator can only be used on `Option`s in a function that returns `Option`\n+error[E0277]: the `?` operator can only be used on `Option`s, not `Result`s, in a function that returns `Option`\n   --> $DIR/bad-interconversion.rs:22:22\n    |\n LL | / fn result_to_option() -> Option<u16> {\n LL | |     Some(Err(\"hello\")?)\n-   | |                      ^ this `?` produces `Result<Infallible, &str>`, which is incompatible with `Option<u16>`\n+   | |                      ^ use `.ok()?` if you want to discard the `Result<Infallible, &str>` error information\n LL | |\n LL | | }\n    | |_- this function returns an `Option`\n@@ -66,7 +66,7 @@ LL | | }\n    = help: the trait `FromResidual<ControlFlow<{integer}, Infallible>>` is not implemented for `Option<u64>`\n    = note: required by `from_residual`\n \n-error[E0277]: the `?` operator can only be used on `ControlFlow<B, _>`s in a function that returns `ControlFlow<B, _>`\n+error[E0277]: the `?` operator can only be used on `ControlFlow`s in a function that returns `ControlFlow`\n   --> $DIR/bad-interconversion.rs:32:39\n    |\n LL | / fn result_to_control_flow() -> ControlFlow<String> {\n@@ -77,10 +77,9 @@ LL | | }\n    | |_- this function returns a `ControlFlow`\n    |\n    = help: the trait `FromResidual<Result<Infallible, &str>>` is not implemented for `ControlFlow<String>`\n-   = note: unlike `Result`, there's no `From`-conversion performed for `ControlFlow`\n    = note: required by `from_residual`\n \n-error[E0277]: the `?` operator can only be used on `ControlFlow<B, _>`s in a function that returns `ControlFlow<B, _>`\n+error[E0277]: the `?` operator can only be used on `ControlFlow`s in a function that returns `ControlFlow`\n   --> $DIR/bad-interconversion.rs:37:12\n    |\n LL | / fn option_to_control_flow() -> ControlFlow<u64> {\n@@ -92,10 +91,9 @@ LL | | }\n    | |_- this function returns a `ControlFlow`\n    |\n    = help: the trait `FromResidual<Option<Infallible>>` is not implemented for `ControlFlow<u64>`\n-   = note: unlike `Result`, there's no `From`-conversion performed for `ControlFlow`\n    = note: required by `from_residual`\n \n-error[E0277]: the `?` operator can only be used on `ControlFlow<B, _>`s in a function that returns `ControlFlow<B, _>`\n+error[E0277]: the `?` operator in a function that returns `ControlFlow<B, _>` can only be used on other `ControlFlow<B, _>`s (with the same Break type)\n   --> $DIR/bad-interconversion.rs:43:29\n    |\n LL | / fn control_flow_to_control_flow() -> ControlFlow<i64> {"}, {"sha": "9f7d80d4f23cdc1bdb834e1b023d98f591bc9d2b", "filename": "src/test/ui/try-trait/option-to-result.stderr", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/8be67998a1f488b386d2982b3ddeec65099ab14c/src%2Ftest%2Fui%2Ftry-trait%2Foption-to-result.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/8be67998a1f488b386d2982b3ddeec65099ab14c/src%2Ftest%2Fui%2Ftry-trait%2Foption-to-result.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftry-trait%2Foption-to-result.stderr?ref=8be67998a1f488b386d2982b3ddeec65099ab14c", "patch": "@@ -12,13 +12,13 @@ LL | | }\n    = help: the trait `FromResidual<Option<Infallible>>` is not implemented for `Result<(), ()>`\n    = note: required by `from_residual`\n \n-error[E0277]: the `?` operator can only be used on `Option`s in a function that returns `Option`\n+error[E0277]: the `?` operator can only be used on `Option`s, not `Result`s, in a function that returns `Option`\n   --> $DIR/option-to-result.rs:11:6\n    |\n LL | / fn test_option() -> Option<i32>{\n LL | |     let a:Result<i32, i32> = Ok(5);\n LL | |     a?;\n-   | |      ^ this `?` produces `Result<Infallible, i32>`, which is incompatible with `Option<i32>`\n+   | |      ^ use `.ok()?` if you want to discard the `Result<Infallible, i32>` error information\n LL | |     Some(5)\n LL | | }\n    | |_- this function returns an `Option`"}]}