{"sha": "0dda42bc143309e3036341298414269351627528", "node_id": "C_kwDOAAsO6NoAKDBkZGE0MmJjMTQzMzA5ZTMwMzYzNDEyOTg0MTQyNjkzNTE2Mjc1Mjg", "commit": {"author": {"name": "Nilstrieb", "email": "48135649+Nilstrieb@users.noreply.github.com", "date": "2022-04-11T19:31:41Z"}, "committer": {"name": "Nilstrieb", "email": "48135649+Nilstrieb@users.noreply.github.com", "date": "2022-06-07T14:42:26Z"}, "message": "Improve the safety docs for `CStr`\n\nNamely, the two functions `from_ptr` and `from_bytes_with_nul_unchecked`.\nBefore, this functions didn't state the requirements clearly enough,\nand I was not immediately able to find them like for other functions.\n\nThis doesn't change the content of the docs, but simply rewords them for\nclarity.", "tree": {"sha": "459ba8527f3b0cc13a8a5629e0bca9e794aba9a8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/459ba8527f3b0cc13a8a5629e0bca9e794aba9a8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0dda42bc143309e3036341298414269351627528", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0dda42bc143309e3036341298414269351627528", "html_url": "https://github.com/rust-lang/rust/commit/0dda42bc143309e3036341298414269351627528", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0dda42bc143309e3036341298414269351627528/comments", "author": {"login": "Nilstrieb", "id": 48135649, "node_id": "MDQ6VXNlcjQ4MTM1NjQ5", "avatar_url": "https://avatars.githubusercontent.com/u/48135649?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Nilstrieb", "html_url": "https://github.com/Nilstrieb", "followers_url": "https://api.github.com/users/Nilstrieb/followers", "following_url": "https://api.github.com/users/Nilstrieb/following{/other_user}", "gists_url": "https://api.github.com/users/Nilstrieb/gists{/gist_id}", "starred_url": "https://api.github.com/users/Nilstrieb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Nilstrieb/subscriptions", "organizations_url": "https://api.github.com/users/Nilstrieb/orgs", "repos_url": "https://api.github.com/users/Nilstrieb/repos", "events_url": "https://api.github.com/users/Nilstrieb/events{/privacy}", "received_events_url": "https://api.github.com/users/Nilstrieb/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Nilstrieb", "id": 48135649, "node_id": "MDQ6VXNlcjQ4MTM1NjQ5", "avatar_url": "https://avatars.githubusercontent.com/u/48135649?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Nilstrieb", "html_url": "https://github.com/Nilstrieb", "followers_url": "https://api.github.com/users/Nilstrieb/followers", "following_url": "https://api.github.com/users/Nilstrieb/following{/other_user}", "gists_url": "https://api.github.com/users/Nilstrieb/gists{/gist_id}", "starred_url": "https://api.github.com/users/Nilstrieb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Nilstrieb/subscriptions", "organizations_url": "https://api.github.com/users/Nilstrieb/orgs", "repos_url": "https://api.github.com/users/Nilstrieb/repos", "events_url": "https://api.github.com/users/Nilstrieb/events{/privacy}", "received_events_url": "https://api.github.com/users/Nilstrieb/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1851f0802e148bb7fa0bfd7dabcb7397bf371b0b", "url": "https://api.github.com/repos/rust-lang/rust/commits/1851f0802e148bb7fa0bfd7dabcb7397bf371b0b", "html_url": "https://github.com/rust-lang/rust/commit/1851f0802e148bb7fa0bfd7dabcb7397bf371b0b"}], "stats": {"total": 37, "additions": 27, "deletions": 10}, "files": [{"sha": "264f4da5aa66e9d10f748e19d29a52115afaa95d", "filename": "library/core/src/ffi/c_str.rs", "status": "modified", "additions": 27, "deletions": 10, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/0dda42bc143309e3036341298414269351627528/library%2Fcore%2Fsrc%2Fffi%2Fc_str.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0dda42bc143309e3036341298414269351627528/library%2Fcore%2Fsrc%2Fffi%2Fc_str.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fffi%2Fc_str.rs?ref=0dda42bc143309e3036341298414269351627528", "patch": "@@ -196,20 +196,32 @@ impl CStr {\n     /// allows inspection and interoperation of non-owned C strings. The total\n     /// size of the raw C string must be smaller than `isize::MAX` **bytes**\n     /// in memory due to calling the `slice::from_raw_parts` function.\n-    /// This method is unsafe for a number of reasons:\n     ///\n-    /// * There is no guarantee to the validity of `ptr`.\n-    /// * The returned lifetime is not guaranteed to be the actual lifetime of\n-    ///   `ptr`.\n-    /// * There is no guarantee that the memory pointed to by `ptr` contains a\n-    ///   valid nul terminator byte at the end of the string.\n-    /// * It is not guaranteed that the memory pointed by `ptr` won't change\n-    ///   before the `CStr` has been destroyed.\n+    /// # Safety\n+    ///\n+    /// * The memory pointed to by `ptr` must contain a valid nul terminator at the\n+    ///   end of the string.\n+    ///\n+    /// * `ptr` must be [valid] for reads of bytes up to and including the null terminator.\n+    ///   This means in particular:\n+    ///\n+    ///     * The entire memory range of this `CStr` must be contained within a single allocated object!\n+    ///     * `ptr` must be non-null even for a zero-length cstr.\n+    ///\n+    /// * The memory referenced by the returned `CStr` must not be mutated for\n+    ///   the duration of lifetime `'a`.\n     ///\n     /// > **Note**: This operation is intended to be a 0-cost cast but it is\n     /// > currently implemented with an up-front calculation of the length of\n     /// > the string. This is not guaranteed to always be the case.\n     ///\n+    /// # Caveat\n+    ///\n+    /// The lifetime for the returned slice is inferred from its usage. To prevent accidental misuse,\n+    /// it's suggested to tie the lifetime to whichever source lifetime is safe in the context,\n+    /// such as by providing a helper function taking the lifetime of a host value for the slice,\n+    /// or by explicit annotation.\n+    ///\n     /// # Examples\n     ///\n     /// ```ignore (extern-declaration)\n@@ -227,6 +239,8 @@ impl CStr {\n     /// }\n     /// # }\n     /// ```\n+    ///\n+    /// [valid]: core::ptr#safety\n     #[inline]\n     #[must_use]\n     #[stable(feature = \"rust1\", since = \"1.0.0\")]\n@@ -349,8 +363,11 @@ impl CStr {\n     /// Unsafely creates a C string wrapper from a byte slice.\n     ///\n     /// This function will cast the provided `bytes` to a `CStr` wrapper without\n-    /// performing any sanity checks. The provided slice **must** be nul-terminated\n-    /// and not contain any interior nul bytes.\n+    /// performing any sanity checks.\n+    ///\n+    /// # Safety\n+    /// The provided slice **must** be nul-terminated and not contain any interior\n+    /// nul bytes.\n     ///\n     /// # Examples\n     ///"}]}