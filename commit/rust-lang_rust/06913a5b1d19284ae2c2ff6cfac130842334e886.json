{"sha": "06913a5b1d19284ae2c2ff6cfac130842334e886", "node_id": "MDY6Q29tbWl0NzI0NzEyOjA2OTEzYTViMWQxOTI4NGFlMmMyZmY2Y2ZhYzEzMDg0MjMzNGU4ODY=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2018-01-12T20:53:51Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2018-01-19T16:57:01Z"}, "message": "Automaticaly calculate beta prerelease numbers\n\nThis is a forward-port of:\n\n* 9426dda83d7a928d6ced377345e14b84b0f11c21\n* cbfb9858951da7aee22d82178405306fca9decb1\n\nfrom the beta branch which is used to automatically calculate the beta number\nbased on the number of merges to the beta branch so far.", "tree": {"sha": "d6a0de7cdf9c71355761591f8f93e428a3159a3d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d6a0de7cdf9c71355761591f8f93e428a3159a3d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/06913a5b1d19284ae2c2ff6cfac130842334e886", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/06913a5b1d19284ae2c2ff6cfac130842334e886", "html_url": "https://github.com/rust-lang/rust/commit/06913a5b1d19284ae2c2ff6cfac130842334e886", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/06913a5b1d19284ae2c2ff6cfac130842334e886/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3bd4af88bea2e6ecdd3455ed89b3ef1fc3500aa4", "url": "https://api.github.com/repos/rust-lang/rust/commits/3bd4af88bea2e6ecdd3455ed89b3ef1fc3500aa4", "html_url": "https://github.com/rust-lang/rust/commit/3bd4af88bea2e6ecdd3455ed89b3ef1fc3500aa4"}], "stats": {"total": 65, "additions": 57, "deletions": 8}, "files": [{"sha": "e412dd9e3e67010a6f0f2645c17e018494a21296", "filename": "src/bootstrap/channel.rs", "status": "modified", "additions": 0, "deletions": 5, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/06913a5b1d19284ae2c2ff6cfac130842334e886/src%2Fbootstrap%2Fchannel.rs", "raw_url": "https://github.com/rust-lang/rust/raw/06913a5b1d19284ae2c2ff6cfac130842334e886/src%2Fbootstrap%2Fchannel.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fchannel.rs?ref=06913a5b1d19284ae2c2ff6cfac130842334e886", "patch": "@@ -26,11 +26,6 @@ use config::Config;\n // The version number\n pub const CFG_RELEASE_NUM: &str = \"1.25.0\";\n \n-// An optional number to put after the label, e.g. '.2' -> '-beta.2'\n-// Be sure to make this starts with a dot to conform to semver pre-release\n-// versions (section 9)\n-pub const CFG_PRERELEASE_VERSION: &str = \".1\";\n-\n pub struct GitInfo {\n     inner: Option<Info>,\n }"}, {"sha": "224b31ef26872469d600fc87ff4b99cb006fb0bf", "filename": "src/bootstrap/dist.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/06913a5b1d19284ae2c2ff6cfac130842334e886/src%2Fbootstrap%2Fdist.rs", "raw_url": "https://github.com/rust-lang/rust/raw/06913a5b1d19284ae2c2ff6cfac130842334e886/src%2Fbootstrap%2Fdist.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fdist.rs?ref=06913a5b1d19284ae2c2ff6cfac130842334e886", "patch": "@@ -1652,7 +1652,6 @@ fn add_env(build: &Build, cmd: &mut Command, target: Interned<String>) {\n     cmd.env(\"CFG_RELEASE_INFO\", build.rust_version())\n        .env(\"CFG_RELEASE_NUM\", channel::CFG_RELEASE_NUM)\n        .env(\"CFG_RELEASE\", build.rust_release())\n-       .env(\"CFG_PRERELEASE_VERSION\", channel::CFG_PRERELEASE_VERSION)\n        .env(\"CFG_VER_MAJOR\", parts.next().unwrap())\n        .env(\"CFG_VER_MINOR\", parts.next().unwrap())\n        .env(\"CFG_VER_PATCH\", parts.next().unwrap())"}, {"sha": "3738828a4baed00011f87aea1fe41ec37c06f980", "filename": "src/bootstrap/lib.rs", "status": "modified", "additions": 51, "deletions": 2, "changes": 53, "blob_url": "https://github.com/rust-lang/rust/blob/06913a5b1d19284ae2c2ff6cfac130842334e886/src%2Fbootstrap%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/06913a5b1d19284ae2c2ff6cfac130842334e886/src%2Fbootstrap%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Flib.rs?ref=06913a5b1d19284ae2c2ff6cfac130842334e886", "patch": "@@ -134,7 +134,7 @@ extern crate toml;\n #[cfg(unix)]\n extern crate libc;\n \n-use std::cell::RefCell;\n+use std::cell::{RefCell, Cell};\n use std::collections::{HashSet, HashMap};\n use std::env;\n use std::fs::{self, File};\n@@ -250,6 +250,7 @@ pub struct Build {\n     is_sudo: bool,\n     ci_env: CiEnv,\n     delayed_failures: RefCell<Vec<String>>,\n+    prerelease_version: Cell<Option<u32>>,\n }\n \n #[derive(Debug)]\n@@ -335,6 +336,7 @@ impl Build {\n             is_sudo,\n             ci_env: CiEnv::current(),\n             delayed_failures: RefCell::new(Vec::new()),\n+            prerelease_version: Cell::new(None),\n         }\n     }\n \n@@ -774,12 +776,59 @@ impl Build {\n     fn release(&self, num: &str) -> String {\n         match &self.config.channel[..] {\n             \"stable\" => num.to_string(),\n-            \"beta\" => format!(\"{}-beta{}\", num, channel::CFG_PRERELEASE_VERSION),\n+            \"beta\" => format!(\"{}-beta.{}\", num, self.beta_prerelease_version()),\n             \"nightly\" => format!(\"{}-nightly\", num),\n             _ => format!(\"{}-dev\", num),\n         }\n     }\n \n+    fn beta_prerelease_version(&self) -> u32 {\n+        if let Some(s) = self.prerelease_version.get() {\n+            return s\n+        }\n+\n+        let beta = output(\n+            Command::new(\"git\")\n+                .arg(\"ls-remote\")\n+                .arg(\"origin\")\n+                .arg(\"beta\")\n+                .current_dir(&self.src)\n+        );\n+        let beta = beta.trim().split_whitespace().next().unwrap();\n+        let master = output(\n+            Command::new(\"git\")\n+                .arg(\"ls-remote\")\n+                .arg(\"origin\")\n+                .arg(\"master\")\n+                .current_dir(&self.src)\n+        );\n+        let master = master.trim().split_whitespace().next().unwrap();\n+\n+        // Figure out where the current beta branch started.\n+        let base = output(\n+            Command::new(\"git\")\n+                .arg(\"merge-base\")\n+                .arg(beta)\n+                .arg(master)\n+                .current_dir(&self.src),\n+        );\n+        let base = base.trim();\n+\n+        // Next figure out how many merge commits happened since we branched off\n+        // beta. That's our beta number!\n+        let count = output(\n+            Command::new(\"git\")\n+                .arg(\"rev-list\")\n+                .arg(\"--count\")\n+                .arg(\"--merges\")\n+                .arg(format!(\"{}...HEAD\", base))\n+                .current_dir(&self.src),\n+        );\n+        let n = count.trim().parse().unwrap();\n+        self.prerelease_version.set(Some(n));\n+        n\n+    }\n+\n     /// Returns the value of `release` above for Rust itself.\n     fn rust_release(&self) -> String {\n         self.release(channel::CFG_RELEASE_NUM)"}, {"sha": "14a1906ff421dd24996e619005ff2cdfeaca90f2", "filename": "src/ci/init_repo.sh", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/06913a5b1d19284ae2c2ff6cfac130842334e886/src%2Fci%2Finit_repo.sh", "raw_url": "https://github.com/rust-lang/rust/raw/06913a5b1d19284ae2c2ff6cfac130842334e886/src%2Fci%2Finit_repo.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Finit_repo.sh?ref=06913a5b1d19284ae2c2ff6cfac130842334e886", "patch": "@@ -36,6 +36,12 @@ fi\n rm -rf \"$CACHE_DIR\"\n mkdir \"$CACHE_DIR\"\n \n+# On the beta channel we'll be automatically calculating the prerelease version\n+# via the git history, so unshallow our shallow clone from CI.\n+if grep -q RUST_RELEASE_CHANNEL=beta src/ci/run.sh; then\n+  git fetch origin --unshallow beta master\n+fi\n+\n travis_fold start update_cache\n travis_time_start\n "}]}