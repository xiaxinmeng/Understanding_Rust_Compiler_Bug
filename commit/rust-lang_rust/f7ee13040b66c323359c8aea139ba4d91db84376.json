{"sha": "f7ee13040b66c323359c8aea139ba4d91db84376", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY3ZWUxMzA0MGI2NmMzMjMzNTljOGFlYTEzOWJhNGQ5MWRiODQzNzY=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-09-09T15:42:29Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-09-09T15:42:29Z"}, "message": "Rollup merge of #64312 - GuillaumeGomez:rustdoc-better-esc-handling, r=Mark-Simulacrum\n\nUnify escape usage\n\nFixes #63443.\n\nI chose to keep the search text when pressing escape so when we focus on the search bar, we got the results again without needing to load them again. I also unified a bit a few things (maybe I should have done it in another commit, sorry...).\n\nr? @Mark-Simulacrum", "tree": {"sha": "cb047366c3ea2adc9511c6f41334b9c52b8b8863", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cb047366c3ea2adc9511c6f41334b9c52b8b8863"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f7ee13040b66c323359c8aea139ba4d91db84376", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJddnLlCRBK7hj4Ov3rIwAAdHIIAKgZ/rbQPyOU6dOF5FITnkV4\nPvqm25jJxY/GICsv9JJhXjWrRpIEfEG4C/p4F7p8KBGazGGtl3vc0zSw5lAzkulY\nBVlO20AlL8aIv+xR/P6CGDkljcEt6i7fzKsx/x4wN1SP/ALA/CZbznNyaOq6XNLu\njvLIXvhOi9R6r8tVSYiPUueCZfvDWp0hPXX7VqWmoxx5G3Gw3+lVNOIYqCJHjn9n\nHdm2YdyWN4t9n4w/j+fd2pNS7oZeSkcrWk34LyV4cLvA82FeECe5GZG6BywVoUrE\nHbauEZD/Psid4Q0V1SJetsiTNBgq+6+95/hxD/ZMzqJ8IDaZQfbbkz6xcJQQ4bk=\n=lmGS\n-----END PGP SIGNATURE-----\n", "payload": "tree cb047366c3ea2adc9511c6f41334b9c52b8b8863\nparent 063740f25dd4c213389ffa909c743acc85e64bf7\nparent 0d34fe42f724ba094b8d131f869c716204450e5c\nauthor Mazdak Farrokhzad <twingoow@gmail.com> 1568043749 +0200\ncommitter GitHub <noreply@github.com> 1568043749 +0200\n\nRollup merge of #64312 - GuillaumeGomez:rustdoc-better-esc-handling, r=Mark-Simulacrum\n\nUnify escape usage\n\nFixes #63443.\n\nI chose to keep the search text when pressing escape so when we focus on the search bar, we got the results again without needing to load them again. I also unified a bit a few things (maybe I should have done it in another commit, sorry...).\n\nr? @Mark-Simulacrum\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f7ee13040b66c323359c8aea139ba4d91db84376", "html_url": "https://github.com/rust-lang/rust/commit/f7ee13040b66c323359c8aea139ba4d91db84376", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f7ee13040b66c323359c8aea139ba4d91db84376/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "063740f25dd4c213389ffa909c743acc85e64bf7", "url": "https://api.github.com/repos/rust-lang/rust/commits/063740f25dd4c213389ffa909c743acc85e64bf7", "html_url": "https://github.com/rust-lang/rust/commit/063740f25dd4c213389ffa909c743acc85e64bf7"}, {"sha": "0d34fe42f724ba094b8d131f869c716204450e5c", "url": "https://api.github.com/repos/rust-lang/rust/commits/0d34fe42f724ba094b8d131f869c716204450e5c", "html_url": "https://github.com/rust-lang/rust/commit/0d34fe42f724ba094b8d131f869c716204450e5c"}], "stats": {"total": 47, "additions": 29, "deletions": 18}, "files": [{"sha": "17a940cc4c9f8adb26058db6f1d3c6bb59e60cd7", "filename": "src/librustdoc/html/static/main.js", "status": "modified", "additions": 29, "deletions": 18, "changes": 47, "blob_url": "https://github.com/rust-lang/rust/blob/f7ee13040b66c323359c8aea139ba4d91db84376/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fmain.js", "raw_url": "https://github.com/rust-lang/rust/raw/f7ee13040b66c323359c8aea139ba4d91db84376/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fmain.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fmain.js?ref=f7ee13040b66c323359c8aea139ba4d91db84376", "patch": "@@ -39,6 +39,14 @@ if (!DOMTokenList.prototype.remove) {\n     };\n }\n \n+function getSearchInput() {\n+    return document.getElementsByClassName(\"search-input\")[0];\n+}\n+\n+function getSearchElement() {\n+    return document.getElementById(\"search\");\n+}\n+\n (function() {\n     \"use strict\";\n \n@@ -71,7 +79,7 @@ if (!DOMTokenList.prototype.remove) {\n                      \"derive\",\n                      \"traitalias\"];\n \n-    var search_input = document.getElementsByClassName(\"search-input\")[0];\n+    var search_input = getSearchInput();\n \n     // On the search screen, so you remain on the last tab you opened.\n     //\n@@ -158,7 +166,7 @@ if (!DOMTokenList.prototype.remove) {\n         // If we're in mobile mode, we should add the sidebar in any case.\n         hideSidebar();\n         var elem;\n-        var search = document.getElementById(\"search\");\n+        var search = getSearchElement();\n         var i, from, to, match = window.location.hash.match(/^#?(\\d+)(?:-(\\d+))?$/);\n         if (match) {\n             from = parseInt(match[1], 10);\n@@ -250,7 +258,12 @@ if (!DOMTokenList.prototype.remove) {\n         return String.fromCharCode(c);\n     }\n \n+    function getHelpElement() {\n+        return document.getElementById(\"help\");\n+    }\n+\n     function displayHelp(display, ev, help) {\n+        var help = help ? help : getHelpElement();\n         if (display === true) {\n             if (hasClass(help, \"hidden\")) {\n                 ev.preventDefault();\n@@ -264,9 +277,10 @@ if (!DOMTokenList.prototype.remove) {\n         }\n     }\n \n-    function handleEscape(ev, help) {\n+    function handleEscape(ev) {\n+        var help = getHelpElement();\n+        var search = getSearchElement();\n         hideModal();\n-        var search = document.getElementById(\"search\");\n         if (hasClass(help, \"hidden\") === false) {\n             displayHelp(false, ev, help);\n         } else if (hasClass(search, \"hidden\") === false) {\n@@ -284,22 +298,21 @@ if (!DOMTokenList.prototype.remove) {\n             return;\n         }\n \n-        var help = document.getElementById(\"help\");\n         if (document.activeElement.tagName === \"INPUT\") {\n             switch (getVirtualKey(ev)) {\n             case \"Escape\":\n-                handleEscape(ev, help);\n+                handleEscape(ev);\n                 break;\n             }\n         } else {\n             switch (getVirtualKey(ev)) {\n             case \"Escape\":\n-                handleEscape(ev, help);\n+                handleEscape(ev);\n                 break;\n \n             case \"s\":\n             case \"S\":\n-                displayHelp(false, ev, help);\n+                displayHelp(false, ev);\n                 hideModal();\n                 ev.preventDefault();\n                 focusSearchBar();\n@@ -314,7 +327,7 @@ if (!DOMTokenList.prototype.remove) {\n             case \"?\":\n                 if (ev.shiftKey) {\n                     hideModal();\n-                    displayHelp(true, ev, help);\n+                    displayHelp(true, ev);\n                 }\n                 break;\n             }\n@@ -1281,9 +1294,7 @@ if (!DOMTokenList.prototype.remove) {\n                 } else if (e.which === 16) { // shift\n                     // Does nothing, it's just to avoid losing \"focus\" on the highlighted element.\n                 } else if (e.which === 27) { // escape\n-                    removeClass(actives[currentTab][0], \"highlighted\");\n-                    search_input.value = \"\";\n-                    defocusSearchBar();\n+                    handleEscape(e);\n                 } else if (actives[currentTab].length > 0) {\n                     removeClass(actives[currentTab][0], \"highlighted\");\n                 }\n@@ -1434,7 +1445,7 @@ if (!DOMTokenList.prototype.remove) {\n                 ret_others[0] + ret_in_args[0] + ret_returned[0] + \"</div>\";\n \n             addClass(main, \"hidden\");\n-            var search = document.getElementById(\"search\");\n+            var search = getSearchElement();\n             removeClass(search, \"hidden\");\n             search.innerHTML = output;\n             var tds = search.getElementsByTagName(\"td\");\n@@ -1644,7 +1655,7 @@ if (!DOMTokenList.prototype.remove) {\n                     if (hasClass(main, \"content\")) {\n                         removeClass(main, \"hidden\");\n                     }\n-                    var search_c = document.getElementById(\"search\");\n+                    var search_c = getSearchElement();\n                     if (hasClass(search_c, \"content\")) {\n                         addClass(search_c, \"hidden\");\n                     }\n@@ -1691,7 +1702,7 @@ if (!DOMTokenList.prototype.remove) {\n                         if (hasClass(main, \"content\")) {\n                             removeClass(main, \"hidden\");\n                         }\n-                        var search_c = document.getElementById(\"search\");\n+                        var search_c = getSearchElement();\n                         if (hasClass(search_c, \"content\")) {\n                             addClass(search_c, \"hidden\");\n                         }\n@@ -2460,7 +2471,7 @@ if (!DOMTokenList.prototype.remove) {\n     var params = getQueryStringParams();\n     if (params && params.search) {\n         addClass(main, \"hidden\");\n-        var search = document.getElementById(\"search\");\n+        var search = getSearchElement();\n         removeClass(search, \"hidden\");\n         search.innerHTML = \"<h3 style=\\\"text-align: center;\\\">Loading search results...</h3>\";\n     }\n@@ -2545,10 +2556,10 @@ if (!DOMTokenList.prototype.remove) {\n \n // Sets the focus on the search bar at the top of the page\n function focusSearchBar() {\n-    document.getElementsByClassName(\"search-input\")[0].focus();\n+    getSearchInput().focus();\n }\n \n // Removes the focus from the search bar\n function defocusSearchBar() {\n-    document.getElementsByClassName(\"search-input\")[0].blur();\n+    getSearchInput().blur();\n }"}]}