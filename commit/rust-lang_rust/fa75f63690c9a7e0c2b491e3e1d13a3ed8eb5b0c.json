{"sha": "fa75f63690c9a7e0c2b491e3e1d13a3ed8eb5b0c", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZhNzVmNjM2OTBjOWE3ZTBjMmI0OTFlM2UxZDEzYTNlZDhlYjViMGM=", "commit": {"author": {"name": "Cameron Steffen", "email": "cam.steffen94@gmail.com", "date": "2020-11-23T15:23:24Z"}, "committer": {"name": "flip1995", "email": "philipp.krones@embecosm.com", "date": "2021-01-02T17:25:40Z"}, "message": "Fix field_reassign_with_default for private fields", "tree": {"sha": "97857feb12e3426e8f9252a1f7730a66490abbfe", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/97857feb12e3426e8f9252a1f7730a66490abbfe"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fa75f63690c9a7e0c2b491e3e1d13a3ed8eb5b0c", "comment_count": 0, "verification": {"verified": false, "reason": "bad_email", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEij1UXJ/PQTcb99vTHKDfKvWdaKUFAl/wrJQACgkQHKDfKvWd\naKUtpxAA3BbKNVCzdTWVBgPxUszbjXohD7oeERYnd9Av0MVpKrq+WZ1H/Whhr8IX\nmnyoJ/abLW101HSrbDuVaUAS2SvduZTV7pI2gYdapl5hj1SVk9zhAG3F+y9eEi35\nlXDDYZqU9VwzelDxvLBuu2M53OqXTT/Ta9MAzTdoyxEBCNBK/FTCHl/oJB07YePv\n40+EkakXHaDI1LZrGi/FvTeD1oHKnqtRtJKw0gjWC4B2V7VLb75rOnoMYDYEcOlC\n3V+8TzRcEeAjL90r0sT/V4ww8hklVpXa5JJSegVFNtZ3Vm4NN4D0nkFuwCuCfbeh\ncinRhQ87qYhfVoFe9JssZQAL3mmw0MhjJEuaZ66KxXlTSKBw16U6F4rVlkqL4kF2\nNyvm1ztG38iy8abfW9Q3nzX7+xXVKq/2ZpWUI62KpEHVyc7SQKRpfzL2eUuocR+4\n1oqSZTNfGpPj0lDomfrVcb76i6vDPtTH3mFBrxIqYIveO/tJC2+NccKdbWCJLQGh\nhvUNmI3SPj9H2T7QPGirXhzCALgAD6uXCRzLdM1hmxAJW6Sz1rwMUTx0qVX1+FMF\nLJcwCYkQzWPDlDHGh6aW4TIhfmjnAY3DIesdhUG2YB4E3j1372N5TvSl2Ey1by6t\nH1aKtf/5dqJptzMQQ+xOSnJCZwERYFsl9YRK8ASMAiinUp0IcVo=\n=UGwS\n-----END PGP SIGNATURE-----", "payload": "tree 97857feb12e3426e8f9252a1f7730a66490abbfe\nparent f74e2001b94fa67ecef00bdb7de1e120f9cf0ec8\nauthor Cameron Steffen <cam.steffen94@gmail.com> 1606145004 -0600\ncommitter flip1995 <philipp.krones@embecosm.com> 1609608340 +0100\n\nFix field_reassign_with_default for private fields\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fa75f63690c9a7e0c2b491e3e1d13a3ed8eb5b0c", "html_url": "https://github.com/rust-lang/rust/commit/fa75f63690c9a7e0c2b491e3e1d13a3ed8eb5b0c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fa75f63690c9a7e0c2b491e3e1d13a3ed8eb5b0c/comments", "author": {"login": "camsteffen", "id": 5565418, "node_id": "MDQ6VXNlcjU1NjU0MTg=", "avatar_url": "https://avatars.githubusercontent.com/u/5565418?v=4", "gravatar_id": "", "url": "https://api.github.com/users/camsteffen", "html_url": "https://github.com/camsteffen", "followers_url": "https://api.github.com/users/camsteffen/followers", "following_url": "https://api.github.com/users/camsteffen/following{/other_user}", "gists_url": "https://api.github.com/users/camsteffen/gists{/gist_id}", "starred_url": "https://api.github.com/users/camsteffen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/camsteffen/subscriptions", "organizations_url": "https://api.github.com/users/camsteffen/orgs", "repos_url": "https://api.github.com/users/camsteffen/repos", "events_url": "https://api.github.com/users/camsteffen/events{/privacy}", "received_events_url": "https://api.github.com/users/camsteffen/received_events", "type": "User", "site_admin": false}, "committer": {"login": "flip1995", "id": 9744647, "node_id": "MDQ6VXNlcjk3NDQ2NDc=", "avatar_url": "https://avatars.githubusercontent.com/u/9744647?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flip1995", "html_url": "https://github.com/flip1995", "followers_url": "https://api.github.com/users/flip1995/followers", "following_url": "https://api.github.com/users/flip1995/following{/other_user}", "gists_url": "https://api.github.com/users/flip1995/gists{/gist_id}", "starred_url": "https://api.github.com/users/flip1995/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flip1995/subscriptions", "organizations_url": "https://api.github.com/users/flip1995/orgs", "repos_url": "https://api.github.com/users/flip1995/repos", "events_url": "https://api.github.com/users/flip1995/events{/privacy}", "received_events_url": "https://api.github.com/users/flip1995/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f74e2001b94fa67ecef00bdb7de1e120f9cf0ec8", "url": "https://api.github.com/repos/rust-lang/rust/commits/f74e2001b94fa67ecef00bdb7de1e120f9cf0ec8", "html_url": "https://github.com/rust-lang/rust/commit/f74e2001b94fa67ecef00bdb7de1e120f9cf0ec8"}], "stats": {"total": 174, "additions": 81, "deletions": 93}, "files": [{"sha": "b0d7c7b3baab1b71fa6d0b82090b08aadc9c37c0", "filename": "clippy_lints/src/default.rs", "status": "modified", "additions": 69, "deletions": 93, "changes": 162, "blob_url": "https://github.com/rust-lang/rust/blob/fa75f63690c9a7e0c2b491e3e1d13a3ed8eb5b0c/clippy_lints%2Fsrc%2Fdefault.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fa75f63690c9a7e0c2b491e3e1d13a3ed8eb5b0c/clippy_lints%2Fsrc%2Fdefault.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fdefault.rs?ref=fa75f63690c9a7e0c2b491e3e1d13a3ed8eb5b0c", "patch": "@@ -6,7 +6,7 @@ use rustc_errors::Applicability;\n use rustc_hir::def::Res;\n use rustc_hir::{Block, Expr, ExprKind, PatKind, QPath, Stmt, StmtKind};\n use rustc_lint::{LateContext, LateLintPass};\n-use rustc_middle::ty::{self, Adt, Ty};\n+use rustc_middle::ty;\n use rustc_session::{declare_tool_lint, impl_lint_pass};\n use rustc_span::symbol::{Ident, Symbol};\n use rustc_span::Span;\n@@ -103,18 +103,41 @@ impl LateLintPass<'_> for Default {\n     }\n \n     fn check_block<'tcx>(&mut self, cx: &LateContext<'tcx>, block: &Block<'tcx>) {\n-        // find all binding statements like `let mut _ = T::default()` where `T::default()` is the\n-        // `default` method of the `Default` trait, and store statement index in current block being\n-        // checked and the name of the bound variable\n-        let binding_statements_using_default = enumerate_bindings_using_default(cx, block);\n-\n         // start from the `let mut _ = _::default();` and look at all the following\n         // statements, see if they re-assign the fields of the binding\n-        for (stmt_idx, binding_name, binding_type, span) in binding_statements_using_default {\n-            // the last statement of a block cannot trigger the lint\n-            if stmt_idx == block.stmts.len() - 1 {\n-                break;\n-            }\n+        let stmts_head = match block.stmts {\n+            // Skip the last statement since there cannot possibly be any following statements that re-assign fields.\n+            [head @ .., _] if !head.is_empty() => head,\n+            _ => return,\n+        };\n+        for (stmt_idx, stmt) in stmts_head.iter().enumerate() {\n+            // find all binding statements like `let mut _ = T::default()` where `T::default()` is the\n+            // `default` method of the `Default` trait, and store statement index in current block being\n+            // checked and the name of the bound variable\n+            let (local, variant, binding_name, binding_type, span) = if_chain! {\n+                // only take `let ...` statements\n+                if let StmtKind::Local(local) = stmt.kind;\n+                if let Some(expr) = local.init;\n+                // only take bindings to identifiers\n+                if let PatKind::Binding(_, binding_id, ident, _) = local.pat.kind;\n+                // only when assigning `... = Default::default()`\n+                if is_expr_default(expr, cx);\n+                let binding_type = cx.typeck_results().node_type(binding_id);\n+                if let Some(adt) = binding_type.ty_adt_def();\n+                if adt.is_struct();\n+                let variant = adt.non_enum_variant();\n+                if adt.did.is_local() || !variant.is_field_list_non_exhaustive();\n+                let module_did = cx.tcx.parent_module(stmt.hir_id).to_def_id();\n+                if variant\n+                    .fields\n+                    .iter()\n+                    .all(|field| field.vis.is_accessible_from(module_did, cx.tcx));\n+                then {\n+                    (local, variant, ident.name, binding_type, expr.span)\n+                } else {\n+                    continue;\n+                }\n+            };\n \n             // find all \"later statement\"'s where the fields of the binding set as\n             // Default::default() get reassigned, unless the reassignment refers to the original binding\n@@ -154,49 +177,45 @@ impl LateLintPass<'_> for Default {\n             // if there are incorrectly assigned fields, do a span_lint_and_note to suggest\n             // construction using `Ty { fields, ..Default::default() }`\n             if !assigned_fields.is_empty() && !cancel_lint {\n-                // take the original assignment as span\n-                let stmt = &block.stmts[stmt_idx];\n-\n-                if let StmtKind::Local(preceding_local) = &stmt.kind {\n-                    // if all fields of the struct are not assigned, add `.. Default::default()` to the suggestion.\n-                    let ext_with_default = !fields_of_type(binding_type)\n-                        .iter()\n-                        .all(|field| assigned_fields.iter().any(|(a, _)| a == &field.name));\n+                // if all fields of the struct are not assigned, add `.. Default::default()` to the suggestion.\n+                let ext_with_default = !variant\n+                    .fields\n+                    .iter()\n+                    .all(|field| assigned_fields.iter().any(|(a, _)| a == &field.ident.name));\n \n-                    let field_list = assigned_fields\n-                        .into_iter()\n-                        .map(|(field, rhs)| {\n-                            // extract and store the assigned value for help message\n-                            let value_snippet = snippet(cx, rhs.span, \"..\");\n-                            format!(\"{}: {}\", field, value_snippet)\n-                        })\n-                        .collect::<Vec<String>>()\n-                        .join(\", \");\n+                let field_list = assigned_fields\n+                    .into_iter()\n+                    .map(|(field, rhs)| {\n+                        // extract and store the assigned value for help message\n+                        let value_snippet = snippet(cx, rhs.span, \"..\");\n+                        format!(\"{}: {}\", field, value_snippet)\n+                    })\n+                    .collect::<Vec<String>>()\n+                    .join(\", \");\n \n-                    let sugg = if ext_with_default {\n-                        if field_list.is_empty() {\n-                            format!(\"{}::default()\", binding_type)\n-                        } else {\n-                            format!(\"{} {{ {}, ..Default::default() }}\", binding_type, field_list)\n-                        }\n+                let sugg = if ext_with_default {\n+                    if field_list.is_empty() {\n+                        format!(\"{}::default()\", binding_type)\n                     } else {\n-                        format!(\"{} {{ {} }}\", binding_type, field_list)\n-                    };\n+                        format!(\"{} {{ {}, ..Default::default() }}\", binding_type, field_list)\n+                    }\n+                } else {\n+                    format!(\"{} {{ {} }}\", binding_type, field_list)\n+                };\n \n-                    // span lint once per statement that binds default\n-                    span_lint_and_note(\n-                        cx,\n-                        FIELD_REASSIGN_WITH_DEFAULT,\n-                        first_assign.unwrap().span,\n-                        \"field assignment outside of initializer for an instance created with Default::default()\",\n-                        Some(preceding_local.span),\n-                        &format!(\n-                            \"consider initializing the variable with `{}` and removing relevant reassignments\",\n-                            sugg\n-                        ),\n-                    );\n-                    self.reassigned_linted.insert(span);\n-                }\n+                // span lint once per statement that binds default\n+                span_lint_and_note(\n+                    cx,\n+                    FIELD_REASSIGN_WITH_DEFAULT,\n+                    first_assign.unwrap().span,\n+                    \"field assignment outside of initializer for an instance created with Default::default()\",\n+                    Some(local.span),\n+                    &format!(\n+                        \"consider initializing the variable with `{}` and removing relevant reassignments\",\n+                        sugg\n+                    ),\n+                );\n+                self.reassigned_linted.insert(span);\n             }\n         }\n     }\n@@ -217,38 +236,6 @@ fn is_expr_default<'tcx>(expr: &'tcx Expr<'tcx>, cx: &LateContext<'tcx>) -> bool\n     }\n }\n \n-/// Returns the block indices, identifiers and types of bindings set as `Default::default()`, except\n-/// for when the pattern type is a tuple.\n-fn enumerate_bindings_using_default<'tcx>(\n-    cx: &LateContext<'tcx>,\n-    block: &Block<'tcx>,\n-) -> Vec<(usize, Symbol, Ty<'tcx>, Span)> {\n-    block\n-        .stmts\n-        .iter()\n-        .enumerate()\n-        .filter_map(|(idx, stmt)| {\n-            if_chain! {\n-                // only take `let ...` statements\n-                if let StmtKind::Local(ref local) = stmt.kind;\n-                // only take bindings to identifiers\n-                if let PatKind::Binding(_, _, ident, _) = local.pat.kind;\n-                // that are not tuples\n-                let ty = cx.typeck_results().pat_ty(local.pat);\n-                if !matches!(ty.kind(), ty::Tuple(_));\n-                // only when assigning `... = Default::default()`\n-                if let Some(ref expr) = local.init;\n-                if is_expr_default(expr, cx);\n-                then {\n-                    Some((idx, ident.name, ty, expr.span))\n-                } else {\n-                    None\n-                }\n-            }\n-        })\n-        .collect()\n-}\n-\n /// Returns the reassigned field and the assigning expression (right-hand side of assign).\n fn field_reassigned_by_stmt<'tcx>(this: &Stmt<'tcx>, binding_name: Symbol) -> Option<(Ident, &'tcx Expr<'tcx>)> {\n     if_chain! {\n@@ -268,14 +255,3 @@ fn field_reassigned_by_stmt<'tcx>(this: &Stmt<'tcx>, binding_name: Symbol) -> Op\n         }\n     }\n }\n-\n-/// Returns the vec of fields for a struct and an empty vec for non-struct ADTs.\n-fn fields_of_type(ty: Ty<'_>) -> Vec<Ident> {\n-    if let Adt(adt, _) = ty.kind() {\n-        if adt.is_struct() {\n-            let variant = &adt.non_enum_variant();\n-            return variant.fields.iter().map(|f| f.ident).collect();\n-        }\n-    }\n-    vec![]\n-}"}, {"sha": "3e0921022b4174cf4faa22bae70d821a0055dfc6", "filename": "tests/ui/field_reassign_with_default.rs", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/fa75f63690c9a7e0c2b491e3e1d13a3ed8eb5b0c/tests%2Fui%2Ffield_reassign_with_default.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fa75f63690c9a7e0c2b491e3e1d13a3ed8eb5b0c/tests%2Fui%2Ffield_reassign_with_default.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ffield_reassign_with_default.rs?ref=fa75f63690c9a7e0c2b491e3e1d13a3ed8eb5b0c", "patch": "@@ -107,4 +107,16 @@ fn main() {\n     x.i = side_effect.next();\n     x.j = 2;\n     x.i = side_effect.next();\n+\n+    // don't lint - some private fields\n+    let mut x = m::F::default();\n+    x.a = 1;\n+}\n+\n+mod m {\n+    #[derive(Default)]\n+    pub struct F {\n+        pub a: u64,\n+        b: u64,\n+    }\n }"}]}