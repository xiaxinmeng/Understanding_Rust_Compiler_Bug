{"sha": "5e7610378f5dce4f3cfdaf05fbafc962d000ffcd", "node_id": "C_kwDOAAsO6NoAKDVlNzYxMDM3OGY1ZGNlNGYzY2ZkYWYwNWZiYWZjOTYyZDAwMGZmY2Q", "commit": {"author": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2022-03-16T00:00:00Z"}, "committer": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2022-03-16T12:00:33Z"}, "message": "Reject `#[thread_local]` attribute on non-static items", "tree": {"sha": "293ff233b52ccb0739973ffd2756212d741bd33c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/293ff233b52ccb0739973ffd2756212d741bd33c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5e7610378f5dce4f3cfdaf05fbafc962d000ffcd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5e7610378f5dce4f3cfdaf05fbafc962d000ffcd", "html_url": "https://github.com/rust-lang/rust/commit/5e7610378f5dce4f3cfdaf05fbafc962d000ffcd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5e7610378f5dce4f3cfdaf05fbafc962d000ffcd/comments", "author": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d8e564715e0eb17130e99e8fcc92a36fce7feaf5", "url": "https://api.github.com/repos/rust-lang/rust/commits/d8e564715e0eb17130e99e8fcc92a36fce7feaf5", "html_url": "https://github.com/rust-lang/rust/commit/d8e564715e0eb17130e99e8fcc92a36fce7feaf5"}], "stats": {"total": 84, "additions": 84, "deletions": 0}, "files": [{"sha": "8c1d6188e7c82e91628281a3df3db5ad8f03a4be", "filename": "compiler/rustc_passes/src/check_attr.rs", "status": "modified", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/5e7610378f5dce4f3cfdaf05fbafc962d000ffcd/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5e7610378f5dce4f3cfdaf05fbafc962d000ffcd/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs?ref=5e7610378f5dce4f3cfdaf05fbafc962d000ffcd", "patch": "@@ -80,6 +80,7 @@ impl CheckAttrVisitor<'_> {\n                     self.check_rustc_must_implement_one_of(attr, span, target)\n                 }\n                 sym::target_feature => self.check_target_feature(hir_id, attr, span, target),\n+                sym::thread_local => self.check_thread_local(attr, span, target),\n                 sym::track_caller => {\n                     self.check_track_caller(hir_id, attr.span, attrs, span, target)\n                 }\n@@ -521,6 +522,21 @@ impl CheckAttrVisitor<'_> {\n         }\n     }\n \n+    /// Checks if the `#[thread_local]` attribute on `item` is valid. Returns `true` if valid.\n+    fn check_thread_local(&self, attr: &Attribute, span: Span, target: Target) -> bool {\n+        match target {\n+            Target::ForeignStatic | Target::Static => true,\n+            _ => {\n+                self.tcx\n+                    .sess\n+                    .struct_span_err(attr.span, \"attribute should be applied to a static\")\n+                    .span_label(span, \"not a static\")\n+                    .emit();\n+                false\n+            }\n+        }\n+    }\n+\n     fn doc_attr_str_error(&self, meta: &NestedMetaItem, attr_name: &str) {\n         self.tcx\n             .sess"}, {"sha": "f1c4273870bffdbdd0e830c2af39e7363714386d", "filename": "src/test/ui/thread-local/non-static.rs", "status": "added", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/5e7610378f5dce4f3cfdaf05fbafc962d000ffcd/src%2Ftest%2Fui%2Fthread-local%2Fnon-static.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5e7610378f5dce4f3cfdaf05fbafc962d000ffcd/src%2Ftest%2Fui%2Fthread-local%2Fnon-static.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fthread-local%2Fnon-static.rs?ref=5e7610378f5dce4f3cfdaf05fbafc962d000ffcd", "patch": "@@ -0,0 +1,30 @@\n+// Check that #[thread_local] attribute is rejected on non-static items.\n+#![feature(thread_local)]\n+\n+#[thread_local]\n+//~^ ERROR attribute should be applied to a static\n+const A: u32 = 0;\n+\n+#[thread_local]\n+//~^ ERROR attribute should be applied to a static\n+fn main() {\n+    #[thread_local] || {};\n+    //~^ ERROR attribute should be applied to a static\n+}\n+\n+struct S {\n+    #[thread_local]\n+    //~^ ERROR attribute should be applied to a static\n+    a: String,\n+    b: String,\n+}\n+\n+#[thread_local]\n+// Static. OK.\n+static B: u32 = 0;\n+\n+extern \"C\" {\n+    #[thread_local]\n+    // Foreign static. OK.\n+    static C: u32;\n+}"}, {"sha": "09a1618d6e710362fe8b8b0578a87a624f46717e", "filename": "src/test/ui/thread-local/non-static.stderr", "status": "added", "additions": 38, "deletions": 0, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/5e7610378f5dce4f3cfdaf05fbafc962d000ffcd/src%2Ftest%2Fui%2Fthread-local%2Fnon-static.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/5e7610378f5dce4f3cfdaf05fbafc962d000ffcd/src%2Ftest%2Fui%2Fthread-local%2Fnon-static.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fthread-local%2Fnon-static.stderr?ref=5e7610378f5dce4f3cfdaf05fbafc962d000ffcd", "patch": "@@ -0,0 +1,38 @@\n+error: attribute should be applied to a static\n+  --> $DIR/non-static.rs:4:1\n+   |\n+LL | #[thread_local]\n+   | ^^^^^^^^^^^^^^^\n+LL |\n+LL | const A: u32 = 0;\n+   | ----------------- not a static\n+\n+error: attribute should be applied to a static\n+  --> $DIR/non-static.rs:8:1\n+   |\n+LL |   #[thread_local]\n+   |   ^^^^^^^^^^^^^^^\n+LL |\n+LL | / fn main() {\n+LL | |     #[thread_local] || {};\n+LL | |\n+LL | | }\n+   | |_- not a static\n+\n+error: attribute should be applied to a static\n+  --> $DIR/non-static.rs:11:5\n+   |\n+LL |     #[thread_local] || {};\n+   |     ^^^^^^^^^^^^^^^ ----- not a static\n+\n+error: attribute should be applied to a static\n+  --> $DIR/non-static.rs:16:5\n+   |\n+LL |     #[thread_local]\n+   |     ^^^^^^^^^^^^^^^\n+LL |\n+LL |     a: String,\n+   |     --------- not a static\n+\n+error: aborting due to 4 previous errors\n+"}]}