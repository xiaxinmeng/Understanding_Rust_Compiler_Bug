{"sha": "418c6bcec35a5552f8732946819f792da75bf555", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQxOGM2YmNlYzM1YTU1NTJmODczMjk0NjgxOWY3OTJkYTc1YmY1NTU=", "commit": {"author": {"name": "Graydon Hoare", "email": "graydon@mozilla.com", "date": "2012-02-28T20:05:05Z"}, "committer": {"name": "Graydon Hoare", "email": "graydon@mozilla.com", "date": "2012-02-28T20:08:26Z"}, "message": "Only modify Makefile and config.mk if they change during configure.", "tree": {"sha": "711c99392302b3d1e3dc94433ec08ba0f542a5fd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/711c99392302b3d1e3dc94433ec08ba0f542a5fd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/418c6bcec35a5552f8732946819f792da75bf555", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/418c6bcec35a5552f8732946819f792da75bf555", "html_url": "https://github.com/rust-lang/rust/commit/418c6bcec35a5552f8732946819f792da75bf555", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/418c6bcec35a5552f8732946819f792da75bf555/comments", "author": {"login": "graydon", "id": 14097, "node_id": "MDQ6VXNlcjE0MDk3", "avatar_url": "https://avatars.githubusercontent.com/u/14097?v=4", "gravatar_id": "", "url": "https://api.github.com/users/graydon", "html_url": "https://github.com/graydon", "followers_url": "https://api.github.com/users/graydon/followers", "following_url": "https://api.github.com/users/graydon/following{/other_user}", "gists_url": "https://api.github.com/users/graydon/gists{/gist_id}", "starred_url": "https://api.github.com/users/graydon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/graydon/subscriptions", "organizations_url": "https://api.github.com/users/graydon/orgs", "repos_url": "https://api.github.com/users/graydon/repos", "events_url": "https://api.github.com/users/graydon/events{/privacy}", "received_events_url": "https://api.github.com/users/graydon/received_events", "type": "User", "site_admin": false}, "committer": {"login": "graydon", "id": 14097, "node_id": "MDQ6VXNlcjE0MDk3", "avatar_url": "https://avatars.githubusercontent.com/u/14097?v=4", "gravatar_id": "", "url": "https://api.github.com/users/graydon", "html_url": "https://github.com/graydon", "followers_url": "https://api.github.com/users/graydon/followers", "following_url": "https://api.github.com/users/graydon/following{/other_user}", "gists_url": "https://api.github.com/users/graydon/gists{/gist_id}", "starred_url": "https://api.github.com/users/graydon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/graydon/subscriptions", "organizations_url": "https://api.github.com/users/graydon/orgs", "repos_url": "https://api.github.com/users/graydon/repos", "events_url": "https://api.github.com/users/graydon/events{/privacy}", "received_events_url": "https://api.github.com/users/graydon/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1ed12f36028daea4cfc5ad267bc65a4f02fe4a29", "url": "https://api.github.com/repos/rust-lang/rust/commits/1ed12f36028daea4cfc5ad267bc65a4f02fe4a29", "html_url": "https://github.com/rust-lang/rust/commit/1ed12f36028daea4cfc5ad267bc65a4f02fe4a29"}], "stats": {"total": 39, "additions": 29, "deletions": 10}, "files": [{"sha": "16af7010377c854b2f8c94c2cd193e1e7486af87", "filename": "configure", "status": "modified", "additions": 29, "deletions": 10, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/418c6bcec35a5552f8732946819f792da75bf555/configure", "raw_url": "https://github.com/rust-lang/rust/raw/418c6bcec35a5552f8732946819f792da75bf555/configure", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/configure?ref=418c6bcec35a5552f8732946819f792da75bf555", "patch": "@@ -41,9 +41,26 @@ make_dir() {\n     fi\n }\n \n-copy() {\n-    msg \"cp $1 $2\"\n-    cp $1 $2\n+copy_if_changed() {\n+    if cmp -s $1 $2\n+    then\n+        msg \"leaving $2 unchanged\"\n+    else\n+        msg \"cp $1 $2\"\n+        cp $1 $2\n+        chmod u-w $1 # make copied artifact read-only\n+    fi\n+}\n+\n+move_if_changed() {\n+    if cmp -s $1 $2\n+    then\n+        msg \"leaving $2 unchanged\"\n+    else\n+        msg \"mv $1 $2\"\n+        mv $1 $2\n+        chmod u-w $1 # make moved artifact read-only\n+    fi\n }\n \n putvar() {\n@@ -56,7 +73,7 @@ putvar() {\n     else\n         printf \"configure: %-20s := %s\\n\" $1 \"$T\"\n     fi\n-    printf \"%-20s := %s\\n\" $1 \"$T\" >>config.mk\n+    printf \"%-20s := %s\\n\" $1 \"$T\" >>config.tmp\n }\n \n probe() {\n@@ -158,6 +175,7 @@ opt() {\n \n \n msg \"looking for configure programs\"\n+need_cmd cmp\n need_cmd mkdir\n need_cmd printf\n need_cmd cut\n@@ -250,8 +268,8 @@ then\n     echo \"Options:\"\n     echo \"\"\n else\n-    msg \"recreating config.mk\"\n-    echo '' >config.mk\n+    msg \"recreating config.tmp\"\n+    echo '' >config.tmp\n \n     step_msg \"processing $CFG_SELF args\"\n fi\n@@ -665,11 +683,12 @@ done\n \n # Munge any paths that appear in config.mk back to posix-y\n perl -i.bak -p -e 's@ ([a-zA-Z]):[/\\\\]@ /\\1/@go;' \\\n-               -e 's@\\\\@/@go;' config.mk\n-rm -f config.mk.bak\n+               -e 's@\\\\@/@go;' config.tmp\n+rm -f config.tmp.bak\n \n msg\n-copy ${CFG_SRC_DIR}Makefile.in ./Makefile\n-chmod u-w Makefile # it is generated, make it read-only\n+copy_if_changed ${CFG_SRC_DIR}Makefile.in ./Makefile\n+move_if_changed config.tmp config.mk\n+rm -f config.tmp\n \n step_msg \"complete\""}]}