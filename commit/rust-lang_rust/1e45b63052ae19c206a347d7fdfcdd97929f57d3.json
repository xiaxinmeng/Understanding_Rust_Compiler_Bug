{"sha": "1e45b63052ae19c206a347d7fdfcdd97929f57d3", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFlNDViNjMwNTJhZTE5YzIwNmEzNDdkN2ZkZmNkZDk3OTI5ZjU3ZDM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-11-23T23:48:44Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2016-11-23T23:48:44Z"}, "message": "Auto merge of #37931 - eddyb:meta-version, r=jseyfried\n\nrustc_metadata: don't break the version check when CrateRoot changes.\n\nIn #36551 I made `rustc_version` a field of `CrateRoot`, but despite it being the first field, one could still break the version check by changing `CrateRoot` so older compilers couldn't fully decode it (e.g. #37463).\n\nThis PR fixes #37803 by moving the version string back at the beginning of metadata, right after the 32-bit big-endian absolute position of `CrateRoot`, and by incrementing `METADATA_VERSION`.", "tree": {"sha": "a46a54b8acb8ab734b7f8b69d438ad34dfb69c34", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a46a54b8acb8ab734b7f8b69d438ad34dfb69c34"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1e45b63052ae19c206a347d7fdfcdd97929f57d3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1e45b63052ae19c206a347d7fdfcdd97929f57d3", "html_url": "https://github.com/rust-lang/rust/commit/1e45b63052ae19c206a347d7fdfcdd97929f57d3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1e45b63052ae19c206a347d7fdfcdd97929f57d3/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d5814b03e652043be607f96e24709e06c2b55429", "url": "https://api.github.com/repos/rust-lang/rust/commits/d5814b03e652043be607f96e24709e06c2b55429", "html_url": "https://github.com/rust-lang/rust/commit/d5814b03e652043be607f96e24709e06c2b55429"}, {"sha": "f4c68d2825535cbef847d0ac874ceced81cf2980", "url": "https://api.github.com/repos/rust-lang/rust/commits/f4c68d2825535cbef847d0ac874ceced81cf2980", "html_url": "https://github.com/rust-lang/rust/commit/f4c68d2825535cbef847d0ac874ceced81cf2980"}], "stats": {"total": 49, "additions": 31, "deletions": 18}, "files": [{"sha": "f59f2bcc074764c42bf61f55e5da3a6729239536", "filename": "src/librustc_metadata/decoder.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/1e45b63052ae19c206a347d7fdfcdd97929f57d3/src%2Flibrustc_metadata%2Fdecoder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e45b63052ae19c206a347d7fdfcdd97929f57d3/src%2Flibrustc_metadata%2Fdecoder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Fdecoder.rs?ref=1e45b63052ae19c206a347d7fdfcdd97929f57d3", "patch": "@@ -421,6 +421,10 @@ impl<'a, 'tcx> MetadataBlob {\n         self.raw_bytes().starts_with(METADATA_HEADER)\n     }\n \n+    pub fn get_rustc_version(&self) -> String {\n+        Lazy::with_position(METADATA_HEADER.len() + 4).decode(self)\n+    }\n+\n     pub fn get_root(&self) -> CrateRoot {\n         let slice = self.raw_bytes();\n         let offset = METADATA_HEADER.len();"}, {"sha": "665f3de0a3ba7fda9a389cc3c257d19f4ae19708", "filename": "src/librustc_metadata/encoder.rs", "status": "modified", "additions": 11, "deletions": 4, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/1e45b63052ae19c206a347d7fdfcdd97929f57d3/src%2Flibrustc_metadata%2Fencoder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e45b63052ae19c206a347d7fdfcdd97929f57d3/src%2Flibrustc_metadata%2Fencoder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Fencoder.rs?ref=1e45b63052ae19c206a347d7fdfcdd97929f57d3", "patch": "@@ -1278,7 +1278,6 @@ impl<'a, 'tcx> EncodeContext<'a, 'tcx> {\n         let link_meta = self.link_meta;\n         let is_proc_macro = tcx.sess.crate_types.borrow().contains(&CrateTypeProcMacro);\n         let root = self.lazy(&CrateRoot {\n-            rustc_version: rustc_version(),\n             name: link_meta.crate_name,\n             triple: tcx.sess.opts.target_triple.clone(),\n             hash: link_meta.crate_hash,\n@@ -1368,7 +1367,8 @@ pub fn encode_metadata<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>,\n     // Will be filed with the root position after encoding everything.\n     cursor.write_all(&[0, 0, 0, 0]).unwrap();\n \n-    let root = EncodeContext {\n+    let root = {\n+        let mut ecx = EncodeContext {\n             opaque: opaque::Encoder::new(&mut cursor),\n             tcx: tcx,\n             reexports: reexports,\n@@ -1378,8 +1378,15 @@ pub fn encode_metadata<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>,\n             lazy_state: LazyState::NoNode,\n             type_shorthands: Default::default(),\n             predicate_shorthands: Default::default(),\n-        }\n-        .encode_crate_root();\n+        };\n+\n+        // Encode the rustc version string in a predictable location.\n+        rustc_version().encode(&mut ecx).unwrap();\n+\n+        // Encode all the entries and extra information in the crate,\n+        // culminating in the `CrateRoot` which points to all of it.\n+        ecx.encode_crate_root()\n+    };\n     let mut result = cursor.into_inner();\n \n     // Encode the root position."}, {"sha": "868bc363791350d53e322af81e3e99c426157579", "filename": "src/librustc_metadata/locator.rs", "status": "modified", "additions": 11, "deletions": 10, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/1e45b63052ae19c206a347d7fdfcdd97929f57d3/src%2Flibrustc_metadata%2Flocator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e45b63052ae19c206a347d7fdfcdd97929f57d3/src%2Flibrustc_metadata%2Flocator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Flocator.rs?ref=1e45b63052ae19c206a347d7fdfcdd97929f57d3", "patch": "@@ -639,25 +639,26 @@ impl<'a> Context<'a> {\n     }\n \n     fn crate_matches(&mut self, metadata: &MetadataBlob, libpath: &Path) -> Option<Svh> {\n-        let root = metadata.get_root();\n-        if let Some(is_proc_macro) = self.is_proc_macro {\n-            if root.macro_derive_registrar.is_some() != is_proc_macro {\n-                return None;\n-            }\n-        }\n-\n         let rustc_version = rustc_version();\n-        if root.rustc_version != rustc_version {\n+        let found_version = metadata.get_rustc_version();\n+        if found_version != rustc_version {\n             info!(\"Rejecting via version: expected {} got {}\",\n                   rustc_version,\n-                  root.rustc_version);\n+                  found_version);\n             self.rejected_via_version.push(CrateMismatch {\n                 path: libpath.to_path_buf(),\n-                got: root.rustc_version,\n+                got: found_version,\n             });\n             return None;\n         }\n \n+        let root = metadata.get_root();\n+        if let Some(is_proc_macro) = self.is_proc_macro {\n+            if root.macro_derive_registrar.is_some() != is_proc_macro {\n+                return None;\n+            }\n+        }\n+\n         if self.should_match_name {\n             if self.crate_name != root.name {\n                 info!(\"Rejecting via crate name\");"}, {"sha": "32e89f64f0ec1516b2049e8f5a46bafefde83342", "filename": "src/librustc_metadata/schema.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/1e45b63052ae19c206a347d7fdfcdd97929f57d3/src%2Flibrustc_metadata%2Fschema.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e45b63052ae19c206a347d7fdfcdd97929f57d3/src%2Flibrustc_metadata%2Fschema.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_metadata%2Fschema.rs?ref=1e45b63052ae19c206a347d7fdfcdd97929f57d3", "patch": "@@ -34,15 +34,17 @@ pub fn rustc_version() -> String {\n \n /// Metadata encoding version.\n /// NB: increment this if you change the format of metadata such that\n-/// the rustc version can't be found to compare with `RUSTC_VERSION`.\n-pub const METADATA_VERSION: u8 = 3;\n+/// the rustc version can't be found to compare with `rustc_version()`.\n+pub const METADATA_VERSION: u8 = 4;\n \n /// Metadata header which includes `METADATA_VERSION`.\n /// To get older versions of rustc to ignore this metadata,\n /// there are 4 zero bytes at the start, which are treated\n /// as a length of 0 by old compilers.\n ///\n-/// This header is followed by the position of the `CrateRoot`.\n+/// This header is followed by the position of the `CrateRoot`,\n+/// which is encoded as a 32-bit big-endian unsigned integer,\n+/// and further followed by the rustc version string.\n pub const METADATA_HEADER: &'static [u8; 12] =\n     &[0, 0, 0, 0, b'r', b'u', b's', b't', 0, 0, 0, METADATA_VERSION];\n \n@@ -163,7 +165,6 @@ pub enum LazyState {\n \n #[derive(RustcEncodable, RustcDecodable)]\n pub struct CrateRoot {\n-    pub rustc_version: String,\n     pub name: Symbol,\n     pub triple: String,\n     pub hash: hir::svh::Svh,"}]}