{"sha": "bfccfdc78065752079a3863db19ca7148ade3e6f", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJmY2NmZGM3ODA2NTc1MjA3OWEzODYzZGIxOWNhNzE0OGFkZTNlNmY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-05-01T07:57:35Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-05-01T07:57:35Z"}, "message": "auto merge of #6144 : catamorphism/rust/mkdir_recursive-breakage, r=thestinger\n\nr? @brson or @thestinger : Added a change_dir_locked function to os, and use it in the\r\nmkdir_recursive tests so that the tests don't clobber each other's\r\ndirectory changes.", "tree": {"sha": "b836a4d48a9eb02362cacad524962a3c2467a6b2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b836a4d48a9eb02362cacad524962a3c2467a6b2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bfccfdc78065752079a3863db19ca7148ade3e6f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bfccfdc78065752079a3863db19ca7148ade3e6f", "html_url": "https://github.com/rust-lang/rust/commit/bfccfdc78065752079a3863db19ca7148ade3e6f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bfccfdc78065752079a3863db19ca7148ade3e6f/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "17ca13651a2bc6533413d80eb8941e5ddb20820e", "url": "https://api.github.com/repos/rust-lang/rust/commits/17ca13651a2bc6533413d80eb8941e5ddb20820e", "html_url": "https://github.com/rust-lang/rust/commit/17ca13651a2bc6533413d80eb8941e5ddb20820e"}, {"sha": "782e06e0e379768d03e35acae16e7ee1e1841633", "url": "https://api.github.com/repos/rust-lang/rust/commits/782e06e0e379768d03e35acae16e7ee1e1841633", "html_url": "https://github.com/rust-lang/rust/commit/782e06e0e379768d03e35acae16e7ee1e1841633"}], "stats": {"total": 80, "additions": 59, "deletions": 21}, "files": [{"sha": "0455dabb7f0138ebbb2ef32306e2c806f026aaf8", "filename": "src/libcore/os.rs", "status": "modified", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/bfccfdc78065752079a3863db19ca7148ade3e6f/src%2Flibcore%2Fos.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bfccfdc78065752079a3863db19ca7148ade3e6f/src%2Flibcore%2Fos.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fos.rs?ref=bfccfdc78065752079a3863db19ca7148ade3e6f", "patch": "@@ -818,6 +818,36 @@ pub fn change_dir(p: &Path) -> bool {\n     }\n }\n \n+/// Changes the current working directory to the specified\n+/// path while acquiring a global lock, then calls `action`.\n+/// If the change is successful, releases the lock and restores the\n+/// CWD to what it was before, returning true.\n+/// Returns false if the directory doesn't exist or if the directory change\n+/// is otherwise unsuccessful.\n+pub fn change_dir_locked(p: &Path, action: &fn()) -> bool {\n+    use unstable::global::global_data_clone_create;\n+    use unstable::{Exclusive, exclusive};\n+\n+    fn key(_: Exclusive<()>) { }\n+\n+    let result = unsafe {\n+        global_data_clone_create(key, || {\n+            ~exclusive(())\n+        })\n+    };\n+\n+    do result.with_imm() |_| {\n+        let old_dir = os::getcwd();\n+        if change_dir(p) {\n+            action();\n+            change_dir(&old_dir)\n+        }\n+        else {\n+            false\n+        }\n+    }\n+}\n+\n /// Copies a file from one location to another\n pub fn copy_file(from: &Path, to: &Path) -> bool {\n     return do_copy_file(from, to);"}, {"sha": "6da74834b1a49bbc736624b7acb968b845a08ed9", "filename": "src/libstd/tempfile.rs", "status": "modified", "additions": 29, "deletions": 21, "changes": 50, "blob_url": "https://github.com/rust-lang/rust/blob/bfccfdc78065752079a3863db19ca7148ade3e6f/src%2Flibstd%2Ftempfile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bfccfdc78065752079a3863db19ca7148ade3e6f/src%2Flibstd%2Ftempfile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Ftempfile.rs?ref=bfccfdc78065752079a3863db19ca7148ade3e6f", "patch": "@@ -42,13 +42,18 @@ mod tests {\n         use core::libc::consts::os::posix88::{S_IRUSR, S_IWUSR, S_IXUSR};\n         use core::os;\n \n-        let root = mkdtemp(&os::tmpdir(), \"temp\").expect(\"recursive_mkdir_rel\");\n-        os::change_dir(&root);\n-        let path = Path(\"frob\");\n-        assert!(os::mkdir_recursive(&path,  (S_IRUSR | S_IWUSR | S_IXUSR) as i32));\n-        assert!(os::path_is_dir(&path));\n-        assert!(os::mkdir_recursive(&path,  (S_IRUSR | S_IWUSR | S_IXUSR) as i32));\n-        assert!(os::path_is_dir(&path));\n+        let root = mkdtemp(&os::tmpdir(), \"recursive_mkdir_rel\").\n+            expect(\"recursive_mkdir_rel\");\n+        assert!(do os::change_dir_locked(&root) {\n+            let path = Path(\"frob\");\n+            debug!(\"recursive_mkdir_rel: Making: %s in cwd %s [%?]\", path.to_str(),\n+                   os::getcwd().to_str(),\n+                   os::path_exists(&path));\n+            assert!(os::mkdir_recursive(&path,  (S_IRUSR | S_IWUSR | S_IXUSR) as i32));\n+            assert!(os::path_is_dir(&path));\n+            assert!(os::mkdir_recursive(&path,  (S_IRUSR | S_IWUSR | S_IXUSR) as i32));\n+            assert!(os::path_is_dir(&path));\n+        });\n     }\n \n     #[test]\n@@ -67,18 +72,21 @@ mod tests {\n         use core::libc::consts::os::posix88::{S_IRUSR, S_IWUSR, S_IXUSR};\n         use core::os;\n \n-        let root = mkdtemp(&os::tmpdir(), \"temp\").expect(\"recursive_mkdir_rel_2\");\n-        os::change_dir(&root);\n-        let path = Path(\"./frob/baz\");\n-        debug!(\"...Making: %s in cwd %s\", path.to_str(), os::getcwd().to_str());\n-        assert!(os::mkdir_recursive(&path, (S_IRUSR | S_IWUSR | S_IXUSR) as i32));\n-        assert!(os::path_is_dir(&path));\n-        assert!(os::path_is_dir(&path.pop()));\n-        let path2 = Path(\"quux/blat\");\n-        debug!(\"Making: %s in cwd %s\", path2.to_str(), os::getcwd().to_str());\n-        assert!(os::mkdir_recursive(&path2, (S_IRUSR | S_IWUSR | S_IXUSR) as i32));\n-        assert!(os::path_is_dir(&path2));\n-        assert!(os::path_is_dir(&path2.pop()));\n+        let root = mkdtemp(&os::tmpdir(), \"recursive_mkdir_rel_2\").\n+            expect(\"recursive_mkdir_rel_2\");\n+        assert!(do os::change_dir_locked(&root) {\n+            let path = Path(\"./frob/baz\");\n+            debug!(\"recursive_mkdir_rel_2: Making: %s in cwd %s [%?]\", path.to_str(),\n+                   os::getcwd().to_str(), os::path_exists(&path));\n+            assert!(os::mkdir_recursive(&path, (S_IRUSR | S_IWUSR | S_IXUSR) as i32));\n+                assert!(os::path_is_dir(&path));\n+            assert!(os::path_is_dir(&path.pop()));\n+            let path2 = Path(\"quux/blat\");\n+            debug!(\"recursive_mkdir_rel_2: Making: %s in cwd %s\", path2.to_str(),\n+                   os::getcwd().to_str());\n+            assert!(os::mkdir_recursive(&path2, (S_IRUSR | S_IWUSR | S_IXUSR) as i32));\n+                assert!(os::path_is_dir(&path2));\n+            assert!(os::path_is_dir(&path2.pop()));\n+        });\n     }\n-\n-}\n\\ No newline at end of file\n+}"}]}