{"sha": "cadcd70775cf42b2add2526026a0a06c1ced411c", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNhZGNkNzA3NzVjZjQyYjJhZGQyNTI2MDI2YTBhMDZjMWNlZDQxMWM=", "commit": {"author": {"name": "Ulrik Sverdrup", "email": "bluss@users.noreply.github.com", "date": "2016-01-12T22:04:46Z"}, "committer": {"name": "Ulrik Sverdrup", "email": "bluss@users.noreply.github.com", "date": "2016-01-14T13:59:55Z"}, "message": "UTF-8 validation: Add missing if conditional for short input\n\nWe need to guard that `len` is large enough for the fast skip loop.", "tree": {"sha": "86e857e3000a21845f422e311fcd9dce6c21210e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/86e857e3000a21845f422e311fcd9dce6c21210e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cadcd70775cf42b2add2526026a0a06c1ced411c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cadcd70775cf42b2add2526026a0a06c1ced411c", "html_url": "https://github.com/rust-lang/rust/commit/cadcd70775cf42b2add2526026a0a06c1ced411c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cadcd70775cf42b2add2526026a0a06c1ced411c/comments", "author": {"login": "bluss", "id": 3209739, "node_id": "MDQ6VXNlcjMyMDk3Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/3209739?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bluss", "html_url": "https://github.com/bluss", "followers_url": "https://api.github.com/users/bluss/followers", "following_url": "https://api.github.com/users/bluss/following{/other_user}", "gists_url": "https://api.github.com/users/bluss/gists{/gist_id}", "starred_url": "https://api.github.com/users/bluss/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bluss/subscriptions", "organizations_url": "https://api.github.com/users/bluss/orgs", "repos_url": "https://api.github.com/users/bluss/repos", "events_url": "https://api.github.com/users/bluss/events{/privacy}", "received_events_url": "https://api.github.com/users/bluss/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bluss", "id": 3209739, "node_id": "MDQ6VXNlcjMyMDk3Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/3209739?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bluss", "html_url": "https://github.com/bluss", "followers_url": "https://api.github.com/users/bluss/followers", "following_url": "https://api.github.com/users/bluss/following{/other_user}", "gists_url": "https://api.github.com/users/bluss/gists{/gist_id}", "starred_url": "https://api.github.com/users/bluss/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bluss/subscriptions", "organizations_url": "https://api.github.com/users/bluss/orgs", "repos_url": "https://api.github.com/users/bluss/repos", "events_url": "https://api.github.com/users/bluss/events{/privacy}", "received_events_url": "https://api.github.com/users/bluss/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "11e3de39d9f3faa7bf119023be39c0afd580a9c4", "url": "https://api.github.com/repos/rust-lang/rust/commits/11e3de39d9f3faa7bf119023be39c0afd580a9c4", "html_url": "https://github.com/rust-lang/rust/commit/11e3de39d9f3faa7bf119023be39c0afd580a9c4"}], "stats": {"total": 29, "additions": 16, "deletions": 13}, "files": [{"sha": "d85212d25e792ee285149c6a79d250dedf1d9830", "filename": "src/libcore/str/mod.rs", "status": "modified", "additions": 16, "deletions": 13, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/cadcd70775cf42b2add2526026a0a06c1ced411c/src%2Flibcore%2Fstr%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cadcd70775cf42b2add2526026a0a06c1ced411c/src%2Flibcore%2Fstr%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fstr%2Fmod.rs?ref=cadcd70775cf42b2add2526026a0a06c1ced411c", "patch": "@@ -1158,24 +1158,27 @@ fn run_utf8_validation(v: &[u8]) -> Result<(), Utf8Error> {\n             offset += 1;\n         } else {\n             // Ascii case, try to skip forward quickly.\n+            // When the pointer is aligned, read 2 words of data per iteration\n+            // until we find a word containing a non-ascii byte.\n+            const BYTES_PER_ITERATION: usize = 2 * usize::BYTES;\n             let ptr = v.as_ptr();\n             let align = (ptr as usize + offset) & (usize::BYTES - 1);\n             if align == 0 {\n-                // When the pointer is aligned, read 2 words of data per iteration\n-                // until we find a word containing a non-ascii byte.\n-                while offset <= len - 2 * usize::BYTES {\n-                    unsafe {\n-                        let u = *(ptr.offset(offset as isize) as *const usize);\n-                        let v = *(ptr.offset((offset + usize::BYTES) as isize) as *const usize);\n-\n-                        // break if there is a nonascii byte\n-                        let zu = contains_nonascii(u);\n-                        let zv = contains_nonascii(v);\n-                        if zu || zv {\n-                            break;\n+                if len >= BYTES_PER_ITERATION {\n+                    while offset <= len - BYTES_PER_ITERATION {\n+                        unsafe {\n+                            let u = *(ptr.offset(offset as isize) as *const usize);\n+                            let v = *(ptr.offset((offset + usize::BYTES) as isize) as *const usize);\n+\n+                            // break if there is a nonascii byte\n+                            let zu = contains_nonascii(u);\n+                            let zv = contains_nonascii(v);\n+                            if zu || zv {\n+                                break;\n+                            }\n                         }\n+                        offset += BYTES_PER_ITERATION;\n                     }\n-                    offset += usize::BYTES * 2;\n                 }\n                 // step from the point where the wordwise loop stopped\n                 while offset < len && v[offset] < 128 {"}]}