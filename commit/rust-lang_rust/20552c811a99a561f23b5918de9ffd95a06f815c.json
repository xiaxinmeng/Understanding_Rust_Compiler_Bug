{"sha": "20552c811a99a561f23b5918de9ffd95a06f815c", "node_id": "MDY6Q29tbWl0NzI0NzEyOjIwNTUyYzgxMWE5OWE1NjFmMjNiNTkxOGRlOWZmZDk1YTA2ZjgxNWM=", "commit": {"author": {"name": "Joshua Nelson", "email": "jyn514@gmail.com", "date": "2020-05-30T15:35:35Z"}, "committer": {"name": "Joshua Nelson", "email": "jyn514@gmail.com", "date": "2020-06-26T11:23:39Z"}, "message": "Generate docs for links to private items when passed --document-private\n\n- Pass around document_private a lot more\n- Add tests\n  + Add tests for intra-doc links to private items\n  + Add ignored tests for warnings in reference links", "tree": {"sha": "2fa2643d99978dd3977b027846dca887f2c2fcdf", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2fa2643d99978dd3977b027846dca887f2c2fcdf"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/20552c811a99a561f23b5918de9ffd95a06f815c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/20552c811a99a561f23b5918de9ffd95a06f815c", "html_url": "https://github.com/rust-lang/rust/commit/20552c811a99a561f23b5918de9ffd95a06f815c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/20552c811a99a561f23b5918de9ffd95a06f815c/comments", "author": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6f8bec93990434b5da5060f05d1e9fa7116bc743", "url": "https://api.github.com/repos/rust-lang/rust/commits/6f8bec93990434b5da5060f05d1e9fa7116bc743", "html_url": "https://github.com/rust-lang/rust/commit/6f8bec93990434b5da5060f05d1e9fa7116bc743"}], "stats": {"total": 105, "additions": 78, "deletions": 27}, "files": [{"sha": "35b15cf717cee1270b687315e450e8dacf8717c7", "filename": "src/librustdoc/config.rs", "status": "modified", "additions": 6, "deletions": 8, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/20552c811a99a561f23b5918de9ffd95a06f815c/src%2Flibrustdoc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/20552c811a99a561f23b5918de9ffd95a06f815c/src%2Flibrustdoc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fconfig.rs?ref=20552c811a99a561f23b5918de9ffd95a06f815c", "patch": "@@ -123,10 +123,6 @@ pub struct Options {\n     ///\n     /// Be aware: This option can come both from the CLI and from crate attributes!\n     pub default_passes: DefaultPassOption,\n-    /// Document items that have lower than `pub` visibility.\n-    pub document_private: bool,\n-    /// Document items that have `doc(hidden)`.\n-    pub document_hidden: bool,\n     /// Any passes manually selected by the user.\n     ///\n     /// Be aware: This option can come both from the CLI and from crate attributes!\n@@ -177,8 +173,6 @@ impl fmt::Debug for Options {\n             .field(\"test_args\", &self.test_args)\n             .field(\"persist_doctests\", &self.persist_doctests)\n             .field(\"default_passes\", &self.default_passes)\n-            .field(\"document_private\", &self.document_private)\n-            .field(\"document_hidden\", &self.document_hidden)\n             .field(\"manual_passes\", &self.manual_passes)\n             .field(\"display_warnings\", &self.display_warnings)\n             .field(\"show_coverage\", &self.show_coverage)\n@@ -250,6 +244,10 @@ pub struct RenderOptions {\n     pub generate_search_filter: bool,\n     /// Option (disabled by default) to generate files used by RLS and some other tools.\n     pub generate_redirect_pages: bool,\n+    /// Document items that have lower than `pub` visibility.\n+    pub document_private: bool,\n+    /// Document items that have `doc(hidden)`.\n+    pub document_hidden: bool,\n }\n \n impl Options {\n@@ -567,8 +565,6 @@ impl Options {\n             should_test,\n             test_args,\n             default_passes,\n-            document_private,\n-            document_hidden,\n             manual_passes,\n             display_warnings,\n             show_coverage,\n@@ -597,6 +593,8 @@ impl Options {\n                 markdown_playground_url,\n                 generate_search_filter,\n                 generate_redirect_pages,\n+                document_private,\n+                document_hidden,\n             },\n             output_format,\n         })"}, {"sha": "8ab6c74289d1798d1f7ada7bb0e73d8a15bf5e2e", "filename": "src/librustdoc/core.rs", "status": "modified", "additions": 8, "deletions": 7, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/20552c811a99a561f23b5918de9ffd95a06f815c/src%2Flibrustdoc%2Fcore.rs", "raw_url": "https://github.com/rust-lang/rust/raw/20552c811a99a561f23b5918de9ffd95a06f815c/src%2Flibrustdoc%2Fcore.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fcore.rs?ref=20552c811a99a561f23b5918de9ffd95a06f815c", "patch": "@@ -62,6 +62,8 @@ pub struct DocContext<'tcx> {\n     // FIXME(eddyb) make this a `ty::TraitRef<'tcx>` set.\n     pub generated_synthetics: RefCell<FxHashSet<(Ty<'tcx>, DefId)>>,\n     pub auto_traits: Vec<DefId>,\n+    /// The options given to rustdoc that could be relevant to a pass.\n+    pub render_options: RenderOptions,\n }\n \n impl<'tcx> DocContext<'tcx> {\n@@ -281,8 +283,6 @@ pub fn run_core(options: RustdocOptions) -> (clean::Crate, RenderInfo, RenderOpt\n         describe_lints,\n         lint_cap,\n         mut default_passes,\n-        mut document_private,\n-        document_hidden,\n         mut manual_passes,\n         display_warnings,\n         render_options,\n@@ -448,6 +448,7 @@ pub fn run_core(options: RustdocOptions) -> (clean::Crate, RenderInfo, RenderOpt\n                         .cloned()\n                         .filter(|trait_def_id| tcx.trait_is_auto(*trait_def_id))\n                         .collect(),\n+                    render_options,\n                 };\n                 debug!(\"crate: {:?}\", tcx.hir().krate());\n \n@@ -524,7 +525,7 @@ pub fn run_core(options: RustdocOptions) -> (clean::Crate, RenderInfo, RenderOpt\n                     }\n \n                     if attr.is_word() && name == sym::document_private_items {\n-                        document_private = true;\n+                        ctxt.render_options.document_private = true;\n                     }\n                 }\n \n@@ -544,9 +545,9 @@ pub fn run_core(options: RustdocOptions) -> (clean::Crate, RenderInfo, RenderOpt\n                 for p in passes {\n                     let run = match p.condition {\n                         Always => true,\n-                        WhenDocumentPrivate => document_private,\n-                        WhenNotDocumentPrivate => !document_private,\n-                        WhenNotDocumentHidden => !document_hidden,\n+                        WhenDocumentPrivate => ctxt.render_options.document_private,\n+                        WhenNotDocumentPrivate => !ctxt.render_options.document_private,\n+                        WhenNotDocumentHidden => !ctxt.render_options.document_hidden,\n                     };\n                     if run {\n                         debug!(\"running pass {}\", p.pass.name);\n@@ -556,7 +557,7 @@ pub fn run_core(options: RustdocOptions) -> (clean::Crate, RenderInfo, RenderOpt\n \n                 ctxt.sess().abort_if_errors();\n \n-                (krate, ctxt.renderinfo.into_inner(), render_options)\n+                (krate, ctxt.renderinfo.into_inner(), ctxt.render_options)\n             })\n         })\n     })"}, {"sha": "a453a8b3dcb2ae23cec835fe71c990c960740a9d", "filename": "src/librustdoc/html/format.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/20552c811a99a561f23b5918de9ffd95a06f815c/src%2Flibrustdoc%2Fhtml%2Fformat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/20552c811a99a561f23b5918de9ffd95a06f815c/src%2Flibrustdoc%2Fhtml%2Fformat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fformat.rs?ref=20552c811a99a561f23b5918de9ffd95a06f815c", "patch": "@@ -468,7 +468,7 @@ impl clean::Path {\n \n pub fn href(did: DefId) -> Option<(String, ItemType, Vec<String>)> {\n     let cache = cache();\n-    if !did.is_local() && !cache.access_levels.is_public(did) {\n+    if !did.is_local() && !cache.access_levels.is_public(did) && !cache.document_private {\n         return None;\n     }\n "}, {"sha": "04c4685213b2e7df6ad05df902306e7c7156afef", "filename": "src/librustdoc/html/render.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/20552c811a99a561f23b5918de9ffd95a06f815c/src%2Flibrustdoc%2Fhtml%2Frender.rs", "raw_url": "https://github.com/rust-lang/rust/raw/20552c811a99a561f23b5918de9ffd95a06f815c/src%2Flibrustdoc%2Fhtml%2Frender.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender.rs?ref=20552c811a99a561f23b5918de9ffd95a06f815c", "patch": "@@ -469,6 +469,7 @@ pub fn run(\n         static_root_path,\n         generate_search_filter,\n         generate_redirect_pages,\n+        document_private,\n         ..\n     } = options;\n \n@@ -546,7 +547,7 @@ pub fn run(\n     scx.ensure_dir(&dst)?;\n     krate = sources::render(&dst, &mut scx, krate)?;\n     let (new_crate, index, cache) =\n-        Cache::from_krate(renderinfo, &extern_html_root_urls, &dst, krate);\n+        Cache::from_krate(renderinfo, document_private, &extern_html_root_urls, &dst, krate);\n     krate = new_crate;\n     let cache = Arc::new(cache);\n     let mut cx = Context {"}, {"sha": "1b5c8a9378e41efbd55ce77343bd0817b63e86e7", "filename": "src/librustdoc/html/render/cache.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/20552c811a99a561f23b5918de9ffd95a06f815c/src%2Flibrustdoc%2Fhtml%2Frender%2Fcache.rs", "raw_url": "https://github.com/rust-lang/rust/raw/20552c811a99a561f23b5918de9ffd95a06f815c/src%2Flibrustdoc%2Fhtml%2Frender%2Fcache.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fcache.rs?ref=20552c811a99a561f23b5918de9ffd95a06f815c", "patch": "@@ -91,6 +91,10 @@ crate struct Cache {\n     /// The version of the crate being documented, if given from the `--crate-version` flag.\n     pub crate_version: Option<String>,\n \n+    /// Whether to document private items.\n+    /// This is stored in `Cache` so it doesn't need to be passed through all rustdoc functions.\n+    pub document_private: bool,\n+\n     // Private fields only used when initially crawling a crate to build a cache\n     stack: Vec<String>,\n     parent_stack: Vec<DefId>,\n@@ -126,6 +130,7 @@ crate struct Cache {\n impl Cache {\n     pub fn from_krate(\n         renderinfo: RenderInfo,\n+        document_private: bool,\n         extern_html_root_urls: &BTreeMap<String, String>,\n         dst: &Path,\n         mut krate: clean::Crate,\n@@ -160,6 +165,7 @@ impl Cache {\n             stripped_mod: false,\n             access_levels,\n             crate_version: krate.version.take(),\n+            document_private,\n             orphan_impl_items: Vec::new(),\n             orphan_trait_impls: Vec::new(),\n             traits: krate.external_traits.replace(Default::default()),"}, {"sha": "de6fa3dbd4a89135d7a83f8843f49d148c51ce9e", "filename": "src/librustdoc/lib.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/20552c811a99a561f23b5918de9ffd95a06f815c/src%2Flibrustdoc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/20552c811a99a561f23b5918de9ffd95a06f815c/src%2Flibrustdoc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Flib.rs?ref=20552c811a99a561f23b5918de9ffd95a06f815c", "patch": "@@ -34,7 +34,6 @@ extern crate rustc_metadata;\n extern crate rustc_middle;\n extern crate rustc_mir;\n extern crate rustc_parse;\n-extern crate rustc_privacy;\n extern crate rustc_resolve;\n extern crate rustc_session;\n extern crate rustc_span as rustc_span;"}, {"sha": "e4fe8996a233f338eea4e1fc8b7b6701c85df208", "filename": "src/librustdoc/passes/collect_intra_doc_links.rs", "status": "modified", "additions": 19, "deletions": 9, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/20552c811a99a561f23b5918de9ffd95a06f815c/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs", "raw_url": "https://github.com/rust-lang/rust/raw/20552c811a99a561f23b5918de9ffd95a06f815c/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs?ref=20552c811a99a561f23b5918de9ffd95a06f815c", "patch": "@@ -204,7 +204,10 @@ impl<'a, 'tcx> LinkCollector<'a, 'tcx> {\n                         return Ok((res, Some(path_str.to_owned())));\n                     }\n                     other => {\n-                        debug!(\"failed to resolve {} in namespace {:?} (got {:?})\", path_str, ns, other);\n+                        debug!(\n+                            \"failed to resolve {} in namespace {:?} (got {:?})\",\n+                            path_str, ns, other\n+                        );\n                         debug!(\"extra_fragment is {:?}\", extra_fragment);\n                         return Ok((res, extra_fragment.clone()));\n                     }\n@@ -564,10 +567,9 @@ impl<'a, 'tcx> DocFolder for LinkCollector<'a, 'tcx> {\n             let mut path_str;\n             let (res, fragment) = {\n                 let mut kind = None;\n-                path_str = if let Some(prefix) =\n-                    [\"struct@\", \"enum@\", \"type@\", \"trait@\", \"union@\"]\n-                        .iter()\n-                        .find(|p| link.starts_with(**p))\n+                path_str = if let Some(prefix) = [\"struct@\", \"enum@\", \"type@\", \"trait@\", \"union@\"]\n+                    .iter()\n+                    .find(|p| link.starts_with(**p))\n                 {\n                     kind = Some(TypeNS);\n                     link.trim_start_matches(prefix)\n@@ -766,22 +768,30 @@ impl<'a, 'tcx> DocFolder for LinkCollector<'a, 'tcx> {\n             if let Res::PrimTy(_) = res {\n                 item.attrs.links.push((ori_link, None, fragment));\n             } else {\n-                // ~~WRONG: TODO: I think this happens too late and we need to instead put this in `self.resolve`~~\n-                debug!(\"item {:?} resolved to {:?}\", item, res);\n+                debug!(\"linked item {} resolved to {:?}\", path_str, res);\n                 if let Some(local) = res.opt_def_id().and_then(|def_id| def_id.as_local()) {\n+                    use rustc_hir::def_id::LOCAL_CRATE;\n+\n                     let hir_id = self.cx.tcx.hir().as_local_hir_id(local);\n-                    if !self.cx.tcx.privacy_access_levels(rustc_hir::def_id::LOCAL_CRATE).is_exported(hir_id) {\n+                    if !self.cx.tcx.privacy_access_levels(LOCAL_CRATE).is_exported(hir_id)\n+                        && !self.cx.render_options.document_private\n+                    {\n                         let item_name = item.name.as_deref().unwrap_or(\"<unknown>\");\n+                        let err_msg = format!(\n+                            \"public documentation for `{}` links to a private item\",\n+                            item_name\n+                        );\n                         build_diagnostic(\n                             cx,\n                             &item,\n                             path_str,\n                             &dox,\n                             link_range,\n-                            &format!(\"public documentation for `{}` links to a private item\", item_name),\n+                            &err_msg,\n                             \"this item is private\",\n                             None,\n                         );\n+                        continue;\n                     }\n                 }\n                 let id = register_res(cx, res);"}, {"sha": "0a8dafdaf94667ef591fcc5f9ad5f8fd00c28cb3", "filename": "src/test/rustdoc-ui/intra-links-private.public.stderr", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/20552c811a99a561f23b5918de9ffd95a06f815c/src%2Ftest%2Frustdoc-ui%2Fintra-links-private.public.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/20552c811a99a561f23b5918de9ffd95a06f815c/src%2Ftest%2Frustdoc-ui%2Fintra-links-private.public.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fintra-links-private.public.stderr?ref=20552c811a99a561f23b5918de9ffd95a06f815c", "patch": "@@ -0,0 +1,10 @@\n+warning: `[DontDocMe]` public documentation for `DocMe` links to a private item\n+  --> $DIR/intra-links-private.rs:6:11\n+   |\n+LL | /// docs [DontDocMe]\n+   |           ^^^^^^^^^ this item is private\n+   |\n+   = note: `#[warn(intra_doc_link_resolution_failure)]` on by default\n+\n+warning: 1 warning emitted\n+"}, {"sha": "b7906aba5b1a9c27265a2b17ae1ae8a6045c3885", "filename": "src/test/rustdoc-ui/intra-links-private.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/20552c811a99a561f23b5918de9ffd95a06f815c/src%2Ftest%2Frustdoc-ui%2Fintra-links-private.rs", "raw_url": "https://github.com/rust-lang/rust/raw/20552c811a99a561f23b5918de9ffd95a06f815c/src%2Ftest%2Frustdoc-ui%2Fintra-links-private.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fintra-links-private.rs?ref=20552c811a99a561f23b5918de9ffd95a06f815c", "patch": "@@ -0,0 +1,10 @@\n+// check-pass\n+// revisions: public private\n+// [private]compile-flags: --document-private-items\n+#![cfg_attr(private, deny(intra_doc_resolution_failure))]\n+\n+/// docs [DontDocMe]\n+//[public]~^ WARNING `[DontDocMe]` public documentation for `DocMe` links to a private item\n+// FIXME: for [private] we should also make sure the link was actually generated\n+pub struct DocMe;\n+struct DontDocMe;"}, {"sha": "21cb7eb9040bdecead088b4b46b3defe7705056c", "filename": "src/test/rustdoc-ui/reference-link-has-one-warning.rs", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/20552c811a99a561f23b5918de9ffd95a06f815c/src%2Ftest%2Frustdoc-ui%2Freference-link-has-one-warning.rs", "raw_url": "https://github.com/rust-lang/rust/raw/20552c811a99a561f23b5918de9ffd95a06f815c/src%2Ftest%2Frustdoc-ui%2Freference-link-has-one-warning.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Freference-link-has-one-warning.rs?ref=20552c811a99a561f23b5918de9ffd95a06f815c", "patch": "@@ -0,0 +1,6 @@\n+// ignore-test\n+// check-pass\n+\n+/// docs [label][with#anchor#error]\n+//~^ WARNING has an issue with the link anchor\n+pub struct S;"}, {"sha": "5bbc62b76dd044fc85f91a8ea7143c855e70bc7d", "filename": "src/test/rustdoc-ui/reference-link-has-one-warning.stderr", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/20552c811a99a561f23b5918de9ffd95a06f815c/src%2Ftest%2Frustdoc-ui%2Freference-link-has-one-warning.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/20552c811a99a561f23b5918de9ffd95a06f815c/src%2Ftest%2Frustdoc-ui%2Freference-link-has-one-warning.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Freference-link-has-one-warning.stderr?ref=20552c811a99a561f23b5918de9ffd95a06f815c", "patch": "@@ -0,0 +1,10 @@\n+warning: `[with#anchor#error]` has an issue with the link anchor.\n+  --> $DIR/reference-link-has-one-warning.rs:3:18\n+   |\n+LL | /// docs [label][with#anchor#error]\n+   |                  ^^^^^^^^^^^^^^^^^ only one `#` is allowed in a link\n+   |\n+   = note: `#[warn(intra_doc_link_resolution_failure)]` on by default\n+\n+warning: 1 warning emitted\n+"}]}