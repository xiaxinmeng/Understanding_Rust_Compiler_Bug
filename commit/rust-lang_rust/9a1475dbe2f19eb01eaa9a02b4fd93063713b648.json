{"sha": "9a1475dbe2f19eb01eaa9a02b4fd93063713b648", "node_id": "C_kwDOAAsO6NoAKDlhMTQ3NWRiZTJmMTllYjAxZWFhOWEwMmI0ZmQ5MzA2MzcxM2I2NDg", "commit": {"author": {"name": "Ben Kimock", "email": "kimockb@gmail.com", "date": "2022-05-22T23:39:09Z"}, "committer": {"name": "Ben Kimock", "email": "kimockb@gmail.com", "date": "2022-05-29T20:45:26Z"}, "message": "Save a created event for zero-size reborrows", "tree": {"sha": "b067d21060b72c580708cba1765e06f6fe7e6685", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b067d21060b72c580708cba1765e06f6fe7e6685"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9a1475dbe2f19eb01eaa9a02b4fd93063713b648", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9a1475dbe2f19eb01eaa9a02b4fd93063713b648", "html_url": "https://github.com/rust-lang/rust/commit/9a1475dbe2f19eb01eaa9a02b4fd93063713b648", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9a1475dbe2f19eb01eaa9a02b4fd93063713b648/comments", "author": {"login": "saethlin", "id": 12105168, "node_id": "MDQ6VXNlcjEyMTA1MTY4", "avatar_url": "https://avatars.githubusercontent.com/u/12105168?v=4", "gravatar_id": "", "url": "https://api.github.com/users/saethlin", "html_url": "https://github.com/saethlin", "followers_url": "https://api.github.com/users/saethlin/followers", "following_url": "https://api.github.com/users/saethlin/following{/other_user}", "gists_url": "https://api.github.com/users/saethlin/gists{/gist_id}", "starred_url": "https://api.github.com/users/saethlin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/saethlin/subscriptions", "organizations_url": "https://api.github.com/users/saethlin/orgs", "repos_url": "https://api.github.com/users/saethlin/repos", "events_url": "https://api.github.com/users/saethlin/events{/privacy}", "received_events_url": "https://api.github.com/users/saethlin/received_events", "type": "User", "site_admin": false}, "committer": {"login": "saethlin", "id": 12105168, "node_id": "MDQ6VXNlcjEyMTA1MTY4", "avatar_url": "https://avatars.githubusercontent.com/u/12105168?v=4", "gravatar_id": "", "url": "https://api.github.com/users/saethlin", "html_url": "https://github.com/saethlin", "followers_url": "https://api.github.com/users/saethlin/followers", "following_url": "https://api.github.com/users/saethlin/following{/other_user}", "gists_url": "https://api.github.com/users/saethlin/gists{/gist_id}", "starred_url": "https://api.github.com/users/saethlin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/saethlin/subscriptions", "organizations_url": "https://api.github.com/users/saethlin/orgs", "repos_url": "https://api.github.com/users/saethlin/repos", "events_url": "https://api.github.com/users/saethlin/events{/privacy}", "received_events_url": "https://api.github.com/users/saethlin/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5c3e4b6556431c816d05b262a890905a2a50841a", "url": "https://api.github.com/repos/rust-lang/rust/commits/5c3e4b6556431c816d05b262a890905a2a50841a", "html_url": "https://github.com/rust-lang/rust/commit/5c3e4b6556431c816d05b262a890905a2a50841a"}], "stats": {"total": 27, "additions": 25, "deletions": 2}, "files": [{"sha": "2eba35118388e70b9a10e81488fd4c11f11930b5", "filename": "src/stacked_borrows.rs", "status": "modified", "additions": 20, "deletions": 1, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/9a1475dbe2f19eb01eaa9a02b4fd93063713b648/src%2Fstacked_borrows.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9a1475dbe2f19eb01eaa9a02b4fd93063713b648/src%2Fstacked_borrows.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fstacked_borrows.rs?ref=9a1475dbe2f19eb01eaa9a02b4fd93063713b648", "patch": "@@ -706,7 +706,26 @@ trait EvalContextPrivExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n     ) -> InterpResult<'tcx> {\n         let this = self.eval_context_mut();\n         if size == Size::ZERO {\n-            // Nothing to do for zero-sized accesses.\n+            // Don't update any stacks for a zero-sized access; borrow stacks are per-byte and this\n+            // touches no bytes so there is no stack to put this tag in.\n+            // However, if the pointer for this operation points at a real allocation we still\n+            // record where it was created so that we can issue a helpful diagnostic if there is an\n+            // attempt to use it for a non-zero-sized access.\n+            // Dangling slices are a common case here; it's valid to get their length but with raw\n+            // pointer tagging for example all calls to get_unchecked on them are invalid.\n+            if let Ok((alloc_id, base_offset, orig_tag)) = this.ptr_try_get_alloc_id(place.ptr) {\n+                let extra = this.get_alloc_extra(alloc_id)?;\n+                let stacked_borrows =\n+                    extra.stacked_borrows.as_ref().expect(\"we should have Stacked Borrows data\");\n+                let mut alloc_history = stacked_borrows.history.borrow_mut();\n+                alloc_history.log_creation(\n+                    Some(orig_tag),\n+                    new_tag,\n+                    alloc_range(base_offset, Size::ZERO),\n+                    &mut this.machine.current_span(),\n+                );\n+            }\n+\n             trace!(\n                 \"reborrow of size 0: {} reference {:?} derived from {:?} (pointee {})\",\n                 kind,"}, {"sha": "c6b4dc16b797b0b7e6660f3897f701434fa7a3da", "filename": "tests/compile-fail/stacked_borrows/zst_slice.stderr", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/9a1475dbe2f19eb01eaa9a02b4fd93063713b648/tests%2Fcompile-fail%2Fstacked_borrows%2Fzst_slice.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/9a1475dbe2f19eb01eaa9a02b4fd93063713b648/tests%2Fcompile-fail%2Fstacked_borrows%2Fzst_slice.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Fstacked_borrows%2Fzst_slice.stderr?ref=9a1475dbe2f19eb01eaa9a02b4fd93063713b648", "patch": "@@ -2,7 +2,11 @@ error: Undefined Behavior: trying to reborrow <TAG> for SharedReadOnly permissio\n    |\n    = help: this indicates a potential bug in the program: it performed an invalid operation, but the rules it violated are still experimental\n    = help: see https://github.com/rust-lang/unsafe-code-guidelines/blob/master/wip/stacked-borrows.md for further information\n-           \n+help: <TAG> was created by a retag at offsets [0x0..0x0]\n+  --> $DIR/zst_slice.rs:LL:CC\n+   |\n+LL |         assert_eq!(*s.get_unchecked(1), 2);\n+   |                     ^^^^^^^^^^^^^^^^^^\n    = note: inside `core::slice::<impl [i32]>::get_unchecked::<usize>` at rustc_src/src/slice/mod.rs:LL:CC\n note: inside `main` at $DIR/zst_slice.rs:LL:CC\n   --> $DIR/zst_slice.rs:LL:CC"}]}