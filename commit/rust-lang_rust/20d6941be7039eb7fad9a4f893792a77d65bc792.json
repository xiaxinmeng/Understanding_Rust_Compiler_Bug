{"sha": "20d6941be7039eb7fad9a4f893792a77d65bc792", "node_id": "MDY6Q29tbWl0NzI0NzEyOjIwZDY5NDFiZTcwMzllYjdmYWQ5YTRmODkzNzkyYTc3ZDY1YmM3OTI=", "commit": {"author": {"name": "Bastian Kauschke", "email": "bastian_kauschke@hotmail.de", "date": "2020-07-04T12:02:41Z"}, "committer": {"name": "Bastian Kauschke", "email": "bastian_kauschke@hotmail.de", "date": "2020-07-04T12:02:41Z"}, "message": "ConstCx to LocalDefId", "tree": {"sha": "e75dc808aec7d4b23cbca625a372a39d9f3634a8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e75dc808aec7d4b23cbca625a372a39d9f3634a8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/20d6941be7039eb7fad9a4f893792a77d65bc792", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/20d6941be7039eb7fad9a4f893792a77d65bc792", "html_url": "https://github.com/rust-lang/rust/commit/20d6941be7039eb7fad9a4f893792a77d65bc792", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/20d6941be7039eb7fad9a4f893792a77d65bc792/comments", "author": {"login": "lcnr", "id": 29864074, "node_id": "MDQ6VXNlcjI5ODY0MDc0", "avatar_url": "https://avatars.githubusercontent.com/u/29864074?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lcnr", "html_url": "https://github.com/lcnr", "followers_url": "https://api.github.com/users/lcnr/followers", "following_url": "https://api.github.com/users/lcnr/following{/other_user}", "gists_url": "https://api.github.com/users/lcnr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lcnr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lcnr/subscriptions", "organizations_url": "https://api.github.com/users/lcnr/orgs", "repos_url": "https://api.github.com/users/lcnr/repos", "events_url": "https://api.github.com/users/lcnr/events{/privacy}", "received_events_url": "https://api.github.com/users/lcnr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lcnr", "id": 29864074, "node_id": "MDQ6VXNlcjI5ODY0MDc0", "avatar_url": "https://avatars.githubusercontent.com/u/29864074?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lcnr", "html_url": "https://github.com/lcnr", "followers_url": "https://api.github.com/users/lcnr/followers", "following_url": "https://api.github.com/users/lcnr/following{/other_user}", "gists_url": "https://api.github.com/users/lcnr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lcnr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lcnr/subscriptions", "organizations_url": "https://api.github.com/users/lcnr/orgs", "repos_url": "https://api.github.com/users/lcnr/repos", "events_url": "https://api.github.com/users/lcnr/events{/privacy}", "received_events_url": "https://api.github.com/users/lcnr/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0cd7ff7ddfb75a38dca81ad3e76b1e984129e939", "url": "https://api.github.com/repos/rust-lang/rust/commits/0cd7ff7ddfb75a38dca81ad3e76b1e984129e939", "html_url": "https://github.com/rust-lang/rust/commit/0cd7ff7ddfb75a38dca81ad3e76b1e984129e939"}], "stats": {"total": 54, "additions": 25, "deletions": 29}, "files": [{"sha": "75067ffa4b338d64b73c627b8d98008325673d22", "filename": "src/librustc_mir/const_eval/eval_queries.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/20d6941be7039eb7fad9a4f893792a77d65bc792/src%2Flibrustc_mir%2Fconst_eval%2Feval_queries.rs", "raw_url": "https://github.com/rust-lang/rust/raw/20d6941be7039eb7fad9a4f893792a77d65bc792/src%2Flibrustc_mir%2Fconst_eval%2Feval_queries.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fconst_eval%2Feval_queries.rs?ref=20d6941be7039eb7fad9a4f893792a77d65bc792", "patch": "@@ -334,9 +334,9 @@ pub fn const_eval_raw_provider<'tcx>(\n                 }\n \n                 v\n-            } else if def_id.is_local() {\n+            } else if let Some(def_id) = def_id.as_local() {\n                 // constant defined in this crate, we can figure out a lint level!\n-                match tcx.def_kind(def_id) {\n+                match tcx.def_kind(def_id.to_def_id()) {\n                     // constants never produce a hard error at the definition site. Anything else is\n                     // a backwards compatibility hazard (and will break old versions of winapi for\n                     // sure)\n@@ -346,7 +346,7 @@ pub fn const_eval_raw_provider<'tcx>(\n                     // validation thus preventing such a hard error from being a backwards\n                     // compatibility hazard\n                     DefKind::Const | DefKind::AssocConst => {\n-                        let hir_id = tcx.hir().as_local_hir_id(def_id.expect_local());\n+                        let hir_id = tcx.hir().as_local_hir_id(def_id);\n                         err.report_as_lint(\n                             tcx.at(tcx.def_span(def_id)),\n                             \"any use of this value will cause an error\",\n@@ -369,7 +369,7 @@ pub fn const_eval_raw_provider<'tcx>(\n                                 err.report_as_lint(\n                                     tcx.at(span),\n                                     \"reaching this expression at runtime will panic or abort\",\n-                                    tcx.hir().as_local_hir_id(def_id.expect_local()),\n+                                    tcx.hir().as_local_hir_id(def_id),\n                                     Some(err.span),\n                                 )\n                             }"}, {"sha": "81c1b0b5bd49f6443144776f06b11faa79ce72cc", "filename": "src/librustc_mir/transform/check_consts/mod.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/20d6941be7039eb7fad9a4f893792a77d65bc792/src%2Flibrustc_mir%2Ftransform%2Fcheck_consts%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/20d6941be7039eb7fad9a4f893792a77d65bc792/src%2Flibrustc_mir%2Ftransform%2Fcheck_consts%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fcheck_consts%2Fmod.rs?ref=20d6941be7039eb7fad9a4f893792a77d65bc792", "patch": "@@ -22,7 +22,7 @@ pub mod validation;\n pub struct ConstCx<'mir, 'tcx> {\n     pub body: &'mir mir::Body<'tcx>,\n     pub tcx: TyCtxt<'tcx>,\n-    pub def_id: DefId,\n+    pub def_id: LocalDefId,\n     pub param_env: ty::ParamEnv<'tcx>,\n     pub const_kind: Option<hir::ConstContext>,\n }\n@@ -40,7 +40,7 @@ impl ConstCx<'mir, 'tcx> {\n         param_env: ty::ParamEnv<'tcx>,\n     ) -> Self {\n         let const_kind = tcx.hir().body_const_context(def_id);\n-        ConstCx { body, tcx, def_id: def_id.to_def_id(), param_env, const_kind }\n+        ConstCx { body, tcx, def_id: def_id, param_env, const_kind }\n     }\n \n     /// Returns the kind of const context this `Item` represents (`const`, `static`, etc.)."}, {"sha": "33fe2758c28fe666eb3b58fe34517a9644e1d3bc", "filename": "src/librustc_mir/transform/check_consts/post_drop_elaboration.rs", "status": "modified", "additions": 1, "deletions": 7, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/20d6941be7039eb7fad9a4f893792a77d65bc792/src%2Flibrustc_mir%2Ftransform%2Fcheck_consts%2Fpost_drop_elaboration.rs", "raw_url": "https://github.com/rust-lang/rust/raw/20d6941be7039eb7fad9a4f893792a77d65bc792/src%2Flibrustc_mir%2Ftransform%2Fcheck_consts%2Fpost_drop_elaboration.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fcheck_consts%2Fpost_drop_elaboration.rs?ref=20d6941be7039eb7fad9a4f893792a77d65bc792", "patch": "@@ -29,13 +29,7 @@ pub fn check_live_drops(tcx: TyCtxt<'tcx>, def_id: LocalDefId, body: &mir::Body<\n         return;\n     }\n \n-    let ccx = ConstCx {\n-        body,\n-        tcx,\n-        def_id: def_id.to_def_id(),\n-        const_kind,\n-        param_env: tcx.param_env(def_id),\n-    };\n+    let ccx = ConstCx { body, tcx, def_id: def_id, const_kind, param_env: tcx.param_env(def_id) };\n \n     let mut visitor = CheckLiveDrops { ccx: &ccx, qualifs: Qualifs::default() };\n "}, {"sha": "3dddd9c1c1766cea6845b18c7de17dac227fdee9", "filename": "src/librustc_mir/transform/check_consts/qualifs.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/20d6941be7039eb7fad9a4f893792a77d65bc792/src%2Flibrustc_mir%2Ftransform%2Fcheck_consts%2Fqualifs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/20d6941be7039eb7fad9a4f893792a77d65bc792/src%2Flibrustc_mir%2Ftransform%2Fcheck_consts%2Fqualifs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fcheck_consts%2Fqualifs.rs?ref=20d6941be7039eb7fad9a4f893792a77d65bc792", "patch": "@@ -126,7 +126,7 @@ impl Qualif for CustomEq {\n         // because that component may be part of an enum variant (e.g.,\n         // `Option::<NonStructuralMatchTy>::Some`), in which case some values of this type may be\n         // structural-match (`Option::None`).\n-        let id = cx.tcx.hir().local_def_id_to_hir_id(cx.def_id.as_local().unwrap());\n+        let id = cx.tcx.hir().local_def_id_to_hir_id(cx.def_id);\n         traits::search_for_structural_match_violation(id, cx.body.span, cx.tcx, ty).is_some()\n     }\n "}, {"sha": "5cb161ebcfb5ea4ca8f3f62a642e4c13b1052780", "filename": "src/librustc_mir/transform/check_consts/validation.rs", "status": "modified", "additions": 9, "deletions": 9, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/20d6941be7039eb7fad9a4f893792a77d65bc792/src%2Flibrustc_mir%2Ftransform%2Fcheck_consts%2Fvalidation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/20d6941be7039eb7fad9a4f893792a77d65bc792/src%2Flibrustc_mir%2Ftransform%2Fcheck_consts%2Fvalidation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fcheck_consts%2Fvalidation.rs?ref=20d6941be7039eb7fad9a4f893792a77d65bc792", "patch": "@@ -56,7 +56,7 @@ impl Qualifs<'mir, 'tcx> {\n             // without breaking stable code?\n             MaybeMutBorrowedLocals::mut_borrows_only(tcx, &body, param_env)\n                 .unsound_ignore_borrow_on_drop()\n-                .into_engine(tcx, &body, def_id)\n+                .into_engine(tcx, &body, def_id.to_def_id())\n                 .iterate_to_fixpoint()\n                 .into_results_cursor(&body)\n         });\n@@ -83,7 +83,7 @@ impl Qualifs<'mir, 'tcx> {\n             let ConstCx { tcx, body, def_id, .. } = *ccx;\n \n             FlowSensitiveAnalysis::new(NeedsDrop, ccx)\n-                .into_engine(tcx, &body, def_id)\n+                .into_engine(tcx, &body, def_id.to_def_id())\n                 .iterate_to_fixpoint()\n                 .into_results_cursor(&body)\n         });\n@@ -110,7 +110,7 @@ impl Qualifs<'mir, 'tcx> {\n             let ConstCx { tcx, body, def_id, .. } = *ccx;\n \n             FlowSensitiveAnalysis::new(HasMutInterior, ccx)\n-                .into_engine(tcx, &body, def_id)\n+                .into_engine(tcx, &body, def_id.to_def_id())\n                 .iterate_to_fixpoint()\n                 .into_results_cursor(&body)\n         });\n@@ -153,7 +153,7 @@ impl Qualifs<'mir, 'tcx> {\n \n             hir::ConstContext::Const | hir::ConstContext::Static(_) => {\n                 let mut cursor = FlowSensitiveAnalysis::new(CustomEq, ccx)\n-                    .into_engine(ccx.tcx, &ccx.body, ccx.def_id)\n+                    .into_engine(ccx.tcx, &ccx.body, ccx.def_id.to_def_id())\n                     .iterate_to_fixpoint()\n                     .into_results_cursor(&ccx.body);\n \n@@ -195,13 +195,13 @@ impl Validator<'mir, 'tcx> {\n         let ConstCx { tcx, body, def_id, const_kind, .. } = *self.ccx;\n \n         let use_min_const_fn_checks = (const_kind == Some(hir::ConstContext::ConstFn)\n-            && crate::const_eval::is_min_const_fn(tcx, def_id))\n+            && crate::const_eval::is_min_const_fn(tcx, def_id.to_def_id()))\n             && !tcx.sess.opts.debugging_opts.unleash_the_miri_inside_of_you;\n \n         if use_min_const_fn_checks {\n             // Enforce `min_const_fn` for stable `const fn`s.\n             use crate::transform::qualify_min_const_fn::is_min_const_fn;\n-            if let Err((span, err)) = is_min_const_fn(tcx, def_id, &body) {\n+            if let Err((span, err)) = is_min_const_fn(tcx, def_id.to_def_id(), &body) {\n                 error_min_const_fn_violation(tcx, span, err);\n                 return;\n             }\n@@ -212,10 +212,10 @@ impl Validator<'mir, 'tcx> {\n         // Ensure that the end result is `Sync` in a non-thread local `static`.\n         let should_check_for_sync = const_kind\n             == Some(hir::ConstContext::Static(hir::Mutability::Not))\n-            && !tcx.is_thread_local_static(def_id);\n+            && !tcx.is_thread_local_static(def_id.to_def_id());\n \n         if should_check_for_sync {\n-            let hir_id = tcx.hir().as_local_hir_id(def_id.expect_local());\n+            let hir_id = tcx.hir().as_local_hir_id(def_id);\n             check_return_ty_is_sync(tcx, &body, hir_id);\n         }\n     }\n@@ -535,7 +535,7 @@ impl Visitor<'tcx> for Validator<'mir, 'tcx> {\n                     // `#[allow_internal_unstable]`.\n                     use crate::transform::qualify_min_const_fn::lib_feature_allowed;\n                     if !self.span.allows_unstable(feature)\n-                        && !lib_feature_allowed(self.tcx, self.def_id, feature)\n+                        && !lib_feature_allowed(self.tcx, self.def_id.to_def_id(), feature)\n                     {\n                         self.check_op(ops::FnCallUnstable(def_id, feature));\n                     }"}, {"sha": "14c3093e1e9a11e784ad1ac75751673b99a7e31f", "filename": "src/librustc_mir/transform/mod.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/20d6941be7039eb7fad9a4f893792a77d65bc792/src%2Flibrustc_mir%2Ftransform%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/20d6941be7039eb7fad9a4f893792a77d65bc792/src%2Flibrustc_mir%2Ftransform%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fmod.rs?ref=20d6941be7039eb7fad9a4f893792a77d65bc792", "patch": "@@ -203,7 +203,8 @@ pub fn run_passes(\n }\n \n fn mir_const_qualif(tcx: TyCtxt<'_>, def_id: DefId) -> ConstQualifs {\n-    let const_kind = tcx.hir().body_const_context(def_id.expect_local());\n+    let def_id = def_id.expect_local();\n+    let const_kind = tcx.hir().body_const_context(def_id);\n \n     // No need to const-check a non-const `fn`.\n     if const_kind.is_none() {\n@@ -214,7 +215,7 @@ fn mir_const_qualif(tcx: TyCtxt<'_>, def_id: DefId) -> ConstQualifs {\n     // cannot yet be stolen), because `mir_validated()`, which steals\n     // from `mir_const(), forces this query to execute before\n     // performing the steal.\n-    let body = &tcx.mir_const(def_id).borrow();\n+    let body = &tcx.mir_const(def_id.to_def_id()).borrow();\n \n     if body.return_ty().references_error() {\n         tcx.sess.delay_span_bug(body.span, \"mir_const_qualif: MIR had errors\");"}, {"sha": "5aa67227994d918a1ac679cf6bee3394b4c65a5b", "filename": "src/librustc_mir/transform/promote_consts.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/20d6941be7039eb7fad9a4f893792a77d65bc792/src%2Flibrustc_mir%2Ftransform%2Fpromote_consts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/20d6941be7039eb7fad9a4f893792a77d65bc792/src%2Flibrustc_mir%2Ftransform%2Fpromote_consts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fpromote_consts.rs?ref=20d6941be7039eb7fad9a4f893792a77d65bc792", "patch": "@@ -60,15 +60,16 @@ impl<'tcx> MirPass<'tcx> for PromoteTemps<'tcx> {\n             return;\n         }\n \n-        let def_id = src.def_id();\n+        let def_id = src.def_id().expect_local();\n \n         let mut rpo = traversal::reverse_postorder(body);\n-        let ccx = ConstCx::new(tcx, def_id.expect_local(), body);\n+        let ccx = ConstCx::new(tcx, def_id, body);\n         let (temps, all_candidates) = collect_temps_and_candidates(&ccx, &mut rpo);\n \n         let promotable_candidates = validate_candidates(&ccx, &temps, &all_candidates);\n \n-        let promoted = promote_candidates(def_id, body, tcx, temps, promotable_candidates);\n+        let promoted =\n+            promote_candidates(def_id.to_def_id(), body, tcx, temps, promotable_candidates);\n         self.promoted_fragments.set(promoted);\n     }\n }\n@@ -724,7 +725,7 @@ impl<'tcx> Validator<'_, 'tcx> {\n             ty::FnDef(def_id, _) => {\n                 is_const_fn(self.tcx, def_id)\n                     || is_unstable_const_fn(self.tcx, def_id).is_some()\n-                    || is_lang_panic_fn(self.tcx, self.def_id)\n+                    || is_lang_panic_fn(self.tcx, self.def_id.to_def_id())\n             }\n             _ => false,\n         };"}]}