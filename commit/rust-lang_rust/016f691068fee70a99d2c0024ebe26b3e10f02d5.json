{"sha": "016f691068fee70a99d2c0024ebe26b3e10f02d5", "node_id": "MDY6Q29tbWl0NzI0NzEyOjAxNmY2OTEwNjhmZWU3MGE5OWQyYzAwMjRlYmUyNmIzZTEwZjAyZDU=", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2021-08-18T17:54:59Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-08-18T17:54:59Z"}, "message": "Rollup merge of #88036 - nbdd0121:const3, r=petrochenkov\n\nFix dead code warning when inline const is used in pattern\n\nFixes #78171", "tree": {"sha": "b9fb7f2e677c1ec818ee22c98abb7c7126fc4a6d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b9fb7f2e677c1ec818ee22c98abb7c7126fc4a6d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/016f691068fee70a99d2c0024ebe26b3e10f02d5", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhHUlzCRBK7hj4Ov3rIwAAW40IAEhu88hdpdIeT45mF3Gcoq8C\njTwux/+ZSBFd0/XMqE0NxcqsxusCahRbPdobi6rNS2HkuneoHC9qs+0uPLWe/ITj\nGAfuQITXPi6uKXSHD+38tKkPCYvxyyELnsdi9jHH5IwOouauh0DoUmb4vdGv8lBd\nhWGW13QdE+2XJFm+ZRQnZkEB+TVFypXFS2b4RIMtbRdeH6IuHrOigIEzkWsrDVYW\nTX4cPMxy86X84hL1pR71SSsGr8jSL+W/279eWERVs7pS2lj7d9rVUniW6N0gIgWP\nd2mlzIlvNAz5INjzj/OCySnRpwCdnqxzQtgS9iQ6LtH3s4F+FoBVRQR3KFzhNHc=\n=Gdso\n-----END PGP SIGNATURE-----\n", "payload": "tree b9fb7f2e677c1ec818ee22c98abb7c7126fc4a6d\nparent 9b7c771713ec2678f9dbd7a398f3759b253d960e\nparent e62ecdc5a7cbd44a9ade5061ddad4d8a4e1d6599\nauthor Guillaume Gomez <guillaume1.gomez@gmail.com> 1629309299 +0200\ncommitter GitHub <noreply@github.com> 1629309299 +0200\n\nRollup merge of #88036 - nbdd0121:const3, r=petrochenkov\n\nFix dead code warning when inline const is used in pattern\n\nFixes #78171\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/016f691068fee70a99d2c0024ebe26b3e10f02d5", "html_url": "https://github.com/rust-lang/rust/commit/016f691068fee70a99d2c0024ebe26b3e10f02d5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/016f691068fee70a99d2c0024ebe26b3e10f02d5/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9b7c771713ec2678f9dbd7a398f3759b253d960e", "url": "https://api.github.com/repos/rust-lang/rust/commits/9b7c771713ec2678f9dbd7a398f3759b253d960e", "html_url": "https://github.com/rust-lang/rust/commit/9b7c771713ec2678f9dbd7a398f3759b253d960e"}, {"sha": "e62ecdc5a7cbd44a9ade5061ddad4d8a4e1d6599", "url": "https://api.github.com/repos/rust-lang/rust/commits/e62ecdc5a7cbd44a9ade5061ddad4d8a4e1d6599", "html_url": "https://github.com/rust-lang/rust/commit/e62ecdc5a7cbd44a9ade5061ddad4d8a4e1d6599"}], "stats": {"total": 52, "additions": 52, "deletions": 0}, "files": [{"sha": "ae65222f3f22fc450d959293fa9a4152799382dc", "filename": "compiler/rustc_passes/src/dead.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/016f691068fee70a99d2c0024ebe26b3e10f02d5/compiler%2Frustc_passes%2Fsrc%2Fdead.rs", "raw_url": "https://github.com/rust-lang/rust/raw/016f691068fee70a99d2c0024ebe26b3e10f02d5/compiler%2Frustc_passes%2Fsrc%2Fdead.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fdead.rs?ref=016f691068fee70a99d2c0024ebe26b3e10f02d5", "patch": "@@ -15,6 +15,7 @@ use rustc_middle::middle::privacy;\n use rustc_middle::ty::{self, DefIdTree, TyCtxt};\n use rustc_session::lint;\n use rustc_span::symbol::{sym, Symbol};\n+use std::mem;\n \n // Any local node that may call something in its body block should be\n // explored. For example, if it's a live Node::Item that is a\n@@ -395,8 +396,14 @@ impl<'tcx> Visitor<'tcx> for MarkSymbolVisitor<'tcx> {\n     }\n \n     fn visit_anon_const(&mut self, c: &'tcx hir::AnonConst) {\n+        // When inline const blocks are used in pattern position, paths\n+        // referenced by it should be considered as used.\n+        let in_pat = mem::replace(&mut self.in_pat, false);\n+\n         self.live_symbols.insert(self.tcx.hir().local_def_id(c.hir_id));\n         intravisit::walk_anon_const(self, c);\n+\n+        self.in_pat = in_pat;\n     }\n }\n "}, {"sha": "4c6211a279a58e9483da41ba47f542e0e86b0a16", "filename": "src/test/ui/lint/dead-code/anon-const-in-pat.rs", "status": "added", "additions": 45, "deletions": 0, "changes": 45, "blob_url": "https://github.com/rust-lang/rust/blob/016f691068fee70a99d2c0024ebe26b3e10f02d5/src%2Ftest%2Fui%2Flint%2Fdead-code%2Fanon-const-in-pat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/016f691068fee70a99d2c0024ebe26b3e10f02d5/src%2Ftest%2Fui%2Flint%2Fdead-code%2Fanon-const-in-pat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Fdead-code%2Fanon-const-in-pat.rs?ref=016f691068fee70a99d2c0024ebe26b3e10f02d5", "patch": "@@ -0,0 +1,45 @@\n+// check-pass\n+#![feature(inline_const)]\n+#![allow(incomplete_features)]\n+#![deny(dead_code)]\n+\n+const fn one() -> i32 {\n+    1\n+}\n+\n+const fn two() -> i32 {\n+    2\n+}\n+\n+const fn three() -> i32 {\n+    3\n+}\n+\n+fn inline_const() {\n+    // rust-lang/rust#78171: dead_code lint triggers even though function is used in const pattern\n+    match 1 {\n+        const { one() } => {}\n+        _ => {}\n+    }\n+}\n+\n+fn inline_const_range() {\n+    match 1 {\n+        1 ..= const { two() } => {}\n+        _ => {}\n+    }\n+}\n+\n+struct S<const C: i32>;\n+\n+fn const_generic_arg() {\n+    match S::<3> {\n+        S::<{three()}> => {}\n+    }\n+}\n+\n+fn main() {\n+    inline_const();\n+    inline_const_range();\n+    const_generic_arg();\n+}"}]}