{"sha": "101a88f95064b21a3de26f2d3e932408fa9e1c97", "node_id": "MDY6Q29tbWl0NzI0NzEyOjEwMWE4OGY5NTA2NGIyMWEzZGUyNmYyZDNlOTMyNDA4ZmE5ZTFjOTc=", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2021-09-17T15:41:21Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-09-17T15:41:21Z"}, "message": "Rollup merge of #89012 - vishadGoyal:issue-88802-fix, r=jyn514\n\nSuggest removing `#![feature]` for library features that have been stabilized\n\nIssue: https://github.com/rust-lang/rust/issues/88802\nDelayed the check if #![feature] has been used to enable lib features in a non-nightly build to occur after TyCtxt has been constructed.", "tree": {"sha": "a1c61724745327620f23e9ce2b4ad491525e7d8b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a1c61724745327620f23e9ce2b4ad491525e7d8b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/101a88f95064b21a3de26f2d3e932408fa9e1c97", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhRLchCRBK7hj4Ov3rIwAA5zYIAC9JSe5VMDPe9i92OWRYIkdU\nqdqWA/bK6JjY2tu9Da+NQEXgqIp7o+mcXB5w96/03dJtIZVdTWzz9/sp9uGBsBkA\nGaZZIQGB8cKTuit5SooSQ9BioKubo5aalr5AIGn2GSR9H93cGkJWhIqidrWZfcQ/\n7hXs9JU7IYrxiiQ7I2D06W2SjL2LwVcCsVHFe0f28ILgR4VYDHOW32vkvyZLC3bz\nZ8GwGktFB3U3dGjeleK6sDSzrEl77NIPQkon50oVKxJEgNEt/7XDjIRIO2YBSo95\n/elvuqYnCbfc9N/hSRbH28K4KNxXImyo4LZe22UCskWQbMYC7rme4ztamxP4DoU=\n=GjCN\n-----END PGP SIGNATURE-----\n", "payload": "tree a1c61724745327620f23e9ce2b4ad491525e7d8b\nparent 833358b96444cd63e211f1fc1e47fc87ffe5be28\nparent 9f7e281d47f27c24a59b30cae30c20435be4083c\nauthor Guillaume Gomez <guillaume1.gomez@gmail.com> 1631893281 +0200\ncommitter GitHub <noreply@github.com> 1631893281 +0200\n\nRollup merge of #89012 - vishadGoyal:issue-88802-fix, r=jyn514\n\nSuggest removing `#![feature]` for library features that have been stabilized\n\nIssue: https://github.com/rust-lang/rust/issues/88802\nDelayed the check if #![feature] has been used to enable lib features in a non-nightly build to occur after TyCtxt has been constructed.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/101a88f95064b21a3de26f2d3e932408fa9e1c97", "html_url": "https://github.com/rust-lang/rust/commit/101a88f95064b21a3de26f2d3e932408fa9e1c97", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/101a88f95064b21a3de26f2d3e932408fa9e1c97/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "833358b96444cd63e211f1fc1e47fc87ffe5be28", "url": "https://api.github.com/repos/rust-lang/rust/commits/833358b96444cd63e211f1fc1e47fc87ffe5be28", "html_url": "https://github.com/rust-lang/rust/commit/833358b96444cd63e211f1fc1e47fc87ffe5be28"}, {"sha": "9f7e281d47f27c24a59b30cae30c20435be4083c", "url": "https://api.github.com/repos/rust-lang/rust/commits/9f7e281d47f27c24a59b30cae30c20435be4083c", "html_url": "https://github.com/rust-lang/rust/commit/9f7e281d47f27c24a59b30cae30c20435be4083c"}], "stats": {"total": 16, "additions": 16, "deletions": 0}, "files": [{"sha": "06e9d9ed329331e3d18e72d77ba7c45f2baea978", "filename": "compiler/rustc_ast_passes/src/feature_gate.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/101a88f95064b21a3de26f2d3e932408fa9e1c97/compiler%2Frustc_ast_passes%2Fsrc%2Ffeature_gate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/101a88f95064b21a3de26f2d3e932408fa9e1c97/compiler%2Frustc_ast_passes%2Fsrc%2Ffeature_gate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast_passes%2Fsrc%2Ffeature_gate.rs?ref=101a88f95064b21a3de26f2d3e932408fa9e1c97", "patch": "@@ -702,10 +702,16 @@ pub fn check_crate(krate: &ast::Crate, sess: &Session) {\n }\n \n fn maybe_stage_features(sess: &Session, krate: &ast::Crate) {\n+    // checks if `#![feature]` has been used to enable any lang feature\n+    // does not check the same for lib features unless there's at least one\n+    // declared lang feature\n     use rustc_errors::Applicability;\n \n     if !sess.opts.unstable_features.is_nightly_build() {\n         let lang_features = &sess.features_untracked().declared_lang_features;\n+        if lang_features.len() == 0 {\n+            return;\n+        }\n         for attr in krate.attrs.iter().filter(|attr| attr.has_name(sym::feature)) {\n             let mut err = struct_span_err!(\n                 sess.parse_sess.span_diagnostic,"}, {"sha": "d7c354aeb490f6accc78a15593b84410dc3655f5", "filename": "compiler/rustc_passes/src/stability.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/101a88f95064b21a3de26f2d3e932408fa9e1c97/compiler%2Frustc_passes%2Fsrc%2Fstability.rs", "raw_url": "https://github.com/rust-lang/rust/raw/101a88f95064b21a3de26f2d3e932408fa9e1c97/compiler%2Frustc_passes%2Fsrc%2Fstability.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fstability.rs?ref=101a88f95064b21a3de26f2d3e932408fa9e1c97", "patch": "@@ -929,6 +929,16 @@ pub fn check_unused_or_stable_features(tcx: TyCtxt<'_>) {\n     let declared_lib_features = &tcx.features().declared_lib_features;\n     let mut remaining_lib_features = FxHashMap::default();\n     for (feature, span) in declared_lib_features {\n+        if !tcx.sess.opts.unstable_features.is_nightly_build() {\n+            struct_span_err!(\n+                tcx.sess,\n+                *span,\n+                E0554,\n+                \"`#![feature]` may not be used on the {} release channel\",\n+                env!(\"CFG_RELEASE_CHANNEL\")\n+            )\n+            .emit();\n+        }\n         if remaining_lib_features.contains_key(&feature) {\n             // Warn if the user enables a lib feature multiple times.\n             duplicate_feature_err(tcx.sess, *span, *feature);"}]}