{"sha": "e5698faf4c3d1964d2a644f7b0856d5b3577df73", "node_id": "MDY6Q29tbWl0NzI0NzEyOmU1Njk4ZmFmNGMzZDE5NjRkMmE2NDRmN2IwODU2ZDViMzU3N2RmNzM=", "commit": {"author": {"name": "Edwin Cheng", "email": "edwin0cheng@gmail.com", "date": "2020-04-04T08:10:45Z"}, "committer": {"name": "Edwin Cheng", "email": "edwin0cheng@gmail.com", "date": "2020-04-09T17:18:47Z"}, "message": "Implement expand_task and list_macros", "tree": {"sha": "5ca3dde68c552ee03f1b4f922247cc5b7c4cf380", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5ca3dde68c552ee03f1b4f922247cc5b7c4cf380"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e5698faf4c3d1964d2a644f7b0856d5b3577df73", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e5698faf4c3d1964d2a644f7b0856d5b3577df73", "html_url": "https://github.com/rust-lang/rust/commit/e5698faf4c3d1964d2a644f7b0856d5b3577df73", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e5698faf4c3d1964d2a644f7b0856d5b3577df73/comments", "author": {"login": "edwin0cheng", "id": 11014119, "node_id": "MDQ6VXNlcjExMDE0MTE5", "avatar_url": "https://avatars.githubusercontent.com/u/11014119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/edwin0cheng", "html_url": "https://github.com/edwin0cheng", "followers_url": "https://api.github.com/users/edwin0cheng/followers", "following_url": "https://api.github.com/users/edwin0cheng/following{/other_user}", "gists_url": "https://api.github.com/users/edwin0cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/edwin0cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/edwin0cheng/subscriptions", "organizations_url": "https://api.github.com/users/edwin0cheng/orgs", "repos_url": "https://api.github.com/users/edwin0cheng/repos", "events_url": "https://api.github.com/users/edwin0cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/edwin0cheng/received_events", "type": "User", "site_admin": false}, "committer": {"login": "edwin0cheng", "id": 11014119, "node_id": "MDQ6VXNlcjExMDE0MTE5", "avatar_url": "https://avatars.githubusercontent.com/u/11014119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/edwin0cheng", "html_url": "https://github.com/edwin0cheng", "followers_url": "https://api.github.com/users/edwin0cheng/followers", "following_url": "https://api.github.com/users/edwin0cheng/following{/other_user}", "gists_url": "https://api.github.com/users/edwin0cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/edwin0cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/edwin0cheng/subscriptions", "organizations_url": "https://api.github.com/users/edwin0cheng/orgs", "repos_url": "https://api.github.com/users/edwin0cheng/repos", "events_url": "https://api.github.com/users/edwin0cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/edwin0cheng/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f7f121d60d0f6b8f280e09397b14a8afd0a369c1", "url": "https://api.github.com/repos/rust-lang/rust/commits/f7f121d60d0f6b8f280e09397b14a8afd0a369c1", "html_url": "https://github.com/rust-lang/rust/commit/f7f121d60d0f6b8f280e09397b14a8afd0a369c1"}], "stats": {"total": 31, "additions": 27, "deletions": 4}, "files": [{"sha": "8fba73ac97a21355b763222fb4fdae7bbe56edce", "filename": "crates/ra_proc_macro_srv/src/lib.rs", "status": "modified", "additions": 27, "deletions": 4, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/e5698faf4c3d1964d2a644f7b0856d5b3577df73/crates%2Fra_proc_macro_srv%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e5698faf4c3d1964d2a644f7b0856d5b3577df73/crates%2Fra_proc_macro_srv%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_proc_macro_srv%2Fsrc%2Flib.rs?ref=e5698faf4c3d1964d2a644f7b0856d5b3577df73", "patch": "@@ -22,10 +22,33 @@ mod dylib;\n use proc_macro::bridge::client::TokenStream;\n use ra_proc_macro::{ExpansionResult, ExpansionTask, ListMacrosResult, ListMacrosTask};\n \n-pub fn expand_task(_task: &ExpansionTask) -> Result<ExpansionResult, String> {\n-    unimplemented!()\n+pub fn expand_task(task: &ExpansionTask) -> Result<ExpansionResult, String> {\n+    let expander = dylib::Expander::new(&task.lib)\n+        .expect(&format!(\"Cannot expand with provided libraries: ${:?}\", &task.lib));\n+\n+    match expander.expand(&task.macro_name, &task.macro_body, task.attributes.as_ref()) {\n+        Ok(expansion) => Ok(ExpansionResult { expansion }),\n+        Err(msg) => {\n+            let reason = format!(\n+                \"Cannot perform expansion for {}: error {:?}!\",\n+                &task.macro_name,\n+                msg.as_str()\n+            );\n+            Err(reason)\n+        }\n+    }\n }\n \n-pub fn list_macros(_task: &ListMacrosTask) -> Result<ListMacrosResult, String> {\n-    unimplemented!()\n+pub fn list_macros(task: &ListMacrosTask) -> Result<ListMacrosResult, String> {\n+    let expander = dylib::Expander::new(&task.lib)\n+        .expect(&format!(\"Cannot expand with provided libraries: ${:?}\", &task.lib));\n+\n+    match expander.list_macros() {\n+        Ok(macros) => Ok(ListMacrosResult { macros }),\n+        Err(msg) => {\n+            let reason =\n+                format!(\"Cannot perform expansion for {:?}: error {:?}!\", &task.lib, msg.as_str());\n+            Err(reason)\n+        }\n+    }\n }"}]}