{"sha": "324418f32bd0d82f20dd79327dff1e3c78b719d2", "node_id": "MDY6Q29tbWl0NzI0NzEyOjMyNDQxOGYzMmJkMGQ4MmYyMGRkNzkzMjdkZmYxZTNjNzhiNzE5ZDI=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2013-09-25T07:56:18Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2013-09-25T18:40:30Z"}, "message": "Don't die in try_unsafe_borrow if tls isn't ready\n\nIf there's no TLS key just yet, then there's nothing to unsafely borrow, so\ncontinue returning None. This prevents causing the runtime to abort itself when\nlogging before the runtime is fully initialized.\n\nCloses #9487", "tree": {"sha": "32af46820e6ba813c1c6c7211075099745fc25c2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/32af46820e6ba813c1c6c7211075099745fc25c2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/324418f32bd0d82f20dd79327dff1e3c78b719d2", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/324418f32bd0d82f20dd79327dff1e3c78b719d2", "html_url": "https://github.com/rust-lang/rust/commit/324418f32bd0d82f20dd79327dff1e3c78b719d2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/324418f32bd0d82f20dd79327dff1e3c78b719d2/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "753547963340cb973210ad2df5590c29bf46ddf1", "url": "https://api.github.com/repos/rust-lang/rust/commits/753547963340cb973210ad2df5590c29bf46ddf1", "html_url": "https://github.com/rust-lang/rust/commit/753547963340cb973210ad2df5590c29bf46ddf1"}], "stats": {"total": 36, "additions": 30, "deletions": 6}, "files": [{"sha": "33384594c575ff4bab120fbd3f3a6e48afa8ceb6", "filename": "src/libstd/rt/local_ptr.rs", "status": "modified", "additions": 10, "deletions": 6, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/324418f32bd0d82f20dd79327dff1e3c78b719d2/src%2Flibstd%2Frt%2Flocal_ptr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/324418f32bd0d82f20dd79327dff1e3c78b719d2/src%2Flibstd%2Frt%2Flocal_ptr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Frt%2Flocal_ptr.rs?ref=324418f32bd0d82f20dd79327dff1e3c78b719d2", "patch": "@@ -129,12 +129,16 @@ pub unsafe fn unsafe_borrow<T>() -> *mut T {\n }\n \n pub unsafe fn try_unsafe_borrow<T>() -> Option<*mut T> {\n-    let key = tls_key();\n-    let void_ptr = tls::get(key);\n-    if void_ptr.is_null() {\n-        None\n-    } else {\n-        Some(void_ptr as *mut T)\n+    match maybe_tls_key() {\n+        Some(key) => {\n+            let void_ptr = tls::get(key);\n+            if void_ptr.is_null() {\n+                None\n+            } else {\n+                Some(void_ptr as *mut T)\n+            }\n+        }\n+        None => None\n     }\n }\n "}, {"sha": "cdf38821ebefeb209b7798fec3d3c1fd143e652a", "filename": "src/test/run-pass/logging_before_rt_started.rs", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/324418f32bd0d82f20dd79327dff1e3c78b719d2/src%2Ftest%2Frun-pass%2Flogging_before_rt_started.rs", "raw_url": "https://github.com/rust-lang/rust/raw/324418f32bd0d82f20dd79327dff1e3c78b719d2/src%2Ftest%2Frun-pass%2Flogging_before_rt_started.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Flogging_before_rt_started.rs?ref=324418f32bd0d82f20dd79327dff1e3c78b719d2", "patch": "@@ -0,0 +1,20 @@\n+// Copyright 2013 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// exec-env:RUST_LOG=std::ptr\n+// xfail-fast this would cause everything to print forever on windows...\n+\n+// In issue #9487, it was realized that std::ptr was invoking the logging\n+// infrastructure, and when std::ptr was used during runtime initialization,\n+// this caused some serious problems. The problems have since been fixed, but\n+// this test will trigger \"output during runtime initialization\" to make sure\n+// that the bug isn't re-introduced.\n+\n+fn main() {}"}]}