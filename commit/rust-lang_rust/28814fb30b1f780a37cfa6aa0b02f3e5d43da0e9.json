{"sha": "28814fb30b1f780a37cfa6aa0b02f3e5d43da0e9", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI4ODE0ZmIzMGIxZjc4MGEzN2NmYTZhYTBiMDJmM2U1ZDQzZGEwZTk=", "commit": {"author": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2016-02-05T17:04:20Z"}, "committer": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2016-02-05T17:04:20Z"}, "message": "Merge pull request #619 from Manishearth/regex_syntax\n\nnew regex syntax lint", "tree": {"sha": "84b190906aa5ac6f918c74f328a84ae7df325282", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/84b190906aa5ac6f918c74f328a84ae7df325282"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/28814fb30b1f780a37cfa6aa0b02f3e5d43da0e9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/28814fb30b1f780a37cfa6aa0b02f3e5d43da0e9", "html_url": "https://github.com/rust-lang/rust/commit/28814fb30b1f780a37cfa6aa0b02f3e5d43da0e9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/28814fb30b1f780a37cfa6aa0b02f3e5d43da0e9/comments", "author": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "527d3c313104b3c32d202acbaaa2b1ecf086b151", "url": "https://api.github.com/repos/rust-lang/rust/commits/527d3c313104b3c32d202acbaaa2b1ecf086b151", "html_url": "https://github.com/rust-lang/rust/commit/527d3c313104b3c32d202acbaaa2b1ecf086b151"}, {"sha": "2adc906a755abced869bb7e4a454302497155a40", "url": "https://api.github.com/repos/rust-lang/rust/commits/2adc906a755abced869bb7e4a454302497155a40", "html_url": "https://github.com/rust-lang/rust/commit/2adc906a755abced869bb7e4a454302497155a40"}], "stats": {"total": 121, "additions": 118, "deletions": 3}, "files": [{"sha": "c0d600e418c9d790c6abdbdbfaded77e25470cd3", "filename": "Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/28814fb30b1f780a37cfa6aa0b02f3e5d43da0e9/Cargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/28814fb30b1f780a37cfa6aa0b02f3e5d43da0e9/Cargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.toml?ref=28814fb30b1f780a37cfa6aa0b02f3e5d43da0e9", "patch": "@@ -19,6 +19,7 @@ plugin = true\n [dependencies]\n unicode-normalization = \"0.1\"\n semver = \"0.2.1\"\n+regex-syntax = \"0.2.2\"\n \n [dev-dependencies]\n compiletest_rs = \"0.0.11\""}, {"sha": "f7908ffdcab7739861ea96f46b30046c50bfc11e", "filename": "README.md", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/28814fb30b1f780a37cfa6aa0b02f3e5d43da0e9/README.md", "raw_url": "https://github.com/rust-lang/rust/raw/28814fb30b1f780a37cfa6aa0b02f3e5d43da0e9/README.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/README.md?ref=28814fb30b1f780a37cfa6aa0b02f3e5d43da0e9", "patch": "@@ -6,7 +6,7 @@ A collection of lints to catch common mistakes and improve your Rust code.\n [Jump to usage instructions](#usage)\n \n ##Lints\n-There are 110 lints included in this crate:\n+There are 111 lints included in this crate:\n \n name                                                                                                           | default | meaning\n ---------------------------------------------------------------------------------------------------------------|---------|------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\n@@ -47,6 +47,7 @@ name\n [identity_op](https://github.com/Manishearth/rust-clippy/wiki#identity_op)                                     | warn    | using identity operations, e.g. `x + 0` or `y / 1`\n [ineffective_bit_mask](https://github.com/Manishearth/rust-clippy/wiki#ineffective_bit_mask)                   | warn    | expressions where a bit mask will be rendered useless by a comparison, e.g. `(x | 1) > 2`\n [inline_always](https://github.com/Manishearth/rust-clippy/wiki#inline_always)                                 | warn    | `#[inline(always)]` is a bad idea in most cases\n+[invalid_regex](https://github.com/Manishearth/rust-clippy/wiki#invalid_regex)                                 | deny    | finds invalid regular expressions in `Regex::new(_)` invocations\n [items_after_statements](https://github.com/Manishearth/rust-clippy/wiki#items_after_statements)               | warn    | finds blocks where an item comes after a statement\n [iter_next_loop](https://github.com/Manishearth/rust-clippy/wiki#iter_next_loop)                               | warn    | for-looping over `_.next()` which is probably not intended\n [len_without_is_empty](https://github.com/Manishearth/rust-clippy/wiki#len_without_is_empty)                   | warn    | traits and impls that have `.len()` but not `.is_empty()`"}, {"sha": "56a2a072421467ec33f65bf32eee8dad553332e7", "filename": "src/lib.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/28814fb30b1f780a37cfa6aa0b02f3e5d43da0e9/src%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/28814fb30b1f780a37cfa6aa0b02f3e5d43da0e9/src%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flib.rs?ref=28814fb30b1f780a37cfa6aa0b02f3e5d43da0e9", "patch": "@@ -28,6 +28,9 @@ extern crate unicode_normalization;\n // for semver check in attrs.rs\n extern crate semver;\n \n+// for regex checking\n+extern crate regex_syntax;\n+\n extern crate rustc_plugin;\n \n use rustc_plugin::Registry;\n@@ -82,6 +85,7 @@ pub mod derive;\n pub mod print;\n pub mod vec;\n pub mod drop_ref;\n+pub mod regex;\n \n mod reexport {\n     pub use syntax::ast::{Name, NodeId};\n@@ -150,7 +154,7 @@ pub fn plugin_registrar(reg: &mut Registry) {\n     reg.register_late_lint_pass(box vec::UselessVec);\n     reg.register_late_lint_pass(box drop_ref::DropRefPass);\n     reg.register_late_lint_pass(box types::AbsurdUnsignedComparisons);\n-\n+    reg.register_late_lint_pass(box regex::RegexPass);\n \n     reg.register_lint_group(\"clippy_pedantic\", vec![\n         matches::SINGLE_MATCH_ELSE,\n@@ -251,6 +255,7 @@ pub fn plugin_registrar(reg: &mut Registry) {\n         ptr_arg::PTR_ARG,\n         ranges::RANGE_STEP_BY_ZERO,\n         ranges::RANGE_ZIP_WITH_LEN,\n+        regex::INVALID_REGEX,\n         returns::LET_AND_RETURN,\n         returns::NEEDLESS_RETURN,\n         strings::STRING_LIT_AS_BYTES,"}, {"sha": "259bbb1b64bd7667471a8f25c4c6389f5c102be0", "filename": "src/regex.rs", "status": "added", "additions": 83, "deletions": 0, "changes": 83, "blob_url": "https://github.com/rust-lang/rust/blob/28814fb30b1f780a37cfa6aa0b02f3e5d43da0e9/src%2Fregex.rs", "raw_url": "https://github.com/rust-lang/rust/raw/28814fb30b1f780a37cfa6aa0b02f3e5d43da0e9/src%2Fregex.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fregex.rs?ref=28814fb30b1f780a37cfa6aa0b02f3e5d43da0e9", "patch": "@@ -0,0 +1,83 @@\n+use regex_syntax;\n+use std::error::Error;\n+use syntax::ast::Lit_::LitStr;\n+use syntax::codemap::{Span, BytePos};\n+use syntax::parse::token::InternedString;\n+use rustc_front::hir::*;\n+use rustc::middle::const_eval::{eval_const_expr_partial, ConstVal};\n+use rustc::middle::const_eval::EvalHint::ExprTypeChecked;\n+use rustc::lint::*;\n+\n+use utils::{match_path, REGEX_NEW_PATH, span_lint};\n+\n+/// **What it does:** This lint checks `Regex::new(_)` invocations for correct regex syntax. It is `deny` by default.\n+///\n+/// **Why is this bad?** This will lead to a runtime panic.\n+///\n+/// **Known problems:** None.\n+///\n+/// **Example:** `Regex::new(\"|\")`\n+declare_lint! {\n+    pub INVALID_REGEX,\n+    Deny,\n+    \"finds invalid regular expressions in `Regex::new(_)` invocations\"\n+}\n+\n+#[derive(Copy,Clone)]\n+pub struct RegexPass;\n+\n+impl LintPass for RegexPass {\n+    fn get_lints(&self) -> LintArray {\n+        lint_array!(INVALID_REGEX)\n+    }\n+}\n+\n+impl LateLintPass for RegexPass {\n+    fn check_expr(&mut self, cx: &LateContext, expr: &Expr) {\n+        if_let_chain!{[\n+            let ExprCall(ref fun, ref args) = expr.node,\n+            let ExprPath(_, ref path) = fun.node,\n+            match_path(path, &REGEX_NEW_PATH) && args.len() == 1\n+        ], {\n+            if let ExprLit(ref lit) = args[0].node {\n+                if let LitStr(ref r, _) = lit.node {\n+                    if let Err(e) = regex_syntax::Expr::parse(r) {\n+                        span_lint(cx,\n+                                  INVALID_REGEX,\n+                                  str_span(args[0].span, &r, e.position()),\n+                                  &format!(\"Regex syntax error: {}\",\n+                                           e.description()));\n+                    }\n+                }\n+            } else {\n+                if_let_chain!{[\n+                    let Some(r) = const_str(cx, &*args[0]),\n+                    let Err(e) = regex_syntax::Expr::parse(&r)\n+                ], {\n+                    span_lint(cx,\n+                              INVALID_REGEX,\n+                              args[0].span,\n+                              &format!(\"Regex syntax error on position {}: {}\",\n+                                       e.position(),\n+                                       e.description()));\n+                }}\n+            }\n+        }}\n+    }\n+}\n+\n+#[allow(cast_possible_truncation)]\n+fn str_span(base: Span, s: &str, c: usize) -> Span {\n+    let lo = match s.char_indices().nth(c) {\n+        Some((b, _)) => base.lo + BytePos(b as u32),\n+        _ => base.hi\n+    };\n+    Span{ lo: lo, hi: lo, ..base }\n+}\n+\n+fn const_str(cx: &LateContext, e: &Expr) -> Option<InternedString> {\n+    match eval_const_expr_partial(cx.tcx, e, ExprTypeChecked, None) {\n+        Ok(ConstVal::Str(r)) => Some(r),\n+        _ => None\n+    }\n+}"}, {"sha": "8f542431d64514106bc71deacd692ae6b67d2125", "filename": "src/utils.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/28814fb30b1f780a37cfa6aa0b02f3e5d43da0e9/src%2Futils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/28814fb30b1f780a37cfa6aa0b02f3e5d43da0e9/src%2Futils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Futils.rs?ref=28814fb30b1f780a37cfa6aa0b02f3e5d43da0e9", "patch": "@@ -36,6 +36,7 @@ pub const LL_PATH: [&'static str; 3] = [\"collections\", \"linked_list\", \"LinkedLis\n pub const MUTEX_PATH: [&'static str; 4] = [\"std\", \"sync\", \"mutex\", \"Mutex\"];\n pub const OPEN_OPTIONS_PATH: [&'static str; 3] = [\"std\", \"fs\", \"OpenOptions\"];\n pub const OPTION_PATH: [&'static str; 3] = [\"core\", \"option\", \"Option\"];\n+pub const REGEX_NEW_PATH: [&'static str; 3] = [\"regex\", \"Regex\", \"new\"];\n pub const RESULT_PATH: [&'static str; 3] = [\"core\", \"result\", \"Result\"];\n pub const STRING_PATH: [&'static str; 3] = [\"collections\", \"string\", \"String\"];\n pub const VEC_FROM_ELEM_PATH: [&'static str; 3] = [\"std\", \"vec\", \"from_elem\"];"}, {"sha": "34dfc1ef25b37039a9362bfe6a36739d66090705", "filename": "tests/compile-fail/regex.rs", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/28814fb30b1f780a37cfa6aa0b02f3e5d43da0e9/tests%2Fcompile-fail%2Fregex.rs", "raw_url": "https://github.com/rust-lang/rust/raw/28814fb30b1f780a37cfa6aa0b02f3e5d43da0e9/tests%2Fcompile-fail%2Fregex.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Fregex.rs?ref=28814fb30b1f780a37cfa6aa0b02f3e5d43da0e9", "patch": "@@ -0,0 +1,24 @@\n+#![feature(plugin)]\n+#![plugin(clippy)]\n+\n+#![allow(unused)]\n+#![deny(invalid_regex)]\n+\n+extern crate regex;\n+\n+use regex::Regex;\n+\n+const OPENING_PAREN : &'static str = \"(\";\n+\n+fn main() {\n+    let pipe_in_wrong_position = Regex::new(\"|\");\n+    //~^ERROR: Regex syntax error: empty alternate\n+    let wrong_char_ranice = Regex::new(\"[z-a]\"); \n+    //~^ERROR: Regex syntax error: invalid character class range\n+    \n+    let some_regex = Regex::new(OPENING_PAREN);\n+    //~^ERROR: Regex syntax error on position 0: unclosed\n+\n+    let closing_paren = \")\";\n+    let not_linted = Regex::new(closing_paren);\n+}"}, {"sha": "92d2671eaa749eb5954761e82fc5f6b8c1f7f02a", "filename": "tests/compile-test.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/28814fb30b1f780a37cfa6aa0b02f3e5d43da0e9/tests%2Fcompile-test.rs", "raw_url": "https://github.com/rust-lang/rust/raw/28814fb30b1f780a37cfa6aa0b02f3e5d43da0e9/tests%2Fcompile-test.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-test.rs?ref=28814fb30b1f780a37cfa6aa0b02f3e5d43da0e9", "patch": "@@ -7,7 +7,7 @@ fn run_mode(mode: &'static str) {\n     let mut config = compiletest::default_config();\n \n     let cfg_mode = mode.parse().ok().expect(\"Invalid mode\");\n-    config.target_rustcflags = Some(\"-L target/debug/\".to_owned());\n+    config.target_rustcflags = Some(\"-L target/debug/ -L target/debug/deps\".to_owned());\n     if let Ok(name) = var::<&str>(\"TESTNAME\") {\n         let s : String = name.to_owned();\n         config.filter = Some(s)"}]}