{"sha": "f06a71149bdeeac0c88dba6e1ad0774487b5d3de", "node_id": "C_kwDOAAsO6NoAKGYwNmE3MTE0OWJkZWVhYzBjODhkYmE2ZTFhZDA3NzQ0ODdiNWQzZGU", "commit": {"author": {"name": "Ken Matsui", "email": "26405363+ken-matsui@users.noreply.github.com", "date": "2021-11-07T01:25:04Z"}, "committer": {"name": "Ken Matsui", "email": "26405363+ken-matsui@users.noreply.github.com", "date": "2021-11-07T01:25:04Z"}, "message": "Support early stopping too old pre-installed `tidy` command for macOS in the HTML checker", "tree": {"sha": "390c4167877ba08477ba0038f53829ad4146ca51", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/390c4167877ba08477ba0038f53829ad4146ca51"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f06a71149bdeeac0c88dba6e1ad0774487b5d3de", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEENhGM023oMzS0St3kEDNgsymO5DMFAmGHKvYACgkQEDNgsymO\n5DOsDhAAr9TMKV3QNyNyB7QxAY1THyv2aBjm73bmlWs8IvdHtzPzb4i9phub53ZS\np6wte0obXLgzeNy1WurM25SeQhlxu/MV9T/ttMx1siHawO+e9n2jEOzrKP6hcEIM\nlcxIq1ogtFug94Yznuu22Mx2kkYMtDbqTZfFAFUjOdYP0eIZ8Sn3OJt1ARGBS6io\nnNTIvWDkveQKbeqCY+8gLg9yixHC/LVKBhem91BEuXxUy+71IT4UGSMCqHOA25zA\nuB6Td3WS14c2EqQkG+l1fO61tTTGo8Y7hXGkFJ6Q+Hw/CZbFCrbKgjgflFbvpmt2\n17TAXZ8wSROHwF7YPJeucZktFVQ2Z3npRTB6R7+w8Gx0P0oAMleUO+yz88K3Te/a\nHIbgoi4dt+esMQg63dY5UOEqS3ddkKnQHAZ5GcvD7kd4UsmhEp7jRKdDvoN2f4T8\nY3VnZwlxxnEjRV2Z9lGrMOrDmsF16fiEsLMVbapzGAVHXhisOs3+bGNFYcBvG2XI\nIDvlQaB20Nmu27Iwwxbsr7ISvzNH4ESe69GEVdmPTf4RLZTDFK0yDwB8hbJ6AJSO\nkDK69CnJFvb6Xkds6db/RalzO90axGlk0x6YwNGEa32V0uOY8D4WcsxBdfa9c23u\n8EOaseblxt2WFNpVAte4u8fKYL6etWPSpAz7kIyH5gx06p+iSrs=\n=PfKm\n-----END PGP SIGNATURE-----", "payload": "tree 390c4167877ba08477ba0038f53829ad4146ca51\nparent 0727994435c75fdedd3e9d226cf434089b0ab585\nauthor Ken Matsui <26405363+ken-matsui@users.noreply.github.com> 1636248304 +0900\ncommitter Ken Matsui <26405363+ken-matsui@users.noreply.github.com> 1636248304 +0900\n\nSupport early stopping too old pre-installed `tidy` command for macOS in the HTML checker\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f06a71149bdeeac0c88dba6e1ad0774487b5d3de", "html_url": "https://github.com/rust-lang/rust/commit/f06a71149bdeeac0c88dba6e1ad0774487b5d3de", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f06a71149bdeeac0c88dba6e1ad0774487b5d3de/comments", "author": {"login": "ken-matsui", "id": 26405363, "node_id": "MDQ6VXNlcjI2NDA1MzYz", "avatar_url": "https://avatars.githubusercontent.com/u/26405363?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ken-matsui", "html_url": "https://github.com/ken-matsui", "followers_url": "https://api.github.com/users/ken-matsui/followers", "following_url": "https://api.github.com/users/ken-matsui/following{/other_user}", "gists_url": "https://api.github.com/users/ken-matsui/gists{/gist_id}", "starred_url": "https://api.github.com/users/ken-matsui/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ken-matsui/subscriptions", "organizations_url": "https://api.github.com/users/ken-matsui/orgs", "repos_url": "https://api.github.com/users/ken-matsui/repos", "events_url": "https://api.github.com/users/ken-matsui/events{/privacy}", "received_events_url": "https://api.github.com/users/ken-matsui/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ken-matsui", "id": 26405363, "node_id": "MDQ6VXNlcjI2NDA1MzYz", "avatar_url": "https://avatars.githubusercontent.com/u/26405363?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ken-matsui", "html_url": "https://github.com/ken-matsui", "followers_url": "https://api.github.com/users/ken-matsui/followers", "following_url": "https://api.github.com/users/ken-matsui/following{/other_user}", "gists_url": "https://api.github.com/users/ken-matsui/gists{/gist_id}", "starred_url": "https://api.github.com/users/ken-matsui/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ken-matsui/subscriptions", "organizations_url": "https://api.github.com/users/ken-matsui/orgs", "repos_url": "https://api.github.com/users/ken-matsui/repos", "events_url": "https://api.github.com/users/ken-matsui/events{/privacy}", "received_events_url": "https://api.github.com/users/ken-matsui/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0727994435c75fdedd3e9d226cf434089b0ab585", "url": "https://api.github.com/repos/rust-lang/rust/commits/0727994435c75fdedd3e9d226cf434089b0ab585", "html_url": "https://github.com/rust-lang/rust/commit/0727994435c75fdedd3e9d226cf434089b0ab585"}], "stats": {"total": 23, "additions": 23, "deletions": 0}, "files": [{"sha": "f52fbdfe2d7dc5949b5195985598a0c3bc335747", "filename": "src/tools/html-checker/main.rs", "status": "modified", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/f06a71149bdeeac0c88dba6e1ad0774487b5d3de/src%2Ftools%2Fhtml-checker%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f06a71149bdeeac0c88dba6e1ad0774487b5d3de/src%2Ftools%2Fhtml-checker%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fhtml-checker%2Fmain.rs?ref=f06a71149bdeeac0c88dba6e1ad0774487b5d3de", "patch": "@@ -79,11 +79,34 @@ fn find_all_html_files(dir: &Path) -> (usize, usize) {\n     (files_read, errors)\n }\n \n+/// Default `tidy` command for macOS is too old that it does not have `mute-id` and `mute` options.\n+/// `tidy` on macOS Monterey was released on 31 October 2006, and the same date can be seen seven\n+/// years ago at <https://stackoverflow.com/questions/22283382/overwrite-osx-tidy>. Accordingly,\n+/// the macOS environment using pre-installed `tidy` should immediately suspend HTML checker process\n+/// and show a hint to install a newer one.\n+#[cfg(target_os = \"macos\")]\n+fn check_tidy_version() -> Result<(), String> {\n+    let output = Command::new(\"tidy\").arg(\"-v\").output().expect(\"failed to run tidy command\");\n+    let version = String::from_utf8(output.stdout).expect(\"failed to read version of tidy command\");\n+    if version.contains(\"HTML Tidy for Mac OS X released on 31 October 2006\") {\n+        eprintln!(\"The pre-installed HTML Tidy for macOS is not supported.\");\n+        eprintln!(\"Consider installing a newer one and re-running.\");\n+        eprintln!(\"If you're using Homebrew, you can install it by the following command:\");\n+        eprintln!(\"    brew install tidy-html5\");\n+        eprintln!();\n+        Err(\"HTML check failed: 1 error\".to_string())\n+    } else {\n+        Ok(())\n+    }\n+}\n+\n fn main() -> Result<(), String> {\n     let args = env::args().collect::<Vec<_>>();\n     if args.len() != 2 {\n         return Err(format!(\"Usage: {} <doc folder>\", args[0]));\n     }\n+    #[cfg(target_os = \"macos\")]\n+    check_tidy_version()?;\n \n     println!(\"Running HTML checker...\");\n "}]}