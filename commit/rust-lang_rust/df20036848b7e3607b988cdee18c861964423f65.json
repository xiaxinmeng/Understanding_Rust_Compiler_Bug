{"sha": "df20036848b7e3607b988cdee18c861964423f65", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRmMjAwMzY4NDhiN2UzNjA3Yjk4OGNkZWUxOGM4NjE5NjQ0MjNmNjU=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2020-03-01T23:07:23Z"}, "committer": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2020-03-01T23:07:23Z"}, "message": "stash API: remove panic to fix ICE.", "tree": {"sha": "1dd072026392d498bd30d9b8178187b22de67776", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1dd072026392d498bd30d9b8178187b22de67776"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/df20036848b7e3607b988cdee18c861964423f65", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/df20036848b7e3607b988cdee18c861964423f65", "html_url": "https://github.com/rust-lang/rust/commit/df20036848b7e3607b988cdee18c861964423f65", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/df20036848b7e3607b988cdee18c861964423f65/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d3c79346a3e7ddbb5fb417810f226ac5a9209007", "url": "https://api.github.com/repos/rust-lang/rust/commits/d3c79346a3e7ddbb5fb417810f226ac5a9209007", "html_url": "https://github.com/rust-lang/rust/commit/d3c79346a3e7ddbb5fb417810f226ac5a9209007"}], "stats": {"total": 88, "additions": 74, "deletions": 14}, "files": [{"sha": "161b2c717e7ce94ce4de1858a0ea34b2f52518d3", "filename": "src/librustc_errors/lib.rs", "status": "modified", "additions": 4, "deletions": 14, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/df20036848b7e3607b988cdee18c861964423f65/src%2Flibrustc_errors%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/df20036848b7e3607b988cdee18c861964423f65/src%2Flibrustc_errors%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_errors%2Flib.rs?ref=df20036848b7e3607b988cdee18c861964423f65", "patch": "@@ -444,22 +444,12 @@ impl Handler {\n     }\n \n     /// Stash a given diagnostic with the given `Span` and `StashKey` as the key for later stealing.\n-    /// If the diagnostic with this `(span, key)` already exists, this will result in an ICE.\n     pub fn stash_diagnostic(&self, span: Span, key: StashKey, diag: Diagnostic) {\n         let mut inner = self.inner.borrow_mut();\n-        if let Some(mut old_diag) = inner.stashed_diagnostics.insert((span, key), diag) {\n-            // We are removing a previously stashed diagnostic which should not happen.\n-            old_diag.level = Bug;\n-            old_diag.note(&format!(\n-                \"{}:{}: already existing stashed diagnostic with (span = {:?}, key = {:?})\",\n-                file!(),\n-                line!(),\n-                span,\n-                key\n-            ));\n-            inner.emit_diag_at_span(old_diag, span);\n-            panic!(ExplicitBug);\n-        }\n+        // FIXME(Centril, #69537): Consider reintroducing panic on overwriting a stashed diagnostic\n+        // if/when we have a more robust macro-friendly replacement for `(span, key)` as a key.\n+        // See the PR for a discussion.\n+        inner.stashed_diagnostics.insert((span, key), diag);\n     }\n \n     /// Steal a previously stashed diagnostic with the given `Span` and `StashKey` as the key."}, {"sha": "69fc0c1cbb96b71b0a8fc3ed3aa0acbd42032aaa", "filename": "src/test/ui/issues/issue-69396-const-no-type-in-macro.rs", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/df20036848b7e3607b988cdee18c861964423f65/src%2Ftest%2Fui%2Fissues%2Fissue-69396-const-no-type-in-macro.rs", "raw_url": "https://github.com/rust-lang/rust/raw/df20036848b7e3607b988cdee18c861964423f65/src%2Ftest%2Fui%2Fissues%2Fissue-69396-const-no-type-in-macro.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-69396-const-no-type-in-macro.rs?ref=df20036848b7e3607b988cdee18c861964423f65", "patch": "@@ -0,0 +1,17 @@\n+macro_rules! suite {\n+    ( $( $fn:ident; )* ) => {\n+        $(\n+            const A = \"A\".$fn();\n+            //~^ ERROR the name `A` is defined multiple times\n+            //~| ERROR missing type for `const` item\n+            //~| ERROR the type placeholder `_` is not allowed within types\n+        )*\n+    }\n+}\n+\n+suite! {\n+    len;\n+    is_empty;\n+}\n+\n+fn main() {}"}, {"sha": "1af5368d2b6d934b909827f73e5e839d81527293", "filename": "src/test/ui/issues/issue-69396-const-no-type-in-macro.stderr", "status": "added", "additions": 53, "deletions": 0, "changes": 53, "blob_url": "https://github.com/rust-lang/rust/blob/df20036848b7e3607b988cdee18c861964423f65/src%2Ftest%2Fui%2Fissues%2Fissue-69396-const-no-type-in-macro.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/df20036848b7e3607b988cdee18c861964423f65/src%2Ftest%2Fui%2Fissues%2Fissue-69396-const-no-type-in-macro.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-69396-const-no-type-in-macro.stderr?ref=df20036848b7e3607b988cdee18c861964423f65", "patch": "@@ -0,0 +1,53 @@\n+error[E0428]: the name `A` is defined multiple times\n+  --> $DIR/issue-69396-const-no-type-in-macro.rs:4:13\n+   |\n+LL |               const A = \"A\".$fn();\n+   |               ^^^^^^^^^^^^^^^^^^^^\n+   |               |\n+   |               `A` redefined here\n+   |               previous definition of the value `A` here\n+...\n+LL | / suite! {\n+LL | |     len;\n+LL | |     is_empty;\n+LL | | }\n+   | |_- in this macro invocation\n+   |\n+   = note: `A` must be defined only once in the value namespace of this module\n+   = note: this error originates in a macro (in Nightly builds, run with -Z macro-backtrace for more info)\n+\n+error: missing type for `const` item\n+  --> $DIR/issue-69396-const-no-type-in-macro.rs:4:19\n+   |\n+LL |               const A = \"A\".$fn();\n+   |                     ^ help: provide a type for the item: `A: usize`\n+...\n+LL | / suite! {\n+LL | |     len;\n+LL | |     is_empty;\n+LL | | }\n+   | |_- in this macro invocation\n+   |\n+   = note: this error originates in a macro (in Nightly builds, run with -Z macro-backtrace for more info)\n+\n+error[E0121]: the type placeholder `_` is not allowed within types on item signatures\n+  --> $DIR/issue-69396-const-no-type-in-macro.rs:4:19\n+   |\n+LL |               const A = \"A\".$fn();\n+   |                     ^\n+   |                     |\n+   |                     not allowed in type signatures\n+   |                     help: replace `_` with the correct type: `bool`\n+...\n+LL | / suite! {\n+LL | |     len;\n+LL | |     is_empty;\n+LL | | }\n+   | |_- in this macro invocation\n+   |\n+   = note: this error originates in a macro (in Nightly builds, run with -Z macro-backtrace for more info)\n+\n+error: aborting due to 3 previous errors\n+\n+Some errors have detailed explanations: E0121, E0428.\n+For more information about an error, try `rustc --explain E0121`."}]}