{"sha": "7646dc046eb562276231de8ec6a4df1bc691cafc", "node_id": "MDY6Q29tbWl0NzI0NzEyOjc2NDZkYzA0NmViNTYyMjc2MjMxZGU4ZWM2YTRkZjFiYzY5MWNhZmM=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-12-30T19:29:21Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-12-30T20:32:04Z"}, "message": "Encapsulate highlighting activation", "tree": {"sha": "3820a5c89a7b6317373fca4d68cab01912cc24f6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3820a5c89a7b6317373fca4d68cab01912cc24f6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7646dc046eb562276231de8ec6a4df1bc691cafc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7646dc046eb562276231de8ec6a4df1bc691cafc", "html_url": "https://github.com/rust-lang/rust/commit/7646dc046eb562276231de8ec6a4df1bc691cafc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7646dc046eb562276231de8ec6a4df1bc691cafc/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "17dda0972a68dd88a766c223390317dc2cb3ea00", "url": "https://api.github.com/repos/rust-lang/rust/commits/17dda0972a68dd88a766c223390317dc2cb3ea00", "html_url": "https://github.com/rust-lang/rust/commit/17dda0972a68dd88a766c223390317dc2cb3ea00"}], "stats": {"total": 59, "additions": 24, "deletions": 35}, "files": [{"sha": "4384ee56768c178a62476ec8e760a13ac38e364a", "filename": "editors/code/src/events/change_active_text_editor.ts", "status": "removed", "additions": 0, "deletions": 25, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/17dda0972a68dd88a766c223390317dc2cb3ea00/editors%2Fcode%2Fsrc%2Fevents%2Fchange_active_text_editor.ts", "raw_url": "https://github.com/rust-lang/rust/raw/17dda0972a68dd88a766c223390317dc2cb3ea00/editors%2Fcode%2Fsrc%2Fevents%2Fchange_active_text_editor.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fevents%2Fchange_active_text_editor.ts?ref=17dda0972a68dd88a766c223390317dc2cb3ea00", "patch": "@@ -1,25 +0,0 @@\n-import { TextEditor } from 'vscode';\n-import { TextDocumentIdentifier } from 'vscode-languageclient';\n-import { Decoration } from '../highlighting';\n-import { Server } from '../server';\n-\n-export function makeHandler() {\n-    return async function handle(editor: TextEditor | undefined) {\n-        if (!editor || editor.document.languageId !== 'rust') {\n-            return;\n-        }\n-\n-        if (!Server.config.highlightingOn) {\n-            return;\n-        }\n-\n-        const params: TextDocumentIdentifier = {\n-            uri: editor.document.uri.toString(),\n-        };\n-        const decorations = await Server.client.sendRequest<Decoration[]>(\n-            'rust-analyzer/decorationsRequest',\n-            params,\n-        );\n-        Server.highlighter.setHighlights(editor, decorations);\n-    };\n-}"}, {"sha": "be135474de620b85ec0e2176525ed7b458b8d155", "filename": "editors/code/src/events/index.ts", "status": "removed", "additions": 0, "deletions": 3, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/17dda0972a68dd88a766c223390317dc2cb3ea00/editors%2Fcode%2Fsrc%2Fevents%2Findex.ts", "raw_url": "https://github.com/rust-lang/rust/raw/17dda0972a68dd88a766c223390317dc2cb3ea00/editors%2Fcode%2Fsrc%2Fevents%2Findex.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fevents%2Findex.ts?ref=17dda0972a68dd88a766c223390317dc2cb3ea00", "patch": "@@ -1,3 +0,0 @@\n-import * as changeActiveTextEditor from './change_active_text_editor';\n-\n-export { changeActiveTextEditor };"}, {"sha": "ced78adc110c55eba1c226ebc5b26de202ef94e6", "filename": "editors/code/src/highlighting.ts", "status": "modified", "additions": 21, "deletions": 1, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/7646dc046eb562276231de8ec6a4df1bc691cafc/editors%2Fcode%2Fsrc%2Fhighlighting.ts", "raw_url": "https://github.com/rust-lang/rust/raw/7646dc046eb562276231de8ec6a4df1bc691cafc/editors%2Fcode%2Fsrc%2Fhighlighting.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fhighlighting.ts?ref=7646dc046eb562276231de8ec6a4df1bc691cafc", "patch": "@@ -1,10 +1,30 @@\n-import seedrandom = require('seedrandom');\n import * as vscode from 'vscode';\n import * as lc from 'vscode-languageclient';\n+import * as seedrandom from 'seedrandom';\n+\n import * as scopes from './scopes';\n import * as scopesMapper from './scopes_mapper';\n \n import { Server } from './server';\n+import { Ctx } from './ctx';\n+\n+export function activateHighlighting(ctx: Ctx) {\n+    vscode.window.onDidChangeActiveTextEditor(\n+        async (editor: vscode.TextEditor | undefined) => {\n+            if (!editor || editor.document.languageId !== 'rust') return;\n+            if (!Server.config.highlightingOn) return;\n+\n+            const params: lc.TextDocumentIdentifier = {\n+                uri: editor.document.uri.toString(),\n+            };\n+            const decorations = await ctx.client.sendRequest<Decoration[]>(\n+                'rust-analyzer/decorationsRequest',\n+                params,\n+            );\n+            Server.highlighter.setHighlights(editor, decorations);\n+        },\n+    );\n+}\n \n export interface Decoration {\n     range: lc.Range;"}, {"sha": "45657532e5fa09a624336895dd24cf41c311a326", "filename": "editors/code/src/main.ts", "status": "modified", "additions": 3, "deletions": 6, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/7646dc046eb562276231de8ec6a4df1bc691cafc/editors%2Fcode%2Fsrc%2Fmain.ts", "raw_url": "https://github.com/rust-lang/rust/raw/7646dc046eb562276231de8ec6a4df1bc691cafc/editors%2Fcode%2Fsrc%2Fmain.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fmain.ts?ref=7646dc046eb562276231de8ec6a4df1bc691cafc", "patch": "@@ -4,10 +4,10 @@ import * as lc from 'vscode-languageclient';\n import * as commands from './commands';\n import { activateInlayHints } from './inlay_hints';\n import { StatusDisplay } from './status_display';\n-import * as events from './events';\n import * as notifications from './notifications';\n import { Server } from './server';\n import { Ctx } from './ctx';\n+import { activateHighlighting } from './highlighting';\n \n let ctx!: Ctx;\n \n@@ -37,6 +37,8 @@ export async function activate(context: vscode.ExtensionContext) {\n     );\n     ctx.pushCleanup(watchStatus);\n \n+    activateHighlighting(ctx);\n+\n     // Notifications are events triggered by the language server\n     const allNotifications: [string, lc.GenericNotificationHandler][] = [\n         [\n@@ -49,11 +51,6 @@ export async function activate(context: vscode.ExtensionContext) {\n         ],\n     ];\n \n-    // The events below are plain old javascript events, triggered and handled by vscode\n-    vscode.window.onDidChangeActiveTextEditor(\n-        events.changeActiveTextEditor.makeHandler(),\n-    );\n-\n     const startServer = () => Server.start(allNotifications);\n     const reloadCommand = () => reloadServer(startServer);\n "}]}