{"sha": "816cda7e1b0cc9a08baa5e44e1e3875b2a70c96e", "node_id": "C_kwDOAAsO6NoAKDgxNmNkYTdlMWIwY2M5YTA4YmFhNWU0NGUxZTM4NzViMmE3MGM5NmU", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2021-12-18T07:16:30Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-12-18T07:16:30Z"}, "message": "Rollup merge of #91975 - cjgillot:noinline-generator, r=jackh726\n\nMove generator check earlier in inlining.\n\nInlining into generator may create references to other generators. For instance, inlining `Pin::<&mut from_generator::GenFuture<[generator1]>>::new_unchecked` into `generator2`. This cross reference can then create cycles when computing inlining for `generator1`.\n\nIn order to avoid this kind of surprises, we forbid all inlining into generators, and rely on LLVM to do the right thing. The existing `remove-zst-query-cycle` already ICEs in inline-mir mode, so we use it as test.\n\nSplit from #91743.", "tree": {"sha": "70cc474134e87ce02a5851b5236fd85b03252c10", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/70cc474134e87ce02a5851b5236fd85b03252c10"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/816cda7e1b0cc9a08baa5e44e1e3875b2a70c96e", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhvYrOCRBK7hj4Ov3rIwAAxuEIAK5mZ0h+z+dNzdcojTnUnG2m\nEkJSJZmvRGsTkzPjdTWN0Gzxs8GyIGCwqN4XiC2tL8r/AVysh/7+AGMgcERZyVc9\nAT4oarFC4h/+fV+Fje2GPeWGHaYh91aKslsIHlRoWSX1LJfieraGjbF+SbmtnnTP\nhMwz8qDuZl/FlS4cWhRGWRv0Ze4+wzlaUhV34NUZRpOhPXC6uxQPiC5dg4dn/I+N\nhYnRzYh6w1UMKUYKSrzptWVu5n2YmKEpPI1IaUXxBhrd2s8PSuy22siy8bxC89yI\nfOOV0cEe8v1r334uW+LRp2xEUUNmZI/7d9tWY1w2YQS/YmqVVQTewSAL9jaPT0c=\n=wSJv\n-----END PGP SIGNATURE-----\n", "payload": "tree 70cc474134e87ce02a5851b5236fd85b03252c10\nparent fcc59794a73f3181e196f65e6f7bba536edd09b0\nparent d48dbdc080f45f36ffc756de35c1443f2e05f527\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1639811790 +0100\ncommitter GitHub <noreply@github.com> 1639811790 +0100\n\nRollup merge of #91975 - cjgillot:noinline-generator, r=jackh726\n\nMove generator check earlier in inlining.\n\nInlining into generator may create references to other generators. For instance, inlining `Pin::<&mut from_generator::GenFuture<[generator1]>>::new_unchecked` into `generator2`. This cross reference can then create cycles when computing inlining for `generator1`.\n\nIn order to avoid this kind of surprises, we forbid all inlining into generators, and rely on LLVM to do the right thing. The existing `remove-zst-query-cycle` already ICEs in inline-mir mode, so we use it as test.\n\nSplit from #91743.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/816cda7e1b0cc9a08baa5e44e1e3875b2a70c96e", "html_url": "https://github.com/rust-lang/rust/commit/816cda7e1b0cc9a08baa5e44e1e3875b2a70c96e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/816cda7e1b0cc9a08baa5e44e1e3875b2a70c96e/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fcc59794a73f3181e196f65e6f7bba536edd09b0", "url": "https://api.github.com/repos/rust-lang/rust/commits/fcc59794a73f3181e196f65e6f7bba536edd09b0", "html_url": "https://github.com/rust-lang/rust/commit/fcc59794a73f3181e196f65e6f7bba536edd09b0"}, {"sha": "d48dbdc080f45f36ffc756de35c1443f2e05f527", "url": "https://api.github.com/repos/rust-lang/rust/commits/d48dbdc080f45f36ffc756de35c1443f2e05f527", "html_url": "https://github.com/rust-lang/rust/commit/d48dbdc080f45f36ffc756de35c1443f2e05f527"}], "stats": {"total": 31, "additions": 12, "deletions": 19}, "files": [{"sha": "8be95b2d95a20c79897ffcde16bb4167ec5ca8cc", "filename": "compiler/rustc_mir_transform/src/inline.rs", "status": "modified", "additions": 6, "deletions": 8, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/816cda7e1b0cc9a08baa5e44e1e3875b2a70c96e/compiler%2Frustc_mir_transform%2Fsrc%2Finline.rs", "raw_url": "https://github.com/rust-lang/rust/raw/816cda7e1b0cc9a08baa5e44e1e3875b2a70c96e/compiler%2Frustc_mir_transform%2Fsrc%2Finline.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Finline.rs?ref=816cda7e1b0cc9a08baa5e44e1e3875b2a70c96e", "patch": "@@ -68,6 +68,12 @@ fn inline<'tcx>(tcx: TyCtxt<'tcx>, body: &mut Body<'tcx>) -> bool {\n     if body.source.promoted.is_some() {\n         return false;\n     }\n+    // Avoid inlining into generators, since their `optimized_mir` is used for layout computation,\n+    // which can create a cycle, even when no attempt is made to inline the function in the other\n+    // direction.\n+    if body.generator.is_some() {\n+        return false;\n+    }\n \n     let mut this = Inliner {\n         tcx,\n@@ -202,14 +208,6 @@ impl<'tcx> Inliner<'tcx> {\n \n         if let Some(callee_def_id) = callee.def_id().as_local() {\n             let callee_hir_id = self.tcx.hir().local_def_id_to_hir_id(callee_def_id);\n-            // Avoid inlining into generators,\n-            // since their `optimized_mir` is used for layout computation, which can\n-            // create a cycle, even when no attempt is made to inline the function\n-            // in the other direction.\n-            if caller_body.generator.is_some() {\n-                return Err(\"local generator (query cycle avoidance)\");\n-            }\n-\n             // Avoid a cycle here by only using `instance_mir` only if we have\n             // a lower `HirId` than the callee. This ensures that the callee will\n             // not inline us. This trick only works without incremental compilation."}, {"sha": "84ccf25ef750e1e5adc0c95660156618578925e5", "filename": "src/test/mir-opt/generator_drop_cleanup.main-{closure#0}.generator_drop.0.mir", "status": "modified", "additions": 5, "deletions": 10, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/816cda7e1b0cc9a08baa5e44e1e3875b2a70c96e/src%2Ftest%2Fmir-opt%2Fgenerator_drop_cleanup.main-%7Bclosure%230%7D.generator_drop.0.mir", "raw_url": "https://github.com/rust-lang/rust/raw/816cda7e1b0cc9a08baa5e44e1e3875b2a70c96e/src%2Ftest%2Fmir-opt%2Fgenerator_drop_cleanup.main-%7Bclosure%230%7D.generator_drop.0.mir", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fgenerator_drop_cleanup.main-%7Bclosure%230%7D.generator_drop.0.mir?ref=816cda7e1b0cc9a08baa5e44e1e3875b2a70c96e", "patch": "@@ -20,21 +20,16 @@ fn main::{closure#0}(_1: *mut [generator@$DIR/generator-drop-cleanup.rs:10:15: 1\n     let _3: std::string::String;         // in scope 0 at $DIR/generator-drop-cleanup.rs:11:13: 11:15\n     let _4: ();                          // in scope 0 at $DIR/generator-drop-cleanup.rs:12:9: 12:14\n     let mut _5: ();                      // in scope 0 at $DIR/generator-drop-cleanup.rs:12:9: 12:14\n-    let mut _7: ();                      // in scope 0 at $DIR/generator-drop-cleanup.rs:10:18: 10:18\n-    let mut _8: ();                      // in scope 0 at $DIR/generator-drop-cleanup.rs:10:15: 13:6\n-    let mut _9: u32;                     // in scope 0 at $DIR/generator-drop-cleanup.rs:10:15: 13:6\n+    let mut _6: ();                      // in scope 0 at $DIR/generator-drop-cleanup.rs:10:18: 10:18\n+    let mut _7: ();                      // in scope 0 at $DIR/generator-drop-cleanup.rs:10:15: 13:6\n+    let mut _8: u32;                     // in scope 0 at $DIR/generator-drop-cleanup.rs:10:15: 13:6\n     scope 1 {\n         debug _s => (((*_1) as variant#3).0: std::string::String); // in scope 1 at $DIR/generator-drop-cleanup.rs:11:13: 11:15\n     }\n-    scope 2 (inlined String::new) {      // at $DIR/generator-drop-cleanup.rs:11:18: 11:31\n-        let mut _6: std::vec::Vec<u8>;   // in scope 2 at $DIR/generator-drop-cleanup.rs:11:18: 11:31\n-        scope 3 (inlined Vec::<u8>::new) { // at $DIR/generator-drop-cleanup.rs:11:18: 11:31\n-        }\n-    }\n \n     bb0: {\n-        _9 = discriminant((*_1));        // scope 0 at $DIR/generator-drop-cleanup.rs:10:15: 13:6\n-        switchInt(move _9) -> [0_u32: bb7, 3_u32: bb10, otherwise: bb11]; // scope 0 at $DIR/generator-drop-cleanup.rs:10:15: 13:6\n+        _8 = discriminant((*_1));        // scope 0 at $DIR/generator-drop-cleanup.rs:10:15: 13:6\n+        switchInt(move _8) -> [0_u32: bb7, 3_u32: bb10, otherwise: bb11]; // scope 0 at $DIR/generator-drop-cleanup.rs:10:15: 13:6\n     }\n \n     bb1: {"}, {"sha": "be4d68f2de70714cce3a3fc8507a9223a9f4d4c6", "filename": "src/test/ui/mir/remove-zsts-query-cycle.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/816cda7e1b0cc9a08baa5e44e1e3875b2a70c96e/src%2Ftest%2Fui%2Fmir%2Fremove-zsts-query-cycle.rs", "raw_url": "https://github.com/rust-lang/rust/raw/816cda7e1b0cc9a08baa5e44e1e3875b2a70c96e/src%2Ftest%2Fui%2Fmir%2Fremove-zsts-query-cycle.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmir%2Fremove-zsts-query-cycle.rs?ref=816cda7e1b0cc9a08baa5e44e1e3875b2a70c96e", "patch": "@@ -2,7 +2,7 @@\n //   optimized mir -> remove zsts -> layout of a generator -> optimized mir.\n //\n // edition:2018\n-// compile-flags: --crate-type=lib\n+// compile-flags: --crate-type=lib -Zinline-mir=yes\n // build-pass\n \n pub async fn listen() -> Result<(), std::io::Error> {"}]}