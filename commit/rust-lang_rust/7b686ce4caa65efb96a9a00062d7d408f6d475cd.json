{"sha": "7b686ce4caa65efb96a9a00062d7d408f6d475cd", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdiNjg2Y2U0Y2FhNjVlZmI5NmE5YTAwMDYyZDdkNDA4ZjZkNDc1Y2Q=", "commit": {"author": {"name": "Corey Farwell", "email": "coreyf@rwell.org", "date": "2017-03-19T14:18:12Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2017-03-19T14:18:12Z"}, "message": "Rollup merge of #40441 - tschottdorf:promotable-rfc, r=eddyb\n\nAdd feature gate for rvalue-static-promotion\n\nProbably needs more tests (which ones?) and there may be other things that need to be done. Also not sure whether the version that introduces the flag is really `1.15.1`.\n\nSee https://github.com/rust-lang/rfcs/pull/1414.\n\nUpdates #38865.", "tree": {"sha": "5e842607f7390870fd7ce62c5e10aab8170b70d9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5e842607f7390870fd7ce62c5e10aab8170b70d9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7b686ce4caa65efb96a9a00062d7d408f6d475cd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7b686ce4caa65efb96a9a00062d7d408f6d475cd", "html_url": "https://github.com/rust-lang/rust/commit/7b686ce4caa65efb96a9a00062d7d408f6d475cd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7b686ce4caa65efb96a9a00062d7d408f6d475cd/comments", "author": {"login": "frewsxcv", "id": 416575, "node_id": "MDQ6VXNlcjQxNjU3NQ==", "avatar_url": "https://avatars.githubusercontent.com/u/416575?v=4", "gravatar_id": "", "url": "https://api.github.com/users/frewsxcv", "html_url": "https://github.com/frewsxcv", "followers_url": "https://api.github.com/users/frewsxcv/followers", "following_url": "https://api.github.com/users/frewsxcv/following{/other_user}", "gists_url": "https://api.github.com/users/frewsxcv/gists{/gist_id}", "starred_url": "https://api.github.com/users/frewsxcv/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/frewsxcv/subscriptions", "organizations_url": "https://api.github.com/users/frewsxcv/orgs", "repos_url": "https://api.github.com/users/frewsxcv/repos", "events_url": "https://api.github.com/users/frewsxcv/events{/privacy}", "received_events_url": "https://api.github.com/users/frewsxcv/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9c15de4fd59bee290848b5443c7e194fd5afb02c", "url": "https://api.github.com/repos/rust-lang/rust/commits/9c15de4fd59bee290848b5443c7e194fd5afb02c", "html_url": "https://github.com/rust-lang/rust/commit/9c15de4fd59bee290848b5443c7e194fd5afb02c"}, {"sha": "f06b04949f7944bfe31405d3735240bb02ee9bd1", "url": "https://api.github.com/repos/rust-lang/rust/commits/f06b04949f7944bfe31405d3735240bb02ee9bd1", "html_url": "https://github.com/rust-lang/rust/commit/f06b04949f7944bfe31405d3735240bb02ee9bd1"}], "stats": {"total": 64, "additions": 61, "deletions": 3}, "files": [{"sha": "7820d44920829fe6e3dc1657fc9e8a5e95b361a0", "filename": "src/doc/unstable-book/src/SUMMARY.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7b686ce4caa65efb96a9a00062d7d408f6d475cd/src%2Fdoc%2Funstable-book%2Fsrc%2FSUMMARY.md", "raw_url": "https://github.com/rust-lang/rust/raw/7b686ce4caa65efb96a9a00062d7d408f6d475cd/src%2Fdoc%2Funstable-book%2Fsrc%2FSUMMARY.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Funstable-book%2Fsrc%2FSUMMARY.md?ref=7b686ce4caa65efb96a9a00062d7d408f6d475cd", "patch": "@@ -71,6 +71,7 @@\n - [repr_simd](repr-simd.md)\n - [rustc_attrs](rustc-attrs.md)\n - [rustc_diagnostic_macros](rustc-diagnostic-macros.md)\n+- [rvalue_static_promotion](rvalue-static-promotion.md)\n - [sanitizer_runtime](sanitizer-runtime.md)\n - [simd](simd.md)\n - [simd_ffi](simd-ffi.md)"}, {"sha": "2583d350ebe11d4f6df184e238a471c27334a8b4", "filename": "src/doc/unstable-book/src/rvalue-static-promotion.md", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/7b686ce4caa65efb96a9a00062d7d408f6d475cd/src%2Fdoc%2Funstable-book%2Fsrc%2Frvalue-static-promotion.md", "raw_url": "https://github.com/rust-lang/rust/raw/7b686ce4caa65efb96a9a00062d7d408f6d475cd/src%2Fdoc%2Funstable-book%2Fsrc%2Frvalue-static-promotion.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Funstable-book%2Fsrc%2Frvalue-static-promotion.md?ref=7b686ce4caa65efb96a9a00062d7d408f6d475cd", "patch": "@@ -0,0 +1,23 @@\n+# `rvalue_static_promotion`\n+\n+The tracking issue for this feature is: [#38865]\n+\n+[#38865]: https://github.com/rust-lang/rust/issues/38865\n+\n+------------------------\n+\n+The `rvalue_static_promotion` feature allows directly creating `'static` references to\n+constant `rvalue`s, which in particular allowing for more concise code in the common case\n+in which a `'static` reference is all that's needed.\n+\n+\n+## Examples\n+\n+```rust\n+#![feature(rvalue_static_promotion)]\n+\n+fn main() {\n+    let DEFAULT_VALUE: &'static u32 = &42;\n+    assert_eq!(*DEFAULT_VALUE, 42);\n+}\n+```"}, {"sha": "a1deda0ab3ec1c8e238f244ab71950a1346e8f6b", "filename": "src/librustc/middle/mem_categorization.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/7b686ce4caa65efb96a9a00062d7d408f6d475cd/src%2Flibrustc%2Fmiddle%2Fmem_categorization.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7b686ce4caa65efb96a9a00062d7d408f6d475cd/src%2Flibrustc%2Fmiddle%2Fmem_categorization.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fmem_categorization.rs?ref=7b686ce4caa65efb96a9a00062d7d408f6d475cd", "patch": "@@ -843,11 +843,10 @@ impl<'a, 'gcx, 'tcx> MemCategorizationContext<'a, 'gcx, 'tcx> {\n         let promotable = self.tcx().rvalue_promotable_to_static.borrow().get(&id).cloned()\n                                    .unwrap_or(false);\n \n-        // Only promote `[T; 0]` before an RFC for rvalue promotions\n-        // is accepted.\n+        // When the corresponding feature isn't toggled, only promote `[T; 0]`.\n         let promotable = match expr_ty.sty {\n             ty::TyArray(_, 0) => true,\n-            _ => promotable & false\n+            _ => promotable && self.tcx().sess.features.borrow().rvalue_static_promotion,\n         };\n \n         // Compute maximum lifetime of this rvalue. This is 'static if"}, {"sha": "d07069d030a1bba4099ab2887b16dccf40c54a5f", "filename": "src/libsyntax/feature_gate.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/7b686ce4caa65efb96a9a00062d7d408f6d475cd/src%2Flibsyntax%2Ffeature_gate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7b686ce4caa65efb96a9a00062d7d408f6d475cd/src%2Flibsyntax%2Ffeature_gate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Ffeature_gate.rs?ref=7b686ce4caa65efb96a9a00062d7d408f6d475cd", "patch": "@@ -342,6 +342,9 @@ declare_features! (\n \n     // Allows the `catch {...}` expression\n     (active, catch_expr, \"1.17.0\", Some(31436)),\n+\n+    // See rust-lang/rfcs#1414. Allows code like `let x: &'static u32 = &42` to work.\n+    (active, rvalue_static_promotion, \"1.15.1\", Some(38865)),\n );\n \n declare_features! ("}, {"sha": "f33d0a71481d2d18905dca6aa338aa4dd7cb9cdf", "filename": "src/test/compile-fail/feature-gate-rvalue_static_promotion.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/7b686ce4caa65efb96a9a00062d7d408f6d475cd/src%2Ftest%2Fcompile-fail%2Ffeature-gate-rvalue_static_promotion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7b686ce4caa65efb96a9a00062d7d408f6d475cd/src%2Ftest%2Fcompile-fail%2Ffeature-gate-rvalue_static_promotion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Ffeature-gate-rvalue_static_promotion.rs?ref=7b686ce4caa65efb96a9a00062d7d408f6d475cd", "patch": "@@ -0,0 +1,15 @@\n+// Copyright 2017 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#[allow(unused_variables)]\n+fn main() {\n+    let x: &'static u32 = &42; //~ error: does not live long enough\n+    let y: &'static Option<u32> = &None; //~ error: does not live long enough\n+}"}, {"sha": "30643cfc3eb7d5b5c2527b847aaf3d6991d0e35e", "filename": "src/test/run-pass/rvalue-static-promotion.rs", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/7b686ce4caa65efb96a9a00062d7d408f6d475cd/src%2Ftest%2Frun-pass%2Frvalue-static-promotion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7b686ce4caa65efb96a9a00062d7d408f6d475cd/src%2Ftest%2Frun-pass%2Frvalue-static-promotion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Frvalue-static-promotion.rs?ref=7b686ce4caa65efb96a9a00062d7d408f6d475cd", "patch": "@@ -0,0 +1,17 @@\n+// Copyright 2017 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+#![feature(rvalue_static_promotion)]\n+\n+#[allow(unused_variables)]\n+fn main() {\n+    let x: &'static u32 = &42;\n+    let y: &'static Option<u32> = &None;\n+}"}]}