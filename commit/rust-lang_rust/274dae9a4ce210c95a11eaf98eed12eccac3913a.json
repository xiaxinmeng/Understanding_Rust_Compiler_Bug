{"sha": "274dae9a4ce210c95a11eaf98eed12eccac3913a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI3NGRhZTlhNGNlMjEwYzk1YTExZWFmOThlZWQxMmVjY2FjMzkxM2E=", "commit": {"author": {"name": "Bj\u00f6rn Steinbrink", "email": "bsteinbr@gmail.com", "date": "2015-08-23T13:27:25Z"}, "committer": {"name": "Bj\u00f6rn Steinbrink", "email": "bsteinbr@gmail.com", "date": "2015-08-23T13:35:45Z"}, "message": "Improve codegen for the various \"with overflow\" intrinsics\n\nWe're currently possibly introducing an unneeded temporary, make use of\nInsertValue which is said to kick us off of FastISel and we generate\nloads/stores of first class aggregates, which is bad as well. Let's not\ndo all these things.", "tree": {"sha": "84af2eb1e9b45000640d1e5f91a902276111e87d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/84af2eb1e9b45000640d1e5f91a902276111e87d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/274dae9a4ce210c95a11eaf98eed12eccac3913a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/274dae9a4ce210c95a11eaf98eed12eccac3913a", "html_url": "https://github.com/rust-lang/rust/commit/274dae9a4ce210c95a11eaf98eed12eccac3913a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/274dae9a4ce210c95a11eaf98eed12eccac3913a/comments", "author": {"login": "dotdash", "id": 230962, "node_id": "MDQ6VXNlcjIzMDk2Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dotdash", "html_url": "https://github.com/dotdash", "followers_url": "https://api.github.com/users/dotdash/followers", "following_url": "https://api.github.com/users/dotdash/following{/other_user}", "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}", "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions", "organizations_url": "https://api.github.com/users/dotdash/orgs", "repos_url": "https://api.github.com/users/dotdash/repos", "events_url": "https://api.github.com/users/dotdash/events{/privacy}", "received_events_url": "https://api.github.com/users/dotdash/received_events", "type": "User", "site_admin": false}, "committer": {"login": "dotdash", "id": 230962, "node_id": "MDQ6VXNlcjIzMDk2Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/230962?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dotdash", "html_url": "https://github.com/dotdash", "followers_url": "https://api.github.com/users/dotdash/followers", "following_url": "https://api.github.com/users/dotdash/following{/other_user}", "gists_url": "https://api.github.com/users/dotdash/gists{/gist_id}", "starred_url": "https://api.github.com/users/dotdash/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dotdash/subscriptions", "organizations_url": "https://api.github.com/users/dotdash/orgs", "repos_url": "https://api.github.com/users/dotdash/repos", "events_url": "https://api.github.com/users/dotdash/events{/privacy}", "received_events_url": "https://api.github.com/users/dotdash/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2375743037fdfcb624917ebf87d8d9a142c3e395", "url": "https://api.github.com/repos/rust-lang/rust/commits/2375743037fdfcb624917ebf87d8d9a142c3e395", "html_url": "https://github.com/rust-lang/rust/commit/2375743037fdfcb624917ebf87d8d9a142c3e395"}], "stats": {"total": 64, "additions": 29, "deletions": 35}, "files": [{"sha": "3b6ce32e0b9c55c558801597e148a76189921f5d", "filename": "src/librustc_trans/trans/intrinsic.rs", "status": "modified", "additions": 29, "deletions": 35, "changes": 64, "blob_url": "https://github.com/rust-lang/rust/blob/274dae9a4ce210c95a11eaf98eed12eccac3913a/src%2Flibrustc_trans%2Ftrans%2Fintrinsic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/274dae9a4ce210c95a11eaf98eed12eccac3913a/src%2Flibrustc_trans%2Ftrans%2Fintrinsic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Ftrans%2Fintrinsic.rs?ref=274dae9a4ce210c95a11eaf98eed12eccac3913a", "patch": "@@ -616,171 +616,171 @@ pub fn trans_intrinsic_call<'a, 'blk, 'tcx>(mut bcx: Block<'blk, 'tcx>,\n         (_, \"i8_add_with_overflow\") =>\n             with_overflow_intrinsic(bcx,\n                                     \"llvm.sadd.with.overflow.i8\",\n-                                    ret_ty,\n                                     llargs[0],\n                                     llargs[1],\n+                                    llresult,\n                                     call_debug_location),\n         (_, \"i16_add_with_overflow\") =>\n             with_overflow_intrinsic(bcx,\n                                     \"llvm.sadd.with.overflow.i16\",\n-                                    ret_ty,\n                                     llargs[0],\n                                     llargs[1],\n+                                    llresult,\n                                     call_debug_location),\n         (_, \"i32_add_with_overflow\") =>\n             with_overflow_intrinsic(bcx,\n                                     \"llvm.sadd.with.overflow.i32\",\n-                                    ret_ty,\n                                     llargs[0],\n                                     llargs[1],\n+                                    llresult,\n                                     call_debug_location),\n         (_, \"i64_add_with_overflow\") =>\n             with_overflow_intrinsic(bcx,\n                                     \"llvm.sadd.with.overflow.i64\",\n-                                    ret_ty,\n                                     llargs[0],\n                                     llargs[1],\n+                                    llresult,\n                                     call_debug_location),\n \n         (_, \"u8_add_with_overflow\") =>\n             with_overflow_intrinsic(bcx,\n                                     \"llvm.uadd.with.overflow.i8\",\n-                                    ret_ty,\n                                     llargs[0],\n                                     llargs[1],\n+                                    llresult,\n                                     call_debug_location),\n         (_, \"u16_add_with_overflow\") =>\n             with_overflow_intrinsic(bcx,\n                                     \"llvm.uadd.with.overflow.i16\",\n-                                    ret_ty,\n                                     llargs[0],\n                                     llargs[1],\n+                                    llresult,\n                                     call_debug_location),\n         (_, \"u32_add_with_overflow\") =>\n             with_overflow_intrinsic(bcx,\n                                     \"llvm.uadd.with.overflow.i32\",\n-                                    ret_ty,\n                                     llargs[0],\n                                     llargs[1],\n+                                    llresult,\n                                     call_debug_location),\n         (_, \"u64_add_with_overflow\") =>\n             with_overflow_intrinsic(bcx,\n                                     \"llvm.uadd.with.overflow.i64\",\n-                                    ret_ty,\n                                     llargs[0],\n                                     llargs[1],\n+                                    llresult,\n                                     call_debug_location),\n         (_, \"i8_sub_with_overflow\") =>\n             with_overflow_intrinsic(bcx,\n                                     \"llvm.ssub.with.overflow.i8\",\n-                                    ret_ty,\n                                     llargs[0],\n                                     llargs[1],\n+                                    llresult,\n                                     call_debug_location),\n         (_, \"i16_sub_with_overflow\") =>\n             with_overflow_intrinsic(bcx,\n                                     \"llvm.ssub.with.overflow.i16\",\n-                                    ret_ty,\n                                     llargs[0],\n                                     llargs[1],\n+                                    llresult,\n                                     call_debug_location),\n         (_, \"i32_sub_with_overflow\") =>\n             with_overflow_intrinsic(bcx,\n                                     \"llvm.ssub.with.overflow.i32\",\n-                                    ret_ty,\n                                     llargs[0],\n                                     llargs[1],\n+                                    llresult,\n                                     call_debug_location),\n         (_, \"i64_sub_with_overflow\") =>\n             with_overflow_intrinsic(bcx,\n                                     \"llvm.ssub.with.overflow.i64\",\n-                                    ret_ty,\n                                     llargs[0],\n                                     llargs[1],\n+                                    llresult,\n                                     call_debug_location),\n         (_, \"u8_sub_with_overflow\") =>\n             with_overflow_intrinsic(bcx,\n                                     \"llvm.usub.with.overflow.i8\",\n-                                    ret_ty,\n                                     llargs[0],\n                                     llargs[1],\n+                                    llresult,\n                                     call_debug_location),\n         (_, \"u16_sub_with_overflow\") =>\n             with_overflow_intrinsic(bcx,\n                                     \"llvm.usub.with.overflow.i16\",\n-                                    ret_ty,\n                                     llargs[0],\n                                     llargs[1],\n+                                    llresult,\n                                     call_debug_location),\n         (_, \"u32_sub_with_overflow\") =>\n             with_overflow_intrinsic(bcx,\n                                     \"llvm.usub.with.overflow.i32\",\n-                                    ret_ty,\n                                     llargs[0],\n                                     llargs[1],\n+                                    llresult,\n                                     call_debug_location),\n         (_, \"u64_sub_with_overflow\") =>\n             with_overflow_intrinsic(bcx,\n                                     \"llvm.usub.with.overflow.i64\",\n-                                    ret_ty,\n                                     llargs[0],\n                                     llargs[1],\n+                                    llresult,\n                                     call_debug_location),\n         (_, \"i8_mul_with_overflow\") =>\n             with_overflow_intrinsic(bcx,\n                                     \"llvm.smul.with.overflow.i8\",\n-                                    ret_ty,\n                                     llargs[0],\n                                     llargs[1],\n+                                    llresult,\n                                     call_debug_location),\n         (_, \"i16_mul_with_overflow\") =>\n             with_overflow_intrinsic(bcx,\n                                     \"llvm.smul.with.overflow.i16\",\n-                                    ret_ty,\n                                     llargs[0],\n                                     llargs[1],\n+                                    llresult,\n                                     call_debug_location),\n         (_, \"i32_mul_with_overflow\") =>\n             with_overflow_intrinsic(bcx,\n                                     \"llvm.smul.with.overflow.i32\",\n-                                    ret_ty,\n                                     llargs[0],\n                                     llargs[1],\n+                                    llresult,\n                                     call_debug_location),\n         (_, \"i64_mul_with_overflow\") =>\n             with_overflow_intrinsic(bcx,\n                                     \"llvm.smul.with.overflow.i64\",\n-                                    ret_ty,\n                                     llargs[0],\n                                     llargs[1],\n+                                    llresult,\n                                     call_debug_location),\n         (_, \"u8_mul_with_overflow\") =>\n             with_overflow_intrinsic(bcx,\n                                     \"llvm.umul.with.overflow.i8\",\n-                                    ret_ty,\n                                     llargs[0],\n                                     llargs[1],\n+                                    llresult,\n                                     call_debug_location),\n         (_, \"u16_mul_with_overflow\") =>\n             with_overflow_intrinsic(bcx,\n                                     \"llvm.umul.with.overflow.i16\",\n-                                    ret_ty,\n                                     llargs[0],\n                                     llargs[1],\n+                                    llresult,\n                                     call_debug_location),\n         (_, \"u32_mul_with_overflow\") =>\n             with_overflow_intrinsic(bcx,\n                                     \"llvm.umul.with.overflow.i32\",\n-                                    ret_ty,\n                                     llargs[0],\n                                     llargs[1],\n+                                    llresult,\n                                     call_debug_location),\n         (_, \"u64_mul_with_overflow\") =>\n             with_overflow_intrinsic(bcx,\n                                     \"llvm.umul.with.overflow.i64\",\n-                                    ret_ty,\n                                     llargs[0],\n                                     llargs[1],\n+                                    llresult,\n                                     call_debug_location),\n \n         (_, \"unchecked_udiv\") => UDiv(bcx, llargs[0], llargs[1], call_debug_location),\n@@ -1053,9 +1053,9 @@ fn count_zeros_intrinsic(bcx: Block,\n \n fn with_overflow_intrinsic<'blk, 'tcx>(bcx: Block<'blk, 'tcx>,\n                                        name: &'static str,\n-                                       t: Ty<'tcx>,\n                                        a: ValueRef,\n                                        b: ValueRef,\n+                                       out: ValueRef,\n                                        call_debug_location: DebugLoc)\n                                        -> ValueRef {\n     let llfn = bcx.ccx().get_intrinsic(&name);\n@@ -1064,16 +1064,10 @@ fn with_overflow_intrinsic<'blk, 'tcx>(bcx: Block<'blk, 'tcx>,\n     let val = Call(bcx, llfn, &[a, b], None, call_debug_location);\n     let result = ExtractValue(bcx, val, 0);\n     let overflow = ZExt(bcx, ExtractValue(bcx, val, 1), Type::bool(bcx.ccx()));\n-    let ret = C_undef(type_of::type_of(bcx.ccx(), t));\n-    let ret = InsertValue(bcx, ret, result, 0);\n-    let ret = InsertValue(bcx, ret, overflow, 1);\n-    if !arg_is_indirect(bcx.ccx(), t) {\n-        let tmp = alloc_ty(bcx, t, \"tmp\");\n-        Store(bcx, ret, tmp);\n-        load_ty(bcx, tmp, t)\n-    } else {\n-        ret\n-    }\n+    Store(bcx, result, StructGEP(bcx, out, 0));\n+    Store(bcx, overflow, StructGEP(bcx, out, 1));\n+\n+    C_nil(bcx.ccx())\n }\n \n fn try_intrinsic<'blk, 'tcx>(bcx: Block<'blk, 'tcx>,"}]}