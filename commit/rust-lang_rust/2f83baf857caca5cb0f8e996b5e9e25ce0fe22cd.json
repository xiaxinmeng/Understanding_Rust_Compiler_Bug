{"sha": "2f83baf857caca5cb0f8e996b5e9e25ce0fe22cd", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJmODNiYWY4NTdjYWNhNWNiMGY4ZTk5NmI1ZTllMjVjZTBmZTIyY2Q=", "commit": {"author": {"name": "Tim Chevalier", "email": "chevalier@alum.wellesley.edu", "date": "2012-11-16T00:36:16Z"}, "committer": {"name": "Tim Chevalier", "email": "chevalier@alum.wellesley.edu", "date": "2012-11-16T02:41:17Z"}, "message": "Check for duplicate supertraits and forbid them\n\nAs per #3953", "tree": {"sha": "4156126777f08d1cc484843c1a962034effd48e4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4156126777f08d1cc484843c1a962034effd48e4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2f83baf857caca5cb0f8e996b5e9e25ce0fe22cd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2f83baf857caca5cb0f8e996b5e9e25ce0fe22cd", "html_url": "https://github.com/rust-lang/rust/commit/2f83baf857caca5cb0f8e996b5e9e25ce0fe22cd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2f83baf857caca5cb0f8e996b5e9e25ce0fe22cd/comments", "author": {"login": "catamorphism", "id": 427212, "node_id": "MDQ6VXNlcjQyNzIxMg==", "avatar_url": "https://avatars.githubusercontent.com/u/427212?v=4", "gravatar_id": "", "url": "https://api.github.com/users/catamorphism", "html_url": "https://github.com/catamorphism", "followers_url": "https://api.github.com/users/catamorphism/followers", "following_url": "https://api.github.com/users/catamorphism/following{/other_user}", "gists_url": "https://api.github.com/users/catamorphism/gists{/gist_id}", "starred_url": "https://api.github.com/users/catamorphism/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/catamorphism/subscriptions", "organizations_url": "https://api.github.com/users/catamorphism/orgs", "repos_url": "https://api.github.com/users/catamorphism/repos", "events_url": "https://api.github.com/users/catamorphism/events{/privacy}", "received_events_url": "https://api.github.com/users/catamorphism/received_events", "type": "User", "site_admin": false}, "committer": {"login": "catamorphism", "id": 427212, "node_id": "MDQ6VXNlcjQyNzIxMg==", "avatar_url": "https://avatars.githubusercontent.com/u/427212?v=4", "gravatar_id": "", "url": "https://api.github.com/users/catamorphism", "html_url": "https://github.com/catamorphism", "followers_url": "https://api.github.com/users/catamorphism/followers", "following_url": "https://api.github.com/users/catamorphism/following{/other_user}", "gists_url": "https://api.github.com/users/catamorphism/gists{/gist_id}", "starred_url": "https://api.github.com/users/catamorphism/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/catamorphism/subscriptions", "organizations_url": "https://api.github.com/users/catamorphism/orgs", "repos_url": "https://api.github.com/users/catamorphism/repos", "events_url": "https://api.github.com/users/catamorphism/events{/privacy}", "received_events_url": "https://api.github.com/users/catamorphism/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "82017b8416798b4ad46c1b7416611b353374051a", "url": "https://api.github.com/repos/rust-lang/rust/commits/82017b8416798b4ad46c1b7416611b353374051a", "html_url": "https://github.com/rust-lang/rust/commit/82017b8416798b4ad46c1b7416611b353374051a"}], "stats": {"total": 39, "additions": 36, "deletions": 3}, "files": [{"sha": "7fc0b65d10cae736cc4ea1b1be33ab345b42c2d0", "filename": "src/librustc/middle/typeck/collect.rs", "status": "modified", "additions": 13, "deletions": 3, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/2f83baf857caca5cb0f8e996b5e9e25ce0fe22cd/src%2Flibrustc%2Fmiddle%2Ftypeck%2Fcollect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f83baf857caca5cb0f8e996b5e9e25ce0fe22cd/src%2Flibrustc%2Fmiddle%2Ftypeck%2Fcollect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftypeck%2Fcollect.rs?ref=2f83baf857caca5cb0f8e996b5e9e25ce0fe22cd", "patch": "@@ -254,16 +254,26 @@ fn ensure_trait_methods(ccx: @crate_ctxt, id: ast::node_id, trait_ty: ty::t) {\n \n fn ensure_supertraits(ccx: @crate_ctxt,\n                       id: ast::node_id,\n+                      sp: codemap::span,\n                       rp: Option<ty::region_variance>,\n                       trait_refs: &[@ast::trait_ref]) {\n-    if ccx.tcx.supertraits.contains_key(local_def(id)) { return; }\n+    let tcx = ccx.tcx;\n+    if tcx.supertraits.contains_key(local_def(id)) { return; }\n \n     let instantiated = dvec::DVec();\n     for trait_refs.each |trait_ref| {\n         let (did, tpt) = instantiate_trait_ref(ccx, *trait_ref, rp);\n+        if instantiated.any(|other_trait: &InstantiatedTraitRef|\n+                            { (*other_trait).def_id == did }) {\n+            // This means a trait inherited from the same supertrait more\n+            // than once.\n+            tcx.sess.span_err(sp, ~\"Duplicate supertrait in trait \\\n+                                     declaration\");\n+            return;\n+        }\n         instantiated.push(InstantiatedTraitRef { def_id: did, tpt: tpt });\n     }\n-    ccx.tcx.supertraits.insert(local_def(id),\n+    tcx.supertraits.insert(local_def(id),\n                                @dvec::unwrap(move instantiated));\n }\n \n@@ -551,7 +561,7 @@ fn convert(ccx: @crate_ctxt, it: @ast::item) {\n                it.id, ty_to_str(tcx, tpt.ty));\n         write_ty_to_tcx(tcx, it.id, tpt.ty);\n         ensure_trait_methods(ccx, it.id, tpt.ty);\n-        ensure_supertraits(ccx, it.id, rp, supertraits);\n+        ensure_supertraits(ccx, it.id, it.span, rp, supertraits);\n \n         let (_, provided_methods) = split_trait_methods(trait_methods);\n         let {bounds, _} = mk_substs(ccx, tps, rp);"}, {"sha": "45fa00bd672bfab2e638a238d03d61e49d19f2dd", "filename": "src/test/compile-fail/issue-3953.rs", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/2f83baf857caca5cb0f8e996b5e9e25ce0fe22cd/src%2Ftest%2Fcompile-fail%2Fissue-3953.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f83baf857caca5cb0f8e996b5e9e25ce0fe22cd/src%2Ftest%2Fcompile-fail%2Fissue-3953.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fissue-3953.rs?ref=2f83baf857caca5cb0f8e996b5e9e25ce0fe22cd", "patch": "@@ -0,0 +1,23 @@\n+use cmp::Eq;\n+\n+trait Hahaha: Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, //~ ERROR Duplicate supertrait in trait declaration\n+              Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq,\n+              Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq,\n+              Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq,\n+              Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq,\n+              Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq, Eq {}\n+\n+enum Lol = int;\n+\n+pub impl Lol: Hahaha {\n+    pure fn eq(other: &Lol) -> bool { *self != **other }\n+    pure fn ne(other: &Lol) -> bool { *self == **other }\n+}\n+\n+fn main() {\n+    if Lol(2) == Lol(4) {\n+        io::println(\"2 == 4\");\n+    } else {\n+        io::println(\"2 != 4\");\n+    }\n+}\n\\ No newline at end of file"}]}