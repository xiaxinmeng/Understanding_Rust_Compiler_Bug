{"sha": "6593fcd82498b749f5a1e187fe4b76026ab5ce8e", "node_id": "C_kwDOAAsO6NoAKDY1OTNmY2Q4MjQ5OGI3NDlmNWExZTE4N2ZlNGI3NjAyNmFiNWNlOGU", "commit": {"author": {"name": "Josh Triplett", "email": "josh@joshtriplett.org", "date": "2022-01-02T00:15:36Z"}, "committer": {"name": "Josh Triplett", "email": "josh@joshtriplett.org", "date": "2022-01-02T00:15:36Z"}, "message": "Require `-Zunstable-options` for `-C instrument-coverage=except-*` options\n\nThese options primarily exist to work around bugs, and those bugs have\nlargely been fixed. Avoid stabilizing them, so that we don't have to\nsupport them indefinitely.", "tree": {"sha": "1eff6da4e8764aa0ef7836e6e5b72b649f9f42af", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1eff6da4e8764aa0ef7836e6e5b72b649f9f42af"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6593fcd82498b749f5a1e187fe4b76026ab5ce8e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6593fcd82498b749f5a1e187fe4b76026ab5ce8e", "html_url": "https://github.com/rust-lang/rust/commit/6593fcd82498b749f5a1e187fe4b76026ab5ce8e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6593fcd82498b749f5a1e187fe4b76026ab5ce8e/comments", "author": {"login": "joshtriplett", "id": 162737, "node_id": "MDQ6VXNlcjE2MjczNw==", "avatar_url": "https://avatars.githubusercontent.com/u/162737?v=4", "gravatar_id": "", "url": "https://api.github.com/users/joshtriplett", "html_url": "https://github.com/joshtriplett", "followers_url": "https://api.github.com/users/joshtriplett/followers", "following_url": "https://api.github.com/users/joshtriplett/following{/other_user}", "gists_url": "https://api.github.com/users/joshtriplett/gists{/gist_id}", "starred_url": "https://api.github.com/users/joshtriplett/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/joshtriplett/subscriptions", "organizations_url": "https://api.github.com/users/joshtriplett/orgs", "repos_url": "https://api.github.com/users/joshtriplett/repos", "events_url": "https://api.github.com/users/joshtriplett/events{/privacy}", "received_events_url": "https://api.github.com/users/joshtriplett/received_events", "type": "User", "site_admin": false}, "committer": {"login": "joshtriplett", "id": 162737, "node_id": "MDQ6VXNlcjE2MjczNw==", "avatar_url": "https://avatars.githubusercontent.com/u/162737?v=4", "gravatar_id": "", "url": "https://api.github.com/users/joshtriplett", "html_url": "https://github.com/joshtriplett", "followers_url": "https://api.github.com/users/joshtriplett/followers", "following_url": "https://api.github.com/users/joshtriplett/following{/other_user}", "gists_url": "https://api.github.com/users/joshtriplett/gists{/gist_id}", "starred_url": "https://api.github.com/users/joshtriplett/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/joshtriplett/subscriptions", "organizations_url": "https://api.github.com/users/joshtriplett/orgs", "repos_url": "https://api.github.com/users/joshtriplett/repos", "events_url": "https://api.github.com/users/joshtriplett/events{/privacy}", "received_events_url": "https://api.github.com/users/joshtriplett/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e14bd48476bf3d8613f6b1ac1f79d4c7010da6ac", "url": "https://api.github.com/repos/rust-lang/rust/commits/e14bd48476bf3d8613f6b1ac1f79d4c7010da6ac", "html_url": "https://github.com/rust-lang/rust/commit/e14bd48476bf3d8613f6b1ac1f79d4c7010da6ac"}], "stats": {"total": 23, "additions": 15, "deletions": 8}, "files": [{"sha": "7e8e4a75b37e6dfa93655d88b28a8f8688303654", "filename": "compiler/rustc_session/src/config.rs", "status": "modified", "additions": 11, "deletions": 4, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/6593fcd82498b749f5a1e187fe4b76026ab5ce8e/compiler%2Frustc_session%2Fsrc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6593fcd82498b749f5a1e187fe4b76026ab5ce8e/compiler%2Frustc_session%2Fsrc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Fconfig.rs?ref=6593fcd82498b749f5a1e187fe4b76026ab5ce8e", "patch": "@@ -135,8 +135,8 @@ pub enum MirSpanview {\n /// selected, code structure, and enabled attributes. If errors are encountered,\n /// either while compiling or when generating `llvm-cov show` reports, consider\n /// lowering the optimization level, including or excluding `-C link-dead-code`,\n-/// or using `-C instrument-coverage=except-unused-functions` or `-C\n-/// instrument-coverage=except-unused-generics`.\n+/// or using `-Zunstable-options -C instrument-coverage=except-unused-functions`\n+/// or `-Zunstable-options -C instrument-coverage=except-unused-generics`.\n ///\n /// Note that `ExceptUnusedFunctions` means: When `mapgen.rs` generates the\n /// coverage map, it will not attempt to generate synthetic functions for unused\n@@ -150,9 +150,9 @@ pub enum MirSpanview {\n pub enum InstrumentCoverage {\n     /// Default `-C instrument-coverage` or `-C instrument-coverage=statement`\n     All,\n-    /// `-C instrument-coverage=except-unused-generics`\n+    /// `-Zunstable-options -C instrument-coverage=except-unused-generics`\n     ExceptUnusedGenerics,\n-    /// `-C instrument-coverage=except-unused-functions`\n+    /// `-Zunstable-options -C instrument-coverage=except-unused-functions`\n     ExceptUnusedFunctions,\n     /// `-C instrument-coverage=off` (or `no`, etc.)\n     Off,\n@@ -2154,6 +2154,13 @@ pub fn build_session_options(matches: &getopts::Matches) -> Options {\n                 and `-Z instrument-coverage`\",\n             );\n         }\n+        (Some(InstrumentCoverage::Off | InstrumentCoverage::All), _) => {}\n+        (Some(_), _) if !debugging_opts.unstable_options => {\n+            early_error(\n+                error_format,\n+                \"`-C instrument-coverage=except-*` requires `-Z unstable-options`\",\n+            );\n+        }\n         (None, None) => {}\n         (None, ic) => {\n             early_warn("}, {"sha": "b94989161ccfc6bc7099f018d275e545954b8e79", "filename": "src/doc/rustc/src/instrument-coverage.md", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/6593fcd82498b749f5a1e187fe4b76026ab5ce8e/src%2Fdoc%2Frustc%2Fsrc%2Finstrument-coverage.md", "raw_url": "https://github.com/rust-lang/rust/raw/6593fcd82498b749f5a1e187fe4b76026ab5ce8e/src%2Fdoc%2Frustc%2Fsrc%2Finstrument-coverage.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Frustc%2Fsrc%2Finstrument-coverage.md?ref=6593fcd82498b749f5a1e187fe4b76026ab5ce8e", "patch": "@@ -318,9 +318,9 @@ $ llvm-cov report \\\n ## `-C instrument-coverage=<options>`\n \n -   `-C instrument-coverage=all`: Instrument all functions, including unused functions and unused generics. (This is the same as `-C instrument-coverage`, with no value.)\n--   `-C instrument-coverage=except-unused-generics`: Instrument all functions except unused generics.\n--   `-C instrument-coverage=except-unused-functions`: Instrument only used (called) functions and instantiated generic functions.\n -   `-C instrument-coverage=off`: Do not instrument any functions. (This is the same as simply not including the `-C instrument-coverage` option.)\n+-   `-Zunstable-options -C instrument-coverage=except-unused-generics`: Instrument all functions except unused generics.\n+-   `-Zunstable-options -C instrument-coverage=except-unused-functions`: Instrument only used (called) functions and instantiated generic functions.\n \n ## Other references\n "}, {"sha": "96c066e0623dda31f14b274750270450e92fdccd", "filename": "src/test/run-make-fulldeps/coverage-reports/expected_show_coverage.uses_crate.txt", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/6593fcd82498b749f5a1e187fe4b76026ab5ce8e/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.uses_crate.txt", "raw_url": "https://github.com/rust-lang/rust/raw/6593fcd82498b749f5a1e187fe4b76026ab5ce8e/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.uses_crate.txt", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fcoverage-reports%2Fexpected_show_coverage.uses_crate.txt?ref=6593fcd82498b749f5a1e187fe4b76026ab5ce8e", "patch": "@@ -125,7 +125,7 @@\n    78|       |// generic functions with:\n    79|       |//\n    80|       |// ```shell\n-   81|       |// $ `rustc -C instrument-coverage=except-unused-generics ...`\n+   81|       |// $ `rustc -Zunstable-options -C instrument-coverage=except-unused-generics ...`\n    82|       |// ```\n    83|       |//\n    84|       |// Even though this function is used by `uses_crate.rs` (and"}, {"sha": "8b8b1f7f351fd7d9a1905562450313b2354efaaa", "filename": "src/test/run-make-fulldeps/coverage/lib/used_crate.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/6593fcd82498b749f5a1e187fe4b76026ab5ce8e/src%2Ftest%2Frun-make-fulldeps%2Fcoverage%2Flib%2Fused_crate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6593fcd82498b749f5a1e187fe4b76026ab5ce8e/src%2Ftest%2Frun-make-fulldeps%2Fcoverage%2Flib%2Fused_crate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Fcoverage%2Flib%2Fused_crate.rs?ref=6593fcd82498b749f5a1e187fe4b76026ab5ce8e", "patch": "@@ -78,7 +78,7 @@ fn use_this_lib_crate() {\n // generic functions with:\n //\n // ```shell\n-// $ `rustc -C instrument-coverage=except-unused-generics ...`\n+// $ `rustc -Zunstable-options -C instrument-coverage=except-unused-generics ...`\n // ```\n //\n // Even though this function is used by `uses_crate.rs` (and"}]}