{"sha": "785eb32f49653fbc5789396af4fa6ad61f89fb38", "node_id": "MDY6Q29tbWl0NzI0NzEyOjc4NWViMzJmNDk2NTNmYmM1Nzg5Mzk2YWY0ZmE2YWQ2MWY4OWZiMzg=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-03-25T12:53:48Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-03-25T12:53:48Z"}, "message": "Merge #3717\n\n3717: Always expand macros during analysis r=matklad a=matklad\n\n\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>", "tree": {"sha": "122bfa08be70a7dc435a0bbb2cca720ce26e053b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/122bfa08be70a7dc435a0bbb2cca720ce26e053b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/785eb32f49653fbc5789396af4fa6ad61f89fb38", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJee1RcCRBK7hj4Ov3rIwAAdHIIAJL4V8qEnudAuqLL3ymbYmYF\nxJIwwXAc24nWnvUfuCrRTUl/gAc8TG8X7tFJye0IXNWQ2pg2jI3kYDOoBGUUyntH\ncMKh5PBIpaaN0S64/wJjyXvXh8gZtMwrCbPCkJ2alN5ZMgkuD1TX3Nwx3uc+H1eU\nMJseMBXWe9ldmICeG3o1U0lFf5UhjHT9hoPlXnUgriNKYbh5Luwpj2mu6bLCz3y1\nsF3+VOccjxxo/5mLNtQ0PolI8XWwmmiF54YiVPsmOpZRFFt/4HSUefIjkmklnyBK\n7oz4R5wYD1it3KO31gA92G6DjZiKCOGLUxD1Y/CAK/xWwClofqBPiKiXfmB/Rl0=\n=uziO\n-----END PGP SIGNATURE-----\n", "payload": "tree 122bfa08be70a7dc435a0bbb2cca720ce26e053b\nparent 8d667bb32ed8460988bf9fe3515a6f8318adb8b0\nparent 2ccfb49baba6a9a0381e8a5be77df5a3c8f46205\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1585140828 +0000\ncommitter GitHub <noreply@github.com> 1585140828 +0000\n\nMerge #3717\n\n3717: Always expand macros during analysis r=matklad a=matklad\n\n\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/785eb32f49653fbc5789396af4fa6ad61f89fb38", "html_url": "https://github.com/rust-lang/rust/commit/785eb32f49653fbc5789396af4fa6ad61f89fb38", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/785eb32f49653fbc5789396af4fa6ad61f89fb38/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8d667bb32ed8460988bf9fe3515a6f8318adb8b0", "url": "https://api.github.com/repos/rust-lang/rust/commits/8d667bb32ed8460988bf9fe3515a6f8318adb8b0", "html_url": "https://github.com/rust-lang/rust/commit/8d667bb32ed8460988bf9fe3515a6f8318adb8b0"}, {"sha": "2ccfb49baba6a9a0381e8a5be77df5a3c8f46205", "url": "https://api.github.com/repos/rust-lang/rust/commits/2ccfb49baba6a9a0381e8a5be77df5a3c8f46205", "html_url": "https://github.com/rust-lang/rust/commit/2ccfb49baba6a9a0381e8a5be77df5a3c8f46205"}], "stats": {"total": 74, "additions": 51, "deletions": 23}, "files": [{"sha": "16a5fe9680973f6ded918c65d148a081bd618a03", "filename": "crates/ra_hir/src/semantics.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/785eb32f49653fbc5789396af4fa6ad61f89fb38/crates%2Fra_hir%2Fsrc%2Fsemantics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/785eb32f49653fbc5789396af4fa6ad61f89fb38/crates%2Fra_hir%2Fsrc%2Fsemantics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fsemantics.rs?ref=785eb32f49653fbc5789396af4fa6ad61f89fb38", "patch": "@@ -173,11 +173,11 @@ impl<'db, DB: HirDatabase> Semantics<'db, DB> {\n     }\n \n     pub fn resolve_method_call(&self, call: &ast::MethodCallExpr) -> Option<Function> {\n-        self.analyze(call.syntax()).resolve_method_call(call)\n+        self.analyze(call.syntax()).resolve_method_call(self.db, call)\n     }\n \n     pub fn resolve_field(&self, field: &ast::FieldExpr) -> Option<StructField> {\n-        self.analyze(field.syntax()).resolve_field(field)\n+        self.analyze(field.syntax()).resolve_field(self.db, field)\n     }\n \n     pub fn resolve_record_field(\n@@ -188,7 +188,7 @@ impl<'db, DB: HirDatabase> Semantics<'db, DB> {\n     }\n \n     pub fn resolve_record_literal(&self, record_lit: &ast::RecordLit) -> Option<VariantDef> {\n-        self.analyze(record_lit.syntax()).resolve_record_literal(record_lit)\n+        self.analyze(record_lit.syntax()).resolve_record_literal(self.db, record_lit)\n     }\n \n     pub fn resolve_record_pattern(&self, record_pat: &ast::RecordPat) -> Option<VariantDef> {"}, {"sha": "815ca158c140e4f4dc9ea13f5bc2d2c3b5031605", "filename": "crates/ra_hir/src/source_analyzer.rs", "status": "modified", "additions": 26, "deletions": 18, "changes": 44, "blob_url": "https://github.com/rust-lang/rust/blob/785eb32f49653fbc5789396af4fa6ad61f89fb38/crates%2Fra_hir%2Fsrc%2Fsource_analyzer.rs", "raw_url": "https://github.com/rust-lang/rust/raw/785eb32f49653fbc5789396af4fa6ad61f89fb38/crates%2Fra_hir%2Fsrc%2Fsource_analyzer.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fsource_analyzer.rs?ref=785eb32f49653fbc5789396af4fa6ad61f89fb38", "patch": "@@ -78,9 +78,15 @@ impl SourceAnalyzer {\n         }\n     }\n \n-    fn expr_id(&self, expr: &ast::Expr) -> Option<ExprId> {\n-        let src = InFile { file_id: self.file_id, value: expr };\n-        self.body_source_map.as_ref()?.node_expr(src)\n+    fn expr_id(&self, db: &dyn HirDatabase, expr: &ast::Expr) -> Option<ExprId> {\n+        let src = match expr {\n+            ast::Expr::MacroCall(call) => {\n+                self.expand_expr(db, InFile::new(self.file_id, call.clone()))?\n+            }\n+            _ => InFile::new(self.file_id, expr.clone()),\n+        };\n+        let sm = self.body_source_map.as_ref()?;\n+        sm.node_expr(src.as_ref())\n     }\n \n     fn pat_id(&self, pat: &ast::Pat) -> Option<PatId> {\n@@ -104,14 +110,7 @@ impl SourceAnalyzer {\n     }\n \n     pub(crate) fn type_of(&self, db: &dyn HirDatabase, expr: &ast::Expr) -> Option<Type> {\n-        let expr_id = match expr {\n-            ast::Expr::MacroCall(call) => {\n-                let expr = self.expand_expr(db, InFile::new(self.file_id, call.clone()))?;\n-                self.body_source_map.as_ref()?.node_expr(expr.as_ref())\n-            }\n-            _ => self.expr_id(expr),\n-        }?;\n-\n+        let expr_id = self.expr_id(db, expr)?;\n         let ty = self.infer.as_ref()?[expr_id].clone();\n         Type::new_with_resolver(db, &self.resolver, ty)\n     }\n@@ -122,13 +121,21 @@ impl SourceAnalyzer {\n         Type::new_with_resolver(db, &self.resolver, ty)\n     }\n \n-    pub(crate) fn resolve_method_call(&self, call: &ast::MethodCallExpr) -> Option<Function> {\n-        let expr_id = self.expr_id(&call.clone().into())?;\n+    pub(crate) fn resolve_method_call(\n+        &self,\n+        db: &dyn HirDatabase,\n+        call: &ast::MethodCallExpr,\n+    ) -> Option<Function> {\n+        let expr_id = self.expr_id(db, &call.clone().into())?;\n         self.infer.as_ref()?.method_resolution(expr_id).map(Function::from)\n     }\n \n-    pub(crate) fn resolve_field(&self, field: &ast::FieldExpr) -> Option<crate::StructField> {\n-        let expr_id = self.expr_id(&field.clone().into())?;\n+    pub(crate) fn resolve_field(\n+        &self,\n+        db: &dyn HirDatabase,\n+        field: &ast::FieldExpr,\n+    ) -> Option<crate::StructField> {\n+        let expr_id = self.expr_id(db, &field.clone().into())?;\n         self.infer.as_ref()?.field_resolution(expr_id).map(|it| it.into())\n     }\n \n@@ -138,7 +145,7 @@ impl SourceAnalyzer {\n         field: &ast::RecordField,\n     ) -> Option<(crate::StructField, Option<Local>)> {\n         let (expr_id, local) = match field.expr() {\n-            Some(it) => (self.expr_id(&it)?, None),\n+            Some(it) => (self.expr_id(db, &it)?, None),\n             None => {\n                 let src = InFile { file_id: self.file_id, value: field };\n                 let expr_id = self.body_source_map.as_ref()?.field_init_shorthand_expr(src)?;\n@@ -159,9 +166,10 @@ impl SourceAnalyzer {\n \n     pub(crate) fn resolve_record_literal(\n         &self,\n+        db: &dyn HirDatabase,\n         record_lit: &ast::RecordLit,\n     ) -> Option<crate::VariantDef> {\n-        let expr_id = self.expr_id(&record_lit.clone().into())?;\n+        let expr_id = self.expr_id(db, &record_lit.clone().into())?;\n         self.infer.as_ref()?.variant_resolution_for_expr(expr_id).map(|it| it.into())\n     }\n \n@@ -207,7 +215,7 @@ impl SourceAnalyzer {\n         path: &ast::Path,\n     ) -> Option<PathResolution> {\n         if let Some(path_expr) = path.syntax().parent().and_then(ast::PathExpr::cast) {\n-            let expr_id = self.expr_id(&path_expr.into())?;\n+            let expr_id = self.expr_id(db, &path_expr.into())?;\n             if let Some(assoc) = self.infer.as_ref()?.assoc_resolutions_for_expr(expr_id) {\n                 return Some(PathResolution::AssocItem(assoc.into()));\n             }"}, {"sha": "8aed94d162aba166761d94dcf62c872674bd523d", "filename": "crates/ra_ide/src/goto_definition.rs", "status": "modified", "additions": 22, "deletions": 2, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/785eb32f49653fbc5789396af4fa6ad61f89fb38/crates%2Fra_ide%2Fsrc%2Fgoto_definition.rs", "raw_url": "https://github.com/rust-lang/rust/raw/785eb32f49653fbc5789396af4fa6ad61f89fb38/crates%2Fra_ide%2Fsrc%2Fgoto_definition.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fgoto_definition.rs?ref=785eb32f49653fbc5789396af4fa6ad61f89fb38", "patch": "@@ -104,6 +104,9 @@ mod tests {\n         let (analysis, pos) = analysis_and_position(ra_fixture);\n \n         let mut navs = analysis.goto_definition(pos).unwrap().unwrap().info;\n+        if navs.len() == 0 {\n+            panic!(\"unresolved reference\")\n+        }\n         assert_eq!(navs.len(), 1);\n \n         let nav = navs.pop().unwrap();\n@@ -359,7 +362,7 @@ mod tests {\n     fn goto_def_for_fields() {\n         covers!(ra_ide_db::goto_def_for_fields);\n         check_goto(\n-            \"\n+            r\"\n             //- /lib.rs\n             struct Foo {\n                 spam: u32,\n@@ -378,7 +381,7 @@ mod tests {\n     fn goto_def_for_record_fields() {\n         covers!(ra_ide_db::goto_def_for_record_fields);\n         check_goto(\n-            \"\n+            r\"\n             //- /lib.rs\n             struct Foo {\n                 spam: u32,\n@@ -395,6 +398,23 @@ mod tests {\n         );\n     }\n \n+    #[test]\n+    fn goto_def_for_record_fields_macros() {\n+        check_goto(\n+            r\"\n+            //- /lib.rs\n+            macro_rules! m { () => { 92 };}\n+            struct Foo { spam: u32 }\n+\n+            fn bar() -> Foo {\n+                Foo { spam<|>: m!() }\n+            }\n+            \",\n+            \"spam RECORD_FIELD_DEF FileId(1) [45; 54) [45; 49)\",\n+            \"spam: u32|spam\",\n+        );\n+    }\n+\n     #[test]\n     fn goto_for_tuple_fields() {\n         check_goto("}]}