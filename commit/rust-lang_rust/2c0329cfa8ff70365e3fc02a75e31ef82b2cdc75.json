{"sha": "2c0329cfa8ff70365e3fc02a75e31ef82b2cdc75", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJjMDMyOWNmYThmZjcwMzY1ZTNmYzAyYTc1ZTMxZWY4MmIyY2RjNzU=", "commit": {"author": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2015-03-31T03:34:37Z"}, "committer": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2015-03-31T03:34:37Z"}, "message": "Rollup merge of #23852 - cmr:missing_doc, r=Manishearth\n\nDue to a long-standing conservative approach to trait exports, all traits are\nconsidered exported. However, the missing_docs lint uses the export map to\ndetermine if something is public and ought to have documentation. This commit\nmodifies the lint to check if traits are private before emitting the warning.\n\nCloses #11592", "tree": {"sha": "399090ddd7329d1ef151ffc991a740d82d992c92", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/399090ddd7329d1ef151ffc991a740d82d992c92"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2c0329cfa8ff70365e3fc02a75e31ef82b2cdc75", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2c0329cfa8ff70365e3fc02a75e31ef82b2cdc75", "html_url": "https://github.com/rust-lang/rust/commit/2c0329cfa8ff70365e3fc02a75e31ef82b2cdc75", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2c0329cfa8ff70365e3fc02a75e31ef82b2cdc75/comments", "author": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e76b41276318352643773d2eeb58c6f68c03724e", "url": "https://api.github.com/repos/rust-lang/rust/commits/e76b41276318352643773d2eeb58c6f68c03724e", "html_url": "https://github.com/rust-lang/rust/commit/e76b41276318352643773d2eeb58c6f68c03724e"}, {"sha": "31a52852009958c58828ebf174cfd609503602e1", "url": "https://api.github.com/repos/rust-lang/rust/commits/31a52852009958c58828ebf174cfd609503602e1", "html_url": "https://github.com/rust-lang/rust/commit/31a52852009958c58828ebf174cfd609503602e1"}], "stats": {"total": 56, "additions": 54, "deletions": 2}, "files": [{"sha": "586a1eb085c1c4e841dcba8ef76680913c872d23", "filename": "src/librustc_lint/builtin.rs", "status": "modified", "additions": 34, "deletions": 2, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/2c0329cfa8ff70365e3fc02a75e31ef82b2cdc75/src%2Flibrustc_lint%2Fbuiltin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2c0329cfa8ff70365e3fc02a75e31ef82b2cdc75/src%2Flibrustc_lint%2Fbuiltin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_lint%2Fbuiltin.rs?ref=2c0329cfa8ff70365e3fc02a75e31ef82b2cdc75", "patch": "@@ -39,7 +39,7 @@ use util::ppaux::ty_to_string;\n use util::nodemap::{FnvHashMap, NodeSet};\n use lint::{Level, Context, LintPass, LintArray, Lint};\n \n-use std::collections::BitSet;\n+use std::collections::{HashSet, BitSet};\n use std::collections::hash_map::Entry::{Occupied, Vacant};\n use std::num::SignedInt;\n use std::{cmp, slice};\n@@ -1437,6 +1437,9 @@ pub struct MissingDoc {\n     /// Stack of whether #[doc(hidden)] is set\n     /// at each level which has lint attributes.\n     doc_hidden_stack: Vec<bool>,\n+\n+    /// Private traits or trait items that leaked through. Don't check their methods.\n+    private_traits: HashSet<ast::NodeId>,\n }\n \n impl MissingDoc {\n@@ -1445,6 +1448,7 @@ impl MissingDoc {\n             struct_def_stack: vec!(),\n             in_variant: false,\n             doc_hidden_stack: vec!(false),\n+            private_traits: HashSet::new(),\n         }\n     }\n \n@@ -1531,18 +1535,46 @@ impl LintPass for MissingDoc {\n             ast::ItemMod(..) => \"a module\",\n             ast::ItemEnum(..) => \"an enum\",\n             ast::ItemStruct(..) => \"a struct\",\n-            ast::ItemTrait(..) => \"a trait\",\n+            ast::ItemTrait(_, _, _, ref items) => {\n+                // Issue #11592, traits are always considered exported, even when private.\n+                if it.vis == ast::Visibility::Inherited {\n+                    self.private_traits.insert(it.id);\n+                    for itm in items {\n+                        self.private_traits.insert(itm.id);\n+                    }\n+                    return\n+                }\n+                \"a trait\"\n+            },\n             ast::ItemTy(..) => \"a type alias\",\n+            ast::ItemImpl(_, _, _, Some(ref trait_ref), _, ref impl_items) => {\n+                // If the trait is private, add the impl items to private_traits so they don't get\n+                // reported for missing docs.\n+                let real_trait = ty::trait_ref_to_def_id(cx.tcx, trait_ref);\n+                match cx.tcx.map.find(real_trait.node) {\n+                    Some(ast_map::NodeItem(item)) => if item.vis == ast::Visibility::Inherited {\n+                        for itm in impl_items {\n+                            self.private_traits.insert(itm.id);\n+                        }\n+                    },\n+                    _ => { }\n+                }\n+                return\n+            },\n             _ => return\n         };\n+\n         self.check_missing_docs_attrs(cx, Some(it.id), &it.attrs, it.span, desc);\n     }\n \n     fn check_trait_item(&mut self, cx: &Context, trait_item: &ast::TraitItem) {\n+        if self.private_traits.contains(&trait_item.id) { return }\n+\n         let desc = match trait_item.node {\n             ast::MethodTraitItem(..) => \"a trait method\",\n             ast::TypeTraitItem(..) => \"an associated type\"\n         };\n+\n         self.check_missing_docs_attrs(cx, Some(trait_item.id),\n                                       &trait_item.attrs,\n                                       trait_item.span, desc);"}, {"sha": "432e7ff20254f6d68bedc5b45cb0700b7283de08", "filename": "src/test/run-pass/issue-11592.rs", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/2c0329cfa8ff70365e3fc02a75e31ef82b2cdc75/src%2Ftest%2Frun-pass%2Fissue-11592.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2c0329cfa8ff70365e3fc02a75e31ef82b2cdc75/src%2Ftest%2Frun-pass%2Fissue-11592.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fissue-11592.rs?ref=2c0329cfa8ff70365e3fc02a75e31ef82b2cdc75", "patch": "@@ -0,0 +1,20 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+//! Ensure the private trait Bar isn't complained about.\n+\n+#![deny(missing_docs)]\n+\n+mod foo {\n+    trait Bar { fn bar(&self) { } }\n+    impl Bar for i8 { fn bar(&self) { } }\n+}\n+\n+fn main() { }"}]}