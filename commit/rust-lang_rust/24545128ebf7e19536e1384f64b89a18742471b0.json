{"sha": "24545128ebf7e19536e1384f64b89a18742471b0", "node_id": "MDY6Q29tbWl0NzI0NzEyOjI0NTQ1MTI4ZWJmN2UxOTUzNmUxMzg0ZjY0Yjg5YTE4NzQyNDcxYjA=", "commit": {"author": {"name": "Mark Rousskov", "email": "mark.simulacrum@gmail.com", "date": "2019-10-07T22:10:41Z"}, "committer": {"name": "Mark Rousskov", "email": "mark.simulacrum@gmail.com", "date": "2019-10-17T23:16:41Z"}, "message": "Take lint passes as constructor functions", "tree": {"sha": "8d73444f13a19ba82065f161899a1cfca6a219c0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8d73444f13a19ba82065f161899a1cfca6a219c0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/24545128ebf7e19536e1384f64b89a18742471b0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/24545128ebf7e19536e1384f64b89a18742471b0", "html_url": "https://github.com/rust-lang/rust/commit/24545128ebf7e19536e1384f64b89a18742471b0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/24545128ebf7e19536e1384f64b89a18742471b0/comments", "author": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7fef39791a093681c59f08181f96a0a2d63ab981", "url": "https://api.github.com/repos/rust-lang/rust/commits/7fef39791a093681c59f08181f96a0a2d63ab981", "html_url": "https://github.com/rust-lang/rust/commit/7fef39791a093681c59f08181f96a0a2d63ab981"}], "stats": {"total": 37, "additions": 19, "deletions": 18}, "files": [{"sha": "73d8bb11b719cb58162cd731bc8db22393b9f548", "filename": "src/librustc/lint/context.rs", "status": "modified", "additions": 8, "deletions": 8, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/24545128ebf7e19536e1384f64b89a18742471b0/src%2Flibrustc%2Flint%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/24545128ebf7e19536e1384f64b89a18742471b0/src%2Flibrustc%2Flint%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Flint%2Fcontext.rs?ref=24545128ebf7e19536e1384f64b89a18742471b0", "patch": "@@ -168,20 +168,20 @@ impl LintStore {\n             .collect()\n     }\n \n-    pub fn register_early_pass(&mut self, pass: EarlyLintPassObject) {\n-        self.early_passes.as_mut().unwrap().push(pass);\n+    pub fn register_early_pass(&mut self, pass: fn() -> EarlyLintPassObject) {\n+        self.early_passes.as_mut().unwrap().push((pass)());\n     }\n \n-    pub fn register_pre_expansion_pass(&mut self, pass: EarlyLintPassObject) {\n-        self.pre_expansion_passes.as_mut().unwrap().push(pass);\n+    pub fn register_pre_expansion_pass(&mut self, pass: fn() -> EarlyLintPassObject) {\n+        self.pre_expansion_passes.as_mut().unwrap().push((pass)());\n     }\n \n-    pub fn register_late_pass(&mut self, pass: LateLintPassObject) {\n-        self.late_passes.lock().as_mut().unwrap().push(pass);\n+    pub fn register_late_pass(&mut self, pass: fn() -> LateLintPassObject) {\n+        self.late_passes.lock().as_mut().unwrap().push((pass)());\n     }\n \n-    pub fn register_late_mod_pass(&mut self, pass: LateLintPassObject) {\n-        self.late_module_passes.push(pass);\n+    pub fn register_late_mod_pass(&mut self, pass: fn() -> LateLintPassObject) {\n+        self.late_module_passes.push((pass)());\n     }\n \n     // Helper method for register_early/late_pass"}, {"sha": "0026c2317d15621be89943de4687a436afca8d73", "filename": "src/librustc_lint/lib.rs", "status": "modified", "additions": 4, "deletions": 5, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/24545128ebf7e19536e1384f64b89a18742471b0/src%2Flibrustc_lint%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/24545128ebf7e19536e1384f64b89a18742471b0/src%2Flibrustc_lint%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_lint%2Flib.rs?ref=24545128ebf7e19536e1384f64b89a18742471b0", "patch": "@@ -205,9 +205,8 @@ pub fn register_builtins(store: &mut lint::LintStore, no_interleave_lints: bool)\n \n     macro_rules! register_pass {\n         ($method:ident, $ty:ident, $constructor:expr) => (\n-            let obj = box $constructor;\n             store.register_lints(&$ty::get_lints());\n-            store.$method(obj);\n+            store.$method(|| box $constructor);\n         )\n     }\n \n@@ -487,11 +486,11 @@ pub fn register_builtins(store: &mut lint::LintStore, no_interleave_lints: bool)\n \n pub fn register_internals(store: &mut lint::LintStore) {\n     store.register_lints(&DefaultHashTypes::get_lints());\n-    store.register_early_pass(box DefaultHashTypes::new());\n+    store.register_early_pass(|| box DefaultHashTypes::new());\n     store.register_lints(&LintPassImpl::get_lints());\n-    store.register_early_pass(box LintPassImpl);\n+    store.register_early_pass(|| box LintPassImpl);\n     store.register_lints(&TyTyKind::get_lints());\n-    store.register_late_pass(box TyTyKind);\n+    store.register_late_pass(|| box TyTyKind);\n     store.register_group(\n         false,\n         \"rustc::internal\","}, {"sha": "44318bf06aaaff851b8997952c4ffba015eb85fb", "filename": "src/librustc_plugin/registry.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/24545128ebf7e19536e1384f64b89a18742471b0/src%2Flibrustc_plugin%2Fregistry.rs", "raw_url": "https://github.com/rust-lang/rust/raw/24545128ebf7e19536e1384f64b89a18742471b0/src%2Flibrustc_plugin%2Fregistry.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_plugin%2Fregistry.rs?ref=24545128ebf7e19536e1384f64b89a18742471b0", "patch": "@@ -36,10 +36,10 @@ pub struct Registry<'a> {\n     pub syntax_exts: Vec<NamedSyntaxExtension>,\n \n     #[doc(hidden)]\n-    pub early_lint_passes: Vec<EarlyLintPassObject>,\n+    pub early_lint_passes: Vec<fn() -> EarlyLintPassObject>,\n \n     #[doc(hidden)]\n-    pub late_lint_passes: Vec<LateLintPassObject>,\n+    pub late_lint_passes: Vec<fn() -> LateLintPassObject>,\n \n     #[doc(hidden)]\n     pub lints: Vec<&'static Lint>,\n@@ -109,12 +109,12 @@ impl<'a> Registry<'a> {\n     }\n \n     /// Register a compiler lint pass.\n-    pub fn register_early_lint_pass(&mut self, lint_pass: EarlyLintPassObject) {\n+    pub fn register_early_lint_pass(&mut self, lint_pass: fn() -> EarlyLintPassObject) {\n         self.early_lint_passes.push(lint_pass);\n     }\n \n     /// Register a compiler lint pass.\n-    pub fn register_late_lint_pass(&mut self, lint_pass: LateLintPassObject) {\n+    pub fn register_late_lint_pass(&mut self, lint_pass: fn() -> LateLintPassObject) {\n         self.late_lint_passes.push(lint_pass);\n     }\n     /// Register a lint group."}, {"sha": "ba5b5d1906aea7cd787c9f42924648359bc828a9", "filename": "src/test/ui-fulldeps/auxiliary/lint-for-crate.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/24545128ebf7e19536e1384f64b89a18742471b0/src%2Ftest%2Fui-fulldeps%2Fauxiliary%2Flint-for-crate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/24545128ebf7e19536e1384f64b89a18742471b0/src%2Ftest%2Fui-fulldeps%2Fauxiliary%2Flint-for-crate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui-fulldeps%2Fauxiliary%2Flint-for-crate.rs?ref=24545128ebf7e19536e1384f64b89a18742471b0", "patch": "@@ -32,5 +32,6 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for Pass {\n \n #[plugin_registrar]\n pub fn plugin_registrar(reg: &mut Registry) {\n-    reg.register_late_lint_pass(box Pass);\n+    reg.register_lint(&[&CRATE_NOT_OKAY]);\n+    reg.register_late_lint_pass(|| box Pass);\n }"}, {"sha": "0dbdf4f5aa9e21abac0d0ce2475aa524474f27dd", "filename": "src/test/ui-fulldeps/internal-lints/lint_pass_impl_without_macro.stderr", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/24545128ebf7e19536e1384f64b89a18742471b0/src%2Ftest%2Fui-fulldeps%2Finternal-lints%2Flint_pass_impl_without_macro.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/24545128ebf7e19536e1384f64b89a18742471b0/src%2Ftest%2Fui-fulldeps%2Finternal-lints%2Flint_pass_impl_without_macro.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui-fulldeps%2Finternal-lints%2Flint_pass_impl_without_macro.stderr?ref=24545128ebf7e19536e1384f64b89a18742471b0", "patch": "@@ -23,3 +23,4 @@ LL | custom_lint_pass_macro!();\n    = help: try using `declare_lint_pass!` or `impl_lint_pass!` instead\n \n error: aborting due to 2 previous errors\n+"}]}