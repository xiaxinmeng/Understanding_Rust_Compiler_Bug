{"sha": "a09a00a56049c705dcddc33773a27d5ce976b02e", "node_id": "MDY6Q29tbWl0NzI0NzEyOmEwOWEwMGE1NjA0OWM3MDVkY2RkYzMzNzczYTI3ZDVjZTk3NmIwMmU=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-07-24T20:31:44Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-07-24T20:31:44Z"}, "message": "Merge #5520\n\n5520: Add DocumentData to represent in-memory document with LSP info r=matklad a=kjeremy\n\nAt the moment this only holds document version information but in the near-future it will hold other things like semantic token delta info.\n\nCo-authored-by: kjeremy <kjeremy@gmail.com>", "tree": {"sha": "442cd510e65defcc8a7ef0d1ed2a20b1e7cfef08", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/442cd510e65defcc8a7ef0d1ed2a20b1e7cfef08"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a09a00a56049c705dcddc33773a27d5ce976b02e", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfG0UwCRBK7hj4Ov3rIwAAdHIIAIZUNF6RUAhsitQ/OriONDho\nL/3hj/RUTdxsphGq+QfFS+83yaZGOAsMWuruC57WZE7ITK1Ypu/jzktEMQQtT//H\nG5YAz27Q77SlEaDh0to/PL3RD9ce+uaeDlMgawitzW8czZAkzYxIx83OAeFtWJWQ\niIJXzrON9Fk90Jzhlqrb7rPDpwtznmC/W30654zsLPnvzFZCWL1xHBZvC7Ea1f+Z\nA2UaVqW3QZ4ux7cjm5r5UhamQ+vBKhUyGBOJ3InLyUFw0Qm9i974Iz/hYRUKdWen\ntQfQaIeqSmkWCimPqa3l+hMZiOJlQ918mENC0A6xrD6Mitrjl9X94eWiiMtIqk0=\n=ec+b\n-----END PGP SIGNATURE-----\n", "payload": "tree 442cd510e65defcc8a7ef0d1ed2a20b1e7cfef08\nparent 18172eb1972717d108969710f2bce10c018e98c9\nparent 48da2d4c16a05bf0559c864d2b3f1b832d1fec85\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1595622704 +0000\ncommitter GitHub <noreply@github.com> 1595622704 +0000\n\nMerge #5520\n\n5520: Add DocumentData to represent in-memory document with LSP info r=matklad a=kjeremy\n\nAt the moment this only holds document version information but in the near-future it will hold other things like semantic token delta info.\n\nCo-authored-by: kjeremy <kjeremy@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a09a00a56049c705dcddc33773a27d5ce976b02e", "html_url": "https://github.com/rust-lang/rust/commit/a09a00a56049c705dcddc33773a27d5ce976b02e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a09a00a56049c705dcddc33773a27d5ce976b02e/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "18172eb1972717d108969710f2bce10c018e98c9", "url": "https://api.github.com/repos/rust-lang/rust/commits/18172eb1972717d108969710f2bce10c018e98c9", "html_url": "https://github.com/rust-lang/rust/commit/18172eb1972717d108969710f2bce10c018e98c9"}, {"sha": "48da2d4c16a05bf0559c864d2b3f1b832d1fec85", "url": "https://api.github.com/repos/rust-lang/rust/commits/48da2d4c16a05bf0559c864d2b3f1b832d1fec85", "html_url": "https://github.com/rust-lang/rust/commit/48da2d4c16a05bf0559c864d2b3f1b832d1fec85"}], "stats": {"total": 33, "additions": 26, "deletions": 7}, "files": [{"sha": "43219e6330f3d0456e0b711b82f2d5b6c5b526c6", "filename": "crates/rust-analyzer/src/document.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/a09a00a56049c705dcddc33773a27d5ce976b02e/crates%2Frust-analyzer%2Fsrc%2Fdocument.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a09a00a56049c705dcddc33773a27d5ce976b02e/crates%2Frust-analyzer%2Fsrc%2Fdocument.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fdocument.rs?ref=a09a00a56049c705dcddc33773a27d5ce976b02e", "patch": "@@ -0,0 +1,16 @@\n+//! In-memory document information.\n+\n+/// Information about a document that the Language Client\n+// knows about.\n+// Its lifetime is driven by the textDocument/didOpen and textDocument/didClose\n+// client notifications.\n+#[derive(Debug, Clone)]\n+pub(crate) struct DocumentData {\n+    pub version: Option<i64>,\n+}\n+\n+impl DocumentData {\n+    pub fn new(version: i64) -> Self {\n+        DocumentData { version: Some(version) }\n+    }\n+}"}, {"sha": "b2d65a6d18f2701b2e8e8bcf9d9ddfde82cfe78a", "filename": "crates/rust-analyzer/src/global_state.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/a09a00a56049c705dcddc33773a27d5ce976b02e/crates%2Frust-analyzer%2Fsrc%2Fglobal_state.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a09a00a56049c705dcddc33773a27d5ce976b02e/crates%2Frust-analyzer%2Fsrc%2Fglobal_state.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fglobal_state.rs?ref=a09a00a56049c705dcddc33773a27d5ce976b02e", "patch": "@@ -17,6 +17,7 @@ use rustc_hash::FxHashMap;\n use crate::{\n     config::Config,\n     diagnostics::{CheckFixes, DiagnosticCollection},\n+    document::DocumentData,\n     from_proto,\n     line_endings::LineEndings,\n     main_loop::Task,\n@@ -69,7 +70,7 @@ pub(crate) struct GlobalState {\n     pub(crate) config: Config,\n     pub(crate) analysis_host: AnalysisHost,\n     pub(crate) diagnostics: DiagnosticCollection,\n-    pub(crate) mem_docs: FxHashMap<VfsPath, Option<i64>>,\n+    pub(crate) mem_docs: FxHashMap<VfsPath, DocumentData>,\n     pub(crate) vfs: Arc<RwLock<(vfs::Vfs, FxHashMap<FileId, LineEndings>)>>,\n     pub(crate) status: Status,\n     pub(crate) source_root_config: SourceRootConfig,\n@@ -84,7 +85,7 @@ pub(crate) struct GlobalStateSnapshot {\n     pub(crate) analysis: Analysis,\n     pub(crate) check_fixes: CheckFixes,\n     pub(crate) latest_requests: Arc<RwLock<LatestRequests>>,\n-    mem_docs: FxHashMap<VfsPath, Option<i64>>,\n+    mem_docs: FxHashMap<VfsPath, DocumentData>,\n     vfs: Arc<RwLock<(vfs::Vfs, FxHashMap<FileId, LineEndings>)>>,\n     pub(crate) workspaces: Arc<Vec<ProjectWorkspace>>,\n }\n@@ -259,7 +260,7 @@ impl GlobalStateSnapshot {\n \n     pub(crate) fn url_file_version(&self, url: &Url) -> Option<i64> {\n         let path = from_proto::vfs_path(&url).ok()?;\n-        self.mem_docs.get(&path).copied()?\n+        self.mem_docs.get(&path)?.version\n     }\n \n     pub(crate) fn anchored_path(&self, file_id: FileId, path: &str) -> Url {"}, {"sha": "c4284556edfac57f51972cae1456c46e2acb73ec", "filename": "crates/rust-analyzer/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/a09a00a56049c705dcddc33773a27d5ce976b02e/crates%2Frust-analyzer%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a09a00a56049c705dcddc33773a27d5ce976b02e/crates%2Frust-analyzer%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Flib.rs?ref=a09a00a56049c705dcddc33773a27d5ce976b02e", "patch": "@@ -33,6 +33,7 @@ mod line_endings;\n mod request_metrics;\n mod lsp_utils;\n mod thread_pool;\n+mod document;\n pub mod lsp_ext;\n pub mod config;\n "}, {"sha": "51626fcd58e046c34703c34cc740d1814634136d", "filename": "crates/rust-analyzer/src/main_loop.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/a09a00a56049c705dcddc33773a27d5ce976b02e/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a09a00a56049c705dcddc33773a27d5ce976b02e/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs?ref=a09a00a56049c705dcddc33773a27d5ce976b02e", "patch": "@@ -15,6 +15,7 @@ use ra_prof::profile;\n use crate::{\n     config::Config,\n     dispatch::{NotificationDispatcher, RequestDispatcher},\n+    document::DocumentData,\n     from_proto,\n     global_state::{file_id_to_url, url_to_file_id, GlobalState, Status},\n     handlers, lsp_ext,\n@@ -311,7 +312,7 @@ impl GlobalState {\n                 let url = file_id_to_url(&self.vfs.read().0, file_id);\n                 let diagnostics = self.diagnostics.diagnostics_for(file_id).cloned().collect();\n                 let version = from_proto::vfs_path(&url)\n-                    .map(|path| self.mem_docs.get(&path).copied().flatten())\n+                    .map(|path| self.mem_docs.get(&path)?.version)\n                     .unwrap_or_default();\n \n                 self.send_notification::<lsp_types::notification::PublishDiagnostics>(\n@@ -406,7 +407,7 @@ impl GlobalState {\n                 if let Ok(path) = from_proto::vfs_path(&params.text_document.uri) {\n                     if this\n                         .mem_docs\n-                        .insert(path.clone(), Some(params.text_document.version))\n+                        .insert(path.clone(), DocumentData::new(params.text_document.version))\n                         .is_some()\n                     {\n                         log::error!(\"duplicate DidOpenTextDocument: {}\", path)\n@@ -428,7 +429,7 @@ impl GlobalState {\n \n                     // The version passed in DidChangeTextDocument is the version after all edits are applied\n                     // so we should apply it before the vfs is notified.\n-                    *doc = params.text_document.version;\n+                    doc.version = params.text_document.version;\n \n                     vfs.set_file_contents(path.clone(), Some(text.into_bytes()));\n                 }\n@@ -438,7 +439,7 @@ impl GlobalState {\n                 let mut version = None;\n                 if let Ok(path) = from_proto::vfs_path(&params.text_document.uri) {\n                     match this.mem_docs.remove(&path) {\n-                        Some(entry) => version = entry,\n+                        Some(doc) => version = doc.version,\n                         None => log::error!(\"orphan DidCloseTextDocument: {}\", path),\n                     }\n "}]}