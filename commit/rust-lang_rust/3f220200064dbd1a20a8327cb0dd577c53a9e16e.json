{"sha": "3f220200064dbd1a20a8327cb0dd577c53a9e16e", "node_id": "C_kwDOAAsO6NoAKDNmMjIwMjAwMDY0ZGJkMWEyMGE4MzI3Y2IwZGQ1NzdjNTNhOWUxNmU", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2022-09-06T11:04:41Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-09-06T11:04:41Z"}, "message": "Rollup merge of #100658 - chenyukang:100631-check-get-attr, r=lcnr\n\nTyCtxt::get_attr should check that no duplicates are allowed\n\nFixes #100631", "tree": {"sha": "35b56ce0a4e0396649db5dea1f42ec6dbaed7d50", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/35b56ce0a4e0396649db5dea1f42ec6dbaed7d50"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3f220200064dbd1a20a8327cb0dd577c53a9e16e", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjFylJCRBK7hj4Ov3rIwAA8hIIAIpa3HMZCGECPOKt5jvhm31p\nxuAvlflqBJcCUN5s7fbKHLAcVv5nXXR9eNKHW27JggTWiYxZySL6goqmANeRcSs9\n9X9Kzyye0y3st10YtaFS1X/yhkAapM+7a7GKnLmKMM/wfN44mtB/RKzXHN/BHK7P\nQt0yakdED+NW2D7Iw2mC3CGVJx0v6naotERnCIaJwhTQImMgnFW3EFngZkdwg2Ia\n4z9bQ13IZOuxfpGzthoJSPYidca8b7Jr/QLC1GfUY04yw95fnm2Fp4LCodZf0Iry\nlVmqXgNRbzxUQQ7HWToPPL3XetI6+UyTTBwDyK/hFzVjdpLUX+O+NzYrDkE+hJY=\n=613W\n-----END PGP SIGNATURE-----\n", "payload": "tree 35b56ce0a4e0396649db5dea1f42ec6dbaed7d50\nparent 098cf8802271eacdc463fa66c35da377926d4c4e\nparent 00b10a5552c575e884a40de808a3cb64a647a442\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1662462281 +0530\ncommitter GitHub <noreply@github.com> 1662462281 +0530\n\nRollup merge of #100658 - chenyukang:100631-check-get-attr, r=lcnr\n\nTyCtxt::get_attr should check that no duplicates are allowed\n\nFixes #100631\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3f220200064dbd1a20a8327cb0dd577c53a9e16e", "html_url": "https://github.com/rust-lang/rust/commit/3f220200064dbd1a20a8327cb0dd577c53a9e16e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3f220200064dbd1a20a8327cb0dd577c53a9e16e/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "098cf8802271eacdc463fa66c35da377926d4c4e", "url": "https://api.github.com/repos/rust-lang/rust/commits/098cf8802271eacdc463fa66c35da377926d4c4e", "html_url": "https://github.com/rust-lang/rust/commit/098cf8802271eacdc463fa66c35da377926d4c4e"}, {"sha": "00b10a5552c575e884a40de808a3cb64a647a442", "url": "https://api.github.com/repos/rust-lang/rust/commits/00b10a5552c575e884a40de808a3cb64a647a442", "html_url": "https://github.com/rust-lang/rust/commit/00b10a5552c575e884a40de808a3cb64a647a442"}], "stats": {"total": 43, "additions": 38, "deletions": 5}, "files": [{"sha": "b38684a63e410d103150011d9ab452dfde04503d", "filename": "compiler/rustc_codegen_llvm/src/attributes.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/3f220200064dbd1a20a8327cb0dd577c53a9e16e/compiler%2Frustc_codegen_llvm%2Fsrc%2Fattributes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3f220200064dbd1a20a8327cb0dd577c53a9e16e/compiler%2Frustc_codegen_llvm%2Fsrc%2Fattributes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fattributes.rs?ref=3f220200064dbd1a20a8327cb0dd577c53a9e16e", "patch": "@@ -386,7 +386,8 @@ pub fn from_fn_attrs<'ll, 'tcx>(\n     ) {\n         let span = cx\n             .tcx\n-            .get_attr(instance.def_id(), sym::target_feature)\n+            .get_attrs(instance.def_id(), sym::target_feature)\n+            .next()\n             .map_or_else(|| cx.tcx.def_span(instance.def_id()), |a| a.span);\n         let msg = format!(\n             \"the target features {} must all be either enabled or disabled together\","}, {"sha": "38a02cb1d7ce9f224e065897ae2b35f6caa464d9", "filename": "compiler/rustc_feature/src/builtin_attrs.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/3f220200064dbd1a20a8327cb0dd577c53a9e16e/compiler%2Frustc_feature%2Fsrc%2Fbuiltin_attrs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3f220200064dbd1a20a8327cb0dd577c53a9e16e/compiler%2Frustc_feature%2Fsrc%2Fbuiltin_attrs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_feature%2Fsrc%2Fbuiltin_attrs.rs?ref=3f220200064dbd1a20a8327cb0dd577c53a9e16e", "patch": "@@ -823,6 +823,14 @@ pub fn is_builtin_only_local(name: Symbol) -> bool {\n     BUILTIN_ATTRIBUTE_MAP.get(&name).map_or(false, |attr| attr.only_local)\n }\n \n+pub fn is_valid_for_get_attr(name: Symbol) -> bool {\n+    BUILTIN_ATTRIBUTE_MAP.get(&name).map_or(false, |attr| match attr.duplicates {\n+        WarnFollowing | ErrorFollowing | ErrorPreceding | FutureWarnFollowing\n+        | FutureWarnPreceding => true,\n+        DuplicatesOk | WarnFollowingWordOnly => false,\n+    })\n+}\n+\n pub static BUILTIN_ATTRIBUTE_MAP: LazyLock<FxHashMap<Symbol, &BuiltinAttribute>> =\n     LazyLock::new(|| {\n         let mut map = FxHashMap::default();"}, {"sha": "bdaa0ee88eba19792cd89fdd7d5104ce271fdfe9", "filename": "compiler/rustc_feature/src/lib.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/3f220200064dbd1a20a8327cb0dd577c53a9e16e/compiler%2Frustc_feature%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3f220200064dbd1a20a8327cb0dd577c53a9e16e/compiler%2Frustc_feature%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_feature%2Fsrc%2Flib.rs?ref=3f220200064dbd1a20a8327cb0dd577c53a9e16e", "patch": "@@ -151,7 +151,7 @@ pub use active::{Features, ACTIVE_FEATURES, INCOMPATIBLE_FEATURES};\n pub use builtin_attrs::AttributeDuplicates;\n pub use builtin_attrs::{\n     deprecated_attributes, find_gated_cfg, is_builtin_attr_name, is_builtin_only_local,\n-    AttributeGate, AttributeTemplate, AttributeType, BuiltinAttribute, GatedCfg,\n-    BUILTIN_ATTRIBUTES, BUILTIN_ATTRIBUTE_MAP,\n+    is_valid_for_get_attr, AttributeGate, AttributeTemplate, AttributeType, BuiltinAttribute,\n+    GatedCfg, BUILTIN_ATTRIBUTES, BUILTIN_ATTRIBUTE_MAP,\n };\n pub use removed::{REMOVED_FEATURES, STABLE_REMOVED_FEATURES};"}, {"sha": "1312a1467968af7ca888ce3d20a38616c68b881b", "filename": "compiler/rustc_middle/src/ty/mod.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/3f220200064dbd1a20a8327cb0dd577c53a9e16e/compiler%2Frustc_middle%2Fsrc%2Fty%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3f220200064dbd1a20a8327cb0dd577c53a9e16e/compiler%2Frustc_middle%2Fsrc%2Fty%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fmod.rs?ref=3f220200064dbd1a20a8327cb0dd577c53a9e16e", "patch": "@@ -2269,7 +2269,11 @@ impl<'tcx> TyCtxt<'tcx> {\n     }\n \n     pub fn get_attr(self, did: DefId, attr: Symbol) -> Option<&'tcx ast::Attribute> {\n-        self.get_attrs(did, attr).next()\n+        if cfg!(debug_assertions) && !rustc_feature::is_valid_for_get_attr(attr) {\n+            bug!(\"get_attr: unexpected called with DefId `{:?}`, attr `{:?}`\", did, attr);\n+        } else {\n+            self.get_attrs(did, attr).next()\n+        }\n     }\n \n     /// Determines whether an item is annotated with an attribute."}, {"sha": "43893263be13898135f6b9211f461275f2162ce7", "filename": "compiler/rustc_typeck/src/check/check.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3f220200064dbd1a20a8327cb0dd577c53a9e16e/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcheck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3f220200064dbd1a20a8327cb0dd577c53a9e16e/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcheck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcheck.rs?ref=3f220200064dbd1a20a8327cb0dd577c53a9e16e", "patch": "@@ -1459,7 +1459,7 @@ fn check_enum<'tcx>(tcx: TyCtxt<'tcx>, vs: &'tcx [hir::Variant<'tcx>], def_id: L\n     def.destructor(tcx); // force the destructor to be evaluated\n \n     if vs.is_empty() {\n-        if let Some(attr) = tcx.get_attr(def_id.to_def_id(), sym::repr) {\n+        if let Some(attr) = tcx.get_attrs(def_id.to_def_id(), sym::repr).next() {\n             struct_span_err!(\n                 tcx.sess,\n                 attr.span,"}, {"sha": "0fefcf83fd51670b08bdf02387566241a687adf2", "filename": "src/test/ui/attributes/issue-100631.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/3f220200064dbd1a20a8327cb0dd577c53a9e16e/src%2Ftest%2Fui%2Fattributes%2Fissue-100631.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3f220200064dbd1a20a8327cb0dd577c53a9e16e/src%2Ftest%2Fui%2Fattributes%2Fissue-100631.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fattributes%2Fissue-100631.rs?ref=3f220200064dbd1a20a8327cb0dd577c53a9e16e", "patch": "@@ -0,0 +1,8 @@\n+// issue #100631, make sure `TyCtxt::get_attr` only called by case that compiler\n+// can reasonably deal with multiple attributes.\n+// `repr` will use `TyCtxt::get_attrs` since it's `DuplicatesOk`.\n+#[repr(C)] //~ ERROR: unsupported representation for zero-variant enum [E0084]\n+#[repr(C)]\n+enum Foo {}\n+\n+fn main() {}"}, {"sha": "caa5351ddc7aa6d6764c488f8f6e390a78e489cc", "filename": "src/test/ui/attributes/issue-100631.stderr", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/3f220200064dbd1a20a8327cb0dd577c53a9e16e/src%2Ftest%2Fui%2Fattributes%2Fissue-100631.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/3f220200064dbd1a20a8327cb0dd577c53a9e16e/src%2Ftest%2Fui%2Fattributes%2Fissue-100631.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fattributes%2Fissue-100631.stderr?ref=3f220200064dbd1a20a8327cb0dd577c53a9e16e", "patch": "@@ -0,0 +1,12 @@\n+error[E0084]: unsupported representation for zero-variant enum\n+  --> $DIR/issue-100631.rs:4:1\n+   |\n+LL | #[repr(C)]\n+   | ^^^^^^^^^^\n+LL | #[repr(C)]\n+LL | enum Foo {}\n+   | -------- zero-variant enum\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0084`."}]}