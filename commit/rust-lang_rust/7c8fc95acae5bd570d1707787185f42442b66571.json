{"sha": "7c8fc95acae5bd570d1707787185f42442b66571", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdjOGZjOTVhY2FlNWJkNTcwZDE3MDc3ODcxODVmNDI0NDJiNjY1NzE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-10-06T09:27:19Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-10-06T09:27:19Z"}, "message": "auto merge of #17803 : bkoropoff/rust/issue-17021, r=alexcrichton\n\nThis closes issue #17021.", "tree": {"sha": "2c6706ea1cf9e5644966240e2ca69ff835ea926d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2c6706ea1cf9e5644966240e2ca69ff835ea926d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7c8fc95acae5bd570d1707787185f42442b66571", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7c8fc95acae5bd570d1707787185f42442b66571", "html_url": "https://github.com/rust-lang/rust/commit/7c8fc95acae5bd570d1707787185f42442b66571", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7c8fc95acae5bd570d1707787185f42442b66571/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0e2f0acf2213825bfcd88cc7355d3e2f32c1db13", "url": "https://api.github.com/repos/rust-lang/rust/commits/0e2f0acf2213825bfcd88cc7355d3e2f32c1db13", "html_url": "https://github.com/rust-lang/rust/commit/0e2f0acf2213825bfcd88cc7355d3e2f32c1db13"}, {"sha": "1694bf64ba1764f8c7a84b83e2bbe34b1e0ab0ab", "url": "https://api.github.com/repos/rust-lang/rust/commits/1694bf64ba1764f8c7a84b83e2bbe34b1e0ab0ab", "html_url": "https://github.com/rust-lang/rust/commit/1694bf64ba1764f8c7a84b83e2bbe34b1e0ab0ab"}], "stats": {"total": 132, "additions": 78, "deletions": 54}, "files": [{"sha": "e50b61a68e515433a3ed86f8af0c58218f87c746", "filename": "src/librustc/middle/trans/debuginfo.rs", "status": "modified", "additions": 76, "deletions": 54, "changes": 130, "blob_url": "https://github.com/rust-lang/rust/blob/7c8fc95acae5bd570d1707787185f42442b66571/src%2Flibrustc%2Fmiddle%2Ftrans%2Fdebuginfo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7c8fc95acae5bd570d1707787185f42442b66571/src%2Flibrustc%2Fmiddle%2Ftrans%2Fdebuginfo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fdebuginfo.rs?ref=7c8fc95acae5bd570d1707787185f42442b66571", "patch": "@@ -456,60 +456,17 @@ impl TypeMap {\n                 let return_type_id = self.get_unique_type_id_as_string(return_type_id);\n                 unique_type_id.push_str(return_type_id.as_slice());\n             },\n-            ty::ty_closure(box ty::ClosureTy { fn_style,\n-                                               onceness,\n-                                               store,\n-                                               ref bounds,\n-                                               ref sig,\n-                                               abi: _ }) => {\n-                if fn_style == ast::UnsafeFn {\n-                    unique_type_id.push_str(\"unsafe \");\n-                }\n-\n-                if onceness == ast::Once {\n-                    unique_type_id.push_str(\"once \");\n-                }\n-\n-                match store {\n-                    ty::UniqTraitStore => unique_type_id.push_str(\"~|\"),\n-                    ty::RegionTraitStore(_, ast::MutMutable) => {\n-                        unique_type_id.push_str(\"&mut|\")\n-                    }\n-                    ty::RegionTraitStore(_, ast::MutImmutable) => {\n-                        unique_type_id.push_str(\"&|\")\n-                    }\n-                };\n-\n-                for &parameter_type in sig.inputs.iter() {\n-                    let parameter_type_id =\n-                        self.get_unique_type_id_of_type(cx, parameter_type);\n-                    let parameter_type_id =\n-                        self.get_unique_type_id_as_string(parameter_type_id);\n-                    unique_type_id.push_str(parameter_type_id.as_slice());\n-                    unique_type_id.push_char(',');\n-                }\n-\n-                if sig.variadic {\n-                    unique_type_id.push_str(\"...\");\n-                }\n-\n-                unique_type_id.push_str(\"|->\");\n-\n-                let return_type_id = self.get_unique_type_id_of_type(cx, sig.output);\n-                let return_type_id = self.get_unique_type_id_as_string(return_type_id);\n-                unique_type_id.push_str(return_type_id.as_slice());\n-\n-                unique_type_id.push_char(':');\n-\n-                for bound in bounds.builtin_bounds.iter() {\n-                    match bound {\n-                        ty::BoundSend => unique_type_id.push_str(\"Send\"),\n-                        ty::BoundSized => unique_type_id.push_str(\"Sized\"),\n-                        ty::BoundCopy => unique_type_id.push_str(\"Copy\"),\n-                        ty::BoundSync => unique_type_id.push_str(\"Sync\"),\n-                    };\n-                    unique_type_id.push_char('+');\n-                }\n+            ty::ty_closure(box ref closure_ty) => {\n+                self.get_unique_type_id_of_closure_type(cx,\n+                                                        closure_ty.clone(),\n+                                                        &mut unique_type_id);\n+            },\n+            ty::ty_unboxed_closure(ref def_id, _) => {\n+                let closure_ty = cx.tcx().unboxed_closures.borrow()\n+                                   .find(def_id).unwrap().closure_type.clone();\n+                self.get_unique_type_id_of_closure_type(cx,\n+                                                        closure_ty,\n+                                                        &mut unique_type_id);\n             },\n             _ => {\n                 cx.sess().bug(format!(\"get_unique_type_id_of_type() - unexpected type: {}, {:?}\",\n@@ -581,6 +538,66 @@ impl TypeMap {\n         }\n     }\n \n+    fn get_unique_type_id_of_closure_type(&mut self,\n+                                          cx: &CrateContext,\n+                                          closure_ty: ty::ClosureTy,\n+                                          unique_type_id: &mut String) {\n+        let ty::ClosureTy { fn_style,\n+                            onceness,\n+                            store,\n+                            ref bounds,\n+                            ref sig,\n+                            abi: _ } = closure_ty;\n+        if fn_style == ast::UnsafeFn {\n+            unique_type_id.push_str(\"unsafe \");\n+        }\n+\n+        if onceness == ast::Once {\n+            unique_type_id.push_str(\"once \");\n+        }\n+\n+        match store {\n+            ty::UniqTraitStore => unique_type_id.push_str(\"~|\"),\n+            ty::RegionTraitStore(_, ast::MutMutable) => {\n+                unique_type_id.push_str(\"&mut|\")\n+            }\n+            ty::RegionTraitStore(_, ast::MutImmutable) => {\n+                unique_type_id.push_str(\"&|\")\n+            }\n+        };\n+\n+        for &parameter_type in sig.inputs.iter() {\n+            let parameter_type_id =\n+                self.get_unique_type_id_of_type(cx, parameter_type);\n+            let parameter_type_id =\n+                self.get_unique_type_id_as_string(parameter_type_id);\n+            unique_type_id.push_str(parameter_type_id.as_slice());\n+            unique_type_id.push_char(',');\n+        }\n+\n+        if sig.variadic {\n+            unique_type_id.push_str(\"...\");\n+        }\n+\n+        unique_type_id.push_str(\"|->\");\n+\n+        let return_type_id = self.get_unique_type_id_of_type(cx, sig.output);\n+        let return_type_id = self.get_unique_type_id_as_string(return_type_id);\n+        unique_type_id.push_str(return_type_id.as_slice());\n+\n+        unique_type_id.push_char(':');\n+\n+        for bound in bounds.builtin_bounds.iter() {\n+            match bound {\n+                ty::BoundSend => unique_type_id.push_str(\"Send\"),\n+                ty::BoundSized => unique_type_id.push_str(\"Sized\"),\n+                ty::BoundCopy => unique_type_id.push_str(\"Copy\"),\n+                ty::BoundSync => unique_type_id.push_str(\"Sync\"),\n+            };\n+            unique_type_id.push_char('+');\n+        }\n+    }\n+\n     // Get the UniqueTypeId for an enum variant. Enum variants are not really\n     // types of their own, so they need special handling. We still need a\n     // UniqueTypeId for them, since to debuginfo they *are* real types.\n@@ -2903,6 +2920,11 @@ fn type_metadata(cx: &CrateContext,\n         ty::ty_closure(ref closurety) => {\n             subroutine_type_metadata(cx, unique_type_id, &closurety.sig, usage_site_span)\n         }\n+        ty::ty_unboxed_closure(ref def_id, _) => {\n+            let sig = cx.tcx().unboxed_closures.borrow()\n+                        .find(def_id).unwrap().closure_type.sig.clone();\n+            subroutine_type_metadata(cx, unique_type_id, &sig, usage_site_span)\n+        }\n         ty::ty_struct(def_id, ref substs) => {\n             prepare_struct_metadata(cx,\n                                     t,"}, {"sha": "43ab16c106f6f10cd486ba5ed888c1ac2d88ff07", "filename": "src/test/run-pass/unboxed-closures-unique-type-id.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/7c8fc95acae5bd570d1707787185f42442b66571/src%2Ftest%2Frun-pass%2Funboxed-closures-unique-type-id.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7c8fc95acae5bd570d1707787185f42442b66571/src%2Ftest%2Frun-pass%2Funboxed-closures-unique-type-id.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Funboxed-closures-unique-type-id.rs?ref=7c8fc95acae5bd570d1707787185f42442b66571", "patch": "@@ -16,6 +16,8 @@\n //    ReScope(63u32))\n //\n // This is a regression test for issue #17021.\n+//\n+// compile-flags: -g\n \n #![feature(unboxed_closures, overloaded_calls)]\n "}]}