{"sha": "950e8b8182897da60bcece70d84e9f0b6dc88632", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk1MGU4YjgxODI4OTdkYTYwYmNlY2U3MGQ4NGU5ZjBiNmRjODg2MzI=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2018-10-30T18:23:23Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2018-10-30T18:23:23Z"}, "message": "introduce syntax-ptr", "tree": {"sha": "54c97e78e93f6663231fb555c1223373035a4315", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/54c97e78e93f6663231fb555c1223373035a4315"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/950e8b8182897da60bcece70d84e9f0b6dc88632", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/950e8b8182897da60bcece70d84e9f0b6dc88632", "html_url": "https://github.com/rust-lang/rust/commit/950e8b8182897da60bcece70d84e9f0b6dc88632", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/950e8b8182897da60bcece70d84e9f0b6dc88632/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bc4de7128f474f75a9eff6591923657025099b74", "url": "https://api.github.com/repos/rust-lang/rust/commits/bc4de7128f474f75a9eff6591923657025099b74", "html_url": "https://github.com/rust-lang/rust/commit/bc4de7128f474f75a9eff6591923657025099b74"}], "stats": {"total": 80, "additions": 75, "deletions": 5}, "files": [{"sha": "88c7ba356c177db719d04685b9456901a3b3e75b", "filename": "Cargo.lock", "status": "modified", "additions": 6, "deletions": 5, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/950e8b8182897da60bcece70d84e9f0b6dc88632/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/950e8b8182897da60bcece70d84e9f0b6dc88632/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=950e8b8182897da60bcece70d84e9f0b6dc88632", "patch": "@@ -661,7 +661,7 @@ dependencies = [\n  \"serde_json 1.0.32 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"smol_str 0.1.7 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"tempdir 0.3.7 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"text_unit 0.1.4 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"text_unit 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"url_serde 0.2.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"walkdir 2.2.5 (registry+https://github.com/rust-lang/crates.io-index)\",\n ]\n@@ -675,6 +675,7 @@ dependencies = [\n  \"parking_lot 0.6.4 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"rowan 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"test_utils 0.1.0\",\n+ \"text_unit 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"unicode-xid 0.1.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"walkdir 2.2.5 (registry+https://github.com/rust-lang/crates.io-index)\",\n ]\n@@ -798,7 +799,7 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n dependencies = [\n  \"parking_lot 0.6.4 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"smol_str 0.1.7 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"text_unit 0.1.4 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"text_unit 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)\",\n ]\n \n [[package]]\n@@ -1038,12 +1039,12 @@ version = \"0.1.0\"\n dependencies = [\n  \"difference 2.0.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"itertools 0.7.8 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"text_unit 0.1.4 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"text_unit 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)\",\n ]\n \n [[package]]\n name = \"text_unit\"\n-version = \"0.1.4\"\n+version = \"0.1.5\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n dependencies = [\n  \"serde 1.0.80 (registry+https://github.com/rust-lang/crates.io-index)\",\n@@ -1372,7 +1373,7 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n \"checksum tera 0.11.18 (registry+https://github.com/rust-lang/crates.io-index)\" = \"6c87cae42cc4fc480278c7583792cc5da2d51a25be916b7921cbb45c43063b8d\"\n \"checksum teraron 0.0.1 (registry+https://github.com/rust-lang/crates.io-index)\" = \"0d89ad4617d1dec55331067fadaa041e813479e1779616f3d3ce9308bf46184e\"\n \"checksum termion 1.5.1 (registry+https://github.com/rust-lang/crates.io-index)\" = \"689a3bdfaab439fd92bc87df5c4c78417d3cbe537487274e9b0b2dce76e92096\"\n-\"checksum text_unit 0.1.4 (registry+https://github.com/rust-lang/crates.io-index)\" = \"93fc86da66d0b9aa8d359b0ec31b4342c6bc52637eadef05b91b098551a9f8e9\"\n+\"checksum text_unit 0.1.5 (registry+https://github.com/rust-lang/crates.io-index)\" = \"8009d7bdbd896a7e09b595f8f9325a19047fc708653e60d0895202b82135048f\"\n \"checksum textwrap 0.10.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"307686869c93e71f94da64286f9a9524c0f308a9e1c87a583de8e9c9039ad3f6\"\n \"checksum thread_local 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)\" = \"c6b53e329000edc2b34dbe8545fd20e55a333362d0a321909685a19bd28c3f1b\"\n \"checksum time 0.1.40 (registry+https://github.com/rust-lang/crates.io-index)\" = \"d825be0eb33fda1a7e68012d51e9c7f451dc1a69391e7fdc197060bb8c56667b\""}, {"sha": "363c72c0b774631df822b80cd305d3deae2b057b", "filename": "crates/ra_analysis/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/950e8b8182897da60bcece70d84e9f0b6dc88632/crates%2Fra_analysis%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/950e8b8182897da60bcece70d84e9f0b6dc88632/crates%2Fra_analysis%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_analysis%2Fsrc%2Flib.rs?ref=950e8b8182897da60bcece70d84e9f0b6dc88632", "patch": "@@ -12,6 +12,7 @@ mod descriptors;\n mod imp;\n mod symbol_index;\n mod completion;\n+mod syntax_ptr;\n \n use std::{\n     fmt,"}, {"sha": "863ad2672bf85c9b2c31ae49f384450aa14cfb89", "filename": "crates/ra_analysis/src/syntax_ptr.rs", "status": "added", "additions": 67, "deletions": 0, "changes": 67, "blob_url": "https://github.com/rust-lang/rust/blob/950e8b8182897da60bcece70d84e9f0b6dc88632/crates%2Fra_analysis%2Fsrc%2Fsyntax_ptr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/950e8b8182897da60bcece70d84e9f0b6dc88632/crates%2Fra_analysis%2Fsrc%2Fsyntax_ptr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_analysis%2Fsrc%2Fsyntax_ptr.rs?ref=950e8b8182897da60bcece70d84e9f0b6dc88632", "patch": "@@ -0,0 +1,67 @@\n+use ra_syntax::{\n+    File, TextRange, SyntaxKind, SyntaxNode, SyntaxNodeRef,\n+    ast::{self, AstNode},\n+};\n+\n+use crate::FileId;\n+use crate::db::SyntaxDatabase;\n+\n+/// SyntaxPtr is a cheap `Copy` id which identifies a particular syntax node,\n+/// without retainig syntax tree in memory. You need to explicitelly `resovle`\n+/// `SyntaxPtr` to get a `SyntaxNode`\n+#[derive(Debug, Clone, Copy, PartialEq, Eq)]\n+pub(crate) struct SyntaxPtr {\n+    file_id: FileId,\n+    local: LocalSyntaxPtr,\n+}\n+\n+impl SyntaxPtr {\n+    pub(crate) fn new(file_id: FileId, node: SyntaxNodeRef) -> SyntaxPtr {\n+        let local = LocalSyntaxPtr::new(node);\n+        SyntaxPtr { file_id, local }\n+    }\n+\n+    pub(crate) fn resolve(self, db: &impl SyntaxDatabase) -> SyntaxNode {\n+        let syntax = db.file_syntax(self.file_id);\n+        self.local.resolve(&syntax)\n+    }\n+}\n+\n+\n+/// A pionter to a syntax node inside a file.\n+#[derive(Debug, Clone, Copy, PartialEq, Eq)]\n+struct LocalSyntaxPtr {\n+    range: TextRange,\n+    kind: SyntaxKind,\n+}\n+\n+impl LocalSyntaxPtr {\n+    fn new(node: SyntaxNodeRef) -> LocalSyntaxPtr {\n+        LocalSyntaxPtr {\n+            range: node.range(),\n+            kind: node.kind(),\n+        }\n+    }\n+\n+    fn resolve(self, file: &File) -> SyntaxNode {\n+        let mut curr = file.syntax();\n+        loop {\n+            if curr.range() == self.range && curr.kind() == self.kind {\n+                return curr.owned();\n+            }\n+            curr = curr.children()\n+                .find(|it| self.range.is_subrange(&it.range()))\n+                .unwrap_or_else(|| panic!(\"can't resovle local ptr to SyntaxNode: {:?}\", self))\n+        }\n+    }\n+}\n+\n+\n+#[test]\n+fn test_local_syntax_ptr() {\n+    let file = File::parse(\"struct Foo { f: u32, }\");\n+    let field = file.syntax().descendants().find_map(ast::NamedFieldDef::cast).unwrap();\n+    let ptr = LocalSyntaxPtr::new(field.syntax());\n+    let field_syntax = ptr.resolve(&file);\n+    assert_eq!(field.syntax(), field_syntax);\n+}"}, {"sha": "043c9bacd85f1e11999bfbac6438cd93f1268bcf", "filename": "crates/ra_syntax/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/950e8b8182897da60bcece70d84e9f0b6dc88632/crates%2Fra_syntax%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/950e8b8182897da60bcece70d84e9f0b6dc88632/crates%2Fra_syntax%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_syntax%2FCargo.toml?ref=950e8b8182897da60bcece70d84e9f0b6dc88632", "patch": "@@ -11,6 +11,7 @@ itertools = \"0.7.8\"\n drop_bomb = \"0.1.4\"\n parking_lot = \"0.6.0\"\n rowan = \"0.1.1\"\n+text_unit = \"0.1.5\"\n \n [dev-dependencies]\n test_utils = { path = \"../test_utils\" }"}]}