{"sha": "8ff46a368cbaad4f7ae28a2b19b7dde59ed75111", "node_id": "MDY6Q29tbWl0NzI0NzEyOjhmZjQ2YTM2OGNiYWFkNGY3YWUyOGEyYjE5YjdkZGU1OWVkNzUxMTE=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-06-17T08:52:15Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-06-17T08:52:15Z"}, "message": "Merge #9307\n\n9307: internal: switch some tests to minicore r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>", "tree": {"sha": "4198286d6c63b03fc3172c70dee6c4575ddb7f12", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4198286d6c63b03fc3172c70dee6c4575ddb7f12"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8ff46a368cbaad4f7ae28a2b19b7dde59ed75111", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgyw0/CRBK7hj4Ov3rIwAAsowIAHZ2TSuf5qBS+Fw69bh5PL12\n7UjtGSL+WXimtrVdew9wusYRnY7fGvaN20GGdV8nCMspvPyuQWhqtQQMNwe3IGF/\nTzWJgqH1YWTvJjSrhAC9Yet/HJBcubcPTF31vHRXZvrGH23cw6pdVWsK3eMkALiH\n3PR9480mcLUhcQN02JAiGcitZqNInucNB7dEd/e7R8d6z05yiwk5i6/B5pUJn+gV\nRfoEOMOBikDFQ25QFv4mODyidC+EwL46gqRaYyt/Ezey1ToI9SlF3g1PTqqR1zGP\nHwAObWnnnDTuih0jxv+LQX04bpoHAW/fcpT7K8OZCixqGcfw6txhyd3tVv68Vio=\n=Tuuw\n-----END PGP SIGNATURE-----\n", "payload": "tree 4198286d6c63b03fc3172c70dee6c4575ddb7f12\nparent b5830fbf9222b9a83309dc61fe1df480b0c3b153\nparent ac35645455f9ccdf3019d3c272a1790673cb81fd\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1623919935 +0000\ncommitter GitHub <noreply@github.com> 1623919935 +0000\n\nMerge #9307\n\n9307: internal: switch some tests to minicore r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8ff46a368cbaad4f7ae28a2b19b7dde59ed75111", "html_url": "https://github.com/rust-lang/rust/commit/8ff46a368cbaad4f7ae28a2b19b7dde59ed75111", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8ff46a368cbaad4f7ae28a2b19b7dde59ed75111/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b5830fbf9222b9a83309dc61fe1df480b0c3b153", "url": "https://api.github.com/repos/rust-lang/rust/commits/b5830fbf9222b9a83309dc61fe1df480b0c3b153", "html_url": "https://github.com/rust-lang/rust/commit/b5830fbf9222b9a83309dc61fe1df480b0c3b153"}, {"sha": "ac35645455f9ccdf3019d3c272a1790673cb81fd", "url": "https://api.github.com/repos/rust-lang/rust/commits/ac35645455f9ccdf3019d3c272a1790673cb81fd", "html_url": "https://github.com/rust-lang/rust/commit/ac35645455f9ccdf3019d3c272a1790673cb81fd"}], "stats": {"total": 215, "additions": 37, "deletions": 178}, "files": [{"sha": "7fd73d4c71c8c97e61444631afbcad8dd88b50f6", "filename": "crates/ide_assists/src/handlers/convert_iter_for_each_to_for.rs", "status": "modified", "additions": 37, "deletions": 84, "changes": 121, "blob_url": "https://github.com/rust-lang/rust/blob/8ff46a368cbaad4f7ae28a2b19b7dde59ed75111/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fconvert_iter_for_each_to_for.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8ff46a368cbaad4f7ae28a2b19b7dde59ed75111/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fconvert_iter_for_each_to_for.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_assists%2Fsrc%2Fhandlers%2Fconvert_iter_for_each_to_for.rs?ref=8ff46a368cbaad4f7ae28a2b19b7dde59ed75111", "patch": "@@ -77,9 +77,11 @@ fn validate_method_call_expr(\n     expr: ast::MethodCallExpr,\n ) -> Option<(ast::Expr, ast::Expr)> {\n     let name_ref = expr.name_ref()?;\n-    if name_ref.syntax().text_range().intersect(ctx.frange.range).is_none()\n-        || name_ref.text() != \"for_each\"\n-    {\n+    if name_ref.syntax().text_range().intersect(ctx.frange.range).is_none() {\n+        cov_mark::hit!(test_for_each_not_applicable_invalid_cursor_pos);\n+        return None;\n+    }\n+    if name_ref.text() != \"for_each\" {\n         return None;\n     }\n \n@@ -98,59 +100,27 @@ fn validate_method_call_expr(\n \n #[cfg(test)]\n mod tests {\n-    use crate::tests::{self, check_assist};\n+    use crate::tests::{check_assist, check_assist_not_applicable};\n \n     use super::*;\n \n-    const EMPTY_ITER_FIXTURE: &'static str = r\"\n-//- /lib.rs deps:core crate:empty_iter\n-pub struct EmptyIter;\n-impl Iterator for EmptyIter {\n-    type Item = usize;\n-    fn next(&mut self) -> Option<Self::Item> { None }\n-}\n-pub struct Empty;\n-impl Empty {\n-    pub fn iter(&self) -> EmptyIter { EmptyIter }\n-}\n-\";\n-\n-    fn check_assist_with_fixtures(before: &str, after: &str) {\n-        let before = &format!(\n-            \"//- /main.rs crate:main deps:core,empty_iter{}{}{}\",\n-            before,\n-            EMPTY_ITER_FIXTURE,\n-            FamousDefs::FIXTURE,\n-        );\n-        check_assist(convert_iter_for_each_to_for, before, after);\n-    }\n-\n-    fn check_assist_not_applicable(before: &str) {\n-        let before = &format!(\n-            \"//- /main.rs crate:main deps:core,empty_iter{}{}{}\",\n-            before,\n-            EMPTY_ITER_FIXTURE,\n-            FamousDefs::FIXTURE,\n-        );\n-        tests::check_assist_not_applicable(convert_iter_for_each_to_for, before);\n-    }\n-\n     #[test]\n     fn test_for_each_in_method_stmt() {\n-        check_assist_with_fixtures(\n+        check_assist(\n+            convert_iter_for_each_to_for,\n             r#\"\n-use empty_iter::*;\n+//- minicore: iterators\n fn main() {\n-    let x = Empty;\n-    x.iter().$0for_each(|(x, y)| {\n+    let it = core::iter::repeat(92);\n+    it.$0for_each(|(x, y)| {\n         println!(\"x: {}, y: {}\", x, y);\n     });\n-}\"#,\n+}\n+\"#,\n             r#\"\n-use empty_iter::*;\n fn main() {\n-    let x = Empty;\n-    for (x, y) in x.iter() {\n+    let it = core::iter::repeat(92);\n+    for (x, y) in it {\n         println!(\"x: {}, y: {}\", x, y);\n     }\n }\n@@ -160,43 +130,21 @@ fn main() {\n \n     #[test]\n     fn test_for_each_in_method() {\n-        check_assist_with_fixtures(\n+        check_assist(\n+            convert_iter_for_each_to_for,\n             r#\"\n-use empty_iter::*;\n+//- minicore: iterators\n fn main() {\n-    let x = Empty;\n-    x.iter().$0for_each(|(x, y)| {\n+    let it = core::iter::repeat(92);\n+    it.$0for_each(|(x, y)| {\n         println!(\"x: {}, y: {}\", x, y);\n     })\n-}\"#,\n-            r#\"\n-use empty_iter::*;\n-fn main() {\n-    let x = Empty;\n-    for (x, y) in x.iter() {\n-        println!(\"x: {}, y: {}\", x, y);\n-    }\n }\n \"#,\n-        )\n-    }\n-\n-    #[test]\n-    fn test_for_each_in_iter_stmt() {\n-        check_assist_with_fixtures(\n-            r#\"\n-use empty_iter::*;\n-fn main() {\n-    let x = Empty.iter();\n-    x.$0for_each(|(x, y)| {\n-        println!(\"x: {}, y: {}\", x, y);\n-    });\n-}\"#,\n             r#\"\n-use empty_iter::*;\n fn main() {\n-    let x = Empty.iter();\n-    for (x, y) in x {\n+    let it = core::iter::repeat(92);\n+    for (x, y) in it {\n         println!(\"x: {}, y: {}\", x, y);\n     }\n }\n@@ -206,18 +154,19 @@ fn main() {\n \n     #[test]\n     fn test_for_each_without_braces_stmt() {\n-        check_assist_with_fixtures(\n+        check_assist(\n+            convert_iter_for_each_to_for,\n             r#\"\n-use empty_iter::*;\n+//- minicore: iterators\n fn main() {\n-    let x = Empty;\n-    x.iter().$0for_each(|(x, y)| println!(\"x: {}, y: {}\", x, y));\n-}\"#,\n+    let it = core::iter::repeat(92);\n+    it.$0for_each(|(x, y)| println!(\"x: {}, y: {}\", x, y));\n+}\n+\"#,\n             r#\"\n-use empty_iter::*;\n fn main() {\n-    let x = Empty;\n-    for (x, y) in x.iter() {\n+    let it = core::iter::repeat(92);\n+    for (x, y) in it {\n         println!(\"x: {}, y: {}\", x, y)\n     }\n }\n@@ -228,7 +177,9 @@ fn main() {\n     #[test]\n     fn test_for_each_not_applicable() {\n         check_assist_not_applicable(\n+            convert_iter_for_each_to_for,\n             r#\"\n+//- minicore: iterators\n fn main() {\n     ().$0for_each(|x| println!(\"{}\", x));\n }\"#,\n@@ -237,11 +188,13 @@ fn main() {\n \n     #[test]\n     fn test_for_each_not_applicable_invalid_cursor_pos() {\n+        cov_mark::check!(test_for_each_not_applicable_invalid_cursor_pos);\n         check_assist_not_applicable(\n+            convert_iter_for_each_to_for,\n             r#\"\n-use empty_iter::*;\n+//- minicore: iterators\n fn main() {\n-    Empty.iter().for_each(|(x, y)| $0println!(\"x: {}, y: {}\", x, y));\n+    core::iter::repeat(92).for_each(|(x, y)| $0println!(\"x: {}, y: {}\", x, y));\n }\"#,\n         )\n     }"}, {"sha": "551203936bd781c4e22bf2d6c76ef9757bb4cc22", "filename": "crates/ide_db/src/helpers/famous_defs_fixture.rs", "status": "modified", "additions": 0, "deletions": 94, "changes": 94, "blob_url": "https://github.com/rust-lang/rust/blob/8ff46a368cbaad4f7ae28a2b19b7dde59ed75111/crates%2Fide_db%2Fsrc%2Fhelpers%2Ffamous_defs_fixture.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8ff46a368cbaad4f7ae28a2b19b7dde59ed75111/crates%2Fide_db%2Fsrc%2Fhelpers%2Ffamous_defs_fixture.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_db%2Fsrc%2Fhelpers%2Ffamous_defs_fixture.rs?ref=8ff46a368cbaad4f7ae28a2b19b7dde59ed75111", "patch": "@@ -26,100 +26,6 @@ pub mod default {\n     }\n }\n \n-pub mod iter {\n-    pub use self::traits::{collect::IntoIterator, iterator::Iterator};\n-    mod traits {\n-        pub(crate) mod iterator {\n-            use crate::option::Option;\n-            pub trait Iterator {\n-                type Item;\n-                fn next(&mut self) -> Option<Self::Item>;\n-                fn by_ref(&mut self) -> &mut Self {\n-                    self\n-                }\n-                fn take(self, n: usize) -> crate::iter::Take<Self> {\n-                    crate::iter::Take { inner: self }\n-                }\n-            }\n-\n-            impl<I: Iterator> Iterator for &mut I {\n-                type Item = I::Item;\n-                fn next(&mut self) -> Option<I::Item> {\n-                    (**self).next()\n-                }\n-            }\n-        }\n-        pub(crate) mod collect {\n-            pub trait IntoIterator {\n-                type Item;\n-            }\n-        }\n-    }\n-\n-    pub use self::sources::*;\n-    pub(crate) mod sources {\n-        use super::Iterator;\n-        use crate::option::Option::{self, *};\n-        pub struct Repeat<A> {\n-            element: A,\n-        }\n-\n-        pub fn repeat<T>(elt: T) -> Repeat<T> {\n-            Repeat { element: elt }\n-        }\n-\n-        impl<A> Iterator for Repeat<A> {\n-            type Item = A;\n-\n-            fn next(&mut self) -> Option<A> {\n-                None\n-            }\n-        }\n-    }\n-\n-    pub use self::adapters::*;\n-    pub(crate) mod adapters {\n-        use super::Iterator;\n-        use crate::option::Option::{self, *};\n-        pub struct Take<I> {\n-            pub(crate) inner: I,\n-        }\n-        impl<I> Iterator for Take<I>\n-        where\n-            I: Iterator,\n-        {\n-            type Item = <I as Iterator>::Item;\n-            fn next(&mut self) -> Option<<I as Iterator>::Item> {\n-                None\n-            }\n-        }\n-    }\n-}\n-\n-pub mod ops {\n-    #[lang = \"fn\"]\n-    pub trait Fn<Args>: FnMut<Args> {\n-        extern \"rust-call\" fn call(&self, args: Args) -> Self::Output;\n-    }\n-\n-    #[lang = \"fn_mut\"]\n-    pub trait FnMut<Args>: FnOnce<Args> {\n-        extern \"rust-call\" fn call_mut(&mut self, args: Args) -> Self::Output;\n-    }\n-    #[lang = \"fn_once\"]\n-    pub trait FnOnce<Args> {\n-        #[lang = \"fn_once_output\"]\n-        type Output;\n-        extern \"rust-call\" fn call_once(self, args: Args) -> Self::Output;\n-    }\n-\n-    #[lang = \"deref\"]\n-    pub trait Deref {\n-        type Target: ?Sized;\n-        fn deref(&self) -> &Self::Target;\n-    }\n-}\n-\n pub mod option {\n     pub enum Option<T> {\n         None,"}]}