{"sha": "1671b9baeceeb38ddb7366668d28e3a7ee839ef3", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE2NzFiOWJhZWNlZWIzOGRkYjczNjY2NjhkMjhlM2E3ZWU4MzllZjM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-06-12T18:25:55Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-06-12T18:25:55Z"}, "message": "Auto merge of #26221 - sanxiyn:wf-span, r=arielb1\n\nWhen checking field types of struct or enum definitions, use spans for field types instead of the entire item.", "tree": {"sha": "a3093bc1dcc0bdb539d10ead1a07a57ad6e58a61", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a3093bc1dcc0bdb539d10ead1a07a57ad6e58a61"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1671b9baeceeb38ddb7366668d28e3a7ee839ef3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1671b9baeceeb38ddb7366668d28e3a7ee839ef3", "html_url": "https://github.com/rust-lang/rust/commit/1671b9baeceeb38ddb7366668d28e3a7ee839ef3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1671b9baeceeb38ddb7366668d28e3a7ee839ef3/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4cc87c8acbc2eebf923b8ede73ea98ac361ea303", "url": "https://api.github.com/repos/rust-lang/rust/commits/4cc87c8acbc2eebf923b8ede73ea98ac361ea303", "html_url": "https://github.com/rust-lang/rust/commit/4cc87c8acbc2eebf923b8ede73ea98ac361ea303"}, {"sha": "793d9fcb5237f2148a7a40f2f17d4a8dcb6128cb", "url": "https://api.github.com/repos/rust-lang/rust/commits/793d9fcb5237f2148a7a40f2f17d4a8dcb6128cb", "html_url": "https://github.com/rust-lang/rust/commit/793d9fcb5237f2148a7a40f2f17d4a8dcb6128cb"}], "stats": {"total": 55, "additions": 28, "deletions": 27}, "files": [{"sha": "c524c3024ebf4ecc90af9f364b85d91f9553b6a0", "filename": "src/librustc_typeck/check/mod.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/1671b9baeceeb38ddb7366668d28e3a7ee839ef3/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1671b9baeceeb38ddb7366668d28e3a7ee839ef3/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fmod.rs?ref=1671b9baeceeb38ddb7366668d28e3a7ee839ef3", "patch": "@@ -1626,10 +1626,9 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         let t = ast_ty_to_ty(self, self, ast_t);\n \n         let mut bounds_checker = wf::BoundsChecker::new(self,\n-                                                        ast_t.span,\n                                                         self.body_id,\n                                                         None);\n-        bounds_checker.check_ty(t);\n+        bounds_checker.check_ty(t, ast_t.span);\n \n         t\n     }"}, {"sha": "c1d260815f6bdc7a1ecf4c64b65e2b6aaf0a3489", "filename": "src/librustc_typeck/check/wf.rs", "status": "modified", "additions": 15, "deletions": 17, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/1671b9baeceeb38ddb7366668d28e3a7ee839ef3/src%2Flibrustc_typeck%2Fcheck%2Fwf.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1671b9baeceeb38ddb7366668d28e3a7ee839ef3/src%2Flibrustc_typeck%2Fcheck%2Fwf.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fwf.rs?ref=1671b9baeceeb38ddb7366668d28e3a7ee839ef3", "patch": "@@ -23,7 +23,7 @@ use util::ppaux::{Repr, UserString};\n use std::collections::HashSet;\n use syntax::ast;\n use syntax::ast_util::local_def;\n-use syntax::codemap::Span;\n+use syntax::codemap::{DUMMY_SP, Span};\n use syntax::parse::token::{self, special_idents};\n use syntax::visit;\n use syntax::visit::Visitor;\n@@ -162,15 +162,14 @@ impl<'ccx, 'tcx> CheckTypeWellFormedVisitor<'ccx, 'tcx> {\n         self.with_fcx(item, |this, fcx| {\n             let variants = lookup_fields(fcx);\n             let mut bounds_checker = BoundsChecker::new(fcx,\n-                                                        item.span,\n                                                         item.id,\n                                                         Some(&mut this.cache));\n             debug!(\"check_type_defn at bounds_checker.scope: {:?}\", bounds_checker.scope);\n \n-             for variant in &variants {\n+            for variant in &variants {\n                 for field in &variant.fields {\n                     // Regions are checked below.\n-                    bounds_checker.check_traits_in_ty(field.ty);\n+                    bounds_checker.check_traits_in_ty(field.ty, field.span);\n                 }\n \n                 // For DST, all intermediate types must be sized.\n@@ -199,7 +198,6 @@ impl<'ccx, 'tcx> CheckTypeWellFormedVisitor<'ccx, 'tcx> {\n     {\n         self.with_fcx(item, |this, fcx| {\n             let mut bounds_checker = BoundsChecker::new(fcx,\n-                                                        item.span,\n                                                         item.id,\n                                                         Some(&mut this.cache));\n             debug!(\"check_item_type at bounds_checker.scope: {:?}\", bounds_checker.scope);\n@@ -209,7 +207,7 @@ impl<'ccx, 'tcx> CheckTypeWellFormedVisitor<'ccx, 'tcx> {\n                                                       &fcx.inh.param_env.free_substs,\n                                                       &type_scheme.ty);\n \n-            bounds_checker.check_traits_in_ty(item_ty);\n+            bounds_checker.check_traits_in_ty(item_ty, item.span);\n         });\n     }\n \n@@ -218,7 +216,6 @@ impl<'ccx, 'tcx> CheckTypeWellFormedVisitor<'ccx, 'tcx> {\n     {\n         self.with_fcx(item, |this, fcx| {\n             let mut bounds_checker = BoundsChecker::new(fcx,\n-                                                        item.span,\n                                                         item.id,\n                                                         Some(&mut this.cache));\n             debug!(\"check_impl at bounds_checker.scope: {:?}\", bounds_checker.scope);\n@@ -231,7 +228,7 @@ impl<'ccx, 'tcx> CheckTypeWellFormedVisitor<'ccx, 'tcx> {\n                                                       &fcx.inh.param_env.free_substs,\n                                                       &self_ty);\n \n-            bounds_checker.check_traits_in_ty(self_ty);\n+            bounds_checker.check_traits_in_ty(self_ty, item.span);\n \n             // Similarly, obtain an \"inside\" reference to the trait\n             // that the impl implements.\n@@ -252,7 +249,7 @@ impl<'ccx, 'tcx> CheckTypeWellFormedVisitor<'ccx, 'tcx> {\n             // trait reference. Instead, this is done at the impl site.\n             // Arguably this is wrong and we should treat the trait-reference\n             // the same way as we treat the self-type.\n-            bounds_checker.check_trait_ref(&trait_ref);\n+            bounds_checker.check_trait_ref(&trait_ref, item.span);\n \n             let cause =\n                 traits::ObligationCause::new(\n@@ -483,11 +480,10 @@ pub struct BoundsChecker<'cx,'tcx:'cx> {\n \n impl<'cx,'tcx> BoundsChecker<'cx,'tcx> {\n     pub fn new(fcx: &'cx FnCtxt<'cx,'tcx>,\n-               span: Span,\n                scope: ast::NodeId,\n                cache: Option<&'cx mut HashSet<Ty<'tcx>>>)\n                -> BoundsChecker<'cx,'tcx> {\n-        BoundsChecker { fcx: fcx, span: span, scope: scope,\n+        BoundsChecker { fcx: fcx, span: DUMMY_SP, scope: scope,\n                         cache: cache, binding_count: 0 }\n     }\n \n@@ -500,30 +496,32 @@ impl<'cx,'tcx> BoundsChecker<'cx,'tcx> {\n     ///\n     /// Note that it does not (currently, at least) check that `A : Copy` (that check is delegated\n     /// to the point where impl `A : Trait<B>` is implemented).\n-    pub fn check_trait_ref(&mut self, trait_ref: &ty::TraitRef<'tcx>) {\n+    pub fn check_trait_ref(&mut self, trait_ref: &ty::TraitRef<'tcx>, span: Span) {\n         let trait_predicates = ty::lookup_predicates(self.fcx.tcx(), trait_ref.def_id);\n \n-        let bounds = self.fcx.instantiate_bounds(self.span,\n+        let bounds = self.fcx.instantiate_bounds(span,\n                                                  trait_ref.substs,\n                                                  &trait_predicates);\n \n         self.fcx.add_obligations_for_parameters(\n             traits::ObligationCause::new(\n-                self.span,\n+                span,\n                 self.fcx.body_id,\n                 traits::ItemObligation(trait_ref.def_id)),\n             &bounds);\n \n         for &ty in &trait_ref.substs.types {\n-            self.check_traits_in_ty(ty);\n+            self.check_traits_in_ty(ty, span);\n         }\n     }\n \n-    pub fn check_ty(&mut self, ty: Ty<'tcx>) {\n+    pub fn check_ty(&mut self, ty: Ty<'tcx>, span: Span) {\n+        self.span = span;\n         ty.fold_with(self);\n     }\n \n-    fn check_traits_in_ty(&mut self, ty: Ty<'tcx>) {\n+    fn check_traits_in_ty(&mut self, ty: Ty<'tcx>, span: Span) {\n+        self.span = span;\n         // When checking types outside of a type def'n, we ignore\n         // region obligations. See discussion below in fold_ty().\n         self.binding_count += 1;"}, {"sha": "c13f7346b1178c6c0ad8d73c147397e168b9738f", "filename": "src/test/compile-fail/trait-bounds-on-structs-and-enums.rs", "status": "modified", "additions": 12, "deletions": 8, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/1671b9baeceeb38ddb7366668d28e3a7ee839ef3/src%2Ftest%2Fcompile-fail%2Ftrait-bounds-on-structs-and-enums.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1671b9baeceeb38ddb7366668d28e3a7ee839ef3/src%2Ftest%2Fcompile-fail%2Ftrait-bounds-on-structs-and-enums.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Ftrait-bounds-on-structs-and-enums.rs?ref=1671b9baeceeb38ddb7366668d28e3a7ee839ef3", "patch": "@@ -32,23 +32,27 @@ impl<T> Foo<T> {\n }\n \n struct Baz {\n-//~^ ERROR not implemented\n-    a: Foo<isize>,\n+    a: Foo<isize>, //~ ERROR not implemented\n }\n \n enum Boo {\n-//~^ ERROR not implemented\n-    Quux(Bar<usize>),\n+    Quux(Bar<usize>), //~ ERROR not implemented\n }\n \n struct Badness<U> {\n-//~^ ERROR not implemented\n-    b: Foo<U>,\n+    b: Foo<U>, //~ ERROR not implemented\n }\n \n enum MoreBadness<V> {\n-//~^ ERROR not implemented\n-    EvenMoreBadness(Bar<V>),\n+    EvenMoreBadness(Bar<V>), //~ ERROR not implemented\n+}\n+\n+struct TupleLike(\n+    Foo<i32>, //~ ERROR not implemented\n+);\n+\n+enum Enum {\n+    DictionaryLike { field: Bar<i32> }, //~ ERROR not implemented\n }\n \n trait PolyTrait<T>"}]}