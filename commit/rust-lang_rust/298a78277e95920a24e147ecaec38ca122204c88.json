{"sha": "298a78277e95920a24e147ecaec38ca122204c88", "node_id": "C_kwDOAAsO6NoAKDI5OGE3ODI3N2U5NTkyMGEyNGUxNDdlY2FlYzM4Y2ExMjIyMDRjODg", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-01-21T14:18:17Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-01-21T14:18:17Z"}, "message": "Auto merge of #106977 - michaelwoerister:unord_id_collections, r=oli-obk\n\nUse UnordMap and UnordSet for id collections (DefIdMap, LocalDefIdMap, etc)\n\nThis PR changes the `rustc_data_structures::define_id_collections!` macro to use `UnordMap` and `UnordSet` instead of `FxHashMap` and `FxHashSet`. This should account for a large portion of hash-maps being used in places where they can cause trouble.\n\nThe changes required are moderate but non-zero:\n- In some places the collections are extracted into sorted vecs.\n- There are a few instances where for-loops have been changed to extends.\n\n~~Let's see what the performance impact is. With a bit more refactoring, we might be able to get rid of some of the additional sorting -- but the change set is already big enough. Unless there's a performance impact, I'd like to do further changes in subsequent PRs.~~\n\nPerformance does not seem to be negatively affected ([perf-run here](https://github.com/rust-lang/rust/pull/106977#issuecomment-1396776699)).\n\nPart of [MCP 533](https://github.com/rust-lang/compiler-team/issues/533).\n\nr? `@ghost`", "tree": {"sha": "d6ad1ac9b963f313b25198d0af94687d52d712e4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d6ad1ac9b963f313b25198d0af94687d52d712e4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/298a78277e95920a24e147ecaec38ca122204c88", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/298a78277e95920a24e147ecaec38ca122204c88", "html_url": "https://github.com/rust-lang/rust/commit/298a78277e95920a24e147ecaec38ca122204c88", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/298a78277e95920a24e147ecaec38ca122204c88/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ce460dcd14d7f020a38614a37f05e8484163c98c", "url": "https://api.github.com/repos/rust-lang/rust/commits/ce460dcd14d7f020a38614a37f05e8484163c98c", "html_url": "https://github.com/rust-lang/rust/commit/ce460dcd14d7f020a38614a37f05e8484163c98c"}, {"sha": "c1b358945a4e1d4877b21c02fa52afc5ff2b39a7", "url": "https://api.github.com/repos/rust-lang/rust/commits/c1b358945a4e1d4877b21c02fa52afc5ff2b39a7", "html_url": "https://github.com/rust-lang/rust/commit/c1b358945a4e1d4877b21c02fa52afc5ff2b39a7"}], "stats": {"total": 60, "additions": 30, "deletions": 30}, "files": [{"sha": "e9b2e31a769ad5a216a3375d9be6a52f9e4f2e24", "filename": "clippy_lints/src/inherent_impl.rs", "status": "modified", "additions": 12, "deletions": 14, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/298a78277e95920a24e147ecaec38ca122204c88/clippy_lints%2Fsrc%2Finherent_impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/298a78277e95920a24e147ecaec38ca122204c88/clippy_lints%2Fsrc%2Finherent_impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Finherent_impl.rs?ref=298a78277e95920a24e147ecaec38ca122204c88", "patch": "@@ -52,21 +52,19 @@ impl<'tcx> LateLintPass<'tcx> for MultipleInherentImpl {\n         // List of spans to lint. (lint_span, first_span)\n         let mut lint_spans = Vec::new();\n \n-        for (_, impl_ids) in cx\n+        let inherent_impls = cx\n             .tcx\n-            .crate_inherent_impls(())\n-            .inherent_impls\n-            .iter()\n-            .filter(|(&id, impls)| {\n-                impls.len() > 1\n-                    // Check for `#[allow]` on the type definition\n-                    && !is_lint_allowed(\n-                        cx,\n-                        MULTIPLE_INHERENT_IMPL,\n-                        cx.tcx.hir().local_def_id_to_hir_id(id),\n-                    )\n-            })\n-        {\n+            .with_stable_hashing_context(|hcx| cx.tcx.crate_inherent_impls(()).inherent_impls.to_sorted(&hcx, true));\n+\n+        for (_, impl_ids) in inherent_impls.into_iter().filter(|(&id, impls)| {\n+            impls.len() > 1\n+            // Check for `#[allow]` on the type definition\n+            && !is_lint_allowed(\n+                cx,\n+                MULTIPLE_INHERENT_IMPL,\n+                cx.tcx.hir().local_def_id_to_hir_id(id),\n+            )\n+        }) {\n             for impl_id in impl_ids.iter().map(|id| id.expect_local()) {\n                 match type_map.entry(cx.tcx.type_of(impl_id)) {\n                     Entry::Vacant(e) => {"}, {"sha": "3c70c9cf19a516ccdc00d91ef97324d6a86b5682", "filename": "clippy_lints/src/len_zero.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/298a78277e95920a24e147ecaec38ca122204c88/clippy_lints%2Fsrc%2Flen_zero.rs", "raw_url": "https://github.com/rust-lang/rust/raw/298a78277e95920a24e147ecaec38ca122204c88/clippy_lints%2Fsrc%2Flen_zero.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flen_zero.rs?ref=298a78277e95920a24e147ecaec38ca122204c88", "patch": "@@ -219,7 +219,7 @@ fn check_trait_items(cx: &LateContext<'_>, visited_trait: &Item<'_>, trait_items\n         let is_empty = sym!(is_empty);\n \n         let is_empty_method_found = current_and_super_traits\n-            .iter()\n+            .items()\n             .flat_map(|&i| cx.tcx.associated_items(i).filter_by_name_unhygienic(is_empty))\n             .any(|i| {\n                 i.kind == ty::AssocKind::Fn"}, {"sha": "d1a1f773f87b3b0878b83ab05a261a8ea89ab4c9", "filename": "clippy_lints/src/loops/while_immutable_condition.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/298a78277e95920a24e147ecaec38ca122204c88/clippy_lints%2Fsrc%2Floops%2Fwhile_immutable_condition.rs", "raw_url": "https://github.com/rust-lang/rust/raw/298a78277e95920a24e147ecaec38ca122204c88/clippy_lints%2Fsrc%2Floops%2Fwhile_immutable_condition.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Floops%2Fwhile_immutable_condition.rs?ref=298a78277e95920a24e147ecaec38ca122204c88", "patch": "@@ -35,7 +35,7 @@ pub(super) fn check<'tcx>(cx: &LateContext<'tcx>, cond: &'tcx Expr<'_>, expr: &'\n         } else {\n             return;\n         };\n-    let mutable_static_in_cond = var_visitor.def_ids.iter().any(|(_, v)| *v);\n+    let mutable_static_in_cond = var_visitor.def_ids.items().any(|(_, v)| *v);\n \n     let mut has_break_or_return_visitor = HasBreakOrReturnVisitor {\n         has_break_or_return: false,"}, {"sha": "3371b4cce32c1fa265b21ab0c207c6d5d8742a99", "filename": "clippy_lints/src/missing_trait_methods.rs", "status": "modified", "additions": 14, "deletions": 12, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/298a78277e95920a24e147ecaec38ca122204c88/clippy_lints%2Fsrc%2Fmissing_trait_methods.rs", "raw_url": "https://github.com/rust-lang/rust/raw/298a78277e95920a24e147ecaec38ca122204c88/clippy_lints%2Fsrc%2Fmissing_trait_methods.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmissing_trait_methods.rs?ref=298a78277e95920a24e147ecaec38ca122204c88", "patch": "@@ -80,19 +80,21 @@ impl<'tcx> LateLintPass<'tcx> for MissingTraitMethods {\n                 }\n             }\n \n-            for assoc in provided.values() {\n-                let source_map = cx.tcx.sess.source_map();\n-                let definition_span = source_map.guess_head_span(cx.tcx.def_span(assoc.def_id));\n+            cx.tcx.with_stable_hashing_context(|hcx| {\n+                for assoc in provided.values_sorted(&hcx, true) {\n+                    let source_map = cx.tcx.sess.source_map();\n+                    let definition_span = source_map.guess_head_span(cx.tcx.def_span(assoc.def_id));\n \n-                span_lint_and_help(\n-                    cx,\n-                    MISSING_TRAIT_METHODS,\n-                    source_map.guess_head_span(item.span),\n-                    &format!(\"missing trait method provided by default: `{}`\", assoc.name),\n-                    Some(definition_span),\n-                    \"implement the method\",\n-                );\n-            }\n+                    span_lint_and_help(\n+                        cx,\n+                        MISSING_TRAIT_METHODS,\n+                        source_map.guess_head_span(item.span),\n+                        &format!(\"missing trait method provided by default: `{}`\", assoc.name),\n+                        Some(definition_span),\n+                        \"implement the method\",\n+                    );\n+                }\n+            })\n         }\n     }\n }"}, {"sha": "2d21aaa4f7fdb5606f560763c8e00dcac0a8ab93", "filename": "clippy_lints/src/pass_by_ref_or_value.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/298a78277e95920a24e147ecaec38ca122204c88/clippy_lints%2Fsrc%2Fpass_by_ref_or_value.rs", "raw_url": "https://github.com/rust-lang/rust/raw/298a78277e95920a24e147ecaec38ca122204c88/clippy_lints%2Fsrc%2Fpass_by_ref_or_value.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fpass_by_ref_or_value.rs?ref=298a78277e95920a24e147ecaec38ca122204c88", "patch": "@@ -190,10 +190,10 @@ impl<'tcx> PassByRefOrValue {\n                             // Don't lint if an unsafe pointer is created.\n                             // TODO: Limit the check only to unsafe pointers to the argument (or part of the argument)\n                             //       which escape the current function.\n-                            if typeck.node_types().iter().any(|(_, &ty)| ty.is_unsafe_ptr())\n+                            if typeck.node_types().items().any(|(_, &ty)| ty.is_unsafe_ptr())\n                                 || typeck\n                                     .adjustments()\n-                                    .iter()\n+                                    .items()\n                                     .flat_map(|(_, a)| a)\n                                     .any(|a| matches!(a.kind, Adjust::Pointer(PointerCast::UnsafeFnPointer)))\n                             {"}]}