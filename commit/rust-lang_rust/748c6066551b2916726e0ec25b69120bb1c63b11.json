{"sha": "748c6066551b2916726e0ec25b69120bb1c63b11", "node_id": "C_kwDOAAsO6NoAKDc0OGM2MDY2NTUxYjI5MTY3MjZlMGVjMjViNjkxMjBiYjFjNjNiMTE", "commit": {"author": {"name": "Michael Howell", "email": "michael@notriddle.com", "date": "2022-08-18T22:13:28Z"}, "committer": {"name": "Michael Howell", "email": "michael@notriddle.com", "date": "2022-08-18T22:31:14Z"}, "message": "rustdoc: count deref and non-deref as same set of used methods", "tree": {"sha": "7a54dbebeac60b8564b9848c184fc8fe86c4a160", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7a54dbebeac60b8564b9848c184fc8fe86c4a160"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/748c6066551b2916726e0ec25b69120bb1c63b11", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/748c6066551b2916726e0ec25b69120bb1c63b11", "html_url": "https://github.com/rust-lang/rust/commit/748c6066551b2916726e0ec25b69120bb1c63b11", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/748c6066551b2916726e0ec25b69120bb1c63b11/comments", "author": {"login": "notriddle", "id": 1593513, "node_id": "MDQ6VXNlcjE1OTM1MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1593513?v=4", "gravatar_id": "", "url": "https://api.github.com/users/notriddle", "html_url": "https://github.com/notriddle", "followers_url": "https://api.github.com/users/notriddle/followers", "following_url": "https://api.github.com/users/notriddle/following{/other_user}", "gists_url": "https://api.github.com/users/notriddle/gists{/gist_id}", "starred_url": "https://api.github.com/users/notriddle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/notriddle/subscriptions", "organizations_url": "https://api.github.com/users/notriddle/orgs", "repos_url": "https://api.github.com/users/notriddle/repos", "events_url": "https://api.github.com/users/notriddle/events{/privacy}", "received_events_url": "https://api.github.com/users/notriddle/received_events", "type": "User", "site_admin": false}, "committer": {"login": "notriddle", "id": 1593513, "node_id": "MDQ6VXNlcjE1OTM1MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1593513?v=4", "gravatar_id": "", "url": "https://api.github.com/users/notriddle", "html_url": "https://github.com/notriddle", "followers_url": "https://api.github.com/users/notriddle/followers", "following_url": "https://api.github.com/users/notriddle/following{/other_user}", "gists_url": "https://api.github.com/users/notriddle/gists{/gist_id}", "starred_url": "https://api.github.com/users/notriddle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/notriddle/subscriptions", "organizations_url": "https://api.github.com/users/notriddle/orgs", "repos_url": "https://api.github.com/users/notriddle/repos", "events_url": "https://api.github.com/users/notriddle/events{/privacy}", "received_events_url": "https://api.github.com/users/notriddle/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a39bdb1d6b9eaf23f2636baee0949d67890abcd8", "url": "https://api.github.com/repos/rust-lang/rust/commits/a39bdb1d6b9eaf23f2636baee0949d67890abcd8", "html_url": "https://github.com/rust-lang/rust/commit/a39bdb1d6b9eaf23f2636baee0949d67890abcd8"}], "stats": {"total": 47, "additions": 41, "deletions": 6}, "files": [{"sha": "a8e32e84cbcbd9402469b8da380ff06dae8fa1d2", "filename": "src/librustdoc/html/render/mod.rs", "status": "modified", "additions": 11, "deletions": 6, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/748c6066551b2916726e0ec25b69120bb1c63b11/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/748c6066551b2916726e0ec25b69120bb1c63b11/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs?ref=748c6066551b2916726e0ec25b69120bb1c63b11", "patch": "@@ -1985,7 +1985,7 @@ fn sidebar_assoc_items(cx: &Context<'_>, out: &mut Buffer, it: &clean::Item) {\n             {\n                 let mut derefs = FxHashSet::default();\n                 derefs.insert(did);\n-                sidebar_deref_methods(cx, out, impl_, v, &mut derefs);\n+                sidebar_deref_methods(cx, out, impl_, v, &mut derefs, &mut used_links);\n             }\n \n             let format_impls = |impls: Vec<&Impl>, id_map: &mut IdMap| {\n@@ -2057,6 +2057,7 @@ fn sidebar_deref_methods(\n     impl_: &Impl,\n     v: &[Impl],\n     derefs: &mut FxHashSet<DefId>,\n+    used_links: &mut FxHashSet<String>,\n ) {\n     let c = cx.cache();\n \n@@ -2089,13 +2090,10 @@ fn sidebar_deref_methods(\n             .and_then(|did| c.impls.get(&did));\n         if let Some(impls) = inner_impl {\n             debug!(\"found inner_impl: {:?}\", impls);\n-            let mut used_links = FxHashSet::default();\n             let mut ret = impls\n                 .iter()\n                 .filter(|i| i.inner_impl().trait_.is_none())\n-                .flat_map(|i| {\n-                    get_methods(i.inner_impl(), true, &mut used_links, deref_mut, cx.tcx())\n-                })\n+                .flat_map(|i| get_methods(i.inner_impl(), true, used_links, deref_mut, cx.tcx()))\n                 .collect::<Vec<_>>();\n             if !ret.is_empty() {\n                 let id = if let Some(target_def_id) = real_target.def_id(c) {\n@@ -2124,7 +2122,14 @@ fn sidebar_deref_methods(\n                         .map(|t| Some(t.def_id()) == cx.tcx().lang_items().deref_trait())\n                         .unwrap_or(false)\n                 }) {\n-                    sidebar_deref_methods(cx, out, target_deref_impl, target_impls, derefs);\n+                    sidebar_deref_methods(\n+                        cx,\n+                        out,\n+                        target_deref_impl,\n+                        target_impls,\n+                        derefs,\n+                        used_links,\n+                    );\n                 }\n             }\n         }"}, {"sha": "f09d23206093d7a36d43f6789ed479c8c74206e9", "filename": "src/test/rustdoc/issue-100679-sidebar-links-deref.rs", "status": "added", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/748c6066551b2916726e0ec25b69120bb1c63b11/src%2Ftest%2Frustdoc%2Fissue-100679-sidebar-links-deref.rs", "raw_url": "https://github.com/rust-lang/rust/raw/748c6066551b2916726e0ec25b69120bb1c63b11/src%2Ftest%2Frustdoc%2Fissue-100679-sidebar-links-deref.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fissue-100679-sidebar-links-deref.rs?ref=748c6066551b2916726e0ec25b69120bb1c63b11", "patch": "@@ -0,0 +1,30 @@\n+#![crate_name=\"foo\"]\n+\n+pub struct Vec;\n+\n+pub struct Slice;\n+\n+impl std::ops::Deref for Vec {\n+    type Target = Slice;\n+    fn deref(&self) -> &Slice {\n+        &Slice\n+    }\n+}\n+\n+// @has foo/struct.Vec.html '//*[@class=\"sidebar-elems\"]//section//li/a[@href=\"#method.is_empty\"]' \\\n+//          \"is_empty\"\n+impl Vec {\n+    pub fn is_empty(&self) -> bool {\n+        true\n+    }\n+}\n+\n+// @has foo/struct.Vec.html '//*[@class=\"sidebar-elems\"]//section//li/a[@href=\"#method.is_empty-1\"]' \\\n+//          \"is_empty\"\n+// @has foo/struct.Slice.html '//*[@class=\"sidebar-elems\"]//section//li/a[@href=\"#method.is_empty\"]' \\\n+//          \"is_empty\"\n+impl Slice {\n+    pub fn is_empty(&self) -> bool {\n+        true\n+    }\n+}"}]}