{"sha": "9b3db0ed445de1b513742770420ba4b60a025219", "node_id": "MDY6Q29tbWl0NzI0NzEyOjliM2RiMGVkNDQ1ZGUxYjUxMzc0Mjc3MDQyMGJhNGI2MGEwMjUyMTk=", "commit": {"author": {"name": "Patrick Walton", "email": "pcwalton@mimiga.net", "date": "2011-03-11T23:35:20Z"}, "committer": {"name": "Patrick Walton", "email": "pcwalton@mimiga.net", "date": "2011-03-11T23:35:50Z"}, "message": "rustc: Add some stub metadata to each crate", "tree": {"sha": "ba749edd60a802d5707b44ccf432ca237c151028", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ba749edd60a802d5707b44ccf432ca237c151028"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9b3db0ed445de1b513742770420ba4b60a025219", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9b3db0ed445de1b513742770420ba4b60a025219", "html_url": "https://github.com/rust-lang/rust/commit/9b3db0ed445de1b513742770420ba4b60a025219", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9b3db0ed445de1b513742770420ba4b60a025219/comments", "author": {"login": "pcwalton", "id": 157897, "node_id": "MDQ6VXNlcjE1Nzg5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/157897?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pcwalton", "html_url": "https://github.com/pcwalton", "followers_url": "https://api.github.com/users/pcwalton/followers", "following_url": "https://api.github.com/users/pcwalton/following{/other_user}", "gists_url": "https://api.github.com/users/pcwalton/gists{/gist_id}", "starred_url": "https://api.github.com/users/pcwalton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pcwalton/subscriptions", "organizations_url": "https://api.github.com/users/pcwalton/orgs", "repos_url": "https://api.github.com/users/pcwalton/repos", "events_url": "https://api.github.com/users/pcwalton/events{/privacy}", "received_events_url": "https://api.github.com/users/pcwalton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pcwalton", "id": 157897, "node_id": "MDQ6VXNlcjE1Nzg5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/157897?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pcwalton", "html_url": "https://github.com/pcwalton", "followers_url": "https://api.github.com/users/pcwalton/followers", "following_url": "https://api.github.com/users/pcwalton/following{/other_user}", "gists_url": "https://api.github.com/users/pcwalton/gists{/gist_id}", "starred_url": "https://api.github.com/users/pcwalton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pcwalton/subscriptions", "organizations_url": "https://api.github.com/users/pcwalton/orgs", "repos_url": "https://api.github.com/users/pcwalton/repos", "events_url": "https://api.github.com/users/pcwalton/events{/privacy}", "received_events_url": "https://api.github.com/users/pcwalton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "74d891517be8f6299b0626c26400dd54dd1aac6c", "url": "https://api.github.com/repos/rust-lang/rust/commits/74d891517be8f6299b0626c26400dd54dd1aac6c", "html_url": "https://github.com/rust-lang/rust/commit/74d891517be8f6299b0626c26400dd54dd1aac6c"}], "stats": {"total": 44, "additions": 44, "deletions": 0}, "files": [{"sha": "0ed79db453cbbe80fda9f653eec57b97618b04a9", "filename": "src/comp/back/x86.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/9b3db0ed445de1b513742770420ba4b60a025219/src%2Fcomp%2Fback%2Fx86.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b3db0ed445de1b513742770420ba4b60a025219/src%2Fcomp%2Fback%2Fx86.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomp%2Fback%2Fx86.rs?ref=9b3db0ed445de1b513742770420ba4b60a025219", "patch": "@@ -273,6 +273,16 @@ fn get_module_asm() -> str {\n     ret _str.connect(glues, \"\\n\\n\");\n }\n \n+fn get_meta_sect_name() -> str {\n+    if (_str.eq(target_os(), \"macos\")) {\n+        ret \"__DATA,__note.rustc\";\n+    }\n+    if (_str.eq(target_os(), \"win32\")) {\n+        ret \".note.rustc\";\n+    }\n+    ret \".note.rustc\";\n+}\n+\n fn get_data_layout() -> str {\n     if (_str.eq(target_os(), \"macos\")) {\n       ret \"e-p:32:32-f64:32:64-i64:32:64-f80:128:128-n8:16:32\";"}, {"sha": "433d7147024b4f193f483a79c69ad32e0f27d2b2", "filename": "src/comp/middle/metadata.rs", "status": "added", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/9b3db0ed445de1b513742770420ba4b60a025219/src%2Fcomp%2Fmiddle%2Fmetadata.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b3db0ed445de1b513742770420ba4b60a025219/src%2Fcomp%2Fmiddle%2Fmetadata.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomp%2Fmiddle%2Fmetadata.rs?ref=9b3db0ed445de1b513742770420ba4b60a025219", "patch": "@@ -0,0 +1,29 @@\n+import std._str;\n+import front.ast;\n+import middle.trans;\n+import back.x86;\n+\n+import lib.llvm.llvm;\n+import lib.llvm.llvm.ValueRef;\n+import lib.llvm.False;\n+\n+// Returns a Plain Old LLVM String.\n+fn C_postr(str s) -> ValueRef {\n+    ret llvm.LLVMConstString(_str.buf(s), _str.byte_len(s), False);\n+}\n+\n+fn collect_meta_directives(@trans.crate_ctxt cx, @ast.crate crate)\n+        -> ValueRef {\n+    ret C_postr(\"Hello world!\");    // TODO\n+}\n+\n+fn write_metadata(@trans.crate_ctxt cx, @ast.crate crate) {\n+    auto llmeta = collect_meta_directives(cx, crate);\n+\n+    auto llconst = trans.C_struct(vec(llmeta));\n+    auto llglobal = llvm.LLVMAddGlobal(cx.llmod, trans.val_ty(llconst),\n+                                       _str.buf(\"rust_metadata\"));\n+    llvm.LLVMSetInitializer(llglobal, llconst);\n+    llvm.LLVMSetSection(llglobal, _str.buf(x86.get_meta_sect_name()));\n+}\n+"}, {"sha": "6485054231711454816969c4d9cf63266f83fb4a", "filename": "src/comp/middle/trans.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/9b3db0ed445de1b513742770420ba4b60a025219/src%2Fcomp%2Fmiddle%2Ftrans.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b3db0ed445de1b513742770420ba4b60a025219/src%2Fcomp%2Fmiddle%2Ftrans.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomp%2Fmiddle%2Ftrans.rs?ref=9b3db0ed445de1b513742770420ba4b60a025219", "patch": "@@ -6192,6 +6192,9 @@ fn trans_crate(session.session sess, @ast.crate crate, str output,\n         trans_main_fn(cx, cx.crate_ptr);\n     }\n \n+    // Translate the metadata.\n+    middle.metadata.write_metadata(cx, crate);\n+\n     check_module(llmod);\n \n     llvm.LLVMWriteBitcodeToFile(llmod, _str.buf(output));"}, {"sha": "006aca62b0e851c8892b3d0e27eed12c2f43c1a3", "filename": "src/comp/rustc.rc", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/9b3db0ed445de1b513742770420ba4b60a025219/src%2Fcomp%2Frustc.rc", "raw_url": "https://github.com/rust-lang/rust/raw/9b3db0ed445de1b513742770420ba4b60a025219/src%2Fcomp%2Frustc.rc", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomp%2Frustc.rc?ref=9b3db0ed445de1b513742770420ba4b60a025219", "patch": "@@ -14,6 +14,7 @@ mod front {\n \n mod middle {\n     mod fold;\n+    mod metadata;\n     mod resolve;\n     mod trans;\n     mod ty;\n@@ -40,6 +41,7 @@ mod util {\n }\n \n auth driver.rustc.main = impure;\n+auth middle.metadata = unsafe;\n auth middle.trans = unsafe;\n auth middle.trans.copy_args_to_allocas = impure;\n auth middle.trans.trans_block = impure;"}]}