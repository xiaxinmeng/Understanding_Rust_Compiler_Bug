{"sha": "f51ba7d8a434b537f05b0eba8e97d3af1580cfa9", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY1MWJhN2Q4YTQzNGI1MzdmMDViMGViYThlOTdkM2FmMTU4MGNmYTk=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-01-28T18:34:57Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-01-28T18:34:57Z"}, "message": "Merge #7485\n\n7485: Fix incorrect `FileId` and remove broken shortcut r=jonas-schievink a=jonas-schievink\n\nApparently we were using the crate's root file instead of the file\r\ncontaining the block.\r\n\r\nbors r+\n\nCo-authored-by: Jonas Schievink <jonasschievink@gmail.com>", "tree": {"sha": "73a3ed7fa6ae337a1c8cb69f10ff9f0101cd6fce", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/73a3ed7fa6ae337a1c8cb69f10ff9f0101cd6fce"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f51ba7d8a434b537f05b0eba8e97d3af1580cfa9", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgEwPRCRBK7hj4Ov3rIwAAdHIIAIzqSfLISfoQb02wCh8WlMkR\nd778a5wFZcmPzkcsXBHlSl8WMcKE1m/cKS4ZEAMvzNlp4o/5Gu6rj64nZVzYM6Xg\nYA/6onmwjUqe0SNg/ERppp8cTnA4vHpHkFIJGx9p+/Xr9u/HYKOpPsmv3BQbgv73\netSfZGj6nXJgRTclctAvdrc4UHvKfgBYTxLaQtXlNj8KCpRJQvdYf46fvFB0cx1K\nRVV849EWctCMyW9pXSXyQr+B8dBTLqw9dWM8NMQv0vlNiqQnicP5oXgVEBRUh+9x\nJ2/q08N1ASWdKfbVHPfBKY1gdZzNaR2/bo6qEwzu341Yc9tQUKQ+oodRelwgbQ4=\n=qExF\n-----END PGP SIGNATURE-----\n", "payload": "tree 73a3ed7fa6ae337a1c8cb69f10ff9f0101cd6fce\nparent fa1b500d2f412119454de7f9e98ec2664b604108\nparent 090b2f0e50b48cd22ac48399bd3c4d17c3e92765\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1611858897 +0000\ncommitter GitHub <noreply@github.com> 1611858897 +0000\n\nMerge #7485\n\n7485: Fix incorrect `FileId` and remove broken shortcut r=jonas-schievink a=jonas-schievink\n\nApparently we were using the crate's root file instead of the file\r\ncontaining the block.\r\n\r\nbors r+\n\nCo-authored-by: Jonas Schievink <jonasschievink@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f51ba7d8a434b537f05b0eba8e97d3af1580cfa9", "html_url": "https://github.com/rust-lang/rust/commit/f51ba7d8a434b537f05b0eba8e97d3af1580cfa9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f51ba7d8a434b537f05b0eba8e97d3af1580cfa9/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fa1b500d2f412119454de7f9e98ec2664b604108", "url": "https://api.github.com/repos/rust-lang/rust/commits/fa1b500d2f412119454de7f9e98ec2664b604108", "html_url": "https://github.com/rust-lang/rust/commit/fa1b500d2f412119454de7f9e98ec2664b604108"}, {"sha": "090b2f0e50b48cd22ac48399bd3c4d17c3e92765", "url": "https://api.github.com/repos/rust-lang/rust/commits/090b2f0e50b48cd22ac48399bd3c4d17c3e92765", "html_url": "https://github.com/rust-lang/rust/commit/090b2f0e50b48cd22ac48399bd3c4d17c3e92765"}], "stats": {"total": 25, "additions": 9, "deletions": 16}, "files": [{"sha": "6169b3bbcbdd851a000bb8bc51f243dcfb400008", "filename": "crates/hir_def/src/nameres.rs", "status": "modified", "additions": 3, "deletions": 9, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/f51ba7d8a434b537f05b0eba8e97d3af1580cfa9/crates%2Fhir_def%2Fsrc%2Fnameres.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f51ba7d8a434b537f05b0eba8e97d3af1580cfa9/crates%2Fhir_def%2Fsrc%2Fnameres.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fnameres.rs?ref=f51ba7d8a434b537f05b0eba8e97d3af1580cfa9", "patch": "@@ -199,24 +199,18 @@ impl DefMap {\n \n     pub(crate) fn block_def_map_query(db: &dyn DefDatabase, block_id: BlockId) -> Arc<DefMap> {\n         let block: BlockLoc = db.lookup_intern_block(block_id);\n-        let item_tree = db.item_tree(block.ast_id.file_id);\n-        let block_items = item_tree.inner_items_of_block(block.ast_id.value);\n-\n         let parent = block.module.def_map(db);\n \n-        if block_items.is_empty() {\n-            // If there are no inner items, nothing new is brought into scope, so we can just return\n-            // the parent DefMap. This keeps DefMap parent chains short.\n-            return parent;\n-        }\n+        // FIXME: It would be good to just return the parent map when the block has no items, but\n+        // we rely on `def_map.block` in a few places, which is `Some` for the inner `DefMap`.\n \n         let block_info =\n             BlockInfo { block: block_id, parent, parent_module: block.module.local_id };\n \n         let mut def_map = DefMap::empty(block.module.krate, block_info.parent.edition);\n         def_map.block = Some(block_info);\n \n-        let def_map = collector::collect_defs(db, def_map, Some(block.ast_id.value));\n+        let def_map = collector::collect_defs(db, def_map, Some(block.ast_id));\n         Arc::new(def_map)\n     }\n "}, {"sha": "ae98fadac29785514ffdb72376f97fccb12588d1", "filename": "crates/hir_def/src/nameres/collector.rs", "status": "modified", "additions": 6, "deletions": 7, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/f51ba7d8a434b537f05b0eba8e97d3af1580cfa9/crates%2Fhir_def%2Fsrc%2Fnameres%2Fcollector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f51ba7d8a434b537f05b0eba8e97d3af1580cfa9/crates%2Fhir_def%2Fsrc%2Fnameres%2Fcollector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fnameres%2Fcollector.rs?ref=f51ba7d8a434b537f05b0eba8e97d3af1580cfa9", "patch": "@@ -48,7 +48,7 @@ const FIXED_POINT_LIMIT: usize = 8192;\n pub(super) fn collect_defs(\n     db: &dyn DefDatabase,\n     mut def_map: DefMap,\n-    block: Option<FileAstId<ast::BlockExpr>>,\n+    block: Option<AstId<ast::BlockExpr>>,\n ) -> DefMap {\n     let crate_graph = db.crate_graph();\n \n@@ -261,11 +261,10 @@ impl DefCollector<'_> {\n         }\n     }\n \n-    fn seed_with_inner(&mut self, block: FileAstId<ast::BlockExpr>) {\n-        let file_id = self.db.crate_graph()[self.def_map.krate].root_file_id;\n-        let item_tree = self.db.item_tree(file_id.into());\n+    fn seed_with_inner(&mut self, block: AstId<ast::BlockExpr>) {\n+        let item_tree = self.db.item_tree(block.file_id);\n         let module_id = self.def_map.root;\n-        self.def_map.modules[module_id].origin = ModuleOrigin::CrateRoot { definition: file_id };\n+        self.def_map.modules[module_id].origin = ModuleOrigin::BlockExpr { block };\n         if item_tree\n             .top_level_attrs(self.db, self.def_map.krate)\n             .cfg()\n@@ -275,11 +274,11 @@ impl DefCollector<'_> {\n                 def_collector: &mut *self,\n                 macro_depth: 0,\n                 module_id,\n-                file_id: file_id.into(),\n+                file_id: block.file_id,\n                 item_tree: &item_tree,\n                 mod_dir: ModDir::root(),\n             }\n-            .collect(item_tree.inner_items_of_block(block));\n+            .collect(item_tree.inner_items_of_block(block.value));\n         }\n     }\n "}]}