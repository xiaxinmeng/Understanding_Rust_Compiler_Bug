{"sha": "e13f02eb2e188a3d8c2a5f7ba20823a85ab14307", "node_id": "MDY6Q29tbWl0NzI0NzEyOmUxM2YwMmViMmUxODhhM2Q4YzJhNWY3YmEyMDgyM2E4NWFiMTQzMDc=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2017-08-25T17:10:27Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2017-08-25T17:12:02Z"}, "message": "rustbuild: Automatically enable Ninja on MSVC\n\nDiscovered in #43767 it turns out the default MSBuild generator in CMake for\nwhatever reason isn't supporting many of the configuration options we give to\nLLVM. To improve the contributor experience automatically enable Ninja if we\nfind it to ensure that \"flavorful\" configurations of LLVM work by default in\nmore situations.\n\nCloses #43767", "tree": {"sha": "81d7a2de2d6b3d8e087298308d6b1a5c04e2231a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/81d7a2de2d6b3d8e087298308d6b1a5c04e2231a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e13f02eb2e188a3d8c2a5f7ba20823a85ab14307", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e13f02eb2e188a3d8c2a5f7ba20823a85ab14307", "html_url": "https://github.com/rust-lang/rust/commit/e13f02eb2e188a3d8c2a5f7ba20823a85ab14307", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e13f02eb2e188a3d8c2a5f7ba20823a85ab14307/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ba65645c78a87f1fa5c6d7132130bb3175fbe68b", "url": "https://api.github.com/repos/rust-lang/rust/commits/ba65645c78a87f1fa5c6d7132130bb3175fbe68b", "html_url": "https://github.com/rust-lang/rust/commit/ba65645c78a87f1fa5c6d7132130bb3175fbe68b"}], "stats": {"total": 25, "additions": 21, "deletions": 4}, "files": [{"sha": "54208d8bb57a623cfada3ec171e9ed4515fb5df0", "filename": "src/bootstrap/sanity.rs", "status": "modified", "additions": 21, "deletions": 4, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/e13f02eb2e188a3d8c2a5f7ba20823a85ab14307/src%2Fbootstrap%2Fsanity.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e13f02eb2e188a3d8c2a5f7ba20823a85ab14307/src%2Fbootstrap%2Fsanity.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fsanity.rs?ref=e13f02eb2e188a3d8c2a5f7ba20823a85ab14307", "patch": "@@ -93,10 +93,27 @@ pub fn check(build: &mut Build) {\n     }\n \n     // Ninja is currently only used for LLVM itself.\n-    // Some Linux distros rename `ninja` to `ninja-build`.\n-    // CMake can work with either binary name.\n-    if building_llvm && build.config.ninja && cmd_finder.maybe_have(\"ninja-build\").is_none() {\n-        cmd_finder.must_have(\"ninja\");\n+    if building_llvm {\n+        if build.config.ninja {\n+            // Some Linux distros rename `ninja` to `ninja-build`.\n+            // CMake can work with either binary name.\n+            if cmd_finder.maybe_have(\"ninja-build\").is_none() {\n+                cmd_finder.must_have(\"ninja\");\n+            }\n+        }\n+\n+        // If ninja isn't enabled but we're building for MSVC then we try\n+        // doubly hard to enable it. It was realized in #43767 that the msbuild\n+        // CMake generator for MSVC doesn't respect configuration options like\n+        // disabling LLVM assertions, which can often be quite important!\n+        //\n+        // In these cases we automatically enable Ninja if we find it in the\n+        // environment.\n+        if !build.config.ninja && build.config.build.contains(\"msvc\") {\n+            if cmd_finder.maybe_have(\"ninja\").is_some() {\n+                build.config.ninja = true;\n+            }\n+        }\n     }\n \n     build.config.python = build.config.python.take().map(|p| cmd_finder.must_have(p))"}]}