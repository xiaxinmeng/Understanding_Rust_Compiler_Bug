{"sha": "8eb96b85171bd5cb5b36c87f43f460f324ba078f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjhlYjk2Yjg1MTcxYmQ1Y2I1YjM2Yzg3ZjQzZjQ2MGYzMjRiYTA3OGY=", "commit": {"author": {"name": "Muhammad Mominul Huque", "email": "mominul2082@gmail.com", "date": "2021-04-23T13:55:52Z"}, "committer": {"name": "Muhammad Mominul Huque", "email": "mominul2082@gmail.com", "date": "2021-04-23T13:55:52Z"}, "message": "Handle native target-cpu variant\nand raise fatal error if the specified target cpu is not supported", "tree": {"sha": "e2ec8732c3d664116ed4915e1ed2177432745342", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e2ec8732c3d664116ed4915e1ed2177432745342"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8eb96b85171bd5cb5b36c87f43f460f324ba078f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8eb96b85171bd5cb5b36c87f43f460f324ba078f", "html_url": "https://github.com/rust-lang/rust/commit/8eb96b85171bd5cb5b36c87f43f460f324ba078f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8eb96b85171bd5cb5b36c87f43f460f324ba078f/comments", "author": {"login": "mominul", "id": 9459891, "node_id": "MDQ6VXNlcjk0NTk4OTE=", "avatar_url": "https://avatars.githubusercontent.com/u/9459891?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mominul", "html_url": "https://github.com/mominul", "followers_url": "https://api.github.com/users/mominul/followers", "following_url": "https://api.github.com/users/mominul/following{/other_user}", "gists_url": "https://api.github.com/users/mominul/gists{/gist_id}", "starred_url": "https://api.github.com/users/mominul/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mominul/subscriptions", "organizations_url": "https://api.github.com/users/mominul/orgs", "repos_url": "https://api.github.com/users/mominul/repos", "events_url": "https://api.github.com/users/mominul/events{/privacy}", "received_events_url": "https://api.github.com/users/mominul/received_events", "type": "User", "site_admin": false}, "committer": {"login": "mominul", "id": 9459891, "node_id": "MDQ6VXNlcjk0NTk4OTE=", "avatar_url": "https://avatars.githubusercontent.com/u/9459891?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mominul", "html_url": "https://github.com/mominul", "followers_url": "https://api.github.com/users/mominul/followers", "following_url": "https://api.github.com/users/mominul/following{/other_user}", "gists_url": "https://api.github.com/users/mominul/gists{/gist_id}", "starred_url": "https://api.github.com/users/mominul/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mominul/subscriptions", "organizations_url": "https://api.github.com/users/mominul/orgs", "repos_url": "https://api.github.com/users/mominul/repos", "events_url": "https://api.github.com/users/mominul/events{/privacy}", "received_events_url": "https://api.github.com/users/mominul/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e16ccba3945e06a9e687dd13de9053d981cc4fad", "url": "https://api.github.com/repos/rust-lang/rust/commits/e16ccba3945e06a9e687dd13de9053d981cc4fad", "html_url": "https://github.com/rust-lang/rust/commit/e16ccba3945e06a9e687dd13de9053d981cc4fad"}], "stats": {"total": 32, "additions": 24, "deletions": 8}, "files": [{"sha": "e6792def56796c2cc1ba0e328c73bb251a3404be", "filename": "Cargo.lock", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/8eb96b85171bd5cb5b36c87f43f460f324ba078f/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/8eb96b85171bd5cb5b36c87f43f460f324ba078f/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=8eb96b85171bd5cb5b36c87f43f460f324ba078f", "patch": "@@ -306,6 +306,7 @@ dependencies = [\n  \"cranelift-frontend\",\n  \"cranelift-jit\",\n  \"cranelift-module\",\n+ \"cranelift-native\",\n  \"cranelift-object\",\n  \"gimli\",\n  \"indexmap\","}, {"sha": "2789207c65581ab380463f0ff114ddeb7a601159", "filename": "Cargo.toml", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/8eb96b85171bd5cb5b36c87f43f460f324ba078f/Cargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/8eb96b85171bd5cb5b36c87f43f460f324ba078f/Cargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.toml?ref=8eb96b85171bd5cb5b36c87f43f460f324ba078f", "patch": "@@ -12,6 +12,7 @@ crate-type = [\"dylib\"]\n cranelift-codegen = { git = \"https://github.com/bytecodealliance/wasmtime/\", branch = \"main\", features = [\"unwind\"] }\n cranelift-frontend = { git = \"https://github.com/bytecodealliance/wasmtime/\", branch = \"main\" }\n cranelift-module = { git = \"https://github.com/bytecodealliance/wasmtime/\", branch = \"main\" }\n+cranelift-native = { git = \"https://github.com/bytecodealliance/wasmtime/\", branch = \"main\" }\n cranelift-jit = { git = \"https://github.com/bytecodealliance/wasmtime/\", branch = \"main\", optional = true }\n cranelift-object = { git = \"https://github.com/bytecodealliance/wasmtime/\", branch = \"main\" }\n target-lexicon = \"0.12.0\"\n@@ -28,6 +29,7 @@ smallvec = \"1.6.1\"\n #cranelift-codegen = { path = \"../wasmtime/cranelift/codegen\" }\n #cranelift-frontend = { path = \"../wasmtime/cranelift/frontend\" }\n #cranelift-module = { path = \"../wasmtime/cranelift/module\" }\n+#cranelift-native = { path = ../wasmtime/cranelift/native\" }\n #cranelift-jit = { path = \"../wasmtime/cranelift/jit\" }\n #cranelift-object = { path = \"../wasmtime/cranelift/object\" }\n "}, {"sha": "b7a6e692e34119cb4e59748b8286134915b5003d", "filename": "src/lib.rs", "status": "modified", "additions": 21, "deletions": 8, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/8eb96b85171bd5cb5b36c87f43f460f324ba078f/src%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8eb96b85171bd5cb5b36c87f43f460f324ba078f/src%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flib.rs?ref=8eb96b85171bd5cb5b36c87f43f460f324ba078f", "patch": "@@ -272,15 +272,28 @@ fn build_isa(sess: &Session, backend_config: &BackendConfig) -> Box<dyn isa::Tar\n     let flags = settings::Flags::new(flags_builder);\n \n     let variant = cranelift_codegen::isa::BackendVariant::MachInst;\n-    let mut isa_builder = cranelift_codegen::isa::lookup_variant(target_triple, variant).unwrap();\n+\n+    let isa_builder = match sess.opts.cg.target_cpu.as_deref() {\n+        Some(\"native\") => {\n+            let builder = cranelift_native::builder_with_options(variant, true).unwrap();\n+            builder\n+        }\n+        Some(value) => {\n+            let mut builder = cranelift_codegen::isa::lookup_variant(target_triple, variant).unwrap();\n+            if let Err(_) = builder.enable(value) {\n+                sess.fatal(\"The target cpu isn't currently supported by Cranelift.\");\n+            }\n+            builder\n+        }\n+        None => {\n+            let mut builder = cranelift_codegen::isa::lookup_variant(target_triple, variant).unwrap();\n+            // Don't use \"haswell\" as the default, as it implies `has_lzcnt`.\n+            // macOS CI is still at Ivy Bridge EP, so `lzcnt` is interpreted as `bsr`.\n+            builder.enable(\"nehalem\").unwrap();\n+            builder\n+        }\n+    };\n     \n-    if let Some(target_cpu) = sess.opts.cg.target_cpu.as_ref() {\n-        isa_builder.enable(target_cpu).unwrap();\n-    } else {\n-        // Don't use \"haswell\" as the default, as it implies `has_lzcnt`.\n-        // macOS CI is still at Ivy Bridge EP, so `lzcnt` is interpreted as `bsr`.\n-        isa_builder.enable(\"nehalem\").unwrap();\n-    }\n     isa_builder.finish(flags)\n }\n "}]}