{"sha": "d334059696e57b882903d9d852d3e64ae887f5ec", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQzMzQwNTk2OTZlNTdiODgyOTAzZDlkODUyZDNlNjRhZTg4N2Y1ZWM=", "commit": {"author": {"name": "Yuki Okushi", "email": "huyuumi.dev@gmail.com", "date": "2020-10-16T20:36:52Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-10-16T20:36:52Z"}, "message": "Rollup merge of #77992 - nagisa:thaw-coverage-instrumentation, r=wesleywiser\n\ninstrument-coverage: try our best to not ICE\n\ninstrument-coverage was ICEing for me on some code, in particular code\nthat had devirtualized paths from standard library. Instrument coverage\nprobably has no bussiness dictating which paths are valid and which\naren't so just feed it everything and whatever and let tooling deal with\nother stuff.\n\nFor example, with this commit we can generate coverage hitpoints for\nthese interesting paths:\n\n* `/rustc/.../library/core/lib.rs` \u2013 non-devirtualized path for libcore\n* `/home/.../src/library/core/lib.rs` \u2013 devirtualized version of above\n* `<inline asm>`, `<anon>` and many similar synthetic paths\n\nEven if those paths somehow get to the instrumentation pass, I'd much\nrather get hits for these weird paths and hope some of them work (as\nwould be the case for devirtualized path to libcore), rather than have\ncompilation fail entirely.", "tree": {"sha": "5eda673ae3cb0ec8a9b0319d3a48b52cd699ec19", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5eda673ae3cb0ec8a9b0319d3a48b52cd699ec19"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d334059696e57b882903d9d852d3e64ae887f5ec", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfigRkCRBK7hj4Ov3rIwAAdHIIABHFDRZh3QGuAdcdipz2s2JS\nC3INVvcisLLSvlVz+VGnezU76AWNaq3U+PfuEsBCQaeZnHTFiiK4+GWilqZqStou\n6Zr9DErWCj4MiKFmWMpkyoZUenU+EHUA7Yur7TOdjaNraUkaFTkYtJDR3Q/N+xJO\nGGohMjv+4LyxGVFNSJkB0WqjC9roZ2HcAGv7N9SrrRCMLv7VC29fAe/huzAEp69V\njyl41CXUlFL0LDlYzdbVf+9ABjzV1gbpBbJj70WyEO+BURBmnz04bFvRy/UmoDu4\nPGcfYwFS/oJxedD+h3bBbxOAi/cLTamdd/Le/ndxgFufgOLsJIvDrs4oZbjCTe0=\n=4fpY\n-----END PGP SIGNATURE-----\n", "payload": "tree 5eda673ae3cb0ec8a9b0319d3a48b52cd699ec19\nparent b4282b37f167dfec0e383fa1c9dc05b073621aae\nparent 8436cfe71db9a3f0c6b6d8f44fd18b4d6612627a\nauthor Yuki Okushi <huyuumi.dev@gmail.com> 1602880612 +0900\ncommitter GitHub <noreply@github.com> 1602880612 +0900\n\nRollup merge of #77992 - nagisa:thaw-coverage-instrumentation, r=wesleywiser\n\ninstrument-coverage: try our best to not ICE\n\ninstrument-coverage was ICEing for me on some code, in particular code\nthat had devirtualized paths from standard library. Instrument coverage\nprobably has no bussiness dictating which paths are valid and which\naren't so just feed it everything and whatever and let tooling deal with\nother stuff.\n\nFor example, with this commit we can generate coverage hitpoints for\nthese interesting paths:\n\n* `/rustc/.../library/core/lib.rs` \u2013 non-devirtualized path for libcore\n* `/home/.../src/library/core/lib.rs` \u2013 devirtualized version of above\n* `<inline asm>`, `<anon>` and many similar synthetic paths\n\nEven if those paths somehow get to the instrumentation pass, I'd much\nrather get hits for these weird paths and hope some of them work (as\nwould be the case for devirtualized path to libcore), rather than have\ncompilation fail entirely.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d334059696e57b882903d9d852d3e64ae887f5ec", "html_url": "https://github.com/rust-lang/rust/commit/d334059696e57b882903d9d852d3e64ae887f5ec", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d334059696e57b882903d9d852d3e64ae887f5ec/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b4282b37f167dfec0e383fa1c9dc05b073621aae", "url": "https://api.github.com/repos/rust-lang/rust/commits/b4282b37f167dfec0e383fa1c9dc05b073621aae", "html_url": "https://github.com/rust-lang/rust/commit/b4282b37f167dfec0e383fa1c9dc05b073621aae"}, {"sha": "8436cfe71db9a3f0c6b6d8f44fd18b4d6612627a", "url": "https://api.github.com/repos/rust-lang/rust/commits/8436cfe71db9a3f0c6b6d8f44fd18b4d6612627a", "html_url": "https://github.com/rust-lang/rust/commit/8436cfe71db9a3f0c6b6d8f44fd18b4d6612627a"}], "stats": {"total": 12, "additions": 2, "deletions": 10}, "files": [{"sha": "6824c73ab60a05f69ffa00f1813b6c709469890c", "filename": "compiler/rustc_mir/src/transform/instrument_coverage.rs", "status": "modified", "additions": 2, "deletions": 10, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/d334059696e57b882903d9d852d3e64ae887f5ec/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Finstrument_coverage.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d334059696e57b882903d9d852d3e64ae887f5ec/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Finstrument_coverage.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Finstrument_coverage.rs?ref=d334059696e57b882903d9d852d3e64ae887f5ec", "patch": "@@ -22,9 +22,7 @@ use rustc_middle::ty::query::Providers;\n use rustc_middle::ty::TyCtxt;\n use rustc_span::def_id::DefId;\n use rustc_span::source_map::original_sp;\n-use rustc_span::{\n-    BytePos, CharPos, FileName, Pos, RealFileName, SourceFile, Span, Symbol, SyntaxContext,\n-};\n+use rustc_span::{BytePos, CharPos, Pos, SourceFile, Span, Symbol, SyntaxContext};\n \n use std::cmp::Ordering;\n \n@@ -549,13 +547,7 @@ impl<'a, 'tcx> Instrumentor<'a, 'tcx> {\n         let mir_body = &self.mir_body;\n         let body_span = self.body_span();\n         let source_file = source_map.lookup_source_file(body_span.lo());\n-        let file_name = match &source_file.name {\n-            FileName::Real(RealFileName::Named(path)) => Symbol::intern(&path.to_string_lossy()),\n-            _ => bug!(\n-                \"source_file.name should be a RealFileName, but it was: {:?}\",\n-                source_file.name\n-            ),\n-        };\n+        let file_name = Symbol::intern(&source_file.name.to_string());\n \n         debug!(\"instrumenting {:?}, span: {}\", def_id, source_map.span_to_string(body_span));\n "}]}