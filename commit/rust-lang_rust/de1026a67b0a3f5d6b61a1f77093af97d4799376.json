{"sha": "de1026a67b0a3f5d6b61a1f77093af97d4799376", "node_id": "C_kwDOAAsO6NoAKGRlMTAyNmE2N2IwYTNmNWQ2YjYxYTFmNzcwOTNhZjk3ZDQ3OTkzNzY", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-04-23T19:32:05Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-04-23T19:32:05Z"}, "message": "Auto merge of #96326 - JakobDegen:relax-operand, r=oli-obk\n\nRelax restrictions for copy operands\n\nThis was [discussed on Zulip](https://rust-lang.zulipchat.com/#narrow/stream/189540-t-compiler.2Fwg-mir-opt/topic/Removing.20requirement.20that.20.60Copy.60.20operands.20have.20.60Copy.60.20types/near/279102313). Details about motivation and such can be found there\n\nr? `@oli-obk`", "tree": {"sha": "9fe55e14ae7f39ac62a32ec5663b1f1db1dd4bb2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9fe55e14ae7f39ac62a32ec5663b1f1db1dd4bb2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/de1026a67b0a3f5d6b61a1f77093af97d4799376", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/de1026a67b0a3f5d6b61a1f77093af97d4799376", "html_url": "https://github.com/rust-lang/rust/commit/de1026a67b0a3f5d6b61a1f77093af97d4799376", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/de1026a67b0a3f5d6b61a1f77093af97d4799376/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6b4563bf93f4b103ed22507ed825008b89e4f5d9", "url": "https://api.github.com/repos/rust-lang/rust/commits/6b4563bf93f4b103ed22507ed825008b89e4f5d9", "html_url": "https://github.com/rust-lang/rust/commit/6b4563bf93f4b103ed22507ed825008b89e4f5d9"}, {"sha": "ae7d6facdaf2aab55e53e6d4b44003940819a27f", "url": "https://api.github.com/repos/rust-lang/rust/commits/ae7d6facdaf2aab55e53e6d4b44003940819a27f", "html_url": "https://github.com/rust-lang/rust/commit/ae7d6facdaf2aab55e53e6d4b44003940819a27f"}], "stats": {"total": 11, "additions": 8, "deletions": 3}, "files": [{"sha": "f71bc586b4847e3d92b2ac6f7a35123ed0ba3ee3", "filename": "compiler/rustc_const_eval/src/transform/validate.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/de1026a67b0a3f5d6b61a1f77093af97d4799376/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fvalidate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/de1026a67b0a3f5d6b61a1f77093af97d4799376/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fvalidate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fvalidate.rs?ref=de1026a67b0a3f5d6b61a1f77093af97d4799376", "patch": "@@ -214,7 +214,8 @@ impl<'a, 'tcx> Visitor<'tcx> for TypeChecker<'a, 'tcx> {\n \n     fn visit_operand(&mut self, operand: &Operand<'tcx>, location: Location) {\n         // This check is somewhat expensive, so only run it when -Zvalidate-mir is passed.\n-        if self.tcx.sess.opts.debugging_opts.validate_mir {\n+        if self.tcx.sess.opts.debugging_opts.validate_mir && self.mir_phase < MirPhase::DropsLowered\n+        {\n             // `Operand::Copy` is only supposed to be used with `Copy` types.\n             if let Operand::Copy(place) = operand {\n                 let ty = place.ty(&self.body.local_decls, self.tcx).ty;"}, {"sha": "881f59ae464c93ababca1442fe0a67e7f2909d7b", "filename": "compiler/rustc_middle/src/mir/mod.rs", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/de1026a67b0a3f5d6b61a1f77093af97d4799376/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/de1026a67b0a3f5d6b61a1f77093af97d4799376/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmod.rs?ref=de1026a67b0a3f5d6b61a1f77093af97d4799376", "patch": "@@ -166,7 +166,8 @@ pub enum MirPhase {\n     /// * [`StatementKind::Retag`]\n     ///\n     /// Furthermore, `Drop` now uses explicit drop flags visible in the MIR and reaching a `Drop`\n-    /// terminator means that the auto-generated drop glue will be invoked.\n+    /// terminator means that the auto-generated drop glue will be invoked. Also, `Copy` operands\n+    /// are allowed for non-`Copy` types.\n     DropsLowered = 3,\n     /// Beginning with this phase, the following variant is disallowed:\n     /// * [`Rvalue::Aggregate`] for any `AggregateKind` except `Array`\n@@ -2330,7 +2331,10 @@ pub struct SourceScopeLocalData {\n /// validator.\n #[derive(Clone, PartialEq, TyEncodable, TyDecodable, Hash, HashStable)]\n pub enum Operand<'tcx> {\n-    /// Creates a value by loading the given place. The type of the place must be `Copy`\n+    /// Creates a value by loading the given place.\n+    ///\n+    /// Before drop elaboration, the type of the place must be `Copy`. After drop elaboration there\n+    /// is no such requirement.\n     Copy(Place<'tcx>),\n \n     /// Creates a value by performing loading the place, just like the `Copy` operand."}]}