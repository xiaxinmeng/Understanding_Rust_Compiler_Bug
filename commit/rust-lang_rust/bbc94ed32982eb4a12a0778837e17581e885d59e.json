{"sha": "bbc94ed32982eb4a12a0778837e17581e885d59e", "node_id": "MDY6Q29tbWl0NzI0NzEyOmJiYzk0ZWQzMjk4MmViNGExMmEwNzc4ODM3ZTE3NTgxZTg4NWQ1OWU=", "commit": {"author": {"name": "Mara Bos", "email": "m-ou.se@m-ou.se", "date": "2021-09-01T07:23:28Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-09-01T07:23:28Z"}, "message": "Rollup merge of #88525 - notriddle:notriddle/coherence-dyn-auto-trait, r=petrochenkov\n\nfix(rustc_typeck): produce better errors for dyn auto trait\n\nFixes #85026", "tree": {"sha": "29a182b19b20ce3f0d544eabda13e6af00c9083d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/29a182b19b20ce3f0d544eabda13e6af00c9083d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bbc94ed32982eb4a12a0778837e17581e885d59e", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhLypwCRBK7hj4Ov3rIwAArKoIAGf/38a98yVthYZLTGaku7V7\n+kdejoxWGPE2t0AbGj1CO+sOv3UuTc4PLiiLJb/5pgoBvhsmkFStKILmD0jfuS94\nQmPqL0LI1yVe3Jsgjf/uj+mBQbDaTx2sCuIx6JU8SmhAJcSgxEBbP9wfUxMQCbQF\nop2KNuPhd+LIZhjPSYbxzp9mXl08CY6ho7iPVzNL6HzGp9pAzFq3ekegHZUAY3+S\nwk2WRlW+KevcJWgsqm8J57mRuPI+d8HuAKKHahZIzHd5Q/0zALVhAHh3T0jBwHNg\nA0dldO+hcuRvOH2faAhO3LgFvTqtD/oCpEEpyE3j/Gd1WRWPa50U9dwH5c3A0so=\n=t/9n\n-----END PGP SIGNATURE-----\n", "payload": "tree 29a182b19b20ce3f0d544eabda13e6af00c9083d\nparent 75b2ae5ec50a3fb3cadd297b7d524935afa9faad\nparent 6e70678f7d93ad777297c865e35e005520a4eefb\nauthor Mara Bos <m-ou.se@m-ou.se> 1630481008 +0200\ncommitter GitHub <noreply@github.com> 1630481008 +0200\n\nRollup merge of #88525 - notriddle:notriddle/coherence-dyn-auto-trait, r=petrochenkov\n\nfix(rustc_typeck): produce better errors for dyn auto trait\n\nFixes #85026\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bbc94ed32982eb4a12a0778837e17581e885d59e", "html_url": "https://github.com/rust-lang/rust/commit/bbc94ed32982eb4a12a0778837e17581e885d59e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bbc94ed32982eb4a12a0778837e17581e885d59e/comments", "author": {"login": "m-ou-se", "id": 783247, "node_id": "MDQ6VXNlcjc4MzI0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/783247?v=4", "gravatar_id": "", "url": "https://api.github.com/users/m-ou-se", "html_url": "https://github.com/m-ou-se", "followers_url": "https://api.github.com/users/m-ou-se/followers", "following_url": "https://api.github.com/users/m-ou-se/following{/other_user}", "gists_url": "https://api.github.com/users/m-ou-se/gists{/gist_id}", "starred_url": "https://api.github.com/users/m-ou-se/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/m-ou-se/subscriptions", "organizations_url": "https://api.github.com/users/m-ou-se/orgs", "repos_url": "https://api.github.com/users/m-ou-se/repos", "events_url": "https://api.github.com/users/m-ou-se/events{/privacy}", "received_events_url": "https://api.github.com/users/m-ou-se/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "75b2ae5ec50a3fb3cadd297b7d524935afa9faad", "url": "https://api.github.com/repos/rust-lang/rust/commits/75b2ae5ec50a3fb3cadd297b7d524935afa9faad", "html_url": "https://github.com/rust-lang/rust/commit/75b2ae5ec50a3fb3cadd297b7d524935afa9faad"}, {"sha": "6e70678f7d93ad777297c865e35e005520a4eefb", "url": "https://api.github.com/repos/rust-lang/rust/commits/6e70678f7d93ad777297c865e35e005520a4eefb", "html_url": "https://github.com/rust-lang/rust/commit/6e70678f7d93ad777297c865e35e005520a4eefb"}], "stats": {"total": 71, "additions": 71, "deletions": 0}, "files": [{"sha": "45d91c2047d4193857e2d6569b0593d6becd8c03", "filename": "compiler/rustc_error_codes/src/error_codes.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/bbc94ed32982eb4a12a0778837e17581e885d59e/compiler%2Frustc_error_codes%2Fsrc%2Ferror_codes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bbc94ed32982eb4a12a0778837e17581e885d59e/compiler%2Frustc_error_codes%2Fsrc%2Ferror_codes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_error_codes%2Fsrc%2Ferror_codes.rs?ref=bbc94ed32982eb4a12a0778837e17581e885d59e", "patch": "@@ -480,6 +480,7 @@ E0781: include_str!(\"./error_codes/E0781.md\"),\n E0782: include_str!(\"./error_codes/E0782.md\"),\n E0783: include_str!(\"./error_codes/E0783.md\"),\n E0784: include_str!(\"./error_codes/E0784.md\"),\n+E0785: include_str!(\"./error_codes/E0785.md\"),\n ;\n //  E0006, // merged with E0005\n //  E0008, // cannot bind by-move into a pattern guard"}, {"sha": "373320539ef646611ee80d7bd457c9bab5e113a0", "filename": "compiler/rustc_error_codes/src/error_codes/E0785.md", "status": "added", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/bbc94ed32982eb4a12a0778837e17581e885d59e/compiler%2Frustc_error_codes%2Fsrc%2Ferror_codes%2FE0785.md", "raw_url": "https://github.com/rust-lang/rust/raw/bbc94ed32982eb4a12a0778837e17581e885d59e/compiler%2Frustc_error_codes%2Fsrc%2Ferror_codes%2FE0785.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_error_codes%2Fsrc%2Ferror_codes%2FE0785.md?ref=bbc94ed32982eb4a12a0778837e17581e885d59e", "patch": "@@ -0,0 +1,30 @@\n+An inherent `impl` was written on a dyn auto trait.\n+\n+Erroneous code example:\n+\n+```compile_fail,E0785\n+#![feature(auto_traits)]\n+\n+auto trait AutoTrait {}\n+\n+impl dyn AutoTrait {}\n+```\n+\n+Dyn objects allow any number of auto traits, plus at most one non-auto trait.\n+The non-auto trait becomes the \"principal trait\".\n+\n+When checking if an impl on a dyn trait is coherent, the principal trait is\n+normally the only one considered. Since the erroneous code has no principal\n+trait, it cannot be implemented at all.\n+\n+Working example:\n+\n+```\n+#![feature(auto_traits)]\n+\n+trait PrincipalTrait {}\n+\n+auto trait AutoTrait {}\n+\n+impl dyn PrincipalTrait + AutoTrait + Send {}\n+```"}, {"sha": "c7be9e2123512cae236c673adf01cec411436b32", "filename": "compiler/rustc_typeck/src/coherence/inherent_impls.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/bbc94ed32982eb4a12a0778837e17581e885d59e/compiler%2Frustc_typeck%2Fsrc%2Fcoherence%2Finherent_impls.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bbc94ed32982eb4a12a0778837e17581e885d59e/compiler%2Frustc_typeck%2Fsrc%2Fcoherence%2Finherent_impls.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcoherence%2Finherent_impls.rs?ref=bbc94ed32982eb4a12a0778837e17581e885d59e", "patch": "@@ -60,6 +60,17 @@ impl ItemLikeVisitor<'v> for InherentCollect<'tcx> {\n             ty::Dynamic(ref data, ..) if data.principal_def_id().is_some() => {\n                 self.check_def_id(item, data.principal_def_id().unwrap());\n             }\n+            ty::Dynamic(..) => {\n+                struct_span_err!(\n+                    self.tcx.sess,\n+                    ty.span,\n+                    E0785,\n+                    \"cannot define inherent `impl` for a dyn auto trait\"\n+                )\n+                .span_label(ty.span, \"impl requires at least one non-auto trait\")\n+                .note(\"define and implement a new trait or type instead\")\n+                .emit();\n+            }\n             ty::Bool => {\n                 self.check_primitive_impl(\n                     item.def_id,"}, {"sha": "8b116545aa696e27dd35275c11148d27214d85e2", "filename": "src/test/ui/coherence/issue-85026.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/bbc94ed32982eb4a12a0778837e17581e885d59e/src%2Ftest%2Fui%2Fcoherence%2Fissue-85026.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bbc94ed32982eb4a12a0778837e17581e885d59e/src%2Ftest%2Fui%2Fcoherence%2Fissue-85026.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcoherence%2Fissue-85026.rs?ref=bbc94ed32982eb4a12a0778837e17581e885d59e", "patch": "@@ -0,0 +1,10 @@\n+#![feature(auto_traits)]\n+auto trait AutoTrait {}\n+\n+// You cannot impl your own `dyn AutoTrait`.\n+impl dyn AutoTrait {} //~ERROR E0785\n+\n+// You cannot impl someone else's `dyn AutoTrait`\n+impl dyn Unpin {} //~ERROR E0785\n+\n+fn main() {}"}, {"sha": "a5da19bbfaa4764b721baacda810cf3cf146bc27", "filename": "src/test/ui/coherence/issue-85026.stderr", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/bbc94ed32982eb4a12a0778837e17581e885d59e/src%2Ftest%2Fui%2Fcoherence%2Fissue-85026.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/bbc94ed32982eb4a12a0778837e17581e885d59e/src%2Ftest%2Fui%2Fcoherence%2Fissue-85026.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fcoherence%2Fissue-85026.stderr?ref=bbc94ed32982eb4a12a0778837e17581e885d59e", "patch": "@@ -0,0 +1,19 @@\n+error[E0785]: cannot define inherent `impl` for a dyn auto trait\n+  --> $DIR/issue-85026.rs:5:6\n+   |\n+LL | impl dyn AutoTrait {}\n+   |      ^^^^^^^^^^^^^ impl requires at least one non-auto trait\n+   |\n+   = note: define and implement a new trait or type instead\n+\n+error[E0785]: cannot define inherent `impl` for a dyn auto trait\n+  --> $DIR/issue-85026.rs:8:6\n+   |\n+LL | impl dyn Unpin {}\n+   |      ^^^^^^^^^ impl requires at least one non-auto trait\n+   |\n+   = note: define and implement a new trait or type instead\n+\n+error: aborting due to 2 previous errors\n+\n+For more information about this error, try `rustc --explain E0785`."}]}