{"sha": "4ed0c6a464e89116d862773320aeab50464acd5f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRlZDBjNmE0NjRlODkxMTZkODYyNzczMzIwYWVhYjUwNDY0YWNkNWY=", "commit": {"author": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2020-08-10T12:05:43Z"}, "committer": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2020-08-10T12:08:15Z"}, "message": "Use existing `infcx` when emitting trait impl diagnostic\n\nFixes #75361\nFixes #74918\n\nPreviously, we were creating a new `InferCtxt`, which caused an ICE when\nused with type variables from the existing `InferCtxt`", "tree": {"sha": "a9338e9bfaf1543c0f9bebd3acb1b1c6f0ba90b0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a9338e9bfaf1543c0f9bebd3acb1b1c6f0ba90b0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4ed0c6a464e89116d862773320aeab50464acd5f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE7J9Gc3TfBwj2K399tAh+UQ6YsWQFAl8xOLAACgkQtAh+UQ6Y\nsWSiLg/+Oxd+5SIuXTIEcT0pm3AdcGcd/CbVRwPDZRcGqPcre22rptRLwDuDcK9J\nnVqU5popWVI3HeHobAw0DI/KHTuICCRsgTBXQ+u3ofkw12OgFbIW2KtDJUU1kw4K\nPOzLw5WiHtvJN62lu6VQ1sQb1/DEMWrxy43o4cEoeXiVPMDdb8fjyWKPhS4nxOi2\ndgM2/NgcbRN3NFLxKyr9U70m0CxsXIWPd7kzjYUzRqxLkLOGw4jp7tzmBIBj8GJ4\nOGfKs65coCzUHpf4Mlix58d38Fzf1miCMczS0DWLL60Y238Jl7aQyGtmxZqiOYrS\nry0MZhKo9kDojFgIt8Ynbs5CFlg5mR64+xXbQuLfbxbRnCdLCUQGMMWCdAJc/8yN\nviwDgCZe5NWSDWqTwvTvNmemtu+LER1lKShsHMyAByWp57+PXcP5kfP22PuBgwsX\n4s7fsbYp6z74PfYrCNrMdbd20rWyoCdoj+UW5tSy1Zr+MUPdqbtV0Z6iycL0xg04\nRTuCAm0PvNKObo5tBnPPn4RbkuB8MxTY0kmW5hHBXUmci0xjdIepopMnxSiNap4n\nfMtR6DWTCBjJb32MHulCtUmXXkZOz30ra/GVtcx1+oKz6KlBxulrkn9z7Fu1S2Ad\nJYWPSVyH4ZHvJEiCAvA+o7sCdOoq9gsP2/9ESO+naHDwXYg7hFk=\n=+NzL\n-----END PGP SIGNATURE-----", "payload": "tree a9338e9bfaf1543c0f9bebd3acb1b1c6f0ba90b0\nparent 13290e83a6e20f3b408d177a9d64d8cf98fe4615\nauthor Aaron Hill <aa1ronham@gmail.com> 1597061143 -0400\ncommitter Aaron Hill <aa1ronham@gmail.com> 1597061295 -0400\n\nUse existing `infcx` when emitting trait impl diagnostic\n\nFixes #75361\nFixes #74918\n\nPreviously, we were creating a new `InferCtxt`, which caused an ICE when\nused with type variables from the existing `InferCtxt`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4ed0c6a464e89116d862773320aeab50464acd5f", "html_url": "https://github.com/rust-lang/rust/commit/4ed0c6a464e89116d862773320aeab50464acd5f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4ed0c6a464e89116d862773320aeab50464acd5f/comments", "author": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "13290e83a6e20f3b408d177a9d64d8cf98fe4615", "url": "https://api.github.com/repos/rust-lang/rust/commits/13290e83a6e20f3b408d177a9d64d8cf98fe4615", "html_url": "https://github.com/rust-lang/rust/commit/13290e83a6e20f3b408d177a9d64d8cf98fe4615"}], "stats": {"total": 109, "additions": 104, "deletions": 5}, "files": [{"sha": "1ddf88c030660e318958322fbc9cb9bac06d93e3", "filename": "src/librustc_infer/infer/error_reporting/nice_region_error/trait_impl_difference.rs", "status": "modified", "additions": 3, "deletions": 5, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/4ed0c6a464e89116d862773320aeab50464acd5f/src%2Flibrustc_infer%2Finfer%2Ferror_reporting%2Fnice_region_error%2Ftrait_impl_difference.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4ed0c6a464e89116d862773320aeab50464acd5f/src%2Flibrustc_infer%2Finfer%2Ferror_reporting%2Fnice_region_error%2Ftrait_impl_difference.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_infer%2Finfer%2Ferror_reporting%2Fnice_region_error%2Ftrait_impl_difference.rs?ref=4ed0c6a464e89116d862773320aeab50464acd5f", "patch": "@@ -2,7 +2,7 @@\n \n use crate::infer::error_reporting::nice_region_error::NiceRegionError;\n use crate::infer::lexical_region_resolve::RegionResolutionError;\n-use crate::infer::{Subtype, TyCtxtInferExt, ValuePairs};\n+use crate::infer::{Subtype, ValuePairs};\n use crate::traits::ObligationCauseCode::CompareImplMethodObligation;\n use rustc_errors::ErrorReported;\n use rustc_hir as hir;\n@@ -53,7 +53,6 @@ impl<'a, 'tcx> NiceRegionError<'a, 'tcx> {\n     }\n \n     fn emit_err(&self, sp: Span, expected: Ty<'tcx>, found: Ty<'tcx>, trait_def_id: DefId) {\n-        let tcx = self.tcx();\n         let trait_sp = self.tcx().def_span(trait_def_id);\n         let mut err = self\n             .tcx()\n@@ -85,9 +84,8 @@ impl<'a, 'tcx> NiceRegionError<'a, 'tcx> {\n             );\n         }\n \n-        if let Some((expected, found)) = tcx\n-            .infer_ctxt()\n-            .enter(|infcx| infcx.expected_found_str_ty(&ExpectedFound { expected, found }))\n+        if let Some((expected, found)) =\n+            self.infcx.expected_found_str_ty(&ExpectedFound { expected, found })\n         {\n             // Highlighted the differences when showing the \"expected/found\" note.\n             err.note_expected_found(&\"\", expected, &\"\", found);"}, {"sha": "0e3ea4bc8c9de0f4e008cc413f9e1cdd465c3bb2", "filename": "src/test/ui/mismatched_types/issue-74918-missing-lifetime.rs", "status": "added", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/4ed0c6a464e89116d862773320aeab50464acd5f/src%2Ftest%2Fui%2Fmismatched_types%2Fissue-74918-missing-lifetime.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4ed0c6a464e89116d862773320aeab50464acd5f/src%2Ftest%2Fui%2Fmismatched_types%2Fissue-74918-missing-lifetime.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmismatched_types%2Fissue-74918-missing-lifetime.rs?ref=4ed0c6a464e89116d862773320aeab50464acd5f", "patch": "@@ -0,0 +1,28 @@\n+// Regression test for issue #74918\n+// Tests that we don't ICE after emitting an error\n+\n+struct ChunkingIterator<T, S: 'static + Iterator<Item = T>> {\n+    source: S,\n+}\n+\n+impl<T, S: Iterator<Item = T>> Iterator for ChunkingIterator<T, S> {\n+    type Item = IteratorChunk<T, S>; //~ ERROR missing lifetime\n+\n+    fn next(&mut self) -> Option<IteratorChunk<T, S>> { //~ ERROR `impl`\n+        todo!()\n+    }\n+}\n+\n+struct IteratorChunk<'a, T, S: Iterator<Item = T>> {\n+    source: &'a mut S,\n+}\n+\n+impl<T, S: Iterator<Item = T>> Iterator for IteratorChunk<'_, T, S> {\n+    type Item = T;\n+\n+    fn next(&mut self) -> Option<T> {\n+        todo!()\n+    }\n+}\n+\n+fn main() {}"}, {"sha": "da3056eac90093201a1c97c6377012a2b343854e", "filename": "src/test/ui/mismatched_types/issue-74918-missing-lifetime.stderr", "status": "added", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/4ed0c6a464e89116d862773320aeab50464acd5f/src%2Ftest%2Fui%2Fmismatched_types%2Fissue-74918-missing-lifetime.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/4ed0c6a464e89116d862773320aeab50464acd5f/src%2Ftest%2Fui%2Fmismatched_types%2Fissue-74918-missing-lifetime.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmismatched_types%2Fissue-74918-missing-lifetime.stderr?ref=4ed0c6a464e89116d862773320aeab50464acd5f", "patch": "@@ -0,0 +1,30 @@\n+error[E0106]: missing lifetime specifier\n+  --> $DIR/issue-74918-missing-lifetime.rs:9:31\n+   |\n+LL |     type Item = IteratorChunk<T, S>;\n+   |                               ^ expected named lifetime parameter\n+   |\n+help: consider introducing a named lifetime parameter\n+   |\n+LL |     type Item<'a> = IteratorChunk<<'a>T, S>;\n+   |              ^^^^                 ^^^^\n+\n+error: `impl` item signature doesn't match `trait` item signature\n+  --> $DIR/issue-74918-missing-lifetime.rs:11:5\n+   |\n+LL |     fn next(&mut self) -> Option<IteratorChunk<T, S>> {\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ found `fn(&mut ChunkingIterator<T, S>) -> std::option::Option<IteratorChunk<'_, T, S>>`\n+   | \n+  ::: $SRC_DIR/core/src/iter/traits/iterator.rs:LL:COL\n+   |\n+LL |     fn next(&mut self) -> Option<Self::Item>;\n+   |     ----------------------------------------- expected `fn(&mut ChunkingIterator<T, S>) -> std::option::Option<IteratorChunk<'static, _, _>>`\n+   |\n+   = note: expected `fn(&mut ChunkingIterator<T, S>) -> std::option::Option<IteratorChunk<'static, _, _>>`\n+              found `fn(&mut ChunkingIterator<T, S>) -> std::option::Option<IteratorChunk<'_, _, _>>`\n+   = help: the lifetime requirements from the `impl` do not correspond to the requirements in the `trait`\n+   = help: verify the lifetime relationships in the `trait` and `impl` between the `self` argument, the other inputs and its output\n+\n+error: aborting due to 2 previous errors\n+\n+For more information about this error, try `rustc --explain E0106`."}, {"sha": "4410514476dc1c34921281e333dc2816c9abc260", "filename": "src/test/ui/mismatched_types/issue-75361-mismatched-impl.rs", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/4ed0c6a464e89116d862773320aeab50464acd5f/src%2Ftest%2Fui%2Fmismatched_types%2Fissue-75361-mismatched-impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4ed0c6a464e89116d862773320aeab50464acd5f/src%2Ftest%2Fui%2Fmismatched_types%2Fissue-75361-mismatched-impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmismatched_types%2Fissue-75361-mismatched-impl.rs?ref=4ed0c6a464e89116d862773320aeab50464acd5f", "patch": "@@ -0,0 +1,24 @@\n+// Regresison test for issue #75361\n+// Tests that we don't ICE on mismatched types with inference variables\n+\n+\n+trait MyTrait {\n+    type Item;\n+}\n+\n+pub trait Graph {\n+  type EdgeType;\n+\n+  fn adjacent_edges(&self) -> Box<dyn MyTrait<Item = &Self::EdgeType>>;\n+}\n+\n+impl<T> Graph for T {\n+  type EdgeType = T;\n+\n+  fn adjacent_edges(&self) -> Box<dyn MyTrait<Item = &Self::EdgeType> + '_> { //~ ERROR `impl`\n+      panic!()\n+  }\n+\n+}\n+\n+fn main() {}"}, {"sha": "5be7f5271dee87dd1af876174713a32b3dfcb187", "filename": "src/test/ui/mismatched_types/issue-75361-mismatched-impl.stderr", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/4ed0c6a464e89116d862773320aeab50464acd5f/src%2Ftest%2Fui%2Fmismatched_types%2Fissue-75361-mismatched-impl.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/4ed0c6a464e89116d862773320aeab50464acd5f/src%2Ftest%2Fui%2Fmismatched_types%2Fissue-75361-mismatched-impl.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmismatched_types%2Fissue-75361-mismatched-impl.stderr?ref=4ed0c6a464e89116d862773320aeab50464acd5f", "patch": "@@ -0,0 +1,19 @@\n+error: `impl` item signature doesn't match `trait` item signature\n+  --> $DIR/issue-75361-mismatched-impl.rs:18:3\n+   |\n+LL |   fn adjacent_edges(&self) -> Box<dyn MyTrait<Item = &Self::EdgeType>>;\n+   |   --------------------------------------------------------------------- expected `fn(&T) -> std::boxed::Box<(dyn MyTrait<Item = &_> + 'static)>`\n+...\n+LL |   fn adjacent_edges(&self) -> Box<dyn MyTrait<Item = &Self::EdgeType> + '_> {\n+   |   ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ found `fn(&T) -> std::boxed::Box<dyn MyTrait<Item = &_>>`\n+   |\n+   = note: expected `fn(&T) -> std::boxed::Box<(dyn MyTrait<Item = &T> + 'static)>`\n+              found `fn(&T) -> std::boxed::Box<dyn MyTrait<Item = &T>>`\n+help: the lifetime requirements from the `impl` do not correspond to the requirements in the `trait`\n+  --> $DIR/issue-75361-mismatched-impl.rs:12:55\n+   |\n+LL |   fn adjacent_edges(&self) -> Box<dyn MyTrait<Item = &Self::EdgeType>>;\n+   |                                                       ^^^^^^^^^^^^^^ consider borrowing this type parameter in the trait\n+\n+error: aborting due to previous error\n+"}]}