{"sha": "ea7ca705e655119f57c496560964ca4a6f47af79", "node_id": "C_kwDOAAsO6NoAKGVhN2NhNzA1ZTY1NTExOWY1N2M0OTY1NjA5NjRjYTRhNmY0N2FmNzk", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-02-20T21:12:20Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-02-20T21:12:20Z"}, "message": "Rollup merge of #108276 - lcnr:opaque-tys, r=oli-obk\n\nsmall `opaque_type_origin` cleanup\n\nr? `@oli-obk`", "tree": {"sha": "ac59345c57f7de78513ff27b0469acf0fbd7f3ca", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ac59345c57f7de78513ff27b0469acf0fbd7f3ca"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ea7ca705e655119f57c496560964ca4a6f47af79", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJj8+I0CRBK7hj4Ov3rIwAAyMAIAJlr4SJeiJf5t8qwC0cBG/mK\n4XTFXdMgNUQgYKpSo2eZsLdGCFyz22bA/0QQ2kNhsA770923gXzQ/D8WeOCkfNEn\n8b0Y+NQ1Z/zbDlsLmvcs1US2Q3Etg95oETHriIhAfI6t12Mff7u+l6xCchLC6565\nEtxBI3x1xFKFQQf/KDFOnXyAsMxNI2VDU0j/xVV17+O38MoIAfOxOPoDt1GXynRB\nzo5RkH1hEqYJCE9zb60JI3HVzqUXAq9en65Ny5uuVbIMeteu3lGIUvZPqjx4ZQux\nZrhJn1W4xDXZg4vkQUvu7l2MMlMZXWe6/fjg7H738sLb94jujRSp0KHC0mCtLRc=\n=mOmB\n-----END PGP SIGNATURE-----\n", "payload": "tree ac59345c57f7de78513ff27b0469acf0fbd7f3ca\nparent 02842d4f69e75ab32488800c4435b9ab5bfdb62e\nparent f97a8f017d5ccb6ec73e4450bce35f82e03b1b41\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1676927540 +0100\ncommitter GitHub <noreply@github.com> 1676927540 +0100\n\nRollup merge of #108276 - lcnr:opaque-tys, r=oli-obk\n\nsmall `opaque_type_origin` cleanup\n\nr? `@oli-obk`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ea7ca705e655119f57c496560964ca4a6f47af79", "html_url": "https://github.com/rust-lang/rust/commit/ea7ca705e655119f57c496560964ca4a6f47af79", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ea7ca705e655119f57c496560964ca4a6f47af79/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "02842d4f69e75ab32488800c4435b9ab5bfdb62e", "url": "https://api.github.com/repos/rust-lang/rust/commits/02842d4f69e75ab32488800c4435b9ab5bfdb62e", "html_url": "https://github.com/rust-lang/rust/commit/02842d4f69e75ab32488800c4435b9ab5bfdb62e"}, {"sha": "f97a8f017d5ccb6ec73e4450bce35f82e03b1b41", "url": "https://api.github.com/repos/rust-lang/rust/commits/f97a8f017d5ccb6ec73e4450bce35f82e03b1b41", "html_url": "https://github.com/rust-lang/rust/commit/f97a8f017d5ccb6ec73e4450bce35f82e03b1b41"}], "stats": {"total": 44, "additions": 18, "deletions": 26}, "files": [{"sha": "b2f3a3abb4c50ca76bfa6abbf1916a3e8fececd5", "filename": "compiler/rustc_hir_typeck/src/fn_ctxt/_impl.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/ea7ca705e655119f57c496560964ca4a6f47af79/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2F_impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ea7ca705e655119f57c496560964ca4a6f47af79/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2F_impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2F_impl.rs?ref=ea7ca705e655119f57c496560964ca4a6f47af79", "patch": "@@ -32,7 +32,7 @@ use rustc_session::lint;\n use rustc_span::def_id::LocalDefId;\n use rustc_span::hygiene::DesugaringKind;\n use rustc_span::symbol::{kw, sym, Ident};\n-use rustc_span::{Span, DUMMY_SP};\n+use rustc_span::Span;\n use rustc_trait_selection::traits::error_reporting::TypeErrCtxtExt as _;\n use rustc_trait_selection::traits::{self, NormalizeExt, ObligationCauseCode, ObligationCtxt};\n \n@@ -737,7 +737,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                 if let ty::subst::GenericArgKind::Type(ty) = ty.unpack()\n                     && let ty::Alias(ty::Opaque, ty::AliasTy { def_id, .. }) = *ty.kind()\n                     && let Some(def_id) = def_id.as_local()\n-                    && self.opaque_type_origin(def_id, DUMMY_SP).is_some() {\n+                    && self.opaque_type_origin(def_id).is_some() {\n                     return None;\n                 }\n             }"}, {"sha": "e783443502b865357a8007730bbf82ae8366c095", "filename": "compiler/rustc_infer/src/infer/opaque_types.rs", "status": "modified", "additions": 16, "deletions": 24, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/ea7ca705e655119f57c496560964ca4a6f47af79/compiler%2Frustc_infer%2Fsrc%2Finfer%2Fopaque_types.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ea7ca705e655119f57c496560964ca4a6f47af79/compiler%2Frustc_infer%2Fsrc%2Finfer%2Fopaque_types.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_infer%2Fsrc%2Finfer%2Fopaque_types.rs?ref=ea7ca705e655119f57c496560964ca4a6f47af79", "patch": "@@ -57,9 +57,7 @@ impl<'tcx> InferCtxt<'tcx> {\n         }\n         let mut obligations = vec![];\n         let replace_opaque_type = |def_id: DefId| {\n-            def_id\n-                .as_local()\n-                .map_or(false, |def_id| self.opaque_type_origin(def_id, span).is_some())\n+            def_id.as_local().map_or(false, |def_id| self.opaque_type_origin(def_id).is_some())\n         };\n         let value = value.fold_with(&mut BottomUpFolder {\n             tcx: self.tcx,\n@@ -144,9 +142,9 @@ impl<'tcx> InferCtxt<'tcx> {\n                         //     let x = || foo(); // returns the Opaque assoc with `foo`\n                         // }\n                         // ```\n-                        self.opaque_type_origin(def_id, cause.span)?\n+                        self.opaque_type_origin(def_id)?\n                     }\n-                    DefiningAnchor::Bubble => self.opaque_ty_origin_unchecked(def_id, cause.span),\n+                    DefiningAnchor::Bubble => self.opaque_type_origin_unchecked(def_id),\n                     DefiningAnchor::Error => return None,\n                 };\n                 if let ty::Alias(ty::Opaque, ty::AliasTy { def_id: b_def_id, .. }) = *b.kind() {\n@@ -155,9 +153,8 @@ impl<'tcx> InferCtxt<'tcx> {\n                     // no one encounters it in practice.\n                     // It does occur however in `fn fut() -> impl Future<Output = i32> { async { 42 } }`,\n                     // where it is of no concern, so we only check for TAITs.\n-                    if let Some(OpaqueTyOrigin::TyAlias) = b_def_id\n-                        .as_local()\n-                        .and_then(|b_def_id| self.opaque_type_origin(b_def_id, cause.span))\n+                    if let Some(OpaqueTyOrigin::TyAlias) =\n+                        b_def_id.as_local().and_then(|b_def_id| self.opaque_type_origin(b_def_id))\n                     {\n                         self.tcx.sess.emit_err(OpaqueHiddenTypeDiag {\n                             span: cause.span,\n@@ -371,24 +368,18 @@ impl<'tcx> InferCtxt<'tcx> {\n         });\n     }\n \n+    /// Returns the origin of the opaque type `def_id` if we're currently\n+    /// in its defining scope.\n     #[instrument(skip(self), level = \"trace\", ret)]\n-    pub fn opaque_type_origin(&self, def_id: LocalDefId, span: Span) -> Option<OpaqueTyOrigin> {\n+    pub fn opaque_type_origin(&self, def_id: LocalDefId) -> Option<OpaqueTyOrigin> {\n         let opaque_hir_id = self.tcx.hir().local_def_id_to_hir_id(def_id);\n         let parent_def_id = match self.defining_use_anchor {\n             DefiningAnchor::Bubble | DefiningAnchor::Error => return None,\n             DefiningAnchor::Bind(bind) => bind,\n         };\n-        let item_kind = &self.tcx.hir().expect_item(def_id).kind;\n-\n-        let hir::ItemKind::OpaqueTy(hir::OpaqueTy { origin, .. }) = item_kind else {\n-            span_bug!(\n-                span,\n-                \"weird opaque type: {:#?}, {:#?}\",\n-                def_id,\n-                item_kind\n-            )\n-        };\n-        let in_definition_scope = match *origin {\n+\n+        let origin = self.opaque_type_origin_unchecked(def_id);\n+        let in_definition_scope = match origin {\n             // Async `impl Trait`\n             hir::OpaqueTyOrigin::AsyncFn(parent) => parent == parent_def_id,\n             // Anonymous `impl Trait`\n@@ -398,16 +389,17 @@ impl<'tcx> InferCtxt<'tcx> {\n                 may_define_opaque_type(self.tcx, parent_def_id, opaque_hir_id)\n             }\n         };\n-        trace!(?origin);\n-        in_definition_scope.then_some(*origin)\n+        in_definition_scope.then_some(origin)\n     }\n \n+    /// Returns the origin of the opaque type `def_id` even if we are not in its\n+    /// defining scope.\n     #[instrument(skip(self), level = \"trace\", ret)]\n-    fn opaque_ty_origin_unchecked(&self, def_id: LocalDefId, span: Span) -> OpaqueTyOrigin {\n+    fn opaque_type_origin_unchecked(&self, def_id: LocalDefId) -> OpaqueTyOrigin {\n         match self.tcx.hir().expect_item(def_id).kind {\n             hir::ItemKind::OpaqueTy(hir::OpaqueTy { origin, .. }) => origin,\n             ref itemkind => {\n-                span_bug!(span, \"weird opaque type: {:?}, {:#?}\", def_id, itemkind)\n+                bug!(\"weird opaque type: {:?}, {:#?}\", def_id, itemkind)\n             }\n         }\n     }"}]}