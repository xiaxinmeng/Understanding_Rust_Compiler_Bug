{"sha": "2acd62d7c389bcdcf212673ed14120d2fd841df6", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJhY2Q2MmQ3YzM4OWJjZGNmMjEyNjczZWQxNDEyMGQyZmQ4NDFkZjY=", "commit": {"author": {"name": "Mohsen Zohrevandi", "email": "mohsen.zohrevandi@fortanix.com", "date": "2021-05-06T16:36:26Z"}, "committer": {"name": "Mohsen Zohrevandi", "email": "mohsen.zohrevandi@fortanix.com", "date": "2021-05-06T16:36:26Z"}, "message": "join_orders_after_tls_destructors: ensure thread 2 is launched before thread 1 enters TLS destructors", "tree": {"sha": "260f2783e1f43eefb9073884dc0f4bbf32295c02", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/260f2783e1f43eefb9073884dc0f4bbf32295c02"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2acd62d7c389bcdcf212673ed14120d2fd841df6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2acd62d7c389bcdcf212673ed14120d2fd841df6", "html_url": "https://github.com/rust-lang/rust/commit/2acd62d7c389bcdcf212673ed14120d2fd841df6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2acd62d7c389bcdcf212673ed14120d2fd841df6/comments", "author": {"login": "mzohreva", "id": 1142455, "node_id": "MDQ6VXNlcjExNDI0NTU=", "avatar_url": "https://avatars.githubusercontent.com/u/1142455?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mzohreva", "html_url": "https://github.com/mzohreva", "followers_url": "https://api.github.com/users/mzohreva/followers", "following_url": "https://api.github.com/users/mzohreva/following{/other_user}", "gists_url": "https://api.github.com/users/mzohreva/gists{/gist_id}", "starred_url": "https://api.github.com/users/mzohreva/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mzohreva/subscriptions", "organizations_url": "https://api.github.com/users/mzohreva/orgs", "repos_url": "https://api.github.com/users/mzohreva/repos", "events_url": "https://api.github.com/users/mzohreva/events{/privacy}", "received_events_url": "https://api.github.com/users/mzohreva/received_events", "type": "User", "site_admin": false}, "committer": {"login": "mzohreva", "id": 1142455, "node_id": "MDQ6VXNlcjExNDI0NTU=", "avatar_url": "https://avatars.githubusercontent.com/u/1142455?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mzohreva", "html_url": "https://github.com/mzohreva", "followers_url": "https://api.github.com/users/mzohreva/followers", "following_url": "https://api.github.com/users/mzohreva/following{/other_user}", "gists_url": "https://api.github.com/users/mzohreva/gists{/gist_id}", "starred_url": "https://api.github.com/users/mzohreva/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mzohreva/subscriptions", "organizations_url": "https://api.github.com/users/mzohreva/orgs", "repos_url": "https://api.github.com/users/mzohreva/repos", "events_url": "https://api.github.com/users/mzohreva/events{/privacy}", "received_events_url": "https://api.github.com/users/mzohreva/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8a0a4b1493264901e5e41c4285fc3cc9f8419c28", "url": "https://api.github.com/repos/rust-lang/rust/commits/8a0a4b1493264901e5e41c4285fc3cc9f8419c28", "html_url": "https://github.com/rust-lang/rust/commit/8a0a4b1493264901e5e41c4285fc3cc9f8419c28"}], "stats": {"total": 17, "additions": 9, "deletions": 8}, "files": [{"sha": "f33d6129619318e8774303d9b77b930de34093f5", "filename": "library/std/src/thread/local/tests.rs", "status": "modified", "additions": 9, "deletions": 8, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/2acd62d7c389bcdcf212673ed14120d2fd841df6/library%2Fstd%2Fsrc%2Fthread%2Flocal%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2acd62d7c389bcdcf212673ed14120d2fd841df6/library%2Fstd%2Fsrc%2Fthread%2Flocal%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fthread%2Flocal%2Ftests.rs?ref=2acd62d7c389bcdcf212673ed14120d2fd841df6", "patch": "@@ -250,13 +250,6 @@ fn join_orders_after_tls_destructors() {\n \n                 impl Drop for TlDrop {\n                     fn drop(&mut self) {\n-                        loop {\n-                            match SYNC_STATE.load(Ordering::SeqCst) {\n-                                FRESH => thread::yield_now(),\n-                                THREAD2_LAUNCHED => break,\n-                                v => unreachable!(\"sync state: {}\", v),\n-                            }\n-                        }\n                         let mut sync_state = SYNC_STATE.swap(THREAD1_WAITING, Ordering::SeqCst);\n                         loop {\n                             match sync_state {\n@@ -276,7 +269,15 @@ fn join_orders_after_tls_destructors() {\n                     static TL_DROP: TlDrop = TlDrop;\n                 }\n \n-                TL_DROP.with(|_| {})\n+                TL_DROP.with(|_| {});\n+\n+                loop {\n+                    match SYNC_STATE.load(Ordering::SeqCst) {\n+                        FRESH => thread::yield_now(),\n+                        THREAD2_LAUNCHED => break,\n+                        v => unreachable!(\"sync state: {}\", v),\n+                    }\n+                }\n             })\n             .unwrap();\n "}]}