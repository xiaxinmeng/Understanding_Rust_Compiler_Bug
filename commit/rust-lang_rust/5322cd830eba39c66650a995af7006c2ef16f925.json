{"sha": "5322cd830eba39c66650a995af7006c2ef16f925", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUzMjJjZDgzMGViYTM5YzY2NjUwYTk5NWFmNzAwNmMyZWYxNmY5MjU=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-03-21T00:45:24Z"}, "committer": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-03-21T00:45:24Z"}, "message": "Expand legacy-scoped macro during collection", "tree": {"sha": "a31747f6c05faf9f393358560ca859f519a7db84", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a31747f6c05faf9f393358560ca859f519a7db84"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5322cd830eba39c66650a995af7006c2ef16f925", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5322cd830eba39c66650a995af7006c2ef16f925", "html_url": "https://github.com/rust-lang/rust/commit/5322cd830eba39c66650a995af7006c2ef16f925", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5322cd830eba39c66650a995af7006c2ef16f925/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "787bd3c5516d250245f6070308d689311b638fbe", "url": "https://api.github.com/repos/rust-lang/rust/commits/787bd3c5516d250245f6070308d689311b638fbe", "html_url": "https://github.com/rust-lang/rust/commit/787bd3c5516d250245f6070308d689311b638fbe"}], "stats": {"total": 34, "additions": 28, "deletions": 6}, "files": [{"sha": "28b73c3a18d43ec2abd38ae49a46ed637f54a1d9", "filename": "crates/hir_def/src/nameres/collector.rs", "status": "modified", "additions": 7, "deletions": 6, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/5322cd830eba39c66650a995af7006c2ef16f925/crates%2Fhir_def%2Fsrc%2Fnameres%2Fcollector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5322cd830eba39c66650a995af7006c2ef16f925/crates%2Fhir_def%2Fsrc%2Fnameres%2Fcollector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fnameres%2Fcollector.rs?ref=5322cd830eba39c66650a995af7006c2ef16f925", "patch": "@@ -1467,12 +1467,13 @@ impl ModCollector<'_, '_> {\n             },\n         ) {\n             Ok(Ok(macro_call_id)) => {\n-                self.def_collector.unexpanded_macros.push(MacroDirective {\n-                    module_id: self.module_id,\n-                    ast_id,\n-                    legacy: Some(macro_call_id),\n-                    depth: self.macro_depth + 1,\n-                });\n+                // Legacy macros need to be expanded immediately, so that any macros they produce\n+                // are in scope.\n+                self.def_collector.collect_macro_expansion(\n+                    self.module_id,\n+                    macro_call_id,\n+                    self.macro_depth + 1,\n+                );\n \n                 return;\n             }"}, {"sha": "6d3cb8d7afaf23ef67a70582292b41e8d992b6fc", "filename": "crates/hir_def/src/nameres/tests/macros.rs", "status": "modified", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/5322cd830eba39c66650a995af7006c2ef16f925/crates%2Fhir_def%2Fsrc%2Fnameres%2Ftests%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5322cd830eba39c66650a995af7006c2ef16f925/crates%2Fhir_def%2Fsrc%2Fnameres%2Ftests%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fnameres%2Ftests%2Fmacros.rs?ref=5322cd830eba39c66650a995af7006c2ef16f925", "patch": "@@ -712,6 +712,27 @@ b! { static = #[] ();}\n     );\n }\n \n+#[test]\n+fn macros_defining_macros() {\n+    check(\n+        r#\"\n+macro_rules! item {\n+    ($item:item) => { $item }\n+}\n+\n+item! {\n+    macro_rules! indirect_macro { () => { struct S {} } }\n+}\n+\n+indirect_macro!();\n+    \"#,\n+        expect![[r#\"\n+            crate\n+            S: t\n+        \"#]],\n+    );\n+}\n+\n #[test]\n fn resolves_proc_macros() {\n     check("}]}