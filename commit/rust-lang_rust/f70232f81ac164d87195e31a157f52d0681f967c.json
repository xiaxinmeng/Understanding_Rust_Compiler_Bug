{"sha": "f70232f81ac164d87195e31a157f52d0681f967c", "node_id": "C_kwDOAAsO6NoAKGY3MDIzMmY4MWFjMTY0ZDg3MTk1ZTMxYTE1N2Y1MmQwNjgxZjk2N2M", "commit": {"author": {"name": "Mark Rousskov", "email": "mark.simulacrum@gmail.com", "date": "2021-10-14T14:19:03Z"}, "committer": {"name": "Mark Rousskov", "email": "mark.simulacrum@gmail.com", "date": "2021-10-14T19:21:14Z"}, "message": "Move LLVM profiling to a separate phase of compilation", "tree": {"sha": "e0930505e3fcac4803109b3be09ca4f3b34e8678", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e0930505e3fcac4803109b3be09ca4f3b34e8678"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f70232f81ac164d87195e31a157f52d0681f967c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f70232f81ac164d87195e31a157f52d0681f967c", "html_url": "https://github.com/rust-lang/rust/commit/f70232f81ac164d87195e31a157f52d0681f967c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f70232f81ac164d87195e31a157f52d0681f967c/comments", "author": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Mark-Simulacrum", "id": 5047365, "node_id": "MDQ6VXNlcjUwNDczNjU=", "avatar_url": "https://avatars.githubusercontent.com/u/5047365?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Mark-Simulacrum", "html_url": "https://github.com/Mark-Simulacrum", "followers_url": "https://api.github.com/users/Mark-Simulacrum/followers", "following_url": "https://api.github.com/users/Mark-Simulacrum/following{/other_user}", "gists_url": "https://api.github.com/users/Mark-Simulacrum/gists{/gist_id}", "starred_url": "https://api.github.com/users/Mark-Simulacrum/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Mark-Simulacrum/subscriptions", "organizations_url": "https://api.github.com/users/Mark-Simulacrum/orgs", "repos_url": "https://api.github.com/users/Mark-Simulacrum/repos", "events_url": "https://api.github.com/users/Mark-Simulacrum/events{/privacy}", "received_events_url": "https://api.github.com/users/Mark-Simulacrum/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c34ac8747ca96d09cb08b8f5adddead826e77c06", "url": "https://api.github.com/repos/rust-lang/rust/commits/c34ac8747ca96d09cb08b8f5adddead826e77c06", "html_url": "https://github.com/rust-lang/rust/commit/c34ac8747ca96d09cb08b8f5adddead826e77c06"}], "stats": {"total": 38, "additions": 30, "deletions": 8}, "files": [{"sha": "29ef13a60fbc431d08c4ea71a81d71b149cbf45b", "filename": "src/ci/pgo.sh", "status": "modified", "additions": 30, "deletions": 8, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/f70232f81ac164d87195e31a157f52d0681f967c/src%2Fci%2Fpgo.sh", "raw_url": "https://github.com/rust-lang/rust/raw/f70232f81ac164d87195e31a157f52d0681f967c/src%2Fci%2Fpgo.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fpgo.sh?ref=f70232f81ac164d87195e31a157f52d0681f967c", "patch": "@@ -4,9 +4,13 @@ set -euxo pipefail\n \n rm -rf /tmp/rustc-pgo\n \n+# We collect LLVM profiling information and rustc profiling information in\n+# separate phases. This increases build time -- though not by a huge amount --\n+# but prevents any problems from arising due to different profiling runtimes\n+# being simultaneously linked in.\n+\n python3 ../x.py build --target=$PGO_HOST --host=$PGO_HOST \\\n     --stage 2 library/std \\\n-    --rust-profile-generate=/tmp/rustc-pgo \\\n     --llvm-profile-generate\n \n # Profile libcore compilation in opt-level=0 and opt-level=3\n@@ -15,6 +19,29 @@ RUSTC_BOOTSTRAP=1 ./build/$PGO_HOST/stage2/bin/rustc --edition=2018 \\\n RUSTC_BOOTSTRAP=1 ./build/$PGO_HOST/stage2/bin/rustc --edition=2018 \\\n     --crate-type=lib -Copt-level=3 ../library/core/src/lib.rs\n \n+# Merge the profile data we gathered for LLVM\n+# Note that this uses the profdata from the clang we used to build LLVM,\n+# which likely has a different version than our in-tree clang.\n+/rustroot/bin/llvm-profdata \\\n+    merge -o /tmp/llvm-pgo.profdata ./build/$PGO_HOST/llvm/build/profiles\n+\n+# Rustbuild currently doesn't support rebuilding LLVM when PGO options\n+# change (or any other llvm-related options); so just clear out the relevant\n+# directories ourselves.\n+rm -r ./build/$PGO_HOST/llvm ./build/$PGO_HOST/lld\n+\n+# Okay, LLVM profiling is done, switch to rustc PGO.\n+\n+python3 ../x.py build --target=$PGO_HOST --host=$PGO_HOST \\\n+    --stage 2 library/std \\\n+    --rust-profile-generate=/tmp/rustc-pgo\n+\n+# Profile libcore compilation in opt-level=0 and opt-level=3\n+RUSTC_BOOTSTRAP=1 ./build/$PGO_HOST/stage2/bin/rustc --edition=2018 \\\n+    --crate-type=lib ../library/core/src/lib.rs\n+RUSTC_BOOTSTRAP=1 ./build/$PGO_HOST/stage2/bin/rustc --edition=2018 \\\n+    --crate-type=lib -Copt-level=3 ../library/core/src/lib.rs\n+\n cp -r /tmp/rustc-perf ./\n chown -R $(whoami): ./rustc-perf\n cd rustc-perf\n@@ -46,18 +73,13 @@ cd /checkout/obj\n ./build/$PGO_HOST/llvm/bin/llvm-profdata \\\n     merge -o /tmp/rustc-pgo.profdata /tmp/rustc-pgo\n \n-# Merge the profile data we gathered for LLVM\n-# Note that this uses the profdata from the clang we used to build LLVM,\n-# which likely has a different version than our in-tree clang.\n-/rustroot/bin/llvm-profdata \\\n-    merge -o /tmp/llvm-pgo.profdata ./build/$PGO_HOST/llvm/build/profiles\n-\n # Rustbuild currently doesn't support rebuilding LLVM when PGO options\n # change (or any other llvm-related options); so just clear out the relevant\n # directories ourselves.\n rm -r ./build/$PGO_HOST/llvm ./build/$PGO_HOST/lld\n \n-# This produces the actual final set of artifacts.\n+# This produces the actual final set of artifacts, using both the LLVM and rustc\n+# collected profiling data.\n $@ \\\n     --rust-profile-use=/tmp/rustc-pgo.profdata \\\n     --llvm-profile-use=/tmp/llvm-pgo.profdata"}]}