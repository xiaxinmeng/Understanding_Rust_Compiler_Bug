{"sha": "dbac2192072a2a8b964be9858d06570da1cc86ba", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRiYWMyMTkyMDcyYTJhOGI5NjRiZTk4NThkMDY1NzBkYTFjYzg2YmE=", "commit": {"author": {"name": "bjorn3", "email": "bjorn3@users.noreply.github.com", "date": "2019-07-31T12:04:00Z"}, "committer": {"name": "bjorn3", "email": "bjorn3@users.noreply.github.com", "date": "2019-08-09T10:46:24Z"}, "message": "Libtest support", "tree": {"sha": "a18accdd35d99386e9d2b8c8fab974230660095e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a18accdd35d99386e9d2b8c8fab974230660095e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/dbac2192072a2a8b964be9858d06570da1cc86ba", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/dbac2192072a2a8b964be9858d06570da1cc86ba", "html_url": "https://github.com/rust-lang/rust/commit/dbac2192072a2a8b964be9858d06570da1cc86ba", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/dbac2192072a2a8b964be9858d06570da1cc86ba/comments", "author": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e7a507863c281d571995e10f1e97beca42cb89ac", "url": "https://api.github.com/repos/rust-lang/rust/commits/e7a507863c281d571995e10f1e97beca42cb89ac", "html_url": "https://github.com/rust-lang/rust/commit/e7a507863c281d571995e10f1e97beca42cb89ac"}], "stats": {"total": 82, "additions": 79, "deletions": 3}, "files": [{"sha": "d00d779cb28ae36785853d92483dd26daf467b38", "filename": ".gitignore", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/dbac2192072a2a8b964be9858d06570da1cc86ba/.gitignore", "raw_url": "https://github.com/rust-lang/rust/raw/dbac2192072a2a8b964be9858d06570da1cc86ba/.gitignore", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.gitignore?ref=dbac2192072a2a8b964be9858d06570da1cc86ba", "patch": "@@ -7,5 +7,6 @@ perf.data.old\n /build_sysroot/sysroot\n /build_sysroot/sysroot_src\n /build_sysroot/Cargo.lock\n+/build_sysroot/test_target/Cargo.lock\n /rust\n /regex"}, {"sha": "7776f1bd38309ca918f3a0d45fde903124287b06", "filename": "build_sysroot/Cargo.toml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/dbac2192072a2a8b964be9858d06570da1cc86ba/build_sysroot%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/dbac2192072a2a8b964be9858d06570da1cc86ba/build_sysroot%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/build_sysroot%2FCargo.toml?ref=dbac2192072a2a8b964be9858d06570da1cc86ba", "patch": "@@ -7,7 +7,7 @@ version = \"0.0.0\"\n core = { path = \"./sysroot_src/src/libcore\" }\n compiler_builtins = \"0.1\"\n alloc = { path = \"./sysroot_src/src/liballoc\" }\n-std = { path = \"./sysroot_src/src/libstd\" }\n+std = { path = \"./sysroot_src/src/libstd\", features = [\"panic_unwind\"] }\n \n alloc_system = { path = \"./alloc_system\" }\n "}, {"sha": "4e58858f133daf416d6b5055867eaf50d791a0c5", "filename": "build_sysroot/build_sysroot.sh", "status": "modified", "additions": 13, "deletions": 1, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/dbac2192072a2a8b964be9858d06570da1cc86ba/build_sysroot%2Fbuild_sysroot.sh", "raw_url": "https://github.com/rust-lang/rust/raw/dbac2192072a2a8b964be9858d06570da1cc86ba/build_sysroot%2Fbuild_sysroot.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/build_sysroot%2Fbuild_sysroot.sh?ref=dbac2192072a2a8b964be9858d06570da1cc86ba", "patch": "@@ -12,7 +12,8 @@ popd >/dev/null\n # Cleanup for previous run\n #     v Clean target dir except for build scripts and incremental cache\n rm -r target/*/{debug,release}/{build,deps,examples,libsysroot*,native} || true\n-rm Cargo.lock 2>/dev/null || true\n+rm -r sysroot_src/src/{libcore,libtest}/target/$TARGET_TRIPLE/$sysroot_channel/ || true\n+rm Cargo.lock test_target/Cargo.lock 2>/dev/null || true\n rm -r sysroot 2>/dev/null || true\n \n # Build libs\n@@ -28,3 +29,14 @@ fi\n # Copy files to sysroot\n mkdir -p sysroot/lib/rustlib/$TARGET_TRIPLE/lib/\n cp target/$TARGET_TRIPLE/$sysroot_channel/deps/*.rlib sysroot/lib/rustlib/$TARGET_TRIPLE/lib/\n+\n+if [[ \"$1\" == \"--release\" ]]; then\n+    channel='release'\n+    RUSTFLAGS=\"$RUSTFLAGS -Zmir-opt-level=3\" cargo build --target $TARGET_TRIPLE --release --manifest-path ./sysroot_src/src/libtest/Cargo.toml\n+else\n+    channel='debug'\n+    cargo build --target $TARGET_TRIPLE --manifest-path ./sysroot_src/src/libtest/Cargo.toml\n+fi\n+\n+# Copy files to sysroot\n+cp sysroot_src/src/libtest/target/$TARGET_TRIPLE/$sysroot_channel/deps/*.rlib sysroot/lib/rustlib/$TARGET_TRIPLE/lib/"}, {"sha": "de035f52f33f6c199ce8616b1e762680f33ee0e4", "filename": "patches/0017-Fix-libtest-compilation.patch", "status": "added", "additions": 49, "deletions": 0, "changes": 49, "blob_url": "https://github.com/rust-lang/rust/blob/dbac2192072a2a8b964be9858d06570da1cc86ba/patches%2F0017-Fix-libtest-compilation.patch", "raw_url": "https://github.com/rust-lang/rust/raw/dbac2192072a2a8b964be9858d06570da1cc86ba/patches%2F0017-Fix-libtest-compilation.patch", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/patches%2F0017-Fix-libtest-compilation.patch?ref=dbac2192072a2a8b964be9858d06570da1cc86ba", "patch": "@@ -0,0 +1,49 @@\n+From a25405f1fc4a168c9c370524be48aff8c8ebc529 Mon Sep 17 00:00:00 2001\n+From: bjorn3 <bjorn3@users.noreply.github.com>\n+Date: Wed, 12 Jun 2019 18:07:23 +0200\n+Subject: [PATCH] Fix libtest compilation\n+\n+---\n+ src/libtest/lib.rs | 11 +++++------\n+ 1 file changed, 5 insertions(+), 6 deletions(-)\n+\n+diff --git a/src/libtest/lib.rs b/src/libtest/lib.rs\n+index 810a98e..4fdde0e 100644\n+--- a/src/libtest/lib.rs\n++++ b/src/libtest/lib.rs\n+@@ -1441,11 +1441,11 @@ pub fn run_test(\n+         return;\n+     }\n+ \n+-    fn run_test_inner(\n++    fn run_test_inner<F: FnOnce() + Send + 'static>(\n+         desc: TestDesc,\n+         monitor_ch: Sender<MonitorMsg>,\n+         nocapture: bool,\n+-        testfn: Box<dyn FnOnce() + Send>,\n++        testfn: F,\n+         concurrency: Concurrent,\n+     ) {\n+         // Buffer for capturing standard I/O\n+@@ -1500,15 +1500,14 @@ pub fn run_test(\n+                 (benchfn.clone())(harness)\n+             });\n+         }\n+-        DynTestFn(f) => {\n+-            let cb = move || __rust_begin_short_backtrace(f);\n+-            run_test_inner(desc, monitor_ch, opts.nocapture, Box::new(cb), concurrency)\n++        DynTestFn(_f) => {\n++            unimplemented!();\n+         }\n+         StaticTestFn(f) => run_test_inner(\n+             desc,\n+             monitor_ch,\n+             opts.nocapture,\n+-            Box::new(move || __rust_begin_short_backtrace(f)),\n++            move || __rust_begin_short_backtrace(f),\n+             concurrency,\n+         ),\n+     }\n+-- \n+2.11.0\n+"}, {"sha": "5beabfb5ee2f4371587af6e371322858fc96144e", "filename": "src/intrinsics.rs", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/dbac2192072a2a8b964be9858d06570da1cc86ba/src%2Fintrinsics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dbac2192072a2a8b964be9858d06570da1cc86ba/src%2Fintrinsics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fintrinsics.rs?ref=dbac2192072a2a8b964be9858d06570da1cc86ba", "patch": "@@ -1011,6 +1011,20 @@ pub fn codegen_intrinsic_call<'a, 'tcx: 'a>(\n         simd_fmax, (c x, c y) {\n             simd_flt_binop!(fx, intrinsic, fmax(x, y) -> ret);\n         };\n+\n+        try, (v f, v data, v _local_ptr) {\n+            // FIXME once unwinding is supported, change this to actually catch panics\n+            let f_sig = fx.bcx.func.import_signature(Signature {\n+                call_conv: cranelift::codegen::isa::CallConv::SystemV,\n+                params: vec![AbiParam::new(fx.bcx.func.dfg.value_type(data))],\n+                returns: vec![],\n+            });\n+\n+            fx.bcx.ins().call_indirect(f_sig, f, &[data]);\n+\n+            let ret_val = CValue::const_val(fx, ret.layout().ty, 0);\n+            ret.write_cvalue(fx, ret_val);\n+        };\n     }\n \n     if let Some((_, dest)) = destination {"}, {"sha": "dc4029bfb3387e5bfda344942bb1e98e66a10973", "filename": "test.sh", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/dbac2192072a2a8b964be9858d06570da1cc86ba/test.sh", "raw_url": "https://github.com/rust-lang/rust/raw/dbac2192072a2a8b964be9858d06570da1cc86ba/test.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/test.sh?ref=dbac2192072a2a8b964be9858d06570da1cc86ba", "patch": "@@ -58,7 +58,7 @@ echo \"[TEST] rust-lang/regex example shootout-regex-dna\"\n cat examples/regexdna-input.txt | ../cargo.sh run --example shootout-regex-dna > res.txt\n diff -u res.txt examples/regexdna-output.txt\n \n-# FIXME compile libtest\n+# FIXME fix \"memory allocation of k bytes failed\"\n # echo \"[TEST] rust-lang/regex standalone tests\"\n # ../cargo.sh test\n popd"}]}