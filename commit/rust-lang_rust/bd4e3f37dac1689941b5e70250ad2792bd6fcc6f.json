{"sha": "bd4e3f37dac1689941b5e70250ad2792bd6fcc6f", "node_id": "C_kwDOAAsO6NoAKGJkNGUzZjM3ZGFjMTY4OTk0MWI1ZTcwMjUwYWQyNzkyYmQ2ZmNjNmY", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume1.gomez@gmail.com", "date": "2023-03-31T20:32:50Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-03-31T20:32:50Z"}, "message": "Rollup merge of #109798 - est31:ftl_test_note, r=davidtwco\n\nfluent_messages macro: don't emit the OS error in a note\n\nThis makes it possible to make the normalization of the error message precise, allowing us to not normalize all notes away. See https://github.com/rust-lang/rust/pull/109700#discussion_r1152489053", "tree": {"sha": "8f9219d354284b3bf03cb97efdb8644f886f3437", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8f9219d354284b3bf03cb97efdb8644f886f3437"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bd4e3f37dac1689941b5e70250ad2792bd6fcc6f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkJ0NyCRBK7hj4Ov3rIwAABHEIACV6yaNJ0ahTe/rwhLJww6bJ\nWKzqPOrQAm1Zz6pN04/lkNVQBK8VQItSyLeK6ld65ZnPIpfZ4BonMepeK6f5Qsre\nADXRF7jg8kH4bNvdqbR5WxGdmEPV2+W/KsAYxo8/Hcal/Tzrwr9nGOv1whHZ6OQI\nIHmlp5Ya4/Ok4CNmq7OppkBZ10fzUNbYCkUt+Il2kAYgMN8XyaBfjuWc38U8atbi\nnm0oU88TWY29m7A+fLn+QzujE72f0t9dJKmuL3H3UretMlvu1lozefd23ZS4TrV8\nixou8hiKNyUEP14KFa89Oq2l6jNaWRKx5rpebvZXZZVGUjKkPgnTEyju1rpsw5s=\n=aTfR\n-----END PGP SIGNATURE-----\n", "payload": "tree 8f9219d354284b3bf03cb97efdb8644f886f3437\nparent 45fcb6fd7c51ebe44e430d4fa7f628d436547719\nparent 97fb15d9508da0712aa6a5b194251e90315105fb\nauthor Guillaume Gomez <guillaume1.gomez@gmail.com> 1680294770 +0200\ncommitter GitHub <noreply@github.com> 1680294770 +0200\n\nRollup merge of #109798 - est31:ftl_test_note, r=davidtwco\n\nfluent_messages macro: don't emit the OS error in a note\n\nThis makes it possible to make the normalization of the error message precise, allowing us to not normalize all notes away. See https://github.com/rust-lang/rust/pull/109700#discussion_r1152489053\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bd4e3f37dac1689941b5e70250ad2792bd6fcc6f", "html_url": "https://github.com/rust-lang/rust/commit/bd4e3f37dac1689941b5e70250ad2792bd6fcc6f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bd4e3f37dac1689941b5e70250ad2792bd6fcc6f/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "45fcb6fd7c51ebe44e430d4fa7f628d436547719", "url": "https://api.github.com/repos/rust-lang/rust/commits/45fcb6fd7c51ebe44e430d4fa7f628d436547719", "html_url": "https://github.com/rust-lang/rust/commit/45fcb6fd7c51ebe44e430d4fa7f628d436547719"}, {"sha": "97fb15d9508da0712aa6a5b194251e90315105fb", "url": "https://api.github.com/repos/rust-lang/rust/commits/97fb15d9508da0712aa6a5b194251e90315105fb", "html_url": "https://github.com/rust-lang/rust/commit/97fb15d9508da0712aa6a5b194251e90315105fb"}], "stats": {"total": 39, "additions": 15, "deletions": 24}, "files": [{"sha": "9f96a04148792f4d4ae494edc47df4c38821e07f", "filename": "compiler/rustc_macros/src/diagnostics/fluent.rs", "status": "modified", "additions": 9, "deletions": 14, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/bd4e3f37dac1689941b5e70250ad2792bd6fcc6f/compiler%2Frustc_macros%2Fsrc%2Fdiagnostics%2Ffluent.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bd4e3f37dac1689941b5e70250ad2792bd6fcc6f/compiler%2Frustc_macros%2Fsrc%2Fdiagnostics%2Ffluent.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_macros%2Fsrc%2Fdiagnostics%2Ffluent.rs?ref=bd4e3f37dac1689941b5e70250ad2792bd6fcc6f", "patch": "@@ -15,8 +15,7 @@ use proc_macro2::TokenStream;\n use quote::quote;\n use std::{\n     collections::{HashMap, HashSet},\n-    fs::File,\n-    io::Read,\n+    fs::read_to_string,\n     path::{Path, PathBuf},\n };\n use syn::{parse_macro_input, Ident, LitStr};\n@@ -95,22 +94,18 @@ pub(crate) fn fluent_messages(input: proc_macro::TokenStream) -> proc_macro::Tok\n \n     // As this macro also outputs an `include_str!` for this file, the macro will always be\n     // re-executed when the file changes.\n-    let mut resource_file = match File::open(absolute_ftl_path) {\n-        Ok(resource_file) => resource_file,\n+    let resource_contents = match read_to_string(absolute_ftl_path) {\n+        Ok(resource_contents) => resource_contents,\n         Err(e) => {\n-            Diagnostic::spanned(resource_span, Level::Error, \"could not open Fluent resource\")\n-                .note(e.to_string())\n-                .emit();\n+            Diagnostic::spanned(\n+                resource_span,\n+                Level::Error,\n+                format!(\"could not open Fluent resource: {}\", e.to_string()),\n+            )\n+            .emit();\n             return failed(&crate_name);\n         }\n     };\n-    let mut resource_contents = String::new();\n-    if let Err(e) = resource_file.read_to_string(&mut resource_contents) {\n-        Diagnostic::spanned(resource_span, Level::Error, \"could not read Fluent resource\")\n-            .note(e.to_string())\n-            .emit();\n-        return failed(&crate_name);\n-    }\n     let mut bad = false;\n     for esc in [\"\\\\n\", \"\\\\\\\"\", \"\\\\'\"] {\n         for _ in resource_contents.matches(esc) {"}, {"sha": "6ba13387b046096c114e8d0ea81af2f03a35296c", "filename": "tests/ui-fulldeps/fluent-messages/test.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/bd4e3f37dac1689941b5e70250ad2792bd6fcc6f/tests%2Fui-fulldeps%2Ffluent-messages%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bd4e3f37dac1689941b5e70250ad2792bd6fcc6f/tests%2Fui-fulldeps%2Ffluent-messages%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-fulldeps%2Ffluent-messages%2Ftest.rs?ref=bd4e3f37dac1689941b5e70250ad2792bd6fcc6f", "patch": "@@ -1,4 +1,4 @@\n-// normalize-stderr-test \"note.*\" -> \"note: os-specific message\"\n+// normalize-stderr-test \"could not open Fluent resource:.*\" -> \"could not open Fluent resource: os-specific message\"\n \n #![feature(rustc_private)]\n #![crate_type = \"lib\"]"}, {"sha": "2affe621c113adce68641172c125210f6c1556ad", "filename": "tests/ui-fulldeps/fluent-messages/test.stderr", "status": "modified", "additions": 5, "deletions": 9, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/bd4e3f37dac1689941b5e70250ad2792bd6fcc6f/tests%2Fui-fulldeps%2Ffluent-messages%2Ftest.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/bd4e3f37dac1689941b5e70250ad2792bd6fcc6f/tests%2Fui-fulldeps%2Ffluent-messages%2Ftest.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-fulldeps%2Ffluent-messages%2Ftest.stderr?ref=bd4e3f37dac1689941b5e70250ad2792bd6fcc6f", "patch": "@@ -1,18 +1,14 @@\n-error: could not open Fluent resource\n+error: could not open Fluent resource: os-specific message\n   --> $DIR/test.rs:24:24\n    |\n LL |     fluent_messages! { \"/definitely_does_not_exist.ftl\" }\n    |                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n-   |\n-   = note: os-specific message\n \n-error: could not open Fluent resource\n+error: could not open Fluent resource: os-specific message\n   --> $DIR/test.rs:31:24\n    |\n LL |     fluent_messages! { \"../definitely_does_not_exist.ftl\" }\n    |                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n-   |\n-   = note: os-specific message\n \n error: could not parse Fluent resource\n   --> $DIR/test.rs:38:24\n@@ -89,23 +85,23 @@ error: invalid escape `\\n` in Fluent resource\n LL |     fluent_messages! { \"./invalid-escape.ftl\" }\n    |                        ^^^^^^^^^^^^^^^^^^^^^^\n    |\n-   = note: os-specific message\n+   = note: Fluent does not interpret these escape sequences (<https://projectfluent.org/fluent/guide/special.html>)\n \n error: invalid escape `\\\"` in Fluent resource\n   --> $DIR/test.rs:99:24\n    |\n LL |     fluent_messages! { \"./invalid-escape.ftl\" }\n    |                        ^^^^^^^^^^^^^^^^^^^^^^\n    |\n-   = note: os-specific message\n+   = note: Fluent does not interpret these escape sequences (<https://projectfluent.org/fluent/guide/special.html>)\n \n error: invalid escape `\\'` in Fluent resource\n   --> $DIR/test.rs:99:24\n    |\n LL |     fluent_messages! { \"./invalid-escape.ftl\" }\n    |                        ^^^^^^^^^^^^^^^^^^^^^^\n    |\n-   = note: os-specific message\n+   = note: Fluent does not interpret these escape sequences (<https://projectfluent.org/fluent/guide/special.html>)\n \n error: aborting due to 13 previous errors\n "}]}