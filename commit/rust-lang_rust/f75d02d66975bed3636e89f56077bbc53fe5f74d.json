{"sha": "f75d02d66975bed3636e89f56077bbc53fe5f74d", "node_id": "C_kwDOAAsO6NoAKGY3NWQwMmQ2Njk3NWJlZDM2MzZlODlmNTYwNzdiYmM1M2ZlNWY3NGQ", "commit": {"author": {"name": "S\u00e9bastien Marie", "email": "semarie@online.fr", "date": "2022-05-11T04:50:23Z"}, "committer": {"name": "S\u00e9bastien Marie", "email": "semarie@online.fr", "date": "2022-05-11T04:50:23Z"}, "message": "openbsd: convert futex timeout managment to Timespec usage", "tree": {"sha": "38d489997a6ee2c7bc3e728d3f62158d51edd34f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/38d489997a6ee2c7bc3e728d3f62158d51edd34f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f75d02d66975bed3636e89f56077bbc53fe5f74d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f75d02d66975bed3636e89f56077bbc53fe5f74d", "html_url": "https://github.com/rust-lang/rust/commit/f75d02d66975bed3636e89f56077bbc53fe5f74d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f75d02d66975bed3636e89f56077bbc53fe5f74d/comments", "author": {"login": "semarie", "id": 8948701, "node_id": "MDQ6VXNlcjg5NDg3MDE=", "avatar_url": "https://avatars.githubusercontent.com/u/8948701?v=4", "gravatar_id": "", "url": "https://api.github.com/users/semarie", "html_url": "https://github.com/semarie", "followers_url": "https://api.github.com/users/semarie/followers", "following_url": "https://api.github.com/users/semarie/following{/other_user}", "gists_url": "https://api.github.com/users/semarie/gists{/gist_id}", "starred_url": "https://api.github.com/users/semarie/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/semarie/subscriptions", "organizations_url": "https://api.github.com/users/semarie/orgs", "repos_url": "https://api.github.com/users/semarie/repos", "events_url": "https://api.github.com/users/semarie/events{/privacy}", "received_events_url": "https://api.github.com/users/semarie/received_events", "type": "User", "site_admin": false}, "committer": {"login": "semarie", "id": 8948701, "node_id": "MDQ6VXNlcjg5NDg3MDE=", "avatar_url": "https://avatars.githubusercontent.com/u/8948701?v=4", "gravatar_id": "", "url": "https://api.github.com/users/semarie", "html_url": "https://github.com/semarie", "followers_url": "https://api.github.com/users/semarie/followers", "following_url": "https://api.github.com/users/semarie/following{/other_user}", "gists_url": "https://api.github.com/users/semarie/gists{/gist_id}", "starred_url": "https://api.github.com/users/semarie/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/semarie/subscriptions", "organizations_url": "https://api.github.com/users/semarie/orgs", "repos_url": "https://api.github.com/users/semarie/repos", "events_url": "https://api.github.com/users/semarie/events{/privacy}", "received_events_url": "https://api.github.com/users/semarie/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "532be942ddf8f40d086e54d157453434b16e9647", "url": "https://api.github.com/repos/rust-lang/rust/commits/532be942ddf8f40d086e54d157453434b16e9647", "html_url": "https://github.com/rust-lang/rust/commit/532be942ddf8f40d086e54d157453434b16e9647"}], "stats": {"total": 16, "additions": 7, "deletions": 9}, "files": [{"sha": "d70108e7bd6275f230845f7a9826381f655849e4", "filename": "library/std/src/sys/unix/futex.rs", "status": "modified", "additions": 6, "deletions": 8, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/f75d02d66975bed3636e89f56077bbc53fe5f74d/library%2Fstd%2Fsrc%2Fsys%2Funix%2Ffutex.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f75d02d66975bed3636e89f56077bbc53fe5f74d/library%2Fstd%2Fsrc%2Fsys%2Funix%2Ffutex.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Funix%2Ffutex.rs?ref=f75d02d66975bed3636e89f56077bbc53fe5f74d", "patch": "@@ -136,15 +136,13 @@ pub fn futex_wake_all(futex: &AtomicU32) {\n \n #[cfg(target_os = \"openbsd\")]\n pub fn futex_wait(futex: &AtomicU32, expected: u32, timeout: Option<Duration>) -> bool {\n+    use super::time::Timespec;\n     use crate::ptr::{null, null_mut};\n-    let timespec = timeout.and_then(|d| {\n-        Some(libc::timespec {\n-            // Sleep forever if the timeout is longer than fits in a timespec.\n-            tv_sec: d.as_secs().try_into().ok()?,\n-            // This conversion never truncates, as subsec_nanos is always <1e9.\n-            tv_nsec: d.subsec_nanos() as _,\n-        })\n-    });\n+\n+    // Overflows are rounded up to an infinite timeout (None).\n+    let timespec = timeout\n+        .and_then(|d| Timespec::zero().checked_add_duration(&d))\n+        .and_then(|t| t.to_timespec());\n \n     let r = unsafe {\n         libc::futex("}, {"sha": "df95f1494fd560d9524b20d5562e9588df5914c9", "filename": "library/std/src/sys/unix/time.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/f75d02d66975bed3636e89f56077bbc53fe5f74d/library%2Fstd%2Fsrc%2Fsys%2Funix%2Ftime.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f75d02d66975bed3636e89f56077bbc53fe5f74d/library%2Fstd%2Fsrc%2Fsys%2Funix%2Ftime.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Funix%2Ftime.rs?ref=f75d02d66975bed3636e89f56077bbc53fe5f74d", "patch": "@@ -51,7 +51,7 @@ impl fmt::Debug for SystemTime {\n }\n \n impl Timespec {\n-    const fn zero() -> Timespec {\n+    pub const fn zero() -> Timespec {\n         Timespec { tv_sec: 0, tv_nsec: 0 }\n     }\n "}]}