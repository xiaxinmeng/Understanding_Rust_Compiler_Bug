{"sha": "dea13632a8e8f90febe3de17c740498285397936", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRlYTEzNjMyYThlOGY5MGZlYmUzZGUxN2M3NDA0OTgyODUzOTc5MzY=", "commit": {"author": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2020-12-17T20:25:55Z"}, "committer": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2020-12-17T20:25:55Z"}, "message": "Suppress `CONST_ITEM_MUTATION` lint if a dereference occurs anywhere\n\nFixes #79971", "tree": {"sha": "c85f47bc8a5755b403d8299a4c2ee125423c873d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c85f47bc8a5755b403d8299a4c2ee125423c873d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/dea13632a8e8f90febe3de17c740498285397936", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE7J9Gc3TfBwj2K399tAh+UQ6YsWQFAl/bvuwACgkQtAh+UQ6Y\nsWQ9Cw//WBQc57fhLNdCzITBLRcVaGFU1UsfIDJJsjSJ6ftS90vbuKTddixotJOa\nB+WXssVamILww3CefAaJj7n6uBJnR5p5wTASoWmnIHUADNN8ZEgfcVL0Hcbg0H2q\nb5fcOwx6f1KYYSKK56F3p+2C/8PXhAbNW7lTUA5aV+gDZhCTapEoz2vK24F9+XYs\nW3g34vDGhugHOUwK+55QPhy8D2RG7+qt13VjNqFZCb2wbeFMV3C3CBwlYM2CaQZZ\n6f5gLQomUDESgAhxSuyDQq6evg9qWnsQaZgL2esONpCPodqi5kNmM8/3mQ1y4f1b\nBPvOTofs3W4qRbUxKHAxVB+cokCDxfxaXKJoGAte41CScWu9Pk8aZoU+EjjrC3JE\nSZCswa4KFhreQoRZHP6VbHsDHScTS7qHjiWI1TmnTezpZx67YM8+X+2YYIxwZ7eX\nkb3aUcPOGONuEsCxFEt60TyjVuotscf2fKx/tKNTZ17rENJ0H2NCxlg6n+JJ169Z\nIgVX5P/A+vRjYnl6S2Htr6z37LOTNo9qYPhS0rSQ/sVYHKud25CIVTyDp18VbuVs\n1elELi4QMulbIu0MTfzx6BuFYqeJtVXPF3oBgPWplOWasg4Qs6uMMy1pU39wMV99\nTmvInUiybBB4lyVROHbSvo35YRJC08O8RJBhg1SchI57oYk+IZs=\n=RcZ1\n-----END PGP SIGNATURE-----", "payload": "tree c85f47bc8a5755b403d8299a4c2ee125423c873d\nparent d23e08448332425a84ae23124bea4dbd685536ce\nauthor Aaron Hill <aa1ronham@gmail.com> 1608236755 -0500\ncommitter Aaron Hill <aa1ronham@gmail.com> 1608236755 -0500\n\nSuppress `CONST_ITEM_MUTATION` lint if a dereference occurs anywhere\n\nFixes #79971\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/dea13632a8e8f90febe3de17c740498285397936", "html_url": "https://github.com/rust-lang/rust/commit/dea13632a8e8f90febe3de17c740498285397936", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/dea13632a8e8f90febe3de17c740498285397936/comments", "author": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d23e08448332425a84ae23124bea4dbd685536ce", "url": "https://api.github.com/repos/rust-lang/rust/commits/d23e08448332425a84ae23124bea4dbd685536ce", "html_url": "https://github.com/rust-lang/rust/commit/d23e08448332425a84ae23124bea4dbd685536ce"}], "stats": {"total": 32, "additions": 21, "deletions": 11}, "files": [{"sha": "e2d50ba034ad3f65f80633fed0e848a40c90a72f", "filename": "compiler/rustc_mir/src/transform/check_const_item_mutation.rs", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/dea13632a8e8f90febe3de17c740498285397936/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcheck_const_item_mutation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dea13632a8e8f90febe3de17c740498285397936/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcheck_const_item_mutation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcheck_const_item_mutation.rs?ref=dea13632a8e8f90febe3de17c740498285397936", "patch": "@@ -66,12 +66,14 @@ impl<'a, 'tcx> ConstMutationChecker<'a, 'tcx> {\n         location: Location,\n         decorate: impl for<'b> FnOnce(LintDiagnosticBuilder<'b>) -> DiagnosticBuilder<'b>,\n     ) {\n-        // Don't lint on borrowing/assigning to a dereference\n-        // e.g:\n+        // Don't lint on borrowing/assigning when a dereference is involved.\n+        // If we 'leave' the temporary via a dereference, we must\n+        // be modifying something else\n         //\n         // `unsafe { *FOO = 0; *BAR.field = 1; }`\n         // `unsafe { &mut *FOO }`\n-        if !matches!(place.projection.last(), Some(PlaceElem::Deref)) {\n+        // `unsafe { (*ARRAY)[0] = val; }\n+        if !place.projection.iter().any(|p| matches!(p, PlaceElem::Deref)) {\n             let source_info = self.body.source_info(location);\n             let lint_root = self.body.source_scopes[source_info.scope]\n                 .local_data"}, {"sha": "4bf5e0a9e212a2e38f0627c6e4dc7ca71b001220", "filename": "src/test/ui/lint/lint-const-item-mutation.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/dea13632a8e8f90febe3de17c740498285397936/src%2Ftest%2Fui%2Flint%2Flint-const-item-mutation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dea13632a8e8f90febe3de17c740498285397936/src%2Ftest%2Fui%2Flint%2Flint-const-item-mutation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Flint-const-item-mutation.rs?ref=dea13632a8e8f90febe3de17c740498285397936", "patch": "@@ -30,6 +30,8 @@ const MUTABLE: Mutable = Mutable { msg: \"\" };\n const MUTABLE2: Mutable2 = Mutable2 { msg: \"\", other: String::new() };\n const VEC: Vec<i32> = Vec::new();\n const PTR: *mut () = 1 as *mut _;\n+const PTR_TO_ARRAY: *mut [u32; 4] = 0x12345678 as _;\n+const ARRAY_OF_PTR: [*mut u32; 1] = [1 as *mut _];\n \n fn main() {\n     ARRAY[0] = 5; //~ WARN attempting to modify\n@@ -55,4 +57,10 @@ fn main() {\n     // Test that we don't warn when converting a raw pointer\n     // into a mutable reference\n     unsafe { &mut *PTR };\n+\n+    // Test that we don't warn when there's a dereference involved.\n+    // If we ever 'leave' the const via a deference, we're going\n+    // to end up modifying something other than the temporary\n+    unsafe { (*PTR_TO_ARRAY)[0] = 1 };\n+    unsafe { *ARRAY_OF_PTR[0] = 25; }\n }"}, {"sha": "74505eeb987c6613ad82e514dedfcb5413ab50a2", "filename": "src/test/ui/lint/lint-const-item-mutation.stderr", "status": "modified", "additions": 8, "deletions": 8, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/dea13632a8e8f90febe3de17c740498285397936/src%2Ftest%2Fui%2Flint%2Flint-const-item-mutation.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/dea13632a8e8f90febe3de17c740498285397936/src%2Ftest%2Fui%2Flint%2Flint-const-item-mutation.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Flint-const-item-mutation.stderr?ref=dea13632a8e8f90febe3de17c740498285397936", "patch": "@@ -1,5 +1,5 @@\n warning: attempting to modify a `const` item\n-  --> $DIR/lint-const-item-mutation.rs:35:5\n+  --> $DIR/lint-const-item-mutation.rs:37:5\n    |\n LL |     ARRAY[0] = 5;\n    |     ^^^^^^^^^^^^\n@@ -13,7 +13,7 @@ LL | const ARRAY: [u8; 1] = [25];\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n warning: attempting to modify a `const` item\n-  --> $DIR/lint-const-item-mutation.rs:36:5\n+  --> $DIR/lint-const-item-mutation.rs:38:5\n    |\n LL |     MY_STRUCT.field = false;\n    |     ^^^^^^^^^^^^^^^^^^^^^^^\n@@ -26,7 +26,7 @@ LL | const MY_STRUCT: MyStruct = MyStruct { field: true, inner_array: ['a'], raw\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n warning: attempting to modify a `const` item\n-  --> $DIR/lint-const-item-mutation.rs:37:5\n+  --> $DIR/lint-const-item-mutation.rs:39:5\n    |\n LL |     MY_STRUCT.inner_array[0] = 'b';\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n@@ -39,7 +39,7 @@ LL | const MY_STRUCT: MyStruct = MyStruct { field: true, inner_array: ['a'], raw\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n warning: taking a mutable reference to a `const` item\n-  --> $DIR/lint-const-item-mutation.rs:38:5\n+  --> $DIR/lint-const-item-mutation.rs:40:5\n    |\n LL |     MY_STRUCT.use_mut();\n    |     ^^^^^^^^^^^^^^^^^^^\n@@ -58,7 +58,7 @@ LL | const MY_STRUCT: MyStruct = MyStruct { field: true, inner_array: ['a'], raw\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n warning: taking a mutable reference to a `const` item\n-  --> $DIR/lint-const-item-mutation.rs:39:5\n+  --> $DIR/lint-const-item-mutation.rs:41:5\n    |\n LL |     &mut MY_STRUCT;\n    |     ^^^^^^^^^^^^^^\n@@ -72,7 +72,7 @@ LL | const MY_STRUCT: MyStruct = MyStruct { field: true, inner_array: ['a'], raw\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n warning: taking a mutable reference to a `const` item\n-  --> $DIR/lint-const-item-mutation.rs:40:5\n+  --> $DIR/lint-const-item-mutation.rs:42:5\n    |\n LL |     (&mut MY_STRUCT).use_mut();\n    |     ^^^^^^^^^^^^^^^^\n@@ -86,7 +86,7 @@ LL | const MY_STRUCT: MyStruct = MyStruct { field: true, inner_array: ['a'], raw\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n warning: attempting to modify a `const` item\n-  --> $DIR/lint-const-item-mutation.rs:52:5\n+  --> $DIR/lint-const-item-mutation.rs:54:5\n    |\n LL |     MUTABLE2.msg = \"wow\";\n    |     ^^^^^^^^^^^^^^^^^^^^\n@@ -99,7 +99,7 @@ LL | const MUTABLE2: Mutable2 = Mutable2 { msg: \"\", other: String::new() };\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n warning: taking a mutable reference to a `const` item\n-  --> $DIR/lint-const-item-mutation.rs:53:5\n+  --> $DIR/lint-const-item-mutation.rs:55:5\n    |\n LL |     VEC.push(0);\n    |     ^^^^^^^^^^^"}]}