{"sha": "9a7061dfab73caeea215a99a5d8cca26360fe99e", "node_id": "MDY6Q29tbWl0NzI0NzEyOjlhNzA2MWRmYWI3M2NhZWVhMjE1YTk5YTVkOGNjYTI2MzYwZmU5OWU=", "commit": {"author": {"name": "Marijn Haverbeke", "email": "marijnh@gmail.com", "date": "2012-01-07T19:04:16Z"}, "committer": {"name": "Marijn Haverbeke", "email": "marijnh@gmail.com", "date": "2012-01-08T20:57:54Z"}, "message": "Fix some bad code in the dict interner\n\nIssue #1436", "tree": {"sha": "b41557c5577c0407092d981fb987a74c65825497", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b41557c5577c0407092d981fb987a74c65825497"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9a7061dfab73caeea215a99a5d8cca26360fe99e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9a7061dfab73caeea215a99a5d8cca26360fe99e", "html_url": "https://github.com/rust-lang/rust/commit/9a7061dfab73caeea215a99a5d8cca26360fe99e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9a7061dfab73caeea215a99a5d8cca26360fe99e/comments", "author": {"login": "marijnh", "id": 144427, "node_id": "MDQ6VXNlcjE0NDQyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/144427?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marijnh", "html_url": "https://github.com/marijnh", "followers_url": "https://api.github.com/users/marijnh/followers", "following_url": "https://api.github.com/users/marijnh/following{/other_user}", "gists_url": "https://api.github.com/users/marijnh/gists{/gist_id}", "starred_url": "https://api.github.com/users/marijnh/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marijnh/subscriptions", "organizations_url": "https://api.github.com/users/marijnh/orgs", "repos_url": "https://api.github.com/users/marijnh/repos", "events_url": "https://api.github.com/users/marijnh/events{/privacy}", "received_events_url": "https://api.github.com/users/marijnh/received_events", "type": "User", "site_admin": false}, "committer": {"login": "marijnh", "id": 144427, "node_id": "MDQ6VXNlcjE0NDQyNw==", "avatar_url": "https://avatars.githubusercontent.com/u/144427?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marijnh", "html_url": "https://github.com/marijnh", "followers_url": "https://api.github.com/users/marijnh/followers", "following_url": "https://api.github.com/users/marijnh/following{/other_user}", "gists_url": "https://api.github.com/users/marijnh/gists{/gist_id}", "starred_url": "https://api.github.com/users/marijnh/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marijnh/subscriptions", "organizations_url": "https://api.github.com/users/marijnh/orgs", "repos_url": "https://api.github.com/users/marijnh/repos", "events_url": "https://api.github.com/users/marijnh/events{/privacy}", "received_events_url": "https://api.github.com/users/marijnh/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e3afc78fde5c614995dd4f2c76da160a321c8f5d", "url": "https://api.github.com/repos/rust-lang/rust/commits/e3afc78fde5c614995dd4f2c76da160a321c8f5d", "html_url": "https://github.com/rust-lang/rust/commit/e3afc78fde5c614995dd4f2c76da160a321c8f5d"}], "stats": {"total": 16, "additions": 5, "deletions": 11}, "files": [{"sha": "17e5f34e5343cd04cfe0619191bd41f0139e610d", "filename": "src/rt/rust_crate_cache.cpp", "status": "modified", "additions": 5, "deletions": 10, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/9a7061dfab73caeea215a99a5d8cca26360fe99e/src%2Frt%2Frust_crate_cache.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/9a7061dfab73caeea215a99a5d8cca26360fe99e/src%2Frt%2Frust_crate_cache.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_crate_cache.cpp?ref=9a7061dfab73caeea215a99a5d8cca26360fe99e", "patch": "@@ -48,21 +48,16 @@ rust_crate_cache::get_type_desc(size_t size,\n void**\n rust_crate_cache::get_dict(size_t n_fields, void** dict) {\n     rust_hashable_dict *found = NULL;\n-    uintptr_t key = 0;\n-    for (size_t i = 0; i < n_fields; ++i) key ^= (uintptr_t)dict[i];\n-    size_t keysz = sizeof(uintptr_t);\n-    HASH_FIND(hh, this->dicts, &key, keysz, found);\n-    if (found) { printf(\"found!\\n\"); return &(found->fields[0]); }\n-    printf(\"not found\\n\");\n-    size_t dictsz = n_fields * sizeof(void*);\n+    size_t dictsz = sizeof(void*) * n_fields;\n+    HASH_FIND(hh, this->dicts, dict, dictsz, found);\n+    if (found) return &(found->fields[0]);\n     found = (rust_hashable_dict*)\n-        sched->kernel->malloc(keysz + sizeof(UT_hash_handle) + dictsz,\n+        sched->kernel->malloc(sizeof(UT_hash_handle) + dictsz,\n                               \"crate cache dict\");\n     if (!found) return NULL;\n-    found->key = key;\n     void** retptr = &(found->fields[0]);\n     memcpy(retptr, dict, dictsz);\n-    HASH_ADD(hh, this->dicts, key, keysz, found);\n+    HASH_ADD_KEYPTR(hh, this->dicts, retptr, dictsz, found);\n     return retptr;\n }\n "}, {"sha": "4980264601162b7933387f18156ab950cfc51f41", "filename": "src/rt/rust_scheduler.h", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/9a7061dfab73caeea215a99a5d8cca26360fe99e/src%2Frt%2Frust_scheduler.h", "raw_url": "https://github.com/rust-lang/rust/raw/9a7061dfab73caeea215a99a5d8cca26360fe99e/src%2Frt%2Frust_scheduler.h", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_scheduler.h?ref=9a7061dfab73caeea215a99a5d8cca26360fe99e", "patch": "@@ -12,7 +12,6 @@\n struct rust_scheduler;\n \n struct rust_hashable_dict {\n-    uintptr_t key;\n     UT_hash_handle hh;\n     void* fields[0];\n };"}]}