{"sha": "e552c0d86baebdf594b9cacebbcf5207e57207d5", "node_id": "C_kwDOAAsO6NoAKGU1NTJjMGQ4NmJhZWJkZjU5NGI5Y2FjZWJiY2Y1MjA3ZTU3MjA3ZDU", "commit": {"author": {"name": "David Wood", "email": "david.wood@huawei.com", "date": "2021-10-01T12:41:18Z"}, "committer": {"name": "David Wood", "email": "david.wood@huawei.com", "date": "2021-10-02T20:01:43Z"}, "message": "bootstrap: add config option for nix patching\n\nOn NixOS systems, bootstrap will patch rustc used in bootstrapping after\nchecking `/etc/os-release` (to confirm the current distribution is NixOS).\nHowever, when using Nix on a non-NixOS system, it can be desirable for\nbootstrap to patch rustc. In this commit, a `patch-binaries-for-nix`\noption is added to `config.toml`, which allows for user opt-in to\nbootstrap's Nix patching.\n\nSigned-off-by: David Wood <david.wood@huawei.com>", "tree": {"sha": "e8302f5ed832c07b68454b2a3c31d82f4896a32c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e8302f5ed832c07b68454b2a3c31d82f4896a32c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e552c0d86baebdf594b9cacebbcf5207e57207d5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e552c0d86baebdf594b9cacebbcf5207e57207d5", "html_url": "https://github.com/rust-lang/rust/commit/e552c0d86baebdf594b9cacebbcf5207e57207d5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e552c0d86baebdf594b9cacebbcf5207e57207d5/comments", "author": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "committer": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4e4942dfa66667c0addfff8e0882a59b035d45ca", "url": "https://api.github.com/repos/rust-lang/rust/commits/4e4942dfa66667c0addfff8e0882a59b035d45ca", "html_url": "https://github.com/rust-lang/rust/commit/4e4942dfa66667c0addfff8e0882a59b035d45ca"}], "stats": {"total": 35, "additions": 23, "deletions": 12}, "files": [{"sha": "d811b914d20a156f419c328dfd159a3c6ebe4804", "filename": "config.toml.example", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/e552c0d86baebdf594b9cacebbcf5207e57207d5/config.toml.example", "raw_url": "https://github.com/rust-lang/rust/raw/e552c0d86baebdf594b9cacebbcf5207e57207d5/config.toml.example", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/config.toml.example?ref=e552c0d86baebdf594b9cacebbcf5207e57207d5", "patch": "@@ -313,6 +313,12 @@ changelog-seen = 2\n # this setting's very existence, are all subject to change.)\n #print-step-rusage = false\n \n+# Always patch binaries for usage with Nix toolchains. If `true` then binaries\n+# will be patched unconditionally. If `false` or unset, binaries will be patched\n+# only if the current distribution is NixOS. This option is useful when using\n+# a Nix toolchain on non-NixOS distributions.\n+#patch-binaries-for-nix = false\n+\n # =============================================================================\n # General install configuration options\n # ============================================================================="}, {"sha": "05d7b0f611f72ccf2349fc23e626d1f805ed92c8", "filename": "src/bootstrap/bootstrap.py", "status": "modified", "additions": 16, "deletions": 12, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/e552c0d86baebdf594b9cacebbcf5207e57207d5/src%2Fbootstrap%2Fbootstrap.py", "raw_url": "https://github.com/rust-lang/rust/raw/e552c0d86baebdf594b9cacebbcf5207e57207d5/src%2Fbootstrap%2Fbootstrap.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbootstrap.py?ref=e552c0d86baebdf594b9cacebbcf5207e57207d5", "patch": "@@ -594,19 +594,23 @@ def fix_bin_or_dylib(self, fname):\n         if ostype != \"Linux\":\n             return\n \n-        # Use `/etc/os-release` instead of `/etc/NIXOS`.\n-        # The latter one does not exist on NixOS when using tmpfs as root.\n-        try:\n-            with open(\"/etc/os-release\", \"r\") as f:\n-                if not any(line.strip() == \"ID=nixos\" for line in f):\n-                    return\n-        except FileNotFoundError:\n-            return\n-        if os.path.exists(\"/lib\"):\n-            return\n+        # If the user has asked binaries to be patched for Nix, then\n+        # don't check for NixOS or `/lib`, just continue to the patching.\n+        if self.get_toml('patch-binaries-for-nix', 'build') != 'true':\n+            # Use `/etc/os-release` instead of `/etc/NIXOS`.\n+            # The latter one does not exist on NixOS when using tmpfs as root.\n+            try:\n+                with open(\"/etc/os-release\", \"r\") as f:\n+                    if not any(line.strip() == \"ID=nixos\" for line in f):\n+                        return\n+            except FileNotFoundError:\n+                return\n+            if os.path.exists(\"/lib\"):\n+                return\n \n-        # At this point we're pretty sure the user is running NixOS\n-        nix_os_msg = \"info: you seem to be running NixOS. Attempting to patch\"\n+        # At this point we're pretty sure the user is running NixOS or\n+        # using Nix\n+        nix_os_msg = \"info: you seem to be using Nix. Attempting to patch\"\n         print(nix_os_msg, fname)\n \n         # Only build `.nix-deps` once."}, {"sha": "062820040dc783709198cd92e8098ff04f8a7ca8", "filename": "src/bootstrap/config.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/e552c0d86baebdf594b9cacebbcf5207e57207d5/src%2Fbootstrap%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e552c0d86baebdf594b9cacebbcf5207e57207d5/src%2Fbootstrap%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fconfig.rs?ref=e552c0d86baebdf594b9cacebbcf5207e57207d5", "patch": "@@ -397,6 +397,7 @@ struct Build {\n     install_stage: Option<u32>,\n     dist_stage: Option<u32>,\n     bench_stage: Option<u32>,\n+    patch_binaries_for_nix: Option<bool>,\n }\n \n /// TOML representation of various global install decisions."}]}