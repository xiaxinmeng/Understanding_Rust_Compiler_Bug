{"sha": "0820e31a00c02cdefe2e47a5b6c1df27ad531f69", "node_id": "C_kwDOAAsO6NoAKDA4MjBlMzFhMDBjMDJjZGVmZTJlNDdhNWI2YzFkZjI3YWQ1MzFmNjk", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-04-19T15:54:44Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-04-19T15:54:44Z"}, "message": "Rollup merge of #110541 - jyn514:fix-configure, r=ozkanonur\n\nFix various configure bugs\n\nFixes https://github.com/rust-lang/rust/issues/107050. Fixes https://github.com/rust-lang/rust/issues/108928. Closes https://github.com/rust-lang/rust/pull/108641.\n\nI recommend reading this commit-by-commit to see the commit descriptions, but the code changes are small.\n\nThis also changes the README to suggest `configure` instead of `printf`, as well as a few other cleanups described in the commit message.", "tree": {"sha": "f61ad5139b9eb88c302e6ccac183f3a1b83f5090", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f61ad5139b9eb88c302e6ccac183f3a1b83f5090"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0820e31a00c02cdefe2e47a5b6c1df27ad531f69", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkQA7ECRBK7hj4Ov3rIwAAwMsIAHYoTrGFCXR4XKEx3hLmlW3R\nDyMHQb7+VPRHbSxnNPcPV+HjHUjHq6lwVqK9U7VN/KC+xSMh3xy+vYZD1TiedkdR\nmCb/soVwOwkITpU5GL93+LAZ94UOPqDIQ91l4IEAeHr2rBmr+XYLr+aXftuD7crA\ni5IY6mi9sT7sEKMgekQKM4vkSjCOvh3MIIpVj1Xk/nIAVfFoQfb7R88ObXGzFKKx\naqExrzMndn78Cu4rgx8FgyA6qESuANyL+4cBPCsYXEO6acVc6DLYKpw5+UQJSvy1\nMpDfzSgTfSacC3tj4ZpEL7rtxMclFRsnOWcbkUu41d3K1gFr/6mL+o68Hce3cJw=\n=l42R\n-----END PGP SIGNATURE-----\n", "payload": "tree f61ad5139b9eb88c302e6ccac183f3a1b83f5090\nparent b59658c990557e654fac9fd80902f9d6891a665d\nparent 8a9668d8e8e0f6a6c5657c3c4ec86367816395cf\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1681919684 +0200\ncommitter GitHub <noreply@github.com> 1681919684 +0200\n\nRollup merge of #110541 - jyn514:fix-configure, r=ozkanonur\n\nFix various configure bugs\n\nFixes https://github.com/rust-lang/rust/issues/107050. Fixes https://github.com/rust-lang/rust/issues/108928. Closes https://github.com/rust-lang/rust/pull/108641.\n\nI recommend reading this commit-by-commit to see the commit descriptions, but the code changes are small.\n\nThis also changes the README to suggest `configure` instead of `printf`, as well as a few other cleanups described in the commit message.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0820e31a00c02cdefe2e47a5b6c1df27ad531f69", "html_url": "https://github.com/rust-lang/rust/commit/0820e31a00c02cdefe2e47a5b6c1df27ad531f69", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0820e31a00c02cdefe2e47a5b6c1df27ad531f69/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b59658c990557e654fac9fd80902f9d6891a665d", "url": "https://api.github.com/repos/rust-lang/rust/commits/b59658c990557e654fac9fd80902f9d6891a665d", "html_url": "https://github.com/rust-lang/rust/commit/b59658c990557e654fac9fd80902f9d6891a665d"}, {"sha": "8a9668d8e8e0f6a6c5657c3c4ec86367816395cf", "url": "https://api.github.com/repos/rust-lang/rust/commits/8a9668d8e8e0f6a6c5657c3c4ec86367816395cf", "html_url": "https://github.com/rust-lang/rust/commit/8a9668d8e8e0f6a6c5657c3c4ec86367816395cf"}], "stats": {"total": 63, "additions": 32, "deletions": 31}, "files": [{"sha": "41b135972af11458ebc394377610af743f8731ae", "filename": "README.md", "status": "modified", "additions": 25, "deletions": 26, "changes": 51, "blob_url": "https://github.com/rust-lang/rust/blob/0820e31a00c02cdefe2e47a5b6c1df27ad531f69/README.md", "raw_url": "https://github.com/rust-lang/rust/raw/0820e31a00c02cdefe2e47a5b6c1df27ad531f69/README.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/README.md?ref=0820e31a00c02cdefe2e47a5b6c1df27ad531f69", "patch": "@@ -22,6 +22,8 @@ Read [\"Installation\"] from [The Book].\n \n The Rust build system uses a Python script called `x.py` to build the compiler,\n which manages the bootstrapping process. It lives at the root of the project.\n+It also uses a file named `config.toml` to determine various configuration settings for the build.\n+You can see a full list of options in `config.example.toml`.\n \n The `x.py` command can be run directly on most Unix systems in the following\n format:\n@@ -85,6 +87,8 @@ See [the rustc-dev-guide for more info][sysllvm].\n \n ### Building on a Unix-like system\n \n+#### Build steps\n+\n 1. Clone the [source] with `git`:\n \n    ```sh\n@@ -96,18 +100,13 @@ See [the rustc-dev-guide for more info][sysllvm].\n \n 2. Configure the build settings:\n \n-   The Rust build system uses a file named `config.toml` in the root of the\n-   source tree to determine various configuration settings for the build.\n-   Set up the defaults intended for distros to get started. You can see a full\n-   list of options in `config.example.toml`.\n-\n    ```sh\n-   printf 'profile = \"user\" \\nchangelog-seen = 2 \\n' > config.toml\n+   ./configure\n    ```\n \n    If you plan to use `x.py install` to create an installation, it is\n    recommended that you set the `prefix` value in the `[install]` section to a\n-   directory.\n+   directory: `./configure --set install.prefix=<path>`\n \n 3. Build and install:\n \n@@ -117,12 +116,25 @@ See [the rustc-dev-guide for more info][sysllvm].\n \n    When complete, `./x.py install` will place several programs into\n    `$PREFIX/bin`: `rustc`, the Rust compiler, and `rustdoc`, the\n-   API-documentation tool. If you've set `profile = \"user\"` or\n-   `build.extended = true`, it will also include [Cargo], Rust's package\n-   manager.\n+   API-documentation tool. By default, it will also include [Cargo], Rust's package manager.\n+   You can disable this behavior by passing `--set build.extended=false` to `./configure`.\n \n [Cargo]: https://github.com/rust-lang/cargo\n \n+#### Configure and Make\n+\n+This project provides a configure script and makefile (the latter of which just invokes `x.py`).\n+`./configure` is the recommended way to programatically generate a `config.toml`. `make` is not\n+recommended (we suggest using `x.py` directly), but it is supported and we try not to break it\n+unnecessarily.\n+\n+```sh\n+./configure\n+make && sudo make install\n+```\n+\n+`configure` generates a `config.toml` which can also be used with normal `x.py` invocations.\n+\n ### Building on Windows\n \n On Windows, we suggest using [winget] to install dependencies by running the\n@@ -186,7 +198,7 @@ toolchain.\n 4. Navigate to Rust's source code (or clone it), then build it:\n \n    ```sh\n-   ./x.py build && ./x.py install\n+   python x.py setup user && python x.py build && python x.py install\n    ```\n \n #### MSVC\n@@ -204,6 +216,7 @@ With these dependencies installed, you can build the compiler in a `cmd.exe`\n shell with:\n \n ```sh\n+python x.py setup user\n python x.py build\n ```\n \n@@ -232,21 +245,7 @@ Windows build triples are:\n \n The build triple can be specified by either specifying `--build=<triple>` when\n invoking `x.py` commands, or by creating a `config.toml` file (as described in\n-[Installing from Source](#installing-from-source)), and modifying the `build`\n-option under the `[build]` section.\n-\n-### Configure and Make\n-\n-While it's not the recommended build system, this project also provides a\n-configure script and makefile (the latter of which just invokes `x.py`).\n-\n-```sh\n-./configure\n-make && sudo make install\n-```\n-\n-`configure` generates a `config.toml` which can also be used with normal `x.py`\n-invocations.\n+[Building on a Unix-like system](#building-on-a-unix-like-system)), and passing `--set build.build=<triple>` to `./configure`.\n \n ## Building Documentation\n "}, {"sha": "26bd80a008fb33ab80f0d5db20f0eb64b7db6342", "filename": "src/bootstrap/bootstrap_test.py", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/0820e31a00c02cdefe2e47a5b6c1df27ad531f69/src%2Fbootstrap%2Fbootstrap_test.py", "raw_url": "https://github.com/rust-lang/rust/raw/0820e31a00c02cdefe2e47a5b6c1df27ad531f69/src%2Fbootstrap%2Fbootstrap_test.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbootstrap_test.py?ref=0820e31a00c02cdefe2e47a5b6c1df27ad531f69", "patch": "@@ -97,6 +97,7 @@ def serialize_and_parse(self, args):\n     def test_no_args(self):\n         build = self.serialize_and_parse([])\n         self.assertEqual(build.get_toml(\"changelog-seen\"), '2')\n+        self.assertEqual(build.get_toml(\"profile\"), 'user')\n         self.assertIsNone(build.get_toml(\"llvm.download-ci-llvm\"))\n \n     def test_set_section(self):\n@@ -107,10 +108,9 @@ def test_set_target(self):\n         build = self.serialize_and_parse([\"--set\", \"target.x86_64-unknown-linux-gnu.cc=gcc\"])\n         self.assertEqual(build.get_toml(\"cc\", section=\"target.x86_64-unknown-linux-gnu\"), 'gcc')\n \n-    # Uncomment when #108928 is fixed.\n-    # def test_set_top_level(self):\n-    #     build = self.serialize_and_parse([\"--set\", \"profile=compiler\"])\n-    #     self.assertEqual(build.get_toml(\"profile\"), 'compiler')\n+    def test_set_top_level(self):\n+        build = self.serialize_and_parse([\"--set\", \"profile=compiler\"])\n+        self.assertEqual(build.get_toml(\"profile\"), 'compiler')\n \n if __name__ == '__main__':\n     SUITE = unittest.TestSuite()"}, {"sha": "f95a97518c55fe1fccfb4c032bf19440553367f7", "filename": "src/bootstrap/configure.py", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/0820e31a00c02cdefe2e47a5b6c1df27ad531f69/src%2Fbootstrap%2Fconfigure.py", "raw_url": "https://github.com/rust-lang/rust/raw/0820e31a00c02cdefe2e47a5b6c1df27ad531f69/src%2Fbootstrap%2Fconfigure.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fconfigure.py?ref=0820e31a00c02cdefe2e47a5b6c1df27ad531f69", "patch": "@@ -417,6 +417,8 @@ def parse_example_config(known_args, config):\n         # Avoid using quotes unless it's necessary.\n         targets[target][0] = targets[target][0].replace(\"x86_64-unknown-linux-gnu\", \"'{}'\".format(target) if \".\" in target else target)\n \n+    if 'profile' not in config:\n+        set('profile', 'user', config)\n     configure_file(sections, top_level_keys, targets, config)\n     return section_order, sections, targets\n \n@@ -475,7 +477,7 @@ def configure_section(lines, config):\n def configure_top_level_key(lines, top_level_key, value):\n     for i, line in enumerate(lines):\n         if line.startswith('#' + top_level_key + ' = ') or line.startswith(top_level_key + ' = '):\n-            lines[i] = \"{} = {}\".format(top_level_key, value)\n+            lines[i] = \"{} = {}\".format(top_level_key, to_toml(value))\n             return\n \n     raise RuntimeError(\"failed to find config line for {}\".format(top_level_key))"}]}