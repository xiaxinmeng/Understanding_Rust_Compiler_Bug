{"sha": "326315bf5499d2ff59ebd2bdd0e22576bef25b44", "node_id": "C_kwDOAAsO6NoAKDMyNjMxNWJmNTQ5OWQyZmY1OWViZDJiZGQwZTIyNTc2YmVmMjViNDQ", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-06-04T21:42:00Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-06-04T21:42:00Z"}, "message": "Rollup merge of #97609 - Elliot-Roberts:unused-trait-refactor, r=cjgillot\n\nIterate over `maybe_unused_trait_imports` when checking dead trait imports\n\nCloses #96873\nr? `@cjgillot`\n\nSome questions, if you have time:\n\n- Is there a way to shorten the `rustc_data_structures::fx::FxIndexSet` path in the query declaration? I wasn't sure where to put a `use`.\n- Was returning by reference from the query the right choice here?\n- How would I go about evaluating the importance of the `is_dummy()` call in `check_crate`? I don't see failing tests when I comment it out. Should I just try to determine whether dummy spans can ever be put into `maybe_unused_trait_imports`?\n- Am I doing anything silly with the various ID types?\n- Is that `let-else` with `unreachable!()` bad? (i.e is there a better idiom? Would `panic!(\"<explanation>\")` be better?)\n- If I want to evaluate the perf of using a `Vec` as mentioned in #96873, is the best way to use the CI or is it feasible locally?\n\nThanks :)", "tree": {"sha": "2fc0bfa7884f8a89e3ad1a821da17b4311ca881e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2fc0bfa7884f8a89e3ad1a821da17b4311ca881e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/326315bf5499d2ff59ebd2bdd0e22576bef25b44", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJim9GoCRBK7hj4Ov3rIwAAcjYIAG84U60s/ER9fKtdvmoq9n/f\nPrjQfpD1bsNKUY8XPeGD12igCGzQsdhzsdplO2LWjsPm4KEWG/5TXFO7wsMv/bad\n7anDxNuREJfMvDi6jr/yCITLFVsnlL9cf3VqRN3PK/HxAqT4EOU9fgawpk9QWp8X\nu+TTpQP7LM6xUNQsF5VvsYu8AK/pxrWI3PoaGj1r7rZGwynjx5d83m4AhlUxn5HZ\n4LwysWRlIE/XrYHdRjJSpG5aHvugHMyObE87Zt7GXWS1FAkUV6hkLzi2I+ipq5AD\na8vh0UQUnUr23Dy79Q0MpcdNdZAv4wyagCVVxRdDc7oFKzlyg7p0UPXaQFpISDc=\n=9SDY\n-----END PGP SIGNATURE-----\n", "payload": "tree 2fc0bfa7884f8a89e3ad1a821da17b4311ca881e\nparent 3a8e71385940c2f02ec4b23876c0a36fd09bdefe\nparent 76c6845a8592931edd1e80dbccfd8cbd047e4f2b\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1654378920 +0200\ncommitter GitHub <noreply@github.com> 1654378920 +0200\n\nRollup merge of #97609 - Elliot-Roberts:unused-trait-refactor, r=cjgillot\n\nIterate over `maybe_unused_trait_imports` when checking dead trait imports\n\nCloses #96873\nr? `@cjgillot`\n\nSome questions, if you have time:\n\n- Is there a way to shorten the `rustc_data_structures::fx::FxIndexSet` path in the query declaration? I wasn't sure where to put a `use`.\n- Was returning by reference from the query the right choice here?\n- How would I go about evaluating the importance of the `is_dummy()` call in `check_crate`? I don't see failing tests when I comment it out. Should I just try to determine whether dummy spans can ever be put into `maybe_unused_trait_imports`?\n- Am I doing anything silly with the various ID types?\n- Is that `let-else` with `unreachable!()` bad? (i.e is there a better idiom? Would `panic!(\"<explanation>\")` be better?)\n- If I want to evaluate the perf of using a `Vec` as mentioned in #96873, is the best way to use the CI or is it feasible locally?\n\nThanks :)\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/326315bf5499d2ff59ebd2bdd0e22576bef25b44", "html_url": "https://github.com/rust-lang/rust/commit/326315bf5499d2ff59ebd2bdd0e22576bef25b44", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/326315bf5499d2ff59ebd2bdd0e22576bef25b44/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3a8e71385940c2f02ec4b23876c0a36fd09bdefe", "url": "https://api.github.com/repos/rust-lang/rust/commits/3a8e71385940c2f02ec4b23876c0a36fd09bdefe", "html_url": "https://github.com/rust-lang/rust/commit/3a8e71385940c2f02ec4b23876c0a36fd09bdefe"}, {"sha": "76c6845a8592931edd1e80dbccfd8cbd047e4f2b", "url": "https://api.github.com/repos/rust-lang/rust/commits/76c6845a8592931edd1e80dbccfd8cbd047e4f2b", "html_url": "https://github.com/rust-lang/rust/commit/76c6845a8592931edd1e80dbccfd8cbd047e4f2b"}], "stats": {"total": 74, "additions": 29, "deletions": 45}, "files": [{"sha": "24531e461896be80703ba4101f824f975bfa5281", "filename": "compiler/rustc_middle/src/query/mod.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/326315bf5499d2ff59ebd2bdd0e22576bef25b44/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/326315bf5499d2ff59ebd2bdd0e22576bef25b44/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fquery%2Fmod.rs?ref=326315bf5499d2ff59ebd2bdd0e22576bef25b44", "patch": "@@ -1728,8 +1728,8 @@ rustc_queries! {\n     query upvars_mentioned(def_id: DefId) -> Option<&'tcx FxIndexMap<hir::HirId, hir::Upvar>> {\n         desc { |tcx| \"collecting upvars mentioned in `{}`\", tcx.def_path_str(def_id) }\n     }\n-    query maybe_unused_trait_import(def_id: LocalDefId) -> bool {\n-        desc { |tcx| \"maybe_unused_trait_import for `{}`\", tcx.def_path_str(def_id.to_def_id()) }\n+    query maybe_unused_trait_imports(_: ()) -> &'tcx FxIndexSet<LocalDefId> {\n+        desc { \"fetching potentially unused trait imports\" }\n     }\n     query maybe_unused_extern_crates(_: ()) -> &'tcx [(LocalDefId, Span)] {\n         desc { \"looking up all possibly unused extern crates\" }"}, {"sha": "ac71146303ac2940007b4765dcb3683ba6f0f5f6", "filename": "compiler/rustc_middle/src/ty/context.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/326315bf5499d2ff59ebd2bdd0e22576bef25b44/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/326315bf5499d2ff59ebd2bdd0e22576bef25b44/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fcontext.rs?ref=326315bf5499d2ff59ebd2bdd0e22576bef25b44", "patch": "@@ -2893,8 +2893,8 @@ pub fn provide(providers: &mut ty::query::Providers) {\n         assert_eq!(id, LOCAL_CRATE);\n         tcx.crate_name\n     };\n-    providers.maybe_unused_trait_import =\n-        |tcx, id| tcx.resolutions(()).maybe_unused_trait_imports.contains(&id);\n+    providers.maybe_unused_trait_imports =\n+        |tcx, ()| &tcx.resolutions(()).maybe_unused_trait_imports;\n     providers.maybe_unused_extern_crates =\n         |tcx, ()| &tcx.resolutions(()).maybe_unused_extern_crates[..];\n     providers.names_imported_by_glob_use = |tcx, id| {"}, {"sha": "3a2d3408b9d9365325e793afd223604ccc90ee2c", "filename": "compiler/rustc_middle/src/ty/mod.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/326315bf5499d2ff59ebd2bdd0e22576bef25b44/compiler%2Frustc_middle%2Fsrc%2Fty%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/326315bf5499d2ff59ebd2bdd0e22576bef25b44/compiler%2Frustc_middle%2Fsrc%2Fty%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fmod.rs?ref=326315bf5499d2ff59ebd2bdd0e22576bef25b44", "patch": "@@ -28,7 +28,7 @@ pub use generics::*;\n use rustc_ast as ast;\n use rustc_attr as attr;\n use rustc_data_structures::fingerprint::Fingerprint;\n-use rustc_data_structures::fx::{FxHashMap, FxHashSet, FxIndexMap};\n+use rustc_data_structures::fx::{FxHashMap, FxHashSet, FxIndexMap, FxIndexSet};\n use rustc_data_structures::intern::{Interned, WithStableHash};\n use rustc_data_structures::stable_hasher::{HashStable, StableHasher};\n use rustc_data_structures::tagged_ptr::CopyTaggedPtr;\n@@ -138,7 +138,7 @@ pub struct ResolverOutputs {\n     pub has_pub_restricted: bool,\n     pub access_levels: AccessLevels,\n     pub extern_crate_map: FxHashMap<LocalDefId, CrateNum>,\n-    pub maybe_unused_trait_imports: FxHashSet<LocalDefId>,\n+    pub maybe_unused_trait_imports: FxIndexSet<LocalDefId>,\n     pub maybe_unused_extern_crates: Vec<(LocalDefId, Span)>,\n     pub reexport_map: FxHashMap<LocalDefId, Vec<ModChild>>,\n     pub glob_map: FxHashMap<LocalDefId, FxHashSet<Symbol>>,"}, {"sha": "59794c4d3f0d83adc9814608ef1017efa5bdd185", "filename": "compiler/rustc_middle/src/ty/query.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/326315bf5499d2ff59ebd2bdd0e22576bef25b44/compiler%2Frustc_middle%2Fsrc%2Fty%2Fquery.rs", "raw_url": "https://github.com/rust-lang/rust/raw/326315bf5499d2ff59ebd2bdd0e22576bef25b44/compiler%2Frustc_middle%2Fsrc%2Fty%2Fquery.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fquery.rs?ref=326315bf5499d2ff59ebd2bdd0e22576bef25b44", "patch": "@@ -37,7 +37,7 @@ use crate::ty::{self, AdtSizedConstraint, CrateInherentImpls, ParamEnvAnd, Ty, T\n use rustc_ast as ast;\n use rustc_ast::expand::allocator::AllocatorKind;\n use rustc_attr as attr;\n-use rustc_data_structures::fx::{FxHashMap, FxHashSet, FxIndexMap};\n+use rustc_data_structures::fx::{FxHashMap, FxHashSet, FxIndexMap, FxIndexSet};\n use rustc_data_structures::steal::Steal;\n use rustc_data_structures::svh::Svh;\n use rustc_data_structures::sync::Lrc;"}, {"sha": "49c15d2c9ef1f7be31c42a28a41d95c70b921db1", "filename": "compiler/rustc_resolve/src/lib.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/326315bf5499d2ff59ebd2bdd0e22576bef25b44/compiler%2Frustc_resolve%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/326315bf5499d2ff59ebd2bdd0e22576bef25b44/compiler%2Frustc_resolve%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Flib.rs?ref=326315bf5499d2ff59ebd2bdd0e22576bef25b44", "patch": "@@ -28,7 +28,7 @@ use rustc_ast::node_id::NodeMap;\n use rustc_ast::{self as ast, NodeId, CRATE_NODE_ID};\n use rustc_ast::{AngleBracketedArg, Crate, Expr, ExprKind, GenericArg, GenericArgs, LitKind, Path};\n use rustc_ast_lowering::{LifetimeRes, ResolverAstLowering};\n-use rustc_data_structures::fx::{FxHashMap, FxHashSet, FxIndexMap};\n+use rustc_data_structures::fx::{FxHashMap, FxHashSet, FxIndexMap, FxIndexSet};\n use rustc_data_structures::intern::Interned;\n use rustc_data_structures::sync::Lrc;\n use rustc_errors::{Applicability, DiagnosticBuilder, ErrorGuaranteed};\n@@ -941,7 +941,7 @@ pub struct Resolver<'a> {\n     visibilities: FxHashMap<LocalDefId, ty::Visibility>,\n     has_pub_restricted: bool,\n     used_imports: FxHashSet<NodeId>,\n-    maybe_unused_trait_imports: FxHashSet<LocalDefId>,\n+    maybe_unused_trait_imports: FxIndexSet<LocalDefId>,\n     maybe_unused_extern_crates: Vec<(LocalDefId, Span)>,\n \n     /// Privacy errors are delayed until the end in order to deduplicate them."}, {"sha": "f28184c74d35548518765421a2f957972b580137", "filename": "compiler/rustc_typeck/src/check_unused.rs", "status": "modified", "additions": 20, "deletions": 36, "changes": 56, "blob_url": "https://github.com/rust-lang/rust/blob/326315bf5499d2ff59ebd2bdd0e22576bef25b44/compiler%2Frustc_typeck%2Fsrc%2Fcheck_unused.rs", "raw_url": "https://github.com/rust-lang/rust/raw/326315bf5499d2ff59ebd2bdd0e22576bef25b44/compiler%2Frustc_typeck%2Fsrc%2Fcheck_unused.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck_unused.rs?ref=326315bf5499d2ff59ebd2bdd0e22576bef25b44", "patch": "@@ -16,48 +16,32 @@ pub fn check_crate(tcx: TyCtxt<'_>) {\n         used_trait_imports.extend(imports.iter());\n     }\n \n-    for id in tcx.hir().items() {\n-        if matches!(tcx.def_kind(id.def_id), DefKind::Use) {\n-            if tcx.visibility(id.def_id).is_public() {\n-                continue;\n-            }\n-            let item = tcx.hir().item(id);\n-            if item.span.is_dummy() {\n-                continue;\n-            }\n-            if let hir::ItemKind::Use(path, _) = item.kind {\n-                check_import(tcx, &mut used_trait_imports, item.item_id(), path.span);\n-            }\n+    for &id in tcx.maybe_unused_trait_imports(()) {\n+        debug_assert_eq!(tcx.def_kind(id), DefKind::Use);\n+        if tcx.visibility(id).is_public() {\n+            continue;\n+        }\n+        if used_trait_imports.contains(&id) {\n+            continue;\n         }\n+        let item = tcx.hir().expect_item(id);\n+        if item.span.is_dummy() {\n+            continue;\n+        }\n+        let hir::ItemKind::Use(path, _) = item.kind else { unreachable!() };\n+        tcx.struct_span_lint_hir(lint::builtin::UNUSED_IMPORTS, item.hir_id(), path.span, |lint| {\n+            let msg = if let Ok(snippet) = tcx.sess.source_map().span_to_snippet(path.span) {\n+                format!(\"unused import: `{}`\", snippet)\n+            } else {\n+                \"unused import\".to_owned()\n+            };\n+            lint.build(&msg).emit();\n+        });\n     }\n \n     unused_crates_lint(tcx);\n }\n \n-fn check_import<'tcx>(\n-    tcx: TyCtxt<'tcx>,\n-    used_trait_imports: &mut FxHashSet<LocalDefId>,\n-    item_id: hir::ItemId,\n-    span: Span,\n-) {\n-    if !tcx.maybe_unused_trait_import(item_id.def_id) {\n-        return;\n-    }\n-\n-    if used_trait_imports.contains(&item_id.def_id) {\n-        return;\n-    }\n-\n-    tcx.struct_span_lint_hir(lint::builtin::UNUSED_IMPORTS, item_id.hir_id(), span, |lint| {\n-        let msg = if let Ok(snippet) = tcx.sess.source_map().span_to_snippet(span) {\n-            format!(\"unused import: `{}`\", snippet)\n-        } else {\n-            \"unused import\".to_owned()\n-        };\n-        lint.build(&msg).emit();\n-    });\n-}\n-\n fn unused_crates_lint(tcx: TyCtxt<'_>) {\n     let lint = lint::builtin::UNUSED_EXTERN_CRATES;\n "}]}