{"sha": "2efa31b2d9bf171fecd294b8e0126d8ffdb453e3", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJlZmEzMWIyZDliZjE3MWZlY2QyOTRiOGUwMTI2ZDhmZmRiNDUzZTM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-02-01T23:43:34Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-02-01T23:43:34Z"}, "message": "Auto merge of #57937 - denzp:nvptx, r=nagisa\n\nNVPTX target specification\n\nThis change adds a built-in `nvptx64-nvidia-cuda` GPGPU no-std target specification and a basic PTX assembly smoke tests.\n\nThe approach is taken here and the target spec is based on `ptx-linker`, a project started about 1.5 years ago. Key feature: bitcode object files being linked with LTO into the final module on the linker's side.\n\nPrior to this change, the linker used a `ld` linker-flavor, but I think, having the special CLI convention is a more reliable way.\n\nQuestions about further progress on reliable CUDA workflow with Rust:\n1. Is it possible to create a test suite `codegen-asm` to verify end-to-end integration with LLVM backend?\n1. How would it be better to organise no-std `compile-fail` tests: add `#![no_std]` where possible and mark others as `ignore-nvptx` directive, or alternatively, introduce `compile-fail-no-std` test suite?\n1. Can we have the `ptx-linker` eventually be integrated as `rls` or `clippy`? Hopefully, this should allow to statically link against LLVM used in Rust and get rid of the [current hacky solution](https://github.com/denzp/rustc-llvm-proxy).\n1. Am I missing some methods from `rustc_codegen_ssa::back::linker::Linker` that can be useful for bitcode-only linking?\n\nCurrently, there are no major public CUDA projects written in Rust I'm aware of, but I'm expecting to have a built-in target will create a solid foundation for further experiments and awesome crates.\n\nRelated to #38789\nFixes #38787\nFixes #38786", "tree": {"sha": "a7be085de514ca23d9b4737697eb4aec45092460", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a7be085de514ca23d9b4737697eb4aec45092460"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3", "html_url": "https://github.com/rust-lang/rust/commit/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "852701ad6df90f4e4cdb11d487373f026f38e5b3", "url": "https://api.github.com/repos/rust-lang/rust/commits/852701ad6df90f4e4cdb11d487373f026f38e5b3", "html_url": "https://github.com/rust-lang/rust/commit/852701ad6df90f4e4cdb11d487373f026f38e5b3"}, {"sha": "49931fda56dc6268ba3c104b64768f551cfc4636", "url": "https://api.github.com/repos/rust-lang/rust/commits/49931fda56dc6268ba3c104b64768f551cfc4636", "html_url": "https://github.com/rust-lang/rust/commit/49931fda56dc6268ba3c104b64768f551cfc4636"}], "stats": {"total": 544, "additions": 483, "deletions": 61}, "files": [{"sha": "7985b6c0e191f770815fc37d4ee7a7f4ce154020", "filename": ".travis.yml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/.travis.yml", "raw_url": "https://github.com/rust-lang/rust/raw/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/.travis.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.travis.yml?ref=2efa31b2d9bf171fecd294b8e0126d8ffdb453e3", "patch": "@@ -168,7 +168,7 @@ matrix:\n       if: branch = auto\n     - env: IMAGE=i686-gnu-nopt\n       if: branch = auto\n-    - env: IMAGE=wasm32-unknown\n+    - env: IMAGE=test-various\n       if: branch = auto\n     - env: IMAGE=x86_64-gnu\n       if: branch = auto"}, {"sha": "1aa2e116a5a6456865cf4e031424b97a1e0dc4a6", "filename": "src/bootstrap/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/src%2Fbootstrap%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/src%2Fbootstrap%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Flib.rs?ref=2efa31b2d9bf171fecd294b8e0126d8ffdb453e3", "patch": "@@ -831,6 +831,7 @@ impl Build {\n                   !target.contains(\"msvc\") &&\n                   !target.contains(\"emscripten\") &&\n                   !target.contains(\"wasm32\") &&\n+                  !target.contains(\"nvptx\") &&\n                   !target.contains(\"fuchsia\") {\n             Some(self.cc(target))\n         } else {"}, {"sha": "ff4fb85bbfad335b4a7d41b8e1bba4a41f36e40c", "filename": "src/bootstrap/sanity.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/src%2Fbootstrap%2Fsanity.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/src%2Fbootstrap%2Fsanity.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fsanity.rs?ref=2efa31b2d9bf171fecd294b8e0126d8ffdb453e3", "patch": "@@ -156,7 +156,7 @@ pub fn check(build: &mut Build) {\n             panic!(\"the iOS target is only supported on macOS\");\n         }\n \n-        if target.contains(\"-none-\") {\n+        if target.contains(\"-none-\") || target.contains(\"nvptx\") {\n             if build.no_std(*target).is_none() {\n                 let target = build.config.target_config.entry(target.clone())\n                     .or_default();\n@@ -165,7 +165,7 @@ pub fn check(build: &mut Build) {\n             }\n \n             if build.no_std(*target) == Some(false) {\n-                panic!(\"All the *-none-* targets are no-std targets\")\n+                panic!(\"All the *-none-* and nvptx* targets are no-std targets\")\n             }\n         }\n "}, {"sha": "e2710a18bdae3e1720e41779eed95244a3c3dea7", "filename": "src/ci/docker/dist-various-2/Dockerfile", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/src%2Fci%2Fdocker%2Fdist-various-2%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/src%2Fci%2Fdocker%2Fdist-various-2%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fdist-various-2%2FDockerfile?ref=2efa31b2d9bf171fecd294b8e0126d8ffdb453e3", "patch": "@@ -70,6 +70,7 @@ ENV TARGETS=$TARGETS,x86_64-sun-solaris\n ENV TARGETS=$TARGETS,x86_64-unknown-linux-gnux32\n ENV TARGETS=$TARGETS,x86_64-unknown-cloudabi\n ENV TARGETS=$TARGETS,x86_64-fortanix-unknown-sgx\n+ENV TARGETS=$TARGETS,nvptx64-nvidia-cuda\n \n ENV X86_FORTANIX_SGX_LIBS=\"/x86_64-fortanix-unknown-sgx/lib/\"\n "}, {"sha": "6c419e13c9f0528410c9c688b64cfef746ea76c3", "filename": "src/ci/docker/test-various/Dockerfile", "status": "renamed", "additions": 14, "deletions": 5, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/src%2Fci%2Fdocker%2Ftest-various%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/src%2Fci%2Fdocker%2Ftest-various%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Ftest-various%2FDockerfile?ref=2efa31b2d9bf171fecd294b8e0126d8ffdb453e3", "patch": "@@ -13,14 +13,16 @@ RUN apt-get update && apt-get install -y --no-install-recommends \\\n   gdb \\\n   xz-utils\n \n+# FIXME: build the `ptx-linker` instead.\n+RUN curl -sL https://github.com/denzp/rust-ptx-linker/releases/download/v0.9.0-alpha.2/rust-ptx-linker.linux64.tar.gz | \\\n+  tar -xzvC /usr/bin\n+\n RUN curl -sL https://nodejs.org/dist/v9.2.0/node-v9.2.0-linux-x64.tar.xz | \\\n-    tar -xJ\n+  tar -xJ\n \n COPY scripts/sccache.sh /scripts/\n RUN sh /scripts/sccache.sh\n \n-ENV TARGETS=wasm32-unknown-unknown\n-\n ENV RUST_CONFIGURE_ARGS \\\n   --set build.nodejs=/node-v9.2.0-linux-x64/bin/node \\\n   --set rust.lld\n@@ -31,11 +33,18 @@ ENV RUST_CONFIGURE_ARGS \\\n # other contexts as well\n ENV NO_DEBUG_ASSERTIONS=1\n \n-ENV SCRIPT python2.7 /checkout/x.py test --target $TARGETS \\\n+ENV WASM_TARGETS=wasm32-unknown-unknown\n+ENV WASM_SCRIPT python2.7 /checkout/x.py test --target $WASM_TARGETS \\\n   src/test/run-make \\\n   src/test/ui \\\n   src/test/run-pass \\\n   src/test/compile-fail \\\n   src/test/mir-opt \\\n   src/test/codegen-units \\\n-  src/libcore \\\n+  src/libcore\n+\n+ENV NVPTX_TARGETS=nvptx64-nvidia-cuda\n+ENV NVPTX_SCRIPT python2.7 /checkout/x.py test --target $NVPTX_TARGETS \\\n+  src/test/run-make\n+\n+ENV SCRIPT $WASM_SCRIPT && $NVPTX_SCRIPT", "previous_filename": "src/ci/docker/wasm32-unknown/Dockerfile"}, {"sha": "b379b5ba024941b1cdd63f65ab8064f811a4e515", "filename": "src/librustc/ty/context.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/src%2Flibrustc%2Fty%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/src%2Flibrustc%2Fty%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fcontext.rs?ref=2efa31b2d9bf171fecd294b8e0126d8ffdb453e3", "patch": "@@ -1675,6 +1675,12 @@ impl<'a, 'gcx, 'tcx> TyCtxt<'a, 'gcx, 'tcx> {\n         }\n         false\n     }\n+\n+    /// Determine whether identifiers in the assembly have strict naming rules.\n+    /// Currently, only NVPTX* targets need it.\n+    pub fn has_strict_asm_symbol_naming(&self) -> bool {\n+        self.gcx.sess.target.target.arch.contains(\"nvptx\")\n+    }\n }\n \n impl<'a, 'tcx> TyCtxt<'a, 'tcx, 'tcx> {"}, {"sha": "2a5ecf9a0593ff400a301a73c6e15371b8b1ee32", "filename": "src/librustc_codegen_ssa/back/link.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/src%2Flibrustc_codegen_ssa%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/src%2Flibrustc_codegen_ssa%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fback%2Flink.rs?ref=2efa31b2d9bf171fecd294b8e0126d8ffdb453e3", "patch": "@@ -149,6 +149,7 @@ pub fn linker_and_flavor(sess: &Session) -> (PathBuf, LinkerFlavor) {\n                 LinkerFlavor::Ld => \"ld\",\n                 LinkerFlavor::Msvc => \"link.exe\",\n                 LinkerFlavor::Lld(_) => \"lld\",\n+                LinkerFlavor::PtxLinker => \"rust-ptx-linker\",\n             }), flavor)),\n             (Some(linker), None) => {\n                 let stem = if linker.extension().and_then(|ext| ext.to_str()) == Some(\"exe\") {"}, {"sha": "249715a7b6e26210741661766606297d568fbea5", "filename": "src/librustc_codegen_ssa/back/linker.rs", "status": "modified", "additions": 131, "deletions": 1, "changes": 132, "blob_url": "https://github.com/rust-lang/rust/blob/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/src%2Flibrustc_codegen_ssa%2Fback%2Flinker.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/src%2Flibrustc_codegen_ssa%2Fback%2Flinker.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fback%2Flinker.rs?ref=2efa31b2d9bf171fecd294b8e0126d8ffdb453e3", "patch": "@@ -13,7 +13,7 @@ use rustc::hir::def_id::{LOCAL_CRATE, CrateNum};\n use rustc::middle::dependency_format::Linkage;\n use rustc::session::Session;\n use rustc::session::config::{self, CrateType, OptLevel, DebugInfo,\n-                             CrossLangLto};\n+                             CrossLangLto, Lto};\n use rustc::ty::TyCtxt;\n use rustc_target::spec::{LinkerFlavor, LldFlavor};\n use serialize::{json, Encoder};\n@@ -83,6 +83,10 @@ impl LinkerInfo {\n             LinkerFlavor::Lld(LldFlavor::Wasm) => {\n                 Box::new(WasmLd::new(cmd, sess, self)) as Box<dyn Linker>\n             }\n+\n+            LinkerFlavor::PtxLinker => {\n+                Box::new(PtxLinker { cmd, sess }) as Box<dyn Linker>\n+            }\n         }\n     }\n }\n@@ -1080,3 +1084,129 @@ fn exported_symbols(tcx: TyCtxt, crate_type: CrateType) -> Vec<String> {\n \n     symbols\n }\n+\n+/// Much simplified and explicit CLI for the NVPTX linker. The linker operates\n+/// with bitcode and uses LLVM backend to generate a PTX assembly.\n+pub struct PtxLinker<'a> {\n+    cmd: Command,\n+    sess: &'a Session,\n+}\n+\n+impl<'a> Linker for PtxLinker<'a> {\n+    fn link_rlib(&mut self, path: &Path) {\n+        self.cmd.arg(\"--rlib\").arg(path);\n+    }\n+\n+    fn link_whole_rlib(&mut self, path: &Path) {\n+        self.cmd.arg(\"--rlib\").arg(path);\n+    }\n+\n+    fn include_path(&mut self, path: &Path) {\n+        self.cmd.arg(\"-L\").arg(path);\n+    }\n+\n+    fn debuginfo(&mut self) {\n+        self.cmd.arg(\"--debug\");\n+    }\n+\n+    fn add_object(&mut self, path: &Path) {\n+        self.cmd.arg(\"--bitcode\").arg(path);\n+    }\n+\n+    fn args(&mut self, args: &[String]) {\n+        self.cmd.args(args);\n+    }\n+\n+    fn optimize(&mut self) {\n+        match self.sess.lto() {\n+            Lto::Thin | Lto::Fat | Lto::ThinLocal => {\n+                self.cmd.arg(\"-Olto\");\n+            },\n+\n+            Lto::No => { },\n+        };\n+    }\n+\n+    fn output_filename(&mut self, path: &Path) {\n+        self.cmd.arg(\"-o\").arg(path);\n+    }\n+\n+    fn finalize(&mut self) -> Command {\n+        // Provide the linker with fallback to internal `target-cpu`.\n+        self.cmd.arg(\"--fallback-arch\").arg(match self.sess.opts.cg.target_cpu {\n+            Some(ref s) => s,\n+            None => &self.sess.target.target.options.cpu\n+        });\n+\n+        ::std::mem::replace(&mut self.cmd, Command::new(\"\"))\n+    }\n+\n+    fn link_dylib(&mut self, _lib: &str) {\n+        panic!(\"external dylibs not supported\")\n+    }\n+\n+    fn link_rust_dylib(&mut self, _lib: &str, _path: &Path) {\n+        panic!(\"external dylibs not supported\")\n+    }\n+\n+    fn link_staticlib(&mut self, _lib: &str) {\n+        panic!(\"staticlibs not supported\")\n+    }\n+\n+    fn link_whole_staticlib(&mut self, _lib: &str, _search_path: &[PathBuf]) {\n+        panic!(\"staticlibs not supported\")\n+    }\n+\n+    fn framework_path(&mut self, _path: &Path) {\n+        panic!(\"frameworks not supported\")\n+    }\n+\n+    fn link_framework(&mut self, _framework: &str) {\n+        panic!(\"frameworks not supported\")\n+    }\n+\n+    fn position_independent_executable(&mut self) {\n+    }\n+\n+    fn full_relro(&mut self) {\n+    }\n+\n+    fn partial_relro(&mut self) {\n+    }\n+\n+    fn no_relro(&mut self) {\n+    }\n+\n+    fn build_static_executable(&mut self) {\n+    }\n+\n+    fn gc_sections(&mut self, _keep_metadata: bool) {\n+    }\n+\n+    fn pgo_gen(&mut self) {\n+    }\n+\n+    fn no_default_libraries(&mut self) {\n+    }\n+\n+    fn build_dylib(&mut self, _out_filename: &Path) {\n+    }\n+\n+    fn export_symbols(&mut self, _tmpdir: &Path, _crate_type: CrateType) {\n+    }\n+\n+    fn subsystem(&mut self, _subsystem: &str) {\n+    }\n+\n+    fn no_position_independent_executable(&mut self) {\n+    }\n+\n+    fn group_start(&mut self) {\n+    }\n+\n+    fn group_end(&mut self) {\n+    }\n+\n+    fn cross_lang_lto(&mut self) {\n+    }\n+}"}, {"sha": "8e96f98540117cfd0dc7eeead57b0ff34e8c753f", "filename": "src/librustc_codegen_utils/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/src%2Flibrustc_codegen_utils%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/src%2Flibrustc_codegen_utils%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_utils%2Flib.rs?ref=2efa31b2d9bf171fecd294b8e0126d8ffdb453e3", "patch": "@@ -12,6 +12,7 @@\n #![feature(nll)]\n #![allow(unused_attributes)]\n #![feature(rustc_diagnostic_macros)]\n+#![feature(in_band_lifetimes)]\n \n #![recursion_limit=\"256\"]\n "}, {"sha": "3238a0b10bfd6d40fcb939f83b989db7e451466e", "filename": "src/librustc_codegen_utils/symbol_names.rs", "status": "modified", "additions": 75, "deletions": 52, "changes": 127, "blob_url": "https://github.com/rust-lang/rust/blob/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/src%2Flibrustc_codegen_utils%2Fsymbol_names.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/src%2Flibrustc_codegen_utils%2Fsymbol_names.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_utils%2Fsymbol_names.rs?ref=2efa31b2d9bf171fecd294b8e0126d8ffdb453e3", "patch": "@@ -221,7 +221,7 @@ fn get_symbol_hash<'a, 'tcx>(\n }\n \n fn def_symbol_name<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>, def_id: DefId) -> ty::SymbolName {\n-    let mut buffer = SymbolPathBuffer::new();\n+    let mut buffer = SymbolPathBuffer::new(tcx);\n     item_path::with_forced_absolute_paths(|| {\n         tcx.push_item_path(&mut buffer, def_id, false);\n     });\n@@ -317,7 +317,7 @@ fn compute_symbol_name<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>, instance: Instance\n \n     let hash = get_symbol_hash(tcx, def_id, instance, instance_ty, substs);\n \n-    let mut buf = SymbolPathBuffer::from_interned(tcx.def_symbol_name(def_id));\n+    let mut buf = SymbolPathBuffer::from_interned(tcx.def_symbol_name(def_id), tcx);\n \n     if instance.is_vtable_shim() {\n         buf.push(\"{{vtable-shim}}\");\n@@ -343,22 +343,25 @@ fn compute_symbol_name<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>, instance: Instance\n struct SymbolPathBuffer {\n     result: String,\n     temp_buf: String,\n+    strict_naming: bool,\n }\n \n impl SymbolPathBuffer {\n-    fn new() -> Self {\n+    fn new(tcx: TyCtxt<'_, '_, '_>) -> Self {\n         let mut result = SymbolPathBuffer {\n             result: String::with_capacity(64),\n             temp_buf: String::with_capacity(16),\n+            strict_naming: tcx.has_strict_asm_symbol_naming(),\n         };\n         result.result.push_str(\"_ZN\"); // _Z == Begin name-sequence, N == nested\n         result\n     }\n \n-    fn from_interned(symbol: ty::SymbolName) -> Self {\n+    fn from_interned(symbol: ty::SymbolName, tcx: TyCtxt<'_, '_, '_>) -> Self {\n         let mut result = SymbolPathBuffer {\n             result: String::with_capacity(64),\n             temp_buf: String::with_capacity(16),\n+            strict_naming: tcx.has_strict_asm_symbol_naming(),\n         };\n         result.result.push_str(&symbol.as_str());\n         result\n@@ -375,68 +378,88 @@ impl SymbolPathBuffer {\n         let _ = write!(self.result, \"17h{:016x}E\", hash);\n         self.result\n     }\n-}\n \n-impl ItemPathBuffer for SymbolPathBuffer {\n-    fn root_mode(&self) -> &RootMode {\n-        const ABSOLUTE: &RootMode = &RootMode::Absolute;\n-        ABSOLUTE\n-    }\n-\n-    fn push(&mut self, text: &str) {\n+    // Name sanitation. LLVM will happily accept identifiers with weird names, but\n+    // gas doesn't!\n+    // gas accepts the following characters in symbols: a-z, A-Z, 0-9, ., _, $\n+    // NVPTX assembly has more strict naming rules than gas, so additionally, dots\n+    // are replaced with '$' there.\n+    fn sanitize_and_append(&mut self, s: &str) {\n         self.temp_buf.clear();\n-        let need_underscore = sanitize(&mut self.temp_buf, text);\n+\n+        for c in s.chars() {\n+            match c {\n+                // Escape these with $ sequences\n+                '@' => self.temp_buf.push_str(\"$SP$\"),\n+                '*' => self.temp_buf.push_str(\"$BP$\"),\n+                '&' => self.temp_buf.push_str(\"$RF$\"),\n+                '<' => self.temp_buf.push_str(\"$LT$\"),\n+                '>' => self.temp_buf.push_str(\"$GT$\"),\n+                '(' => self.temp_buf.push_str(\"$LP$\"),\n+                ')' => self.temp_buf.push_str(\"$RP$\"),\n+                ',' => self.temp_buf.push_str(\"$C$\"),\n+\n+                '-' | ':' => if self.strict_naming {\n+                    // NVPTX doesn't support these characters in symbol names.\n+                    self.temp_buf.push('$')\n+                }\n+                else {\n+                    // '.' doesn't occur in types and functions, so reuse it\n+                    // for ':' and '-'\n+                    self.temp_buf.push('.')\n+                },\n+\n+                '.' => if self.strict_naming {\n+                    self.temp_buf.push('$')\n+                }\n+                else {\n+                    self.temp_buf.push('.')\n+                },\n+\n+                // These are legal symbols\n+                'a'..='z' | 'A'..='Z' | '0'..='9' | '_' | '$' => self.temp_buf.push(c),\n+\n+                _ => {\n+                    self.temp_buf.push('$');\n+                    for c in c.escape_unicode().skip(1) {\n+                        match c {\n+                            '{' => {}\n+                            '}' => self.temp_buf.push('$'),\n+                            c => self.temp_buf.push(c),\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+\n+        let need_underscore = {\n+            // Underscore-qualify anything that didn't start as an ident.\n+            !self.temp_buf.is_empty()\n+                && self.temp_buf.as_bytes()[0] != '_' as u8\n+                && !(self.temp_buf.as_bytes()[0] as char).is_xid_start()\n+        };\n+\n         let _ = write!(\n             self.result,\n             \"{}\",\n             self.temp_buf.len() + (need_underscore as usize)\n         );\n+\n         if need_underscore {\n             self.result.push('_');\n         }\n+\n         self.result.push_str(&self.temp_buf);\n     }\n }\n \n-// Name sanitation. LLVM will happily accept identifiers with weird names, but\n-// gas doesn't!\n-// gas accepts the following characters in symbols: a-z, A-Z, 0-9, ., _, $\n-//\n-// returns true if an underscore must be added at the start\n-pub fn sanitize(result: &mut String, s: &str) -> bool {\n-    for c in s.chars() {\n-        match c {\n-            // Escape these with $ sequences\n-            '@' => result.push_str(\"$SP$\"),\n-            '*' => result.push_str(\"$BP$\"),\n-            '&' => result.push_str(\"$RF$\"),\n-            '<' => result.push_str(\"$LT$\"),\n-            '>' => result.push_str(\"$GT$\"),\n-            '(' => result.push_str(\"$LP$\"),\n-            ')' => result.push_str(\"$RP$\"),\n-            ',' => result.push_str(\"$C$\"),\n-\n-            // '.' doesn't occur in types and functions, so reuse it\n-            // for ':' and '-'\n-            '-' | ':' => result.push('.'),\n-\n-            // These are legal symbols\n-            'a'..='z' | 'A'..='Z' | '0'..='9' | '_' | '.' | '$' => result.push(c),\n-\n-            _ => {\n-                result.push('$');\n-                for c in c.escape_unicode().skip(1) {\n-                    match c {\n-                        '{' => {}\n-                        '}' => result.push('$'),\n-                        c => result.push(c),\n-                    }\n-                }\n-            }\n-        }\n+impl ItemPathBuffer for SymbolPathBuffer {\n+    fn root_mode(&self) -> &RootMode {\n+        const ABSOLUTE: &RootMode = &RootMode::Absolute;\n+        ABSOLUTE\n     }\n \n-    // Underscore-qualify anything that didn't start as an ident.\n-    !result.is_empty() && result.as_bytes()[0] != '_' as u8\n-        && !(result.as_bytes()[0] as char).is_xid_start()\n+    fn push(&mut self, text: &str) {\n+        self.sanitize_and_append(text);\n+    }\n }"}, {"sha": "aeecce49b0c67689c1e07638e288581ebc4d04fa", "filename": "src/librustc_target/spec/mod.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/src%2Flibrustc_target%2Fspec%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/src%2Flibrustc_target%2Fspec%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_target%2Fspec%2Fmod.rs?ref=2efa31b2d9bf171fecd294b8e0126d8ffdb453e3", "patch": "@@ -75,6 +75,7 @@ pub enum LinkerFlavor {\n     Ld,\n     Msvc,\n     Lld(LldFlavor),\n+    PtxLinker,\n }\n \n #[derive(Clone, Copy, Debug, Eq, Ord, PartialEq, PartialOrd, Hash,\n@@ -143,6 +144,7 @@ flavor_mappings! {\n     ((LinkerFlavor::Gcc), \"gcc\"),\n     ((LinkerFlavor::Ld), \"ld\"),\n     ((LinkerFlavor::Msvc), \"msvc\"),\n+    ((LinkerFlavor::PtxLinker), \"ptx-linker\"),\n     ((LinkerFlavor::Lld(LldFlavor::Wasm)), \"wasm-ld\"),\n     ((LinkerFlavor::Lld(LldFlavor::Ld64)), \"ld64.lld\"),\n     ((LinkerFlavor::Lld(LldFlavor::Ld)), \"ld.lld\"),\n@@ -455,6 +457,8 @@ supported_targets! {\n     (\"x86_64-fortanix-unknown-sgx\", x86_64_fortanix_unknown_sgx),\n \n     (\"x86_64-unknown-uefi\", x86_64_unknown_uefi),\n+\n+    (\"nvptx64-nvidia-cuda\", nvptx64_nvidia_cuda),\n }\n \n /// Everything `rustc` knows about how to compile for a specific target."}, {"sha": "e8512415e66a3c9c6f969ee7b2339865f4b7e482", "filename": "src/librustc_target/spec/nvptx64_nvidia_cuda.rs", "status": "added", "additions": 73, "deletions": 0, "changes": 73, "blob_url": "https://github.com/rust-lang/rust/blob/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/src%2Flibrustc_target%2Fspec%2Fnvptx64_nvidia_cuda.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/src%2Flibrustc_target%2Fspec%2Fnvptx64_nvidia_cuda.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_target%2Fspec%2Fnvptx64_nvidia_cuda.rs?ref=2efa31b2d9bf171fecd294b8e0126d8ffdb453e3", "patch": "@@ -0,0 +1,73 @@\n+use spec::{LinkerFlavor, Target, TargetOptions, TargetResult, PanicStrategy, MergeFunctions};\n+use spec::abi::Abi;\n+\n+pub fn target() -> TargetResult {\n+    Ok(Target {\n+        arch: \"nvptx64\".to_string(),\n+        data_layout: \"e-i64:64-i128:128-v16:16-v32:32-n16:32:64\".to_string(),\n+        llvm_target: \"nvptx64-nvidia-cuda\".to_string(),\n+\n+        target_os: \"cuda\".to_string(),\n+        target_vendor: \"nvidia\".to_string(),\n+        target_env: String::new(),\n+\n+        linker_flavor: LinkerFlavor::PtxLinker,\n+\n+        target_endian: \"little\".to_string(),\n+        target_pointer_width: \"64\".to_string(),\n+        target_c_int_width: \"32\".to_string(),\n+\n+        options: TargetOptions {\n+            // The linker can be installed from `crates.io`.\n+            linker: Some(\"rust-ptx-linker\".to_string()),\n+\n+            // With `ptx-linker` approach, it can be later overriden via link flags.\n+            cpu: \"sm_30\".to_string(),\n+\n+            // FIXME: create tests for the atomics.\n+            max_atomic_width: Some(64),\n+\n+            // Unwinding on CUDA is neither feasible nor useful.\n+            panic_strategy: PanicStrategy::Abort,\n+\n+            // Needed to use `dylib` and `bin` crate types and the linker.\n+            dynamic_linking: true,\n+            executables: true,\n+\n+            // Avoid using dylib because it contain metadata not supported\n+            // by LLVM NVPTX backend.\n+            only_cdylib: true,\n+\n+            // Let the `ptx-linker` to handle LLVM lowering into MC / assembly.\n+            obj_is_bitcode: true,\n+\n+            // Convinient and predicable naming scheme.\n+            dll_prefix: \"\".to_string(),\n+            dll_suffix: \".ptx\".to_string(),\n+            exe_suffix: \".ptx\".to_string(),\n+\n+            // Disable MergeFunctions LLVM optimisation pass because it can\n+            // produce kernel functions that call other kernel functions.\n+            // This behavior is not supported by PTX ISA.\n+            merge_functions: MergeFunctions::Disabled,\n+\n+            // FIXME: enable compilation tests for the target and\n+            // create the tests for this.\n+            abi_blacklist: vec![\n+                Abi::Cdecl,\n+                Abi::Stdcall,\n+                Abi::Fastcall,\n+                Abi::Vectorcall,\n+                Abi::Thiscall,\n+                Abi::Aapcs,\n+                Abi::Win64,\n+                Abi::SysV64,\n+                Abi::Msp430Interrupt,\n+                Abi::X86Interrupt,\n+                Abi::AmdGpuKernel,\n+            ],\n+\n+            .. Default::default()\n+        },\n+    })\n+}"}, {"sha": "2c211b5c7850794d389c9c2c36d7bc7793caa68d", "filename": "src/test/run-make/nvptx-binary-crate/Makefile", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/src%2Ftest%2Frun-make%2Fnvptx-binary-crate%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/src%2Ftest%2Frun-make%2Fnvptx-binary-crate%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fnvptx-binary-crate%2FMakefile?ref=2efa31b2d9bf171fecd294b8e0126d8ffdb453e3", "patch": "@@ -0,0 +1,12 @@\n+-include ../../run-make-fulldeps/tools.mk\n+\n+ifeq ($(TARGET),nvptx64-nvidia-cuda)\n+all:\n+\t$(RUSTC) main.rs --crate-type=\"bin\" --target $(TARGET) -O -C link-arg=--arch=sm_60 -o $(TMPDIR)/main.link_arg.ptx\n+\t$(RUSTC) main.rs --crate-type=\"bin\" --target $(TARGET) -O -C target-cpu=sm_60 -o $(TMPDIR)/main.target_cpu.ptx\n+\n+\tFileCheck main.rs --input-file $(TMPDIR)/main.link_arg.ptx\n+\tFileCheck main.rs --input-file $(TMPDIR)/main.target_cpu.ptx\n+else\n+all:\n+endif"}, {"sha": "826bc3a47bbd633df852443dcb2d5adf7cc7c6ad", "filename": "src/test/run-make/nvptx-binary-crate/main.rs", "status": "added", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/src%2Ftest%2Frun-make%2Fnvptx-binary-crate%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/src%2Ftest%2Frun-make%2Fnvptx-binary-crate%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fnvptx-binary-crate%2Fmain.rs?ref=2efa31b2d9bf171fecd294b8e0126d8ffdb453e3", "patch": "@@ -0,0 +1,28 @@\n+#![no_std]\n+#![no_main]\n+#![deny(warnings)]\n+#![feature(abi_ptx, core_intrinsics)]\n+\n+// Check the overriden CUDA arch.\n+// CHECK: .target sm_60\n+// CHECK: .address_size 64\n+\n+// Verify that no extra function declarations are present.\n+// CHECK-NOT: .func\n+\n+// CHECK-LABEL: .visible .entry top_kernel(\n+#[no_mangle]\n+pub unsafe extern \"ptx-kernel\" fn top_kernel(a: *const u32, b: *mut u32) {\n+    // CHECK: add.s32 %{{r[0-9]+}}, %{{r[0-9]+}}, 5;\n+    *b = *a + 5;\n+}\n+\n+// Verify that no extra function definitions are there.\n+// CHECK-NOT: .func\n+// CHECK-NOT: .entry\n+\n+#[panic_handler]\n+unsafe fn breakpoint_panic_handler(_: &::core::panic::PanicInfo) -> ! {\n+    core::intrinsics::breakpoint();\n+    core::hint::unreachable_unchecked();\n+}"}, {"sha": "7284e9d1a7c9968ca6b64fbeb29cb04d75c404a3", "filename": "src/test/run-make/nvptx-dylib-crate/Makefile", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/src%2Ftest%2Frun-make%2Fnvptx-dylib-crate%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/src%2Ftest%2Frun-make%2Fnvptx-dylib-crate%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fnvptx-dylib-crate%2FMakefile?ref=2efa31b2d9bf171fecd294b8e0126d8ffdb453e3", "patch": "@@ -0,0 +1,10 @@\n+-include ../../run-make-fulldeps/tools.mk\n+\n+ifeq ($(TARGET),nvptx64-nvidia-cuda)\n+all:\n+\t$(RUSTC) dep.rs --crate-type=\"rlib\" --target $(TARGET)\n+\t$(RUSTC) kernel.rs --crate-type=\"cdylib\" -O --target $(TARGET)\n+\tFileCheck kernel.rs --input-file $(TMPDIR)/kernel.ptx\n+else\n+all:\n+endif"}, {"sha": "57f3ee87cdb9d7bad8e324ca310503ee023c8dbd", "filename": "src/test/run-make/nvptx-dylib-crate/dep.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/src%2Ftest%2Frun-make%2Fnvptx-dylib-crate%2Fdep.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/src%2Ftest%2Frun-make%2Fnvptx-dylib-crate%2Fdep.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fnvptx-dylib-crate%2Fdep.rs?ref=2efa31b2d9bf171fecd294b8e0126d8ffdb453e3", "patch": "@@ -0,0 +1,14 @@\n+#![no_std]\n+#![deny(warnings)]\n+\n+#[inline(never)]\n+#[no_mangle]\n+pub fn wrapping_external_fn(a: u32) -> u32 {\n+    a.wrapping_mul(a)\n+}\n+\n+#[inline(never)]\n+#[no_mangle]\n+pub fn panicking_external_fn(a: u32) -> u32 {\n+    a * a\n+}"}, {"sha": "63fd6b063dd8c01e47acd4d1b46b5ae3c08da3c9", "filename": "src/test/run-make/nvptx-dylib-crate/kernel.rs", "status": "added", "additions": 59, "deletions": 0, "changes": 59, "blob_url": "https://github.com/rust-lang/rust/blob/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/src%2Ftest%2Frun-make%2Fnvptx-dylib-crate%2Fkernel.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/src%2Ftest%2Frun-make%2Fnvptx-dylib-crate%2Fkernel.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fnvptx-dylib-crate%2Fkernel.rs?ref=2efa31b2d9bf171fecd294b8e0126d8ffdb453e3", "patch": "@@ -0,0 +1,59 @@\n+#![no_std]\n+#![deny(warnings)]\n+#![feature(abi_ptx, core_intrinsics)]\n+\n+extern crate dep;\n+\n+// Verify the default CUDA arch.\n+// CHECK: .target sm_30\n+// CHECK: .address_size 64\n+\n+// Make sure declarations are there.\n+// CHECK: .func (.param .b32 func_retval0) wrapping_external_fn\n+// CHECK: .func (.param .b32 func_retval0) panicking_external_fn\n+// CHECK: .func [[PANIC_HANDLER:_ZN4core9panicking5panic[a-zA-Z0-9]+]]\n+\n+// CHECK-LABEL: .visible .entry top_kernel(\n+#[no_mangle]\n+pub unsafe extern \"ptx-kernel\" fn top_kernel(a: *const u32, b: *mut u32) {\n+    // CHECK:      call.uni (retval0),\n+    // CHECK-NEXT: wrapping_external_fn\n+    // CHECK:      ld.param.b32 %[[LHS:r[0-9]+]], [retval0+0];\n+    let lhs = dep::wrapping_external_fn(*a);\n+\n+    // CHECK:      call.uni (retval0),\n+    // CHECK-NEXT: panicking_external_fn\n+    // CHECK:      ld.param.b32 %[[RHS:r[0-9]+]], [retval0+0];\n+    let rhs = dep::panicking_external_fn(*a);\n+\n+    // CHECK: add.s32 %[[RES:r[0-9]+]], %[[RHS]], %[[LHS]];\n+    // CHECK: st.global.u32 [%{{rd[0-9]+}}], %[[RES]];\n+    *b = lhs + rhs;\n+}\n+\n+// Verify that external function bodies are available.\n+// CHECK-LABEL: .func (.param .b32 func_retval0) wrapping_external_fn\n+// CHECK: {\n+// CHECK:   st.param.b32 [func_retval0+0], %{{r[0-9]+}};\n+// CHECK: }\n+\n+// Also verify panic behavior.\n+// CHECK-LABEL: .func (.param .b32 func_retval0) panicking_external_fn\n+// CHECK: {\n+// CHECK:   %{{p[0-9]+}} bra [[PANIC_LABEL:[a-zA-Z0-9_]+]];\n+// CHECK: [[PANIC_LABEL]]:\n+// CHECK:   call.uni\n+// CHECK:   [[PANIC_HANDLER]]\n+// CHECK: }\n+\n+// Verify whether out dummy panic formatter has a correct body.\n+// CHECK: .func [[PANIC_FMT:_ZN4core9panicking9panic_fmt[a-zA-Z0-9]+]]()\n+// CHECK: {\n+// CHECK:   trap;\n+// CHECK: }\n+\n+#[panic_handler]\n+unsafe fn breakpoint_panic_handler(_: &::core::panic::PanicInfo) -> ! {\n+    core::intrinsics::breakpoint();\n+    core::hint::unreachable_unchecked();\n+}"}, {"sha": "e03601878bdee32d02385270bac1230380bbb798", "filename": "src/test/run-make/nvptx-emit-asm/Makefile", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/src%2Ftest%2Frun-make%2Fnvptx-emit-asm%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/src%2Ftest%2Frun-make%2Fnvptx-emit-asm%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fnvptx-emit-asm%2FMakefile?ref=2efa31b2d9bf171fecd294b8e0126d8ffdb453e3", "patch": "@@ -0,0 +1,9 @@\n+-include ../../run-make-fulldeps/tools.mk\n+\n+ifeq ($(TARGET),nvptx64-nvidia-cuda)\n+all:\n+\t$(RUSTC) kernel.rs --crate-type=\"rlib\" --emit asm,llvm-ir -O --target $(TARGET)\n+\tFileCheck kernel.rs --input-file $(TMPDIR)/kernel.s\n+else\n+all:\n+endif"}, {"sha": "b71e18d910391c5889da894a52b6ecd442f6849e", "filename": "src/test/run-make/nvptx-emit-asm/kernel.rs", "status": "added", "additions": 41, "deletions": 0, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/src%2Ftest%2Frun-make%2Fnvptx-emit-asm%2Fkernel.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2efa31b2d9bf171fecd294b8e0126d8ffdb453e3/src%2Ftest%2Frun-make%2Fnvptx-emit-asm%2Fkernel.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fnvptx-emit-asm%2Fkernel.rs?ref=2efa31b2d9bf171fecd294b8e0126d8ffdb453e3", "patch": "@@ -0,0 +1,41 @@\n+#![no_std]\n+#![deny(warnings)]\n+#![feature(abi_ptx)]\n+\n+// Verify the default CUDA arch.\n+// CHECK: .target sm_30\n+// CHECK: .address_size 64\n+\n+// Verify function name doesn't contain unacceaptable characters.\n+// CHECK: .func (.param .b32 func_retval0) [[IMPL_FN:_ZN[a-zA-Z0-9$_]+square[a-zA-Z0-9$_]+]]\n+\n+// CHECK-LABEL: .visible .entry top_kernel(\n+#[no_mangle]\n+pub unsafe extern \"ptx-kernel\" fn top_kernel(a: *const u32, b: *mut u32) {\n+    // CHECK:      call.uni (retval0),\n+    // CHECK-NEXT: [[IMPL_FN]]\n+    *b = deep::private::MyStruct::new(*a).square();\n+}\n+\n+pub mod deep {\n+    pub mod private {\n+        pub struct MyStruct<T>(T);\n+\n+        impl MyStruct<u32> {\n+            pub fn new(a: u32) -> Self {\n+                MyStruct(a)\n+            }\n+\n+            #[inline(never)]\n+            pub fn square(&self) -> u32 {\n+                self.0.wrapping_mul(self.0)\n+            }\n+        }\n+    }\n+}\n+\n+// Verify that external function bodies are available.\n+// CHECK: .func (.param .b32 func_retval0) [[IMPL_FN]]\n+// CHECK: {\n+// CHECK:   mul.lo.s32 %{{r[0-9]+}}, %{{r[0-9]+}}, %{{r[0-9]+}}\n+// CHECK: }"}]}