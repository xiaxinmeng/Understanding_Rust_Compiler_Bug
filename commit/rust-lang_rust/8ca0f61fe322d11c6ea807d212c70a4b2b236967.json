{"sha": "8ca0f61fe322d11c6ea807d212c70a4b2b236967", "node_id": "C_kwDOAAsO6NoAKDhjYTBmNjFmZTMyMmQxMWM2ZWE4MDdkMjEyYzcwYTRiMmIyMzY5Njc", "commit": {"author": {"name": "DaniPopes", "email": "57450786+DaniPopes@users.noreply.github.com", "date": "2023-03-19T23:50:03Z"}, "committer": {"name": "DaniPopes", "email": "57450786+DaniPopes@users.noreply.github.com", "date": "2023-03-19T23:50:03Z"}, "message": "fix ClashingExternDeclarations lint ICE", "tree": {"sha": "a113090b4fabd6716778cb0a77067d7464384b56", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a113090b4fabd6716778cb0a77067d7464384b56"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8ca0f61fe322d11c6ea807d212c70a4b2b236967", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEdOrdJNeWRt9kyFLLDwlkDdt6xpIFAmQXn6sACgkQDwlkDdt6\nxpLCMw//WunknQMM6wfbeilFgu/aj9Va/lDExFsdzWd13qSaWPja9w9DmAX+cKBJ\n5f8uQ0ZcRSaDX0IMw8GGOyezeg3Vz/7awoznunBJv4TeC08tssaK5CryUDKEz1Wf\n2/Y9dvlsRQJCz340cx59dTeS3klRCit5hnKpwEIxcPJFZCBcvfGO8b/DbbdnPDpp\ntZt8bTC7zc6QzQZ5rvcVC2I4FuF+veXHTjlXELE5jdRm9qDYoUtrjzy6cbjErNTV\nKHMDJuMJNrv40+Hw1Bf3RasstYvhKdSPqpAFP3RHwaTN6E/9FMuziyeUyy2iTCIb\np8x+McH2zeCtq81dH/UpLPzX/97avZ+BPrDBF99Z2sQJv0ZUiV0MoEFw+s4NjAvt\nlUhhRD3zG+JyMb99iEGScYvg08wWHYCpzvt6DLgbKOrcYR5Kfx0w82MddSf8KJuJ\nn//E8UJVT14ML0Q9vMdQ/9nKHziz+y7WjCLxeSdLaBgnyGKhk+Vs0toYYeQ4i1Z3\n0Gbm9EVv9P83fXm5l0+u/GH1Wd1FBasC3o95b4KwnkrRAMYSsyXuf83+BwqIp/yQ\nWVg0KC5l1vM8Zg7VjS+aElCPUvhVc4h570z9oB/TqR/c+3hyUDqfFBShsQzmKdhA\nUQzEC0dcJV71W46TiX4438EjYM/qNjEMXgvSJFcHI95Z7Id2qjw=\n=KLsV\n-----END PGP SIGNATURE-----", "payload": "tree a113090b4fabd6716778cb0a77067d7464384b56\nparent 8826b68c623619161d499f8138614a0edd741bc8\nauthor DaniPopes <57450786+DaniPopes@users.noreply.github.com> 1679269803 +0100\ncommitter DaniPopes <57450786+DaniPopes@users.noreply.github.com> 1679269803 +0100\n\nfix ClashingExternDeclarations lint ICE\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8ca0f61fe322d11c6ea807d212c70a4b2b236967", "html_url": "https://github.com/rust-lang/rust/commit/8ca0f61fe322d11c6ea807d212c70a4b2b236967", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8ca0f61fe322d11c6ea807d212c70a4b2b236967/comments", "author": {"login": "DaniPopes", "id": 57450786, "node_id": "MDQ6VXNlcjU3NDUwNzg2", "avatar_url": "https://avatars.githubusercontent.com/u/57450786?v=4", "gravatar_id": "", "url": "https://api.github.com/users/DaniPopes", "html_url": "https://github.com/DaniPopes", "followers_url": "https://api.github.com/users/DaniPopes/followers", "following_url": "https://api.github.com/users/DaniPopes/following{/other_user}", "gists_url": "https://api.github.com/users/DaniPopes/gists{/gist_id}", "starred_url": "https://api.github.com/users/DaniPopes/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/DaniPopes/subscriptions", "organizations_url": "https://api.github.com/users/DaniPopes/orgs", "repos_url": "https://api.github.com/users/DaniPopes/repos", "events_url": "https://api.github.com/users/DaniPopes/events{/privacy}", "received_events_url": "https://api.github.com/users/DaniPopes/received_events", "type": "User", "site_admin": false}, "committer": {"login": "DaniPopes", "id": 57450786, "node_id": "MDQ6VXNlcjU3NDUwNzg2", "avatar_url": "https://avatars.githubusercontent.com/u/57450786?v=4", "gravatar_id": "", "url": "https://api.github.com/users/DaniPopes", "html_url": "https://github.com/DaniPopes", "followers_url": "https://api.github.com/users/DaniPopes/followers", "following_url": "https://api.github.com/users/DaniPopes/following{/other_user}", "gists_url": "https://api.github.com/users/DaniPopes/gists{/gist_id}", "starred_url": "https://api.github.com/users/DaniPopes/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/DaniPopes/subscriptions", "organizations_url": "https://api.github.com/users/DaniPopes/orgs", "repos_url": "https://api.github.com/users/DaniPopes/repos", "events_url": "https://api.github.com/users/DaniPopes/events{/privacy}", "received_events_url": "https://api.github.com/users/DaniPopes/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8826b68c623619161d499f8138614a0edd741bc8", "url": "https://api.github.com/repos/rust-lang/rust/commits/8826b68c623619161d499f8138614a0edd741bc8", "html_url": "https://github.com/rust-lang/rust/commit/8826b68c623619161d499f8138614a0edd741bc8"}], "stats": {"total": 75, "additions": 49, "deletions": 26}, "files": [{"sha": "ca3865c2c0050fc9395e72bead80eea1edb9fb0b", "filename": "compiler/rustc_lint/src/builtin.rs", "status": "modified", "additions": 11, "deletions": 13, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/8ca0f61fe322d11c6ea807d212c70a4b2b236967/compiler%2Frustc_lint%2Fsrc%2Fbuiltin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8ca0f61fe322d11c6ea807d212c70a4b2b236967/compiler%2Frustc_lint%2Fsrc%2Fbuiltin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_lint%2Fsrc%2Fbuiltin.rs?ref=8ca0f61fe322d11c6ea807d212c70a4b2b236967", "patch": "@@ -2781,8 +2781,8 @@ impl ClashingExternDeclarations {\n \n             // Given a transparent newtype, reach through and grab the inner\n             // type unless the newtype makes the type non-null.\n-            let non_transparent_ty = |ty: Ty<'tcx>| -> Ty<'tcx> {\n-                let mut ty = ty;\n+            // Also returns whether this type is a ZST.\n+            let non_transparent_ty = |mut ty: Ty<'tcx>| -> Ty<'tcx> {\n                 loop {\n                     if let ty::Adt(def, substs) = *ty.kind() {\n                         let is_transparent = def.repr().transparent();\n@@ -2792,14 +2792,14 @@ impl ClashingExternDeclarations {\n                             ty, is_transparent, is_non_null\n                         );\n                         if is_transparent && !is_non_null {\n-                            debug_assert!(def.variants().len() == 1);\n+                            debug_assert_eq!(def.variants().len(), 1);\n                             let v = &def.variant(VariantIdx::new(0));\n-                            ty = transparent_newtype_field(tcx, v)\n-                                .expect(\n-                                    \"single-variant transparent structure with zero-sized field\",\n-                                )\n-                                .ty(tcx, substs);\n-                            continue;\n+                            // continue with `ty`'s non-ZST field,\n+                            // otherwise `ty` is a ZST and we can return\n+                            if let Some(field) = transparent_newtype_field(tcx, v) {\n+                                ty = field.ty(tcx, substs);\n+                                continue;\n+                            }\n                         }\n                     }\n                     debug!(\"non_transparent_ty -> {:?}\", ty);\n@@ -2813,10 +2813,8 @@ impl ClashingExternDeclarations {\n             if !seen_types.insert((a, b)) {\n                 // We've encountered a cycle. There's no point going any further -- the types are\n                 // structurally the same.\n-                return true;\n-            }\n-            let tcx = cx.tcx;\n-            if a == b {\n+                true\n+            } else if a == b {\n                 // All nominally-same types are structurally same, too.\n                 true\n             } else {"}, {"sha": "09fda33dbec5c1c51aee99c2dd1bca45494d78ed", "filename": "tests/ui/lint/clashing-extern-fn.rs", "status": "modified", "additions": 29, "deletions": 4, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/8ca0f61fe322d11c6ea807d212c70a4b2b236967/tests%2Fui%2Flint%2Fclashing-extern-fn.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8ca0f61fe322d11c6ea807d212c70a4b2b236967/tests%2Fui%2Flint%2Fclashing-extern-fn.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Flint%2Fclashing-extern-fn.rs?ref=8ca0f61fe322d11c6ea807d212c70a4b2b236967", "patch": "@@ -122,8 +122,8 @@ mod banana {\n             weight: u32,\n             length: u16,\n         } // note: distinct type\n-          // This should not trigger the lint because two::Banana is structurally equivalent to\n-          // one::Banana.\n+        // This should not trigger the lint because two::Banana is structurally equivalent to\n+        // one::Banana.\n         extern \"C\" {\n             fn weigh_banana(count: *const Banana) -> u64;\n         }\n@@ -223,6 +223,27 @@ mod transparent {\n     }\n }\n \n+#[allow(improper_ctypes)]\n+mod zst {\n+    mod transparent {\n+        #[repr(transparent)]\n+        struct TransparentZst(());\n+        extern \"C\" {\n+            fn zst() -> ();\n+            fn transparent_zst() -> TransparentZst;\n+        }\n+    }\n+\n+    mod not_transparent {\n+        struct NotTransparentZst(());\n+        extern \"C\" {\n+            // These shouldn't warn since all return types are zero sized\n+            fn zst() -> NotTransparentZst;\n+            fn transparent_zst() -> NotTransparentZst;\n+        }\n+    }\n+}\n+\n mod missing_return_type {\n     mod a {\n         extern \"C\" {\n@@ -397,10 +418,14 @@ mod hidden_niche {\n         use std::num::NonZeroUsize;\n \n         #[repr(transparent)]\n-        struct Transparent { x: NonZeroUsize }\n+        struct Transparent {\n+            x: NonZeroUsize,\n+        }\n \n         #[repr(transparent)]\n-        struct TransparentNoNiche { y: UnsafeCell<NonZeroUsize> }\n+        struct TransparentNoNiche {\n+            y: UnsafeCell<NonZeroUsize>,\n+        }\n \n         extern \"C\" {\n             fn hidden_niche_transparent() -> Option<Transparent>;"}, {"sha": "5d457ba0ec7637401eab9505b7ce690fb2e9c494", "filename": "tests/ui/lint/clashing-extern-fn.stderr", "status": "modified", "additions": 9, "deletions": 9, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/8ca0f61fe322d11c6ea807d212c70a4b2b236967/tests%2Fui%2Flint%2Fclashing-extern-fn.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/8ca0f61fe322d11c6ea807d212c70a4b2b236967/tests%2Fui%2Flint%2Fclashing-extern-fn.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Flint%2Fclashing-extern-fn.stderr?ref=8ca0f61fe322d11c6ea807d212c70a4b2b236967", "patch": "@@ -130,7 +130,7 @@ LL |             fn transparent_incorrect() -> isize;\n               found `unsafe extern \"C\" fn() -> isize`\n \n warning: `missing_return_type` redeclared with a different signature\n-  --> $DIR/clashing-extern-fn.rs:238:13\n+  --> $DIR/clashing-extern-fn.rs:259:13\n    |\n LL |             fn missing_return_type() -> usize;\n    |             ---------------------------------- `missing_return_type` previously declared here\n@@ -142,7 +142,7 @@ LL |             fn missing_return_type();\n               found `unsafe extern \"C\" fn()`\n \n warning: `non_zero_usize` redeclared with a different signature\n-  --> $DIR/clashing-extern-fn.rs:256:13\n+  --> $DIR/clashing-extern-fn.rs:277:13\n    |\n LL |             fn non_zero_usize() -> core::num::NonZeroUsize;\n    |             ----------------------------------------------- `non_zero_usize` previously declared here\n@@ -154,7 +154,7 @@ LL |             fn non_zero_usize() -> usize;\n               found `unsafe extern \"C\" fn() -> usize`\n \n warning: `non_null_ptr` redeclared with a different signature\n-  --> $DIR/clashing-extern-fn.rs:258:13\n+  --> $DIR/clashing-extern-fn.rs:279:13\n    |\n LL |             fn non_null_ptr() -> core::ptr::NonNull<usize>;\n    |             ----------------------------------------------- `non_null_ptr` previously declared here\n@@ -166,7 +166,7 @@ LL |             fn non_null_ptr() -> *const usize;\n               found `unsafe extern \"C\" fn() -> *const usize`\n \n warning: `option_non_zero_usize_incorrect` redeclared with a different signature\n-  --> $DIR/clashing-extern-fn.rs:356:13\n+  --> $DIR/clashing-extern-fn.rs:377:13\n    |\n LL |             fn option_non_zero_usize_incorrect() -> usize;\n    |             ---------------------------------------------- `option_non_zero_usize_incorrect` previously declared here\n@@ -178,7 +178,7 @@ LL |             fn option_non_zero_usize_incorrect() -> isize;\n               found `unsafe extern \"C\" fn() -> isize`\n \n warning: `option_non_null_ptr_incorrect` redeclared with a different signature\n-  --> $DIR/clashing-extern-fn.rs:358:13\n+  --> $DIR/clashing-extern-fn.rs:379:13\n    |\n LL |             fn option_non_null_ptr_incorrect() -> *const usize;\n    |             --------------------------------------------------- `option_non_null_ptr_incorrect` previously declared here\n@@ -190,7 +190,7 @@ LL |             fn option_non_null_ptr_incorrect() -> *const isize;\n               found `unsafe extern \"C\" fn() -> *const isize`\n \n warning: `hidden_niche_transparent_no_niche` redeclared with a different signature\n-  --> $DIR/clashing-extern-fn.rs:408:13\n+  --> $DIR/clashing-extern-fn.rs:433:13\n    |\n LL |             fn hidden_niche_transparent_no_niche() -> usize;\n    |             ------------------------------------------------ `hidden_niche_transparent_no_niche` previously declared here\n@@ -202,7 +202,7 @@ LL |             fn hidden_niche_transparent_no_niche() -> Option<TransparentNoN\n               found `unsafe extern \"C\" fn() -> Option<TransparentNoNiche>`\n \n warning: `hidden_niche_unsafe_cell` redeclared with a different signature\n-  --> $DIR/clashing-extern-fn.rs:412:13\n+  --> $DIR/clashing-extern-fn.rs:437:13\n    |\n LL |             fn hidden_niche_unsafe_cell() -> usize;\n    |             --------------------------------------- `hidden_niche_unsafe_cell` previously declared here\n@@ -214,7 +214,7 @@ LL |             fn hidden_niche_unsafe_cell() -> Option<UnsafeCell<NonZeroUsize\n               found `unsafe extern \"C\" fn() -> Option<UnsafeCell<NonZeroUsize>>`\n \n warning: `extern` block uses type `Option<TransparentNoNiche>`, which is not FFI-safe\n-  --> $DIR/clashing-extern-fn.rs:408:55\n+  --> $DIR/clashing-extern-fn.rs:433:55\n    |\n LL |             fn hidden_niche_transparent_no_niche() -> Option<TransparentNoNiche>;\n    |                                                       ^^^^^^^^^^^^^^^^^^^^^^^^^^ not FFI-safe\n@@ -224,7 +224,7 @@ LL |             fn hidden_niche_transparent_no_niche() -> Option<TransparentNoN\n    = note: `#[warn(improper_ctypes)]` on by default\n \n warning: `extern` block uses type `Option<UnsafeCell<NonZeroUsize>>`, which is not FFI-safe\n-  --> $DIR/clashing-extern-fn.rs:412:46\n+  --> $DIR/clashing-extern-fn.rs:437:46\n    |\n LL |             fn hidden_niche_unsafe_cell() -> Option<UnsafeCell<NonZeroUsize>>;\n    |                                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ not FFI-safe"}]}