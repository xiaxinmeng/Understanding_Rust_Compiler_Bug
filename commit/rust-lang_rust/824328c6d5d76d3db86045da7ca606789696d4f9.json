{"sha": "824328c6d5d76d3db86045da7ca606789696d4f9", "node_id": "MDY6Q29tbWl0NzI0NzEyOjgyNDMyOGM2ZDVkNzZkM2RiODYwNDVkYTdjYTYwNjc4OTY5NmQ0Zjk=", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2019-11-25T21:48:31Z"}, "committer": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2019-11-27T07:34:15Z"}, "message": "adjust for goto_block refactoring", "tree": {"sha": "1ac237e92a1a0d1e09cb06a531f767009e0056e1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1ac237e92a1a0d1e09cb06a531f767009e0056e1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/824328c6d5d76d3db86045da7ca606789696d4f9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/824328c6d5d76d3db86045da7ca606789696d4f9", "html_url": "https://github.com/rust-lang/rust/commit/824328c6d5d76d3db86045da7ca606789696d4f9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/824328c6d5d76d3db86045da7ca606789696d4f9/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "91cec06f4c32a49b027db745d424beaff2b7a694", "url": "https://api.github.com/repos/rust-lang/rust/commits/91cec06f4c32a49b027db745d424beaff2b7a694", "html_url": "https://github.com/rust-lang/rust/commit/91cec06f4c32a49b027db745d424beaff2b7a694"}], "stats": {"total": 85, "additions": 37, "deletions": 48}, "files": [{"sha": "c405329141985ce7842cb3e9e00723311628ab3f", "filename": "src/machine.rs", "status": "modified", "additions": 7, "deletions": 9, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/824328c6d5d76d3db86045da7ca606789696d4f9/src%2Fmachine.rs", "raw_url": "https://github.com/rust-lang/rust/raw/824328c6d5d76d3db86045da7ca606789696d4f9/src%2Fmachine.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fmachine.rs?ref=824328c6d5d76d3db86045da7ca606789696d4f9", "patch": "@@ -186,22 +186,21 @@ impl<'mir, 'tcx> Machine<'mir, 'tcx> for Evaluator<'tcx> {\n         ecx: &mut InterpCx<'mir, 'tcx, Self>,\n         instance: ty::Instance<'tcx>,\n         args: &[OpTy<'tcx, Tag>],\n-        dest: Option<PlaceTy<'tcx, Tag>>,\n-        ret: Option<mir::BasicBlock>,\n+        ret: Option<(PlaceTy<'tcx, Tag>, mir::BasicBlock)>,\n         unwind: Option<mir::BasicBlock>,\n     ) -> InterpResult<'tcx, Option<&'mir mir::Body<'tcx>>> {\n-        ecx.find_fn(instance, args, dest, ret, unwind)\n+        ecx.find_fn(instance, args, ret, unwind)\n     }\n \n     #[inline(always)]\n     fn call_extra_fn(\n         ecx: &mut InterpCx<'mir, 'tcx, Self>,\n         fn_val: Dlsym,\n         args: &[OpTy<'tcx, Tag>],\n-        dest: Option<PlaceTy<'tcx, Tag>>,\n-        ret: Option<mir::BasicBlock>,\n+        ret: Option<(PlaceTy<'tcx, Tag>, mir::BasicBlock)>,\n+        _unwind: Option<mir::BasicBlock>,\n     ) -> InterpResult<'tcx> {\n-        ecx.call_dlsym(fn_val, args, dest, ret)\n+        ecx.call_dlsym(fn_val, args, ret)\n     }\n \n     #[inline(always)]\n@@ -210,11 +209,10 @@ impl<'mir, 'tcx> Machine<'mir, 'tcx> for Evaluator<'tcx> {\n         span: Span,\n         instance: ty::Instance<'tcx>,\n         args: &[OpTy<'tcx, Tag>],\n-        dest: Option<PlaceTy<'tcx, Tag>>,\n-        ret: Option<mir::BasicBlock>,\n+        ret: Option<(PlaceTy<'tcx, Tag>, mir::BasicBlock)>,\n         unwind: Option<mir::BasicBlock>,\n     ) -> InterpResult<'tcx> {\n-        ecx.call_intrinsic(span, instance, args, dest, ret, unwind)\n+        ecx.call_intrinsic(span, instance, args, ret, unwind)\n     }\n \n     #[inline(always)]"}, {"sha": "dfee4066da1b0d1986d5b5e06007dafdb001a2e1", "filename": "src/shims/dlsym.rs", "status": "modified", "additions": 3, "deletions": 6, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/824328c6d5d76d3db86045da7ca606789696d4f9/src%2Fshims%2Fdlsym.rs", "raw_url": "https://github.com/rust-lang/rust/raw/824328c6d5d76d3db86045da7ca606789696d4f9/src%2Fshims%2Fdlsym.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fshims%2Fdlsym.rs?ref=824328c6d5d76d3db86045da7ca606789696d4f9", "patch": "@@ -27,15 +27,12 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n         &mut self,\n         dlsym: Dlsym,\n         args: &[OpTy<'tcx, Tag>],\n-        dest: Option<PlaceTy<'tcx, Tag>>,\n-        ret: Option<mir::BasicBlock>,\n+        ret: Option<(PlaceTy<'tcx, Tag>, mir::BasicBlock)>,\n     ) -> InterpResult<'tcx> {\n         use self::Dlsym::*;\n \n         let this = self.eval_context_mut();\n-\n-        let dest = dest.expect(\"we don't support any diverging dlsym\");\n-        let ret = ret.expect(\"dest is `Some` but ret is `None`\");\n+        let (dest, ret) = ret.expect(\"we don't support any diverging dlsym\");\n \n         match dlsym {\n             GetEntropy => {\n@@ -46,8 +43,8 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n             }\n         }\n \n-        this.goto_block(Some(ret))?;\n         this.dump_place(*dest);\n+        this.go_to_block(ret);\n         Ok(())\n     }\n }"}, {"sha": "b136260f751ec9cc84d782776a09327055d1489f", "filename": "src/shims/foreign_items.rs", "status": "modified", "additions": 8, "deletions": 9, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/824328c6d5d76d3db86045da7ca606789696d4f9/src%2Fshims%2Fforeign_items.rs", "raw_url": "https://github.com/rust-lang/rust/raw/824328c6d5d76d3db86045da7ca606789696d4f9/src%2Fshims%2Fforeign_items.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fshims%2Fforeign_items.rs?ref=824328c6d5d76d3db86045da7ca606789696d4f9", "patch": "@@ -114,8 +114,7 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n         &mut self,\n         def_id: DefId,\n         args: &[OpTy<'tcx, Tag>],\n-        dest: Option<PlaceTy<'tcx, Tag>>,\n-        ret: Option<mir::BasicBlock>,\n+        ret: Option<(PlaceTy<'tcx, Tag>, mir::BasicBlock)>,\n         _unwind: Option<mir::BasicBlock>\n     ) -> InterpResult<'tcx, Option<&'mir mir::Body<'tcx>>> {\n         let this = self.eval_context_mut();\n@@ -129,7 +128,7 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n         let tcx = &{ this.tcx.tcx };\n \n         // First: functions that diverge.\n-        match link_name {\n+        let (dest, ret) = match link_name {\n             // Note that this matches calls to the *foreign* item `__rust_start_panic* -\n             // that is, calls to `extern \"Rust\" { fn __rust_start_panic(...) }`.\n             // We forward this to the underlying *implementation* in the panic runtime crate.\n@@ -154,15 +153,15 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n                 return Err(InterpError::Exit(code).into());\n             }\n             _ => {\n-                if dest.is_none() {\n+                if let Some(p) = ret {\n+                    p\n+                } else {\n                     throw_unsup_format!(\"can't call (diverging) foreign function: {}\", link_name);\n                 }\n             }\n-        }\n+        };\n \n-        // Next: functions that assume a ret and dest.\n-        let dest = dest.expect(\"we already checked for a dest\");\n-        let ret = ret.expect(\"dest is `Some` but ret is `None`\");\n+        // Next: functions that return.\n         match link_name {\n             \"malloc\" => {\n                 let size = this.read_scalar(args[0])?.to_machine_usize(this)?;\n@@ -928,8 +927,8 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n             _ => throw_unsup_format!(\"can't call foreign function: {}\", link_name),\n         }\n \n-        this.goto_block(Some(ret))?;\n         this.dump_place(*dest);\n+        this.go_to_block(ret);\n         Ok(None)\n     }\n "}, {"sha": "00886328030bbc035a61a5091b00422877828309", "filename": "src/shims/intrinsics.rs", "status": "modified", "additions": 13, "deletions": 14, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/824328c6d5d76d3db86045da7ca606789696d4f9/src%2Fshims%2Fintrinsics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/824328c6d5d76d3db86045da7ca606789696d4f9/src%2Fshims%2Fintrinsics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fshims%2Fintrinsics.rs?ref=824328c6d5d76d3db86045da7ca606789696d4f9", "patch": "@@ -16,12 +16,11 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n         span: Span,\n         instance: ty::Instance<'tcx>,\n         args: &[OpTy<'tcx, Tag>],\n-        dest: Option<PlaceTy<'tcx, Tag>>,\n-        _ret: Option<mir::BasicBlock>,\n+        ret: Option<(PlaceTy<'tcx, Tag>, mir::BasicBlock)>,\n         unwind: Option<mir::BasicBlock>\n     ) -> InterpResult<'tcx> {\n         let this = self.eval_context_mut();\n-        if this.emulate_intrinsic(span, instance, args, dest)? {\n+        if this.emulate_intrinsic(span, instance, args, ret)? {\n             return Ok(());\n         }\n         let tcx = &{this.tcx.tcx};\n@@ -32,23 +31,21 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n         // that might still hang around!\n         let intrinsic_name = &*tcx.item_name(instance.def_id()).as_str();\n \n-        // Handle diverging intrinsics\n-        match intrinsic_name {\n+        // Handle diverging intrinsics.\n+        let (dest, ret) = match intrinsic_name {\n             \"abort\" => {\n                 // FIXME: Add a better way of indicating 'abnormal' termination,\n                 // since this is not really an 'unsupported' behavior\n                 throw_unsup_format!(\"the evaluated program aborted!\");\n             }\n             \"miri_start_panic\" => return this.handle_miri_start_panic(args, unwind),\n-            _ => {}\n-        }\n-\n-        // Handle non-diverging intrinsics\n-        // The intrinsic itself cannot diverge (otherwise, we would have handled it above),\n-        // so if we got here without a return place that's UB (can happen e.g., for transmute returning `!`).\n-        let dest = match dest {\n-            Some(dest) => dest,\n-            None => throw_ub!(Unreachable)\n+            _ => {\n+                if let Some(p) = ret {\n+                    p\n+                } else {\n+                    throw_unsup_format!(\"unimplemented (diverging) intrinsic: {}\", intrinsic_name);\n+                }\n+            }\n         };\n \n         match intrinsic_name {\n@@ -581,6 +578,8 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n             name => throw_unsup_format!(\"unimplemented intrinsic: {}\", name),\n         }\n \n+        this.dump_place(*dest);\n+        this.go_to_block(ret);\n         Ok(())\n     }\n }"}, {"sha": "2e8aea3f86e05132aace5422ad87687f5cb47929", "filename": "src/shims/mod.rs", "status": "modified", "additions": 5, "deletions": 6, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/824328c6d5d76d3db86045da7ca606789696d4f9/src%2Fshims%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/824328c6d5d76d3db86045da7ca606789696d4f9/src%2Fshims%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fshims%2Fmod.rs?ref=824328c6d5d76d3db86045da7ca606789696d4f9", "patch": "@@ -16,25 +16,24 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n         &mut self,\n         instance: ty::Instance<'tcx>,\n         args: &[OpTy<'tcx, Tag>],\n-        dest: Option<PlaceTy<'tcx, Tag>>,\n-        ret: Option<mir::BasicBlock>,\n+        ret: Option<(PlaceTy<'tcx, Tag>, mir::BasicBlock)>,\n         unwind: Option<mir::BasicBlock>\n     ) -> InterpResult<'tcx, Option<&'mir mir::Body<'tcx>>> {\n         let this = self.eval_context_mut();\n         trace!(\n             \"eval_fn_call: {:#?}, {:?}\",\n             instance,\n-            dest.map(|place| *place)\n+            ret.map(|p| *p.0)\n         );\n \n         // There are some more lang items we want to hook that CTFE does not hook (yet).\n         if this.tcx.lang_items().align_offset_fn() == Some(instance.def.def_id()) {\n-            let dest = dest.unwrap();\n+            let (dest, ret) = ret.unwrap();\n             let n = this\n                 .align_offset(args[0], args[1])?\n                 .unwrap_or_else(|| this.truncate(u128::max_value(), dest.layout));\n             this.write_scalar(Scalar::from_uint(n, dest.layout.size), dest)?;\n-            this.goto_block(ret)?;\n+            this.go_to_block(ret);\n             return Ok(None);\n         }\n \n@@ -46,7 +45,7 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n             // to run extra MIR), and Ok(Some(body)) if we found MIR to run for the\n             // foreign function\n             // Any needed call to `goto_block` will be performed by `emulate_foreign_item`.\n-            return this.emulate_foreign_item(instance.def_id(), args, dest, ret, unwind);\n+            return this.emulate_foreign_item(instance.def_id(), args, ret, unwind);\n         }\n \n         // Otherwise, load the MIR."}, {"sha": "42028738822a2c726c4eb3e285d58e4545668911", "filename": "src/shims/panic.rs", "status": "modified", "additions": 1, "deletions": 4, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/824328c6d5d76d3db86045da7ca606789696d4f9/src%2Fshims%2Fpanic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/824328c6d5d76d3db86045da7ca606789696d4f9/src%2Fshims%2Fpanic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fshims%2Fpanic.rs?ref=824328c6d5d76d3db86045da7ca606789696d4f9", "patch": "@@ -53,10 +53,7 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n         this.machine.panic_payload = Some(scalar);\n \n         // Jump to the unwind block to begin unwinding.\n-        // We don't use `goto_block` as that is just meant for normal returns.\n-        let next_frame = this.frame_mut();\n-        next_frame.block = unwind;\n-        next_frame.stmt = 0;\n+        this.unwind_to_block(unwind);\n         return Ok(())\n     }\n "}]}