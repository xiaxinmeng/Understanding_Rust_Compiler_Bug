{"sha": "8415fa27877a4309a79b08c75a52eb4c3546b7a5", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg0MTVmYTI3ODc3YTQzMDlhNzliMDhjNzVhNTJlYjRjMzU0NmI3YTU=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-04-14T18:59:26Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-04-14T18:59:26Z"}, "message": "Auto merge of #24399 - brson:stab, r=nrc", "tree": {"sha": "d06ae27779bb8a3e0cba51f44d77ab6831e2437c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d06ae27779bb8a3e0cba51f44d77ab6831e2437c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8415fa27877a4309a79b08c75a52eb4c3546b7a5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8415fa27877a4309a79b08c75a52eb4c3546b7a5", "html_url": "https://github.com/rust-lang/rust/commit/8415fa27877a4309a79b08c75a52eb4c3546b7a5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8415fa27877a4309a79b08c75a52eb4c3546b7a5/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "dabf0c6371d3b193664f58746fa27c1835a010f3", "url": "https://api.github.com/repos/rust-lang/rust/commits/dabf0c6371d3b193664f58746fa27c1835a010f3", "html_url": "https://github.com/rust-lang/rust/commit/dabf0c6371d3b193664f58746fa27c1835a010f3"}, {"sha": "22a9f668af6d1ea6d178130360675979e12d1eaa", "url": "https://api.github.com/repos/rust-lang/rust/commits/22a9f668af6d1ea6d178130360675979e12d1eaa", "html_url": "https://github.com/rust-lang/rust/commit/22a9f668af6d1ea6d178130360675979e12d1eaa"}], "stats": {"total": 85, "additions": 57, "deletions": 28}, "files": [{"sha": "9f05423e1eb0bdeead4af78ebcf88f6a646d2689", "filename": "src/librustc/middle/stability.rs", "status": "modified", "additions": 39, "deletions": 28, "changes": 67, "blob_url": "https://github.com/rust-lang/rust/blob/8415fa27877a4309a79b08c75a52eb4c3546b7a5/src%2Flibrustc%2Fmiddle%2Fstability.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8415fa27877a4309a79b08c75a52eb4c3546b7a5/src%2Flibrustc%2Fmiddle%2Fstability.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fstability.rs?ref=8415fa27877a4309a79b08c75a52eb4c3546b7a5", "patch": "@@ -57,36 +57,50 @@ impl<'a> Annotator<'a> {\n                    attrs: &Vec<Attribute>, item_sp: Span, f: F, required: bool) where\n         F: FnOnce(&mut Annotator),\n     {\n-        debug!(\"annotate(id = {:?}, attrs = {:?})\", id, attrs);\n-        match attr::find_stability(self.sess.diagnostic(), attrs, item_sp) {\n-            Some(stab) => {\n-                debug!(\"annotate: found {:?}\", stab);\n-                self.index.local.insert(id, stab.clone());\n-\n-                // Don't inherit #[stable(feature = \"rust1\", since = \"1.0.0\")]\n-                if stab.level != attr::Stable {\n-                    let parent = replace(&mut self.parent, Some(stab));\n-                    f(self);\n-                    self.parent = parent;\n-                } else {\n+        if self.index.staged_api {\n+            debug!(\"annotate(id = {:?}, attrs = {:?})\", id, attrs);\n+            match attr::find_stability(self.sess.diagnostic(), attrs, item_sp) {\n+                Some(stab) => {\n+                    debug!(\"annotate: found {:?}\", stab);\n+                    self.index.local.insert(id, stab.clone());\n+\n+                    // Don't inherit #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+                    if stab.level != attr::Stable {\n+                        let parent = replace(&mut self.parent, Some(stab));\n+                        f(self);\n+                        self.parent = parent;\n+                    } else {\n+                        f(self);\n+                    }\n+                }\n+                None => {\n+                    debug!(\"annotate: not found, use_parent = {:?}, parent = {:?}\",\n+                           use_parent, self.parent);\n+                    if use_parent {\n+                        if let Some(stab) = self.parent.clone() {\n+                            self.index.local.insert(id, stab);\n+                        } else if self.index.staged_api && required\n+                            && self.export_map.contains(&id)\n+                            && !self.sess.opts.test {\n+                                self.sess.span_err(item_sp,\n+                                                   \"This node does not have a stability attribute\");\n+                            }\n+                    }\n                     f(self);\n                 }\n             }\n-            None => {\n-                debug!(\"annotate: not found, use_parent = {:?}, parent = {:?}\",\n-                       use_parent, self.parent);\n-                if use_parent {\n-                    if let Some(stab) = self.parent.clone() {\n-                        self.index.local.insert(id, stab);\n-                    } else if self.index.staged_api && required\n-                           && self.export_map.contains(&id)\n-                           && !self.sess.opts.test {\n-                        self.sess.span_err(item_sp,\n-                                           \"This node does not have a stability attribute\");\n-                    }\n+        } else {\n+            // Emit warnings for non-staged-api crates. These should be errors.\n+            for attr in attrs {\n+                let tag = attr.name();\n+                if tag == \"unstable\" || tag == \"stable\" || tag == \"deprecated\" {\n+                    attr::mark_used(attr);\n+                    self.sess.span_warn(attr.span(),\n+                                        \"stability attributes are deprecated and \\\n+                                         will soon become errors\");\n                 }\n-                f(self);\n             }\n+            f(self);\n         }\n     }\n }\n@@ -157,9 +171,6 @@ impl<'a, 'v> Visitor<'v> for Annotator<'a> {\n impl Index {\n     /// Construct the stability index for a crate being compiled.\n     pub fn build(&mut self, sess: &Session, krate: &Crate, export_map: &PublicItems) {\n-        if !self.staged_api {\n-            return;\n-        }\n         let mut annotator = Annotator {\n             sess: sess,\n             index: self,"}, {"sha": "db16e7c0138242e298e7c687af5aef9462204463", "filename": "src/test/compile-fail/stability-attribute-non-staged.rs", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/8415fa27877a4309a79b08c75a52eb4c3546b7a5/src%2Ftest%2Fcompile-fail%2Fstability-attribute-non-staged.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8415fa27877a4309a79b08c75a52eb4c3546b7a5/src%2Ftest%2Fcompile-fail%2Fstability-attribute-non-staged.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fstability-attribute-non-staged.rs?ref=8415fa27877a4309a79b08c75a52eb4c3546b7a5", "patch": "@@ -0,0 +1,18 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// These two generate an error to satisfy the compile-fail test\n+#![deny(warnings)]\n+#![feature(blah)] //~ ERROR\n+\n+#[unstable] //~ WARNING: stability attributes are deprecated\n+#[stable] //~ WARNING: stability attributes are deprecated\n+#[deprecated] //~ WARNING: stability attributes are deprecated\n+fn main() { }"}]}