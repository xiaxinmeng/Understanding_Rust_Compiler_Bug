{"sha": "8de3fb159dcf412d4692bd862b7b3d348810ecd0", "node_id": "C_kwDOAAsO6NoAKDhkZTNmYjE1OWRjZjQxMmQ0NjkyYmQ4NjJiN2IzZDM0ODgxMGVjZDA", "commit": {"author": {"name": "Gryffon Bellish", "email": "owenbellish@gmail.com", "date": "2022-03-25T19:31:52Z"}, "committer": {"name": "flip1995", "email": "philipp.krones@embecosm.com", "date": "2022-04-21T08:03:01Z"}, "message": "Add empty_drop lint", "tree": {"sha": "97f81a6e7fcbc046de63946bf12457f355c2a7b3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/97f81a6e7fcbc046de63946bf12457f355c2a7b3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8de3fb159dcf412d4692bd862b7b3d348810ecd0", "comment_count": 0, "verification": {"verified": false, "reason": "bad_email", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEij1UXJ/PQTcb99vTHKDfKvWdaKUFAmJhD7UACgkQHKDfKvWd\naKVWpg/+JzM+tY+CASldqUnrVUvpwYUjjS0sT+arzEiIoGa+5k0tD9aJqRXD/BC7\n/XRgN+VAYH7z4Gm6bYaYq/LjxcJDZlqFhOQjNOlOZI/11DPzyvoDL0G35jWAtO/G\nSsRE5kO4fZIBJQrziEGa0d9dE0S01/h9CsXuYNS5hXE5mqRARc6GWzAJ+y9juX1c\nKSXywQvrFWP3u+VQBGrOtTF0QApyiKKx7s33sR4fvqy9l2I+zZpI9peQ/G9+EkDO\n/FyaUBkj9159lf7uTHQBxCBkeAf5mlzBwh9yIh2ER0qsFNxG3fZSWu/dfM/xS4DL\nC/6YWoHFisaYEDgurV3Pmd4kZqlne+PZRLO52Jr/eOgVDXiRXLSg61tlTSPX9evJ\nN8eTZn3+7X3Va9Ea5vK/KCpRAcwLVdTFlblJSHk9U7d+UP0/QnY4iNkdFJcgL4hY\ntANhgO5BQ6ZmLLK5X2VJC3fMWTYY24CCU4XVt3Qq887K/+l3e87REL06LFw1v/Bq\nxSfRgDqAfQ0aIXOWx99zFNn+v0xgofJXew6MG1TH34qk8in/2RiLTMGhfCmZiDda\nGsHNQ7n0UJTtdEp7zysDQwNR1VIQk4beiYC6e7Uxlo9xcX/58hFSwCWGSBSSMM0W\nNTIaR/o2nFTmWMKrdBTY7ERKXFLxyL2a1kKAhN4gCstML7Ym2VM=\n=+Qdq\n-----END PGP SIGNATURE-----", "payload": "tree 97f81a6e7fcbc046de63946bf12457f355c2a7b3\nparent 4c25880f0ceb84f8fc8bfe98c14e45fb47164e19\nauthor Gryffon Bellish <owenbellish@gmail.com> 1648236712 -0400\ncommitter flip1995 <philipp.krones@embecosm.com> 1650528181 +0200\n\nAdd empty_drop lint\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8de3fb159dcf412d4692bd862b7b3d348810ecd0", "html_url": "https://github.com/rust-lang/rust/commit/8de3fb159dcf412d4692bd862b7b3d348810ecd0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8de3fb159dcf412d4692bd862b7b3d348810ecd0/comments", "author": {"login": "PyroTechniac", "id": 39341355, "node_id": "MDQ6VXNlcjM5MzQxMzU1", "avatar_url": "https://avatars.githubusercontent.com/u/39341355?v=4", "gravatar_id": "", "url": "https://api.github.com/users/PyroTechniac", "html_url": "https://github.com/PyroTechniac", "followers_url": "https://api.github.com/users/PyroTechniac/followers", "following_url": "https://api.github.com/users/PyroTechniac/following{/other_user}", "gists_url": "https://api.github.com/users/PyroTechniac/gists{/gist_id}", "starred_url": "https://api.github.com/users/PyroTechniac/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/PyroTechniac/subscriptions", "organizations_url": "https://api.github.com/users/PyroTechniac/orgs", "repos_url": "https://api.github.com/users/PyroTechniac/repos", "events_url": "https://api.github.com/users/PyroTechniac/events{/privacy}", "received_events_url": "https://api.github.com/users/PyroTechniac/received_events", "type": "User", "site_admin": false}, "committer": {"login": "flip1995", "id": 9744647, "node_id": "MDQ6VXNlcjk3NDQ2NDc=", "avatar_url": "https://avatars.githubusercontent.com/u/9744647?v=4", "gravatar_id": "", "url": "https://api.github.com/users/flip1995", "html_url": "https://github.com/flip1995", "followers_url": "https://api.github.com/users/flip1995/followers", "following_url": "https://api.github.com/users/flip1995/following{/other_user}", "gists_url": "https://api.github.com/users/flip1995/gists{/gist_id}", "starred_url": "https://api.github.com/users/flip1995/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/flip1995/subscriptions", "organizations_url": "https://api.github.com/users/flip1995/orgs", "repos_url": "https://api.github.com/users/flip1995/repos", "events_url": "https://api.github.com/users/flip1995/events{/privacy}", "received_events_url": "https://api.github.com/users/flip1995/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4c25880f0ceb84f8fc8bfe98c14e45fb47164e19", "url": "https://api.github.com/repos/rust-lang/rust/commits/4c25880f0ceb84f8fc8bfe98c14e45fb47164e19", "html_url": "https://github.com/rust-lang/rust/commit/4c25880f0ceb84f8fc8bfe98c14e45fb47164e19"}], "stats": {"total": 146, "additions": 146, "deletions": 0}, "files": [{"sha": "2948c24fb3b67f2cc7333300c5b7cbcaca316bc4", "filename": "CHANGELOG.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/8de3fb159dcf412d4692bd862b7b3d348810ecd0/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/8de3fb159dcf412d4692bd862b7b3d348810ecd0/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=8de3fb159dcf412d4692bd862b7b3d348810ecd0", "patch": "@@ -3365,6 +3365,7 @@ Released 2018-09-13\n [`duplicate_underscore_argument`]: https://rust-lang.github.io/rust-clippy/master/index.html#duplicate_underscore_argument\n [`duration_subsec`]: https://rust-lang.github.io/rust-clippy/master/index.html#duration_subsec\n [`else_if_without_else`]: https://rust-lang.github.io/rust-clippy/master/index.html#else_if_without_else\n+[`empty_drop`]: https://rust-lang.github.io/rust-clippy/master/index.html#empty_drop\n [`empty_enum`]: https://rust-lang.github.io/rust-clippy/master/index.html#empty_enum\n [`empty_line_after_outer_attr`]: https://rust-lang.github.io/rust-clippy/master/index.html#empty_line_after_outer_attr\n [`empty_loop`]: https://rust-lang.github.io/rust-clippy/master/index.html#empty_loop"}, {"sha": "325ae2356c14cb255531b3df3950d3208feaa39e", "filename": "clippy_lints/src/empty_drop.rs", "status": "added", "additions": 65, "deletions": 0, "changes": 65, "blob_url": "https://github.com/rust-lang/rust/blob/8de3fb159dcf412d4692bd862b7b3d348810ecd0/clippy_lints%2Fsrc%2Fempty_drop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8de3fb159dcf412d4692bd862b7b3d348810ecd0/clippy_lints%2Fsrc%2Fempty_drop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fempty_drop.rs?ref=8de3fb159dcf412d4692bd862b7b3d348810ecd0", "patch": "@@ -0,0 +1,65 @@\n+use clippy_utils::{diagnostics::span_lint_and_sugg, peel_blocks};\n+use if_chain::if_chain;\n+use rustc_errors::Applicability;\n+use rustc_hir::{Body, ExprKind, Impl, ImplItemKind, Item, ItemKind, Node};\n+use rustc_lint::{LateContext, LateLintPass};\n+use rustc_session::{declare_lint_pass, declare_tool_lint};\n+\n+declare_clippy_lint! {\n+    /// ### What it does\n+    /// Checks for empty `Drop` implementations.\n+    ///\n+    /// ### Why is this bad?\n+    /// Empty `Drop` implementations have no effect when dropping an instance of the type. They are\n+    /// most likely useless. However, an empty `Drop` implementation prevents a type from being\n+    /// destructured, which might be the intention behind adding the implementation as a marker.\n+    ///\n+    /// ### Example\n+    /// ```rust\n+    /// struct S;\n+    ///\n+    /// impl Drop for S {\n+    ///     fn drop(&mut self) {}\n+    /// }\n+    /// ```\n+    /// Use instead:\n+    /// ```rust\n+    /// struct S;\n+    /// ```\n+    #[clippy::version = \"1.61.0\"]\n+    pub EMPTY_DROP,\n+    restriction,\n+    \"empty `Drop` implementations\"\n+}\n+declare_lint_pass!(EmptyDrop => [EMPTY_DROP]);\n+\n+impl LateLintPass<'_> for EmptyDrop {\n+    fn check_item(&mut self, cx: &LateContext<'_>, item: &Item<'_>) {\n+        if_chain! {\n+            if let ItemKind::Impl(Impl {\n+                of_trait: Some(ref trait_ref),\n+                items: [child],\n+                ..\n+            }) = item.kind;\n+            if trait_ref.trait_def_id() == cx.tcx.lang_items().drop_trait();\n+            if let impl_item_hir = child.id.hir_id();\n+            if let Some(Node::ImplItem(impl_item)) = cx.tcx.hir().find(impl_item_hir);\n+            if let ImplItemKind::Fn(_, b) = &impl_item.kind;\n+            if let Body { value: func_expr, .. } = cx.tcx.hir().body(*b);\n+            let func_expr = peel_blocks(func_expr);\n+            if let ExprKind::Block(block, _) = func_expr.kind;\n+            if block.stmts.is_empty() && block.expr.is_none();\n+            then {\n+                span_lint_and_sugg(\n+                    cx,\n+                    EMPTY_DROP,\n+                    item.span,\n+                    \"empty drop implementation\",\n+                    \"try removing this impl\",\n+                    String::new(),\n+                    Applicability::MaybeIncorrect\n+                );\n+            }\n+        }\n+    }\n+}"}, {"sha": "8507531c8d307b0ff11fd0bc151c1b3619b3e238", "filename": "clippy_lints/src/lib.register_lints.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/8de3fb159dcf412d4692bd862b7b3d348810ecd0/clippy_lints%2Fsrc%2Flib.register_lints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8de3fb159dcf412d4692bd862b7b3d348810ecd0/clippy_lints%2Fsrc%2Flib.register_lints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.register_lints.rs?ref=8de3fb159dcf412d4692bd862b7b3d348810ecd0", "patch": "@@ -134,6 +134,7 @@ store.register_lints(&[\n     drop_forget_ref::UNDROPPED_MANUALLY_DROPS,\n     duration_subsec::DURATION_SUBSEC,\n     else_if_without_else::ELSE_IF_WITHOUT_ELSE,\n+    empty_drop::EMPTY_DROP,\n     empty_enum::EMPTY_ENUM,\n     empty_structs_with_brackets::EMPTY_STRUCTS_WITH_BRACKETS,\n     entry::MAP_ENTRY,"}, {"sha": "46c79c56a47db9e6894bee28330eb5e1272e75e7", "filename": "clippy_lints/src/lib.register_restriction.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/8de3fb159dcf412d4692bd862b7b3d348810ecd0/clippy_lints%2Fsrc%2Flib.register_restriction.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8de3fb159dcf412d4692bd862b7b3d348810ecd0/clippy_lints%2Fsrc%2Flib.register_restriction.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.register_restriction.rs?ref=8de3fb159dcf412d4692bd862b7b3d348810ecd0", "patch": "@@ -16,6 +16,7 @@ store.register_group(true, \"clippy::restriction\", Some(\"clippy_restriction\"), ve\n     LintId::of(default_union_representation::DEFAULT_UNION_REPRESENTATION),\n     LintId::of(disallowed_script_idents::DISALLOWED_SCRIPT_IDENTS),\n     LintId::of(else_if_without_else::ELSE_IF_WITHOUT_ELSE),\n+    LintId::of(empty_drop::EMPTY_DROP),\n     LintId::of(empty_structs_with_brackets::EMPTY_STRUCTS_WITH_BRACKETS),\n     LintId::of(exhaustive_items::EXHAUSTIVE_ENUMS),\n     LintId::of(exhaustive_items::EXHAUSTIVE_STRUCTS),"}, {"sha": "335467bf9d2aec413d7410344288fd8eed8dec99", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/8de3fb159dcf412d4692bd862b7b3d348810ecd0/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8de3fb159dcf412d4692bd862b7b3d348810ecd0/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=8de3fb159dcf412d4692bd862b7b3d348810ecd0", "patch": "@@ -210,6 +210,7 @@ mod double_parens;\n mod drop_forget_ref;\n mod duration_subsec;\n mod else_if_without_else;\n+mod empty_drop;\n mod empty_enum;\n mod empty_structs_with_brackets;\n mod entry;\n@@ -822,6 +823,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n     store.register_late_pass(move || Box::new(disallowed_methods::DisallowedMethods::new(disallowed_methods.clone())));\n     store.register_early_pass(|| Box::new(asm_syntax::InlineAsmX86AttSyntax));\n     store.register_early_pass(|| Box::new(asm_syntax::InlineAsmX86IntelSyntax));\n+    store.register_late_pass(|| Box::new(empty_drop::EmptyDrop));\n     store.register_late_pass(|| Box::new(strings::StrToString));\n     store.register_late_pass(|| Box::new(strings::StringToString));\n     store.register_late_pass(|| Box::new(zero_sized_map_values::ZeroSizedMapValues));"}, {"sha": "2e1b768461ab2a1e7483831b842e4822b4c13502", "filename": "tests/ui/empty_drop.fixed", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/8de3fb159dcf412d4692bd862b7b3d348810ecd0/tests%2Fui%2Fempty_drop.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/8de3fb159dcf412d4692bd862b7b3d348810ecd0/tests%2Fui%2Fempty_drop.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fempty_drop.fixed?ref=8de3fb159dcf412d4692bd862b7b3d348810ecd0", "patch": "@@ -0,0 +1,24 @@\n+// run-rustfix\n+#![warn(clippy::empty_drop)]\n+#![allow(unused)]\n+\n+// should cause an error\n+struct Foo;\n+\n+\n+\n+// shouldn't cause an error\n+struct Bar;\n+\n+impl Drop for Bar {\n+    fn drop(&mut self) {\n+        println!(\"dropping bar!\");\n+    }\n+}\n+\n+// should error\n+struct Baz;\n+\n+\n+\n+fn main() {}"}, {"sha": "75232b0334df6c9153bc927021b4dfd611f75c48", "filename": "tests/ui/empty_drop.rs", "status": "added", "additions": 30, "deletions": 0, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/8de3fb159dcf412d4692bd862b7b3d348810ecd0/tests%2Fui%2Fempty_drop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8de3fb159dcf412d4692bd862b7b3d348810ecd0/tests%2Fui%2Fempty_drop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fempty_drop.rs?ref=8de3fb159dcf412d4692bd862b7b3d348810ecd0", "patch": "@@ -0,0 +1,30 @@\n+// run-rustfix\n+#![warn(clippy::empty_drop)]\n+#![allow(unused)]\n+\n+// should cause an error\n+struct Foo;\n+\n+impl Drop for Foo {\n+    fn drop(&mut self) {}\n+}\n+\n+// shouldn't cause an error\n+struct Bar;\n+\n+impl Drop for Bar {\n+    fn drop(&mut self) {\n+        println!(\"dropping bar!\");\n+    }\n+}\n+\n+// should error\n+struct Baz;\n+\n+impl Drop for Baz {\n+    fn drop(&mut self) {\n+        {}\n+    }\n+}\n+\n+fn main() {}"}, {"sha": "70f7880d03601314e4ea7bd40f6b8d0098b3dd8a", "filename": "tests/ui/empty_drop.stderr", "status": "added", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/8de3fb159dcf412d4692bd862b7b3d348810ecd0/tests%2Fui%2Fempty_drop.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/8de3fb159dcf412d4692bd862b7b3d348810ecd0/tests%2Fui%2Fempty_drop.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fempty_drop.stderr?ref=8de3fb159dcf412d4692bd862b7b3d348810ecd0", "patch": "@@ -0,0 +1,22 @@\n+error: empty drop implementation\n+  --> $DIR/empty_drop.rs:8:1\n+   |\n+LL | / impl Drop for Foo {\n+LL | |     fn drop(&mut self) {}\n+LL | | }\n+   | |_^ help: try removing this impl\n+   |\n+   = note: `-D clippy::empty-drop` implied by `-D warnings`\n+\n+error: empty drop implementation\n+  --> $DIR/empty_drop.rs:24:1\n+   |\n+LL | / impl Drop for Baz {\n+LL | |     fn drop(&mut self) {\n+LL | |         {}\n+LL | |     }\n+LL | | }\n+   | |_^ help: try removing this impl\n+\n+error: aborting due to 2 previous errors\n+"}]}