{"sha": "d5c62fd399e39bdabde6be5ee198a128457a2e98", "node_id": "C_kwDOAAsO6NoAKGQ1YzYyZmQzOTllMzliZGFiZGU2YmU1ZWUxOThhMTI4NDU3YTJlOTg", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-04-27T09:47:08Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-04-27T09:47:08Z"}, "message": "Auto merge of #8431 - dswij:8416, r=xFrednet\n\n`redundant_closure` fix FP on coerced closure\n\nCloses https://github.com/rust-lang/rust-clippy/issues/8416,\nCloses https://github.com/rust-lang/rust-clippy/issues/7812\nCloses https://github.com/rust-lang/rust-clippy/issues/8091\n\n~~Seems like this is fixed in #817 and regressed.~~\n\nIgnore coerced closure false positives, but this will lead to some false negatives on resolvable generics. IMO, this is still an overall improvement\n\nchangelog: [`redundant_closure`] ignores coerced closure", "tree": {"sha": "fcdd83633dca2d12a3c25784bee73b6fb1ccc3d9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fcdd83633dca2d12a3c25784bee73b6fb1ccc3d9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d5c62fd399e39bdabde6be5ee198a128457a2e98", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d5c62fd399e39bdabde6be5ee198a128457a2e98", "html_url": "https://github.com/rust-lang/rust/commit/d5c62fd399e39bdabde6be5ee198a128457a2e98", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d5c62fd399e39bdabde6be5ee198a128457a2e98/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "18a1831377ffd7578af850a136cdf3bec3650c1a", "url": "https://api.github.com/repos/rust-lang/rust/commits/18a1831377ffd7578af850a136cdf3bec3650c1a", "html_url": "https://github.com/rust-lang/rust/commit/18a1831377ffd7578af850a136cdf3bec3650c1a"}, {"sha": "33bf9e9a54697bcdaba30291f2d4e357ee84777f", "url": "https://api.github.com/repos/rust-lang/rust/commits/33bf9e9a54697bcdaba30291f2d4e357ee84777f", "html_url": "https://github.com/rust-lang/rust/commit/33bf9e9a54697bcdaba30291f2d4e357ee84777f"}], "stats": {"total": 46, "additions": 30, "deletions": 16}, "files": [{"sha": "1b19868e4c70faf2d33f6a5911528f971b25672b", "filename": "clippy_lints/src/eta_reduction.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d5c62fd399e39bdabde6be5ee198a128457a2e98/clippy_lints%2Fsrc%2Feta_reduction.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d5c62fd399e39bdabde6be5ee198a128457a2e98/clippy_lints%2Fsrc%2Feta_reduction.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Feta_reduction.rs?ref=d5c62fd399e39bdabde6be5ee198a128457a2e98", "patch": "@@ -3,7 +3,7 @@ use clippy_utils::higher::VecArgs;\n use clippy_utils::source::snippet_opt;\n use clippy_utils::ty::is_type_diagnostic_item;\n use clippy_utils::usage::local_used_after_expr;\n-use clippy_utils::{higher, path_to_local, path_to_local_id};\n+use clippy_utils::{higher, is_adjusted, path_to_local, path_to_local_id};\n use if_chain::if_chain;\n use rustc_errors::Applicability;\n use rustc_hir::def_id::DefId;\n@@ -103,6 +103,7 @@ impl<'tcx> LateLintPass<'tcx> for EtaReduction {\n         let closure_ty = cx.typeck_results().expr_ty(expr);\n \n         if_chain!(\n+            if !is_adjusted(cx, &body.value);\n             if let ExprKind::Call(callee, args) = body.value.kind;\n             if let ExprKind::Path(_) = callee.kind;\n             if check_inputs(cx, body.params, args);\n@@ -144,6 +145,7 @@ impl<'tcx> LateLintPass<'tcx> for EtaReduction {\n         );\n \n         if_chain!(\n+            if !is_adjusted(cx, &body.value);\n             if let ExprKind::MethodCall(path, args, _) = body.value.kind;\n             if check_inputs(cx, body.params, args);\n             let method_def_id = cx.typeck_results().type_dependent_def_id(body.value.hir_id).unwrap();"}, {"sha": "6c2272f4dff97f350344b4fbb66fc5d4ba4cb146", "filename": "tests/ui/eta.fixed", "status": "modified", "additions": 14, "deletions": 2, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/d5c62fd399e39bdabde6be5ee198a128457a2e98/tests%2Fui%2Feta.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/d5c62fd399e39bdabde6be5ee198a128457a2e98/tests%2Fui%2Feta.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Feta.fixed?ref=d5c62fd399e39bdabde6be5ee198a128457a2e98", "patch": "@@ -37,7 +37,7 @@ fn main() {\n     }\n \n     // See #815\n-    let e = Some(1u8).map(divergent);\n+    let e = Some(1u8).map(|a| divergent(a));\n     let e = Some(1u8).map(generic);\n     let e = Some(1u8).map(generic);\n     // See #515\n@@ -233,7 +233,7 @@ fn late_bound_lifetimes() {\n     {\n     }\n     map_str(|s| take_asref_path(s));\n-    map_str_to_path(std::convert::AsRef::as_ref);\n+    map_str_to_path(|s| s.as_ref());\n }\n \n mod type_param_bound {\n@@ -279,3 +279,15 @@ mod bind_by_ref {\n         Some(A).map(|ref a| B::from(a));\n     }\n }\n+\n+// #7812 False positive on coerced closure\n+fn coerced_closure() {\n+    fn function_returning_unit<F: FnMut(i32)>(f: F) {}\n+    function_returning_unit(|x| std::process::exit(x));\n+\n+    fn arr() -> &'static [u8; 0] {\n+        &[]\n+    }\n+    fn slice_fn(_: impl FnOnce() -> &'static [u8]) {}\n+    slice_fn(|| arr());\n+}"}, {"sha": "a1a9c0dfbf381d64ae7f47d3fdc46cb1e981ad69", "filename": "tests/ui/eta.rs", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/d5c62fd399e39bdabde6be5ee198a128457a2e98/tests%2Fui%2Feta.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d5c62fd399e39bdabde6be5ee198a128457a2e98/tests%2Fui%2Feta.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Feta.rs?ref=d5c62fd399e39bdabde6be5ee198a128457a2e98", "patch": "@@ -279,3 +279,15 @@ mod bind_by_ref {\n         Some(A).map(|ref a| B::from(a));\n     }\n }\n+\n+// #7812 False positive on coerced closure\n+fn coerced_closure() {\n+    fn function_returning_unit<F: FnMut(i32)>(f: F) {}\n+    function_returning_unit(|x| std::process::exit(x));\n+\n+    fn arr() -> &'static [u8; 0] {\n+        &[]\n+    }\n+    fn slice_fn(_: impl FnOnce() -> &'static [u8]) {}\n+    slice_fn(|| arr());\n+}"}, {"sha": "bf2e97e744ab348d639991e748d71df3d87c1b82", "filename": "tests/ui/eta.stderr", "status": "modified", "additions": 1, "deletions": 13, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/d5c62fd399e39bdabde6be5ee198a128457a2e98/tests%2Fui%2Feta.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/d5c62fd399e39bdabde6be5ee198a128457a2e98/tests%2Fui%2Feta.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Feta.stderr?ref=d5c62fd399e39bdabde6be5ee198a128457a2e98", "patch": "@@ -24,12 +24,6 @@ error: redundant closure\n LL |     all(&[1, 2, 3], &&2, |x, y| below(x, y)); //is adjusted\n    |                          ^^^^^^^^^^^^^^^^^^ help: replace the closure with the function itself: `below`\n \n-error: redundant closure\n-  --> $DIR/eta.rs:40:27\n-   |\n-LL |     let e = Some(1u8).map(|a| divergent(a));\n-   |                           ^^^^^^^^^^^^^^^^ help: replace the closure with the function itself: `divergent`\n-\n error: redundant closure\n   --> $DIR/eta.rs:41:27\n    |\n@@ -122,11 +116,5 @@ error: redundant closure\n LL |         Some(1).map(|n| in_loop(n));\n    |                     ^^^^^^^^^^^^^^ help: replace the closure with the function itself: `in_loop`\n \n-error: redundant closure\n-  --> $DIR/eta.rs:236:21\n-   |\n-LL |     map_str_to_path(|s| s.as_ref());\n-   |                     ^^^^^^^^^^^^^^ help: replace the closure with the method itself: `std::convert::AsRef::as_ref`\n-\n-error: aborting due to 21 previous errors\n+error: aborting due to 19 previous errors\n "}]}