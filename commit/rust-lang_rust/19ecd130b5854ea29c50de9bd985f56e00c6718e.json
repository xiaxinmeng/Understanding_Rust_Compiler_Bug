{"sha": "19ecd130b5854ea29c50de9bd985f56e00c6718e", "node_id": "C_kwDOAAsO6NoAKDE5ZWNkMTMwYjU4NTRlYTI5YzUwZGU5YmQ5ODVmNTZlMDBjNjcxOGU", "commit": {"author": {"name": "Ben Kimock", "email": "kimockb@gmail.com", "date": "2022-02-20T16:55:39Z"}, "committer": {"name": "Ben Kimock", "email": "kimockb@gmail.com", "date": "2022-02-22T15:32:52Z"}, "message": "Prune backtraces similar to RUST_BACKTRACE=1 logic\n\nPreviously, Miri would always print a backtrace including all frames\nwhen encountering an error. This adds -Zmiri-backtrace which defaults\nto 1, internally called BacktraceStyle::Short. By default, backtraces\nare pruned to start at __rust_begin_short_backtrace, similar to std.\nThen we also remove non-local frames from the bottom of the trace.\nThis cleans up the last one or two shims outside main or a test.\n\nUsers can opt out of pruning by setting -Zmiri-backtrace=full, and will\nbe automatically opted out if there are no local frames because that\nmeans the reported error is likely in the Rust runtime, which this\npruning is crafted to remove.", "tree": {"sha": "5ccd0b3deeb60f669a81deb1ca4c20ae3e6742d0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5ccd0b3deeb60f669a81deb1ca4c20ae3e6742d0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/19ecd130b5854ea29c50de9bd985f56e00c6718e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/19ecd130b5854ea29c50de9bd985f56e00c6718e", "html_url": "https://github.com/rust-lang/rust/commit/19ecd130b5854ea29c50de9bd985f56e00c6718e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/19ecd130b5854ea29c50de9bd985f56e00c6718e/comments", "author": {"login": "saethlin", "id": 12105168, "node_id": "MDQ6VXNlcjEyMTA1MTY4", "avatar_url": "https://avatars.githubusercontent.com/u/12105168?v=4", "gravatar_id": "", "url": "https://api.github.com/users/saethlin", "html_url": "https://github.com/saethlin", "followers_url": "https://api.github.com/users/saethlin/followers", "following_url": "https://api.github.com/users/saethlin/following{/other_user}", "gists_url": "https://api.github.com/users/saethlin/gists{/gist_id}", "starred_url": "https://api.github.com/users/saethlin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/saethlin/subscriptions", "organizations_url": "https://api.github.com/users/saethlin/orgs", "repos_url": "https://api.github.com/users/saethlin/repos", "events_url": "https://api.github.com/users/saethlin/events{/privacy}", "received_events_url": "https://api.github.com/users/saethlin/received_events", "type": "User", "site_admin": false}, "committer": {"login": "saethlin", "id": 12105168, "node_id": "MDQ6VXNlcjEyMTA1MTY4", "avatar_url": "https://avatars.githubusercontent.com/u/12105168?v=4", "gravatar_id": "", "url": "https://api.github.com/users/saethlin", "html_url": "https://github.com/saethlin", "followers_url": "https://api.github.com/users/saethlin/followers", "following_url": "https://api.github.com/users/saethlin/following{/other_user}", "gists_url": "https://api.github.com/users/saethlin/gists{/gist_id}", "starred_url": "https://api.github.com/users/saethlin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/saethlin/subscriptions", "organizations_url": "https://api.github.com/users/saethlin/orgs", "repos_url": "https://api.github.com/users/saethlin/repos", "events_url": "https://api.github.com/users/saethlin/events{/privacy}", "received_events_url": "https://api.github.com/users/saethlin/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2b0078e4556a259e8797a5e8f29110150b71c1c4", "url": "https://api.github.com/repos/rust-lang/rust/commits/2b0078e4556a259e8797a5e8f29110150b71c1c4", "html_url": "https://github.com/rust-lang/rust/commit/2b0078e4556a259e8797a5e8f29110150b71c1c4"}], "stats": {"total": 78, "additions": 76, "deletions": 2}, "files": [{"sha": "333ff6af889f635b52708f9cc472ca61a9a76b4e", "filename": "src/bin/miri.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/19ecd130b5854ea29c50de9bd985f56e00c6718e/src%2Fbin%2Fmiri.rs", "raw_url": "https://github.com/rust-lang/rust/raw/19ecd130b5854ea29c50de9bd985f56e00c6718e/src%2Fbin%2Fmiri.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbin%2Fmiri.rs?ref=19ecd130b5854ea29c50de9bd985f56e00c6718e", "patch": "@@ -29,6 +29,8 @@ use rustc_middle::{\n };\n use rustc_session::{config::ErrorOutputType, search_paths::PathKind, CtfeBacktrace};\n \n+use miri::BacktraceStyle;\n+\n struct MiriCompilerCalls {\n     miri_config: miri::MiriConfig,\n }\n@@ -462,6 +464,14 @@ fn main() {\n                     let measureme_out = arg.strip_prefix(\"-Zmiri-measureme=\").unwrap();\n                     miri_config.measureme_out = Some(measureme_out.to_string());\n                 }\n+                arg if arg.starts_with(\"-Zmiri-backtrace=\") => {\n+                    miri_config.backtrace_style = match arg.strip_prefix(\"-Zmiri-backtrace=\") {\n+                        Some(\"0\") => BacktraceStyle::Off,\n+                        Some(\"1\") => BacktraceStyle::Short,\n+                        Some(\"full\") => BacktraceStyle::Full,\n+                        _ => panic!(\"-Zmiri-backtrace may only be 0, 1, or full\"),\n+                    };\n+                }\n                 _ => {\n                     // Forward to rustc.\n                     rustc_args.push(arg);"}, {"sha": "718148060749fa80e7dcb042b75ba6af41209210", "filename": "src/diagnostics.rs", "status": "modified", "additions": 49, "deletions": 1, "changes": 50, "blob_url": "https://github.com/rust-lang/rust/blob/19ecd130b5854ea29c50de9bd985f56e00c6718e/src%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/19ecd130b5854ea29c50de9bd985f56e00c6718e/src%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdiagnostics.rs?ref=19ecd130b5854ea29c50de9bd985f56e00c6718e", "patch": "@@ -157,6 +157,46 @@ pub fn report_error<'tcx, 'mir>(\n         }\n     };\n \n+    let mut stacktrace = ecx.generate_stacktrace();\n+    let has_local_frame = stacktrace.iter().any(|frame| frame.instance.def_id().is_local());\n+    match ecx.machine.backtrace_style {\n+        BacktraceStyle::Off => {\n+            // Retain one frame so that we can print a span for the error itself\n+            stacktrace.truncate(1);\n+        }\n+        BacktraceStyle::Short => {\n+            // Only prune frames if there is at least one local frame. This check ensures that if\n+            // we get a backtrace that never makes it to the user code because it has detected a\n+            // bug in the Rust runtime, we don't prune away every frame.\n+            if has_local_frame {\n+                // This is part of the logic that `std` uses to select the relevant part of a\n+                // backtrace. But here, we only look for __rust_begin_short_backtrace, not\n+                // __rust_end_short_backtrace because the end symbol comes from a call to the default\n+                // panic handler.\n+                stacktrace = stacktrace\n+                    .into_iter()\n+                    .take_while(|frame| {\n+                        let def_id = frame.instance.def_id();\n+                        let path = ecx.tcx.tcx.def_path_str(def_id);\n+                        !path.contains(\"__rust_begin_short_backtrace\")\n+                    })\n+                    .collect::<Vec<_>>();\n+\n+                // After we prune frames from the bottom, there are a few left that are part of the\n+                // Rust runtime. So we remove frames until we get to a local symbol, which should be\n+                // main or a test.\n+                // This len check ensures that we don't somehow remove every frame, as doing so breaks\n+                // the primary error message.\n+                while stacktrace.len() > 1\n+                    && stacktrace.last().map_or(false, |e| !e.instance.def_id().is_local())\n+                {\n+                    stacktrace.pop();\n+                }\n+            }\n+        }\n+        BacktraceStyle::Full => {}\n+    }\n+\n     e.print_backtrace();\n     let msg = e.to_string();\n     report_msg(\n@@ -165,9 +205,17 @@ pub fn report_error<'tcx, 'mir>(\n         &if let Some(title) = title { format!(\"{}: {}\", title, msg) } else { msg.clone() },\n         msg,\n         helps,\n-        &ecx.generate_stacktrace(),\n+        &stacktrace,\n     );\n \n+    // Include a note like `std` does for short backtraces, but since we are opt-out not opt-in, we\n+    // do not include a note when backtraces are off.\n+    if ecx.machine.backtrace_style == BacktraceStyle::Short && has_local_frame {\n+        ecx.tcx.sess.diagnostic().note_without_error(\n+            \"some details are omitted, run with `MIRIFLAGS=-Zmiri-backtrace=full` for a verbose backtrace\",\n+        );\n+    }\n+\n     // Debug-dump all locals.\n     for (i, frame) in ecx.active_thread_stack().iter().enumerate() {\n         trace!(\"-------------------\");"}, {"sha": "e2e85e3e757216162f53c36f4cb28434af7727ac", "filename": "src/eval.rs", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/19ecd130b5854ea29c50de9bd985f56e00c6718e/src%2Feval.rs", "raw_url": "https://github.com/rust-lang/rust/raw/19ecd130b5854ea29c50de9bd985f56e00c6718e/src%2Feval.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Feval.rs?ref=19ecd130b5854ea29c50de9bd985f56e00c6718e", "patch": "@@ -57,6 +57,16 @@ pub enum IsolatedOp {\n     Allow,\n }\n \n+#[derive(Copy, Clone, PartialEq, Eq)]\n+pub enum BacktraceStyle {\n+    /// Prints a terser backtrace which ideally only contains relevant information.\n+    Short,\n+    /// Prints a backtrace with all possible information.\n+    Full,\n+    /// Prints only the frame that the error occurs in.\n+    Off,\n+}\n+\n /// Configuration needed to spawn a Miri instance.\n #[derive(Clone)]\n pub struct MiriConfig {\n@@ -98,6 +108,7 @@ pub struct MiriConfig {\n     pub measureme_out: Option<String>,\n     /// Panic when unsupported functionality is encountered\n     pub panic_on_unsupported: bool,\n+    pub backtrace_style: BacktraceStyle,\n }\n \n impl Default for MiriConfig {\n@@ -121,6 +132,7 @@ impl Default for MiriConfig {\n             cmpxchg_weak_failure_rate: 0.8,\n             measureme_out: None,\n             panic_on_unsupported: false,\n+            backtrace_style: BacktraceStyle::Short,\n         }\n     }\n }"}, {"sha": "006eedde4b6f5f17ca33fc6f982c10252eba9ffb", "filename": "src/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/19ecd130b5854ea29c50de9bd985f56e00c6718e/src%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/19ecd130b5854ea29c50de9bd985f56e00c6718e/src%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flib.rs?ref=19ecd130b5854ea29c50de9bd985f56e00c6718e", "patch": "@@ -60,7 +60,7 @@ pub use crate::diagnostics::{\n     NonHaltingDiagnostic, TerminationInfo,\n };\n pub use crate::eval::{\n-    create_ecx, eval_entry, AlignmentCheck, IsolatedOp, MiriConfig, RejectOpWith,\n+    create_ecx, eval_entry, AlignmentCheck, BacktraceStyle, IsolatedOp, MiriConfig, RejectOpWith,\n };\n pub use crate::helpers::EvalContextExt as HelpersEvalContextExt;\n pub use crate::machine::{"}, {"sha": "a75ac844902fc507b96769e95a57db8b0f4d47ce", "filename": "src/machine.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/19ecd130b5854ea29c50de9bd985f56e00c6718e/src%2Fmachine.rs", "raw_url": "https://github.com/rust-lang/rust/raw/19ecd130b5854ea29c50de9bd985f56e00c6718e/src%2Fmachine.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fmachine.rs?ref=19ecd130b5854ea29c50de9bd985f56e00c6718e", "patch": "@@ -343,6 +343,9 @@ pub struct Evaluator<'mir, 'tcx> {\n     /// functionality is encountered. If `false`, an error is propagated in the Miri application context\n     /// instead (default behavior)\n     pub(crate) panic_on_unsupported: bool,\n+\n+    /// Equivalent setting as RUST_BACKTRACE on encountering an error.\n+    pub(crate) backtrace_style: BacktraceStyle,\n }\n \n impl<'mir, 'tcx> Evaluator<'mir, 'tcx> {\n@@ -374,6 +377,7 @@ impl<'mir, 'tcx> Evaluator<'mir, 'tcx> {\n             string_cache: Default::default(),\n             exported_symbols_cache: FxHashMap::default(),\n             panic_on_unsupported: config.panic_on_unsupported,\n+            backtrace_style: config.backtrace_style,\n         }\n     }\n "}]}