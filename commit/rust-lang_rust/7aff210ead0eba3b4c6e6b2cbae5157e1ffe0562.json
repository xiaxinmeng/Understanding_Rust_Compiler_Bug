{"sha": "7aff210ead0eba3b4c6e6b2cbae5157e1ffe0562", "node_id": "C_kwDOAAsO6NoAKDdhZmYyMTBlYWQwZWJhM2I0YzZlNmIyY2JhZTUxNTdlMWZmZTA1NjI", "commit": {"author": {"name": "mejrs", "email": "", "date": "2023-01-08T23:00:41Z"}, "committer": {"name": "David Tolnay", "email": "dtolnay@gmail.com", "date": "2023-01-11T22:20:34Z"}, "message": "Support eager subdiagnostics again", "tree": {"sha": "0ce1ddd20d6bf5b093f945a1e685d06eeb2ab0ca", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0ce1ddd20d6bf5b093f945a1e685d06eeb2ab0ca"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7aff210ead0eba3b4c6e6b2cbae5157e1ffe0562", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEERijF2Cz/ZdaBZKeK+boUO5X/bYIFAmO/NjIACgkQ+boUO5X/\nbYJkhBAAkfpFHp0898Sv9KFRgkCNtZFOZppLb4Hgc5o2y4n1splKderQu4FhYkcw\ni1uohp88RFwQmrJ/E387vP3sUhtyrxxGYdvJfOLCjLWGPHLeOfmPIHvjD8+JPYYn\nXtkqCvibbWZTfla8+CP4qvX6Bm1M1YhsZ5Inh507TdQ+fXHRcBytU5RhjmVHWnrD\nxAKrBlhAP2rF0/GzVCdUbvnalOStRwbfjx3fog0x5Ly/r19LT3BzkxR5nFF8Su3l\nubMokvIh/89WmmqIBOOgekncgv+yPVe1KdRpBTPdz9n+5w8qMk4W/HE+jUWtWDRs\nJ2rErdQJfJoyyiv2XktFho50+PbjSRwlUjcSeW7N6SGSZRJFa1FFKO7rmqXQV26h\nTJAFNmWFX+EEsmvgk6BLGnSMYxO4frbi+tJOcQmta0szDaNvHXW3027+BZY3yMNt\nvnkPbFHLcY4MnkQSvVDeFmtX241Q9Fj3JLK6jOcDe3XuGDZdHdCzq8pZA9ZNU0a3\n1s6cB3lOb2efGgkK4UfcQ/q696eyVJZX2w6MGsHUdyn2gNplVf/aD3j3+xftV9Om\nHUXQYcFKQyDQxnYciSWalZbuqptiTy78aAumZpVWkteEhOczqhJhXnaXAS+JTE+I\nVJYSaCh4XOLWErpPDcxJ3UBD0yBTis6GIDSrHKpcM+HvjBGAChs=\n=SA3q\n-----END PGP SIGNATURE-----", "payload": "tree 0ce1ddd20d6bf5b093f945a1e685d06eeb2ab0ca\nparent ef4046e4f3932991971cdb64915172899532aece\nauthor mejrs <> 1673218841 +0100\ncommitter David Tolnay <dtolnay@gmail.com> 1673475634 -0800\n\nSupport eager subdiagnostics again\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7aff210ead0eba3b4c6e6b2cbae5157e1ffe0562", "html_url": "https://github.com/rust-lang/rust/commit/7aff210ead0eba3b4c6e6b2cbae5157e1ffe0562", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7aff210ead0eba3b4c6e6b2cbae5157e1ffe0562/comments", "author": {}, "committer": {"login": "dtolnay", "id": 1940490, "node_id": "MDQ6VXNlcjE5NDA0OTA=", "avatar_url": "https://avatars.githubusercontent.com/u/1940490?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dtolnay", "html_url": "https://github.com/dtolnay", "followers_url": "https://api.github.com/users/dtolnay/followers", "following_url": "https://api.github.com/users/dtolnay/following{/other_user}", "gists_url": "https://api.github.com/users/dtolnay/gists{/gist_id}", "starred_url": "https://api.github.com/users/dtolnay/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dtolnay/subscriptions", "organizations_url": "https://api.github.com/users/dtolnay/orgs", "repos_url": "https://api.github.com/users/dtolnay/repos", "events_url": "https://api.github.com/users/dtolnay/events{/privacy}", "received_events_url": "https://api.github.com/users/dtolnay/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ef4046e4f3932991971cdb64915172899532aece", "url": "https://api.github.com/repos/rust-lang/rust/commits/ef4046e4f3932991971cdb64915172899532aece", "html_url": "https://github.com/rust-lang/rust/commit/ef4046e4f3932991971cdb64915172899532aece"}], "stats": {"total": 59, "additions": 29, "deletions": 30}, "files": [{"sha": "e405462bbb862268856c601acf1e0711bbce8cdd", "filename": "compiler/rustc_macros/src/diagnostics/diagnostic_builder.rs", "status": "modified", "additions": 20, "deletions": 4, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/7aff210ead0eba3b4c6e6b2cbae5157e1ffe0562/compiler%2Frustc_macros%2Fsrc%2Fdiagnostics%2Fdiagnostic_builder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7aff210ead0eba3b4c6e6b2cbae5157e1ffe0562/compiler%2Frustc_macros%2Fsrc%2Fdiagnostics%2Fdiagnostic_builder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_macros%2Fsrc%2Fdiagnostics%2Fdiagnostic_builder.rs?ref=7aff210ead0eba3b4c6e6b2cbae5157e1ffe0562", "patch": "@@ -382,10 +382,26 @@ impl<'a> DiagnosticDeriveVariantBuilder<'a> {\n                     return Ok(quote! { #diag.subdiagnostic(#binding); });\n                 }\n             }\n-            (Meta::List(_), \"subdiagnostic\") => {\n-                throw_invalid_attr!(attr, &meta, |diag| {\n-                    diag.help(\"`subdiagnostic` does not support nested attributes\")\n-                })\n+            (Meta::List(MetaList { ref nested, .. }), \"subdiagnostic\") => {\n+                if nested.len() == 1\n+                    && let Some(NestedMeta::Meta(Meta::Path(path))) = nested.first()\n+                    && path.is_ident(\"eager\") {\n+                        let handler = match &self.parent.kind {\n+                            DiagnosticDeriveKind::Diagnostic { handler } => handler,\n+                            DiagnosticDeriveKind::LintDiagnostic => {\n+                                throw_invalid_attr!(attr, &meta, |diag| {\n+                                    diag.help(\"eager subdiagnostics are not supported on lints\")\n+                                })\n+                            }\n+                        };\n+                        return Ok(quote! { #diag.eager_subdiagnostic(#handler, #binding); });\n+                } else {\n+                    throw_invalid_attr!(attr, &meta, |diag| {\n+                        diag.help(\n+                            \"`eager` is the only supported nested attribute for `subdiagnostic`\",\n+                        )\n+                    })\n+                }\n             }\n             _ => (),\n         }"}, {"sha": "bb3722fe156e03b8d01a47d6bbdfe08675e16730", "filename": "compiler/rustc_macros/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7aff210ead0eba3b4c6e6b2cbae5157e1ffe0562/compiler%2Frustc_macros%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7aff210ead0eba3b4c6e6b2cbae5157e1ffe0562/compiler%2Frustc_macros%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_macros%2Fsrc%2Flib.rs?ref=7aff210ead0eba3b4c6e6b2cbae5157e1ffe0562", "patch": "@@ -1,5 +1,6 @@\n #![feature(allow_internal_unstable)]\n #![feature(if_let_guard)]\n+#![feature(let_chains)]\n #![feature(never_type)]\n #![feature(proc_macro_diagnostic)]\n #![feature(proc_macro_span)]"}, {"sha": "65d9601e78ab6980d05557915901a44ad72abfd9", "filename": "tests/ui-fulldeps/session-diagnostic/diagnostic-derive.rs", "status": "modified", "additions": 0, "deletions": 2, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/7aff210ead0eba3b4c6e6b2cbae5157e1ffe0562/tests%2Fui-fulldeps%2Fsession-diagnostic%2Fdiagnostic-derive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7aff210ead0eba3b4c6e6b2cbae5157e1ffe0562/tests%2Fui-fulldeps%2Fsession-diagnostic%2Fdiagnostic-derive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-fulldeps%2Fsession-diagnostic%2Fdiagnostic-derive.rs?ref=7aff210ead0eba3b4c6e6b2cbae5157e1ffe0562", "patch": "@@ -723,7 +723,6 @@ struct SubdiagnosticEagerLint {\n #[diag(compiletest_example)]\n struct SubdiagnosticEagerCorrect {\n     #[subdiagnostic(eager)]\n-    //~^ ERROR `#[subdiagnostic(...)]` is not a valid attribute\n     note: Note,\n }\n \n@@ -744,7 +743,6 @@ pub(crate) struct SubdiagnosticWithSuggestion {\n #[diag(compiletest_example)]\n struct SubdiagnosticEagerSuggestion {\n     #[subdiagnostic(eager)]\n-    //~^ ERROR `#[subdiagnostic(...)]` is not a valid attribute\n     sub: SubdiagnosticWithSuggestion,\n }\n "}, {"sha": "13e806a434f637f9e4bb2ca8efec71b06f922ef4", "filename": "tests/ui-fulldeps/session-diagnostic/diagnostic-derive.stderr", "status": "modified", "additions": 8, "deletions": 24, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/7aff210ead0eba3b4c6e6b2cbae5157e1ffe0562/tests%2Fui-fulldeps%2Fsession-diagnostic%2Fdiagnostic-derive.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/7aff210ead0eba3b4c6e6b2cbae5157e1ffe0562/tests%2Fui-fulldeps%2Fsession-diagnostic%2Fdiagnostic-derive.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-fulldeps%2Fsession-diagnostic%2Fdiagnostic-derive.stderr?ref=7aff210ead0eba3b4c6e6b2cbae5157e1ffe0562", "patch": "@@ -539,7 +539,7 @@ error: `#[subdiagnostic(...)]` is not a valid attribute\n LL |     #[subdiagnostic(bad)]\n    |     ^^^^^^^^^^^^^^^^^^^^^\n    |\n-   = help: `subdiagnostic` does not support nested attributes\n+   = help: `eager` is the only supported nested attribute for `subdiagnostic`\n \n error: `#[subdiagnostic = ...]` is not a valid attribute\n   --> $DIR/diagnostic-derive.rs:693:5\n@@ -553,54 +553,38 @@ error: `#[subdiagnostic(...)]` is not a valid attribute\n LL |     #[subdiagnostic(bad, bad)]\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |\n-   = help: `subdiagnostic` does not support nested attributes\n+   = help: `eager` is the only supported nested attribute for `subdiagnostic`\n \n error: `#[subdiagnostic(...)]` is not a valid attribute\n   --> $DIR/diagnostic-derive.rs:709:5\n    |\n LL |     #[subdiagnostic(\"bad\")]\n    |     ^^^^^^^^^^^^^^^^^^^^^^^\n    |\n-   = help: `subdiagnostic` does not support nested attributes\n+   = help: `eager` is the only supported nested attribute for `subdiagnostic`\n \n error: `#[subdiagnostic(...)]` is not a valid attribute\n   --> $DIR/diagnostic-derive.rs:717:5\n    |\n LL |     #[subdiagnostic(eager)]\n    |     ^^^^^^^^^^^^^^^^^^^^^^^\n    |\n-   = help: `subdiagnostic` does not support nested attributes\n-\n-error: `#[subdiagnostic(...)]` is not a valid attribute\n-  --> $DIR/diagnostic-derive.rs:725:5\n-   |\n-LL |     #[subdiagnostic(eager)]\n-   |     ^^^^^^^^^^^^^^^^^^^^^^^\n-   |\n-   = help: `subdiagnostic` does not support nested attributes\n-\n-error: `#[subdiagnostic(...)]` is not a valid attribute\n-  --> $DIR/diagnostic-derive.rs:746:5\n-   |\n-LL |     #[subdiagnostic(eager)]\n-   |     ^^^^^^^^^^^^^^^^^^^^^^^\n-   |\n-   = help: `subdiagnostic` does not support nested attributes\n+   = help: eager subdiagnostics are not supported on lints\n \n error: expected at least one string literal for `code(...)`\n-  --> $DIR/diagnostic-derive.rs:777:18\n+  --> $DIR/diagnostic-derive.rs:775:18\n    |\n LL |     #[suggestion(code())]\n    |                  ^^^^^^\n \n error: `code(...)` must contain only string literals\n-  --> $DIR/diagnostic-derive.rs:785:23\n+  --> $DIR/diagnostic-derive.rs:783:23\n    |\n LL |     #[suggestion(code(foo))]\n    |                       ^^^\n \n error: `code = \"...\"`/`code(...)` must contain only string literals\n-  --> $DIR/diagnostic-derive.rs:793:18\n+  --> $DIR/diagnostic-derive.rs:791:18\n    |\n LL |     #[suggestion(code = 3)]\n    |                  ^^^^^^^^\n@@ -676,7 +660,7 @@ note: required by a bound in `DiagnosticBuilder::<'a, G>::set_arg`\n   --> $COMPILER_DIR/rustc_errors/src/diagnostic_builder.rs:LL:CC\n    = note: this error originates in the derive macro `Diagnostic` which comes from the expansion of the macro `forward` (in Nightly builds, run with -Z macro-backtrace for more info)\n \n-error: aborting due to 85 previous errors\n+error: aborting due to 83 previous errors\n \n Some errors have detailed explanations: E0277, E0425.\n For more information about an error, try `rustc --explain E0277`."}]}