{"sha": "9bcbc58eba8563e6b829941d65c42a24476e7048", "node_id": "C_kwDOAAsO6NoAKDliY2JjNThlYmE4NTYzZTZiODI5OTQxZDY1YzQyYTI0NDc2ZTcwNDg", "commit": {"author": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2021-12-09T00:35:53Z"}, "committer": {"name": "Aaron Hill", "email": "aa1ronham@gmail.com", "date": "2021-12-09T00:38:35Z"}, "message": "Install llvm tools to sysroot when assembling local toolchain\n\nSome projects (e.g. the `bootimage` crate) may require the\nuser to install the `llvm-tools-preview` rustup component.\nHowever, this cannot be easily done with a locally built toolchain.\n\nTo allow a local toolchain to be used a drop-in replacement for\na normal rustup toolchain in more cases, this PR copies the built\nLLVM tools to the sysoot. From the perspective a tool looking\nat the sysroot, this is equivalent to installing `llvm-tools-preview`.", "tree": {"sha": "cf766f99860699fd7aff0c521d18470e0b3c6b31", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cf766f99860699fd7aff0c521d18470e0b3c6b31"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9bcbc58eba8563e6b829941d65c42a24476e7048", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE7J9Gc3TfBwj2K399tAh+UQ6YsWQFAmGxUAsACgkQtAh+UQ6Y\nsWR9HQ//TBzTdqr8lmbVDVW9obSxv+axbQlyvHAVX9G57eVjuX38bkrdgFK532hE\nYBu+7/Sxq1RilJmljeDSUo0xfxrMt9Ga9q9VPpMygGJuNcVulW8455J5RzS491fT\n72k2NOy+AhMG1PyLZ7k9YNuLMzkmnQmrmGo6mNz91TmDbY2dW14HGNxWfG+2/rpG\n+ctRvfeuBIykLK+XpB+kIrME+Q90xk+UIpK5Ya4oMjMXjn09cEtPYEt49xQ05iRO\nlgjbunI+cpCQeAizSJRueCmZIQNOYfjdhlOqWIXAP/1E9Q0Yh8/oCVKGLuzL6wlX\nhCRPWOc3t8C7UgT7Uj8otlBMV7l7uZbbp3qdtvPXgvRCrS2Y+P1Vux7a/KXqkJhx\ni1j2I6jsiJhnuQY9YMETR0pquk+tFaxQFOBvZaMdsvXoUwEt8r3dmr571733eJmn\nbOZ9jR1LC6WYyK1TzgmINeP2v7NWHLlFOy01JDzm/RdMURk7xLnZ+T5rkRqXZyOD\n0eISiNIXsgFFP3OEEF+21+6Va9iSBoV8TR2OhX4v4FGc2/zBgj5b3vYM3ahu4iPL\nzEQ5lm1j0n2yYgXKLZ8aB3fT2HqRwU4cwA/ENOn742+55dzvEW61Ic/GS1yBQkXw\nwtCSQsB8wWdQhzagWtEXlPheuBfm2vN+D8idrsincd/Xnr6owGg=\n=/z9r\n-----END PGP SIGNATURE-----", "payload": "tree cf766f99860699fd7aff0c521d18470e0b3c6b31\nparent e6b883c74f49f32cb5d1cbad3457f2b8805a4a38\nauthor Aaron Hill <aa1ronham@gmail.com> 1639010153 -0600\ncommitter Aaron Hill <aa1ronham@gmail.com> 1639010315 -0600\n\nInstall llvm tools to sysroot when assembling local toolchain\n\nSome projects (e.g. the `bootimage` crate) may require the\nuser to install the `llvm-tools-preview` rustup component.\nHowever, this cannot be easily done with a locally built toolchain.\n\nTo allow a local toolchain to be used a drop-in replacement for\na normal rustup toolchain in more cases, this PR copies the built\nLLVM tools to the sysoot. From the perspective a tool looking\nat the sysroot, this is equivalent to installing `llvm-tools-preview`.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9bcbc58eba8563e6b829941d65c42a24476e7048", "html_url": "https://github.com/rust-lang/rust/commit/9bcbc58eba8563e6b829941d65c42a24476e7048", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9bcbc58eba8563e6b829941d65c42a24476e7048/comments", "author": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Aaron1011", "id": 1408859, "node_id": "MDQ6VXNlcjE0MDg4NTk=", "avatar_url": "https://avatars.githubusercontent.com/u/1408859?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Aaron1011", "html_url": "https://github.com/Aaron1011", "followers_url": "https://api.github.com/users/Aaron1011/followers", "following_url": "https://api.github.com/users/Aaron1011/following{/other_user}", "gists_url": "https://api.github.com/users/Aaron1011/gists{/gist_id}", "starred_url": "https://api.github.com/users/Aaron1011/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Aaron1011/subscriptions", "organizations_url": "https://api.github.com/users/Aaron1011/orgs", "repos_url": "https://api.github.com/users/Aaron1011/repos", "events_url": "https://api.github.com/users/Aaron1011/events{/privacy}", "received_events_url": "https://api.github.com/users/Aaron1011/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e6b883c74f49f32cb5d1cbad3457f2b8805a4a38", "url": "https://api.github.com/repos/rust-lang/rust/commits/e6b883c74f49f32cb5d1cbad3457f2b8805a4a38", "html_url": "https://github.com/rust-lang/rust/commit/e6b883c74f49f32cb5d1cbad3457f2b8805a4a38"}], "stats": {"total": 11, "additions": 11, "deletions": 0}, "files": [{"sha": "186b5e92d33e35dfa5c31fe79798e7d565b2b99d", "filename": "src/bootstrap/compile.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/9bcbc58eba8563e6b829941d65c42a24476e7048/src%2Fbootstrap%2Fcompile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9bcbc58eba8563e6b829941d65c42a24476e7048/src%2Fbootstrap%2Fcompile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcompile.rs?ref=9bcbc58eba8563e6b829941d65c42a24476e7048", "patch": "@@ -28,6 +28,7 @@ use crate::dist;\n use crate::native;\n use crate::tool::SourceType;\n use crate::util::{exe, is_debug_info, is_dylib, symlink_dir};\n+use crate::LLVM_TOOLS;\n use crate::{Compiler, DependencyType, GitRepo, Mode};\n \n #[derive(Debug, PartialOrd, Ord, Copy, Clone, PartialEq, Eq, Hash)]\n@@ -1164,6 +1165,16 @@ impl Step for Assemble {\n                 let llvm_bin_dir = output(Command::new(llvm_config_bin).arg(\"--bindir\"));\n                 let llvm_bin_dir = Path::new(llvm_bin_dir.trim());\n                 builder.copy(&llvm_bin_dir.join(&src_exe), &libdir_bin.join(&dst_exe));\n+\n+                // Since we've already built the LLVM tools, install them to the sysroot.\n+                // This is the equivalent of installing the `llvm-tools-preview` component via\n+                // rustup, and lets developers use a locally built toolchain to\n+                // build projects that expect llvm tools to be present in the sysroot\n+                // (e.g. the `bootimage` crate).\n+                for tool in LLVM_TOOLS {\n+                    let tool_exe = exe(tool, target_compiler.host);\n+                    builder.copy(&llvm_bin_dir.join(&tool_exe), &libdir_bin.join(&tool_exe));\n+                }\n             }\n         }\n "}]}