{"sha": "62989008956e284e6d0c61032ea8b67fbe735338", "node_id": "MDY6Q29tbWl0NzI0NzEyOjYyOTg5MDA4OTU2ZTI4NGU2ZDBjNjEwMzJlYThiNjdmYmU3MzUzMzg=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2014-03-13T23:23:10Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2014-03-13T23:23:10Z"}, "message": "std: Demangle more escapes in backtraces\n\nThe rust compiler not only outputs symbols in the form that C++ does, but it\nalso mangle symbols like '&' and '~' to special compiler-defined escape\nsequences. For convenience, these symbols are demangled when printing\nbacktraces.", "tree": {"sha": "00ce4f094d562308cade71534892edbfe4d4a66d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/00ce4f094d562308cade71534892edbfe4d4a66d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/62989008956e284e6d0c61032ea8b67fbe735338", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/62989008956e284e6d0c61032ea8b67fbe735338", "html_url": "https://github.com/rust-lang/rust/commit/62989008956e284e6d0c61032ea8b67fbe735338", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/62989008956e284e6d0c61032ea8b67fbe735338/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b4d324334cb48198c27d782002d75eba14a6abde", "url": "https://api.github.com/repos/rust-lang/rust/commits/b4d324334cb48198c27d782002d75eba14a6abde", "html_url": "https://github.com/rust-lang/rust/commit/b4d324334cb48198c27d782002d75eba14a6abde"}], "stats": {"total": 61, "additions": 54, "deletions": 7}, "files": [{"sha": "831f6c73e35f17bb98d50076f112fa81f990a029", "filename": "src/libstd/rt/backtrace.rs", "status": "modified", "additions": 54, "deletions": 7, "changes": 61, "blob_url": "https://github.com/rust-lang/rust/blob/62989008956e284e6d0c61032ea8b67fbe735338/src%2Flibstd%2Frt%2Fbacktrace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/62989008956e284e6d0c61032ea8b67fbe735338/src%2Flibstd%2Frt%2Fbacktrace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Frt%2Fbacktrace.rs?ref=62989008956e284e6d0c61032ea8b67fbe735338", "patch": "@@ -91,8 +91,47 @@ fn demangle(writer: &mut Writer, s: &str) -> IoResult<()> {\n                 rest = rest.slice_from(1);\n             }\n             let i: uint = from_str(s.slice_to(s.len() - rest.len())).unwrap();\n-            try!(writer.write_str(rest.slice_to(i)));\n             s = rest.slice_from(i);\n+            rest = rest.slice_to(i);\n+            loop {\n+                if rest.starts_with(\"$\") {\n+                    macro_rules! demangle(\n+                        ($($pat:expr => $demangled:expr),*) => ({\n+                            $(if rest.starts_with($pat) {\n+                                try!(writer.write_str($demangled));\n+                                rest = rest.slice_from($pat.len());\n+                              } else)*\n+                            {\n+                                try!(writer.write_str(rest));\n+                                break;\n+                            }\n+\n+                        })\n+                    )\n+                    // see src/librustc/back/link.rs for these mappings\n+                    demangle! (\n+                        \"$SP$\" => \"@\",\n+                        \"$UP$\" => \"~\",\n+                        \"$RP$\" => \"*\",\n+                        \"$BP$\" => \"&\",\n+                        \"$LT$\" => \"<\",\n+                        \"$GT$\" => \">\",\n+                        \"$LP$\" => \"(\",\n+                        \"$RP$\" => \")\",\n+                        \"$C$\"  => \",\",\n+\n+                        // in theory we can demangle any unicode code point, but\n+                        // for simplicity we just catch the common ones.\n+                        \"$x20\" => \" \",\n+                        \"$x27\" => \"'\",\n+                        \"$x5b\" => \"[\",\n+                        \"$x5d\" => \"]\"\n+                    )\n+                } else {\n+                    try!(writer.write_str(rest));\n+                    break;\n+                }\n+            }\n         }\n     }\n \n@@ -698,17 +737,25 @@ mod test {\n     use io::MemWriter;\n     use str;\n \n+    macro_rules! t( ($a:expr, $b:expr) => ({\n+        let mut m = MemWriter::new();\n+        super::demangle(&mut m, $a).unwrap();\n+        assert_eq!(str::from_utf8_owned(m.unwrap()).unwrap(), $b.to_owned());\n+    }) )\n+\n     #[test]\n     fn demangle() {\n-        macro_rules! t( ($a:expr, $b:expr) => ({\n-            let mut m = MemWriter::new();\n-            super::demangle(&mut m, $a);\n-            assert_eq!(str::from_utf8_owned(m.unwrap()).unwrap(), $b.to_owned());\n-        }) )\n-\n         t!(\"test\", \"test\");\n         t!(\"_ZN4testE\", \"test\");\n         t!(\"_ZN4test\", \"_ZN4test\");\n         t!(\"_ZN4test1a2bcE\", \"test::a::bc\");\n     }\n+\n+    #[test]\n+    fn demangle_dollars() {\n+        t!(\"_ZN4$UP$E\", \"~\");\n+        t!(\"_ZN8$UP$testE\", \"~test\");\n+        t!(\"_ZN8$UP$test4foobE\", \"~test::foob\");\n+        t!(\"_ZN8$x20test4foobE\", \" test::foob\");\n+    }\n }"}]}