{"sha": "2f247140817c9cbd9009085c9f9ccedb4f6a718f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJmMjQ3MTQwODE3YzljYmQ5MDA5MDg1YzlmOWNjZWRiNGY2YTcxOGY=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-11-09T11:40:08Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-11-09T11:40:08Z"}, "message": "Merge #6501\n\n6501: Remove text_edit_builder api from AssistBuilder r=matklad a=Veykril\n\nAlso fixes a small bug in `expand_glob_import` in regards to the very nice looking `something::{*}` import when only one item was used. Before it would duplicate the path and just append it, causing the following wrong import `something::something::UsedItem`.\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>", "tree": {"sha": "9866d241ed3345fd89ac511eba4bd3d85bd41171", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9866d241ed3345fd89ac511eba4bd3d85bd41171"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2f247140817c9cbd9009085c9f9ccedb4f6a718f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfqSqYCRBK7hj4Ov3rIwAAdHIIAJXDEsKErzxurZCy9mLVW7VQ\nXV0o42CupYCN1rz4RFfo7090exjAo8TJI1WKID5T6F13RBpD3JuvdlvzLFzlZdN6\nrKDpTi8kwDKWYfR+9mmltFdch2dbHtINHruv0kdxQ2b5auvkD39EeTsqi1sJj84V\nb+5vdIsCqusjdyhXWm59uUDX/dlYWtodbGg/08cdI3wEHGWFDnmaRcZNqDZ+eSKu\nyRl5HubsnLqEzCzHCe7IN7CZVgCk5ZxkARwwFZOndzcCSBVwZjFn86zNkbDe6qJ3\n85t3W5OUu1py4HJ1fJWYLPN3MD58FmjQSSa6YTqP9uU//Ee1WQRiRNkNCU7WF7c=\n=LsiW\n-----END PGP SIGNATURE-----\n", "payload": "tree 9866d241ed3345fd89ac511eba4bd3d85bd41171\nparent a12088456072459c7df2d9d8f077a69ab518710a\nparent 4c03d98db4638729e8b47449ba76bf51e33cd444\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1604922008 +0000\ncommitter GitHub <noreply@github.com> 1604922008 +0000\n\nMerge #6501\n\n6501: Remove text_edit_builder api from AssistBuilder r=matklad a=Veykril\n\nAlso fixes a small bug in `expand_glob_import` in regards to the very nice looking `something::{*}` import when only one item was used. Before it would duplicate the path and just append it, causing the following wrong import `something::something::UsedItem`.\n\nCo-authored-by: Lukas Wirth <lukastw97@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2f247140817c9cbd9009085c9f9ccedb4f6a718f", "html_url": "https://github.com/rust-lang/rust/commit/2f247140817c9cbd9009085c9f9ccedb4f6a718f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2f247140817c9cbd9009085c9f9ccedb4f6a718f/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a12088456072459c7df2d9d8f077a69ab518710a", "url": "https://api.github.com/repos/rust-lang/rust/commits/a12088456072459c7df2d9d8f077a69ab518710a", "html_url": "https://github.com/rust-lang/rust/commit/a12088456072459c7df2d9d8f077a69ab518710a"}, {"sha": "4c03d98db4638729e8b47449ba76bf51e33cd444", "url": "https://api.github.com/repos/rust-lang/rust/commits/4c03d98db4638729e8b47449ba76bf51e33cd444", "html_url": "https://github.com/rust-lang/rust/commit/4c03d98db4638729e8b47449ba76bf51e33cd444"}], "stats": {"total": 86, "additions": 51, "deletions": 35}, "files": [{"sha": "51a160f405f79e676b15ea1cf221ea47cad3fd98", "filename": "crates/assists/src/assist_context.rs", "status": "modified", "additions": 0, "deletions": 6, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/2f247140817c9cbd9009085c9f9ccedb4f6a718f/crates%2Fassists%2Fsrc%2Fassist_context.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f247140817c9cbd9009085c9f9ccedb4f6a718f/crates%2Fassists%2Fsrc%2Fassist_context.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fassists%2Fsrc%2Fassist_context.rs?ref=2f247140817c9cbd9009085c9f9ccedb4f6a718f", "patch": "@@ -275,12 +275,6 @@ impl AssistBuilder {\n         algo::diff(&node, &new).into_text_edit(&mut self.edit);\n     }\n \n-    // FIXME: kill this API\n-    /// Get access to the raw `TextEditBuilder`.\n-    pub(crate) fn text_edit_builder(&mut self) -> &mut TextEditBuilder {\n-        &mut self.edit\n-    }\n-\n     fn finish(mut self) -> SourceChange {\n         self.commit();\n         let mut change = mem::take(&mut self.change);"}, {"sha": "f51a9a4ad157d3a1f7a393ec4279f04076601526", "filename": "crates/assists/src/handlers/expand_glob_import.rs", "status": "modified", "additions": 48, "deletions": 28, "changes": 76, "blob_url": "https://github.com/rust-lang/rust/blob/2f247140817c9cbd9009085c9f9ccedb4f6a718f/crates%2Fassists%2Fsrc%2Fhandlers%2Fexpand_glob_import.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f247140817c9cbd9009085c9f9ccedb4f6a718f/crates%2Fassists%2Fsrc%2Fhandlers%2Fexpand_glob_import.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fassists%2Fsrc%2Fhandlers%2Fexpand_glob_import.rs?ref=2f247140817c9cbd9009085c9f9ccedb4f6a718f", "patch": "@@ -5,13 +5,13 @@ use ide_db::{\n     search::SearchScope,\n };\n use syntax::{\n-    algo,\n+    algo::SyntaxRewriter,\n     ast::{self, make},\n     AstNode, Direction, SyntaxNode, SyntaxToken, T,\n };\n \n use crate::{\n-    assist_context::{AssistBuilder, AssistContext, Assists},\n+    assist_context::{AssistContext, Assists},\n     AssistId, AssistKind,\n };\n \n@@ -61,7 +61,9 @@ pub(crate) fn expand_glob_import(acc: &mut Assists, ctx: &AssistContext) -> Opti\n         \"Expand glob import\",\n         target.text_range(),\n         |builder| {\n-            replace_ast(builder, parent, mod_path, names_to_import);\n+            let mut rewriter = SyntaxRewriter::default();\n+            replace_ast(&mut rewriter, parent, mod_path, names_to_import);\n+            builder.rewrite(rewriter);\n         },\n     )\n }\n@@ -236,7 +238,7 @@ fn find_names_to_import(\n }\n \n fn replace_ast(\n-    builder: &mut AssistBuilder,\n+    rewriter: &mut SyntaxRewriter,\n     parent: Either<ast::UseTree, ast::UseTreeList>,\n     path: ast::Path,\n     names_to_import: Vec<Name>,\n@@ -264,32 +266,21 @@ fn replace_ast(\n     match use_trees.as_slice() {\n         [name] => {\n             if let Some(end_path) = name.path() {\n-                let replacement =\n-                    make::use_tree(make::path_concat(path, end_path), None, None, false);\n-\n-                algo::diff(\n-                    &parent.either(|n| n.syntax().clone(), |n| n.syntax().clone()),\n-                    replacement.syntax(),\n-                )\n-                .into_text_edit(builder.text_edit_builder());\n+                rewriter.replace_ast(\n+                    &parent.left_or_else(|tl| tl.parent_use_tree()),\n+                    &make::use_tree(make::path_concat(path, end_path), None, None, false),\n+                );\n             }\n         }\n-        names => {\n-            let replacement = match parent {\n-                Either::Left(_) => {\n-                    make::use_tree(path, Some(make::use_tree_list(names.to_owned())), None, false)\n-                        .syntax()\n-                        .clone()\n-                }\n-                Either::Right(_) => make::use_tree_list(names.to_owned()).syntax().clone(),\n-            };\n-\n-            algo::diff(\n-                &parent.either(|n| n.syntax().clone(), |n| n.syntax().clone()),\n-                &replacement,\n-            )\n-            .into_text_edit(builder.text_edit_builder());\n-        }\n+        names => match &parent {\n+            Either::Left(parent) => rewriter.replace_ast(\n+                parent,\n+                &make::use_tree(path, Some(make::use_tree_list(names.to_owned())), None, false),\n+            ),\n+            Either::Right(parent) => {\n+                rewriter.replace_ast(parent, &make::use_tree_list(names.to_owned()))\n+            }\n+        },\n     };\n }\n \n@@ -884,4 +875,33 @@ fn qux(baz: Baz) {}\n     \",\n         )\n     }\n+\n+    #[test]\n+    fn expanding_glob_import_single_nested_glob_only() {\n+        check_assist(\n+            expand_glob_import,\n+            r\"\n+mod foo {\n+    pub struct Bar;\n+}\n+\n+use foo::{*<|>};\n+\n+struct Baz {\n+    bar: Bar\n+}\n+\",\n+            r\"\n+mod foo {\n+    pub struct Bar;\n+}\n+\n+use foo::Bar;\n+\n+struct Baz {\n+    bar: Bar\n+}\n+\",\n+        );\n+    }\n }"}, {"sha": "7c0f0f44e1c76939105a604443fdab4c05b4709c", "filename": "crates/assists/src/handlers/reorder_fields.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/2f247140817c9cbd9009085c9f9ccedb4f6a718f/crates%2Fassists%2Fsrc%2Fhandlers%2Freorder_fields.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f247140817c9cbd9009085c9f9ccedb4f6a718f/crates%2Fassists%2Fsrc%2Fhandlers%2Freorder_fields.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fassists%2Fsrc%2Fhandlers%2Freorder_fields.rs?ref=2f247140817c9cbd9009085c9f9ccedb4f6a718f", "patch": "@@ -47,9 +47,11 @@ fn reorder<R: AstNode>(acc: &mut Assists, ctx: &AssistContext) -> Option<()> {\n         \"Reorder record fields\",\n         target,\n         |edit| {\n+            let mut rewriter = algo::SyntaxRewriter::default();\n             for (old, new) in fields.iter().zip(&sorted_fields) {\n-                algo::diff(old, new).into_text_edit(edit.text_edit_builder());\n+                rewriter.replace(old, new);\n             }\n+            edit.rewrite(rewriter);\n         },\n     )\n }"}]}