{"sha": "d7d098a7e63a09ff0f14db44e9dfadec30d70d97", "node_id": "C_kwDOAAsO6NoAKGQ3ZDA5OGE3ZTYzYTA5ZmYwZjE0ZGI0NGU5ZGZhZGVjMzBkNzBkOTc", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-11-30T19:29:40Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-11-30T19:29:40Z"}, "message": "Auto merge of #9997 - Jarcho:issue_9901, r=llogiq\n\nDon't lint `explicit_auto_deref` when the initial type is neither a reference, nor a receiver\n\nfixes #9901\nfixes #9777\nchangelog: `explicit_auto_deref`: Don't lint when the initial value is neither a reference, nor a receiver", "tree": {"sha": "10a259c53e635c83fa77cdfa907c16ca5ecc78fb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/10a259c53e635c83fa77cdfa907c16ca5ecc78fb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d7d098a7e63a09ff0f14db44e9dfadec30d70d97", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d7d098a7e63a09ff0f14db44e9dfadec30d70d97", "html_url": "https://github.com/rust-lang/rust/commit/d7d098a7e63a09ff0f14db44e9dfadec30d70d97", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d7d098a7e63a09ff0f14db44e9dfadec30d70d97/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "87963f03bae339175bf7ea6d94cf39d21a59b473", "url": "https://api.github.com/repos/rust-lang/rust/commits/87963f03bae339175bf7ea6d94cf39d21a59b473", "html_url": "https://github.com/rust-lang/rust/commit/87963f03bae339175bf7ea6d94cf39d21a59b473"}, {"sha": "2d32b403596d6ff152ccce3f1136b695698a3cc8", "url": "https://api.github.com/repos/rust-lang/rust/commits/2d32b403596d6ff152ccce3f1136b695698a3cc8", "html_url": "https://github.com/rust-lang/rust/commit/2d32b403596d6ff152ccce3f1136b695698a3cc8"}], "stats": {"total": 25, "additions": 19, "deletions": 6}, "files": [{"sha": "57c30661e88239ea035b7871dc083270517400db", "filename": "clippy_lints/src/dereference.rs", "status": "modified", "additions": 11, "deletions": 6, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/d7d098a7e63a09ff0f14db44e9dfadec30d70d97/clippy_lints%2Fsrc%2Fdereference.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d7d098a7e63a09ff0f14db44e9dfadec30d70d97/clippy_lints%2Fsrc%2Fdereference.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fdereference.rs?ref=d7d098a7e63a09ff0f14db44e9dfadec30d70d97", "patch": "@@ -289,23 +289,24 @@ impl<'tcx> LateLintPass<'tcx> for Dereferencing<'tcx> {\n                 let (position, adjustments) = walk_parents(cx, &mut self.possible_borrowers, expr, &self.msrv);\n                 match kind {\n                     RefOp::Deref => {\n+                        let sub_ty = typeck.expr_ty(sub_expr);\n                         if let Position::FieldAccess {\n                             name,\n                             of_union: false,\n                         } = position\n-                            && !ty_contains_field(typeck.expr_ty(sub_expr), name)\n+                            && !ty_contains_field(sub_ty, name)\n                         {\n                             self.state = Some((\n                                 State::ExplicitDerefField { name },\n                                 StateData { span: expr.span, hir_id: expr.hir_id, position },\n                             ));\n-                        } else if position.is_deref_stable() {\n+                        } else if position.is_deref_stable() && sub_ty.is_ref() {\n                             self.state = Some((\n                                 State::ExplicitDeref { mutability: None },\n                                 StateData { span: expr.span, hir_id: expr.hir_id, position },\n                             ));\n                         }\n-                    }\n+                    },\n                     RefOp::Method(target_mut)\n                         if !is_lint_allowed(cx, EXPLICIT_DEREF_METHODS, expr.hir_id)\n                             && position.lint_explicit_deref() =>\n@@ -320,7 +321,7 @@ impl<'tcx> LateLintPass<'tcx> for Dereferencing<'tcx> {\n                             StateData {\n                                 span: expr.span,\n                                 hir_id: expr.hir_id,\n-                                position\n+                                position,\n                             },\n                         ));\n                     },\n@@ -394,7 +395,11 @@ impl<'tcx> LateLintPass<'tcx> for Dereferencing<'tcx> {\n                                     msg,\n                                     snip_expr,\n                                 }),\n-                                StateData { span: expr.span, hir_id: expr.hir_id, position },\n+                                StateData {\n+                                    span: expr.span,\n+                                    hir_id: expr.hir_id,\n+                                    position,\n+                                },\n                             ));\n                         } else if position.is_deref_stable()\n                             // Auto-deref doesn't combine with other adjustments\n@@ -406,7 +411,7 @@ impl<'tcx> LateLintPass<'tcx> for Dereferencing<'tcx> {\n                                 StateData {\n                                     span: expr.span,\n                                     hir_id: expr.hir_id,\n-                                    position\n+                                    position,\n                                 },\n                             ));\n                         }"}, {"sha": "475fae5e823b31e66a484cae692c3ed6ab0ed2b6", "filename": "tests/ui/explicit_auto_deref.fixed", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d7d098a7e63a09ff0f14db44e9dfadec30d70d97/tests%2Fui%2Fexplicit_auto_deref.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/d7d098a7e63a09ff0f14db44e9dfadec30d70d97/tests%2Fui%2Fexplicit_auto_deref.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fexplicit_auto_deref.fixed?ref=d7d098a7e63a09ff0f14db44e9dfadec30d70d97", "patch": "@@ -277,4 +277,8 @@ fn main() {\n         unimplemented!()\n     }\n     let _: String = takes_assoc(&*String::new());\n+\n+    // Issue #9901\n+    fn takes_ref(_: &i32) {}\n+    takes_ref(*Box::new(&0i32));\n }"}, {"sha": "c1894258f4d84312d891f55472908489c5173aba", "filename": "tests/ui/explicit_auto_deref.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d7d098a7e63a09ff0f14db44e9dfadec30d70d97/tests%2Fui%2Fexplicit_auto_deref.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d7d098a7e63a09ff0f14db44e9dfadec30d70d97/tests%2Fui%2Fexplicit_auto_deref.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fexplicit_auto_deref.rs?ref=d7d098a7e63a09ff0f14db44e9dfadec30d70d97", "patch": "@@ -277,4 +277,8 @@ fn main() {\n         unimplemented!()\n     }\n     let _: String = takes_assoc(&*String::new());\n+\n+    // Issue #9901\n+    fn takes_ref(_: &i32) {}\n+    takes_ref(*Box::new(&0i32));\n }"}]}