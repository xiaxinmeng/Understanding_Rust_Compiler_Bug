{"sha": "df90f57a5f76059394abd8328d30003b844cb497", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRmOTBmNTdhNWY3NjA1OTM5NGFiZDgzMjhkMzAwMDNiODQ0Y2I0OTc=", "commit": {"author": {"name": "Patrick Walton", "email": "pcwalton@mimiga.net", "date": "2011-07-21T18:23:50Z"}, "committer": {"name": "Patrick Walton", "email": "pcwalton@mimiga.net", "date": "2011-07-21T18:24:20Z"}, "message": "rustc: Avoid SHA-1 hashing every type, since they're interned", "tree": {"sha": "1554bc8183606d7ba8d8e175126c5e0a4d05b9b2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1554bc8183606d7ba8d8e175126c5e0a4d05b9b2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/df90f57a5f76059394abd8328d30003b844cb497", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/df90f57a5f76059394abd8328d30003b844cb497", "html_url": "https://github.com/rust-lang/rust/commit/df90f57a5f76059394abd8328d30003b844cb497", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/df90f57a5f76059394abd8328d30003b844cb497/comments", "author": {"login": "pcwalton", "id": 157897, "node_id": "MDQ6VXNlcjE1Nzg5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/157897?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pcwalton", "html_url": "https://github.com/pcwalton", "followers_url": "https://api.github.com/users/pcwalton/followers", "following_url": "https://api.github.com/users/pcwalton/following{/other_user}", "gists_url": "https://api.github.com/users/pcwalton/gists{/gist_id}", "starred_url": "https://api.github.com/users/pcwalton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pcwalton/subscriptions", "organizations_url": "https://api.github.com/users/pcwalton/orgs", "repos_url": "https://api.github.com/users/pcwalton/repos", "events_url": "https://api.github.com/users/pcwalton/events{/privacy}", "received_events_url": "https://api.github.com/users/pcwalton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pcwalton", "id": 157897, "node_id": "MDQ6VXNlcjE1Nzg5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/157897?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pcwalton", "html_url": "https://github.com/pcwalton", "followers_url": "https://api.github.com/users/pcwalton/followers", "following_url": "https://api.github.com/users/pcwalton/following{/other_user}", "gists_url": "https://api.github.com/users/pcwalton/gists{/gist_id}", "starred_url": "https://api.github.com/users/pcwalton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pcwalton/subscriptions", "organizations_url": "https://api.github.com/users/pcwalton/orgs", "repos_url": "https://api.github.com/users/pcwalton/repos", "events_url": "https://api.github.com/users/pcwalton/events{/privacy}", "received_events_url": "https://api.github.com/users/pcwalton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c32f525f73b90dc30a6d6ff943cc716e43e84d73", "url": "https://api.github.com/repos/rust-lang/rust/commits/c32f525f73b90dc30a6d6ff943cc716e43e84d73", "html_url": "https://github.com/rust-lang/rust/commit/c32f525f73b90dc30a6d6ff943cc716e43e84d73"}], "stats": {"total": 38, "additions": 9, "deletions": 29}, "files": [{"sha": "098f7263005c57e0c21cf5b5db2227ad1cf13c0a", "filename": "src/comp/back/link.rs", "status": "modified", "additions": 5, "deletions": 25, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/df90f57a5f76059394abd8328d30003b844cb497/src%2Fcomp%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/df90f57a5f76059394abd8328d30003b844cb497/src%2Fcomp%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomp%2Fback%2Flink.rs?ref=df90f57a5f76059394abd8328d30003b844cb497", "patch": "@@ -399,38 +399,18 @@ fn truncated_sha1_result(sha1 sha) -> str {\n     ret str::substr(sha.result_str(), 0u, 16u);\n }\n \n-\n-// This calculates STH for a symbol, as defined above\n-fn symbol_hash(ty::ctxt tcx, sha1 sha, &ty::t t,\n-               &link_meta link_meta) -> str {\n-    // NB: do *not* use abbrevs here as we want the symbol names\n-    // to be independent of one another in the crate.\n-\n+fn hash_link_meta(sha1 sha, &link_meta link_meta) -> str {\n     sha.reset();\n     sha.input_str(link_meta.name);\n     sha.input_str(\"-\");\n-    // FIXME: This wants to be link_meta.meta_hash\n-    sha.input_str(link_meta.name);\n+    sha.input_str(link_meta.vers);\n     sha.input_str(\"-\");\n-    sha.input_str(encoder::encoded_ty(tcx, t));\n-    auto hash = truncated_sha1_result(sha);\n-    // Prefix with _ so that it never blends into adjacent digits\n-\n-    ret \"_\" + hash;\n+    sha.input_str(link_meta.extras_hash);\n+    ret truncated_sha1_result(sha);\n }\n \n fn get_symbol_hash(&@crate_ctxt ccx, &ty::t t) -> str {\n-    auto hash = \"\";\n-    alt (ccx.type_sha1s.find(t)) {\n-        case (some(?h)) { hash = h; }\n-        case (none) {\n-            hash =\n-                symbol_hash(ccx.tcx, ccx.sha, t,\n-                            ccx.link_meta);\n-            ccx.type_sha1s.insert(t, hash);\n-        }\n-    }\n-    ret hash;\n+    ret #fmt(\"_%s_%u\", ccx.link_meta_hash, t);\n }\n \n fn mangle(&str[] ss) -> str {"}, {"sha": "f0e76658eb29025197a52dfa10a7c7a14f7d5acb", "filename": "src/comp/middle/trans.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/df90f57a5f76059394abd8328d30003b844cb497/src%2Fcomp%2Fmiddle%2Ftrans.rs", "raw_url": "https://github.com/rust-lang/rust/raw/df90f57a5f76059394abd8328d30003b844cb497/src%2Fcomp%2Fmiddle%2Ftrans.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomp%2Fmiddle%2Ftrans.rs?ref=df90f57a5f76059394abd8328d30003b844cb497", "patch": "@@ -136,6 +136,7 @@ type crate_ctxt =\n         hashmap[ast::node_id, str] item_symbols,\n         mutable option::t[ValueRef] main_fn,\n         link::link_meta link_meta,\n+        str link_meta_hash,\n \n         // TODO: hashmap[tup(tag_id,subtys), @tag_info]\n         hashmap[ty::t, uint] tag_sizes,\n@@ -150,7 +151,6 @@ type crate_ctxt =\n         @glue_fns glues,\n         namegen names,\n         std::sha1::sha1 sha,\n-        hashmap[ty::t, str] type_sha1s,\n         hashmap[ty::t, str] type_short_names,\n         ty::ctxt tcx,\n         stats stats,\n@@ -8601,9 +8601,9 @@ fn trans_crate(&session::session sess, &@ast::crate crate, &ty::ctxt tcx,\n     auto tag_sizes = map::mk_hashmap[ty::t, uint](hasher, eqer);\n     auto tydescs = map::mk_hashmap[ty::t, @tydesc_info](hasher, eqer);\n     auto lltypes = map::mk_hashmap[ty::t, TypeRef](hasher, eqer);\n-    auto sha1s = map::mk_hashmap[ty::t, str](hasher, eqer);\n     auto short_names = map::mk_hashmap[ty::t, str](hasher, eqer);\n     auto sha = std::sha1::mk_sha1();\n+    auto link_meta = link::build_link_meta(sess, *crate, output, sha);\n     auto ccx =\n         @rec(sess=sess,\n              llmod=llmod,\n@@ -8615,7 +8615,8 @@ fn trans_crate(&session::session sess, &@ast::crate crate, &ty::ctxt tcx,\n              ast_map=amap,\n              item_symbols=new_int_hash[str](),\n              mutable main_fn=none[ValueRef],\n-             link_meta=link::build_link_meta(sess, *crate, output, sha),\n+             link_meta=link_meta,\n+             link_meta_hash=link::hash_link_meta(sha, link_meta),\n              tag_sizes=tag_sizes,\n              discrims=new_int_hash[ValueRef](),\n              discrim_symbols=new_int_hash[str](),\n@@ -8628,7 +8629,6 @@ fn trans_crate(&session::session sess, &@ast::crate crate, &ty::ctxt tcx,\n              glues=glues,\n              names=namegen(0),\n              sha=sha,\n-             type_sha1s=sha1s,\n              type_short_names=short_names,\n              tcx=tcx,\n              stats=rec(mutable n_static_tydescs=0u,"}]}