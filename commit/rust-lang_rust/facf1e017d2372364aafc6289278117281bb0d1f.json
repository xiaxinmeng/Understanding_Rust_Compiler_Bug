{"sha": "facf1e017d2372364aafc6289278117281bb0d1f", "node_id": "C_kwDOAAsO6NoAKGZhY2YxZTAxN2QyMzcyMzY0YWFmYzYyODkyNzgxMTcyODFiYjBkMWY", "commit": {"author": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2023-03-06T18:19:05Z"}, "committer": {"name": "Camille GILLOT", "email": "gillot.camille@gmail.com", "date": "2023-03-11T22:41:01Z"}, "message": "Use ensure for thir_abstract_const.", "tree": {"sha": "f8f546e0da871f63ad9ee6b3307da4577b04575e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f8f546e0da871f63ad9ee6b3307da4577b04575e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/facf1e017d2372364aafc6289278117281bb0d1f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/facf1e017d2372364aafc6289278117281bb0d1f", "html_url": "https://github.com/rust-lang/rust/commit/facf1e017d2372364aafc6289278117281bb0d1f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/facf1e017d2372364aafc6289278117281bb0d1f/comments", "author": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cjgillot", "id": 1822483, "node_id": "MDQ6VXNlcjE4MjI0ODM=", "avatar_url": "https://avatars.githubusercontent.com/u/1822483?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cjgillot", "html_url": "https://github.com/cjgillot", "followers_url": "https://api.github.com/users/cjgillot/followers", "following_url": "https://api.github.com/users/cjgillot/following{/other_user}", "gists_url": "https://api.github.com/users/cjgillot/gists{/gist_id}", "starred_url": "https://api.github.com/users/cjgillot/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cjgillot/subscriptions", "organizations_url": "https://api.github.com/users/cjgillot/orgs", "repos_url": "https://api.github.com/users/cjgillot/repos", "events_url": "https://api.github.com/users/cjgillot/events{/privacy}", "received_events_url": "https://api.github.com/users/cjgillot/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1ca103a16885564a999dce3916d97007766f2ff1", "url": "https://api.github.com/repos/rust-lang/rust/commits/1ca103a16885564a999dce3916d97007766f2ff1", "html_url": "https://github.com/rust-lang/rust/commit/1ca103a16885564a999dce3916d97007766f2ff1"}], "stats": {"total": 7, "additions": 2, "deletions": 5}, "files": [{"sha": "d51b031d36682bf0d0c75d880fb4b0af1284006c", "filename": "compiler/rustc_mir_build/src/build/mod.rs", "status": "modified", "additions": 2, "deletions": 5, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/facf1e017d2372364aafc6289278117281bb0d1f/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/facf1e017d2372364aafc6289278117281bb0d1f/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fmod.rs?ref=facf1e017d2372364aafc6289278117281bb0d1f", "patch": "@@ -48,17 +48,14 @@ pub(crate) fn mir_built(\n /// Construct the MIR for a given `DefId`.\n fn mir_build(tcx: TyCtxt<'_>, def: ty::WithOptConstParam<LocalDefId>) -> Body<'_> {\n     // Ensure unsafeck and abstract const building is ran before we steal the THIR.\n-    // We can't use `ensure()` for `thir_abstract_const` as it doesn't compute the query\n-    // if inputs are green. This can cause ICEs when calling `thir_abstract_const` after\n-    // THIR has been stolen if we haven't computed this query yet.\n     match def {\n         ty::WithOptConstParam { did, const_param_did: Some(const_param_did) } => {\n             tcx.ensure().thir_check_unsafety_for_const_arg((did, const_param_did));\n-            drop(tcx.thir_abstract_const_of_const_arg((did, const_param_did)));\n+            tcx.ensure().thir_abstract_const_of_const_arg((did, const_param_did));\n         }\n         ty::WithOptConstParam { did, const_param_did: None } => {\n             tcx.ensure().thir_check_unsafety(did);\n-            drop(tcx.thir_abstract_const(did));\n+            tcx.ensure().thir_abstract_const(did);\n         }\n     }\n "}]}