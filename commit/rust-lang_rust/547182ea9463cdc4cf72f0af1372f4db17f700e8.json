{"sha": "547182ea9463cdc4cf72f0af1372f4db17f700e8", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU0NzE4MmVhOTQ2M2NkYzRjZjcyZjBhZjEzNzJmNGRiMTdmNzAwZTg=", "commit": {"author": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2018-10-11T22:06:30Z"}, "committer": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2018-10-15T20:25:08Z"}, "message": "handle user-self-type for def-ids", "tree": {"sha": "f5f9b5e440c1c0bd0b9640ee7f34539a6a5a04d1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f5f9b5e440c1c0bd0b9640ee7f34539a6a5a04d1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/547182ea9463cdc4cf72f0af1372f4db17f700e8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/547182ea9463cdc4cf72f0af1372f4db17f700e8", "html_url": "https://github.com/rust-lang/rust/commit/547182ea9463cdc4cf72f0af1372f4db17f700e8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/547182ea9463cdc4cf72f0af1372f4db17f700e8/comments", "author": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0e1d3624e990e84299ab75926c865f19353e9b2f", "url": "https://api.github.com/repos/rust-lang/rust/commits/0e1d3624e990e84299ab75926c865f19353e9b2f", "html_url": "https://github.com/rust-lang/rust/commit/0e1d3624e990e84299ab75926c865f19353e9b2f"}], "stats": {"total": 24, "additions": 21, "deletions": 3}, "files": [{"sha": "a345d0484cf01ebbc231d7d30322811055522b8d", "filename": "src/librustc_mir/borrow_check/nll/type_check/relate_tys.rs", "status": "modified", "additions": 21, "deletions": 3, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/547182ea9463cdc4cf72f0af1372f4db17f700e8/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Ftype_check%2Frelate_tys.rs", "raw_url": "https://github.com/rust-lang/rust/raw/547182ea9463cdc4cf72f0af1372f4db17f700e8/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Ftype_check%2Frelate_tys.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fborrow_check%2Fnll%2Ftype_check%2Frelate_tys.rs?ref=547182ea9463cdc4cf72f0af1372f4db17f700e8", "patch": "@@ -15,7 +15,7 @@ use rustc::infer::{InferCtxt, NLLRegionVariableOrigin};\n use rustc::mir::{ConstraintCategory, UserTypeAnnotation};\n use rustc::traits::query::Fallible;\n use rustc::ty::relate::TypeRelation;\n-use rustc::ty::subst::UserSubsts;\n+use rustc::ty::subst::{Subst, UserSelfTy, UserSubsts};\n use rustc::ty::{self, Ty};\n use syntax_pos::DUMMY_SP;\n \n@@ -98,9 +98,24 @@ pub(super) fn relate_type_and_user_type<'tcx>(\n                 },\n                 _,\n             ) = infcx.instantiate_canonical_with_fresh_inference_vars(DUMMY_SP, &canonical_substs);\n-            assert!(user_self_ty.is_none()); // TODO for now\n             let ty = infcx.tcx.mk_fn_def(def_id, substs);\n+\n             type_relating.relate(&ty, &a)?;\n+\n+            if let Some(UserSelfTy {\n+                impl_def_id,\n+                self_ty,\n+            }) = user_self_ty\n+            {\n+                let impl_self_ty = infcx.tcx.type_of(impl_def_id);\n+                let impl_self_ty = impl_self_ty.subst(infcx.tcx, &substs);\n+                type_relating.relate_with_variance(\n+                    ty::Variance::Invariant,\n+                    &self_ty,\n+                    &impl_self_ty,\n+                )?;\n+            }\n+\n             Ok(ty)\n         }\n         UserTypeAnnotation::AdtDef(adt_def, canonical_substs) => {\n@@ -111,7 +126,10 @@ pub(super) fn relate_type_and_user_type<'tcx>(\n                 },\n                 _,\n             ) = infcx.instantiate_canonical_with_fresh_inference_vars(DUMMY_SP, &canonical_substs);\n-            assert!(user_self_ty.is_none()); // TODO for now\n+\n+            // We don't extract adt-defs with a self-type.\n+            assert!(user_self_ty.is_none());\n+\n             let ty = infcx.tcx.mk_adt(adt_def, substs);\n             type_relating.relate(&ty, &a)?;\n             Ok(ty)"}]}