{"sha": "1c2f641e15a91f38cb5b67381de474bdcb1d5e0c", "node_id": "C_kwDOAAsO6NoAKDFjMmY2NDFlMTVhOTFmMzhjYjViNjczODFkZTQ3NGJkY2IxZDVlMGM", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-03-05T19:57:21Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-03-05T19:57:21Z"}, "message": "Rollup merge of #108764 - cjgillot:dpm-adapt, r=compiler-errors\n\nTweaks to -Zdrop-tracking-mir\n\nSplit from https://github.com/rust-lang/rust/pull/107421\n\n3 commits: 1 diagnostic improvement and 2 ICEs.", "tree": {"sha": "74ed608de814d2b4bbf05baa1fad08d3b3d5b010", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/74ed608de814d2b4bbf05baa1fad08d3b3d5b010"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1c2f641e15a91f38cb5b67381de474bdcb1d5e0c", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkBPQhCRBK7hj4Ov3rIwAAGBMIAFsc+KWfAlhmKRm2Z/26BCOP\n3mfIL/GzNWs7a+liVBICjcvGAFKzmdJVBSt3B+iVI3tRrSK/SMPwwC5A7MFvmxxP\ndQm78I9XeY24+0FbOOKIXKJpADBLOBW0XHEAPZVppfjRQ61xBXysqa7f/Vtj2LIF\nrRuAak4Cc1ddc5zeu6PSKccKC6/iTbAetCsQyBUP6wYnESVNCArF6Rq2yw4ZD31d\nH5DgYCVPxziMgMkoyh10r9MMTMk7XK4PjNsXmABmtc/LH+6EX13V2nwHCMriVXWN\n9PzHFFUKuY3W9qi9g65lp38WisMztYbmLigxRvateB2sMHUwOb2EaQQwBGXurRE=\n=ZnTy\n-----END PGP SIGNATURE-----\n", "payload": "tree 74ed608de814d2b4bbf05baa1fad08d3b3d5b010\nparent b8762321a2978c8fd6d3e451132afbd4703df7f0\nparent fba5d3dd03a0dcb0ed544950bd00f50f85f493ef\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1678046241 +0100\ncommitter GitHub <noreply@github.com> 1678046241 +0100\n\nRollup merge of #108764 - cjgillot:dpm-adapt, r=compiler-errors\n\nTweaks to -Zdrop-tracking-mir\n\nSplit from https://github.com/rust-lang/rust/pull/107421\n\n3 commits: 1 diagnostic improvement and 2 ICEs.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1c2f641e15a91f38cb5b67381de474bdcb1d5e0c", "html_url": "https://github.com/rust-lang/rust/commit/1c2f641e15a91f38cb5b67381de474bdcb1d5e0c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1c2f641e15a91f38cb5b67381de474bdcb1d5e0c/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b8762321a2978c8fd6d3e451132afbd4703df7f0", "url": "https://api.github.com/repos/rust-lang/rust/commits/b8762321a2978c8fd6d3e451132afbd4703df7f0", "html_url": "https://github.com/rust-lang/rust/commit/b8762321a2978c8fd6d3e451132afbd4703df7f0"}, {"sha": "fba5d3dd03a0dcb0ed544950bd00f50f85f493ef", "url": "https://api.github.com/repos/rust-lang/rust/commits/fba5d3dd03a0dcb0ed544950bd00f50f85f493ef", "html_url": "https://github.com/rust-lang/rust/commit/fba5d3dd03a0dcb0ed544950bd00f50f85f493ef"}], "stats": {"total": 27, "additions": 20, "deletions": 7}, "files": [{"sha": "3449d3d439dfc35c5db562d66b59d417b0be9104", "filename": "compiler/rustc_hir_analysis/src/check/check.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/1c2f641e15a91f38cb5b67381de474bdcb1d5e0c/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fcheck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1c2f641e15a91f38cb5b67381de474bdcb1d5e0c/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fcheck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_analysis%2Fsrc%2Fcheck%2Fcheck.rs?ref=1c2f641e15a91f38cb5b67381de474bdcb1d5e0c", "patch": "@@ -1510,6 +1510,14 @@ fn opaque_type_cycle_error(\n                     {\n                         label_match(interior_ty.ty, interior_ty.span);\n                     }\n+                    if tcx.sess.opts.unstable_opts.drop_tracking_mir\n+                        && let DefKind::Generator = tcx.def_kind(closure_def_id)\n+                    {\n+                        let generator_layout = tcx.mir_generator_witnesses(closure_def_id);\n+                        for interior_ty in &generator_layout.field_tys {\n+                            label_match(interior_ty.ty, interior_ty.source_info.span);\n+                        }\n+                    }\n                 }\n             }\n         }"}, {"sha": "746326f9bde8c85e0a08c7ae523d344817bfb6fc", "filename": "compiler/rustc_mir_transform/src/generator.rs", "status": "modified", "additions": 8, "deletions": 6, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/1c2f641e15a91f38cb5b67381de474bdcb1d5e0c/compiler%2Frustc_mir_transform%2Fsrc%2Fgenerator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1c2f641e15a91f38cb5b67381de474bdcb1d5e0c/compiler%2Frustc_mir_transform%2Fsrc%2Fgenerator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Fgenerator.rs?ref=1c2f641e15a91f38cb5b67381de474bdcb1d5e0c", "patch": "@@ -1872,12 +1872,14 @@ fn check_must_not_suspend_def(\n     data: SuspendCheckData<'_>,\n ) -> bool {\n     if let Some(attr) = tcx.get_attr(def_id, sym::must_not_suspend) {\n-        let msg = format!(\n-            \"{}`{}`{} held across a suspend point, but should not be\",\n-            data.descr_pre,\n-            tcx.def_path_str(def_id),\n-            data.descr_post,\n-        );\n+        let msg = rustc_errors::DelayDm(|| {\n+            format!(\n+                \"{}`{}`{} held across a suspend point, but should not be\",\n+                data.descr_pre,\n+                tcx.def_path_str(def_id),\n+                data.descr_post,\n+            )\n+        });\n         tcx.struct_span_lint_hir(\n             rustc_session::lint::builtin::MUST_NOT_SUSPEND,\n             hir_id,"}, {"sha": "38120b9760f3d46d300224f61b986449deb072fb", "filename": "compiler/rustc_trait_selection/src/solve/fulfill.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1c2f641e15a91f38cb5b67381de474bdcb1d5e0c/compiler%2Frustc_trait_selection%2Fsrc%2Fsolve%2Ffulfill.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1c2f641e15a91f38cb5b67381de474bdcb1d5e0c/compiler%2Frustc_trait_selection%2Fsrc%2Fsolve%2Ffulfill.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Fsolve%2Ffulfill.rs?ref=1c2f641e15a91f38cb5b67381de474bdcb1d5e0c", "patch": "@@ -149,6 +149,6 @@ impl<'tcx> TraitEngine<'tcx> for FulfillmentCtxt<'tcx> {\n         &mut self,\n         _: &InferCtxt<'tcx>,\n     ) -> Vec<PredicateObligation<'tcx>> {\n-        unimplemented!()\n+        std::mem::take(&mut self.obligations)\n     }\n }"}, {"sha": "9c67f17e963588b447c17ee99b0c7a225ea1d4bf", "filename": "tests/ui/impl-trait/recursive-impl-trait-type-indirect.drop_tracking_mir.stderr", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/1c2f641e15a91f38cb5b67381de474bdcb1d5e0c/tests%2Fui%2Fimpl-trait%2Frecursive-impl-trait-type-indirect.drop_tracking_mir.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/1c2f641e15a91f38cb5b67381de474bdcb1d5e0c/tests%2Fui%2Fimpl-trait%2Frecursive-impl-trait-type-indirect.drop_tracking_mir.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fimpl-trait%2Frecursive-impl-trait-type-indirect.drop_tracking_mir.stderr?ref=1c2f641e15a91f38cb5b67381de474bdcb1d5e0c", "patch": "@@ -114,6 +114,9 @@ error[E0720]: cannot resolve opaque type\n    |\n LL | fn generator_hold() -> impl Sized {\n    |                        ^^^^^^^^^^ recursive opaque type\n+...\n+LL |         let x = generator_hold();\n+   |             - generator captures itself here\n \n error[E0720]: cannot resolve opaque type\n   --> $DIR/recursive-impl-trait-type-indirect.rs:90:26"}]}