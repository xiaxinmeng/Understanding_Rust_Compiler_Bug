{"sha": "c6692a8b4284a2e033f620b71a2ad6a88833bb05", "node_id": "C_kwDOAAsO6NoAKGM2NjkyYThiNDI4NGEyZTAzM2Y2MjBiNzFhMmFkNmE4ODgzM2JiMDU", "commit": {"author": {"name": "Christian Poveda", "email": "git@pvdrz.com", "date": "2023-02-06T19:21:37Z"}, "committer": {"name": "Christian Poveda", "email": "git@pvdrz.com", "date": "2023-02-06T19:21:37Z"}, "message": "Add configuration to lint missing docs of `pub(crate)` items", "tree": {"sha": "ffab5e078871cb3aff6b44e4a071d052bcca14fa", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ffab5e078871cb3aff6b44e4a071d052bcca14fa"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c6692a8b4284a2e033f620b71a2ad6a88833bb05", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niHUEABYIAB0WIQRsB8A/3NrzTlMMjT0nUl7150IKUAUCY+FTQQAKCRAnUl7150IK\nUDMSAQDSsESsTxqPkIhnfa/BP9X24NWMNerL8Fs/WQQll0SfbQD/bvNYp5AArJhE\nZvvRuLB0Xxt43lpVTyfSbjSdc5An9wo=\n=Kppw\n-----END PGP SIGNATURE-----", "payload": "tree ffab5e078871cb3aff6b44e4a071d052bcca14fa\nparent 8a9860901f0ae9782ff23fb793838a16f733a60b\nauthor Christian Poveda <git@pvdrz.com> 1675711297 -0500\ncommitter Christian Poveda <git@pvdrz.com> 1675711297 -0500\n\nAdd configuration to lint missing docs of `pub(crate)` items\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c6692a8b4284a2e033f620b71a2ad6a88833bb05", "html_url": "https://github.com/rust-lang/rust/commit/c6692a8b4284a2e033f620b71a2ad6a88833bb05", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c6692a8b4284a2e033f620b71a2ad6a88833bb05/comments", "author": {"login": "pvdrz", "id": 31802960, "node_id": "MDQ6VXNlcjMxODAyOTYw", "avatar_url": "https://avatars.githubusercontent.com/u/31802960?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pvdrz", "html_url": "https://github.com/pvdrz", "followers_url": "https://api.github.com/users/pvdrz/followers", "following_url": "https://api.github.com/users/pvdrz/following{/other_user}", "gists_url": "https://api.github.com/users/pvdrz/gists{/gist_id}", "starred_url": "https://api.github.com/users/pvdrz/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pvdrz/subscriptions", "organizations_url": "https://api.github.com/users/pvdrz/orgs", "repos_url": "https://api.github.com/users/pvdrz/repos", "events_url": "https://api.github.com/users/pvdrz/events{/privacy}", "received_events_url": "https://api.github.com/users/pvdrz/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pvdrz", "id": 31802960, "node_id": "MDQ6VXNlcjMxODAyOTYw", "avatar_url": "https://avatars.githubusercontent.com/u/31802960?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pvdrz", "html_url": "https://github.com/pvdrz", "followers_url": "https://api.github.com/users/pvdrz/followers", "following_url": "https://api.github.com/users/pvdrz/following{/other_user}", "gists_url": "https://api.github.com/users/pvdrz/gists{/gist_id}", "starred_url": "https://api.github.com/users/pvdrz/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pvdrz/subscriptions", "organizations_url": "https://api.github.com/users/pvdrz/orgs", "repos_url": "https://api.github.com/users/pvdrz/repos", "events_url": "https://api.github.com/users/pvdrz/events{/privacy}", "received_events_url": "https://api.github.com/users/pvdrz/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8a9860901f0ae9782ff23fb793838a16f733a60b", "url": "https://api.github.com/repos/rust-lang/rust/commits/8a9860901f0ae9782ff23fb793838a16f733a60b", "html_url": "https://github.com/rust-lang/rust/commit/8a9860901f0ae9782ff23fb793838a16f733a60b"}], "stats": {"total": 78, "additions": 74, "deletions": 4}, "files": [{"sha": "f5c417fffa83720f75409f28fcd021407ea7fdcd", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/c6692a8b4284a2e033f620b71a2ad6a88833bb05/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c6692a8b4284a2e033f620b71a2ad6a88833bb05/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=c6692a8b4284a2e033f620b71a2ad6a88833bb05", "patch": "@@ -665,12 +665,13 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n         ))\n     });\n     let doc_valid_idents = conf.doc_valid_idents.iter().cloned().collect::<FxHashSet<_>>();\n+    let only_check_missing_docs_in_crate_items = conf.only_check_missing_docs_in_crate_items;\n     store.register_late_pass(move |_| Box::new(doc::DocMarkdown::new(doc_valid_idents.clone())));\n     store.register_late_pass(|_| Box::new(neg_multiply::NegMultiply));\n     store.register_late_pass(|_| Box::new(mem_forget::MemForget));\n     store.register_late_pass(|_| Box::new(let_if_seq::LetIfSeq));\n     store.register_late_pass(|_| Box::new(mixed_read_write_in_expression::EvalOrderDependence));\n-    store.register_late_pass(|_| Box::new(missing_doc::MissingDoc::new()));\n+    store.register_late_pass(move |_| Box::new(missing_doc::MissingDoc::new(only_check_missing_docs_in_crate_items)));\n     store.register_late_pass(|_| Box::new(missing_inline::MissingInline));\n     store.register_late_pass(move |_| Box::new(exhaustive_items::ExhaustiveItems));\n     store.register_late_pass(|_| Box::new(match_result_ok::MatchResultOk));"}, {"sha": "3bce54bf2e920b8c224b42448ae7b316a951840b", "filename": "clippy_lints/src/missing_doc.rs", "status": "modified", "additions": 13, "deletions": 3, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/c6692a8b4284a2e033f620b71a2ad6a88833bb05/clippy_lints%2Fsrc%2Fmissing_doc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c6692a8b4284a2e033f620b71a2ad6a88833bb05/clippy_lints%2Fsrc%2Fmissing_doc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmissing_doc.rs?ref=c6692a8b4284a2e033f620b71a2ad6a88833bb05", "patch": "@@ -12,7 +12,7 @@ use if_chain::if_chain;\n use rustc_ast::ast::{self, MetaItem, MetaItemKind};\n use rustc_hir as hir;\n use rustc_lint::{LateContext, LateLintPass, LintContext};\n-use rustc_middle::ty::DefIdTree;\n+use rustc_middle::ty::{DefIdTree, Visibility};\n use rustc_session::{declare_tool_lint, impl_lint_pass};\n use rustc_span::def_id::CRATE_DEF_ID;\n use rustc_span::source_map::Span;\n@@ -35,6 +35,8 @@ declare_clippy_lint! {\n }\n \n pub struct MissingDoc {\n+    /// FIXME: docs\n+    crate_items_only: bool,\n     /// Stack of whether #[doc(hidden)] is set\n     /// at each level which has lint attributes.\n     doc_hidden_stack: Vec<bool>,\n@@ -43,14 +45,15 @@ pub struct MissingDoc {\n impl Default for MissingDoc {\n     #[must_use]\n     fn default() -> Self {\n-        Self::new()\n+        Self::new(false)\n     }\n }\n \n impl MissingDoc {\n     #[must_use]\n-    pub fn new() -> Self {\n+    pub fn new(crate_items_only: bool) -> Self {\n         Self {\n+            crate_items_only,\n             doc_hidden_stack: vec![false],\n         }\n     }\n@@ -128,6 +131,13 @@ impl<'tcx> LateLintPass<'tcx> for MissingDoc {\n     }\n \n     fn check_item(&mut self, cx: &LateContext<'tcx>, it: &'tcx hir::Item<'_>) {\n+        if self.crate_items_only {\n+            let vis = cx.tcx.visibility(it.owner_id.to_def_id());\n+            if vis != Visibility::Public && vis != Visibility::Restricted(CRATE_DEF_ID.into()) {\n+                return;\n+            }\n+        }\n+\n         match it.kind {\n             hir::ItemKind::Fn(..) => {\n                 // ignore main()"}, {"sha": "f81965b64327b9ecab33c6c8025eb46b2c2d1091", "filename": "clippy_lints/src/utils/conf.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/c6692a8b4284a2e033f620b71a2ad6a88833bb05/clippy_lints%2Fsrc%2Futils%2Fconf.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c6692a8b4284a2e033f620b71a2ad6a88833bb05/clippy_lints%2Fsrc%2Futils%2Fconf.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Futils%2Fconf.rs?ref=c6692a8b4284a2e033f620b71a2ad6a88833bb05", "patch": "@@ -454,6 +454,10 @@ define_Conf! {\n     /// configuration will cause restriction lints to trigger even\n     /// if no suggestion can be made.\n     (suppress_restriction_lint_in_const: bool = false),\n+    /// Lint: MISSING_DOCS_IN_PRIVATE_ITEMS.\n+    ///\n+    /// FIXME: docs\n+    (only_check_missing_docs_in_crate_items: bool = false),\n }\n \n /// Search for the configuration file."}, {"sha": "a2f1fc27da354288d86c9d156846a934c0753994", "filename": "tests/ui-toml/pub_crate_missing_docs/clippy.toml", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/c6692a8b4284a2e033f620b71a2ad6a88833bb05/tests%2Fui-toml%2Fpub_crate_missing_docs%2Fclippy.toml", "raw_url": "https://github.com/rust-lang/rust/raw/c6692a8b4284a2e033f620b71a2ad6a88833bb05/tests%2Fui-toml%2Fpub_crate_missing_docs%2Fclippy.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-toml%2Fpub_crate_missing_docs%2Fclippy.toml?ref=c6692a8b4284a2e033f620b71a2ad6a88833bb05", "patch": "@@ -0,0 +1 @@\n+only-check-missing-docs-in-crate-items = true"}, {"sha": "8eef92d20bf372ce69eaca2633fba3e95387d473", "filename": "tests/ui-toml/pub_crate_missing_docs/pub_crate_missing_doc.rs", "status": "added", "additions": 32, "deletions": 0, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/c6692a8b4284a2e033f620b71a2ad6a88833bb05/tests%2Fui-toml%2Fpub_crate_missing_docs%2Fpub_crate_missing_doc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c6692a8b4284a2e033f620b71a2ad6a88833bb05/tests%2Fui-toml%2Fpub_crate_missing_docs%2Fpub_crate_missing_doc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-toml%2Fpub_crate_missing_docs%2Fpub_crate_missing_doc.rs?ref=c6692a8b4284a2e033f620b71a2ad6a88833bb05", "patch": "@@ -0,0 +1,32 @@\n+//! this is crate\n+#![warn(clippy::missing_docs_in_private_items)]\n+\n+/// this is mod\n+mod my_mod {\n+    /// some docs\n+    fn priv_with_docs() {}\n+    fn priv_no_docs() {}\n+    /// some docs\n+    pub(crate) fn crate_with_docs() {}\n+    pub(crate) fn crate_no_docs() {}\n+    /// some docs\n+    pub(super) fn super_with_docs() {}\n+    pub(super) fn super_no_docs() {}\n+\n+    mod my_sub {\n+        /// some docs\n+        fn sub_priv_with_docs() {}\n+        fn sub_priv_no_docs() {}\n+        /// some docs\n+        pub(crate) fn sub_crate_with_docs() {}\n+        pub(crate) fn sub_crate_no_docs() {}\n+        /// some docs\n+        pub(super) fn sub_super_with_docs() {}\n+        pub(super) fn sub_super_no_docs() {}\n+    }\n+}\n+\n+fn main() {\n+    my_mod::crate_with_docs();\n+    my_mod::crate_no_docs();\n+}"}, {"sha": "954ef2382f7be6c858d1d1a61b976559721ae996", "filename": "tests/ui-toml/pub_crate_missing_docs/pub_crate_missing_doc.stderr", "status": "added", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/c6692a8b4284a2e033f620b71a2ad6a88833bb05/tests%2Fui-toml%2Fpub_crate_missing_docs%2Fpub_crate_missing_doc.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c6692a8b4284a2e033f620b71a2ad6a88833bb05/tests%2Fui-toml%2Fpub_crate_missing_docs%2Fpub_crate_missing_doc.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui-toml%2Fpub_crate_missing_docs%2Fpub_crate_missing_doc.stderr?ref=c6692a8b4284a2e033f620b71a2ad6a88833bb05", "patch": "@@ -0,0 +1,22 @@\n+error: missing documentation for a function\n+  --> $DIR/pub_crate_missing_doc.rs:11:5\n+   |\n+LL |     pub(crate) fn crate_no_docs() {}\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+   = note: `-D clippy::missing-docs-in-private-items` implied by `-D warnings`\n+\n+error: missing documentation for a function\n+  --> $DIR/pub_crate_missing_doc.rs:14:5\n+   |\n+LL |     pub(super) fn super_no_docs() {}\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: missing documentation for a function\n+  --> $DIR/pub_crate_missing_doc.rs:22:9\n+   |\n+LL |         pub(crate) fn sub_crate_no_docs() {}\n+   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: aborting due to 3 previous errors\n+"}]}