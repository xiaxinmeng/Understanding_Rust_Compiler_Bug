{"sha": "4fe167f83a90f3f193c3cb5dafb4c2862d0671e9", "node_id": "C_kwDOAAsO6NoAKDRmZTE2N2Y4M2E5MGYzZjE5M2MzY2I1ZGFmYjRjMjg2MmQwNjcxZTk", "commit": {"author": {"name": "David Tolnay", "email": "dtolnay@gmail.com", "date": "2022-12-18T17:40:23Z"}, "committer": {"name": "David Tolnay", "email": "dtolnay@gmail.com", "date": "2023-01-14T21:28:14Z"}, "message": "Add test of leaking a binary_heap PeekMut", "tree": {"sha": "8496f5243441583f40266f3d440add96013c76dd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8496f5243441583f40266f3d440add96013c76dd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4fe167f83a90f3f193c3cb5dafb4c2862d0671e9", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEERijF2Cz/ZdaBZKeK+boUO5X/bYIFAmPDHm4ACgkQ+boUO5X/\nbYKDQA//V36M+osMxxksX4F92siUNLRqE1I2VJslWq2km8bEsqglbfOFyxYrFCS0\nlzitzJMr+EbvsnSXRa8kQ1KWlJ+KCiBxLUKrxn7c/aPguazPgs8u0uSpEzjy8bzC\ndH0G0Lpnj7oiu01NCdgcom6whKcYMNDd8aEgywszzTktS8ByiUOsPun1G+6TPnAz\nMzgwZwS/ocfyBfOkBMWdvbKRnY4IN+op8DehnZruoDQkUgDin88rBTOoqE36/VWF\nHjyR5CS1Uxg1QuLpWctFBKCLudm96oG0ZCvzjRVO1eQrAB8iHHjunsWUBZ//sa4d\nAr3uxXsKmY1o1bGWrbZB3U+x6GsRg6P4DdcFUV3itcFXcEJ7ywJBmn6k7wIsEvi6\nr9kLIrau2SNOZMlQP0Qd4iQMkZw0cyzu9BcIfkgTo94lpHRYNZdXkuBOvMxLYKyn\nL7sFB2TjlmVIZIkiLsxFlHo5kUH+EbtuptdFFsbTj2VZHVyB9zCvPYwUJL5Nyoa+\n3aL1thbXaPDy/wHl+1stn8usc8jLngDAV3aJJT3se1wIFevhXBUKE1D24SLvDybn\nEIL+NHXqjGnttmAkuOLkj1V8iO0NRQYAO30MGEu2DTD4ei7VmZ0O2+SzImzB9A9T\nzHS6XACNnlzJVEyPy2DFWSpwuB/7zIMekFNiLggVM2pFute5b0A=\n=tqMh\n-----END PGP SIGNATURE-----", "payload": "tree 8496f5243441583f40266f3d440add96013c76dd\nparent b8f9cb345ab1401f2fbd14cc23f64dda9dd2314e\nauthor David Tolnay <dtolnay@gmail.com> 1671385223 -0800\ncommitter David Tolnay <dtolnay@gmail.com> 1673731694 -0800\n\nAdd test of leaking a binary_heap PeekMut\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4fe167f83a90f3f193c3cb5dafb4c2862d0671e9", "html_url": "https://github.com/rust-lang/rust/commit/4fe167f83a90f3f193c3cb5dafb4c2862d0671e9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4fe167f83a90f3f193c3cb5dafb4c2862d0671e9/comments", "author": {"login": "dtolnay", "id": 1940490, "node_id": "MDQ6VXNlcjE5NDA0OTA=", "avatar_url": "https://avatars.githubusercontent.com/u/1940490?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dtolnay", "html_url": "https://github.com/dtolnay", "followers_url": "https://api.github.com/users/dtolnay/followers", "following_url": "https://api.github.com/users/dtolnay/following{/other_user}", "gists_url": "https://api.github.com/users/dtolnay/gists{/gist_id}", "starred_url": "https://api.github.com/users/dtolnay/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dtolnay/subscriptions", "organizations_url": "https://api.github.com/users/dtolnay/orgs", "repos_url": "https://api.github.com/users/dtolnay/repos", "events_url": "https://api.github.com/users/dtolnay/events{/privacy}", "received_events_url": "https://api.github.com/users/dtolnay/received_events", "type": "User", "site_admin": false}, "committer": {"login": "dtolnay", "id": 1940490, "node_id": "MDQ6VXNlcjE5NDA0OTA=", "avatar_url": "https://avatars.githubusercontent.com/u/1940490?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dtolnay", "html_url": "https://github.com/dtolnay", "followers_url": "https://api.github.com/users/dtolnay/followers", "following_url": "https://api.github.com/users/dtolnay/following{/other_user}", "gists_url": "https://api.github.com/users/dtolnay/gists{/gist_id}", "starred_url": "https://api.github.com/users/dtolnay/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dtolnay/subscriptions", "organizations_url": "https://api.github.com/users/dtolnay/orgs", "repos_url": "https://api.github.com/users/dtolnay/repos", "events_url": "https://api.github.com/users/dtolnay/events{/privacy}", "received_events_url": "https://api.github.com/users/dtolnay/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b8f9cb345ab1401f2fbd14cc23f64dda9dd2314e", "url": "https://api.github.com/repos/rust-lang/rust/commits/b8f9cb345ab1401f2fbd14cc23f64dda9dd2314e", "html_url": "https://github.com/rust-lang/rust/commit/b8f9cb345ab1401f2fbd14cc23f64dda9dd2314e"}], "stats": {"total": 20, "additions": 20, "deletions": 0}, "files": [{"sha": "ffbb6c80ac01847999294b6dee8af0b81fa0dc4f", "filename": "library/alloc/src/collections/binary_heap/tests.rs", "status": "modified", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/4fe167f83a90f3f193c3cb5dafb4c2862d0671e9/library%2Falloc%2Fsrc%2Fcollections%2Fbinary_heap%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4fe167f83a90f3f193c3cb5dafb4c2862d0671e9/library%2Falloc%2Fsrc%2Fcollections%2Fbinary_heap%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Falloc%2Fsrc%2Fcollections%2Fbinary_heap%2Ftests.rs?ref=4fe167f83a90f3f193c3cb5dafb4c2862d0671e9", "patch": "@@ -1,6 +1,7 @@\n use super::*;\n use crate::boxed::Box;\n use crate::testing::crash_test::{CrashTestDummy, Panic};\n+use core::mem;\n use std::iter::TrustedLen;\n use std::panic::{catch_unwind, AssertUnwindSafe};\n \n@@ -146,6 +147,24 @@ fn test_peek_mut() {\n     assert_eq!(heap.peek(), Some(&9));\n }\n \n+#[test]\n+fn test_peek_mut_leek() {\n+    let data = vec![4, 2, 7];\n+    let mut heap = BinaryHeap::from(data);\n+    let mut max = heap.peek_mut().unwrap();\n+    *max = -1;\n+\n+    // The PeekMut object's Drop impl would have been responsible for moving the\n+    // -1 out of the max position of the BinaryHeap, but we don't run it.\n+    mem::forget(max);\n+\n+    // Absent some mitigation like leak amplification, the -1 would incorrectly\n+    // end up in the last position of the returned Vec, with the rest of the\n+    // heap's original contents in front of it in sorted order.\n+    let sorted_vec = heap.into_sorted_vec();\n+    assert!(sorted_vec.is_sorted(), \"{:?}\", sorted_vec);\n+}\n+\n #[test]\n fn test_peek_mut_pop() {\n     let data = vec![2, 4, 6, 2, 1, 8, 10, 3, 5, 7, 0, 9, 1];"}, {"sha": "afc3a3dc6a8c6bb646b725f281052558f61e7844", "filename": "library/alloc/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/4fe167f83a90f3f193c3cb5dafb4c2862d0671e9/library%2Falloc%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4fe167f83a90f3f193c3cb5dafb4c2862d0671e9/library%2Falloc%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Falloc%2Fsrc%2Flib.rs?ref=4fe167f83a90f3f193c3cb5dafb4c2862d0671e9", "patch": "@@ -125,6 +125,7 @@\n #![feature(hasher_prefixfree_extras)]\n #![feature(inline_const)]\n #![feature(inplace_iteration)]\n+#![cfg_attr(test, feature(is_sorted))]\n #![feature(iter_advance_by)]\n #![feature(iter_next_chunk)]\n #![feature(iter_repeat_n)]"}]}