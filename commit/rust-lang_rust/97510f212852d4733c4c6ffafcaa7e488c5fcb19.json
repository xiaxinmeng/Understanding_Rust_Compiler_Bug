{"sha": "97510f212852d4733c4c6ffafcaa7e488c5fcb19", "node_id": "C_kwDOAAsO6NoAKDk3NTEwZjIxMjg1MmQ0NzMzYzRjNmZmYWZjYWE3ZTQ4OGM1ZmNiMTk", "commit": {"author": {"name": "R\u00e9my Rakic", "email": "remy.rakic+github@gmail.com", "date": "2022-07-14T18:41:55Z"}, "committer": {"name": "R\u00e9my Rakic", "email": "remy.rakic+github@gmail.com", "date": "2022-07-14T18:41:55Z"}, "message": "fix dwarf debuginfo being used in addition to CodeView on windows\n\nFixes the debuginfo size increase regression introduced by the DWARF5 support.", "tree": {"sha": "d295d4e0ba0609288bd8fc296676feb6adaa762d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d295d4e0ba0609288bd8fc296676feb6adaa762d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/97510f212852d4733c4c6ffafcaa7e488c5fcb19", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/97510f212852d4733c4c6ffafcaa7e488c5fcb19", "html_url": "https://github.com/rust-lang/rust/commit/97510f212852d4733c4c6ffafcaa7e488c5fcb19", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/97510f212852d4733c4c6ffafcaa7e488c5fcb19/comments", "author": {"login": "lqd", "id": 247183, "node_id": "MDQ6VXNlcjI0NzE4Mw==", "avatar_url": "https://avatars.githubusercontent.com/u/247183?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lqd", "html_url": "https://github.com/lqd", "followers_url": "https://api.github.com/users/lqd/followers", "following_url": "https://api.github.com/users/lqd/following{/other_user}", "gists_url": "https://api.github.com/users/lqd/gists{/gist_id}", "starred_url": "https://api.github.com/users/lqd/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lqd/subscriptions", "organizations_url": "https://api.github.com/users/lqd/orgs", "repos_url": "https://api.github.com/users/lqd/repos", "events_url": "https://api.github.com/users/lqd/events{/privacy}", "received_events_url": "https://api.github.com/users/lqd/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lqd", "id": 247183, "node_id": "MDQ6VXNlcjI0NzE4Mw==", "avatar_url": "https://avatars.githubusercontent.com/u/247183?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lqd", "html_url": "https://github.com/lqd", "followers_url": "https://api.github.com/users/lqd/followers", "following_url": "https://api.github.com/users/lqd/following{/other_user}", "gists_url": "https://api.github.com/users/lqd/gists{/gist_id}", "starred_url": "https://api.github.com/users/lqd/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lqd/subscriptions", "organizations_url": "https://api.github.com/users/lqd/orgs", "repos_url": "https://api.github.com/users/lqd/repos", "events_url": "https://api.github.com/users/lqd/events{/privacy}", "received_events_url": "https://api.github.com/users/lqd/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "24699bcbadff59693a89a5184afed87f6416cdea", "url": "https://api.github.com/repos/rust-lang/rust/commits/24699bcbadff59693a89a5184afed87f6416cdea", "html_url": "https://github.com/rust-lang/rust/commit/24699bcbadff59693a89a5184afed87f6416cdea"}], "stats": {"total": 37, "additions": 20, "deletions": 17}, "files": [{"sha": "cf591295b84680b57c660219f07e891a0c09a821", "filename": "compiler/rustc_codegen_llvm/src/debuginfo/mod.rs", "status": "modified", "additions": 20, "deletions": 17, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/97510f212852d4733c4c6ffafcaa7e488c5fcb19/compiler%2Frustc_codegen_llvm%2Fsrc%2Fdebuginfo%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/97510f212852d4733c4c6ffafcaa7e488c5fcb19/compiler%2Frustc_codegen_llvm%2Fsrc%2Fdebuginfo%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fdebuginfo%2Fmod.rs?ref=97510f212852d4733c4c6ffafcaa7e488c5fcb19", "patch": "@@ -97,23 +97,26 @@ impl<'ll, 'tcx> CodegenUnitDebugContext<'ll, 'tcx> {\n         unsafe {\n             llvm::LLVMRustDIBuilderFinalize(self.builder);\n \n-            // Debuginfo generation in LLVM by default uses a higher\n-            // version of dwarf than macOS currently understands. We can\n-            // instruct LLVM to emit an older version of dwarf, however,\n-            // for macOS to understand. For more info see #11352\n-            // This can be overridden using --llvm-opts -dwarf-version,N.\n-            // Android has the same issue (#22398)\n-            let dwarf_version =\n-                sess.opts.unstable_opts.dwarf_version.unwrap_or(sess.target.default_dwarf_version);\n-            llvm::LLVMRustAddModuleFlag(\n-                self.llmod,\n-                llvm::LLVMModFlagBehavior::Warning,\n-                \"Dwarf Version\\0\".as_ptr().cast(),\n-                dwarf_version,\n-            );\n-\n-            // Indicate that we want CodeView debug information on MSVC\n-            if sess.target.is_like_msvc {\n+            if !sess.target.is_like_msvc {\n+                // Debuginfo generation in LLVM by default uses a higher\n+                // version of dwarf than macOS currently understands. We can\n+                // instruct LLVM to emit an older version of dwarf, however,\n+                // for macOS to understand. For more info see #11352\n+                // This can be overridden using --llvm-opts -dwarf-version,N.\n+                // Android has the same issue (#22398)\n+                let dwarf_version = sess\n+                    .opts\n+                    .unstable_opts\n+                    .dwarf_version\n+                    .unwrap_or(sess.target.default_dwarf_version);\n+                llvm::LLVMRustAddModuleFlag(\n+                    self.llmod,\n+                    llvm::LLVMModFlagBehavior::Warning,\n+                    \"Dwarf Version\\0\".as_ptr().cast(),\n+                    dwarf_version,\n+                );\n+            } else {\n+                // Indicate that we want CodeView debug information on MSVC\n                 llvm::LLVMRustAddModuleFlag(\n                     self.llmod,\n                     llvm::LLVMModFlagBehavior::Warning,"}]}