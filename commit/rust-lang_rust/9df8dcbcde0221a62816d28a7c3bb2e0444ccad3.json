{"sha": "9df8dcbcde0221a62816d28a7c3bb2e0444ccad3", "node_id": "MDY6Q29tbWl0NzI0NzEyOjlkZjhkY2JjZGUwMjIxYTYyODE2ZDI4YTdjM2JiMmUwNDQ0Y2NhZDM=", "commit": {"author": {"name": "Mara Bos", "email": "m-ou.se@m-ou.se", "date": "2021-01-16T17:30:10Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-01-16T17:30:10Z"}, "message": "Rollup merge of #81040 - osa1:fix_80992, r=jyn514\n\ndoctest: Reset errors before dropping the parse session\n\nThe first parse is to collect whether the code contains macros, has\n`main`, and uses other crates. In that pass we ignore errors as those\nwill be reported when the test file is actually built.\n\nFor that we need to reset errors in the `Diagnostic` otherwise when\ndropping it unhandled errors will be reported as compiler bugs.\n\nFixes #80992", "tree": {"sha": "afd36471ae56dc49b80589487ef4997b95f3c0ce", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/afd36471ae56dc49b80589487ef4997b95f3c0ce"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9df8dcbcde0221a62816d28a7c3bb2e0444ccad3", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgAyKiCRBK7hj4Ov3rIwAAdHIIAKVNr3ZgyN2mo4r8MRy6ifU3\nhhQMjEDNm5JJwdZsKwZfyxA0/yB6yBG9obuJfmVPt6XBJX9U+s1CxqG1zLQgxR0t\nf+SZg+rCyZCz4Dld4rsKSmV422ejBU5xnJp2fTHhqHUhBFGMIKXlbyOEDXU7fxXb\ndmCrdny6vIb7K+YSLER0XWcTXYpRsdrVC8SUxLvFhAxs/5xMs9gBYpoHAbf1N/Ql\n9BlgJ+Zu+bL1Uo2VJ3A6T79MV6YModx1r717iQTO40/vPCiWlwkPRXWvHWcjCZJl\nshXAFbKoQoIv5/czj8IucuS3op9MoWgB/la8kmWpcZjW1Uqx2yuOmwhYk6Ivl6k=\n=Vhc/\n-----END PGP SIGNATURE-----\n", "payload": "tree afd36471ae56dc49b80589487ef4997b95f3c0ce\nparent 1368e81bcb2f5e9ed0188deb46f7a994f225ab4d\nparent 0ef55570fb35a79a32bc062c0a441c02952fd65e\nauthor Mara Bos <m-ou.se@m-ou.se> 1610818210 +0000\ncommitter GitHub <noreply@github.com> 1610818210 +0000\n\nRollup merge of #81040 - osa1:fix_80992, r=jyn514\n\ndoctest: Reset errors before dropping the parse session\n\nThe first parse is to collect whether the code contains macros, has\n`main`, and uses other crates. In that pass we ignore errors as those\nwill be reported when the test file is actually built.\n\nFor that we need to reset errors in the `Diagnostic` otherwise when\ndropping it unhandled errors will be reported as compiler bugs.\n\nFixes #80992\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9df8dcbcde0221a62816d28a7c3bb2e0444ccad3", "html_url": "https://github.com/rust-lang/rust/commit/9df8dcbcde0221a62816d28a7c3bb2e0444ccad3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9df8dcbcde0221a62816d28a7c3bb2e0444ccad3/comments", "author": {"login": "m-ou-se", "id": 783247, "node_id": "MDQ6VXNlcjc4MzI0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/783247?v=4", "gravatar_id": "", "url": "https://api.github.com/users/m-ou-se", "html_url": "https://github.com/m-ou-se", "followers_url": "https://api.github.com/users/m-ou-se/followers", "following_url": "https://api.github.com/users/m-ou-se/following{/other_user}", "gists_url": "https://api.github.com/users/m-ou-se/gists{/gist_id}", "starred_url": "https://api.github.com/users/m-ou-se/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/m-ou-se/subscriptions", "organizations_url": "https://api.github.com/users/m-ou-se/orgs", "repos_url": "https://api.github.com/users/m-ou-se/repos", "events_url": "https://api.github.com/users/m-ou-se/events{/privacy}", "received_events_url": "https://api.github.com/users/m-ou-se/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1368e81bcb2f5e9ed0188deb46f7a994f225ab4d", "url": "https://api.github.com/repos/rust-lang/rust/commits/1368e81bcb2f5e9ed0188deb46f7a994f225ab4d", "html_url": "https://github.com/rust-lang/rust/commit/1368e81bcb2f5e9ed0188deb46f7a994f225ab4d"}, {"sha": "0ef55570fb35a79a32bc062c0a441c02952fd65e", "url": "https://api.github.com/repos/rust-lang/rust/commits/0ef55570fb35a79a32bc062c0a441c02952fd65e", "html_url": "https://github.com/rust-lang/rust/commit/0ef55570fb35a79a32bc062c0a441c02952fd65e"}], "stats": {"total": 23, "additions": 23, "deletions": 0}, "files": [{"sha": "3de97f2dd2e59375b817e02bf8aa5dbcdec900c8", "filename": "src/librustdoc/doctest.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/9df8dcbcde0221a62816d28a7c3bb2e0444ccad3/src%2Flibrustdoc%2Fdoctest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9df8dcbcde0221a62816d28a7c3bb2e0444ccad3/src%2Flibrustdoc%2Fdoctest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fdoctest.rs?ref=9df8dcbcde0221a62816d28a7c3bb2e0444ccad3", "patch": "@@ -500,6 +500,12 @@ crate fn make_test(\n                 }\n             }\n \n+            // Reset errors so that they won't be reported as compiler bugs when dropping the\n+            // handler. Any errors in the tests will be reported when the test file is compiled,\n+            // Note that we still need to cancel the errors above otherwise `DiagnosticBuilder`\n+            // will panic on drop.\n+            sess.span_diagnostic.reset_err_count();\n+\n             (found_main, found_extern_crate, found_macro)\n         })\n     });"}, {"sha": "8983439bb64d35a215ac1fe523e73a15389296e2", "filename": "src/test/rustdoc-ui/issue-80992.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/9df8dcbcde0221a62816d28a7c3bb2e0444ccad3/src%2Ftest%2Frustdoc-ui%2Fissue-80992.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9df8dcbcde0221a62816d28a7c3bb2e0444ccad3/src%2Ftest%2Frustdoc-ui%2Fissue-80992.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fissue-80992.rs?ref=9df8dcbcde0221a62816d28a7c3bb2e0444ccad3", "patch": "@@ -0,0 +1,11 @@\n+// check-pass\n+// compile-flags:--test\n+// normalize-stdout-test: \"src/test/rustdoc-ui\" -> \"$$DIR\"\n+// normalize-stdout-test \"finished in \\d+\\.\\d+s\" -> \"finished in $$TIME\"\n+\n+pub fn test() -> Result<(), ()> {\n+    //! ```compile_fail\n+    //! fn test() -> Result< {}\n+    //! ```\n+    Ok(())\n+}"}, {"sha": "1dd19f468274c4d162b270545868e292464d2511", "filename": "src/test/rustdoc-ui/issue-80992.stdout", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/9df8dcbcde0221a62816d28a7c3bb2e0444ccad3/src%2Ftest%2Frustdoc-ui%2Fissue-80992.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/9df8dcbcde0221a62816d28a7c3bb2e0444ccad3/src%2Ftest%2Frustdoc-ui%2Fissue-80992.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fissue-80992.stdout?ref=9df8dcbcde0221a62816d28a7c3bb2e0444ccad3", "patch": "@@ -0,0 +1,6 @@\n+\n+running 1 test\n+test $DIR/issue-80992.rs - test (line 7) ... ok\n+\n+test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in $TIME\n+"}]}