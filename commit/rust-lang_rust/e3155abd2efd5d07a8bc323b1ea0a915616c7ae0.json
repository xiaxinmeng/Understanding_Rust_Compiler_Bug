{"sha": "e3155abd2efd5d07a8bc323b1ea0a915616c7ae0", "node_id": "MDY6Q29tbWl0NzI0NzEyOmUzMTU1YWJkMmVmZDVkMDdhOGJjMzIzYjFlYTBhOTE1NjE2YzdhZTA=", "commit": {"author": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2019-09-07T22:42:12Z"}, "committer": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2019-12-28T08:42:26Z"}, "message": "Stabilize attribute macros on inline modules", "tree": {"sha": "c253e73f99edc0eaef0b586bcc44c1b4206b71ea", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c253e73f99edc0eaef0b586bcc44c1b4206b71ea"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e3155abd2efd5d07a8bc323b1ea0a915616c7ae0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e3155abd2efd5d07a8bc323b1ea0a915616c7ae0", "html_url": "https://github.com/rust-lang/rust/commit/e3155abd2efd5d07a8bc323b1ea0a915616c7ae0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e3155abd2efd5d07a8bc323b1ea0a915616c7ae0/comments", "author": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "committer": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3a087ad3a924be12343bb035bf9b63ed81f650bf", "url": "https://api.github.com/repos/rust-lang/rust/commits/3a087ad3a924be12343bb035bf9b63ed81f650bf", "html_url": "https://github.com/rust-lang/rust/commit/3a087ad3a924be12343bb035bf9b63ed81f650bf"}], "stats": {"total": 130, "additions": 58, "deletions": 72}, "files": [{"sha": "4f6f88a753b2b6e739b63547c2240820614b5e61", "filename": "src/libsyntax_expand/expand.rs", "status": "modified", "additions": 4, "deletions": 7, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/e3155abd2efd5d07a8bc323b1ea0a915616c7ae0/src%2Flibsyntax_expand%2Fexpand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e3155abd2efd5d07a8bc323b1ea0a915616c7ae0/src%2Flibsyntax_expand%2Fexpand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax_expand%2Fexpand.rs?ref=e3155abd2efd5d07a8bc323b1ea0a915616c7ae0", "patch": "@@ -717,13 +717,10 @@ impl<'a, 'b> MacroExpander<'a, 'b> {\n \n     fn gate_proc_macro_attr_item(&self, span: Span, item: &Annotatable) {\n         let kind = match item {\n-            Annotatable::Item(item) => match &item.kind {\n-                ItemKind::Mod(m) if m.inline => \"modules\",\n-                _ => return,\n-            },\n-            Annotatable::TraitItem(_) | Annotatable::ImplItem(_) | Annotatable::ForeignItem(_) => {\n-                return;\n-            }\n+            Annotatable::Item(_)\n+            | Annotatable::TraitItem(_)\n+            | Annotatable::ImplItem(_)\n+            | Annotatable::ForeignItem(_) => return,\n             Annotatable::Stmt(_) => \"statements\",\n             Annotatable::Expr(_) => \"expressions\",\n             Annotatable::Arm(..)"}, {"sha": "c506e903e7f897b7f2ebac04210e0c15615b0a59", "filename": "src/test/ui/proc-macro/attributes-on-modules-fail.rs", "status": "modified", "additions": 19, "deletions": 2, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/e3155abd2efd5d07a8bc323b1ea0a915616c7ae0/src%2Ftest%2Fui%2Fproc-macro%2Fattributes-on-modules-fail.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e3155abd2efd5d07a8bc323b1ea0a915616c7ae0/src%2Ftest%2Fui%2Fproc-macro%2Fattributes-on-modules-fail.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Fattributes-on-modules-fail.rs?ref=e3155abd2efd5d07a8bc323b1ea0a915616c7ae0", "patch": "@@ -3,7 +3,7 @@\n #[macro_use]\n extern crate test_macros;\n \n-#[identity_attr] //~ ERROR custom attributes cannot be applied to modules\n+#[identity_attr]\n mod m {\n     pub struct X;\n \n@@ -19,11 +19,28 @@ mod n {}\n #[empty_attr]\n mod module; //~ ERROR non-inline modules in proc macro input are unstable\n \n-#[empty_attr] //~ ERROR custom attributes cannot be applied to modules\n+#[empty_attr]\n mod outer {\n     mod inner; //~ ERROR non-inline modules in proc macro input are unstable\n \n     mod inner_inline {} // OK\n }\n \n+#[derive(Empty)]\n+struct S {\n+    field: [u8; {\n+        #[path = \"outer/inner.rs\"]\n+        mod inner; //~ ERROR non-inline modules in proc macro input are unstable\n+        mod inner_inline {} // OK\n+        0\n+    }]\n+}\n+\n+#[identity_attr]\n+fn f() {\n+    #[path = \"outer/inner.rs\"]\n+    mod inner; //~ ERROR non-inline modules in proc macro input are unstable\n+    mod inner_inline {} // OK\n+}\n+\n fn main() {}"}, {"sha": "74b9932a916c9c65a7bff3a8717ab19010ac9571", "filename": "src/test/ui/proc-macro/attributes-on-modules-fail.stderr", "status": "modified", "additions": 13, "deletions": 13, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/e3155abd2efd5d07a8bc323b1ea0a915616c7ae0/src%2Ftest%2Fui%2Fproc-macro%2Fattributes-on-modules-fail.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e3155abd2efd5d07a8bc323b1ea0a915616c7ae0/src%2Ftest%2Fui%2Fproc-macro%2Fattributes-on-modules-fail.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Fattributes-on-modules-fail.stderr?ref=e3155abd2efd5d07a8bc323b1ea0a915616c7ae0", "patch": "@@ -1,12 +1,3 @@\n-error[E0658]: custom attributes cannot be applied to modules\n-  --> $DIR/attributes-on-modules-fail.rs:6:1\n-   |\n-LL | #[identity_attr]\n-   | ^^^^^^^^^^^^^^^^\n-   |\n-   = note: for more information, see https://github.com/rust-lang/rust/issues/54727\n-   = help: add `#![feature(proc_macro_hygiene)]` to the crate attributes to enable\n-\n error: `derive` may only be applied to structs, enums and unions\n   --> $DIR/attributes-on-modules-fail.rs:16:1\n    |\n@@ -31,11 +22,20 @@ LL |     mod inner;\n    = note: for more information, see https://github.com/rust-lang/rust/issues/54727\n    = help: add `#![feature(proc_macro_hygiene)]` to the crate attributes to enable\n \n-error[E0658]: custom attributes cannot be applied to modules\n-  --> $DIR/attributes-on-modules-fail.rs:22:1\n+error[E0658]: non-inline modules in proc macro input are unstable\n+  --> $DIR/attributes-on-modules-fail.rs:33:9\n+   |\n+LL |         mod inner;\n+   |         ^^^^^^^^^^\n+   |\n+   = note: for more information, see https://github.com/rust-lang/rust/issues/54727\n+   = help: add `#![feature(proc_macro_hygiene)]` to the crate attributes to enable\n+\n+error[E0658]: non-inline modules in proc macro input are unstable\n+  --> $DIR/attributes-on-modules-fail.rs:42:5\n    |\n-LL | #[empty_attr]\n-   | ^^^^^^^^^^^^^\n+LL |     mod inner;\n+   |     ^^^^^^^^^^\n    |\n    = note: for more information, see https://github.com/rust-lang/rust/issues/54727\n    = help: add `#![feature(proc_macro_hygiene)]` to the crate attributes to enable"}, {"sha": "6c73b0bf19c7f845391a47e2b9d6ab29619e0cda", "filename": "src/test/ui/proc-macro/attributes-on-modules.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/e3155abd2efd5d07a8bc323b1ea0a915616c7ae0/src%2Ftest%2Fui%2Fproc-macro%2Fattributes-on-modules.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e3155abd2efd5d07a8bc323b1ea0a915616c7ae0/src%2Ftest%2Fui%2Fproc-macro%2Fattributes-on-modules.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Fattributes-on-modules.rs?ref=e3155abd2efd5d07a8bc323b1ea0a915616c7ae0", "patch": "@@ -1,13 +1,19 @@\n+// check-pass\n // aux-build:test-macros.rs\n \n #[macro_use]\n extern crate test_macros;\n \n-#[identity_attr] //~ ERROR custom attributes cannot be applied to modules\n+#[identity_attr]\n mod m {\n     pub struct S;\n }\n \n+#[identity_attr]\n+fn f() {\n+    mod m {}\n+}\n+\n fn main() {\n     let s = m::S;\n }"}, {"sha": "df75f0bf4b149d10b0330c24154fbd74271a48e5", "filename": "src/test/ui/proc-macro/attributes-on-modules.stderr", "status": "removed", "additions": 0, "deletions": 12, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/3a087ad3a924be12343bb035bf9b63ed81f650bf/src%2Ftest%2Fui%2Fproc-macro%2Fattributes-on-modules.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/3a087ad3a924be12343bb035bf9b63ed81f650bf/src%2Ftest%2Fui%2Fproc-macro%2Fattributes-on-modules.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Fattributes-on-modules.stderr?ref=3a087ad3a924be12343bb035bf9b63ed81f650bf", "patch": "@@ -1,12 +0,0 @@\n-error[E0658]: custom attributes cannot be applied to modules\n-  --> $DIR/attributes-on-modules.rs:6:1\n-   |\n-LL | #[identity_attr]\n-   | ^^^^^^^^^^^^^^^^\n-   |\n-   = note: for more information, see https://github.com/rust-lang/rust/issues/54727\n-   = help: add `#![feature(proc_macro_hygiene)]` to the crate attributes to enable\n-\n-error: aborting due to previous error\n-\n-For more information about this error, try `rustc --explain E0658`."}, {"sha": "5df6ac422ac4b11264be2a7513d7b971e02c708d", "filename": "src/test/ui/proc-macro/proc-macro-gates.rs", "status": "modified", "additions": 1, "deletions": 5, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/e3155abd2efd5d07a8bc323b1ea0a915616c7ae0/src%2Ftest%2Fui%2Fproc-macro%2Fproc-macro-gates.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e3155abd2efd5d07a8bc323b1ea0a915616c7ae0/src%2Ftest%2Fui%2Fproc-macro%2Fproc-macro-gates.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Fproc-macro-gates.rs?ref=e3155abd2efd5d07a8bc323b1ea0a915616c7ae0", "patch": "@@ -10,12 +10,8 @@ fn _test_inner() {\n     #![empty_attr] //~ ERROR: non-builtin inner attributes are unstable\n }\n \n-#[empty_attr] //~ ERROR: custom attributes cannot be applied to modules\n-mod _test2 {}\n-\n mod _test2_inner {\n-    #![empty_attr] //~ ERROR: custom attributes cannot be applied to modules\n-          //~| ERROR: non-builtin inner attributes are unstable\n+    #![empty_attr] //~ ERROR: non-builtin inner attributes are unstable\n }\n \n #[empty_attr = \"y\"] //~ ERROR: key-value macro attributes are not supported"}, {"sha": "fff96572e340f678987e2c5c4757c4f850b7dd2c", "filename": "src/test/ui/proc-macro/proc-macro-gates.stderr", "status": "modified", "additions": 14, "deletions": 32, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/e3155abd2efd5d07a8bc323b1ea0a915616c7ae0/src%2Ftest%2Fui%2Fproc-macro%2Fproc-macro-gates.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e3155abd2efd5d07a8bc323b1ea0a915616c7ae0/src%2Ftest%2Fui%2Fproc-macro%2Fproc-macro-gates.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fproc-macro%2Fproc-macro-gates.stderr?ref=e3155abd2efd5d07a8bc323b1ea0a915616c7ae0", "patch": "@@ -8,40 +8,22 @@ LL |     #![empty_attr]\n    = help: add `#![feature(custom_inner_attributes)]` to the crate attributes to enable\n \n error[E0658]: non-builtin inner attributes are unstable\n-  --> $DIR/proc-macro-gates.rs:17:5\n+  --> $DIR/proc-macro-gates.rs:14:5\n    |\n LL |     #![empty_attr]\n    |     ^^^^^^^^^^^^^^\n    |\n    = note: for more information, see https://github.com/rust-lang/rust/issues/54726\n    = help: add `#![feature(custom_inner_attributes)]` to the crate attributes to enable\n \n-error[E0658]: custom attributes cannot be applied to modules\n-  --> $DIR/proc-macro-gates.rs:13:1\n-   |\n-LL | #[empty_attr]\n-   | ^^^^^^^^^^^^^\n-   |\n-   = note: for more information, see https://github.com/rust-lang/rust/issues/54727\n-   = help: add `#![feature(proc_macro_hygiene)]` to the crate attributes to enable\n-\n-error[E0658]: custom attributes cannot be applied to modules\n-  --> $DIR/proc-macro-gates.rs:17:5\n-   |\n-LL |     #![empty_attr]\n-   |     ^^^^^^^^^^^^^^\n-   |\n-   = note: for more information, see https://github.com/rust-lang/rust/issues/54727\n-   = help: add `#![feature(proc_macro_hygiene)]` to the crate attributes to enable\n-\n error: key-value macro attributes are not supported\n-  --> $DIR/proc-macro-gates.rs:21:1\n+  --> $DIR/proc-macro-gates.rs:17:1\n    |\n LL | #[empty_attr = \"y\"]\n    | ^^^^^^^^^^^^^^^^^^^\n \n error[E0658]: custom attributes cannot be applied to statements\n-  --> $DIR/proc-macro-gates.rs:30:5\n+  --> $DIR/proc-macro-gates.rs:26:5\n    |\n LL |     #[empty_attr]\n    |     ^^^^^^^^^^^^^\n@@ -50,7 +32,7 @@ LL |     #[empty_attr]\n    = help: add `#![feature(proc_macro_hygiene)]` to the crate attributes to enable\n \n error[E0658]: custom attributes cannot be applied to statements\n-  --> $DIR/proc-macro-gates.rs:34:5\n+  --> $DIR/proc-macro-gates.rs:30:5\n    |\n LL |     #[empty_attr]\n    |     ^^^^^^^^^^^^^\n@@ -59,7 +41,7 @@ LL |     #[empty_attr]\n    = help: add `#![feature(proc_macro_hygiene)]` to the crate attributes to enable\n \n error[E0658]: custom attributes cannot be applied to statements\n-  --> $DIR/proc-macro-gates.rs:38:5\n+  --> $DIR/proc-macro-gates.rs:34:5\n    |\n LL |     #[empty_attr]\n    |     ^^^^^^^^^^^^^\n@@ -68,7 +50,7 @@ LL |     #[empty_attr]\n    = help: add `#![feature(proc_macro_hygiene)]` to the crate attributes to enable\n \n error[E0658]: custom attributes cannot be applied to expressions\n-  --> $DIR/proc-macro-gates.rs:42:14\n+  --> $DIR/proc-macro-gates.rs:38:14\n    |\n LL |     let _x = #[identity_attr] 2;\n    |              ^^^^^^^^^^^^^^^^\n@@ -77,7 +59,7 @@ LL |     let _x = #[identity_attr] 2;\n    = help: add `#![feature(proc_macro_hygiene)]` to the crate attributes to enable\n \n error[E0658]: custom attributes cannot be applied to expressions\n-  --> $DIR/proc-macro-gates.rs:45:15\n+  --> $DIR/proc-macro-gates.rs:41:15\n    |\n LL |     let _x = [#[identity_attr] 2];\n    |               ^^^^^^^^^^^^^^^^\n@@ -86,7 +68,7 @@ LL |     let _x = [#[identity_attr] 2];\n    = help: add `#![feature(proc_macro_hygiene)]` to the crate attributes to enable\n \n error[E0658]: custom attributes cannot be applied to expressions\n-  --> $DIR/proc-macro-gates.rs:48:14\n+  --> $DIR/proc-macro-gates.rs:44:14\n    |\n LL |     let _x = #[identity_attr] println!();\n    |              ^^^^^^^^^^^^^^^^\n@@ -95,7 +77,7 @@ LL |     let _x = #[identity_attr] println!();\n    = help: add `#![feature(proc_macro_hygiene)]` to the crate attributes to enable\n \n error[E0658]: procedural macros cannot be expanded to patterns\n-  --> $DIR/proc-macro-gates.rs:53:12\n+  --> $DIR/proc-macro-gates.rs:49:12\n    |\n LL |     if let identity!(Some(_x)) = Some(3) {}\n    |            ^^^^^^^^^^^^^^^^^^^\n@@ -104,7 +86,7 @@ LL |     if let identity!(Some(_x)) = Some(3) {}\n    = help: add `#![feature(proc_macro_hygiene)]` to the crate attributes to enable\n \n error[E0658]: procedural macros cannot be expanded to statements\n-  --> $DIR/proc-macro-gates.rs:56:5\n+  --> $DIR/proc-macro-gates.rs:52:5\n    |\n LL |     empty!(struct S;);\n    |     ^^^^^^^^^^^^^^^^^^\n@@ -113,7 +95,7 @@ LL |     empty!(struct S;);\n    = help: add `#![feature(proc_macro_hygiene)]` to the crate attributes to enable\n \n error[E0658]: procedural macros cannot be expanded to statements\n-  --> $DIR/proc-macro-gates.rs:57:5\n+  --> $DIR/proc-macro-gates.rs:53:5\n    |\n LL |     empty!(let _x = 3;);\n    |     ^^^^^^^^^^^^^^^^^^^^\n@@ -122,7 +104,7 @@ LL |     empty!(let _x = 3;);\n    = help: add `#![feature(proc_macro_hygiene)]` to the crate attributes to enable\n \n error[E0658]: procedural macros cannot be expanded to expressions\n-  --> $DIR/proc-macro-gates.rs:59:14\n+  --> $DIR/proc-macro-gates.rs:55:14\n    |\n LL |     let _x = identity!(3);\n    |              ^^^^^^^^^^^^\n@@ -131,14 +113,14 @@ LL |     let _x = identity!(3);\n    = help: add `#![feature(proc_macro_hygiene)]` to the crate attributes to enable\n \n error[E0658]: procedural macros cannot be expanded to expressions\n-  --> $DIR/proc-macro-gates.rs:60:15\n+  --> $DIR/proc-macro-gates.rs:56:15\n    |\n LL |     let _x = [empty!(3)];\n    |               ^^^^^^^^^\n    |\n    = note: for more information, see https://github.com/rust-lang/rust/issues/54727\n    = help: add `#![feature(proc_macro_hygiene)]` to the crate attributes to enable\n \n-error: aborting due to 16 previous errors\n+error: aborting due to 14 previous errors\n \n For more information about this error, try `rustc --explain E0658`."}]}