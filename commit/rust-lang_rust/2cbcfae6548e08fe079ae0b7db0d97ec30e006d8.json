{"sha": "2cbcfae6548e08fe079ae0b7db0d97ec30e006d8", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJjYmNmYWU2NTQ4ZTA4ZmUwNzlhZTBiN2RiMGQ5N2VjMzBlMDA2ZDg=", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2021-05-05T15:52:29Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-05-05T15:52:29Z"}, "message": "Rollup merge of #84913 - estebank:issue-84831, r=varkor\n\nDo not ICE on invalid const param\n\nWhen encountering a path that can't have generics, do not call\n`generics_of`. This would happen when writing something like\n`path::this_is_a_mod<const_val>`.\n\nFix #84831.", "tree": {"sha": "02063ef4cd6cb4e64d1b16f885ed993abe663fb9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/02063ef4cd6cb4e64d1b16f885ed993abe663fb9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2cbcfae6548e08fe079ae0b7db0d97ec30e006d8", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgkr8+CRBK7hj4Ov3rIwAAT3IIAB7vfsvkmBI2LMnAWr5dFI7L\nGA2bX5v36pNLFUUy5OJ4xvTjHugRe7OiHbt2fszWqLEUoUTLSM/+Ygtv0NunVahi\nU5febxsP1/ZY0m4r3DeTGm5RnUW/xpUC+m/rlxBqWX8euX1e3OwFp4Zrdie0jRSP\nJQtmuBnP9sh3XzMfnNb7b4jH3FosC1Krty+/78I5FyTOMvNqKp+IcgRBKwPMTHV2\nkx0fuoUWLKFZVehcJGM/zNtm/wVLqlTyMok7Ke5ig7FVLeH7Bh8pl9d6ALkScjmb\nVdhNCYSWVOspNKxfALllysNCqkYKrIwTG08LDG5a6cLmPTByxEmzlzAv2rGGLS4=\n=jSOz\n-----END PGP SIGNATURE-----\n", "payload": "tree 02063ef4cd6cb4e64d1b16f885ed993abe663fb9\nparent 2c7bf41b97e1b2a4ad475dd8fb197ce7f0c5c805\nparent 11379f0494b6a8c81b3fb9e0411651bc749aaa06\nauthor Ralf Jung <post@ralfj.de> 1620229949 +0200\ncommitter GitHub <noreply@github.com> 1620229949 +0200\n\nRollup merge of #84913 - estebank:issue-84831, r=varkor\n\nDo not ICE on invalid const param\n\nWhen encountering a path that can't have generics, do not call\n`generics_of`. This would happen when writing something like\n`path::this_is_a_mod<const_val>`.\n\nFix #84831.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2cbcfae6548e08fe079ae0b7db0d97ec30e006d8", "html_url": "https://github.com/rust-lang/rust/commit/2cbcfae6548e08fe079ae0b7db0d97ec30e006d8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2cbcfae6548e08fe079ae0b7db0d97ec30e006d8/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2c7bf41b97e1b2a4ad475dd8fb197ce7f0c5c805", "url": "https://api.github.com/repos/rust-lang/rust/commits/2c7bf41b97e1b2a4ad475dd8fb197ce7f0c5c805", "html_url": "https://github.com/rust-lang/rust/commit/2c7bf41b97e1b2a4ad475dd8fb197ce7f0c5c805"}, {"sha": "11379f0494b6a8c81b3fb9e0411651bc749aaa06", "url": "https://api.github.com/repos/rust-lang/rust/commits/11379f0494b6a8c81b3fb9e0411651bc749aaa06", "html_url": "https://github.com/rust-lang/rust/commit/11379f0494b6a8c81b3fb9e0411651bc749aaa06"}], "stats": {"total": 55, "additions": 54, "deletions": 1}, "files": [{"sha": "97b6f5cf41211fb8873f22eb9c263b4f8383bcff", "filename": "compiler/rustc_typeck/src/collect/type_of.rs", "status": "modified", "additions": 19, "deletions": 1, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/2cbcfae6548e08fe079ae0b7db0d97ec30e006d8/compiler%2Frustc_typeck%2Fsrc%2Fcollect%2Ftype_of.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2cbcfae6548e08fe079ae0b7db0d97ec30e006d8/compiler%2Frustc_typeck%2Fsrc%2Fcollect%2Ftype_of.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcollect%2Ftype_of.rs?ref=2cbcfae6548e08fe079ae0b7db0d97ec30e006d8", "patch": "@@ -191,7 +191,25 @@ pub(super) fn opt_const_param_of(tcx: TyCtxt<'_>, def_id: LocalDefId) -> Option<\n                     Res::Def(DefKind::Ctor(..), def_id) => {\n                         tcx.generics_of(tcx.parent(def_id).unwrap())\n                     }\n-                    Res::Def(_, def_id) => tcx.generics_of(def_id),\n+                    // Other `DefKind`s don't have generics and would ICE when calling\n+                    // `generics_of`.\n+                    Res::Def(\n+                        DefKind::Struct\n+                        | DefKind::Union\n+                        | DefKind::Enum\n+                        | DefKind::Variant\n+                        | DefKind::Trait\n+                        | DefKind::OpaqueTy\n+                        | DefKind::TyAlias\n+                        | DefKind::ForeignTy\n+                        | DefKind::TraitAlias\n+                        | DefKind::AssocTy\n+                        | DefKind::Fn\n+                        | DefKind::AssocFn\n+                        | DefKind::AssocConst\n+                        | DefKind::Impl,\n+                        def_id,\n+                    ) => tcx.generics_of(def_id),\n                     Res::Err => {\n                         tcx.sess.delay_span_bug(tcx.def_span(def_id), \"anon const with Res::Err\");\n                         return None;"}, {"sha": "c646f71072532a4631ddfd8009793527b796ddcc", "filename": "src/test/ui/typeck/issue-84831.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/2cbcfae6548e08fe079ae0b7db0d97ec30e006d8/src%2Ftest%2Fui%2Ftypeck%2Fissue-84831.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2cbcfae6548e08fe079ae0b7db0d97ec30e006d8/src%2Ftest%2Fui%2Ftypeck%2Fissue-84831.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Fissue-84831.rs?ref=2cbcfae6548e08fe079ae0b7db0d97ec30e006d8", "patch": "@@ -0,0 +1,9 @@\n+fn f() {\n+    std::<0>; //~ ERROR expected value\n+}\n+fn j() {\n+    std::<_ as _>; //~ ERROR expected value\n+    //~^ ERROR expected one of `,` or `>`, found keyword `as`\n+}\n+\n+fn main () {}"}, {"sha": "e3cce10a00fd1fc68cb81190b8fba7993322f3ad", "filename": "src/test/ui/typeck/issue-84831.stderr", "status": "added", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/2cbcfae6548e08fe079ae0b7db0d97ec30e006d8/src%2Ftest%2Fui%2Ftypeck%2Fissue-84831.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2cbcfae6548e08fe079ae0b7db0d97ec30e006d8/src%2Ftest%2Fui%2Ftypeck%2Fissue-84831.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Fissue-84831.stderr?ref=2cbcfae6548e08fe079ae0b7db0d97ec30e006d8", "patch": "@@ -0,0 +1,26 @@\n+error: expected one of `,` or `>`, found keyword `as`\n+  --> $DIR/issue-84831.rs:5:13\n+   |\n+LL |     std::<_ as _>;\n+   |             ^^ expected one of `,` or `>`\n+   |\n+help: expressions must be enclosed in braces to be used as const generic arguments\n+   |\n+LL |     std::<{ _ as _ }>;\n+   |           ^        ^\n+\n+error[E0423]: expected value, found crate `std`\n+  --> $DIR/issue-84831.rs:2:5\n+   |\n+LL |     std::<0>;\n+   |     ^^^^^^^^ not a value\n+\n+error[E0423]: expected value, found crate `std`\n+  --> $DIR/issue-84831.rs:5:5\n+   |\n+LL |     std::<_ as _>;\n+   |     ^^^^^^^^^^^^^ not a value\n+\n+error: aborting due to 3 previous errors\n+\n+For more information about this error, try `rustc --explain E0423`."}]}