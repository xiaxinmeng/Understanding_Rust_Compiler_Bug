{"sha": "8746b79a384cdb30ecc2dae3ca0f0ece4dc56eed", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg3NDZiNzlhMzg0Y2RiMzBlY2MyZGFlM2NhMGYwZWNlNGRjNTZlZWQ=", "commit": {"author": {"name": "Cameron Steffen", "email": "cam.steffen94@gmail.com", "date": "2021-07-29T18:13:37Z"}, "committer": {"name": "Cameron Steffen", "email": "cam.steffen94@gmail.com", "date": "2021-08-01T22:46:23Z"}, "message": "Inline create_maybe_get_coercion_reason macro", "tree": {"sha": "38573e4c18e06f793a568a44ed12bd07652f004c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/38573e4c18e06f793a568a44ed12bd07652f004c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8746b79a384cdb30ecc2dae3ca0f0ece4dc56eed", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8746b79a384cdb30ecc2dae3ca0f0ece4dc56eed", "html_url": "https://github.com/rust-lang/rust/commit/8746b79a384cdb30ecc2dae3ca0f0ece4dc56eed", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8746b79a384cdb30ecc2dae3ca0f0ece4dc56eed/comments", "author": {"login": "camsteffen", "id": 5565418, "node_id": "MDQ6VXNlcjU1NjU0MTg=", "avatar_url": "https://avatars.githubusercontent.com/u/5565418?v=4", "gravatar_id": "", "url": "https://api.github.com/users/camsteffen", "html_url": "https://github.com/camsteffen", "followers_url": "https://api.github.com/users/camsteffen/followers", "following_url": "https://api.github.com/users/camsteffen/following{/other_user}", "gists_url": "https://api.github.com/users/camsteffen/gists{/gist_id}", "starred_url": "https://api.github.com/users/camsteffen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/camsteffen/subscriptions", "organizations_url": "https://api.github.com/users/camsteffen/orgs", "repos_url": "https://api.github.com/users/camsteffen/repos", "events_url": "https://api.github.com/users/camsteffen/events{/privacy}", "received_events_url": "https://api.github.com/users/camsteffen/received_events", "type": "User", "site_admin": false}, "committer": {"login": "camsteffen", "id": 5565418, "node_id": "MDQ6VXNlcjU1NjU0MTg=", "avatar_url": "https://avatars.githubusercontent.com/u/5565418?v=4", "gravatar_id": "", "url": "https://api.github.com/users/camsteffen", "html_url": "https://github.com/camsteffen", "followers_url": "https://api.github.com/users/camsteffen/followers", "following_url": "https://api.github.com/users/camsteffen/following{/other_user}", "gists_url": "https://api.github.com/users/camsteffen/gists{/gist_id}", "starred_url": "https://api.github.com/users/camsteffen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/camsteffen/subscriptions", "organizations_url": "https://api.github.com/users/camsteffen/orgs", "repos_url": "https://api.github.com/users/camsteffen/repos", "events_url": "https://api.github.com/users/camsteffen/events{/privacy}", "received_events_url": "https://api.github.com/users/camsteffen/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4e21ef2a4eca12180e24a345d66066fc1e4e36da", "url": "https://api.github.com/repos/rust-lang/rust/commits/4e21ef2a4eca12180e24a345d66066fc1e4e36da", "html_url": "https://github.com/rust-lang/rust/commit/4e21ef2a4eca12180e24a345d66066fc1e4e36da"}], "stats": {"total": 102, "additions": 50, "deletions": 52}, "files": [{"sha": "dee81510b795b8942f368ed91c77f91044e23650", "filename": "compiler/rustc_typeck/src/check/_match.rs", "status": "modified", "additions": 49, "deletions": 51, "changes": 100, "blob_url": "https://github.com/rust-lang/rust/blob/8746b79a384cdb30ecc2dae3ca0f0ece4dc56eed/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2F_match.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8746b79a384cdb30ecc2dae3ca0f0ece4dc56eed/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2F_match.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2F_match.rs?ref=8746b79a384cdb30ecc2dae3ca0f0ece4dc56eed", "patch": "@@ -13,41 +13,6 @@ use rustc_trait_selection::traits::{\n     StatementAsExpression,\n };\n \n-macro_rules! create_maybe_get_coercion_reason {\n-    ($fn_name:ident, $node:expr) => {\n-        pub(crate) fn $fn_name(&self, hir_id: hir::HirId, sp: Span) -> Option<(Span, String)> {\n-            let node = $node(self.tcx.hir(), hir_id);\n-            if let hir::Node::Block(block) = node {\n-                // check that the body's parent is an fn\n-                let parent = self.tcx.hir().get(\n-                    self.tcx.hir().get_parent_node(self.tcx.hir().get_parent_node(block.hir_id)),\n-                );\n-                if let (\n-                    Some(expr),\n-                    hir::Node::Item(hir::Item { kind: hir::ItemKind::Fn(..), .. }),\n-                ) = (&block.expr, parent)\n-                {\n-                    // check that the `if` expr without `else` is the fn body's expr\n-                    if expr.span == sp {\n-                        return self.get_fn_decl(hir_id).and_then(|(fn_decl, _)| {\n-                            let span = fn_decl.output.span();\n-                            let snippet = self.tcx.sess.source_map().span_to_snippet(span).ok()?;\n-                            Some((\n-                                span,\n-                                format!(\"expected `{}` because of this return type\", snippet),\n-                            ))\n-                        });\n-                    }\n-                }\n-            }\n-            if let hir::Node::Local(hir::Local { ty: Some(_), pat, .. }) = node {\n-                return Some((pat.span, \"expected because of this assignment\".to_string()));\n-            }\n-            None\n-        }\n-    };\n-}\n-\n impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n     pub fn check_match(\n         &self,\n@@ -154,7 +119,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                     expr.span,\n                     &arms[0].body,\n                     &mut coercion,\n-                    |hir_id, span| self.maybe_get_coercion_reason(hir_id, span),\n+                    |hir_id, span| self.coercion_reason_match(hir_id, span),\n                 ) {\n                 tcx.ty_error()\n             } else {\n@@ -373,23 +338,56 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         error\n     }\n \n-    create_maybe_get_coercion_reason!(\n-        maybe_get_coercion_reason,\n-        |hir: rustc_middle::hir::map::Map<'a>, id| {\n-            let arm_id = hir.get_parent_node(id);\n-            let match_id = hir.get_parent_node(arm_id);\n-            let containing_id = hir.get_parent_node(match_id);\n-            hir.get(containing_id)\n-        }\n-    );\n+    pub(crate) fn coercion_reason_if(\n+        &self,\n+        hir_id: hir::HirId,\n+        span: Span,\n+    ) -> Option<(Span, String)> {\n+        self.coercion_reason_inner(hir_id, span, 1)\n+    }\n \n-    create_maybe_get_coercion_reason!(\n-        maybe_get_coercion_reason_if,\n-        |hir: rustc_middle::hir::map::Map<'a>, id| {\n-            let rslt = hir.get_parent_node(hir.get_parent_node(id));\n-            hir.get(rslt)\n+    pub(crate) fn coercion_reason_match(\n+        &self,\n+        hir_id: hir::HirId,\n+        span: Span,\n+    ) -> Option<(Span, String)> {\n+        self.coercion_reason_inner(hir_id, span, 2)\n+    }\n+\n+    fn coercion_reason_inner(\n+        &self,\n+        hir_id: hir::HirId,\n+        span: Span,\n+        parent_index: usize,\n+    ) -> Option<(Span, String)> {\n+        let hir = self.tcx.hir();\n+        let mut parent_iter = hir.parent_iter(hir_id);\n+        let (_, node) = parent_iter.nth(parent_index)?;\n+        match node {\n+            hir::Node::Block(block) => {\n+                let expr = block.expr?;\n+                // check that the body's parent is an fn\n+                let (_, parent) = parent_iter.nth(1)?;\n+                if let hir::Node::Item(hir::Item { kind: hir::ItemKind::Fn(..), .. }) = parent {\n+                    // check that the `if` expr without `else` is the fn body's expr\n+                    if expr.span == span {\n+                        let (fn_decl, _) = self.get_fn_decl(hir_id)?;\n+                        let span = fn_decl.output.span();\n+                        let snippet = self.tcx.sess.source_map().span_to_snippet(span).ok()?;\n+                        return Some((\n+                            span,\n+                            format!(\"expected `{}` because of this return type\", snippet),\n+                        ));\n+                    }\n+                }\n+                None\n+            }\n+            hir::Node::Local(hir::Local { ty: Some(_), pat, .. }) => {\n+                Some((pat.span, \"expected because of this assignment\".to_string()))\n+            }\n+            _ => None,\n         }\n-    );\n+    }\n \n     pub(crate) fn if_cause(\n         &self,"}, {"sha": "e95884ae23b9397343ffb21ba2b067c67cd448b3", "filename": "compiler/rustc_typeck/src/check/expr.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/8746b79a384cdb30ecc2dae3ca0f0ece4dc56eed/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8746b79a384cdb30ecc2dae3ca0f0ece4dc56eed/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fexpr.rs?ref=8746b79a384cdb30ecc2dae3ca0f0ece4dc56eed", "patch": "@@ -838,7 +838,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n             self.diverges.set(cond_diverges | then_diverges & else_diverges);\n         } else {\n             self.if_fallback_coercion(sp, then_expr, &mut coerce, |hir_id, span| {\n-                self.maybe_get_coercion_reason_if(hir_id, span)\n+                self.coercion_reason_if(hir_id, span)\n             });\n \n             // If the condition is false we can't diverge."}]}