{"sha": "f4d7d099021500c049741d90041869a7890211da", "node_id": "C_kwDOAAsO6NoAKGY0ZDdkMDk5MDIxNTAwYzA0OTc0MWQ5MDA0MTg2OWE3ODkwMjExZGE", "commit": {"author": {"name": "Eric Holk", "email": "ericholk@microsoft.com", "date": "2022-01-25T00:11:33Z"}, "committer": {"name": "Eric Holk", "email": "ericholk@microsoft.com", "date": "2022-01-25T00:11:33Z"}, "message": "Disable drop range analysis\n\nThe previous PR, #93165, still performed the drop range analysis\ndespite ignoring the results. Unfortunately, there were ICEs in\nthe analysis as well, so some packages failed to build (see the\nissue #93197 for an example). This change further disables the\nanalysis and just provides dummy results in that case.", "tree": {"sha": "4ecca2df5c2deb2dff2aaece6f177b2de6adaf97", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4ecca2df5c2deb2dff2aaece6f177b2de6adaf97"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f4d7d099021500c049741d90041869a7890211da", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f4d7d099021500c049741d90041869a7890211da", "html_url": "https://github.com/rust-lang/rust/commit/f4d7d099021500c049741d90041869a7890211da", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f4d7d099021500c049741d90041869a7890211da/comments", "author": {"login": "eholk", "id": 105766, "node_id": "MDQ6VXNlcjEwNTc2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/105766?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eholk", "html_url": "https://github.com/eholk", "followers_url": "https://api.github.com/users/eholk/followers", "following_url": "https://api.github.com/users/eholk/following{/other_user}", "gists_url": "https://api.github.com/users/eholk/gists{/gist_id}", "starred_url": "https://api.github.com/users/eholk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eholk/subscriptions", "organizations_url": "https://api.github.com/users/eholk/orgs", "repos_url": "https://api.github.com/users/eholk/repos", "events_url": "https://api.github.com/users/eholk/events{/privacy}", "received_events_url": "https://api.github.com/users/eholk/received_events", "type": "User", "site_admin": false}, "committer": {"login": "eholk", "id": 105766, "node_id": "MDQ6VXNlcjEwNTc2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/105766?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eholk", "html_url": "https://github.com/eholk", "followers_url": "https://api.github.com/users/eholk/followers", "following_url": "https://api.github.com/users/eholk/following{/other_user}", "gists_url": "https://api.github.com/users/eholk/gists{/gist_id}", "starred_url": "https://api.github.com/users/eholk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eholk/subscriptions", "organizations_url": "https://api.github.com/users/eholk/orgs", "repos_url": "https://api.github.com/users/eholk/repos", "events_url": "https://api.github.com/users/eholk/events{/privacy}", "received_events_url": "https://api.github.com/users/eholk/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "51126be1b260216b41143469086e6e6ee567647e", "url": "https://api.github.com/repos/rust-lang/rust/commits/51126be1b260216b41143469086e6e6ee567647e", "html_url": "https://github.com/rust-lang/rust/commit/51126be1b260216b41143469086e6e6ee567647e"}], "stats": {"total": 30, "additions": 18, "deletions": 12}, "files": [{"sha": "4b8f01e3535bde8cb7516385fb14c55629fac60a", "filename": "compiler/rustc_typeck/src/check/generator_interior/drop_ranges.rs", "status": "modified", "additions": 18, "deletions": 12, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/f4d7d099021500c049741d90041869a7890211da/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fgenerator_interior%2Fdrop_ranges.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f4d7d099021500c049741d90041869a7890211da/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fgenerator_interior%2Fdrop_ranges.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fgenerator_interior%2Fdrop_ranges.rs?ref=f4d7d099021500c049741d90041869a7890211da", "patch": "@@ -37,21 +37,27 @@ pub fn compute_drop_ranges<'a, 'tcx>(\n     def_id: DefId,\n     body: &'tcx Body<'tcx>,\n ) -> DropRanges {\n-    let consumed_borrowed_places = find_consumed_and_borrowed(fcx, def_id, body);\n+    if super::ENABLE_DROP_TRACKING {\n+        let consumed_borrowed_places = find_consumed_and_borrowed(fcx, def_id, body);\n \n-    let num_exprs = fcx.tcx.region_scope_tree(def_id).body_expr_count(body.id()).unwrap_or(0);\n-    let mut drop_ranges = build_control_flow_graph(\n-        fcx.tcx.hir(),\n-        fcx.tcx,\n-        &fcx.typeck_results.borrow(),\n-        consumed_borrowed_places,\n-        body,\n-        num_exprs,\n-    );\n+        let num_exprs = fcx.tcx.region_scope_tree(def_id).body_expr_count(body.id()).unwrap_or(0);\n+        let mut drop_ranges = build_control_flow_graph(\n+            fcx.tcx.hir(),\n+            fcx.tcx,\n+            &fcx.typeck_results.borrow(),\n+            consumed_borrowed_places,\n+            body,\n+            num_exprs,\n+        );\n \n-    drop_ranges.propagate_to_fixpoint();\n+        drop_ranges.propagate_to_fixpoint();\n \n-    DropRanges { tracked_value_map: drop_ranges.tracked_value_map, nodes: drop_ranges.nodes }\n+        DropRanges { tracked_value_map: drop_ranges.tracked_value_map, nodes: drop_ranges.nodes }\n+    } else {\n+        // If drop range tracking is not enabled, skip all the analysis and produce an\n+        // empty set of DropRanges.\n+        DropRanges { tracked_value_map: FxHashMap::default(), nodes: IndexVec::new() }\n+    }\n }\n \n /// Applies `f` to consumable node in the HIR subtree pointed to by `place`."}]}