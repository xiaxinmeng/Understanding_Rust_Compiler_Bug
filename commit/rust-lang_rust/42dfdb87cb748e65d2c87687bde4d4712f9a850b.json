{"sha": "42dfdb87cb748e65d2c87687bde4d4712f9a850b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQyZGZkYjg3Y2I3NDhlNjVkMmM4NzY4N2JkZTRkNDcxMmY5YTg1MGI=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-05-31T18:47:00Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-05-31T18:47:00Z"}, "message": "Merge #9090\n\n9090: hir_ty: use correct receiver_ty in method resolution r=cynecx a=cynecx\n\nFixes https://github.com/rust-analyzer/rust-analyzer/issues/8100.\n\nCo-authored-by: cynecx <me@cynecx.net>", "tree": {"sha": "7b3000a7b3b0ac22321177641b15463b81c1de66", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7b3000a7b3b0ac22321177641b15463b81c1de66"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/42dfdb87cb748e65d2c87687bde4d4712f9a850b", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgtS8kCRBK7hj4Ov3rIwAA1/sIAJ0A32bJ16Ohu5HyKlvu5w7G\ng2icfAIe6zHm0LQOTeOmghPYSiuGdy1f6P60NdaCHS9brNLll59WzZovUPBLZJml\nc3FbmH819vIHeLyZvxB5piym8cE6qm3DftscRFB+CnMgd6m8iaihWSTefSL39RJO\nGx+KGgRIXAuT1xelRpKlLig9crfYi4sYb1r1unsYohh5QsyWOnp1H9/87ojP1ib6\nUkXFzSOoWcRbO6sLOz45Ag2wcg6EVg6DS/ymlGwIVHJNIqiwD/B02HqjxCNBPFh5\nOUnYrklQp9KfNV4G4aZEyZOQ7ECuYcPtX+WgPWIOaWMqmE8NcPw1fE6dWkN9odA=\n=AKy9\n-----END PGP SIGNATURE-----\n", "payload": "tree 7b3000a7b3b0ac22321177641b15463b81c1de66\nparent a127b10d0087c19c299ccfcb5b9f3af4615411f8\nparent 759cb07891d6c9583095d7a1423619b36bc3d547\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1622486820 +0000\ncommitter GitHub <noreply@github.com> 1622486820 +0000\n\nMerge #9090\n\n9090: hir_ty: use correct receiver_ty in method resolution r=cynecx a=cynecx\n\nFixes https://github.com/rust-analyzer/rust-analyzer/issues/8100.\n\nCo-authored-by: cynecx <me@cynecx.net>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/42dfdb87cb748e65d2c87687bde4d4712f9a850b", "html_url": "https://github.com/rust-lang/rust/commit/42dfdb87cb748e65d2c87687bde4d4712f9a850b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/42dfdb87cb748e65d2c87687bde4d4712f9a850b/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a127b10d0087c19c299ccfcb5b9f3af4615411f8", "url": "https://api.github.com/repos/rust-lang/rust/commits/a127b10d0087c19c299ccfcb5b9f3af4615411f8", "html_url": "https://github.com/rust-lang/rust/commit/a127b10d0087c19c299ccfcb5b9f3af4615411f8"}, {"sha": "759cb07891d6c9583095d7a1423619b36bc3d547", "url": "https://api.github.com/repos/rust-lang/rust/commits/759cb07891d6c9583095d7a1423619b36bc3d547", "html_url": "https://github.com/rust-lang/rust/commit/759cb07891d6c9583095d7a1423619b36bc3d547"}], "stats": {"total": 94, "additions": 82, "deletions": 12}, "files": [{"sha": "f73bf43b2154a1e3e07b26b0e477cc24232d60ad", "filename": "crates/hir_ty/src/infer/expr.rs", "status": "modified", "additions": 2, "deletions": 11, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/42dfdb87cb748e65d2c87687bde4d4712f9a850b/crates%2Fhir_ty%2Fsrc%2Finfer%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/42dfdb87cb748e65d2c87687bde4d4712f9a850b/crates%2Fhir_ty%2Fsrc%2Finfer%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Finfer%2Fexpr.rs?ref=42dfdb87cb748e65d2c87687bde4d4712f9a850b", "patch": "@@ -890,7 +890,7 @@ impl<'a> InferenceContext<'a> {\n                 method_name,\n             )\n         });\n-        let (derefed_receiver_ty, method_ty, substs) = match resolved {\n+        let (receiver_ty, method_ty, substs) = match resolved {\n             Some((ty, func)) => {\n                 let ty = canonicalized_receiver.decanonicalize_ty(ty);\n                 let generics = generics(self.db.upcast(), func.into());\n@@ -916,16 +916,7 @@ impl<'a> InferenceContext<'a> {\n             }\n             None => (self.err_ty(), Vec::new(), self.err_ty()),\n         };\n-        // Apply autoref so the below unification works correctly\n-        // FIXME: return correct autorefs from lookup_method\n-        let actual_receiver_ty = match self.resolve_ty_shallow(&expected_receiver_ty).as_reference()\n-        {\n-            Some((_, lifetime, mutability)) => {\n-                TyKind::Ref(mutability, lifetime, derefed_receiver_ty).intern(&Interner)\n-            }\n-            _ => derefed_receiver_ty,\n-        };\n-        self.unify(&expected_receiver_ty, &actual_receiver_ty);\n+        self.unify(&expected_receiver_ty, &receiver_ty);\n \n         self.check_call_arguments(args, &param_tys);\n         self.normalize_associated_types_in(ret_ty)"}, {"sha": "af6b6cda7092fcd130471750949a1a3ab60b29ed", "filename": "crates/hir_ty/src/method_resolution.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/42dfdb87cb748e65d2c87687bde4d4712f9a850b/crates%2Fhir_ty%2Fsrc%2Fmethod_resolution.rs", "raw_url": "https://github.com/rust-lang/rust/raw/42dfdb87cb748e65d2c87687bde4d4712f9a850b/crates%2Fhir_ty%2Fsrc%2Fmethod_resolution.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Fmethod_resolution.rs?ref=42dfdb87cb748e65d2c87687bde4d4712f9a850b", "patch": "@@ -721,7 +721,8 @@ fn iterate_inherent_methods(\n                     cov_mark::hit!(impl_self_type_match_without_receiver);\n                     continue;\n                 }\n-                if callback(&self_ty.value, item) {\n+                let receiver_ty = receiver_ty.map(|x| &x.value).unwrap_or(&self_ty.value);\n+                if callback(receiver_ty, item) {\n                     return true;\n                 }\n             }"}, {"sha": "ac312981df0d650cfeb8e84e14c71952ea97d575", "filename": "crates/hir_ty/src/tests/simple.rs", "status": "modified", "additions": 78, "deletions": 0, "changes": 78, "blob_url": "https://github.com/rust-lang/rust/blob/42dfdb87cb748e65d2c87687bde4d4712f9a850b/crates%2Fhir_ty%2Fsrc%2Ftests%2Fsimple.rs", "raw_url": "https://github.com/rust-lang/rust/raw/42dfdb87cb748e65d2c87687bde4d4712f9a850b/crates%2Fhir_ty%2Fsrc%2Ftests%2Fsimple.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Ftests%2Fsimple.rs?ref=42dfdb87cb748e65d2c87687bde4d4712f9a850b", "patch": "@@ -2634,3 +2634,81 @@ fn f() {\n         \"#]],\n     )\n }\n+\n+#[test]\n+fn infer_boxed_self_receiver() {\n+    check_infer(\n+        r#\"\n+#[lang = \"deref\"]\n+pub trait Deref {\n+    type Target;\n+    fn deref(&self) -> &Self::Target;\n+}\n+\n+struct Box<T>(T);\n+\n+impl<T> Deref for Box<T> {\n+    type Target = T;\n+    fn deref(&self) -> &Self::Target;\n+}\n+\n+struct Foo<T>(T);\n+\n+impl<T> Foo<T> {\n+    fn get_inner<'a>(self: &'a Box<Self>) -> &'a T {}\n+\n+    fn get_self<'a>(self: &'a Box<Self>) -> &'a Self {}\n+\n+    fn into_inner(self: Box<Self>) -> Self {}\n+}\n+\n+fn main() {\n+    let boxed = Box(Foo(0_i32));\n+\n+    let bad1 = boxed.get_inner();\n+    let good1 = Foo::get_inner(&boxed);\n+\n+    let bad2 = boxed.get_self();\n+    let good2 = Foo::get_self(&boxed);\n+\n+    let inner = boxed.into_inner();\n+}\n+        \"#,\n+        expect![[r#\"\n+            67..71 'self': &Self\n+            175..179 'self': &Box<T>\n+            259..263 'self': &Box<Foo<T>>\n+            289..291 '{}': ()\n+            313..317 'self': &Box<Foo<T>>\n+            346..348 '{}': ()\n+            368..372 'self': Box<Foo<T>>\n+            393..395 '{}': ()\n+            409..630 '{     ...r(); }': ()\n+            419..424 'boxed': Box<Foo<i32>>\n+            427..430 'Box': Box<Foo<i32>>(Foo<i32>) -> Box<Foo<i32>>\n+            427..442 'Box(Foo(0_i32))': Box<Foo<i32>>\n+            431..434 'Foo': Foo<i32>(i32) -> Foo<i32>\n+            431..441 'Foo(0_i32)': Foo<i32>\n+            435..440 '0_i32': i32\n+            453..457 'bad1': &i32\n+            460..465 'boxed': Box<Foo<i32>>\n+            460..477 'boxed....nner()': &i32\n+            487..492 'good1': &i32\n+            495..509 'Foo::get_inner': fn get_inner<i32>(&Box<Foo<i32>>) -> &i32\n+            495..517 'Foo::g...boxed)': &i32\n+            510..516 '&boxed': &Box<Foo<i32>>\n+            511..516 'boxed': Box<Foo<i32>>\n+            528..532 'bad2': &Foo<i32>\n+            535..540 'boxed': Box<Foo<i32>>\n+            535..551 'boxed....self()': &Foo<i32>\n+            561..566 'good2': &Foo<i32>\n+            569..582 'Foo::get_self': fn get_self<i32>(&Box<Foo<i32>>) -> &Foo<i32>\n+            569..590 'Foo::g...boxed)': &Foo<i32>\n+            583..589 '&boxed': &Box<Foo<i32>>\n+            584..589 'boxed': Box<Foo<i32>>\n+            601..606 'inner': Foo<i32>\n+            609..614 'boxed': Box<Foo<i32>>\n+            609..627 'boxed....nner()': Foo<i32>\n+        \"#]],\n+    );\n+}"}]}