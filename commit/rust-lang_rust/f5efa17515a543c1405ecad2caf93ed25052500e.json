{"sha": "f5efa17515a543c1405ecad2caf93ed25052500e", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY1ZWZhMTc1MTVhNTQzYzE0MDVlY2FkMmNhZjkzZWQyNTA1MjUwMGU=", "commit": {"author": {"name": "Josh Mcguigan", "email": "joshmcg88@gmail.com", "date": "2020-03-01T22:02:32Z"}, "committer": {"name": "Josh Mcguigan", "email": "joshmcg88@gmail.com", "date": "2020-03-01T22:02:32Z"}, "message": "handle array pattern matching type inference", "tree": {"sha": "cb91b80bee65f81bb408ab0c1f1240733f3156f1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/cb91b80bee65f81bb408ab0c1f1240733f3156f1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f5efa17515a543c1405ecad2caf93ed25052500e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f5efa17515a543c1405ecad2caf93ed25052500e", "html_url": "https://github.com/rust-lang/rust/commit/f5efa17515a543c1405ecad2caf93ed25052500e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f5efa17515a543c1405ecad2caf93ed25052500e/comments", "author": {"login": "JoshMcguigan", "id": 22216761, "node_id": "MDQ6VXNlcjIyMjE2NzYx", "avatar_url": "https://avatars.githubusercontent.com/u/22216761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JoshMcguigan", "html_url": "https://github.com/JoshMcguigan", "followers_url": "https://api.github.com/users/JoshMcguigan/followers", "following_url": "https://api.github.com/users/JoshMcguigan/following{/other_user}", "gists_url": "https://api.github.com/users/JoshMcguigan/gists{/gist_id}", "starred_url": "https://api.github.com/users/JoshMcguigan/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JoshMcguigan/subscriptions", "organizations_url": "https://api.github.com/users/JoshMcguigan/orgs", "repos_url": "https://api.github.com/users/JoshMcguigan/repos", "events_url": "https://api.github.com/users/JoshMcguigan/events{/privacy}", "received_events_url": "https://api.github.com/users/JoshMcguigan/received_events", "type": "User", "site_admin": false}, "committer": {"login": "JoshMcguigan", "id": 22216761, "node_id": "MDQ6VXNlcjIyMjE2NzYx", "avatar_url": "https://avatars.githubusercontent.com/u/22216761?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JoshMcguigan", "html_url": "https://github.com/JoshMcguigan", "followers_url": "https://api.github.com/users/JoshMcguigan/followers", "following_url": "https://api.github.com/users/JoshMcguigan/following{/other_user}", "gists_url": "https://api.github.com/users/JoshMcguigan/gists{/gist_id}", "starred_url": "https://api.github.com/users/JoshMcguigan/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JoshMcguigan/subscriptions", "organizations_url": "https://api.github.com/users/JoshMcguigan/orgs", "repos_url": "https://api.github.com/users/JoshMcguigan/repos", "events_url": "https://api.github.com/users/JoshMcguigan/events{/privacy}", "received_events_url": "https://api.github.com/users/JoshMcguigan/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b9ef7a6b987eea4b0b14298fbbe44d912806f50f", "url": "https://api.github.com/repos/rust-lang/rust/commits/b9ef7a6b987eea4b0b14298fbbe44d912806f50f", "html_url": "https://github.com/rust-lang/rust/commit/b9ef7a6b987eea4b0b14298fbbe44d912806f50f"}], "stats": {"total": 65, "additions": 55, "deletions": 10}, "files": [{"sha": "623e525993969787cc999cfeb262e14f86bfce4e", "filename": "crates/ra_hir_ty/src/infer/pat.rs", "status": "modified", "additions": 14, "deletions": 10, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/f5efa17515a543c1405ecad2caf93ed25052500e/crates%2Fra_hir_ty%2Fsrc%2Finfer%2Fpat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f5efa17515a543c1405ecad2caf93ed25052500e/crates%2Fra_hir_ty%2Fsrc%2Finfer%2Fpat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_ty%2Fsrc%2Finfer%2Fpat.rs?ref=f5efa17515a543c1405ecad2caf93ed25052500e", "patch": "@@ -12,7 +12,7 @@ use hir_expand::name::Name;\n use test_utils::tested_by;\n \n use super::{BindingMode, InferenceContext};\n-use crate::{db::HirDatabase, utils::variant_data, Substs, Ty, TypeCtor, ApplicationTy};\n+use crate::{db::HirDatabase, utils::variant_data, Substs, Ty, TypeCtor};\n \n impl<'a, D: HirDatabase> InferenceContext<'a, D> {\n     fn infer_tuple_struct_pat(\n@@ -186,17 +186,21 @@ impl<'a, D: HirDatabase> InferenceContext<'a, D> {\n                 return inner_ty;\n             }\n             Pat::Slice { prefix, slice: _slice, suffix } => {\n-                let ty = if let Ty::Apply(ApplicationTy { ctor: TypeCtor::Slice, parameters }) = expected {\n-                    for pat_id in prefix.iter().chain(suffix) {\n-                        self.infer_pat(*pat_id, parameters.as_single(), default_bm);\n-                    }\n-\n-                    parameters.as_single().clone()\n-                } else {\n-                    Ty::Unknown\n+                let (container_ty, elem_ty) = match &expected {\n+                    ty_app!(TypeCtor::Array, st) => {\n+                        (TypeCtor::Array, st.as_single().clone())\n+                    },\n+                    ty_app!(TypeCtor::Slice, st) => {\n+                        (TypeCtor::Slice, st.as_single().clone())\n+                    },\n+                    _ => (TypeCtor::Slice, Ty::Unknown),\n                 };\n \n-                Ty::apply_one(TypeCtor::Slice, ty)\n+                for pat_id in prefix.iter().chain(suffix) {\n+                    self.infer_pat(*pat_id, &elem_ty, default_bm);\n+                }\n+\n+                Ty::apply_one(container_ty, elem_ty)\n             }\n             _ => Ty::Unknown,\n         };"}, {"sha": "76aa320246f2fd38a6d182d73d458339785c8fda", "filename": "crates/ra_hir_ty/src/tests/patterns.rs", "status": "modified", "additions": 41, "deletions": 0, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/f5efa17515a543c1405ecad2caf93ed25052500e/crates%2Fra_hir_ty%2Fsrc%2Ftests%2Fpatterns.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f5efa17515a543c1405ecad2caf93ed25052500e/crates%2Fra_hir_ty%2Fsrc%2Ftests%2Fpatterns.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_ty%2Fsrc%2Ftests%2Fpatterns.rs?ref=f5efa17515a543c1405ecad2caf93ed25052500e", "patch": "@@ -54,6 +54,7 @@ fn test(x: &i32) {\n     [144; 145) 'e': {unknown}\n     [158; 205) 'if let...     }': ()\n     [165; 170) '[val]': [{unknown}]\n+    [166; 169) 'val': {unknown}\n     [173; 176) 'opt': [{unknown}]\n     [177; 205) '{     ...     }': ()\n     [191; 192) 'h': {unknown}\n@@ -184,6 +185,46 @@ fn test() {\n     );\n }\n \n+#[test]\n+fn infer_pattern_match_arr() {\n+    assert_snapshot!(\n+        infer(r#\"\n+fn test() {\n+    let arr: [f64; 2] = [0.0, 1.0];\n+    match arr {\n+        [1.0, a] => {\n+            a;\n+        },\n+        [b, c] => {\n+            b;\n+            c;\n+        }\n+    }\n+}\n+\"#),\n+    @r###\"\n+    [11; 180) '{     ...   } }': ()\n+    [21; 24) 'arr': [f64; _]\n+    [37; 47) '[0.0, 1.0]': [f64; _]\n+    [38; 41) '0.0': f64\n+    [43; 46) '1.0': f64\n+    [53; 178) 'match ...     }': ()\n+    [59; 62) 'arr': [f64; _]\n+    [73; 81) '[1.0, a]': [f64; _]\n+    [74; 77) '1.0': f64\n+    [79; 80) 'a': f64\n+    [85; 111) '{     ...     }': ()\n+    [99; 100) 'a': f64\n+    [121; 127) '[b, c]': [f64; _]\n+    [122; 123) 'b': f64\n+    [125; 126) 'c': f64\n+    [131; 172) '{     ...     }': ()\n+    [145; 146) 'b': f64\n+    [160; 161) 'c': f64\n+    \"###\n+    );\n+}\n+\n #[test]\n fn infer_adt_pattern() {\n     assert_snapshot!("}]}