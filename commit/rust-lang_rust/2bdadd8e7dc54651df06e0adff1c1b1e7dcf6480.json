{"sha": "2bdadd8e7dc54651df06e0adff1c1b1e7dcf6480", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJiZGFkZDhlN2RjNTQ2NTFkZjA2ZTBhZGZmMWMxYjFlN2RjZjY0ODA=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-10-09T23:14:58Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-10-09T23:14:58Z"}, "message": "Auto merge of #6151 - bofh69:master, r=ebroto\n\nPreserve raw strs for: format!(s) to s.to_string() lint\n\nfixes #6142\n\nclippy::useless_format will keep the source's string (after converting {{ and }} to { and }) when suggesting a change from format!() to .to_string() usage. Ie:\n|     let s = format!(r#\"\"hello {{}}\"\"#);\n|             ^^^^^^^^^^^^^^^^^^^^^ help: consider using `.to_string()`: `r#\"\"hello {}\"\"#.to_string()`\n\nchangelog: [`useless_format`]: preserve raw string literals when no arguments to `format!()` are provided.", "tree": {"sha": "b3471fef1070d8876826263fbb632602d8a76d5e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b3471fef1070d8876826263fbb632602d8a76d5e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2bdadd8e7dc54651df06e0adff1c1b1e7dcf6480", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2bdadd8e7dc54651df06e0adff1c1b1e7dcf6480", "html_url": "https://github.com/rust-lang/rust/commit/2bdadd8e7dc54651df06e0adff1c1b1e7dcf6480", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2bdadd8e7dc54651df06e0adff1c1b1e7dcf6480/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0b86340999c207647b797bccbb1d49f824a277df", "url": "https://api.github.com/repos/rust-lang/rust/commits/0b86340999c207647b797bccbb1d49f824a277df", "html_url": "https://github.com/rust-lang/rust/commit/0b86340999c207647b797bccbb1d49f824a277df"}, {"sha": "7b7ddfa55da889b41e90243ac59a04eed832a71e", "url": "https://api.github.com/repos/rust-lang/rust/commits/7b7ddfa55da889b41e90243ac59a04eed832a71e", "html_url": "https://github.com/rust-lang/rust/commit/7b7ddfa55da889b41e90243ac59a04eed832a71e"}], "stats": {"total": 19, "additions": 15, "deletions": 4}, "files": [{"sha": "26da058598e4ff996ff872cc16e22e7fbdc48b77", "filename": "clippy_lints/src/format.rs", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/2bdadd8e7dc54651df06e0adff1c1b1e7dcf6480/clippy_lints%2Fsrc%2Fformat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2bdadd8e7dc54651df06e0adff1c1b1e7dcf6480/clippy_lints%2Fsrc%2Fformat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fformat.rs?ref=2bdadd8e7dc54651df06e0adff1c1b1e7dcf6480", "patch": "@@ -1,6 +1,6 @@\n use crate::utils::paths;\n use crate::utils::{\n-    is_expn_of, is_type_diagnostic_item, last_path_segment, match_def_path, match_function_call, snippet,\n+    is_expn_of, is_type_diagnostic_item, last_path_segment, match_def_path, match_function_call, snippet, snippet_opt,\n     span_lint_and_then,\n };\n use if_chain::if_chain;\n@@ -132,7 +132,11 @@ fn on_new_v1<'tcx>(cx: &LateContext<'tcx>, expr: &'tcx Expr<'_>) -> Option<Strin\n         then {\n             // `format!(\"foo\")` expansion contains `match () { () => [], }`\n             if tup.is_empty() {\n-                return Some(format!(\"{:?}.to_string()\", s.as_str()));\n+                if let Some(s_src) = snippet_opt(cx, lit.span) {\n+                    // Simulate macro expansion, converting {{ and }} to { and }.\n+                    let s_expand = s_src.replace(\"{{\", \"{\").replace(\"}}\", \"}\");\n+                    return Some(format!(\"{}.to_string()\", s_expand))\n+                }\n             } else if s.as_str().is_empty() {\n                 return on_argumentv1_new(cx, &tup[0], arms);\n             }"}, {"sha": "740a22a07d747c5dc409fea811cf27afb96e5468", "filename": "tests/ui/format.fixed", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/2bdadd8e7dc54651df06e0adff1c1b1e7dcf6480/tests%2Fui%2Fformat.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/2bdadd8e7dc54651df06e0adff1c1b1e7dcf6480/tests%2Fui%2Fformat.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fformat.fixed?ref=2bdadd8e7dc54651df06e0adff1c1b1e7dcf6480", "patch": "@@ -13,7 +13,8 @@ fn main() {\n     \"foo\".to_string();\n     \"{}\".to_string();\n     \"{} abc {}\".to_string();\n-    \"foo {}\\n\\\" bar\".to_string();\n+    r##\"foo {}\n+\" bar\"##.to_string();\n \n     \"foo\".to_string();\n     format!(\"{:?}\", \"foo\"); // Don't warn about `Debug`."}, {"sha": "96df7f37f779232dd03fc305b86845381317ef69", "filename": "tests/ui/format.stderr", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/2bdadd8e7dc54651df06e0adff1c1b1e7dcf6480/tests%2Fui%2Fformat.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2bdadd8e7dc54651df06e0adff1c1b1e7dcf6480/tests%2Fui%2Fformat.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fformat.stderr?ref=2bdadd8e7dc54651df06e0adff1c1b1e7dcf6480", "patch": "@@ -25,7 +25,13 @@ LL | /     format!(\n LL | |         r##\"foo {{}}\n LL | | \" bar\"##\n LL | |     );\n-   | |______^ help: consider using `.to_string()`: `\"foo {}/n/\" bar\".to_string();`\n+   | |______^\n+   |\n+help: consider using `.to_string()`\n+   |\n+LL |     r##\"foo {}\n+LL | \" bar\"##.to_string();\n+   |\n \n error: useless use of `format!`\n   --> $DIR/format.rs:21:5"}]}