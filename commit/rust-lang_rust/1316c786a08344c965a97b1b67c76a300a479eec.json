{"sha": "1316c786a08344c965a97b1b67c76a300a479eec", "node_id": "MDY6Q29tbWl0NzI0NzEyOjEzMTZjNzg2YTA4MzQ0Yzk2NWE5N2IxYjY3Yzc2YTMwMGE0NzllZWM=", "commit": {"author": {"name": "The8472", "email": "git@infinite-source.de", "date": "2020-08-11T23:15:08Z"}, "committer": {"name": "The8472", "email": "git@infinite-source.de", "date": "2020-08-11T23:30:22Z"}, "message": "Workaround for copy_file_range spuriously returning EOPNOTSUPP when attemted on a NFS mount under RHEL/CentOS 7.\n\nThe syscall is supposed to return ENOSYS in most cases but when calling it on NFS it may leak through\nEOPNOTSUPP even though that's supposed to be handled by the kernel and not returned to userspace.\nSince it returns ENOSYS in some cases anyway this will trip the  HAS_COPY_FILE_RANGE\ndetection anyway, so treat EOPNOTSUPP as if it were a ENOSYS.\n\nhttps://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/7.8_release_notes/deprecated_functionality#the_literal_copy_file_range_literal_call_has_been_disabled_on_local_file_systems_and_in_nfs\nhttps://bugzilla.redhat.com/show_bug.cgi?id=1783554", "tree": {"sha": "deb30515edb9517b275a8bb600c79d46d05719f4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/deb30515edb9517b275a8bb600c79d46d05719f4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1316c786a08344c965a97b1b67c76a300a479eec", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1316c786a08344c965a97b1b67c76a300a479eec", "html_url": "https://github.com/rust-lang/rust/commit/1316c786a08344c965a97b1b67c76a300a479eec", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1316c786a08344c965a97b1b67c76a300a479eec/comments", "author": {"login": "the8472", "id": 1065730, "node_id": "MDQ6VXNlcjEwNjU3MzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1065730?v=4", "gravatar_id": "", "url": "https://api.github.com/users/the8472", "html_url": "https://github.com/the8472", "followers_url": "https://api.github.com/users/the8472/followers", "following_url": "https://api.github.com/users/the8472/following{/other_user}", "gists_url": "https://api.github.com/users/the8472/gists{/gist_id}", "starred_url": "https://api.github.com/users/the8472/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/the8472/subscriptions", "organizations_url": "https://api.github.com/users/the8472/orgs", "repos_url": "https://api.github.com/users/the8472/repos", "events_url": "https://api.github.com/users/the8472/events{/privacy}", "received_events_url": "https://api.github.com/users/the8472/received_events", "type": "User", "site_admin": false}, "committer": {"login": "the8472", "id": 1065730, "node_id": "MDQ6VXNlcjEwNjU3MzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1065730?v=4", "gravatar_id": "", "url": "https://api.github.com/users/the8472", "html_url": "https://github.com/the8472", "followers_url": "https://api.github.com/users/the8472/followers", "following_url": "https://api.github.com/users/the8472/following{/other_user}", "gists_url": "https://api.github.com/users/the8472/gists{/gist_id}", "starred_url": "https://api.github.com/users/the8472/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/the8472/subscriptions", "organizations_url": "https://api.github.com/users/the8472/orgs", "repos_url": "https://api.github.com/users/the8472/repos", "events_url": "https://api.github.com/users/the8472/events{/privacy}", "received_events_url": "https://api.github.com/users/the8472/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e5e33ebd2ba12a78dbf6e2d5f154d5f71f28576c", "url": "https://api.github.com/repos/rust-lang/rust/commits/e5e33ebd2ba12a78dbf6e2d5f154d5f71f28576c", "html_url": "https://github.com/rust-lang/rust/commit/e5e33ebd2ba12a78dbf6e2d5f154d5f71f28576c"}], "stats": {"total": 6, "additions": 4, "deletions": 2}, "files": [{"sha": "bcdc36a516e3a184a25fbb741a694684671a6041", "filename": "library/std/src/sys/unix/fs.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/1316c786a08344c965a97b1b67c76a300a479eec/library%2Fstd%2Fsrc%2Fsys%2Funix%2Ffs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1316c786a08344c965a97b1b67c76a300a479eec/library%2Fstd%2Fsrc%2Fsys%2Funix%2Ffs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Funix%2Ffs.rs?ref=1316c786a08344c965a97b1b67c76a300a479eec", "patch": "@@ -1162,7 +1162,7 @@ pub fn copy(from: &Path, to: &Path) -> io::Result<u64> {\n             };\n             if let Err(ref copy_err) = copy_result {\n                 match copy_err.raw_os_error() {\n-                    Some(libc::ENOSYS) | Some(libc::EPERM) => {\n+                    Some(libc::ENOSYS) | Some(libc::EPERM) | Some(libc::EOPNOTSUPP) => {\n                         HAS_COPY_FILE_RANGE.store(false, Ordering::Relaxed);\n                     }\n                     _ => {}\n@@ -1180,11 +1180,13 @@ pub fn copy(from: &Path, to: &Path) -> io::Result<u64> {\n                         if os_err == libc::ENOSYS\n                             || os_err == libc::EXDEV\n                             || os_err == libc::EINVAL\n-                            || os_err == libc::EPERM =>\n+                            || os_err == libc::EPERM\n+                            || os_err == libc::EOPNOTSUPP =>\n                     {\n                         // Try fallback io::copy if either:\n                         // - Kernel version is < 4.5 (ENOSYS)\n                         // - Files are mounted on different fs (EXDEV)\n+                        // - copy_file_range is broken in various ways on RHEL/CentOS 7 (EOPNOTSUPP)\n                         // - copy_file_range is disallowed, for example by seccomp (EPERM)\n                         // - copy_file_range cannot be used with pipes or device nodes (EINVAL)\n                         assert_eq!(written, 0);"}]}