{"sha": "4c658f76c1b51ced4f6c30ea37441c4141659b93", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRjNjU4Zjc2YzFiNTFjZWQ0ZjZjMzBlYTM3NDQxYzQxNDE2NTliOTM=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2018-02-12T18:46:31Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2018-02-12T18:46:31Z"}, "message": "Update compiletest's `read2` function\n\nThis was originally copied over from Cargo and Cargo has since [been\nupdated][update] so let's pull in the fixes here too!\n\n[update]: https://github.com/rust-lang/cargo/pull/5030", "tree": {"sha": "02c29e87844a8d1a5514f9015d1718fa3771e1e5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/02c29e87844a8d1a5514f9015d1718fa3771e1e5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4c658f76c1b51ced4f6c30ea37441c4141659b93", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4c658f76c1b51ced4f6c30ea37441c4141659b93", "html_url": "https://github.com/rust-lang/rust/commit/4c658f76c1b51ced4f6c30ea37441c4141659b93", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4c658f76c1b51ced4f6c30ea37441c4141659b93/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "16362c737fe740f630ada06349fa9004e2a51bb7", "url": "https://api.github.com/repos/rust-lang/rust/commits/16362c737fe740f630ada06349fa9004e2a51bb7", "html_url": "https://github.com/rust-lang/rust/commit/16362c737fe740f630ada06349fa9004e2a51bb7"}], "stats": {"total": 24, "additions": 14, "deletions": 10}, "files": [{"sha": "486c0d81e3f407d0c3424cd049f3ea21df3e025a", "filename": "src/tools/compiletest/src/read2.rs", "status": "modified", "additions": 14, "deletions": 10, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/4c658f76c1b51ced4f6c30ea37441c4141659b93/src%2Ftools%2Fcompiletest%2Fsrc%2Fread2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4c658f76c1b51ced4f6c30ea37441c4141659b93/src%2Ftools%2Fcompiletest%2Fsrc%2Fread2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fread2.rs?ref=4c658f76c1b51ced4f6c30ea37441c4141659b93", "patch": "@@ -58,9 +58,12 @@ mod imp {\n         fds[0].events = libc::POLLIN;\n         fds[1].fd = err_pipe.as_raw_fd();\n         fds[1].events = libc::POLLIN;\n-        loop {\n+        let mut nfds = 2;\n+        let mut errfd = 1;\n+\n+        while nfds > 0 {\n             // wait for either pipe to become readable using `select`\n-            let r = unsafe { libc::poll(fds.as_mut_ptr(), 2, -1) };\n+            let r = unsafe { libc::poll(fds.as_mut_ptr(), nfds, -1) };\n             if r == -1 {\n                 let err = io::Error::last_os_error();\n                 if err.kind() == io::ErrorKind::Interrupted {\n@@ -86,19 +89,20 @@ mod imp {\n                     }\n                 }\n             };\n-            if !out_done && fds[0].revents != 0 && handle(out_pipe.read_to_end(&mut out))? {\n-                out_done = true;\n-            }\n-            data(true, &mut out, out_done);\n-            if !err_done && fds[1].revents != 0 && handle(err_pipe.read_to_end(&mut err))? {\n+            if !err_done && fds[errfd].revents != 0 && handle(err_pipe.read_to_end(&mut err))? {\n                 err_done = true;\n+                nfds -= 1;\n             }\n             data(false, &mut err, err_done);\n-\n-            if out_done && err_done {\n-                return Ok(())\n+            if !out_done && fds[0].revents != 0 && handle(out_pipe.read_to_end(&mut out))? {\n+                out_done = true;\n+                fds[0].fd = err_pipe.as_raw_fd();\n+                errfd = 0;\n+                nfds -= 1;\n             }\n+            data(true, &mut out, out_done);\n         }\n+        Ok(())\n     }\n }\n "}]}