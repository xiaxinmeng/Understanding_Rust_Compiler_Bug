{"sha": "3855e039a2c095f2e54b2f389f29e200293774ac", "node_id": "C_kwDOAAsO6NoAKDM4NTVlMDM5YTJjMDk1ZjJlNTRiMmYzODlmMjllMjAwMjkzNzc0YWM", "commit": {"author": {"name": "Takayuki Maeda", "email": "takoyaki0316@gmail.com", "date": "2022-08-24T02:34:14Z"}, "committer": {"name": "Takayuki Maeda", "email": "takoyaki0316@gmail.com", "date": "2022-08-24T02:34:14Z"}, "message": "do not suggest adding a bound to a opaque type", "tree": {"sha": "18958c3dc1c0db4da4292f04d9fda00e85e8011d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/18958c3dc1c0db4da4292f04d9fda00e85e8011d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3855e039a2c095f2e54b2f389f29e200293774ac", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3855e039a2c095f2e54b2f389f29e200293774ac", "html_url": "https://github.com/rust-lang/rust/commit/3855e039a2c095f2e54b2f389f29e200293774ac", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3855e039a2c095f2e54b2f389f29e200293774ac/comments", "author": {"login": "TaKO8Ki", "id": 41065217, "node_id": "MDQ6VXNlcjQxMDY1MjE3", "avatar_url": "https://avatars.githubusercontent.com/u/41065217?v=4", "gravatar_id": "", "url": "https://api.github.com/users/TaKO8Ki", "html_url": "https://github.com/TaKO8Ki", "followers_url": "https://api.github.com/users/TaKO8Ki/followers", "following_url": "https://api.github.com/users/TaKO8Ki/following{/other_user}", "gists_url": "https://api.github.com/users/TaKO8Ki/gists{/gist_id}", "starred_url": "https://api.github.com/users/TaKO8Ki/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/TaKO8Ki/subscriptions", "organizations_url": "https://api.github.com/users/TaKO8Ki/orgs", "repos_url": "https://api.github.com/users/TaKO8Ki/repos", "events_url": "https://api.github.com/users/TaKO8Ki/events{/privacy}", "received_events_url": "https://api.github.com/users/TaKO8Ki/received_events", "type": "User", "site_admin": false}, "committer": {"login": "TaKO8Ki", "id": 41065217, "node_id": "MDQ6VXNlcjQxMDY1MjE3", "avatar_url": "https://avatars.githubusercontent.com/u/41065217?v=4", "gravatar_id": "", "url": "https://api.github.com/users/TaKO8Ki", "html_url": "https://github.com/TaKO8Ki", "followers_url": "https://api.github.com/users/TaKO8Ki/followers", "following_url": "https://api.github.com/users/TaKO8Ki/following{/other_user}", "gists_url": "https://api.github.com/users/TaKO8Ki/gists{/gist_id}", "starred_url": "https://api.github.com/users/TaKO8Ki/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/TaKO8Ki/subscriptions", "organizations_url": "https://api.github.com/users/TaKO8Ki/orgs", "repos_url": "https://api.github.com/users/TaKO8Ki/repos", "events_url": "https://api.github.com/users/TaKO8Ki/events{/privacy}", "received_events_url": "https://api.github.com/users/TaKO8Ki/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "87991d5f5d72d6baca490141cb890211ba2f3843", "url": "https://api.github.com/repos/rust-lang/rust/commits/87991d5f5d72d6baca490141cb890211ba2f3843", "html_url": "https://github.com/rust-lang/rust/commit/87991d5f5d72d6baca490141cb890211ba2f3843"}], "stats": {"total": 49, "additions": 48, "deletions": 1}, "files": [{"sha": "68f9a7c5007c87500b7486dcafbbcc831a117107", "filename": "compiler/rustc_borrowck/src/diagnostics/explain_borrow.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/3855e039a2c095f2e54b2f389f29e200293774ac/compiler%2Frustc_borrowck%2Fsrc%2Fdiagnostics%2Fexplain_borrow.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3855e039a2c095f2e54b2f389f29e200293774ac/compiler%2Frustc_borrowck%2Fsrc%2Fdiagnostics%2Fexplain_borrow.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_borrowck%2Fsrc%2Fdiagnostics%2Fexplain_borrow.rs?ref=3855e039a2c095f2e54b2f389f29e200293774ac", "patch": "@@ -273,13 +273,17 @@ impl<'tcx> BorrowExplanation<'tcx> {\n             _ => {}\n         }\n     }\n-    pub(crate) fn add_lifetime_bound_suggestion_to_diagnostic(\n+\n+    fn add_lifetime_bound_suggestion_to_diagnostic(\n         &self,\n         err: &mut Diagnostic,\n         category: &ConstraintCategory<'tcx>,\n         span: Span,\n         region_name: &RegionName,\n     ) {\n+        if !span.is_desugaring(DesugaringKind::OpaqueTy) {\n+            return;\n+        }\n         if let ConstraintCategory::OpaqueType = category {\n             let suggestable_name =\n                 if region_name.was_named() { region_name.name } else { kw::UnderscoreLifetime };"}, {"sha": "5340288051ac9cfc57377c4b029068b8f8922011", "filename": "src/test/ui/regions/do-not-suggest-adding-bound-to-opaque-type.rs", "status": "added", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/3855e039a2c095f2e54b2f389f29e200293774ac/src%2Ftest%2Fui%2Fregions%2Fdo-not-suggest-adding-bound-to-opaque-type.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3855e039a2c095f2e54b2f389f29e200293774ac/src%2Ftest%2Fui%2Fregions%2Fdo-not-suggest-adding-bound-to-opaque-type.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fregions%2Fdo-not-suggest-adding-bound-to-opaque-type.rs?ref=3855e039a2c095f2e54b2f389f29e200293774ac", "patch": "@@ -0,0 +1,29 @@\n+#![feature(allocator_api)]\n+\n+use std::{\n+    alloc::{AllocError, Allocator, Layout},\n+    ptr::NonNull,\n+};\n+\n+struct GhostBump;\n+\n+unsafe impl Allocator for &GhostBump {\n+    fn allocate(&self, layout: Layout) -> Result<NonNull<[u8]>, AllocError> {\n+        todo!()\n+    }\n+\n+    unsafe fn deallocate(&self, ptr: NonNull<u8>, layout: Layout) {\n+        todo!()\n+    }\n+}\n+\n+fn foo() -> impl Iterator<Item = usize> {\n+    let arena = GhostBump;\n+    let mut vec = Vec::new_in(&arena); //~ ERROR `arena` does not live long enough\n+    vec.push(1);\n+    vec.push(2);\n+    vec.push(3);\n+    vec.into_iter()\n+}\n+\n+fn main() {}"}, {"sha": "677b81956f9871283ebd6360ca0a0274d623ddcc", "filename": "src/test/ui/regions/do-not-suggest-adding-bound-to-opaque-type.stderr", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/3855e039a2c095f2e54b2f389f29e200293774ac/src%2Ftest%2Fui%2Fregions%2Fdo-not-suggest-adding-bound-to-opaque-type.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/3855e039a2c095f2e54b2f389f29e200293774ac/src%2Ftest%2Fui%2Fregions%2Fdo-not-suggest-adding-bound-to-opaque-type.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fregions%2Fdo-not-suggest-adding-bound-to-opaque-type.stderr?ref=3855e039a2c095f2e54b2f389f29e200293774ac", "patch": "@@ -0,0 +1,14 @@\n+error[E0597]: `arena` does not live long enough\n+  --> $DIR/do-not-suggest-adding-bound-to-opaque-type.rs:22:31\n+   |\n+LL |     let mut vec = Vec::new_in(&arena);\n+   |                               ^^^^^^ borrowed value does not live long enough\n+...\n+LL |     vec.into_iter()\n+   |     --------------- opaque type requires that `arena` is borrowed for `'static`\n+LL | }\n+   | - `arena` dropped here while still borrowed\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0597`."}]}