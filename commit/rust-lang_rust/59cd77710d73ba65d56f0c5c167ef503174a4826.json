{"sha": "59cd77710d73ba65d56f0c5c167ef503174a4826", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU5Y2Q3NzcxMGQ3M2JhNjVkNTZmMGM1YzE2N2VmNTAzMTc0YTQ4MjY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-09-17T22:25:07Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-09-17T22:25:07Z"}, "message": "Auto merge of #7657 - dswij:needless-borrow-mut, r=llogiq\n\n`needless_borrow` checks for mutable borrow\n\ncloses #7635\n\nchangelog: [`needless_borrow`] now checks for needless mutable borrow", "tree": {"sha": "0357334f5187a924978a1e7b1a8697a2f109736e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0357334f5187a924978a1e7b1a8697a2f109736e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/59cd77710d73ba65d56f0c5c167ef503174a4826", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/59cd77710d73ba65d56f0c5c167ef503174a4826", "html_url": "https://github.com/rust-lang/rust/commit/59cd77710d73ba65d56f0c5c167ef503174a4826", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/59cd77710d73ba65d56f0c5c167ef503174a4826/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ed7a82ef053de9560b64f8d72de7294d11a9fc59", "url": "https://api.github.com/repos/rust-lang/rust/commits/ed7a82ef053de9560b64f8d72de7294d11a9fc59", "html_url": "https://github.com/rust-lang/rust/commit/ed7a82ef053de9560b64f8d72de7294d11a9fc59"}, {"sha": "81d57de79106171026159399aa821830412fe8e8", "url": "https://api.github.com/repos/rust-lang/rust/commits/81d57de79106171026159399aa821830412fe8e8", "html_url": "https://github.com/rust-lang/rust/commit/81d57de79106171026159399aa821830412fe8e8"}], "stats": {"total": 74, "additions": 51, "deletions": 23}, "files": [{"sha": "1b2495d764d2a0c650f9f866a153252fa5288b5a", "filename": "clippy_lints/src/needless_borrow.rs", "status": "modified", "additions": 9, "deletions": 3, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/59cd77710d73ba65d56f0c5c167ef503174a4826/clippy_lints%2Fsrc%2Fneedless_borrow.rs", "raw_url": "https://github.com/rust-lang/rust/raw/59cd77710d73ba65d56f0c5c167ef503174a4826/clippy_lints%2Fsrc%2Fneedless_borrow.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fneedless_borrow.rs?ref=59cd77710d73ba65d56f0c5c167ef503174a4826", "patch": "@@ -104,7 +104,7 @@ impl<'tcx> LateLintPass<'tcx> for NeedlessBorrow {\n         if e.span.from_expansion() {\n             return;\n         }\n-        if let ExprKind::AddrOf(BorrowKind::Ref, Mutability::Not, inner) = e.kind {\n+        if let ExprKind::AddrOf(BorrowKind::Ref, mutability, inner) = e.kind {\n             if let ty::Ref(_, ty, _) = cx.typeck_results().expr_ty(inner).kind() {\n                 for adj3 in cx.typeck_results().expr_adjustments(e).windows(3) {\n                     if let [Adjustment {\n@@ -116,14 +116,20 @@ impl<'tcx> LateLintPass<'tcx> for NeedlessBorrow {\n                         ..\n                     }] = *adj3\n                     {\n+                        let help_msg_ty = if matches!(mutability, Mutability::Not) {\n+                            format!(\"&{}\", ty)\n+                        } else {\n+                            format!(\"&mut {}\", ty)\n+                        };\n+\n                         span_lint_and_then(\n                             cx,\n                             NEEDLESS_BORROW,\n                             e.span,\n                             &format!(\n-                                \"this expression borrows a reference (`&{}`) that is immediately dereferenced \\\n+                                \"this expression borrows a reference (`{}`) that is immediately dereferenced \\\n                              by the compiler\",\n-                                ty\n+                                help_msg_ty\n                             ),\n                             |diag| {\n                                 if let Some(snippet) = snippet_opt(cx, inner.span) {"}, {"sha": "42c2bb9f4149eb48bbf2f777e859adcc88623ee0", "filename": "tests/ui/needless_borrow.fixed", "status": "modified", "additions": 16, "deletions": 8, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/59cd77710d73ba65d56f0c5c167ef503174a4826/tests%2Fui%2Fneedless_borrow.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/59cd77710d73ba65d56f0c5c167ef503174a4826/tests%2Fui%2Fneedless_borrow.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fneedless_borrow.fixed?ref=59cd77710d73ba65d56f0c5c167ef503174a4826", "patch": "@@ -1,17 +1,16 @@\n // run-rustfix\n \n-#![allow(clippy::needless_borrowed_reference)]\n-\n-fn x(y: &i32) -> i32 {\n-    *y\n-}\n-\n #[warn(clippy::all, clippy::needless_borrow)]\n #[allow(unused_variables)]\n fn main() {\n     let a = 5;\n-    let b = x(&a);\n-    let c = x(&a);\n+    let _ = x(&a); // no warning\n+    let _ = x(&a); // warn\n+\n+    let mut b = 5;\n+    mut_ref(&mut b); // no warning\n+    mut_ref(&mut b); // warn\n+\n     let s = &String::from(\"hi\");\n     let s_ident = f(&s); // should not error, because `&String` implements Copy, but `String` does not\n     let g_val = g(&Vec::new()); // should not error, because `&Vec<T>` derefs to `&[T]`\n@@ -29,6 +28,15 @@ fn main() {\n     };\n }\n \n+#[allow(clippy::needless_borrowed_reference)]\n+fn x(y: &i32) -> i32 {\n+    *y\n+}\n+\n+fn mut_ref(y: &mut i32) {\n+    *y = 5;\n+}\n+\n fn f<T: Copy>(y: &T) -> T {\n     *y\n }"}, {"sha": "31977416bc7028738fb91c94c0a3d6dd0af4c9f9", "filename": "tests/ui/needless_borrow.rs", "status": "modified", "additions": 16, "deletions": 8, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/59cd77710d73ba65d56f0c5c167ef503174a4826/tests%2Fui%2Fneedless_borrow.rs", "raw_url": "https://github.com/rust-lang/rust/raw/59cd77710d73ba65d56f0c5c167ef503174a4826/tests%2Fui%2Fneedless_borrow.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fneedless_borrow.rs?ref=59cd77710d73ba65d56f0c5c167ef503174a4826", "patch": "@@ -1,17 +1,16 @@\n // run-rustfix\n \n-#![allow(clippy::needless_borrowed_reference)]\n-\n-fn x(y: &i32) -> i32 {\n-    *y\n-}\n-\n #[warn(clippy::all, clippy::needless_borrow)]\n #[allow(unused_variables)]\n fn main() {\n     let a = 5;\n-    let b = x(&a);\n-    let c = x(&&a);\n+    let _ = x(&a); // no warning\n+    let _ = x(&&a); // warn\n+\n+    let mut b = 5;\n+    mut_ref(&mut b); // no warning\n+    mut_ref(&mut &mut b); // warn\n+\n     let s = &String::from(\"hi\");\n     let s_ident = f(&s); // should not error, because `&String` implements Copy, but `String` does not\n     let g_val = g(&Vec::new()); // should not error, because `&Vec<T>` derefs to `&[T]`\n@@ -29,6 +28,15 @@ fn main() {\n     };\n }\n \n+#[allow(clippy::needless_borrowed_reference)]\n+fn x(y: &i32) -> i32 {\n+    *y\n+}\n+\n+fn mut_ref(y: &mut i32) {\n+    *y = 5;\n+}\n+\n fn f<T: Copy>(y: &T) -> T {\n     *y\n }"}, {"sha": "012d62e287156f850f02871bba101d930a9bbdb7", "filename": "tests/ui/needless_borrow.stderr", "status": "modified", "additions": 10, "deletions": 4, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/59cd77710d73ba65d56f0c5c167ef503174a4826/tests%2Fui%2Fneedless_borrow.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/59cd77710d73ba65d56f0c5c167ef503174a4826/tests%2Fui%2Fneedless_borrow.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fneedless_borrow.stderr?ref=59cd77710d73ba65d56f0c5c167ef503174a4826", "patch": "@@ -1,16 +1,22 @@\n error: this expression borrows a reference (`&i32`) that is immediately dereferenced by the compiler\n-  --> $DIR/needless_borrow.rs:14:15\n+  --> $DIR/needless_borrow.rs:8:15\n    |\n-LL |     let c = x(&&a);\n+LL |     let _ = x(&&a); // warn\n    |               ^^^ help: change this to: `&a`\n    |\n    = note: `-D clippy::needless-borrow` implied by `-D warnings`\n \n+error: this expression borrows a reference (`&mut i32`) that is immediately dereferenced by the compiler\n+  --> $DIR/needless_borrow.rs:12:13\n+   |\n+LL |     mut_ref(&mut &mut b); // warn\n+   |             ^^^^^^^^^^^ help: change this to: `&mut b`\n+\n error: this expression borrows a reference (`&i32`) that is immediately dereferenced by the compiler\n-  --> $DIR/needless_borrow.rs:27:15\n+  --> $DIR/needless_borrow.rs:26:15\n    |\n LL |         46 => &&a,\n    |               ^^^ help: change this to: `&a`\n \n-error: aborting due to 2 previous errors\n+error: aborting due to 3 previous errors\n "}]}