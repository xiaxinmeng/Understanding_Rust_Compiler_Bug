{"sha": "40fe064c63797f2be4cf37abdf30a324878e5929", "node_id": "C_kwDOAAsO6NoAKDQwZmUwNjRjNjM3OTdmMmJlNGNmMzdhYmRmMzBhMzI0ODc4ZTU5Mjk", "commit": {"author": {"name": "Guillaume Gomez", "email": "guillaume.gomez@huawei.com", "date": "2021-10-01T18:54:36Z"}, "committer": {"name": "Guillaume Gomez", "email": "guillaume.gomez@huawei.com", "date": "2021-10-04T18:57:05Z"}, "message": "Add a check for duplicated doc aliases in unused lint", "tree": {"sha": "36a7abb201af780e7803a8aa30ea8ec8d347cdd7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/36a7abb201af780e7803a8aa30ea8ec8d347cdd7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/40fe064c63797f2be4cf37abdf30a324878e5929", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/40fe064c63797f2be4cf37abdf30a324878e5929", "html_url": "https://github.com/rust-lang/rust/commit/40fe064c63797f2be4cf37abdf30a324878e5929", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/40fe064c63797f2be4cf37abdf30a324878e5929/comments", "author": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "committer": {"login": "GuillaumeGomez", "id": 3050060, "node_id": "MDQ6VXNlcjMwNTAwNjA=", "avatar_url": "https://avatars.githubusercontent.com/u/3050060?v=4", "gravatar_id": "", "url": "https://api.github.com/users/GuillaumeGomez", "html_url": "https://github.com/GuillaumeGomez", "followers_url": "https://api.github.com/users/GuillaumeGomez/followers", "following_url": "https://api.github.com/users/GuillaumeGomez/following{/other_user}", "gists_url": "https://api.github.com/users/GuillaumeGomez/gists{/gist_id}", "starred_url": "https://api.github.com/users/GuillaumeGomez/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/GuillaumeGomez/subscriptions", "organizations_url": "https://api.github.com/users/GuillaumeGomez/orgs", "repos_url": "https://api.github.com/users/GuillaumeGomez/repos", "events_url": "https://api.github.com/users/GuillaumeGomez/events{/privacy}", "received_events_url": "https://api.github.com/users/GuillaumeGomez/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a8387aef8c378a771686878062e544af4d5e2245", "url": "https://api.github.com/repos/rust-lang/rust/commits/a8387aef8c378a771686878062e544af4d5e2245", "html_url": "https://github.com/rust-lang/rust/commit/a8387aef8c378a771686878062e544af4d5e2245"}], "stats": {"total": 45, "additions": 38, "deletions": 7}, "files": [{"sha": "e7b2a018680ad4f39969e4cbf8a6eb989b3d6a0f", "filename": "compiler/rustc_passes/src/check_attr.rs", "status": "modified", "additions": 36, "deletions": 6, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/40fe064c63797f2be4cf37abdf30a324878e5929/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/40fe064c63797f2be4cf37abdf30a324878e5929/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs?ref=40fe064c63797f2be4cf37abdf30a324878e5929", "patch": "@@ -9,7 +9,7 @@ use rustc_middle::ty::query::Providers;\n use rustc_middle::ty::TyCtxt;\n \n use rustc_ast::{ast, AttrStyle, Attribute, Lit, LitKind, NestedMetaItem};\n-use rustc_data_structures::stable_set::FxHashSet;\n+use rustc_data_structures::fx::{FxHashMap, FxHashSet};\n use rustc_errors::{pluralize, struct_span_err, Applicability};\n use rustc_feature::{AttributeType, BUILTIN_ATTRIBUTE_MAP};\n use rustc_hir as hir;\n@@ -66,6 +66,7 @@ impl CheckAttrVisitor<'tcx> {\n         target: Target,\n         item: Option<ItemLike<'_>>,\n     ) {\n+        let mut doc_aliases = FxHashMap::default();\n         let mut is_valid = true;\n         let mut specified_inline = None;\n         let mut seen = FxHashSet::default();\n@@ -79,7 +80,13 @@ impl CheckAttrVisitor<'tcx> {\n                 sym::track_caller => {\n                     self.check_track_caller(hir_id, &attr.span, attrs, span, target)\n                 }\n-                sym::doc => self.check_doc_attrs(attr, hir_id, target, &mut specified_inline),\n+                sym::doc => self.check_doc_attrs(\n+                    attr,\n+                    hir_id,\n+                    target,\n+                    &mut specified_inline,\n+                    &mut doc_aliases,\n+                ),\n                 sym::no_link => self.check_no_link(hir_id, &attr, span, target),\n                 sym::export_name => self.check_export_name(hir_id, &attr, span, target),\n                 sym::rustc_layout_scalar_valid_range_start\n@@ -512,6 +519,7 @@ impl CheckAttrVisitor<'tcx> {\n         hir_id: HirId,\n         target: Target,\n         is_list: bool,\n+        aliases: &mut FxHashMap<String, Span>,\n     ) -> bool {\n         let tcx = self.tcx;\n         let err_fn = move |span: Span, msg: &str| {\n@@ -582,17 +590,38 @@ impl CheckAttrVisitor<'tcx> {\n         if &*item_name.as_str() == doc_alias {\n             return err_fn(meta.span(), \"is the same as the item's name\");\n         }\n+        let span = meta.span();\n+        if let Err(entry) = aliases.try_insert(doc_alias.to_owned(), span) {\n+            self.tcx.struct_span_lint_hir(UNUSED_ATTRIBUTES, hir_id, span, |lint| {\n+                lint.build(\"doc alias is duplicated\")\n+                    .span_label(*entry.entry.get(), \"first defined here\")\n+                    .emit();\n+            });\n+        }\n         true\n     }\n \n-    fn check_doc_alias(&self, meta: &NestedMetaItem, hir_id: HirId, target: Target) -> bool {\n+    fn check_doc_alias(\n+        &self,\n+        meta: &NestedMetaItem,\n+        hir_id: HirId,\n+        target: Target,\n+        aliases: &mut FxHashMap<String, Span>,\n+    ) -> bool {\n         if let Some(values) = meta.meta_item_list() {\n             let mut errors = 0;\n             for v in values {\n                 match v.literal() {\n                     Some(l) => match l.kind {\n                         LitKind::Str(s, _) => {\n-                            if !self.check_doc_alias_value(v, &s.as_str(), hir_id, target, true) {\n+                            if !self.check_doc_alias_value(\n+                                v,\n+                                &s.as_str(),\n+                                hir_id,\n+                                target,\n+                                true,\n+                                aliases,\n+                            ) {\n                                 errors += 1;\n                             }\n                         }\n@@ -621,7 +650,7 @@ impl CheckAttrVisitor<'tcx> {\n             }\n             errors == 0\n         } else if let Some(doc_alias) = meta.value_str().map(|s| s.to_string()) {\n-            self.check_doc_alias_value(meta, &doc_alias, hir_id, target, false)\n+            self.check_doc_alias_value(meta, &doc_alias, hir_id, target, false, aliases)\n         } else {\n             self.tcx\n                 .sess\n@@ -858,6 +887,7 @@ impl CheckAttrVisitor<'tcx> {\n         hir_id: HirId,\n         target: Target,\n         specified_inline: &mut Option<(bool, Span)>,\n+        aliases: &mut FxHashMap<String, Span>,\n     ) -> bool {\n         let mut is_valid = true;\n \n@@ -867,7 +897,7 @@ impl CheckAttrVisitor<'tcx> {\n                     match i_meta.name_or_empty() {\n                         sym::alias\n                             if !self.check_attr_not_crate_level(&meta, hir_id, \"alias\")\n-                                || !self.check_doc_alias(&meta, hir_id, target) =>\n+                                || !self.check_doc_alias(&meta, hir_id, target, aliases) =>\n                         {\n                             is_valid = false\n                         }"}, {"sha": "4adec3c4f608d78e93c412ccb6a5476a370fad7d", "filename": "compiler/rustc_passes/src/lib.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/40fe064c63797f2be4cf37abdf30a324878e5929/compiler%2Frustc_passes%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/40fe064c63797f2be4cf37abdf30a324878e5929/compiler%2Frustc_passes%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Flib.rs?ref=40fe064c63797f2be4cf37abdf30a324878e5929", "patch": "@@ -9,8 +9,9 @@\n #![feature(in_band_lifetimes)]\n #![feature(format_args_capture)]\n #![feature(iter_zip)]\n-#![feature(nll)]\n+#![feature(map_try_insert)]\n #![feature(min_specialization)]\n+#![feature(nll)]\n #![feature(try_blocks)]\n #![recursion_limit = \"256\"]\n "}]}