{"sha": "48b10feedbee5b8554fa82696ce5e836933f189c", "node_id": "C_kwDOAAsO6NoAKDQ4YjEwZmVlZGJlZTViODU1NGZhODI2OTZjZTVlODM2OTMzZjE4OWM", "commit": {"author": {"name": "Nicholas Nethercote", "email": "n.nethercote@gmail.com", "date": "2022-11-18T00:24:21Z"}, "committer": {"name": "Nicholas Nethercote", "email": "n.nethercote@gmail.com", "date": "2022-11-21T22:04:15Z"}, "message": "Split `MacArgs` in two.\n\n`MacArgs` is an enum with three variants: `Empty`, `Delimited`, and `Eq`. It's\nused in two ways:\n- For representing attribute macro arguments (e.g. in `AttrItem`), where all\n  three variants are used.\n- For representing function-like macros (e.g. in `MacCall` and `MacroDef`),\n  where only the `Delimited` variant is used.\n\nIn other words, `MacArgs` is used in two quite different places due to them\nhaving partial overlap. I find this makes the code hard to read. It also leads\nto various unreachable code paths, and allows invalid values (such as\naccidentally using `MacArgs::Empty` in a `MacCall`).\n\nThis commit splits `MacArgs` in two:\n- `DelimArgs` is a new struct just for the \"delimited arguments\" case. It is\n  now used in `MacCall` and `MacroDef`.\n- `AttrArgs` is a renaming of the old `MacArgs` enum for the attribute macro\n  case. Its `Delimited` variant now contains a `DelimArgs`.\n\nVarious other related things are renamed as well.\n\nThese changes make the code clearer, avoids several unreachable paths, and\ndisallows the invalid values.", "tree": {"sha": "1725950f074be34d7a03cc7d4af8f321eff97df0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1725950f074be34d7a03cc7d4af8f321eff97df0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/48b10feedbee5b8554fa82696ce5e836933f189c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/48b10feedbee5b8554fa82696ce5e836933f189c", "html_url": "https://github.com/rust-lang/rust/commit/48b10feedbee5b8554fa82696ce5e836933f189c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/48b10feedbee5b8554fa82696ce5e836933f189c/comments", "author": {"login": "nnethercote", "id": 1940286, "node_id": "MDQ6VXNlcjE5NDAyODY=", "avatar_url": "https://avatars.githubusercontent.com/u/1940286?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nnethercote", "html_url": "https://github.com/nnethercote", "followers_url": "https://api.github.com/users/nnethercote/followers", "following_url": "https://api.github.com/users/nnethercote/following{/other_user}", "gists_url": "https://api.github.com/users/nnethercote/gists{/gist_id}", "starred_url": "https://api.github.com/users/nnethercote/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nnethercote/subscriptions", "organizations_url": "https://api.github.com/users/nnethercote/orgs", "repos_url": "https://api.github.com/users/nnethercote/repos", "events_url": "https://api.github.com/users/nnethercote/events{/privacy}", "received_events_url": "https://api.github.com/users/nnethercote/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nnethercote", "id": 1940286, "node_id": "MDQ6VXNlcjE5NDAyODY=", "avatar_url": "https://avatars.githubusercontent.com/u/1940286?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nnethercote", "html_url": "https://github.com/nnethercote", "followers_url": "https://api.github.com/users/nnethercote/followers", "following_url": "https://api.github.com/users/nnethercote/following{/other_user}", "gists_url": "https://api.github.com/users/nnethercote/gists{/gist_id}", "starred_url": "https://api.github.com/users/nnethercote/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nnethercote/subscriptions", "organizations_url": "https://api.github.com/users/nnethercote/orgs", "repos_url": "https://api.github.com/users/nnethercote/repos", "events_url": "https://api.github.com/users/nnethercote/events{/privacy}", "received_events_url": "https://api.github.com/users/nnethercote/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3597ed5a099488aa77caf444106a0550b7e5d2e8", "url": "https://api.github.com/repos/rust-lang/rust/commits/3597ed5a099488aa77caf444106a0550b7e5d2e8", "html_url": "https://github.com/rust-lang/rust/commit/3597ed5a099488aa77caf444106a0550b7e5d2e8"}], "stats": {"total": 22, "additions": 13, "deletions": 9}, "files": [{"sha": "b2fe0386f945dd82f8531f7643a6e5c06869f75f", "filename": "clippy_lints/src/crate_in_macro_def.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/48b10feedbee5b8554fa82696ce5e836933f189c/clippy_lints%2Fsrc%2Fcrate_in_macro_def.rs", "raw_url": "https://github.com/rust-lang/rust/raw/48b10feedbee5b8554fa82696ce5e836933f189c/clippy_lints%2Fsrc%2Fcrate_in_macro_def.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fcrate_in_macro_def.rs?ref=48b10feedbee5b8554fa82696ce5e836933f189c", "patch": "@@ -55,7 +55,7 @@ impl EarlyLintPass for CrateInMacroDef {\n         if_chain! {\n             if item.attrs.iter().any(is_macro_export);\n             if let ItemKind::MacroDef(macro_def) = &item.kind;\n-            let tts = macro_def.body.inner_tokens();\n+            let tts = macro_def.body.tokens.clone();\n             if let Some(span) = contains_unhygienic_crate_reference(&tts);\n             then {\n                 span_lint_and_sugg("}, {"sha": "87b378bfd1982517ad2d9e53b600c71ff1e5ff14", "filename": "clippy_utils/src/ast_utils.rs", "status": "modified", "additions": 12, "deletions": 8, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/48b10feedbee5b8554fa82696ce5e836933f189c/clippy_utils%2Fsrc%2Fast_utils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/48b10feedbee5b8554fa82696ce5e836933f189c/clippy_utils%2Fsrc%2Fast_utils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_utils%2Fsrc%2Fast_utils.rs?ref=48b10feedbee5b8554fa82696ce5e836933f189c", "patch": "@@ -388,7 +388,7 @@ pub fn eq_item_kind(l: &ItemKind, r: &ItemKind) -> bool {\n                 && over(li, ri, |l, r| eq_item(l, r, eq_assoc_item_kind))\n         },\n         (MacCall(l), MacCall(r)) => eq_mac_call(l, r),\n-        (MacroDef(l), MacroDef(r)) => l.macro_rules == r.macro_rules && eq_mac_args(&l.body, &r.body),\n+        (MacroDef(l), MacroDef(r)) => l.macro_rules == r.macro_rules && eq_delim_args(&l.body, &r.body),\n         _ => false,\n     }\n }\n@@ -709,26 +709,30 @@ pub fn eq_assoc_constraint(l: &AssocConstraint, r: &AssocConstraint) -> bool {\n }\n \n pub fn eq_mac_call(l: &MacCall, r: &MacCall) -> bool {\n-    eq_path(&l.path, &r.path) && eq_mac_args(&l.args, &r.args)\n+    eq_path(&l.path, &r.path) && eq_delim_args(&l.args, &r.args)\n }\n \n pub fn eq_attr(l: &Attribute, r: &Attribute) -> bool {\n     use AttrKind::*;\n     l.style == r.style\n         && match (&l.kind, &r.kind) {\n             (DocComment(l1, l2), DocComment(r1, r2)) => l1 == r1 && l2 == r2,\n-            (Normal(l), Normal(r)) => eq_path(&l.item.path, &r.item.path) && eq_mac_args(&l.item.args, &r.item.args),\n+            (Normal(l), Normal(r)) => eq_path(&l.item.path, &r.item.path) && eq_attr_args(&l.item.args, &r.item.args),\n             _ => false,\n         }\n }\n \n-pub fn eq_mac_args(l: &MacArgs, r: &MacArgs) -> bool {\n-    use MacArgs::*;\n+pub fn eq_attr_args(l: &AttrArgs, r: &AttrArgs) -> bool {\n+    use AttrArgs::*;\n     match (l, r) {\n         (Empty, Empty) => true,\n-        (Delimited(_, ld, lts), Delimited(_, rd, rts)) => ld == rd && lts.eq_unspanned(rts),\n-        (Eq(_, MacArgsEq::Ast(le)), Eq(_, MacArgsEq::Ast(re))) => eq_expr(le, re),\n-        (Eq(_, MacArgsEq::Hir(ll)), Eq(_, MacArgsEq::Hir(rl))) => ll.kind == rl.kind,\n+        (Delimited(la), Delimited(ra)) => eq_delim_args(la, ra),\n+        (Eq(_, AttrArgsEq::Ast(le)), Eq(_, AttrArgsEq::Ast(re))) => eq_expr(le, re),\n+        (Eq(_, AttrArgsEq::Hir(ll)), Eq(_, AttrArgsEq::Hir(rl))) => ll.kind == rl.kind,\n         _ => false,\n     }\n }\n+\n+pub fn eq_delim_args(l: &DelimArgs, r: &DelimArgs) -> bool {\n+    l.delim == r.delim && l.tokens.eq_unspanned(&r.tokens)\n+}"}]}