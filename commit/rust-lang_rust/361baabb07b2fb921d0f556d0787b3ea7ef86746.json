{"sha": "361baabb07b2fb921d0f556d0787b3ea7ef86746", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM2MWJhYWJiMDdiMmZiOTIxZDBmNTU2ZDA3ODdiM2VhN2VmODY3NDY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-12-05T00:22:58Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-12-05T00:22:58Z"}, "message": "auto merge of #19303 : nodakai/rust/libsyntax-reject-dirs, r=alexcrichton\n\nOn *BSD systems, we can `open(2)` a directory and directly `read(2)` from it due to an old tradition.  We should avoid doing so by explicitly calling `fstat(2)` to check the type of the opened file.\r\n\r\nOpening a directory as a module file can't always be avoided.  Even when there's no \"path\" attribute trick involved, there can always be a *directory* named `my_module.rs`.\r\n\r\nIncidentally, remove unnecessary mutability of `&self` from `io::fs::File::stat()`.", "tree": {"sha": "bc61837ee47ed0611090b199b69e43a89e5c5c7b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bc61837ee47ed0611090b199b69e43a89e5c5c7b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/361baabb07b2fb921d0f556d0787b3ea7ef86746", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/361baabb07b2fb921d0f556d0787b3ea7ef86746", "html_url": "https://github.com/rust-lang/rust/commit/361baabb07b2fb921d0f556d0787b3ea7ef86746", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/361baabb07b2fb921d0f556d0787b3ea7ef86746/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d9c7c00b9a3d80fc81fbbb77a9f21e5f71a1d213", "url": "https://api.github.com/repos/rust-lang/rust/commits/d9c7c00b9a3d80fc81fbbb77a9f21e5f71a1d213", "html_url": "https://github.com/rust-lang/rust/commit/d9c7c00b9a3d80fc81fbbb77a9f21e5f71a1d213"}, {"sha": "3980cdecd073789fb5ff7256e2ca40685a289b01", "url": "https://api.github.com/repos/rust-lang/rust/commits/3980cdecd073789fb5ff7256e2ca40685a289b01", "html_url": "https://github.com/rust-lang/rust/commit/3980cdecd073789fb5ff7256e2ca40685a289b01"}], "stats": {"total": 38, "additions": 25, "deletions": 13}, "files": [{"sha": "e52c00f8247a81a71257410c913cab354937fbbf", "filename": "src/libstd/io/fs.rs", "status": "modified", "additions": 23, "deletions": 9, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/361baabb07b2fb921d0f556d0787b3ea7ef86746/src%2Flibstd%2Fio%2Ffs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/361baabb07b2fb921d0f556d0787b3ea7ef86746/src%2Flibstd%2Fio%2Ffs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fio%2Ffs.rs?ref=361baabb07b2fb921d0f556d0787b3ea7ef86746", "patch": "@@ -53,7 +53,8 @@\n use clone::Clone;\n use io::standard_error;\n use io::{FilePermission, Write, Open, FileAccess, FileMode, FileType};\n-use io::{IoResult, IoError, FileStat, SeekStyle, Seek, Writer, Reader};\n+use io::{IoResult, IoError, InvalidInput};\n+use io::{FileStat, SeekStyle, Seek, Writer, Reader};\n use io::{Read, Truncate, ReadWrite, Append};\n use io::UpdateIoError;\n use io;\n@@ -134,13 +135,26 @@ impl File {\n     pub fn open_mode(path: &Path,\n                      mode: FileMode,\n                      access: FileAccess) -> IoResult<File> {\n-        fs_imp::open(path, mode, access).map(|fd| {\n-            File {\n-                path: path.clone(),\n-                fd: fd,\n-                last_nread: -1\n+        fs_imp::open(path, mode, access).and_then(|fd| {\n+            // On *BSD systems, we can open a directory as a file and read from it:\n+            // fd=open(\"/tmp\", O_RDONLY); read(fd, buf, N);\n+            // due to an old tradition before the introduction of opendir(3).\n+            // We explicitly reject it because there are few use cases.\n+            if cfg!(not(any(windows, target_os = \"linux\", target_os = \"android\"))) &&\n+               try!(fd.fstat()).kind == FileType::Directory {\n+                Err(IoError {\n+                    kind: InvalidInput,\n+                    desc: \"is a directory\",\n+                    detail: None\n+                })\n+            } else {\n+                Ok(File {\n+                    path: path.clone(),\n+                    fd: fd,\n+                    last_nread: -1\n+                })\n             }\n-        }).update_err(\"couldn't open file\", |e| {\n+        }).update_err(\"couldn't open path as file\", |e| {\n             format!(\"{}; path={}; mode={}; access={}\", e, path.display(),\n                 mode_string(mode), access_string(access))\n         })\n@@ -237,7 +251,7 @@ impl File {\n     }\n \n     /// Queries information about the underlying file.\n-    pub fn stat(&mut self) -> IoResult<FileStat> {\n+    pub fn stat(&self) -> IoResult<FileStat> {\n         self.fd.fstat()\n             .update_err(\"couldn't fstat file\", |e|\n                 format!(\"{}; path={}\", e, self.path.display()))\n@@ -886,7 +900,7 @@ mod test {\n         let filename = &tmpdir.join(\"file_that_does_not_exist.txt\");\n         let result = File::open_mode(filename, Open, Read);\n \n-        error!(result, \"couldn't open file\");\n+        error!(result, \"couldn't open path as file\");\n         if cfg!(unix) {\n             error!(result, \"no such file or directory\");\n         }"}, {"sha": "9402c63dcf558b6a3c001a28297d40c7edc76596", "filename": "src/libstd/sys/windows/fs.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/361baabb07b2fb921d0f556d0787b3ea7ef86746/src%2Flibstd%2Fsys%2Fwindows%2Ffs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/361baabb07b2fb921d0f556d0787b3ea7ef86746/src%2Flibstd%2Fsys%2Fwindows%2Ffs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Fwindows%2Ffs.rs?ref=361baabb07b2fb921d0f556d0787b3ea7ef86746", "patch": "@@ -131,7 +131,7 @@ impl FileDesc {\n         return ret;\n     }\n \n-    pub fn fstat(&mut self) -> IoResult<io::FileStat> {\n+    pub fn fstat(&self) -> IoResult<io::FileStat> {\n         let mut stat: libc::stat = unsafe { mem::zeroed() };\n         match unsafe { libc::fstat(self.fd(), &mut stat) } {\n             0 => Ok(mkstat(&stat)),"}, {"sha": "597366a1b35dfc8b8ad13d393f1132b56d727828", "filename": "src/test/compile-fail/issue-5806.rs", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/361baabb07b2fb921d0f556d0787b3ea7ef86746/src%2Ftest%2Fcompile-fail%2Fissue-5806.rs", "raw_url": "https://github.com/rust-lang/rust/raw/361baabb07b2fb921d0f556d0787b3ea7ef86746/src%2Ftest%2Fcompile-fail%2Fissue-5806.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fissue-5806.rs?ref=361baabb07b2fb921d0f556d0787b3ea7ef86746", "patch": "@@ -18,9 +18,7 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n-// ignore-freebsd FIXME #12460\n-\n #[path = \"../compile-fail\"]\n-mod foo; //~ ERROR: illegal operation on a directory\n+mod foo; //~ ERROR: a directory\n \n fn main() {}"}]}