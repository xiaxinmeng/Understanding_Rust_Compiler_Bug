{"sha": "6b2da4e5474ec064e44b7cf19523de1bab72ba27", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZiMmRhNGU1NDc0ZWMwNjRlNDRiN2NmMTk1MjNkZTFiYWI3MmJhMjc=", "commit": {"author": {"name": "Bernardo", "email": "berublan@gmail.com", "date": "2018-12-23T14:49:14Z"}, "committer": {"name": "Bernardo", "email": "berublan@gmail.com", "date": "2018-12-25T19:06:49Z"}, "message": "use new translate_offset_with_edit for TryConvWith\ndoc comments", "tree": {"sha": "2e9e353843eb08fb5b792bf674e52a747409a139", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2e9e353843eb08fb5b792bf674e52a747409a139"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6b2da4e5474ec064e44b7cf19523de1bab72ba27", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6b2da4e5474ec064e44b7cf19523de1bab72ba27", "html_url": "https://github.com/rust-lang/rust/commit/6b2da4e5474ec064e44b7cf19523de1bab72ba27", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6b2da4e5474ec064e44b7cf19523de1bab72ba27/comments", "author": {"login": "vemoo", "id": 4866051, "node_id": "MDQ6VXNlcjQ4NjYwNTE=", "avatar_url": "https://avatars.githubusercontent.com/u/4866051?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vemoo", "html_url": "https://github.com/vemoo", "followers_url": "https://api.github.com/users/vemoo/followers", "following_url": "https://api.github.com/users/vemoo/following{/other_user}", "gists_url": "https://api.github.com/users/vemoo/gists{/gist_id}", "starred_url": "https://api.github.com/users/vemoo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vemoo/subscriptions", "organizations_url": "https://api.github.com/users/vemoo/orgs", "repos_url": "https://api.github.com/users/vemoo/repos", "events_url": "https://api.github.com/users/vemoo/events{/privacy}", "received_events_url": "https://api.github.com/users/vemoo/received_events", "type": "User", "site_admin": false}, "committer": {"login": "vemoo", "id": 4866051, "node_id": "MDQ6VXNlcjQ4NjYwNTE=", "avatar_url": "https://avatars.githubusercontent.com/u/4866051?v=4", "gravatar_id": "", "url": "https://api.github.com/users/vemoo", "html_url": "https://github.com/vemoo", "followers_url": "https://api.github.com/users/vemoo/followers", "following_url": "https://api.github.com/users/vemoo/following{/other_user}", "gists_url": "https://api.github.com/users/vemoo/gists{/gist_id}", "starred_url": "https://api.github.com/users/vemoo/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/vemoo/subscriptions", "organizations_url": "https://api.github.com/users/vemoo/orgs", "repos_url": "https://api.github.com/users/vemoo/repos", "events_url": "https://api.github.com/users/vemoo/events{/privacy}", "received_events_url": "https://api.github.com/users/vemoo/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "aff0124b37e34910190498ad519deb1aea0d8451", "url": "https://api.github.com/repos/rust-lang/rust/commits/aff0124b37e34910190498ad519deb1aea0d8451", "html_url": "https://github.com/rust-lang/rust/commit/aff0124b37e34910190498ad519deb1aea0d8451"}], "stats": {"total": 42, "additions": 5, "deletions": 37}, "files": [{"sha": "2e3635ea0eac100e3be43a6f1e185af2dc7666c2", "filename": "crates/ra_editor/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/6b2da4e5474ec064e44b7cf19523de1bab72ba27/crates%2Fra_editor%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6b2da4e5474ec064e44b7cf19523de1bab72ba27/crates%2Fra_editor%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_editor%2Fsrc%2Flib.rs?ref=6b2da4e5474ec064e44b7cf19523de1bab72ba27", "patch": "@@ -14,6 +14,7 @@ pub use self::{\n     extend_selection::extend_selection,\n     folding_ranges::{folding_ranges, Fold, FoldKind},\n     line_index::{LineCol, LineIndex},\n+    line_index_utils::translate_offset_with_edit,\n     symbols::{file_structure, file_symbols, FileSymbol, StructureNode},\n     typing::{join_lines, on_enter, on_eq_typed},\n };"}, {"sha": "ba3ac8aebd5989d1dc72348cf47772a1aec9508a", "filename": "crates/ra_editor/src/line_index_utils.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/6b2da4e5474ec064e44b7cf19523de1bab72ba27/crates%2Fra_editor%2Fsrc%2Fline_index_utils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6b2da4e5474ec064e44b7cf19523de1bab72ba27/crates%2Fra_editor%2Fsrc%2Fline_index_utils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_editor%2Fsrc%2Fline_index_utils.rs?ref=6b2da4e5474ec064e44b7cf19523de1bab72ba27", "patch": "@@ -1,6 +1,6 @@\n use ra_text_edit::AtomTextEdit;\n use ra_syntax::{TextUnit, TextRange};\n-use crate::{LineIndex, LineCol, line_index::Utf16Char, line_index};\n+use crate::{LineIndex, LineCol, line_index::{self, Utf16Char}};\n use superslice::Ext;\n \n #[derive(Debug, Clone)]"}, {"sha": "63827aeea0c2f8ac72e226a5544425e666e8594b", "filename": "crates/ra_lsp_server/src/conv.rs", "status": "modified", "additions": 1, "deletions": 36, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/6b2da4e5474ec064e44b7cf19523de1bab72ba27/crates%2Fra_lsp_server%2Fsrc%2Fconv.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6b2da4e5474ec064e44b7cf19523de1bab72ba27/crates%2Fra_lsp_server%2Fsrc%2Fconv.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Fsrc%2Fconv.rs?ref=6b2da4e5474ec064e44b7cf19523de1bab72ba27", "patch": "@@ -3,7 +3,7 @@ use languageserver_types::{\n     TextDocumentItem, TextDocumentPositionParams, Url, VersionedTextDocumentIdentifier, InsertTextFormat,\n };\n use ra_analysis::{FileId, FileSystemEdit, SourceChange, SourceFileEdit, FilePosition, CompletionItem, CompletionItemKind, InsertText};\n-use ra_editor::{LineCol, LineIndex};\n+use ra_editor::{LineCol, LineIndex, translate_offset_with_edit};\n use ra_text_edit::{AtomTextEdit, TextEdit};\n use ra_syntax::{SyntaxKind, TextRange, TextUnit};\n \n@@ -261,41 +261,6 @@ impl TryConvWith for SourceChange {\n     }\n }\n \n-// HACK: we should translate offset to line/column using linde_index *with edits applied*.\n-// A naive version of this function would be to apply `edits` to the original text,\n-// construct a new line index and use that, but it would be slow.\n-//\n-// Writing fast & correct version is issue #105, let's use a quick hack in the meantime\n-fn translate_offset_with_edit(\n-    pre_edit_index: &LineIndex,\n-    offset: TextUnit,\n-    edits: &[AtomTextEdit],\n-) -> LineCol {\n-    let fallback = pre_edit_index.line_col(offset);\n-    let edit = match edits.first() {\n-        None => return fallback,\n-        Some(edit) => edit,\n-    };\n-    let end_offset = edit.delete.start() + TextUnit::of_str(&edit.insert);\n-    if !(edit.delete.start() <= offset && offset <= end_offset) {\n-        return fallback;\n-    }\n-    let rel_offset = offset - edit.delete.start();\n-    let in_edit_line_col = LineIndex::new(&edit.insert).line_col(rel_offset);\n-    let edit_line_col = pre_edit_index.line_col(edit.delete.start());\n-    if in_edit_line_col.line == 0 {\n-        LineCol {\n-            line: edit_line_col.line,\n-            col_utf16: edit_line_col.col_utf16 + in_edit_line_col.col_utf16,\n-        }\n-    } else {\n-        LineCol {\n-            line: edit_line_col.line + in_edit_line_col.line,\n-            col_utf16: in_edit_line_col.col_utf16,\n-        }\n-    }\n-}\n-\n impl TryConvWith for SourceFileEdit {\n     type Ctx = ServerWorld;\n     type Output = TextDocumentEdit;"}, {"sha": "8acf10448494cbb66a6efe946e2c553790b047eb", "filename": "crates/ra_text_edit/src/lib.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/6b2da4e5474ec064e44b7cf19523de1bab72ba27/crates%2Fra_text_edit%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6b2da4e5474ec064e44b7cf19523de1bab72ba27/crates%2Fra_text_edit%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_text_edit%2Fsrc%2Flib.rs?ref=6b2da4e5474ec064e44b7cf19523de1bab72ba27", "patch": "@@ -6,8 +6,10 @@ pub use crate::text_edit::{TextEdit, TextEditBuilder};\n \n use text_unit::{TextRange, TextUnit};\n \n+/// Must not overlap with other `AtomTextEdit`s\n #[derive(Debug, Clone)]\n pub struct AtomTextEdit {\n+    /// Refers to offsets in the original text\n     pub delete: TextRange,\n     pub insert: String,\n }"}]}