{"sha": "749b487be49b793dd713c429042b33262208f4f9", "node_id": "C_kwDOAAsO6NoAKDc0OWI0ODdiZTQ5Yjc5M2RkNzEzYzQyOTA0MmIzMzI2MjIwOGY0Zjk", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-04-10T04:36:38Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-04-10T04:36:38Z"}, "message": "Auto merge of #109880 - ehuss:fix-macos-installer-rust-docs, r=Mark-Simulacrum\n\nFix macOS and Windows installers when rust-docs is not available.\n\nThis fixes the macOS `.pkg` and Windows `.msi` installers to work when rust-docs is not available. If the rust-docs component is not built, then the installer would fail. This adds the rust-docs component to the filtering mechanism so that the rust-docs line of the distribution definition aren't included.\n\nI tested installing and uninstalling both with and without the rust-docs component available.\n\nThis happens on the aarch64-apple-darwin distribution provided by rust-lang since we currently disable the rust-docs component due to long build times. An alternate solution would be to just enable the rust-docs component on aarch64-apple-darwin since there are faster build systems.\n\nFixes #109877", "tree": {"sha": "2ee60a6b6651e14ce1934c7dfc73b599453c6840", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2ee60a6b6651e14ce1934c7dfc73b599453c6840"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/749b487be49b793dd713c429042b33262208f4f9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/749b487be49b793dd713c429042b33262208f4f9", "html_url": "https://github.com/rust-lang/rust/commit/749b487be49b793dd713c429042b33262208f4f9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/749b487be49b793dd713c429042b33262208f4f9/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3c2e2dd5c516acc60ababd12e5dba684d71c2315", "url": "https://api.github.com/repos/rust-lang/rust/commits/3c2e2dd5c516acc60ababd12e5dba684d71c2315", "html_url": "https://github.com/rust-lang/rust/commit/3c2e2dd5c516acc60ababd12e5dba684d71c2315"}, {"sha": "6b57a344cba18b18178cdcf609d68880f33cc6eb", "url": "https://api.github.com/repos/rust-lang/rust/commits/6b57a344cba18b18178cdcf609d68880f33cc6eb", "html_url": "https://github.com/rust-lang/rust/commit/6b57a344cba18b18178cdcf609d68880f33cc6eb"}], "stats": {"total": 65, "additions": 42, "deletions": 23}, "files": [{"sha": "8ce220c86478145cb229e71da91702d77d68556d", "filename": "src/bootstrap/dist.rs", "status": "modified", "additions": 30, "deletions": 23, "changes": 53, "blob_url": "https://github.com/rust-lang/rust/blob/749b487be49b793dd713c429042b33262208f4f9/src%2Fbootstrap%2Fdist.rs", "raw_url": "https://github.com/rust-lang/rust/raw/749b487be49b793dd713c429042b33262208f4f9/src%2Fbootstrap%2Fdist.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fdist.rs?ref=749b487be49b793dd713c429042b33262208f4f9", "patch": "@@ -1488,7 +1488,7 @@ impl Step for Extended {\n \n         let xform = |p: &Path| {\n             let mut contents = t!(fs::read_to_string(p));\n-            for tool in &[\"rust-demangler\", \"miri\"] {\n+            for tool in &[\"rust-demangler\", \"miri\", \"rust-docs\"] {\n                 if !built_tools.contains(tool) {\n                     contents = filter(&contents, tool);\n                 }\n@@ -1585,11 +1585,10 @@ impl Step for Extended {\n             prepare(\"rustc\");\n             prepare(\"cargo\");\n             prepare(\"rust-analysis\");\n-            prepare(\"rust-docs\");\n             prepare(\"rust-std\");\n             prepare(\"clippy\");\n             prepare(\"rust-analyzer\");\n-            for tool in &[\"rust-demangler\", \"miri\"] {\n+            for tool in &[\"rust-docs\", \"rust-demangler\", \"miri\"] {\n                 if built_tools.contains(tool) {\n                     prepare(tool);\n                 }\n@@ -1624,23 +1623,25 @@ impl Step for Extended {\n                     .arg(\"-out\")\n                     .arg(exe.join(\"RustcGroup.wxs\")),\n             );\n-            builder.run(\n-                Command::new(&heat)\n-                    .current_dir(&exe)\n-                    .arg(\"dir\")\n-                    .arg(\"rust-docs\")\n-                    .args(&heat_flags)\n-                    .arg(\"-cg\")\n-                    .arg(\"DocsGroup\")\n-                    .arg(\"-dr\")\n-                    .arg(\"Docs\")\n-                    .arg(\"-var\")\n-                    .arg(\"var.DocsDir\")\n-                    .arg(\"-out\")\n-                    .arg(exe.join(\"DocsGroup.wxs\"))\n-                    .arg(\"-t\")\n-                    .arg(etc.join(\"msi/squash-components.xsl\")),\n-            );\n+            if built_tools.contains(\"rust-docs\") {\n+                builder.run(\n+                    Command::new(&heat)\n+                        .current_dir(&exe)\n+                        .arg(\"dir\")\n+                        .arg(\"rust-docs\")\n+                        .args(&heat_flags)\n+                        .arg(\"-cg\")\n+                        .arg(\"DocsGroup\")\n+                        .arg(\"-dr\")\n+                        .arg(\"Docs\")\n+                        .arg(\"-var\")\n+                        .arg(\"var.DocsDir\")\n+                        .arg(\"-out\")\n+                        .arg(exe.join(\"DocsGroup.wxs\"))\n+                        .arg(\"-t\")\n+                        .arg(etc.join(\"msi/squash-components.xsl\")),\n+                );\n+            }\n             builder.run(\n                 Command::new(&heat)\n                     .current_dir(&exe)\n@@ -1787,7 +1788,6 @@ impl Step for Extended {\n                 cmd.current_dir(&exe)\n                     .arg(\"-nologo\")\n                     .arg(\"-dRustcDir=rustc\")\n-                    .arg(\"-dDocsDir=rust-docs\")\n                     .arg(\"-dCargoDir=cargo\")\n                     .arg(\"-dStdDir=rust-std\")\n                     .arg(\"-dAnalysisDir=rust-analysis\")\n@@ -1799,6 +1799,9 @@ impl Step for Extended {\n                     .arg(&input);\n                 add_env(builder, &mut cmd, target);\n \n+                if built_tools.contains(\"rust-docs\") {\n+                    cmd.arg(\"-dDocsDir=rust-docs\");\n+                }\n                 if built_tools.contains(\"rust-demangler\") {\n                     cmd.arg(\"-dRustDemanglerDir=rust-demangler\");\n                 }\n@@ -1817,7 +1820,9 @@ impl Step for Extended {\n             candle(&etc.join(\"msi/ui.wxs\"));\n             candle(&etc.join(\"msi/rustwelcomedlg.wxs\"));\n             candle(\"RustcGroup.wxs\".as_ref());\n-            candle(\"DocsGroup.wxs\".as_ref());\n+            if built_tools.contains(\"rust-docs\") {\n+                candle(\"DocsGroup.wxs\".as_ref());\n+            }\n             candle(\"CargoGroup.wxs\".as_ref());\n             candle(\"StdGroup.wxs\".as_ref());\n             candle(\"ClippyGroup.wxs\".as_ref());\n@@ -1854,7 +1859,6 @@ impl Step for Extended {\n                 .arg(\"ui.wixobj\")\n                 .arg(\"rustwelcomedlg.wixobj\")\n                 .arg(\"RustcGroup.wixobj\")\n-                .arg(\"DocsGroup.wixobj\")\n                 .arg(\"CargoGroup.wixobj\")\n                 .arg(\"StdGroup.wixobj\")\n                 .arg(\"AnalysisGroup.wixobj\")\n@@ -1870,6 +1874,9 @@ impl Step for Extended {\n             if built_tools.contains(\"rust-demangler\") {\n                 cmd.arg(\"RustDemanglerGroup.wixobj\");\n             }\n+            if built_tools.contains(\"rust-docs\") {\n+                cmd.arg(\"DocsGroup.wixobj\");\n+            }\n \n             if target.ends_with(\"windows-gnu\") {\n                 cmd.arg(\"GccGroup.wixobj\");"}, {"sha": "9f4e4fd0611df6a7569f1ad0b1c9dc93d22a15c5", "filename": "src/etc/installer/msi/rust.wxs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/749b487be49b793dd713c429042b33262208f4f9/src%2Fetc%2Finstaller%2Fmsi%2Frust.wxs", "raw_url": "https://github.com/rust-lang/rust/raw/749b487be49b793dd713c429042b33262208f4f9/src%2Fetc%2Finstaller%2Fmsi%2Frust.wxs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fetc%2Finstaller%2Fmsi%2Frust.wxs?ref=749b487be49b793dd713c429042b33262208f4f9", "patch": "@@ -167,7 +167,9 @@\n                     <?if $(env.CFG_MINGW)=\"1\" ?>\n                         <Directory Id=\"Gcc\" Name=\".\" />\n                     <?endif?>\n+                    <!-- tool-rust-docs-start -->\n                     <Directory Id=\"Docs\" Name=\".\" />\n+                    <!-- tool-rust-docs-end -->\n                     <Directory Id=\"Cargo\" Name=\".\" />\n                     <Directory Id=\"Std\" Name=\".\" />\n                 </Directory>\n@@ -209,6 +211,7 @@\n                         <RegistryValue Root=\"HKMU\" Key=\"$(var.BaseRegKey)\" Name=\"RustShell\" Type=\"integer\" Value=\"1\" KeyPath=\"yes\" />\n                         <RemoveFolder Id=\"ApplicationProgramsFolder1\" On=\"uninstall\" />\n                     </Component>\n+                    <!-- tool-rust-docs-start -->\n                     <Component Id=\"DocIndexShortcut\" Guid=\"*\">\n                         <Shortcut Id=\"RustDocs\"\n                                   Name=\"$(var.ProductName) Documentation\"\n@@ -217,6 +220,7 @@\n                         <RegistryValue Root=\"HKMU\" Key=\"$(var.BaseRegKey)\" Name=\"RustDocs\" Type=\"integer\" Value=\"1\" KeyPath=\"yes\" />\n                         <RemoveFolder Id=\"ApplicationProgramsFolder2\" On=\"uninstall\" />\n                     </Component>\n+                    <!-- tool-rust-docs-end -->\n                 </Directory>\n             </Directory>\n \n@@ -256,6 +260,7 @@\n                      <ComponentGroupRef Id=\"GccGroup\" />\n             </Feature>\n         <?endif?>\n+        <!-- tool-rust-docs-start -->\n         <Feature Id=\"Docs\"\n                  Title=\"HTML documentation\"\n                  Display=\"5\"\n@@ -264,6 +269,7 @@\n                  <ComponentGroupRef Id=\"DocsGroup\" />\n                  <ComponentRef Id=\"DocIndexShortcut\" />\n         </Feature>\n+        <!-- tool-rust-docs-end -->\n         <Feature Id=\"Path\"\n                  Title=\"Add to PATH\"\n                  Description=\"Add Rust to PATH environment variable\""}, {"sha": "1643fc8364b64a3b806b08fbb01d48d7da146f8e", "filename": "src/etc/installer/pkg/Distribution.xml", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/749b487be49b793dd713c429042b33262208f4f9/src%2Fetc%2Finstaller%2Fpkg%2FDistribution.xml", "raw_url": "https://github.com/rust-lang/rust/raw/749b487be49b793dd713c429042b33262208f4f9/src%2Fetc%2Finstaller%2Fpkg%2FDistribution.xml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fetc%2Finstaller%2Fpkg%2FDistribution.xml?ref=749b487be49b793dd713c429042b33262208f4f9", "patch": "@@ -15,7 +15,9 @@\n       <line choice=\"rustc\"/>\n       <line choice=\"rust-std\"/>\n       <line choice=\"cargo\"/>\n+      <!-- tool-rust-docs-start -->\n       <line choice=\"rust-docs\"/>\n+      <!-- tool-rust-docs-end -->\n       </line>\n       <line choice=\"uninstall\" />\n     </choices-outline>\n@@ -55,15 +57,19 @@\n         >\n         <pkg-ref id=\"org.rust-lang.rust-std\"/>\n     </choice>\n+    <!-- tool-rust-docs-start -->\n     <choice id=\"rust-docs\" visible=\"true\"\n         title=\"Documentation\" description=\"HTML documentation.\"\n         selected=\"(!choices.uninstall.selected &amp;&amp; choices['rust-docs'].selected) || (choices.uninstall.selected &amp;&amp; choices.install.selected)\"\n         >\n         <pkg-ref id=\"org.rust-lang.rust-docs\"/>\n     </choice>\n+    <!-- tool-rust-docs-end -->\n     <pkg-ref id=\"org.rust-lang.rustc\" version=\"0\" onConclusion=\"none\">rustc.pkg</pkg-ref>\n     <pkg-ref id=\"org.rust-lang.cargo\" version=\"0\" onConclusion=\"none\">cargo.pkg</pkg-ref>\n+    <!-- tool-rust-docs-start -->\n     <pkg-ref id=\"org.rust-lang.rust-docs\" version=\"0\" onConclusion=\"none\">rust-docs.pkg</pkg-ref>\n+    <!-- tool-rust-docs-end -->\n     <pkg-ref id=\"org.rust-lang.rust-std\" version=\"0\" onConclusion=\"none\">rust-std.pkg</pkg-ref>\n     <pkg-ref id=\"org.rust-lang.uninstall\" version=\"0\" onConclusion=\"none\">uninstall.pkg</pkg-ref>\n     <background file=\"rust-logo.png\" mime-type=\"image/png\""}]}