{"sha": "f85bb0fb09a1932cdc17ebb0dcd13b81c93346f7", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY4NWJiMGZiMDlhMTkzMmNkYzE3ZWJiMGRjZDEzYjgxYzkzMzQ2Zjc=", "commit": {"author": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2021-02-27T11:24:58Z"}, "committer": {"name": "Ralf Jung", "email": "post@ralfj.de", "date": "2021-02-27T11:24:58Z"}, "message": "test for unnecessary rebuilds in 'cargo miri run'", "tree": {"sha": "44b59d95940c4f95dd4b65bdc7e290b70278db74", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/44b59d95940c4f95dd4b65bdc7e290b70278db74"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f85bb0fb09a1932cdc17ebb0dcd13b81c93346f7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f85bb0fb09a1932cdc17ebb0dcd13b81c93346f7", "html_url": "https://github.com/rust-lang/rust/commit/f85bb0fb09a1932cdc17ebb0dcd13b81c93346f7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f85bb0fb09a1932cdc17ebb0dcd13b81c93346f7/comments", "author": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "committer": {"login": "RalfJung", "id": 330628, "node_id": "MDQ6VXNlcjMzMDYyOA==", "avatar_url": "https://avatars.githubusercontent.com/u/330628?v=4", "gravatar_id": "", "url": "https://api.github.com/users/RalfJung", "html_url": "https://github.com/RalfJung", "followers_url": "https://api.github.com/users/RalfJung/followers", "following_url": "https://api.github.com/users/RalfJung/following{/other_user}", "gists_url": "https://api.github.com/users/RalfJung/gists{/gist_id}", "starred_url": "https://api.github.com/users/RalfJung/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/RalfJung/subscriptions", "organizations_url": "https://api.github.com/users/RalfJung/orgs", "repos_url": "https://api.github.com/users/RalfJung/repos", "events_url": "https://api.github.com/users/RalfJung/events{/privacy}", "received_events_url": "https://api.github.com/users/RalfJung/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e29f1379413dd5ddbcbb3199bbe9faf2745824f5", "url": "https://api.github.com/repos/rust-lang/rust/commits/e29f1379413dd5ddbcbb3199bbe9faf2745824f5", "html_url": "https://github.com/rust-lang/rust/commit/e29f1379413dd5ddbcbb3199bbe9faf2745824f5"}], "stats": {"total": 30, "additions": 28, "deletions": 2}, "files": [{"sha": "0505b422d95f153626b4c4f927c1af365d3fc90a", "filename": "test-cargo-miri/run-test.py", "status": "modified", "additions": 28, "deletions": 2, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/f85bb0fb09a1932cdc17ebb0dcd13b81c93346f7/test-cargo-miri%2Frun-test.py", "raw_url": "https://github.com/rust-lang/rust/raw/f85bb0fb09a1932cdc17ebb0dcd13b81c93346f7/test-cargo-miri%2Frun-test.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/test-cargo-miri%2Frun-test.py?ref=f85bb0fb09a1932cdc17ebb0dcd13b81c93346f7", "patch": "@@ -15,8 +15,10 @@ def fail(msg):\n     print(\"\\nTEST FAIL: {}\".format(msg))\n     sys.exit(1)\n \n-def cargo_miri(cmd):\n-    args = [\"cargo\", \"miri\", cmd, \"-q\"]\n+def cargo_miri(cmd, quiet = True):\n+    args = [\"cargo\", \"miri\", cmd]\n+    if quiet:\n+        args += [\"-q\"]\n     if 'MIRI_TEST_TARGET' in os.environ:\n         args += [\"--target\", os.environ['MIRI_TEST_TARGET']]\n     return args\n@@ -48,6 +50,25 @@ def test(name, cmd, stdout_ref, stderr_ref, stdin=b'', env={}):\n     print(\"--- END stderr ---\")\n     fail(\"exit code was {}\".format(p.returncode))\n \n+def test_rebuild(name, cmd, rebuild_count_expected):\n+    print(\"Testing {}...\".format(name))\n+    p = subprocess.Popen(\n+        cmd,\n+        stdout=subprocess.PIPE,\n+        stderr=subprocess.PIPE,\n+    )\n+    (stdout, stderr) = p.communicate()\n+    stdout = stdout.decode(\"UTF-8\")\n+    stderr = stderr.decode(\"UTF-8\")\n+    if p.returncode != 0:\n+        fail(\"rebuild failed\");\n+    rebuild_count =  stderr.count(\" Compiling \");\n+    if rebuild_count != rebuild_count_expected:\n+        print(\"--- BEGIN stderr ---\")\n+        print(stderr, end=\"\")\n+        print(\"--- END stderr ---\")\n+        fail(\"Expected {} rebuild(s), but got {}\".format(rebuild_count_expected, rebuild_count));\n+\n def test_cargo_miri_run():\n     test(\"`cargo miri run` (no isolation)\",\n         cargo_miri(\"run\"),\n@@ -67,6 +88,11 @@ def test_cargo_miri_run():\n         \"run.subcrate.stdout.ref\", \"run.subcrate.stderr.ref\",\n         env={'MIRIFLAGS': \"-Zmiri-disable-isolation\"},\n     )\n+    # Special test: run it again *without* `-q` to make sure nothing is being rebuilt (Miri issue #1722)\n+    test_rebuild(\"`cargo miri run` (clean rebuild)\",\n+        cargo_miri(\"run\", quiet=False) + [\"--\", \"\"],\n+        rebuild_count_expected=1,\n+    )\n \n def test_cargo_miri_test():\n     # rustdoc is not run on foreign targets"}]}