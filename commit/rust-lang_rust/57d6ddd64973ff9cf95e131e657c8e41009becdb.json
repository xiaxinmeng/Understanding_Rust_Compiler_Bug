{"sha": "57d6ddd64973ff9cf95e131e657c8e41009becdb", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU3ZDZkZGQ2NDk3M2ZmOWNmOTVlMTMxZTY1N2M4ZTQxMDA5YmVjZGI=", "commit": {"author": {"name": "Michael Woerister", "email": "michaelwoerister@posteo.net", "date": "2016-09-29T15:00:11Z"}, "committer": {"name": "Michael Woerister", "email": "michaelwoerister@posteo.net", "date": "2016-10-07T14:08:57Z"}, "message": "incr.comp.: Hide concrete hash algorithm used for ICH", "tree": {"sha": "013d1f0710ff8154161df9371a1d37d62433da3c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/013d1f0710ff8154161df9371a1d37d62433da3c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/57d6ddd64973ff9cf95e131e657c8e41009becdb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/57d6ddd64973ff9cf95e131e657c8e41009becdb", "html_url": "https://github.com/rust-lang/rust/commit/57d6ddd64973ff9cf95e131e657c8e41009becdb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/57d6ddd64973ff9cf95e131e657c8e41009becdb/comments", "author": {"login": "michaelwoerister", "id": 1825894, "node_id": "MDQ6VXNlcjE4MjU4OTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1825894?v=4", "gravatar_id": "", "url": "https://api.github.com/users/michaelwoerister", "html_url": "https://github.com/michaelwoerister", "followers_url": "https://api.github.com/users/michaelwoerister/followers", "following_url": "https://api.github.com/users/michaelwoerister/following{/other_user}", "gists_url": "https://api.github.com/users/michaelwoerister/gists{/gist_id}", "starred_url": "https://api.github.com/users/michaelwoerister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/michaelwoerister/subscriptions", "organizations_url": "https://api.github.com/users/michaelwoerister/orgs", "repos_url": "https://api.github.com/users/michaelwoerister/repos", "events_url": "https://api.github.com/users/michaelwoerister/events{/privacy}", "received_events_url": "https://api.github.com/users/michaelwoerister/received_events", "type": "User", "site_admin": false}, "committer": {"login": "michaelwoerister", "id": 1825894, "node_id": "MDQ6VXNlcjE4MjU4OTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1825894?v=4", "gravatar_id": "", "url": "https://api.github.com/users/michaelwoerister", "html_url": "https://github.com/michaelwoerister", "followers_url": "https://api.github.com/users/michaelwoerister/followers", "following_url": "https://api.github.com/users/michaelwoerister/following{/other_user}", "gists_url": "https://api.github.com/users/michaelwoerister/gists{/gist_id}", "starred_url": "https://api.github.com/users/michaelwoerister/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/michaelwoerister/subscriptions", "organizations_url": "https://api.github.com/users/michaelwoerister/orgs", "repos_url": "https://api.github.com/users/michaelwoerister/repos", "events_url": "https://api.github.com/users/michaelwoerister/events{/privacy}", "received_events_url": "https://api.github.com/users/michaelwoerister/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e2bd2d83dd620ddf55eb5638c1e74bed616678e8", "url": "https://api.github.com/repos/rust-lang/rust/commits/e2bd2d83dd620ddf55eb5638c1e74bed616678e8", "html_url": "https://github.com/rust-lang/rust/commit/e2bd2d83dd620ddf55eb5638c1e74bed616678e8"}], "stats": {"total": 80, "additions": 72, "deletions": 8}, "files": [{"sha": "d002aba595bcac22f70fc8215c4eb1febd36c2e6", "filename": "src/librustc/session/mod.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/57d6ddd64973ff9cf95e131e657c8e41009becdb/src%2Flibrustc%2Fsession%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57d6ddd64973ff9cf95e131e657c8e41009becdb/src%2Flibrustc%2Fsession%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fsession%2Fmod.rs?ref=57d6ddd64973ff9cf95e131e657c8e41009becdb", "patch": "@@ -118,6 +118,8 @@ pub struct PerfStats {\n     pub incr_comp_hashes_time: Cell<Duration>,\n     // The number of incr. comp. hash computations performed\n     pub incr_comp_hashes_count: Cell<u64>,\n+    // The number of bytes hashed when computing ICH values\n+    pub incr_comp_bytes_hashed: Cell<u64>,\n     // The accumulated time spent on computing symbol hashes\n     pub symbol_hash_time: Cell<Duration>,\n }\n@@ -439,6 +441,11 @@ impl Session {\n                  duration_to_secs_str(self.perf_stats.incr_comp_hashes_time.get()));\n         println!(\"Total number of incr. comp. hashes computed:   {}\",\n                  self.perf_stats.incr_comp_hashes_count.get());\n+        println!(\"Total number of bytes hashed for incr. comp.:  {}\",\n+                 self.perf_stats.incr_comp_bytes_hashed.get());\n+        println!(\"Average bytes hashed per incr. comp. HIR node: {}\",\n+                 self.perf_stats.incr_comp_bytes_hashed.get() /\n+                 self.perf_stats.incr_comp_hashes_count.get());\n         println!(\"Total time spent computing symbol hashes:      {}\",\n                  duration_to_secs_str(self.perf_stats.symbol_hash_time.get()));\n     }\n@@ -571,6 +578,7 @@ pub fn build_session_(sopts: config::Options,\n             svh_time: Cell::new(Duration::from_secs(0)),\n             incr_comp_hashes_time: Cell::new(Duration::from_secs(0)),\n             incr_comp_hashes_count: Cell::new(0),\n+            incr_comp_bytes_hashed: Cell::new(0),\n             symbol_hash_time: Cell::new(Duration::from_secs(0)),\n         }\n     };"}, {"sha": "28db39d667c4c864012fc34c8537b4b8af05bc53", "filename": "src/librustc_incremental/calculate_svh/hasher.rs", "status": "added", "additions": 46, "deletions": 0, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/57d6ddd64973ff9cf95e131e657c8e41009becdb/src%2Flibrustc_incremental%2Fcalculate_svh%2Fhasher.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57d6ddd64973ff9cf95e131e657c8e41009becdb/src%2Flibrustc_incremental%2Fcalculate_svh%2Fhasher.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_incremental%2Fcalculate_svh%2Fhasher.rs?ref=57d6ddd64973ff9cf95e131e657c8e41009becdb", "patch": "@@ -0,0 +1,46 @@\n+// Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+use std::hash::Hasher;\n+use std::collections::hash_map::DefaultHasher;\n+\n+#[derive(Debug)]\n+pub struct IchHasher {\n+    // FIXME: this should use SHA1, not DefaultHasher. DefaultHasher is not\n+    // built to avoid collisions.\n+    state: DefaultHasher,\n+    bytes_hashed: u64,\n+}\n+\n+impl IchHasher {\n+    pub fn new() -> IchHasher {\n+        IchHasher {\n+            state: DefaultHasher::new(),\n+            bytes_hashed: 0\n+        }\n+    }\n+\n+    pub fn bytes_hashed(&self) -> u64 {\n+        self.bytes_hashed\n+    }\n+}\n+\n+impl Hasher for IchHasher {\n+    #[inline]\n+    fn finish(&self) -> u64 {\n+        self.state.finish()\n+    }\n+\n+    #[inline]\n+    fn write(&mut self, bytes: &[u8]) {\n+        self.state.write(bytes);\n+        self.bytes_hashed += bytes.len() as u64;\n+    }\n+}"}, {"sha": "12627e02debd0d723427d028e1cad35a042a8603", "filename": "src/librustc_incremental/calculate_svh/mod.rs", "status": "modified", "additions": 15, "deletions": 5, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/57d6ddd64973ff9cf95e131e657c8e41009becdb/src%2Flibrustc_incremental%2Fcalculate_svh%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57d6ddd64973ff9cf95e131e657c8e41009becdb/src%2Flibrustc_incremental%2Fcalculate_svh%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_incremental%2Fcalculate_svh%2Fmod.rs?ref=57d6ddd64973ff9cf95e131e657c8e41009becdb", "patch": "@@ -30,7 +30,6 @@\n use syntax::ast;\n use std::cell::RefCell;\n use std::hash::{Hash, Hasher};\n-use std::collections::hash_map::DefaultHasher;\n use rustc::dep_graph::DepNode;\n use rustc::hir;\n use rustc::hir::def_id::{CRATE_DEF_INDEX, DefId};\n@@ -43,10 +42,12 @@ use rustc::session::config::DebugInfoLevel::NoDebugInfo;\n use self::def_path_hash::DefPathHashes;\n use self::svh_visitor::StrictVersionHashVisitor;\n use self::caching_codemap_view::CachingCodemapView;\n+use self::hasher::IchHasher;\n \n mod def_path_hash;\n mod svh_visitor;\n mod caching_codemap_view;\n+mod hasher;\n \n pub struct IncrementalHashesMap {\n     hashes: FnvHashMap<DepNode<DefId>, u64>,\n@@ -74,6 +75,10 @@ impl IncrementalHashesMap {\n     pub fn iter<'a>(&'a self) -> ::std::collections::hash_map::Iter<'a, DepNode<DefId>, u64> {\n         self.hashes.iter()\n     }\n+\n+    pub fn len(&self) -> usize {\n+        self.hashes.len()\n+    }\n }\n \n impl<'a> ::std::ops::Index<&'a DepNode<DefId>> for IncrementalHashesMap {\n@@ -102,6 +107,9 @@ pub fn compute_incremental_hashes_map<'a, 'tcx: 'a>(tcx: TyCtxt<'a, 'tcx, 'tcx>)\n                                  |v| visit::walk_crate(v, krate));\n         krate.visit_all_items(&mut visitor);\n     });\n+\n+    tcx.sess.perf_stats.incr_comp_hashes_count.set(visitor.hashes.len() as u64);\n+\n     record_time(&tcx.sess.perf_stats.svh_time, || visitor.compute_crate_hash());\n     visitor.hashes\n }\n@@ -127,9 +135,7 @@ impl<'a, 'tcx> HashItemsVisitor<'a, 'tcx> {\n     {\n         assert!(def_id.is_local());\n         debug!(\"HashItemsVisitor::calculate(def_id={:?})\", def_id);\n-        // FIXME: this should use SHA1, not DefaultHasher. DefaultHasher is not\n-        // built to avoid collisions.\n-        let mut state = DefaultHasher::new();\n+        let mut state = IchHasher::new();\n         walk_op(&mut StrictVersionHashVisitor::new(&mut state,\n                                                    self.tcx,\n                                                    &mut self.def_path_hashes,\n@@ -138,12 +144,16 @@ impl<'a, 'tcx> HashItemsVisitor<'a, 'tcx> {\n         let item_hash = state.finish();\n         self.hashes.insert(DepNode::Hir(def_id), item_hash);\n         debug!(\"calculate_item_hash: def_id={:?} hash={:?}\", def_id, item_hash);\n+\n+        let bytes_hashed = self.tcx.sess.perf_stats.incr_comp_bytes_hashed.get() +\n+                           state.bytes_hashed();\n+        self.tcx.sess.perf_stats.incr_comp_bytes_hashed.set(bytes_hashed);\n     }\n \n     fn compute_crate_hash(&mut self) {\n         let krate = self.tcx.map.krate();\n \n-        let mut crate_state = DefaultHasher::new();\n+        let mut crate_state = IchHasher::new();\n \n         let crate_disambiguator = self.tcx.sess.local_crate_disambiguator();\n         \"crate_disambiguator\".hash(&mut crate_state);"}, {"sha": "584e5598b9f9ffec78ecb6e9f9f4233dcc14c119", "filename": "src/librustc_incremental/calculate_svh/svh_visitor.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/57d6ddd64973ff9cf95e131e657c8e41009becdb/src%2Flibrustc_incremental%2Fcalculate_svh%2Fsvh_visitor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/57d6ddd64973ff9cf95e131e657c8e41009becdb/src%2Flibrustc_incremental%2Fcalculate_svh%2Fsvh_visitor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_incremental%2Fcalculate_svh%2Fsvh_visitor.rs?ref=57d6ddd64973ff9cf95e131e657c8e41009becdb", "patch": "@@ -31,10 +31,10 @@ use rustc::hir::intravisit as visit;\n use rustc::ty::TyCtxt;\n use rustc_data_structures::fnv;\n use std::hash::Hash;\n-use std::collections::hash_map::DefaultHasher;\n \n use super::def_path_hash::DefPathHashes;\n use super::caching_codemap_view::CachingCodemapView;\n+use super::hasher::IchHasher;\n \n const IGNORED_ATTRIBUTES: &'static [&'static str] = &[\n     \"cfg\",\n@@ -48,15 +48,15 @@ const IGNORED_ATTRIBUTES: &'static [&'static str] = &[\n \n pub struct StrictVersionHashVisitor<'a, 'hash: 'a, 'tcx: 'hash> {\n     pub tcx: TyCtxt<'hash, 'tcx, 'tcx>,\n-    pub st: &'a mut DefaultHasher,\n+    pub st: &'a mut IchHasher,\n     // collect a deterministic hash of def-ids that we have seen\n     def_path_hashes: &'a mut DefPathHashes<'hash, 'tcx>,\n     hash_spans: bool,\n     codemap: &'a mut CachingCodemapView<'tcx>,\n }\n \n impl<'a, 'hash, 'tcx> StrictVersionHashVisitor<'a, 'hash, 'tcx> {\n-    pub fn new(st: &'a mut DefaultHasher,\n+    pub fn new(st: &'a mut IchHasher,\n                tcx: TyCtxt<'hash, 'tcx, 'tcx>,\n                def_path_hashes: &'a mut DefPathHashes<'hash, 'tcx>,\n                codemap: &'a mut CachingCodemapView<'tcx>,"}]}