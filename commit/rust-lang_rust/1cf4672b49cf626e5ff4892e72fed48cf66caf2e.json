{"sha": "1cf4672b49cf626e5ff4892e72fed48cf66caf2e", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFjZjQ2NzJiNDljZjYyNmU1ZmY0ODkyZTcyZmVkNDhjZjY2Y2FmMmU=", "commit": {"author": {"name": "Oliver Schneider", "email": "oli-obk@users.noreply.github.com", "date": "2017-09-30T14:19:12Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2017-09-30T14:19:12Z"}, "message": "Merge pull request #2096 from lpesk/invalid-ref\n\nLint for creation of invalid references", "tree": {"sha": "7bd3ee4a8b8926360b3d0594e6ae3a0f11d55b3e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7bd3ee4a8b8926360b3d0594e6ae3a0f11d55b3e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1cf4672b49cf626e5ff4892e72fed48cf66caf2e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1cf4672b49cf626e5ff4892e72fed48cf66caf2e", "html_url": "https://github.com/rust-lang/rust/commit/1cf4672b49cf626e5ff4892e72fed48cf66caf2e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1cf4672b49cf626e5ff4892e72fed48cf66caf2e/comments", "author": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "06280e838b2a8ff2809566aff574d51b182330f5", "url": "https://api.github.com/repos/rust-lang/rust/commits/06280e838b2a8ff2809566aff574d51b182330f5", "html_url": "https://github.com/rust-lang/rust/commit/06280e838b2a8ff2809566aff574d51b182330f5"}, {"sha": "8e6abc6fd761b8a1c607d9d1f626db99f146aee7", "url": "https://api.github.com/repos/rust-lang/rust/commits/8e6abc6fd761b8a1c607d9d1f626db99f146aee7", "html_url": "https://github.com/rust-lang/rust/commit/8e6abc6fd761b8a1c607d9d1f626db99f146aee7"}], "stats": {"total": 179, "additions": 179, "deletions": 0}, "files": [{"sha": "ad3398cb0782db9ed4b2a54bee677ae82b5245ee", "filename": "clippy_lints/src/invalid_ref.rs", "status": "added", "additions": 55, "deletions": 0, "changes": 55, "blob_url": "https://github.com/rust-lang/rust/blob/1cf4672b49cf626e5ff4892e72fed48cf66caf2e/clippy_lints%2Fsrc%2Finvalid_ref.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1cf4672b49cf626e5ff4892e72fed48cf66caf2e/clippy_lints%2Fsrc%2Finvalid_ref.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Finvalid_ref.rs?ref=1cf4672b49cf626e5ff4892e72fed48cf66caf2e", "patch": "@@ -0,0 +1,55 @@\n+use rustc::lint::*;\n+use rustc::ty;\n+use rustc::hir::*;\n+use utils::{match_def_path, paths, span_help_and_lint, opt_def_id};\n+\n+/// **What it does:** Checks for creation of references to zeroed or uninitialized memory.\n+///\n+/// **Why is this bad?** Creation of null references is undefined behavior.\n+///\n+/// **Known problems:** None. \n+///\n+/// **Example:**\n+/// ```rust\n+/// let bad_ref: &usize = std::mem::zeroed();\n+/// ```\n+\n+declare_lint! {\n+    pub INVALID_REF,\n+    Warn,\n+    \"creation of invalid reference\"\n+}\n+\n+const ZERO_REF_SUMMARY: &str = \"reference to zeroed memory\";\n+const UNINIT_REF_SUMMARY: &str = \"reference to uninitialized memory\";\n+const HELP: &str = \"Creation of a null reference is undefined behavior; see https://doc.rust-lang.org/reference/behavior-considered-undefined.html\"; \n+\n+pub struct InvalidRef; \n+\n+impl LintPass for InvalidRef {\n+    fn get_lints(&self) -> LintArray {\n+        lint_array!(INVALID_REF)\n+    }\n+}\n+\n+impl<'a, 'tcx> LateLintPass<'a, 'tcx> for InvalidRef {\n+    fn check_expr(&mut self, cx: &LateContext<'a, 'tcx>, expr: &'tcx Expr) {\n+        if_let_chain!{[\n+            let ExprCall(ref path, ref args) = expr.node,\n+            let ExprPath(ref qpath) = path.node,\n+            args.len() == 0,\n+            let ty::TyRef(..) = cx.tables.expr_ty(expr).sty, \n+            let Some(def_id) = opt_def_id(cx.tables.qpath_def(qpath, path.hir_id)),\n+        ], {\n+            let msg = if match_def_path(cx.tcx, def_id, &paths::MEM_ZEROED) | match_def_path(cx.tcx, def_id, &paths::INIT) {\n+                ZERO_REF_SUMMARY\n+            } else if match_def_path(cx.tcx, def_id, &paths::MEM_UNINIT) | match_def_path(cx.tcx, def_id, &paths::UNINIT) {\n+                UNINIT_REF_SUMMARY\n+            } else {\n+                return;\n+            };\n+            span_help_and_lint(cx, INVALID_REF, expr.span, msg, HELP);\n+        }}        \n+        return;\n+    }\n+}"}, {"sha": "759a66eaae5b3a6a2ebf46bb9e207b98e5a679ef", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/1cf4672b49cf626e5ff4892e72fed48cf66caf2e/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1cf4672b49cf626e5ff4892e72fed48cf66caf2e/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=1cf4672b49cf626e5ff4892e72fed48cf66caf2e", "patch": "@@ -97,6 +97,7 @@ pub mod if_let_redundant_pattern_matching;\n pub mod if_not_else;\n pub mod infinite_iter;\n pub mod int_plus_one;\n+pub mod invalid_ref;\n pub mod is_unit_expr;\n pub mod items_after_statements;\n pub mod large_enum_variant;\n@@ -328,6 +329,7 @@ pub fn register_plugins(reg: &mut rustc_plugin::Registry) {\n     reg.register_late_lint_pass(box use_self::UseSelf);\n     reg.register_late_lint_pass(box bytecount::ByteCount);\n     reg.register_late_lint_pass(box infinite_iter::Pass);\n+    reg.register_late_lint_pass(box invalid_ref::InvalidRef);\n \n     reg.register_lint_group(\"clippy_restrictions\", vec![\n         arithmetic::FLOAT_ARITHMETIC,\n@@ -345,6 +347,7 @@ pub fn register_plugins(reg: &mut rustc_plugin::Registry) {\n         if_not_else::IF_NOT_ELSE,\n         infinite_iter::MAYBE_INFINITE_ITER,\n         int_plus_one::INT_PLUS_ONE,\n+        invalid_ref::INVALID_REF,\n         items_after_statements::ITEMS_AFTER_STATEMENTS,\n         matches::SINGLE_MATCH_ELSE,\n         mem_forget::MEM_FORGET,"}, {"sha": "2a2eabcca1f8a7c5a2c2c736797844a67081941f", "filename": "clippy_lints/src/utils/paths.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/1cf4672b49cf626e5ff4892e72fed48cf66caf2e/clippy_lints%2Fsrc%2Futils%2Fpaths.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1cf4672b49cf626e5ff4892e72fed48cf66caf2e/clippy_lints%2Fsrc%2Futils%2Fpaths.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Futils%2Fpaths.rs?ref=1cf4672b49cf626e5ff4892e72fed48cf66caf2e", "patch": "@@ -30,6 +30,7 @@ pub const HASH: [&'static str; 2] = [\"hash\", \"Hash\"];\n pub const HASHMAP: [&'static str; 5] = [\"std\", \"collections\", \"hash\", \"map\", \"HashMap\"];\n pub const HASHMAP_ENTRY: [&'static str; 5] = [\"std\", \"collections\", \"hash\", \"map\", \"Entry\"];\n pub const HASHSET: [&'static str; 5] = [\"std\", \"collections\", \"hash\", \"set\", \"HashSet\"];\n+pub const INIT: [&'static str; 4] = [\"core\", \"intrinsics\", \"\", \"init\"];\n pub const INTO_ITERATOR: [&'static str; 4] = [\"core\", \"iter\", \"traits\", \"IntoIterator\"];\n pub const IO_PRINT: [&'static str; 4] = [\"std\", \"io\", \"stdio\", \"_print\"];\n pub const IO_READ: [&'static str; 3] = [\"std\", \"io\", \"Read\"];\n@@ -39,6 +40,8 @@ pub const LINKED_LIST: [&'static str; 3] = [\"alloc\", \"linked_list\", \"LinkedList\"\n pub const LINT: [&'static str; 3] = [\"rustc\", \"lint\", \"Lint\"];\n pub const LINT_ARRAY: [&'static str; 3] = [\"rustc\", \"lint\", \"LintArray\"];\n pub const MEM_FORGET: [&'static str; 3] = [\"core\", \"mem\", \"forget\"];\n+pub const MEM_UNINIT: [&'static str; 3] = [\"core\", \"mem\", \"uninitialized\"];\n+pub const MEM_ZEROED: [&'static str; 3] = [\"core\", \"mem\", \"zeroed\"];\n pub const MUTEX: [&'static str; 4] = [\"std\", \"sync\", \"mutex\", \"Mutex\"];\n pub const OPEN_OPTIONS: [&'static str; 3] = [\"std\", \"fs\", \"OpenOptions\"];\n pub const OPS_MODULE: [&'static str; 2] = [\"core\", \"ops\"];\n@@ -80,6 +83,7 @@ pub const TO_OWNED: [&'static str; 3] = [\"alloc\", \"borrow\", \"ToOwned\"];\n pub const TO_STRING: [&'static str; 3] = [\"alloc\", \"string\", \"ToString\"];\n pub const TRANSMUTE: [&'static str; 4] = [\"core\", \"intrinsics\", \"\", \"transmute\"];\n pub const TRY_INTO_RESULT: [&'static str; 4] = [\"std\", \"ops\", \"Try\", \"into_result\"];\n+pub const UNINIT: [&'static str; 4] = [\"core\", \"intrinsics\", \"\", \"uninit\"];\n pub const VEC: [&'static str; 3] = [\"alloc\", \"vec\", \"Vec\"];\n pub const VEC_DEQUE: [&'static str; 3] = [\"alloc\", \"vec_deque\", \"VecDeque\"];\n pub const VEC_FROM_ELEM: [&'static str; 3] = [\"alloc\", \"vec\", \"from_elem\"];"}, {"sha": "2b8f04c9781ce26505cb4b3ee9bc3666d25ae30b", "filename": "tests/ui/invalid_ref.rs", "status": "added", "additions": 66, "deletions": 0, "changes": 66, "blob_url": "https://github.com/rust-lang/rust/blob/1cf4672b49cf626e5ff4892e72fed48cf66caf2e/tests%2Fui%2Finvalid_ref.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1cf4672b49cf626e5ff4892e72fed48cf66caf2e/tests%2Fui%2Finvalid_ref.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Finvalid_ref.rs?ref=1cf4672b49cf626e5ff4892e72fed48cf66caf2e", "patch": "@@ -0,0 +1,66 @@\n+#![feature(plugin)]\n+#![plugin(clippy)]\n+\n+#![allow(unused)]\n+#![feature(core_intrinsics)]\n+\n+extern crate core;\n+use std::intrinsics::{init, uninit};\n+\n+fn main() {\n+    let x = 1; \n+    unsafe { \n+        ref_to_zeroed_std(&x);\n+        ref_to_zeroed_core(&x);\n+        ref_to_zeroed_intr(&x);\n+        ref_to_uninit_std(&x);\n+        ref_to_uninit_core(&x);\n+        ref_to_uninit_intr(&x);\n+        some_ref();\n+        std_zeroed_no_ref();\n+        core_zeroed_no_ref();\n+        intr_init_no_ref();\n+    }\n+}\n+\n+unsafe fn ref_to_zeroed_std<T: ?Sized>(t: &T) {\n+    let ref_zero: &T = std::mem::zeroed();     // warning\n+}\n+\n+unsafe fn ref_to_zeroed_core<T: ?Sized>(t: &T) {\n+    let ref_zero: &T = core::mem::zeroed();   // warning\n+}\n+\n+unsafe fn ref_to_zeroed_intr<T: ?Sized>(t: &T) {\n+    let ref_zero: &T = std::intrinsics::init();   // warning\n+}\n+\n+unsafe fn ref_to_uninit_std<T: ?Sized>(t: &T) {\n+    let ref_uninit: &T = std::mem::uninitialized();   // warning\n+}\n+\n+unsafe fn ref_to_uninit_core<T: ?Sized>(t: &T) {\n+    let ref_uninit: &T = core::mem::uninitialized();   // warning\n+}\n+\n+unsafe fn ref_to_uninit_intr<T: ?Sized>(t: &T) {\n+    let ref_uninit: &T = std::intrinsics::uninit();   // warning\n+}\n+\n+fn some_ref() {\n+    let some_ref = &1; \n+}\n+\n+unsafe fn std_zeroed_no_ref() {\n+    let mem_zero: usize = std::mem::zeroed();  // no warning\n+}\n+\n+unsafe fn core_zeroed_no_ref() {\n+    let mem_zero: usize = core::mem::zeroed();  // no warning\n+}\n+\n+unsafe fn intr_init_no_ref() {\n+    let mem_zero: usize = std::intrinsics::init(); // no warning\n+}\n+\n+"}, {"sha": "420fed017444c39375792948c409e1755bb4746b", "filename": "tests/ui/invalid_ref.stderr", "status": "added", "additions": 51, "deletions": 0, "changes": 51, "blob_url": "https://github.com/rust-lang/rust/blob/1cf4672b49cf626e5ff4892e72fed48cf66caf2e/tests%2Fui%2Finvalid_ref.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/1cf4672b49cf626e5ff4892e72fed48cf66caf2e/tests%2Fui%2Finvalid_ref.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Finvalid_ref.stderr?ref=1cf4672b49cf626e5ff4892e72fed48cf66caf2e", "patch": "@@ -0,0 +1,51 @@\n+error: reference to zeroed memory\n+  --> $DIR/invalid_ref.rs:27:24\n+   |\n+27 |     let ref_zero: &T = std::mem::zeroed();     // warning\n+   |                        ^^^^^^^^^^^^^^^^^^\n+   |\n+   = note: `-D invalid-ref` implied by `-D warnings`\n+   = help: Creation of a null reference is undefined behavior; see https://doc.rust-lang.org/reference/behavior-considered-undefined.html\n+\n+error: reference to zeroed memory\n+  --> $DIR/invalid_ref.rs:31:24\n+   |\n+31 |     let ref_zero: &T = core::mem::zeroed();   // warning\n+   |                        ^^^^^^^^^^^^^^^^^^^\n+   |\n+   = help: Creation of a null reference is undefined behavior; see https://doc.rust-lang.org/reference/behavior-considered-undefined.html\n+\n+error: reference to zeroed memory\n+  --> $DIR/invalid_ref.rs:35:24\n+   |\n+35 |     let ref_zero: &T = std::intrinsics::init();   // warning\n+   |                        ^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+   = help: Creation of a null reference is undefined behavior; see https://doc.rust-lang.org/reference/behavior-considered-undefined.html\n+\n+error: reference to uninitialized memory\n+  --> $DIR/invalid_ref.rs:39:26\n+   |\n+39 |     let ref_uninit: &T = std::mem::uninitialized();   // warning\n+   |                          ^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+   = help: Creation of a null reference is undefined behavior; see https://doc.rust-lang.org/reference/behavior-considered-undefined.html\n+\n+error: reference to uninitialized memory\n+  --> $DIR/invalid_ref.rs:43:26\n+   |\n+43 |     let ref_uninit: &T = core::mem::uninitialized();   // warning\n+   |                          ^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+   = help: Creation of a null reference is undefined behavior; see https://doc.rust-lang.org/reference/behavior-considered-undefined.html\n+\n+error: reference to uninitialized memory\n+  --> $DIR/invalid_ref.rs:47:26\n+   |\n+47 |     let ref_uninit: &T = std::intrinsics::uninit();   // warning\n+   |                          ^^^^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+   = help: Creation of a null reference is undefined behavior; see https://doc.rust-lang.org/reference/behavior-considered-undefined.html\n+\n+error: aborting due to 6 previous errors\n+"}]}