{"sha": "0a785cdf34e2eba2200677aa2a397bc3ddeed270", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBhNzg1Y2RmMzRlMmViYTIyMDA2NzdhYTJhMzk3YmMzZGRlZWQyNzA=", "commit": {"author": {"name": "Oliver Scherer", "email": "github35764891676564198441@oli-obk.de", "date": "2020-05-12T11:23:01Z"}, "committer": {"name": "Oliver Scherer", "email": "github35764891676564198441@oli-obk.de", "date": "2020-05-12T11:23:01Z"}, "message": "Add some more sanity tests and add a debug log message for it", "tree": {"sha": "e327ea9ab69aa1cfc30774de8e1ba3ebd728e1d8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e327ea9ab69aa1cfc30774de8e1ba3ebd728e1d8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0a785cdf34e2eba2200677aa2a397bc3ddeed270", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0a785cdf34e2eba2200677aa2a397bc3ddeed270", "html_url": "https://github.com/rust-lang/rust/commit/0a785cdf34e2eba2200677aa2a397bc3ddeed270", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0a785cdf34e2eba2200677aa2a397bc3ddeed270/comments", "author": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "committer": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "de434d8e44b40451eff0020832bb9a9303b32067", "url": "https://api.github.com/repos/rust-lang/rust/commits/de434d8e44b40451eff0020832bb9a9303b32067", "html_url": "https://github.com/rust-lang/rust/commit/de434d8e44b40451eff0020832bb9a9303b32067"}], "stats": {"total": 94, "additions": 94, "deletions": 0}, "files": [{"sha": "88dfa90ac21dc9f6ef3f8970b3d6a8f75020770d", "filename": "src/librustc_mir/transform/const_prop.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/0a785cdf34e2eba2200677aa2a397bc3ddeed270/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0a785cdf34e2eba2200677aa2a397bc3ddeed270/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fconst_prop.rs?ref=0a785cdf34e2eba2200677aa2a397bc3ddeed270", "patch": "@@ -893,6 +893,11 @@ impl<'mir, 'tcx> MutVisitor<'tcx> for ConstPropagator<'mir, 'tcx> {\n                     // ```\n                     // FIXME: we overzealously erase the entire local, because that's easier to\n                     // implement.\n+                    trace!(\n+                        \"propagation into {:?} failed.\n+                        Nuking the entire site from orbit, it's the only way to be sure\",\n+                        place,\n+                    );\n                     Self::remove_const(&mut self.ecx, place.local);\n                 }\n             }"}, {"sha": "40f801b1b5e581c8a4ba994ef4090c73bfbab72f", "filename": "src/test/mir-opt/const_prop/mutable_variable_unprop_assign.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/0a785cdf34e2eba2200677aa2a397bc3ddeed270/src%2Ftest%2Fmir-opt%2Fconst_prop%2Fmutable_variable_unprop_assign.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0a785cdf34e2eba2200677aa2a397bc3ddeed270/src%2Ftest%2Fmir-opt%2Fconst_prop%2Fmutable_variable_unprop_assign.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fconst_prop%2Fmutable_variable_unprop_assign.rs?ref=0a785cdf34e2eba2200677aa2a397bc3ddeed270", "patch": "@@ -0,0 +1,15 @@\n+// compile-flags: -O\n+\n+// EMIT_MIR rustc.main.ConstProp.diff\n+fn main() {\n+    let a = foo();\n+    let mut x: (i32, i32) = (1, 2);\n+    x.1 = a;\n+    let y = x.1;\n+    let z = x.0; // this could theoretically be allowed, but we can't handle it right now\n+}\n+\n+#[inline(never)]\n+fn foo() -> i32 {\n+    unimplemented!()\n+}"}, {"sha": "738343c655e360b11ed205d4f99be0032e119728", "filename": "src/test/mir-opt/const_prop/mutable_variable_unprop_assign/rustc.main.ConstProp.diff", "status": "added", "additions": 74, "deletions": 0, "changes": 74, "blob_url": "https://github.com/rust-lang/rust/blob/0a785cdf34e2eba2200677aa2a397bc3ddeed270/src%2Ftest%2Fmir-opt%2Fconst_prop%2Fmutable_variable_unprop_assign%2Frustc.main.ConstProp.diff", "raw_url": "https://github.com/rust-lang/rust/raw/0a785cdf34e2eba2200677aa2a397bc3ddeed270/src%2Ftest%2Fmir-opt%2Fconst_prop%2Fmutable_variable_unprop_assign%2Frustc.main.ConstProp.diff", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fconst_prop%2Fmutable_variable_unprop_assign%2Frustc.main.ConstProp.diff?ref=0a785cdf34e2eba2200677aa2a397bc3ddeed270", "patch": "@@ -0,0 +1,74 @@\n+- // MIR for `main` before ConstProp\n++ // MIR for `main` after ConstProp\n+  \n+  fn main() -> () {\n+      let mut _0: ();                      // return place in scope 0 at $DIR/mutable_variable_unprop_assign.rs:4:11: 4:11\n+      let _1: i32;                         // in scope 0 at $DIR/mutable_variable_unprop_assign.rs:5:9: 5:10\n+      let mut _3: i32;                     // in scope 0 at $DIR/mutable_variable_unprop_assign.rs:7:11: 7:12\n+      scope 1 {\n+          debug a => _1;                   // in scope 1 at $DIR/mutable_variable_unprop_assign.rs:5:9: 5:10\n+          let mut _2: (i32, i32) as UserTypeProjection { base: UserType(0), projs: [] }; // in scope 1 at $DIR/mutable_variable_unprop_assign.rs:6:9: 6:14\n+          scope 2 {\n+              debug x => _2;               // in scope 2 at $DIR/mutable_variable_unprop_assign.rs:6:9: 6:14\n+              let _4: i32;                 // in scope 2 at $DIR/mutable_variable_unprop_assign.rs:8:9: 8:10\n+              scope 3 {\n+                  debug y => _4;           // in scope 3 at $DIR/mutable_variable_unprop_assign.rs:8:9: 8:10\n+                  let _5: i32;             // in scope 3 at $DIR/mutable_variable_unprop_assign.rs:9:9: 9:10\n+                  scope 4 {\n+                      debug z => _5;       // in scope 4 at $DIR/mutable_variable_unprop_assign.rs:9:9: 9:10\n+                  }\n+              }\n+          }\n+      }\n+  \n+      bb0: {\n+          StorageLive(_1);                 // scope 0 at $DIR/mutable_variable_unprop_assign.rs:5:9: 5:10\n+          _1 = const foo() -> bb1;         // scope 0 at $DIR/mutable_variable_unprop_assign.rs:5:13: 5:18\n+                                           // ty::Const\n+                                           // + ty: fn() -> i32 {foo}\n+                                           // + val: Value(Scalar(<ZST>))\n+                                           // mir::Constant\n+                                           // + span: $DIR/mutable_variable_unprop_assign.rs:5:13: 5:16\n+                                           // + literal: Const { ty: fn() -> i32 {foo}, val: Value(Scalar(<ZST>)) }\n+      }\n+  \n+      bb1: {\n+          StorageLive(_2);                 // scope 1 at $DIR/mutable_variable_unprop_assign.rs:6:9: 6:14\n+          _2 = (const 1i32, const 2i32);   // scope 1 at $DIR/mutable_variable_unprop_assign.rs:6:29: 6:35\n+                                           // ty::Const\n+                                           // + ty: i32\n+                                           // + val: Value(Scalar(0x00000001))\n+                                           // mir::Constant\n+-                                          // + span: $DIR/mutable_variable_unprop_assign.rs:6:30: 6:31\n++                                          // + span: $DIR/mutable_variable_unprop_assign.rs:6:29: 6:35\n+                                           // + literal: Const { ty: i32, val: Value(Scalar(0x00000001)) }\n+                                           // ty::Const\n+                                           // + ty: i32\n+                                           // + val: Value(Scalar(0x00000002))\n+                                           // mir::Constant\n+-                                          // + span: $DIR/mutable_variable_unprop_assign.rs:6:33: 6:34\n++                                          // + span: $DIR/mutable_variable_unprop_assign.rs:6:29: 6:35\n+                                           // + literal: Const { ty: i32, val: Value(Scalar(0x00000002)) }\n+          StorageLive(_3);                 // scope 2 at $DIR/mutable_variable_unprop_assign.rs:7:11: 7:12\n+          _3 = _1;                         // scope 2 at $DIR/mutable_variable_unprop_assign.rs:7:11: 7:12\n+          (_2.1: i32) = move _3;           // scope 2 at $DIR/mutable_variable_unprop_assign.rs:7:5: 7:12\n+          StorageDead(_3);                 // scope 2 at $DIR/mutable_variable_unprop_assign.rs:7:11: 7:12\n+          StorageLive(_4);                 // scope 2 at $DIR/mutable_variable_unprop_assign.rs:8:9: 8:10\n+          _4 = (_2.1: i32);                // scope 2 at $DIR/mutable_variable_unprop_assign.rs:8:13: 8:16\n+          StorageLive(_5);                 // scope 3 at $DIR/mutable_variable_unprop_assign.rs:9:9: 9:10\n+          _5 = (_2.0: i32);                // scope 3 at $DIR/mutable_variable_unprop_assign.rs:9:13: 9:16\n+          _0 = const ();                   // scope 0 at $DIR/mutable_variable_unprop_assign.rs:4:11: 10:2\n+                                           // ty::Const\n+                                           // + ty: ()\n+                                           // + val: Value(Scalar(<ZST>))\n+                                           // mir::Constant\n+                                           // + span: $DIR/mutable_variable_unprop_assign.rs:4:11: 10:2\n+                                           // + literal: Const { ty: (), val: Value(Scalar(<ZST>)) }\n+          StorageDead(_5);                 // scope 3 at $DIR/mutable_variable_unprop_assign.rs:10:1: 10:2\n+          StorageDead(_4);                 // scope 2 at $DIR/mutable_variable_unprop_assign.rs:10:1: 10:2\n+          StorageDead(_2);                 // scope 1 at $DIR/mutable_variable_unprop_assign.rs:10:1: 10:2\n+          StorageDead(_1);                 // scope 0 at $DIR/mutable_variable_unprop_assign.rs:10:1: 10:2\n+          return;                          // scope 0 at $DIR/mutable_variable_unprop_assign.rs:10:2: 10:2\n+      }\n+  }\n+  "}]}