{"sha": "0d4a19c0d113cde4c6cd6baaf6c48efed0113a58", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBkNGExOWMwZDExM2NkZTRjNmNkNmJhYWY2YzQ4ZWZlZDAxMTNhNTg=", "commit": {"author": {"name": "John K\u00e5re Alsaker", "email": "john.kare.alsaker@gmail.com", "date": "2019-02-01T22:28:14Z"}, "committer": {"name": "John K\u00e5re Alsaker", "email": "john.kare.alsaker@gmail.com", "date": "2019-03-10T10:10:05Z"}, "message": "Use the new rustc interface", "tree": {"sha": "ad04e181215d0d6f915bebe7b8f2dcae8e2e66ec", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ad04e181215d0d6f915bebe7b8f2dcae8e2e66ec"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0d4a19c0d113cde4c6cd6baaf6c48efed0113a58", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0d4a19c0d113cde4c6cd6baaf6c48efed0113a58", "html_url": "https://github.com/rust-lang/rust/commit/0d4a19c0d113cde4c6cd6baaf6c48efed0113a58", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0d4a19c0d113cde4c6cd6baaf6c48efed0113a58/comments", "author": {"login": "Zoxc", "id": 25784, "node_id": "MDQ6VXNlcjI1Nzg0", "avatar_url": "https://avatars.githubusercontent.com/u/25784?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Zoxc", "html_url": "https://github.com/Zoxc", "followers_url": "https://api.github.com/users/Zoxc/followers", "following_url": "https://api.github.com/users/Zoxc/following{/other_user}", "gists_url": "https://api.github.com/users/Zoxc/gists{/gist_id}", "starred_url": "https://api.github.com/users/Zoxc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Zoxc/subscriptions", "organizations_url": "https://api.github.com/users/Zoxc/orgs", "repos_url": "https://api.github.com/users/Zoxc/repos", "events_url": "https://api.github.com/users/Zoxc/events{/privacy}", "received_events_url": "https://api.github.com/users/Zoxc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Zoxc", "id": 25784, "node_id": "MDQ6VXNlcjI1Nzg0", "avatar_url": "https://avatars.githubusercontent.com/u/25784?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Zoxc", "html_url": "https://github.com/Zoxc", "followers_url": "https://api.github.com/users/Zoxc/followers", "following_url": "https://api.github.com/users/Zoxc/following{/other_user}", "gists_url": "https://api.github.com/users/Zoxc/gists{/gist_id}", "starred_url": "https://api.github.com/users/Zoxc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Zoxc/subscriptions", "organizations_url": "https://api.github.com/users/Zoxc/orgs", "repos_url": "https://api.github.com/users/Zoxc/repos", "events_url": "https://api.github.com/users/Zoxc/events{/privacy}", "received_events_url": "https://api.github.com/users/Zoxc/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9308df75076ae6f1617e09abddafd12ca9d28abb", "url": "https://api.github.com/repos/rust-lang/rust/commits/9308df75076ae6f1617e09abddafd12ca9d28abb", "html_url": "https://github.com/rust-lang/rust/commit/9308df75076ae6f1617e09abddafd12ca9d28abb"}], "stats": {"total": 116, "additions": 61, "deletions": 55}, "files": [{"sha": "1430ba70fbee9d7ca0a393eb844ed5b445218b21", "filename": "src/driver.rs", "status": "modified", "additions": 61, "deletions": 55, "changes": 116, "blob_url": "https://github.com/rust-lang/rust/blob/0d4a19c0d113cde4c6cd6baaf6c48efed0113a58/src%2Fdriver.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0d4a19c0d113cde4c6cd6baaf6c48efed0113a58/src%2Fdriver.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdriver.rs?ref=0d4a19c0d113cde4c6cd6baaf6c48efed0113a58", "patch": "@@ -9,9 +9,10 @@\n extern crate rustc_driver;\n #[allow(unused_extern_crates)]\n extern crate rustc_plugin;\n-use self::rustc_driver::{driver::CompileController, Compilation};\n+#[allow(unused_extern_crates)]\n+extern crate rustc_interface;\n \n-use std::convert::TryInto;\n+use rustc_interface::interface;\n use std::path::Path;\n use std::process::{exit, Command};\n \n@@ -60,10 +61,58 @@ fn test_arg_value() {\n }\n \n #[allow(clippy::too_many_lines)]\n+\n+struct ClippyCallbacks;\n+\n+impl rustc_driver::Callbacks for ClippyCallbacks {\n+    fn after_parsing(&mut self, compiler: &interface::Compiler) -> bool {\n+        let sess = compiler.session();\n+        let mut registry = rustc_plugin::registry::Registry::new(\n+            sess,\n+            compiler.parse().expect(\n+                \"at this compilation stage \\\n+                    the crate must be parsed\",\n+            ).peek().span,\n+        );\n+        registry.args_hidden = Some(Vec::new());\n+\n+        let conf = clippy_lints::read_conf(&registry);\n+        clippy_lints::register_plugins(&mut registry, &conf);\n+\n+        let rustc_plugin::registry::Registry {\n+            early_lint_passes,\n+            late_lint_passes,\n+            lint_groups,\n+            llvm_passes,\n+            attributes,\n+            ..\n+        } = registry;\n+        let mut ls = sess.lint_store.borrow_mut();\n+        for pass in early_lint_passes {\n+            ls.register_early_pass(Some(sess), true, false, pass);\n+        }\n+        for pass in late_lint_passes {\n+            ls.register_late_pass(Some(sess), true, pass);\n+        }\n+\n+        for (name, (to, deprecated_name)) in lint_groups {\n+            ls.register_group(Some(sess), true, name, deprecated_name, to);\n+        }\n+        clippy_lints::register_pre_expansion_lints(sess, &mut ls, &conf);\n+        clippy_lints::register_renamed(&mut ls);\n+\n+        sess.plugin_llvm_passes.borrow_mut().extend(llvm_passes);\n+        sess.plugin_attributes.borrow_mut().extend(attributes);\n+\n+        // Continue execution\n+        true\n+    }\n+}\n+\n pub fn main() {\n     rustc_driver::init_rustc_env_logger();\n     exit(\n-        rustc_driver::run(move || {\n+        rustc_driver::report_ices_to_stderr_if_any(move || {\n             use std::env;\n \n             if std::env::args().any(|a| a == \"--version\" || a == \"-V\") {\n@@ -144,58 +193,15 @@ pub fn main() {\n                 }\n             }\n \n-            let mut controller = CompileController::basic();\n-            if clippy_enabled {\n-                controller.after_parse.callback = Box::new(move |state| {\n-                    let mut registry = rustc_plugin::registry::Registry::new(\n-                        state.session,\n-                        state\n-                            .krate\n-                            .as_ref()\n-                            .expect(\n-                                \"at this compilation stage \\\n-                                 the crate must be parsed\",\n-                            )\n-                            .span,\n-                    );\n-                    registry.args_hidden = Some(Vec::new());\n-\n-                    let conf = clippy_lints::read_conf(&registry);\n-                    clippy_lints::register_plugins(&mut registry, &conf);\n-\n-                    let rustc_plugin::registry::Registry {\n-                        early_lint_passes,\n-                        late_lint_passes,\n-                        lint_groups,\n-                        llvm_passes,\n-                        attributes,\n-                        ..\n-                    } = registry;\n-                    let sess = &state.session;\n-                    let mut ls = sess.lint_store.borrow_mut();\n-                    for pass in early_lint_passes {\n-                        ls.register_early_pass(Some(sess), true, false, pass);\n-                    }\n-                    for pass in late_lint_passes {\n-                        ls.register_late_pass(Some(sess), true, pass);\n-                    }\n-\n-                    for (name, (to, deprecated_name)) in lint_groups {\n-                        ls.register_group(Some(sess), true, name, deprecated_name, to);\n-                    }\n-                    clippy_lints::register_pre_expansion_lints(sess, &mut ls, &conf);\n-                    clippy_lints::register_renamed(&mut ls);\n-\n-                    sess.plugin_llvm_passes.borrow_mut().extend(llvm_passes);\n-                    sess.plugin_attributes.borrow_mut().extend(attributes);\n-                });\n-            }\n-            controller.compilation_done.stop = Compilation::Stop;\n-\n+            let mut clippy = ClippyCallbacks;\n+            let mut default = rustc_driver::DefaultCallbacks;\n+            let callbacks: &mut (dyn rustc_driver::Callbacks + Send) = if clippy_enabled {\n+                &mut clippy\n+            } else {\n+                &mut default\n+            };\n             let args = args;\n-            rustc_driver::run_compiler(&args, Box::new(controller), None, None)\n-        })\n-        .try_into()\n-        .expect(\"exit code too large\"),\n+            rustc_driver::run_compiler(&args, callbacks, None, None)\n+        }).and_then(|result| result).is_err() as i32\n     )\n }"}]}