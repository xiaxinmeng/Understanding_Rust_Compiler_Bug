{"sha": "79061d0e02f70ecbf3333057eac36dcc6c4b1727", "node_id": "MDY6Q29tbWl0NzI0NzEyOjc5MDYxZDBlMDJmNzBlY2JmMzMzMzA1N2VhYzM2ZGNjNmM0YjE3Mjc=", "commit": {"author": {"name": "Oliver Middleton", "email": "olliemail27@gmail.com", "date": "2020-01-17T23:44:44Z"}, "committer": {"name": "Oliver Middleton", "email": "olliemail27@gmail.com", "date": "2020-01-17T23:44:44Z"}, "message": "rustdoc: Catch fatal errors when syntax highlighting\n\nFor some errors the lexer will unwind so we need to handle that in addition to handling `token::Unknown`.", "tree": {"sha": "0f1265828c4af8564a78159a2ff2acee54a655c0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0f1265828c4af8564a78159a2ff2acee54a655c0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/79061d0e02f70ecbf3333057eac36dcc6c4b1727", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/79061d0e02f70ecbf3333057eac36dcc6c4b1727", "html_url": "https://github.com/rust-lang/rust/commit/79061d0e02f70ecbf3333057eac36dcc6c4b1727", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/79061d0e02f70ecbf3333057eac36dcc6c4b1727/comments", "author": {"login": "ollie27", "id": 7189418, "node_id": "MDQ6VXNlcjcxODk0MTg=", "avatar_url": "https://avatars.githubusercontent.com/u/7189418?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ollie27", "html_url": "https://github.com/ollie27", "followers_url": "https://api.github.com/users/ollie27/followers", "following_url": "https://api.github.com/users/ollie27/following{/other_user}", "gists_url": "https://api.github.com/users/ollie27/gists{/gist_id}", "starred_url": "https://api.github.com/users/ollie27/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ollie27/subscriptions", "organizations_url": "https://api.github.com/users/ollie27/orgs", "repos_url": "https://api.github.com/users/ollie27/repos", "events_url": "https://api.github.com/users/ollie27/events{/privacy}", "received_events_url": "https://api.github.com/users/ollie27/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ollie27", "id": 7189418, "node_id": "MDQ6VXNlcjcxODk0MTg=", "avatar_url": "https://avatars.githubusercontent.com/u/7189418?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ollie27", "html_url": "https://github.com/ollie27", "followers_url": "https://api.github.com/users/ollie27/followers", "following_url": "https://api.github.com/users/ollie27/following{/other_user}", "gists_url": "https://api.github.com/users/ollie27/gists{/gist_id}", "starred_url": "https://api.github.com/users/ollie27/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ollie27/subscriptions", "organizations_url": "https://api.github.com/users/ollie27/orgs", "repos_url": "https://api.github.com/users/ollie27/repos", "events_url": "https://api.github.com/users/ollie27/events{/privacy}", "received_events_url": "https://api.github.com/users/ollie27/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "689fca01c5a1eac2d240bf08aa728171a28f2285", "url": "https://api.github.com/repos/rust-lang/rust/commits/689fca01c5a1eac2d240bf08aa728171a28f2285", "html_url": "https://github.com/rust-lang/rust/commit/689fca01c5a1eac2d240bf08aa728171a28f2285"}], "stats": {"total": 38, "additions": 34, "deletions": 4}, "files": [{"sha": "5bea1b56141591d90ee7e386d5f579ea0a40249e", "filename": "src/librustdoc/html/highlight.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/79061d0e02f70ecbf3333057eac36dcc6c4b1727/src%2Flibrustdoc%2Fhtml%2Fhighlight.rs", "raw_url": "https://github.com/rust-lang/rust/raw/79061d0e02f70ecbf3333057eac36dcc6c4b1727/src%2Flibrustdoc%2Fhtml%2Fhighlight.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fhighlight.rs?ref=79061d0e02f70ecbf3333057eac36dcc6c4b1727", "patch": "@@ -41,7 +41,7 @@ pub fn render_with_highlighting(\n     let fm = sess\n         .source_map()\n         .new_source_file(FileName::Custom(String::from(\"rustdoc-highlighting\")), src.to_owned());\n-    let highlight_result = {\n+    let highlight_result = rustc_driver::catch_fatal_errors(|| {\n         let lexer = lexer::StringReader::new(&sess, fm, None);\n         let mut classifier = Classifier::new(lexer, sess.source_map());\n \n@@ -51,7 +51,8 @@ pub fn render_with_highlighting(\n         } else {\n             Ok(String::from_utf8_lossy(&highlighted_source).into_owned())\n         }\n-    };\n+    })\n+    .unwrap_or(Err(()));\n \n     match highlight_result {\n         Ok(highlighted_source) => {"}, {"sha": "2903fd9dcd6602734033bcddf2ecf4b3cb860a62", "filename": "src/librustdoc/passes/check_code_block_syntax.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/79061d0e02f70ecbf3333057eac36dcc6c4b1727/src%2Flibrustdoc%2Fpasses%2Fcheck_code_block_syntax.rs", "raw_url": "https://github.com/rust-lang/rust/raw/79061d0e02f70ecbf3333057eac36dcc6c4b1727/src%2Flibrustdoc%2Fpasses%2Fcheck_code_block_syntax.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fcheck_code_block_syntax.rs?ref=79061d0e02f70ecbf3333057eac36dcc6c4b1727", "patch": "@@ -40,7 +40,7 @@ impl<'a, 'tcx> SyntaxChecker<'a, 'tcx> {\n             dox[code_block.code].to_owned(),\n         );\n \n-        let validation_status = {\n+        let validation_status = rustc_driver::catch_fatal_errors(|| {\n             let mut has_syntax_errors = false;\n             let mut only_whitespace = true;\n             // even if there is a syntax error, we need to run the lexer over the whole file\n@@ -61,7 +61,8 @@ impl<'a, 'tcx> SyntaxChecker<'a, 'tcx> {\n             } else {\n                 None\n             }\n-        };\n+        })\n+        .unwrap_or(Some(CodeBlockInvalid::SyntaxError));\n \n         if let Some(code_block_invalid) = validation_status {\n             let mut diag = if let Some(sp) ="}, {"sha": "72037dd74be355d9d0ada09fbff99b0774fd15d3", "filename": "src/test/rustdoc-ui/invalid-syntax.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/79061d0e02f70ecbf3333057eac36dcc6c4b1727/src%2Ftest%2Frustdoc-ui%2Finvalid-syntax.rs", "raw_url": "https://github.com/rust-lang/rust/raw/79061d0e02f70ecbf3333057eac36dcc6c4b1727/src%2Ftest%2Frustdoc-ui%2Finvalid-syntax.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Finvalid-syntax.rs?ref=79061d0e02f70ecbf3333057eac36dcc6c4b1727", "patch": "@@ -93,3 +93,9 @@ pub fn empty_rust_with_whitespace() {}\n ///\n pub fn indent_after_fenced() {}\n //~^^^ WARNING could not parse code block as Rust code\n+\n+/// ```\n+/// \"invalid\n+/// ```\n+pub fn invalid() {}\n+//~^^^^ WARNING could not parse code block as Rust code"}, {"sha": "a90d3bbb979f66ad7edf09e2f2b24bb91af954c6", "filename": "src/test/rustdoc-ui/invalid-syntax.stderr", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/79061d0e02f70ecbf3333057eac36dcc6c4b1727/src%2Ftest%2Frustdoc-ui%2Finvalid-syntax.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/79061d0e02f70ecbf3333057eac36dcc6c4b1727/src%2Ftest%2Frustdoc-ui%2Finvalid-syntax.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Finvalid-syntax.stderr?ref=79061d0e02f70ecbf3333057eac36dcc6c4b1727", "patch": "@@ -132,3 +132,18 @@ LL | ///     \\____/\n    |\n    = note: error from rustc: unknown start of token: \\\n \n+warning: could not parse code block as Rust code\n+  --> $DIR/invalid-syntax.rs:97:5\n+   |\n+LL |   /// ```\n+   |  _____^\n+LL | | /// \"invalid\n+LL | | /// ```\n+   | |_______^\n+   |\n+   = note: error from rustc: unterminated double quote string\n+help: mark blocks that do not contain Rust code as text\n+   |\n+LL | /// ```text\n+   |     ^^^^^^^\n+"}, {"sha": "afef86ec9c77f265f481bb0d6d73accece4a4664", "filename": "src/test/rustdoc/bad-codeblock-syntax.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/79061d0e02f70ecbf3333057eac36dcc6c4b1727/src%2Ftest%2Frustdoc%2Fbad-codeblock-syntax.rs", "raw_url": "https://github.com/rust-lang/rust/raw/79061d0e02f70ecbf3333057eac36dcc6c4b1727/src%2Ftest%2Frustdoc%2Fbad-codeblock-syntax.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fbad-codeblock-syntax.rs?ref=79061d0e02f70ecbf3333057eac36dcc6c4b1727", "patch": "@@ -33,3 +33,10 @@ pub fn ok() {}\n /// <script>alert(\"not valid Rust\");</script>\n /// ```\n pub fn escape() {}\n+\n+// @has bad_codeblock_syntax/fn.unterminated.html\n+// @has - '//*[@class=\"docblock\"]/pre/code' '\"unterminated'\n+/// ```\n+/// \"unterminated\n+/// ```\n+pub fn unterminated() {}"}]}