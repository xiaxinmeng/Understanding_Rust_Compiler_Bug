{"sha": "4946ee7c8fd9a6b5b7e506373950cac57a4e8015", "node_id": "C_kwDOAAsO6NoAKDQ5NDZlZTdjOGZkOWE2YjViN2U1MDYzNzM5NTBjYWM1N2E0ZTgwMTU", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2022-11-08T05:53:51Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-11-08T05:53:51Z"}, "message": "Rollup merge of #103651 - Alexendoo:parse-format-unicode-escapes, r=wesleywiser\n\nFix `rustc_parse_format` spans following escaped utf-8 multibyte chars\n\nCurrently too many skips are created for char escapes that are larger than 1 byte when encoded in UTF-8, [playground:](https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&gist=c77a9dc669b69b167271b59ed2c8d88c)\n\n```rust\nfn main() {\n    format!(\"\\u{df}{a}\");\n    format!(\"\\u{211d}{a}\");\n    format!(\"\\u{1f4a3}{a}\");\n}\n```\n```\nerror[[E0425]](https://doc.rust-lang.org/stable/error-index.html#E0425): cannot find value `a` in this scope\n --> src/main.rs:2:22\n  |\n2 |     format!(\"\\u{df}{a}\");\n  |                      ^ not found in this scope\n\nerror[[E0425]](https://doc.rust-lang.org/stable/error-index.html#E0425): cannot find value `a` in this scope\n --> src/main.rs:3:25\n  |\n3 |     format!(\"\\u{211d}{a}\");\n  |                         ^ not found in this scope\n\nerror[[E0425]](https://doc.rust-lang.org/stable/error-index.html#E0425): cannot find value `a` in this scope\n --> src/main.rs:4:27\n  |\n4 |     format!(\"\\u{1f4a3}{a}\");\n  |                           ^ not found in this scope\n```\n\nThis reduces the number of skips to account for that\n\nFixes https://github.com/rust-lang/rust-clippy/issues/9727", "tree": {"sha": "7fed610bfab0aebbd6df7c16f391be76c9fbb502", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7fed610bfab0aebbd6df7c16f391be76c9fbb502"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4946ee7c8fd9a6b5b7e506373950cac57a4e8015", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjae7vCRBK7hj4Ov3rIwAAGEoIAJujCU9bWmN+dXz6rBBwUPvw\ndonAZjbupzwK3niPX17AjWJLywRPalRIHpjrqSU0MT3pMMb0OhXm3ikOztgWGsUP\nD8T5mczJYRzePanhemh0S9tgV+1I9BL3n6rvXxfbjFvL4gbKRuIdYwwNOoTKKEAw\n/bOqiH0E0DGs92s3BE8zIFmIW4wzj4hTTBP2g7gXYCMoeeDt+iB06j0ytlmpCmrn\nJs3liD92Ah8kopt8kcxOuFYnX1i0XcI8o2KAJwddbyPyDQUIhzlXh5zS8Zkufv3j\nn4e3SD+/jwdjggbnNNmUoYQdiwxIYBgJuzTUxfHDowjaQuN7mCVAsehaU139vvM=\n=dBjN\n-----END PGP SIGNATURE-----\n", "payload": "tree 7fed610bfab0aebbd6df7c16f391be76c9fbb502\nparent b695ed3f2032d349a5cb9f26a8df67936943c075\nparent f5e390e8631a759579674b0899087a51bb073dd3\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1667886831 +0530\ncommitter GitHub <noreply@github.com> 1667886831 +0530\n\nRollup merge of #103651 - Alexendoo:parse-format-unicode-escapes, r=wesleywiser\n\nFix `rustc_parse_format` spans following escaped utf-8 multibyte chars\n\nCurrently too many skips are created for char escapes that are larger than 1 byte when encoded in UTF-8, [playground:](https://play.rust-lang.org/?version=stable&mode=debug&edition=2021&gist=c77a9dc669b69b167271b59ed2c8d88c)\n\n```rust\nfn main() {\n    format!(\"\\u{df}{a}\");\n    format!(\"\\u{211d}{a}\");\n    format!(\"\\u{1f4a3}{a}\");\n}\n```\n```\nerror[[E0425]](https://doc.rust-lang.org/stable/error-index.html#E0425): cannot find value `a` in this scope\n --> src/main.rs:2:22\n  |\n2 |     format!(\"\\u{df}{a}\");\n  |                      ^ not found in this scope\n\nerror[[E0425]](https://doc.rust-lang.org/stable/error-index.html#E0425): cannot find value `a` in this scope\n --> src/main.rs:3:25\n  |\n3 |     format!(\"\\u{211d}{a}\");\n  |                         ^ not found in this scope\n\nerror[[E0425]](https://doc.rust-lang.org/stable/error-index.html#E0425): cannot find value `a` in this scope\n --> src/main.rs:4:27\n  |\n4 |     format!(\"\\u{1f4a3}{a}\");\n  |                           ^ not found in this scope\n```\n\nThis reduces the number of skips to account for that\n\nFixes https://github.com/rust-lang/rust-clippy/issues/9727\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4946ee7c8fd9a6b5b7e506373950cac57a4e8015", "html_url": "https://github.com/rust-lang/rust/commit/4946ee7c8fd9a6b5b7e506373950cac57a4e8015", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4946ee7c8fd9a6b5b7e506373950cac57a4e8015/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b695ed3f2032d349a5cb9f26a8df67936943c075", "url": "https://api.github.com/repos/rust-lang/rust/commits/b695ed3f2032d349a5cb9f26a8df67936943c075", "html_url": "https://github.com/rust-lang/rust/commit/b695ed3f2032d349a5cb9f26a8df67936943c075"}, {"sha": "f5e390e8631a759579674b0899087a51bb073dd3", "url": "https://api.github.com/repos/rust-lang/rust/commits/f5e390e8631a759579674b0899087a51bb073dd3", "html_url": "https://github.com/rust-lang/rust/commit/f5e390e8631a759579674b0899087a51bb073dd3"}], "stats": {"total": 129, "additions": 111, "deletions": 18}, "files": [{"sha": "54bf4d1d6b7381469d276d77b0ee66afa1663963", "filename": "compiler/rustc_parse_format/src/lib.rs", "status": "modified", "additions": 29, "deletions": 18, "changes": 47, "blob_url": "https://github.com/rust-lang/rust/blob/4946ee7c8fd9a6b5b7e506373950cac57a4e8015/compiler%2Frustc_parse_format%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4946ee7c8fd9a6b5b7e506373950cac57a4e8015/compiler%2Frustc_parse_format%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_parse_format%2Fsrc%2Flib.rs?ref=4946ee7c8fd9a6b5b7e506373950cac57a4e8015", "patch": "@@ -819,27 +819,27 @@ fn find_skips_from_snippet(\n     };\n \n     fn find_skips(snippet: &str, is_raw: bool) -> Vec<usize> {\n-        let mut s = snippet.char_indices().peekable();\n+        let mut s = snippet.char_indices();\n         let mut skips = vec![];\n         while let Some((pos, c)) = s.next() {\n-            match (c, s.peek()) {\n+            match (c, s.clone().next()) {\n                 // skip whitespace and empty lines ending in '\\\\'\n                 ('\\\\', Some((next_pos, '\\n'))) if !is_raw => {\n                     skips.push(pos);\n-                    skips.push(*next_pos);\n+                    skips.push(next_pos);\n                     let _ = s.next();\n \n-                    while let Some((pos, c)) = s.peek() {\n+                    while let Some((pos, c)) = s.clone().next() {\n                         if matches!(c, ' ' | '\\n' | '\\t') {\n-                            skips.push(*pos);\n+                            skips.push(pos);\n                             let _ = s.next();\n                         } else {\n                             break;\n                         }\n                     }\n                 }\n                 ('\\\\', Some((next_pos, 'n' | 't' | 'r' | '0' | '\\\\' | '\\'' | '\\\"'))) => {\n-                    skips.push(*next_pos);\n+                    skips.push(next_pos);\n                     let _ = s.next();\n                 }\n                 ('\\\\', Some((_, 'x'))) if !is_raw => {\n@@ -858,19 +858,30 @@ fn find_skips_from_snippet(\n                     }\n                     if let Some((next_pos, next_c)) = s.next() {\n                         if next_c == '{' {\n-                            skips.push(next_pos);\n-                            let mut i = 0; // consume up to 6 hexanumeric chars + closing `}`\n-                            while let (Some((next_pos, c)), true) = (s.next(), i < 7) {\n-                                if c.is_digit(16) {\n-                                    skips.push(next_pos);\n-                                } else if c == '}' {\n-                                    skips.push(next_pos);\n-                                    break;\n-                                } else {\n-                                    break;\n-                                }\n-                                i += 1;\n+                            // consume up to 6 hexanumeric chars\n+                            let digits_len =\n+                                s.clone().take(6).take_while(|(_, c)| c.is_digit(16)).count();\n+\n+                            let len_utf8 = s\n+                                .as_str()\n+                                .get(..digits_len)\n+                                .and_then(|digits| u32::from_str_radix(digits, 16).ok())\n+                                .and_then(char::from_u32)\n+                                .map_or(1, char::len_utf8);\n+\n+                            // Skip the digits, for chars that encode to more than 1 utf-8 byte\n+                            // exclude as many digits as it is greater than 1 byte\n+                            //\n+                            // So for a 3 byte character, exclude 2 digits\n+                            let required_skips =\n+                                digits_len.saturating_sub(len_utf8.saturating_sub(1));\n+\n+                            // skip '{' and '}' also\n+                            for pos in (next_pos..).take(required_skips + 2) {\n+                                skips.push(pos)\n                             }\n+\n+                            s.nth(digits_len);\n                         } else if next_c.is_digit(16) {\n                             skips.push(next_pos);\n                             // We suggest adding `{` and `}` when appropriate, accept it here as if"}, {"sha": "753d91ce58e6619a98687aea49be80c36d50e26e", "filename": "src/test/ui/fmt/unicode-escape-spans.rs", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/4946ee7c8fd9a6b5b7e506373950cac57a4e8015/src%2Ftest%2Fui%2Ffmt%2Funicode-escape-spans.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4946ee7c8fd9a6b5b7e506373950cac57a4e8015/src%2Ftest%2Fui%2Ffmt%2Funicode-escape-spans.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffmt%2Funicode-escape-spans.rs?ref=4946ee7c8fd9a6b5b7e506373950cac57a4e8015", "patch": "@@ -0,0 +1,19 @@\n+fn main() {\n+    // 1 byte in UTF-8\n+    format!(\"\\u{000041}{a}\"); //~ ERROR cannot find value\n+    format!(\"\\u{0041}{a}\"); //~ ERROR cannot find value\n+    format!(\"\\u{41}{a}\"); //~ ERROR cannot find value\n+    format!(\"\\u{0}{a}\"); //~ ERROR cannot find value\n+\n+    // 2 bytes\n+    format!(\"\\u{0df}{a}\"); //~ ERROR cannot find value\n+    format!(\"\\u{df}{a}\"); //~ ERROR cannot find value\n+\n+    // 3 bytes\n+    format!(\"\\u{00211d}{a}\"); //~ ERROR cannot find value\n+    format!(\"\\u{211d}{a}\"); //~ ERROR cannot find value\n+\n+    // 4 bytes\n+    format!(\"\\u{1f4a3}{a}\"); //~ ERROR cannot find value\n+    format!(\"\\u{10ffff}{a}\"); //~ ERROR cannot find value\n+}"}, {"sha": "1d8473f01b822af6e5d0df044463726e7e2c7e60", "filename": "src/test/ui/fmt/unicode-escape-spans.stderr", "status": "added", "additions": 63, "deletions": 0, "changes": 63, "blob_url": "https://github.com/rust-lang/rust/blob/4946ee7c8fd9a6b5b7e506373950cac57a4e8015/src%2Ftest%2Fui%2Ffmt%2Funicode-escape-spans.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/4946ee7c8fd9a6b5b7e506373950cac57a4e8015/src%2Ftest%2Fui%2Ffmt%2Funicode-escape-spans.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ffmt%2Funicode-escape-spans.stderr?ref=4946ee7c8fd9a6b5b7e506373950cac57a4e8015", "patch": "@@ -0,0 +1,63 @@\n+error[E0425]: cannot find value `a` in this scope\n+  --> $DIR/unicode-escape-spans.rs:3:25\n+   |\n+LL |     format!(\"\\u{000041}{a}\");\n+   |                         ^ not found in this scope\n+\n+error[E0425]: cannot find value `a` in this scope\n+  --> $DIR/unicode-escape-spans.rs:4:23\n+   |\n+LL |     format!(\"\\u{0041}{a}\");\n+   |                       ^ not found in this scope\n+\n+error[E0425]: cannot find value `a` in this scope\n+  --> $DIR/unicode-escape-spans.rs:5:21\n+   |\n+LL |     format!(\"\\u{41}{a}\");\n+   |                     ^ not found in this scope\n+\n+error[E0425]: cannot find value `a` in this scope\n+  --> $DIR/unicode-escape-spans.rs:6:20\n+   |\n+LL |     format!(\"\\u{0}{a}\");\n+   |                    ^ not found in this scope\n+\n+error[E0425]: cannot find value `a` in this scope\n+  --> $DIR/unicode-escape-spans.rs:9:22\n+   |\n+LL |     format!(\"\\u{0df}{a}\");\n+   |                      ^ not found in this scope\n+\n+error[E0425]: cannot find value `a` in this scope\n+  --> $DIR/unicode-escape-spans.rs:10:21\n+   |\n+LL |     format!(\"\\u{df}{a}\");\n+   |                     ^ not found in this scope\n+\n+error[E0425]: cannot find value `a` in this scope\n+  --> $DIR/unicode-escape-spans.rs:13:25\n+   |\n+LL |     format!(\"\\u{00211d}{a}\");\n+   |                         ^ not found in this scope\n+\n+error[E0425]: cannot find value `a` in this scope\n+  --> $DIR/unicode-escape-spans.rs:14:23\n+   |\n+LL |     format!(\"\\u{211d}{a}\");\n+   |                       ^ not found in this scope\n+\n+error[E0425]: cannot find value `a` in this scope\n+  --> $DIR/unicode-escape-spans.rs:17:24\n+   |\n+LL |     format!(\"\\u{1f4a3}{a}\");\n+   |                        ^ not found in this scope\n+\n+error[E0425]: cannot find value `a` in this scope\n+  --> $DIR/unicode-escape-spans.rs:18:25\n+   |\n+LL |     format!(\"\\u{10ffff}{a}\");\n+   |                         ^ not found in this scope\n+\n+error: aborting due to 10 previous errors\n+\n+For more information about this error, try `rustc --explain E0425`."}]}