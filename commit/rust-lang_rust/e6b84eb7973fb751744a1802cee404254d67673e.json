{"sha": "e6b84eb7973fb751744a1802cee404254d67673e", "node_id": "C_kwDOAAsO6NoAKGU2Yjg0ZWI3OTczZmI3NTE3NDRhMTgwMmNlZTQwNDI1NGQ2NzY3M2U", "commit": {"author": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2023-01-07T22:17:00Z"}, "committer": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2023-02-02T16:26:01Z"}, "message": "Suggest `move` in nested closure when appropriate\n\nFix #64008.", "tree": {"sha": "55d9b2fe5af107bad01501400209a38edbda91a2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/55d9b2fe5af107bad01501400209a38edbda91a2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e6b84eb7973fb751744a1802cee404254d67673e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e6b84eb7973fb751744a1802cee404254d67673e", "html_url": "https://github.com/rust-lang/rust/commit/e6b84eb7973fb751744a1802cee404254d67673e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e6b84eb7973fb751744a1802cee404254d67673e/comments", "author": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "committer": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "97872b792c9dd6a9bc5c3f4e62a0bd5958b09cdc", "url": "https://api.github.com/repos/rust-lang/rust/commits/97872b792c9dd6a9bc5c3f4e62a0bd5958b09cdc", "html_url": "https://github.com/rust-lang/rust/commit/97872b792c9dd6a9bc5c3f4e62a0bd5958b09cdc"}], "stats": {"total": 119, "additions": 98, "deletions": 21}, "files": [{"sha": "7901a5046abad12a466cf045b9591d4fe618f5f1", "filename": "compiler/rustc_borrowck/src/diagnostics/region_errors.rs", "status": "modified", "additions": 12, "deletions": 16, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/e6b84eb7973fb751744a1802cee404254d67673e/compiler%2Frustc_borrowck%2Fsrc%2Fdiagnostics%2Fregion_errors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e6b84eb7973fb751744a1802cee404254d67673e/compiler%2Frustc_borrowck%2Fsrc%2Fdiagnostics%2Fregion_errors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_borrowck%2Fsrc%2Fdiagnostics%2Fregion_errors.rs?ref=e6b84eb7973fb751744a1802cee404254d67673e", "patch": "@@ -583,10 +583,12 @@ impl<'a, 'tcx> MirBorrowckCtxt<'a, 'tcx> {\n         let err = FnMutError {\n             span: *span,\n             ty_err: match output_ty.kind() {\n-                ty::Closure(_, _) => FnMutReturnTypeErr::ReturnClosure { span: *span },\n                 ty::Generator(def, ..) if self.infcx.tcx.generator_is_async(*def) => {\n                     FnMutReturnTypeErr::ReturnAsyncBlock { span: *span }\n                 }\n+                _ if output_ty.contains_closure() => {\n+                    FnMutReturnTypeErr::ReturnClosure { span: *span }\n+                }\n                 _ => FnMutReturnTypeErr::ReturnRef { span: *span },\n             },\n         };\n@@ -997,7 +999,7 @@ impl<'a, 'tcx> MirBorrowckCtxt<'a, 'tcx> {\n     fn suggest_move_on_borrowing_closure(&self, diag: &mut Diagnostic) {\n         let map = self.infcx.tcx.hir();\n         let body_id = map.body_owned_by(self.mir_def_id());\n-        let expr = &map.body(body_id).value;\n+        let expr = &map.body(body_id).value.peel_blocks();\n         let mut closure_span = None::<rustc_span::Span>;\n         match expr.kind {\n             hir::ExprKind::MethodCall(.., args, _) => {\n@@ -1012,20 +1014,14 @@ impl<'a, 'tcx> MirBorrowckCtxt<'a, 'tcx> {\n                     }\n                 }\n             }\n-            hir::ExprKind::Block(blk, _) => {\n-                if let Some(expr) = blk.expr {\n-                    // only when the block is a closure\n-                    if let hir::ExprKind::Closure(hir::Closure {\n-                        capture_clause: hir::CaptureBy::Ref,\n-                        body,\n-                        ..\n-                    }) = expr.kind\n-                    {\n-                        let body = map.body(*body);\n-                        if !matches!(body.generator_kind, Some(hir::GeneratorKind::Async(..))) {\n-                            closure_span = Some(expr.span.shrink_to_lo());\n-                        }\n-                    }\n+            hir::ExprKind::Closure(hir::Closure {\n+                capture_clause: hir::CaptureBy::Ref,\n+                body,\n+                ..\n+            }) => {\n+                let body = map.body(*body);\n+                if !matches!(body.generator_kind, Some(hir::GeneratorKind::Async(..))) {\n+                    closure_span = Some(expr.span.shrink_to_lo());\n                 }\n             }\n             _ => {}"}, {"sha": "98d6b68356368c14e06717b05a5c4ccc72e05915", "filename": "compiler/rustc_middle/src/ty/sty.rs", "status": "modified", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/e6b84eb7973fb751744a1802cee404254d67673e/compiler%2Frustc_middle%2Fsrc%2Fty%2Fsty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e6b84eb7973fb751744a1802cee404254d67673e/compiler%2Frustc_middle%2Fsrc%2Fty%2Fsty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fsty.rs?ref=e6b84eb7973fb751744a1802cee404254d67673e", "patch": "@@ -2043,6 +2043,28 @@ impl<'tcx> Ty<'tcx> {\n         cf.is_break()\n     }\n \n+    /// Checks whether a type recursively contains any closure\n+    ///\n+    /// Example: `Option<[closure@file.rs:4:20]>` returns true\n+    pub fn contains_closure(self) -> bool {\n+        struct ContainsClosureVisitor;\n+\n+        impl<'tcx> TypeVisitor<'tcx> for ContainsClosureVisitor {\n+            type BreakTy = ();\n+\n+            fn visit_ty(&mut self, t: Ty<'tcx>) -> ControlFlow<Self::BreakTy> {\n+                if let ty::Closure(_, _) = t.kind() {\n+                    ControlFlow::Break(())\n+                } else {\n+                    t.super_visit_with(self)\n+                }\n+            }\n+        }\n+\n+        let cf = self.visit_with(&mut ContainsClosureVisitor);\n+        cf.is_break()\n+    }\n+\n     /// Returns the type and mutability of `*ty`.\n     ///\n     /// The parameter `explicit` indicates if this is an *explicit* dereference."}, {"sha": "1a08470064cd7470fe9f7e1d9ba9cf5b049ae920", "filename": "tests/ui/borrowck/issue-95079-missing-move-in-nested-closure.fixed", "status": "added", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/e6b84eb7973fb751744a1802cee404254d67673e/tests%2Fui%2Fborrowck%2Fissue-95079-missing-move-in-nested-closure.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/e6b84eb7973fb751744a1802cee404254d67673e/tests%2Fui%2Fborrowck%2Fissue-95079-missing-move-in-nested-closure.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fborrowck%2Fissue-95079-missing-move-in-nested-closure.fixed?ref=e6b84eb7973fb751744a1802cee404254d67673e", "patch": "@@ -0,0 +1,26 @@\n+// run-rustfix\n+#![allow(dead_code, path_statements)]\n+fn foo1(s: &str) -> impl Iterator<Item = String> + '_ {\n+    None.into_iter()\n+        .flat_map(move |()| s.chars().map(move |c| format!(\"{}{}\", c, s)))\n+        //~^ ERROR captured variable cannot escape `FnMut` closure body\n+        //~| HELP consider adding 'move' keyword before the nested closure\n+}\n+\n+fn foo2(s: &str) -> impl Sized + '_ {\n+    move |()| s.chars().map(move |c| format!(\"{}{}\", c, s))\n+    //~^ ERROR lifetime may not live long enough\n+    //~| HELP consider adding 'move' keyword before the nested closure\n+}\n+\n+pub struct X;\n+pub fn foo3<'a>(\n+    bar: &'a X,\n+) -> impl Iterator<Item = ()> + 'a {\n+    Some(()).iter().flat_map(move |()| {\n+        Some(()).iter().map(move |()| { bar; }) //~ ERROR captured variable cannot escape\n+        //~^ HELP consider adding 'move' keyword before the nested closure\n+    })\n+}\n+\n+fn main() {}"}, {"sha": "b93292e3589d371a67bad831dc716efc96ff59d0", "filename": "tests/ui/borrowck/issue-95079-missing-move-in-nested-closure.rs", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/e6b84eb7973fb751744a1802cee404254d67673e/tests%2Fui%2Fborrowck%2Fissue-95079-missing-move-in-nested-closure.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e6b84eb7973fb751744a1802cee404254d67673e/tests%2Fui%2Fborrowck%2Fissue-95079-missing-move-in-nested-closure.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fborrowck%2Fissue-95079-missing-move-in-nested-closure.rs?ref=e6b84eb7973fb751744a1802cee404254d67673e", "patch": "@@ -1,3 +1,5 @@\n+// run-rustfix\n+#![allow(dead_code, path_statements)]\n fn foo1(s: &str) -> impl Iterator<Item = String> + '_ {\n     None.into_iter()\n         .flat_map(move |()| s.chars().map(|c| format!(\"{}{}\", c, s)))\n@@ -11,4 +13,14 @@ fn foo2(s: &str) -> impl Sized + '_ {\n     //~| HELP consider adding 'move' keyword before the nested closure\n }\n \n+pub struct X;\n+pub fn foo3<'a>(\n+    bar: &'a X,\n+) -> impl Iterator<Item = ()> + 'a {\n+    Some(()).iter().flat_map(move |()| {\n+        Some(()).iter().map(|()| { bar; }) //~ ERROR captured variable cannot escape\n+        //~^ HELP consider adding 'move' keyword before the nested closure\n+    })\n+}\n+\n fn main() {}"}, {"sha": "776c338deacf40f4c6d2db778e8e710f44557d40", "filename": "tests/ui/borrowck/issue-95079-missing-move-in-nested-closure.stderr", "status": "modified", "additions": 26, "deletions": 5, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/e6b84eb7973fb751744a1802cee404254d67673e/tests%2Fui%2Fborrowck%2Fissue-95079-missing-move-in-nested-closure.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e6b84eb7973fb751744a1802cee404254d67673e/tests%2Fui%2Fborrowck%2Fissue-95079-missing-move-in-nested-closure.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fborrowck%2Fissue-95079-missing-move-in-nested-closure.stderr?ref=e6b84eb7973fb751744a1802cee404254d67673e", "patch": "@@ -1,13 +1,13 @@\n error: captured variable cannot escape `FnMut` closure body\n-  --> $DIR/issue-95079-missing-move-in-nested-closure.rs:3:29\n+  --> $DIR/issue-95079-missing-move-in-nested-closure.rs:5:29\n    |\n LL | fn foo1(s: &str) -> impl Iterator<Item = String> + '_ {\n    |         - variable defined here\n LL |     None.into_iter()\n LL |         .flat_map(move |()| s.chars().map(|c| format!(\"{}{}\", c, s)))\n    |                           - -^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |                           | |\n-   |                           | returns a reference to a captured variable which escapes the closure body\n+   |                           | returns a closure that contains a reference to a captured variable, which then escapes the closure body\n    |                           | variable captured here\n    |                           inferred to be a `FnMut` closure\n    |\n@@ -19,12 +19,12 @@ LL |         .flat_map(move |()| s.chars().map(move |c| format!(\"{}{}\", c, s)))\n    |                                           ++++\n \n error: lifetime may not live long enough\n-  --> $DIR/issue-95079-missing-move-in-nested-closure.rs:9:15\n+  --> $DIR/issue-95079-missing-move-in-nested-closure.rs:11:15\n    |\n LL |     move |()| s.chars().map(|c| format!(\"{}{}\", c, s))\n    |     --------- ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^ returning this value requires that `'1` must outlive `'2`\n    |     |       |\n-   |     |       return type of closure `Map<Chars<'_>, [closure@$DIR/issue-95079-missing-move-in-nested-closure.rs:9:29: 9:32]>` contains a lifetime `'2`\n+   |     |       return type of closure `Map<Chars<'_>, [closure@$DIR/issue-95079-missing-move-in-nested-closure.rs:11:29: 11:32]>` contains a lifetime `'2`\n    |     lifetime `'1` represents this closure's body\n    |\n    = note: closure implements `Fn`, so references to captured variables can't escape the closure\n@@ -33,5 +33,26 @@ help: consider adding 'move' keyword before the nested closure\n LL |     move |()| s.chars().map(move |c| format!(\"{}{}\", c, s))\n    |                             ++++\n \n-error: aborting due to 2 previous errors\n+error: captured variable cannot escape `FnMut` closure body\n+  --> $DIR/issue-95079-missing-move-in-nested-closure.rs:21:9\n+   |\n+LL |     bar: &'a X,\n+   |     --- variable defined here\n+LL | ) -> impl Iterator<Item = ()> + 'a {\n+LL |     Some(()).iter().flat_map(move |()| {\n+   |                                      - inferred to be a `FnMut` closure\n+LL |         Some(()).iter().map(|()| { bar; })\n+   |         ^^^^^^^^^^^^^^^^^^^^^^^^^^^---^^^^\n+   |         |                          |\n+   |         |                          variable captured here\n+   |         returns a closure that contains a reference to a captured variable, which then escapes the closure body\n+   |\n+   = note: `FnMut` closures only have access to their captured variables while they are executing...\n+   = note: ...therefore, they cannot allow references to captured variables to escape\n+help: consider adding 'move' keyword before the nested closure\n+   |\n+LL |         Some(()).iter().map(move |()| { bar; })\n+   |                             ++++\n+\n+error: aborting due to 3 previous errors\n "}]}