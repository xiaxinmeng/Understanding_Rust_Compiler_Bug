{"sha": "d56969656eb0c933e9a7b442ebdc48b565f11f04", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ1Njk2OTY1NmViMGM5MzNlOWE3YjQ0MmViZGM0OGI1NjVmMTFmMDQ=", "commit": {"author": {"name": "Mohsen Zohrevandi", "email": "mohsen.zohrevandi@fortanix.com", "date": "2020-11-11T18:36:54Z"}, "committer": {"name": "Mohsen Zohrevandi", "email": "mohsen.zohrevandi@fortanix.com", "date": "2020-11-11T19:00:59Z"}, "message": "Add Metadata in std::os::fortanix_sgx::io::FromRawFd", "tree": {"sha": "fa6bf84863bf1a4b789b28cecb6c53c68ffaf6b6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fa6bf84863bf1a4b789b28cecb6c53c68ffaf6b6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d56969656eb0c933e9a7b442ebdc48b565f11f04", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d56969656eb0c933e9a7b442ebdc48b565f11f04", "html_url": "https://github.com/rust-lang/rust/commit/d56969656eb0c933e9a7b442ebdc48b565f11f04", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d56969656eb0c933e9a7b442ebdc48b565f11f04/comments", "author": {"login": "mzohreva", "id": 1142455, "node_id": "MDQ6VXNlcjExNDI0NTU=", "avatar_url": "https://avatars.githubusercontent.com/u/1142455?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mzohreva", "html_url": "https://github.com/mzohreva", "followers_url": "https://api.github.com/users/mzohreva/followers", "following_url": "https://api.github.com/users/mzohreva/following{/other_user}", "gists_url": "https://api.github.com/users/mzohreva/gists{/gist_id}", "starred_url": "https://api.github.com/users/mzohreva/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mzohreva/subscriptions", "organizations_url": "https://api.github.com/users/mzohreva/orgs", "repos_url": "https://api.github.com/users/mzohreva/repos", "events_url": "https://api.github.com/users/mzohreva/events{/privacy}", "received_events_url": "https://api.github.com/users/mzohreva/received_events", "type": "User", "site_admin": false}, "committer": {"login": "mzohreva", "id": 1142455, "node_id": "MDQ6VXNlcjExNDI0NTU=", "avatar_url": "https://avatars.githubusercontent.com/u/1142455?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mzohreva", "html_url": "https://github.com/mzohreva", "followers_url": "https://api.github.com/users/mzohreva/followers", "following_url": "https://api.github.com/users/mzohreva/following{/other_user}", "gists_url": "https://api.github.com/users/mzohreva/gists{/gist_id}", "starred_url": "https://api.github.com/users/mzohreva/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mzohreva/subscriptions", "organizations_url": "https://api.github.com/users/mzohreva/orgs", "repos_url": "https://api.github.com/users/mzohreva/repos", "events_url": "https://api.github.com/users/mzohreva/events{/privacy}", "received_events_url": "https://api.github.com/users/mzohreva/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cf9cf7c923eb01146971429044f216a3ca905e06", "url": "https://api.github.com/repos/rust-lang/rust/commits/cf9cf7c923eb01146971429044f216a3ca905e06", "html_url": "https://github.com/rust-lang/rust/commit/cf9cf7c923eb01146971429044f216a3ca905e06"}], "stats": {"total": 43, "additions": 33, "deletions": 10}, "files": [{"sha": "ffa926417e306edc4550537e589ba7c70b640d8c", "filename": "library/std/src/sys/sgx/ext/io.rs", "status": "modified", "additions": 30, "deletions": 7, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/d56969656eb0c933e9a7b442ebdc48b565f11f04/library%2Fstd%2Fsrc%2Fsys%2Fsgx%2Fext%2Fio.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d56969656eb0c933e9a7b442ebdc48b565f11f04/library%2Fstd%2Fsrc%2Fsys%2Fsgx%2Fext%2Fio.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Fsgx%2Fext%2Fio.rs?ref=d56969656eb0c933e9a7b442ebdc48b565f11f04", "patch": "@@ -25,8 +25,11 @@ pub trait AsRawFd {\n /// descriptor.\n #[unstable(feature = \"sgx_platform\", issue = \"56975\")]\n pub trait FromRawFd {\n+    /// An associated type that contains relevant metadata for `Self`.\n+    type Metadata: Default;\n+\n     /// Constructs a new instance of `Self` from the given raw file\n-    /// descriptor.\n+    /// descriptor and metadata.\n     ///\n     /// This function **consumes ownership** of the specified file\n     /// descriptor. The returned object will take responsibility for closing\n@@ -38,7 +41,7 @@ pub trait FromRawFd {\n     /// accidentally allow violating this contract which can cause memory\n     /// unsafety in code that relies on it being true.\n     #[unstable(feature = \"sgx_platform\", issue = \"56975\")]\n-    unsafe fn from_raw_fd(fd: RawFd) -> Self;\n+    unsafe fn from_raw_fd(fd: RawFd, metadata: Self::Metadata) -> Self;\n }\n \n /// A trait to express the ability to consume an object and acquire ownership of\n@@ -71,18 +74,38 @@ impl AsRawFd for net::TcpListener {\n     }\n }\n \n+/// Metadata for `TcpStream`.\n+#[derive(Debug, Clone, Default)]\n+pub struct TcpStreamMetadata {\n+    /// Local address of the TCP stream\n+    pub local_addr: Option<String>,\n+    /// Peer address of the TCP stream\n+    pub peer_addr: Option<String>,\n+}\n+\n impl FromRawFd for net::TcpStream {\n-    unsafe fn from_raw_fd(fd: RawFd) -> net::TcpStream {\n+    type Metadata = TcpStreamMetadata;\n+\n+    unsafe fn from_raw_fd(fd: RawFd, metadata: Self::Metadata) -> net::TcpStream {\n         let fd = sys::fd::FileDesc::from_inner(fd);\n-        let socket = sys::net::Socket::from_inner(fd);\n-        net::TcpStream::from_inner(sys::net::TcpStream::from_inner((socket, None)))\n+        let socket = sys::net::Socket::from_inner((fd, metadata.local_addr));\n+        net::TcpStream::from_inner(sys::net::TcpStream::from_inner((socket, metadata.peer_addr)))\n     }\n }\n \n+/// Metadata for `TcpListener`.\n+#[derive(Debug, Clone, Default)]\n+pub struct TcpListenerMetadata {\n+    /// Local address of the TCP listener\n+    pub local_addr: Option<String>,\n+}\n+\n impl FromRawFd for net::TcpListener {\n-    unsafe fn from_raw_fd(fd: RawFd) -> net::TcpListener {\n+    type Metadata = TcpListenerMetadata;\n+\n+    unsafe fn from_raw_fd(fd: RawFd, metadata: Self::Metadata) -> net::TcpListener {\n         let fd = sys::fd::FileDesc::from_inner(fd);\n-        let socket = sys::net::Socket::from_inner(fd);\n+        let socket = sys::net::Socket::from_inner((fd, metadata.local_addr));\n         net::TcpListener::from_inner(sys::net::TcpListener::from_inner(socket))\n     }\n }"}, {"sha": "3dd8267921e5e3153d0000f6592202e187677d9a", "filename": "library/std/src/sys/sgx/net.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/d56969656eb0c933e9a7b442ebdc48b565f11f04/library%2Fstd%2Fsrc%2Fsys%2Fsgx%2Fnet.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d56969656eb0c933e9a7b442ebdc48b565f11f04/library%2Fstd%2Fsrc%2Fsys%2Fsgx%2Fnet.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Fsgx%2Fnet.rs?ref=d56969656eb0c933e9a7b442ebdc48b565f11f04", "patch": "@@ -37,9 +37,9 @@ impl TryIntoInner<FileDesc> for Socket {\n     }\n }\n \n-impl FromInner<FileDesc> for Socket {\n-    fn from_inner(inner: FileDesc) -> Socket {\n-        Socket { inner: Arc::new(inner), local_addr: None }\n+impl FromInner<(FileDesc, Option<String>)> for Socket {\n+    fn from_inner((inner, local_addr): (FileDesc, Option<String>)) -> Socket {\n+        Socket { inner: Arc::new(inner), local_addr }\n     }\n }\n "}]}