{"sha": "ac892a12743551c98da1d4b8c6366e285a10833f", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFjODkyYTEyNzQzNTUxYzk4ZGExZDRiOGM2MzY2ZTI4NWExMDgzM2Y=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-09-06T16:26:33Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-09-06T16:26:33Z"}, "message": "Auto merge of #76390 - MaulingMonkey:pr-min-cdb-version, r=petrochenkov\n\ndebuginfo:  Ignore HashMap .natvis tests before cdb 10.0.18362.1\n\nCDB <10.0.18362.1 chokes on casts within HashMap's natvis visualizers.  This PR adds support for \"min-cdb-version\" (per existing \"min-gdb-version\" and \"min-lldb-version\" filters) and uses it.  CI uses a more recent version of CDB for testing and thus should still run the tests.\n\nCredit to @petrochenkov per https://github.com/rust-lang/rust/issues/76352 for helping catch this.\n\n### SDK Testing\n\n| Win 10 SDK                                                             |  x64 CDB          | rustc 1.47.0-nightly (bf4342114 2020-08-25) built-in .natvis  | Note |\n| --------------------------------------------------------------------- | ----------------- | ------------------------------------------------------------- | ---- |\n| [10.0.19041.0](https://go.microsoft.com/fwlink/p/?linkid=2120843)     | 10.0.19041.1      | \u2714\ufe0f                                                            | CI\n| [10.0.18362.1](https://go.microsoft.com/fwlink/?linkid=2083338)       | 10.0.18362.1      | \u2714\ufe0f                                                            | MaulingMonkey\n| [10.0.17763.0](https://go.microsoft.com/fwlink/p/?LinkID=2033908)     | 10.0.17763.132    | \u274c `Unable to find type 'tuple<u64,u64> *' for cast.`\n| [10.0.17134.12](https://go.microsoft.com/fwlink/p/?linkid=870807)     | 10.0.17134.12     | \u274c `Unable to find type 'tuple<u64,u64> *' for cast.`\n| [10.0.16299.91](https://go.microsoft.com/fwlink/p/?linkid=864422)     | 10.0.16299.91     | \u274c `Unable to find type 'tuple<u64,u64> *' for cast.`\n| [10.0.15063.468](https://go.microsoft.com/fwlink/p/?LinkId=845298)    | 10.0.15063.468    | \u274c `Unable to find type 'tuple<u64,u64> *' for cast.`\n| [10.0.14393.795](https://go.microsoft.com/fwlink/p/?LinkId=838916)    | 10.0.14321.1024   | \u274c `Unable to find type 'tuple<u64,u64> *' for cast.` | petrochenkov\n| [10.0.10586.212](https://go.microsoft.com/fwlink/p/?LinkID=698771)    | 10.0.10586.567    | \u274c `Expected ')' at '+ 1)].__1'`\n| [10.0.10240](https://go.microsoft.com/fwlink/p/?LinkId=619296)        | 10.0.10240?       | \u2754 Untested\n\n### Rust Testing\n\n```cmd\nx.py test --stage 1 src/tools/tidy\nx.py test --stage 1 --build x86_64-pc-windows-msvc src\\test\\debuginfo\n```\n\nAlso verified test still fails when intentionally broken w/ CDB version >= min-cdb-version.", "tree": {"sha": "821a445b613c8f8aa712ec9a3043e828b5a8554f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/821a445b613c8f8aa712ec9a3043e828b5a8554f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ac892a12743551c98da1d4b8c6366e285a10833f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ac892a12743551c98da1d4b8c6366e285a10833f", "html_url": "https://github.com/rust-lang/rust/commit/ac892a12743551c98da1d4b8c6366e285a10833f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ac892a12743551c98da1d4b8c6366e285a10833f/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4b65872d272875adb298b6dc12d5e4e79cf8e263", "url": "https://api.github.com/repos/rust-lang/rust/commits/4b65872d272875adb298b6dc12d5e4e79cf8e263", "html_url": "https://github.com/rust-lang/rust/commit/4b65872d272875adb298b6dc12d5e4e79cf8e263"}, {"sha": "4046f928d162e52e2e87e0a91e97aa1ea118f2aa", "url": "https://api.github.com/repos/rust-lang/rust/commits/4046f928d162e52e2e87e0a91e97aa1ea118f2aa", "html_url": "https://github.com/rust-lang/rust/commit/4046f928d162e52e2e87e0a91e97aa1ea118f2aa"}], "stats": {"total": 61, "additions": 55, "deletions": 6}, "files": [{"sha": "9f59936a92d1006ff217ff4f47707c611ecc2ca4", "filename": "src/test/debuginfo/pretty-std-collections-hash.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/ac892a12743551c98da1d4b8c6366e285a10833f/src%2Ftest%2Fdebuginfo%2Fpretty-std-collections-hash.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ac892a12743551c98da1d4b8c6366e285a10833f/src%2Ftest%2Fdebuginfo%2Fpretty-std-collections-hash.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fdebuginfo%2Fpretty-std-collections-hash.rs?ref=ac892a12743551c98da1d4b8c6366e285a10833f", "patch": "@@ -1,3 +1,7 @@\n+// CDB doesn't like how libstd.natvis casts to tuples before this version.\n+// https://github.com/rust-lang/rust/issues/76352#issuecomment-687640746\n+// min-cdb-version: 10.0.18362.1\n+\n // cdb-only\n // compile-flags:-g\n "}, {"sha": "2f832b53a9039f73f2794a79a1d39f140b6b3975", "filename": "src/tools/compiletest/src/common.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/ac892a12743551c98da1d4b8c6366e285a10833f/src%2Ftools%2Fcompiletest%2Fsrc%2Fcommon.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ac892a12743551c98da1d4b8c6366e285a10833f/src%2Ftools%2Fcompiletest%2Fsrc%2Fcommon.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fcommon.rs?ref=ac892a12743551c98da1d4b8c6366e285a10833f", "patch": "@@ -261,6 +261,9 @@ pub struct Config {\n     /// Path to / name of the Microsoft Console Debugger (CDB) executable\n     pub cdb: Option<OsString>,\n \n+    /// Version of CDB\n+    pub cdb_version: Option<[u16; 4]>,\n+\n     /// Path to / name of the GDB executable\n     pub gdb: Option<String>,\n "}, {"sha": "17649dfab37501467b9b93808d5e156c636b1bf4", "filename": "src/tools/compiletest/src/header.rs", "status": "modified", "additions": 22, "deletions": 3, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/ac892a12743551c98da1d4b8c6366e285a10833f/src%2Ftools%2Fcompiletest%2Fsrc%2Fheader.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ac892a12743551c98da1d4b8c6366e285a10833f/src%2Ftools%2Fcompiletest%2Fsrc%2Fheader.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fheader.rs?ref=ac892a12743551c98da1d4b8c6366e285a10833f", "patch": "@@ -8,8 +8,8 @@ use std::path::{Path, PathBuf};\n use tracing::*;\n \n use crate::common::{CompareMode, Config, Debugger, FailMode, Mode, PassMode};\n-use crate::extract_gdb_version;\n use crate::util;\n+use crate::{extract_cdb_version, extract_gdb_version};\n \n #[cfg(test)]\n mod tests;\n@@ -105,6 +105,10 @@ impl EarlyProps {\n                     props.ignore = true;\n                 }\n \n+                if config.debugger == Some(Debugger::Cdb) && ignore_cdb(config, ln) {\n+                    props.ignore = true;\n+                }\n+\n                 if config.debugger == Some(Debugger::Gdb) && ignore_gdb(config, ln) {\n                     props.ignore = true;\n                 }\n@@ -131,6 +135,21 @@ impl EarlyProps {\n \n         return props;\n \n+        fn ignore_cdb(config: &Config, line: &str) -> bool {\n+            if let Some(actual_version) = config.cdb_version {\n+                if let Some(min_version) = line.strip_prefix(\"min-cdb-version:\").map(str::trim) {\n+                    let min_version = extract_cdb_version(min_version).unwrap_or_else(|| {\n+                        panic!(\"couldn't parse version range: {:?}\", min_version);\n+                    });\n+\n+                    // Ignore if actual version is smaller than the minimum\n+                    // required version\n+                    return actual_version < min_version;\n+                }\n+            }\n+            false\n+        }\n+\n         fn ignore_gdb(config: &Config, line: &str) -> bool {\n             if let Some(actual_version) = config.gdb_version {\n                 if let Some(rest) = line.strip_prefix(\"min-gdb-version:\").map(str::trim) {\n@@ -142,8 +161,8 @@ impl EarlyProps {\n                     if start_ver != end_ver {\n                         panic!(\"Expected single GDB version\")\n                     }\n-                    // Ignore if actual version is smaller the minimum required\n-                    // version\n+                    // Ignore if actual version is smaller than the minimum\n+                    // required version\n                     return actual_version < start_ver;\n                 } else if let Some(rest) = line.strip_prefix(\"ignore-gdb-version:\").map(str::trim) {\n                     let (min_version, max_version) ="}, {"sha": "190a9c6221060fae43425f137d3dde09376e240b", "filename": "src/tools/compiletest/src/main.rs", "status": "modified", "additions": 26, "deletions": 3, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/ac892a12743551c98da1d4b8c6366e285a10833f/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ac892a12743551c98da1d4b8c6366e285a10833f/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fmain.rs?ref=ac892a12743551c98da1d4b8c6366e285a10833f", "patch": "@@ -163,7 +163,7 @@ pub fn parse_config(args: Vec<String>) -> Config {\n \n     let target = opt_str2(matches.opt_str(\"target\"));\n     let android_cross_path = opt_path(matches, \"android-cross-path\");\n-    let cdb = analyze_cdb(matches.opt_str(\"cdb\"), &target);\n+    let (cdb, cdb_version) = analyze_cdb(matches.opt_str(\"cdb\"), &target);\n     let (gdb, gdb_version, gdb_native_rust) =\n         analyze_gdb(matches.opt_str(\"gdb\"), &target, &android_cross_path);\n     let (lldb_version, lldb_native_rust) = matches\n@@ -216,6 +216,7 @@ pub fn parse_config(args: Vec<String>) -> Config {\n         target,\n         host: opt_str2(matches.opt_str(\"host\")),\n         cdb,\n+        cdb_version,\n         gdb,\n         gdb_version,\n         gdb_native_rust,\n@@ -773,8 +774,30 @@ fn find_cdb(target: &str) -> Option<OsString> {\n }\n \n /// Returns Path to CDB\n-fn analyze_cdb(cdb: Option<String>, target: &str) -> Option<OsString> {\n-    cdb.map(OsString::from).or_else(|| find_cdb(target))\n+fn analyze_cdb(cdb: Option<String>, target: &str) -> (Option<OsString>, Option<[u16; 4]>) {\n+    let cdb = cdb.map(OsString::from).or_else(|| find_cdb(target));\n+\n+    let mut version = None;\n+    if let Some(cdb) = cdb.as_ref() {\n+        if let Ok(output) = Command::new(cdb).arg(\"/version\").output() {\n+            if let Some(first_line) = String::from_utf8_lossy(&output.stdout).lines().next() {\n+                version = extract_cdb_version(&first_line);\n+            }\n+        }\n+    }\n+\n+    (cdb, version)\n+}\n+\n+fn extract_cdb_version(full_version_line: &str) -> Option<[u16; 4]> {\n+    // Example full_version_line: \"cdb version 10.0.18362.1\"\n+    let version = full_version_line.rsplit(' ').next()?;\n+    let mut components = version.split('.');\n+    let major: u16 = components.next().unwrap().parse().unwrap();\n+    let minor: u16 = components.next().unwrap().parse().unwrap();\n+    let patch: u16 = components.next().unwrap_or(\"0\").parse().unwrap();\n+    let build: u16 = components.next().unwrap_or(\"0\").parse().unwrap();\n+    Some([major, minor, patch, build])\n }\n \n /// Returns (Path to GDB, GDB Version, GDB has Rust Support)"}]}