{"sha": "75f5981d4500e52de767d61ec50a34b97be2a301", "node_id": "MDY6Q29tbWl0NzI0NzEyOjc1ZjU5ODFkNDUwMGU1MmRlNzY3ZDYxZWM1MGEzNGI5N2JlMmEzMDE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-12-30T01:20:18Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-12-30T01:20:18Z"}, "message": "Auto merge of #38695 - alexcrichton:debug-appveyor, r=brson\n\nappveyor: Attempt to debug flaky test runs\n\nThis commit is an attempt to debug #38620 since we're unable to reproduce it\nlocally. It follows the [advice] of those with AppVeyor to use the `handle.exe`\ntool to try to debug what processes have a handle to the file open.\n\nThis won't be guaranteed to actually help us, but hopefully it'll diagnose\nsomething at some point?\n\n[advice]: http://help.appveyor.com/discussions/questions/2898", "tree": {"sha": "6b1f4d90adaeb0ab421ab168efc1d658331a081e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6b1f4d90adaeb0ab421ab168efc1d658331a081e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/75f5981d4500e52de767d61ec50a34b97be2a301", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/75f5981d4500e52de767d61ec50a34b97be2a301", "html_url": "https://github.com/rust-lang/rust/commit/75f5981d4500e52de767d61ec50a34b97be2a301", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/75f5981d4500e52de767d61ec50a34b97be2a301/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e7c788af75c92c3e0f8e547f28d734757136527f", "url": "https://api.github.com/repos/rust-lang/rust/commits/e7c788af75c92c3e0f8e547f28d734757136527f", "html_url": "https://github.com/rust-lang/rust/commit/e7c788af75c92c3e0f8e547f28d734757136527f"}, {"sha": "e5c778228e2e825002bc4eb1e62cfc35afce0dd4", "url": "https://api.github.com/repos/rust-lang/rust/commits/e5c778228e2e825002bc4eb1e62cfc35afce0dd4", "html_url": "https://github.com/rust-lang/rust/commit/e5c778228e2e825002bc4eb1e62cfc35afce0dd4"}], "stats": {"total": 45, "additions": 45, "deletions": 0}, "files": [{"sha": "521ab00d0bfafe925c5bbde612adbf8c9baff16c", "filename": "appveyor.yml", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/75f5981d4500e52de767d61ec50a34b97be2a301/appveyor.yml", "raw_url": "https://github.com/rust-lang/rust/raw/75f5981d4500e52de767d61ec50a34b97be2a301/appveyor.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/appveyor.yml?ref=75f5981d4500e52de767d61ec50a34b97be2a301", "patch": "@@ -96,6 +96,13 @@ install:\n   - 7z x -y sccache.tar > nul\n   - set PATH=%PATH%;%CD%\\sccache2\n \n+  # Help debug some handle issues on AppVeyor\n+  - ps: Invoke-WebRequest -Uri https://download.sysinternals.com/files/Handle.zip -OutFile handle.zip\n+  - mkdir handle\n+  - ps: Expand-Archive handle.zip -dest handle\n+  - set PATH=%PATH%;%CD%\\handle\n+  - handle.exe -accepteula -help\n+\n test_script:\n   - git submodule update --init\n   - set SRC=."}, {"sha": "05f9beca3d11aa1948284a08c5cc92384bab55a1", "filename": "src/tools/compiletest/src/runtest.rs", "status": "modified", "additions": 38, "deletions": 0, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/75f5981d4500e52de767d61ec50a34b97be2a301/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/75f5981d4500e52de767d61ec50a34b97be2a301/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs?ref=75f5981d4500e52de767d61ec50a34b97be2a301", "patch": "@@ -1619,10 +1619,48 @@ actual:\\n\\\n     }\n \n     fn fatal_proc_rec(&self, err: &str, proc_res: &ProcRes) -> ! {\n+        self.try_print_open_handles();\n         self.error(err);\n         proc_res.fatal(None);\n     }\n \n+    // This function is a poor man's attempt to debug rust-lang/rust#38620, if\n+    // that's closed then this should be deleted\n+    //\n+    // This is a very \"opportunistic\" debugging attempt, so we ignore all\n+    // errors here.\n+    fn try_print_open_handles(&self) {\n+        if !cfg!(windows) {\n+            return\n+        }\n+        if self.config.mode != Incremental {\n+            return\n+        }\n+\n+        let filename = match self.testpaths.file.file_stem() {\n+            Some(path) => path,\n+            None => return,\n+        };\n+\n+        let mut cmd = Command::new(\"handle.exe\");\n+        cmd.arg(\"-a\").arg(\"-u\");\n+        cmd.arg(filename);\n+        cmd.arg(\"-nobanner\");\n+        let output = match cmd.output() {\n+            Ok(output) => output,\n+            Err(_) => return,\n+        };\n+        println!(\"---------------------------------------------------\");\n+        println!(\"ran extra command to debug rust-lang/rust#38620: \");\n+        println!(\"{:?}\", cmd);\n+        println!(\"result: {}\", output.status);\n+        println!(\"--- stdout ----------------------------------------\");\n+        println!(\"{}\", String::from_utf8_lossy(&output.stdout));\n+        println!(\"--- stderr ----------------------------------------\");\n+        println!(\"{}\", String::from_utf8_lossy(&output.stderr));\n+        println!(\"---------------------------------------------------\");\n+    }\n+\n     fn _arm_exec_compiled_test(&self, env: Vec<(String, String)>) -> ProcRes {\n         let args = self.make_run_args();\n         let cmdline = self.make_cmdline(\"\", &args.prog, &args.args);"}]}