{"sha": "64758bd48195241dbf39a63974ecbcdcd151f399", "node_id": "C_kwDOAAsO6NoAKDY0NzU4YmQ0ODE5NTI0MWRiZjM5YTYzOTc0ZWNiY2RjZDE1MWYzOTk", "commit": {"author": {"name": "Ryo Yoshida", "email": "low.ryoshida@gmail.com", "date": "2022-07-24T13:32:49Z"}, "committer": {"name": "Ryo Yoshida", "email": "low.ryoshida@gmail.com", "date": "2022-07-24T13:40:00Z"}, "message": "Add info whether it's assignee expr to relevant HIR `Expr` variants", "tree": {"sha": "eacbb59080b41b4292db4e85ad9b81daa02ff119", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/eacbb59080b41b4292db4e85ad9b81daa02ff119"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/64758bd48195241dbf39a63974ecbcdcd151f399", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEkSbsQIURluxz4rzf4laYqTBYYXEFAmLdS7AACgkQ4laYqTBY\nYXEIrw//aIY8mznq1JYchSh/Jo3yQxn0q15TWaFHXb2mvjQNaAxGlOkGlFmWic3r\nXPhwR08PXxDD9ZTdWpLdkLj7w0Y2AZKbZRgPaJg1nU8dpY+tQIsxu3XnGfkjUPeS\nzvM/o5QGBPxCja7JQu5z3nQtUfVfkdS/9k7cb7BVdvIBjx7OBm7zfkzTGhTuLm40\n8UYmeWtqQoygp+Hm30jxz/aW0M2+O8WW1S61hKZ8phos9QVTzRW7+Ed9eUDXI49z\ngT2+OIbCRIfGZJE9txbUp1R5GAmFn3iXULl3qojAscE1MvDIQpT8Q9C0tG3iwNGz\ne9ELOh6MHEpkiMEMw7ocBIm0L9SL5Xi2X6fT5CRZn1UYGuAwD5FoPAl3xT1fy2ZL\nudwXEe3zBvdgmGMCbZWDL/ib7MgP/EYeNFMLaFjuq2H38Syu/xt0h4VWDiJZyFCW\nopTIQ5U3tHWN04R3S8QOgRlDPIoBiBmasudwm9oQxm/z1Zi10uwfvz9AnTA/Ozh6\nRlZ1+c/ZJ8QYtO9RqkCJinlIoX7DSwTs8YHDCD3N49/ELf9wGqg4YPaRB3ihn9PE\ns2jnqWUVxW+ROi4/d/sPZs0yQjrt2I7PLNGgYn+gQfRuA72e/3A0L9CBEn4QBYAA\nTHM/httoZIjS7QW6S0FZHRBhpN+I/lCqIRYOs11WGxf7nQEZD0w=\n=L6kL\n-----END PGP SIGNATURE-----", "payload": "tree eacbb59080b41b4292db4e85ad9b81daa02ff119\nparent fb063d360ce66e9f1316c3e64885e00344062e55\nauthor Ryo Yoshida <low.ryoshida@gmail.com> 1658669569 +0900\ncommitter Ryo Yoshida <low.ryoshida@gmail.com> 1658670000 +0900\n\nAdd info whether it's assignee expr to relevant HIR `Expr` variants\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/64758bd48195241dbf39a63974ecbcdcd151f399", "html_url": "https://github.com/rust-lang/rust/commit/64758bd48195241dbf39a63974ecbcdcd151f399", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/64758bd48195241dbf39a63974ecbcdcd151f399/comments", "author": {"login": "lowr", "id": 24381114, "node_id": "MDQ6VXNlcjI0MzgxMTE0", "avatar_url": "https://avatars.githubusercontent.com/u/24381114?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lowr", "html_url": "https://github.com/lowr", "followers_url": "https://api.github.com/users/lowr/followers", "following_url": "https://api.github.com/users/lowr/following{/other_user}", "gists_url": "https://api.github.com/users/lowr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lowr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lowr/subscriptions", "organizations_url": "https://api.github.com/users/lowr/orgs", "repos_url": "https://api.github.com/users/lowr/repos", "events_url": "https://api.github.com/users/lowr/events{/privacy}", "received_events_url": "https://api.github.com/users/lowr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lowr", "id": 24381114, "node_id": "MDQ6VXNlcjI0MzgxMTE0", "avatar_url": "https://avatars.githubusercontent.com/u/24381114?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lowr", "html_url": "https://github.com/lowr", "followers_url": "https://api.github.com/users/lowr/followers", "following_url": "https://api.github.com/users/lowr/following{/other_user}", "gists_url": "https://api.github.com/users/lowr/gists{/gist_id}", "starred_url": "https://api.github.com/users/lowr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lowr/subscriptions", "organizations_url": "https://api.github.com/users/lowr/orgs", "repos_url": "https://api.github.com/users/lowr/repos", "events_url": "https://api.github.com/users/lowr/events{/privacy}", "received_events_url": "https://api.github.com/users/lowr/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fb063d360ce66e9f1316c3e64885e00344062e55", "url": "https://api.github.com/repos/rust-lang/rust/commits/fb063d360ce66e9f1316c3e64885e00344062e55", "html_url": "https://github.com/rust-lang/rust/commit/fb063d360ce66e9f1316c3e64885e00344062e55"}], "stats": {"total": 66, "additions": 47, "deletions": 19}, "files": [{"sha": "66f9c24e8724a77e10d73a0f55df2367ebb1e116", "filename": "crates/hir-def/src/body/lower.rs", "status": "modified", "additions": 32, "deletions": 7, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/64758bd48195241dbf39a63974ecbcdcd151f399/crates%2Fhir-def%2Fsrc%2Fbody%2Flower.rs", "raw_url": "https://github.com/rust-lang/rust/raw/64758bd48195241dbf39a63974ecbcdcd151f399/crates%2Fhir-def%2Fsrc%2Fbody%2Flower.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-def%2Fsrc%2Fbody%2Flower.rs?ref=64758bd48195241dbf39a63974ecbcdcd151f399", "patch": "@@ -96,6 +96,7 @@ pub(super) fn lower(\n         expander,\n         name_to_pat_grouping: Default::default(),\n         is_lowering_inside_or_pat: false,\n+        is_lowering_assignee_expr: false,\n     }\n     .collect(params, body)\n }\n@@ -109,6 +110,7 @@ struct ExprCollector<'a> {\n     // a poor-mans union-find?\n     name_to_pat_grouping: FxHashMap<Name, Vec<PatId>>,\n     is_lowering_inside_or_pat: bool,\n+    is_lowering_assignee_expr: bool,\n }\n \n impl ExprCollector<'_> {\n@@ -283,7 +285,10 @@ impl ExprCollector<'_> {\n                 } else {\n                     Box::default()\n                 };\n-                self.alloc_expr(Expr::Call { callee, args }, syntax_ptr)\n+                self.alloc_expr(\n+                    Expr::Call { callee, args, is_assignee_expr: self.is_lowering_assignee_expr },\n+                    syntax_ptr,\n+                )\n             }\n             ast::Expr::MethodCallExpr(e) => {\n                 let receiver = self.collect_expr_opt(e.receiver());\n@@ -359,6 +364,7 @@ impl ExprCollector<'_> {\n             ast::Expr::RecordExpr(e) => {\n                 let path =\n                     e.path().and_then(|path| self.expander.parse_path(self.db, path)).map(Box::new);\n+                let is_assignee_expr = self.is_lowering_assignee_expr;\n                 let record_lit = if let Some(nfl) = e.record_expr_field_list() {\n                     let fields = nfl\n                         .fields()\n@@ -379,9 +385,15 @@ impl ExprCollector<'_> {\n                         .collect();\n                     let spread = nfl.spread().map(|s| self.collect_expr(s));\n                     let ellipsis = nfl.dotdot_token().is_some();\n-                    Expr::RecordLit { path, fields, spread, ellipsis }\n+                    Expr::RecordLit { path, fields, spread, ellipsis, is_assignee_expr }\n                 } else {\n-                    Expr::RecordLit { path, fields: Box::default(), spread: None, ellipsis: false }\n+                    Expr::RecordLit {\n+                        path,\n+                        fields: Box::default(),\n+                        spread: None,\n+                        ellipsis: false,\n+                        is_assignee_expr,\n+                    }\n                 };\n \n                 self.alloc_expr(record_lit, syntax_ptr)\n@@ -459,14 +471,21 @@ impl ExprCollector<'_> {\n                 )\n             }\n             ast::Expr::BinExpr(e) => {\n+                let op = e.op_kind();\n+                if let Some(ast::BinaryOp::Assignment { op: None }) = op {\n+                    self.is_lowering_assignee_expr = true;\n+                }\n                 let lhs = self.collect_expr_opt(e.lhs());\n+                self.is_lowering_assignee_expr = false;\n                 let rhs = self.collect_expr_opt(e.rhs());\n-                let op = e.op_kind();\n                 self.alloc_expr(Expr::BinaryOp { lhs, rhs, op }, syntax_ptr)\n             }\n             ast::Expr::TupleExpr(e) => {\n                 let exprs = e.fields().map(|expr| self.collect_expr(expr)).collect();\n-                self.alloc_expr(Expr::Tuple { exprs }, syntax_ptr)\n+                self.alloc_expr(\n+                    Expr::Tuple { exprs, is_assignee_expr: self.is_lowering_assignee_expr },\n+                    syntax_ptr,\n+                )\n             }\n             ast::Expr::BoxExpr(e) => {\n                 let expr = self.collect_expr_opt(e.expr());\n@@ -478,8 +497,14 @@ impl ExprCollector<'_> {\n \n                 match kind {\n                     ArrayExprKind::ElementList(e) => {\n-                        let exprs = e.map(|expr| self.collect_expr(expr)).collect();\n-                        self.alloc_expr(Expr::Array(Array::ElementList(exprs)), syntax_ptr)\n+                        let elements = e.map(|expr| self.collect_expr(expr)).collect();\n+                        self.alloc_expr(\n+                            Expr::Array(Array::ElementList {\n+                                elements,\n+                                is_assignee_expr: self.is_lowering_assignee_expr,\n+                            }),\n+                            syntax_ptr,\n+                        )\n                     }\n                     ArrayExprKind::Repeat { initializer, repeat } => {\n                         let initializer = self.collect_expr_opt(initializer);"}, {"sha": "c1b3788acb7d36d97a53272df8228458b139270e", "filename": "crates/hir-def/src/expr.rs", "status": "modified", "additions": 7, "deletions": 4, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/64758bd48195241dbf39a63974ecbcdcd151f399/crates%2Fhir-def%2Fsrc%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/64758bd48195241dbf39a63974ecbcdcd151f399/crates%2Fhir-def%2Fsrc%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-def%2Fsrc%2Fexpr.rs?ref=64758bd48195241dbf39a63974ecbcdcd151f399", "patch": "@@ -110,6 +110,7 @@ pub enum Expr {\n     Call {\n         callee: ExprId,\n         args: Box<[ExprId]>,\n+        is_assignee_expr: bool,\n     },\n     MethodCall {\n         receiver: ExprId,\n@@ -139,6 +140,7 @@ pub enum Expr {\n         fields: Box<[RecordLitField]>,\n         spread: Option<ExprId>,\n         ellipsis: bool,\n+        is_assignee_expr: bool,\n     },\n     Field {\n         expr: ExprId,\n@@ -197,6 +199,7 @@ pub enum Expr {\n     },\n     Tuple {\n         exprs: Box<[ExprId]>,\n+        is_assignee_expr: bool,\n     },\n     Unsafe {\n         body: ExprId,\n@@ -212,7 +215,7 @@ pub enum Expr {\n \n #[derive(Debug, Clone, Eq, PartialEq)]\n pub enum Array {\n-    ElementList(Box<[ExprId]>),\n+    ElementList { elements: Box<[ExprId]>, is_assignee_expr: bool },\n     Repeat { initializer: ExprId, repeat: ExprId },\n }\n \n@@ -286,7 +289,7 @@ impl Expr {\n                 f(*iterable);\n                 f(*body);\n             }\n-            Expr::Call { callee, args } => {\n+            Expr::Call { callee, args, .. } => {\n                 f(*callee);\n                 args.iter().copied().for_each(f);\n             }\n@@ -340,9 +343,9 @@ impl Expr {\n             | Expr::Box { expr } => {\n                 f(*expr);\n             }\n-            Expr::Tuple { exprs } => exprs.iter().copied().for_each(f),\n+            Expr::Tuple { exprs, .. } => exprs.iter().copied().for_each(f),\n             Expr::Array(a) => match a {\n-                Array::ElementList(exprs) => exprs.iter().copied().for_each(f),\n+                Array::ElementList { elements, .. } => elements.iter().copied().for_each(f),\n                 Array::Repeat { initializer, repeat } => {\n                     f(*initializer);\n                     f(*repeat)"}, {"sha": "d164e64a8be0780a0d9b5d54008b648e46b89c18", "filename": "crates/hir-ty/src/infer/expr.rs", "status": "modified", "additions": 8, "deletions": 8, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/64758bd48195241dbf39a63974ecbcdcd151f399/crates%2Fhir-ty%2Fsrc%2Finfer%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/64758bd48195241dbf39a63974ecbcdcd151f399/crates%2Fhir-ty%2Fsrc%2Finfer%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir-ty%2Fsrc%2Finfer%2Fexpr.rs?ref=64758bd48195241dbf39a63974ecbcdcd151f399", "patch": "@@ -276,7 +276,7 @@ impl<'a> InferenceContext<'a> {\n \n                 closure_ty\n             }\n-            Expr::Call { callee, args } => {\n+            Expr::Call { callee, args, .. } => {\n                 let callee_ty = self.infer_expr(*callee, &Expectation::none());\n                 let mut derefs = Autoderef::new(&mut self.table, callee_ty.clone());\n                 let mut res = None;\n@@ -693,7 +693,7 @@ impl<'a> InferenceContext<'a> {\n                     self.err_ty()\n                 }\n             }\n-            Expr::Tuple { exprs } => {\n+            Expr::Tuple { exprs, .. } => {\n                 let mut tys = match expected\n                     .only_has_type(&mut self.table)\n                     .as_ref()\n@@ -724,12 +724,12 @@ impl<'a> InferenceContext<'a> {\n \n                 let expected = Expectation::has_type(elem_ty.clone());\n                 let len = match array {\n-                    Array::ElementList(items) => {\n-                        for &expr in items.iter() {\n+                    Array::ElementList { elements, .. } => {\n+                        for &expr in elements.iter() {\n                             let cur_elem_ty = self.infer_expr_inner(expr, &expected);\n                             coerce.coerce(self, Some(expr), &cur_elem_ty);\n                         }\n-                        consteval::usize_const(Some(items.len() as u128))\n+                        consteval::usize_const(Some(elements.len() as u128))\n                     }\n                     &Array::Repeat { initializer, repeat } => {\n                         self.infer_expr_coerce(initializer, &Expectation::has_type(elem_ty));\n@@ -850,15 +850,15 @@ impl<'a> InferenceContext<'a> {\n         let rhs_ty = self.resolve_ty_shallow(rhs_ty);\n \n         let ty = match &self.body[lhs] {\n-            Expr::Tuple { exprs } => {\n+            Expr::Tuple { exprs, .. } => {\n                 // We don't consider multiple ellipses. This is analogous to\n                 // `hir_def::body::lower::ExprCollector::collect_tuple_pat()`.\n                 let ellipsis = exprs.iter().position(|e| is_rest_expr(*e));\n                 let exprs: Vec<_> = exprs.iter().filter(|e| !is_rest_expr(**e)).copied().collect();\n \n                 self.infer_tuple_pat_like(&rhs_ty, (), ellipsis, &exprs)\n             }\n-            Expr::Call { callee, args } => {\n+            Expr::Call { callee, args, .. } => {\n                 // Tuple structs\n                 let path = match &self.body[*callee] {\n                     Expr::Path(path) => Some(path),\n@@ -872,7 +872,7 @@ impl<'a> InferenceContext<'a> {\n \n                 self.infer_tuple_struct_pat_like(path, &rhs_ty, (), lhs, ellipsis, &args)\n             }\n-            Expr::Array(Array::ElementList(elements)) => {\n+            Expr::Array(Array::ElementList { elements, .. }) => {\n                 let elem_ty = match rhs_ty.kind(Interner) {\n                     TyKind::Array(st, _) => st.clone(),\n                     _ => self.err_ty(),"}]}