{"sha": "3ee410498db9826c3ccb81ce8c0aa40f7f3b4082", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNlZTQxMDQ5OGRiOTgyNmMzY2NiODFjZThjMGFhNDBmN2YzYjQwODI=", "commit": {"author": {"name": "Mark Mansi", "email": "markm@cs.wisc.edu", "date": "2018-02-23T01:52:56Z"}, "committer": {"name": "Mark Mansi", "email": "markm@cs.wisc.edu", "date": "2018-03-05T20:43:44Z"}, "message": "Start adding a whitelist for rustc dependencies", "tree": {"sha": "98a4943f8641a9e091331747b48c4f2c6412bc46", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/98a4943f8641a9e091331747b48c4f2c6412bc46"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3ee410498db9826c3ccb81ce8c0aa40f7f3b4082", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3ee410498db9826c3ccb81ce8c0aa40f7f3b4082", "html_url": "https://github.com/rust-lang/rust/commit/3ee410498db9826c3ccb81ce8c0aa40f7f3b4082", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3ee410498db9826c3ccb81ce8c0aa40f7f3b4082/comments", "author": {"login": "mark-i-m", "id": 8827840, "node_id": "MDQ6VXNlcjg4Mjc4NDA=", "avatar_url": "https://avatars.githubusercontent.com/u/8827840?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mark-i-m", "html_url": "https://github.com/mark-i-m", "followers_url": "https://api.github.com/users/mark-i-m/followers", "following_url": "https://api.github.com/users/mark-i-m/following{/other_user}", "gists_url": "https://api.github.com/users/mark-i-m/gists{/gist_id}", "starred_url": "https://api.github.com/users/mark-i-m/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mark-i-m/subscriptions", "organizations_url": "https://api.github.com/users/mark-i-m/orgs", "repos_url": "https://api.github.com/users/mark-i-m/repos", "events_url": "https://api.github.com/users/mark-i-m/events{/privacy}", "received_events_url": "https://api.github.com/users/mark-i-m/received_events", "type": "User", "site_admin": false}, "committer": {"login": "mark-i-m", "id": 8827840, "node_id": "MDQ6VXNlcjg4Mjc4NDA=", "avatar_url": "https://avatars.githubusercontent.com/u/8827840?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mark-i-m", "html_url": "https://github.com/mark-i-m", "followers_url": "https://api.github.com/users/mark-i-m/followers", "following_url": "https://api.github.com/users/mark-i-m/following{/other_user}", "gists_url": "https://api.github.com/users/mark-i-m/gists{/gist_id}", "starred_url": "https://api.github.com/users/mark-i-m/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mark-i-m/subscriptions", "organizations_url": "https://api.github.com/users/mark-i-m/orgs", "repos_url": "https://api.github.com/users/mark-i-m/repos", "events_url": "https://api.github.com/users/mark-i-m/events{/privacy}", "received_events_url": "https://api.github.com/users/mark-i-m/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2cb8c5fff690cff5e98c84f9bd08411f79347bd9", "url": "https://api.github.com/repos/rust-lang/rust/commits/2cb8c5fff690cff5e98c84f9bd08411f79347bd9", "html_url": "https://github.com/rust-lang/rust/commit/2cb8c5fff690cff5e98c84f9bd08411f79347bd9"}], "stats": {"total": 91, "additions": 82, "deletions": 9}, "files": [{"sha": "5e7909ff43552a8a08b7f34ef307862e65d0341f", "filename": "src/Cargo.lock", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/3ee410498db9826c3ccb81ce8c0aa40f7f3b4082/src%2FCargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/3ee410498db9826c3ccb81ce8c0aa40f7f3b4082/src%2FCargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2FCargo.lock?ref=3ee410498db9826c3ccb81ce8c0aa40f7f3b4082", "patch": "@@ -2585,6 +2585,11 @@ dependencies = [\n [[package]]\n name = \"tidy\"\n version = \"0.1.0\"\n+dependencies = [\n+ \"serde 1.0.27 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"serde_derive 1.0.27 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"serde_json 1.0.9 (registry+https://github.com/rust-lang/crates.io-index)\",\n+]\n \n [[package]]\n name = \"time\""}, {"sha": "f7b491823f838b3584c32f4e8d52545aff987813", "filename": "src/tools/tidy/Cargo.toml", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/3ee410498db9826c3ccb81ce8c0aa40f7f3b4082/src%2Ftools%2Ftidy%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/3ee410498db9826c3ccb81ce8c0aa40f7f3b4082/src%2Ftools%2Ftidy%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2FCargo.toml?ref=3ee410498db9826c3ccb81ce8c0aa40f7f3b4082", "patch": "@@ -2,3 +2,8 @@\n name = \"tidy\"\n version = \"0.1.0\"\n authors = [\"Alex Crichton <alex@alexcrichton.com>\"]\n+\n+[dependencies]\n+serde = \"1.0.8\"\n+serde_derive = \"1.0.8\"\n+serde_json = \"1.0.2\""}, {"sha": "2cb8a70844e19d376264f58fe733785f5c4489c5", "filename": "src/tools/tidy/src/deps.rs", "status": "modified", "additions": 67, "deletions": 9, "changes": 76, "blob_url": "https://github.com/rust-lang/rust/blob/3ee410498db9826c3ccb81ce8c0aa40f7f3b4082/src%2Ftools%2Ftidy%2Fsrc%2Fdeps.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3ee410498db9826c3ccb81ce8c0aa40f7f3b4082/src%2Ftools%2Ftidy%2Fsrc%2Fdeps.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Fdeps.rs?ref=3ee410498db9826c3ccb81ce8c0aa40f7f3b4082", "patch": "@@ -14,6 +14,10 @@ use std::fs::File;\n use std::io::Read;\n use std::path::Path;\n \n+use std::process::Command;\n+\n+use serde_json;\n+\n static LICENSES: &'static [&'static str] = &[\n     \"MIT/Apache-2.0\",\n     \"MIT / Apache-2.0\",\n@@ -44,31 +48,68 @@ static EXCEPTIONS: &'static [&'static str] = &[\n     \"clippy_lints\",       // MPL-2.0 rls\n ];\n \n+// Whitelist of crates rustc is allowed to depend on. Avoid adding to the list if possible.\n+static WHITELIST: &'static [(&'static str, &'static str)] = &[];\n+\n+// Some type for Serde to deserialize the output of `cargo metadata` to...\n+\n+#[derive(Deserialize)]\n+struct Output {\n+    packages: Vec<Package>,\n+    _resolve: String,\n+}\n+\n+#[derive(Deserialize)]\n+struct Package {\n+    _id: String,\n+    name: String,\n+    version: String,\n+    _source: Option<String>,\n+    _manifest_path: String,\n+}\n+\n+/// Checks the dependency at the given path. Changes `bad` to `true` if a check failed.\n+///\n+/// Specifically, this checks that the license is correct and that the dependencies are on the\n+/// whitelist.\n pub fn check(path: &Path, bad: &mut bool) {\n+    // Check licences\n     let path = path.join(\"vendor\");\n     assert!(path.exists(), \"vendor directory missing\");\n     let mut saw_dir = false;\n-    'next_path: for dir in t!(path.read_dir()) {\n+    for dir in t!(path.read_dir()) {\n         saw_dir = true;\n         let dir = t!(dir);\n \n         // skip our exceptions\n-        for exception in EXCEPTIONS {\n-            if dir.path()\n+        if EXCEPTIONS.iter().any(|exception| {\n+            dir.path()\n                 .to_str()\n                 .unwrap()\n                 .contains(&format!(\"src/vendor/{}\", exception))\n-            {\n-                continue 'next_path;\n-            }\n+        }) {\n+            continue;\n         }\n \n         let toml = dir.path().join(\"Cargo.toml\");\n-        if !check_license(&toml) {\n-            *bad = true;\n-        }\n+        *bad = *bad || !check_license(&toml);\n     }\n     assert!(saw_dir, \"no vendored source\");\n+\n+    // Check dependencies\n+    let deps = get_deps(&path);\n+    *bad = *bad\n+        || deps.iter().any(\n+            |&Package {\n+                 ref name,\n+                 ref version,\n+                 ..\n+             }| {\n+                WHITELIST\n+                    .iter()\n+                    .all(|&(wname, wversion)| name != wname || version != wversion)\n+            },\n+        );\n }\n \n fn check_license(path: &Path) -> bool {\n@@ -109,3 +150,20 @@ fn extract_license(line: &str) -> String {\n         \"bad-license-parse\".into()\n     }\n }\n+\n+fn get_deps(path: &Path) -> Vec<Package> {\n+    // Run `cargo metadata` to get the set of dependencies\n+    let output = Command::new(\"cargo\")\n+        .arg(\"metadata\")\n+        .arg(\"--format-version\")\n+        .arg(\"1\")\n+        .arg(\"--manifest-path\")\n+        .arg(path.join(\"Cargo.toml\"))\n+        .output()\n+        .expect(\"Unable to run `cargo metadata`\")\n+        .stdout;\n+    let output = String::from_utf8_lossy(&output);\n+    let output: Output = serde_json::from_str(&output).unwrap();\n+\n+    output.packages\n+}"}, {"sha": "c927ff19b279bc15af8f4e804d0596650c0298a4", "filename": "src/tools/tidy/src/lib.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/3ee410498db9826c3ccb81ce8c0aa40f7f3b4082/src%2Ftools%2Ftidy%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3ee410498db9826c3ccb81ce8c0aa40f7f3b4082/src%2Ftools%2Ftidy%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Flib.rs?ref=3ee410498db9826c3ccb81ce8c0aa40f7f3b4082", "patch": "@@ -15,6 +15,11 @@\n \n #![deny(warnings)]\n \n+extern crate serde;\n+extern crate serde_json;\n+#[macro_use]\n+extern crate serde_derive;\n+\n use std::fs;\n \n use std::path::Path;"}]}