{"sha": "3f8e68686f826ed333321a6650481162c95911f6", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNmOGU2ODY4NmY4MjZlZDMzMzMyMWE2NjUwNDgxMTYyYzk1OTExZjY=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-04-18T03:01:25Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2014-04-18T03:01:25Z"}, "message": "auto merge of #13576 : lifthrasiir/rust/double-ref, r=alexcrichton\n\nUses the same strategy as `||` and `>>`. Closes #11227.", "tree": {"sha": "a19792fa9d1586b9c2b8f0a726ba247d047860be", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a19792fa9d1586b9c2b8f0a726ba247d047860be"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3f8e68686f826ed333321a6650481162c95911f6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3f8e68686f826ed333321a6650481162c95911f6", "html_url": "https://github.com/rust-lang/rust/commit/3f8e68686f826ed333321a6650481162c95911f6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3f8e68686f826ed333321a6650481162c95911f6/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0c23140aaf16515227b0403538eb4361dec54ae3", "url": "https://api.github.com/repos/rust-lang/rust/commits/0c23140aaf16515227b0403538eb4361dec54ae3", "html_url": "https://github.com/rust-lang/rust/commit/0c23140aaf16515227b0403538eb4361dec54ae3"}, {"sha": "676cd615d47a1801286e2d0dc026e83e239419b7", "url": "https://api.github.com/repos/rust-lang/rust/commits/676cd615d47a1801286e2d0dc026e83e239419b7", "html_url": "https://github.com/rust-lang/rust/commit/676cd615d47a1801286e2d0dc026e83e239419b7"}], "stats": {"total": 133, "additions": 95, "deletions": 38}, "files": [{"sha": "379403e54097726f65794f56a570b26d53b009c4", "filename": "src/libsyntax/parse/parser.rs", "status": "modified", "additions": 54, "deletions": 38, "changes": 92, "blob_url": "https://github.com/rust-lang/rust/blob/3f8e68686f826ed333321a6650481162c95911f6/src%2Flibsyntax%2Fparse%2Fparser.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3f8e68686f826ed333321a6650481162c95911f6/src%2Flibsyntax%2Fparse%2Fparser.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fparse%2Fparser.rs?ref=3f8e68686f826ed333321a6650481162c95911f6", "patch": "@@ -1,4 +1,4 @@\n-// Copyright 2012-2013 The Rust Project Developers. See the COPYRIGHT\n+// Copyright 2012-2014 The Rust Project Developers. See the COPYRIGHT\n // file at the top-level directory of this distribution and at\n // http://rust-lang.org/COPYRIGHT.\n //\n@@ -542,6 +542,26 @@ impl<'a> Parser<'a> {\n         }\n     }\n \n+    // Expect and consume an `&`. If `&&` is seen, replace it with a single\n+    // `&` and continue. If an `&` is not seen, signal an error.\n+    fn expect_and(&mut self) {\n+        match self.token {\n+            token::BINOP(token::AND) => self.bump(),\n+            token::ANDAND => {\n+                let lo = self.span.lo + BytePos(1);\n+                self.replace_token(token::BINOP(token::AND), lo, self.span.hi)\n+            }\n+            _ => {\n+                let token_str = self.this_token_to_str();\n+                let found_token =\n+                    Parser::token_to_str(&token::BINOP(token::AND));\n+                self.fatal(format!(\"expected `{}`, found `{}`\",\n+                                   found_token,\n+                                   token_str))\n+            }\n+        }\n+    }\n+\n     // Expect and consume a `|`. If `||` is seen, replace it with a single\n     // `|` and continue. If a `|` is not seen, signal an error.\n     fn expect_or(&mut self) {\n@@ -1218,9 +1238,10 @@ impl<'a> Parser<'a> {\n             };\n             self.expect(&token::RBRACKET);\n             t\n-        } else if self.token == token::BINOP(token::AND) {\n+        } else if self.token == token::BINOP(token::AND) ||\n+                self.token == token::ANDAND {\n             // BORROWED POINTER\n-            self.bump();\n+            self.expect_and();\n             self.parse_borrowed_pointee()\n         } else if self.is_keyword(keywords::Extern) ||\n                 self.token_is_bare_fn_keyword() {\n@@ -2169,42 +2190,37 @@ impl<'a> Parser<'a> {\n             hi = e.span.hi;\n             ex = self.mk_unary(UnNot, e);\n           }\n-          token::BINOP(b) => {\n-            match b {\n-              token::MINUS => {\n-                self.bump();\n-                let e = self.parse_prefix_expr();\n-                hi = e.span.hi;\n-                ex = self.mk_unary(UnNeg, e);\n+          token::BINOP(token::MINUS) => {\n+            self.bump();\n+            let e = self.parse_prefix_expr();\n+            hi = e.span.hi;\n+            ex = self.mk_unary(UnNeg, e);\n+          }\n+          token::BINOP(token::STAR) => {\n+            self.bump();\n+            let e = self.parse_prefix_expr();\n+            hi = e.span.hi;\n+            ex = self.mk_unary(UnDeref, e);\n+          }\n+          token::BINOP(token::AND) | token::ANDAND => {\n+            self.expect_and();\n+            let _lt = self.parse_opt_lifetime();\n+            let m = self.parse_mutability();\n+            let e = self.parse_prefix_expr();\n+            hi = e.span.hi;\n+            // HACK: turn &[...] into a &-vec\n+            ex = match e.node {\n+              ExprVec(..) if m == MutImmutable => {\n+                ExprVstore(e, ExprVstoreSlice)\n               }\n-              token::STAR => {\n-                self.bump();\n-                let e = self.parse_prefix_expr();\n-                hi = e.span.hi;\n-                ex = self.mk_unary(UnDeref, e);\n+              ExprLit(lit) if lit_is_str(lit) && m == MutImmutable => {\n+                ExprVstore(e, ExprVstoreSlice)\n               }\n-              token::AND => {\n-                self.bump();\n-                let _lt = self.parse_opt_lifetime();\n-                let m = self.parse_mutability();\n-                let e = self.parse_prefix_expr();\n-                hi = e.span.hi;\n-                // HACK: turn &[...] into a &-vec\n-                ex = match e.node {\n-                  ExprVec(..) if m == MutImmutable => {\n-                    ExprVstore(e, ExprVstoreSlice)\n-                  }\n-                  ExprLit(lit) if lit_is_str(lit) && m == MutImmutable => {\n-                    ExprVstore(e, ExprVstoreSlice)\n-                  }\n-                  ExprVec(..) if m == MutMutable => {\n-                    ExprVstore(e, ExprVstoreMutSlice)\n-                  }\n-                  _ => ExprAddrOf(m, e)\n-                };\n+              ExprVec(..) if m == MutMutable => {\n+                ExprVstore(e, ExprVstoreMutSlice)\n               }\n-              _ => return self.parse_dot_or_call_expr()\n-            }\n+              _ => ExprAddrOf(m, e)\n+            };\n           }\n           token::AT => {\n             self.bump();\n@@ -2749,10 +2765,10 @@ impl<'a> Parser<'a> {\n                 span: mk_sp(lo, hi)\n             }\n           }\n-          token::BINOP(token::AND) => {\n+          token::BINOP(token::AND) | token::ANDAND => {\n               // parse &pat\n               let lo = self.span.lo;\n-              self.bump();\n+              self.expect_and();\n               let sub = self.parse_pat();\n               hi = sub.span.hi;\n               // HACK: parse &\"...\" as a literal of a borrowed str"}, {"sha": "656b9164dfe221381f22f92bfa60099f295f6006", "filename": "src/test/run-pass/double-ref.rs", "status": "added", "additions": 41, "deletions": 0, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/3f8e68686f826ed333321a6650481162c95911f6/src%2Ftest%2Frun-pass%2Fdouble-ref.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3f8e68686f826ed333321a6650481162c95911f6/src%2Ftest%2Frun-pass%2Fdouble-ref.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fdouble-ref.rs?ref=3f8e68686f826ed333321a6650481162c95911f6", "patch": "@@ -0,0 +1,41 @@\n+// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+fn check_expr() {\n+    let _:         & uint =     &1u;\n+    let _:       & & uint =    &&1u;\n+    let _:     & & & uint =   &&&1u;\n+    let _:     & & & uint =  & &&1u;\n+    let _:   & & & & uint =  &&&&1u;\n+    let _:   & & & & uint = & &&&1u;\n+    let _: & & & & & uint = &&&&&1u;\n+}\n+\n+fn check_ty() {\n+    let _:     &uint =         & 1u;\n+    let _:    &&uint =       & & 1u;\n+    let _:   &&&uint =     & & & 1u;\n+    let _:  & &&uint =     & & & 1u;\n+    let _:  &&&&uint =   & & & & 1u;\n+    let _: & &&&uint =   & & & & 1u;\n+    let _: &&&&&uint = & & & & & 1u;\n+}\n+\n+fn check_pat() {\n+    let     &_ =         & 1u;\n+    let    &&_ =       & & 1u;\n+    let   &&&_ =     & & & 1u;\n+    let  & &&_ =     & & & 1u;\n+    let  &&&&_ =   & & & & 1u;\n+    let & &&&_ =   & & & & 1u;\n+    let &&&&&_ = & & & & & 1u;\n+}\n+\n+pub fn main() {}"}]}