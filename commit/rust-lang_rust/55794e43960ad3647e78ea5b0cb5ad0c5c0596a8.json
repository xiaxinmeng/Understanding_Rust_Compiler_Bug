{"sha": "55794e43960ad3647e78ea5b0cb5ad0c5c0596a8", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU1Nzk0ZTQzOTYwYWQzNjQ3ZTc4ZWE1YjBjYjVhZDBjNWMwNTk2YTg=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-11-12T05:52:17Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-11-12T05:52:17Z"}, "message": "Auto merge of #78965 - jryans:emscripten-threads-libc, r=kennytm\n\nUpdate thread and futex APIs to work with Emscripten\n\nThis updates the thread and futex APIs in `std` to match the APIs exposed by\nEmscripten. This allows threads to run on `wasm32-unknown-emscripten` and the\nthread parker to compile without errors related to the missing `futex` module.\n\nTo make use of this, Rust code must be compiled with `-C target-feature=atomics`\nand Emscripten must link with `-pthread`.\n\nI have confirmed this works well locally when building multithreaded crates.\nAttempting to enable `std` thread tests currently fails for seemingly obscure\nreasons and Emscripten is currently disabled in CI, so further work is needed to\nhave proper test coverage here.", "tree": {"sha": "8f15452ce9172f3340c458c214eb9f70ff91e359", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8f15452ce9172f3340c458c214eb9f70ff91e359"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/55794e43960ad3647e78ea5b0cb5ad0c5c0596a8", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/55794e43960ad3647e78ea5b0cb5ad0c5c0596a8", "html_url": "https://github.com/rust-lang/rust/commit/55794e43960ad3647e78ea5b0cb5ad0c5c0596a8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/55794e43960ad3647e78ea5b0cb5ad0c5c0596a8/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5a6a41e7847ff5f85a31b87431ce2af29c567f1d", "url": "https://api.github.com/repos/rust-lang/rust/commits/5a6a41e7847ff5f85a31b87431ce2af29c567f1d", "html_url": "https://github.com/rust-lang/rust/commit/5a6a41e7847ff5f85a31b87431ce2af29c567f1d"}, {"sha": "bf3be09ee800de4ec98dfeea5088639e1c538813", "url": "https://api.github.com/repos/rust-lang/rust/commits/bf3be09ee800de4ec98dfeea5088639e1c538813", "html_url": "https://github.com/rust-lang/rust/commit/bf3be09ee800de4ec98dfeea5088639e1c538813"}], "stats": {"total": 62, "additions": 42, "deletions": 20}, "files": [{"sha": "42ddc1d514ec756e90ca526f879ff25fc0f81025", "filename": "library/std/src/sys/unix/futex.rs", "status": "modified", "additions": 41, "deletions": 1, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/55794e43960ad3647e78ea5b0cb5ad0c5c0596a8/library%2Fstd%2Fsrc%2Fsys%2Funix%2Ffutex.rs", "raw_url": "https://github.com/rust-lang/rust/raw/55794e43960ad3647e78ea5b0cb5ad0c5c0596a8/library%2Fstd%2Fsrc%2Fsys%2Funix%2Ffutex.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Funix%2Ffutex.rs?ref=55794e43960ad3647e78ea5b0cb5ad0c5c0596a8", "patch": "@@ -1,10 +1,17 @@\n-#![cfg(any(target_os = \"linux\", target_os = \"android\"))]\n+#![cfg(any(\n+    target_os = \"linux\",\n+    target_os = \"android\",\n+    all(target_os = \"emscripten\", target_feature = \"atomics\")\n+))]\n \n+#[cfg(any(target_os = \"linux\", target_os = \"android\"))]\n use crate::convert::TryInto;\n+#[cfg(any(target_os = \"linux\", target_os = \"android\"))]\n use crate::ptr::null;\n use crate::sync::atomic::AtomicI32;\n use crate::time::Duration;\n \n+#[cfg(any(target_os = \"linux\", target_os = \"android\"))]\n pub fn futex_wait(futex: &AtomicI32, expected: i32, timeout: Option<Duration>) {\n     let timespec = timeout.and_then(|d| {\n         Some(libc::timespec {\n@@ -25,6 +32,28 @@ pub fn futex_wait(futex: &AtomicI32, expected: i32, timeout: Option<Duration>) {\n     }\n }\n \n+#[cfg(target_os = \"emscripten\")]\n+pub fn futex_wait(futex: &AtomicI32, expected: i32, timeout: Option<Duration>) {\n+    extern \"C\" {\n+        fn emscripten_futex_wait(\n+            addr: *const AtomicI32,\n+            val: libc::c_uint,\n+            max_wait_ms: libc::c_double,\n+        ) -> libc::c_int;\n+    }\n+\n+    unsafe {\n+        emscripten_futex_wait(\n+            futex as *const AtomicI32,\n+            // `val` is declared unsigned to match the Emscripten headers, but since it's used as\n+            // an opaque value, we can ignore the meaning of signed vs. unsigned and cast here.\n+            expected as libc::c_uint,\n+            timeout.map_or(crate::f64::INFINITY, |d| d.as_secs_f64() * 1000.0),\n+        );\n+    }\n+}\n+\n+#[cfg(any(target_os = \"linux\", target_os = \"android\"))]\n pub fn futex_wake(futex: &AtomicI32) {\n     unsafe {\n         libc::syscall(\n@@ -35,3 +64,14 @@ pub fn futex_wake(futex: &AtomicI32) {\n         );\n     }\n }\n+\n+#[cfg(target_os = \"emscripten\")]\n+pub fn futex_wake(futex: &AtomicI32) {\n+    extern \"C\" {\n+        fn emscripten_futex_wake(addr: *const AtomicI32, count: libc::c_int) -> libc::c_int;\n+    }\n+\n+    unsafe {\n+        emscripten_futex_wake(futex as *const AtomicI32, 1);\n+    }\n+}"}, {"sha": "cda17eb4bd23c8110f77db4d89a8313c5f25956a", "filename": "library/std/src/sys/unix/thread.rs", "status": "modified", "additions": 1, "deletions": 19, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/55794e43960ad3647e78ea5b0cb5ad0c5c0596a8/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fthread.rs", "raw_url": "https://github.com/rust-lang/rust/raw/55794e43960ad3647e78ea5b0cb5ad0c5c0596a8/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fthread.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fthread.rs?ref=55794e43960ad3647e78ea5b0cb5ad0c5c0596a8", "patch": "@@ -22,24 +22,6 @@ pub struct Thread {\n unsafe impl Send for Thread {}\n unsafe impl Sync for Thread {}\n \n-// The pthread_attr_setstacksize symbol doesn't exist in the emscripten libc,\n-// so we have to not link to it to satisfy emcc's ERROR_ON_UNDEFINED_SYMBOLS.\n-#[cfg(not(target_os = \"emscripten\"))]\n-unsafe fn pthread_attr_setstacksize(\n-    attr: *mut libc::pthread_attr_t,\n-    stack_size: libc::size_t,\n-) -> libc::c_int {\n-    libc::pthread_attr_setstacksize(attr, stack_size)\n-}\n-\n-#[cfg(target_os = \"emscripten\")]\n-unsafe fn pthread_attr_setstacksize(\n-    _attr: *mut libc::pthread_attr_t,\n-    _stack_size: libc::size_t,\n-) -> libc::c_int {\n-    panic!()\n-}\n-\n impl Thread {\n     // unsafe: see thread::Builder::spawn_unchecked for safety requirements\n     pub unsafe fn new(stack: usize, p: Box<dyn FnOnce()>) -> io::Result<Thread> {\n@@ -50,7 +32,7 @@ impl Thread {\n \n         let stack_size = cmp::max(stack, min_stack_size(&attr));\n \n-        match pthread_attr_setstacksize(&mut attr, stack_size) {\n+        match libc::pthread_attr_setstacksize(&mut attr, stack_size) {\n             0 => {}\n             n => {\n                 assert_eq!(n, libc::EINVAL);"}]}