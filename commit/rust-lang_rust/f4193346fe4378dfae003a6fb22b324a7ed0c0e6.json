{"sha": "f4193346fe4378dfae003a6fb22b324a7ed0c0e6", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY0MTkzMzQ2ZmU0Mzc4ZGZhZTAwM2E2ZmIyMmIzMjRhN2VkMGMwZTY=", "commit": {"author": {"name": "Mara Bos", "email": "m-ou.se@m-ou.se", "date": "2021-09-02T17:10:20Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-09-02T17:10:20Z"}, "message": "Rollup merge of #88567 - camelid:query-job-info, r=cjgillot\n\nRemove redundant `Span` in `QueryJobInfo`\n\nPreviously, `QueryJobInfo` was composed of two parts: a `QueryInfo` and\na `QueryJob`. However, both `QueryInfo` and `QueryJob` have a `span`\nfield, which seem to be the same. So, the `span` was recorded twice.\n\nNow, `QueryJobInfo` is composed of a `QueryStackFrame` (the other field\nof `QueryInfo`) and a `QueryJob`. So, now, the `span` is only recorded\nonce.", "tree": {"sha": "029c9bf744f928b5f4dd908fe2548af4fbee7830", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/029c9bf744f928b5f4dd908fe2548af4fbee7830"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f4193346fe4378dfae003a6fb22b324a7ed0c0e6", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhMQV8CRBK7hj4Ov3rIwAADOkIAA5ww/Y33OmRockWVXqYJxWP\nGZN+xxFGHDyZot3n+cHXRPrAewBzY+6lH6ntmIcGHCnoOW37jPv1L4u3gUHP5yjn\n7rJ3JD48AY5NsTkI3CuVH+dAdSBhBoZHDO0lWqbhzxC9aRg3oRsrQsxmUsy/8wDc\nkbgvILjpGzP1E4+SlAs3/rsPSaABP/Dl6+evOVhFz2ipr7uz/ginATSt2I2Wk0gm\nfTySNfIsLAXeJcLeu9c6/IJOUY7LJXQ3pcuLN9V5MIiv09LuVRTcq8Ha6fl1zqF6\nSc2K0qFc/3frmagkQoVJbYeIXnsLPqFAvrXSQ7c+HFgb/2iDqPCRzNP4Qi3GlbA=\n=LOB5\n-----END PGP SIGNATURE-----\n", "payload": "tree 029c9bf744f928b5f4dd908fe2548af4fbee7830\nparent e248c4d5d0459fbf2a796e5bb413adca37d37b16\nparent 4553a4baf2b365541c2322462a31eb5e5f43f3b5\nauthor Mara Bos <m-ou.se@m-ou.se> 1630602620 +0200\ncommitter GitHub <noreply@github.com> 1630602620 +0200\n\nRollup merge of #88567 - camelid:query-job-info, r=cjgillot\n\nRemove redundant `Span` in `QueryJobInfo`\n\nPreviously, `QueryJobInfo` was composed of two parts: a `QueryInfo` and\na `QueryJob`. However, both `QueryInfo` and `QueryJob` have a `span`\nfield, which seem to be the same. So, the `span` was recorded twice.\n\nNow, `QueryJobInfo` is composed of a `QueryStackFrame` (the other field\nof `QueryInfo`) and a `QueryJob`. So, now, the `span` is only recorded\nonce.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f4193346fe4378dfae003a6fb22b324a7ed0c0e6", "html_url": "https://github.com/rust-lang/rust/commit/f4193346fe4378dfae003a6fb22b324a7ed0c0e6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f4193346fe4378dfae003a6fb22b324a7ed0c0e6/comments", "author": {"login": "m-ou-se", "id": 783247, "node_id": "MDQ6VXNlcjc4MzI0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/783247?v=4", "gravatar_id": "", "url": "https://api.github.com/users/m-ou-se", "html_url": "https://github.com/m-ou-se", "followers_url": "https://api.github.com/users/m-ou-se/followers", "following_url": "https://api.github.com/users/m-ou-se/following{/other_user}", "gists_url": "https://api.github.com/users/m-ou-se/gists{/gist_id}", "starred_url": "https://api.github.com/users/m-ou-se/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/m-ou-se/subscriptions", "organizations_url": "https://api.github.com/users/m-ou-se/orgs", "repos_url": "https://api.github.com/users/m-ou-se/repos", "events_url": "https://api.github.com/users/m-ou-se/events{/privacy}", "received_events_url": "https://api.github.com/users/m-ou-se/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e248c4d5d0459fbf2a796e5bb413adca37d37b16", "url": "https://api.github.com/repos/rust-lang/rust/commits/e248c4d5d0459fbf2a796e5bb413adca37d37b16", "html_url": "https://github.com/rust-lang/rust/commit/e248c4d5d0459fbf2a796e5bb413adca37d37b16"}, {"sha": "4553a4baf2b365541c2322462a31eb5e5f43f3b5", "url": "https://api.github.com/repos/rust-lang/rust/commits/4553a4baf2b365541c2322462a31eb5e5f43f3b5", "html_url": "https://github.com/rust-lang/rust/commit/4553a4baf2b365541c2322462a31eb5e5f43f3b5"}], "stats": {"total": 19, "additions": 8, "deletions": 11}, "files": [{"sha": "c3fdf4fc228511b0ebc767267f052461f681196a", "filename": "compiler/rustc_query_system/src/query/job.rs", "status": "modified", "additions": 6, "deletions": 9, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/f4193346fe4378dfae003a6fb22b324a7ed0c0e6/compiler%2Frustc_query_system%2Fsrc%2Fquery%2Fjob.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f4193346fe4378dfae003a6fb22b324a7ed0c0e6/compiler%2Frustc_query_system%2Fsrc%2Fquery%2Fjob.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_query_system%2Fsrc%2Fquery%2Fjob.rs?ref=f4193346fe4378dfae003a6fb22b324a7ed0c0e6", "patch": "@@ -61,7 +61,7 @@ where\n     }\n \n     fn query(self, map: &QueryMap<D>) -> QueryStackFrame {\n-        map.get(&self).unwrap().info.query.clone()\n+        map.get(&self).unwrap().query.clone()\n     }\n \n     #[cfg(parallel_compiler)]\n@@ -81,7 +81,7 @@ where\n }\n \n pub struct QueryJobInfo<D> {\n-    pub info: QueryInfo,\n+    pub query: QueryStackFrame,\n     pub job: QueryJob<D>,\n }\n \n@@ -155,7 +155,7 @@ where\n \n         while let Some(job) = current_job {\n             let info = query_map.get(&job).unwrap();\n-            cycle.push(info.info.clone());\n+            cycle.push(QueryInfo { span: info.job.span, query: info.query.clone() });\n \n             if job == *self {\n                 cycle.reverse();\n@@ -170,7 +170,7 @@ where\n                     .job\n                     .parent\n                     .as_ref()\n-                    .map(|parent| (info.info.span, parent.query(&query_map)));\n+                    .map(|parent| (info.job.span, parent.query(&query_map)));\n                 return CycleError { usage, cycle };\n             }\n \n@@ -649,13 +649,10 @@ pub fn print_query_stack<CTX: QueryContext>(\n         };\n         let mut diag = Diagnostic::new(\n             Level::FailureNote,\n-            &format!(\n-                \"#{} [{}] {}\",\n-                i, query_info.info.query.name, query_info.info.query.description\n-            ),\n+            &format!(\"#{} [{}] {}\", i, query_info.query.name, query_info.query.description),\n         );\n         diag.span =\n-            tcx.dep_context().sess().source_map().guess_head_span(query_info.info.span).into();\n+            tcx.dep_context().sess().source_map().guess_head_span(query_info.job.span).into();\n         handler.force_print_diagnostic(diag);\n \n         current_query = query_info.job.parent;"}, {"sha": "3f22de6fba4077987d673cb21dfe8a4fea89b830", "filename": "compiler/rustc_query_system/src/query/plumbing.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/f4193346fe4378dfae003a6fb22b324a7ed0c0e6/compiler%2Frustc_query_system%2Fsrc%2Fquery%2Fplumbing.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f4193346fe4378dfae003a6fb22b324a7ed0c0e6/compiler%2Frustc_query_system%2Fsrc%2Fquery%2Fplumbing.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_query_system%2Fsrc%2Fquery%2Fplumbing.rs?ref=f4193346fe4378dfae003a6fb22b324a7ed0c0e6", "patch": "@@ -130,8 +130,8 @@ where\n             for (k, v) in shard.active.iter() {\n                 if let QueryResult::Started(ref job) = *v {\n                     let id = QueryJobId::new(job.id, shard_id, kind);\n-                    let info = QueryInfo { span: job.span, query: make_query(tcx, k.clone()) };\n-                    jobs.insert(id, QueryJobInfo { info, job: job.clone() });\n+                    let query = make_query(tcx, k.clone());\n+                    jobs.insert(id, QueryJobInfo { query, job: job.clone() });\n                 }\n             }\n         }"}]}