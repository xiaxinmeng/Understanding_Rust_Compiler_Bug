{"sha": "dceafac96dd857031bd11a0c3078cde9a75ccd86", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRjZWFmYWM5NmRkODU3MDMxYmQxMWEwYzMwNzhjZGU5YTc1Y2NkODY=", "commit": {"author": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2020-07-15T18:01:29Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-07-15T18:01:29Z"}, "message": "Rollup merge of #74347 - jyn514:ive-got-a-small-query-for-you, r=eddyb\n\nInitialize default providers only once\n\nThis avoids copying a new `Providers` struct for each downstream crate\nthat wants to use it.\n\nFollow-up to https://github.com/rust-lang/rust/pull/74283 without the perf hit.\n\nr? @eddyb", "tree": {"sha": "af428986997b645ecdf10a16e2cf56df254e868e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/af428986997b645ecdf10a16e2cf56df254e868e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/dceafac96dd857031bd11a0c3078cde9a75ccd86", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfD0R6CRBK7hj4Ov3rIwAAdHIIALJyrJ/ftCSEFDI+qZq8/O78\nGI+KdATsn3r0VbXCBqC3pY9szO5RGYDG+qh+5utfo8lLfqHryVMt341pavhlArYo\nsTsuDvf2Ga8Oo+kIpRTd6A3p4lC0KB8xi3Q41L6vwOs6BjfXDM/T/Cs64/+7xHjB\n6acVRUUEPTSxkW5xRcnvbIxhBSXn5JqqaTmXZ92c1glhL+lTe6hLGciMeP3jweKF\nCMN7Kq2rkpoKJ2wu8+07NWO2HSj5zRQwiDuyKZ+hGY4BOkbFy5JDlwQpEc9+8YeU\n/L8bR42GKuljee9ZHVrKQmEs8XAPiPVb2cqTHzTBEnoXVaoE6jV7B/sEXtxr8ao=\n=jLgh\n-----END PGP SIGNATURE-----\n", "payload": "tree af428986997b645ecdf10a16e2cf56df254e868e\nparent bee28990d3d3c43f1c6dd83e4623cfa3e5f65caf\nparent f6764c42ab3a7d8875680536ec1e8df7d0ed3100\nauthor Manish Goregaokar <manishsmail@gmail.com> 1594836089 -0700\ncommitter GitHub <noreply@github.com> 1594836089 -0700\n\nRollup merge of #74347 - jyn514:ive-got-a-small-query-for-you, r=eddyb\n\nInitialize default providers only once\n\nThis avoids copying a new `Providers` struct for each downstream crate\nthat wants to use it.\n\nFollow-up to https://github.com/rust-lang/rust/pull/74283 without the perf hit.\n\nr? @eddyb\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/dceafac96dd857031bd11a0c3078cde9a75ccd86", "html_url": "https://github.com/rust-lang/rust/commit/dceafac96dd857031bd11a0c3078cde9a75ccd86", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/dceafac96dd857031bd11a0c3078cde9a75ccd86/comments", "author": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bee28990d3d3c43f1c6dd83e4623cfa3e5f65caf", "url": "https://api.github.com/repos/rust-lang/rust/commits/bee28990d3d3c43f1c6dd83e4623cfa3e5f65caf", "html_url": "https://github.com/rust-lang/rust/commit/bee28990d3d3c43f1c6dd83e4623cfa3e5f65caf"}, {"sha": "f6764c42ab3a7d8875680536ec1e8df7d0ed3100", "url": "https://api.github.com/repos/rust-lang/rust/commits/f6764c42ab3a7d8875680536ec1e8df7d0ed3100", "html_url": "https://github.com/rust-lang/rust/commit/f6764c42ab3a7d8875680536ec1e8df7d0ed3100"}], "stats": {"total": 26, "additions": 16, "deletions": 10}, "files": [{"sha": "fe40c615f79c96f4aec3fd521be3f5d6c657f358", "filename": "src/librustc_interface/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/dceafac96dd857031bd11a0c3078cde9a75ccd86/src%2Flibrustc_interface%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dceafac96dd857031bd11a0c3078cde9a75ccd86/src%2Flibrustc_interface%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_interface%2Flib.rs?ref=dceafac96dd857031bd11a0c3078cde9a75ccd86", "patch": "@@ -14,6 +14,7 @@ mod queries;\n pub mod util;\n \n pub use interface::{run_compiler, Config};\n+pub use passes::{DEFAULT_EXTERN_QUERY_PROVIDERS, DEFAULT_QUERY_PROVIDERS};\n pub use queries::Queries;\n \n #[cfg(test)]"}, {"sha": "af4397075bb600a5171b588c2482a8e7723c3100", "filename": "src/librustc_interface/passes.rs", "status": "modified", "additions": 15, "deletions": 10, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/dceafac96dd857031bd11a0c3078cde9a75ccd86/src%2Flibrustc_interface%2Fpasses.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dceafac96dd857031bd11a0c3078cde9a75ccd86/src%2Flibrustc_interface%2Fpasses.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_interface%2Fpasses.rs?ref=dceafac96dd857031bd11a0c3078cde9a75ccd86", "patch": "@@ -3,6 +3,7 @@ use crate::proc_macro_decls;\n use crate::util;\n \n use log::{info, log_enabled, warn};\n+use once_cell::sync::Lazy;\n use rustc_ast::mut_visit::MutVisitor;\n use rustc_ast::{self, ast, visit};\n use rustc_codegen_ssa::back::link::emit_metadata;\n@@ -19,6 +20,7 @@ use rustc_middle::arena::Arena;\n use rustc_middle::dep_graph::DepGraph;\n use rustc_middle::middle;\n use rustc_middle::middle::cstore::{CrateStore, MetadataLoader, MetadataLoaderDyn};\n+use rustc_middle::ty::query::Providers;\n use rustc_middle::ty::steal::Steal;\n use rustc_middle::ty::{self, GlobalCtxt, ResolverOutputs, TyCtxt};\n use rustc_mir as mir;\n@@ -719,7 +721,8 @@ pub fn prepare_outputs(\n     Ok(outputs)\n }\n \n-pub fn default_provide(providers: &mut ty::query::Providers) {\n+pub static DEFAULT_QUERY_PROVIDERS: Lazy<Providers> = Lazy::new(|| {\n+    let providers = &mut Providers::default();\n     providers.analysis = analysis;\n     proc_macro_decls::provide(providers);\n     plugin::build::provide(providers);\n@@ -738,12 +741,15 @@ pub fn default_provide(providers: &mut ty::query::Providers) {\n     rustc_lint::provide(providers);\n     rustc_symbol_mangling::provide(providers);\n     rustc_codegen_ssa::provide(providers);\n-}\n+    *providers\n+});\n \n-pub fn default_provide_extern(providers: &mut ty::query::Providers) {\n-    rustc_metadata::provide_extern(providers);\n-    rustc_codegen_ssa::provide_extern(providers);\n-}\n+pub static DEFAULT_EXTERN_QUERY_PROVIDERS: Lazy<Providers> = Lazy::new(|| {\n+    let mut extern_providers = *DEFAULT_QUERY_PROVIDERS;\n+    rustc_metadata::provide_extern(&mut extern_providers);\n+    rustc_codegen_ssa::provide_extern(&mut extern_providers);\n+    extern_providers\n+});\n \n pub struct QueryContext<'tcx>(&'tcx GlobalCtxt<'tcx>);\n \n@@ -780,12 +786,11 @@ pub fn create_global_ctxt<'tcx>(\n     let query_result_on_disk_cache = rustc_incremental::load_query_result_cache(sess);\n \n     let codegen_backend = compiler.codegen_backend();\n-    let mut local_providers = ty::query::Providers::default();\n-    default_provide(&mut local_providers);\n+    let mut local_providers = *DEFAULT_QUERY_PROVIDERS;\n     codegen_backend.provide(&mut local_providers);\n \n-    let mut extern_providers = local_providers;\n-    default_provide_extern(&mut extern_providers);\n+    let mut extern_providers = *DEFAULT_EXTERN_QUERY_PROVIDERS;\n+    codegen_backend.provide(&mut extern_providers);\n     codegen_backend.provide_extern(&mut extern_providers);\n \n     if let Some(callback) = compiler.override_queries {"}]}