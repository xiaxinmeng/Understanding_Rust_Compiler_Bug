{"sha": "fbbcb089c52e6dce88600be36a1cc97884294d4f", "node_id": "C_kwDOAAsO6NoAKGZiYmNiMDg5YzUyZTZkY2U4ODYwMGJlMzZhMWNjOTc4ODQyOTRkNGY", "commit": {"author": {"name": "Will Crichton", "email": "wcrichto@cs.stanford.edu", "date": "2022-02-12T05:48:59Z"}, "committer": {"name": "Will Crichton", "email": "wcrichto@cs.stanford.edu", "date": "2022-02-12T05:48:59Z"}, "message": "Add --scrape-tests flags so rustdoc can scrape examples from tests", "tree": {"sha": "f82d4a8451f0f28b1761630043cbea2191bc6bfd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f82d4a8451f0f28b1761630043cbea2191bc6bfd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fbbcb089c52e6dce88600be36a1cc97884294d4f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fbbcb089c52e6dce88600be36a1cc97884294d4f", "html_url": "https://github.com/rust-lang/rust/commit/fbbcb089c52e6dce88600be36a1cc97884294d4f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fbbcb089c52e6dce88600be36a1cc97884294d4f/comments", "author": {"login": "willcrichton", "id": 663326, "node_id": "MDQ6VXNlcjY2MzMyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/663326?v=4", "gravatar_id": "", "url": "https://api.github.com/users/willcrichton", "html_url": "https://github.com/willcrichton", "followers_url": "https://api.github.com/users/willcrichton/followers", "following_url": "https://api.github.com/users/willcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/willcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/willcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/willcrichton/subscriptions", "organizations_url": "https://api.github.com/users/willcrichton/orgs", "repos_url": "https://api.github.com/users/willcrichton/repos", "events_url": "https://api.github.com/users/willcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/willcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "willcrichton", "id": 663326, "node_id": "MDQ6VXNlcjY2MzMyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/663326?v=4", "gravatar_id": "", "url": "https://api.github.com/users/willcrichton", "html_url": "https://github.com/willcrichton", "followers_url": "https://api.github.com/users/willcrichton/followers", "following_url": "https://api.github.com/users/willcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/willcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/willcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/willcrichton/subscriptions", "organizations_url": "https://api.github.com/users/willcrichton/orgs", "repos_url": "https://api.github.com/users/willcrichton/repos", "events_url": "https://api.github.com/users/willcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/willcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0c292c9667f1b202a9150d58bdd2e89e3e803996", "url": "https://api.github.com/repos/rust-lang/rust/commits/0c292c9667f1b202a9150d58bdd2e89e3e803996", "html_url": "https://github.com/rust-lang/rust/commit/0c292c9667f1b202a9150d58bdd2e89e3e803996"}], "stats": {"total": 42, "additions": 37, "deletions": 5}, "files": [{"sha": "c7fd5ed6fcb2ed28d2bd217e35a94928c8326d7d", "filename": "src/doc/rustdoc/src/unstable-features.md", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/fbbcb089c52e6dce88600be36a1cc97884294d4f/src%2Fdoc%2Frustdoc%2Fsrc%2Funstable-features.md", "raw_url": "https://github.com/rust-lang/rust/raw/fbbcb089c52e6dce88600be36a1cc97884294d4f/src%2Fdoc%2Frustdoc%2Fsrc%2Funstable-features.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Frustdoc%2Fsrc%2Funstable-features.md?ref=fbbcb089c52e6dce88600be36a1cc97884294d4f", "patch": "@@ -509,3 +509,6 @@ reverse-dependency like `examples/ex.rs` is given to rustdoc with the target\n crate being documented (`foobar`) and a path to output the calls\n (`output.calls`). Then, the generated calls file can be passed via\n `--with-examples` to the subsequent documentation of `foobar`.\n+\n+To scrape examples from test code, e.g. functions marked `#[test]`, then\n+add the `--scrape-tests` flag."}, {"sha": "955572850c6e8d64374541b15f0fffc4138e760e", "filename": "src/librustdoc/core.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/fbbcb089c52e6dce88600be36a1cc97884294d4f/src%2Flibrustdoc%2Fcore.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fbbcb089c52e6dce88600be36a1cc97884294d4f/src%2Flibrustdoc%2Fcore.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fcore.rs?ref=fbbcb089c52e6dce88600be36a1cc97884294d4f", "patch": "@@ -200,6 +200,7 @@ crate fn create_config(\n         lint_opts,\n         describe_lints,\n         lint_cap,\n+        scrape_examples_options,\n         ..\n     }: RustdocOptions,\n ) -> rustc_interface::Config {\n@@ -227,6 +228,7 @@ crate fn create_config(\n \n     let crate_types =\n         if proc_macro_crate { vec![CrateType::ProcMacro] } else { vec![CrateType::Rlib] };\n+    let test = scrape_examples_options.map(|opts| opts.scrape_tests).unwrap_or(false);\n     // plays with error output here!\n     let sessopts = config::Options {\n         maybe_sysroot,\n@@ -244,6 +246,7 @@ crate fn create_config(\n         edition,\n         describe_lints,\n         crate_name,\n+        test,\n         ..Options::default()\n     };\n "}, {"sha": "dbd0168284251ec01d9413d55ce28ac4784a800f", "filename": "src/librustdoc/lib.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/fbbcb089c52e6dce88600be36a1cc97884294d4f/src%2Flibrustdoc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fbbcb089c52e6dce88600be36a1cc97884294d4f/src%2Flibrustdoc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Flib.rs?ref=fbbcb089c52e6dce88600be36a1cc97884294d4f", "patch": "@@ -596,6 +596,9 @@ fn opts() -> Vec<RustcOptGroup> {\n                 \"collect function call information for functions from the target crate\",\n             )\n         }),\n+        unstable(\"scrape-tests\", |o| {\n+            o.optflag(\"\", \"scrape-tests\", \"Include test code when scraping examples\")\n+        }),\n         unstable(\"with-examples\", |o| {\n             o.optmulti(\n                 \"\","}, {"sha": "80292b208663d8ff5e772079c79d1e6a8e2ae5db", "filename": "src/librustdoc/scrape_examples.rs", "status": "modified", "additions": 11, "deletions": 4, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/fbbcb089c52e6dce88600be36a1cc97884294d4f/src%2Flibrustdoc%2Fscrape_examples.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fbbcb089c52e6dce88600be36a1cc97884294d4f/src%2Flibrustdoc%2Fscrape_examples.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fscrape_examples.rs?ref=fbbcb089c52e6dce88600be36a1cc97884294d4f", "patch": "@@ -34,6 +34,7 @@ use std::path::PathBuf;\n crate struct ScrapeExamplesOptions {\n     output_path: PathBuf,\n     target_crates: Vec<String>,\n+    crate scrape_tests: bool,\n }\n \n impl ScrapeExamplesOptions {\n@@ -43,16 +44,22 @@ impl ScrapeExamplesOptions {\n     ) -> Result<Option<Self>, i32> {\n         let output_path = matches.opt_str(\"scrape-examples-output-path\");\n         let target_crates = matches.opt_strs(\"scrape-examples-target-crate\");\n-        match (output_path, !target_crates.is_empty()) {\n-            (Some(output_path), true) => Ok(Some(ScrapeExamplesOptions {\n+        let scrape_tests = matches.opt_present(\"scrape-tests\");\n+        match (output_path, !target_crates.is_empty(), scrape_tests) {\n+            (Some(output_path), true, _) => Ok(Some(ScrapeExamplesOptions {\n                 output_path: PathBuf::from(output_path),\n                 target_crates,\n+                scrape_tests,\n             })),\n-            (Some(_), false) | (None, true) => {\n+            (Some(_), false, _) | (None, true, _) => {\n                 diag.err(\"must use --scrape-examples-output-path and --scrape-examples-target-crate together\");\n                 Err(1)\n             }\n-            (None, false) => Ok(None),\n+            (None, false, true) => {\n+                diag.err(\"must use --scrape-examples-output-path and --scrape-examples-target-crate with --scrape-tests\");\n+                Err(1)\n+            }\n+            (None, false, false) => Ok(None),\n         }\n     }\n }"}, {"sha": "d49b6c1f290cb1633ada9884640851b88530ed2c", "filename": "src/test/run-make/rustdoc-scrape-examples-multiple/scrape.mk", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/fbbcb089c52e6dce88600be36a1cc97884294d4f/src%2Ftest%2Frun-make%2Frustdoc-scrape-examples-multiple%2Fscrape.mk", "raw_url": "https://github.com/rust-lang/rust/raw/fbbcb089c52e6dce88600be36a1cc97884294d4f/src%2Ftest%2Frun-make%2Frustdoc-scrape-examples-multiple%2Fscrape.mk", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Frustdoc-scrape-examples-multiple%2Fscrape.mk?ref=fbbcb089c52e6dce88600be36a1cc97884294d4f", "patch": "@@ -7,7 +7,8 @@ $(TMPDIR)/%.calls: $(TMPDIR)/libfoobar.rmeta\n \t  --extern foobar=$(TMPDIR)/libfoobar.rmeta \\\n \t\t-Z unstable-options \\\n \t\t--scrape-examples-output-path $@ \\\n-\t\t--scrape-examples-target-crate foobar\n+\t\t--scrape-examples-target-crate foobar \\\n+\t\t$(extra_flags)\n \n $(TMPDIR)/lib%.rmeta: src/lib.rs\n \t$(RUSTC) src/lib.rs --crate-name $* --crate-type lib --emit=metadata"}, {"sha": "9f80a8d96022f457c3b99069b168bfba5940c606", "filename": "src/test/run-make/rustdoc-scrape-examples-test/Makefile", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/fbbcb089c52e6dce88600be36a1cc97884294d4f/src%2Ftest%2Frun-make%2Frustdoc-scrape-examples-test%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/fbbcb089c52e6dce88600be36a1cc97884294d4f/src%2Ftest%2Frun-make%2Frustdoc-scrape-examples-test%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Frustdoc-scrape-examples-test%2FMakefile?ref=fbbcb089c52e6dce88600be36a1cc97884294d4f", "patch": "@@ -0,0 +1,6 @@\n+extra_flags := --scrape-tests\n+deps := ex\n+\n+-include ../rustdoc-scrape-examples-multiple/scrape.mk\n+\n+all: scrape"}, {"sha": "d1a9a74e7825c55985e6d2a8d0c47831a2d1e789", "filename": "src/test/run-make/rustdoc-scrape-examples-test/examples/ex.rs", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/fbbcb089c52e6dce88600be36a1cc97884294d4f/src%2Ftest%2Frun-make%2Frustdoc-scrape-examples-test%2Fexamples%2Fex.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fbbcb089c52e6dce88600be36a1cc97884294d4f/src%2Ftest%2Frun-make%2Frustdoc-scrape-examples-test%2Fexamples%2Fex.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Frustdoc-scrape-examples-test%2Fexamples%2Fex.rs?ref=fbbcb089c52e6dce88600be36a1cc97884294d4f", "patch": "@@ -0,0 +1,6 @@\n+fn main() {}\n+\n+#[test]\n+fn a_test() {\n+  foobar::ok();\n+}"}, {"sha": "22be1ad41010f93a6fb64e3756df9927618511eb", "filename": "src/test/run-make/rustdoc-scrape-examples-test/src/lib.rs", "status": "added", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/fbbcb089c52e6dce88600be36a1cc97884294d4f/src%2Ftest%2Frun-make%2Frustdoc-scrape-examples-test%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fbbcb089c52e6dce88600be36a1cc97884294d4f/src%2Ftest%2Frun-make%2Frustdoc-scrape-examples-test%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Frustdoc-scrape-examples-test%2Fsrc%2Flib.rs?ref=fbbcb089c52e6dce88600be36a1cc97884294d4f", "patch": "@@ -0,0 +1,3 @@\n+// @has foobar/fn.ok.html '//*[@class=\"docblock scraped-example-list\"]' ''\n+\n+pub fn ok() {}"}]}