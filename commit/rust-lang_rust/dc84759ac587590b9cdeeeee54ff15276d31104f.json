{"sha": "dc84759ac587590b9cdeeeee54ff15276d31104f", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRjODQ3NTlhYzU4NzU5MGI5Y2RlZWVlZTU0ZmYxNTI3NmQzMTEwNGY=", "commit": {"author": {"name": "Martin Carton", "email": "cartonmartin+github@gmail.com", "date": "2016-09-13T13:58:31Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2016-09-13T13:58:31Z"}, "message": "Merge pull request #1224 from oli-obk/divergence\n\nlint diverging expressions that are sub-expressions of others", "tree": {"sha": "0b33b05b66cc2cc6d0f4a6fed49a6143cf82a312", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0b33b05b66cc2cc6d0f4a6fed49a6143cf82a312"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/dc84759ac587590b9cdeeeee54ff15276d31104f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/dc84759ac587590b9cdeeeee54ff15276d31104f", "html_url": "https://github.com/rust-lang/rust/commit/dc84759ac587590b9cdeeeee54ff15276d31104f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/dc84759ac587590b9cdeeeee54ff15276d31104f/comments", "author": {"login": "mcarton", "id": 3751788, "node_id": "MDQ6VXNlcjM3NTE3ODg=", "avatar_url": "https://avatars.githubusercontent.com/u/3751788?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mcarton", "html_url": "https://github.com/mcarton", "followers_url": "https://api.github.com/users/mcarton/followers", "following_url": "https://api.github.com/users/mcarton/following{/other_user}", "gists_url": "https://api.github.com/users/mcarton/gists{/gist_id}", "starred_url": "https://api.github.com/users/mcarton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mcarton/subscriptions", "organizations_url": "https://api.github.com/users/mcarton/orgs", "repos_url": "https://api.github.com/users/mcarton/repos", "events_url": "https://api.github.com/users/mcarton/events{/privacy}", "received_events_url": "https://api.github.com/users/mcarton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "05e734b5552ed1a04ab799f06a8dc7db2db73fe7", "url": "https://api.github.com/repos/rust-lang/rust/commits/05e734b5552ed1a04ab799f06a8dc7db2db73fe7", "html_url": "https://github.com/rust-lang/rust/commit/05e734b5552ed1a04ab799f06a8dc7db2db73fe7"}, {"sha": "9427a4ae8055d3ecf3ecfb2296d6a8e60868cbc0", "url": "https://api.github.com/repos/rust-lang/rust/commits/9427a4ae8055d3ecf3ecfb2296d6a8e60868cbc0", "html_url": "https://github.com/rust-lang/rust/commit/9427a4ae8055d3ecf3ecfb2296d6a8e60868cbc0"}], "stats": {"total": 141, "additions": 138, "deletions": 3}, "files": [{"sha": "84bbf87d29c24907dd2a046bcca97fa58d802ba8", "filename": "CHANGELOG.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/dc84759ac587590b9cdeeeee54ff15276d31104f/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/dc84759ac587590b9cdeeeee54ff15276d31104f/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=dc84759ac587590b9cdeeeee54ff15276d31104f", "patch": "@@ -211,6 +211,7 @@ All notable changes to this project will be documented in this file.\n [`cyclomatic_complexity`]: https://github.com/Manishearth/rust-clippy/wiki#cyclomatic_complexity\n [`deprecated_semver`]: https://github.com/Manishearth/rust-clippy/wiki#deprecated_semver\n [`derive_hash_xor_eq`]: https://github.com/Manishearth/rust-clippy/wiki#derive_hash_xor_eq\n+[`diverging_sub_expression`]: https://github.com/Manishearth/rust-clippy/wiki#diverging_sub_expression\n [`doc_markdown`]: https://github.com/Manishearth/rust-clippy/wiki#doc_markdown\n [`double_neg`]: https://github.com/Manishearth/rust-clippy/wiki#double_neg\n [`drop_ref`]: https://github.com/Manishearth/rust-clippy/wiki#drop_ref"}, {"sha": "ba0973b0e67f47dfa1131a421577d524d5f6c88e", "filename": "README.md", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/dc84759ac587590b9cdeeeee54ff15276d31104f/README.md", "raw_url": "https://github.com/rust-lang/rust/raw/dc84759ac587590b9cdeeeee54ff15276d31104f/README.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/README.md?ref=dc84759ac587590b9cdeeeee54ff15276d31104f", "patch": "@@ -17,7 +17,7 @@ Table of contents:\n \n ## Lints\n \n-There are 170 lints included in this crate:\n+There are 171 lints included in this crate:\n \n name                                                                                                                 | default | triggers on\n ---------------------------------------------------------------------------------------------------------------------|---------|----------------------------------------------------------------------------------------------------------------------------------\n@@ -50,6 +50,7 @@ name\n [cyclomatic_complexity](https://github.com/Manishearth/rust-clippy/wiki#cyclomatic_complexity)                       | warn    | functions that should be split up into multiple functions\n [deprecated_semver](https://github.com/Manishearth/rust-clippy/wiki#deprecated_semver)                               | warn    | use of `#[deprecated(since = \"x\")]` where x is not semver\n [derive_hash_xor_eq](https://github.com/Manishearth/rust-clippy/wiki#derive_hash_xor_eq)                             | warn    | deriving `Hash` but implementing `PartialEq` explicitly\n+[diverging_sub_expression](https://github.com/Manishearth/rust-clippy/wiki#diverging_sub_expression)                 | warn    | whether an expression contains a diverging sub expression\n [doc_markdown](https://github.com/Manishearth/rust-clippy/wiki#doc_markdown)                                         | warn    | presence of `_`, `::` or camel-case outside backticks in documentation\n [double_neg](https://github.com/Manishearth/rust-clippy/wiki#double_neg)                                             | warn    | `--x`, which is a double negation of `x` and not a pre-decrement as in C/C++\n [drop_ref](https://github.com/Manishearth/rust-clippy/wiki#drop_ref)                                                 | warn    | calls to `std::mem::drop` with a reference instead of an owned value"}, {"sha": "e53c830e11dec860bf8bde8758c0762261ae69fa", "filename": "clippy_lints/src/eval_order_dependence.rs", "status": "modified", "additions": 97, "deletions": 2, "changes": 99, "blob_url": "https://github.com/rust-lang/rust/blob/dc84759ac587590b9cdeeeee54ff15276d31104f/clippy_lints%2Fsrc%2Feval_order_dependence.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dc84759ac587590b9cdeeeee54ff15276d31104f/clippy_lints%2Fsrc%2Feval_order_dependence.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Feval_order_dependence.rs?ref=dc84759ac587590b9cdeeeee54ff15276d31104f", "patch": "@@ -1,8 +1,9 @@\n use rustc::hir::def_id::DefId;\n use rustc::hir::intravisit::{Visitor, walk_expr};\n use rustc::hir::*;\n+use rustc::ty;\n use rustc::lint::*;\n-use utils::{get_parent_expr, span_note_and_lint};\n+use utils::{get_parent_expr, span_note_and_lint, span_lint};\n \n /// **What it does:** Checks for a read and a write to the same variable where\n /// whether the read occurs before or after the write depends on the evaluation\n@@ -26,12 +27,32 @@ declare_lint! {\n     \"whether a variable read occurs before a write depends on sub-expression evaluation order\"\n }\n \n+/// **What it does:** Checks for diverging calls that are not match arms or statements.\n+///\n+/// **Why is this bad?** It is often confusing to read. In addition, the\n+/// sub-expression evaluation order for Rust is not well documented.\n+///\n+/// **Known problems:** Someone might want to use `some_bool || panic!()` as a shorthand.\n+///\n+/// **Example:**\n+/// ```rust\n+/// let a = b() || panic!() || c();\n+/// // `c()` is dead, `panic!()` is only called if `b()` returns `false`\n+/// let x = (a, b, c, panic!());\n+/// // can simply be replaced by `panic!()`\n+/// ```\n+declare_lint! {\n+    pub DIVERGING_SUB_EXPRESSION,\n+    Warn,\n+    \"whether an expression contains a diverging sub expression\"\n+}\n+\n #[derive(Copy,Clone)]\n pub struct EvalOrderDependence;\n \n impl LintPass for EvalOrderDependence {\n     fn get_lints(&self) -> LintArray {\n-        lint_array!(EVAL_ORDER_DEPENDENCE)\n+        lint_array!(EVAL_ORDER_DEPENDENCE, DIVERGING_SUB_EXPRESSION)\n     }\n }\n \n@@ -56,6 +77,80 @@ impl LateLintPass for EvalOrderDependence {\n             _ => {}\n         }\n     }\n+    fn check_stmt(&mut self, cx: &LateContext, stmt: &Stmt) {\n+        match stmt.node {\n+            StmtExpr(ref e, _) | StmtSemi(ref e, _) => DivergenceVisitor(cx).maybe_walk_expr(e),\n+            StmtDecl(ref d, _) => {\n+                if let DeclLocal(ref local) = d.node {\n+                    if let Local { init: Some(ref e), .. } = **local {\n+                        DivergenceVisitor(cx).visit_expr(e);\n+                    }\n+                }\n+            },\n+        }\n+    }\n+}\n+\n+struct DivergenceVisitor<'a, 'tcx: 'a>(&'a LateContext<'a, 'tcx>);\n+\n+impl<'a, 'tcx> DivergenceVisitor<'a, 'tcx> {\n+    fn maybe_walk_expr(&mut self, e: &Expr) {\n+        match e.node {\n+            ExprClosure(..) => {},\n+            ExprMatch(ref e, ref arms, _) => {\n+                self.visit_expr(e);\n+                for arm in arms {\n+                    if let Some(ref guard) = arm.guard {\n+                        self.visit_expr(guard);\n+                    }\n+                    // make sure top level arm expressions aren't linted\n+                    walk_expr(self, &*arm.body);\n+                }\n+            }\n+            _ => walk_expr(self, e),\n+        }\n+    }\n+    fn report_diverging_sub_expr(&mut self, e: &Expr) {\n+        span_lint(\n+            self.0,\n+            DIVERGING_SUB_EXPRESSION,\n+            e.span,\n+            \"sub-expression diverges\",\n+        );\n+    }\n+}\n+\n+impl<'a, 'tcx, 'v> Visitor<'v> for DivergenceVisitor<'a, 'tcx> {\n+    fn visit_expr(&mut self, e: &'v Expr) {\n+        match e.node {\n+            ExprAgain(_) |\n+            ExprBreak(_) |\n+            ExprRet(_) => self.report_diverging_sub_expr(e),\n+            ExprCall(ref func, _) => match self.0.tcx.expr_ty(func).sty {\n+                ty::TyFnDef(_, _, fn_ty) |\n+                ty::TyFnPtr(fn_ty) => if let ty::TyNever = self.0.tcx.erase_late_bound_regions(&fn_ty.sig).output.sty {\n+                    self.report_diverging_sub_expr(e);\n+                },\n+                _ => {},\n+            },\n+            ExprMethodCall(..) => {\n+                let method_call = ty::MethodCall::expr(e.id);\n+                let borrowed_table = self.0.tcx.tables.borrow();\n+                let method_type = borrowed_table.method_map.get(&method_call).expect(\"This should never happen.\");\n+                let result_ty = method_type.ty.fn_ret();\n+                if let ty::TyNever = self.0.tcx.erase_late_bound_regions(&result_ty).sty {\n+                    self.report_diverging_sub_expr(e);\n+                }\n+            },\n+            _ => {\n+                // do not lint expressions referencing objects of type `!`, as that required a diverging expression to begin with\n+            },\n+        }\n+        self.maybe_walk_expr(e);\n+    }\n+    fn visit_block(&mut self, _: &'v Block) {\n+        // don't continue over blocks, LateLintPass already does that\n+    }\n }\n \n /// Walks up the AST from the the given write expression (`vis.write_expr`)"}, {"sha": "67108eb5688c0adab080286e58584feae62745d9", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/dc84759ac587590b9cdeeeee54ff15276d31104f/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dc84759ac587590b9cdeeeee54ff15276d31104f/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=dc84759ac587590b9cdeeeee54ff15276d31104f", "patch": "@@ -331,6 +331,7 @@ pub fn register_plugins(reg: &mut rustc_plugin::Registry) {\n         eq_op::EQ_OP,\n         escape::BOXED_LOCAL,\n         eta_reduction::REDUNDANT_CLOSURE,\n+        eval_order_dependence::DIVERGING_SUB_EXPRESSION,\n         eval_order_dependence::EVAL_ORDER_DEPENDENCE,\n         format::USELESS_FORMAT,\n         formatting::SUSPICIOUS_ASSIGNMENT_FORMATTING,"}, {"sha": "782c406d74c881ff25d24a7b80cd8739e47a8fd7", "filename": "tests/compile-fail/diverging_sub_expression.rs", "status": "added", "additions": 37, "deletions": 0, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/dc84759ac587590b9cdeeeee54ff15276d31104f/tests%2Fcompile-fail%2Fdiverging_sub_expression.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dc84759ac587590b9cdeeeee54ff15276d31104f/tests%2Fcompile-fail%2Fdiverging_sub_expression.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Fdiverging_sub_expression.rs?ref=dc84759ac587590b9cdeeeee54ff15276d31104f", "patch": "@@ -0,0 +1,37 @@\n+#![feature(plugin, never_type)]\n+#![plugin(clippy)]\n+#![deny(diverging_sub_expression)]\n+\n+#[allow(empty_loop)]\n+fn diverge() -> ! { loop {} }\n+\n+struct A;\n+\n+impl A {\n+    fn foo(&self) -> ! { diverge() }\n+}\n+\n+#[allow(unused_variables, unnecessary_operation)]\n+fn main() {\n+    let b = true;\n+    b || diverge(); //~ ERROR sub-expression diverges\n+    b || A.foo(); //~ ERROR sub-expression diverges\n+    let y = (5, diverge(), 6); //~ ERROR sub-expression diverges\n+    println!(\"{}\", y.1);\n+}\n+\n+#[allow(dead_code, unused_variables)]\n+fn foobar() {\n+    loop {\n+        let x = match 5 {\n+            4 => return,\n+            5 => continue,\n+            6 => (println!(\"foo\"), return), //~ ERROR sub-expression diverges\n+            7 => (println!(\"bar\"), continue), //~ ERROR sub-expression diverges\n+            8 => break,\n+            9 => diverge(),\n+            3 => (println!(\"moo\"), diverge()), //~ ERROR sub-expression diverges\n+            _ => (println!(\"boo\"), break), //~ ERROR sub-expression diverges\n+        };\n+    }\n+}"}]}