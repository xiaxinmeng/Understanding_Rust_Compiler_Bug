{"sha": "4db2241212bfda4f764df8f57acd87b72ed35d6a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRkYjIyNDEyMTJiZmRhNGY3NjRkZjhmNTdhY2Q4N2I3MmVkMzVkNmE=", "commit": {"author": {"name": "kennytm", "email": "kennytm@gmail.com", "date": "2018-05-24T08:02:39Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2018-05-24T08:02:39Z"}, "message": "Rollup merge of #50964 - michaelwoerister:query-symbol-names, r=nikomatsakis\n\nMake sure that queries have predictable symbol names.\n\nSome recent refactorings led to query names not showing up in the corresponding symbol names. [perf-focus](https://github.com/nikomatsakis/perf-focus) and manual profiling have been broken by this. This PR makes sure that query providers always get their own symbol and that that symbol has a predictable name.\n\nSince this adds `#[inline(never)]` to a function that wraps the provider call, let's check if this does not regress performance before merging.\n\nr? @nikomatsakis", "tree": {"sha": "56f3effc69475f8b58df63c7f5f1cf170c476475", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/56f3effc69475f8b58df63c7f5f1cf170c476475"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4db2241212bfda4f764df8f57acd87b72ed35d6a", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJbBnGfCRBK7hj4Ov3rIwAAdHIIAFmeVlyTpO1hPDZH4lPG+0WM\nkRawvdv6rykS9TvBc3tIjqesvYquCCE3cgR2MDFMkC6ujabcAGNeQR4KY7/a8jn/\nTFRr0YWlEuNU0LO3pJaZIK40DZ99/X7FCI7kxo34zOrK8O/x8S1uI3ZpDPj9No3v\n0Xp0ydA0krB+h2c0uk0S0uwQ1/undIHMEIh69quYz3W+f/2GgppJTAlPLd2D0Htq\nSXkU7C4C2W6Ua2tkT/+XvH18gWrBg2oFmAT21rvMCMpS7PmzX/uQS0yo2FqgRv+a\n15uBxQay5WclY89gCZRGRMtg1r66C4hKsfCV+OZEHoV6Q/OClxvyJaBMdSKoSQs=\n=QrGb\n-----END PGP SIGNATURE-----\n", "payload": "tree 56f3effc69475f8b58df63c7f5f1cf170c476475\nparent 02d53f2de7b420cdaab6e98d8fd958489cca42de\nparent 599b79ebf522aa9e7507a602844b2da573160347\nauthor kennytm <kennytm@gmail.com> 1527148959 +0800\ncommitter GitHub <noreply@github.com> 1527148959 +0800\n\nRollup merge of #50964 - michaelwoerister:query-symbol-names, r=nikomatsakis\n\nMake sure that queries have predictable symbol names.\n\nSome recent refactorings led to query names not showing up in the corresponding symbol names. [perf-focus](https://github.com/nikomatsakis/perf-focus) and manual profiling have been broken by this. This PR makes sure that query providers always get their own symbol and that that symbol has a predictable name.\n\nSince this adds `#[inline(never)]` to a function that wraps the provider call, let's check if this does not regress performance before merging.\n\nr? @nikomatsakis\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4db2241212bfda4f764df8f57acd87b72ed35d6a", "html_url": "https://github.com/rust-lang/rust/commit/4db2241212bfda4f764df8f57acd87b72ed35d6a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4db2241212bfda4f764df8f57acd87b72ed35d6a/comments", "author": {"login": "kennytm", "id": 103023, "node_id": "MDQ6VXNlcjEwMzAyMw==", "avatar_url": "https://avatars.githubusercontent.com/u/103023?v=4", "gravatar_id": "", "url": "https://api.github.com/users/kennytm", "html_url": "https://github.com/kennytm", "followers_url": "https://api.github.com/users/kennytm/followers", "following_url": "https://api.github.com/users/kennytm/following{/other_user}", "gists_url": "https://api.github.com/users/kennytm/gists{/gist_id}", "starred_url": "https://api.github.com/users/kennytm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/kennytm/subscriptions", "organizations_url": "https://api.github.com/users/kennytm/orgs", "repos_url": "https://api.github.com/users/kennytm/repos", "events_url": "https://api.github.com/users/kennytm/events{/privacy}", "received_events_url": "https://api.github.com/users/kennytm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "02d53f2de7b420cdaab6e98d8fd958489cca42de", "url": "https://api.github.com/repos/rust-lang/rust/commits/02d53f2de7b420cdaab6e98d8fd958489cca42de", "html_url": "https://github.com/rust-lang/rust/commit/02d53f2de7b420cdaab6e98d8fd958489cca42de"}, {"sha": "599b79ebf522aa9e7507a602844b2da573160347", "url": "https://api.github.com/repos/rust-lang/rust/commits/599b79ebf522aa9e7507a602844b2da573160347", "html_url": "https://github.com/rust-lang/rust/commit/599b79ebf522aa9e7507a602844b2da573160347"}], "stats": {"total": 17, "additions": 15, "deletions": 2}, "files": [{"sha": "4a9d44b7403b9a09a3fb688712ad96aacd4d776e", "filename": "src/librustc/ty/maps/plumbing.rs", "status": "modified", "additions": 15, "deletions": 2, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/4db2241212bfda4f764df8f57acd87b72ed35d6a/src%2Flibrustc%2Fty%2Fmaps%2Fplumbing.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4db2241212bfda4f764df8f57acd87b72ed35d6a/src%2Flibrustc%2Fty%2Fmaps%2Fplumbing.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fmaps%2Fplumbing.rs?ref=4db2241212bfda4f764df8f57acd87b72ed35d6a", "patch": "@@ -701,6 +701,16 @@ macro_rules! define_maps {\n             })*\n         }\n \n+        // This module and the functions in it exist only to provide a\n+        // predictable symbol name prefix for query providers. This is helpful\n+        // for analyzing queries in profilers.\n+        pub(super) mod __query_compute {\n+            $(#[inline(never)]\n+            pub fn $name<F: FnOnce() -> R, R>(f: F) -> R {\n+                f()\n+            })*\n+        }\n+\n         $(impl<$tcx> QueryConfig<$tcx> for queries::$name<$tcx> {\n             type Key = $K;\n             type Value = $V;\n@@ -722,9 +732,12 @@ macro_rules! define_maps {\n                 DepNode::new(tcx, $node(*key))\n             }\n \n+            #[inline]\n             fn compute(tcx: TyCtxt<'_, 'tcx, '_>, key: Self::Key) -> Self::Value {\n-                let provider = tcx.maps.providers[key.map_crate()].$name;\n-                provider(tcx.global_tcx(), key)\n+                __query_compute::$name(move || {\n+                    let provider = tcx.maps.providers[key.map_crate()].$name;\n+                    provider(tcx.global_tcx(), key)\n+                })\n             }\n \n             fn handle_cycle_error(tcx: TyCtxt<'_, 'tcx, '_>) -> Self::Value {"}]}