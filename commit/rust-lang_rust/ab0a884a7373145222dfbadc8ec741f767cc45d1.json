{"sha": "ab0a884a7373145222dfbadc8ec741f767cc45d1", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFiMGE4ODRhNzM3MzE0NTIyMmRmYmFkYzhlYzc0MWY3NjdjYzQ1ZDE=", "commit": {"author": {"name": "Daniel Micay", "email": "danielmicay@gmail.com", "date": "2013-10-01T02:40:44Z"}, "committer": {"name": "Daniel Micay", "email": "danielmicay@gmail.com", "date": "2013-10-01T04:38:37Z"}, "message": "fix dropping non-primitive immediates\n\nCloses #9446", "tree": {"sha": "e0c5262565609744cfe7c5f08f79cb80306ed2b4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e0c5262565609744cfe7c5f08f79cb80306ed2b4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ab0a884a7373145222dfbadc8ec741f767cc45d1", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ab0a884a7373145222dfbadc8ec741f767cc45d1", "html_url": "https://github.com/rust-lang/rust/commit/ab0a884a7373145222dfbadc8ec741f767cc45d1", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ab0a884a7373145222dfbadc8ec741f767cc45d1/comments", "author": {"login": "thestinger", "id": 1505226, "node_id": "MDQ6VXNlcjE1MDUyMjY=", "avatar_url": "https://avatars.githubusercontent.com/u/1505226?v=4", "gravatar_id": "", "url": "https://api.github.com/users/thestinger", "html_url": "https://github.com/thestinger", "followers_url": "https://api.github.com/users/thestinger/followers", "following_url": "https://api.github.com/users/thestinger/following{/other_user}", "gists_url": "https://api.github.com/users/thestinger/gists{/gist_id}", "starred_url": "https://api.github.com/users/thestinger/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/thestinger/subscriptions", "organizations_url": "https://api.github.com/users/thestinger/orgs", "repos_url": "https://api.github.com/users/thestinger/repos", "events_url": "https://api.github.com/users/thestinger/events{/privacy}", "received_events_url": "https://api.github.com/users/thestinger/received_events", "type": "User", "site_admin": false}, "committer": {"login": "thestinger", "id": 1505226, "node_id": "MDQ6VXNlcjE1MDUyMjY=", "avatar_url": "https://avatars.githubusercontent.com/u/1505226?v=4", "gravatar_id": "", "url": "https://api.github.com/users/thestinger", "html_url": "https://github.com/thestinger", "followers_url": "https://api.github.com/users/thestinger/followers", "following_url": "https://api.github.com/users/thestinger/following{/other_user}", "gists_url": "https://api.github.com/users/thestinger/gists{/gist_id}", "starred_url": "https://api.github.com/users/thestinger/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/thestinger/subscriptions", "organizations_url": "https://api.github.com/users/thestinger/orgs", "repos_url": "https://api.github.com/users/thestinger/repos", "events_url": "https://api.github.com/users/thestinger/events{/privacy}", "received_events_url": "https://api.github.com/users/thestinger/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4dd3ccb7ef5c8e675994701609e8ba01fe0c8ab0", "url": "https://api.github.com/repos/rust-lang/rust/commits/4dd3ccb7ef5c8e675994701609e8ba01fe0c8ab0", "html_url": "https://github.com/rust-lang/rust/commit/4dd3ccb7ef5c8e675994701609e8ba01fe0c8ab0"}], "stats": {"total": 20, "additions": 4, "deletions": 16}, "files": [{"sha": "cecea2703307b6dcf607734ea825de091a8edbba", "filename": "src/librustc/middle/trans/glue.rs", "status": "modified", "additions": 3, "deletions": 13, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/ab0a884a7373145222dfbadc8ec741f767cc45d1/src%2Flibrustc%2Fmiddle%2Ftrans%2Fglue.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ab0a884a7373145222dfbadc8ec741f767cc45d1/src%2Flibrustc%2Fmiddle%2Ftrans%2Fglue.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fglue.rs?ref=ab0a884a7373145222dfbadc8ec741f767cc45d1", "patch": "@@ -77,19 +77,9 @@ pub fn drop_ty(cx: @mut Block, v: ValueRef, t: ty::t) -> @mut Block {\n \n pub fn drop_ty_immediate(bcx: @mut Block, v: ValueRef, t: ty::t) -> @mut Block {\n     let _icx = push_ctxt(\"drop_ty_immediate\");\n-    match ty::get(t).sty {\n-        ty::ty_uniq(_)\n-      | ty::ty_evec(_, ty::vstore_uniq)\n-      | ty::ty_estr(ty::vstore_uniq) => {\n-        free_ty_immediate(bcx, v, t)\n-      }\n-        ty::ty_box(_) | ty::ty_opaque_box\n-      | ty::ty_evec(_, ty::vstore_box)\n-      | ty::ty_estr(ty::vstore_box) => {\n-        decr_refcnt_maybe_free(bcx, v, None, t)\n-      }\n-      _ => bcx.tcx().sess.bug(\"drop_ty_immediate: non-box ty\")\n-    }\n+    let vp = alloca(bcx, type_of(bcx.ccx(), t), \"\");\n+    Store(bcx, v, vp);\n+    drop_ty(bcx, vp, t)\n }\n \n pub fn free_ty(cx: @mut Block, v: ValueRef, t: ty::t) -> @mut Block {"}, {"sha": "e97960b3f0209d3320095f2d6da7c4805686c9e1", "filename": "src/test/run-pass/issue-9446.rs", "status": "modified", "additions": 1, "deletions": 3, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/ab0a884a7373145222dfbadc8ec741f767cc45d1/src%2Ftest%2Frun-pass%2Fissue-9446.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ab0a884a7373145222dfbadc8ec741f767cc45d1/src%2Ftest%2Frun-pass%2Fissue-9446.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fissue-9446.rs?ref=ab0a884a7373145222dfbadc8ec741f767cc45d1", "patch": "@@ -8,8 +8,6 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n-// xfail-test\n-\n struct Wrapper(~str);\n \n impl Wrapper {\n@@ -26,7 +24,7 @@ impl Drop for Wrapper {\n     fn drop(&mut self) {}\n }\n \n-fn main() {\n+pub fn main() {\n     {\n         // This runs without complaint.\n         let x = Wrapper::new(~\"Bob\");"}]}