{"sha": "5321ad574df4475675763cc7b354680e4d20ee2e", "node_id": "C_kwDOAAsO6NoAKDUzMjFhZDU3NGRmNDQ3NTY3NTc2M2NjN2IzNTQ2ODBlNGQyMGVlMmU", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-01-15T20:17:35Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-01-15T20:17:35Z"}, "message": "Rollup merge of #106900 - clubby789:unused-braces-regression, r=estebank\n\nFix regression in `unused_braces` with macros\n\nFixes #106899", "tree": {"sha": "f5b4384b6635bd24ca04d1094689d26322675bc6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f5b4384b6635bd24ca04d1094689d26322675bc6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5321ad574df4475675763cc7b354680e4d20ee2e", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjxF9fCRBK7hj4Ov3rIwAAc9gIAFWzlH+jM4PAh9IRXsTTunnW\ndgKsGgpvY3FnK2g/+dtlt+/1Taey9YTdtNUXk/aXyl92mZxooFpk2rptuVbZIO6F\n2WhpXLxo3VEHlHxsX77S8TsWT5ThdsUhKbieN6cU4AbT2lYqxqNmz2WHAOq50Mxq\nGVRNHI3+jpJFUijkUyAKBeK4/Y9NR2/6/aBqIPpj+akcVVwLSMPuhCa334YDFCKe\nY5vTTV1iHrUPSyx+c+0DKtaKFUBFvfmSfSjDs2+iRwqtpEB/QN4vmDdFeeDtU96Y\nWuI7poHItVJ7gHgf1iWngS/iq7Vro0y6WtMOgMbXvpI+x9aJjMqzP1qrGJr+Z4g=\n=o66d\n-----END PGP SIGNATURE-----\n", "payload": "tree f5b4384b6635bd24ca04d1094689d26322675bc6\nparent 5610231454f81d09f0a21f7fbdf58ad44898759c\nparent 295f5483fee168b385b03db03dfa9986f05ea706\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1673813855 +0100\ncommitter GitHub <noreply@github.com> 1673813855 +0100\n\nRollup merge of #106900 - clubby789:unused-braces-regression, r=estebank\n\nFix regression in `unused_braces` with macros\n\nFixes #106899\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5321ad574df4475675763cc7b354680e4d20ee2e", "html_url": "https://github.com/rust-lang/rust/commit/5321ad574df4475675763cc7b354680e4d20ee2e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5321ad574df4475675763cc7b354680e4d20ee2e/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5610231454f81d09f0a21f7fbdf58ad44898759c", "url": "https://api.github.com/repos/rust-lang/rust/commits/5610231454f81d09f0a21f7fbdf58ad44898759c", "html_url": "https://github.com/rust-lang/rust/commit/5610231454f81d09f0a21f7fbdf58ad44898759c"}, {"sha": "295f5483fee168b385b03db03dfa9986f05ea706", "url": "https://api.github.com/repos/rust-lang/rust/commits/295f5483fee168b385b03db03dfa9986f05ea706", "html_url": "https://github.com/rust-lang/rust/commit/295f5483fee168b385b03db03dfa9986f05ea706"}], "stats": {"total": 34, "additions": 29, "deletions": 5}, "files": [{"sha": "36791915964df75565cc6d3a1670fdc01b1e7f95", "filename": "compiler/rustc_lint/src/unused.rs", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/5321ad574df4475675763cc7b354680e4d20ee2e/compiler%2Frustc_lint%2Fsrc%2Funused.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5321ad574df4475675763cc7b354680e4d20ee2e/compiler%2Frustc_lint%2Fsrc%2Funused.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_lint%2Fsrc%2Funused.rs?ref=5321ad574df4475675763cc7b354680e4d20ee2e", "patch": "@@ -1095,17 +1095,21 @@ impl UnusedDelimLint for UnusedBraces {\n                 //      ```\n                 // - the block has no attribute and was not created inside a macro\n                 // - if the block is an `anon_const`, the inner expr must be a literal\n-                //      (do not lint `struct A<const N: usize>; let _: A<{ 2 + 3 }>;`)\n-                //\n+                //   not created by a macro, i.e. do not lint on:\n+                //      ```\n+                //      struct A<const N: usize>;\n+                //      let _: A<{ 2 + 3 }>;\n+                //      let _: A<{produces_literal!()}>;\n+                //      ```\n                 // FIXME(const_generics): handle paths when #67075 is fixed.\n                 if let [stmt] = inner.stmts.as_slice() {\n                     if let ast::StmtKind::Expr(ref expr) = stmt.kind {\n                         if !Self::is_expr_delims_necessary(expr, followed_by_block, false)\n                             && (ctx != UnusedDelimsCtx::AnonConst\n-                                || matches!(expr.kind, ast::ExprKind::Lit(_)))\n+                                || (matches!(expr.kind, ast::ExprKind::Lit(_))\n+                                    && !expr.span.from_expansion()))\n                             && !cx.sess().source_map().is_multiline(value.span)\n                             && value.attrs.is_empty()\n-                            && !expr.span.from_expansion()\n                             && !value.span.from_expansion()\n                             && !inner.span.from_expansion()\n                         {"}, {"sha": "e691fb37e6c43e51341367474a4fe12ac274edd0", "filename": "tests/ui/lint/unused_braces.fixed", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/5321ad574df4475675763cc7b354680e4d20ee2e/tests%2Fui%2Flint%2Funused_braces.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/5321ad574df4475675763cc7b354680e4d20ee2e/tests%2Fui%2Flint%2Funused_braces.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Flint%2Funused_braces.fixed?ref=5321ad574df4475675763cc7b354680e4d20ee2e", "patch": "@@ -50,4 +50,8 @@ fn main() {\n     if { return } {\n \n     }\n+\n+    // regression test for https://github.com/rust-lang/rust/issues/106899\n+    return println!(\"!\");\n+    //~^ WARN unnecessary braces\n }"}, {"sha": "0d260d2cbc93f5d82dcc96f0c1fee67871bbf273", "filename": "tests/ui/lint/unused_braces.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/5321ad574df4475675763cc7b354680e4d20ee2e/tests%2Fui%2Flint%2Funused_braces.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5321ad574df4475675763cc7b354680e4d20ee2e/tests%2Fui%2Flint%2Funused_braces.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Flint%2Funused_braces.rs?ref=5321ad574df4475675763cc7b354680e4d20ee2e", "patch": "@@ -50,4 +50,8 @@ fn main() {\n     if { return } {\n \n     }\n+\n+    // regression test for https://github.com/rust-lang/rust/issues/106899\n+    return { println!(\"!\") };\n+    //~^ WARN unnecessary braces\n }"}, {"sha": "0b4a1c321805ddea51a8b4261d5794fd89b38efc", "filename": "tests/ui/lint/unused_braces.stderr", "status": "modified", "additions": 13, "deletions": 1, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/5321ad574df4475675763cc7b354680e4d20ee2e/tests%2Fui%2Flint%2Funused_braces.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/5321ad574df4475675763cc7b354680e4d20ee2e/tests%2Fui%2Flint%2Funused_braces.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Flint%2Funused_braces.stderr?ref=5321ad574df4475675763cc7b354680e4d20ee2e", "patch": "@@ -68,5 +68,17 @@ LL -     consume({ 7 });\n LL +     consume(7);\n    |\n \n-warning: 5 warnings emitted\n+warning: unnecessary braces around `return` value\n+  --> $DIR/unused_braces.rs:55:12\n+   |\n+LL |     return { println!(\"!\") };\n+   |            ^^             ^^\n+   |\n+help: remove these braces\n+   |\n+LL -     return { println!(\"!\") };\n+LL +     return println!(\"!\");\n+   |\n+\n+warning: 6 warnings emitted\n "}]}