{"sha": "e07425d55b77fde99af2092a92109a0da0860692", "node_id": "C_kwDOAAsO6NoAKGUwNzQyNWQ1NWI3N2ZkZTk5YWYyMDkyYTkyMTA5YTBkYTA4NjA2OTI", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-11-20T07:16:42Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-11-20T07:16:42Z"}, "message": "Auto merge of #98914 - fee1-dead-contrib:min-deref-patterns, r=compiler-errors\n\nMinimal implementation of implicit deref patterns for Strings\n\ncc `@compiler-errors` `@BoxyUwU` https://github.com/rust-lang/lang-team/issues/88 #87121\n\n~~I forgot to add a feature gate, will do so in a minute~~ Done", "tree": {"sha": "e7ade368e6c2c2980fbde38df0bff50ff3da7702", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e7ade368e6c2c2980fbde38df0bff50ff3da7702"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e07425d55b77fde99af2092a92109a0da0860692", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e07425d55b77fde99af2092a92109a0da0860692", "html_url": "https://github.com/rust-lang/rust/commit/e07425d55b77fde99af2092a92109a0da0860692", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e07425d55b77fde99af2092a92109a0da0860692/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2ed65da15279d25e8b8b91d60162930ab48f16f6", "url": "https://api.github.com/repos/rust-lang/rust/commits/2ed65da15279d25e8b8b91d60162930ab48f16f6", "html_url": "https://github.com/rust-lang/rust/commit/2ed65da15279d25e8b8b91d60162930ab48f16f6"}, {"sha": "bc51f8783cdbee5a1ed121f017ec7360d9be9124", "url": "https://api.github.com/repos/rust-lang/rust/commits/bc51f8783cdbee5a1ed121f017ec7360d9be9124", "html_url": "https://github.com/rust-lang/rust/commit/bc51f8783cdbee5a1ed121f017ec7360d9be9124"}], "stats": {"total": 401, "additions": 302, "deletions": 99}, "files": [{"sha": "ae49a76a087838bf60d316f0cdd12dee2308b89b", "filename": "compiler/rustc_feature/src/active.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/compiler%2Frustc_feature%2Fsrc%2Factive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/compiler%2Frustc_feature%2Fsrc%2Factive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_feature%2Fsrc%2Factive.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -506,6 +506,8 @@ declare_features! (\n     (active, stmt_expr_attributes, \"1.6.0\", Some(15701), None),\n     /// Allows lints part of the strict provenance effort.\n     (active, strict_provenance, \"1.61.0\", Some(95228), None),\n+    /// Allows string patterns to dereference values to match them.\n+    (active, string_deref_patterns, \"CURRENT_RUSTC_VERSION\", Some(87121), None),\n     /// Allows the use of `#[target_feature]` on safe functions.\n     (active, target_feature_11, \"1.45.0\", Some(69098), None),\n     /// Allows using `#[thread_local]` on `static` items."}, {"sha": "b68dd25996b116cd5c60c8027c4a9f0ae46c19dc", "filename": "compiler/rustc_hir/src/lang_items.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/compiler%2Frustc_hir%2Fsrc%2Flang_items.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/compiler%2Frustc_hir%2Fsrc%2Flang_items.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir%2Fsrc%2Flang_items.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -312,6 +312,8 @@ language_item_table! {\n     Range,                   sym::Range,               range_struct,               Target::Struct,         GenericRequirement::None;\n     RangeToInclusive,        sym::RangeToInclusive,    range_to_inclusive_struct,  Target::Struct,         GenericRequirement::None;\n     RangeTo,                 sym::RangeTo,             range_to_struct,            Target::Struct,         GenericRequirement::None;\n+\n+    String,                  sym::String,              string,                     Target::Struct,         GenericRequirement::None;\n }\n \n pub enum GenericRequirement {"}, {"sha": "9f5aadca967bd4748d0ccaafd4d7bec42fade531", "filename": "compiler/rustc_hir_typeck/src/fn_ctxt/suggestions.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2Fsuggestions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2Fsuggestions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2Fsuggestions.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -464,7 +464,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                     ref_cnt += 1;\n                 }\n                 if let ty::Adt(adt, _) = peeled.kind()\n-                    && self.tcx.is_diagnostic_item(sym::String, adt.did())\n+                    && Some(adt.did()) == self.tcx.lang_items().string()\n                 {\n                     err.span_suggestion_verbose(\n                         expr.span.shrink_to_hi(),"}, {"sha": "8190163cba15b4bb8fde3ae5d1f86f3aa2c0439b", "filename": "compiler/rustc_hir_typeck/src/method/suggest.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/compiler%2Frustc_hir_typeck%2Fsrc%2Fmethod%2Fsuggest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/compiler%2Frustc_hir_typeck%2Fsrc%2Fmethod%2Fsuggest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Fmethod%2Fsuggest.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -821,10 +821,10 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                                 ty.is_str()\n                                     || matches!(\n                                         ty.kind(),\n-                                        ty::Adt(adt, _) if self.tcx.is_diagnostic_item(sym::String, adt.did())\n+                                        ty::Adt(adt, _) if Some(adt.did()) == self.tcx.lang_items().string()\n                                     )\n                             }\n-                            ty::Adt(adt, _) => self.tcx.is_diagnostic_item(sym::String, adt.did()),\n+                            ty::Adt(adt, _) => Some(adt.did()) == self.tcx.lang_items().string(),\n                             _ => false,\n                         };\n                         if is_string_or_ref_str && item_name.name == sym::iter {"}, {"sha": "adc7a21f265a82be3cec68264b95a88ee6c42ef2", "filename": "compiler/rustc_hir_typeck/src/op.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/compiler%2Frustc_hir_typeck%2Fsrc%2Fop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/compiler%2Frustc_hir_typeck%2Fsrc%2Fop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Fop.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -556,9 +556,9 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         let rm_borrow_msg = \"remove the borrow to obtain an owned `String`\";\n         let to_owned_msg = \"create an owned `String` from a string reference\";\n \n+        let string_type = self.tcx.lang_items().string();\n         let is_std_string = |ty: Ty<'tcx>| {\n-            ty.ty_adt_def()\n-                .map_or(false, |ty_def| self.tcx.is_diagnostic_item(sym::String, ty_def.did()))\n+            ty.ty_adt_def().map_or(false, |ty_def| Some(ty_def.did()) == string_type)\n         };\n \n         match (lhs_ty.kind(), rhs_ty.kind()) {"}, {"sha": "1d021f19104eae943f302a68c64b3f1b1e193b00", "filename": "compiler/rustc_hir_typeck/src/pat.rs", "status": "modified", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/compiler%2Frustc_hir_typeck%2Fsrc%2Fpat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/compiler%2Frustc_hir_typeck%2Fsrc%2Fpat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Fpat.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -401,6 +401,16 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n             }\n         }\n \n+        if self.tcx.features().string_deref_patterns && let hir::ExprKind::Lit(Spanned { node: ast::LitKind::Str(..), .. }) = lt.kind {\n+            let tcx = self.tcx;\n+            let expected = self.resolve_vars_if_possible(expected);\n+            pat_ty = match expected.kind() {\n+                ty::Adt(def, _) if Some(def.did()) == tcx.lang_items().string() => expected,\n+                ty::Str => tcx.mk_static_str(),\n+                _ => pat_ty,\n+            };\n+        }\n+\n         // Somewhat surprising: in this case, the subtyping relation goes the\n         // opposite way as the other cases. Actually what we really want is not\n         // a subtyping relation at all but rather that there exists a LUB"}, {"sha": "83e6f4e33bed8ecf227c65d3571c3d58c05f3562", "filename": "compiler/rustc_lint/src/non_fmt_panic.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/compiler%2Frustc_lint%2Fsrc%2Fnon_fmt_panic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/compiler%2Frustc_lint%2Fsrc%2Fnon_fmt_panic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_lint%2Fsrc%2Fnon_fmt_panic.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -148,7 +148,7 @@ fn check_panic<'tcx>(cx: &LateContext<'tcx>, f: &'tcx hir::Expr<'tcx>, arg: &'tc\n                 ty::Ref(_, r, _) if *r.kind() == ty::Str,\n             ) || matches!(\n                 ty.ty_adt_def(),\n-                Some(ty_def) if cx.tcx.is_diagnostic_item(sym::String, ty_def.did()),\n+                Some(ty_def) if Some(ty_def.did()) == cx.tcx.lang_items().string(),\n             );\n \n             let infcx = cx.tcx.infer_ctxt().build();"}, {"sha": "af0d7879c576ac266741d0d58a2ac1ddd43b1af8", "filename": "compiler/rustc_mir_build/src/build/matches/test.rs", "status": "modified", "additions": 33, "deletions": 0, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fmatches%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fmatches%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fbuild%2Fmatches%2Ftest.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -240,6 +240,39 @@ impl<'a, 'tcx> Builder<'a, 'tcx> {\n             }\n \n             TestKind::Eq { value, ty } => {\n+                let tcx = self.tcx;\n+                if let ty::Adt(def, _) = ty.kind() && Some(def.did()) == tcx.lang_items().string() {\n+                    if !tcx.features().string_deref_patterns {\n+                        bug!(\"matching on `String` went through without enabling string_deref_patterns\");\n+                    }\n+                    let re_erased = tcx.lifetimes.re_erased;\n+                    let ref_string = self.temp(tcx.mk_imm_ref(re_erased, ty), test.span);\n+                    let ref_str_ty = tcx.mk_imm_ref(re_erased, tcx.types.str_);\n+                    let ref_str = self.temp(ref_str_ty, test.span);\n+                    let deref = tcx.require_lang_item(LangItem::Deref, None);\n+                    let method = trait_method(tcx, deref, sym::deref, ty, &[]);\n+                    let eq_block = self.cfg.start_new_block();\n+                    self.cfg.push_assign(block, source_info, ref_string, Rvalue::Ref(re_erased, BorrowKind::Shared, place));\n+                    self.cfg.terminate(\n+                        block,\n+                        source_info,\n+                        TerminatorKind::Call {\n+                            func: Operand::Constant(Box::new(Constant {\n+                                span: test.span,\n+                                user_ty: None,\n+                                literal: method,\n+                            })),\n+                            args: vec![Operand::Move(ref_string)],\n+                            destination: ref_str,\n+                            target: Some(eq_block),\n+                            cleanup: None,\n+                            from_hir_call: false,\n+                            fn_span: source_info.span\n+                        }\n+                    );\n+                    self.non_scalar_compare(eq_block, make_target_blocks, source_info, value, ref_str, ref_str_ty);\n+                    return;\n+                }\n                 if !ty.is_scalar() {\n                     // Use `PartialEq::eq` instead of `BinOp::Eq`\n                     // (the binop can only handle primitives)"}, {"sha": "1b109ca6b11dd0d851c4e0470cd5c21b62c12030", "filename": "compiler/rustc_span/src/symbol.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_span%2Fsrc%2Fsymbol.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -1407,6 +1407,7 @@ symbols! {\n         str_trim_end,\n         str_trim_start,\n         strict_provenance,\n+        string_deref_patterns,\n         stringify,\n         struct_field_attributes,\n         struct_inherit,"}, {"sha": "c3547f64b5c9c747e1aa9c7a2804452e95a3f85b", "filename": "compiler/rustc_trait_selection/src/traits/error_reporting/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -1729,7 +1729,7 @@ impl<'tcx> InferCtxtPrivExt<'tcx> for TypeErrCtxt<'_, 'tcx> {\n                 ty::Bool => Some(0),\n                 ty::Char => Some(1),\n                 ty::Str => Some(2),\n-                ty::Adt(def, _) if tcx.is_diagnostic_item(sym::String, def.did()) => Some(2),\n+                ty::Adt(def, _) if Some(def.did()) == tcx.lang_items().string() => Some(2),\n                 ty::Int(..)\n                 | ty::Uint(..)\n                 | ty::Float(..)"}, {"sha": "7a8e6f088f3acc5f3c63b1695e4b6d9907d2ec5c", "filename": "library/alloc/src/string.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/library%2Falloc%2Fsrc%2Fstring.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/library%2Falloc%2Fsrc%2Fstring.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Falloc%2Fsrc%2Fstring.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -362,8 +362,8 @@ use crate::vec::Vec;\n /// [`Deref`]: core::ops::Deref \"ops::Deref\"\n /// [`as_str()`]: String::as_str\n #[derive(PartialOrd, Eq, Ord)]\n-#[cfg_attr(not(test), rustc_diagnostic_item = \"String\")]\n #[stable(feature = \"rust1\", since = \"1.0.0\")]\n+#[cfg_attr(all(not(bootstrap), not(test)), lang = \"String\")]\n pub struct String {\n     vec: Vec<u8>,\n }"}, {"sha": "5b185082d4d87f839f31e472c7bdb5475b9a934d", "filename": "src/test/mir-opt/deref-patterns/string.foo.PreCodegen.after.mir", "status": "added", "additions": 74, "deletions": 0, "changes": 74, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftest%2Fmir-opt%2Fderef-patterns%2Fstring.foo.PreCodegen.after.mir", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftest%2Fmir-opt%2Fderef-patterns%2Fstring.foo.PreCodegen.after.mir", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fderef-patterns%2Fstring.foo.PreCodegen.after.mir?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -0,0 +1,74 @@\n+// MIR for `foo` after PreCodegen\n+\n+fn foo(_1: Option<String>) -> i32 {\n+    debug s => _1;                       // in scope 0 at $DIR/string.rs:+0:12: +0:13\n+    let mut _0: i32;                     // return place in scope 0 at $DIR/string.rs:+0:34: +0:37\n+    let mut _2: &std::string::String;    // in scope 0 at $DIR/string.rs:+2:14: +2:17\n+    let mut _3: &str;                    // in scope 0 at $DIR/string.rs:+2:14: +2:17\n+    let mut _4: bool;                    // in scope 0 at $DIR/string.rs:+2:14: +2:17\n+    let mut _5: isize;                   // in scope 0 at $DIR/string.rs:+2:9: +2:18\n+    let _6: std::option::Option<std::string::String>; // in scope 0 at $DIR/string.rs:+3:9: +3:10\n+    let mut _7: bool;                    // in scope 0 at $DIR/string.rs:+5:1: +5:2\n+    scope 1 {\n+        debug s => _6;                   // in scope 1 at $DIR/string.rs:+3:9: +3:10\n+    }\n+\n+    bb0: {\n+        _7 = const false;                // scope 0 at $DIR/string.rs:+1:11: +1:12\n+        _7 = const true;                 // scope 0 at $DIR/string.rs:+1:11: +1:12\n+        _5 = discriminant(_1);           // scope 0 at $DIR/string.rs:+1:11: +1:12\n+        switchInt(move _5) -> [1_isize: bb2, otherwise: bb1]; // scope 0 at $DIR/string.rs:+1:5: +1:12\n+    }\n+\n+    bb1: {\n+        StorageLive(_6);                 // scope 0 at $DIR/string.rs:+3:9: +3:10\n+        _7 = const false;                // scope 0 at $DIR/string.rs:+3:9: +3:10\n+        _6 = move _1;                    // scope 0 at $DIR/string.rs:+3:9: +3:10\n+        _0 = const 4321_i32;             // scope 1 at $DIR/string.rs:+3:14: +3:18\n+        drop(_6) -> bb6;                 // scope 0 at $DIR/string.rs:+3:17: +3:18\n+    }\n+\n+    bb2: {\n+        _2 = &((_1 as Some).0: std::string::String); // scope 0 at $DIR/string.rs:+2:14: +2:17\n+        _3 = <String as Deref>::deref(move _2) -> bb3; // scope 0 at $DIR/string.rs:+2:14: +2:17\n+                                         // mir::Constant\n+                                         // + span: $DIR/string.rs:9:14: 9:17\n+                                         // + literal: Const { ty: for<'a> fn(&'a String) -> &'a <String as Deref>::Target {<String as Deref>::deref}, val: Value(<ZST>) }\n+    }\n+\n+    bb3: {\n+        _4 = <str as PartialEq>::eq(_3, const \"a\") -> bb4; // scope 0 at $DIR/string.rs:+2:14: +2:17\n+                                         // mir::Constant\n+                                         // + span: $DIR/string.rs:9:14: 9:17\n+                                         // + literal: Const { ty: for<'a, 'b> fn(&'a str, &'b str) -> bool {<str as PartialEq>::eq}, val: Value(<ZST>) }\n+                                         // mir::Constant\n+                                         // + span: $DIR/string.rs:9:14: 9:17\n+                                         // + literal: Const { ty: &str, val: Value(Slice(..)) }\n+    }\n+\n+    bb4: {\n+        switchInt(move _4) -> [false: bb1, otherwise: bb5]; // scope 0 at $DIR/string.rs:+2:14: +2:17\n+    }\n+\n+    bb5: {\n+        _0 = const 1234_i32;             // scope 0 at $DIR/string.rs:+2:22: +2:26\n+        goto -> bb9;                     // scope 0 at $DIR/string.rs:+2:22: +2:26\n+    }\n+\n+    bb6: {\n+        StorageDead(_6);                 // scope 0 at $DIR/string.rs:+3:17: +3:18\n+        goto -> bb9;                     // scope 0 at $DIR/string.rs:+3:17: +3:18\n+    }\n+\n+    bb7: {\n+        return;                          // scope 0 at $DIR/string.rs:+5:2: +5:2\n+    }\n+\n+    bb8: {\n+        drop(_1) -> bb7;                 // scope 0 at $DIR/string.rs:+5:1: +5:2\n+    }\n+\n+    bb9: {\n+        switchInt(_7) -> [false: bb7, otherwise: bb8]; // scope 0 at $DIR/string.rs:+5:1: +5:2\n+    }\n+}"}, {"sha": "3a99c44aa0e18888100cd4b1e03d76fe3ddadc86", "filename": "src/test/mir-opt/deref-patterns/string.rs", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftest%2Fmir-opt%2Fderef-patterns%2Fstring.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftest%2Fmir-opt%2Fderef-patterns%2Fstring.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fmir-opt%2Fderef-patterns%2Fstring.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -0,0 +1,12 @@\n+// compile-flags: -Z mir-opt-level=0 -C panic=abort\n+\n+#![feature(string_deref_patterns)]\n+#![crate_type = \"lib\"]\n+\n+// EMIT_MIR string.foo.PreCodegen.after.mir\n+pub fn foo(s: Option<String>) -> i32 {\n+    match s {\n+        Some(\"a\") => 1234,\n+        s => 4321,\n+    }\n+}"}, {"sha": "249716040a17702a8a58669f1e0ef92fabc7da4e", "filename": "src/test/ui/deref-patterns/basic.rs", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftest%2Fui%2Fderef-patterns%2Fbasic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftest%2Fui%2Fderef-patterns%2Fbasic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fderef-patterns%2Fbasic.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -0,0 +1,17 @@\n+// run-pass\n+// check-run-results\n+#![feature(string_deref_patterns)]\n+\n+fn main() {\n+    test(Some(String::from(\"42\")));\n+    test(Some(String::new()));\n+    test(None);\n+}\n+\n+fn test(o: Option<String>) {\n+    match o {\n+        Some(\"42\") => println!(\"the answer\"),\n+        Some(_) => println!(\"something else?\"),\n+        None => println!(\"nil\"),\n+    }\n+}"}, {"sha": "e50df05828152c5e7356feffc3b2f70b1bde2e4e", "filename": "src/test/ui/deref-patterns/basic.run.stdout", "status": "added", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftest%2Fui%2Fderef-patterns%2Fbasic.run.stdout", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftest%2Fui%2Fderef-patterns%2Fbasic.run.stdout", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fderef-patterns%2Fbasic.run.stdout?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -0,0 +1,3 @@\n+the answer\n+something else?\n+nil"}, {"sha": "050b847305b16167e1fe8587501e2ef089b14f63", "filename": "src/test/ui/deref-patterns/default-infer.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftest%2Fui%2Fderef-patterns%2Fdefault-infer.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftest%2Fui%2Fderef-patterns%2Fdefault-infer.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fderef-patterns%2Fdefault-infer.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -0,0 +1,9 @@\n+// check-pass\n+#![feature(string_deref_patterns)]\n+\n+fn main() {\n+    match <_ as Default>::default() {\n+        \"\" => (),\n+        _ => unreachable!(),\n+    }\n+}"}, {"sha": "ff50e30dea8c8935a9a6631726f458d53fae5381", "filename": "src/test/ui/deref-patterns/gate.rs", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftest%2Fui%2Fderef-patterns%2Fgate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftest%2Fui%2Fderef-patterns%2Fgate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fderef-patterns%2Fgate.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -0,0 +1,7 @@\n+// gate-test-string_deref_patterns\n+fn main() {\n+    match String::new() {\n+        \"\" | _ => {}\n+        //~^ mismatched types\n+    }\n+}"}, {"sha": "993468b5e826bf9e2ecead481144468c6731c5ab", "filename": "src/test/ui/deref-patterns/gate.stderr", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftest%2Fui%2Fderef-patterns%2Fgate.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftest%2Fui%2Fderef-patterns%2Fgate.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fderef-patterns%2Fgate.stderr?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -0,0 +1,11 @@\n+error[E0308]: mismatched types\n+  --> $DIR/gate.rs:4:9\n+   |\n+LL |     match String::new() {\n+   |           ------------- this expression has type `String`\n+LL |         \"\" | _ => {}\n+   |         ^^ expected struct `String`, found `&str`\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0308`."}, {"sha": "97e260d2752bb6eacd0b6506afba41a924c3d13f", "filename": "src/test/ui/deref-patterns/refs.rs", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftest%2Fui%2Fderef-patterns%2Frefs.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftest%2Fui%2Fderef-patterns%2Frefs.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fderef-patterns%2Frefs.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -0,0 +1,18 @@\n+// check-pass\n+#![feature(string_deref_patterns)]\n+\n+fn foo(s: &String) -> i32 {\n+    match *s {\n+        \"a\" => 42,\n+        _ => -1,\n+    }\n+}\n+\n+fn bar(s: Option<&&&&String>) -> i32 {\n+    match s {\n+        Some(&&&&\"&&&&\") => 1,\n+        _ => -1,\n+    }\n+}\n+\n+fn main() {}"}, {"sha": "942aeb6fdf4019a7e821dc87a5d67bea11562394", "filename": "src/test/ui/resolve/blind-item-local-shadow.rs", "status": "renamed", "additions": 0, "deletions": 0, "changes": 0, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftest%2Fui%2Fresolve%2Fblind-item-local-shadow.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftest%2Fui%2Fresolve%2Fblind-item-local-shadow.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fresolve%2Fblind-item-local-shadow.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "previous_filename": "src/test/ui/blind-item-local-shadow.rs"}, {"sha": "d0fab6949604090dfb02129c971eccb4246dd7be", "filename": "src/tools/clippy/clippy_lints/src/format.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fformat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fformat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fformat.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -73,7 +73,7 @@ impl<'tcx> LateLintPass<'tcx> for UselessFormat {\n                 if format_args.format_string.parts == [kw::Empty];\n                 if arg.format.is_default();\n                 if match cx.typeck_results().expr_ty(value).peel_refs().kind() {\n-                    ty::Adt(adt, _) => cx.tcx.is_diagnostic_item(sym::String, adt.did()),\n+                    ty::Adt(adt, _) => Some(adt.did()) == cx.tcx.lang_items().string(),\n                     ty::Str => true,\n                     _ => false,\n                 };"}, {"sha": "68c5c3673fe1544fb3e3c0b80df66870afa9df52", "filename": "src/tools/clippy/clippy_lints/src/format_push_string.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fformat_push_string.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fformat_push_string.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fformat_push_string.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -1,7 +1,7 @@\n use clippy_utils::diagnostics::span_lint_and_help;\n-use clippy_utils::ty::is_type_diagnostic_item;\n+use clippy_utils::ty::is_type_lang_item;\n use clippy_utils::{match_def_path, paths, peel_hir_expr_refs};\n-use rustc_hir::{BinOpKind, Expr, ExprKind};\n+use rustc_hir::{BinOpKind, Expr, ExprKind, LangItem};\n use rustc_lint::{LateContext, LateLintPass};\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n use rustc_span::sym;\n@@ -41,7 +41,7 @@ declare_clippy_lint! {\n declare_lint_pass!(FormatPushString => [FORMAT_PUSH_STRING]);\n \n fn is_string(cx: &LateContext<'_>, e: &Expr<'_>) -> bool {\n-    is_type_diagnostic_item(cx, cx.typeck_results().expr_ty(e).peel_refs(), sym::String)\n+    is_type_lang_item(cx, cx.typeck_results().expr_ty(e).peel_refs(), LangItem::String)\n }\n fn is_format(cx: &LateContext<'_>, e: &Expr<'_>) -> bool {\n     if let Some(macro_def_id) = e.span.ctxt().outer_expn_data().macro_def_id {"}, {"sha": "74a60b6a0d24b4ba8ba1a70f604d9bce2d5791be", "filename": "src/tools/clippy/clippy_lints/src/from_str_radix_10.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Ffrom_str_radix_10.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Ffrom_str_radix_10.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Ffrom_str_radix_10.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -1,10 +1,10 @@\n use clippy_utils::diagnostics::span_lint_and_sugg;\n use clippy_utils::is_integer_literal;\n use clippy_utils::sugg::Sugg;\n-use clippy_utils::ty::is_type_diagnostic_item;\n+use clippy_utils::ty::{is_type_diagnostic_item, is_type_lang_item};\n use if_chain::if_chain;\n use rustc_errors::Applicability;\n-use rustc_hir::{def, Expr, ExprKind, PrimTy, QPath, TyKind};\n+use rustc_hir::{def, Expr, ExprKind, LangItem, PrimTy, QPath, TyKind};\n use rustc_lint::{LateContext, LateLintPass};\n use rustc_middle::ty::Ty;\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n@@ -98,5 +98,5 @@ impl<'tcx> LateLintPass<'tcx> for FromStrRadix10 {\n \n /// Checks if a Ty is `String` or `&str`\n fn is_ty_stringish(cx: &LateContext<'_>, ty: Ty<'_>) -> bool {\n-    is_type_diagnostic_item(cx, ty, sym::String) || is_type_diagnostic_item(cx, ty, sym::str)\n+    is_type_lang_item(cx, ty, LangItem::String) || is_type_diagnostic_item(cx, ty, sym::str)\n }"}, {"sha": "aaecc4fa8f25698e68b705906deba938d01ed6f8", "filename": "src/tools/clippy/clippy_lints/src/inherent_to_string.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Finherent_to_string.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Finherent_to_string.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Finherent_to_string.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -1,8 +1,8 @@\n use clippy_utils::diagnostics::span_lint_and_help;\n-use clippy_utils::ty::{implements_trait, is_type_diagnostic_item};\n+use clippy_utils::ty::{implements_trait, is_type_lang_item};\n use clippy_utils::{return_ty, trait_ref_of_method};\n use if_chain::if_chain;\n-use rustc_hir::{GenericParamKind, ImplItem, ImplItemKind};\n+use rustc_hir::{GenericParamKind, ImplItem, ImplItemKind, LangItem};\n use rustc_lint::{LateContext, LateLintPass};\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n use rustc_span::sym;\n@@ -105,7 +105,7 @@ impl<'tcx> LateLintPass<'tcx> for InherentToString {\n             if impl_item.generics.params.iter().all(|p| matches!(p.kind, GenericParamKind::Lifetime { .. }));\n \n             // Check if return type is String\n-            if is_type_diagnostic_item(cx, return_ty(cx, impl_item.hir_id()), sym::String);\n+            if is_type_lang_item(cx, return_ty(cx, impl_item.hir_id()), LangItem::String);\n \n             // Filters instances of to_string which are required by a trait\n             if trait_ref_of_method(cx, impl_item.owner_id.def_id).is_none();"}, {"sha": "d6438ca7fec2aca306b8be7c776eef7fef382b33", "filename": "src/tools/clippy/clippy_lints/src/manual_retain.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmanual_retain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmanual_retain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmanual_retain.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -1,6 +1,6 @@\n use clippy_utils::diagnostics::span_lint_and_sugg;\n use clippy_utils::source::snippet;\n-use clippy_utils::ty::is_type_diagnostic_item;\n+use clippy_utils::ty::{is_type_diagnostic_item, is_type_lang_item};\n use clippy_utils::{get_parent_expr, match_def_path, paths, SpanlessEq};\n use clippy_utils::{meets_msrv, msrvs};\n use rustc_errors::Applicability;\n@@ -140,7 +140,7 @@ fn check_to_owned(\n         && let Some(chars_expr_def_id) = cx.typeck_results().type_dependent_def_id(chars_expr.hir_id)\n         && match_def_path(cx, chars_expr_def_id, &paths::STR_CHARS)\n         && let ty = cx.typeck_results().expr_ty(str_expr).peel_refs()\n-        && is_type_diagnostic_item(cx, ty, sym::String)\n+        && is_type_lang_item(cx, ty, hir::LangItem::String)\n         && SpanlessEq::new(cx).eq_expr(left_expr, str_expr) {\n         suggest(cx, parent_expr, left_expr, filter_expr);\n     }"}, {"sha": "c20d7959fc4a258576c48ec3792fc2f90338c4cb", "filename": "src/tools/clippy/clippy_lints/src/manual_string_new.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmanual_string_new.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmanual_string_new.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmanual_string_new.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -44,7 +44,7 @@ impl LateLintPass<'_> for ManualStringNew {\n         let ty = cx.typeck_results().expr_ty(expr);\n         match ty.kind() {\n             ty::Adt(adt_def, _) if adt_def.is_struct() => {\n-                if !cx.tcx.is_diagnostic_item(sym::String, adt_def.did()) {\n+                if cx.tcx.lang_items().string() != Some(adt_def.did()) {\n                     return;\n                 }\n             },"}, {"sha": "675a85ae5553a7833079969be6d354f0291bcdae", "filename": "src/tools/clippy/clippy_lints/src/matches/match_str_case_mismatch.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmatches%2Fmatch_str_case_mismatch.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmatches%2Fmatch_str_case_mismatch.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmatches%2Fmatch_str_case_mismatch.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -1,13 +1,13 @@\n use clippy_utils::diagnostics::span_lint_and_sugg;\n-use clippy_utils::ty::is_type_diagnostic_item;\n+use clippy_utils::ty::is_type_lang_item;\n use rustc_ast::ast::LitKind;\n use rustc_errors::Applicability;\n use rustc_hir::intravisit::{walk_expr, Visitor};\n-use rustc_hir::{Arm, Expr, ExprKind, PatKind};\n+use rustc_hir::{Arm, Expr, ExprKind, LangItem, PatKind};\n use rustc_lint::LateContext;\n use rustc_middle::ty;\n use rustc_span::symbol::Symbol;\n-use rustc_span::{sym, Span};\n+use rustc_span::Span;\n \n use super::MATCH_STR_CASE_MISMATCH;\n \n@@ -59,7 +59,7 @@ impl<'a, 'tcx> MatchExprVisitor<'a, 'tcx> {\n         if let Some(case_method) = get_case_method(segment_ident) {\n             let ty = self.cx.typeck_results().expr_ty(receiver).peel_refs();\n \n-            if is_type_diagnostic_item(self.cx, ty, sym::String) || ty.kind() == &ty::Str {\n+            if is_type_lang_item(self.cx, ty, LangItem::String) || ty.kind() == &ty::Str {\n                 self.case_method = Some(case_method);\n                 return true;\n             }"}, {"sha": "89aaad359d4acf09662cd41e666620ec407ac5c6", "filename": "src/tools/clippy/clippy_lints/src/methods/bytes_count_to_len.rs", "status": "modified", "additions": 2, "deletions": 3, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Fbytes_count_to_len.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Fbytes_count_to_len.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Fbytes_count_to_len.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -1,11 +1,10 @@\n use clippy_utils::diagnostics::span_lint_and_sugg;\n use clippy_utils::source::snippet_with_applicability;\n-use clippy_utils::ty::is_type_diagnostic_item;\n+use clippy_utils::ty::is_type_lang_item;\n use if_chain::if_chain;\n use rustc_errors::Applicability;\n use rustc_hir as hir;\n use rustc_lint::LateContext;\n-use rustc_span::sym;\n \n use super::BYTES_COUNT_TO_LEN;\n \n@@ -20,7 +19,7 @@ pub(super) fn check<'tcx>(\n         if let Some(impl_id) = cx.tcx.impl_of_method(bytes_id);\n         if cx.tcx.type_of(impl_id).is_str();\n         let ty = cx.typeck_results().expr_ty(bytes_recv).peel_refs();\n-        if ty.is_str() || is_type_diagnostic_item(cx, ty, sym::String);\n+        if ty.is_str() || is_type_lang_item(cx, ty, hir::LangItem::String);\n         then {\n             let mut applicability = Applicability::MachineApplicable;\n             span_lint_and_sugg("}, {"sha": "d512cc4eeae125acebd79058624d98ade6ab2d49", "filename": "src/tools/clippy/clippy_lints/src/methods/bytes_nth.rs", "status": "modified", "additions": 3, "deletions": 4, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Fbytes_nth.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Fbytes_nth.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Fbytes_nth.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -1,18 +1,17 @@\n use clippy_utils::diagnostics::span_lint_and_sugg;\n use clippy_utils::source::snippet_with_applicability;\n-use clippy_utils::ty::is_type_diagnostic_item;\n+use clippy_utils::ty::is_type_lang_item;\n use rustc_errors::Applicability;\n-use rustc_hir::Expr;\n+use rustc_hir::{Expr, LangItem};\n use rustc_lint::LateContext;\n-use rustc_span::sym;\n \n use super::BYTES_NTH;\n \n pub(super) fn check<'tcx>(cx: &LateContext<'tcx>, expr: &Expr<'_>, recv: &'tcx Expr<'tcx>, n_arg: &'tcx Expr<'tcx>) {\n     let ty = cx.typeck_results().expr_ty(recv).peel_refs();\n     let caller_type = if ty.is_str() {\n         \"str\"\n-    } else if is_type_diagnostic_item(cx, ty, sym::String) {\n+    } else if is_type_lang_item(cx, ty, LangItem::String) {\n         \"String\"\n     } else {\n         return;"}, {"sha": "d226c0bba6593f4fccfc89237d866d8d8d1784e2", "filename": "src/tools/clippy/clippy_lints/src/methods/case_sensitive_file_extension_comparisons.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Fcase_sensitive_file_extension_comparisons.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Fcase_sensitive_file_extension_comparisons.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Fcase_sensitive_file_extension_comparisons.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -1,10 +1,10 @@\n use clippy_utils::diagnostics::span_lint_and_help;\n-use clippy_utils::ty::is_type_diagnostic_item;\n+use clippy_utils::ty::is_type_lang_item;\n use if_chain::if_chain;\n use rustc_ast::ast::LitKind;\n-use rustc_hir::{Expr, ExprKind};\n+use rustc_hir::{Expr, ExprKind, LangItem};\n use rustc_lint::LateContext;\n-use rustc_span::{source_map::Spanned, symbol::sym, Span};\n+use rustc_span::{source_map::Spanned, Span};\n \n use super::CASE_SENSITIVE_FILE_EXTENSION_COMPARISONS;\n \n@@ -26,7 +26,7 @@ pub(super) fn check<'tcx>(\n         if ext_str.chars().skip(1).all(|c| c.is_uppercase() || c.is_ascii_digit())\n             || ext_str.chars().skip(1).all(|c| c.is_lowercase() || c.is_ascii_digit());\n         let recv_ty = cx.typeck_results().expr_ty(recv).peel_refs();\n-        if recv_ty.is_str() || is_type_diagnostic_item(cx, recv_ty, sym::String);\n+        if recv_ty.is_str() || is_type_lang_item(cx, recv_ty, LangItem::String);\n         then {\n             span_lint_and_help(\n                 cx,"}, {"sha": "a9189b31c57108990d96fbe740632ede6cb3c6f6", "filename": "src/tools/clippy/clippy_lints/src/methods/expect_fun_call.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Fexpect_fun_call.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Fexpect_fun_call.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Fexpect_fun_call.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -1,7 +1,7 @@\n use clippy_utils::diagnostics::span_lint_and_sugg;\n use clippy_utils::macros::{root_macro_call_first_node, FormatArgsExpn};\n use clippy_utils::source::snippet_with_applicability;\n-use clippy_utils::ty::is_type_diagnostic_item;\n+use clippy_utils::ty::{is_type_diagnostic_item, is_type_lang_item};\n use rustc_errors::Applicability;\n use rustc_hir as hir;\n use rustc_lint::LateContext;\n@@ -33,7 +33,7 @@ pub(super) fn check<'tcx>(\n                     if (method_name.ident.name == sym::as_str || method_name.ident.name == sym::as_ref) && {\n                         let arg_type = cx.typeck_results().expr_ty(receiver);\n                         let base_type = arg_type.peel_refs();\n-                        *base_type.kind() == ty::Str || is_type_diagnostic_item(cx, base_type, sym::String)\n+                        *base_type.kind() == ty::Str || is_type_lang_item(cx, base_type, hir::LangItem::String)\n                     } {\n                         receiver\n                     } else {\n@@ -50,7 +50,7 @@ pub(super) fn check<'tcx>(\n     // converted to string.\n     fn requires_to_string(cx: &LateContext<'_>, arg: &hir::Expr<'_>) -> bool {\n         let arg_ty = cx.typeck_results().expr_ty(arg);\n-        if is_type_diagnostic_item(cx, arg_ty, sym::String) {\n+        if is_type_lang_item(cx, arg_ty, hir::LangItem::String) {\n             return false;\n         }\n         if let ty::Ref(_, ty, ..) = arg_ty.kind() {"}, {"sha": "4f4f543e8a912abd079ddaf9b74724100376ce00", "filename": "src/tools/clippy/clippy_lints/src/methods/inefficient_to_string.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Finefficient_to_string.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Finefficient_to_string.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Finefficient_to_string.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -1,13 +1,13 @@\n use clippy_utils::diagnostics::span_lint_and_then;\n use clippy_utils::source::snippet_with_applicability;\n-use clippy_utils::ty::{is_type_diagnostic_item, walk_ptrs_ty_depth};\n+use clippy_utils::ty::{is_type_lang_item, walk_ptrs_ty_depth};\n use clippy_utils::{match_def_path, paths};\n use if_chain::if_chain;\n use rustc_errors::Applicability;\n use rustc_hir as hir;\n use rustc_lint::LateContext;\n use rustc_middle::ty::{self, Ty};\n-use rustc_span::symbol::{sym, Symbol};\n+use rustc_span::symbol::{Symbol, sym};\n \n use super::INEFFICIENT_TO_STRING;\n \n@@ -60,7 +60,7 @@ fn specializes_tostring(cx: &LateContext<'_>, ty: Ty<'_>) -> bool {\n         return true;\n     }\n \n-    if is_type_diagnostic_item(cx, ty, sym::String) {\n+    if is_type_lang_item(cx, ty, hir::LangItem::String) {\n         return true;\n     }\n "}, {"sha": "13c47c03a80dd583d6a006315dc2ce3fdd3f30f5", "filename": "src/tools/clippy/clippy_lints/src/methods/manual_str_repeat.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Fmanual_str_repeat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Fmanual_str_repeat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Fmanual_str_repeat.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -36,14 +36,14 @@ fn parse_repeat_arg(cx: &LateContext<'_>, e: &Expr<'_>) -> Option<RepeatKind> {\n         }\n     } else {\n         let ty = cx.typeck_results().expr_ty(e);\n-        if is_type_diagnostic_item(cx, ty, sym::String)\n+        if is_type_lang_item(cx, ty, LangItem::String)\n             || (is_type_lang_item(cx, ty, LangItem::OwnedBox) && get_ty_param(ty).map_or(false, Ty::is_str))\n             || (is_type_diagnostic_item(cx, ty, sym::Cow) && get_ty_param(ty).map_or(false, Ty::is_str))\n         {\n             Some(RepeatKind::String)\n         } else {\n             let ty = ty.peel_refs();\n-            (ty.is_str() || is_type_diagnostic_item(cx, ty, sym::String)).then_some(RepeatKind::String)\n+            (ty.is_str() || is_type_lang_item(cx, ty, LangItem::String)).then_some(RepeatKind::String)\n         }\n     }\n }\n@@ -58,7 +58,7 @@ pub(super) fn check(\n     if_chain! {\n         if let ExprKind::Call(repeat_fn, [repeat_arg]) = take_self_arg.kind;\n         if is_path_diagnostic_item(cx, repeat_fn, sym::iter_repeat);\n-        if is_type_diagnostic_item(cx, cx.typeck_results().expr_ty(collect_expr), sym::String);\n+        if is_type_lang_item(cx, cx.typeck_results().expr_ty(collect_expr), LangItem::String);\n         if let Some(collect_id) = cx.typeck_results().type_dependent_def_id(collect_expr.hir_id);\n         if let Some(take_id) = cx.typeck_results().type_dependent_def_id(take_expr.hir_id);\n         if let Some(iter_trait_id) = cx.tcx.get_diagnostic_item(sym::Iterator);"}, {"sha": "01655e860c43fa6c6c3d21f572ffc186d8dd899f", "filename": "src/tools/clippy/clippy_lints/src/methods/no_effect_replace.rs", "status": "modified", "additions": 3, "deletions": 4, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Fno_effect_replace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Fno_effect_replace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Fno_effect_replace.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -1,11 +1,10 @@\n use clippy_utils::diagnostics::span_lint;\n-use clippy_utils::ty::is_type_diagnostic_item;\n+use clippy_utils::ty::is_type_lang_item;\n use clippy_utils::SpanlessEq;\n use if_chain::if_chain;\n use rustc_ast::LitKind;\n-use rustc_hir::ExprKind;\n+use rustc_hir::{ExprKind, LangItem};\n use rustc_lint::LateContext;\n-use rustc_span::sym;\n \n use super::NO_EFFECT_REPLACE;\n \n@@ -16,7 +15,7 @@ pub(super) fn check<'tcx>(\n     arg2: &'tcx rustc_hir::Expr<'_>,\n ) {\n     let ty = cx.typeck_results().expr_ty(expr).peel_refs();\n-    if !(ty.is_str() || is_type_diagnostic_item(cx, ty, sym::String)) {\n+    if !(ty.is_str() || is_type_lang_item(cx, ty, LangItem::String)) {\n         return;\n     }\n "}, {"sha": "a345ec813ff502f8231fc6cd777b35f042273401", "filename": "src/tools/clippy/clippy_lints/src/methods/repeat_once.rs", "status": "modified", "additions": 3, "deletions": 4, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Frepeat_once.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Frepeat_once.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Frepeat_once.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -1,11 +1,10 @@\n use clippy_utils::consts::{constant_context, Constant};\n use clippy_utils::diagnostics::span_lint_and_sugg;\n use clippy_utils::source::snippet;\n-use clippy_utils::ty::is_type_diagnostic_item;\n+use clippy_utils::ty::is_type_lang_item;\n use rustc_errors::Applicability;\n-use rustc_hir::Expr;\n+use rustc_hir::{Expr, LangItem};\n use rustc_lint::LateContext;\n-use rustc_span::sym;\n \n use super::REPEAT_ONCE;\n \n@@ -37,7 +36,7 @@ pub(super) fn check<'tcx>(\n                 format!(\"{}.to_vec()\", snippet(cx, recv.span, r#\"\"...\"\"#)),\n                 Applicability::MachineApplicable,\n             );\n-        } else if is_type_diagnostic_item(cx, ty, sym::String) {\n+        } else if is_type_lang_item(cx, ty, LangItem::String) {\n             span_lint_and_sugg(\n                 cx,\n                 REPEAT_ONCE,"}, {"sha": "1c031ad6acbafbda64f697eb47c202da7072a3a2", "filename": "src/tools/clippy/clippy_lints/src/methods/search_is_some.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Fsearch_is_some.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Fsearch_is_some.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Fsearch_is_some.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -1,7 +1,7 @@\n use clippy_utils::diagnostics::{span_lint_and_help, span_lint_and_sugg};\n use clippy_utils::source::{snippet, snippet_with_applicability};\n use clippy_utils::sugg::deref_closure_args;\n-use clippy_utils::ty::is_type_diagnostic_item;\n+use clippy_utils::ty::is_type_lang_item;\n use clippy_utils::{is_trait_method, strip_pat_refs};\n use if_chain::if_chain;\n use rustc_errors::Applicability;\n@@ -105,7 +105,7 @@ pub(super) fn check<'tcx>(\n     else if search_method == \"find\" {\n         let is_string_or_str_slice = |e| {\n             let self_ty = cx.typeck_results().expr_ty(e).peel_refs();\n-            if is_type_diagnostic_item(cx, self_ty, sym::String) {\n+            if is_type_lang_item(cx, self_ty, hir::LangItem::String) {\n                 true\n             } else {\n                 *self_ty.kind() == ty::Str"}, {"sha": "6f4cec546e969693a0ec9b5260dd98f3ea58f519", "filename": "src/tools/clippy/clippy_lints/src/methods/string_extend_chars.rs", "status": "modified", "additions": 3, "deletions": 4, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Fstring_extend_chars.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Fstring_extend_chars.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Fstring_extend_chars.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -1,26 +1,25 @@\n use clippy_utils::diagnostics::span_lint_and_sugg;\n use clippy_utils::method_chain_args;\n use clippy_utils::source::snippet_with_applicability;\n-use clippy_utils::ty::is_type_diagnostic_item;\n+use clippy_utils::ty::is_type_lang_item;\n use rustc_errors::Applicability;\n use rustc_hir as hir;\n use rustc_lint::LateContext;\n use rustc_middle::ty;\n-use rustc_span::symbol::sym;\n \n use super::STRING_EXTEND_CHARS;\n \n pub(super) fn check(cx: &LateContext<'_>, expr: &hir::Expr<'_>, recv: &hir::Expr<'_>, arg: &hir::Expr<'_>) {\n     let obj_ty = cx.typeck_results().expr_ty(recv).peel_refs();\n-    if !is_type_diagnostic_item(cx, obj_ty, sym::String) {\n+    if !is_type_lang_item(cx, obj_ty, hir::LangItem::String) {\n         return;\n     }\n     if let Some(arglists) = method_chain_args(arg, &[\"chars\"]) {\n         let target = &arglists[0].0;\n         let self_ty = cx.typeck_results().expr_ty(target).peel_refs();\n         let ref_str = if *self_ty.kind() == ty::Str {\n             \"\"\n-        } else if is_type_diagnostic_item(cx, self_ty, sym::String) {\n+        } else if is_type_lang_item(cx, self_ty, hir::LangItem::String) {\n             \"&\"\n         } else {\n             return;"}, {"sha": "c9b87bc6bf29d8e9df51a8b64291438300d772e1", "filename": "src/tools/clippy/clippy_lints/src/methods/unnecessary_join.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Funnecessary_join.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Funnecessary_join.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Funnecessary_join.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -1,10 +1,10 @@\n-use clippy_utils::{diagnostics::span_lint_and_sugg, ty::is_type_diagnostic_item};\n+use clippy_utils::{diagnostics::span_lint_and_sugg, ty::is_type_lang_item};\n use rustc_ast::ast::LitKind;\n use rustc_errors::Applicability;\n-use rustc_hir::{Expr, ExprKind};\n+use rustc_hir::{Expr, ExprKind, LangItem};\n use rustc_lint::LateContext;\n use rustc_middle::ty::{Ref, Slice};\n-use rustc_span::{sym, Span};\n+use rustc_span::Span;\n \n use super::UNNECESSARY_JOIN;\n \n@@ -21,7 +21,7 @@ pub(super) fn check<'tcx>(\n         // the turbofish for collect is ::<Vec<String>>\n         if let Ref(_, ref_type, _) = collect_output_adjusted_type.kind();\n         if let Slice(slice) = ref_type.kind();\n-        if is_type_diagnostic_item(cx, *slice, sym::String);\n+        if is_type_lang_item(cx, *slice, LangItem::String);\n         // the argument for join is \"\"\n         if let ExprKind::Lit(spanned) = &join_arg.kind;\n         if let LitKind::Str(symbol, _) = spanned.node;"}, {"sha": "79aa15b06ef4d4abf97c94ebeef4b35e9dc15b4f", "filename": "src/tools/clippy/clippy_lints/src/needless_pass_by_value.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fneedless_pass_by_value.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fneedless_pass_by_value.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fneedless_pass_by_value.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -1,7 +1,7 @@\n use clippy_utils::diagnostics::{multispan_sugg, span_lint_and_then};\n use clippy_utils::ptr::get_spans;\n use clippy_utils::source::{snippet, snippet_opt};\n-use clippy_utils::ty::{implements_trait, is_copy, is_type_diagnostic_item};\n+use clippy_utils::ty::{implements_trait, is_copy, is_type_diagnostic_item, is_type_lang_item};\n use clippy_utils::{get_trait_def_id, is_self, paths};\n use if_chain::if_chain;\n use rustc_ast::ast::Attribute;\n@@ -11,7 +11,7 @@ use rustc_hir::intravisit::FnKind;\n use rustc_hir::{\n     BindingAnnotation, Body, FnDecl, GenericArg, HirId, Impl, ItemKind, Mutability, Node, PatKind, QPath, TyKind,\n };\n-use rustc_hir::{HirIdMap, HirIdSet};\n+use rustc_hir::{HirIdMap, HirIdSet, LangItem};\n use rustc_hir_typeck::expr_use_visitor as euv;\n use rustc_infer::infer::TyCtxtInferExt;\n use rustc_lint::{LateContext, LateLintPass};\n@@ -249,7 +249,7 @@ impl<'tcx> LateLintPass<'tcx> for NeedlessPassByValue {\n                             }\n                         }\n \n-                        if is_type_diagnostic_item(cx, ty, sym::String) {\n+                        if is_type_lang_item(cx, ty, LangItem::String) {\n                             if let Some(clone_spans) =\n                                 get_spans(cx, Some(body.id()), idx, &[(\"clone\", \".to_string()\"), (\"as_str\", \"\")]) {\n                                 diag.span_suggestion("}, {"sha": "6aa5e13fe3186e31013bc94f0debdfef561cbae9", "filename": "src/tools/clippy/clippy_lints/src/ptr.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fptr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fptr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fptr.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -450,7 +450,7 @@ fn check_fn_args<'cx, 'tcx: 'cx>(\n                                 substs.type_at(0),\n                             ),\n                         ),\n-                        Some(sym::String) => (\n+                        _ if Some(adt.did()) == cx.tcx.lang_items().string() => (\n                             [(\"clone\", \".to_owned()\"), (\"as_str\", \"\")].as_slice(),\n                             DerefTy::Str,\n                         ),"}, {"sha": "c1677fb3da1c4850215dfd6a88e1ee485d4c54ed", "filename": "src/tools/clippy/clippy_lints/src/redundant_clone.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fredundant_clone.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fredundant_clone.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fredundant_clone.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -1,12 +1,12 @@\n use clippy_utils::diagnostics::{span_lint_hir, span_lint_hir_and_then};\n use clippy_utils::mir::{visit_local_usage, LocalUsage, PossibleBorrowerMap};\n use clippy_utils::source::snippet_opt;\n-use clippy_utils::ty::{has_drop, is_copy, is_type_diagnostic_item, walk_ptrs_ty_depth};\n+use clippy_utils::ty::{has_drop, is_copy, is_type_diagnostic_item, is_type_lang_item, walk_ptrs_ty_depth};\n use clippy_utils::{fn_has_unsatisfiable_preds, match_def_path, paths};\n use if_chain::if_chain;\n use rustc_errors::Applicability;\n use rustc_hir::intravisit::FnKind;\n-use rustc_hir::{def_id, Body, FnDecl, HirId};\n+use rustc_hir::{def_id, Body, FnDecl, HirId, LangItem};\n use rustc_lint::{LateContext, LateLintPass};\n use rustc_middle::mir;\n use rustc_middle::ty::{self, Ty};\n@@ -102,7 +102,7 @@ impl<'tcx> LateLintPass<'tcx> for RedundantClone {\n             let from_borrow = match_def_path(cx, fn_def_id, &paths::CLONE_TRAIT_METHOD)\n                 || match_def_path(cx, fn_def_id, &paths::TO_OWNED_METHOD)\n                 || (match_def_path(cx, fn_def_id, &paths::TO_STRING_METHOD)\n-                    && is_type_diagnostic_item(cx, arg_ty, sym::String));\n+                    && is_type_lang_item(cx, arg_ty, LangItem::String));\n \n             let from_deref = !from_borrow\n                 && (match_def_path(cx, fn_def_id, &paths::PATH_TO_PATH_BUF)"}, {"sha": "f4705481d4e69b3131ad73ce0439ba6903092dca", "filename": "src/tools/clippy/clippy_lints/src/strings.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fstrings.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fstrings.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fstrings.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -1,6 +1,6 @@\n use clippy_utils::diagnostics::{span_lint, span_lint_and_help, span_lint_and_sugg};\n use clippy_utils::source::{snippet, snippet_with_applicability};\n-use clippy_utils::ty::is_type_diagnostic_item;\n+use clippy_utils::ty::is_type_lang_item;\n use clippy_utils::{get_parent_expr, is_lint_allowed, match_function_call, method_calls, paths};\n use clippy_utils::{peel_blocks, SpanlessEq};\n use if_chain::if_chain;\n@@ -190,7 +190,7 @@ impl<'tcx> LateLintPass<'tcx> for StringAdd {\n             },\n             ExprKind::Index(target, _idx) => {\n                 let e_ty = cx.typeck_results().expr_ty(target).peel_refs();\n-                if matches!(e_ty.kind(), ty::Str) || is_type_diagnostic_item(cx, e_ty, sym::String) {\n+                if matches!(e_ty.kind(), ty::Str) || is_type_lang_item(cx, e_ty, LangItem::String) {\n                     span_lint(\n                         cx,\n                         STRING_SLICE,\n@@ -205,7 +205,7 @@ impl<'tcx> LateLintPass<'tcx> for StringAdd {\n }\n \n fn is_string(cx: &LateContext<'_>, e: &Expr<'_>) -> bool {\n-    is_type_diagnostic_item(cx, cx.typeck_results().expr_ty(e).peel_refs(), sym::String)\n+    is_type_lang_item(cx, cx.typeck_results().expr_ty(e).peel_refs(), LangItem::String)\n }\n \n fn is_add(cx: &LateContext<'_>, src: &Expr<'_>, target: &Expr<'_>) -> bool {\n@@ -446,7 +446,7 @@ impl<'tcx> LateLintPass<'tcx> for StringToString {\n             if let ExprKind::MethodCall(path, self_arg, ..) = &expr.kind;\n             if path.ident.name == sym::to_string;\n             let ty = cx.typeck_results().expr_ty(self_arg);\n-            if is_type_diagnostic_item(cx, ty, sym::String);\n+            if is_type_lang_item(cx, ty, LangItem::String);\n             then {\n                 span_lint_and_help(\n                     cx,"}, {"sha": "802415e163df541c83b28a9dbcb2b7469be5854e", "filename": "src/tools/clippy/clippy_lints/src/types/box_collection.rs", "status": "modified", "additions": 15, "deletions": 14, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Ftypes%2Fbox_collection.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Ftypes%2Fbox_collection.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Ftypes%2Fbox_collection.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -37,18 +37,19 @@ pub(super) fn check(cx: &LateContext<'_>, hir_ty: &hir::Ty<'_>, qpath: &QPath<'_\n fn get_std_collection(cx: &LateContext<'_>, qpath: &QPath<'_>) -> Option<Symbol> {\n     let param = qpath_generic_tys(qpath).next()?;\n     let id = path_def_id(cx, param)?;\n-    cx.tcx.get_diagnostic_name(id).filter(|&name| {\n-        matches!(\n-            name,\n-            sym::HashMap\n-                | sym::String\n-                | sym::Vec\n-                | sym::HashSet\n-                | sym::VecDeque\n-                | sym::LinkedList\n-                | sym::BTreeMap\n-                | sym::BTreeSet\n-                | sym::BinaryHeap\n-        )\n-    })\n+    cx.tcx\n+        .get_diagnostic_name(id)\n+        .filter(|&name| matches!(name, sym::HashMap | sym::Vec | sym::HashSet\n+            | sym::VecDeque\n+            | sym::LinkedList\n+            | sym::BTreeMap\n+            | sym::BTreeSet\n+            | sym::BinaryHeap))\n+        .or_else(|| {\n+            cx.tcx\n+                .lang_items()\n+                .string()\n+                .filter(|did| id == *did)\n+                .map(|_| sym::String)\n+        })\n }"}, {"sha": "855137b14d84bdbee4802b3659225c936aff981f", "filename": "src/tools/clippy/clippy_lints/src/types/rc_buffer.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Ftypes%2Frc_buffer.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Ftypes%2Frc_buffer.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Ftypes%2Frc_buffer.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -91,10 +91,10 @@ pub(super) fn check(cx: &LateContext<'_>, hir_ty: &hir::Ty<'_>, qpath: &QPath<'_\n fn match_buffer_type(cx: &LateContext<'_>, qpath: &QPath<'_>) -> Option<&'static str> {\n     let ty = qpath_generic_tys(qpath).next()?;\n     let id = path_def_id(cx, ty)?;\n-    let path = match cx.tcx.get_diagnostic_name(id)? {\n-        sym::String => \"str\",\n-        sym::OsString => \"std::ffi::OsStr\",\n-        sym::PathBuf => \"std::path::Path\",\n+    let path = match cx.tcx.get_diagnostic_name(id) {\n+        Some(sym::OsString) => \"std::ffi::OsStr\",\n+        Some(sym::PathBuf) => \"std::path::Path\",\n+        _ if Some(id) == cx.tcx.lang_items().string() => \"str\",\n         _ => return None,\n     };\n     Some(path)"}, {"sha": "9f207d32fcfff1c4fff43c48266a9a24d72f1fa8", "filename": "src/tools/clippy/clippy_lints/src/unnecessary_owned_empty_strings.rs", "status": "modified", "additions": 3, "deletions": 4, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Funnecessary_owned_empty_strings.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Funnecessary_owned_empty_strings.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Funnecessary_owned_empty_strings.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -1,13 +1,12 @@\n-use clippy_utils::{diagnostics::span_lint_and_sugg, ty::is_type_diagnostic_item};\n+use clippy_utils::{diagnostics::span_lint_and_sugg, ty::is_type_lang_item};\n use clippy_utils::{match_def_path, paths};\n use if_chain::if_chain;\n use rustc_ast::ast::LitKind;\n use rustc_errors::Applicability;\n-use rustc_hir::{BorrowKind, Expr, ExprKind, Mutability};\n+use rustc_hir::{BorrowKind, Expr, ExprKind, LangItem, Mutability};\n use rustc_lint::{LateContext, LateLintPass};\n use rustc_middle::ty;\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n-use rustc_span::sym;\n \n declare_clippy_lint! {\n     /// ### What it does\n@@ -61,7 +60,7 @@ impl<'tcx> LateLintPass<'tcx> for UnnecessaryOwnedEmptyStrings {\n                         if let LitKind::Str(symbol, _) = spanned.node;\n                         if symbol.is_empty();\n                         let inner_expr_type = cx.typeck_results().expr_ty(inner_expr);\n-                        if is_type_diagnostic_item(cx, inner_expr_type, sym::String);\n+                        if is_type_lang_item(cx, inner_expr_type, LangItem::String);\n                         then {\n                             span_lint_and_sugg(\n                                 cx,"}, {"sha": "3f93b9b491d4cb71e28ffedd0b470baea01a7b88", "filename": "src/tools/clippy/clippy_utils/src/lib.rs", "status": "modified", "additions": 12, "deletions": 3, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e07425d55b77fde99af2092a92109a0da0860692/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Flib.rs?ref=e07425d55b77fde99af2092a92109a0da0860692", "patch": "@@ -434,6 +434,16 @@ pub fn is_expr_path_def_path(cx: &LateContext<'_>, expr: &Expr<'_>, segments: &[\n     path_def_id(cx, expr).map_or(false, |id| match_def_path(cx, id, segments))\n }\n \n+/// If `maybe_path` is a path node which resolves to an item, resolves it to a `DefId` and checks if\n+/// it matches the given lang item.\n+pub fn is_path_lang_item<'tcx>(\n+    cx: &LateContext<'_>,\n+    maybe_path: &impl MaybePath<'tcx>,\n+    lang_item: LangItem,\n+) -> bool {\n+    path_def_id(cx, maybe_path).map_or(false, |id| cx.tcx.lang_items().get(lang_item) == Some(id))\n+}\n+\n /// If `maybe_path` is a path node which resolves to an item, resolves it to a `DefId` and checks if\n /// it matches the given diagnostic item.\n pub fn is_path_diagnostic_item<'tcx>(\n@@ -760,7 +770,6 @@ pub fn can_mut_borrow_both(cx: &LateContext<'_>, e1: &Expr<'_>, e2: &Expr<'_>) -\n /// constructor from the std library\n fn is_default_equivalent_ctor(cx: &LateContext<'_>, def_id: DefId, path: &QPath<'_>) -> bool {\n     let std_types_symbols = &[\n-        sym::String,\n         sym::Vec,\n         sym::VecDeque,\n         sym::LinkedList,\n@@ -777,7 +786,7 @@ fn is_default_equivalent_ctor(cx: &LateContext<'_>, def_id: DefId, path: &QPath<\n                 if let Some(adt) = cx.tcx.type_of(impl_did).ty_adt_def() {\n                     return std_types_symbols\n                         .iter()\n-                        .any(|&symbol| cx.tcx.is_diagnostic_item(symbol, adt.did()));\n+                        .any(|&symbol| cx.tcx.is_diagnostic_item(symbol, adt.did()) || Some(adt.did()) == cx.tcx.lang_items().string());\n                 }\n             }\n         }\n@@ -834,7 +843,7 @@ fn is_default_equivalent_from(cx: &LateContext<'_>, from_func: &Expr<'_>, arg: &\n             ExprKind::Lit(hir::Lit {\n                 node: LitKind::Str(ref sym, _),\n                 ..\n-            }) => return sym.is_empty() && is_path_diagnostic_item(cx, ty, sym::String),\n+            }) => return sym.is_empty() && is_path_lang_item(cx, ty, LangItem::String),\n             ExprKind::Array([]) => return is_path_diagnostic_item(cx, ty, sym::Vec),\n             ExprKind::Repeat(_, ArrayLen::Body(len)) => {\n                 if let ExprKind::Lit(ref const_lit) = cx.tcx.hir().body(len.body).value.kind &&"}]}