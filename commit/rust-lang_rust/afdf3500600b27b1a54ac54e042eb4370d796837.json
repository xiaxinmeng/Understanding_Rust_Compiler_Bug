{"sha": "afdf3500600b27b1a54ac54e042eb4370d796837", "node_id": "MDY6Q29tbWl0NzI0NzEyOmFmZGYzNTAwNjAwYjI3YjFhNTRhYzU0ZTA0MmViNDM3MGQ3OTY4Mzc=", "commit": {"author": {"name": "Niklas Fiekas", "email": "niklas.fiekas@backscattering.de", "date": "2018-07-17T17:22:55Z"}, "committer": {"name": "Niklas Fiekas", "email": "niklas.fiekas@backscattering.de", "date": "2018-08-24T09:57:48Z"}, "message": "Add copy_iterator lint (#1534)", "tree": {"sha": "79f47ffe026bb85027950ee0e48e9f50eed40ae9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/79f47ffe026bb85027950ee0e48e9f50eed40ae9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/afdf3500600b27b1a54ac54e042eb4370d796837", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/afdf3500600b27b1a54ac54e042eb4370d796837", "html_url": "https://github.com/rust-lang/rust/commit/afdf3500600b27b1a54ac54e042eb4370d796837", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/afdf3500600b27b1a54ac54e042eb4370d796837/comments", "author": {"login": "niklasf", "id": 402777, "node_id": "MDQ6VXNlcjQwMjc3Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/402777?v=4", "gravatar_id": "", "url": "https://api.github.com/users/niklasf", "html_url": "https://github.com/niklasf", "followers_url": "https://api.github.com/users/niklasf/followers", "following_url": "https://api.github.com/users/niklasf/following{/other_user}", "gists_url": "https://api.github.com/users/niklasf/gists{/gist_id}", "starred_url": "https://api.github.com/users/niklasf/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/niklasf/subscriptions", "organizations_url": "https://api.github.com/users/niklasf/orgs", "repos_url": "https://api.github.com/users/niklasf/repos", "events_url": "https://api.github.com/users/niklasf/events{/privacy}", "received_events_url": "https://api.github.com/users/niklasf/received_events", "type": "User", "site_admin": false}, "committer": {"login": "niklasf", "id": 402777, "node_id": "MDQ6VXNlcjQwMjc3Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/402777?v=4", "gravatar_id": "", "url": "https://api.github.com/users/niklasf", "html_url": "https://github.com/niklasf", "followers_url": "https://api.github.com/users/niklasf/followers", "following_url": "https://api.github.com/users/niklasf/following{/other_user}", "gists_url": "https://api.github.com/users/niklasf/gists{/gist_id}", "starred_url": "https://api.github.com/users/niklasf/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/niklasf/subscriptions", "organizations_url": "https://api.github.com/users/niklasf/orgs", "repos_url": "https://api.github.com/users/niklasf/repos", "events_url": "https://api.github.com/users/niklasf/events{/privacy}", "received_events_url": "https://api.github.com/users/niklasf/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "dda656652e2e1a8d615a712d7f7482c25fa0a9c2", "url": "https://api.github.com/repos/rust-lang/rust/commits/dda656652e2e1a8d615a712d7f7482c25fa0a9c2", "html_url": "https://github.com/rust-lang/rust/commit/dda656652e2e1a8d615a712d7f7482c25fa0a9c2"}], "stats": {"total": 100, "additions": 100, "deletions": 0}, "files": [{"sha": "ac0c2ed32c61a574127babb08b4b8f2f669ec9a5", "filename": "clippy_lints/src/copy_iterator.rs", "status": "added", "additions": 57, "deletions": 0, "changes": 57, "blob_url": "https://github.com/rust-lang/rust/blob/afdf3500600b27b1a54ac54e042eb4370d796837/clippy_lints%2Fsrc%2Fcopy_iterator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/afdf3500600b27b1a54ac54e042eb4370d796837/clippy_lints%2Fsrc%2Fcopy_iterator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fcopy_iterator.rs?ref=afdf3500600b27b1a54ac54e042eb4370d796837", "patch": "@@ -0,0 +1,57 @@\n+use crate::utils::{is_copy, match_path, paths, span_note_and_lint};\n+use rustc::hir::{Item, ItemKind};\n+use rustc::lint::*;\n+use rustc::{declare_lint, lint_array};\n+\n+/// **What it does:** Checks for types that implement `Copy` as well as\n+/// `Iterator`.\n+///\n+/// **Why is this bad?** Implicit copies can be confusing when working with\n+/// iterator combinators.\n+///\n+/// **Known problems:** None.\n+///\n+/// **Example:**\n+/// ```rust\n+/// #[derive(Copy, Clone)]\n+/// struct Countdown(u8);\n+///\n+/// impl Iterator for Countdown {\n+///     // ...\n+/// }\n+///\n+/// let a: Vec<_> = my_iterator.take(1).collect();\n+/// let b: Vec<_> = my_iterator.collect();\n+/// ```\n+declare_clippy_lint! {\n+    pub COPY_ITERATOR,\n+    pedantic,\n+    \"implementing `Iterator` on a `Copy` type\"\n+}\n+\n+pub struct CopyIterator;\n+\n+impl LintPass for CopyIterator {\n+    fn get_lints(&self) -> LintArray {\n+        lint_array![COPY_ITERATOR]\n+    }\n+}\n+\n+impl<'a, 'tcx> LateLintPass<'a, 'tcx> for CopyIterator {\n+    fn check_item(&mut self, cx: &LateContext<'a, 'tcx>, item: &'tcx Item) {\n+        if let ItemKind::Impl(_, _, _, _, Some(ref trait_ref), _, _) = item.node {\n+            let ty = cx.tcx.type_of(cx.tcx.hir.local_def_id(item.id));\n+\n+            if is_copy(cx, ty) && match_path(&trait_ref.path, &paths::ITERATOR) {\n+                span_note_and_lint(\n+                    cx,\n+                    COPY_ITERATOR,\n+                    item.span,\n+                    \"you are implementing `Iterator` on a `Copy` type\",\n+                    item.span,\n+                    \"consider implementing `IntoIterator` instead\",\n+                );\n+            }\n+        }\n+    }\n+}"}, {"sha": "ee2f0ca5406b34373ae0469fc2589f8b39b0b490", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/afdf3500600b27b1a54ac54e042eb4370d796837/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/afdf3500600b27b1a54ac54e042eb4370d796837/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=afdf3500600b27b1a54ac54e042eb4370d796837", "patch": "@@ -66,6 +66,7 @@ pub mod bytecount;\n pub mod collapsible_if;\n pub mod const_static_lifetime;\n pub mod copies;\n+pub mod copy_iterator;\n pub mod cyclomatic_complexity;\n pub mod default_trait_access;\n pub mod derive;\n@@ -338,6 +339,7 @@ pub fn register_plugins(reg: &mut rustc_plugin::Registry<'_>, conf: &Conf) {\n     reg.register_late_lint_pass(box types::InvalidUpcastComparisons);\n     reg.register_late_lint_pass(box regex::Pass::default());\n     reg.register_late_lint_pass(box copies::CopyAndPaste);\n+    reg.register_late_lint_pass(box copy_iterator::CopyIterator);\n     reg.register_late_lint_pass(box format::Pass);\n     reg.register_early_lint_pass(box formatting::Formatting);\n     reg.register_late_lint_pass(box swap::Swap);\n@@ -431,6 +433,7 @@ pub fn register_plugins(reg: &mut rustc_plugin::Registry<'_>, conf: &Conf) {\n     reg.register_lint_group(\"clippy_pedantic\", vec![\n         attrs::INLINE_ALWAYS,\n         copies::MATCH_SAME_ARMS,\n+        copy_iterator::COPY_ITERATOR,\n         default_trait_access::DEFAULT_TRAIT_ACCESS,\n         derive::EXPL_IMPL_CLONE_ON_COPY,\n         doc::DOC_MARKDOWN,"}, {"sha": "1b65cc4f8cc2d4001e00997a13b1f8417be4bd71", "filename": "tests/ui/copy_iterator.rs", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/afdf3500600b27b1a54ac54e042eb4370d796837/tests%2Fui%2Fcopy_iterator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/afdf3500600b27b1a54ac54e042eb4370d796837/tests%2Fui%2Fcopy_iterator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcopy_iterator.rs?ref=afdf3500600b27b1a54ac54e042eb4370d796837", "patch": "@@ -0,0 +1,23 @@\n+#![warn(copy_iterator)]\n+\n+#[derive(Copy, Clone)]\n+struct Countdown(u8);\n+\n+impl Iterator for Countdown {\n+    type Item = u8;\n+\n+    fn next(&mut self) -> Option<u8> {\n+        self.0.checked_sub(1).map(|c| {\n+            self.0 = c;\n+            c\n+        })\n+    }\n+}\n+\n+fn main() {\n+    let my_iterator = Countdown(5);\n+    let a: Vec<_> = my_iterator.take(1).collect();\n+    assert_eq!(a.len(), 1);\n+    let b: Vec<_> = my_iterator.collect();\n+    assert_eq!(b.len(), 5);\n+}"}, {"sha": "f520156b01e66b206bafac703e3302e3740e30ab", "filename": "tests/ui/copy_iterator.stderr", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/afdf3500600b27b1a54ac54e042eb4370d796837/tests%2Fui%2Fcopy_iterator.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/afdf3500600b27b1a54ac54e042eb4370d796837/tests%2Fui%2Fcopy_iterator.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcopy_iterator.stderr?ref=afdf3500600b27b1a54ac54e042eb4370d796837", "patch": "@@ -0,0 +1,17 @@\n+error: you are implementing `Iterator` on a `Copy` type\n+  --> $DIR/copy_iterator.rs:6:1\n+   |\n+6  | / impl Iterator for Countdown {\n+7  | |     type Item = u8;\n+8  | |\n+9  | |     fn next(&mut self) -> Option<u8> {\n+...  |\n+14 | |     }\n+15 | | }\n+   | |_^\n+   |\n+   = note: `-D copy-iterator` implied by `-D warnings`\n+   = note: consider implementing `IntoIterator` instead\n+\n+error: aborting due to previous error\n+"}]}