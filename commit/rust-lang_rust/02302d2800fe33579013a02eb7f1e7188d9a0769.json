{"sha": "02302d2800fe33579013a02eb7f1e7188d9a0769", "node_id": "MDY6Q29tbWl0NzI0NzEyOjAyMzAyZDI4MDBmZTMzNTc5MDEzYTAyZWI3ZjFlNzE4OGQ5YTA3Njk=", "commit": {"author": {"name": "Nick Cameron", "email": "ncameron@mozilla.com", "date": "2016-01-28T06:14:08Z"}, "committer": {"name": "Nick Cameron", "email": "ncameron@mozilla.com", "date": "2016-01-28T06:14:08Z"}, "message": "Don't reformat strings if we don't have to.\n\nSpecifically if no line exceeds the allowed width and we aren't moving the string to a new offset", "tree": {"sha": "f06d0924f89d5bfaa94af556b5a1d54bef055e63", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f06d0924f89d5bfaa94af556b5a1d54bef055e63"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/02302d2800fe33579013a02eb7f1e7188d9a0769", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/02302d2800fe33579013a02eb7f1e7188d9a0769", "html_url": "https://github.com/rust-lang/rust/commit/02302d2800fe33579013a02eb7f1e7188d9a0769", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/02302d2800fe33579013a02eb7f1e7188d9a0769/comments", "author": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fb17a44584a77a4ffddc0f8c375a34bed857e979", "url": "https://api.github.com/repos/rust-lang/rust/commits/fb17a44584a77a4ffddc0f8c375a34bed857e979", "html_url": "https://github.com/rust-lang/rust/commit/fb17a44584a77a4ffddc0f8c375a34bed857e979"}], "stats": {"total": 74, "additions": 69, "deletions": 5}, "files": [{"sha": "01fc86bdbf45c7c963cf0d700ce05622c5433974", "filename": "src/config.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/02302d2800fe33579013a02eb7f1e7188d9a0769/src%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/02302d2800fe33579013a02eb7f1e7188d9a0769/src%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fconfig.rs?ref=02302d2800fe33579013a02eb7f1e7188d9a0769", "patch": "@@ -334,7 +334,8 @@ create_config! {\n     chain_indent: BlockIndentStyle, BlockIndentStyle::Visual, \"Indentation of chain\";\n     reorder_imports: bool, false, \"Reorder import statements alphabetically\";\n     single_line_if_else: bool, false, \"Put else on same line as closing brace for if statements\";\n-    format_strings: bool, true, \"Format string literals, or leave as is\";\n+    format_strings: bool, true, \"Format string literals where necessary\";\n+    force_format_strings: bool, false, \"Always format string literals\";\n     chains_overflow_last: bool, true, \"Allow last call in method chain to break the line\";\n     take_source_hints: bool, true, \"Retain some formatting characteristics from the source code\";\n     hard_tabs: bool, false, \"Use tab characters for indentation, spaces for alignment\";"}, {"sha": "b299f82a883e0c6a60b970443b8f479df450414a", "filename": "src/expr.rs", "status": "modified", "additions": 36, "deletions": 4, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/02302d2800fe33579013a02eb7f1e7188d9a0769/src%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/02302d2800fe33579013a02eb7f1e7188d9a0769/src%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fexpr.rs?ref=02302d2800fe33579013a02eb7f1e7188d9a0769", "patch": "@@ -1182,8 +1182,15 @@ fn rewrite_string_lit(context: &RewriteContext,\n                       width: usize,\n                       offset: Indent)\n                       -> Option<String> {\n-    if !context.config.format_strings {\n-        return Some(context.snippet(span));\n+    let string_lit = context.snippet(span);\n+\n+    if !context.config.format_strings && !context.config.force_format_strings {\n+        return Some(string_lit);\n+    }\n+\n+    if !context.config.force_format_strings &&\n+       !string_requires_rewrite(context, span, &string_lit, width, offset) {\n+        return Some(string_lit);\n     }\n \n     let fmt = StringFormat {\n@@ -1197,12 +1204,37 @@ fn rewrite_string_lit(context: &RewriteContext,\n         config: context.config,\n     };\n \n-    let string_lit = context.snippet(span);\n-    let str_lit = &string_lit[1..string_lit.len() - 1]; // Remove the quote characters.\n+    // Remove the quote characters.\n+    let str_lit = &string_lit[1..string_lit.len() - 1];\n \n     rewrite_string(str_lit, &fmt)\n }\n \n+fn string_requires_rewrite(context: &RewriteContext,\n+                           span: Span,\n+                           string: &str,\n+                           width: usize,\n+                           offset: Indent)\n+                           -> bool {\n+    if context.codemap.lookup_char_pos(span.lo).col.0 != offset.width() {\n+        return true;\n+    }\n+\n+    for (i, line) in string.lines().enumerate() {\n+        if i == 0 {\n+            if line.len() > width {\n+                return true;\n+            }\n+        } else {\n+            if line.len() > width + offset.width() {\n+                return true;\n+            }\n+        }\n+    }\n+\n+    false\n+}\n+\n pub fn rewrite_call<R>(context: &RewriteContext,\n                        callee: &R,\n                        args: &[ptr::P<ast::Expr>],"}, {"sha": "8ba60ccac1d1269b6a312b4079ba3ab582aa0bac", "filename": "tests/source/string-lit-2.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/02302d2800fe33579013a02eb7f1e7188d9a0769/tests%2Fsource%2Fstring-lit-2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/02302d2800fe33579013a02eb7f1e7188d9a0769/tests%2Fsource%2Fstring-lit-2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fstring-lit-2.rs?ref=02302d2800fe33579013a02eb7f1e7188d9a0769", "patch": "@@ -0,0 +1,14 @@\n+fn main() -> &'static str {\n+    let too_many_lines = \"H\\\n+                          e\\\n+                          l\\\n+                          l\\\n+                          o\";\n+    let leave_me = \"sssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss\\\n+                    s\n+                    jjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjj\";\n+    // Crappy formatting :-(\n+    let change_me = \"ssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss\\\n+                     s\n+                     jjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjj\";\n+}"}, {"sha": "ca8aa36a90d8f63295e564ffd5b10f8c472f7ceb", "filename": "tests/source/string-lit.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/02302d2800fe33579013a02eb7f1e7188d9a0769/tests%2Fsource%2Fstring-lit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/02302d2800fe33579013a02eb7f1e7188d9a0769/tests%2Fsource%2Fstring-lit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fstring-lit.rs?ref=02302d2800fe33579013a02eb7f1e7188d9a0769", "patch": "@@ -1,3 +1,4 @@\n+// rustfmt-force_format_strings: true\n // Long string literals\n \n fn main() -> &'static str {"}, {"sha": "08e8be8186c7cd9c254af356ee78b101968f834f", "filename": "tests/target/string-lit-2.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/02302d2800fe33579013a02eb7f1e7188d9a0769/tests%2Ftarget%2Fstring-lit-2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/02302d2800fe33579013a02eb7f1e7188d9a0769/tests%2Ftarget%2Fstring-lit-2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fstring-lit-2.rs?ref=02302d2800fe33579013a02eb7f1e7188d9a0769", "patch": "@@ -0,0 +1,15 @@\n+fn main() -> &'static str {\n+    let too_many_lines = \"H\\\n+                          e\\\n+                          l\\\n+                          l\\\n+                          o\";\n+    let leave_me = \"sssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss\\\n+                    s\n+                    jjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjj\";\n+    // Crappy formatting :-(\n+    let change_me = \"sssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssssss\n+                     \\\n+                     jjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjjj\\\n+                     j\";\n+}"}, {"sha": "e7146a84f9e97c7ba43f7d4443645d6590f38b18", "filename": "tests/target/string-lit.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/02302d2800fe33579013a02eb7f1e7188d9a0769/tests%2Ftarget%2Fstring-lit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/02302d2800fe33579013a02eb7f1e7188d9a0769/tests%2Ftarget%2Fstring-lit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fstring-lit.rs?ref=02302d2800fe33579013a02eb7f1e7188d9a0769", "patch": "@@ -1,3 +1,4 @@\n+// rustfmt-force_format_strings: true\n // Long string literals\n \n fn main() -> &'static str {"}]}