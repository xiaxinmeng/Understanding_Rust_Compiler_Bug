{"sha": "55326992513aefa96af2a70c44aed4334e9eca23", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU1MzI2OTkyNTEzYWVmYTk2YWYyYTcwYzQ0YWVkNDMzNGU5ZWNhMjM=", "commit": {"author": {"name": "Mazdak Farrokhzad", "email": "twingoow@gmail.com", "date": "2019-10-19T14:00:54Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-10-19T14:00:54Z"}, "message": "Rollup merge of #65448 - eddyb:codegen-box-less-special, r=oli-obk\n\nrustc_codegen_ssa: remove some unnecessary Box special-casing.\n\nCould help simplify #60900.\n\nr? @nikomatsakis", "tree": {"sha": "f717ff42cb3cde86af2b716a06c7a238e521bc45", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f717ff42cb3cde86af2b716a06c7a238e521bc45"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/55326992513aefa96af2a70c44aed4334e9eca23", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJdqxcWCRBK7hj4Ov3rIwAAdHIIADCn7HKTcmUAS1hHAaNgaxo/\njkPDObay2tY0pyX/cJSnRte9k/s0UMdQEFVS2Y+83EmEoDIjcY42Z/vHe1B/J9qb\n2Nqdj04f1Fnww3iPS6vKkHf2vKkXgGvRHMwadRWmbYEpEgZsJnyFBoFwK8v5GnKO\nqkUVSTVY1EnuXo5rsjMKEIcyTwGLyC2C8hdhPFqQOnwGzYNfyUezT6CopZWWWK4f\nJNKXMtHa4GFMr3DL0/QJIqkT2uVFqIHkkuhG5c8z2fB3+ltHA6Wa/Es1TcUjf6Li\n+L1tAzLcri/gRycUERxfl7K419Smg2TCvGxthajhLEe82BuXMLF8Al4No2U9PMg=\n=u2S8\n-----END PGP SIGNATURE-----\n", "payload": "tree f717ff42cb3cde86af2b716a06c7a238e521bc45\nparent a6b5c80dbc879a80633d49f2c4bebe193ab1134c\nparent c39af6e79b135ed0462b5cb11eb530cbd07facad\nauthor Mazdak Farrokhzad <twingoow@gmail.com> 1571493654 +0200\ncommitter GitHub <noreply@github.com> 1571493654 +0200\n\nRollup merge of #65448 - eddyb:codegen-box-less-special, r=oli-obk\n\nrustc_codegen_ssa: remove some unnecessary Box special-casing.\n\nCould help simplify #60900.\n\nr? @nikomatsakis\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/55326992513aefa96af2a70c44aed4334e9eca23", "html_url": "https://github.com/rust-lang/rust/commit/55326992513aefa96af2a70c44aed4334e9eca23", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/55326992513aefa96af2a70c44aed4334e9eca23/comments", "author": {"login": "Centril", "id": 855702, "node_id": "MDQ6VXNlcjg1NTcwMg==", "avatar_url": "https://avatars.githubusercontent.com/u/855702?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Centril", "html_url": "https://github.com/Centril", "followers_url": "https://api.github.com/users/Centril/followers", "following_url": "https://api.github.com/users/Centril/following{/other_user}", "gists_url": "https://api.github.com/users/Centril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Centril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Centril/subscriptions", "organizations_url": "https://api.github.com/users/Centril/orgs", "repos_url": "https://api.github.com/users/Centril/repos", "events_url": "https://api.github.com/users/Centril/events{/privacy}", "received_events_url": "https://api.github.com/users/Centril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a6b5c80dbc879a80633d49f2c4bebe193ab1134c", "url": "https://api.github.com/repos/rust-lang/rust/commits/a6b5c80dbc879a80633d49f2c4bebe193ab1134c", "html_url": "https://github.com/rust-lang/rust/commit/a6b5c80dbc879a80633d49f2c4bebe193ab1134c"}, {"sha": "c39af6e79b135ed0462b5cb11eb530cbd07facad", "url": "https://api.github.com/repos/rust-lang/rust/commits/c39af6e79b135ed0462b5cb11eb530cbd07facad", "html_url": "https://github.com/rust-lang/rust/commit/c39af6e79b135ed0462b5cb11eb530cbd07facad"}], "stats": {"total": 46, "additions": 19, "deletions": 27}, "files": [{"sha": "f4f3dd4d2d295520629a458f2d320ed11a8071db", "filename": "src/librustc_codegen_ssa/base.rs", "status": "modified", "additions": 19, "deletions": 27, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/55326992513aefa96af2a70c44aed4334e9eca23/src%2Flibrustc_codegen_ssa%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/55326992513aefa96af2a70c44aed4334e9eca23/src%2Flibrustc_codegen_ssa%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fbase.rs?ref=55326992513aefa96af2a70c44aed4334e9eca23", "patch": "@@ -168,12 +168,6 @@ pub fn unsize_thin_ptr<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>>(\n             let ptr_ty = bx.cx().type_ptr_to(bx.cx().backend_type(bx.cx().layout_of(b)));\n             (bx.pointercast(src, ptr_ty), unsized_info(bx.cx(), a, b, None))\n         }\n-        (&ty::Adt(def_a, _), &ty::Adt(def_b, _)) if def_a.is_box() && def_b.is_box() => {\n-            let (a, b) = (src_ty.boxed_ty(), dst_ty.boxed_ty());\n-            assert!(bx.cx().type_is_sized(a));\n-            let ptr_ty = bx.cx().type_ptr_to(bx.cx().backend_type(bx.cx().layout_of(b)));\n-            (bx.pointercast(src, ptr_ty), unsized_info(bx.cx(), a, b, None))\n-        }\n         (&ty::Adt(def_a, _), &ty::Adt(def_b, _)) => {\n             assert_eq!(def_a, def_b);\n \n@@ -196,6 +190,8 @@ pub fn unsize_thin_ptr<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>>(\n             }\n             let (lldata, llextra) = result.unwrap();\n             // HACK(eddyb) have to bitcast pointers until LLVM removes pointee types.\n+            // FIXME(eddyb) move these out of this `match` arm, so they're always\n+            // applied, uniformly, no matter the source/destination types.\n             (bx.bitcast(lldata, bx.cx().scalar_pair_element_backend_type(dst_layout, 0, true)),\n              bx.bitcast(llextra, bx.cx().scalar_pair_element_backend_type(dst_layout, 1, true)))\n         }\n@@ -212,31 +208,27 @@ pub fn coerce_unsized_into<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>>(\n ) {\n     let src_ty = src.layout.ty;\n     let dst_ty = dst.layout.ty;\n-    let mut coerce_ptr = || {\n-        let (base, info) = match bx.load_operand(src).val {\n-            OperandValue::Pair(base, info) => {\n-                // fat-ptr to fat-ptr unsize preserves the vtable\n-                // i.e., &'a fmt::Debug+Send => &'a fmt::Debug\n-                // So we need to pointercast the base to ensure\n-                // the types match up.\n-                let thin_ptr = dst.layout.field(bx.cx(), FAT_PTR_ADDR);\n-                (bx.pointercast(base, bx.cx().backend_type(thin_ptr)), info)\n-            }\n-            OperandValue::Immediate(base) => {\n-                unsize_thin_ptr(bx, base, src_ty, dst_ty)\n-            }\n-            OperandValue::Ref(..) => bug!()\n-        };\n-        OperandValue::Pair(base, info).store(bx, dst);\n-    };\n     match (&src_ty.kind, &dst_ty.kind) {\n         (&ty::Ref(..), &ty::Ref(..)) |\n         (&ty::Ref(..), &ty::RawPtr(..)) |\n         (&ty::RawPtr(..), &ty::RawPtr(..)) => {\n-            coerce_ptr()\n-        }\n-        (&ty::Adt(def_a, _), &ty::Adt(def_b, _)) if def_a.is_box() && def_b.is_box() => {\n-            coerce_ptr()\n+            let (base, info) = match bx.load_operand(src).val {\n+                OperandValue::Pair(base, info) => {\n+                    // fat-ptr to fat-ptr unsize preserves the vtable\n+                    // i.e., &'a fmt::Debug+Send => &'a fmt::Debug\n+                    // So we need to pointercast the base to ensure\n+                    // the types match up.\n+                    // FIXME(eddyb) use `scalar_pair_element_backend_type` here,\n+                    // like `unsize_thin_ptr` does.\n+                    let thin_ptr = dst.layout.field(bx.cx(), FAT_PTR_ADDR);\n+                    (bx.pointercast(base, bx.cx().backend_type(thin_ptr)), info)\n+                }\n+                OperandValue::Immediate(base) => {\n+                    unsize_thin_ptr(bx, base, src_ty, dst_ty)\n+                }\n+                OperandValue::Ref(..) => bug!()\n+            };\n+            OperandValue::Pair(base, info).store(bx, dst);\n         }\n \n         (&ty::Adt(def_a, _), &ty::Adt(def_b, _)) => {"}]}