{"sha": "0393a1602fd224adc36b62e7158f3b1ebb257afb", "node_id": "MDY6Q29tbWl0NzI0NzEyOjAzOTNhMTYwMmZkMjI0YWRjMzZiNjJlNzE1OGYzYjFlYmIyNTdhZmI=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2015-01-06T23:38:56Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2015-01-06T23:38:56Z"}, "message": "rollup merge of #20650: klutzy/omg-windows-error-mode\n\nBelieve or not, `CreateProcess()` is racy if several threads create\nchild processes: [0], [1], [2].\n\nThis caused some tests show crash dialogs during\n`make check-stage#-rpass`.\n\nMore explanation:\n\nOn Windows, `SetErrorMode()` controls display of error dialogs: it\naccepts new error mode and returns old error mode.\nThe error mode is process-global and automatically inherited to child\nprocess when created.\n\nMSYS2 bash shell internally sets it to not show error dialogs, therefore\n`make check-stage#-rpass` should not show them either.\n\nHowever, [1] says that `CreateProcess()` internally invokes\n`SetErrorMode()` twice: at first it sets mode `0x8001` and saves\noriginal mode, and at second it restores original mode.\nSo if two threads simultaneously call `CreateProcess()`, the first\nthread sets error mode to `0x8001` then the second thread recognizes\nthat current error mode is `0x8001`. Therefore, The second thread will\ncreate process with wrong error mode.\n\nThis really occurs inside `compiletest`: it creates several processes on\neach thread, so some `run-pass` tests are invoked with wrong error mode\ntherefore show crash dialog.\n\nThis commit adds `StaticMutex` for `CreateProcess()` call. This seems\nto fix the \"dialog annoyance\" issue.\n\n[0]: http://support.microsoft.com/kb/315939\n[1]: https://code.google.com/p/nativeclient/issues/detail?id=2968\n[2]: https://ghc.haskell.org/trac/ghc/ticket/2650", "tree": {"sha": "615625694c1ed0e83323af1224878b0b38fb6457", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/615625694c1ed0e83323af1224878b0b38fb6457"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0393a1602fd224adc36b62e7158f3b1ebb257afb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0393a1602fd224adc36b62e7158f3b1ebb257afb", "html_url": "https://github.com/rust-lang/rust/commit/0393a1602fd224adc36b62e7158f3b1ebb257afb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0393a1602fd224adc36b62e7158f3b1ebb257afb/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "36f5d122b80682de473aeda2e20f14b6ceb86d74", "url": "https://api.github.com/repos/rust-lang/rust/commits/36f5d122b80682de473aeda2e20f14b6ceb86d74", "html_url": "https://github.com/rust-lang/rust/commit/36f5d122b80682de473aeda2e20f14b6ceb86d74"}, {"sha": "68cb17097ae92dd50ff076d4b34d955836c4977c", "url": "https://api.github.com/repos/rust-lang/rust/commits/68cb17097ae92dd50ff076d4b34d955836c4977c", "html_url": "https://github.com/rust-lang/rust/commit/68cb17097ae92dd50ff076d4b34d955836c4977c"}], "stats": {"total": 7, "additions": 7, "deletions": 0}, "files": [{"sha": "8e1f169b5cdcc05864d79a05fb26e6198fda9a41", "filename": "src/libstd/sys/windows/process.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/0393a1602fd224adc36b62e7158f3b1ebb257afb/src%2Flibstd%2Fsys%2Fwindows%2Fprocess.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0393a1602fd224adc36b62e7158f3b1ebb257afb/src%2Flibstd%2Fsys%2Fwindows%2Fprocess.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Fwindows%2Fprocess.rs?ref=0393a1602fd224adc36b62e7158f3b1ebb257afb", "patch": "@@ -25,13 +25,19 @@ use path::BytesContainer;\n use ptr;\n use str;\n use sys::fs::FileDesc;\n+use sync::{StaticMutex, MUTEX_INIT};\n+\n use sys::fs;\n use sys::{self, retry, c, wouldblock, set_nonblocking, ms_to_timeval, timer};\n use sys_common::helper_thread::Helper;\n use sys_common::{AsInner, mkerr_libc, timeout};\n \n pub use sys_common::ProcessConfig;\n \n+// `CreateProcess` is racy!\n+// http://support.microsoft.com/kb/315939\n+static CREATE_PROCESS_LOCK: StaticMutex = MUTEX_INIT;\n+\n /// A value representing a child process.\n ///\n /// The lifetime of this value is linked to the lifetime of the actual\n@@ -224,6 +230,7 @@ impl Process {\n                 with_dirp(cfg.cwd(), |dirp| {\n                     let mut cmd_str: Vec<u16> = cmd_str.utf16_units().collect();\n                     cmd_str.push(0);\n+                    let _lock = CREATE_PROCESS_LOCK.lock().unwrap();\n                     let created = CreateProcessW(ptr::null(),\n                                                  cmd_str.as_mut_ptr(),\n                                                  ptr::null_mut(),"}]}