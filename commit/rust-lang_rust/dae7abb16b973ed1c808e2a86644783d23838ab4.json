{"sha": "dae7abb16b973ed1c808e2a86644783d23838ab4", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRhZTdhYmIxNmI5NzNlZDFjODA4ZTJhODY2NDQ3ODNkMjM4MzhhYjQ=", "commit": {"author": {"name": "Philipp Hansch", "email": "dev@phansch.net", "date": "2018-10-16T19:35:25Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2018-10-16T19:35:25Z"}, "message": "Merge pull request #3325 from phansch/riir_update_lints_first_replace_region\n\nRIIR update_lints: Replace lint count in README.md", "tree": {"sha": "485444422c0a9c4e259973fbcc79c3185460f36d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/485444422c0a9c4e259973fbcc79c3185460f36d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/dae7abb16b973ed1c808e2a86644783d23838ab4", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJbxj19CRBK7hj4Ov3rIwAAdHIIAGdQDqLw+V9GNN0jk5QN+Y7l\nwn71QG9MqOChTWasNrawPSuqudcUjZFVg0hBEeNtiS0su1bGrEmhgaNOHM6IkRnL\nBP1bMx8HYiHKUU7Q/77wt8JXUvUP/sIYuGLftw8phywRikWE8HZYw/A6AVn996B0\nFVFr3VhebVyUasmAGeQxWU2s8R0CTa1drHcGGzn9Qj5gI7FZxkL8/HyM+hC9E3BF\n67BfT2xQU/q35KePguOPYvEVJR8Mllm7wXhQBURiGwJ6yOX+N/WjaXWYT4uXd0SI\nO+lCENHHTdGJN5qAmI5DBcZW9P+ebpd9g7gj+/8TIbTplWLubD60tYLmyRaSztQ=\n=1jH3\n-----END PGP SIGNATURE-----\n", "payload": "tree 485444422c0a9c4e259973fbcc79c3185460f36d\nparent 6ae89c4f1123d81e56141b02cd3b83436c1ad035\nparent 05ffc2d05743c0cc4ad5e551c147dc8385e67bac\nauthor Philipp Hansch <dev@phansch.net> 1539718525 +0200\ncommitter GitHub <noreply@github.com> 1539718525 +0200\n\nMerge pull request #3325 from phansch/riir_update_lints_first_replace_region\n\nRIIR update_lints: Replace lint count in README.md"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/dae7abb16b973ed1c808e2a86644783d23838ab4", "html_url": "https://github.com/rust-lang/rust/commit/dae7abb16b973ed1c808e2a86644783d23838ab4", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/dae7abb16b973ed1c808e2a86644783d23838ab4/comments", "author": {"login": "phansch", "id": 2042399, "node_id": "MDQ6VXNlcjIwNDIzOTk=", "avatar_url": "https://avatars.githubusercontent.com/u/2042399?v=4", "gravatar_id": "", "url": "https://api.github.com/users/phansch", "html_url": "https://github.com/phansch", "followers_url": "https://api.github.com/users/phansch/followers", "following_url": "https://api.github.com/users/phansch/following{/other_user}", "gists_url": "https://api.github.com/users/phansch/gists{/gist_id}", "starred_url": "https://api.github.com/users/phansch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/phansch/subscriptions", "organizations_url": "https://api.github.com/users/phansch/orgs", "repos_url": "https://api.github.com/users/phansch/repos", "events_url": "https://api.github.com/users/phansch/events{/privacy}", "received_events_url": "https://api.github.com/users/phansch/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6ae89c4f1123d81e56141b02cd3b83436c1ad035", "url": "https://api.github.com/repos/rust-lang/rust/commits/6ae89c4f1123d81e56141b02cd3b83436c1ad035", "html_url": "https://github.com/rust-lang/rust/commit/6ae89c4f1123d81e56141b02cd3b83436c1ad035"}, {"sha": "05ffc2d05743c0cc4ad5e551c147dc8385e67bac", "url": "https://api.github.com/repos/rust-lang/rust/commits/05ffc2d05743c0cc4ad5e551c147dc8385e67bac", "html_url": "https://github.com/rust-lang/rust/commit/05ffc2d05743c0cc4ad5e551c147dc8385e67bac"}], "stats": {"total": 162, "additions": 153, "deletions": 9}, "files": [{"sha": "dcb2de2b1f8ee005326f49979aa540d5aaa13615", "filename": "clippy_dev/src/lib.rs", "status": "modified", "additions": 128, "deletions": 6, "changes": 134, "blob_url": "https://github.com/rust-lang/rust/blob/dae7abb16b973ed1c808e2a86644783d23838ab4/clippy_dev%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dae7abb16b973ed1c808e2a86644783d23838ab4/clippy_dev%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_dev%2Fsrc%2Flib.rs?ref=dae7abb16b973ed1c808e2a86644783d23838ab4", "patch": "@@ -57,9 +57,9 @@ impl Lint {\n         }\n     }\n \n-    /// Returns all non-deprecated lints\n-    pub fn active_lints(lints: impl Iterator<Item=Self>) -> impl Iterator<Item=Self> {\n-        lints.filter(|l| l.deprecation.is_none())\n+    /// Returns all non-deprecated lints and non-internal lints\n+    pub fn usable_lints(lints: impl Iterator<Item=Self>) -> impl Iterator<Item=Self> {\n+        lints.filter(|l| l.deprecation.is_none() && !l.group.starts_with(\"internal\"))\n     }\n \n     /// Returns the lints in a HashMap, grouped by the different lint groups\n@@ -101,6 +101,89 @@ fn lint_files() -> impl Iterator<Item=walkdir::DirEntry> {\n         .filter(|f| f.path().extension() == Some(OsStr::new(\"rs\")))\n }\n \n+/// Replace a region in a file delimited by two lines matching regexes.\n+///\n+/// `path` is the relative path to the file on which you want to perform the replacement.\n+///\n+/// See `replace_region_in_text` for documentation of the other options.\n+#[allow(clippy::expect_fun_call)]\n+pub fn replace_region_in_file<F>(path: &str, start: &str, end: &str, replace_start: bool, replacements: F) where F: Fn() -> Vec<String> {\n+    let mut f = fs::File::open(path).expect(&format!(\"File not found: {}\", path));\n+    let mut contents = String::new();\n+    f.read_to_string(&mut contents).expect(\"Something went wrong reading the file\");\n+    let replaced = replace_region_in_text(&contents, start, end, replace_start, replacements);\n+\n+    let mut f = fs::File::create(path).expect(&format!(\"File not found: {}\", path));\n+    f.write_all(replaced.as_bytes()).expect(\"Unable to write file\");\n+    // Ensure we write the changes with a trailing newline so that\n+    // the file has the proper line endings.\n+    f.write_all(b\"\\n\").expect(\"Unable to write file\");\n+}\n+\n+/// Replace a region in a text delimited by two lines matching regexes.\n+///\n+/// * `text` is the input text on which you want to perform the replacement\n+/// * `start` is a `&str` that describes the delimiter line before the region you want to replace.\n+///   As the `&str` will be converted to a `Regex`, this can contain regex syntax, too.\n+/// * `end` is a `&str` that describes the delimiter line until where the replacement should\n+///   happen.  As the `&str` will be converted to a `Regex`, this can contain regex syntax, too.\n+/// * If `replace_start` is true, the `start` delimiter line is replaced as well.\n+///   The `end` delimiter line is never replaced.\n+/// * `replacements` is a closure that has to return a `Vec<String>` which contains the new text.\n+///\n+/// If you want to perform the replacement on files instead of already parsed text,\n+/// use `replace_region_in_file`.\n+///\n+/// # Example\n+///\n+/// ```\n+/// let the_text = \"replace_start\\nsome text\\nthat will be replaced\\nreplace_end\";\n+/// let result = clippy_dev::replace_region_in_text(\n+///     the_text,\n+///     r#\"replace_start\"#,\n+///     r#\"replace_end\"#,\n+///     false,\n+///     || {\n+///         vec![\"a different\".to_string(), \"text\".to_string()]\n+///     }\n+/// );\n+/// assert_eq!(\"replace_start\\na different\\ntext\\nreplace_end\", result);\n+/// ```\n+pub fn replace_region_in_text<F>(text: &str, start: &str, end: &str, replace_start: bool, replacements: F) -> String where F: Fn() -> Vec<String> {\n+    let lines = text.lines();\n+    let mut in_old_region = false;\n+    let mut found = false;\n+    let mut new_lines = vec![];\n+    let start = Regex::new(start).unwrap();\n+    let end = Regex::new(end).unwrap();\n+\n+    for line in lines {\n+        if in_old_region {\n+            if end.is_match(&line) {\n+                in_old_region = false;\n+                new_lines.extend(replacements());\n+                new_lines.push(line.to_string());\n+            }\n+        } else if start.is_match(&line) {\n+            if !replace_start {\n+                new_lines.push(line.to_string());\n+            }\n+            in_old_region = true;\n+            found = true;\n+        } else {\n+            new_lines.push(line.to_string());\n+        }\n+    }\n+\n+    if !found {\n+        // This happens if the provided regex in `clippy_dev/src/main.rs` is not found in the\n+        // given text or file. Most likely this is an error on the programmer's side and the Regex\n+        // is incorrect.\n+        println!(\"regex {:?} not found. You may have to update it.\", start);\n+    }\n+    new_lines.join(\"\\n\")\n+}\n+\n #[test]\n fn test_parse_contents() {\n     let result: Vec<Lint> = parse_contents(\n@@ -141,15 +224,54 @@ declare_deprecated_lint! {\n }\n \n #[test]\n-fn test_active_lints() {\n+fn test_replace_region() {\n+    let text = r#\"\n+abc\n+123\n+789\n+def\n+ghi\"#;\n+    let expected = r#\"\n+abc\n+hello world\n+def\n+ghi\"#;\n+    let result = replace_region_in_text(text, r#\"^\\s*abc$\"#, r#\"^\\s*def\"#, false, || {\n+        vec![\"hello world\".to_string()]\n+    });\n+    assert_eq!(expected, result);\n+}\n+\n+#[test]\n+fn test_replace_region_with_start() {\n+    let text = r#\"\n+abc\n+123\n+789\n+def\n+ghi\"#;\n+    let expected = r#\"\n+hello world\n+def\n+ghi\"#;\n+    let result = replace_region_in_text(text, r#\"^\\s*abc$\"#, r#\"^\\s*def\"#, true, || {\n+        vec![\"hello world\".to_string()]\n+    });\n+    assert_eq!(expected, result);\n+}\n+\n+#[test]\n+fn test_usable_lints() {\n     let lints = vec![\n         Lint::new(\"should_assert_eq\", \"Deprecated\", \"abc\", Some(\"Reason\"), \"module_name\"),\n-        Lint::new(\"should_assert_eq2\", \"Not Deprecated\", \"abc\", None, \"module_name\")\n+        Lint::new(\"should_assert_eq2\", \"Not Deprecated\", \"abc\", None, \"module_name\"),\n+        Lint::new(\"should_assert_eq2\", \"internal\", \"abc\", None, \"module_name\"),\n+        Lint::new(\"should_assert_eq2\", \"internal_style\", \"abc\", None, \"module_name\")\n     ];\n     let expected = vec![\n         Lint::new(\"should_assert_eq2\", \"Not Deprecated\", \"abc\", None, \"module_name\")\n     ];\n-    assert_eq!(expected, Lint::active_lints(lints.into_iter()).collect::<Vec<Lint>>());\n+    assert_eq!(expected, Lint::usable_lints(lints.into_iter()).collect::<Vec<Lint>>());\n }\n \n #[test]"}, {"sha": "7b688836a95a0817e44b295fce9f6f539f2c1653", "filename": "clippy_dev/src/main.rs", "status": "modified", "additions": 25, "deletions": 3, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/dae7abb16b973ed1c808e2a86644783d23838ab4/clippy_dev%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/dae7abb16b973ed1c808e2a86644783d23838ab4/clippy_dev%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_dev%2Fsrc%2Fmain.rs?ref=dae7abb16b973ed1c808e2a86644783d23838ab4", "patch": "@@ -32,13 +32,17 @@ fn main() {\n     if let Some(matches) = matches.subcommand_matches(\"update_lints\") {\n         if matches.is_present(\"print-only\") {\n             print_lints();\n+        } else {\n+            update_lints();\n         }\n     }\n }\n \n fn print_lints() {\n-    let lint_list = gather_all().collect::<Vec<Lint>>();\n-    let grouped_by_lint_group = Lint::by_lint_group(&lint_list);\n+    let lint_list = gather_all();\n+    let usable_lints: Vec<Lint> = Lint::usable_lints(lint_list).collect();\n+    let lint_count = usable_lints.len();\n+    let grouped_by_lint_group = Lint::by_lint_group(&usable_lints);\n \n     for (lint_group, mut lints) in grouped_by_lint_group {\n         if lint_group == \"Deprecated\" { continue; }\n@@ -51,5 +55,23 @@ fn print_lints() {\n         }\n     }\n \n-    println!(\"there are {} lints\", Lint::active_lints(lint_list.into_iter()).count());\n+    println!(\"there are {} lints\", lint_count);\n+}\n+\n+fn update_lints() {\n+    let lint_list = gather_all();\n+    let usable_lints: Vec<Lint> = Lint::usable_lints(lint_list).collect();\n+    let lint_count = usable_lints.len();\n+\n+    replace_region_in_file(\n+        \"../README.md\",\n+        r#\"\\[There are \\d+ lints included in this crate!\\]\\(https://rust-lang-nursery.github.io/rust-clippy/master/index.html\\)\"#,\n+        \"\",\n+        true,\n+        || {\n+            vec![\n+                format!(\"[There are {} lints included in this crate!](https://rust-lang-nursery.github.io/rust-clippy/master/index.html)\", lint_count)\n+            ]\n+        }\n+    );\n }"}]}