{"sha": "89d35060b900f0aa441ca16b1bde2cdebcb46263", "node_id": "C_kwDOAAsO6NoAKDg5ZDM1MDYwYjkwMGYwYWE0NDFjYTE2YjFiZGUyY2RlYmNiNDYyNjM", "commit": {"author": {"name": "Eric Holk", "email": "ericholk@microsoft.com", "date": "2022-05-23T19:50:55Z"}, "committer": {"name": "Eric Holk", "email": "ericholk@microsoft.com", "date": "2022-07-29T22:59:26Z"}, "message": "Update must_not_suspend lint to traverse references", "tree": {"sha": "4c7f509dc49a256794a037480eecf7dd8fefe0a9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4c7f509dc49a256794a037480eecf7dd8fefe0a9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/89d35060b900f0aa441ca16b1bde2cdebcb46263", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/89d35060b900f0aa441ca16b1bde2cdebcb46263", "html_url": "https://github.com/rust-lang/rust/commit/89d35060b900f0aa441ca16b1bde2cdebcb46263", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/89d35060b900f0aa441ca16b1bde2cdebcb46263/comments", "author": {"login": "eholk", "id": 105766, "node_id": "MDQ6VXNlcjEwNTc2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/105766?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eholk", "html_url": "https://github.com/eholk", "followers_url": "https://api.github.com/users/eholk/followers", "following_url": "https://api.github.com/users/eholk/following{/other_user}", "gists_url": "https://api.github.com/users/eholk/gists{/gist_id}", "starred_url": "https://api.github.com/users/eholk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eholk/subscriptions", "organizations_url": "https://api.github.com/users/eholk/orgs", "repos_url": "https://api.github.com/users/eholk/repos", "events_url": "https://api.github.com/users/eholk/events{/privacy}", "received_events_url": "https://api.github.com/users/eholk/received_events", "type": "User", "site_admin": false}, "committer": {"login": "eholk", "id": 105766, "node_id": "MDQ6VXNlcjEwNTc2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/105766?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eholk", "html_url": "https://github.com/eholk", "followers_url": "https://api.github.com/users/eholk/followers", "following_url": "https://api.github.com/users/eholk/following{/other_user}", "gists_url": "https://api.github.com/users/eholk/gists{/gist_id}", "starred_url": "https://api.github.com/users/eholk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eholk/subscriptions", "organizations_url": "https://api.github.com/users/eholk/orgs", "repos_url": "https://api.github.com/users/eholk/repos", "events_url": "https://api.github.com/users/eholk/events{/privacy}", "received_events_url": "https://api.github.com/users/eholk/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "bdfc68855861ecea26844a66c38c53f496386b7d", "url": "https://api.github.com/repos/rust-lang/rust/commits/bdfc68855861ecea26844a66c38c53f496386b7d", "html_url": "https://github.com/rust-lang/rust/commit/bdfc68855861ecea26844a66c38c53f496386b7d"}], "stats": {"total": 18, "additions": 12, "deletions": 6}, "files": [{"sha": "b897d137f74ae92470c9eaa7246176494548f4f7", "filename": "compiler/rustc_typeck/src/check/generator_interior.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/89d35060b900f0aa441ca16b1bde2cdebcb46263/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fgenerator_interior.rs", "raw_url": "https://github.com/rust-lang/rust/raw/89d35060b900f0aa441ca16b1bde2cdebcb46263/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fgenerator_interior.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fgenerator_interior.rs?ref=89d35060b900f0aa441ca16b1bde2cdebcb46263", "patch": "@@ -489,6 +489,8 @@ pub fn check_must_not_suspend_ty<'tcx>(\n \n     let plural_suffix = pluralize!(data.plural_len);\n \n+    debug!(\"Checking must_not_suspend for {}\", ty);\n+\n     match *ty.kind() {\n         ty::Adt(..) if ty.is_box() => {\n             let boxed_ty = ty.boxed_ty();\n@@ -580,6 +582,10 @@ pub fn check_must_not_suspend_ty<'tcx>(\n                 },\n             )\n         }\n+        ty::Ref(_region, ty, _mutability) => {\n+            let descr_pre = &format!(\"{}reference{} to \", data.descr_pre, plural_suffix);\n+            check_must_not_suspend_ty(fcx, ty, hir_id, SuspendCheckData { descr_pre, ..data })\n+        }\n         _ => false,\n     }\n }"}, {"sha": "8fbf3e71649efce85f6e30af835917bc1e1e3213", "filename": "src/test/ui/lint/must_not_suspend/ref.stderr", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/89d35060b900f0aa441ca16b1bde2cdebcb46263/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Fref.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/89d35060b900f0aa441ca16b1bde2cdebcb46263/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Fref.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Fmust_not_suspend%2Fref.stderr?ref=89d35060b900f0aa441ca16b1bde2cdebcb46263", "patch": "@@ -1,5 +1,5 @@\n-error: `Umm` held across a suspend point, but should not be\n-  --> $DIR/ref.rs:18:26\n+error: reference to `Umm` held across a suspend point, but should not be\n+  --> $DIR/ref.rs:18:13\n    |\n LL |         let guard = &mut self.u;\n    |                          ^^^^^^\n@@ -13,15 +13,15 @@ note: the lint level is defined here\n LL | #![deny(must_not_suspend)]\n    |         ^^^^^^^^^^^^^^^^\n note: You gotta use Umm's, ya know?\n-  --> $DIR/ref.rs:18:26\n+  --> $DIR/ref.rs:18:13\n    |\n LL |         let guard = &mut self.u;\n-   |                          ^^^^^^\n+   |             ^^^^^\n help: consider using a block (`{ ... }`) to shrink the value's scope, ending before the suspend point\n-  --> $DIR/ref.rs:18:26\n+  --> $DIR/ref.rs:18:13\n    |\n LL |         let guard = &mut self.u;\n-   |                          ^^^^^^\n+   |             ^^^^^\n \n error: aborting due to previous error\n "}]}