{"sha": "b84ab57f90a83e03bb0ac5d6ed13ec3f7e3edb94", "node_id": "C_kwDOAAsO6NoAKGI4NGFiNTdmOTBhODNlMDNiYjBhYzVkNmVkMTNlYzNmN2UzZWRiOTQ", "commit": {"author": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2023-05-24T22:05:04Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-05-24T22:05:04Z"}, "message": "Rollup merge of #111840 - voidc:borrowck-consumers, r=oli-obk\n\nExpose more information in `get_body_with_borrowck_facts`\n\nVerification tools for Rust such as, for example, Creusot or Prusti would benefit from having access to more information computed by the borrow checker.\nAs a first step in that direction, #86977 added the `get_body_with_borrowck_facts` API, allowing compiler consumers to obtain a `mir::Body` with accompanying borrow checker information.\nAt RustVerify 2023, multiple people working on verification tools expressed their need for a more comprehensive API.\nWhile eventually borrow information could be part of Stable MIR, in the meantime, this PR proposes a more limited approach, extending the existing `get_body_with_borrowck_facts` API.\nIn summary, we propose the following changes:\n\n- Permit obtaining the borrow-checked body without necessarily running Polonius\n- Return the `BorrowSet` and the `RegionInferenceContext` in `BodyWithBorrowckFacts`\n- Provide a way to compute the `borrows_out_of_scope_at_location` map\n- Make some helper methods public\n\nThis is similar to #108328 but smaller in scope.\n`@smoelius` Do you think these changes would also be sufficient for your needs?\n\nr? `@oli-obk`\ncc `@JonasAlaif`", "tree": {"sha": "f2e039aad6ba6a7d1dea19f7e36e9616cdd7a4f5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f2e039aad6ba6a7d1dea19f7e36e9616cdd7a4f5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b84ab57f90a83e03bb0ac5d6ed13ec3f7e3edb94", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkbooQCRBK7hj4Ov3rIwAABsUIAFklvynWVvemyuukrQNIgdg7\ny8v6pAGOKY8TnkDi8eak3M4YhjCMqjdCfc5tf4PpeQekBrn+halJFGvvaJkwvRIP\nyvmZfPpxZfWJPMJIb1Ozde+ET8C+a9POXxshl7VBVJSdF/mEtSUAS1SbvmK/FoOJ\nqdkgI7P+7nH2E6bYpt9gaK4eBQMQ+Hpulr61mWdBSrJYP2r+CPy2v/FIro4Sk+as\nPnj+6012YsZqD9cD2DjLvSkVHKvInipR9//b0S7JO2mf7Ujty0kOAAQ4KNfKzCle\np4+t3kmAzSJYGVpMoSE7o/47LY6LtyFm0+z1Ge/x/tdZwhy93yBJx8tWyNbLahY=\n=FkfF\n-----END PGP SIGNATURE-----\n", "payload": "tree f2e039aad6ba6a7d1dea19f7e36e9616cdd7a4f5\nparent a9a4c9b3dbfcd7c51b377985ccc2a030f93da9fb\nparent 8dac074087afc9f02a794027bede787bb9367ad3\nauthor Manish Goregaokar <manishsmail@gmail.com> 1684965904 -0700\ncommitter GitHub <noreply@github.com> 1684965904 -0700\n\nRollup merge of #111840 - voidc:borrowck-consumers, r=oli-obk\n\nExpose more information in `get_body_with_borrowck_facts`\n\nVerification tools for Rust such as, for example, Creusot or Prusti would benefit from having access to more information computed by the borrow checker.\nAs a first step in that direction, #86977 added the `get_body_with_borrowck_facts` API, allowing compiler consumers to obtain a `mir::Body` with accompanying borrow checker information.\nAt RustVerify 2023, multiple people working on verification tools expressed their need for a more comprehensive API.\nWhile eventually borrow information could be part of Stable MIR, in the meantime, this PR proposes a more limited approach, extending the existing `get_body_with_borrowck_facts` API.\nIn summary, we propose the following changes:\n\n- Permit obtaining the borrow-checked body without necessarily running Polonius\n- Return the `BorrowSet` and the `RegionInferenceContext` in `BodyWithBorrowckFacts`\n- Provide a way to compute the `borrows_out_of_scope_at_location` map\n- Make some helper methods public\n\nThis is similar to #108328 but smaller in scope.\n`@smoelius` Do you think these changes would also be sufficient for your needs?\n\nr? `@oli-obk`\ncc `@JonasAlaif`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b84ab57f90a83e03bb0ac5d6ed13ec3f7e3edb94", "html_url": "https://github.com/rust-lang/rust/commit/b84ab57f90a83e03bb0ac5d6ed13ec3f7e3edb94", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b84ab57f90a83e03bb0ac5d6ed13ec3f7e3edb94/comments", "author": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a9a4c9b3dbfcd7c51b377985ccc2a030f93da9fb", "url": "https://api.github.com/repos/rust-lang/rust/commits/a9a4c9b3dbfcd7c51b377985ccc2a030f93da9fb", "html_url": "https://github.com/rust-lang/rust/commit/a9a4c9b3dbfcd7c51b377985ccc2a030f93da9fb"}, {"sha": "8dac074087afc9f02a794027bede787bb9367ad3", "url": "https://api.github.com/repos/rust-lang/rust/commits/8dac074087afc9f02a794027bede787bb9367ad3", "html_url": "https://github.com/rust-lang/rust/commit/8dac074087afc9f02a794027bede787bb9367ad3"}], "stats": {"total": 210, "additions": 144, "deletions": 66}, "files": [{"sha": "6be20b0974ddb6c74e74650401b72dc2da8bf533", "filename": "compiler/rustc_borrowck/src/borrow_set.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b84ab57f90a83e03bb0ac5d6ed13ec3f7e3edb94/compiler%2Frustc_borrowck%2Fsrc%2Fborrow_set.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b84ab57f90a83e03bb0ac5d6ed13ec3f7e3edb94/compiler%2Frustc_borrowck%2Fsrc%2Fborrow_set.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_borrowck%2Fsrc%2Fborrow_set.rs?ref=b84ab57f90a83e03bb0ac5d6ed13ec3f7e3edb94", "patch": "@@ -30,7 +30,7 @@ pub struct BorrowSet<'tcx> {\n     /// Map from local to all the borrows on that local.\n     pub local_map: FxIndexMap<mir::Local, FxIndexSet<BorrowIndex>>,\n \n-    pub(crate) locals_state_at_exit: LocalsStateAtExit,\n+    pub locals_state_at_exit: LocalsStateAtExit,\n }\n \n impl<'tcx> Index<BorrowIndex> for BorrowSet<'tcx> {\n@@ -153,7 +153,7 @@ impl<'tcx> BorrowSet<'tcx> {\n         self.activation_map.get(&location).map_or(&[], |activations| &activations[..])\n     }\n \n-    pub(crate) fn len(&self) -> usize {\n+    pub fn len(&self) -> usize {\n         self.location_map.len()\n     }\n "}, {"sha": "dc20b371d92e028337fb566364d9f5b918ded1e1", "filename": "compiler/rustc_borrowck/src/consumers.rs", "status": "modified", "additions": 86, "deletions": 9, "changes": 95, "blob_url": "https://github.com/rust-lang/rust/blob/b84ab57f90a83e03bb0ac5d6ed13ec3f7e3edb94/compiler%2Frustc_borrowck%2Fsrc%2Fconsumers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b84ab57f90a83e03bb0ac5d6ed13ec3f7e3edb94/compiler%2Frustc_borrowck%2Fsrc%2Fconsumers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_borrowck%2Fsrc%2Fconsumers.rs?ref=b84ab57f90a83e03bb0ac5d6ed13ec3f7e3edb94", "patch": "@@ -3,22 +3,95 @@\n //! This file provides API for compiler consumers.\n \n use rustc_hir::def_id::LocalDefId;\n-use rustc_index::IndexSlice;\n+use rustc_index::{IndexSlice, IndexVec};\n use rustc_infer::infer::{DefiningAnchor, TyCtxtInferExt};\n-use rustc_middle::mir::Body;\n+use rustc_middle::mir::{Body, Promoted};\n use rustc_middle::ty::TyCtxt;\n+use std::rc::Rc;\n+\n+use crate::borrow_set::BorrowSet;\n \n pub use super::{\n+    constraints::OutlivesConstraint,\n+    dataflow::{calculate_borrows_out_of_scope_at_location, BorrowIndex, Borrows},\n     facts::{AllFacts as PoloniusInput, RustcFacts},\n     location::{LocationTable, RichLocation},\n     nll::PoloniusOutput,\n-    BodyWithBorrowckFacts,\n+    place_ext::PlaceExt,\n+    places_conflict::{places_conflict, PlaceConflictBias},\n+    region_infer::RegionInferenceContext,\n };\n \n-/// This function computes Polonius facts for the given body. It makes a copy of\n-/// the body because it needs to regenerate the region identifiers. This function\n-/// should never be invoked during a typical compilation session due to performance\n-/// issues with Polonius.\n+/// Options determining the output behavior of [`get_body_with_borrowck_facts`].\n+///\n+/// If executing under `-Z polonius` the choice here has no effect, and everything as if\n+/// [`PoloniusOutputFacts`](ConsumerOptions::PoloniusOutputFacts) had been selected\n+/// will be retrieved.\n+#[derive(Debug, Copy, Clone)]\n+pub enum ConsumerOptions {\n+    /// Retrieve the [`Body`] along with the [`BorrowSet`](super::borrow_set::BorrowSet)\n+    /// and [`RegionInferenceContext`]. If you would like the body only, use\n+    /// [`TyCtxt::mir_promoted`].\n+    ///\n+    /// These can be used in conjunction with [`calculate_borrows_out_of_scope_at_location`].\n+    RegionInferenceContext,\n+    /// The recommended option. Retrieves the maximal amount of information\n+    /// without significant slowdowns.\n+    ///\n+    /// Implies [`RegionInferenceContext`](ConsumerOptions::RegionInferenceContext),\n+    /// and additionally retrieve the [`LocationTable`] and [`PoloniusInput`] that\n+    /// would be given to Polonius. Critically, this does not run Polonius, which\n+    /// one may want to avoid due to performance issues on large bodies.\n+    PoloniusInputFacts,\n+    /// Implies [`PoloniusInputFacts`](ConsumerOptions::PoloniusInputFacts),\n+    /// and additionally runs Polonius to calculate the [`PoloniusOutput`].\n+    PoloniusOutputFacts,\n+}\n+\n+impl ConsumerOptions {\n+    /// Should the Polonius input facts be computed?\n+    pub(crate) fn polonius_input(&self) -> bool {\n+        matches!(self, Self::PoloniusInputFacts | Self::PoloniusOutputFacts)\n+    }\n+    /// Should we run Polonius and collect the output facts?\n+    pub(crate) fn polonius_output(&self) -> bool {\n+        matches!(self, Self::PoloniusOutputFacts)\n+    }\n+}\n+\n+/// A `Body` with information computed by the borrow checker. This struct is\n+/// intended to be consumed by compiler consumers.\n+///\n+/// We need to include the MIR body here because the region identifiers must\n+/// match the ones in the Polonius facts.\n+pub struct BodyWithBorrowckFacts<'tcx> {\n+    /// A mir body that contains region identifiers.\n+    pub body: Body<'tcx>,\n+    /// The mir bodies of promoteds.\n+    pub promoted: IndexVec<Promoted, Body<'tcx>>,\n+    /// The set of borrows occurring in `body` with data about them.\n+    pub borrow_set: Rc<BorrowSet<'tcx>>,\n+    /// Context generated during borrowck, intended to be passed to\n+    /// [`calculate_borrows_out_of_scope_at_location`].\n+    pub region_inference_context: Rc<RegionInferenceContext<'tcx>>,\n+    /// The table that maps Polonius points to locations in the table.\n+    /// Populated when using [`ConsumerOptions::PoloniusInputFacts`]\n+    /// or [`ConsumerOptions::PoloniusOutputFacts`].\n+    pub location_table: Option<LocationTable>,\n+    /// Polonius input facts.\n+    /// Populated when using [`ConsumerOptions::PoloniusInputFacts`]\n+    /// or [`ConsumerOptions::PoloniusOutputFacts`].\n+    pub input_facts: Option<Box<PoloniusInput>>,\n+    /// Polonius output facts. Populated when using\n+    /// [`ConsumerOptions::PoloniusOutputFacts`].\n+    pub output_facts: Option<Rc<PoloniusOutput>>,\n+}\n+\n+/// This function computes borrowck facts for the given body. The [`ConsumerOptions`]\n+/// determine which facts are returned. This function makes a copy of the body because\n+/// it needs to regenerate the region identifiers. It should never be invoked during a\n+/// typical compilation session due to the unnecessary overhead of returning\n+/// [`BodyWithBorrowckFacts`].\n ///\n /// Note:\n /// *   This function will panic if the required body was already stolen. This\n@@ -28,10 +101,14 @@ pub use super::{\n ///     that shows how to do this at `tests/run-make/obtain-borrowck/`.\n ///\n /// *   Polonius is highly unstable, so expect regular changes in its signature or other details.\n-pub fn get_body_with_borrowck_facts(tcx: TyCtxt<'_>, def: LocalDefId) -> BodyWithBorrowckFacts<'_> {\n+pub fn get_body_with_borrowck_facts(\n+    tcx: TyCtxt<'_>,\n+    def: LocalDefId,\n+    options: ConsumerOptions,\n+) -> BodyWithBorrowckFacts<'_> {\n     let (input_body, promoted) = tcx.mir_promoted(def);\n     let infcx = tcx.infer_ctxt().with_opaque_type_inference(DefiningAnchor::Bind(def)).build();\n     let input_body: &Body<'_> = &input_body.borrow();\n     let promoted: &IndexSlice<_, _> = &promoted.borrow();\n-    *super::do_mir_borrowck(&infcx, input_body, promoted, true).1.unwrap()\n+    *super::do_mir_borrowck(&infcx, input_body, promoted, Some(options)).1.unwrap()\n }"}, {"sha": "4fe4d7085d78ae733c086e678b38f2f2d9532a68", "filename": "compiler/rustc_borrowck/src/dataflow.rs", "status": "modified", "additions": 20, "deletions": 15, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/b84ab57f90a83e03bb0ac5d6ed13ec3f7e3edb94/compiler%2Frustc_borrowck%2Fsrc%2Fdataflow.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b84ab57f90a83e03bb0ac5d6ed13ec3f7e3edb94/compiler%2Frustc_borrowck%2Fsrc%2Fdataflow.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_borrowck%2Fsrc%2Fdataflow.rs?ref=b84ab57f90a83e03bb0ac5d6ed13ec3f7e3edb94", "patch": "@@ -231,27 +231,32 @@ impl<'tcx> OutOfScopePrecomputer<'_, 'tcx> {\n     }\n }\n \n+pub fn calculate_borrows_out_of_scope_at_location<'tcx>(\n+    body: &Body<'tcx>,\n+    regioncx: &RegionInferenceContext<'tcx>,\n+    borrow_set: &BorrowSet<'tcx>,\n+) -> FxIndexMap<Location, Vec<BorrowIndex>> {\n+    let mut prec = OutOfScopePrecomputer::new(body, regioncx);\n+    for (borrow_index, borrow_data) in borrow_set.iter_enumerated() {\n+        let borrow_region = borrow_data.region;\n+        let location = borrow_data.reserve_location;\n+\n+        prec.precompute_borrows_out_of_scope(borrow_index, borrow_region, location);\n+    }\n+\n+    prec.borrows_out_of_scope_at_location\n+}\n+\n impl<'a, 'tcx> Borrows<'a, 'tcx> {\n-    pub(crate) fn new(\n+    pub fn new(\n         tcx: TyCtxt<'tcx>,\n         body: &'a Body<'tcx>,\n         nonlexical_regioncx: &'a RegionInferenceContext<'tcx>,\n         borrow_set: &'a BorrowSet<'tcx>,\n     ) -> Self {\n-        let mut prec = OutOfScopePrecomputer::new(body, nonlexical_regioncx);\n-        for (borrow_index, borrow_data) in borrow_set.iter_enumerated() {\n-            let borrow_region = borrow_data.region;\n-            let location = borrow_data.reserve_location;\n-\n-            prec.precompute_borrows_out_of_scope(borrow_index, borrow_region, location);\n-        }\n-\n-        Borrows {\n-            tcx,\n-            body,\n-            borrow_set,\n-            borrows_out_of_scope_at_location: prec.borrows_out_of_scope_at_location,\n-        }\n+        let borrows_out_of_scope_at_location =\n+            calculate_borrows_out_of_scope_at_location(body, nonlexical_regioncx, borrow_set);\n+        Borrows { tcx, body, borrow_set, borrows_out_of_scope_at_location }\n     }\n \n     pub fn location(&self, idx: BorrowIndex) -> &Location {"}, {"sha": "5124aa459b65058afcd19c2ae43c38c976cc6119", "filename": "compiler/rustc_borrowck/src/lib.rs", "status": "modified", "additions": 14, "deletions": 29, "changes": 43, "blob_url": "https://github.com/rust-lang/rust/blob/b84ab57f90a83e03bb0ac5d6ed13ec3f7e3edb94/compiler%2Frustc_borrowck%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b84ab57f90a83e03bb0ac5d6ed13ec3f7e3edb94/compiler%2Frustc_borrowck%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_borrowck%2Fsrc%2Flib.rs?ref=b84ab57f90a83e03bb0ac5d6ed13ec3f7e3edb94", "patch": "@@ -61,7 +61,7 @@ use crate::session_diagnostics::VarNeedNotMut;\n use self::diagnostics::{AccessKind, RegionName};\n use self::location::LocationTable;\n use self::prefixes::PrefixSet;\n-use facts::AllFacts;\n+use consumers::{BodyWithBorrowckFacts, ConsumerOptions};\n \n use self::path_utils::*;\n \n@@ -143,23 +143,23 @@ fn mir_borrowck(tcx: TyCtxt<'_>, def: LocalDefId) -> &BorrowCheckResult<'_> {\n         tcx.infer_ctxt().with_opaque_type_inference(DefiningAnchor::Bind(hir_owner.def_id)).build();\n     let input_body: &Body<'_> = &input_body.borrow();\n     let promoted: &IndexSlice<_, _> = &promoted.borrow();\n-    let opt_closure_req = do_mir_borrowck(&infcx, input_body, promoted, false).0;\n+    let opt_closure_req = do_mir_borrowck(&infcx, input_body, promoted, None).0;\n     debug!(\"mir_borrowck done\");\n \n     tcx.arena.alloc(opt_closure_req)\n }\n \n /// Perform the actual borrow checking.\n ///\n-/// If `return_body_with_facts` is true, then return the body with non-erased\n-/// region ids on which the borrow checking was performed together with Polonius\n-/// facts.\n+/// Use `consumer_options: None` for the default behavior of returning\n+/// [`BorrowCheckResult`] only. Otherwise, return [`BodyWithBorrowckFacts`] according\n+/// to the given [`ConsumerOptions`].\n #[instrument(skip(infcx, input_body, input_promoted), fields(id=?input_body.source.def_id()), level = \"debug\")]\n fn do_mir_borrowck<'tcx>(\n     infcx: &InferCtxt<'tcx>,\n     input_body: &Body<'tcx>,\n     input_promoted: &IndexSlice<Promoted, Body<'tcx>>,\n-    return_body_with_facts: bool,\n+    consumer_options: Option<ConsumerOptions>,\n ) -> (BorrowCheckResult<'tcx>, Option<Box<BodyWithBorrowckFacts<'tcx>>>) {\n     let def = input_body.source.def_id().expect_local();\n     debug!(?def);\n@@ -240,8 +240,6 @@ fn do_mir_borrowck<'tcx>(\n     let borrow_set =\n         Rc::new(BorrowSet::build(tcx, body, locals_are_invalidated_at_exit, &mdpe.move_data));\n \n-    let use_polonius = return_body_with_facts || infcx.tcx.sess.opts.unstable_opts.polonius;\n-\n     // Compute non-lexical lifetimes.\n     let nll::NllOutput {\n         regioncx,\n@@ -261,7 +259,7 @@ fn do_mir_borrowck<'tcx>(\n         &mdpe.move_data,\n         &borrow_set,\n         &upvars,\n-        use_polonius,\n+        consumer_options,\n     );\n \n     // Dump MIR results into a file, if that is enabled. This let us\n@@ -441,13 +439,16 @@ fn do_mir_borrowck<'tcx>(\n         tainted_by_errors,\n     };\n \n-    let body_with_facts = if return_body_with_facts {\n-        let output_facts = mbcx.polonius_output.expect(\"Polonius output was not computed\");\n+    let body_with_facts = if consumer_options.is_some() {\n+        let output_facts = mbcx.polonius_output;\n         Some(Box::new(BodyWithBorrowckFacts {\n             body: body_owned,\n-            input_facts: *polonius_input.expect(\"Polonius input facts were not generated\"),\n+            promoted,\n+            borrow_set,\n+            region_inference_context: regioncx,\n+            location_table: polonius_input.as_ref().map(|_| location_table_owned),\n+            input_facts: polonius_input,\n             output_facts,\n-            location_table: location_table_owned,\n         }))\n     } else {\n         None\n@@ -458,22 +459,6 @@ fn do_mir_borrowck<'tcx>(\n     (result, body_with_facts)\n }\n \n-/// A `Body` with information computed by the borrow checker. This struct is\n-/// intended to be consumed by compiler consumers.\n-///\n-/// We need to include the MIR body here because the region identifiers must\n-/// match the ones in the Polonius facts.\n-pub struct BodyWithBorrowckFacts<'tcx> {\n-    /// A mir body that contains region identifiers.\n-    pub body: Body<'tcx>,\n-    /// Polonius input facts.\n-    pub input_facts: AllFacts,\n-    /// Polonius output facts.\n-    pub output_facts: Rc<self::nll::PoloniusOutput>,\n-    /// The table that maps Polonius points to locations in the table.\n-    pub location_table: LocationTable,\n-}\n-\n pub struct BorrowckInferCtxt<'cx, 'tcx> {\n     pub(crate) infcx: &'cx InferCtxt<'tcx>,\n     pub(crate) reg_var_to_origin: RefCell<FxIndexMap<ty::RegionVid, RegionCtxt>>,"}, {"sha": "889acb3acbed7579183ead34a160356bab333fe1", "filename": "compiler/rustc_borrowck/src/nll.rs", "status": "modified", "additions": 9, "deletions": 4, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/b84ab57f90a83e03bb0ac5d6ed13ec3f7e3edb94/compiler%2Frustc_borrowck%2Fsrc%2Fnll.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b84ab57f90a83e03bb0ac5d6ed13ec3f7e3edb94/compiler%2Frustc_borrowck%2Fsrc%2Fnll.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_borrowck%2Fsrc%2Fnll.rs?ref=b84ab57f90a83e03bb0ac5d6ed13ec3f7e3edb94", "patch": "@@ -27,6 +27,7 @@ use rustc_mir_dataflow::ResultsCursor;\n use crate::{\n     borrow_set::BorrowSet,\n     constraint_generation,\n+    consumers::ConsumerOptions,\n     diagnostics::RegionErrors,\n     facts::{AllFacts, AllFactsExt, RustcFacts},\n     invalidation,\n@@ -165,10 +166,14 @@ pub(crate) fn compute_regions<'cx, 'tcx>(\n     move_data: &MoveData<'tcx>,\n     borrow_set: &BorrowSet<'tcx>,\n     upvars: &[Upvar<'tcx>],\n-    use_polonius: bool,\n+    consumer_options: Option<ConsumerOptions>,\n ) -> NllOutput<'tcx> {\n+    let polonius_input = consumer_options.map(|c| c.polonius_input()).unwrap_or_default()\n+        || infcx.tcx.sess.opts.unstable_opts.polonius;\n+    let polonius_output = consumer_options.map(|c| c.polonius_output()).unwrap_or_default()\n+        || infcx.tcx.sess.opts.unstable_opts.polonius;\n     let mut all_facts =\n-        (use_polonius || AllFacts::enabled(infcx.tcx)).then_some(AllFacts::default());\n+        (polonius_input || AllFacts::enabled(infcx.tcx)).then_some(AllFacts::default());\n \n     let universal_regions = Rc::new(universal_regions);\n \n@@ -189,7 +194,7 @@ pub(crate) fn compute_regions<'cx, 'tcx>(\n             move_data,\n             elements,\n             upvars,\n-            use_polonius,\n+            polonius_input,\n         );\n \n     if let Some(all_facts) = &mut all_facts {\n@@ -284,7 +289,7 @@ pub(crate) fn compute_regions<'cx, 'tcx>(\n             all_facts.write_to_dir(dir_path, location_table).unwrap();\n         }\n \n-        if use_polonius {\n+        if polonius_output {\n             let algorithm =\n                 env::var(\"POLONIUS_ALGORITHM\").unwrap_or_else(|_| String::from(\"Hybrid\"));\n             let algorithm = Algorithm::from_str(&algorithm).unwrap();"}, {"sha": "d521d0db21323df8526d25c5309cf5302f122dc3", "filename": "compiler/rustc_borrowck/src/place_ext.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b84ab57f90a83e03bb0ac5d6ed13ec3f7e3edb94/compiler%2Frustc_borrowck%2Fsrc%2Fplace_ext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b84ab57f90a83e03bb0ac5d6ed13ec3f7e3edb94/compiler%2Frustc_borrowck%2Fsrc%2Fplace_ext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_borrowck%2Fsrc%2Fplace_ext.rs?ref=b84ab57f90a83e03bb0ac5d6ed13ec3f7e3edb94", "patch": "@@ -7,7 +7,7 @@ use rustc_middle::mir::{Body, Mutability, Place};\n use rustc_middle::ty::{self, TyCtxt};\n \n /// Extension methods for the `Place` type.\n-pub(crate) trait PlaceExt<'tcx> {\n+pub trait PlaceExt<'tcx> {\n     /// Returns `true` if we can safely ignore borrows of this place.\n     /// This is true whenever there is no action that the user can do\n     /// to the place `self` that would invalidate the borrow. This is true"}, {"sha": "25c485b814f4a1ae1220bce79757c8d2e5dab821", "filename": "compiler/rustc_borrowck/src/places_conflict.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/b84ab57f90a83e03bb0ac5d6ed13ec3f7e3edb94/compiler%2Frustc_borrowck%2Fsrc%2Fplaces_conflict.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b84ab57f90a83e03bb0ac5d6ed13ec3f7e3edb94/compiler%2Frustc_borrowck%2Fsrc%2Fplaces_conflict.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_borrowck%2Fsrc%2Fplaces_conflict.rs?ref=b84ab57f90a83e03bb0ac5d6ed13ec3f7e3edb94", "patch": "@@ -16,15 +16,15 @@ use std::iter;\n /// being run in the calling context, the conservative choice is to assume the compared indices\n /// are disjoint (and therefore, do not overlap).\n #[derive(Copy, Clone, Debug, Eq, PartialEq)]\n-pub(crate) enum PlaceConflictBias {\n+pub enum PlaceConflictBias {\n     Overlap,\n     NoOverlap,\n }\n \n /// Helper function for checking if places conflict with a mutable borrow and deep access depth.\n /// This is used to check for places conflicting outside of the borrow checking code (such as in\n /// dataflow).\n-pub(crate) fn places_conflict<'tcx>(\n+pub fn places_conflict<'tcx>(\n     tcx: TyCtxt<'tcx>,\n     body: &Body<'tcx>,\n     borrow_place: Place<'tcx>,"}, {"sha": "9bb46a50d3cf406f3f38a652abb97233111b47d4", "filename": "compiler/rustc_borrowck/src/region_infer/mod.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/b84ab57f90a83e03bb0ac5d6ed13ec3f7e3edb94/compiler%2Frustc_borrowck%2Fsrc%2Fregion_infer%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b84ab57f90a83e03bb0ac5d6ed13ec3f7e3edb94/compiler%2Frustc_borrowck%2Fsrc%2Fregion_infer%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_borrowck%2Fsrc%2Fregion_infer%2Fmod.rs?ref=b84ab57f90a83e03bb0ac5d6ed13ec3f7e3edb94", "patch": "@@ -585,6 +585,11 @@ impl<'tcx> RegionInferenceContext<'tcx> {\n         self.universal_regions.to_region_vid(r)\n     }\n \n+    /// Returns an iterator over all the outlives constraints.\n+    pub fn outlives_constraints(&self) -> impl Iterator<Item = OutlivesConstraint<'tcx>> + '_ {\n+        self.constraints.outlives().iter().copied()\n+    }\n+\n     /// Adds annotations for `#[rustc_regions]`; see `UniversalRegions::annotate`.\n     pub(crate) fn annotate(&self, tcx: TyCtxt<'tcx>, err: &mut Diagnostic) {\n         self.universal_regions.annotate(tcx, err)\n@@ -698,7 +703,7 @@ impl<'tcx> RegionInferenceContext<'tcx> {\n     #[instrument(skip(self, _body), level = \"debug\")]\n     fn propagate_constraints(&mut self, _body: &Body<'tcx>) {\n         debug!(\"constraints={:#?}\", {\n-            let mut constraints: Vec<_> = self.constraints.outlives().iter().collect();\n+            let mut constraints: Vec<_> = self.outlives_constraints().collect();\n             constraints.sort_by_key(|c| (c.sup, c.sub));\n             constraints\n                 .into_iter()"}, {"sha": "b59a65a713f953c8d1b60788500c43079a565c92", "filename": "tests/run-make-fulldeps/obtain-borrowck/driver.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/b84ab57f90a83e03bb0ac5d6ed13ec3f7e3edb94/tests%2Frun-make-fulldeps%2Fobtain-borrowck%2Fdriver.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b84ab57f90a83e03bb0ac5d6ed13ec3f7e3edb94/tests%2Frun-make-fulldeps%2Fobtain-borrowck%2Fdriver.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Frun-make-fulldeps%2Fobtain-borrowck%2Fdriver.rs?ref=b84ab57f90a83e03bb0ac5d6ed13ec3f7e3edb94", "patch": "@@ -18,7 +18,7 @@ extern crate rustc_interface;\n extern crate rustc_middle;\n extern crate rustc_session;\n \n-use rustc_borrowck::consumers::BodyWithBorrowckFacts;\n+use rustc_borrowck::consumers::{self, BodyWithBorrowckFacts, ConsumerOptions};\n use rustc_driver::Compilation;\n use rustc_hir::def::DefKind;\n use rustc_hir::def_id::LocalDefId;\n@@ -102,7 +102,7 @@ impl rustc_driver::Callbacks for CompilerCalls {\n             println!(\"Bodies retrieved for:\");\n             for (def_id, body) in bodies {\n                 println!(\"{}\", def_id);\n-                assert!(body.input_facts.cfg_edge.len() > 0);\n+                assert!(body.input_facts.unwrap().cfg_edge.len() > 0);\n             }\n         });\n \n@@ -127,7 +127,8 @@ thread_local! {\n }\n \n fn mir_borrowck<'tcx>(tcx: TyCtxt<'tcx>, def_id: LocalDefId) -> ProvidedValue<'tcx> {\n-    let body_with_facts = rustc_borrowck::consumers::get_body_with_borrowck_facts(tcx, def_id);\n+    let opts = ConsumerOptions::PoloniusInputFacts;\n+    let body_with_facts = consumers::get_body_with_borrowck_facts(tcx, def_id, opts);\n     // SAFETY: The reader casts the 'static lifetime to 'tcx before using it.\n     let body_with_facts: BodyWithBorrowckFacts<'static> =\n         unsafe { std::mem::transmute(body_with_facts) };"}]}