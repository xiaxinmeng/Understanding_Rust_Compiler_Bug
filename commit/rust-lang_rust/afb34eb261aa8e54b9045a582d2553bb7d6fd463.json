{"sha": "afb34eb261aa8e54b9045a582d2553bb7d6fd463", "node_id": "C_kwDOAAsO6NoAKGFmYjM0ZWIyNjFhYThlNTRiOTA0NWE1ODJkMjU1M2JiN2Q2ZmQ0NjM", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-07-06T21:26:46Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-07-06T21:26:46Z"}, "message": "Auto merge of #9096 - Jarcho:needless_borrow_subs, r=Manishearth\n\nFix `needless_borrow` 9095\n\nfixes #9095\nchangelog: Don't lint `needless_borrow` on method receivers when it would change which trait impl is called", "tree": {"sha": "1ad16265c543c740c1f369dfe315ed46a649972a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1ad16265c543c740c1f369dfe315ed46a649972a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/afb34eb261aa8e54b9045a582d2553bb7d6fd463", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/afb34eb261aa8e54b9045a582d2553bb7d6fd463", "html_url": "https://github.com/rust-lang/rust/commit/afb34eb261aa8e54b9045a582d2553bb7d6fd463", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/afb34eb261aa8e54b9045a582d2553bb7d6fd463/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f93d418f1789a5782053e99038db7d6701c8a30c", "url": "https://api.github.com/repos/rust-lang/rust/commits/f93d418f1789a5782053e99038db7d6701c8a30c", "html_url": "https://github.com/rust-lang/rust/commit/f93d418f1789a5782053e99038db7d6701c8a30c"}, {"sha": "988b813649c147383bcce125c9afbb0adc681110", "url": "https://api.github.com/repos/rust-lang/rust/commits/988b813649c147383bcce125c9afbb0adc681110", "html_url": "https://github.com/rust-lang/rust/commit/988b813649c147383bcce125c9afbb0adc681110"}], "stats": {"total": 35, "additions": 32, "deletions": 3}, "files": [{"sha": "6dddb969f33400fdaec0a43f13c8bd6973b1decd", "filename": "clippy_lints/src/dereference.rs", "status": "modified", "additions": 8, "deletions": 3, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/afb34eb261aa8e54b9045a582d2553bb7d6fd463/clippy_lints%2Fsrc%2Fdereference.rs", "raw_url": "https://github.com/rust-lang/rust/raw/afb34eb261aa8e54b9045a582d2553bb7d6fd463/clippy_lints%2Fsrc%2Fdereference.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fdereference.rs?ref=afb34eb261aa8e54b9045a582d2553bb7d6fd463", "patch": "@@ -772,9 +772,14 @@ fn walk_parents<'tcx>(cx: &LateContext<'tcx>, e: &'tcx Expr<'_>) -> (Position, &\n                             } else if let Some(trait_id) = cx.tcx.trait_of_item(id)\n                                 && let arg_ty = cx.tcx.erase_regions(cx.typeck_results().expr_ty_adjusted(e))\n                                 && let ty::Ref(_, sub_ty, _) = *arg_ty.kind()\n-                                && let subs = cx.typeck_results().node_substs_opt(child_id).unwrap_or_else(\n-                                    || cx.tcx.mk_substs([].iter())\n-                                ) && let impl_ty = if cx.tcx.fn_sig(id).skip_binder().inputs()[0].is_ref() {\n+                                && let subs = match cx\n+                                    .typeck_results()\n+                                    .node_substs_opt(parent.hir_id)\n+                                    .and_then(|subs| subs.get(1..))\n+                                {\n+                                    Some(subs) => cx.tcx.mk_substs(subs.iter().copied()),\n+                                    None => cx.tcx.mk_substs([].iter()),\n+                                } && let impl_ty = if cx.tcx.fn_sig(id).skip_binder().inputs()[0].is_ref() {\n                                     // Trait methods taking `&self`\n                                     sub_ty\n                                 } else {"}, {"sha": "09afe2ddbbf6289e21d64cb36e1dea36053b51a0", "filename": "tests/ui/needless_borrow.fixed", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/afb34eb261aa8e54b9045a582d2553bb7d6fd463/tests%2Fui%2Fneedless_borrow.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/afb34eb261aa8e54b9045a582d2553bb7d6fd463/tests%2Fui%2Fneedless_borrow.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fneedless_borrow.fixed?ref=afb34eb261aa8e54b9045a582d2553bb7d6fd463", "patch": "@@ -115,6 +115,18 @@ fn main() {\n         fn foo_ref(&self) {}\n     }\n     (&&()).foo_ref(); // Don't lint. `&()` will call `<() as FooRef>::foo_ref`\n+\n+    struct S;\n+    impl From<S> for u32 {\n+        fn from(s: S) -> Self {\n+            (&s).into()\n+        }\n+    }\n+    impl From<&S> for u32 {\n+        fn from(s: &S) -> Self {\n+            0\n+        }\n+    }\n }\n \n #[allow(clippy::needless_borrowed_reference)]"}, {"sha": "3ae4722a1f8985e414ea3a9d49f85ccb397bf770", "filename": "tests/ui/needless_borrow.rs", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/afb34eb261aa8e54b9045a582d2553bb7d6fd463/tests%2Fui%2Fneedless_borrow.rs", "raw_url": "https://github.com/rust-lang/rust/raw/afb34eb261aa8e54b9045a582d2553bb7d6fd463/tests%2Fui%2Fneedless_borrow.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fneedless_borrow.rs?ref=afb34eb261aa8e54b9045a582d2553bb7d6fd463", "patch": "@@ -115,6 +115,18 @@ fn main() {\n         fn foo_ref(&self) {}\n     }\n     (&&()).foo_ref(); // Don't lint. `&()` will call `<() as FooRef>::foo_ref`\n+\n+    struct S;\n+    impl From<S> for u32 {\n+        fn from(s: S) -> Self {\n+            (&s).into()\n+        }\n+    }\n+    impl From<&S> for u32 {\n+        fn from(s: &S) -> Self {\n+            0\n+        }\n+    }\n }\n \n #[allow(clippy::needless_borrowed_reference)]"}]}