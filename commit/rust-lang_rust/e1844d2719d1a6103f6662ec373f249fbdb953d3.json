{"sha": "e1844d2719d1a6103f6662ec373f249fbdb953d3", "node_id": "MDY6Q29tbWl0NzI0NzEyOmUxODQ0ZDI3MTlkMWE2MTAzZjY2NjJlYzM3M2YyNDlmYmRiOTUzZDM=", "commit": {"author": {"name": "Tim Chevalier", "email": "chevalier@alum.wellesley.edu", "date": "2011-05-19T01:01:53Z"}, "committer": {"name": "Graydon Hoare", "email": "graydon@mozilla.com", "date": "2011-05-19T18:40:16Z"}, "message": "Add ann as an argument to visit_fn", "tree": {"sha": "feb357935513ffd79b003b6c3f4613ed88603b94", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/feb357935513ffd79b003b6c3f4613ed88603b94"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e1844d2719d1a6103f6662ec373f249fbdb953d3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e1844d2719d1a6103f6662ec373f249fbdb953d3", "html_url": "https://github.com/rust-lang/rust/commit/e1844d2719d1a6103f6662ec373f249fbdb953d3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e1844d2719d1a6103f6662ec373f249fbdb953d3/comments", "author": {"login": "catamorphism", "id": 427212, "node_id": "MDQ6VXNlcjQyNzIxMg==", "avatar_url": "https://avatars.githubusercontent.com/u/427212?v=4", "gravatar_id": "", "url": "https://api.github.com/users/catamorphism", "html_url": "https://github.com/catamorphism", "followers_url": "https://api.github.com/users/catamorphism/followers", "following_url": "https://api.github.com/users/catamorphism/following{/other_user}", "gists_url": "https://api.github.com/users/catamorphism/gists{/gist_id}", "starred_url": "https://api.github.com/users/catamorphism/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/catamorphism/subscriptions", "organizations_url": "https://api.github.com/users/catamorphism/orgs", "repos_url": "https://api.github.com/users/catamorphism/repos", "events_url": "https://api.github.com/users/catamorphism/events{/privacy}", "received_events_url": "https://api.github.com/users/catamorphism/received_events", "type": "User", "site_admin": false}, "committer": {"login": "graydon", "id": 14097, "node_id": "MDQ6VXNlcjE0MDk3", "avatar_url": "https://avatars.githubusercontent.com/u/14097?v=4", "gravatar_id": "", "url": "https://api.github.com/users/graydon", "html_url": "https://github.com/graydon", "followers_url": "https://api.github.com/users/graydon/followers", "following_url": "https://api.github.com/users/graydon/following{/other_user}", "gists_url": "https://api.github.com/users/graydon/gists{/gist_id}", "starred_url": "https://api.github.com/users/graydon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/graydon/subscriptions", "organizations_url": "https://api.github.com/users/graydon/orgs", "repos_url": "https://api.github.com/users/graydon/repos", "events_url": "https://api.github.com/users/graydon/events{/privacy}", "received_events_url": "https://api.github.com/users/graydon/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6dcd6072775f1b615e6844fe9a2fce246fc9cf70", "url": "https://api.github.com/repos/rust-lang/rust/commits/6dcd6072775f1b615e6844fe9a2fce246fc9cf70", "html_url": "https://github.com/rust-lang/rust/commit/6dcd6072775f1b615e6844fe9a2fce246fc9cf70"}], "stats": {"total": 56, "additions": 30, "deletions": 26}, "files": [{"sha": "743f525401d116ee575e3d9ea28001d2812eed22", "filename": "src/comp/middle/tstate/annotate.rs", "status": "modified", "additions": 8, "deletions": 7, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/e1844d2719d1a6103f6662ec373f249fbdb953d3/src%2Fcomp%2Fmiddle%2Ftstate%2Fannotate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e1844d2719d1a6103f6662ec373f249fbdb953d3/src%2Fcomp%2Fmiddle%2Ftstate%2Fannotate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomp%2Fmiddle%2Ftstate%2Fannotate.rs?ref=e1844d2719d1a6103f6662ec373f249fbdb953d3", "patch": "@@ -127,14 +127,14 @@ fn collect_ids_decl(&@decl d, @vec[uint] res) -> () {\n     }\n }\n \n-fn node_ids_in_fn(&_fn f, &ident i, &def_id d, @vec[uint] res) -> () {\n+fn node_ids_in_fn(&_fn f, &ident i, &def_id d, &ann a, @vec[uint] res) -> () {\n     auto collect_ids = walk::default_visitor();\n     collect_ids = rec(visit_expr_pre  = bind collect_ids_expr(_,res),\n                       visit_block_pre = bind collect_ids_block(_,res),\n                       visit_stmt_pre  = bind collect_ids_stmt(_,res),\n                       visit_decl_pre  = bind collect_ids_decl(_,res)\n                       with collect_ids);\n-    walk::walk_fn(collect_ids, f, i, d);\n+    walk::walk_fn(collect_ids, f, i, d, a);\n }\n \n fn init_vecs(&crate_ctxt ccx, @vec[uint] node_ids, uint len) -> () {\n@@ -145,21 +145,22 @@ fn init_vecs(&crate_ctxt ccx, @vec[uint] node_ids, uint len) -> () {\n }\n \n fn visit_fn(&crate_ctxt ccx, uint num_locals, &_fn f, &ident i,\n-            &def_id d) -> () {\n+            &def_id d, &ann a) -> () {\n     let vec[uint] node_ids_ = [];\n     let @vec[uint] node_ids = @node_ids_;\n-    node_ids_in_fn(f, i, d, node_ids);\n+    node_ids_in_fn(f, i, d, a, node_ids);\n     init_vecs(ccx, node_ids, num_locals);\n }\n \n-fn annotate_in_fn(&crate_ctxt ccx, &_fn f, &ident i, &def_id f_id) -> () {\n+fn annotate_in_fn(&crate_ctxt ccx, &_fn f, &ident i, &def_id f_id, &ann a)\n+    -> () {\n     auto f_info = get_fn_info(ccx, f_id);\n-    visit_fn(ccx, num_locals(f_info), f, i, f_id);\n+    visit_fn(ccx, num_locals(f_info), f, i, f_id, a);\n }\n \n fn annotate_crate(&crate_ctxt ccx, &crate crate) -> () {\n     auto do_ann = walk::default_visitor();\n-    do_ann = rec(visit_fn_pre = bind annotate_in_fn(ccx, _, _, _)\n+    do_ann = rec(visit_fn_pre = bind annotate_in_fn(ccx,_,_,_,_)\n                  with do_ann);\n     walk::walk_crate(do_ann, crate);\n }"}, {"sha": "83931ecbc553e0d999fa99435ad9418b22f0630a", "filename": "src/comp/middle/tstate/collect_locals.rs", "status": "modified", "additions": 7, "deletions": 5, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/e1844d2719d1a6103f6662ec373f249fbdb953d3/src%2Fcomp%2Fmiddle%2Ftstate%2Fcollect_locals.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e1844d2719d1a6103f6662ec373f249fbdb953d3/src%2Fcomp%2Fmiddle%2Ftstate%2Fcollect_locals.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomp%2Fmiddle%2Ftstate%2Fcollect_locals.rs?ref=e1844d2719d1a6103f6662ec373f249fbdb953d3", "patch": "@@ -45,11 +45,12 @@ fn collect_local(&@vec[tup(ident, def_id)] vars, &@decl d) -> () {\n     }\n }\n \n-fn find_locals(&_fn f, &ident i, &def_id d) -> @vec[tup(ident,def_id)] {\n+fn find_locals(&_fn f, &ident i, &def_id d, &ann a)\n+    -> @vec[tup(ident,def_id)] {\n   auto res = @vec::alloc[tup(ident,def_id)](0u);\n   auto visitor = walk::default_visitor();\n   visitor = rec(visit_decl_pre=bind collect_local(res,_) with visitor);\n-  walk_fn(visitor, f, i, d);\n+  walk_fn(visitor, f, i, d, a);\n   ret res;\n }\n \n@@ -62,7 +63,8 @@ fn add_var(def_id v, ident nm, uint next, fn_info tbl) -> uint {\n \n /* builds a table mapping each local var defined in f\n    to a bit number in the precondition/postcondition vectors */\n-fn mk_fn_info(&crate_ctxt ccx, &_fn f, &ident f_name, &def_id f_id) -> () {\n+fn mk_fn_info(&crate_ctxt ccx, &_fn f, &ident f_name, &def_id f_id, &ann a)\n+    -> () {\n     auto res = rec(vars=@new_def_hash[var_info](),\n                    cf=f.decl.cf);\n     let uint next = 0u;\n@@ -71,7 +73,7 @@ fn mk_fn_info(&crate_ctxt ccx, &_fn f, &ident f_name, &def_id f_id) -> () {\n     /* ignore args, which we know are initialized;\n        just collect locally declared vars */\n \n-    let @vec[tup(ident,def_id)] locals = find_locals(f, f_name, f_id);\n+    let @vec[tup(ident,def_id)] locals = find_locals(f, f_name, f_id, a);\n     for (tup(ident,def_id) p in *locals) {\n         next = add_var(p._1, p._0, next, res);\n     }\n@@ -90,7 +92,7 @@ fn mk_fn_info(&crate_ctxt ccx, &_fn f, &ident f_name, &def_id f_id) -> () {\n    to bit number) */\n fn mk_f_to_fn_info(&crate_ctxt ccx, @crate c) -> () {\n   let ast_visitor vars_visitor = walk::default_visitor();\n-  vars_visitor = rec(visit_fn_pre=bind mk_fn_info(ccx,_,_,_)\n+  vars_visitor = rec(visit_fn_pre=bind mk_fn_info(ccx,_,_,_,_)\n                      with vars_visitor);\n \n   walk_crate(vars_visitor, *c);"}, {"sha": "1752fcaf2b13ceb66e6379d15d9bb5def9eacf83", "filename": "src/comp/middle/tstate/pre_post_conditions.rs", "status": "modified", "additions": 1, "deletions": 4, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/e1844d2719d1a6103f6662ec373f249fbdb953d3/src%2Fcomp%2Fmiddle%2Ftstate%2Fpre_post_conditions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e1844d2719d1a6103f6662ec373f249fbdb953d3/src%2Fcomp%2Fmiddle%2Ftstate%2Fpre_post_conditions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomp%2Fmiddle%2Ftstate%2Fpre_post_conditions.rs?ref=e1844d2719d1a6103f6662ec373f249fbdb953d3", "patch": "@@ -138,9 +138,6 @@ import front::ast::stmt_expr;\n import front::ast::block;\n import front::ast::block_;\n \n-import middle::fold::span;\n-import middle::fold::respan;\n-\n import util::common::new_def_hash;\n import util::common::decl_lhs;\n import util::common::uistr;\n@@ -679,7 +676,7 @@ fn find_pre_post_fn(&fn_ctxt fcx, &_fn f) -> () {\n     find_pre_post_block(fcx, f.body);\n }\n \n-fn fn_pre_post(crate_ctxt ccx, &_fn f, &ident i, &def_id id) -> () {\n+fn fn_pre_post(crate_ctxt ccx, &_fn f, &ident i, &def_id id, &ann a) -> () {\n     assert (ccx.fm.contains_key(id));\n     auto fcx = rec(enclosing=ccx.fm.get(id),\n                    id=id, name=i, ccx=ccx);"}, {"sha": "5c0c5b3667f9c726796d5b6d614c36ea8c62d74c", "filename": "src/comp/middle/walk.rs", "status": "modified", "additions": 14, "deletions": 10, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/e1844d2719d1a6103f6662ec373f249fbdb953d3/src%2Fcomp%2Fmiddle%2Fwalk.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e1844d2719d1a6103f6662ec373f249fbdb953d3/src%2Fcomp%2Fmiddle%2Fwalk.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fcomp%2Fmiddle%2Fwalk.rs?ref=e1844d2719d1a6103f6662ec373f249fbdb953d3", "patch": "@@ -32,8 +32,10 @@ type ast_visitor =\n         fn (&@ast::expr e)              visit_expr_post,\n         fn (&@ast::ty t)                visit_ty_pre,\n         fn (&@ast::ty t)                visit_ty_post,\n-        fn (&ast::_fn f, &ast::ident name, &ast::def_id d_id) visit_fn_pre,\n-        fn (&ast::_fn f, &ast::ident name, &ast::def_id d_id)  visit_fn_post);\n+        fn (&ast::_fn f, &ast::ident name, \n+            &ast::def_id d_id, &ast::ann a)  visit_fn_pre,\n+        fn (&ast::_fn f, &ast::ident name,\n+            &ast::def_id d_id, &ast::ann a)  visit_fn_post);\n \n fn walk_crate(&ast_visitor v, &ast::crate c) {\n     if (!v.keep_going()) { ret; }\n@@ -93,8 +95,8 @@ fn walk_item(&ast_visitor v, @ast::item i) {\n             walk_ty(v, t);\n             walk_expr(v, e);\n         }\n-        case (ast::item_fn(?i, ?f, _, ?d, _)) {\n-            walk_fn(v, f, i, d);\n+        case (ast::item_fn(?i, ?f, _, ?d, ?a)) {\n+            walk_fn(v, f, i, d, a);\n         }\n         case (ast::item_mod(_, ?m, _)) {\n             walk_mod(v, m);\n@@ -118,13 +120,14 @@ fn walk_item(&ast_visitor v, @ast::item i) {\n             }\n             for (@ast::method m in ob.methods) {\n                 v.visit_method_pre(m);\n-                walk_fn(v, m.node.meth, m.node.ident, m.node.id);\n+                walk_fn(v, m.node.meth, m.node.ident, m.node.id, m.node.ann);\n                 v.visit_method_post(m);\n             }\n             alt (ob.dtor) {\n                 case (none[@ast::method]) {}\n                 case (some[@ast::method](?m)) {\n-                    walk_fn(v, m.node.meth, m.node.ident, m.node.id);\n+                    walk_fn(v, m.node.meth, m.node.ident, m.node.id,\n+                            m.node.ann);\n                 }\n             }\n         }\n@@ -229,12 +232,13 @@ fn walk_fn_decl(&ast_visitor v, &ast::fn_decl fd) {\n     walk_ty(v, fd.output);\n }\n \n-fn walk_fn(&ast_visitor v, &ast::_fn f, &ast::ident i, &ast::def_id d) {\n+fn walk_fn(&ast_visitor v, &ast::_fn f, &ast::ident i, &ast::def_id d,\n+           &ast::ann a) {\n     if (!v.keep_going()) { ret; }\n-    v.visit_fn_pre(f, i, d);\n+    v.visit_fn_pre(f, i, d, a);\n     walk_fn_decl(v, f.decl);\n     walk_block(v, f.body);\n-    v.visit_fn_post(f, i, d);\n+    v.visit_fn_post(f, i, d, a);\n }\n \n fn walk_block(&ast_visitor v, &ast::block b) {\n@@ -459,7 +463,7 @@ fn def_visit_arm(&ast::arm a) { }\n fn def_visit_decl(&@ast::decl d) { }\n fn def_visit_expr(&@ast::expr e) { }\n fn def_visit_ty(&@ast::ty t) { }\n-fn def_visit_fn(&ast::_fn f, &ast::ident i, &ast::def_id d) { }\n+fn def_visit_fn(&ast::_fn f, &ast::ident i, &ast::def_id d, &ast::ann a) { }\n \n fn default_visitor() -> ast_visitor {\n "}]}