{"sha": "d61c7fc7470ba572624f14af46f519e24322112d", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ2MWM3ZmM3NDcwYmE1NzI2MjRmMTRhZjQ2ZjUxOWUyNDMyMjExMmQ=", "commit": {"author": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2016-12-19T11:35:45Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2016-12-19T11:35:45Z"}, "message": "Merge pull request #1355 from philipturnbull/deref-addrof\n\nLint usage of `*&` and `*&mut`", "tree": {"sha": "ec206f1df8f0bad932bdfbb7100ec1c6decdf925", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ec206f1df8f0bad932bdfbb7100ec1c6decdf925"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d61c7fc7470ba572624f14af46f519e24322112d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d61c7fc7470ba572624f14af46f519e24322112d", "html_url": "https://github.com/rust-lang/rust/commit/d61c7fc7470ba572624f14af46f519e24322112d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d61c7fc7470ba572624f14af46f519e24322112d/comments", "author": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f8349e1a83bf44ea158d97aaba3103a52f8c940d", "url": "https://api.github.com/repos/rust-lang/rust/commits/f8349e1a83bf44ea158d97aaba3103a52f8c940d", "html_url": "https://github.com/rust-lang/rust/commit/f8349e1a83bf44ea158d97aaba3103a52f8c940d"}, {"sha": "0ee6128e27496c063bb45fb958c124db133e8baf", "url": "https://api.github.com/repos/rust-lang/rust/commits/0ee6128e27496c063bb45fb958c124db133e8baf", "html_url": "https://github.com/rust-lang/rust/commit/0ee6128e27496c063bb45fb958c124db133e8baf"}], "stats": {"total": 152, "additions": 151, "deletions": 1}, "files": [{"sha": "54f10f30fd2cdd7719a4adcb3e79dc87a2bb81a7", "filename": "CHANGELOG.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d61c7fc7470ba572624f14af46f519e24322112d/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/d61c7fc7470ba572624f14af46f519e24322112d/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=d61c7fc7470ba572624f14af46f519e24322112d", "patch": "@@ -263,6 +263,7 @@ All notable changes to this project will be documented in this file.\n [`crosspointer_transmute`]: https://github.com/Manishearth/rust-clippy/wiki#crosspointer_transmute\n [`cyclomatic_complexity`]: https://github.com/Manishearth/rust-clippy/wiki#cyclomatic_complexity\n [`deprecated_semver`]: https://github.com/Manishearth/rust-clippy/wiki#deprecated_semver\n+[`deref_addrof`]: https://github.com/Manishearth/rust-clippy/wiki#deref_addrof\n [`derive_hash_xor_eq`]: https://github.com/Manishearth/rust-clippy/wiki#derive_hash_xor_eq\n [`diverging_sub_expression`]: https://github.com/Manishearth/rust-clippy/wiki#diverging_sub_expression\n [`doc_markdown`]: https://github.com/Manishearth/rust-clippy/wiki#doc_markdown"}, {"sha": "7647036f866e684cf688dfc2c281edd1bbcd084d", "filename": "README.md", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/d61c7fc7470ba572624f14af46f519e24322112d/README.md", "raw_url": "https://github.com/rust-lang/rust/raw/d61c7fc7470ba572624f14af46f519e24322112d/README.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/README.md?ref=d61c7fc7470ba572624f14af46f519e24322112d", "patch": "@@ -172,7 +172,7 @@ transparently:\n \n ## Lints\n \n-There are 178 lints included in this crate:\n+There are 179 lints included in this crate:\n \n name                                                                                                                   | default | triggers on\n -----------------------------------------------------------------------------------------------------------------------|---------|----------------------------------------------------------------------------------------------------------------------------------\n@@ -204,6 +204,7 @@ name\n [crosspointer_transmute](https://github.com/Manishearth/rust-clippy/wiki#crosspointer_transmute)                       | warn    | transmutes that have to or from types that are a pointer to the other\n [cyclomatic_complexity](https://github.com/Manishearth/rust-clippy/wiki#cyclomatic_complexity)                         | warn    | functions that should be split up into multiple functions\n [deprecated_semver](https://github.com/Manishearth/rust-clippy/wiki#deprecated_semver)                                 | warn    | use of `#[deprecated(since = \"x\")]` where x is not semver\n+[deref_addrof](https://github.com/Manishearth/rust-clippy/wiki#deref_addrof)                                           | warn    | use of `*&` or `*&mut` in an expression\n [derive_hash_xor_eq](https://github.com/Manishearth/rust-clippy/wiki#derive_hash_xor_eq)                               | warn    | deriving `Hash` but implementing `PartialEq` explicitly\n [diverging_sub_expression](https://github.com/Manishearth/rust-clippy/wiki#diverging_sub_expression)                   | warn    | whether an expression contains a diverging sub expression\n [doc_markdown](https://github.com/Manishearth/rust-clippy/wiki#doc_markdown)                                           | warn    | presence of `_`, `::` or camel-case outside backticks in documentation"}, {"sha": "c6852477a11a079577b50ea09fd50d80af4deb0c", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/d61c7fc7470ba572624f14af46f519e24322112d/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d61c7fc7470ba572624f14af46f519e24322112d/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=d61c7fc7470ba572624f14af46f519e24322112d", "patch": "@@ -116,6 +116,7 @@ pub mod precedence;\n pub mod print;\n pub mod ptr;\n pub mod ranges;\n+pub mod reference;\n pub mod regex;\n pub mod returns;\n pub mod serde;\n@@ -267,6 +268,7 @@ pub fn register_plugins(reg: &mut rustc_plugin::Registry) {\n     reg.register_late_lint_pass(box ok_if_let::Pass);\n     reg.register_late_lint_pass(box if_let_redundant_pattern_matching::Pass);\n     reg.register_late_lint_pass(box partialeq_ne_impl::Pass);\n+    reg.register_early_lint_pass(box reference::Pass);\n \n     reg.register_lint_group(\"clippy_restrictions\", vec![\n         arithmetic::FLOAT_ARITHMETIC,\n@@ -432,6 +434,7 @@ pub fn register_plugins(reg: &mut rustc_plugin::Registry) {\n         ptr::PTR_ARG,\n         ranges::RANGE_STEP_BY_ZERO,\n         ranges::RANGE_ZIP_WITH_LEN,\n+        reference::DEREF_ADDROF,\n         regex::INVALID_REGEX,\n         regex::REGEX_MACRO,\n         regex::TRIVIAL_REGEX,"}, {"sha": "19e8a3c7d146efa196000aae610fc7b837a598d6", "filename": "clippy_lints/src/reference.rs", "status": "added", "additions": 55, "deletions": 0, "changes": 55, "blob_url": "https://github.com/rust-lang/rust/blob/d61c7fc7470ba572624f14af46f519e24322112d/clippy_lints%2Fsrc%2Freference.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d61c7fc7470ba572624f14af46f519e24322112d/clippy_lints%2Fsrc%2Freference.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Freference.rs?ref=d61c7fc7470ba572624f14af46f519e24322112d", "patch": "@@ -0,0 +1,55 @@\n+use syntax::ast::{Expr,ExprKind,UnOp};\n+use rustc::lint::*;\n+use utils::{span_lint_and_then, snippet};\n+\n+/// **What it does:** Checks for usage of `*&` and `*&mut` in expressions.\n+///\n+/// **Why is this bad?** Immediately dereferencing a reference is no-op and\n+/// makes the code less clear.\n+///\n+/// **Known problems:** Multiple dereference/addrof pairs are not handled so\n+/// the suggested fix for `x = **&&y` is `x = *&y`, which is still incorrect.\n+///\n+/// **Example:**\n+/// ```rust\n+/// let a = f(*&mut b);\n+/// let c = *&d;\n+/// ```\n+declare_lint! {\n+    pub DEREF_ADDROF,\n+    Warn,\n+    \"use of `*&` or `*&mut` in an expression\"\n+}\n+\n+pub struct Pass;\n+\n+impl LintPass for Pass {\n+    fn get_lints(&self) -> LintArray {\n+        lint_array!(DEREF_ADDROF)\n+    }\n+}\n+\n+fn without_parens(mut e: &Expr) -> &Expr {\n+    while let ExprKind::Paren(ref child_e) = e.node {\n+        e = child_e;\n+    }\n+    e\n+}\n+\n+impl EarlyLintPass for Pass {\n+    fn check_expr(&mut self, cx: &EarlyContext, e: &Expr) {\n+        if let ExprKind::Unary(UnOp::Deref, ref deref_target) = e.node {\n+            if let ExprKind::AddrOf(_, ref addrof_target) = without_parens(deref_target).node {\n+                span_lint_and_then(\n+                    cx,\n+                    DEREF_ADDROF,\n+                    e.span,\n+                    \"immediately dereferencing a reference\",\n+                    |db| {\n+                        db.span_suggestion(e.span, \"try this\",\n+                                             format!(\"{}\", snippet(cx, addrof_target.span, \"_\")));\n+                    });\n+            }\n+        }\n+    }\n+}"}, {"sha": "faaae46af71821a94cc15536af1dd13b3966be2a", "filename": "tests/compile-fail/formatting.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d61c7fc7470ba572624f14af46f519e24322112d/tests%2Fcompile-fail%2Fformatting.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d61c7fc7470ba572624f14af46f519e24322112d/tests%2Fcompile-fail%2Fformatting.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Fformatting.rs?ref=d61c7fc7470ba572624f14af46f519e24322112d", "patch": "@@ -5,6 +5,7 @@\n #![allow(unused_variables)]\n #![allow(unused_assignments)]\n #![allow(if_same_then_else)]\n+#![allow(deref_addrof)]\n \n fn foo() -> bool { true }\n "}, {"sha": "30a66a715f2000ed5d1650b77dc66a449ff1887d", "filename": "tests/compile-fail/no_effect.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d61c7fc7470ba572624f14af46f519e24322112d/tests%2Fcompile-fail%2Fno_effect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d61c7fc7470ba572624f14af46f519e24322112d/tests%2Fcompile-fail%2Fno_effect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Fno_effect.rs?ref=d61c7fc7470ba572624f14af46f519e24322112d", "patch": "@@ -4,6 +4,7 @@\n #![deny(no_effect, unnecessary_operation)]\n #![allow(dead_code)]\n #![allow(path_statements)]\n+#![allow(deref_addrof)]\n #![feature(untagged_unions)]\n \n struct Unit;"}, {"sha": "b77afbc127025ea4969dafa202597b030dd674f1", "filename": "tests/compile-fail/reference.rs", "status": "added", "additions": 88, "deletions": 0, "changes": 88, "blob_url": "https://github.com/rust-lang/rust/blob/d61c7fc7470ba572624f14af46f519e24322112d/tests%2Fcompile-fail%2Freference.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d61c7fc7470ba572624f14af46f519e24322112d/tests%2Fcompile-fail%2Freference.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Freference.rs?ref=d61c7fc7470ba572624f14af46f519e24322112d", "patch": "@@ -0,0 +1,88 @@\n+#![feature(plugin)]\n+#![plugin(clippy)]\n+\n+fn get_number() -> usize {\n+    10\n+}\n+\n+fn get_reference(n : &usize) -> &usize {\n+    n\n+}\n+\n+#[allow(many_single_char_names)]\n+#[allow(unused_variables)]\n+#[deny(deref_addrof)]\n+fn main() {\n+    let a = 10;\n+    let aref = &a;\n+\n+    let b = *&a;\n+    //~^ERROR immediately dereferencing a reference\n+    //~|HELP try this\n+    //~|SUGGESTION let b = a;\n+\n+    let b = *&get_number();\n+    //~^ERROR immediately dereferencing a reference\n+    //~|HELP try this\n+    //~|SUGGESTION let b = get_number();\n+\n+    let b = *get_reference(&a);\n+\n+    let bytes : Vec<usize> = vec![1, 2, 3, 4];\n+    let b = *&bytes[1..2][0];\n+    //~^ERROR immediately dereferencing a reference\n+    //~|HELP try this\n+    //~|SUGGESTION let b = bytes[1..2][0];\n+\n+    //This produces a suggestion of 'let b = (a);' which\n+    //will trigger the 'unused_parens' lint\n+    let b = *&(a);\n+    //~^ERROR immediately dereferencing a reference\n+    //~|HELP try this\n+    //~|SUGGESTION let b = (a)\n+\n+    let b = *(&a);\n+    //~^ERROR immediately dereferencing a reference\n+    //~|HELP try this\n+    //~|SUGGESTION let b = a;\n+\n+    let b = *((&a));\n+    //~^ERROR immediately dereferencing a reference\n+    //~|HELP try this\n+    //~|SUGGESTION let b = a\n+\n+    let b = *&&a;\n+    //~^ERROR immediately dereferencing a reference\n+    //~|HELP try this\n+    //~|SUGGESTION let b = &a;\n+\n+    let b = **&aref;\n+    //~^ERROR immediately dereferencing a reference\n+    //~|HELP try this\n+    //~|SUGGESTION let b = *aref;\n+\n+    //This produces a suggestion of 'let b = *&a;' which\n+    //will trigger the 'deref_addrof' lint again\n+    let b = **&&a;\n+    //~^ERROR immediately dereferencing a reference\n+    //~|HELP try this\n+    //~|SUGGESTION let b = *&a;\n+\n+    {\n+        let mut x = 10;\n+        let y = *&mut x;\n+        //~^ERROR immediately dereferencing a reference\n+        //~|HELP try this\n+        //~|SUGGESTION let y = x;\n+    }\n+\n+    {\n+        //This produces a suggestion of 'let y = *&mut x' which\n+        //will trigger the 'deref_addrof' lint again\n+        let mut x = 10;\n+        let y = **&mut &mut x;\n+        //~^ERROR immediately dereferencing a reference\n+        //~|HELP try this\n+        //~|SUGGESTION let y = *&mut x;\n+    }\n+}"}]}