{"sha": "2f62c0117a1d59a531f9c84fbdb2f70ff87d22e0", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJmNjJjMDExN2ExZDU5YTUzMWY5Yzg0ZmJkYjJmNzBmZjg3ZDIyZTA=", "commit": {"author": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2021-04-19T11:20:37Z"}, "committer": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2021-04-19T11:32:52Z"}, "message": "Check for rust doc code attributes like rustdoc does", "tree": {"sha": "b5d6941cad6a68b786dd8993bfb8a9bb8997aa80", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b5d6941cad6a68b786dd8993bfb8a9bb8997aa80"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2f62c0117a1d59a531f9c84fbdb2f70ff87d22e0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2f62c0117a1d59a531f9c84fbdb2f70ff87d22e0", "html_url": "https://github.com/rust-lang/rust/commit/2f62c0117a1d59a531f9c84fbdb2f70ff87d22e0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2f62c0117a1d59a531f9c84fbdb2f70ff87d22e0/comments", "author": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8a959497b1fab35294d8ccfa5e51c80a3551a224", "url": "https://api.github.com/repos/rust-lang/rust/commits/8a959497b1fab35294d8ccfa5e51c80a3551a224", "html_url": "https://github.com/rust-lang/rust/commit/8a959497b1fab35294d8ccfa5e51c80a3551a224"}], "stats": {"total": 85, "additions": 40, "deletions": 45}, "files": [{"sha": "bc221d59966fc422e9fa092dc66347b1a2d1e9c1", "filename": "crates/ide/src/syntax_highlighting/inject.rs", "status": "modified", "additions": 2, "deletions": 22, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/2f62c0117a1d59a531f9c84fbdb2f70ff87d22e0/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Finject.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f62c0117a1d59a531f9c84fbdb2f70ff87d22e0/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Finject.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Finject.rs?ref=2f62c0117a1d59a531f9c84fbdb2f70ff87d22e0", "patch": "@@ -4,7 +4,7 @@ use std::mem;\n \n use either::Either;\n use hir::{InFile, Semantics};\n-use ide_db::{call_info::ActiveParameter, SymbolKind};\n+use ide_db::{call_info::ActiveParameter, helpers::rust_doc::is_rust_fence, SymbolKind};\n use syntax::{\n     ast::{self, AstNode},\n     AstToken, NodeOrToken, SyntaxNode, SyntaxToken, TextRange, TextSize,\n@@ -78,26 +78,6 @@ pub(super) fn ra_fixture(\n }\n \n const RUSTDOC_FENCE: &'static str = \"```\";\n-const RUSTDOC_FENCE_TOKENS: &[&'static str] = &[\n-    \"\",\n-    \"rust\",\n-    \"should_panic\",\n-    \"ignore\",\n-    \"no_run\",\n-    \"compile_fail\",\n-    \"allow_fail\",\n-    \"test_harness\",\n-    \"edition2015\",\n-    \"edition2018\",\n-    \"edition2021\",\n-];\n-\n-fn is_rustdoc_fence_token(token: &str) -> bool {\n-    if RUSTDOC_FENCE_TOKENS.contains(&token) {\n-        return true;\n-    }\n-    token.starts_with('E') && token.len() == 5 && token[1..].parse::<u32>().is_ok()\n-}\n \n /// Injection of syntax highlighting of doctests.\n pub(super) fn doc_comment(\n@@ -183,7 +163,7 @@ pub(super) fn doc_comment(\n                     is_codeblock = !is_codeblock;\n                     // Check whether code is rust by inspecting fence guards\n                     let guards = &line[idx + RUSTDOC_FENCE.len()..];\n-                    let is_rust = guards.split(',').any(|sub| is_rustdoc_fence_token(sub.trim()));\n+                    let is_rust = is_rust_fence(guards);\n                     is_doctest = is_codeblock && is_rust;\n                     continue;\n                 }"}, {"sha": "17cc6334b9e07cc68f440ce6ee3a7f18100033f0", "filename": "crates/ide/src/syntax_highlighting/tests.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/2f62c0117a1d59a531f9c84fbdb2f70ff87d22e0/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f62c0117a1d59a531f9c84fbdb2f70ff87d22e0/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fsyntax_highlighting%2Ftests.rs?ref=2f62c0117a1d59a531f9c84fbdb2f70ff87d22e0", "patch": "@@ -307,7 +307,7 @@ fn benchmark_syntax_highlighting_parser() {\n             .filter(|it| it.highlight.tag == HlTag::Symbol(SymbolKind::Function))\n             .count()\n     };\n-    assert_eq!(hash, 1629);\n+    assert_eq!(hash, 1632);\n }\n \n #[test]"}, {"sha": "720de0d1fba82d9cd55ad484e560a31666bd2439", "filename": "crates/ide_db/src/helpers.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/2f62c0117a1d59a531f9c84fbdb2f70ff87d22e0/crates%2Fide_db%2Fsrc%2Fhelpers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f62c0117a1d59a531f9c84fbdb2f70ff87d22e0/crates%2Fide_db%2Fsrc%2Fhelpers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_db%2Fsrc%2Fhelpers.rs?ref=2f62c0117a1d59a531f9c84fbdb2f70ff87d22e0", "patch": "@@ -1,6 +1,7 @@\n //! A module with ide helpers for high-level ide features.\n pub mod insert_use;\n pub mod import_assets;\n+pub mod rust_doc;\n \n use std::collections::VecDeque;\n "}, {"sha": "e27e23867a8b82ef6c0b896d75585a5bd64bd597", "filename": "crates/ide_db/src/helpers/rust_doc.rs", "status": "added", "additions": 34, "deletions": 0, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/2f62c0117a1d59a531f9c84fbdb2f70ff87d22e0/crates%2Fide_db%2Fsrc%2Fhelpers%2Frust_doc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f62c0117a1d59a531f9c84fbdb2f70ff87d22e0/crates%2Fide_db%2Fsrc%2Fhelpers%2Frust_doc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide_db%2Fsrc%2Fhelpers%2Frust_doc.rs?ref=2f62c0117a1d59a531f9c84fbdb2f70ff87d22e0", "patch": "@@ -0,0 +1,34 @@\n+//! Rustdoc specific doc comment handling\n+\n+// stripped down version of https://github.com/rust-lang/rust/blob/392ba2ba1a7d6c542d2459fb8133bebf62a4a423/src/librustdoc/html/markdown.rs#L810-L933\n+pub fn is_rust_fence(s: &str) -> bool {\n+    let mut seen_rust_tags = false;\n+    let mut seen_other_tags = false;\n+\n+    let tokens = s\n+        .trim()\n+        .split(|c| c == ',' || c == ' ' || c == '\\t')\n+        .map(str::trim)\n+        .filter(|t| !t.is_empty());\n+\n+    for token in tokens {\n+        match token {\n+            \"should_panic\" | \"no_run\" | \"ignore\" | \"allow_fail\" => {\n+                seen_rust_tags = !seen_other_tags\n+            }\n+            \"rust\" => seen_rust_tags = true,\n+            \"test_harness\" | \"compile_fail\" => seen_rust_tags = !seen_other_tags || seen_rust_tags,\n+            x if x.starts_with(\"edition\") => {}\n+            x if x.starts_with('E') && x.len() == 5 => {\n+                if x[1..].parse::<u32>().is_ok() {\n+                    seen_rust_tags = !seen_other_tags || seen_rust_tags;\n+                } else {\n+                    seen_other_tags = true;\n+                }\n+            }\n+            _ => seen_other_tags = true,\n+        }\n+    }\n+\n+    !seen_other_tags || seen_rust_tags\n+}"}, {"sha": "35eaffba8ca99a4e88ca5f0d20f13c946820a7b1", "filename": "crates/rust-analyzer/src/markdown.rs", "status": "modified", "additions": 2, "deletions": 22, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/2f62c0117a1d59a531f9c84fbdb2f70ff87d22e0/crates%2Frust-analyzer%2Fsrc%2Fmarkdown.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2f62c0117a1d59a531f9c84fbdb2f70ff87d22e0/crates%2Frust-analyzer%2Fsrc%2Fmarkdown.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fmarkdown.rs?ref=2f62c0117a1d59a531f9c84fbdb2f70ff87d22e0", "patch": "@@ -1,19 +1,7 @@\n //! Transforms markdown\n+use ide_db::helpers::rust_doc::is_rust_fence;\n \n const RUSTDOC_FENCE: &str = \"```\";\n-const RUSTDOC_CODE_BLOCK_ATTRIBUTES_RUST_SPECIFIC: &[&str] = &[\n-    \"\",\n-    \"rust\",\n-    \"should_panic\",\n-    \"ignore\",\n-    \"no_run\",\n-    \"compile_fail\",\n-    \"allow_fail\",\n-    \"test_harness\",\n-    \"edition2015\",\n-    \"edition2018\",\n-    \"edition2021\",\n-];\n \n pub(crate) fn format_docs(src: &str) -> String {\n     let mut processed_lines = Vec::new();\n@@ -29,8 +17,7 @@ pub(crate) fn format_docs(src: &str) -> String {\n             in_code_block ^= true;\n \n             if in_code_block {\n-                is_rust =\n-                    header.split(',').any(|sub| is_rust_specific_code_block_attribute(sub.trim()));\n+                is_rust = is_rust_fence(header);\n \n                 if is_rust {\n                     line = \"```rust\";\n@@ -43,13 +30,6 @@ pub(crate) fn format_docs(src: &str) -> String {\n     processed_lines.join(\"\\n\")\n }\n \n-fn is_rust_specific_code_block_attribute(attr: &str) -> bool {\n-    if RUSTDOC_CODE_BLOCK_ATTRIBUTES_RUST_SPECIFIC.contains(&attr) {\n-        return true;\n-    }\n-    attr.starts_with('E') && attr.len() == 5 && attr[1..].parse::<u32>().is_ok()\n-}\n-\n fn code_line_ignored_by_rustdoc(line: &str) -> bool {\n     let trimmed = line.trim();\n     trimmed == \"#\" || trimmed.starts_with(\"# \") || trimmed.starts_with(\"#\\t\")"}]}