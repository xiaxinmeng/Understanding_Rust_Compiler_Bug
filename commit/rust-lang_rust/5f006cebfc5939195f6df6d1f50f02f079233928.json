{"sha": "5f006cebfc5939195f6df6d1f50f02f079233928", "node_id": "MDY6Q29tbWl0NzI0NzEyOjVmMDA2Y2ViZmM1OTM5MTk1ZjZkZjZkMWY1MGYwMmYwNzkyMzM5Mjg=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2018-01-05T21:26:26Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2018-01-13T18:07:18Z"}, "message": "rustc: Tweak `#[target_feature]` syntax\n\nThis is an implementation of the `#[target_feature]` syntax-related changes of\n[RFC 2045][rfc]. Notably two changes have been implemented:\n\n* The new syntax is `#[target_feature(enable = \"..\")]` instead of\n  `#[target_feature = \"+..\"]`. The `enable` key is necessary instead of the `+`\n  to indicate that a feature is being enabled, and a sub-list is used for\n  possible expansion in the future. Additionally within this syntax the feature\n  names being enabled are now whitelisted against a known set of target feature\n  names that we know about.\n\n* The `#[target_feature]` attribute can only be applied to unsafe functions. It\n  was decided in the RFC that invoking an instruction possibly not defined for\n  the current processor is undefined behavior, so to enable this feature for now\n  it requires an `unsafe` intervention.\n\n[rfc]: https://github.com/rust-lang/rfcs/blob/master/text/2045-target-feature.md", "tree": {"sha": "1005c357e535f4cb262041470959dd001a81d591", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1005c357e535f4cb262041470959dd001a81d591"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5f006cebfc5939195f6df6d1f50f02f079233928", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5f006cebfc5939195f6df6d1f50f02f079233928", "html_url": "https://github.com/rust-lang/rust/commit/5f006cebfc5939195f6df6d1f50f02f079233928", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5f006cebfc5939195f6df6d1f50f02f079233928/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e6072a7b3835f1875e81c9fd27799f9b20a0770c", "url": "https://api.github.com/repos/rust-lang/rust/commits/e6072a7b3835f1875e81c9fd27799f9b20a0770c", "html_url": "https://github.com/rust-lang/rust/commit/e6072a7b3835f1875e81c9fd27799f9b20a0770c"}], "stats": {"total": 243, "additions": 216, "deletions": 27}, "files": [{"sha": "eda7ddb161f1273b09273c6174d1b4be277d2c41", "filename": "src/librustc/dep_graph/dep_node.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/5f006cebfc5939195f6df6d1f50f02f079233928/src%2Flibrustc%2Fdep_graph%2Fdep_node.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5f006cebfc5939195f6df6d1f50f02f079233928/src%2Flibrustc%2Fdep_graph%2Fdep_node.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fdep_graph%2Fdep_node.rs?ref=5f006cebfc5939195f6df6d1f50f02f079233928", "patch": "@@ -635,6 +635,10 @@ define_dep_nodes!( <'tcx>\n     [] Null,\n \n     [] SubstituteNormalizeAndTestPredicates { key: (DefId, &'tcx Substs<'tcx>) },\n+\n+    [input] TargetFeaturesWhitelist,\n+    [] TargetFeaturesEnabled(DefId),\n+\n );\n \n trait DepNodeParams<'a, 'gcx: 'tcx + 'a, 'tcx: 'a> : fmt::Debug {"}, {"sha": "8dedcb24c2fb61a8b50dca7a9d2232ab7941ae98", "filename": "src/librustc/ty/maps/config.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/5f006cebfc5939195f6df6d1f50f02f079233928/src%2Flibrustc%2Fty%2Fmaps%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5f006cebfc5939195f6df6d1f50f02f079233928/src%2Flibrustc%2Fty%2Fmaps%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fmaps%2Fconfig.rs?ref=5f006cebfc5939195f6df6d1f50f02f079233928", "patch": "@@ -631,6 +631,12 @@ impl<'tcx> QueryDescription<'tcx> for queries::substitute_normalize_and_test_pre\n     }\n }\n \n+impl<'tcx> QueryDescription<'tcx> for queries::target_features_whitelist<'tcx> {\n+    fn describe(_tcx: TyCtxt, _: CrateNum) -> String {\n+        format!(\"looking up the whitelist of target features\")\n+    }\n+}\n+\n macro_rules! impl_disk_cacheable_query(\n     ($query_name:ident, |$key:tt| $cond:expr) => {\n         impl<'tcx> QueryDescription<'tcx> for queries::$query_name<'tcx> {"}, {"sha": "51cae9e13f8838a1061fa535df83f2512f8ccaa2", "filename": "src/librustc/ty/maps/mod.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/5f006cebfc5939195f6df6d1f50f02f079233928/src%2Flibrustc%2Fty%2Fmaps%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5f006cebfc5939195f6df6d1f50f02f079233928/src%2Flibrustc%2Fty%2Fmaps%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fmaps%2Fmod.rs?ref=5f006cebfc5939195f6df6d1f50f02f079233928", "patch": "@@ -363,6 +363,11 @@ define_maps! { <'tcx>\n \n     [] fn substitute_normalize_and_test_predicates:\n         substitute_normalize_and_test_predicates_node((DefId, &'tcx Substs<'tcx>)) -> bool,\n+\n+    [] fn target_features_whitelist:\n+        target_features_whitelist_node(CrateNum) -> Rc<FxHashSet<String>>,\n+    [] fn target_features_enabled: TargetFeaturesEnabled(DefId) -> Rc<Vec<String>>,\n+\n }\n \n //////////////////////////////////////////////////////////////////////\n@@ -508,3 +513,7 @@ fn substitute_normalize_and_test_predicates_node<'tcx>(key: (DefId, &'tcx Substs\n                                             -> DepConstructor<'tcx> {\n     DepConstructor::SubstituteNormalizeAndTestPredicates { key }\n }\n+\n+fn target_features_whitelist_node<'tcx>(_: CrateNum) -> DepConstructor<'tcx> {\n+    DepConstructor::TargetFeaturesWhitelist\n+}"}, {"sha": "4f6f1ab0ee2dd1dda937cbac813771f3311a877e", "filename": "src/librustc/ty/maps/plumbing.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/5f006cebfc5939195f6df6d1f50f02f079233928/src%2Flibrustc%2Fty%2Fmaps%2Fplumbing.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5f006cebfc5939195f6df6d1f50f02f079233928/src%2Flibrustc%2Fty%2Fmaps%2Fplumbing.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fty%2Fmaps%2Fplumbing.rs?ref=5f006cebfc5939195f6df6d1f50f02f079233928", "patch": "@@ -918,6 +918,9 @@ pub fn force_from_dep_node<'a, 'gcx, 'lcx>(tcx: TyCtxt<'a, 'gcx, 'lcx>,\n         }\n         DepKind::IsTranslatedFunction => { force!(is_translated_function, def_id!()); }\n         DepKind::OutputFilenames => { force!(output_filenames, LOCAL_CRATE); }\n+\n+        DepKind::TargetFeaturesWhitelist => { force!(target_features_whitelist, LOCAL_CRATE); }\n+        DepKind::TargetFeaturesEnabled => { force!(target_features_enabled, def_id!()); }\n     }\n \n     true"}, {"sha": "f3105e03523a3ba657f451d4a0885a9dcc6d7bef", "filename": "src/librustc_trans/attributes.rs", "status": "modified", "additions": 109, "deletions": 13, "changes": 122, "blob_url": "https://github.com/rust-lang/rust/blob/5f006cebfc5939195f6df6d1f50f02f079233928/src%2Flibrustc_trans%2Fattributes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5f006cebfc5939195f6df6d1f50f02f079233928/src%2Flibrustc_trans%2Fattributes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fattributes.rs?ref=5f006cebfc5939195f6df6d1f50f02f079233928", "patch": "@@ -10,11 +10,18 @@\n //! Set and unset common attributes on LLVM values.\n \n use std::ffi::{CStr, CString};\n+use std::rc::Rc;\n \n+use rustc::hir::Unsafety;\n+use rustc::hir::def_id::{DefId, LOCAL_CRATE};\n use rustc::session::config::Sanitizer;\n+use rustc::ty::TyCtxt;\n+use rustc::ty::maps::Providers;\n+use rustc_data_structures::fx::FxHashSet;\n \n use llvm::{self, Attribute, ValueRef};\n use llvm::AttributePlace::Function;\n+use llvm_util;\n pub use syntax::attr::{self, InlineAttr};\n use syntax::ast;\n use context::CrateContext;\n@@ -94,23 +101,16 @@ pub fn set_probestack(ccx: &CrateContext, llfn: ValueRef) {\n \n /// Composite function which sets LLVM attributes for function depending on its AST (#[attribute])\n /// attributes.\n-pub fn from_fn_attrs(ccx: &CrateContext, attrs: &[ast::Attribute], llfn: ValueRef) {\n+pub fn from_fn_attrs(ccx: &CrateContext, llfn: ValueRef, id: DefId) {\n     use syntax::attr::*;\n-    inline(llfn, find_inline_attr(Some(ccx.sess().diagnostic()), attrs));\n+    let attrs = ccx.tcx().get_attrs(id);\n+    inline(llfn, find_inline_attr(Some(ccx.sess().diagnostic()), &attrs));\n \n     set_frame_pointer_elimination(ccx, llfn);\n     set_probestack(ccx, llfn);\n-    let mut target_features = vec![];\n-    for attr in attrs {\n-        if attr.check_name(\"target_feature\") {\n-            if let Some(val) = attr.value_str() {\n-                for feat in val.as_str().split(\",\").map(|f| f.trim()) {\n-                    if !feat.is_empty() && !feat.contains('\\0') {\n-                        target_features.push(feat.to_string());\n-                    }\n-                }\n-            }\n-        } else if attr.check_name(\"cold\") {\n+\n+    for attr in attrs.iter() {\n+        if attr.check_name(\"cold\") {\n             Attribute::Cold.apply_llfn(Function, llfn);\n         } else if attr.check_name(\"naked\") {\n             naked(llfn, true);\n@@ -123,6 +123,8 @@ pub fn from_fn_attrs(ccx: &CrateContext, attrs: &[ast::Attribute], llfn: ValueRe\n             unwind(llfn, false);\n         }\n     }\n+\n+    let target_features = ccx.tcx().target_features_enabled(id);\n     if !target_features.is_empty() {\n         let val = CString::new(target_features.join(\",\")).unwrap();\n         llvm::AddFunctionAttrStringValue(\n@@ -134,3 +136,97 @@ pub fn from_fn_attrs(ccx: &CrateContext, attrs: &[ast::Attribute], llfn: ValueRe\n fn cstr(s: &'static str) -> &CStr {\n     CStr::from_bytes_with_nul(s.as_bytes()).expect(\"null-terminated string\")\n }\n+\n+pub fn provide(providers: &mut Providers) {\n+    providers.target_features_whitelist = |tcx, cnum| {\n+        assert_eq!(cnum, LOCAL_CRATE);\n+        Rc::new(llvm_util::target_feature_whitelist(tcx.sess)\n+            .iter()\n+            .map(|c| c.to_str().unwrap().to_string())\n+            .collect())\n+    };\n+\n+    providers.target_features_enabled = |tcx, id| {\n+        let whitelist = tcx.target_features_whitelist(LOCAL_CRATE);\n+        let mut target_features = Vec::new();\n+        for attr in tcx.get_attrs(id).iter() {\n+            if !attr.check_name(\"target_feature\") {\n+                continue\n+            }\n+            if let Some(val) = attr.value_str() {\n+                for feat in val.as_str().split(\",\").map(|f| f.trim()) {\n+                    if !feat.is_empty() && !feat.contains('\\0') {\n+                        target_features.push(feat.to_string());\n+                    }\n+                }\n+                let msg = \"#[target_feature = \\\"..\\\"] is deprecated and will \\\n+                           eventually be removed, use \\\n+                           #[target_feature(enable = \\\"..\\\")] instead\";\n+                tcx.sess.span_warn(attr.span, &msg);\n+                continue\n+            }\n+\n+            if tcx.fn_sig(id).unsafety() == Unsafety::Normal {\n+                let msg = \"#[target_feature(..)] can only be applied to \\\n+                           `unsafe` function\";\n+                tcx.sess.span_err(attr.span, msg);\n+            }\n+            from_target_feature(tcx, attr, &whitelist, &mut target_features);\n+        }\n+        Rc::new(target_features)\n+    };\n+}\n+\n+fn from_target_feature(\n+    tcx: TyCtxt,\n+    attr: &ast::Attribute,\n+    whitelist: &FxHashSet<String>,\n+    target_features: &mut Vec<String>,\n+) {\n+    let list = match attr.meta_item_list() {\n+        Some(list) => list,\n+        None => {\n+            let msg = \"#[target_feature] attribute must be of the form \\\n+                       #[target_feature(..)]\";\n+            tcx.sess.span_err(attr.span, &msg);\n+            return\n+        }\n+    };\n+\n+    for item in list {\n+        if !item.check_name(\"enable\") {\n+            let msg = \"#[target_feature(..)] only accepts sub-keys of `enable` \\\n+                       currently\";\n+            tcx.sess.span_err(item.span, &msg);\n+            continue\n+        }\n+        let value = match item.value_str() {\n+            Some(list) => list,\n+            None => {\n+                let msg = \"#[target_feature] attribute must be of the form \\\n+                           #[target_feature(enable = \\\"..\\\")]\";\n+                tcx.sess.span_err(item.span, &msg);\n+                continue\n+            }\n+        };\n+        let value = value.as_str();\n+        for feature in value.split(',') {\n+            if whitelist.contains(feature) {\n+                target_features.push(format!(\"+{}\", feature));\n+                continue\n+            }\n+\n+            let msg = format!(\"the feature named `{}` is not valid for \\\n+                               this target\", feature);\n+            let mut err = tcx.sess.struct_span_err(item.span, &msg);\n+\n+            if feature.starts_with(\"+\") {\n+                let valid = whitelist.contains(&feature[1..]);\n+                if valid {\n+                    err.help(\"consider removing the leading `+` in the feature name\");\n+                }\n+            }\n+            err.emit();\n+        }\n+    }\n+}"}, {"sha": "ccbc6620ffe09b0755a488e3e254a1af06da0683", "filename": "src/librustc_trans/callee.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/5f006cebfc5939195f6df6d1f50f02f079233928/src%2Flibrustc_trans%2Fcallee.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5f006cebfc5939195f6df6d1f50f02f079233928/src%2Flibrustc_trans%2Fcallee.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fcallee.rs?ref=5f006cebfc5939195f6df6d1f50f02f079233928", "patch": "@@ -99,8 +99,7 @@ pub fn get_fn<'a, 'tcx>(ccx: &CrateContext<'a, 'tcx>,\n         if instance.def.is_inline(tcx) {\n             attributes::inline(llfn, attributes::InlineAttr::Hint);\n         }\n-        let attrs = instance.def.attrs(ccx.tcx());\n-        attributes::from_fn_attrs(ccx, &attrs, llfn);\n+        attributes::from_fn_attrs(ccx, llfn, instance.def.def_id());\n \n         let instance_def_id = instance.def_id();\n "}, {"sha": "974c268749b859a5620059aea0f6e6846963aaa7", "filename": "src/librustc_trans/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/5f006cebfc5939195f6df6d1f50f02f079233928/src%2Flibrustc_trans%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5f006cebfc5939195f6df6d1f50f02f079233928/src%2Flibrustc_trans%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Flib.rs?ref=5f006cebfc5939195f6df6d1f50f02f079233928", "patch": "@@ -167,6 +167,7 @@ impl rustc_trans_utils::trans_crate::TransCrate for LlvmTransCrate {\n         back::symbol_names::provide(providers);\n         back::symbol_export::provide(providers);\n         base::provide(providers);\n+        attributes::provide(providers);\n     }\n \n     fn provide_extern(providers: &mut ty::maps::Providers) {"}, {"sha": "8112a9eeab1ef4d8d622bd5dcfc5a561eccb153e", "filename": "src/librustc_trans/llvm_util.rs", "status": "modified", "additions": 15, "deletions": 11, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/5f006cebfc5939195f6df6d1f50f02f079233928/src%2Flibrustc_trans%2Fllvm_util.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5f006cebfc5939195f6df6d1f50f02f079233928/src%2Flibrustc_trans%2Fllvm_util.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fllvm_util.rs?ref=5f006cebfc5939195f6df6d1f50f02f079233928", "patch": "@@ -13,8 +13,8 @@ use back::write::create_target_machine;\n use llvm;\n use rustc::session::Session;\n use rustc::session::config::PrintRequest;\n-use libc::{c_int, c_char};\n-use std::ffi::CString;\n+use libc::c_int;\n+use std::ffi::{CStr, CString};\n \n use std::sync::atomic::{AtomicBool, Ordering};\n use std::sync::Once;\n@@ -97,8 +97,18 @@ const POWERPC_WHITELIST: &'static [&'static str] = &[\"altivec\\0\",\n const MIPS_WHITELIST: &'static [&'static str] = &[\"msa\\0\"];\n \n pub fn target_features(sess: &Session) -> Vec<Symbol> {\n+    let whitelist = target_feature_whitelist(sess);\n     let target_machine = create_target_machine(sess);\n+    let mut features = Vec::new();\n+    for feat in whitelist {\n+        if unsafe { llvm::LLVMRustHasFeature(target_machine, feat.as_ptr()) } {\n+            features.push(Symbol::intern(feat.to_str().unwrap()));\n+        }\n+    }\n+    features\n+}\n \n+pub fn target_feature_whitelist(sess: &Session) -> Vec<&CStr> {\n     let whitelist = match &*sess.target.target.arch {\n         \"arm\" => ARM_WHITELIST,\n         \"aarch64\" => AARCH64_WHITELIST,\n@@ -108,15 +118,9 @@ pub fn target_features(sess: &Session) -> Vec<Symbol> {\n         \"powerpc\" | \"powerpc64\" => POWERPC_WHITELIST,\n         _ => &[],\n     };\n-\n-    let mut features = Vec::new();\n-    for feat in whitelist {\n-        assert_eq!(feat.chars().last(), Some('\\0'));\n-        if unsafe { llvm::LLVMRustHasFeature(target_machine, feat.as_ptr() as *const c_char) } {\n-            features.push(Symbol::intern(&feat[..feat.len() - 1]));\n-        }\n-    }\n-    features\n+    whitelist.iter().map(|m| {\n+        CStr::from_bytes_with_nul(m.as_bytes()).unwrap()\n+    }).collect()\n }\n \n pub fn print_version() {"}, {"sha": "fa6a42e062d9fb5645f755a78b4f4ccc3222e995", "filename": "src/librustc_trans/trans_item.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/5f006cebfc5939195f6df6d1f50f02f079233928/src%2Flibrustc_trans%2Ftrans_item.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5f006cebfc5939195f6df6d1f50f02f079233928/src%2Flibrustc_trans%2Ftrans_item.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Ftrans_item.rs?ref=5f006cebfc5939195f6df6d1f50f02f079233928", "patch": "@@ -199,7 +199,7 @@ fn predefine_fn<'a, 'tcx>(ccx: &CrateContext<'a, 'tcx>,\n     if instance.def.is_inline(ccx.tcx()) {\n         attributes::inline(lldecl, attributes::InlineAttr::Hint);\n     }\n-    attributes::from_fn_attrs(ccx, &attrs, lldecl);\n+    attributes::from_fn_attrs(ccx, lldecl, instance.def.def_id());\n \n     ccx.instances().borrow_mut().insert(instance, lldecl);\n }"}, {"sha": "df24035e10b59301e2c3fd9a15d83170585109e3", "filename": "src/test/ui/target-feature-wrong.rs", "status": "added", "additions": 35, "deletions": 0, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/5f006cebfc5939195f6df6d1f50f02f079233928/src%2Ftest%2Fui%2Ftarget-feature-wrong.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5f006cebfc5939195f6df6d1f50f02f079233928/src%2Ftest%2Fui%2Ftarget-feature-wrong.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftarget-feature-wrong.rs?ref=5f006cebfc5939195f6df6d1f50f02f079233928", "patch": "@@ -0,0 +1,35 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// ignore-arm\n+// ignore-aarch64\n+\n+#![feature(target_feature)]\n+\n+#[target_feature = \"+sse2\"]\n+//~^ WARN: deprecated\n+#[target_feature(enable = \"foo\")]\n+//~^ ERROR: not valid for this target\n+#[target_feature(bar)]\n+//~^ ERROR: only accepts sub-keys\n+#[target_feature(disable = \"baz\")]\n+//~^ ERROR: only accepts sub-keys\n+unsafe fn foo() {}\n+\n+#[target_feature(enable = \"sse2\")]\n+//~^ ERROR: can only be applied to `unsafe` function\n+fn bar() {}\n+\n+fn main() {\n+    unsafe {\n+        foo();\n+        bar();\n+    }\n+}"}, {"sha": "0cbfeb3a7b7bc6173a0bc2efd3ab36f0fb4db423", "filename": "src/test/ui/target-feature-wrong.stderr", "status": "added", "additions": 32, "deletions": 0, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/5f006cebfc5939195f6df6d1f50f02f079233928/src%2Ftest%2Fui%2Ftarget-feature-wrong.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/5f006cebfc5939195f6df6d1f50f02f079233928/src%2Ftest%2Fui%2Ftarget-feature-wrong.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftarget-feature-wrong.stderr?ref=5f006cebfc5939195f6df6d1f50f02f079233928", "patch": "@@ -0,0 +1,32 @@\n+warning: #[target_feature = \"..\"] is deprecated and will eventually be removed, use #[target_feature(enable = \"..\")] instead\n+  --> $DIR/target-feature-wrong.rs:16:1\n+   |\n+16 | #[target_feature = \"+sse2\"]\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: the feature named `foo` is not valid for this target\n+  --> $DIR/target-feature-wrong.rs:18:18\n+   |\n+18 | #[target_feature(enable = \"foo\")]\n+   |                  ^^^^^^^^^^^^^^\n+\n+error: #[target_feature(..)] only accepts sub-keys of `enable` currently\n+  --> $DIR/target-feature-wrong.rs:20:18\n+   |\n+20 | #[target_feature(bar)]\n+   |                  ^^^\n+\n+error: #[target_feature(..)] only accepts sub-keys of `enable` currently\n+  --> $DIR/target-feature-wrong.rs:22:18\n+   |\n+22 | #[target_feature(disable = \"baz\")]\n+   |                  ^^^^^^^^^^^^^^^\n+\n+error: #[target_feature(..)] can only be applied to `unsafe` function\n+  --> $DIR/target-feature-wrong.rs:26:1\n+   |\n+26 | #[target_feature(enable = \"sse2\")]\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: aborting due to 4 previous errors\n+"}]}