{"sha": "a6417b9c3822a08e27e0f556d76b880e26c0554d", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE2NDE3YjljMzgyMmEwOGUyN2UwZjU1NmQ3NmI4ODBlMjZjMDU1NGQ=", "commit": {"author": {"name": "David Wood", "email": "david@davidtw.co", "date": "2020-06-26T10:21:31Z"}, "committer": {"name": "David Wood", "email": "david@davidtw.co", "date": "2020-06-26T10:21:31Z"}, "message": "improper_ctypes: fix remaining `Reveal:All`\n\nThis commit replaces the remaining uses of `ParamEnv::reveal_all` with\n`LateContext`'s `param_env` (normally `Reveal::UserFacing`).\n\nSigned-off-by: David Wood <david@davidtw.co>", "tree": {"sha": "7ab0930847ae166af9d9123782237a136f6429b8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7ab0930847ae166af9d9123782237a136f6429b8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a6417b9c3822a08e27e0f556d76b880e26c0554d", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEfgm2/wUjk9OnjxlyJZLnbIc4H9kFAl71zWQACgkQJZLnbIc4\nH9nVzw//fCb/n0GwzppiLXKG6idTE0QLVzne9nN3gEeDtziHdCn0n+DQuM3lSE/H\n9H1uDv0oVO1jk0C5IHvLxysuwiKncocaFdgjoNfIIjy19xBxTp5YzzgWxZ8FQlKk\nj72z7gHRTJBtuM35sdTfzQP3tnl3hevhJ2SE+3h6Y8YEcdEBlgjOogxZ2hB+neG/\nGGox7AdyQ6mhiHkzxE0RAu89eqqi05Aq4CzuBC0Y5Gbw/GPWB73MHgKa3Q3ech2W\nh99xKnSQu8mSbIIeuuzpb9h0O+YMhpvGBI6+WlzFeC2OVj7APK9KhfBZBFpKPB04\nc2utCtLUeiAc2fgAfstlU2KOlUVWBpP+hC8VkM7uxSZ5PCbpi+m60NhAKhC8DpL2\nos2Dd6ArAeDCIr3nTTS6gf6kxGwLgn0gkzdBPtnl6wO3I9ZUl9/6ixOWIsG4wWPc\nwRBM52Msgpio+qojuBSIkux+M607ArRaMhQwhixpPgJ/XamLdx98pv65OQ99pJ5X\n5yaKeoTe38kY8Us5gzRlDTfSztMO/EuV3gNS8EtKWeArC5SWGMyihc9W2X199hLV\nUtbzqe+9HARQopuf6n8VH5KR1jk90wFCnqcdwfH7+BnIkEvmzJUDXFIAWtZzoU/8\nz3O/NAtCD/BEKCc076+drb1NS89W8lUp803pzePIQ3m9md5PxbM=\n=hTYk\n-----END PGP SIGNATURE-----", "payload": "tree 7ab0930847ae166af9d9123782237a136f6429b8\nparent e093b6525079cb71d4158f97480ac6f6ce311eac\nauthor David Wood <david@davidtw.co> 1593166891 +0100\ncommitter David Wood <david@davidtw.co> 1593166891 +0100\n\nimproper_ctypes: fix remaining `Reveal:All`\n\nThis commit replaces the remaining uses of `ParamEnv::reveal_all` with\n`LateContext`'s `param_env` (normally `Reveal::UserFacing`).\n\nSigned-off-by: David Wood <david@davidtw.co>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a6417b9c3822a08e27e0f556d76b880e26c0554d", "html_url": "https://github.com/rust-lang/rust/commit/a6417b9c3822a08e27e0f556d76b880e26c0554d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a6417b9c3822a08e27e0f556d76b880e26c0554d/comments", "author": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "committer": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e093b6525079cb71d4158f97480ac6f6ce311eac", "url": "https://api.github.com/repos/rust-lang/rust/commits/e093b6525079cb71d4158f97480ac6f6ce311eac", "html_url": "https://github.com/rust-lang/rust/commit/e093b6525079cb71d4158f97480ac6f6ce311eac"}], "stats": {"total": 128, "additions": 66, "deletions": 62}, "files": [{"sha": "8b9402fcf623e1548db3a10c48c0c64ef89f7ffa", "filename": "src/librustc_lint/types.rs", "status": "modified", "additions": 66, "deletions": 62, "changes": 128, "blob_url": "https://github.com/rust-lang/rust/blob/a6417b9c3822a08e27e0f556d76b880e26c0554d/src%2Flibrustc_lint%2Ftypes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a6417b9c3822a08e27e0f556d76b880e26c0554d/src%2Flibrustc_lint%2Ftypes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_lint%2Ftypes.rs?ref=a6417b9c3822a08e27e0f556d76b880e26c0554d", "patch": "@@ -11,7 +11,7 @@ use rustc_index::vec::Idx;\n use rustc_middle::mir::interpret::{sign_extend, truncate};\n use rustc_middle::ty::layout::{IntegerExt, SizeSkeleton};\n use rustc_middle::ty::subst::SubstsRef;\n-use rustc_middle::ty::{self, AdtKind, ParamEnv, Ty, TyCtxt, TypeFoldable};\n+use rustc_middle::ty::{self, AdtKind, Ty, TypeFoldable};\n use rustc_span::source_map;\n use rustc_span::symbol::sym;\n use rustc_span::{Span, DUMMY_SP};\n@@ -524,78 +524,82 @@ enum FfiResult<'tcx> {\n     FfiUnsafe { ty: Ty<'tcx>, reason: String, help: Option<String> },\n }\n \n-fn ty_is_known_nonnull<'tcx>(tcx: TyCtxt<'tcx>, ty: Ty<'tcx>) -> bool {\n-    match ty.kind {\n-        ty::FnPtr(_) => true,\n-        ty::Ref(..) => true,\n-        ty::Adt(field_def, substs) if field_def.repr.transparent() && !field_def.is_union() => {\n-            for field in field_def.all_fields() {\n-                let field_ty =\n-                    tcx.normalize_erasing_regions(ParamEnv::reveal_all(), field.ty(tcx, substs));\n-                if field_ty.is_zst(tcx, field.did) {\n-                    continue;\n-                }\n+impl<'a, 'tcx> ImproperCTypesVisitor<'a, 'tcx> {\n+    /// Is type known to be non-null?\n+    fn ty_is_known_nonnull(&self, ty: Ty<'tcx>) -> bool {\n+        match ty.kind {\n+            ty::FnPtr(_) => true,\n+            ty::Ref(..) => true,\n+            ty::Adt(field_def, substs) if field_def.repr.transparent() && !field_def.is_union() => {\n+                for field in field_def.all_fields() {\n+                    let field_ty = self.cx.tcx.normalize_erasing_regions(\n+                        self.cx.param_env,\n+                        field.ty(self.cx.tcx, substs),\n+                    );\n+                    if field_ty.is_zst(self.cx.tcx, field.did) {\n+                        continue;\n+                    }\n \n-                let attrs = tcx.get_attrs(field_def.did);\n-                if attrs.iter().any(|a| a.check_name(sym::rustc_nonnull_optimization_guaranteed))\n-                    || ty_is_known_nonnull(tcx, field_ty)\n-                {\n-                    return true;\n+                    let attrs = self.cx.tcx.get_attrs(field_def.did);\n+                    if attrs\n+                        .iter()\n+                        .any(|a| a.check_name(sym::rustc_nonnull_optimization_guaranteed))\n+                        || self.ty_is_known_nonnull(field_ty)\n+                    {\n+                        return true;\n+                    }\n                 }\n-            }\n \n-            false\n+                false\n+            }\n+            _ => false,\n         }\n-        _ => false,\n     }\n-}\n \n-/// Check if this enum can be safely exported based on the\n-/// \"nullable pointer optimization\". Currently restricted\n-/// to function pointers, references, core::num::NonZero*,\n-/// core::ptr::NonNull, and #[repr(transparent)] newtypes.\n-/// FIXME: This duplicates code in codegen.\n-fn is_repr_nullable_ptr<'tcx>(\n-    tcx: TyCtxt<'tcx>,\n-    ty: Ty<'tcx>,\n-    ty_def: &'tcx ty::AdtDef,\n-    substs: SubstsRef<'tcx>,\n-) -> bool {\n-    if ty_def.variants.len() != 2 {\n-        return false;\n-    }\n+    /// Check if this enum can be safely exported based on the \"nullable pointer optimization\".\n+    /// Currently restricted to function pointers, references, `core::num::NonZero*`,\n+    /// `core::ptr::NonNull`, and `#[repr(transparent)]` newtypes.\n+    fn is_repr_nullable_ptr(\n+        &self,\n+        ty: Ty<'tcx>,\n+        ty_def: &'tcx ty::AdtDef,\n+        substs: SubstsRef<'tcx>,\n+    ) -> bool {\n+        if ty_def.variants.len() != 2 {\n+            return false;\n+        }\n \n-    let get_variant_fields = |index| &ty_def.variants[VariantIdx::new(index)].fields;\n-    let variant_fields = [get_variant_fields(0), get_variant_fields(1)];\n-    let fields = if variant_fields[0].is_empty() {\n-        &variant_fields[1]\n-    } else if variant_fields[1].is_empty() {\n-        &variant_fields[0]\n-    } else {\n-        return false;\n-    };\n+        let get_variant_fields = |index| &ty_def.variants[VariantIdx::new(index)].fields;\n+        let variant_fields = [get_variant_fields(0), get_variant_fields(1)];\n+        let fields = if variant_fields[0].is_empty() {\n+            &variant_fields[1]\n+        } else if variant_fields[1].is_empty() {\n+            &variant_fields[0]\n+        } else {\n+            return false;\n+        };\n \n-    if fields.len() != 1 {\n-        return false;\n-    }\n+        if fields.len() != 1 {\n+            return false;\n+        }\n \n-    let field_ty = fields[0].ty(tcx, substs);\n-    if !ty_is_known_nonnull(tcx, field_ty) {\n-        return false;\n-    }\n+        let field_ty = fields[0].ty(self.cx.tcx, substs);\n+        if !self.ty_is_known_nonnull(field_ty) {\n+            return false;\n+        }\n \n-    // At this point, the field's type is known to be nonnull and the parent enum is Option-like.\n-    // If the computed size for the field and the enum are different, the nonnull optimization isn't\n-    // being applied (and we've got a problem somewhere).\n-    let compute_size_skeleton = |t| SizeSkeleton::compute(t, tcx, ParamEnv::reveal_all()).unwrap();\n-    if !compute_size_skeleton(ty).same_size(compute_size_skeleton(field_ty)) {\n-        bug!(\"improper_ctypes: Option nonnull optimization not applied?\");\n-    }\n+        // At this point, the field's type is known to be nonnull and the parent enum is\n+        // Option-like. If the computed size for the field and the enum are different, the non-null\n+        // optimization isn't being applied (and we've got a problem somewhere).\n+        let compute_size_skeleton =\n+            |t| SizeSkeleton::compute(t, self.cx.tcx, self.cx.param_env).unwrap();\n+        if !compute_size_skeleton(ty).same_size(compute_size_skeleton(field_ty)) {\n+            bug!(\"improper_ctypes: Option nonnull optimization not applied?\");\n+        }\n \n-    true\n-}\n+        true\n+    }\n \n-impl<'a, 'tcx> ImproperCTypesVisitor<'a, 'tcx> {\n     /// Check if the type is array and emit an unsafe type lint.\n     fn check_for_array_ty(&mut self, sp: Span, ty: Ty<'tcx>) -> bool {\n         if let ty::Array(..) = ty.kind {\n@@ -737,7 +741,7 @@ impl<'a, 'tcx> ImproperCTypesVisitor<'a, 'tcx> {\n                         // discriminant.\n                         if !def.repr.c() && !def.repr.transparent() && def.repr.int.is_none() {\n                             // Special-case types like `Option<extern fn()>`.\n-                            if !is_repr_nullable_ptr(cx, ty, def, substs) {\n+                            if !self.is_repr_nullable_ptr(ty, def, substs) {\n                                 return FfiUnsafe {\n                                     ty,\n                                     reason: \"enum has no representation hint\".into(),"}]}