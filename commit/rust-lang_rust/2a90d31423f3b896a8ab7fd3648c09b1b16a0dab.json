{"sha": "2a90d31423f3b896a8ab7fd3648c09b1b16a0dab", "node_id": "MDY6Q29tbWl0NzI0NzEyOjJhOTBkMzE0MjNmM2I4OTZhOGFiN2ZkMzY0OGMwOWIxYjE2YTBkYWI=", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2020-09-27T16:37:23Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-09-27T16:37:23Z"}, "message": "Rollup merge of #77249 - jyn514:private-links, r=Manishearth\n\nSeparate `private_intra_doc_links` and `broken_intra_doc_links` into separate lints\n\nThis is not ideal because it means `deny(broken_intra_doc_links)` will\nno longer `deny(private_intra_doc_links)`. However, it can't be fixed\nwith a new lint group, because `broken` is already in the `rustdoc` lint\ngroup; there would need to be a way to nest groups somehow.\n\nThis also removes the early `return` so that the link will be generated\neven though it gives a warning.\n\nr? @Manishearth\ncc @ecstatic-morse (https://github.com/rust-lang/rust/pull/77242#issuecomment-699565095)", "tree": {"sha": "81f5b0d33b7dd7030f69ca552bed502f6669350e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/81f5b0d33b7dd7030f69ca552bed502f6669350e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2a90d31423f3b896a8ab7fd3648c09b1b16a0dab", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfcL/DCRBK7hj4Ov3rIwAAdHIIABE7CedzCm9ZTgWa7yVjS5zp\nbgVNoyRkQ3iVkwYLMBLFvMR+ehxlJpGzlfPjEHSJ+PILMxj0NFUCuYn0juait55i\numd/dDNzmCpd7zY4wzooF8hNuEyOaipZTFWN92PXaBCAVvfuo490q/lMmesPT06F\nxS0DFSI77X3wAQ/k3t7Xqd4fIhdDEes9TMDuJIRn+S0EgxqyXNSI35EakiTCJSvo\nQkb5MKRqAlBKhotd++rV/TiLUnNLj8IS8aleEv4GRXQg6C+lUPcAdaYR8xpFO1Ub\nPMO0gR+xzZEG7bKynDJ1uFZULkD6OsgDqftYl28/kBbMc1dZuyRfAqrOr0RTGUM=\n=9OxC\n-----END PGP SIGNATURE-----\n", "payload": "tree 81f5b0d33b7dd7030f69ca552bed502f6669350e\nparent 9f086fcb0075bd922055ac7923d142544c0d286d\nparent 80ffaed809aa9bf659acf146a26d851f594c0b25\nauthor Jonas Schievink <jonasschievink@gmail.com> 1601224643 +0200\ncommitter GitHub <noreply@github.com> 1601224643 +0200\n\nRollup merge of #77249 - jyn514:private-links, r=Manishearth\n\nSeparate `private_intra_doc_links` and `broken_intra_doc_links` into separate lints\n\nThis is not ideal because it means `deny(broken_intra_doc_links)` will\nno longer `deny(private_intra_doc_links)`. However, it can't be fixed\nwith a new lint group, because `broken` is already in the `rustdoc` lint\ngroup; there would need to be a way to nest groups somehow.\n\nThis also removes the early `return` so that the link will be generated\neven though it gives a warning.\n\nr? @Manishearth\ncc @ecstatic-morse (https://github.com/rust-lang/rust/pull/77242#issuecomment-699565095)\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2a90d31423f3b896a8ab7fd3648c09b1b16a0dab", "html_url": "https://github.com/rust-lang/rust/commit/2a90d31423f3b896a8ab7fd3648c09b1b16a0dab", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2a90d31423f3b896a8ab7fd3648c09b1b16a0dab/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9f086fcb0075bd922055ac7923d142544c0d286d", "url": "https://api.github.com/repos/rust-lang/rust/commits/9f086fcb0075bd922055ac7923d142544c0d286d", "html_url": "https://github.com/rust-lang/rust/commit/9f086fcb0075bd922055ac7923d142544c0d286d"}, {"sha": "80ffaed809aa9bf659acf146a26d851f594c0b25", "url": "https://api.github.com/repos/rust-lang/rust/commits/80ffaed809aa9bf659acf146a26d851f594c0b25", "html_url": "https://github.com/rust-lang/rust/commit/80ffaed809aa9bf659acf146a26d851f594c0b25"}], "stats": {"total": 87, "additions": 75, "deletions": 12}, "files": [{"sha": "33caedfc198260f846c51c3f6fbabe54d69ee932", "filename": "compiler/rustc_lint/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/2a90d31423f3b896a8ab7fd3648c09b1b16a0dab/compiler%2Frustc_lint%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2a90d31423f3b896a8ab7fd3648c09b1b16a0dab/compiler%2Frustc_lint%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_lint%2Fsrc%2Flib.rs?ref=2a90d31423f3b896a8ab7fd3648c09b1b16a0dab", "patch": "@@ -305,6 +305,7 @@ fn register_builtins(store: &mut LintStore, no_interleave_lints: bool) {\n     add_lint_group!(\n         \"rustdoc\",\n         BROKEN_INTRA_DOC_LINKS,\n+        PRIVATE_INTRA_DOC_LINKS,\n         INVALID_CODEBLOCK_ATTRIBUTES,\n         MISSING_DOC_CODE_EXAMPLES,\n         PRIVATE_DOC_TESTS"}, {"sha": "0cc97fb4541d194adba5fc535c260a0a8c565e59", "filename": "compiler/rustc_session/src/lint/builtin.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/2a90d31423f3b896a8ab7fd3648c09b1b16a0dab/compiler%2Frustc_session%2Fsrc%2Flint%2Fbuiltin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2a90d31423f3b896a8ab7fd3648c09b1b16a0dab/compiler%2Frustc_session%2Fsrc%2Flint%2Fbuiltin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Flint%2Fbuiltin.rs?ref=2a90d31423f3b896a8ab7fd3648c09b1b16a0dab", "patch": "@@ -1826,6 +1826,17 @@ declare_lint! {\n     \"failures in resolving intra-doc link targets\"\n }\n \n+declare_lint! {\n+    /// This is a subset of `broken_intra_doc_links` that warns when linking from\n+    /// a public item to a private one. This is a `rustdoc` only lint, see the\n+    /// documentation in the [rustdoc book].\n+    ///\n+    /// [rustdoc book]: ../../../rustdoc/lints.html#private_intra_doc_links\n+    pub PRIVATE_INTRA_DOC_LINKS,\n+    Warn,\n+    \"linking from a public item to a private one\"\n+}\n+\n declare_lint! {\n     /// The `invalid_codeblock_attributes` lint detects code block attributes\n     /// in documentation examples that have potentially mis-typed values. This"}, {"sha": "3e632a0644a732f425a218a97832dadb807ece2d", "filename": "src/doc/rustdoc/src/lints.md", "status": "modified", "additions": 40, "deletions": 0, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/2a90d31423f3b896a8ab7fd3648c09b1b16a0dab/src%2Fdoc%2Frustdoc%2Fsrc%2Flints.md", "raw_url": "https://github.com/rust-lang/rust/raw/2a90d31423f3b896a8ab7fd3648c09b1b16a0dab/src%2Fdoc%2Frustdoc%2Fsrc%2Flints.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fdoc%2Frustdoc%2Fsrc%2Flints.md?ref=2a90d31423f3b896a8ab7fd3648c09b1b16a0dab", "patch": "@@ -62,6 +62,46 @@ help: to link to the function, add parentheses\n \n ```\n \n+## private_intra_doc_links\n+\n+This lint **warns by default**. This lint detects when [intra-doc links] from public to private items.\n+For example:\n+\n+```rust\n+/// [private]\n+pub fn public() {}\n+fn private() {}\n+```\n+\n+This gives a warning that the link will be broken when it appears in your documentation:\n+\n+```text\n+warning: public documentation for `public` links to private item `private`\n+ --> priv.rs:1:6\n+  |\n+1 | /// [private]\n+  |      ^^^^^^^ this item is private\n+  |\n+  = note: `#[warn(private_intra_doc_links)]` on by default\n+  = note: this link will resolve properly if you pass `--document-private-items`\n+```\n+\n+Note that this has different behavior depending on whether you pass `--document-private-items` or not!\n+If you document private items, then it will still generate a link, despite the warning:\n+\n+```text\n+warning: public documentation for `public` links to private item `private`\n+ --> priv.rs:1:6\n+  |\n+1 | /// [private]\n+  |      ^^^^^^^ this item is private\n+  |\n+  = note: `#[warn(private_intra_doc_links)]` on by default\n+  = note: this link resolves only because you passed `--document-private-items`, but will break without\n+```\n+\n+[intra-doc links]: linking-to-items-by-name.html\n+\n ## missing_docs\n \n This lint is **allowed by default**. It detects items missing documentation."}, {"sha": "cd6a7feb18029a1ae6b4c9148138a9f0fc86a849", "filename": "src/librustdoc/passes/collect_intra_doc_links.rs", "status": "modified", "additions": 13, "deletions": 8, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/2a90d31423f3b896a8ab7fd3648c09b1b16a0dab/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2a90d31423f3b896a8ab7fd3648c09b1b16a0dab/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs?ref=2a90d31423f3b896a8ab7fd3648c09b1b16a0dab", "patch": "@@ -11,7 +11,10 @@ use rustc_hir::def::{\n use rustc_hir::def_id::DefId;\n use rustc_middle::ty;\n use rustc_resolve::ParentScope;\n-use rustc_session::lint;\n+use rustc_session::lint::{\n+    builtin::{BROKEN_INTRA_DOC_LINKS, PRIVATE_INTRA_DOC_LINKS},\n+    Lint,\n+};\n use rustc_span::hygiene::MacroKind;\n use rustc_span::symbol::Ident;\n use rustc_span::symbol::Symbol;\n@@ -988,7 +991,7 @@ impl LinkCollector<'_, '_> {\n         let report_mismatch = |specified: Disambiguator, resolved: Disambiguator| {\n             // The resolved item did not match the disambiguator; give a better error than 'not found'\n             let msg = format!(\"incompatible link kind for `{}`\", path_str);\n-            report_diagnostic(cx, &msg, &item, dox, &link_range, |diag, sp| {\n+            let callback = |diag: &mut DiagnosticBuilder<'_>, sp| {\n                 let note = format!(\n                     \"this link resolved to {} {}, which is not {} {}\",\n                     resolved.article(),\n@@ -998,7 +1001,8 @@ impl LinkCollector<'_, '_> {\n                 );\n                 diag.note(&note);\n                 suggest_disambiguator(resolved, diag, path_str, dox, sp, &link_range);\n-            });\n+            };\n+            report_diagnostic(cx, BROKEN_INTRA_DOC_LINKS, &msg, &item, dox, &link_range, callback);\n         };\n         if let Res::PrimTy(..) = res {\n             match disambiguator {\n@@ -1055,7 +1059,6 @@ impl LinkCollector<'_, '_> {\n                     && !self.cx.tcx.privacy_access_levels(LOCAL_CRATE).is_exported(hir_dst)\n                 {\n                     privacy_error(cx, &item, &path_str, dox, link_range);\n-                    return;\n                 }\n             }\n             let id = register_res(cx, res);\n@@ -1417,6 +1420,7 @@ impl Suggestion {\n /// to it.\n fn report_diagnostic(\n     cx: &DocContext<'_>,\n+    lint: &'static Lint,\n     msg: &str,\n     item: &Item,\n     dox: &str,\n@@ -1435,7 +1439,7 @@ fn report_diagnostic(\n     let attrs = &item.attrs;\n     let sp = span_of_attrs(attrs).unwrap_or(item.source.span());\n \n-    cx.tcx.struct_span_lint_hir(lint::builtin::BROKEN_INTRA_DOC_LINKS, hir_id, sp, |lint| {\n+    cx.tcx.struct_span_lint_hir(lint, hir_id, sp, |lint| {\n         let mut diag = lint.build(msg);\n \n         let span = link_range\n@@ -1482,6 +1486,7 @@ fn resolution_failure(\n ) {\n     report_diagnostic(\n         collector.cx,\n+        BROKEN_INTRA_DOC_LINKS,\n         &format!(\"unresolved link to `{}`\", path_str),\n         item,\n         dox,\n@@ -1695,7 +1700,7 @@ fn anchor_failure(\n         ),\n     };\n \n-    report_diagnostic(cx, &msg, item, dox, &link_range, |diag, sp| {\n+    report_diagnostic(cx, BROKEN_INTRA_DOC_LINKS, &msg, item, dox, &link_range, |diag, sp| {\n         if let Some(sp) = sp {\n             diag.span_label(sp, \"contains invalid anchor\");\n         }\n@@ -1734,7 +1739,7 @@ fn ambiguity_error(\n         }\n     }\n \n-    report_diagnostic(cx, &msg, item, dox, &link_range, |diag, sp| {\n+    report_diagnostic(cx, BROKEN_INTRA_DOC_LINKS, &msg, item, dox, &link_range, |diag, sp| {\n         if let Some(sp) = sp {\n             diag.span_label(sp, \"ambiguous link\");\n         } else {\n@@ -1784,7 +1789,7 @@ fn privacy_error(\n     let msg =\n         format!(\"public documentation for `{}` links to private item `{}`\", item_name, path_str);\n \n-    report_diagnostic(cx, &msg, item, dox, &link_range, |diag, sp| {\n+    report_diagnostic(cx, PRIVATE_INTRA_DOC_LINKS, &msg, item, dox, &link_range, |diag, sp| {\n         if let Some(sp) = sp {\n             diag.span_label(sp, \"this item is private\");\n         }"}, {"sha": "eeef24b479747422b5a3cf037faff9643faf70d8", "filename": "src/test/rustdoc-ui/intra-links-private.private.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/2a90d31423f3b896a8ab7fd3648c09b1b16a0dab/src%2Ftest%2Frustdoc-ui%2Fintra-links-private.private.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2a90d31423f3b896a8ab7fd3648c09b1b16a0dab/src%2Ftest%2Frustdoc-ui%2Fintra-links-private.private.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fintra-links-private.private.stderr?ref=2a90d31423f3b896a8ab7fd3648c09b1b16a0dab", "patch": "@@ -4,7 +4,7 @@ warning: public documentation for `DocMe` links to private item `DontDocMe`\n LL | /// docs [DontDocMe]\n    |           ^^^^^^^^^ this item is private\n    |\n-   = note: `#[warn(broken_intra_doc_links)]` on by default\n+   = note: `#[warn(private_intra_doc_links)]` on by default\n    = note: this link resolves only because you passed `--document-private-items`, but will break without\n \n warning: 1 warning emitted"}, {"sha": "3f7b17586f19e72338619ce608617c7f985c61b3", "filename": "src/test/rustdoc-ui/intra-links-private.public.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/2a90d31423f3b896a8ab7fd3648c09b1b16a0dab/src%2Ftest%2Frustdoc-ui%2Fintra-links-private.public.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2a90d31423f3b896a8ab7fd3648c09b1b16a0dab/src%2Ftest%2Frustdoc-ui%2Fintra-links-private.public.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fintra-links-private.public.stderr?ref=2a90d31423f3b896a8ab7fd3648c09b1b16a0dab", "patch": "@@ -4,7 +4,7 @@ warning: public documentation for `DocMe` links to private item `DontDocMe`\n LL | /// docs [DontDocMe]\n    |           ^^^^^^^^^ this item is private\n    |\n-   = note: `#[warn(broken_intra_doc_links)]` on by default\n+   = note: `#[warn(private_intra_doc_links)]` on by default\n    = note: this link will resolve properly if you pass `--document-private-items`\n \n warning: 1 warning emitted"}, {"sha": "b802d7e12523a1e1c0b0a505aedaa1327af793a9", "filename": "src/test/rustdoc-ui/issue-74134.private.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/2a90d31423f3b896a8ab7fd3648c09b1b16a0dab/src%2Ftest%2Frustdoc-ui%2Fissue-74134.private.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2a90d31423f3b896a8ab7fd3648c09b1b16a0dab/src%2Ftest%2Frustdoc-ui%2Fissue-74134.private.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fissue-74134.private.stderr?ref=2a90d31423f3b896a8ab7fd3648c09b1b16a0dab", "patch": "@@ -4,7 +4,7 @@ warning: public documentation for `public_item` links to private item `PrivateTy\n LL |     /// [`PrivateType`]\n    |          ^^^^^^^^^^^^^ this item is private\n    |\n-   = note: `#[warn(broken_intra_doc_links)]` on by default\n+   = note: `#[warn(private_intra_doc_links)]` on by default\n    = note: this link resolves only because you passed `--document-private-items`, but will break without\n \n warning: 1 warning emitted"}, {"sha": "40aa2ece1a373e330a41d05f45b97ee86b7d4ac5", "filename": "src/test/rustdoc-ui/issue-74134.public.stderr", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/2a90d31423f3b896a8ab7fd3648c09b1b16a0dab/src%2Ftest%2Frustdoc-ui%2Fissue-74134.public.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/2a90d31423f3b896a8ab7fd3648c09b1b16a0dab/src%2Ftest%2Frustdoc-ui%2Fissue-74134.public.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-ui%2Fissue-74134.public.stderr?ref=2a90d31423f3b896a8ab7fd3648c09b1b16a0dab", "patch": "@@ -4,7 +4,7 @@ warning: public documentation for `public_item` links to private item `PrivateTy\n LL |     /// [`PrivateType`]\n    |          ^^^^^^^^^^^^^ this item is private\n    |\n-   = note: `#[warn(broken_intra_doc_links)]` on by default\n+   = note: `#[warn(private_intra_doc_links)]` on by default\n    = note: this link will resolve properly if you pass `--document-private-items`\n \n warning: 1 warning emitted"}, {"sha": "f86ca44403d93e42ae9b752d7bb3fdc588263ded", "filename": "src/test/rustdoc/intra-doc-link-private.rs", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/2a90d31423f3b896a8ab7fd3648c09b1b16a0dab/src%2Ftest%2Frustdoc%2Fintra-doc-link-private.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2a90d31423f3b896a8ab7fd3648c09b1b16a0dab/src%2Ftest%2Frustdoc%2Fintra-doc-link-private.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fintra-doc-link-private.rs?ref=2a90d31423f3b896a8ab7fd3648c09b1b16a0dab", "patch": "@@ -0,0 +1,6 @@\n+#![crate_name = \"private\"]\n+// compile-flags: --document-private-items\n+/// docs [DontDocMe]\n+// @has private/struct.DocMe.html '//*a[@href=\"../private/struct.DontDocMe.html\"]' 'DontDocMe'\n+pub struct DocMe;\n+struct DontDocMe;"}]}