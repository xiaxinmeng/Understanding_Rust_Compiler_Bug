{"sha": "c41fd760dbab005e8f4038ec67eba17ab60e6a98", "node_id": "C_kwDOAAsO6NoAKGM0MWZkNzYwZGJhYjAwNWU4ZjQwMzhlYzY3ZWJhMTdhYjYwZTZhOTg", "commit": {"author": {"name": "Patrick Walton", "email": "pcwalton@fb.com", "date": "2021-12-17T04:39:41Z"}, "committer": {"name": "Patrick Walton", "email": "pcwalton@fb.com", "date": "2021-12-17T04:40:04Z"}, "message": "rustc_codegen_llvm: Give each codegen unit a unique DWARF name on all\nplatforms, not just Apple ones.\n\nTo avoid breaking split DWARF, we need to ensure that each codegen unit has a\nunique `DW_AT_name`. This is because there's a remote chance that different\ncodegen units for the same module will have entirely identical DWARF entries\nfor the purpose of the DWO ID, which would violate Appendix F (\"Split Dwarf\nObject Files\") of the DWARF 5 specification. LLVM uses the algorithm specified\nin section 7.32 \"Type Signature Computation\" to compute the DWO ID, which does\nnot include any fields that would distinguish compilation units. So we must\nembed the codegen unit name into the `DW_AT_name`.\n\nCloses #88521.", "tree": {"sha": "7b9d65ffa458256d60c39fb251a94f018da4b6f2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7b9d65ffa458256d60c39fb251a94f018da4b6f2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c41fd760dbab005e8f4038ec67eba17ab60e6a98", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c41fd760dbab005e8f4038ec67eba17ab60e6a98", "html_url": "https://github.com/rust-lang/rust/commit/c41fd760dbab005e8f4038ec67eba17ab60e6a98", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c41fd760dbab005e8f4038ec67eba17ab60e6a98/comments", "author": {"login": "pcwalton", "id": 157897, "node_id": "MDQ6VXNlcjE1Nzg5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/157897?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pcwalton", "html_url": "https://github.com/pcwalton", "followers_url": "https://api.github.com/users/pcwalton/followers", "following_url": "https://api.github.com/users/pcwalton/following{/other_user}", "gists_url": "https://api.github.com/users/pcwalton/gists{/gist_id}", "starred_url": "https://api.github.com/users/pcwalton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pcwalton/subscriptions", "organizations_url": "https://api.github.com/users/pcwalton/orgs", "repos_url": "https://api.github.com/users/pcwalton/repos", "events_url": "https://api.github.com/users/pcwalton/events{/privacy}", "received_events_url": "https://api.github.com/users/pcwalton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pcwalton", "id": 157897, "node_id": "MDQ6VXNlcjE1Nzg5Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/157897?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pcwalton", "html_url": "https://github.com/pcwalton", "followers_url": "https://api.github.com/users/pcwalton/followers", "following_url": "https://api.github.com/users/pcwalton/following{/other_user}", "gists_url": "https://api.github.com/users/pcwalton/gists{/gist_id}", "starred_url": "https://api.github.com/users/pcwalton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pcwalton/subscriptions", "organizations_url": "https://api.github.com/users/pcwalton/orgs", "repos_url": "https://api.github.com/users/pcwalton/repos", "events_url": "https://api.github.com/users/pcwalton/events{/privacy}", "received_events_url": "https://api.github.com/users/pcwalton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c5ecc157043ba413568b09292001a4a74b541a4e", "url": "https://api.github.com/repos/rust-lang/rust/commits/c5ecc157043ba413568b09292001a4a74b541a4e", "html_url": "https://github.com/rust-lang/rust/commit/c5ecc157043ba413568b09292001a4a74b541a4e"}], "stats": {"total": 27, "additions": 19, "deletions": 8}, "files": [{"sha": "c2c815c2b784841e63379bad430a4085b629abb6", "filename": "compiler/rustc_codegen_llvm/src/debuginfo/metadata.rs", "status": "modified", "additions": 19, "deletions": 8, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/c41fd760dbab005e8f4038ec67eba17ab60e6a98/compiler%2Frustc_codegen_llvm%2Fsrc%2Fdebuginfo%2Fmetadata.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c41fd760dbab005e8f4038ec67eba17ab60e6a98/compiler%2Frustc_codegen_llvm%2Fsrc%2Fdebuginfo%2Fmetadata.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fdebuginfo%2Fmetadata.rs?ref=c41fd760dbab005e8f4038ec67eba17ab60e6a98", "patch": "@@ -1036,14 +1036,25 @@ pub fn compile_unit_metadata(\n         None => PathBuf::from(&*tcx.crate_name(LOCAL_CRATE).as_str()),\n     };\n \n-    // The OSX linker has an idiosyncrasy where it will ignore some debuginfo\n-    // if multiple object files with the same `DW_AT_name` are linked together.\n-    // As a workaround we generate unique names for each object file. Those do\n-    // not correspond to an actual source file but that is harmless.\n-    if tcx.sess.target.is_like_osx {\n-        name_in_debuginfo.push(\"@\");\n-        name_in_debuginfo.push(codegen_unit_name);\n-    }\n+    // To avoid breaking split DWARF, we need to ensure that each codegen unit\n+    // has a unique `DW_AT_name`. This is because there's a remote chance that\n+    // different codegen units for the same module will have entirely\n+    // identical DWARF entries for the purpose of the DWO ID, which would\n+    // violate Appendix F (\"Split Dwarf Object Files\") of the DWARF 5\n+    // specification. LLVM uses the algorithm specified in section 7.32 \"Type\n+    // Signature Computation\" to compute the DWO ID, which does not include\n+    // any fields that would distinguish compilation units. So we must embed\n+    // the codegen unit name into the `DW_AT_name`. (Issue #88521.)\n+    //\n+    // Additionally, the OSX linker has an idiosyncrasy where it will ignore\n+    // some debuginfo if multiple object files with the same `DW_AT_name` are\n+    // linked together.\n+    //\n+    // As a workaround for these two issues, we generate unique names for each\n+    // object file. Those do not correspond to an actual source file but that\n+    // is harmless.\n+    name_in_debuginfo.push(\"@\");\n+    name_in_debuginfo.push(codegen_unit_name);\n \n     debug!(\"compile_unit_metadata: {:?}\", name_in_debuginfo);\n     let rustc_producer ="}]}