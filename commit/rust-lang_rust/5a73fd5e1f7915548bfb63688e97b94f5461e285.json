{"sha": "5a73fd5e1f7915548bfb63688e97b94f5461e285", "node_id": "MDY6Q29tbWl0NzI0NzEyOjVhNzNmZDVlMWY3OTE1NTQ4YmZiNjM2ODhlOTdiOTRmNTQ2MWUyODU=", "commit": {"author": {"name": "Fabian Zaiser", "email": "fabian.zaiser@gmail.com", "date": "2018-04-03T15:53:13Z"}, "committer": {"name": "Fabian Zaiser", "email": "fabian.zaiser@gmail.com", "date": "2018-04-15T21:32:57Z"}, "message": "Implement Chalk lowering rule Normalize-From-Impl", "tree": {"sha": "96a32ceaa4797dd73464ee83f51876859ab4d30b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/96a32ceaa4797dd73464ee83f51876859ab4d30b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5a73fd5e1f7915548bfb63688e97b94f5461e285", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5a73fd5e1f7915548bfb63688e97b94f5461e285", "html_url": "https://github.com/rust-lang/rust/commit/5a73fd5e1f7915548bfb63688e97b94f5461e285", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5a73fd5e1f7915548bfb63688e97b94f5461e285/comments", "author": {"login": "fanzier", "id": 5846332, "node_id": "MDQ6VXNlcjU4NDYzMzI=", "avatar_url": "https://avatars.githubusercontent.com/u/5846332?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fanzier", "html_url": "https://github.com/fanzier", "followers_url": "https://api.github.com/users/fanzier/followers", "following_url": "https://api.github.com/users/fanzier/following{/other_user}", "gists_url": "https://api.github.com/users/fanzier/gists{/gist_id}", "starred_url": "https://api.github.com/users/fanzier/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fanzier/subscriptions", "organizations_url": "https://api.github.com/users/fanzier/orgs", "repos_url": "https://api.github.com/users/fanzier/repos", "events_url": "https://api.github.com/users/fanzier/events{/privacy}", "received_events_url": "https://api.github.com/users/fanzier/received_events", "type": "User", "site_admin": false}, "committer": {"login": "fanzier", "id": 5846332, "node_id": "MDQ6VXNlcjU4NDYzMzI=", "avatar_url": "https://avatars.githubusercontent.com/u/5846332?v=4", "gravatar_id": "", "url": "https://api.github.com/users/fanzier", "html_url": "https://github.com/fanzier", "followers_url": "https://api.github.com/users/fanzier/followers", "following_url": "https://api.github.com/users/fanzier/following{/other_user}", "gists_url": "https://api.github.com/users/fanzier/gists{/gist_id}", "starred_url": "https://api.github.com/users/fanzier/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/fanzier/subscriptions", "organizations_url": "https://api.github.com/users/fanzier/orgs", "repos_url": "https://api.github.com/users/fanzier/repos", "events_url": "https://api.github.com/users/fanzier/events{/privacy}", "received_events_url": "https://api.github.com/users/fanzier/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7360d6dd678d186d9c9b46311b75ba6840e61aa2", "url": "https://api.github.com/repos/rust-lang/rust/commits/7360d6dd678d186d9c9b46311b75ba6840e61aa2", "html_url": "https://github.com/rust-lang/rust/commit/7360d6dd678d186d9c9b46311b75ba6840e61aa2"}], "stats": {"total": 86, "additions": 81, "deletions": 5}, "files": [{"sha": "b568273c650d3d88a4b5ec679e995b1af636432d", "filename": "src/librustc/ich/impls_ty.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/5a73fd5e1f7915548bfb63688e97b94f5461e285/src%2Flibrustc%2Fich%2Fimpls_ty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5a73fd5e1f7915548bfb63688e97b94f5461e285/src%2Flibrustc%2Fich%2Fimpls_ty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fich%2Fimpls_ty.rs?ref=5a73fd5e1f7915548bfb63688e97b94f5461e285", "patch": "@@ -1388,6 +1388,7 @@ impl<'a, 'tcx> HashStable<StableHashingContext<'a>> for traits::DomainGoal<'tcx>\n             FromEnv(where_clause) => where_clause.hash_stable(hcx, hasher),\n \n             WellFormedTy(ty) => ty.hash_stable(hcx, hasher),\n+            Normalize(projection) => projection.hash_stable(hcx, hasher),\n             FromEnvTy(ty) => ty.hash_stable(hcx, hasher),\n             RegionOutlives(predicate) => predicate.hash_stable(hcx, hasher),\n             TypeOutlives(predicate) => predicate.hash_stable(hcx, hasher),"}, {"sha": "8d2398d34090d8d6f8ddc327150ef42466141217", "filename": "src/librustc/traits/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/5a73fd5e1f7915548bfb63688e97b94f5461e285/src%2Flibrustc%2Ftraits%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5a73fd5e1f7915548bfb63688e97b94f5461e285/src%2Flibrustc%2Ftraits%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ftraits%2Fmod.rs?ref=5a73fd5e1f7915548bfb63688e97b94f5461e285", "patch": "@@ -266,6 +266,7 @@ pub enum DomainGoal<'tcx> {\n     WellFormed(WhereClauseAtom<'tcx>),\n     FromEnv(WhereClauseAtom<'tcx>),\n     WellFormedTy(Ty<'tcx>),\n+    Normalize(ty::ProjectionPredicate<'tcx>),\n     FromEnvTy(Ty<'tcx>),\n     RegionOutlives(ty::RegionOutlivesPredicate<'tcx>),\n     TypeOutlives(ty::TypeOutlivesPredicate<'tcx>),"}, {"sha": "31c5bf1bbad84fd45870dd2b302f4b283d4e72bb", "filename": "src/librustc/traits/structural_impls.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/5a73fd5e1f7915548bfb63688e97b94f5461e285/src%2Flibrustc%2Ftraits%2Fstructural_impls.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5a73fd5e1f7915548bfb63688e97b94f5461e285/src%2Flibrustc%2Ftraits%2Fstructural_impls.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ftraits%2Fstructural_impls.rs?ref=5a73fd5e1f7915548bfb63688e97b94f5461e285", "patch": "@@ -450,6 +450,7 @@ impl<'tcx> fmt::Display for traits::DomainGoal<'tcx> {\n             FromEnv(Implemented(trait_ref)) => write!(fmt, \"FromEnv({})\", trait_ref),\n             FromEnv(ProjectionEq(projection)) => write!(fmt, \"FromEnv({})\", projection),\n             WellFormedTy(ty) => write!(fmt, \"WellFormed({})\", ty),\n+            Normalize(projection) => write!(fmt, \"Normalize({})\", projection),\n             FromEnvTy(ty) => write!(fmt, \"FromEnv({})\", ty),\n             RegionOutlives(predicate) => write!(fmt, \"RegionOutlives({})\", predicate),\n             TypeOutlives(predicate) => write!(fmt, \"TypeOutlives({})\", predicate),\n@@ -538,6 +539,7 @@ EnumTypeFoldableImpl! {\n         (traits::DomainGoal::WellFormed)(wc),\n         (traits::DomainGoal::FromEnv)(wc),\n         (traits::DomainGoal::WellFormedTy)(ty),\n+        (traits::DomainGoal::Normalize)(projection),\n         (traits::DomainGoal::FromEnvTy)(ty),\n         (traits::DomainGoal::RegionOutlives)(predicate),\n         (traits::DomainGoal::TypeOutlives)(predicate),"}, {"sha": "b418a0aca9a3a0c28dff3a47033b2c2618b2c9f8", "filename": "src/librustc_traits/lowering.rs", "status": "modified", "additions": 61, "deletions": 4, "changes": 65, "blob_url": "https://github.com/rust-lang/rust/blob/5a73fd5e1f7915548bfb63688e97b94f5461e285/src%2Flibrustc_traits%2Flowering.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5a73fd5e1f7915548bfb63688e97b94f5461e285/src%2Flibrustc_traits%2Flowering.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_traits%2Flowering.rs?ref=5a73fd5e1f7915548bfb63688e97b94f5461e285", "patch": "@@ -118,10 +118,20 @@ crate fn program_clauses_for<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>, def_id: DefI\n                                        -> Lrc<&'tcx Slice<Clause<'tcx>>>\n {\n     let node_id = tcx.hir.as_local_node_id(def_id).unwrap();\n-    let item = tcx.hir.expect_item(node_id);\n-    match item.node {\n-        hir::ItemTrait(..) => program_clauses_for_trait(tcx, def_id),\n-        hir::ItemImpl(..) => program_clauses_for_impl(tcx, def_id),\n+    let node = tcx.hir.find(node_id).unwrap();\n+    match node {\n+        hir::map::Node::NodeItem(item) => match item.node {\n+            hir::ItemTrait(..) => program_clauses_for_trait(tcx, def_id),\n+            hir::ItemImpl(..) => program_clauses_for_impl(tcx, def_id),\n+            _ => Lrc::new(vec![]),\n+        }\n+        hir::map::Node::NodeImplItem(item) => {\n+            if let hir::ImplItemKind::Type(..) = item.node {\n+                program_clauses_for_associated_type(tcx, def_id)\n+            } else {\n+                Lrc::new(vec![])\n+            }\n+        },\n \n         // FIXME: other constructions e.g. traits, associated types...\n         _ => Lrc::new(tcx.mk_clauses(iter::empty::<Clause>())),\n@@ -233,6 +243,53 @@ fn program_clauses_for_impl<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>, def_id: DefId\n     Lrc::new(tcx.mk_clauses(iter::once(Clause::ForAll(ty::Binder::dummy(clause)))))\n }\n \n+pub fn program_clauses_for_associated_type<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>, item_id: DefId)\n+    -> Lrc<Vec<Clause<'tcx>>> {\n+    // Rule Normalize-From-Impl (see rustc guide)\n+    //\n+    // ```impl<P0..Pn> Trait<A1..An> for A0\n+    // where WC\n+    // {\n+    //     type AssocType<Pn+1..Pm> where WC1 = T;\n+    // }```\n+    //\n+    // ```\n+    // forall<P0..Pm> {\n+    //   forall<Pn+1..Pm> {\n+    //     Normalize(<A0 as Trait<A1..An>>::AssocType<Pn+1..Pm> -> T) :-\n+    //       WC && WC1\n+    //   }\n+    // }\n+    // ```\n+\n+    let item = tcx.associated_item(item_id);\n+    debug_assert_eq!(item.kind, ty::AssociatedKind::Type);\n+    let impl_id = if let ty::AssociatedItemContainer::ImplContainer(impl_id) = item.container {\n+        impl_id\n+    } else {\n+        bug!()\n+    };\n+    // `A0 as Trait<A1..An>`\n+    let trait_ref = tcx.impl_trait_ref(impl_id).unwrap();\n+    // `T`\n+    let ty = tcx.type_of(item_id);\n+    // `WC`\n+    let impl_where_clauses = tcx.predicates_of(impl_id).predicates.lower();\n+    // `WC1`\n+    let item_where_clauses = tcx.predicates_of(item_id).predicates.lower();\n+    // `WC && WC1`\n+    let mut where_clauses = vec![];\n+    where_clauses.extend(impl_where_clauses);\n+    where_clauses.extend(item_where_clauses);\n+    // `<A0 as Trait<A1..An>>::AssocType<Pn+1..Pm>`\n+    let projection_ty = ty::ProjectionTy::from_ref_and_name(tcx, trait_ref, item.name);\n+    // `Normalize(<A0 as Trait<A1..An>>::AssocType<Pn+1..Pm> -> T)`\n+    let normalize_goal = DomainGoal::Normalize(ty::ProjectionPredicate { projection_ty, ty });\n+    // `Normalize(... -> T) :- WC && WC1`\n+    let clause = Clause::Implies(where_clauses, normalize_goal);\n+    Lrc::new(vec![clause])\n+}\n+\n pub fn dump_program_clauses<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>) {\n     if !tcx.features().rustc_attrs {\n         return;"}, {"sha": "671d77efbea3aac7f50850cdfef324cbdb481415", "filename": "src/test/ui/chalkify/lower_impl.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/5a73fd5e1f7915548bfb63688e97b94f5461e285/src%2Ftest%2Fui%2Fchalkify%2Flower_impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5a73fd5e1f7915548bfb63688e97b94f5461e285/src%2Ftest%2Fui%2Fchalkify%2Flower_impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fchalkify%2Flower_impl.rs?ref=5a73fd5e1f7915548bfb63688e97b94f5461e285", "patch": "@@ -15,6 +15,15 @@ trait Foo { }\n #[rustc_dump_program_clauses] //~ ERROR Implemented(T: Foo) :-\n impl<T: 'static> Foo for T where T: Iterator<Item = i32> { }\n \n+trait Bar {\n+    type Assoc;\n+}\n+\n+impl<T> Bar for T where T: Iterator<Item = i32> {\n+    #[rustc_dump_program_clauses] //~ ERROR Normalize(<T as Bar>::Assoc == std::vec::Vec<T>) :-\n+    type Assoc = Vec<T>;\n+}\n+\n fn main() {\n     println!(\"hello\");\n }"}, {"sha": "5a32b8567b99fd5c4eb826176329b2d0ff272ddf", "filename": "src/test/ui/chalkify/lower_impl.stderr", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/5a73fd5e1f7915548bfb63688e97b94f5461e285/src%2Ftest%2Fui%2Fchalkify%2Flower_impl.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/5a73fd5e1f7915548bfb63688e97b94f5461e285/src%2Ftest%2Fui%2Fchalkify%2Flower_impl.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fchalkify%2Flower_impl.stderr?ref=5a73fd5e1f7915548bfb63688e97b94f5461e285", "patch": "@@ -4,5 +4,11 @@ error: Implemented(T: Foo) :- ProjectionEq(<T as std::iter::Iterator>::Item == i\n LL | #[rustc_dump_program_clauses] //~ ERROR Implemented(T: Foo) :-\n    | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n-error: aborting due to previous error\n+error: Normalize(<T as Bar>::Assoc == std::vec::Vec<T>) :- ProjectionEq(<T as std::iter::Iterator>::Item == i32), Implemented(T: std::iter::Iterator), Implemented(T: std::marker::Sized).\n+  --> $DIR/lower_impl.rs:23:5\n+   |\n+LL |     #[rustc_dump_program_clauses] //~ ERROR Normalize(<T as Bar>::Assoc == std::vec::Vec<T>) :-\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+\n+error: aborting due to 2 previous errors\n "}]}