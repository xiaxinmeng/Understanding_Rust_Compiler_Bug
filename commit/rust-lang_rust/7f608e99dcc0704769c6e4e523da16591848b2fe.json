{"sha": "7f608e99dcc0704769c6e4e523da16591848b2fe", "node_id": "C_kwDOAAsO6NoAKDdmNjA4ZTk5ZGNjMDcwNDc2OWM2ZTRlNTIzZGExNjU5MTg0OGIyZmU", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2022-07-27T02:52:56Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-07-27T02:52:56Z"}, "message": "Rollup merge of #99759 - bjorn3:remove_llvm_dead_code, r=nikic\n\nRemove dead code from cg_llvm\n\nFound while working on https://github.com/rust-lang/rust/pull/97485", "tree": {"sha": "9a1b7662a44fb7c4301b65ae7c8e1bb4459c91f0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9a1b7662a44fb7c4301b65ae7c8e1bb4459c91f0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7f608e99dcc0704769c6e4e523da16591848b2fe", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJi4KiICRBK7hj4Ov3rIwAAbqsIADFhy3aAyTFzh0411YEfSM0R\nVPc61AawhLiN+IAtN7/6KZfLtZLV8lybeaubsdFE5avWQwyRE9Hsd91TMOc8dAlC\nRCtWOZHfMmUOelYtkmeDrfdT4gJ9EyFWt4OhguKn6+lchYAcRATtlB8rKIYQqHZu\n/RvRIK6dshZYHqS3OvbFK3lMa5aI8FaMoyj6+pf/et5FE7Hnb7LnHlFarn/E9mFk\net5nTvZfkBQiLMSMVCPpRzVuVhOZQKeiGE4743eV2Hqq9QuuJAeVg96WlyFwKrZW\nUP0N3lnesumFFhL0Mt2oB+kcGEEKRhcf8hY0mZVJ/2DRapI20lbxLpztidNeO0c=\n=pzow\n-----END PGP SIGNATURE-----\n", "payload": "tree 9a1b7662a44fb7c4301b65ae7c8e1bb4459c91f0\nparent fe51d07b99b662e7f839c2a7eac9588e701bf8f0\nparent 017e1726ff658117f43854181fb75c6b26a53b88\nauthor Yuki Okushi <jtitor@2k36.org> 1658890376 +0900\ncommitter GitHub <noreply@github.com> 1658890376 +0900\n\nRollup merge of #99759 - bjorn3:remove_llvm_dead_code, r=nikic\n\nRemove dead code from cg_llvm\n\nFound while working on https://github.com/rust-lang/rust/pull/97485\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7f608e99dcc0704769c6e4e523da16591848b2fe", "html_url": "https://github.com/rust-lang/rust/commit/7f608e99dcc0704769c6e4e523da16591848b2fe", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7f608e99dcc0704769c6e4e523da16591848b2fe/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fe51d07b99b662e7f839c2a7eac9588e701bf8f0", "url": "https://api.github.com/repos/rust-lang/rust/commits/fe51d07b99b662e7f839c2a7eac9588e701bf8f0", "html_url": "https://github.com/rust-lang/rust/commit/fe51d07b99b662e7f839c2a7eac9588e701bf8f0"}, {"sha": "017e1726ff658117f43854181fb75c6b26a53b88", "url": "https://api.github.com/repos/rust-lang/rust/commits/017e1726ff658117f43854181fb75c6b26a53b88", "html_url": "https://github.com/rust-lang/rust/commit/017e1726ff658117f43854181fb75c6b26a53b88"}], "stats": {"total": 100, "additions": 0, "deletions": 100}, "files": [{"sha": "45de284d22a6735bafb39d1d8eead2604de9cf95", "filename": "compiler/rustc_codegen_llvm/src/llvm/diagnostic.rs", "status": "modified", "additions": 0, "deletions": 13, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/7f608e99dcc0704769c6e4e523da16591848b2fe/compiler%2Frustc_codegen_llvm%2Fsrc%2Fllvm%2Fdiagnostic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7f608e99dcc0704769c6e4e523da16591848b2fe/compiler%2Frustc_codegen_llvm%2Fsrc%2Fllvm%2Fdiagnostic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fllvm%2Fdiagnostic.rs?ref=7f608e99dcc0704769c6e4e523da16591848b2fe", "patch": "@@ -20,19 +20,6 @@ pub enum OptimizationDiagnosticKind {\n     OptimizationRemarkOther,\n }\n \n-impl OptimizationDiagnosticKind {\n-    pub fn describe(self) -> &'static str {\n-        match self {\n-            OptimizationRemark | OptimizationRemarkOther => \"remark\",\n-            OptimizationMissed => \"missed\",\n-            OptimizationAnalysis => \"analysis\",\n-            OptimizationAnalysisFPCommute => \"floating-point\",\n-            OptimizationAnalysisAliasing => \"aliasing\",\n-            OptimizationFailure => \"failure\",\n-        }\n-    }\n-}\n-\n pub struct OptimizationDiagnostic<'ll> {\n     pub kind: OptimizationDiagnosticKind,\n     pub pass_name: String,"}, {"sha": "9ee6d39fdc9bf95095f14d1a86cb0086db1b52a7", "filename": "compiler/rustc_codegen_llvm/src/llvm/ffi.rs", "status": "modified", "additions": 0, "deletions": 27, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/7f608e99dcc0704769c6e4e523da16591848b2fe/compiler%2Frustc_codegen_llvm%2Fsrc%2Fllvm%2Fffi.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7f608e99dcc0704769c6e4e523da16591848b2fe/compiler%2Frustc_codegen_llvm%2Fsrc%2Fllvm%2Fffi.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fllvm%2Fffi.rs?ref=7f608e99dcc0704769c6e4e523da16591848b2fe", "patch": "@@ -572,16 +572,6 @@ pub enum ArchiveKind {\n     K_COFF,\n }\n \n-/// LLVMRustPassKind\n-#[derive(Copy, Clone, PartialEq, Debug)]\n-#[repr(C)]\n-#[allow(dead_code)] // Variants constructed by C++.\n-pub enum PassKind {\n-    Other,\n-    Function,\n-    Module,\n-}\n-\n // LLVMRustThinLTOData\n extern \"C\" {\n     pub type ThinLTOData;\n@@ -592,10 +582,6 @@ extern \"C\" {\n     pub type ThinLTOBuffer;\n }\n \n-// LLVMRustModuleNameCallback\n-pub type ThinLTOModuleNameCallback =\n-    unsafe extern \"C\" fn(*mut c_void, *const c_char, *const c_char);\n-\n /// LLVMRustThinLTOModule\n #[repr(C)]\n pub struct ThinLTOModule {\n@@ -661,9 +647,6 @@ extern \"C\" {\n }\n #[repr(C)]\n pub struct Builder<'a>(InvariantOpaque<'a>);\n-extern \"C\" {\n-    pub type MemoryBuffer;\n-}\n #[repr(C)]\n pub struct PassManager<'a>(InvariantOpaque<'a>);\n extern \"C\" {\n@@ -1032,7 +1015,6 @@ extern \"C\" {\n     pub fn LLVMSetDataLayout(M: &Module, Triple: *const c_char);\n \n     /// See Module::setModuleInlineAsm.\n-    pub fn LLVMSetModuleInlineAsm2(M: &Module, Asm: *const c_char, AsmLen: size_t);\n     pub fn LLVMRustAppendModuleInlineAsm(M: &Module, Asm: *const c_char, AsmLen: size_t);\n \n     /// See llvm::LLVMTypeKind::getTypeID.\n@@ -1186,7 +1168,6 @@ extern \"C\" {\n     pub fn LLVMGetInitializer(GlobalVar: &Value) -> Option<&Value>;\n     pub fn LLVMSetInitializer<'a>(GlobalVar: &'a Value, ConstantVal: &'a Value);\n     pub fn LLVMIsThreadLocal(GlobalVar: &Value) -> Bool;\n-    pub fn LLVMSetThreadLocal(GlobalVar: &Value, IsThreadLocal: Bool);\n     pub fn LLVMSetThreadLocalMode(GlobalVar: &Value, Mode: ThreadLocalMode);\n     pub fn LLVMIsGlobalConstant(GlobalVar: &Value) -> Bool;\n     pub fn LLVMSetGlobalConstant(GlobalVar: &Value, IsConstant: Bool);\n@@ -2267,7 +2248,6 @@ extern \"C\" {\n \n     pub fn LLVMIsAConstantInt(value_ref: &Value) -> Option<&ConstantInt>;\n \n-    pub fn LLVMRustPassKind(Pass: &Pass) -> PassKind;\n     pub fn LLVMRustFindAndCreatePass(Pass: *const c_char) -> Option<&'static mut Pass>;\n     pub fn LLVMRustCreateAddressSanitizerFunctionPass(Recover: bool) -> &'static mut Pass;\n     pub fn LLVMRustCreateModuleAddressSanitizerPass(Recover: bool) -> &'static mut Pass;\n@@ -2384,7 +2364,6 @@ extern \"C\" {\n     ) -> LLVMRustResult;\n     pub fn LLVMRustSetLLVMOptions(Argc: c_int, Argv: *const *const c_char);\n     pub fn LLVMRustPrintPasses();\n-    pub fn LLVMRustGetInstructionCount(M: &Module) -> u32;\n     pub fn LLVMRustSetNormalizedTarget(M: &Module, triple: *const c_char);\n     pub fn LLVMRustAddAlwaysInlinePass(P: &PassManagerBuilder, AddLifetimes: bool);\n     pub fn LLVMRustRunRestrictionPass(M: &Module, syms: *const *const c_char, len: size_t);\n@@ -2482,7 +2461,6 @@ extern \"C\" {\n     pub fn LLVMRustPositionBuilderAtStart<'a>(B: &Builder<'a>, BB: &'a BasicBlock);\n \n     pub fn LLVMRustSetComdat<'a>(M: &'a Module, V: &'a Value, Name: *const c_char, NameLen: size_t);\n-    pub fn LLVMRustUnsetComdat(V: &Value);\n     pub fn LLVMRustSetModulePICLevel(M: &Module);\n     pub fn LLVMRustSetModulePIELevel(M: &Module);\n     pub fn LLVMRustSetModuleCodeModel(M: &Module, Model: CodeModel);\n@@ -2514,11 +2492,6 @@ extern \"C\" {\n         Module: &Module,\n         Target: &TargetMachine,\n     ) -> bool;\n-    pub fn LLVMRustGetThinLTOModuleImports(\n-        Data: *const ThinLTOData,\n-        ModuleNameCallback: ThinLTOModuleNameCallback,\n-        CallbackPayload: *mut c_void,\n-    );\n     pub fn LLVMRustFreeThinLTOData(Data: &'static mut ThinLTOData);\n     pub fn LLVMRustParseBitcodeForLTO(\n         Context: &Context,"}, {"sha": "6602a4ab8636cc0be034fbbaacabbef009b94667", "filename": "compiler/rustc_codegen_llvm/src/llvm/mod.rs", "status": "modified", "additions": 0, "deletions": 6, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/7f608e99dcc0704769c6e4e523da16591848b2fe/compiler%2Frustc_codegen_llvm%2Fsrc%2Fllvm%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7f608e99dcc0704769c6e4e523da16591848b2fe/compiler%2Frustc_codegen_llvm%2Fsrc%2Fllvm%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fllvm%2Fmod.rs?ref=7f608e99dcc0704769c6e4e523da16591848b2fe", "patch": "@@ -166,12 +166,6 @@ pub fn SetUniqueComdat(llmod: &Module, val: &Value) {\n     }\n }\n \n-pub fn UnsetComdat(val: &Value) {\n-    unsafe {\n-        LLVMRustUnsetComdat(val);\n-    }\n-}\n-\n pub fn SetUnnamedAddress(global: &Value, unnamed: UnnamedAddr) {\n     unsafe {\n         LLVMSetUnnamedAddress(global, unnamed);"}, {"sha": "0a6bd49992d9932f37326f75cfba45d046ed6e1e", "filename": "compiler/rustc_llvm/llvm-wrapper/PassWrapper.cpp", "status": "modified", "additions": 0, "deletions": 45, "changes": 45, "blob_url": "https://github.com/rust-lang/rust/blob/7f608e99dcc0704769c6e4e523da16591848b2fe/compiler%2Frustc_llvm%2Fllvm-wrapper%2FPassWrapper.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/7f608e99dcc0704769c6e4e523da16591848b2fe/compiler%2Frustc_llvm%2Fllvm-wrapper%2FPassWrapper.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_llvm%2Fllvm-wrapper%2FPassWrapper.cpp?ref=7f608e99dcc0704769c6e4e523da16591848b2fe", "patch": "@@ -90,23 +90,6 @@ extern \"C\" void LLVMTimeTraceProfilerFinish(const char* FileName) {\n   timeTraceProfilerCleanup();\n }\n \n-enum class LLVMRustPassKind {\n-  Other,\n-  Function,\n-  Module,\n-};\n-\n-static LLVMRustPassKind toRust(PassKind Kind) {\n-  switch (Kind) {\n-  case PT_Function:\n-    return LLVMRustPassKind::Function;\n-  case PT_Module:\n-    return LLVMRustPassKind::Module;\n-  default:\n-    return LLVMRustPassKind::Other;\n-  }\n-}\n-\n extern \"C\" LLVMPassRef LLVMRustFindAndCreatePass(const char *PassName) {\n #if LLVM_VERSION_LT(15, 0)\n   StringRef SR(PassName);\n@@ -172,12 +155,6 @@ extern \"C\" LLVMPassRef LLVMRustCreateHWAddressSanitizerPass(bool Recover) {\n #endif\n }\n \n-extern \"C\" LLVMRustPassKind LLVMRustPassKind(LLVMPassRef RustPass) {\n-  assert(RustPass);\n-  Pass *Pass = unwrap(RustPass);\n-  return toRust(Pass->getPassKind());\n-}\n-\n extern \"C\" void LLVMRustAddPass(LLVMPassManagerRef PMR, LLVMPassRef RustPass) {\n #if LLVM_VERSION_LT(15, 0)\n   assert(RustPass);\n@@ -1604,28 +1581,6 @@ LLVMRustPrepareThinLTOImport(const LLVMRustThinLTOData *Data, LLVMModuleRef M,\n   return true;\n }\n \n-extern \"C\" typedef void (*LLVMRustModuleNameCallback)(void*, // payload\n-                                                      const char*, // importing module name\n-                                                      const char*); // imported module name\n-\n-// Calls `module_name_callback` for each module import done by ThinLTO.\n-// The callback is provided with regular null-terminated C strings.\n-extern \"C\" void\n-LLVMRustGetThinLTOModules(const LLVMRustThinLTOData *data,\n-                                LLVMRustModuleNameCallback module_name_callback,\n-                                void* callback_payload) {\n-  for (const auto& importing_module : data->ImportLists) {\n-    const std::string importing_module_id = importing_module.getKey().str();\n-    const auto& imports = importing_module.getValue();\n-    for (const auto& imported_module : imports) {\n-      const std::string imported_module_id = imported_module.getKey().str();\n-      module_name_callback(callback_payload,\n-                           importing_module_id.c_str(),\n-                           imported_module_id.c_str());\n-    }\n-  }\n-}\n-\n // This struct and various functions are sort of a hack right now, but the\n // problem is that we've got in-memory LLVM modules after we generate and\n // optimize all codegen-units for one compilation in rustc. To be compatible"}, {"sha": "ef1a65488e2e4fff51f64b3e3bde106dac51c4ee", "filename": "compiler/rustc_llvm/llvm-wrapper/RustWrapper.cpp", "status": "modified", "additions": 0, "deletions": 9, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/7f608e99dcc0704769c6e4e523da16591848b2fe/compiler%2Frustc_llvm%2Fllvm-wrapper%2FRustWrapper.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/7f608e99dcc0704769c6e4e523da16591848b2fe/compiler%2Frustc_llvm%2Fllvm-wrapper%2FRustWrapper.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_llvm%2Fllvm-wrapper%2FRustWrapper.cpp?ref=7f608e99dcc0704769c6e4e523da16591848b2fe", "patch": "@@ -88,10 +88,6 @@ extern \"C\" char *LLVMRustGetLastError(void) {\n   return Ret;\n }\n \n-extern \"C\" unsigned int LLVMRustGetInstructionCount(LLVMModuleRef M) {\n-  return unwrap(M)->getInstructionCount();\n-}\n-\n extern \"C\" void LLVMRustSetLastError(const char *Err) {\n   free((void *)LastError);\n   LastError = strdup(Err);\n@@ -1529,11 +1525,6 @@ extern \"C\" void LLVMRustSetComdat(LLVMModuleRef M, LLVMValueRef V,\n   }\n }\n \n-extern \"C\" void LLVMRustUnsetComdat(LLVMValueRef V) {\n-  GlobalObject *GV = unwrap<GlobalObject>(V);\n-  GV->setComdat(nullptr);\n-}\n-\n enum class LLVMRustLinkage {\n   ExternalLinkage = 0,\n   AvailableExternallyLinkage = 1,"}]}