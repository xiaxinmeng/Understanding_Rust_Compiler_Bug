{"sha": "463b6cc0e110dad1cb32887b85c2a77702e7b78f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQ2M2I2Y2MwZTExMGRhZDFjYjMyODg3Yjg1YzJhNzc3MDJlN2I3OGY=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2020-10-26T02:09:11Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-10-26T02:09:11Z"}, "message": "Rollup merge of #78268 - JohnTitor:issue-78262, r=estebank\n\nDo not try to report on closures to avoid ICE\n\nFixes #78262", "tree": {"sha": "d2b3187d7aaeed635c10a936f65c526e6dcb820e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d2b3187d7aaeed635c10a936f65c526e6dcb820e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/463b6cc0e110dad1cb32887b85c2a77702e7b78f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfli/HCRBK7hj4Ov3rIwAAdHIIALDIf86xLgrC5FuBO4ljrgwe\nbdqnC27rhdZXEFnh2i+KUCecrapCCsb3V1H2WMKVJHPJ5cD/tH739/vk1ibyGkOa\n+UEZrjkcQ0mEtqZFlqw1NSMB4HO4NqJQC+l1pk04PQC1B0cXH6xqqSGkrGfi86WU\nfXIYnHAKuc4BAXA0r7j9SW0hOxUpbq07t7K1s18d7NiumMyMhJpEWc6xS9fACmDN\nY55WGj7z0AEd6EnGXmzxjwb5DzXv0hDsTqr9aybm+gbscSpPvRFscpBHpLwLOk9v\nv5di6Wbt5SA+yC1cKVe41Wasd90+iui2QmemFa15D/e55LiyVQ3+NhDK7O8L6nM=\n=DTBa\n-----END PGP SIGNATURE-----\n", "payload": "tree d2b3187d7aaeed635c10a936f65c526e6dcb820e\nparent 752bce51972723c0b6f6b73a62369c3395071a19\nparent 4ec396ea5dd7bddfaa667766ab6cd8824c8028da\nauthor Dylan DPC <dylan.dpc@gmail.com> 1603678151 +0100\ncommitter GitHub <noreply@github.com> 1603678151 +0100\n\nRollup merge of #78268 - JohnTitor:issue-78262, r=estebank\n\nDo not try to report on closures to avoid ICE\n\nFixes #78262\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/463b6cc0e110dad1cb32887b85c2a77702e7b78f", "html_url": "https://github.com/rust-lang/rust/commit/463b6cc0e110dad1cb32887b85c2a77702e7b78f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/463b6cc0e110dad1cb32887b85c2a77702e7b78f/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "752bce51972723c0b6f6b73a62369c3395071a19", "url": "https://api.github.com/repos/rust-lang/rust/commits/752bce51972723c0b6f6b73a62369c3395071a19", "html_url": "https://github.com/rust-lang/rust/commit/752bce51972723c0b6f6b73a62369c3395071a19"}, {"sha": "4ec396ea5dd7bddfaa667766ab6cd8824c8028da", "url": "https://api.github.com/repos/rust-lang/rust/commits/4ec396ea5dd7bddfaa667766ab6cd8824c8028da", "html_url": "https://github.com/rust-lang/rust/commit/4ec396ea5dd7bddfaa667766ab6cd8824c8028da"}], "stats": {"total": 50, "additions": 50, "deletions": 0}, "files": [{"sha": "e9d5ebad7de03b4aedc103d8d425dd45936d2833", "filename": "compiler/rustc_infer/src/infer/error_reporting/nice_region_error/static_impl_trait.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/463b6cc0e110dad1cb32887b85c2a77702e7b78f/compiler%2Frustc_infer%2Fsrc%2Finfer%2Ferror_reporting%2Fnice_region_error%2Fstatic_impl_trait.rs", "raw_url": "https://github.com/rust-lang/rust/raw/463b6cc0e110dad1cb32887b85c2a77702e7b78f/compiler%2Frustc_infer%2Fsrc%2Finfer%2Ferror_reporting%2Fnice_region_error%2Fstatic_impl_trait.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_infer%2Fsrc%2Finfer%2Ferror_reporting%2Fnice_region_error%2Fstatic_impl_trait.rs?ref=463b6cc0e110dad1cb32887b85c2a77702e7b78f", "patch": "@@ -39,6 +39,14 @@ impl<'a, 'tcx> NiceRegionError<'a, 'tcx> {\n             ) if **sub_r == RegionKind::ReStatic => {\n                 // This is for an implicit `'static` requirement coming from `impl dyn Trait {}`.\n                 if let ObligationCauseCode::UnifyReceiver(ctxt) = &cause.code {\n+                    // This may have a closure and it would cause ICE\n+                    // through `find_param_with_region` (#78262).\n+                    let anon_reg_sup = tcx.is_suitable_region(sup_r)?;\n+                    let fn_returns = tcx.return_type_impl_or_dyn_traits(anon_reg_sup.def_id);\n+                    if fn_returns.is_empty() {\n+                        return None;\n+                    }\n+\n                     let param = self.find_param_with_region(sup_r, sub_r)?;\n                     let lifetime = if sup_r.has_name() {\n                         format!(\"lifetime `{}`\", sup_r)"}, {"sha": "e97b8eca94892bf1d959640251616f5ee2834f9d", "filename": "src/test/ui/regions/issue-78262.default.stderr", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/463b6cc0e110dad1cb32887b85c2a77702e7b78f/src%2Ftest%2Fui%2Fregions%2Fissue-78262.default.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/463b6cc0e110dad1cb32887b85c2a77702e7b78f/src%2Ftest%2Fui%2Fregions%2Fissue-78262.default.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fregions%2Fissue-78262.default.stderr?ref=463b6cc0e110dad1cb32887b85c2a77702e7b78f", "patch": "@@ -0,0 +1,18 @@\n+error[E0308]: mismatched types\n+  --> $DIR/issue-78262.rs:12:28\n+   |\n+LL |     let f = |x: &dyn TT| x.func();\n+   |                            ^^^^ lifetime mismatch\n+   |\n+   = note: expected reference `&(dyn TT + 'static)`\n+              found reference `&dyn TT`\n+note: the anonymous lifetime #1 defined on the body at 12:13...\n+  --> $DIR/issue-78262.rs:12:13\n+   |\n+LL |     let f = |x: &dyn TT| x.func();\n+   |             ^^^^^^^^^^^^^^^^^^^^^\n+   = note: ...does not necessarily outlive the static lifetime\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0308`."}, {"sha": "4607dbad4220b7eff50bb8523e05ea0ae3e34c12", "filename": "src/test/ui/regions/issue-78262.nll.stderr", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/463b6cc0e110dad1cb32887b85c2a77702e7b78f/src%2Ftest%2Fui%2Fregions%2Fissue-78262.nll.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/463b6cc0e110dad1cb32887b85c2a77702e7b78f/src%2Ftest%2Fui%2Fregions%2Fissue-78262.nll.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fregions%2Fissue-78262.nll.stderr?ref=463b6cc0e110dad1cb32887b85c2a77702e7b78f", "patch": "@@ -0,0 +1,10 @@\n+error[E0521]: borrowed data escapes outside of closure\n+  --> $DIR/issue-78262.rs:12:26\n+   |\n+LL |     let f = |x: &dyn TT| x.func();\n+   |              -           ^^^^^^^^ `x` escapes the closure body here\n+   |              |\n+   |              `x` is a reference that is only valid in the closure body\n+\n+error: aborting due to previous error\n+"}, {"sha": "0bdb0abac307dddff2db21dd530a91dd33f2de2a", "filename": "src/test/ui/regions/issue-78262.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/463b6cc0e110dad1cb32887b85c2a77702e7b78f/src%2Ftest%2Fui%2Fregions%2Fissue-78262.rs", "raw_url": "https://github.com/rust-lang/rust/raw/463b6cc0e110dad1cb32887b85c2a77702e7b78f/src%2Ftest%2Fui%2Fregions%2Fissue-78262.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fregions%2Fissue-78262.rs?ref=463b6cc0e110dad1cb32887b85c2a77702e7b78f", "patch": "@@ -0,0 +1,14 @@\n+// revisions: nll default\n+// ignore-compare-mode-nll\n+//[nll]compile-flags: -Z borrowck=mir\n+\n+trait TT {}\n+\n+impl dyn TT {\n+    fn func(&self) {}\n+}\n+\n+fn main() {\n+    let f = |x: &dyn TT| x.func(); //[default]~ ERROR: mismatched types\n+    //[nll]~^ ERROR: borrowed data escapes outside of closure\n+}"}]}