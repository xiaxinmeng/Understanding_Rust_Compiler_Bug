{"sha": "d33d5fca1dd8c0da5c47d223ab5a52cf1633db98", "node_id": "C_kwDOAAsO6NoAKGQzM2Q1ZmNhMWRkOGMwZGE1YzQ3ZDIyM2FiNWE1MmNmMTYzM2RiOTg", "commit": {"author": {"name": "hkalbasi", "email": "hamidrezakalbasi@protonmail.com", "date": "2022-04-21T21:05:28Z"}, "committer": {"name": "hkalbasi", "email": "hamidrezakalbasi@protonmail.com", "date": "2022-04-21T21:06:11Z"}, "message": "fix const generic panic in dyn trait", "tree": {"sha": "b439504a73f34ca307ecbce27fd6ae2d9f25548a", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b439504a73f34ca307ecbce27fd6ae2d9f25548a"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d33d5fca1dd8c0da5c47d223ab5a52cf1633db98", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d33d5fca1dd8c0da5c47d223ab5a52cf1633db98", "html_url": "https://github.com/rust-lang/rust/commit/d33d5fca1dd8c0da5c47d223ab5a52cf1633db98", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d33d5fca1dd8c0da5c47d223ab5a52cf1633db98/comments", "author": {"login": "HKalbasi", "id": 45197576, "node_id": "MDQ6VXNlcjQ1MTk3NTc2", "avatar_url": "https://avatars.githubusercontent.com/u/45197576?v=4", "gravatar_id": "", "url": "https://api.github.com/users/HKalbasi", "html_url": "https://github.com/HKalbasi", "followers_url": "https://api.github.com/users/HKalbasi/followers", "following_url": "https://api.github.com/users/HKalbasi/following{/other_user}", "gists_url": "https://api.github.com/users/HKalbasi/gists{/gist_id}", "starred_url": "https://api.github.com/users/HKalbasi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/HKalbasi/subscriptions", "organizations_url": "https://api.github.com/users/HKalbasi/orgs", "repos_url": "https://api.github.com/users/HKalbasi/repos", "events_url": "https://api.github.com/users/HKalbasi/events{/privacy}", "received_events_url": "https://api.github.com/users/HKalbasi/received_events", "type": "User", "site_admin": false}, "committer": {"login": "HKalbasi", "id": 45197576, "node_id": "MDQ6VXNlcjQ1MTk3NTc2", "avatar_url": "https://avatars.githubusercontent.com/u/45197576?v=4", "gravatar_id": "", "url": "https://api.github.com/users/HKalbasi", "html_url": "https://github.com/HKalbasi", "followers_url": "https://api.github.com/users/HKalbasi/followers", "following_url": "https://api.github.com/users/HKalbasi/following{/other_user}", "gists_url": "https://api.github.com/users/HKalbasi/gists{/gist_id}", "starred_url": "https://api.github.com/users/HKalbasi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/HKalbasi/subscriptions", "organizations_url": "https://api.github.com/users/HKalbasi/orgs", "repos_url": "https://api.github.com/users/HKalbasi/repos", "events_url": "https://api.github.com/users/HKalbasi/events{/privacy}", "received_events_url": "https://api.github.com/users/HKalbasi/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "71d49d31bbff3d8b0cba267509d33d6b6c1de08f", "url": "https://api.github.com/repos/rust-lang/rust/commits/71d49d31bbff3d8b0cba267509d33d6b6c1de08f", "html_url": "https://github.com/rust-lang/rust/commit/71d49d31bbff3d8b0cba267509d33d6b6c1de08f"}], "stats": {"total": 102, "additions": 66, "deletions": 36}, "files": [{"sha": "427791afa2c753ea12c25559cf626c15a5ad7b0a", "filename": "crates/hir_ty/src/lower.rs", "status": "modified", "additions": 50, "deletions": 36, "changes": 86, "blob_url": "https://github.com/rust-lang/rust/blob/d33d5fca1dd8c0da5c47d223ab5a52cf1633db98/crates%2Fhir_ty%2Fsrc%2Flower.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d33d5fca1dd8c0da5c47d223ab5a52cf1633db98/crates%2Fhir_ty%2Fsrc%2Flower.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Flower.rs?ref=d33d5fca1dd8c0da5c47d223ab5a52cf1633db98", "patch": "@@ -681,23 +681,31 @@ impl<'a> TyLoweringContext<'a> {\n \n         let ty_error = GenericArgData::Ty(TyKind::Error.intern(Interner)).intern(Interner);\n \n-        for eid in def_generics.iter_id().take(parent_params) {\n-            match eid {\n-                Either::Left(_) => substs.push(ty_error.clone()),\n-                Either::Right(x) => {\n-                    substs.push(unknown_const_as_generic(self.db.const_param_ty(x)))\n+        let mut def_generic_iter = def_generics.iter_id();\n+\n+        for _ in 0..parent_params {\n+            if let Some(eid) = def_generic_iter.next() {\n+                match eid {\n+                    Either::Left(_) => substs.push(ty_error.clone()),\n+                    Either::Right(x) => {\n+                        substs.push(unknown_const_as_generic(self.db.const_param_ty(x)))\n+                    }\n                 }\n             }\n         }\n \n         let fill_self_params = || {\n-            substs.extend(\n-                explicit_self_ty\n-                    .into_iter()\n-                    .map(|x| GenericArgData::Ty(x).intern(Interner))\n-                    .chain(iter::repeat(ty_error.clone()))\n-                    .take(self_params),\n-            )\n+            for x in explicit_self_ty\n+                .into_iter()\n+                .map(|x| GenericArgData::Ty(x).intern(Interner))\n+                .chain(iter::repeat(ty_error.clone()))\n+                .take(self_params)\n+            {\n+                if let Some(id) = def_generic_iter.next() {\n+                    assert!(id.is_left());\n+                    substs.push(x);\n+                }\n+            }\n         };\n         let mut had_explicit_args = false;\n \n@@ -712,34 +720,37 @@ impl<'a> TyLoweringContext<'a> {\n             };\n             let skip = if generic_args.has_self_type && self_params == 0 { 1 } else { 0 };\n             // if args are provided, it should be all of them, but we can't rely on that\n-            for (arg, id) in generic_args\n+            for arg in generic_args\n                 .args\n                 .iter()\n                 .filter(|arg| !matches!(arg, GenericArg::Lifetime(_)))\n                 .skip(skip)\n                 .take(expected_num)\n-                .zip(def_generics.iter_id().skip(parent_params + skip))\n             {\n-                if let Some(x) = generic_arg_to_chalk(\n-                    self.db,\n-                    id,\n-                    arg,\n-                    &mut (),\n-                    |_, type_ref| self.lower_ty(type_ref),\n-                    |_, c, ty| {\n-                        const_or_path_to_chalk(\n-                            self.db,\n-                            &self.resolver,\n-                            ty,\n-                            c,\n-                            self.type_param_mode,\n-                            || self.generics(),\n-                            self.in_binders,\n-                        )\n-                    },\n-                ) {\n-                    had_explicit_args = true;\n-                    substs.push(x);\n+                if let Some(id) = def_generic_iter.next() {\n+                    if let Some(x) = generic_arg_to_chalk(\n+                        self.db,\n+                        id,\n+                        arg,\n+                        &mut (),\n+                        |_, type_ref| self.lower_ty(type_ref),\n+                        |_, c, ty| {\n+                            const_or_path_to_chalk(\n+                                self.db,\n+                                &self.resolver,\n+                                ty,\n+                                c,\n+                                self.type_param_mode,\n+                                || self.generics(),\n+                                self.in_binders,\n+                            )\n+                        },\n+                    ) {\n+                        had_explicit_args = true;\n+                        substs.push(x);\n+                    } else {\n+                        never!();\n+                    }\n                 }\n             }\n         } else {\n@@ -757,21 +768,24 @@ impl<'a> TyLoweringContext<'a> {\n                 for default_ty in defaults.iter().skip(substs.len()) {\n                     // each default can depend on the previous parameters\n                     let substs_so_far = Substitution::from_iter(Interner, substs.clone());\n-                    substs.push(default_ty.clone().substitute(Interner, &substs_so_far));\n+                    if let Some(_id) = def_generic_iter.next() {\n+                        substs.push(default_ty.clone().substitute(Interner, &substs_so_far));\n+                    }\n                 }\n             }\n         }\n \n         // add placeholders for args that were not provided\n         // FIXME: emit diagnostics in contexts where this is not allowed\n-        for eid in def_generics.iter_id().skip(substs.len()) {\n+        for eid in def_generic_iter {\n             match eid {\n                 Either::Left(_) => substs.push(ty_error.clone()),\n                 Either::Right(x) => {\n                     substs.push(unknown_const_as_generic(self.db.const_param_ty(x)))\n                 }\n             }\n         }\n+        // If this assert fails, it means you pushed into subst but didn't call .next() of def_generic_iter\n         assert_eq!(substs.len(), total_len);\n \n         Substitution::from_iter(Interner, substs)"}, {"sha": "ef27667ffa5729ee2c242a501ce17497afe0eadb", "filename": "crates/hir_ty/src/tests/regression.rs", "status": "modified", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/d33d5fca1dd8c0da5c47d223ab5a52cf1633db98/crates%2Fhir_ty%2Fsrc%2Ftests%2Fregression.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d33d5fca1dd8c0da5c47d223ab5a52cf1633db98/crates%2Fhir_ty%2Fsrc%2Ftests%2Fregression.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Ftests%2Fregression.rs?ref=d33d5fca1dd8c0da5c47d223ab5a52cf1633db98", "patch": "@@ -1470,6 +1470,22 @@ fn regression_11688_3() {\n     );\n }\n \n+#[test]\n+fn regression_11688_4() {\n+    check_types(\n+        r#\"\n+        trait Bar<const C: usize> {\n+            fn baz(&self) -> [i32; C];\n+        }\n+\n+        fn foo(x: &dyn Bar<2>) {\n+            x.baz();\n+          //^^^^^^^ [i32; 2]\n+        }\n+        \"#,\n+    )\n+}\n+\n #[test]\n fn gat_crash_1() {\n     cov_mark::check!(ignore_gats);"}]}