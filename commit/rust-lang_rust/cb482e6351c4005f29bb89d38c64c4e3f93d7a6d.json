{"sha": "cb482e6351c4005f29bb89d38c64c4e3f93d7a6d", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNiNDgyZTYzNTFjNDAwNWYyOWJiODlkMzhjNjRjNGUzZjkzZDdhNmQ=", "commit": {"author": {"name": "Mikhail Rakhmanov", "email": "rakhmanov.m@gmail.com", "date": "2020-06-02T21:22:45Z"}, "committer": {"name": "Mikhail Rakhmanov", "email": "rakhmanov.m@gmail.com", "date": "2020-06-02T21:22:45Z"}, "message": "Merge remote-tracking branch 'upstream/master' into compute-lazy-assits\n\n# Conflicts:\n#\tcrates/rust-analyzer/src/to_proto.rs", "tree": {"sha": "c96d88e98c1a4fd59c37741e94faeefe465f4fb3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c96d88e98c1a4fd59c37741e94faeefe465f4fb3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cb482e6351c4005f29bb89d38c64c4e3f93d7a6d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cb482e6351c4005f29bb89d38c64c4e3f93d7a6d", "html_url": "https://github.com/rust-lang/rust/commit/cb482e6351c4005f29bb89d38c64c4e3f93d7a6d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cb482e6351c4005f29bb89d38c64c4e3f93d7a6d/comments", "author": {"login": "mcrakhman", "id": 16068868, "node_id": "MDQ6VXNlcjE2MDY4ODY4", "avatar_url": "https://avatars.githubusercontent.com/u/16068868?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mcrakhman", "html_url": "https://github.com/mcrakhman", "followers_url": "https://api.github.com/users/mcrakhman/followers", "following_url": "https://api.github.com/users/mcrakhman/following{/other_user}", "gists_url": "https://api.github.com/users/mcrakhman/gists{/gist_id}", "starred_url": "https://api.github.com/users/mcrakhman/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mcrakhman/subscriptions", "organizations_url": "https://api.github.com/users/mcrakhman/orgs", "repos_url": "https://api.github.com/users/mcrakhman/repos", "events_url": "https://api.github.com/users/mcrakhman/events{/privacy}", "received_events_url": "https://api.github.com/users/mcrakhman/received_events", "type": "User", "site_admin": false}, "committer": {"login": "mcrakhman", "id": 16068868, "node_id": "MDQ6VXNlcjE2MDY4ODY4", "avatar_url": "https://avatars.githubusercontent.com/u/16068868?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mcrakhman", "html_url": "https://github.com/mcrakhman", "followers_url": "https://api.github.com/users/mcrakhman/followers", "following_url": "https://api.github.com/users/mcrakhman/following{/other_user}", "gists_url": "https://api.github.com/users/mcrakhman/gists{/gist_id}", "starred_url": "https://api.github.com/users/mcrakhman/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mcrakhman/subscriptions", "organizations_url": "https://api.github.com/users/mcrakhman/orgs", "repos_url": "https://api.github.com/users/mcrakhman/repos", "events_url": "https://api.github.com/users/mcrakhman/events{/privacy}", "received_events_url": "https://api.github.com/users/mcrakhman/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "57cd936c5262c3b43626618be42d7a72f71c3539", "url": "https://api.github.com/repos/rust-lang/rust/commits/57cd936c5262c3b43626618be42d7a72f71c3539", "html_url": "https://github.com/rust-lang/rust/commit/57cd936c5262c3b43626618be42d7a72f71c3539"}, {"sha": "2f6ab77708ae104c854712285af19516287b6906", "url": "https://api.github.com/repos/rust-lang/rust/commits/2f6ab77708ae104c854712285af19516287b6906", "html_url": "https://github.com/rust-lang/rust/commit/2f6ab77708ae104c854712285af19516287b6906"}], "stats": {"total": 889, "additions": 546, "deletions": 343}, "files": [{"sha": "c7bb1e69f8a575765da2aeb9b82d7dbb25904577", "filename": "crates/ra_ide/src/display/navigation_target.rs", "status": "modified", "additions": 23, "deletions": 43, "changes": 66, "blob_url": "https://github.com/rust-lang/rust/blob/cb482e6351c4005f29bb89d38c64c4e3f93d7a6d/crates%2Fra_ide%2Fsrc%2Fdisplay%2Fnavigation_target.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cb482e6351c4005f29bb89d38c64c4e3f93d7a6d/crates%2Fra_ide%2Fsrc%2Fdisplay%2Fnavigation_target.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fdisplay%2Fnavigation_target.rs?ref=cb482e6351c4005f29bb89d38c64c4e3f93d7a6d", "patch": "@@ -92,15 +92,16 @@ impl NavigationTarget {\n         let name = module.name(db).map(|it| it.to_string().into()).unwrap_or_default();\n         if let Some(src) = module.declaration_source(db) {\n             let frange = original_range(db, src.as_ref().map(|it| it.syntax()));\n-            return NavigationTarget::from_syntax(\n+            let mut res = NavigationTarget::from_syntax(\n                 frange.file_id,\n                 name,\n                 None,\n                 frange.range,\n                 src.value.syntax().kind(),\n-                src.value.doc_comment_text(),\n-                src.value.short_label(),\n             );\n+            res.docs = src.value.doc_comment_text();\n+            res.description = src.value.short_label();\n+            return res;\n         }\n         module.to_nav(db)\n     }\n@@ -130,11 +131,9 @@ impl NavigationTarget {\n     }\n \n     /// Allows `NavigationTarget` to be created from a `NameOwner`\n-    fn from_named(\n+    pub(crate) fn from_named(\n         db: &RootDatabase,\n         node: InFile<&dyn ast::NameOwner>,\n-        docs: Option<String>,\n-        description: Option<String>,\n     ) -> NavigationTarget {\n         //FIXME: use `_` instead of empty string\n         let name = node.value.name().map(|it| it.text().clone()).unwrap_or_default();\n@@ -148,8 +147,6 @@ impl NavigationTarget {\n             focus_range,\n             frange.range,\n             node.value.syntax().kind(),\n-            docs,\n-            description,\n         )\n     }\n \n@@ -159,8 +156,6 @@ impl NavigationTarget {\n         focus_range: Option<TextRange>,\n         full_range: TextRange,\n         kind: SyntaxKind,\n-        docs: Option<String>,\n-        description: Option<String>,\n     ) -> NavigationTarget {\n         NavigationTarget {\n             file_id,\n@@ -169,8 +164,8 @@ impl NavigationTarget {\n             full_range,\n             focus_range,\n             container_name: None,\n-            description,\n-            docs,\n+            description: None,\n+            docs: None,\n         }\n     }\n }\n@@ -238,12 +233,11 @@ where\n {\n     fn to_nav(&self, db: &RootDatabase) -> NavigationTarget {\n         let src = self.source(db);\n-        NavigationTarget::from_named(\n-            db,\n-            src.as_ref().map(|it| it as &dyn ast::NameOwner),\n-            src.value.doc_comment_text(),\n-            src.value.short_label(),\n-        )\n+        let mut res =\n+            NavigationTarget::from_named(db, src.as_ref().map(|it| it as &dyn ast::NameOwner));\n+        res.docs = src.value.doc_comment_text();\n+        res.description = src.value.short_label();\n+        res\n     }\n }\n \n@@ -258,15 +252,7 @@ impl ToNav for hir::Module {\n             }\n         };\n         let frange = original_range(db, src.with_value(syntax));\n-        NavigationTarget::from_syntax(\n-            frange.file_id,\n-            name,\n-            focus,\n-            frange.range,\n-            syntax.kind(),\n-            None,\n-            None,\n-        )\n+        NavigationTarget::from_syntax(frange.file_id, name, focus, frange.range, syntax.kind())\n     }\n }\n \n@@ -285,8 +271,6 @@ impl ToNav for hir::ImplDef {\n             None,\n             frange.range,\n             src.value.syntax().kind(),\n-            None,\n-            None,\n         )\n     }\n }\n@@ -296,12 +280,12 @@ impl ToNav for hir::Field {\n         let src = self.source(db);\n \n         match &src.value {\n-            FieldSource::Named(it) => NavigationTarget::from_named(\n-                db,\n-                src.with_value(it),\n-                it.doc_comment_text(),\n-                it.short_label(),\n-            ),\n+            FieldSource::Named(it) => {\n+                let mut res = NavigationTarget::from_named(db, src.with_value(it));\n+                res.docs = it.doc_comment_text();\n+                res.description = it.short_label();\n+                res\n+            }\n             FieldSource::Pos(it) => {\n                 let frange = original_range(db, src.with_value(it.syntax()));\n                 NavigationTarget::from_syntax(\n@@ -310,8 +294,6 @@ impl ToNav for hir::Field {\n                     None,\n                     frange.range,\n                     it.syntax().kind(),\n-                    None,\n-                    None,\n                 )\n             }\n         }\n@@ -322,12 +304,10 @@ impl ToNav for hir::MacroDef {\n     fn to_nav(&self, db: &RootDatabase) -> NavigationTarget {\n         let src = self.source(db);\n         log::debug!(\"nav target {:#?}\", src.value.syntax());\n-        NavigationTarget::from_named(\n-            db,\n-            src.as_ref().map(|it| it as &dyn ast::NameOwner),\n-            src.value.doc_comment_text(),\n-            None,\n-        )\n+        let mut res =\n+            NavigationTarget::from_named(db, src.as_ref().map(|it| it as &dyn ast::NameOwner));\n+        res.docs = src.value.doc_comment_text();\n+        res\n     }\n }\n "}, {"sha": "f32ce0d229b84247246fa46f103604f771f4fc2e", "filename": "crates/ra_ide/src/runnables.rs", "status": "modified", "additions": 223, "deletions": 27, "changes": 250, "blob_url": "https://github.com/rust-lang/rust/blob/cb482e6351c4005f29bb89d38c64c4e3f93d7a6d/crates%2Fra_ide%2Fsrc%2Frunnables.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cb482e6351c4005f29bb89d38c64c4e3f93d7a6d/crates%2Fra_ide%2Fsrc%2Frunnables.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Frunnables.rs?ref=cb482e6351c4005f29bb89d38c64c4e3f93d7a6d", "patch": "@@ -1,19 +1,19 @@\n+use std::fmt;\n+\n use hir::{AsAssocItem, Attrs, HirFileId, InFile, Semantics};\n use itertools::Itertools;\n+use ra_cfg::CfgExpr;\n use ra_ide_db::RootDatabase;\n use ra_syntax::{\n-    ast::{self, AstNode, AttrsOwner, ModuleItemOwner, NameOwner},\n-    match_ast, SyntaxNode, TextRange,\n+    ast::{self, AstNode, AttrsOwner, DocCommentsOwner, ModuleItemOwner, NameOwner},\n+    match_ast, SyntaxNode,\n };\n \n-use crate::FileId;\n-use ast::DocCommentsOwner;\n-use ra_cfg::CfgExpr;\n-use std::fmt::Display;\n+use crate::{display::ToNav, FileId, NavigationTarget};\n \n #[derive(Debug)]\n pub struct Runnable {\n-    pub range: TextRange,\n+    pub nav: NavigationTarget,\n     pub kind: RunnableKind,\n     pub cfg_exprs: Vec<CfgExpr>,\n }\n@@ -24,8 +24,8 @@ pub enum TestId {\n     Path(String),\n }\n \n-impl Display for TestId {\n-    fn fmt(&self, f: &mut std::fmt::Formatter) -> std::fmt::Result {\n+impl fmt::Display for TestId {\n+    fn fmt(&self, f: &mut fmt::Formatter) -> fmt::Result {\n         match self {\n             TestId::Name(name) => write!(f, \"{}\", name),\n             TestId::Path(path) => write!(f, \"{}\", path),\n@@ -131,7 +131,8 @@ fn runnable_fn(\n     let cfg_exprs =\n         attrs.by_key(\"cfg\").tt_values().map(|subtree| ra_cfg::parse_cfg(subtree)).collect();\n \n-    Some(Runnable { range: fn_def.syntax().text_range(), kind, cfg_exprs })\n+    let nav = NavigationTarget::from_named(sema.db, InFile::new(file_id.into(), &fn_def));\n+    Some(Runnable { nav, kind, cfg_exprs })\n }\n \n #[derive(Debug)]\n@@ -183,7 +184,6 @@ fn runnable_mod(\n     if !has_test_function {\n         return None;\n     }\n-    let range = module.syntax().text_range();\n     let module_def = sema.to_def(&module)?;\n \n     let path = module_def\n@@ -197,7 +197,8 @@ fn runnable_mod(\n     let cfg_exprs =\n         attrs.by_key(\"cfg\").tt_values().map(|subtree| ra_cfg::parse_cfg(subtree)).collect();\n \n-    Some(Runnable { range, kind: RunnableKind::TestMod { path }, cfg_exprs })\n+    let nav = module_def.to_nav(sema.db);\n+    Some(Runnable { nav, kind: RunnableKind::TestMod { path }, cfg_exprs })\n }\n \n #[cfg(test)]\n@@ -227,12 +228,38 @@ mod tests {\n         @r###\"\n         [\n             Runnable {\n-                range: 1..21,\n+                nav: NavigationTarget {\n+                    file_id: FileId(\n+                        1,\n+                    ),\n+                    full_range: 1..21,\n+                    name: \"main\",\n+                    kind: FN_DEF,\n+                    focus_range: Some(\n+                        12..16,\n+                    ),\n+                    container_name: None,\n+                    description: None,\n+                    docs: None,\n+                },\n                 kind: Bin,\n                 cfg_exprs: [],\n             },\n             Runnable {\n-                range: 22..46,\n+                nav: NavigationTarget {\n+                    file_id: FileId(\n+                        1,\n+                    ),\n+                    full_range: 22..46,\n+                    name: \"test_foo\",\n+                    kind: FN_DEF,\n+                    focus_range: Some(\n+                        33..41,\n+                    ),\n+                    container_name: None,\n+                    description: None,\n+                    docs: None,\n+                },\n                 kind: Test {\n                     test_id: Path(\n                         \"test_foo\",\n@@ -244,7 +271,20 @@ mod tests {\n                 cfg_exprs: [],\n             },\n             Runnable {\n-                range: 47..81,\n+                nav: NavigationTarget {\n+                    file_id: FileId(\n+                        1,\n+                    ),\n+                    full_range: 47..81,\n+                    name: \"test_foo\",\n+                    kind: FN_DEF,\n+                    focus_range: Some(\n+                        68..76,\n+                    ),\n+                    container_name: None,\n+                    description: None,\n+                    docs: None,\n+                },\n                 kind: Test {\n                     test_id: Path(\n                         \"test_foo\",\n@@ -279,12 +319,38 @@ mod tests {\n         @r###\"\n         [\n             Runnable {\n-                range: 1..21,\n+                nav: NavigationTarget {\n+                    file_id: FileId(\n+                        1,\n+                    ),\n+                    full_range: 1..21,\n+                    name: \"main\",\n+                    kind: FN_DEF,\n+                    focus_range: Some(\n+                        12..16,\n+                    ),\n+                    container_name: None,\n+                    description: None,\n+                    docs: None,\n+                },\n                 kind: Bin,\n                 cfg_exprs: [],\n             },\n             Runnable {\n-                range: 22..64,\n+                nav: NavigationTarget {\n+                    file_id: FileId(\n+                        1,\n+                    ),\n+                    full_range: 22..64,\n+                    name: \"foo\",\n+                    kind: FN_DEF,\n+                    focus_range: Some(\n+                        56..59,\n+                    ),\n+                    container_name: None,\n+                    description: None,\n+                    docs: None,\n+                },\n                 kind: DocTest {\n                     test_id: Path(\n                         \"foo\",\n@@ -319,12 +385,38 @@ mod tests {\n         @r###\"\n         [\n             Runnable {\n-                range: 1..21,\n+                nav: NavigationTarget {\n+                    file_id: FileId(\n+                        1,\n+                    ),\n+                    full_range: 1..21,\n+                    name: \"main\",\n+                    kind: FN_DEF,\n+                    focus_range: Some(\n+                        12..16,\n+                    ),\n+                    container_name: None,\n+                    description: None,\n+                    docs: None,\n+                },\n                 kind: Bin,\n                 cfg_exprs: [],\n             },\n             Runnable {\n-                range: 51..105,\n+                nav: NavigationTarget {\n+                    file_id: FileId(\n+                        1,\n+                    ),\n+                    full_range: 51..105,\n+                    name: \"foo\",\n+                    kind: FN_DEF,\n+                    focus_range: Some(\n+                        97..100,\n+                    ),\n+                    container_name: None,\n+                    description: None,\n+                    docs: None,\n+                },\n                 kind: DocTest {\n                     test_id: Path(\n                         \"Data::foo\",\n@@ -354,14 +446,40 @@ mod tests {\n         @r###\"\n         [\n             Runnable {\n-                range: 1..59,\n+                nav: NavigationTarget {\n+                    file_id: FileId(\n+                        1,\n+                    ),\n+                    full_range: 1..59,\n+                    name: \"test_mod\",\n+                    kind: MODULE,\n+                    focus_range: Some(\n+                        13..21,\n+                    ),\n+                    container_name: None,\n+                    description: None,\n+                    docs: None,\n+                },\n                 kind: TestMod {\n                     path: \"test_mod\",\n                 },\n                 cfg_exprs: [],\n             },\n             Runnable {\n-                range: 28..57,\n+                nav: NavigationTarget {\n+                    file_id: FileId(\n+                        1,\n+                    ),\n+                    full_range: 28..57,\n+                    name: \"test_foo1\",\n+                    kind: FN_DEF,\n+                    focus_range: Some(\n+                        43..52,\n+                    ),\n+                    container_name: None,\n+                    description: None,\n+                    docs: None,\n+                },\n                 kind: Test {\n                     test_id: Path(\n                         \"test_mod::test_foo1\",\n@@ -396,14 +514,40 @@ mod tests {\n         @r###\"\n         [\n             Runnable {\n-                range: 23..85,\n+                nav: NavigationTarget {\n+                    file_id: FileId(\n+                        1,\n+                    ),\n+                    full_range: 23..85,\n+                    name: \"test_mod\",\n+                    kind: MODULE,\n+                    focus_range: Some(\n+                        27..35,\n+                    ),\n+                    container_name: None,\n+                    description: None,\n+                    docs: None,\n+                },\n                 kind: TestMod {\n                     path: \"foo::test_mod\",\n                 },\n                 cfg_exprs: [],\n             },\n             Runnable {\n-                range: 46..79,\n+                nav: NavigationTarget {\n+                    file_id: FileId(\n+                        1,\n+                    ),\n+                    full_range: 46..79,\n+                    name: \"test_foo1\",\n+                    kind: FN_DEF,\n+                    focus_range: Some(\n+                        65..74,\n+                    ),\n+                    container_name: None,\n+                    description: None,\n+                    docs: None,\n+                },\n                 kind: Test {\n                     test_id: Path(\n                         \"foo::test_mod::test_foo1\",\n@@ -440,14 +584,40 @@ mod tests {\n         @r###\"\n         [\n             Runnable {\n-                range: 41..115,\n+                nav: NavigationTarget {\n+                    file_id: FileId(\n+                        1,\n+                    ),\n+                    full_range: 41..115,\n+                    name: \"test_mod\",\n+                    kind: MODULE,\n+                    focus_range: Some(\n+                        45..53,\n+                    ),\n+                    container_name: None,\n+                    description: None,\n+                    docs: None,\n+                },\n                 kind: TestMod {\n                     path: \"foo::bar::test_mod\",\n                 },\n                 cfg_exprs: [],\n             },\n             Runnable {\n-                range: 68..105,\n+                nav: NavigationTarget {\n+                    file_id: FileId(\n+                        1,\n+                    ),\n+                    full_range: 68..105,\n+                    name: \"test_foo1\",\n+                    kind: FN_DEF,\n+                    focus_range: Some(\n+                        91..100,\n+                    ),\n+                    container_name: None,\n+                    description: None,\n+                    docs: None,\n+                },\n                 kind: Test {\n                     test_id: Path(\n                         \"foo::bar::test_mod::test_foo1\",\n@@ -479,7 +649,20 @@ mod tests {\n         @r###\"\n         [\n             Runnable {\n-                range: 1..58,\n+                nav: NavigationTarget {\n+                    file_id: FileId(\n+                        1,\n+                    ),\n+                    full_range: 1..58,\n+                    name: \"test_foo1\",\n+                    kind: FN_DEF,\n+                    focus_range: Some(\n+                        44..53,\n+                    ),\n+                    container_name: None,\n+                    description: None,\n+                    docs: None,\n+                },\n                 kind: Test {\n                     test_id: Path(\n                         \"test_foo1\",\n@@ -516,7 +699,20 @@ mod tests {\n         @r###\"\n         [\n             Runnable {\n-                range: 1..80,\n+                nav: NavigationTarget {\n+                    file_id: FileId(\n+                        1,\n+                    ),\n+                    full_range: 1..80,\n+                    name: \"test_foo1\",\n+                    kind: FN_DEF,\n+                    focus_range: Some(\n+                        66..75,\n+                    ),\n+                    container_name: None,\n+                    description: None,\n+                    docs: None,\n+                },\n                 kind: Test {\n                     test_id: Path(\n                         \"test_foo1\","}, {"sha": "4b7444039e7b9b448126b7e5f09f21f7659d18ac", "filename": "crates/ra_project_model/src/cargo_workspace.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cb482e6351c4005f29bb89d38c64c4e3f93d7a6d/crates%2Fra_project_model%2Fsrc%2Fcargo_workspace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cb482e6351c4005f29bb89d38c64c4e3f93d7a6d/crates%2Fra_project_model%2Fsrc%2Fcargo_workspace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_project_model%2Fsrc%2Fcargo_workspace.rs?ref=cb482e6351c4005f29bb89d38c64c4e3f93d7a6d", "patch": "@@ -64,7 +64,7 @@ impl Default for CargoConfig {\n     fn default() -> Self {\n         CargoConfig {\n             no_default_features: false,\n-            all_features: true,\n+            all_features: false,\n             features: Vec::new(),\n             load_out_dirs_from_check: false,\n             target: None,"}, {"sha": "673795e781e679dc675284b1f552ce4663fdd0e3", "filename": "crates/rust-analyzer/src/caps.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/cb482e6351c4005f29bb89d38c64c4e3f93d7a6d/crates%2Frust-analyzer%2Fsrc%2Fcaps.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cb482e6351c4005f29bb89d38c64c4e3f93d7a6d/crates%2Frust-analyzer%2Fsrc%2Fcaps.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fcaps.rs?ref=cb482e6351c4005f29bb89d38c64c4e3f93d7a6d", "patch": "@@ -87,6 +87,9 @@ pub fn server_capabilities(client_caps: &ClientCapabilities) -> ServerCapabiliti\n             \"ssr\": true,\n             \"onEnter\": true,\n             \"parentModule\": true,\n+            \"runnables\": {\n+                \"kinds\": [ \"cargo\" ],\n+            },\n         })),\n     }\n }"}, {"sha": "008518a089ffde0b43e6c13ad7b4d14f862280ba", "filename": "crates/rust-analyzer/src/cargo_target_spec.rs", "status": "modified", "additions": 80, "deletions": 5, "changes": 85, "blob_url": "https://github.com/rust-lang/rust/blob/cb482e6351c4005f29bb89d38c64c4e3f93d7a6d/crates%2Frust-analyzer%2Fsrc%2Fcargo_target_spec.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cb482e6351c4005f29bb89d38c64c4e3f93d7a6d/crates%2Frust-analyzer%2Fsrc%2Fcargo_target_spec.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fcargo_target_spec.rs?ref=cb482e6351c4005f29bb89d38c64c4e3f93d7a6d", "patch": "@@ -1,10 +1,10 @@\n //! See `CargoTargetSpec`\n \n+use ra_cfg::CfgExpr;\n use ra_ide::{FileId, RunnableKind, TestId};\n use ra_project_model::{self, ProjectWorkspace, TargetKind};\n \n use crate::{world::WorldSnapshot, Result};\n-use ra_syntax::SmolStr;\n \n /// Abstract representation of Cargo target.\n ///\n@@ -21,7 +21,7 @@ impl CargoTargetSpec {\n     pub(crate) fn runnable_args(\n         spec: Option<CargoTargetSpec>,\n         kind: &RunnableKind,\n-        features_needed: &Vec<SmolStr>,\n+        cfgs: &[CfgExpr],\n     ) -> Result<(Vec<String>, Vec<String>)> {\n         let mut args = Vec::new();\n         let mut extra_args = Vec::new();\n@@ -76,10 +76,14 @@ impl CargoTargetSpec {\n             }\n         }\n \n-        features_needed.iter().for_each(|feature| {\n+        let mut features = Vec::new();\n+        for cfg in cfgs {\n+            required_features(cfg, &mut features);\n+        }\n+        for feature in features {\n             args.push(\"--features\".to_string());\n-            args.push(feature.to_string());\n-        });\n+            args.push(feature);\n+        }\n \n         Ok((args, extra_args))\n     }\n@@ -140,3 +144,74 @@ impl CargoTargetSpec {\n         }\n     }\n }\n+\n+/// Fill minimal features needed\n+fn required_features(cfg_expr: &CfgExpr, features: &mut Vec<String>) {\n+    match cfg_expr {\n+        CfgExpr::KeyValue { key, value } if key == \"feature\" => features.push(value.to_string()),\n+        CfgExpr::All(preds) => {\n+            preds.iter().for_each(|cfg| required_features(cfg, features));\n+        }\n+        CfgExpr::Any(preds) => {\n+            for cfg in preds {\n+                let len_features = features.len();\n+                required_features(cfg, features);\n+                if len_features != features.len() {\n+                    break;\n+                }\n+            }\n+        }\n+        _ => {}\n+    }\n+}\n+\n+#[cfg(test)]\n+mod tests {\n+    use super::*;\n+\n+    use mbe::{ast_to_token_tree, TokenMap};\n+    use ra_cfg::parse_cfg;\n+    use ra_syntax::{\n+        ast::{self, AstNode},\n+        SmolStr,\n+    };\n+\n+    fn get_token_tree_generated(input: &str) -> (tt::Subtree, TokenMap) {\n+        let source_file = ast::SourceFile::parse(input).ok().unwrap();\n+        let tt = source_file.syntax().descendants().find_map(ast::TokenTree::cast).unwrap();\n+        ast_to_token_tree(&tt).unwrap()\n+    }\n+\n+    #[test]\n+    fn test_cfg_expr_minimal_features_needed() {\n+        let (subtree, _) = get_token_tree_generated(r#\"#![cfg(feature = \"baz\")]\"#);\n+        let cfg_expr = parse_cfg(&subtree);\n+        let mut min_features = vec![];\n+        required_features(&cfg_expr, &mut min_features);\n+\n+        assert_eq!(min_features, vec![SmolStr::new(\"baz\")]);\n+\n+        let (subtree, _) =\n+            get_token_tree_generated(r#\"#![cfg(all(feature = \"baz\", feature = \"foo\"))]\"#);\n+        let cfg_expr = parse_cfg(&subtree);\n+\n+        let mut min_features = vec![];\n+        required_features(&cfg_expr, &mut min_features);\n+        assert_eq!(min_features, vec![SmolStr::new(\"baz\"), SmolStr::new(\"foo\")]);\n+\n+        let (subtree, _) =\n+            get_token_tree_generated(r#\"#![cfg(any(feature = \"baz\", feature = \"foo\", unix))]\"#);\n+        let cfg_expr = parse_cfg(&subtree);\n+\n+        let mut min_features = vec![];\n+        required_features(&cfg_expr, &mut min_features);\n+        assert_eq!(min_features, vec![SmolStr::new(\"baz\")]);\n+\n+        let (subtree, _) = get_token_tree_generated(r#\"#![cfg(foo)]\"#);\n+        let cfg_expr = parse_cfg(&subtree);\n+\n+        let mut min_features = vec![];\n+        required_features(&cfg_expr, &mut min_features);\n+        assert!(min_features.is_empty());\n+    }\n+}"}, {"sha": "3337078ace82db5e5374d69748c96bd0e97ee1d4", "filename": "crates/rust-analyzer/src/config.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cb482e6351c4005f29bb89d38c64c4e3f93d7a6d/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cb482e6351c4005f29bb89d38c64c4e3f93d7a6d/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs?ref=cb482e6351c4005f29bb89d38c64c4e3f93d7a6d", "patch": "@@ -123,7 +123,7 @@ impl Default for Config {\n             check: Some(FlycheckConfig::CargoCommand {\n                 command: \"check\".to_string(),\n                 all_targets: true,\n-                all_features: true,\n+                all_features: false,\n                 extra_args: Vec::new(),\n             }),\n "}, {"sha": "4b436c3013f21daa37688f8766902fc19bcd886a", "filename": "crates/rust-analyzer/src/lsp_ext.rs", "status": "modified", "additions": 18, "deletions": 13, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/cb482e6351c4005f29bb89d38c64c4e3f93d7a6d/crates%2Frust-analyzer%2Fsrc%2Flsp_ext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cb482e6351c4005f29bb89d38c64c4e3f93d7a6d/crates%2Frust-analyzer%2Fsrc%2Flsp_ext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Flsp_ext.rs?ref=cb482e6351c4005f29bb89d38c64c4e3f93d7a6d", "patch": "@@ -4,7 +4,6 @@ use std::{collections::HashMap, path::PathBuf};\n \n use lsp_types::request::Request;\n use lsp_types::{Position, Range, TextDocumentIdentifier};\n-use rustc_hash::FxHashMap;\n use serde::{Deserialize, Serialize};\n \n pub enum AnalyzerStatus {}\n@@ -128,7 +127,7 @@ pub enum Runnables {}\n impl Request for Runnables {\n     type Params = RunnablesParams;\n     type Result = Vec<Runnable>;\n-    const METHOD: &'static str = \"rust-analyzer/runnables\";\n+    const METHOD: &'static str = \"experimental/runnables\";\n }\n \n #[derive(Serialize, Deserialize, Debug)]\n@@ -138,25 +137,31 @@ pub struct RunnablesParams {\n     pub position: Option<Position>,\n }\n \n-// Must strictly correspond to the executable name\n+#[derive(Deserialize, Serialize, Debug)]\n+#[serde(rename_all = \"camelCase\")]\n+pub struct Runnable {\n+    pub label: String,\n+    #[serde(skip_serializing_if = \"Option::is_none\")]\n+    pub location: Option<lsp_types::LocationLink>,\n+    pub kind: RunnableKind,\n+    pub args: CargoRunnable,\n+}\n+\n #[derive(Serialize, Deserialize, Debug)]\n #[serde(rename_all = \"lowercase\")]\n pub enum RunnableKind {\n     Cargo,\n-    Rustc,\n-    Rustup,\n }\n \n #[derive(Deserialize, Serialize, Debug)]\n #[serde(rename_all = \"camelCase\")]\n-pub struct Runnable {\n-    pub range: Range,\n-    pub label: String,\n-    pub kind: RunnableKind,\n-    pub args: Vec<String>,\n-    pub extra_args: Vec<String>,\n-    pub env: FxHashMap<String, String>,\n-    pub cwd: Option<PathBuf>,\n+pub struct CargoRunnable {\n+    #[serde(skip_serializing_if = \"Option::is_none\")]\n+    pub workspace_root: Option<PathBuf>,\n+    // command, --package and --lib stuff\n+    pub cargo_args: Vec<String>,\n+    // stuff after --\n+    pub executable_args: Vec<String>,\n }\n \n pub enum InlayHints {}"}, {"sha": "3c40644414bb01a7b80dccc9aee5e092f1b327a7", "filename": "crates/rust-analyzer/src/main_loop/handlers.rs", "status": "modified", "additions": 27, "deletions": 138, "changes": 165, "blob_url": "https://github.com/rust-lang/rust/blob/cb482e6351c4005f29bb89d38c64c4e3f93d7a6d/crates%2Frust-analyzer%2Fsrc%2Fmain_loop%2Fhandlers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cb482e6351c4005f29bb89d38c64c4e3f93d7a6d/crates%2Frust-analyzer%2Fsrc%2Fmain_loop%2Fhandlers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fmain_loop%2Fhandlers.rs?ref=cb482e6351c4005f29bb89d38c64c4e3f93d7a6d", "patch": "@@ -17,15 +17,12 @@ use lsp_types::{\n     SemanticTokensParams, SemanticTokensRangeParams, SemanticTokensRangeResult,\n     SemanticTokensResult, SymbolInformation, TextDocumentIdentifier, Url, WorkspaceEdit,\n };\n-use ra_cfg::CfgExpr;\n use ra_ide::{\n-    FileId, FilePosition, FileRange, Query, RangeInfo, Runnable, RunnableKind, SearchScope,\n-    TextEdit,\n+    FileId, FilePosition, FileRange, Query, RangeInfo, RunnableKind, SearchScope, TextEdit,\n };\n use ra_prof::profile;\n use ra_project_model::TargetKind;\n-use ra_syntax::{AstNode, SmolStr, SyntaxKind, TextRange, TextSize};\n-use rustc_hash::FxHashMap;\n+use ra_syntax::{AstNode, SyntaxKind, TextRange, TextSize};\n use serde::{Deserialize, Serialize};\n use serde_json::to_value;\n use stdx::format_to;\n@@ -403,7 +400,7 @@ pub fn handle_runnables(\n     let cargo_spec = CargoTargetSpec::for_file(&world, file_id)?;\n     for runnable in world.analysis().runnables(file_id)? {\n         if let Some(offset) = offset {\n-            if !runnable.range.contains_inclusive(offset) {\n+            if !runnable.nav.full_range().contains_inclusive(offset) {\n                 continue;\n             }\n         }\n@@ -416,33 +413,39 @@ pub fn handle_runnables(\n                 }\n             }\n         }\n-        res.push(to_lsp_runnable(&world, file_id, runnable)?);\n+        res.push(to_proto::runnable(&world, file_id, runnable)?);\n     }\n \n     // Add `cargo check` and `cargo test` for the whole package\n     match cargo_spec {\n         Some(spec) => {\n             for &cmd in [\"check\", \"test\"].iter() {\n                 res.push(lsp_ext::Runnable {\n-                    range: Default::default(),\n                     label: format!(\"cargo {} -p {}\", cmd, spec.package),\n+                    location: None,\n                     kind: lsp_ext::RunnableKind::Cargo,\n-                    args: vec![cmd.to_string(), \"--package\".to_string(), spec.package.clone()],\n-                    extra_args: Vec::new(),\n-                    env: FxHashMap::default(),\n-                    cwd: workspace_root.map(|root| root.to_owned()),\n+                    args: lsp_ext::CargoRunnable {\n+                        workspace_root: workspace_root.map(|root| root.to_owned()),\n+                        cargo_args: vec![\n+                            cmd.to_string(),\n+                            \"--package\".to_string(),\n+                            spec.package.clone(),\n+                        ],\n+                        executable_args: Vec::new(),\n+                    },\n                 })\n             }\n         }\n         None => {\n             res.push(lsp_ext::Runnable {\n-                range: Default::default(),\n                 label: \"cargo check --workspace\".to_string(),\n+                location: None,\n                 kind: lsp_ext::RunnableKind::Cargo,\n-                args: vec![\"check\".to_string(), \"--workspace\".to_string()],\n-                extra_args: Vec::new(),\n-                env: FxHashMap::default(),\n-                cwd: workspace_root.map(|root| root.to_owned()),\n+                args: lsp_ext::CargoRunnable {\n+                    workspace_root: workspace_root.map(|root| root.to_owned()),\n+                    cargo_args: vec![\"check\".to_string(), \"--workspace\".to_string()],\n+                    executable_args: Vec::new(),\n+                },\n             });\n         }\n     }\n@@ -755,11 +758,11 @@ pub fn handle_code_action(\n     if world.config.client_caps.resolve_code_action {\n         for assist in world.analysis().unresolved_assists(&world.config.assist, frange)?.into_iter()\n         {\n-            res.push(to_proto::unresolved_code_action(&world, assist)?.into());\n+            res.push(to_proto::unresolved_code_action(&world, assist)?);\n         }\n     } else {\n         for assist in world.analysis().resolved_assists(&world.config.assist, frange)?.into_iter() {\n-            res.push(to_proto::resolved_code_action(&world, assist)?.into());\n+            res.push(to_proto::resolved_code_action(&world, assist)?);\n         }\n     }\n \n@@ -782,7 +785,7 @@ pub fn handle_resolve_code_action(\n     let mut res: Vec<lsp_ext::CodeAction> = Vec::new();\n \n     for assist in world.analysis().resolved_assists(&world.config.assist, frange)?.into_iter() {\n-        res.push(to_proto::resolved_code_action(&world, assist)?.into());\n+        res.push(to_proto::resolved_code_action(&world, assist)?);\n     }\n     Ok(res\n         .into_iter()\n@@ -833,10 +836,11 @@ pub fn handle_code_lens(\n                 }\n             };\n \n-            let mut r = to_lsp_runnable(&world, file_id, runnable)?;\n+            let range = to_proto::range(&line_index, runnable.nav.range());\n+            let r = to_proto::runnable(&world, file_id, runnable)?;\n             if world.config.lens.run {\n                 let lens = CodeLens {\n-                    range: r.range,\n+                    range,\n                     command: Some(Command {\n                         title: run_title.to_string(),\n                         command: \"rust-analyzer.runSingle\".into(),\n@@ -848,13 +852,8 @@ pub fn handle_code_lens(\n             }\n \n             if debugee && world.config.lens.debug {\n-                if r.args[0] == \"run\" {\n-                    r.args[0] = \"build\".into();\n-                } else {\n-                    r.args.push(\"--no-run\".into());\n-                }\n                 let debug_lens = CodeLens {\n-                    range: r.range,\n+                    range,\n                     command: Some(Command {\n                         title: \"Debug\".into(),\n                         command: \"rust-analyzer.debugSingle\".into(),\n@@ -1008,65 +1007,6 @@ pub fn publish_diagnostics(world: &WorldSnapshot, file_id: FileId) -> Result<Dia\n     Ok(DiagnosticTask::SetNative(file_id, diagnostics))\n }\n \n-fn to_lsp_runnable(\n-    world: &WorldSnapshot,\n-    file_id: FileId,\n-    runnable: Runnable,\n-) -> Result<lsp_ext::Runnable> {\n-    let spec = CargoTargetSpec::for_file(world, file_id)?;\n-    let target = spec.as_ref().map(|s| s.target.clone());\n-    let mut features_needed = vec![];\n-    for cfg_expr in &runnable.cfg_exprs {\n-        collect_minimal_features_needed(cfg_expr, &mut features_needed);\n-    }\n-    let (args, extra_args) =\n-        CargoTargetSpec::runnable_args(spec, &runnable.kind, &features_needed)?;\n-    let line_index = world.analysis().file_line_index(file_id)?;\n-    let label = match &runnable.kind {\n-        RunnableKind::Test { test_id, .. } => format!(\"test {}\", test_id),\n-        RunnableKind::TestMod { path } => format!(\"test-mod {}\", path),\n-        RunnableKind::Bench { test_id } => format!(\"bench {}\", test_id),\n-        RunnableKind::DocTest { test_id, .. } => format!(\"doctest {}\", test_id),\n-        RunnableKind::Bin => {\n-            target.map_or_else(|| \"run binary\".to_string(), |t| format!(\"run {}\", t))\n-        }\n-    };\n-\n-    Ok(lsp_ext::Runnable {\n-        range: to_proto::range(&line_index, runnable.range),\n-        label,\n-        kind: lsp_ext::RunnableKind::Cargo,\n-        args,\n-        extra_args,\n-        env: {\n-            let mut m = FxHashMap::default();\n-            m.insert(\"RUST_BACKTRACE\".to_string(), \"short\".to_string());\n-            m\n-        },\n-        cwd: world.workspace_root_for(file_id).map(|root| root.to_owned()),\n-    })\n-}\n-\n-/// Fill minimal features needed\n-fn collect_minimal_features_needed(cfg_expr: &CfgExpr, features: &mut Vec<SmolStr>) {\n-    match cfg_expr {\n-        CfgExpr::KeyValue { key, value } if key == \"feature\" => features.push(value.clone()),\n-        CfgExpr::All(preds) => {\n-            preds.iter().for_each(|cfg| collect_minimal_features_needed(cfg, features));\n-        }\n-        CfgExpr::Any(preds) => {\n-            for cfg in preds {\n-                let len_features = features.len();\n-                collect_minimal_features_needed(cfg, features);\n-                if len_features != features.len() {\n-                    break;\n-                }\n-            }\n-        }\n-        _ => {}\n-    }\n-}\n-\n pub fn handle_inlay_hints(\n     world: WorldSnapshot,\n     params: InlayHintsParams,\n@@ -1203,54 +1143,3 @@ pub fn handle_semantic_tokens_range(\n     let semantic_tokens = to_proto::semantic_tokens(&text, &line_index, highlights);\n     Ok(Some(semantic_tokens.into()))\n }\n-\n-#[cfg(test)]\n-mod tests {\n-    use super::*;\n-\n-    use mbe::{ast_to_token_tree, TokenMap};\n-    use ra_cfg::parse_cfg;\n-    use ra_syntax::{\n-        ast::{self, AstNode},\n-        SmolStr,\n-    };\n-\n-    fn get_token_tree_generated(input: &str) -> (tt::Subtree, TokenMap) {\n-        let source_file = ast::SourceFile::parse(input).ok().unwrap();\n-        let tt = source_file.syntax().descendants().find_map(ast::TokenTree::cast).unwrap();\n-        ast_to_token_tree(&tt).unwrap()\n-    }\n-\n-    #[test]\n-    fn test_cfg_expr_minimal_features_needed() {\n-        let (subtree, _) = get_token_tree_generated(r#\"#![cfg(feature = \"baz\")]\"#);\n-        let cfg_expr = parse_cfg(&subtree);\n-        let mut min_features = vec![];\n-        collect_minimal_features_needed(&cfg_expr, &mut min_features);\n-\n-        assert_eq!(min_features, vec![SmolStr::new(\"baz\")]);\n-\n-        let (subtree, _) =\n-            get_token_tree_generated(r#\"#![cfg(all(feature = \"baz\", feature = \"foo\"))]\"#);\n-        let cfg_expr = parse_cfg(&subtree);\n-\n-        let mut min_features = vec![];\n-        collect_minimal_features_needed(&cfg_expr, &mut min_features);\n-        assert_eq!(min_features, vec![SmolStr::new(\"baz\"), SmolStr::new(\"foo\")]);\n-\n-        let (subtree, _) =\n-            get_token_tree_generated(r#\"#![cfg(any(feature = \"baz\", feature = \"foo\", unix))]\"#);\n-        let cfg_expr = parse_cfg(&subtree);\n-\n-        let mut min_features = vec![];\n-        collect_minimal_features_needed(&cfg_expr, &mut min_features);\n-        assert_eq!(min_features, vec![SmolStr::new(\"baz\")]);\n-\n-        let (subtree, _) = get_token_tree_generated(r#\"#![cfg(foo)]\"#);\n-        let cfg_expr = parse_cfg(&subtree);\n-\n-        let mut min_features = vec![];\n-        collect_minimal_features_needed(&cfg_expr, &mut min_features);\n-        assert!(min_features.is_empty());\n-    }\n-}"}, {"sha": "3672b1a26026be81927d5ec382f618d4303e183a", "filename": "crates/rust-analyzer/src/to_proto.rs", "status": "modified", "additions": 36, "deletions": 2, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/cb482e6351c4005f29bb89d38c64c4e3f93d7a6d/crates%2Frust-analyzer%2Fsrc%2Fto_proto.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cb482e6351c4005f29bb89d38c64c4e3f93d7a6d/crates%2Frust-analyzer%2Fsrc%2Fto_proto.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fto_proto.rs?ref=cb482e6351c4005f29bb89d38c64c4e3f93d7a6d", "patch": "@@ -4,12 +4,14 @@ use ra_ide::{\n     Assist, CompletionItem, CompletionItemKind, Documentation, FileSystemEdit, Fold, FoldKind,\n     FunctionSignature, Highlight, HighlightModifier, HighlightTag, HighlightedRange, Indel,\n     InlayHint, InlayKind, InsertTextFormat, LineIndex, NavigationTarget, ReferenceAccess,\n-    ResolvedAssist, Severity, SourceChange, SourceFileEdit, TextEdit,\n+    ResolvedAssist, Runnable, RunnableKind, Severity, SourceChange, SourceFileEdit, TextEdit,\n };\n use ra_syntax::{SyntaxKind, TextRange, TextSize};\n use ra_vfs::LineEndings;\n \n-use crate::{lsp_ext, semantic_tokens, world::WorldSnapshot, Result};\n+use crate::{\n+    cargo_target_spec::CargoTargetSpec, lsp_ext, semantic_tokens, world::WorldSnapshot, Result,\n+};\n \n pub(crate) fn position(line_index: &LineIndex, offset: TextSize) -> lsp_types::Position {\n     let line_col = line_index.line_col(offset);\n@@ -658,3 +660,35 @@ pub(crate) fn resolved_code_action(\n     };\n     Ok(res)\n }\n+\n+pub(crate) fn runnable(\n+    world: &WorldSnapshot,\n+    file_id: FileId,\n+    runnable: Runnable,\n+) -> Result<lsp_ext::Runnable> {\n+    let spec = CargoTargetSpec::for_file(world, file_id)?;\n+    let target = spec.as_ref().map(|s| s.target.clone());\n+    let (cargo_args, executable_args) =\n+        CargoTargetSpec::runnable_args(spec, &runnable.kind, &runnable.cfg_exprs)?;\n+    let label = match &runnable.kind {\n+        RunnableKind::Test { test_id, .. } => format!(\"test {}\", test_id),\n+        RunnableKind::TestMod { path } => format!(\"test-mod {}\", path),\n+        RunnableKind::Bench { test_id } => format!(\"bench {}\", test_id),\n+        RunnableKind::DocTest { test_id, .. } => format!(\"doctest {}\", test_id),\n+        RunnableKind::Bin => {\n+            target.map_or_else(|| \"run binary\".to_string(), |t| format!(\"run {}\", t))\n+        }\n+    };\n+    let location = location_link(world, None, runnable.nav)?;\n+\n+    Ok(lsp_ext::Runnable {\n+        label,\n+        location: Some(location),\n+        kind: lsp_ext::RunnableKind::Cargo,\n+        args: lsp_ext::CargoRunnable {\n+            workspace_root: world.workspace_root_for(file_id).map(|root| root.to_owned()),\n+            cargo_args,\n+            executable_args,\n+        },\n+    })\n+}"}, {"sha": "e18f973b824ca6a64c98ef014f2df6791c829a55", "filename": "crates/rust-analyzer/tests/heavy_tests/main.rs", "status": "modified", "additions": 59, "deletions": 54, "changes": 113, "blob_url": "https://github.com/rust-lang/rust/blob/cb482e6351c4005f29bb89d38c64c4e3f93d7a6d/crates%2Frust-analyzer%2Ftests%2Fheavy_tests%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cb482e6351c4005f29bb89d38c64c4e3f93d7a6d/crates%2Frust-analyzer%2Ftests%2Fheavy_tests%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Ftests%2Fheavy_tests%2Fmain.rs?ref=cb482e6351c4005f29bb89d38c64c4e3f93d7a6d", "patch": "@@ -76,30 +76,33 @@ fn foo() {\n     server.request::<Runnables>(\n         RunnablesParams { text_document: server.doc_id(\"lib.rs\"), position: None },\n         json!([\n-          {\n-            \"args\": [ \"test\" ],\n-            \"extraArgs\": [ \"foo\", \"--nocapture\" ],\n-            \"kind\": \"cargo\",\n-            \"env\": { \"RUST_BACKTRACE\": \"short\" },\n-            \"cwd\": null,\n-            \"label\": \"test foo\",\n-            \"range\": {\n-              \"end\": { \"character\": 1, \"line\": 2 },\n-              \"start\": { \"character\": 0, \"line\": 0 }\n-            }\n-          },\n-          {\n-            \"args\": [\"check\", \"--workspace\"],\n-            \"extraArgs\": [],\n-            \"kind\": \"cargo\",\n-            \"env\": {},\n-            \"cwd\": null,\n-            \"label\": \"cargo check --workspace\",\n-            \"range\": {\n-              \"end\": { \"character\": 0, \"line\": 0 },\n-              \"start\": { \"character\": 0, \"line\": 0 }\n+            {\n+              \"args\": {\n+                \"cargoArgs\": [\"test\"],\n+                \"executableArgs\": [\"foo\", \"--nocapture\"],\n+              },\n+              \"kind\": \"cargo\",\n+              \"label\": \"test foo\",\n+              \"location\": {\n+                \"targetRange\": {\n+                  \"end\": { \"character\": 1, \"line\": 2 },\n+                  \"start\": { \"character\": 0, \"line\": 0 }\n+                },\n+                \"targetSelectionRange\": {\n+                  \"end\": { \"character\": 6, \"line\": 1 },\n+                  \"start\": { \"character\": 3, \"line\": 1 }\n+                },\n+                \"targetUri\": \"file:///[..]/lib.rs\"\n+              }\n+            },\n+            {\n+              \"args\": {\n+                \"cargoArgs\": [\"check\", \"--workspace\"],\n+                \"executableArgs\": [],\n+              },\n+              \"kind\": \"cargo\",\n+              \"label\": \"cargo check --workspace\"\n             }\n-          }\n         ]),\n     );\n }\n@@ -138,42 +141,44 @@ fn main() {}\n     server.request::<Runnables>(\n         RunnablesParams { text_document: server.doc_id(\"foo/tests/spam.rs\"), position: None },\n         json!([\n-            {\n-              \"args\": [ \"test\", \"--package\", \"foo\", \"--test\", \"spam\" ],\n-              \"extraArgs\": [ \"test_eggs\", \"--exact\", \"--nocapture\" ],\n-              \"kind\": \"cargo\",\n-              \"env\": { \"RUST_BACKTRACE\": \"short\" },\n-              \"label\": \"test test_eggs\",\n-              \"range\": {\n-                \"end\": { \"character\": 17, \"line\": 1 },\n-                \"start\": { \"character\": 0, \"line\": 0 }\n-              },\n-              \"cwd\": server.path().join(\"foo\")\n+          {\n+            \"args\": {\n+              \"cargoArgs\": [\"test\", \"--package\", \"foo\", \"--test\", \"spam\"],\n+              \"executableArgs\": [\"test_eggs\", \"--exact\", \"--nocapture\"],\n+              \"workspaceRoot\": server.path().join(\"foo\")\n             },\n-            {\n-              \"args\": [ \"check\", \"--package\", \"foo\" ],\n-              \"extraArgs\": [],\n-              \"kind\": \"cargo\",\n-              \"env\": {},\n-              \"label\": \"cargo check -p foo\",\n-              \"range\": {\n-                \"end\": { \"character\": 0, \"line\": 0 },\n+            \"kind\": \"cargo\",\n+            \"label\": \"test test_eggs\",\n+            \"location\": {\n+              \"targetRange\": {\n+                \"end\": { \"character\": 17, \"line\": 1 },\n                 \"start\": { \"character\": 0, \"line\": 0 }\n               },\n-              \"cwd\": server.path().join(\"foo\")\n-            },\n-            {\n-              \"args\": [ \"test\", \"--package\", \"foo\" ],\n-              \"extraArgs\": [],\n-              \"kind\": \"cargo\",\n-              \"env\": {},\n-              \"label\": \"cargo test -p foo\",\n-              \"range\": {\n-                \"end\": { \"character\": 0, \"line\": 0 },\n-                \"start\": { \"character\": 0, \"line\": 0 }\n+              \"targetSelectionRange\": {\n+                \"end\": { \"character\": 12, \"line\": 1 },\n+                \"start\": { \"character\": 3, \"line\": 1 }\n               },\n-              \"cwd\": server.path().join(\"foo\")\n+              \"targetUri\": \"file:///[..]/tests/spam.rs\"\n             }\n+          },\n+          {\n+            \"args\": {\n+              \"cargoArgs\": [\"check\", \"--package\", \"foo\"],\n+              \"executableArgs\": [],\n+              \"workspaceRoot\": server.path().join(\"foo\")\n+            },\n+            \"kind\": \"cargo\",\n+            \"label\": \"cargo check -p foo\"\n+          },\n+          {\n+            \"args\": {\n+              \"cargoArgs\": [\"test\", \"--package\", \"foo\"],\n+              \"executableArgs\": [],\n+              \"workspaceRoot\": server.path().join(\"foo\")\n+            },\n+            \"kind\": \"cargo\",\n+            \"label\": \"cargo test -p foo\"\n+          }\n         ]),\n     );\n }"}, {"sha": "647cf6107565c3e6d19829a28908a88e8d85a3b1", "filename": "docs/dev/lsp-extensions.md", "status": "modified", "additions": 44, "deletions": 36, "changes": 80, "blob_url": "https://github.com/rust-lang/rust/blob/cb482e6351c4005f29bb89d38c64c4e3f93d7a6d/docs%2Fdev%2Flsp-extensions.md", "raw_url": "https://github.com/rust-lang/rust/raw/cb482e6351c4005f29bb89d38c64c4e3f93d7a6d/docs%2Fdev%2Flsp-extensions.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/docs%2Fdev%2Flsp-extensions.md?ref=cb482e6351c4005f29bb89d38c64c4e3f93d7a6d", "patch": "@@ -311,6 +311,50 @@ Moreover, it would be cool if editors didn't need to implement even basic langua\n   This is how `SelectionRange` request works.\n * Alternatively, should we perhaps flag certain `SelectionRange`s as being brace pairs?\n \n+## Runnables\n+\n+**Issue:** https://github.com/microsoft/language-server-protocol/issues/944\n+\n+**Server Capability:** `{ \"runnables\": { \"kinds\": string[] } }`\n+\n+This request is send from client to server to get the list of things that can be run (tests, binaries, `cargo check -p`).\n+\n+**Method:** `experimental/runnables`\n+\n+**Request:**\n+\n+```typescript\n+interface RunnablesParams {\n+    textDocument: TextDocumentIdentifier;\n+    /// If null, compute runnables for the whole file.\n+    position?: Position;\n+}\n+```\n+\n+**Response:** `Runnable[]`\n+\n+```typescript\n+interface Runnable {\n+    label: string;\n+    /// If this Runnable is associated with a specific function/module, etc, the location of this item\n+    location?: LocationLink;\n+    /// Running things is necessary technology specific, `kind` needs to be advertised via server capabilities,\n+    // the type of `args` is specific to `kind`. The actual running is handled by the client.\n+    kind: string;\n+    args: any;\n+}\n+```\n+\n+rust-analyzer supports only one `kind`, `\"cargo\"`. The `args` for `\"cargo\"` look like this:\n+\n+```typescript\n+{\n+    workspaceRoot?: string;\n+    cargoArgs: string[];\n+    executableArgs: string[];\n+}\n+```\n+\n ## Analyzer Status\n \n **Method:** `rust-analyzer/analyzerStatus`\n@@ -399,39 +443,3 @@ interface InlayHint {\n     label: string,\n }\n ```\n-\n-## Runnables\n-\n-**Method:** `rust-analyzer/runnables`\n-\n-This request is send from client to server to get the list of things that can be run (tests, binaries, `cargo check -p`).\n-Note that we plan to move this request to `experimental/runnables`, as it is not really Rust-specific, but the current API is not necessary the right one.\n-Upstream issue: https://github.com/microsoft/language-server-protocol/issues/944\n-\n-**Request:**\n-\n-```typescript\n-interface RunnablesParams {\n-    textDocument: TextDocumentIdentifier;\n-    /// If null, compute runnables for the whole file.\n-    position?: Position;\n-}\n-```\n-\n-**Response:** `Runnable[]`\n-\n-```typescript\n-interface Runnable {\n-    /// The range this runnable is applicable for.\n-    range: lc.Range;\n-    /// The label to show in the UI.\n-    label: string;\n-    /// The following fields describe a process to spawn.\n-    kind: \"cargo\" | \"rustc\" | \"rustup\";\n-    args: string[];\n-    /// Args for cargo after `--`.\n-    extraArgs: string[];\n-    env: { [key: string]: string };\n-    cwd: string | null;\n-}\n-```"}, {"sha": "d8f4287fd88c58fc81ca6f1fa09fe064798adf09", "filename": "editors/code/package.json", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/cb482e6351c4005f29bb89d38c64c4e3f93d7a6d/editors%2Fcode%2Fpackage.json", "raw_url": "https://github.com/rust-lang/rust/raw/cb482e6351c4005f29bb89d38c64c4e3f93d7a6d/editors%2Fcode%2Fpackage.json", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fpackage.json?ref=cb482e6351c4005f29bb89d38c64c4e3f93d7a6d", "patch": "@@ -238,7 +238,7 @@\n                 },\n                 \"rust-analyzer.cargo.allFeatures\": {\n                     \"type\": \"boolean\",\n-                    \"default\": true,\n+                    \"default\": false,\n                     \"description\": \"Activate all available features\"\n                 },\n                 \"rust-analyzer.cargo.features\": {\n@@ -319,7 +319,7 @@\n                 },\n                 \"rust-analyzer.checkOnSave.allFeatures\": {\n                     \"type\": \"boolean\",\n-                    \"default\": true,\n+                    \"default\": false,\n                     \"markdownDescription\": \"Check with all features (will be passed as `--all-features`)\"\n                 },\n                 \"rust-analyzer.inlayHints.enable\": {"}, {"sha": "a0c9b3ab2e64a04414e6641b14e7fc74bbae44c5", "filename": "editors/code/src/debug.ts", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/cb482e6351c4005f29bb89d38c64c4e3f93d7a6d/editors%2Fcode%2Fsrc%2Fdebug.ts", "raw_url": "https://github.com/rust-lang/rust/raw/cb482e6351c4005f29bb89d38c64c4e3f93d7a6d/editors%2Fcode%2Fsrc%2Fdebug.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fdebug.ts?ref=cb482e6351c4005f29bb89d38c64c4e3f93d7a6d", "patch": "@@ -114,8 +114,8 @@ async function getDebugConfiguration(ctx: Ctx, runnable: ra.Runnable): Promise<v\n }\n \n async function getDebugExecutable(runnable: ra.Runnable): Promise<string> {\n-    const cargo = new Cargo(runnable.cwd || '.', debugOutput);\n-    const executable = await cargo.executableFromArgs(runnable.args);\n+    const cargo = new Cargo(runnable.args.workspaceRoot || '.', debugOutput);\n+    const executable = await cargo.executableFromArgs(runnable.args.cargoArgs);\n \n     // if we are here, there were no compilation errors.\n     return executable;\n@@ -127,8 +127,8 @@ function getLldbDebugConfig(runnable: ra.Runnable, executable: string, sourceFil\n         request: \"launch\",\n         name: runnable.label,\n         program: executable,\n-        args: runnable.extraArgs,\n-        cwd: runnable.cwd,\n+        args: runnable.args.executableArgs,\n+        cwd: runnable.args.workspaceRoot,\n         sourceMap: sourceFileMap,\n         sourceLanguages: [\"rust\"]\n     };\n@@ -140,8 +140,8 @@ function getCppvsDebugConfig(runnable: ra.Runnable, executable: string, sourceFi\n         request: \"launch\",\n         name: runnable.label,\n         program: executable,\n-        args: runnable.extraArgs,\n-        cwd: runnable.cwd,\n+        args: runnable.args.executableArgs,\n+        cwd: runnable.args.workspaceRoot,\n         sourceFileMap: sourceFileMap,\n     };\n }"}, {"sha": "35d73ce31da375a3f0832338f4e8cec5f79d2009", "filename": "editors/code/src/lsp_ext.ts", "status": "modified", "additions": 8, "deletions": 9, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/cb482e6351c4005f29bb89d38c64c4e3f93d7a6d/editors%2Fcode%2Fsrc%2Flsp_ext.ts", "raw_url": "https://github.com/rust-lang/rust/raw/cb482e6351c4005f29bb89d38c64c4e3f93d7a6d/editors%2Fcode%2Fsrc%2Flsp_ext.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Flsp_ext.ts?ref=cb482e6351c4005f29bb89d38c64c4e3f93d7a6d", "patch": "@@ -53,18 +53,17 @@ export interface RunnablesParams {\n     position: lc.Position | null;\n }\n \n-export type RunnableKind = \"cargo\" | \"rustc\" | \"rustup\";\n-\n export interface Runnable {\n-    range: lc.Range;\n     label: string;\n-    kind: RunnableKind;\n-    args: string[];\n-    extraArgs: string[];\n-    env: { [key: string]: string };\n-    cwd: string | null;\n+    location?: lc.LocationLink;\n+    kind: \"cargo\";\n+    args: {\n+        workspaceRoot?: string;\n+        cargoArgs: string[];\n+        executableArgs: string[];\n+    };\n }\n-export const runnables = new lc.RequestType<RunnablesParams, Runnable[], void>(\"rust-analyzer/runnables\");\n+export const runnables = new lc.RequestType<RunnablesParams, Runnable[], void>(\"experimental/runnables\");\n \n export type InlayHint = InlayHint.TypeHint | InlayHint.ParamHint | InlayHint.ChainingHint;\n "}, {"sha": "5c790741f3874b7017741e9f68f65b63359f301d", "filename": "editors/code/src/run.ts", "status": "modified", "additions": 15, "deletions": 6, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/cb482e6351c4005f29bb89d38c64c4e3f93d7a6d/editors%2Fcode%2Fsrc%2Frun.ts", "raw_url": "https://github.com/rust-lang/rust/raw/cb482e6351c4005f29bb89d38c64c4e3f93d7a6d/editors%2Fcode%2Fsrc%2Frun.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Frun.ts?ref=cb482e6351c4005f29bb89d38c64c4e3f93d7a6d", "patch": "@@ -103,18 +103,27 @@ interface CargoTaskDefinition extends vscode.TaskDefinition {\n     env?: { [key: string]: string };\n }\n \n-export function createTask(spec: ra.Runnable): vscode.Task {\n+export function createTask(runnable: ra.Runnable): vscode.Task {\n     const TASK_SOURCE = 'Rust';\n+\n+    let command;\n+    switch (runnable.kind) {\n+        case \"cargo\": command = toolchain.getPathForExecutable(\"cargo\");\n+    }\n+    const args = runnable.args.cargoArgs;\n+    if (runnable.args.executableArgs.length > 0) {\n+        args.push('--', ...runnable.args.executableArgs);\n+    }\n     const definition: CargoTaskDefinition = {\n         type: 'cargo',\n-        label: spec.label,\n-        command: toolchain.getPathForExecutable(spec.kind),\n-        args: spec.extraArgs ? [...spec.args, '--', ...spec.extraArgs] : spec.args,\n-        env: Object.assign({}, process.env, spec.env),\n+        label: runnable.label,\n+        command,\n+        args,\n+        env: Object.assign({}, process.env as { [key: string]: string }, { \"RUST_BACKTRACE\": \"short\" }),\n     };\n \n     const execOption: vscode.ShellExecutionOptions = {\n-        cwd: spec.cwd || '.',\n+        cwd: runnable.args.workspaceRoot || '.',\n         env: definition.env,\n     };\n     const exec = new vscode.ShellExecution("}]}