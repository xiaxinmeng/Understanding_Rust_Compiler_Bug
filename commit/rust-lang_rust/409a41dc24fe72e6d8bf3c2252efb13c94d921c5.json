{"sha": "409a41dc24fe72e6d8bf3c2252efb13c94d921c5", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQwOWE0MWRjMjRmZTcyZTZkOGJmM2MyMjUyZWZiMTNjOTRkOTIxYzU=", "commit": {"author": {"name": "Paul Emmerich", "email": "paul.emmerich@croit.io", "date": "2019-07-11T23:56:43Z"}, "committer": {"name": "Paul Emmerich", "email": "paul.emmerich@croit.io", "date": "2019-07-11T23:56:43Z"}, "message": "libtest: support display_output in JSON formatter", "tree": {"sha": "ae586cdd7a0bfc9cb42d511ffa229fe0a03ad973", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ae586cdd7a0bfc9cb42d511ffa229fe0a03ad973"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/409a41dc24fe72e6d8bf3c2252efb13c94d921c5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/409a41dc24fe72e6d8bf3c2252efb13c94d921c5", "html_url": "https://github.com/rust-lang/rust/commit/409a41dc24fe72e6d8bf3c2252efb13c94d921c5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/409a41dc24fe72e6d8bf3c2252efb13c94d921c5/comments", "author": {"login": "emmericp", "id": 8938753, "node_id": "MDQ6VXNlcjg5Mzg3NTM=", "avatar_url": "https://avatars.githubusercontent.com/u/8938753?v=4", "gravatar_id": "", "url": "https://api.github.com/users/emmericp", "html_url": "https://github.com/emmericp", "followers_url": "https://api.github.com/users/emmericp/followers", "following_url": "https://api.github.com/users/emmericp/following{/other_user}", "gists_url": "https://api.github.com/users/emmericp/gists{/gist_id}", "starred_url": "https://api.github.com/users/emmericp/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/emmericp/subscriptions", "organizations_url": "https://api.github.com/users/emmericp/orgs", "repos_url": "https://api.github.com/users/emmericp/repos", "events_url": "https://api.github.com/users/emmericp/events{/privacy}", "received_events_url": "https://api.github.com/users/emmericp/received_events", "type": "User", "site_admin": false}, "committer": {"login": "emmericp", "id": 8938753, "node_id": "MDQ6VXNlcjg5Mzg3NTM=", "avatar_url": "https://avatars.githubusercontent.com/u/8938753?v=4", "gravatar_id": "", "url": "https://api.github.com/users/emmericp", "html_url": "https://github.com/emmericp", "followers_url": "https://api.github.com/users/emmericp/followers", "following_url": "https://api.github.com/users/emmericp/following{/other_user}", "gists_url": "https://api.github.com/users/emmericp/gists{/gist_id}", "starred_url": "https://api.github.com/users/emmericp/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/emmericp/subscriptions", "organizations_url": "https://api.github.com/users/emmericp/orgs", "repos_url": "https://api.github.com/users/emmericp/repos", "events_url": "https://api.github.com/users/emmericp/events{/privacy}", "received_events_url": "https://api.github.com/users/emmericp/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1add949ef0e424e3b144e33d55938c873ac5050e", "url": "https://api.github.com/repos/rust-lang/rust/commits/1add949ef0e424e3b144e33d55938c873ac5050e", "html_url": "https://github.com/rust-lang/rust/commit/1add949ef0e424e3b144e33d55938c873ac5050e"}], "stats": {"total": 117, "additions": 77, "deletions": 40}, "files": [{"sha": "e0bea4ce54530111ec900e689b5b472e5571ecc0", "filename": "src/libtest/formatters/json.rs", "status": "modified", "additions": 40, "deletions": 31, "changes": 71, "blob_url": "https://github.com/rust-lang/rust/blob/409a41dc24fe72e6d8bf3c2252efb13c94d921c5/src%2Flibtest%2Fformatters%2Fjson.rs", "raw_url": "https://github.com/rust-lang/rust/raw/409a41dc24fe72e6d8bf3c2252efb13c94d921c5/src%2Flibtest%2Fformatters%2Fjson.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibtest%2Fformatters%2Fjson.rs?ref=409a41dc24fe72e6d8bf3c2252efb13c94d921c5", "patch": "@@ -9,44 +9,57 @@ impl<T: Write> JsonFormatter<T> {\n         Self { out }\n     }\n \n-    fn write_message(&mut self, s: &str) -> io::Result<()> {\n+    fn writeln_message(&mut self, s: &str) -> io::Result<()> {\n         assert!(!s.contains('\\n'));\n \n         self.out.write_all(s.as_ref())?;\n         self.out.write_all(b\"\\n\")\n     }\n \n+    fn write_message(&mut self, s: &str) -> io::Result<()> {\n+        assert!(!s.contains('\\n'));\n+\n+        self.out.write_all(s.as_ref())\n+    }\n+\n     fn write_event(\n         &mut self,\n         ty: &str,\n         name: &str,\n         evt: &str,\n-        extra: Option<String>,\n+        stdout: Option<Cow<'_, str>>,\n+        extra: Option<&str>,\n     ) -> io::Result<()> {\n-        if let Some(extras) = extra {\n+        self.write_message(&*format!(\n+            r#\"{{ \"type\": \"{}\", \"name\": \"{}\", \"event\": \"{}\"\"#,\n+            ty, name, evt\n+        ))?;\n+        if let Some(stdout) = stdout {\n             self.write_message(&*format!(\n-                r#\"{{ \"type\": \"{}\", \"name\": \"{}\", \"event\": \"{}\", {} }}\"#,\n-                ty, name, evt, extras\n-            ))\n-        } else {\n+                r#\", \"stdout\": \"{}\"\"#,\n+                EscapedString(stdout)\n+            ))?;\n+        }\n+        if let Some(extra) = extra {\n             self.write_message(&*format!(\n-                r#\"{{ \"type\": \"{}\", \"name\": \"{}\", \"event\": \"{}\" }}\"#,\n-                ty, name, evt\n-            ))\n+                r#\", {}\"#,\n+                extra\n+            ))?;\n         }\n+        self.writeln_message(\" }\")\n     }\n }\n \n impl<T: Write> OutputFormatter for JsonFormatter<T> {\n     fn write_run_start(&mut self, test_count: usize) -> io::Result<()> {\n-        self.write_message(&*format!(\n+        self.writeln_message(&*format!(\n             r#\"{{ \"type\": \"suite\", \"event\": \"started\", \"test_count\": {} }}\"#,\n             test_count\n         ))\n     }\n \n     fn write_test_start(&mut self, desc: &TestDesc) -> io::Result<()> {\n-        self.write_message(&*format!(\n+        self.writeln_message(&*format!(\n             r#\"{{ \"type\": \"test\", \"event\": \"started\", \"name\": \"{}\" }}\"#,\n             desc.name\n         ))\n@@ -57,34 +70,30 @@ impl<T: Write> OutputFormatter for JsonFormatter<T> {\n         desc: &TestDesc,\n         result: &TestResult,\n         stdout: &[u8],\n+        state: &ConsoleTestState,\n     ) -> io::Result<()> {\n+        let stdout = if (state.options.display_output || *result != TrOk) && stdout.len() > 0 {\n+            Some(String::from_utf8_lossy(stdout))\n+        } else {\n+            None\n+        };\n         match *result {\n-            TrOk => self.write_event(\"test\", desc.name.as_slice(), \"ok\", None),\n-\n-            TrFailed => {\n-                let extra_data = if stdout.len() > 0 {\n-                    Some(format!(\n-                        r#\"\"stdout\": \"{}\"\"#,\n-                        EscapedString(String::from_utf8_lossy(stdout))\n-                    ))\n-                } else {\n-                    None\n-                };\n+            TrOk => self.write_event(\"test\", desc.name.as_slice(), \"ok\", stdout, None),\n \n-                self.write_event(\"test\", desc.name.as_slice(), \"failed\", extra_data)\n-            }\n+            TrFailed => self.write_event(\"test\", desc.name.as_slice(), \"failed\", stdout, None),\n \n             TrFailedMsg(ref m) => self.write_event(\n                 \"test\",\n                 desc.name.as_slice(),\n                 \"failed\",\n-                Some(format!(r#\"\"message\": \"{}\"\"#, EscapedString(m))),\n+                stdout,\n+                Some(&*format!(r#\"\"message\": \"{}\"\"#, EscapedString(m))),\n             ),\n \n-            TrIgnored => self.write_event(\"test\", desc.name.as_slice(), \"ignored\", None),\n+            TrIgnored => self.write_event(\"test\", desc.name.as_slice(), \"ignored\", stdout, None),\n \n             TrAllowedFail => {\n-                self.write_event(\"test\", desc.name.as_slice(), \"allowed_failure\", None)\n+                self.write_event(\"test\", desc.name.as_slice(), \"allowed_failure\", stdout, None)\n             }\n \n             TrBench(ref bs) => {\n@@ -105,20 +114,20 @@ impl<T: Write> OutputFormatter for JsonFormatter<T> {\n                     desc.name, median, deviation, mbps\n                 );\n \n-                self.write_message(&*line)\n+                self.writeln_message(&*line)\n             }\n         }\n     }\n \n     fn write_timeout(&mut self, desc: &TestDesc) -> io::Result<()> {\n-        self.write_message(&*format!(\n+        self.writeln_message(&*format!(\n             r#\"{{ \"type\": \"test\", \"event\": \"timeout\", \"name\": \"{}\" }}\"#,\n             desc.name\n         ))\n     }\n \n     fn write_run_finish(&mut self, state: &ConsoleTestState) -> io::Result<bool> {\n-        self.write_message(&*format!(\n+        self.writeln_message(&*format!(\n             \"{{ \\\"type\\\": \\\"suite\\\", \\\n              \\\"event\\\": \\\"{}\\\", \\\n              \\\"passed\\\": {}, \\"}, {"sha": "cc30b06e5ec38f1fd178a1fbed4f35079a0a2209", "filename": "src/libtest/formatters/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/409a41dc24fe72e6d8bf3c2252efb13c94d921c5/src%2Flibtest%2Fformatters%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/409a41dc24fe72e6d8bf3c2252efb13c94d921c5/src%2Flibtest%2Fformatters%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibtest%2Fformatters%2Fmod.rs?ref=409a41dc24fe72e6d8bf3c2252efb13c94d921c5", "patch": "@@ -17,6 +17,7 @@ pub(crate) trait OutputFormatter {\n         desc: &TestDesc,\n         result: &TestResult,\n         stdout: &[u8],\n+        state: &ConsoleTestState,\n     ) -> io::Result<()>;\n     fn write_run_finish(&mut self, state: &ConsoleTestState) -> io::Result<bool>;\n }"}, {"sha": "88331406a64d0dcd501ca2dba520e346c9cf93c8", "filename": "src/libtest/formatters/pretty.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/409a41dc24fe72e6d8bf3c2252efb13c94d921c5/src%2Flibtest%2Fformatters%2Fpretty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/409a41dc24fe72e6d8bf3c2252efb13c94d921c5/src%2Flibtest%2Fformatters%2Fpretty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibtest%2Fformatters%2Fpretty.rs?ref=409a41dc24fe72e6d8bf3c2252efb13c94d921c5", "patch": "@@ -162,7 +162,13 @@ impl<T: Write> OutputFormatter for PrettyFormatter<T> {\n         Ok(())\n     }\n \n-    fn write_result(&mut self, desc: &TestDesc, result: &TestResult, _: &[u8]) -> io::Result<()> {\n+    fn write_result(\n+        &mut self,\n+        desc: &TestDesc,\n+        result: &TestResult,\n+        _: &[u8],\n+        _: &ConsoleTestState,\n+    ) -> io::Result<()> {\n         if self.is_multithreaded {\n             self.write_test_name(desc)?;\n         }"}, {"sha": "d10b0c5807d57406c21be671bc355875eace8d38", "filename": "src/libtest/formatters/terse.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/409a41dc24fe72e6d8bf3c2252efb13c94d921c5/src%2Flibtest%2Fformatters%2Fterse.rs", "raw_url": "https://github.com/rust-lang/rust/raw/409a41dc24fe72e6d8bf3c2252efb13c94d921c5/src%2Flibtest%2Fformatters%2Fterse.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibtest%2Fformatters%2Fterse.rs?ref=409a41dc24fe72e6d8bf3c2252efb13c94d921c5", "patch": "@@ -170,7 +170,13 @@ impl<T: Write> OutputFormatter for TerseFormatter<T> {\n         Ok(())\n     }\n \n-    fn write_result(&mut self, desc: &TestDesc, result: &TestResult, _: &[u8]) -> io::Result<()> {\n+    fn write_result(\n+        &mut self,\n+        desc: &TestDesc,\n+        result: &TestResult,\n+        _: &[u8],\n+        _: &ConsoleTestState,\n+    ) -> io::Result<()> {\n         match *result {\n             TrOk => self.write_ok(),\n             TrFailed | TrFailedMsg(_) => self.write_failed(),"}, {"sha": "6e00e02b3c8095c3cbf6f055f96af00521711bc4", "filename": "src/libtest/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/409a41dc24fe72e6d8bf3c2252efb13c94d921c5/src%2Flibtest%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/409a41dc24fe72e6d8bf3c2252efb13c94d921c5/src%2Flibtest%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibtest%2Flib.rs?ref=409a41dc24fe72e6d8bf3c2252efb13c94d921c5", "patch": "@@ -906,7 +906,7 @@ pub fn run_tests_console(opts: &TestOpts, tests: Vec<TestDescAndFn>) -> io::Resu\n             TeTimeout(ref test) => out.write_timeout(test),\n             TeResult(test, result, stdout) => {\n                 st.write_log_result(&test, &result)?;\n-                out.write_result(&test, &result, &*stdout)?;\n+                out.write_result(&test, &result, &*stdout, &st)?;\n                 match result {\n                     TrOk => {\n                         st.passed += 1;"}, {"sha": "8339e230bbe9259493965dcff4e1ba2e9fde3476", "filename": "src/test/run-make-fulldeps/libtest-json/Makefile", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/409a41dc24fe72e6d8bf3c2252efb13c94d921c5/src%2Ftest%2Frun-make-fulldeps%2Flibtest-json%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/409a41dc24fe72e6d8bf3c2252efb13c94d921c5/src%2Ftest%2Frun-make-fulldeps%2Flibtest-json%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Flibtest-json%2FMakefile?ref=409a41dc24fe72e6d8bf3c2252efb13c94d921c5", "patch": "@@ -2,13 +2,17 @@\n \n # Test expected libtest's JSON output\n \n-OUTPUT_FILE := $(TMPDIR)/libtest-json-output.json\n+OUTPUT_FILE_DEFAULT := $(TMPDIR)/libtest-json-output-default.json\n+OUTPUT_FILE_STDOUT_SUCCESS := $(TMPDIR)/libtest-json-output-stdout-success.json\n \n all:\n \t$(RUSTC) --test f.rs\n-\tRUST_BACKTRACE=0 $(call RUN,f) -Z unstable-options --test-threads=1 --format=json > $(OUTPUT_FILE) || true\n+\tRUST_BACKTRACE=0 $(call RUN,f) -Z unstable-options --test-threads=1 --format=json > $(OUTPUT_FILE_DEFAULT) || true\n+\tRUST_BACKTRACE=0 $(call RUN,f) -Z unstable-options --test-threads=1 --format=json --show-output > $(OUTPUT_FILE_STDOUT_SUCCESS) || true\n \n-\tcat $(OUTPUT_FILE) | \"$(PYTHON)\" validate_json.py\n+\tcat $(OUTPUT_FILE_DEFAULT) | \"$(PYTHON)\" validate_json.py\n+\tcat $(OUTPUT_FILE_STDOUT_SUCCESS) | \"$(PYTHON)\" validate_json.py\n \n \t# Compare to output file\n-\tdiff output.json $(OUTPUT_FILE)\n+\tdiff output-default.json $(OUTPUT_FILE_DEFAULT)\n+\tdiff output-stdout-success.json $(OUTPUT_FILE_STDOUT_SUCCESS)"}, {"sha": "95ff36bd764ec40afb19495ad8844dda458e42f6", "filename": "src/test/run-make-fulldeps/libtest-json/f.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/409a41dc24fe72e6d8bf3c2252efb13c94d921c5/src%2Ftest%2Frun-make-fulldeps%2Flibtest-json%2Ff.rs", "raw_url": "https://github.com/rust-lang/rust/raw/409a41dc24fe72e6d8bf3c2252efb13c94d921c5/src%2Ftest%2Frun-make-fulldeps%2Flibtest-json%2Ff.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Flibtest-json%2Ff.rs?ref=409a41dc24fe72e6d8bf3c2252efb13c94d921c5", "patch": "@@ -1,11 +1,12 @@\n #[test]\n fn a() {\n+    println!(\"print from successful test\");\n     // Should pass\n }\n \n #[test]\n fn b() {\n-    assert!(false)\n+    assert!(false);\n }\n \n #[test]"}, {"sha": "8046d722217036ee89595f9bedf7249d917fe948", "filename": "src/test/run-make-fulldeps/libtest-json/output-default.json", "status": "renamed", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/409a41dc24fe72e6d8bf3c2252efb13c94d921c5/src%2Ftest%2Frun-make-fulldeps%2Flibtest-json%2Foutput-default.json", "raw_url": "https://github.com/rust-lang/rust/raw/409a41dc24fe72e6d8bf3c2252efb13c94d921c5/src%2Ftest%2Frun-make-fulldeps%2Flibtest-json%2Foutput-default.json", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Flibtest-json%2Foutput-default.json?ref=409a41dc24fe72e6d8bf3c2252efb13c94d921c5", "patch": "@@ -2,7 +2,7 @@\n { \"type\": \"test\", \"event\": \"started\", \"name\": \"a\" }\n { \"type\": \"test\", \"name\": \"a\", \"event\": \"ok\" }\n { \"type\": \"test\", \"event\": \"started\", \"name\": \"b\" }\n-{ \"type\": \"test\", \"name\": \"b\", \"event\": \"failed\", \"stdout\": \"thread 'main' panicked at 'assertion failed: false', f.rs:8:5\\nnote: run with `RUST_BACKTRACE=1` environment variable to display a backtrace.\\n\" }\n+{ \"type\": \"test\", \"name\": \"b\", \"event\": \"failed\", \"stdout\": \"thread 'main' panicked at 'assertion failed: false', f.rs:9:5\\nnote: run with `RUST_BACKTRACE=1` environment variable to display a backtrace.\\n\" }\n { \"type\": \"test\", \"event\": \"started\", \"name\": \"c\" }\n { \"type\": \"test\", \"name\": \"c\", \"event\": \"ok\" }\n { \"type\": \"test\", \"event\": \"started\", \"name\": \"d\" }", "previous_filename": "src/test/run-make-fulldeps/libtest-json/output.json"}, {"sha": "303316278d8aba04a055c45840cc7614622563ba", "filename": "src/test/run-make-fulldeps/libtest-json/output-stdout-success.json", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/409a41dc24fe72e6d8bf3c2252efb13c94d921c5/src%2Ftest%2Frun-make-fulldeps%2Flibtest-json%2Foutput-stdout-success.json", "raw_url": "https://github.com/rust-lang/rust/raw/409a41dc24fe72e6d8bf3c2252efb13c94d921c5/src%2Ftest%2Frun-make-fulldeps%2Flibtest-json%2Foutput-stdout-success.json", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make-fulldeps%2Flibtest-json%2Foutput-stdout-success.json?ref=409a41dc24fe72e6d8bf3c2252efb13c94d921c5", "patch": "@@ -0,0 +1,10 @@\n+{ \"type\": \"suite\", \"event\": \"started\", \"test_count\": 4 }\n+{ \"type\": \"test\", \"event\": \"started\", \"name\": \"a\" }\n+{ \"type\": \"test\", \"name\": \"a\", \"event\": \"ok\", \"stdout\": \"print from successful test\\n\" }\n+{ \"type\": \"test\", \"event\": \"started\", \"name\": \"b\" }\n+{ \"type\": \"test\", \"name\": \"b\", \"event\": \"failed\", \"stdout\": \"thread 'main' panicked at 'assertion failed: false', f.rs:9:5\\nnote: run with `RUST_BACKTRACE=1` environment variable to display a backtrace.\\n\" }\n+{ \"type\": \"test\", \"event\": \"started\", \"name\": \"c\" }\n+{ \"type\": \"test\", \"name\": \"c\", \"event\": \"ok\", \"stdout\": \"thread 'main' panicked at 'assertion failed: false', f.rs:15:5\\n\" }\n+{ \"type\": \"test\", \"event\": \"started\", \"name\": \"d\" }\n+{ \"type\": \"test\", \"name\": \"d\", \"event\": \"ignored\" }\n+{ \"type\": \"suite\", \"event\": \"failed\", \"passed\": 2, \"failed\": 1, \"allowed_fail\": 0, \"ignored\": 1, \"measured\": 0, \"filtered_out\": 0 }"}]}