{"sha": "a36077235e800cd2d46aa70151de8c7eac0ced5b", "node_id": "MDY6Q29tbWl0NzI0NzEyOmEzNjA3NzIzNWU4MDBjZDJkNDZhYTcwMTUxZGU4YzdlYWMwY2VkNWI=", "commit": {"author": {"name": "Pietro Albini", "email": "pietro@pietroalbini.org", "date": "2019-10-04T16:42:53Z"}, "committer": {"name": "Pietro Albini", "email": "pietro@pietroalbini.org", "date": "2019-10-25T14:03:06Z"}, "message": "ci: extract installing sccache into a script", "tree": {"sha": "83beac30e82940a99032e0314c6b84ceadcff243", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/83beac30e82940a99032e0314c6b84ceadcff243"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a36077235e800cd2d46aa70151de8c7eac0ced5b", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE1JbYPtLJAsc22U9xPgar6Auq8ZwFAl2zAJoACgkQPgar6Auq\n8Zxlzw/+MtmsskKYeBmpq7yy6TT14HcRy7+mKxXq6aOgIhulQ79lDYb9fDeMRKdt\n45QEGdbwLdK5Cou7XqNI6BV7UnAgE6PSZhmOvbmdKZCv6xsge73UA2KdyU2dE1KQ\ne7SVIZ11ZnJ1J261RmzPvBSWDmCfkFzClnKgj9jMAbGLft0W/fBShqsN4fscNJFE\ncZuEWlu7UgL0SSPoZMzp4a1EAmljeC+cJIabcUqzivYWQAYgYF5PvcO1LWurUrwV\nSOVpv72c4j9OckC43Wo/+E7QrrNlkWx/jl3cXWuvqK0t5BAIR8KCf7Jj+BCkxd8W\n1xN83jdcHHjeel2FDqtYO3agOTvtmDl0W6aqqJQVCqwiZMyHxToQTvd3Tg87D75p\nBVJXyey8GbjcEDp5WE14zmvos5lzXvJZmSvgaSAm09l0MwCKZ3ZJLr+aLRZgNh2o\nYTUrY3hpTqDEDyGt9dm72vsJ99EtyCEuEWt0hPzfb2LdVxbE4l+IrxdodjUqGtCJ\n9cHlXYTyAEQlmkiFKmNbI7x1sAvP1NZoQvht098+JH7jPV+qiYUnJYDeW4pvzH82\nJCtOhn56F3eB/Rc2p+qZUfMfUvNige1v4y4NFRAvcc0bp3c0x48e/dfnwtdhUq9M\nGqh6jVKMZ/STI1Vdj8QHd7ThwhrSW+F3saT7HoASo+vLkTHXZig=\n=0C1c\n-----END PGP SIGNATURE-----", "payload": "tree 83beac30e82940a99032e0314c6b84ceadcff243\nparent c1fb42add5a7859b1b8e258d3c03fd5a29129c40\nauthor Pietro Albini <pietro@pietroalbini.org> 1570207373 +0200\ncommitter Pietro Albini <pietro@pietroalbini.org> 1572012186 +0200\n\nci: extract installing sccache into a script\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a36077235e800cd2d46aa70151de8c7eac0ced5b", "html_url": "https://github.com/rust-lang/rust/commit/a36077235e800cd2d46aa70151de8c7eac0ced5b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a36077235e800cd2d46aa70151de8c7eac0ced5b/comments", "author": {"login": "pietroalbini", "id": 2299951, "node_id": "MDQ6VXNlcjIyOTk5NTE=", "avatar_url": "https://avatars.githubusercontent.com/u/2299951?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pietroalbini", "html_url": "https://github.com/pietroalbini", "followers_url": "https://api.github.com/users/pietroalbini/followers", "following_url": "https://api.github.com/users/pietroalbini/following{/other_user}", "gists_url": "https://api.github.com/users/pietroalbini/gists{/gist_id}", "starred_url": "https://api.github.com/users/pietroalbini/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pietroalbini/subscriptions", "organizations_url": "https://api.github.com/users/pietroalbini/orgs", "repos_url": "https://api.github.com/users/pietroalbini/repos", "events_url": "https://api.github.com/users/pietroalbini/events{/privacy}", "received_events_url": "https://api.github.com/users/pietroalbini/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pietroalbini", "id": 2299951, "node_id": "MDQ6VXNlcjIyOTk5NTE=", "avatar_url": "https://avatars.githubusercontent.com/u/2299951?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pietroalbini", "html_url": "https://github.com/pietroalbini", "followers_url": "https://api.github.com/users/pietroalbini/followers", "following_url": "https://api.github.com/users/pietroalbini/following{/other_user}", "gists_url": "https://api.github.com/users/pietroalbini/gists{/gist_id}", "starred_url": "https://api.github.com/users/pietroalbini/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pietroalbini/subscriptions", "organizations_url": "https://api.github.com/users/pietroalbini/orgs", "repos_url": "https://api.github.com/users/pietroalbini/repos", "events_url": "https://api.github.com/users/pietroalbini/events{/privacy}", "received_events_url": "https://api.github.com/users/pietroalbini/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c1fb42add5a7859b1b8e258d3c03fd5a29129c40", "url": "https://api.github.com/repos/rust-lang/rust/commits/c1fb42add5a7859b1b8e258d3c03fd5a29129c40", "html_url": "https://github.com/rust-lang/rust/commit/c1fb42add5a7859b1b8e258d3c03fd5a29129c40"}], "stats": {"total": 68, "additions": 46, "deletions": 22}, "files": [{"sha": "d4679c1c6733e50807df5f8c61dec675a15e031c", "filename": "src/ci/azure-pipelines/steps/install-sccache.yml", "status": "removed", "additions": 0, "deletions": 21, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/c1fb42add5a7859b1b8e258d3c03fd5a29129c40/src%2Fci%2Fazure-pipelines%2Fsteps%2Finstall-sccache.yml", "raw_url": "https://github.com/rust-lang/rust/raw/c1fb42add5a7859b1b8e258d3c03fd5a29129c40/src%2Fci%2Fazure-pipelines%2Fsteps%2Finstall-sccache.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fazure-pipelines%2Fsteps%2Finstall-sccache.yml?ref=c1fb42add5a7859b1b8e258d3c03fd5a29129c40", "patch": "@@ -1,21 +0,0 @@\n-steps:\n-\n-- bash: |\n-    set -e\n-    curl -fo /usr/local/bin/sccache https://rust-lang-ci-mirrors.s3-us-west-1.amazonaws.com/rustc/2018-04-02-sccache-x86_64-apple-darwin\n-    chmod +x /usr/local/bin/sccache\n-  displayName: Install sccache (OSX)\n-  condition: and(succeeded(), eq(variables['Agent.OS'], 'Darwin'))\n-\n-- script: |\n-    md sccache\n-    powershell -Command \"$ProgressPreference = 'SilentlyContinue'; iwr -outf sccache\\sccache.exe https://rust-lang-ci-mirrors.s3-us-west-1.amazonaws.com/rustc/2018-04-26-sccache-x86_64-pc-windows-msvc\"\n-    echo ##vso[task.prependpath]%CD%\\sccache\n-  displayName: Install sccache (Windows)\n-  condition: and(succeeded(), eq(variables['Agent.OS'], 'Windows_NT'))\n-\n-# Note that we don't install sccache on Linux since it's installed elsewhere\n-# through all the containers.\n-#\n-# FIXME: we should probably install sccache outside the containers and then\n-# mount it inside the containers so we can centralize all installation here."}, {"sha": "66405f2d2bfde734afac64f029f062fad600c194", "filename": "src/ci/azure-pipelines/steps/run.yml", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/a36077235e800cd2d46aa70151de8c7eac0ced5b/src%2Fci%2Fazure-pipelines%2Fsteps%2Frun.yml", "raw_url": "https://github.com/rust-lang/rust/raw/a36077235e800cd2d46aa70151de8c7eac0ced5b/src%2Fci%2Fazure-pipelines%2Fsteps%2Frun.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fazure-pipelines%2Fsteps%2Frun.yml?ref=a36077235e800cd2d46aa70151de8c7eac0ced5b", "patch": "@@ -51,7 +51,12 @@ steps:\n - bash: src/ci/scripts/dump-environment.sh\n   displayName: Show the current environment\n \n-- template: install-sccache.yml\n+- bash: src/ci/scripts/install-sccache.sh\n+  env:\n+    AGENT_OS: $(Agent.OS)\n+  displayName: Install sccache\n+  condition: and(succeeded(), not(variables.SKIP_JOB))\n+\n - template: install-clang.yml\n \n # Switch to XCode 9.3 on OSX since it seems to be the last version that supports"}, {"sha": "d3c298992254ef3424da236fbbaafceef4fb8e20", "filename": "src/ci/scripts/install-sccache.sh", "status": "added", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/a36077235e800cd2d46aa70151de8c7eac0ced5b/src%2Fci%2Fscripts%2Finstall-sccache.sh", "raw_url": "https://github.com/rust-lang/rust/raw/a36077235e800cd2d46aa70151de8c7eac0ced5b/src%2Fci%2Fscripts%2Finstall-sccache.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fscripts%2Finstall-sccache.sh?ref=a36077235e800cd2d46aa70151de8c7eac0ced5b", "patch": "@@ -0,0 +1,20 @@\n+#!/bin/bash\n+# This script installs sccache on the local machine. Note that we don't install\n+# sccache on Linux since it's installed elsewhere through all the containers.\n+\n+set -euo pipefail\n+IFS=$'\\n\\t'\n+\n+source \"$(cd \"$(dirname \"$0\")\" && pwd)/../shared.sh\"\n+\n+if isMacOS; then\n+    curl -fo /usr/local/bin/sccache \"${MIRRORS_BASE}/2018-04-02-sccache-x86_64-apple-darwin\"\n+    chmod +x /usr/local/bin/sccache\n+elif isWindows; then\n+    mkdir -p sccache\n+    curl -fo sccache/sccache.exe \"${MIRRORS_BASE}/2018-04-26-sccache-x86_64-pc-windows-msvc\"\n+    ciCommandAddPath \"$(pwd)/sccache\"\n+fi\n+\n+# FIXME: we should probably install sccache outside the containers and then\n+# mount it inside the containers so we can centralize all installation here."}, {"sha": "49fe3841ceb3b66ba9313629b0117a99c4162a8c", "filename": "src/ci/shared.sh", "status": "modified", "additions": 20, "deletions": 0, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/a36077235e800cd2d46aa70151de8c7eac0ced5b/src%2Fci%2Fshared.sh", "raw_url": "https://github.com/rust-lang/rust/raw/a36077235e800cd2d46aa70151de8c7eac0ced5b/src%2Fci%2Fshared.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fshared.sh?ref=a36077235e800cd2d46aa70151de8c7eac0ced5b", "patch": "@@ -4,6 +4,8 @@\n # `source shared.sh`, hence the invalid shebang and not being\n # marked as an executable file in git.\n \n+export MIRRORS_BASE=\"https://rust-lang-ci-mirrors.s3-us-west-1.amazonaws.com/rustc\"\n+\n # See http://unix.stackexchange.com/questions/82598\n # Duplicated in docker/dist-various-2/shared.sh\n function retry {\n@@ -32,6 +34,24 @@ function isOSX {\n   [ \"$AGENT_OS\" = \"Darwin\" ]\n }\n \n+function isMacOS {\n+    isOSX\n+}\n+\n+function isWindows {\n+    [ \"$AGENT_OS\" = \"Windows_NT\" ]\n+}\n+\n function getCIBranch {\n   echo \"$BUILD_SOURCEBRANCHNAME\"\n }\n+\n+function ciCommandAddPath {\n+    if [[ $# -ne 1 ]]; then\n+        echo \"usage: $0 <path>\"\n+        exit 1\n+    fi\n+    path=\"$1\"\n+\n+    echo \"##vso[task.prependpath]${path}\"\n+}"}]}