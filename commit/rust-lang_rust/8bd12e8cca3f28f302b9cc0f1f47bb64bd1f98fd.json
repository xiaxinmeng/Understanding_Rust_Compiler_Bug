{"sha": "8bd12e8cca3f28f302b9cc0f1f47bb64bd1f98fd", "node_id": "C_kwDOAAsO6NoAKDhiZDEyZThjY2EzZjI4ZjMwMmI5Y2MwZjFmNDdiYjY0YmQxZjk4ZmQ", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-07-19T11:28:20Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-07-19T11:28:20Z"}, "message": "Auto merge of #98912 - nrc:provider-it, r=yaahc\n\ncore::any: replace some generic types with impl Trait\n\nThis gives a cleaner API since the caller only specifies the concrete type they usually want to.\n\nr? `@yaahc`", "tree": {"sha": "8afbd48ab5dbb9c70cac162a517c7ed912a306f8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8afbd48ab5dbb9c70cac162a517c7ed912a306f8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8bd12e8cca3f28f302b9cc0f1f47bb64bd1f98fd", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8bd12e8cca3f28f302b9cc0f1f47bb64bd1f98fd", "html_url": "https://github.com/rust-lang/rust/commit/8bd12e8cca3f28f302b9cc0f1f47bb64bd1f98fd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8bd12e8cca3f28f302b9cc0f1f47bb64bd1f98fd/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4603ac31b0655793a82f110f544dc1c6abc57bb7", "url": "https://api.github.com/repos/rust-lang/rust/commits/4603ac31b0655793a82f110f544dc1c6abc57bb7", "html_url": "https://github.com/rust-lang/rust/commit/4603ac31b0655793a82f110f544dc1c6abc57bb7"}, {"sha": "0c72be3e1a6da6f6fc9bab0a63edf780de7d985d", "url": "https://api.github.com/repos/rust-lang/rust/commits/0c72be3e1a6da6f6fc9bab0a63edf780de7d985d", "html_url": "https://github.com/rust-lang/rust/commit/0c72be3e1a6da6f6fc9bab0a63edf780de7d985d"}], "stats": {"total": 57, "additions": 26, "deletions": 31}, "files": [{"sha": "f20c497a183b2c07a246170116b4ea6651df9fd3", "filename": "library/core/src/any.rs", "status": "modified", "additions": 15, "deletions": 20, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/8bd12e8cca3f28f302b9cc0f1f47bb64bd1f98fd/library%2Fcore%2Fsrc%2Fany.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8bd12e8cca3f28f302b9cc0f1f47bb64bd1f98fd/library%2Fcore%2Fsrc%2Fany.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fany.rs?ref=8bd12e8cca3f28f302b9cc0f1f47bb64bd1f98fd", "patch": "@@ -125,7 +125,7 @@\n //! impl dyn MyTrait + '_ {\n //!     /// Get a reference to a field of the implementing struct.\n //!     pub fn get_context_by_ref<T: ?Sized + 'static>(&self) -> Option<&T> {\n-//!         request_ref::<T, _>(self)\n+//!         request_ref::<T>(self)\n //!     }\n //! }\n //!\n@@ -799,7 +799,7 @@ pub trait Provider {\n     /// impl Provider for SomeConcreteType {\n     ///     fn provide<'a>(&'a self, demand: &mut Demand<'a>) {\n     ///         demand.provide_ref::<str>(&self.field)\n-    ///             .provide_value::<i32, _>(|| self.num_field);\n+    ///             .provide_value::<i32>(|| self.num_field);\n     ///     }\n     /// }\n     /// ```\n@@ -817,17 +817,16 @@ pub trait Provider {\n /// # #![feature(provide_any)]\n /// use std::any::{Provider, request_value};\n ///\n-/// fn get_string<P: Provider>(provider: &P) -> String {\n-///     request_value::<String, _>(provider).unwrap()\n+/// fn get_string(provider: &impl Provider) -> String {\n+///     request_value::<String>(provider).unwrap()\n /// }\n /// ```\n #[unstable(feature = \"provide_any\", issue = \"96024\")]\n-pub fn request_value<'a, T, P>(provider: &'a P) -> Option<T>\n+pub fn request_value<'a, T>(provider: &'a (impl Provider + ?Sized)) -> Option<T>\n where\n     T: 'static,\n-    P: Provider + ?Sized,\n {\n-    request_by_type_tag::<'a, tags::Value<T>, P>(provider)\n+    request_by_type_tag::<'a, tags::Value<T>>(provider)\n }\n \n /// Request a reference from the `Provider`.\n@@ -840,24 +839,22 @@ where\n /// # #![feature(provide_any)]\n /// use std::any::{Provider, request_ref};\n ///\n-/// fn get_str<P: Provider>(provider: &P) -> &str {\n-///     request_ref::<str, _>(provider).unwrap()\n+/// fn get_str(provider: &impl Provider) -> &str {\n+///     request_ref::<str>(provider).unwrap()\n /// }\n /// ```\n #[unstable(feature = \"provide_any\", issue = \"96024\")]\n-pub fn request_ref<'a, T, P>(provider: &'a P) -> Option<&'a T>\n+pub fn request_ref<'a, T>(provider: &'a (impl Provider + ?Sized)) -> Option<&'a T>\n where\n     T: 'static + ?Sized,\n-    P: Provider + ?Sized,\n {\n-    request_by_type_tag::<'a, tags::Ref<tags::MaybeSizedValue<T>>, P>(provider)\n+    request_by_type_tag::<'a, tags::Ref<tags::MaybeSizedValue<T>>>(provider)\n }\n \n /// Request a specific value by tag from the `Provider`.\n-fn request_by_type_tag<'a, I, P>(provider: &'a P) -> Option<I::Reified>\n+fn request_by_type_tag<'a, I>(provider: &'a (impl Provider + ?Sized)) -> Option<I::Reified>\n where\n     I: tags::Type<'a>,\n-    P: Provider + ?Sized,\n {\n     let mut tagged = TaggedOption::<'a, I>(None);\n     provider.provide(tagged.as_demand());\n@@ -896,17 +893,16 @@ impl<'a> Demand<'a> {\n     ///\n     /// impl Provider for SomeConcreteType {\n     ///     fn provide<'a>(&'a self, demand: &mut Demand<'a>) {\n-    ///         demand.provide_value::<String, _>(|| self.field.clone());\n+    ///         demand.provide_value::<String>(|| self.field.clone());\n     ///     }\n     /// }\n     /// ```\n     #[unstable(feature = \"provide_any\", issue = \"96024\")]\n-    pub fn provide_value<T, F>(&mut self, fulfil: F) -> &mut Self\n+    pub fn provide_value<T>(&mut self, fulfil: impl FnOnce() -> T) -> &mut Self\n     where\n         T: 'static,\n-        F: FnOnce() -> T,\n     {\n-        self.provide_with::<tags::Value<T>, F>(fulfil)\n+        self.provide_with::<tags::Value<T>>(fulfil)\n     }\n \n     /// Provide a reference, note that the referee type must be bounded by `'static`,\n@@ -944,10 +940,9 @@ impl<'a> Demand<'a> {\n     }\n \n     /// Provide a value with the given `Type` tag, using a closure to prevent unnecessary work.\n-    fn provide_with<I, F>(&mut self, fulfil: F) -> &mut Self\n+    fn provide_with<I>(&mut self, fulfil: impl FnOnce() -> I::Reified) -> &mut Self\n     where\n         I: tags::Type<'a>,\n-        F: FnOnce() -> I::Reified,\n     {\n         if let Some(res @ TaggedOption(None)) = self.0.downcast_mut::<I>() {\n             res.0 = Some(fulfil());"}, {"sha": "8ed0c88808fe27fc47d36b4734dae75a0401e11b", "filename": "library/core/tests/any.rs", "status": "modified", "additions": 11, "deletions": 11, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/8bd12e8cca3f28f302b9cc0f1f47bb64bd1f98fd/library%2Fcore%2Ftests%2Fany.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8bd12e8cca3f28f302b9cc0f1f47bb64bd1f98fd/library%2Fcore%2Ftests%2Fany.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Ftests%2Fany.rs?ref=8bd12e8cca3f28f302b9cc0f1f47bb64bd1f98fd", "patch": "@@ -142,7 +142,7 @@ impl Provider for SomeConcreteType {\n         demand\n             .provide_ref::<String>(&self.some_string)\n             .provide_ref::<str>(&self.some_string)\n-            .provide_value::<String, _>(|| \"bye\".to_owned());\n+            .provide_value::<String>(|| \"bye\".to_owned());\n     }\n }\n \n@@ -151,29 +151,29 @@ impl Provider for SomeConcreteType {\n fn test_provider() {\n     let obj: &dyn Provider = &SomeConcreteType { some_string: \"hello\".to_owned() };\n \n-    assert_eq!(&**request_ref::<String, _>(obj).unwrap(), \"hello\");\n-    assert_eq!(&*request_value::<String, _>(obj).unwrap(), \"bye\");\n-    assert_eq!(request_value::<u8, _>(obj), None);\n+    assert_eq!(&**request_ref::<String>(obj).unwrap(), \"hello\");\n+    assert_eq!(&*request_value::<String>(obj).unwrap(), \"bye\");\n+    assert_eq!(request_value::<u8>(obj), None);\n }\n \n // Test the provide and request mechanisms with a boxed trait object.\n #[test]\n fn test_provider_boxed() {\n     let obj: Box<dyn Provider> = Box::new(SomeConcreteType { some_string: \"hello\".to_owned() });\n \n-    assert_eq!(&**request_ref::<String, _>(&*obj).unwrap(), \"hello\");\n-    assert_eq!(&*request_value::<String, _>(&*obj).unwrap(), \"bye\");\n-    assert_eq!(request_value::<u8, _>(&*obj), None);\n+    assert_eq!(&**request_ref::<String>(&*obj).unwrap(), \"hello\");\n+    assert_eq!(&*request_value::<String>(&*obj).unwrap(), \"bye\");\n+    assert_eq!(request_value::<u8>(&*obj), None);\n }\n \n // Test the provide and request mechanisms with a concrete object.\n #[test]\n fn test_provider_concrete() {\n     let obj = SomeConcreteType { some_string: \"hello\".to_owned() };\n \n-    assert_eq!(&**request_ref::<String, _>(&obj).unwrap(), \"hello\");\n-    assert_eq!(&*request_value::<String, _>(&obj).unwrap(), \"bye\");\n-    assert_eq!(request_value::<u8, _>(&obj), None);\n+    assert_eq!(&**request_ref::<String>(&obj).unwrap(), \"hello\");\n+    assert_eq!(&*request_value::<String>(&obj).unwrap(), \"bye\");\n+    assert_eq!(request_value::<u8>(&obj), None);\n }\n \n trait OtherTrait: Provider {}\n@@ -182,7 +182,7 @@ impl OtherTrait for SomeConcreteType {}\n \n impl dyn OtherTrait {\n     fn get_ref<T: 'static + ?Sized>(&self) -> Option<&T> {\n-        request_ref::<T, _>(self)\n+        request_ref::<T>(self)\n     }\n }\n "}]}