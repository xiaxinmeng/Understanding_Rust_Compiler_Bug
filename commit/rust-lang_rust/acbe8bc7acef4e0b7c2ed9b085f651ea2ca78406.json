{"sha": "acbe8bc7acef4e0b7c2ed9b085f651ea2ca78406", "node_id": "C_kwDOAAsO6NoAKGFjYmU4YmM3YWNlZjRlMGI3YzJlZDliMDg1ZjY1MWVhMmNhNzg0MDY", "commit": {"author": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-11-11T13:39:20Z"}, "committer": {"name": "Jonas Schievink", "email": "jonasschievink@gmail.com", "date": "2021-11-11T13:44:12Z"}, "message": "Prime a more reasonable set of crates", "tree": {"sha": "ae7691adcc7d4dfc6f477dceec2ff627abc6dd0c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ae7691adcc7d4dfc6f477dceec2ff627abc6dd0c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/acbe8bc7acef4e0b7c2ed9b085f651ea2ca78406", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/acbe8bc7acef4e0b7c2ed9b085f651ea2ca78406", "html_url": "https://github.com/rust-lang/rust/commit/acbe8bc7acef4e0b7c2ed9b085f651ea2ca78406", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/acbe8bc7acef4e0b7c2ed9b085f651ea2ca78406/comments", "author": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jonas-schievink", "id": 1786438, "node_id": "MDQ6VXNlcjE3ODY0Mzg=", "avatar_url": "https://avatars.githubusercontent.com/u/1786438?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jonas-schievink", "html_url": "https://github.com/jonas-schievink", "followers_url": "https://api.github.com/users/jonas-schievink/followers", "following_url": "https://api.github.com/users/jonas-schievink/following{/other_user}", "gists_url": "https://api.github.com/users/jonas-schievink/gists{/gist_id}", "starred_url": "https://api.github.com/users/jonas-schievink/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jonas-schievink/subscriptions", "organizations_url": "https://api.github.com/users/jonas-schievink/orgs", "repos_url": "https://api.github.com/users/jonas-schievink/repos", "events_url": "https://api.github.com/users/jonas-schievink/events{/privacy}", "received_events_url": "https://api.github.com/users/jonas-schievink/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3b3063fb2d1804b3dc42184027ef08073de03fd9", "url": "https://api.github.com/repos/rust-lang/rust/commits/3b3063fb2d1804b3dc42184027ef08073de03fd9", "html_url": "https://github.com/rust-lang/rust/commit/3b3063fb2d1804b3dc42184027ef08073de03fd9"}], "stats": {"total": 29, "additions": 27, "deletions": 2}, "files": [{"sha": "41e48c4ba563850d39fce9c5da4fb93df6eb5635", "filename": "crates/ide/src/prime_caches.rs", "status": "modified", "additions": 27, "deletions": 2, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/acbe8bc7acef4e0b7c2ed9b085f651ea2ca78406/crates%2Fide%2Fsrc%2Fprime_caches.rs", "raw_url": "https://github.com/rust-lang/rust/raw/acbe8bc7acef4e0b7c2ed9b085f651ea2ca78406/crates%2Fide%2Fsrc%2Fprime_caches.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Fprime_caches.rs?ref=acbe8bc7acef4e0b7c2ed9b085f651ea2ca78406", "patch": "@@ -4,7 +4,8 @@\n //! various caches, it's not really advanced at the moment.\n \n use hir::db::DefDatabase;\n-use ide_db::base_db::SourceDatabase;\n+use ide_db::base_db::{CrateGraph, CrateId, SourceDatabase, SourceDatabaseExt};\n+use rustc_hash::FxHashSet;\n \n use crate::RootDatabase;\n \n@@ -19,7 +20,18 @@ pub struct PrimeCachesProgress {\n pub(crate) fn prime_caches(db: &RootDatabase, cb: &(dyn Fn(PrimeCachesProgress) + Sync)) {\n     let _p = profile::span(\"prime_caches\");\n     let graph = db.crate_graph();\n-    let topo = &graph.crates_in_topological_order();\n+    // We're only interested in the transitive dependencies of all workspace crates.\n+    let to_prime: FxHashSet<_> = graph\n+        .iter()\n+        .filter(|&id| {\n+            let file_id = graph[id].root_file_id;\n+            let root_id = db.file_source_root(file_id);\n+            !db.source_root(root_id).is_library\n+        })\n+        .flat_map(|id| graph.transitive_deps(id))\n+        .collect();\n+\n+    let topo = toposort(&graph, &to_prime);\n \n     // FIXME: This would be easy to parallelize, since it's in the ideal ordering for that.\n     // Unfortunately rayon prevents panics from propagation out of a `scope`, which breaks\n@@ -32,3 +44,16 @@ pub(crate) fn prime_caches(db: &RootDatabase, cb: &(dyn Fn(PrimeCachesProgress)\n         db.import_map(crate_id);\n     }\n }\n+\n+fn toposort(graph: &CrateGraph, crates: &FxHashSet<CrateId>) -> Vec<CrateId> {\n+    // Just subset the full topologically sorted set for simplicity.\n+\n+    let all = graph.crates_in_topological_order();\n+    let mut result = Vec::with_capacity(crates.len());\n+    for krate in all {\n+        if crates.contains(&krate) {\n+            result.push(krate);\n+        }\n+    }\n+    result\n+}"}]}