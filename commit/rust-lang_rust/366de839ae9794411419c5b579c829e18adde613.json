{"sha": "366de839ae9794411419c5b579c829e18adde613", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM2NmRlODM5YWU5Nzk0NDExNDE5YzViNTc5YzgyOWUxOGFkZGU2MTM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-06-28T18:52:36Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2016-06-28T18:52:36Z"}, "message": "Auto merge of #34519 - alexcrichton:fix-nightlies, r=brson\n\nTry to fix the nightlies\n\nThey look to be failing right after the CMake PR landed. I've diagnosed and confirmed the first issue fixed, the second is a bit of a shot in the dark to see if it fixes things.", "tree": {"sha": "e57c7bb7777858f221e8af85c27f7a569b94473d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e57c7bb7777858f221e8af85c27f7a569b94473d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/366de839ae9794411419c5b579c829e18adde613", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/366de839ae9794411419c5b579c829e18adde613", "html_url": "https://github.com/rust-lang/rust/commit/366de839ae9794411419c5b579c829e18adde613", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/366de839ae9794411419c5b579c829e18adde613/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "59152a45af3688b53e677ea2362339643499c1a4", "url": "https://api.github.com/repos/rust-lang/rust/commits/59152a45af3688b53e677ea2362339643499c1a4", "html_url": "https://github.com/rust-lang/rust/commit/59152a45af3688b53e677ea2362339643499c1a4"}, {"sha": "3fd411e017ca78eb814272a3b3a71c8b755c4550", "url": "https://api.github.com/repos/rust-lang/rust/commits/3fd411e017ca78eb814272a3b3a71c8b755c4550", "html_url": "https://github.com/rust-lang/rust/commit/3fd411e017ca78eb814272a3b3a71c8b755c4550"}], "stats": {"total": 83, "additions": 59, "deletions": 24}, "files": [{"sha": "6d8601f3dad6d3bee0c8ce725e2efc4418fe85b2", "filename": "mk/llvm.mk", "status": "modified", "additions": 13, "deletions": 1, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/366de839ae9794411419c5b579c829e18adde613/mk%2Fllvm.mk", "raw_url": "https://github.com/rust-lang/rust/raw/366de839ae9794411419c5b579c829e18adde613/mk%2Fllvm.mk", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/mk%2Fllvm.mk?ref=366de839ae9794411419c5b579c829e18adde613", "patch": "@@ -27,12 +27,18 @@ endif\n \n define DEF_LLVM_RULES\n \n+ifeq ($(1),$$(CFG_BUILD))\n+LLVM_DEPS_TARGET_$(1) := $$(LLVM_DEPS)\n+else\n+LLVM_DEPS_TARGET_$(1) := $$(LLVM_DEPS) $$(LLVM_CONFIG_$$(CFG_BUILD))\n+endif\n+\n # If CFG_LLVM_ROOT is defined then we don't build LLVM ourselves\n ifeq ($(CFG_LLVM_ROOT),)\n \n LLVM_STAMP_$(1) = $$(CFG_LLVM_BUILD_DIR_$(1))/llvm-auto-clean-stamp\n \n-$$(LLVM_CONFIG_$(1)): $$(LLVM_DEPS) $$(LLVM_STAMP_$(1))\n+$$(LLVM_CONFIG_$(1)): $$(LLVM_DEPS_TARGET_$(1)) $$(LLVM_STAMP_$(1))\n \t@$$(call E, cmake: llvm)\n ifeq ($$(findstring msvc,$(1)),msvc)\n \t$$(Q)$$(CFG_CMAKE) --build $$(CFG_LLVM_BUILD_DIR_$(1)) \\\n@@ -42,7 +48,13 @@ else\n endif\n \t$$(Q)touch $$(LLVM_CONFIG_$(1))\n \n+ifeq ($$(findstring msvc,$(1)),msvc)\n clean-llvm$(1):\n+else\n+clean-llvm$(1):\n+\t@$$(call E, clean: llvm)\n+\t$$(Q)$$(MAKE) -C $$(CFG_LLVM_BUILD_DIR_$(1)) clean\n+endif\n \n else\n clean-llvm$(1):"}, {"sha": "1e677aa48b0f664346ad29af25d756627578b4e7", "filename": "src/bootstrap/build/native.rs", "status": "modified", "additions": 46, "deletions": 23, "changes": 69, "blob_url": "https://github.com/rust-lang/rust/blob/366de839ae9794411419c5b579c829e18adde613/src%2Fbootstrap%2Fbuild%2Fnative.rs", "raw_url": "https://github.com/rust-lang/rust/raw/366de839ae9794411419c5b579c829e18adde613/src%2Fbootstrap%2Fbuild%2Fnative.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbuild%2Fnative.rs?ref=366de839ae9794411419c5b579c829e18adde613", "patch": "@@ -135,27 +135,64 @@ pub fn compiler_rt(build: &Build, target: &str) {\n     let dst = build.compiler_rt_out(target);\n     let arch = target.split('-').next().unwrap();\n     let mode = if build.config.rust_optimize {\"Release\"} else {\"Debug\"};\n+\n+    let build_llvm_config = build.llvm_config(&build.config.build);\n+    let mut cfg = cmake::Config::new(build.src.join(\"src/compiler-rt\"));\n+    cfg.target(target)\n+       .host(&build.config.build)\n+       .out_dir(&dst)\n+       .profile(mode)\n+       .define(\"LLVM_CONFIG_PATH\", build_llvm_config)\n+       .define(\"COMPILER_RT_DEFAULT_TARGET_TRIPLE\", target)\n+       .define(\"COMPILER_RT_BUILD_SANITIZERS\", \"OFF\")\n+       .define(\"COMPILER_RT_BUILD_EMUTLS\", \"OFF\")\n+       // inform about c/c++ compilers, the c++ compiler isn't actually used but\n+       // it's needed to get the initial configure to work on all platforms.\n+       .define(\"CMAKE_C_COMPILER\", build.cc(target))\n+       .define(\"CMAKE_CXX_COMPILER\", build.cc(target));\n+\n     let (dir, build_target, libname) = if target.contains(\"linux\") ||\n                                           target.contains(\"freebsd\") ||\n                                           target.contains(\"netbsd\") {\n-        let os = if target.contains(\"android\") {\"-android\"} else {\"\"};\n-        let arch = if arch.starts_with(\"arm\") && target.contains(\"eabihf\") {\n-            \"armhf\"\n+        let os_extra = if target.contains(\"android\") && target.contains(\"arm\") {\n+            \"-android\"\n         } else {\n-            arch\n+            \"\"\n         };\n-        let target = format!(\"clang_rt.builtins-{}{}\", arch, os);\n+        let builtins_arch = match arch {\n+            \"i586\" => \"i386\",\n+            \"arm\" | \"armv7\" if target.contains(\"android\") => \"armhf\",\n+            \"arm\" if target.contains(\"eabihf\") => \"armhf\",\n+            _ => arch,\n+        };\n+        let target = format!(\"clang_rt.builtins-{}{}\", builtins_arch, os_extra);\n         (\"linux\".to_string(), target.clone(), target)\n-    } else if target.contains(\"darwin\") {\n-        let target = format!(\"clang_rt.builtins_{}_osx\", arch);\n+    } else if target.contains(\"apple-darwin\") {\n+        let builtins_arch = match arch {\n+            \"i686\" => \"i386\",\n+            _ => arch,\n+        };\n+        let target = format!(\"clang_rt.builtins_{}_osx\", builtins_arch);\n+        (\"builtins\".to_string(), target.clone(), target)\n+    } else if target.contains(\"apple-ios\") {\n+        cfg.define(\"COMPILER_RT_ENABLE_IOS\", \"ON\");\n+        let target = match arch {\n+            \"armv7s\" => \"hard_pic_armv7em_macho_embedded\".to_string(),\n+            \"aarch64\" => \"builtins_arm64_ios\".to_string(),\n+            _ => format!(\"hard_pic_{}_macho_embedded\", arch),\n+        };\n         (\"builtins\".to_string(), target.clone(), target)\n     } else if target.contains(\"windows-gnu\") {\n         let target = format!(\"clang_rt.builtins-{}\", arch);\n         (\"windows\".to_string(), target.clone(), target)\n     } else if target.contains(\"windows-msvc\") {\n+        let builtins_arch = match arch {\n+            \"i586\" | \"i686\" => \"i386\",\n+            _ => arch,\n+        };\n         (format!(\"windows/{}\", mode),\n          \"lib/builtins/builtins\".to_string(),\n-         format!(\"clang_rt.builtins-{}\", arch.replace(\"i686\", \"i386\")))\n+         format!(\"clang_rt.builtins-{}\", builtins_arch))\n     } else {\n         panic!(\"can't get os from target: {}\", target)\n     };\n@@ -168,21 +205,7 @@ pub fn compiler_rt(build: &Build, target: &str) {\n     }\n     let _ = fs::remove_dir_all(&dst);\n     t!(fs::create_dir_all(&dst));\n-    let build_llvm_config = build.llvm_config(&build.config.build);\n-    let mut cfg = cmake::Config::new(build.src.join(\"src/compiler-rt\"));\n-    cfg.target(target)\n-       .host(&build.config.build)\n-       .out_dir(&dst)\n-       .profile(mode)\n-       .define(\"LLVM_CONFIG_PATH\", build_llvm_config)\n-       .define(\"COMPILER_RT_DEFAULT_TARGET_TRIPLE\", target)\n-       .define(\"COMPILER_RT_BUILD_SANITIZERS\", \"OFF\")\n-       .define(\"COMPILER_RT_BUILD_EMUTLS\", \"OFF\")\n-       // inform about c/c++ compilers, the c++ compiler isn't actually used but\n-       // it's needed to get the initial configure to work on all platforms.\n-       .define(\"CMAKE_C_COMPILER\", build.cc(target))\n-       .define(\"CMAKE_CXX_COMPILER\", build.cc(target))\n-       .build_target(&build_target);\n+    cfg.build_target(&build_target);\n     cfg.build();\n }\n "}]}