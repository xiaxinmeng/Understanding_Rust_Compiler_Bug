{"sha": "c1712e55c6d7fbb9d7ccef5de0be0b1c41033219", "node_id": "C_kwDOAAsO6NoAKGMxNzEyZTU1YzZkN2ZiYjlkN2NjZWY1ZGUwYmUwYjFjNDEwMzMyMTk", "commit": {"author": {"name": "Sebastian Ziebell", "email": "sebastian.ziebell@ferrous-systems.com", "date": "2023-04-17T09:34:04Z"}, "committer": {"name": "Sebastian Ziebell", "email": "sebastian.ziebell@ferrous-systems.com", "date": "2023-04-17T10:36:32Z"}, "message": "Restrict \"sort items\" assist inside Impl & Trait\n\nThis fixes the applicability of the \"sort items alphabetically\" assist\nwhen the selection is inside a `Trait` or `Impl`. It's now tested if the\nselection is inside or overlaps with an inner node, e.g. associated\nconst or type alias, function.", "tree": {"sha": "f050e57bc79658fa16d2707a78ddc82dee92f8a3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f050e57bc79658fa16d2707a78ddc82dee92f8a3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c1712e55c6d7fbb9d7ccef5de0be0b1c41033219", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c1712e55c6d7fbb9d7ccef5de0be0b1c41033219", "html_url": "https://github.com/rust-lang/rust/commit/c1712e55c6d7fbb9d7ccef5de0be0b1c41033219", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c1712e55c6d7fbb9d7ccef5de0be0b1c41033219/comments", "author": {"login": "justahero", "id": 1305185, "node_id": "MDQ6VXNlcjEzMDUxODU=", "avatar_url": "https://avatars.githubusercontent.com/u/1305185?v=4", "gravatar_id": "", "url": "https://api.github.com/users/justahero", "html_url": "https://github.com/justahero", "followers_url": "https://api.github.com/users/justahero/followers", "following_url": "https://api.github.com/users/justahero/following{/other_user}", "gists_url": "https://api.github.com/users/justahero/gists{/gist_id}", "starred_url": "https://api.github.com/users/justahero/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/justahero/subscriptions", "organizations_url": "https://api.github.com/users/justahero/orgs", "repos_url": "https://api.github.com/users/justahero/repos", "events_url": "https://api.github.com/users/justahero/events{/privacy}", "received_events_url": "https://api.github.com/users/justahero/received_events", "type": "User", "site_admin": false}, "committer": {"login": "justahero", "id": 1305185, "node_id": "MDQ6VXNlcjEzMDUxODU=", "avatar_url": "https://avatars.githubusercontent.com/u/1305185?v=4", "gravatar_id": "", "url": "https://api.github.com/users/justahero", "html_url": "https://github.com/justahero", "followers_url": "https://api.github.com/users/justahero/followers", "following_url": "https://api.github.com/users/justahero/following{/other_user}", "gists_url": "https://api.github.com/users/justahero/gists{/gist_id}", "starred_url": "https://api.github.com/users/justahero/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/justahero/subscriptions", "organizations_url": "https://api.github.com/users/justahero/orgs", "repos_url": "https://api.github.com/users/justahero/repos", "events_url": "https://api.github.com/users/justahero/events{/privacy}", "received_events_url": "https://api.github.com/users/justahero/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "600283f2de12b40fbe60a6cade3650785ef0bbbc", "url": "https://api.github.com/repos/rust-lang/rust/commits/600283f2de12b40fbe60a6cade3650785ef0bbbc", "html_url": "https://github.com/rust-lang/rust/commit/600283f2de12b40fbe60a6cade3650785ef0bbbc"}], "stats": {"total": 109, "additions": 103, "deletions": 6}, "files": [{"sha": "3a0121f55fa02b6b89a4d4f01516627833dcf1fc", "filename": "crates/ide-assists/src/handlers/sort_items.rs", "status": "modified", "additions": 103, "deletions": 6, "changes": 109, "blob_url": "https://github.com/rust-lang/rust/blob/c1712e55c6d7fbb9d7ccef5de0be0b1c41033219/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fsort_items.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c1712e55c6d7fbb9d7ccef5de0be0b1c41033219/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fsort_items.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-assists%2Fsrc%2Fhandlers%2Fsort_items.rs?ref=c1712e55c6d7fbb9d7ccef5de0be0b1c41033219", "patch": "@@ -87,11 +87,7 @@ pub(crate) fn sort_items(acc: &mut Assists, ctx: &AssistContext<'_>) -> Option<(\n         return None;\n     }\n \n-    if let Some(trait_ast) = ctx.find_node_at_offset::<ast::Trait>() {\n-        add_sort_methods_assist(acc, trait_ast.assoc_item_list()?)\n-    } else if let Some(impl_ast) = ctx.find_node_at_offset::<ast::Impl>() {\n-        add_sort_methods_assist(acc, impl_ast.assoc_item_list()?)\n-    } else if let Some(struct_ast) = ctx.find_node_at_offset::<ast::Struct>() {\n+    if let Some(struct_ast) = ctx.find_node_at_offset::<ast::Struct>() {\n         add_sort_field_list_assist(acc, struct_ast.field_list())\n     } else if let Some(union_ast) = ctx.find_node_at_offset::<ast::Union>() {\n         add_sort_fields_assist(acc, union_ast.record_field_list()?)\n@@ -103,6 +99,10 @@ pub(crate) fn sort_items(acc: &mut Assists, ctx: &AssistContext<'_>) -> Option<(\n         add_sort_fields_assist(acc, enum_struct_variant_ast)\n     } else if let Some(enum_ast) = ctx.find_node_at_offset::<ast::Enum>() {\n         add_sort_variants_assist(acc, enum_ast.variant_list()?)\n+    } else if let Some(trait_ast) = ctx.find_node_at_offset::<ast::Trait>() {\n+        add_sort_methods_assist(acc, ctx, trait_ast.assoc_item_list()?)\n+    } else if let Some(impl_ast) = ctx.find_node_at_offset::<ast::Impl>() {\n+        add_sort_methods_assist(acc, ctx, impl_ast.assoc_item_list()?)\n     } else {\n         None\n     }\n@@ -148,7 +148,19 @@ fn add_sort_field_list_assist(acc: &mut Assists, field_list: Option<ast::FieldLi\n     }\n }\n \n-fn add_sort_methods_assist(acc: &mut Assists, item_list: ast::AssocItemList) -> Option<()> {\n+fn add_sort_methods_assist(\n+    acc: &mut Assists,\n+    ctx: &AssistContext<'_>,\n+    item_list: ast::AssocItemList,\n+) -> Option<()> {\n+    let selection = ctx.selection_trimmed();\n+\n+    // ignore assist if the selection intersects with an associated item.\n+    if item_list.assoc_items().any(|item| item.syntax().text_range().intersect(selection).is_some())\n+    {\n+        return None;\n+    }\n+\n     let methods = get_methods(&item_list);\n     let sorted = sort_by_name(&methods);\n \n@@ -218,6 +230,51 @@ mod tests {\n \n     use super::*;\n \n+    #[test]\n+    fn not_applicable_if_selection_in_fn_body() {\n+        check_assist_not_applicable(\n+            sort_items,\n+            r#\"\n+struct S;\n+impl S {\n+    fn func2() {\n+        $0 bar $0\n+    }\n+    fn func() {}\n+}\n+        \"#,\n+        )\n+    }\n+\n+    #[test]\n+    fn not_applicable_if_selection_at_associated_const() {\n+        check_assist_not_applicable(\n+            sort_items,\n+            r#\"\n+struct S;\n+impl S {\n+    fn func2() {}\n+    fn func() {}\n+    const C: () = $0()$0;\n+}\n+        \"#,\n+        )\n+    }\n+\n+    #[test]\n+    fn not_applicable_if_selection_overlaps_nodes() {\n+        check_assist_not_applicable(\n+            sort_items,\n+            r#\"\n+struct S;\n+impl $0S {\n+    fn$0 func2() {}\n+    fn func() {}\n+}\n+        \"#,\n+        )\n+    }\n+\n     #[test]\n     fn not_applicable_if_no_selection() {\n         cov_mark::check!(not_applicable_if_no_selection);\n@@ -233,6 +290,21 @@ t$0rait Bar {\n         )\n     }\n \n+    #[test]\n+    fn not_applicable_if_selection_in_trait_fn_body() {\n+        check_assist_not_applicable(\n+            sort_items,\n+            r#\"\n+trait Bar {\n+    fn b() {\n+        $0 hello $0\n+    }\n+    fn a();\n+}\n+        \"#,\n+        )\n+    }\n+\n     #[test]\n     fn not_applicable_if_trait_empty() {\n         cov_mark::check!(not_applicable_if_sorted_or_empty_or_single);\n@@ -460,6 +532,31 @@ struct Bar {\n         )\n     }\n \n+    #[test]\n+    fn sort_struct_inside_a_function() {\n+        check_assist(\n+            sort_items,\n+            r#\"\n+fn hello() {\n+    $0struct Bar$0 {\n+        b: u8,\n+        a: u32,\n+        c: u64,\n+    }\n+}\n+        \"#,\n+            r#\"\n+fn hello() {\n+    struct Bar {\n+        a: u32,\n+        b: u8,\n+        c: u64,\n+    }\n+}\n+        \"#,\n+        )\n+    }\n+\n     #[test]\n     fn sort_generic_struct_with_lifetime() {\n         check_assist("}]}