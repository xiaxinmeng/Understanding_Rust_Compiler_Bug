{"sha": "af669c26846f85fd15e34a6f03d5d2f237444c17", "node_id": "C_kwDOAAsO6NoAKGFmNjY5YzI2ODQ2Zjg1ZmQxNWUzNGE2ZjAzZDVkMmYyMzc0NDRjMTc", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-01-16T12:30:49Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-01-16T12:30:49Z"}, "message": "Auto merge of #106850 - cjgillot:issue-106141, r=oli-obk\n\nMake the inlining destination a Local.\n\nFixes https://github.com/rust-lang/rust/issues/106141", "tree": {"sha": "9e2723346bf55e06869542cb075c382117ca2414", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/9e2723346bf55e06869542cb075c382117ca2414"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/af669c26846f85fd15e34a6f03d5d2f237444c17", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/af669c26846f85fd15e34a6f03d5d2f237444c17", "html_url": "https://github.com/rust-lang/rust/commit/af669c26846f85fd15e34a6f03d5d2f237444c17", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/af669c26846f85fd15e34a6f03d5d2f237444c17/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a5bfc25c93d2549887848529382892f93c95207d", "url": "https://api.github.com/repos/rust-lang/rust/commits/a5bfc25c93d2549887848529382892f93c95207d", "html_url": "https://github.com/rust-lang/rust/commit/a5bfc25c93d2549887848529382892f93c95207d"}, {"sha": "389d52c1eb724b4242b6a8ac36c694c6e68b8dd2", "url": "https://api.github.com/repos/rust-lang/rust/commits/389d52c1eb724b4242b6a8ac36c694c6e68b8dd2", "html_url": "https://github.com/rust-lang/rust/commit/389d52c1eb724b4242b6a8ac36c694c6e68b8dd2"}], "stats": {"total": 149, "additions": 118, "deletions": 31}, "files": [{"sha": "28c9080d38d7d38720b83e5f27e48ac8916fc803", "filename": "compiler/rustc_mir_transform/src/inline.rs", "status": "modified", "additions": 28, "deletions": 24, "changes": 52, "blob_url": "https://github.com/rust-lang/rust/blob/af669c26846f85fd15e34a6f03d5d2f237444c17/compiler%2Frustc_mir_transform%2Fsrc%2Finline.rs", "raw_url": "https://github.com/rust-lang/rust/raw/af669c26846f85fd15e34a6f03d5d2f237444c17/compiler%2Frustc_mir_transform%2Fsrc%2Finline.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Finline.rs?ref=af669c26846f85fd15e34a6f03d5d2f237444c17", "patch": "@@ -542,6 +542,21 @@ impl<'tcx> Inliner<'tcx> {\n                     destination\n                 };\n \n+                // Always create a local to hold the destination, as `RETURN_PLACE` may appear\n+                // where a full `Place` is not allowed.\n+                let (remap_destination, destination_local) = if let Some(d) = dest.as_local() {\n+                    (false, d)\n+                } else {\n+                    (\n+                        true,\n+                        self.new_call_temp(\n+                            caller_body,\n+                            &callsite,\n+                            destination.ty(caller_body, self.tcx).ty,\n+                        ),\n+                    )\n+                };\n+\n                 // Copy the arguments if needed.\n                 let args: Vec<_> = self.make_call_args(args, &callsite, caller_body, &callee_body);\n \n@@ -560,7 +575,7 @@ impl<'tcx> Inliner<'tcx> {\n                     new_locals: Local::new(caller_body.local_decls.len())..,\n                     new_scopes: SourceScope::new(caller_body.source_scopes.len())..,\n                     new_blocks: BasicBlock::new(caller_body.basic_blocks.len())..,\n-                    destination: dest,\n+                    destination: destination_local,\n                     callsite_scope: caller_body.source_scopes[callsite.source_info.scope].clone(),\n                     callsite,\n                     cleanup_block: cleanup,\n@@ -591,6 +606,16 @@ impl<'tcx> Inliner<'tcx> {\n                     // To avoid repeated O(n) insert, push any new statements to the end and rotate\n                     // the slice once.\n                     let mut n = 0;\n+                    if remap_destination {\n+                        caller_body[block].statements.push(Statement {\n+                            source_info: callsite.source_info,\n+                            kind: StatementKind::Assign(Box::new((\n+                                dest,\n+                                Rvalue::Use(Operand::Move(destination_local.into())),\n+                            ))),\n+                        });\n+                        n += 1;\n+                    }\n                     for local in callee_body.vars_and_temps_iter().rev() {\n                         if !callee_body.local_decls[local].internal\n                             && integrator.always_live_locals.contains(local)\n@@ -959,7 +984,7 @@ struct Integrator<'a, 'tcx> {\n     new_locals: RangeFrom<Local>,\n     new_scopes: RangeFrom<SourceScope>,\n     new_blocks: RangeFrom<BasicBlock>,\n-    destination: Place<'tcx>,\n+    destination: Local,\n     callsite_scope: SourceScopeData<'tcx>,\n     callsite: &'a CallSite<'tcx>,\n     cleanup_block: Option<BasicBlock>,\n@@ -972,7 +997,7 @@ struct Integrator<'a, 'tcx> {\n impl Integrator<'_, '_> {\n     fn map_local(&self, local: Local) -> Local {\n         let new = if local == RETURN_PLACE {\n-            self.destination.local\n+            self.destination\n         } else {\n             let idx = local.index() - 1;\n             if idx < self.args.len() {\n@@ -1053,27 +1078,6 @@ impl<'tcx> MutVisitor<'tcx> for Integrator<'_, 'tcx> {\n         *span = span.fresh_expansion(self.expn_data);\n     }\n \n-    fn visit_place(&mut self, place: &mut Place<'tcx>, context: PlaceContext, location: Location) {\n-        for elem in place.projection {\n-            // FIXME: Make sure that return place is not used in an indexing projection, since it\n-            // won't be rebased as it is supposed to be.\n-            assert_ne!(ProjectionElem::Index(RETURN_PLACE), elem);\n-        }\n-\n-        // If this is the `RETURN_PLACE`, we need to rebase any projections onto it.\n-        let dest_proj_len = self.destination.projection.len();\n-        if place.local == RETURN_PLACE && dest_proj_len > 0 {\n-            let mut projs = Vec::with_capacity(dest_proj_len + place.projection.len());\n-            projs.extend(self.destination.projection);\n-            projs.extend(place.projection);\n-\n-            place.projection = self.tcx.intern_place_elems(&*projs);\n-        }\n-        // Handles integrating any locals that occur in the base\n-        // or projections\n-        self.super_place(place, context, location)\n-    }\n-\n     fn visit_basic_block_data(&mut self, block: BasicBlock, data: &mut BasicBlockData<'tcx>) {\n         self.in_cleanup_block = data.is_cleanup;\n         self.super_basic_block_data(block, data);"}, {"sha": "a28da146e378659e68193505aeba97c8cb3d0d08", "filename": "tests/mir-opt/inline/inline_into_box_place.main.Inline.diff", "status": "modified", "additions": 11, "deletions": 7, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/af669c26846f85fd15e34a6f03d5d2f237444c17/tests%2Fmir-opt%2Finline%2Finline_into_box_place.main.Inline.diff", "raw_url": "https://github.com/rust-lang/rust/raw/af669c26846f85fd15e34a6f03d5d2f237444c17/tests%2Fmir-opt%2Finline%2Finline_into_box_place.main.Inline.diff", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Finline%2Finline_into_box_place.main.Inline.diff?ref=af669c26846f85fd15e34a6f03d5d2f237444c17", "patch": "@@ -11,13 +11,14 @@\n       let mut _6: ();                      // in scope 0 at $DIR/inline_into_box_place.rs:+1:42: +1:43\n       let mut _7: *const std::vec::Vec<u32>; // in scope 0 at $DIR/inline_into_box_place.rs:+1:29: +1:43\n +     let mut _8: &mut std::vec::Vec<u32>; // in scope 0 at $DIR/inline_into_box_place.rs:+1:33: +1:43\n++     let mut _9: std::vec::Vec<u32>;      // in scope 0 at $DIR/inline_into_box_place.rs:+1:33: +1:43\n       scope 1 {\n           debug _x => _1;                  // in scope 1 at $DIR/inline_into_box_place.rs:+1:9: +1:11\n       }\n       scope 2 {\n       }\n +     scope 3 (inlined Vec::<u32>::new) {  // at $DIR/inline_into_box_place.rs:8:33: 8:43\n-+         let mut _9: alloc::raw_vec::RawVec<u32>; // in scope 3 at $SRC_DIR/alloc/src/vec/mod.rs:LL:COL\n++         let mut _10: alloc::raw_vec::RawVec<u32>; // in scope 3 at $SRC_DIR/alloc/src/vec/mod.rs:LL:COL\n +     }\n   \n       bb0: {\n@@ -37,8 +38,9 @@\n -         (*_7) = Vec::<u32>::new() -> [return: bb2, unwind: bb5]; // scope 0 at $DIR/inline_into_box_place.rs:+1:33: +1:43\n +         StorageLive(_8);                 // scope 0 at $DIR/inline_into_box_place.rs:+1:33: +1:43\n +         _8 = &mut (*_7);                 // scope 0 at $DIR/inline_into_box_place.rs:+1:33: +1:43\n-+         StorageLive(_9);                 // scope 3 at $SRC_DIR/alloc/src/vec/mod.rs:LL:COL\n-+         _9 = const _;                    // scope 3 at $SRC_DIR/alloc/src/vec/mod.rs:LL:COL\n++         StorageLive(_9);                 // scope 0 at $DIR/inline_into_box_place.rs:+1:33: +1:43\n++         StorageLive(_10);                // scope 3 at $SRC_DIR/alloc/src/vec/mod.rs:LL:COL\n++         _10 = const _;                   // scope 3 at $SRC_DIR/alloc/src/vec/mod.rs:LL:COL\n                                            // mir::Constant\n -                                          // + span: $DIR/inline_into_box_place.rs:8:33: 8:41\n -                                          // + user_ty: UserType(1)\n@@ -49,10 +51,12 @@\n +                                          // + span: $SRC_DIR/alloc/src/vec/mod.rs:LL:COL\n +                                          // + user_ty: UserType(0)\n +                                          // + literal: Const { ty: alloc::raw_vec::RawVec<u32>, val: Unevaluated(alloc::raw_vec::RawVec::<T>::NEW, [u32], None) }\n-+         Deinit((*_8));                   // scope 3 at $SRC_DIR/alloc/src/vec/mod.rs:LL:COL\n-+         ((*_8).0: alloc::raw_vec::RawVec<u32>) = move _9; // scope 3 at $SRC_DIR/alloc/src/vec/mod.rs:LL:COL\n-+         ((*_8).1: usize) = const 0_usize; // scope 3 at $SRC_DIR/alloc/src/vec/mod.rs:LL:COL\n-+         StorageDead(_9);                 // scope 3 at $SRC_DIR/alloc/src/vec/mod.rs:LL:COL\n++         Deinit(_9);                      // scope 3 at $SRC_DIR/alloc/src/vec/mod.rs:LL:COL\n++         (_9.0: alloc::raw_vec::RawVec<u32>) = move _10; // scope 3 at $SRC_DIR/alloc/src/vec/mod.rs:LL:COL\n++         (_9.1: usize) = const 0_usize;   // scope 3 at $SRC_DIR/alloc/src/vec/mod.rs:LL:COL\n++         StorageDead(_10);                // scope 3 at $SRC_DIR/alloc/src/vec/mod.rs:LL:COL\n++         (*_8) = move _9;                 // scope 0 at $DIR/inline_into_box_place.rs:+1:33: +1:43\n++         StorageDead(_9);                 // scope 0 at $DIR/inline_into_box_place.rs:+1:33: +1:43\n +         StorageDead(_8);                 // scope 0 at $DIR/inline_into_box_place.rs:+1:33: +1:43\n           _1 = move _5;                    // scope 0 at $DIR/inline_into_box_place.rs:+1:29: +1:43\n           StorageDead(_5);                 // scope 0 at $DIR/inline_into_box_place.rs:+1:42: +1:43"}, {"sha": "97361fa5f4c3b8197bac2466fb9c0a8b33bebc87", "filename": "tests/mir-opt/inline/issue_106141.outer.Inline.diff", "status": "added", "additions": 55, "deletions": 0, "changes": 55, "blob_url": "https://github.com/rust-lang/rust/blob/af669c26846f85fd15e34a6f03d5d2f237444c17/tests%2Fmir-opt%2Finline%2Fissue_106141.outer.Inline.diff", "raw_url": "https://github.com/rust-lang/rust/raw/af669c26846f85fd15e34a6f03d5d2f237444c17/tests%2Fmir-opt%2Finline%2Fissue_106141.outer.Inline.diff", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Finline%2Fissue_106141.outer.Inline.diff?ref=af669c26846f85fd15e34a6f03d5d2f237444c17", "patch": "@@ -0,0 +1,55 @@\n+- // MIR for `outer` before Inline\n++ // MIR for `outer` after Inline\n+  \n+  fn outer() -> usize {\n+      let mut _0: usize;                   // return place in scope 0 at $DIR/issue_106141.rs:+0:19: +0:24\n++     scope 1 (inlined inner) {            // at $DIR/issue_106141.rs:2:5: 2:12\n++         let mut _1: bool;                // in scope 1 at $DIR/issue_106141.rs:13:8: 13:21\n++         let mut _2: bool;                // in scope 1 at $DIR/issue_106141.rs:13:8: 13:21\n++         let mut _3: &[bool; 1];          // in scope 1 at $DIR/issue_106141.rs:11:18: 11:25\n++         scope 2 {\n++             debug buffer => _3;          // in scope 2 at $DIR/issue_106141.rs:11:9: 11:15\n++             scope 3 {\n++                 debug index => _0;       // in scope 3 at $DIR/issue_106141.rs:12:9: 12:14\n++             }\n++         }\n++     }\n+  \n+      bb0: {\n+-         _0 = inner() -> bb1;             // scope 0 at $DIR/issue_106141.rs:+1:5: +1:12\n++         StorageLive(_3);                 // scope 0 at $DIR/issue_106141.rs:+1:5: +1:12\n++         _3 = const _;                    // scope 1 at $DIR/issue_106141.rs:11:18: 11:25\n+                                           // mir::Constant\n+-                                          // + span: $DIR/issue_106141.rs:2:5: 2:10\n+-                                          // + literal: Const { ty: fn() -> usize {inner}, val: Value(<ZST>) }\n++                                          // + span: $DIR/issue_106141.rs:11:18: 11:25\n++                                          // + literal: Const { ty: &[bool; 1], val: Unevaluated(inner, [], Some(promoted[0])) }\n++         _0 = index() -> bb1;             // scope 2 at $DIR/issue_106141.rs:12:17: 12:24\n++                                          // mir::Constant\n++                                          // + span: $DIR/issue_106141.rs:12:17: 12:22\n++                                          // + literal: Const { ty: fn() -> usize {index}, val: Value(<ZST>) }\n+      }\n+  \n+      bb1: {\n++         StorageLive(_1);                 // scope 3 at $DIR/issue_106141.rs:13:8: 13:21\n++         _2 = Lt(_0, const 1_usize);      // scope 3 at $DIR/issue_106141.rs:13:8: 13:21\n++         assert(move _2, \"index out of bounds: the length is {} but the index is {}\", const 1_usize, _0) -> bb2; // scope 3 at $DIR/issue_106141.rs:13:8: 13:21\n++     }\n++ \n++     bb2: {\n++         _1 = (*_3)[_0];                  // scope 3 at $DIR/issue_106141.rs:13:8: 13:21\n++         switchInt(move _1) -> [0: bb3, otherwise: bb4]; // scope 3 at $DIR/issue_106141.rs:13:8: 13:21\n++     }\n++ \n++     bb3: {\n++         _0 = const 0_usize;              // scope 3 at $DIR/issue_106141.rs:16:9: 16:10\n++         goto -> bb4;                     // scope 3 at $DIR/issue_106141.rs:13:5: 17:6\n++     }\n++ \n++     bb4: {\n++         StorageDead(_1);                 // scope 3 at $DIR/issue_106141.rs:17:5: 17:6\n++         StorageDead(_3);                 // scope 0 at $DIR/issue_106141.rs:+1:5: +1:12\n+          return;                          // scope 0 at $DIR/issue_106141.rs:+2:2: +2:2\n+      }\n+  }\n+  "}, {"sha": "c8288b7f3419df1b9b87fb3e5760dcb2a0d0633c", "filename": "tests/mir-opt/inline/issue_106141.rs", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/af669c26846f85fd15e34a6f03d5d2f237444c17/tests%2Fmir-opt%2Finline%2Fissue_106141.rs", "raw_url": "https://github.com/rust-lang/rust/raw/af669c26846f85fd15e34a6f03d5d2f237444c17/tests%2Fmir-opt%2Finline%2Fissue_106141.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fmir-opt%2Finline%2Fissue_106141.rs?ref=af669c26846f85fd15e34a6f03d5d2f237444c17", "patch": "@@ -0,0 +1,24 @@\n+pub fn outer() -> usize {\n+    inner()\n+}\n+\n+fn index() -> usize {\n+    loop {}\n+}\n+\n+#[inline]\n+fn inner() -> usize {\n+    let buffer = &[true];\n+    let index = index();\n+    if buffer[index] {\n+        index\n+    } else {\n+        0\n+    }\n+}\n+\n+fn main() {\n+    outer();\n+}\n+\n+// EMIT_MIR issue_106141.outer.Inline.diff"}]}