{"sha": "387d6c597aeb4d067998cb59f5526cee92994efa", "node_id": "MDY6Q29tbWl0NzI0NzEyOjM4N2Q2YzU5N2FlYjRkMDY3OTk4Y2I1OWY1NTI2Y2VlOTI5OTRlZmE=", "commit": {"author": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2013-03-19T00:54:36Z"}, "committer": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2013-05-07T09:28:39Z"}, "message": "Lift restriction on calling extern C functions, and propagate\nthe ABI as part of the type of an extern fn. cc #3678", "tree": {"sha": "0f2a74724bee689f0fe08a2647f88e0f1ef1eb03", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0f2a74724bee689f0fe08a2647f88e0f1ef1eb03"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/387d6c597aeb4d067998cb59f5526cee92994efa", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/387d6c597aeb4d067998cb59f5526cee92994efa", "html_url": "https://github.com/rust-lang/rust/commit/387d6c597aeb4d067998cb59f5526cee92994efa", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/387d6c597aeb4d067998cb59f5526cee92994efa/comments", "author": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7b2020f2c3f51de0dd4dcfe4a107673eda6f25e7", "url": "https://api.github.com/repos/rust-lang/rust/commits/7b2020f2c3f51de0dd4dcfe4a107673eda6f25e7", "html_url": "https://github.com/rust-lang/rust/commit/7b2020f2c3f51de0dd4dcfe4a107673eda6f25e7"}], "stats": {"total": 48, "additions": 26, "deletions": 22}, "files": [{"sha": "68700d6218769c0aabbf9225026d6901ccb5f5d5", "filename": "src/librustc/middle/typeck/check/mod.rs", "status": "modified", "additions": 1, "deletions": 14, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/387d6c597aeb4d067998cb59f5526cee92994efa/src%2Flibrustc%2Fmiddle%2Ftypeck%2Fcheck%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/387d6c597aeb4d067998cb59f5526cee92994efa/src%2Flibrustc%2Fmiddle%2Ftypeck%2Fcheck%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftypeck%2Fcheck%2Fmod.rs?ref=387d6c597aeb4d067998cb59f5526cee92994efa", "patch": "@@ -1311,19 +1311,6 @@ pub fn check_expr_with_unifier(fcx: @mut FnCtxt,\n         // Extract the function signature from `in_fty`.\n         let fn_sty = structure_of(fcx, f.span, fn_ty);\n \n-        // FIXME(#3678) For now, do not permit calls to C abi functions.\n-        match fn_sty {\n-            ty::ty_bare_fn(ty::BareFnTy {abis, _}) => {\n-                if !abis.is_rust() {\n-                    fcx.tcx().sess.span_err(\n-                        call_expr.span,\n-                        fmt!(\"Calls to C ABI functions are not (yet) \\\n-                              supported; be patient, dear user\"));\n-                }\n-            }\n-            _ => {}\n-        }\n-\n         let fn_sig = match fn_sty {\n             ty::ty_bare_fn(ty::BareFnTy {sig: sig, _}) |\n             ty::ty_closure(ty::ClosureTy {sig: sig, _}) => sig,\n@@ -3607,7 +3594,7 @@ pub fn check_intrinsic_type(ccx: @mut CrateCtxt, it: @ast::foreign_item) {\n     };\n     let fty = ty::mk_bare_fn(tcx, ty::BareFnTy {\n         purity: ast::unsafe_fn,\n-        abis: AbiSet::Rust(),\n+        abis: AbiSet::Intrinsic(),\n         sig: FnSig {bound_lifetime_names: opt_vec::Empty,\n                     inputs: inputs,\n                     output: output}"}, {"sha": "1c3896ef5b9eed9c0f31d6725768e3dccf057375", "filename": "src/librustc/middle/typeck/collect.rs", "status": "modified", "additions": 25, "deletions": 8, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/387d6c597aeb4d067998cb59f5526cee92994efa/src%2Flibrustc%2Fmiddle%2Ftypeck%2Fcollect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/387d6c597aeb4d067998cb59f5526cee92994efa/src%2Flibrustc%2Fmiddle%2Ftypeck%2Fcollect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftypeck%2Fcollect.rs?ref=387d6c597aeb4d067998cb59f5526cee92994efa", "patch": "@@ -134,8 +134,8 @@ impl AstConv for CrateCtxt {\n               Some(&ast_map::node_item(item, _)) => {\n                 ty_of_item(self, item)\n               }\n-              Some(&ast_map::node_foreign_item(foreign_item, _, _, _)) => {\n-                ty_of_foreign_item(self, foreign_item)\n+              Some(&ast_map::node_foreign_item(foreign_item, abis, _, _)) => {\n+                ty_of_foreign_item(self, foreign_item, abis)\n               }\n               ref x => {\n                 self.tcx.sess.bug(fmt!(\"unexpected sort of item \\\n@@ -932,7 +932,20 @@ pub fn convert_foreign(ccx: &CrateCtxt, i: @ast::foreign_item) {\n     // As above, this call populates the type table with the converted\n     // type of the foreign item. We simply write it into the node type\n     // table.\n-    let tpt = ty_of_foreign_item(ccx, i);\n+\n+    // For reasons I cannot fully articulate, I do so hate the AST\n+    // map, and I regard each time that I use it as a personal and\n+    // moral failing, but at the moment it seems like the only\n+    // convenient way to extract the ABI. - ndm\n+    let abis = match ccx.tcx.items.find(&i.id) {\n+        Some(&ast_map::node_foreign_item(_, abis, _, _)) => abis,\n+        ref x => {\n+            ccx.tcx.sess.bug(fmt!(\"unexpected sort of item \\\n+                                   in get_item_ty(): %?\", (*x)));\n+        }\n+    };\n+\n+    let tpt = ty_of_foreign_item(ccx, i, abis);\n     write_ty_to_tcx(ccx.tcx, i.id, tpt.ty);\n     ccx.tcx.tcache.insert(local_def(i.id), tpt);\n }\n@@ -1103,14 +1116,17 @@ pub fn ty_of_item(ccx: &CrateCtxt, it: @ast::item)\n     }\n }\n \n-pub fn ty_of_foreign_item(ccx: &CrateCtxt, it: @ast::foreign_item)\n-    -> ty::ty_param_bounds_and_ty {\n+pub fn ty_of_foreign_item(ccx: &CrateCtxt,\n+                          it: @ast::foreign_item,\n+                          abis: AbiSet) -> ty::ty_param_bounds_and_ty\n+{\n     match it.node {\n         ast::foreign_item_fn(ref fn_decl, _, ref generics) => {\n             ty_of_foreign_fn_decl(ccx,\n                                   fn_decl,\n                                   local_def(it.id),\n-                                  generics)\n+                                  generics,\n+                                  abis)\n         }\n         ast::foreign_item_const(t) => {\n             ty::ty_param_bounds_and_ty {\n@@ -1197,7 +1213,8 @@ pub fn ty_generics(ccx: &CrateCtxt,\n pub fn ty_of_foreign_fn_decl(ccx: &CrateCtxt,\n                              decl: &ast::fn_decl,\n                              def_id: ast::def_id,\n-                             ast_generics: &ast::Generics)\n+                             ast_generics: &ast::Generics,\n+                             abis: AbiSet)\n                           -> ty::ty_param_bounds_and_ty {\n     let ty_generics = ty_generics(ccx, None, ast_generics, 0);\n     let region_param_names = RegionParamNames::from_generics(ast_generics);\n@@ -1208,7 +1225,7 @@ pub fn ty_of_foreign_fn_decl(ccx: &CrateCtxt,\n     let t_fn = ty::mk_bare_fn(\n         ccx.tcx,\n         ty::BareFnTy {\n-            abis: AbiSet::Rust(),\n+            abis: abis,\n             purity: ast::unsafe_fn,\n             sig: ty::FnSig {bound_lifetime_names: opt_vec::Empty,\n                             inputs: input_tys,"}]}