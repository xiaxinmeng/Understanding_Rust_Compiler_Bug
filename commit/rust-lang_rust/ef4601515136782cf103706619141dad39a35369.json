{"sha": "ef4601515136782cf103706619141dad39a35369", "node_id": "MDY6Q29tbWl0NzI0NzEyOmVmNDYwMTUxNTEzNjc4MmNmMTAzNzA2NjE5MTQxZGFkMzlhMzUzNjk=", "commit": {"author": {"name": "Martin Carton", "email": "cartonmartin+github@gmail.com", "date": "2016-05-27T10:26:00Z"}, "committer": {"name": "Martin Carton", "email": "cartonmartin+github@gmail.com", "date": "2016-05-27T10:26:00Z"}, "message": "Merge pull request #957 from oli-obk/needs_borrow\n\nneedless_borrow reported on &&T when only &T implements Trait and &Trait is required", "tree": {"sha": "d5c97e93948a09900dbb392b091cb0a2d8a875f5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d5c97e93948a09900dbb392b091cb0a2d8a875f5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ef4601515136782cf103706619141dad39a35369", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ef4601515136782cf103706619141dad39a35369", "html_url": "https://github.com/rust-lang/rust/commit/ef4601515136782cf103706619141dad39a35369", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ef4601515136782cf103706619141dad39a35369/comments", "author": {"login": "mcarton", "id": 3751788, "node_id": "MDQ6VXNlcjM3NTE3ODg=", "avatar_url": "https://avatars.githubusercontent.com/u/3751788?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mcarton", "html_url": "https://github.com/mcarton", "followers_url": "https://api.github.com/users/mcarton/followers", "following_url": "https://api.github.com/users/mcarton/following{/other_user}", "gists_url": "https://api.github.com/users/mcarton/gists{/gist_id}", "starred_url": "https://api.github.com/users/mcarton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mcarton/subscriptions", "organizations_url": "https://api.github.com/users/mcarton/orgs", "repos_url": "https://api.github.com/users/mcarton/repos", "events_url": "https://api.github.com/users/mcarton/events{/privacy}", "received_events_url": "https://api.github.com/users/mcarton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "mcarton", "id": 3751788, "node_id": "MDQ6VXNlcjM3NTE3ODg=", "avatar_url": "https://avatars.githubusercontent.com/u/3751788?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mcarton", "html_url": "https://github.com/mcarton", "followers_url": "https://api.github.com/users/mcarton/followers", "following_url": "https://api.github.com/users/mcarton/following{/other_user}", "gists_url": "https://api.github.com/users/mcarton/gists{/gist_id}", "starred_url": "https://api.github.com/users/mcarton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mcarton/subscriptions", "organizations_url": "https://api.github.com/users/mcarton/orgs", "repos_url": "https://api.github.com/users/mcarton/repos", "events_url": "https://api.github.com/users/mcarton/events{/privacy}", "received_events_url": "https://api.github.com/users/mcarton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8ac545d0fe224791875ed939db787cb311fac406", "url": "https://api.github.com/repos/rust-lang/rust/commits/8ac545d0fe224791875ed939db787cb311fac406", "html_url": "https://github.com/rust-lang/rust/commit/8ac545d0fe224791875ed939db787cb311fac406"}, {"sha": "5eca09793e9e6969ce960601d83300e1d6065d97", "url": "https://api.github.com/repos/rust-lang/rust/commits/5eca09793e9e6969ce960601d83300e1d6065d97", "html_url": "https://github.com/rust-lang/rust/commit/5eca09793e9e6969ce960601d83300e1d6065d97"}], "stats": {"total": 24, "additions": 16, "deletions": 8}, "files": [{"sha": "033811841ce6f8b5401636bdfe58cb7537c7369e", "filename": "src/needless_borrow.rs", "status": "modified", "additions": 9, "deletions": 8, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/ef4601515136782cf103706619141dad39a35369/src%2Fneedless_borrow.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ef4601515136782cf103706619141dad39a35369/src%2Fneedless_borrow.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fneedless_borrow.rs?ref=ef4601515136782cf103706619141dad39a35369", "patch": "@@ -3,9 +3,10 @@\n //! This lint is **warn** by default\n \n use rustc::lint::*;\n-use rustc::hir::*;\n+use rustc::hir::{ExprAddrOf, Expr, MutImmutable};\n use rustc::ty::TyRef;\n use utils::{span_lint, in_macro};\n+use rustc::ty::adjustment::AutoAdjustment::AdjustDerefRef;\n \n /// **What it does:** This lint checks for address of operations (`&`) that are going to be dereferenced immediately by the compiler\n ///\n@@ -36,13 +37,13 @@ impl LateLintPass for NeedlessBorrow {\n         }\n         if let ExprAddrOf(MutImmutable, ref inner) = e.node {\n             if let TyRef(..) = cx.tcx.expr_ty(inner).sty {\n-                let ty = cx.tcx.expr_ty(e);\n-                let adj_ty = cx.tcx.expr_ty_adjusted(e);\n-                if ty != adj_ty {\n-                    span_lint(cx,\n-                              NEEDLESS_BORROW,\n-                              e.span,\n-                              \"this expression borrows a reference that is immediately dereferenced by the compiler\");\n+                if let Some(&AdjustDerefRef(ref deref)) = cx.tcx.tables.borrow().adjustments.get(&e.id) {\n+                    if deref.autoderefs > 1 && deref.autoref.is_some() {\n+                        span_lint(cx,\n+                                  NEEDLESS_BORROW,\n+                                  e.span,\n+                                  \"this expression borrows a reference that is immediately dereferenced by the compiler\");\n+                    }\n                 }\n             }\n         }"}, {"sha": "602e1e0859b8f83b26d0e07027cece6507853e41", "filename": "tests/compile-fail/needless_borrow.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/ef4601515136782cf103706619141dad39a35369/tests%2Fcompile-fail%2Fneedless_borrow.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ef4601515136782cf103706619141dad39a35369/tests%2Fcompile-fail%2Fneedless_borrow.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-fail%2Fneedless_borrow.rs?ref=ef4601515136782cf103706619141dad39a35369", "patch": "@@ -16,6 +16,7 @@ fn main() {\n     let g_val = g(&Vec::new()); // should not error, because `&Vec<T>` derefs to `&[T]`\n     let vec = Vec::new();\n     let vec_val = g(&vec); // should not error, because `&Vec<T>` derefs to `&[T]`\n+    h(&\"foo\"); // should not error, because the `&&str` is required, due to `&Trait`\n }\n \n fn f<T:Copy>(y: &T) -> T {\n@@ -25,3 +26,9 @@ fn f<T:Copy>(y: &T) -> T {\n fn g(y: &[u8]) -> u8 {\n     y[0]\n }\n+\n+trait Trait {}\n+\n+impl<'a> Trait for &'a str {}\n+\n+fn h(_: &Trait) {}"}]}