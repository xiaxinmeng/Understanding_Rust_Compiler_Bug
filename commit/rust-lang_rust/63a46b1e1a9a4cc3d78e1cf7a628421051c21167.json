{"sha": "63a46b1e1a9a4cc3d78e1cf7a628421051c21167", "node_id": "MDY6Q29tbWl0NzI0NzEyOjYzYTQ2YjFlMWE5YTRjYzNkNzhlMWNmN2E2Mjg0MjEwNTFjMjExNjc=", "commit": {"author": {"name": "Oliver S\u0336c\u0336h\u0336n\u0336e\u0336i\u0336d\u0336e\u0336r Scherer", "email": "github35764891676564198441@oli-obk.de", "date": "2018-09-07T07:54:43Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2018-09-07T07:54:43Z"}, "message": "Merge pull request #3129 from mipli/3091-numeric-typo\n\nAdd lint for misstyped literal casting", "tree": {"sha": "bc2f97ed0ff053942642e35d733e5f6608bc8c08", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bc2f97ed0ff053942642e35d733e5f6608bc8c08"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/63a46b1e1a9a4cc3d78e1cf7a628421051c21167", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJbki7DCRBK7hj4Ov3rIwAAdHIIAAUa/93LN91s8ydLCgZHz8dp\nxUelyPYrsMT2oJllb5VISXeSMYpzLH1vkw7Ux3g+xT4GCHL92dNlfI5l0Q+uarIm\ntQhhiX2C/Ib1KoTnj3tPDEVHh/PqKOF/nkLMLjJoARGnoo7q4S8IvlyC3XQJnON5\nPJYSALvBrA3qdgcgZFMAxwMVrOOhuYtY7fHHuRwfTn0yqxnwnBkElqsx0uaq270x\niVR6rrO5HakjDXwuF2XempHV3a4X3OPAxH0XbJgltYPcHDLEOFjIvgFJQdCHtuwe\nwfLwEzhRILwlo+SGjwVSZX/yxBQoRqULy2mrpuaIzp4CAZwhXzBoBVEQKpWu8V4=\n=NNjH\n-----END PGP SIGNATURE-----\n", "payload": "tree bc2f97ed0ff053942642e35d733e5f6608bc8c08\nparent cafef7b576203f166add9ed143979d9775c25219\nparent 7bf8d8ba094d2376f468b1f1e3c98c90ee307ac5\nauthor Oliver S\u0336c\u0336h\u0336n\u0336e\u0336i\u0336d\u0336e\u0336r Scherer <github35764891676564198441@oli-obk.de> 1536306883 +0200\ncommitter GitHub <noreply@github.com> 1536306883 +0200\n\nMerge pull request #3129 from mipli/3091-numeric-typo\n\nAdd lint for misstyped literal casting"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/63a46b1e1a9a4cc3d78e1cf7a628421051c21167", "html_url": "https://github.com/rust-lang/rust/commit/63a46b1e1a9a4cc3d78e1cf7a628421051c21167", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/63a46b1e1a9a4cc3d78e1cf7a628421051c21167/comments", "author": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cafef7b576203f166add9ed143979d9775c25219", "url": "https://api.github.com/repos/rust-lang/rust/commits/cafef7b576203f166add9ed143979d9775c25219", "html_url": "https://github.com/rust-lang/rust/commit/cafef7b576203f166add9ed143979d9775c25219"}, {"sha": "7bf8d8ba094d2376f468b1f1e3c98c90ee307ac5", "url": "https://api.github.com/repos/rust-lang/rust/commits/7bf8d8ba094d2376f468b1f1e3c98c90ee307ac5", "html_url": "https://github.com/rust-lang/rust/commit/7bf8d8ba094d2376f468b1f1e3c98c90ee307ac5"}], "stats": {"total": 168, "additions": 150, "deletions": 18}, "files": [{"sha": "a2a83118ee8167e5fc60862e073becd3340d298b", "filename": "CHANGELOG.md", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/63a46b1e1a9a4cc3d78e1cf7a628421051c21167/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/63a46b1e1a9a4cc3d78e1cf7a628421051c21167/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=63a46b1e1a9a4cc3d78e1cf7a628421051c21167", "patch": "@@ -645,6 +645,7 @@ All notable changes to this project will be documented in this file.\n [`cmp_owned`]: https://rust-lang-nursery.github.io/rust-clippy/master/index.html#cmp_owned\n [`collapsible_if`]: https://rust-lang-nursery.github.io/rust-clippy/master/index.html#collapsible_if\n [`const_static_lifetime`]: https://rust-lang-nursery.github.io/rust-clippy/master/index.html#const_static_lifetime\n+[`copy_iterator`]: https://rust-lang-nursery.github.io/rust-clippy/master/index.html#copy_iterator\n [`crosspointer_transmute`]: https://rust-lang-nursery.github.io/rust-clippy/master/index.html#crosspointer_transmute\n [`cyclomatic_complexity`]: https://rust-lang-nursery.github.io/rust-clippy/master/index.html#cyclomatic_complexity\n [`decimal_literal_representation`]: https://rust-lang-nursery.github.io/rust-clippy/master/index.html#decimal_literal_representation\n@@ -748,6 +749,7 @@ All notable changes to this project will be documented in this file.\n [`misrefactored_assign_op`]: https://rust-lang-nursery.github.io/rust-clippy/master/index.html#misrefactored_assign_op\n [`missing_docs_in_private_items`]: https://rust-lang-nursery.github.io/rust-clippy/master/index.html#missing_docs_in_private_items\n [`missing_inline_in_public_items`]: https://rust-lang-nursery.github.io/rust-clippy/master/index.html#missing_inline_in_public_items\n+[`mistyped_literal_suffixes`]: https://rust-lang-nursery.github.io/rust-clippy/master/index.html#mistyped_literal_suffixes\n [`mixed_case_hex_literals`]: https://rust-lang-nursery.github.io/rust-clippy/master/index.html#mixed_case_hex_literals\n [`module_inception`]: https://rust-lang-nursery.github.io/rust-clippy/master/index.html#module_inception\n [`modulo_one`]: https://rust-lang-nursery.github.io/rust-clippy/master/index.html#modulo_one\n@@ -800,6 +802,7 @@ All notable changes to this project will be documented in this file.\n [`print_with_newline`]: https://rust-lang-nursery.github.io/rust-clippy/master/index.html#print_with_newline\n [`println_empty_string`]: https://rust-lang-nursery.github.io/rust-clippy/master/index.html#println_empty_string\n [`ptr_arg`]: https://rust-lang-nursery.github.io/rust-clippy/master/index.html#ptr_arg\n+[`ptr_offset_with_cast`]: https://rust-lang-nursery.github.io/rust-clippy/master/index.html#ptr_offset_with_cast\n [`pub_enum_variant_names`]: https://rust-lang-nursery.github.io/rust-clippy/master/index.html#pub_enum_variant_names\n [`question_mark`]: https://rust-lang-nursery.github.io/rust-clippy/master/index.html#question_mark\n [`range_minus_one`]: https://rust-lang-nursery.github.io/rust-clippy/master/index.html#range_minus_one"}, {"sha": "b2ccbf495aec157008757ab0857a6a7c2db9edd0", "filename": "README.md", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/63a46b1e1a9a4cc3d78e1cf7a628421051c21167/README.md", "raw_url": "https://github.com/rust-lang/rust/raw/63a46b1e1a9a4cc3d78e1cf7a628421051c21167/README.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/README.md?ref=63a46b1e1a9a4cc3d78e1cf7a628421051c21167", "patch": "@@ -9,7 +9,7 @@ We are currently in the process of discussing Clippy 1.0 via the RFC process in\n \n A collection of lints to catch common mistakes and improve your [Rust](https://github.com/rust-lang/rust) code.\n \n-[There are 273 lints included in this crate!](https://rust-lang-nursery.github.io/rust-clippy/master/index.html)\n+[There are 275 lints included in this crate!](https://rust-lang-nursery.github.io/rust-clippy/master/index.html)\n \n We have a bunch of lint categories to allow you to choose how much Clippy is supposed to ~~annoy~~ help you:\n "}, {"sha": "d082bd9097163bde39382ec3a28e13e25d74023a", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/63a46b1e1a9a4cc3d78e1cf7a628421051c21167/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/63a46b1e1a9a4cc3d78e1cf7a628421051c21167/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=63a46b1e1a9a4cc3d78e1cf7a628421051c21167", "patch": "@@ -545,6 +545,7 @@ pub fn register_plugins(reg: &mut rustc_plugin::Registry<'_>, conf: &Conf) {\n         lifetimes::NEEDLESS_LIFETIMES,\n         literal_representation::INCONSISTENT_DIGIT_GROUPING,\n         literal_representation::LARGE_DIGIT_GROUPS,\n+        literal_representation::MISTYPED_LITERAL_SUFFIXES,\n         literal_representation::UNREADABLE_LITERAL,\n         loops::EMPTY_LOOP,\n         loops::EXPLICIT_COUNTER_LOOP,\n@@ -868,6 +869,7 @@ pub fn register_plugins(reg: &mut rustc_plugin::Registry<'_>, conf: &Conf) {\n         infinite_iter::INFINITE_ITER,\n         inline_fn_without_body::INLINE_FN_WITHOUT_BODY,\n         invalid_ref::INVALID_REF,\n+        literal_representation::MISTYPED_LITERAL_SUFFIXES,\n         loops::FOR_LOOP_OVER_OPTION,\n         loops::FOR_LOOP_OVER_RESULT,\n         loops::ITER_NEXT_LOOP,"}, {"sha": "304721886cc2a9ab14389f3ffcc77ad7421c35c9", "filename": "clippy_lints/src/literal_representation.rs", "status": "modified", "additions": 74, "deletions": 16, "changes": 90, "blob_url": "https://github.com/rust-lang/rust/blob/63a46b1e1a9a4cc3d78e1cf7a628421051c21167/clippy_lints%2Fsrc%2Fliteral_representation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/63a46b1e1a9a4cc3d78e1cf7a628421051c21167/clippy_lints%2Fsrc%2Fliteral_representation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fliteral_representation.rs?ref=63a46b1e1a9a4cc3d78e1cf7a628421051c21167", "patch": "@@ -26,6 +26,26 @@ declare_clippy_lint! {\n     \"long integer literal without underscores\"\n }\n \n+/// **What it does:** Warns for mistyped suffix in literals\n+///\n+/// **Why is this bad?** This is most probably a typo\n+///\n+/// **Known problems:**\n+///\t\t- Recommends a signed suffix, even though the number might be too big and an unsigned\n+///\t\tsuffix is required\n+///\t\t- Does not match on `_128` since that is a valid grouping for decimal and octal numbers\n+///\n+/// **Example:**\n+///\n+/// ```rust\n+/// 2_32\n+/// ```\n+declare_clippy_lint! {\n+    pub MISTYPED_LITERAL_SUFFIXES,\n+    correctness,\n+    \"mistyped literal suffix\"\n+}\n+\n /// **What it does:** Warns if an integral or floating-point constant is\n /// grouped inconsistently with underscores.\n ///\n@@ -135,18 +155,24 @@ impl<'a> DigitInfo<'a> {\n             (Some(p), s)\n         };\n \n+        let len = sans_prefix.len();\n         let mut last_d = '\\0';\n         for (d_idx, d) in sans_prefix.char_indices() {\n-            if !float && (d == 'i' || d == 'u') || float && (d == 'f' || d == 'e' || d == 'E') {\n-                let suffix_start = if last_d == '_' { d_idx - 1 } else { d_idx };\n-                let (digits, suffix) = sans_prefix.split_at(suffix_start);\n-                return Self {\n-                    digits,\n-                    radix,\n-                    prefix,\n-                    suffix: Some(suffix),\n-                    float,\n-                };\n+            let suffix_start = if last_d == '_' {\n+                d_idx - 1\n+            } else {\n+                d_idx\n+            };\n+            if float && (d == 'f' || d == 'e' || d == 'E') ||\n+                !float && (d == 'i' || d == 'u' || is_possible_suffix_index(&sans_prefix, suffix_start, len)) {\n+                    let (digits, suffix) = sans_prefix.split_at(suffix_start);\n+                    return Self {\n+                        digits,\n+                        radix,\n+                        prefix,\n+                        suffix: Some(suffix),\n+                        float,\n+                    };\n             }\n             last_d = d\n         }\n@@ -161,7 +187,7 @@ impl<'a> DigitInfo<'a> {\n         }\n     }\n \n-    /// Returns digits grouped in a sensible way.\n+    /// Returns literal formatted in a sensible way.\n     crate fn grouping_hint(&self) -> String {\n         let group_size = self.radix.suggest_grouping();\n         if self.digits.contains('.') {\n@@ -211,11 +237,18 @@ impl<'a> DigitInfo<'a> {\n             if self.radix == Radix::Hexadecimal && nb_digits_to_fill != 0 {\n                 hint = format!(\"{:0>4}{}\", &hint[..nb_digits_to_fill], &hint[nb_digits_to_fill..]);\n             }\n+            let suffix_hint = match self.suffix {\n+                Some(suffix) if is_mistyped_suffix(suffix) => {\n+                    format!(\"_i{}\", &suffix[1..])\n+                },\n+                Some(suffix) => suffix.to_string(),\n+                None => String::new()\n+            };\n             format!(\n                 \"{}{}{}\",\n                 self.prefix.unwrap_or(\"\"),\n                 hint,\n-                self.suffix.unwrap_or(\"\")\n+                suffix_hint\n             )\n         }\n     }\n@@ -226,11 +259,22 @@ enum WarningType {\n     InconsistentDigitGrouping,\n     LargeDigitGroups,\n     DecimalRepresentation,\n+    MistypedLiteralSuffix\n }\n \n impl WarningType {\n     crate fn display(&self, grouping_hint: &str, cx: &EarlyContext<'_>, span: syntax_pos::Span) {\n         match self {\n+            WarningType::MistypedLiteralSuffix => {\n+                span_lint_and_sugg(\n+                    cx,\n+                    MISTYPED_LITERAL_SUFFIXES,\n+                    span,\n+                    \"mistyped literal suffix\",\n+                    \"did you mean to write\",\n+                    grouping_hint.to_string()\n+                )\n+            },\n             WarningType::UnreadableLiteral => span_lint_and_sugg(\n                 cx,\n                 UNREADABLE_LITERAL,\n@@ -303,7 +347,7 @@ impl LiteralDigitGrouping {\n                     if char::to_digit(firstch, 10).is_some();\n                     then {\n                         let digit_info = DigitInfo::new(&src, false);\n-                        let _ = Self::do_lint(digit_info.digits).map_err(|warning_type| {\n+                        let _ = Self::do_lint(digit_info.digits, digit_info.suffix).map_err(|warning_type| {\n                             warning_type.display(&digit_info.grouping_hint(), cx, lit.span)\n                         });\n                     }\n@@ -325,12 +369,12 @@ impl LiteralDigitGrouping {\n \n                         // Lint integral and fractional parts separately, and then check consistency of digit\n                         // groups if both pass.\n-                        let _ = Self::do_lint(parts[0])\n+                        let _ = Self::do_lint(parts[0], None)\n                             .map(|integral_group_size| {\n                                 if parts.len() > 1 {\n                                     // Lint the fractional part of literal just like integral part, but reversed.\n                                     let fractional_part = &parts[1].chars().rev().collect::<String>();\n-                                    let _ = Self::do_lint(fractional_part)\n+                                    let _ = Self::do_lint(fractional_part, None)\n                                         .map(|fractional_group_size| {\n                                             let consistent = Self::parts_consistent(integral_group_size,\n                                                                                     fractional_group_size,\n@@ -373,7 +417,12 @@ impl LiteralDigitGrouping {\n \n     /// Performs lint on `digits` (no decimal point) and returns the group\n     /// size on success or `WarningType` when emitting a warning.\n-    fn do_lint(digits: &str) -> Result<usize, WarningType> {\n+    fn do_lint(digits: &str, suffix: Option<&str>) -> Result<usize, WarningType> {\n+        if let Some(suffix) = suffix {\n+            if is_mistyped_suffix(suffix) {\n+                return Err(WarningType::MistypedLiteralSuffix);\n+            }\n+        }\n         // Grab underscore indices with respect to the units digit.\n         let underscore_positions: Vec<usize> = digits\n             .chars()\n@@ -504,3 +553,12 @@ impl LiteralRepresentation {\n         Ok(())\n     }\n }\n+\n+fn is_mistyped_suffix(suffix: &str) -> bool {\n+    [\"_8\", \"_16\", \"_32\", \"_64\"].contains(&suffix)\n+}\n+\n+fn is_possible_suffix_index(lit: &str, idx: usize, len: usize) -> bool {\n+    ((len > 3 && idx == len - 3) || (len > 2 && idx == len - 2)) &&\n+        is_mistyped_suffix(lit.split_at(idx).1)\n+}"}, {"sha": "7a9efaeec84596bac3315a94a33b5be21e2667dd", "filename": "tests/ui/literals.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/63a46b1e1a9a4cc3d78e1cf7a628421051c21167/tests%2Fui%2Fliterals.rs", "raw_url": "https://github.com/rust-lang/rust/raw/63a46b1e1a9a4cc3d78e1cf7a628421051c21167/tests%2Fui%2Fliterals.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fliterals.rs?ref=63a46b1e1a9a4cc3d78e1cf7a628421051c21167", "patch": "@@ -43,4 +43,15 @@ fn main() {\n     let fail11 = 0xabcdeff;\n     let fail12 = 0xabcabcabcabcabcabc;\n     let fail13 = 0x1_23456_78901_usize;\n+\n+    let fail14 = 2_32;\n+    let fail15 = 4_64;\n+    let fail16 = 7_8;\n+    let fail17 = 23_16;\n+    let ok18 = 23_128;\n+    let fail19 = 12_3456_21;\n+    let fail20 = 2__8;\n+    let fail21 = 4___16;\n+    let fail22 = 3__4___23;\n+    let fail23 = 3__16___23;\n }"}, {"sha": "bd2d1f818310c276311c672401ad56eb7ed6c6b9", "filename": "tests/ui/literals.stderr", "status": "modified", "additions": 59, "deletions": 1, "changes": 60, "blob_url": "https://github.com/rust-lang/rust/blob/63a46b1e1a9a4cc3d78e1cf7a628421051c21167/tests%2Fui%2Fliterals.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/63a46b1e1a9a4cc3d78e1cf7a628421051c21167/tests%2Fui%2Fliterals.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fliterals.stderr?ref=63a46b1e1a9a4cc3d78e1cf7a628421051c21167", "patch": "@@ -120,5 +120,63 @@ error: digit groups should be smaller\n    |\n    = note: `-D clippy::large-digit-groups` implied by `-D warnings`\n \n-error: aborting due to 16 previous errors\n+error: mistyped literal suffix\n+  --> $DIR/literals.rs:47:18\n+   |\n+47 |     let fail14 = 2_32;\n+   |                  ^^^^ help: did you mean to write: `2_i32`\n+   |\n+   = note: #[deny(clippy::mistyped_literal_suffixes)] on by default\n+\n+error: mistyped literal suffix\n+  --> $DIR/literals.rs:48:18\n+   |\n+48 |     let fail15 = 4_64;\n+   |                  ^^^^ help: did you mean to write: `4_i64`\n+\n+error: mistyped literal suffix\n+  --> $DIR/literals.rs:49:18\n+   |\n+49 |     let fail16 = 7_8;\n+   |                  ^^^ help: did you mean to write: `7_i8`\n+\n+error: mistyped literal suffix\n+  --> $DIR/literals.rs:50:18\n+   |\n+50 |     let fail17 = 23_16;\n+   |                  ^^^^^ help: did you mean to write: `23_i16`\n+\n+error: digits grouped inconsistently by underscores\n+  --> $DIR/literals.rs:52:18\n+   |\n+52 |     let fail19 = 12_3456_21;\n+   |                  ^^^^^^^^^^ help: consider: `12_345_621`\n+   |\n+   = note: `-D clippy::inconsistent-digit-grouping` implied by `-D warnings`\n+\n+error: mistyped literal suffix\n+  --> $DIR/literals.rs:53:18\n+   |\n+53 |     let fail20 = 2__8;\n+   |                  ^^^^ help: did you mean to write: `2_i8`\n+\n+error: mistyped literal suffix\n+  --> $DIR/literals.rs:54:18\n+   |\n+54 |     let fail21 = 4___16;\n+   |                  ^^^^^^ help: did you mean to write: `4_i16`\n+\n+error: digits grouped inconsistently by underscores\n+  --> $DIR/literals.rs:55:18\n+   |\n+55 |     let fail22 = 3__4___23;\n+   |                  ^^^^^^^^^ help: consider: `3_423`\n+\n+error: digits grouped inconsistently by underscores\n+  --> $DIR/literals.rs:56:18\n+   |\n+56 |     let fail23 = 3__16___23;\n+   |                  ^^^^^^^^^^ help: consider: `31_623`\n+\n+error: aborting due to 25 previous errors\n "}]}