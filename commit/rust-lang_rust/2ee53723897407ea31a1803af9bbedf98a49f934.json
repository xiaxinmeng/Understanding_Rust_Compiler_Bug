{"sha": "2ee53723897407ea31a1803af9bbedf98a49f934", "node_id": "C_kwDOAAsO6NoAKDJlZTUzNzIzODk3NDA3ZWEzMWExODAzYWY5YmJlZGY5OGE0OWY5MzQ", "commit": {"author": {"name": "xFrednet", "email": "xFrednet@gmail.com", "date": "2022-03-14T21:39:36Z"}, "committer": {"name": "xFrednet", "email": "xFrednet@gmail.com", "date": "2022-03-14T21:45:00Z"}, "message": "Allow `single_component_path_imports` for all macros", "tree": {"sha": "7b4937552514033238e107a437829d4b901ee16b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7b4937552514033238e107a437829d4b901ee16b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2ee53723897407ea31a1803af9bbedf98a49f934", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEsfZNmu/fmIv8KDcv/Ny/Ka9k1gEFAmIvt1wACgkQ/Ny/Ka9k\n1gEfYA//QfzCMK8ZJywvSU20w8JHniHPX+1n6reYa69syrAlank5SXn2bvtIM83q\nnqKb/TSdu8pB7+3gVZvi1wpeCfY2GdlEaI0Pp2o+zgFL4KdDyN4xrFgm5fjVCVW3\nKBihjy2nUvDLEqjQxAnJdJK0Ouu03flGzY8/pp6u6T+3GngKZvRfJFdAo5E61oJv\n6RvQUMj1T0xoFGu2nJC/0mEEC75tHXRNVDvIqGmw86AWViuyOuRim2UGdB+oDTMZ\nfCl7rGL4GNnM5SDuu4E4bN+rkt6ADxhEM07KYeNO70ytLiHw8O6/7N0KJ1Mw2Ct7\nk/kLffAgtrUjIiRwZuXNUVvM7Y/nuK1ZRDXyRL5a8yyMWC24c2vCZWFj6U00Mob6\n/JSe7l4ml7+3Mts1dkkx+lOsUFCbLnj7awfJWlIJVy5PazB+H1lHDQh6+Y5Fogi4\n5qVZPAggV4Dtrh5X9ndTwRUk9Hg+xAg2qB12l2ToICivxql3EppZU+e4WbJ/66dm\nLuRo1LJftkNmJ0Q/ldQMQogJPKn81QkLifWDEKNC/Q/Ym5XnsZNwv/eZZTdYb0LU\nWt3nQhHoR8UhTiv45M/PxIc0x+SaRhhRIyfjMEaq9o5FgKOUG4QhFSEl4cdw8Y4o\nHQ4EeDssj28OkyG4OsVYcF93AuZq9ekWwXKYmCvbVB1a1b6yTvM=\n=i7le\n-----END PGP SIGNATURE-----", "payload": "tree 7b4937552514033238e107a437829d4b901ee16b\nparent dc5423ad448877e33cca28db2f1445c9c4473c75\nauthor xFrednet <xFrednet@gmail.com> 1647293976 +0100\ncommitter xFrednet <xFrednet@gmail.com> 1647294300 +0100\n\nAllow `single_component_path_imports` for all macros\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2ee53723897407ea31a1803af9bbedf98a49f934", "html_url": "https://github.com/rust-lang/rust/commit/2ee53723897407ea31a1803af9bbedf98a49f934", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2ee53723897407ea31a1803af9bbedf98a49f934/comments", "author": {"login": "xFrednet", "id": 17087237, "node_id": "MDQ6VXNlcjE3MDg3MjM3", "avatar_url": "https://avatars.githubusercontent.com/u/17087237?v=4", "gravatar_id": "", "url": "https://api.github.com/users/xFrednet", "html_url": "https://github.com/xFrednet", "followers_url": "https://api.github.com/users/xFrednet/followers", "following_url": "https://api.github.com/users/xFrednet/following{/other_user}", "gists_url": "https://api.github.com/users/xFrednet/gists{/gist_id}", "starred_url": "https://api.github.com/users/xFrednet/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/xFrednet/subscriptions", "organizations_url": "https://api.github.com/users/xFrednet/orgs", "repos_url": "https://api.github.com/users/xFrednet/repos", "events_url": "https://api.github.com/users/xFrednet/events{/privacy}", "received_events_url": "https://api.github.com/users/xFrednet/received_events", "type": "User", "site_admin": false}, "committer": {"login": "xFrednet", "id": 17087237, "node_id": "MDQ6VXNlcjE3MDg3MjM3", "avatar_url": "https://avatars.githubusercontent.com/u/17087237?v=4", "gravatar_id": "", "url": "https://api.github.com/users/xFrednet", "html_url": "https://github.com/xFrednet", "followers_url": "https://api.github.com/users/xFrednet/followers", "following_url": "https://api.github.com/users/xFrednet/following{/other_user}", "gists_url": "https://api.github.com/users/xFrednet/gists{/gist_id}", "starred_url": "https://api.github.com/users/xFrednet/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/xFrednet/subscriptions", "organizations_url": "https://api.github.com/users/xFrednet/orgs", "repos_url": "https://api.github.com/users/xFrednet/repos", "events_url": "https://api.github.com/users/xFrednet/events{/privacy}", "received_events_url": "https://api.github.com/users/xFrednet/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "dc5423ad448877e33cca28db2f1445c9c4473c75", "url": "https://api.github.com/repos/rust-lang/rust/commits/dc5423ad448877e33cca28db2f1445c9c4473c75", "html_url": "https://github.com/rust-lang/rust/commit/dc5423ad448877e33cca28db2f1445c9c4473c75"}], "stats": {"total": 52, "additions": 9, "deletions": 43}, "files": [{"sha": "66b79513032f6e8871e52ed543dafc9eb8585b5e", "filename": "clippy_lints/src/single_component_path_imports.rs", "status": "modified", "additions": 7, "deletions": 11, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/2ee53723897407ea31a1803af9bbedf98a49f934/clippy_lints%2Fsrc%2Fsingle_component_path_imports.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2ee53723897407ea31a1803af9bbedf98a49f934/clippy_lints%2Fsrc%2Fsingle_component_path_imports.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fsingle_component_path_imports.rs?ref=2ee53723897407ea31a1803af9bbedf98a49f934", "patch": "@@ -1,5 +1,5 @@\n use clippy_utils::diagnostics::{span_lint_and_help, span_lint_and_sugg};\n-use rustc_ast::{ptr::P, Crate, Item, ItemKind, MacroDef, ModKind, UseTreeKind, VisibilityKind};\n+use rustc_ast::{ptr::P, Crate, Item, ItemKind, MacroDef, ModKind, UseTreeKind};\n use rustc_errors::Applicability;\n use rustc_lint::{EarlyContext, EarlyLintPass, LintContext};\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n@@ -76,14 +76,13 @@ fn check_mod(cx: &EarlyContext<'_>, items: &[P<Item>]) {\n         );\n     }\n \n-    for single_use in &single_use_usages {\n-        if !imports_reused_with_self.contains(&single_use.0) {\n-            let can_suggest = single_use.2;\n+    for (name, span, can_suggest) in single_use_usages {\n+        if !imports_reused_with_self.contains(&name) {\n             if can_suggest {\n                 span_lint_and_sugg(\n                     cx,\n                     SINGLE_COMPONENT_PATH_IMPORTS,\n-                    single_use.1,\n+                    span,\n                     \"this import is redundant\",\n                     \"remove it entirely\",\n                     String::new(),\n@@ -93,7 +92,7 @@ fn check_mod(cx: &EarlyContext<'_>, items: &[P<Item>]) {\n                 span_lint_and_help(\n                     cx,\n                     SINGLE_COMPONENT_PATH_IMPORTS,\n-                    single_use.1,\n+                    span,\n                     \"this import is redundant\",\n                     None,\n                     \"remove this import\",\n@@ -124,14 +123,11 @@ fn track_uses(\n         ItemKind::Use(use_tree) => {\n             let segments = &use_tree.prefix.segments;\n \n-            let should_report =\n-                |name: &Symbol| !macros.contains(name) || matches!(item.vis.kind, VisibilityKind::Inherited);\n-\n             // keep track of `use some_module;` usages\n             if segments.len() == 1 {\n                 if let UseTreeKind::Simple(None, _, _) = use_tree.kind {\n                     let name = segments[0].ident.name;\n-                    if should_report(&name) {\n+                    if !macros.contains(&name) {\n                         single_use_usages.push((name, item.span, true));\n                     }\n                 }\n@@ -146,7 +142,7 @@ fn track_uses(\n                         if segments.len() == 1 {\n                             if let UseTreeKind::Simple(None, _, _) = tree.0.kind {\n                                 let name = segments[0].ident.name;\n-                                if should_report(&name) {\n+                                if !macros.contains(&name) {\n                                     single_use_usages.push((name, tree.0.span, false));\n                                 }\n                             }"}, {"sha": "e43f5d381aaa1087a928a49d86529693a74fdba9", "filename": "tests/ui/single_component_path_imports_macro.fixed", "status": "removed", "additions": 0, "deletions": 20, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/dc5423ad448877e33cca28db2f1445c9c4473c75/tests%2Fui%2Fsingle_component_path_imports_macro.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/dc5423ad448877e33cca28db2f1445c9c4473c75/tests%2Fui%2Fsingle_component_path_imports_macro.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fsingle_component_path_imports_macro.fixed?ref=dc5423ad448877e33cca28db2f1445c9c4473c75", "patch": "@@ -1,20 +0,0 @@\n-// run-rustfix\n-#![warn(clippy::single_component_path_imports)]\n-#![allow(unused_imports)]\n-\n-// #7106: use statements exporting a macro within a crate should not trigger lint\n-\n-macro_rules! m1 {\n-    () => {};\n-}\n-pub(crate) use m1; // ok\n-\n-macro_rules! m2 {\n-    () => {};\n-}\n- // fail\n-\n-fn main() {\n-    m1!();\n-    m2!();\n-}"}, {"sha": "fda294a61546b5c6fa2befd83ef8281b92bba9ea", "filename": "tests/ui/single_component_path_imports_macro.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/2ee53723897407ea31a1803af9bbedf98a49f934/tests%2Fui%2Fsingle_component_path_imports_macro.rs", "raw_url": "https://github.com/rust-lang/rust/raw/2ee53723897407ea31a1803af9bbedf98a49f934/tests%2Fui%2Fsingle_component_path_imports_macro.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fsingle_component_path_imports_macro.rs?ref=2ee53723897407ea31a1803af9bbedf98a49f934", "patch": "@@ -1,8 +1,8 @@\n-// run-rustfix\n #![warn(clippy::single_component_path_imports)]\n #![allow(unused_imports)]\n \n // #7106: use statements exporting a macro within a crate should not trigger lint\n+// #7923: normal `use` statements of macros should also not trigger the lint\n \n macro_rules! m1 {\n     () => {};\n@@ -12,7 +12,7 @@ pub(crate) use m1; // ok\n macro_rules! m2 {\n     () => {};\n }\n-use m2; // fail\n+use m2; // ok\n \n fn main() {\n     m1!();"}, {"sha": "37d5176129ff30a2d06733b35c2b2c9b5404574f", "filename": "tests/ui/single_component_path_imports_macro.stderr", "status": "removed", "additions": 0, "deletions": 10, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/dc5423ad448877e33cca28db2f1445c9c4473c75/tests%2Fui%2Fsingle_component_path_imports_macro.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/dc5423ad448877e33cca28db2f1445c9c4473c75/tests%2Fui%2Fsingle_component_path_imports_macro.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fsingle_component_path_imports_macro.stderr?ref=dc5423ad448877e33cca28db2f1445c9c4473c75", "patch": "@@ -1,10 +0,0 @@\n-error: this import is redundant\n-  --> $DIR/single_component_path_imports_macro.rs:15:1\n-   |\n-LL | use m2; // fail\n-   | ^^^^^^^ help: remove it entirely\n-   |\n-   = note: `-D clippy::single-component-path-imports` implied by `-D warnings`\n-\n-error: aborting due to previous error\n-"}]}