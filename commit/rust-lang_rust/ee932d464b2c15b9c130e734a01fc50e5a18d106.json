{"sha": "ee932d464b2c15b9c130e734a01fc50e5a18d106", "node_id": "MDY6Q29tbWl0NzI0NzEyOmVlOTMyZDQ2NGIyYzE1YjljMTMwZTczNGEwMWZjNTBlNWExOGQxMDY=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-08-25T10:04:56Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-08-25T10:13:08Z"}, "message": ":arrow_up: vfs", "tree": {"sha": "04465e054f673c1433b1568ee2dedc9ba81ff425", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/04465e054f673c1433b1568ee2dedc9ba81ff425"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ee932d464b2c15b9c130e734a01fc50e5a18d106", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ee932d464b2c15b9c130e734a01fc50e5a18d106", "html_url": "https://github.com/rust-lang/rust/commit/ee932d464b2c15b9c130e734a01fc50e5a18d106", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ee932d464b2c15b9c130e734a01fc50e5a18d106/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fdece911fe8e2f3c22760ea22038a6d00cb70dfa", "url": "https://api.github.com/repos/rust-lang/rust/commits/fdece911fe8e2f3c22760ea22038a6d00cb70dfa", "html_url": "https://github.com/rust-lang/rust/commit/fdece911fe8e2f3c22760ea22038a6d00cb70dfa"}], "stats": {"total": 40, "additions": 25, "deletions": 15}, "files": [{"sha": "e2938b5f8c226b226e81b5d49607d95a3f402c76", "filename": "Cargo.lock", "status": "modified", "additions": 6, "deletions": 5, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/ee932d464b2c15b9c130e734a01fc50e5a18d106/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/ee932d464b2c15b9c130e734a01fc50e5a18d106/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=ee932d464b2c15b9c130e734a01fc50e5a18d106", "patch": "@@ -1080,12 +1080,13 @@ dependencies = [\n name = \"ra_batch\"\n version = \"0.1.0\"\n dependencies = [\n+ \"crossbeam-channel 0.3.9 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"log 0.4.8 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"ra_db 0.1.0\",\n  \"ra_hir 0.1.0\",\n  \"ra_ide_api 0.1.0\",\n  \"ra_project_model 0.1.0\",\n- \"ra_vfs 0.2.8 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"ra_vfs 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"ra_vfs_glob 0.1.0\",\n  \"rustc-hash 1.0.1 (registry+https://github.com/rust-lang/crates.io-index)\",\n ]\n@@ -1191,7 +1192,7 @@ dependencies = [\n  \"ra_project_model 0.1.0\",\n  \"ra_syntax 0.1.0\",\n  \"ra_text_edit 0.1.0\",\n- \"ra_vfs 0.2.8 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"ra_vfs 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"ra_vfs_glob 0.1.0\",\n  \"relative-path 0.4.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"rustc-hash 1.0.1 (registry+https://github.com/rust-lang/crates.io-index)\",\n@@ -1300,7 +1301,7 @@ dependencies = [\n \n [[package]]\n name = \"ra_vfs\"\n-version = \"0.2.8\"\n+version = \"0.3.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n dependencies = [\n  \"crossbeam-channel 0.3.9 (registry+https://github.com/rust-lang/crates.io-index)\",\n@@ -1318,7 +1319,7 @@ name = \"ra_vfs_glob\"\n version = \"0.1.0\"\n dependencies = [\n  \"globset 0.4.4 (registry+https://github.com/rust-lang/crates.io-index)\",\n- \"ra_vfs 0.2.8 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"ra_vfs 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n ]\n \n [[package]]\n@@ -2120,7 +2121,7 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n \"checksum quote 0.6.13 (registry+https://github.com/rust-lang/crates.io-index)\" = \"6ce23b6b870e8f94f81fb0a363d65d86675884b34a09043c81e5562f11c1f8e1\"\n \"checksum quote 1.0.2 (registry+https://github.com/rust-lang/crates.io-index)\" = \"053a8c8bcc71fcce321828dc897a98ab9760bef03a4fc36693c231e5b3216cfe\"\n \"checksum ra_rustc_lexer 0.1.0-pre.3 (registry+https://github.com/rust-lang/crates.io-index)\" = \"04371af481820ff8d35c7d12b503eb09cf9e1bd246269bf4a33e3d8c54fa3a4a\"\n-\"checksum ra_vfs 0.2.8 (registry+https://github.com/rust-lang/crates.io-index)\" = \"9e891866e1bb03f50a28cc01e3f244a62107c301ae674ba06b2e7a9b310ae75a\"\n+\"checksum ra_vfs 0.3.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"ccc8b709e0b7ceec822513451b610df1b9370b01953a8bc545a041a6b3bfef01\"\n \"checksum rand 0.6.5 (registry+https://github.com/rust-lang/crates.io-index)\" = \"6d71dacdc3c88c1fde3885a3be3fbab9f35724e6ce99467f7d9c5026132184ca\"\n \"checksum rand 0.7.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"d47eab0e83d9693d40f825f86948aa16eff6750ead4bdffc4ab95b8b3a7f052c\"\n \"checksum rand_chacha 0.1.1 (registry+https://github.com/rust-lang/crates.io-index)\" = \"556d3a1ca6600bfcbab7c7c91ccb085ac7fbbcd70e008a98742e7847f4f7bcef\""}, {"sha": "5fc2703ee9f27e0d29b9e261bb2fb62358e8fc23", "filename": "crates/ra_batch/Cargo.toml", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/ee932d464b2c15b9c130e734a01fc50e5a18d106/crates%2Fra_batch%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/ee932d464b2c15b9c130e734a01fc50e5a18d106/crates%2Fra_batch%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_batch%2FCargo.toml?ref=ee932d464b2c15b9c130e734a01fc50e5a18d106", "patch": "@@ -7,8 +7,9 @@ authors = [\"rust-analyzer developers\"]\n [dependencies]\n log = \"0.4.5\"\n rustc-hash = \"1.0\"\n+crossbeam-channel = \"0.3.5\"\n \n-ra_vfs = \"0.2.0\"\n+ra_vfs = \"0.3.0\"\n ra_vfs_glob = { path = \"../ra_vfs_glob\" }\n ra_db = { path = \"../ra_db\" }\n ra_ide_api = { path = \"../ra_ide_api\" }"}, {"sha": "4e5bad04439bf769b833e9cbc235e3b2f30008c5", "filename": "crates/ra_batch/src/lib.rs", "status": "modified", "additions": 7, "deletions": 3, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/ee932d464b2c15b9c130e734a01fc50e5a18d106/crates%2Fra_batch%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee932d464b2c15b9c130e734a01fc50e5a18d106/crates%2Fra_batch%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_batch%2Fsrc%2Flib.rs?ref=ee932d464b2c15b9c130e734a01fc50e5a18d106", "patch": "@@ -2,10 +2,11 @@ use std::{collections::HashSet, error::Error, path::Path};\n \n use rustc_hash::FxHashMap;\n \n+use crossbeam_channel::{unbounded, Receiver};\n use ra_db::{CrateGraph, FileId, SourceRootId};\n use ra_ide_api::{AnalysisChange, AnalysisHost, FeatureFlags};\n use ra_project_model::{PackageRoot, ProjectWorkspace};\n-use ra_vfs::{RootEntry, Vfs, VfsChange};\n+use ra_vfs::{RootEntry, Vfs, VfsChange, VfsTask};\n use ra_vfs_glob::RustPackageFilterBuilder;\n \n type Result<T> = std::result::Result<T, Box<dyn Error + Send + Sync>>;\n@@ -21,6 +22,8 @@ pub fn load_cargo(root: &Path) -> Result<(AnalysisHost, FxHashMap<SourceRootId,\n     let root = std::env::current_dir()?.join(root);\n     let ws = ProjectWorkspace::discover(root.as_ref())?;\n     let project_roots = ws.to_roots();\n+    let (sender, receiver) = unbounded();\n+    let sender = Box::new(move |t| sender.send(t).unwrap());\n     let (mut vfs, roots) = Vfs::new(\n         project_roots\n             .iter()\n@@ -33,6 +36,7 @@ pub fn load_cargo(root: &Path) -> Result<(AnalysisHost, FxHashMap<SourceRootId,\n                 )\n             })\n             .collect(),\n+        sender,\n     );\n     let crate_graph = ws.to_crate_graph(&mut |path: &Path| {\n         let vfs_file = vfs.load(path);\n@@ -53,22 +57,22 @@ pub fn load_cargo(root: &Path) -> Result<(AnalysisHost, FxHashMap<SourceRootId,\n             (source_root_id, project_root)\n         })\n         .collect::<FxHashMap<_, _>>();\n-    let host = load(&source_roots, crate_graph, &mut vfs);\n+    let host = load(&source_roots, crate_graph, &mut vfs, receiver);\n     Ok((host, source_roots))\n }\n \n pub fn load(\n     source_roots: &FxHashMap<SourceRootId, PackageRoot>,\n     crate_graph: CrateGraph,\n     vfs: &mut Vfs,\n+    receiver: Receiver<VfsTask>,\n ) -> AnalysisHost {\n     let lru_cap = std::env::var(\"RA_LRU_CAP\").ok().and_then(|it| it.parse::<usize>().ok());\n     let mut host = AnalysisHost::new(lru_cap, FeatureFlags::default());\n     let mut analysis_change = AnalysisChange::new();\n     analysis_change.set_crate_graph(crate_graph);\n \n     // wait until Vfs has loaded all roots\n-    let receiver = vfs.task_receiver().clone();\n     let mut roots_loaded = HashSet::new();\n     for task in receiver {\n         vfs.handle_task(task);"}, {"sha": "e271c257bc9112af54b472820a9c992fabf50481", "filename": "crates/ra_lsp_server/Cargo.toml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ee932d464b2c15b9c130e734a01fc50e5a18d106/crates%2Fra_lsp_server%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/ee932d464b2c15b9c130e734a01fc50e5a18d106/crates%2Fra_lsp_server%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2FCargo.toml?ref=ee932d464b2c15b9c130e734a01fc50e5a18d106", "patch": "@@ -16,7 +16,7 @@ lsp-types = { version = \"0.60.0\", features = [\"proposed\"] }\n rustc-hash = \"1.0\"\n parking_lot = \"0.9.0\"\n \n-ra_vfs = \"0.2.7\"\n+ra_vfs = \"0.3.0\"\n thread_worker = { path = \"../thread_worker\" }\n ra_syntax = { path = \"../ra_syntax\" }\n ra_text_edit = { path = \"../ra_text_edit\" }"}, {"sha": "45bd52769bfb1a93b3a86e20b483e920cec140c0", "filename": "crates/ra_lsp_server/src/main_loop.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ee932d464b2c15b9c130e734a01fc50e5a18d106/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee932d464b2c15b9c130e734a01fc50e5a18d106/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop.rs?ref=ee932d464b2c15b9c130e734a01fc50e5a18d106", "patch": "@@ -217,7 +217,7 @@ fn main_loop_inner(\n                 Err(RecvError) => Err(\"client exited without shutdown\")?,\n             },\n             recv(task_receiver) -> task => Event::Task(task.unwrap()),\n-            recv(state.vfs.read().task_receiver()) -> task => match task {\n+            recv(state.task_receiver) -> task => match task {\n                 Ok(task) => Event::Vfs(task),\n                 Err(RecvError) => Err(\"vfs died\")?,\n             },"}, {"sha": "cc79644698629e7b1cba6bb3cd466ab1e9f240c3", "filename": "crates/ra_lsp_server/src/world.rs", "status": "modified", "additions": 7, "deletions": 3, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/ee932d464b2c15b9c130e734a01fc50e5a18d106/crates%2Fra_lsp_server%2Fsrc%2Fworld.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee932d464b2c15b9c130e734a01fc50e5a18d106/crates%2Fra_lsp_server%2Fsrc%2Fworld.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Fsrc%2Fworld.rs?ref=ee932d464b2c15b9c130e734a01fc50e5a18d106", "patch": "@@ -3,14 +3,15 @@ use std::{\n     sync::Arc,\n };\n \n+use crossbeam_channel::{unbounded, Receiver};\n use gen_lsp_server::ErrorCode;\n use lsp_types::Url;\n use parking_lot::RwLock;\n use ra_ide_api::{\n     Analysis, AnalysisChange, AnalysisHost, CrateGraph, FeatureFlags, FileId, LibraryData,\n     SourceRootId,\n };\n-use ra_vfs::{LineEndings, RootEntry, Vfs, VfsChange, VfsFile, VfsRoot};\n+use ra_vfs::{LineEndings, RootEntry, Vfs, VfsChange, VfsFile, VfsRoot, VfsTask};\n use ra_vfs_glob::{Glob, RustPackageFilterBuilder};\n use relative_path::RelativePathBuf;\n \n@@ -39,6 +40,7 @@ pub struct WorldState {\n     pub workspaces: Arc<Vec<ProjectWorkspace>>,\n     pub analysis_host: AnalysisHost,\n     pub vfs: Arc<RwLock<Vfs>>,\n+    pub task_receiver: Receiver<VfsTask>,\n     pub latest_requests: Arc<RwLock<LatestRequests>>,\n }\n \n@@ -80,8 +82,9 @@ impl WorldState {\n                 RootEntry::new(pkg_root.path().clone(), filter.into_vfs_filter())\n             }));\n         }\n-\n-        let (mut vfs, vfs_roots) = Vfs::new(roots);\n+        let (task_sender, task_receiver) = unbounded();\n+        let task_sender = Box::new(move |t| task_sender.send(t).unwrap());\n+        let (mut vfs, vfs_roots) = Vfs::new(roots, task_sender);\n         let roots_to_scan = vfs_roots.len();\n         for r in vfs_roots {\n             let vfs_root_path = vfs.root2path(r);\n@@ -109,6 +112,7 @@ impl WorldState {\n             workspaces: Arc::new(workspaces),\n             analysis_host,\n             vfs: Arc::new(RwLock::new(vfs)),\n+            task_receiver,\n             latest_requests: Default::default(),\n         }\n     }"}, {"sha": "09ba3d3bfec21994d9ca0de6e69e0e587734c1dd", "filename": "crates/ra_vfs_glob/Cargo.toml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ee932d464b2c15b9c130e734a01fc50e5a18d106/crates%2Fra_vfs_glob%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/ee932d464b2c15b9c130e734a01fc50e5a18d106/crates%2Fra_vfs_glob%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_vfs_glob%2FCargo.toml?ref=ee932d464b2c15b9c130e734a01fc50e5a18d106", "patch": "@@ -5,5 +5,5 @@ version = \"0.1.0\"\n authors = [\"rust-analyzer developers\"]\n \n [dependencies]\n-ra_vfs = \"0.2.0\"\n+ra_vfs = \"0.3.0\"\n globset = \"0.4.4\""}]}