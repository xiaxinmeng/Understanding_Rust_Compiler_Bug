{"sha": "aee13fb7c50faba1db567736c1b17cbc4716c74d", "node_id": "C_kwDOAAsO6NoAKGFlZTEzZmI3YzUwZmFiYTFkYjU2NzczNmMxYjE3Y2JjNDcxNmM3NGQ", "commit": {"author": {"name": "Mara Bos", "email": "m-ou.se@m-ou.se", "date": "2022-02-07T14:08:29Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-02-07T14:08:29Z"}, "message": "Rollup merge of #88313 - jyn514:pre-push, r=Mark-Simulacrum\n\nMake the pre-commit script pre-push instead\n\nThis should make it substantially less annoying, and hopefully more\npeople will find it useful. In particular, it will no longer run tidy\neach time you run `git commit --amend` or rebase a branch.\n\nThis also warns if you have the old script in pre-commit; see the HACK\ncomment for details.\n\nr? ````@Mark-Simulacrum```` cc ````@caass````", "tree": {"sha": "a8e3966b484f7b8075acf6b689a894390ca09c49", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a8e3966b484f7b8075acf6b689a894390ca09c49"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/aee13fb7c50faba1db567736c1b17cbc4716c74d", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJiASfeCRBK7hj4Ov3rIwAAUhQIAJ1LgyhdiDKyf6GkZZNtetD2\n/o7ASHK5FkJ0IYU+G6c+BBeszZLF9N4LwVKYMKDVCq0zYI+qTv6Z/Y+lr2r/BSIf\nVLEoV29Fn5Df5MlHbbZZMTy6+qAhFmQv76WskLLVrnMP/D2cUXWHWxeg58TovcFT\nUZWpzfDKLMLv1c6nFzJHiLqarB224FefkjsqoPD8yqgI0CbqYN3NsSPuhrkUakdl\n6FX2iIcwTGdgQwAWX1s4HtANq3hIAMcZzRb6YuzvRJOGcgPShuB6hP1ri3/YTjWG\nSb7woFtmEIuPOg4bzWOAWyuNmKB7wcF7m9aWCZTKgRNMQuuEBKWIJDSdU9E0xWM=\n=ZZOU\n-----END PGP SIGNATURE-----\n", "payload": "tree a8e3966b484f7b8075acf6b689a894390ca09c49\nparent 926e7843eaa1794f15948395588eddedfb74a0d8\nparent 9d664b24f92fbbe22b3243014bb98f6878db30a9\nauthor Mara Bos <m-ou.se@m-ou.se> 1644242909 +0000\ncommitter GitHub <noreply@github.com> 1644242909 +0000\n\nRollup merge of #88313 - jyn514:pre-push, r=Mark-Simulacrum\n\nMake the pre-commit script pre-push instead\n\nThis should make it substantially less annoying, and hopefully more\npeople will find it useful. In particular, it will no longer run tidy\neach time you run `git commit --amend` or rebase a branch.\n\nThis also warns if you have the old script in pre-commit; see the HACK\ncomment for details.\n\nr? ````@Mark-Simulacrum```` cc ````@caass````\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/aee13fb7c50faba1db567736c1b17cbc4716c74d", "html_url": "https://github.com/rust-lang/rust/commit/aee13fb7c50faba1db567736c1b17cbc4716c74d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/aee13fb7c50faba1db567736c1b17cbc4716c74d/comments", "author": {"login": "m-ou-se", "id": 783247, "node_id": "MDQ6VXNlcjc4MzI0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/783247?v=4", "gravatar_id": "", "url": "https://api.github.com/users/m-ou-se", "html_url": "https://github.com/m-ou-se", "followers_url": "https://api.github.com/users/m-ou-se/followers", "following_url": "https://api.github.com/users/m-ou-se/following{/other_user}", "gists_url": "https://api.github.com/users/m-ou-se/gists{/gist_id}", "starred_url": "https://api.github.com/users/m-ou-se/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/m-ou-se/subscriptions", "organizations_url": "https://api.github.com/users/m-ou-se/orgs", "repos_url": "https://api.github.com/users/m-ou-se/repos", "events_url": "https://api.github.com/users/m-ou-se/events{/privacy}", "received_events_url": "https://api.github.com/users/m-ou-se/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "926e7843eaa1794f15948395588eddedfb74a0d8", "url": "https://api.github.com/repos/rust-lang/rust/commits/926e7843eaa1794f15948395588eddedfb74a0d8", "html_url": "https://github.com/rust-lang/rust/commit/926e7843eaa1794f15948395588eddedfb74a0d8"}, {"sha": "9d664b24f92fbbe22b3243014bb98f6878db30a9", "url": "https://api.github.com/repos/rust-lang/rust/commits/9d664b24f92fbbe22b3243014bb98f6878db30a9", "html_url": "https://github.com/rust-lang/rust/commit/9d664b24f92fbbe22b3243014bb98f6878db30a9"}], "stats": {"total": 28, "additions": 21, "deletions": 7}, "files": [{"sha": "9c41ab69c8be3784e4e07f12acc9c06d60b03844", "filename": "src/bootstrap/bin/main.rs", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/aee13fb7c50faba1db567736c1b17cbc4716c74d/src%2Fbootstrap%2Fbin%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aee13fb7c50faba1db567736c1b17cbc4716c74d/src%2Fbootstrap%2Fbin%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbin%2Fmain.rs?ref=aee13fb7c50faba1db567736c1b17cbc4716c74d", "patch": "@@ -30,6 +30,7 @@ fn main() {\n         println!(\"{}\", suggestion);\n     }\n \n+    let pre_commit = config.src.join(\".git\").join(\"hooks\").join(\"pre-commit\");\n     Build::new(config).build();\n \n     if suggest_setup {\n@@ -42,6 +43,19 @@ fn main() {\n         println!(\"{}\", suggestion);\n     }\n \n+    // Give a warning if the pre-commit script is in pre-commit and not pre-push.\n+    // HACK: Since the commit script uses hard links, we can't actually tell if it was installed by x.py setup or not.\n+    // We could see if it's identical to src/etc/pre-push.sh, but pre-push may have been modified in the meantime.\n+    // Instead, look for this comment, which is almost certainly not in any custom hook.\n+    if std::fs::read_to_string(pre_commit).map_or(false, |contents| {\n+        contents.contains(\"https://github.com/rust-lang/rust/issues/77620#issuecomment-705144570\")\n+    }) {\n+        println!(\n+            \"warning: You have the pre-push script installed to .git/hooks/pre-commit. \\\n+                  Consider moving it to .git/hooks/pre-push instead, which runs less often.\"\n+        );\n+    }\n+\n     if suggest_setup || changelog_suggestion.is_some() {\n         println!(\"note: this message was printed twice to make it more likely to be seen\");\n     }"}, {"sha": "ccfd7dc2a53fc297831cd6fc6bb145e676d08202", "filename": "src/bootstrap/setup.rs", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/aee13fb7c50faba1db567736c1b17cbc4716c74d/src%2Fbootstrap%2Fsetup.rs", "raw_url": "https://github.com/rust-lang/rust/raw/aee13fb7c50faba1db567736c1b17cbc4716c74d/src%2Fbootstrap%2Fsetup.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fsetup.rs?ref=aee13fb7c50faba1db567736c1b17cbc4716c74d", "patch": "@@ -271,9 +271,9 @@ fn install_git_hook_maybe(src_path: &Path) -> io::Result<()> {\n     let mut input = String::new();\n     println!(\n         \"Rust's CI will automatically fail if it doesn't pass `tidy`, the internal tool for ensuring code quality.\n-If you'd like, x.py can install a git hook for you that will automatically run `tidy --bless` on each commit\n-to ensure your code is up to par. If you decide later that this behavior is undesirable,\n-simply delete the `pre-commit` file from .git/hooks.\"\n+If you'd like, x.py can install a git hook for you that will automatically run `tidy --bless` before\n+pushing your code to ensure your code is up to par. If you decide later that this behavior is\n+undesirable, simply delete the `pre-push` file from .git/hooks.\"\n     );\n \n     let should_install = loop {\n@@ -293,21 +293,21 @@ simply delete the `pre-commit` file from .git/hooks.\"\n     };\n \n     if should_install {\n-        let src = src_path.join(\"src\").join(\"etc\").join(\"pre-commit.sh\");\n+        let src = src_path.join(\"src\").join(\"etc\").join(\"pre-push.sh\");\n         let git = t!(Command::new(\"git\").args(&[\"rev-parse\", \"--git-common-dir\"]).output().map(\n             |output| {\n                 assert!(output.status.success(), \"failed to run `git`\");\n                 PathBuf::from(t!(String::from_utf8(output.stdout)).trim())\n             }\n         ));\n-        let dst = git.join(\"hooks\").join(\"pre-commit\");\n+        let dst = git.join(\"hooks\").join(\"pre-push\");\n         match fs::hard_link(src, &dst) {\n             Err(e) => println!(\n                 \"error: could not create hook {}: do you already have the git hook installed?\\n{}\",\n                 dst.display(),\n                 e\n             ),\n-            Ok(_) => println!(\"Linked `src/etc/pre-commit.sh` to `.git/hooks/pre-commit`\"),\n+            Ok(_) => println!(\"Linked `src/etc/pre-commit.sh` to `.git/hooks/pre-push`\"),\n         };\n     } else {\n         println!(\"Ok, skipping installation!\");"}, {"sha": "a78725f2ab0d1c1383e708240e819ae451c843c0", "filename": "src/etc/pre-push.sh", "status": "renamed", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/aee13fb7c50faba1db567736c1b17cbc4716c74d/src%2Fetc%2Fpre-push.sh", "raw_url": "https://github.com/rust-lang/rust/raw/aee13fb7c50faba1db567736c1b17cbc4716c74d/src%2Fetc%2Fpre-push.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fetc%2Fpre-push.sh?ref=aee13fb7c50faba1db567736c1b17cbc4716c74d", "patch": "@@ -16,7 +16,7 @@ if [[ \"$OSTYPE\" == \"msys\" || \"$OSTYPE\" == \"win32\" ]]; then\n   COMMAND=\"python $COMMAND\"\n fi\n \n-echo \"Running pre-commit script '$COMMAND'\"\n+echo \"Running pre-push script '$COMMAND'\"\n \n cd \"$ROOT_DIR\"\n ", "previous_filename": "src/etc/pre-commit.sh"}]}