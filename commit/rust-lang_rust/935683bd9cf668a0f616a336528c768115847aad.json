{"sha": "935683bd9cf668a0f616a336528c768115847aad", "node_id": "MDY6Q29tbWl0NzI0NzEyOjkzNTY4M2JkOWNmNjY4YTBmNjE2YTMzNjUyOGM3NjgxMTU4NDdhYWQ=", "commit": {"author": {"name": "Stefan Lankes", "email": "slankes@eonerc.rwth-aachen.de", "date": "2020-04-05T11:37:04Z"}, "committer": {"name": "Stefan Lankes", "email": "slankes@eonerc.rwth-aachen.de", "date": "2020-04-05T11:41:17Z"}, "message": "Simplify dtor registration for HermitCore by using a list of destructors\n\nThe implementation is similiar to macOS solution doesn't\ndepend on additional OS support", "tree": {"sha": "e3cca2f5769ee08194e6151a574f2f617fd54109", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e3cca2f5769ee08194e6151a574f2f617fd54109"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/935683bd9cf668a0f616a336528c768115847aad", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/935683bd9cf668a0f616a336528c768115847aad", "html_url": "https://github.com/rust-lang/rust/commit/935683bd9cf668a0f616a336528c768115847aad", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/935683bd9cf668a0f616a336528c768115847aad/comments", "author": {"login": "stlankes", "id": 5888473, "node_id": "MDQ6VXNlcjU4ODg0NzM=", "avatar_url": "https://avatars.githubusercontent.com/u/5888473?v=4", "gravatar_id": "", "url": "https://api.github.com/users/stlankes", "html_url": "https://github.com/stlankes", "followers_url": "https://api.github.com/users/stlankes/followers", "following_url": "https://api.github.com/users/stlankes/following{/other_user}", "gists_url": "https://api.github.com/users/stlankes/gists{/gist_id}", "starred_url": "https://api.github.com/users/stlankes/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/stlankes/subscriptions", "organizations_url": "https://api.github.com/users/stlankes/orgs", "repos_url": "https://api.github.com/users/stlankes/repos", "events_url": "https://api.github.com/users/stlankes/events{/privacy}", "received_events_url": "https://api.github.com/users/stlankes/received_events", "type": "User", "site_admin": false}, "committer": {"login": "stlankes", "id": 5888473, "node_id": "MDQ6VXNlcjU4ODg0NzM=", "avatar_url": "https://avatars.githubusercontent.com/u/5888473?v=4", "gravatar_id": "", "url": "https://api.github.com/users/stlankes", "html_url": "https://github.com/stlankes", "followers_url": "https://api.github.com/users/stlankes/followers", "following_url": "https://api.github.com/users/stlankes/following{/other_user}", "gists_url": "https://api.github.com/users/stlankes/gists{/gist_id}", "starred_url": "https://api.github.com/users/stlankes/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/stlankes/subscriptions", "organizations_url": "https://api.github.com/users/stlankes/orgs", "repos_url": "https://api.github.com/users/stlankes/repos", "events_url": "https://api.github.com/users/stlankes/events{/privacy}", "received_events_url": "https://api.github.com/users/stlankes/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7b657d340d715f48449189fea9d032350323a13f", "url": "https://api.github.com/repos/rust-lang/rust/commits/7b657d340d715f48449189fea9d032350323a13f", "html_url": "https://github.com/rust-lang/rust/commit/7b657d340d715f48449189fea9d032350323a13f"}], "stats": {"total": 92, "additions": 48, "deletions": 44}, "files": [{"sha": "9b683fce157488df8d26ee08184e278578e5c17b", "filename": "src/libstd/sys/hermit/fast_thread_local.rs", "status": "modified", "additions": 33, "deletions": 1, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/935683bd9cf668a0f616a336528c768115847aad/src%2Flibstd%2Fsys%2Fhermit%2Ffast_thread_local.rs", "raw_url": "https://github.com/rust-lang/rust/raw/935683bd9cf668a0f616a336528c768115847aad/src%2Flibstd%2Fsys%2Fhermit%2Ffast_thread_local.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Fhermit%2Ffast_thread_local.rs?ref=935683bd9cf668a0f616a336528c768115847aad", "patch": "@@ -1,4 +1,36 @@\n #![cfg(target_thread_local)]\n #![unstable(feature = \"thread_local_internals\", issue = \"none\")]\n \n-pub use crate::sys_common::thread_local::register_dtor_fallback as register_dtor;\n+// Simplify dtor registration by using a list of destructors.\n+// The this solution works like the implementation of macOS and\n+// doesn't additional OS support\n+\n+use crate::cell::Cell;\n+use crate::ptr;\n+\n+#[thread_local]\n+static DTORS: Cell<*mut List> = Cell::new(ptr::null_mut());\n+\n+type List = Vec<(*mut u8, unsafe extern \"C\" fn(*mut u8))>;\n+\n+pub unsafe fn register_dtor(t: *mut u8, dtor: unsafe extern \"C\" fn(*mut u8)) {\n+    if DTORS.get().is_null() {\n+        let v: Box<List> = box Vec::new();\n+        DTORS.set(Box::into_raw(v));\n+    }\n+\n+    let list: &mut List = &mut *DTORS.get();\n+    list.push((t, dtor));\n+}\n+\n+// every thread call this function to run through all possible destructors\n+pub unsafe fn run_dtors() {\n+    let mut ptr = DTORS.replace(ptr::null_mut());\n+    while !ptr.is_null() {\n+        let list = Box::from_raw(ptr);\n+        for (ptr, dtor) in list.into_iter() {\n+            dtor(ptr);\n+        }\n+        ptr = DTORS.replace(ptr::null_mut());\n+    }\n+}"}, {"sha": "6736d964e521b9850db1190a8d90e9eeddf6b05d", "filename": "src/libstd/sys/hermit/mod.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/935683bd9cf668a0f616a336528c768115847aad/src%2Flibstd%2Fsys%2Fhermit%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/935683bd9cf668a0f616a336528c768115847aad/src%2Flibstd%2Fsys%2Fhermit%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Fhermit%2Fmod.rs?ref=935683bd9cf668a0f616a336528c768115847aad", "patch": "@@ -103,6 +103,7 @@ pub unsafe extern \"C\" fn runtime_entry(\n     argv: *const *const c_char,\n     env: *const *const c_char,\n ) -> ! {\n+    use crate::sys::hermit::fast_thread_local::run_dtors;\n     extern \"C\" {\n         fn main(argc: isize, argv: *const *const c_char) -> i32;\n     }\n@@ -112,6 +113,7 @@ pub unsafe extern \"C\" fn runtime_entry(\n \n     let result = main(argc as isize, argv);\n \n+    run_dtors();\n     abi::exit(result);\n }\n "}, {"sha": "c0ee2829f09afc50bc3985b478b669adcee77233", "filename": "src/libstd/sys/hermit/thread.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/935683bd9cf668a0f616a336528c768115847aad/src%2Flibstd%2Fsys%2Fhermit%2Fthread.rs", "raw_url": "https://github.com/rust-lang/rust/raw/935683bd9cf668a0f616a336528c768115847aad/src%2Flibstd%2Fsys%2Fhermit%2Fthread.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Fhermit%2Fthread.rs?ref=935683bd9cf668a0f616a336528c768115847aad", "patch": "@@ -5,6 +5,7 @@ use crate::fmt;\n use crate::io;\n use crate::mem;\n use crate::sys::hermit::abi;\n+use crate::sys::hermit::fast_thread_local::run_dtors;\n use crate::time::Duration;\n use core::u32;\n \n@@ -70,6 +71,9 @@ impl Thread {\n             unsafe {\n                 // Finally, let's run some code.\n                 Box::from_raw(main as *mut Box<dyn FnOnce()>)();\n+\n+                // run all destructors\n+                run_dtors();\n             }\n         }\n     }"}, {"sha": "f8be9863ed56f69713e88c98fdfd8b4a6037f2e6", "filename": "src/libstd/sys/hermit/thread_local.rs", "status": "modified", "additions": 9, "deletions": 43, "changes": 52, "blob_url": "https://github.com/rust-lang/rust/blob/935683bd9cf668a0f616a336528c768115847aad/src%2Flibstd%2Fsys%2Fhermit%2Fthread_local.rs", "raw_url": "https://github.com/rust-lang/rust/raw/935683bd9cf668a0f616a336528c768115847aad/src%2Flibstd%2Fsys%2Fhermit%2Fthread_local.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fsys%2Fhermit%2Fthread_local.rs?ref=935683bd9cf668a0f616a336528c768115847aad", "patch": "@@ -1,60 +1,26 @@\n-#![allow(dead_code)] // not used on all platforms\n-\n-use crate::collections::BTreeMap;\n-use crate::ptr;\n-use crate::sync::atomic::{AtomicUsize, Ordering};\n-use crate::sys_common::mutex::Mutex;\n-\n pub type Key = usize;\n \n-type Dtor = unsafe extern \"C\" fn(*mut u8);\n-\n-static NEXT_KEY: AtomicUsize = AtomicUsize::new(0);\n-\n-static mut KEYS: *mut BTreeMap<Key, Option<Dtor>> = ptr::null_mut();\n-static KEYS_LOCK: Mutex = Mutex::new();\n-\n-#[thread_local]\n-static mut LOCALS: *mut BTreeMap<Key, *mut u8> = ptr::null_mut();\n-\n-unsafe fn keys() -> &'static mut BTreeMap<Key, Option<Dtor>> {\n-    if KEYS.is_null() {\n-        KEYS = Box::into_raw(Box::new(BTreeMap::new()));\n-    }\n-    &mut *KEYS\n-}\n-\n-unsafe fn locals() -> &'static mut BTreeMap<Key, *mut u8> {\n-    if LOCALS.is_null() {\n-        LOCALS = Box::into_raw(Box::new(BTreeMap::new()));\n-    }\n-    &mut *LOCALS\n-}\n-\n #[inline]\n-pub unsafe fn create(dtor: Option<Dtor>) -> Key {\n-    let key = NEXT_KEY.fetch_add(1, Ordering::SeqCst);\n-    let _guard = KEYS_LOCK.lock();\n-    keys().insert(key, dtor);\n-    key\n+pub unsafe fn create(_dtor: Option<unsafe extern \"C\" fn(*mut u8)>) -> Key {\n+    panic!(\"should not be used on the wasm target\");\n }\n \n #[inline]\n-pub unsafe fn get(key: Key) -> *mut u8 {\n-    if let Some(&entry) = locals().get(&key) { entry } else { ptr::null_mut() }\n+pub unsafe fn set(_key: Key, _value: *mut u8) {\n+    panic!(\"should not be used on the wasm target\");\n }\n \n #[inline]\n-pub unsafe fn set(key: Key, value: *mut u8) {\n-    locals().insert(key, value);\n+pub unsafe fn get(_key: Key) -> *mut u8 {\n+    panic!(\"should not be used on the wasm target\");\n }\n \n #[inline]\n-pub unsafe fn destroy(key: Key) {\n-    keys().remove(&key);\n+pub unsafe fn destroy(_key: Key) {\n+    panic!(\"should not be used on the wasm target\");\n }\n \n #[inline]\n pub fn requires_synchronized_create() -> bool {\n-    false\n+    panic!(\"should not be used on the wasm target\");\n }"}]}