{"sha": "8a9bbd9d7cef43b0977dcce7f4f89886a7d288d7", "node_id": "MDY6Q29tbWl0NzI0NzEyOjhhOWJiZDlkN2NlZjQzYjA5NzdkY2NlN2Y0Zjg5ODg2YTdkMjg4ZDc=", "commit": {"author": {"name": "Marcus Klaas de Vries", "email": "mail@marcusklaas.nl", "date": "2015-10-18T21:03:01Z"}, "committer": {"name": "Marcus Klaas de Vries", "email": "mail@marcusklaas.nl", "date": "2015-10-18T21:03:01Z"}, "message": "Merge pull request #487 from marcusklaas/konsts-n-statix\n\nFormat constants and static variables", "tree": {"sha": "4a3b1a8c63cccf877e9c2b8f4861f855cddbeef0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4a3b1a8c63cccf877e9c2b8f4861f855cddbeef0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8a9bbd9d7cef43b0977dcce7f4f89886a7d288d7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8a9bbd9d7cef43b0977dcce7f4f89886a7d288d7", "html_url": "https://github.com/rust-lang/rust/commit/8a9bbd9d7cef43b0977dcce7f4f89886a7d288d7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8a9bbd9d7cef43b0977dcce7f4f89886a7d288d7/comments", "author": {"login": "marcusklaas", "id": 1255413, "node_id": "MDQ6VXNlcjEyNTU0MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1255413?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marcusklaas", "html_url": "https://github.com/marcusklaas", "followers_url": "https://api.github.com/users/marcusklaas/followers", "following_url": "https://api.github.com/users/marcusklaas/following{/other_user}", "gists_url": "https://api.github.com/users/marcusklaas/gists{/gist_id}", "starred_url": "https://api.github.com/users/marcusklaas/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marcusklaas/subscriptions", "organizations_url": "https://api.github.com/users/marcusklaas/orgs", "repos_url": "https://api.github.com/users/marcusklaas/repos", "events_url": "https://api.github.com/users/marcusklaas/events{/privacy}", "received_events_url": "https://api.github.com/users/marcusklaas/received_events", "type": "User", "site_admin": false}, "committer": {"login": "marcusklaas", "id": 1255413, "node_id": "MDQ6VXNlcjEyNTU0MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1255413?v=4", "gravatar_id": "", "url": "https://api.github.com/users/marcusklaas", "html_url": "https://github.com/marcusklaas", "followers_url": "https://api.github.com/users/marcusklaas/followers", "following_url": "https://api.github.com/users/marcusklaas/following{/other_user}", "gists_url": "https://api.github.com/users/marcusklaas/gists{/gist_id}", "starred_url": "https://api.github.com/users/marcusklaas/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/marcusklaas/subscriptions", "organizations_url": "https://api.github.com/users/marcusklaas/orgs", "repos_url": "https://api.github.com/users/marcusklaas/repos", "events_url": "https://api.github.com/users/marcusklaas/events{/privacy}", "received_events_url": "https://api.github.com/users/marcusklaas/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2995e1b22b23d9488a94fb53dbc58e9c27234d52", "url": "https://api.github.com/repos/rust-lang/rust/commits/2995e1b22b23d9488a94fb53dbc58e9c27234d52", "html_url": "https://github.com/rust-lang/rust/commit/2995e1b22b23d9488a94fb53dbc58e9c27234d52"}, {"sha": "3ce425c9edf87258b9a498844307a5c23f14b893", "url": "https://api.github.com/repos/rust-lang/rust/commits/3ce425c9edf87258b9a498844307a5c23f14b893", "html_url": "https://github.com/rust-lang/rust/commit/3ce425c9edf87258b9a498844307a5c23f14b893"}], "stats": {"total": 187, "additions": 112, "deletions": 75}, "files": [{"sha": "68715252ce9dc4a79d9799bf733cb09ed9374985", "filename": "src/items.rs", "status": "modified", "additions": 29, "deletions": 30, "changes": 59, "blob_url": "https://github.com/rust-lang/rust/blob/8a9bbd9d7cef43b0977dcce7f4f89886a7d288d7/src%2Fitems.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8a9bbd9d7cef43b0977dcce7f4f89886a7d288d7/src%2Fitems.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fitems.rs?ref=8a9bbd9d7cef43b0977dcce7f4f89886a7d288d7", "patch": "@@ -825,15 +825,15 @@ impl<'a> FmtVisitor<'a> {\n         }\n     }\n \n-    fn format_struct(&self,\n-                     item_name: &str,\n-                     ident: ast::Ident,\n-                     vis: ast::Visibility,\n-                     struct_def: &ast::VariantData,\n-                     generics: Option<&ast::Generics>,\n-                     span: Span,\n-                     offset: Indent)\n-                     -> Option<String> {\n+    pub fn format_struct(&self,\n+                         item_name: &str,\n+                         ident: ast::Ident,\n+                         vis: ast::Visibility,\n+                         struct_def: &ast::VariantData,\n+                         generics: Option<&ast::Generics>,\n+                         span: Span,\n+                         offset: Indent)\n+                         -> Option<String> {\n         let mut result = String::with_capacity(1024);\n \n         let header_str = self.format_header(item_name, ident, vis);\n@@ -929,27 +929,6 @@ impl<'a> FmtVisitor<'a> {\n         Some(result)\n     }\n \n-    pub fn visit_struct(&mut self,\n-                        ident: ast::Ident,\n-                        vis: ast::Visibility,\n-                        struct_def: &ast::VariantData,\n-                        generics: &ast::Generics,\n-                        span: Span) {\n-        let indent = self.block_indent;\n-        let result = self.format_struct(\"struct \",\n-                                        ident,\n-                                        vis,\n-                                        struct_def,\n-                                        Some(generics),\n-                                        span,\n-                                        indent);\n-\n-        if let Some(rewrite) = result {\n-            self.buffer.push_str(&rewrite);\n-            self.last_pos = span.hi;\n-        }\n-    }\n-\n     fn format_header(&self, item_name: &str, ident: ast::Ident, vis: ast::Visibility) -> String {\n         format!(\"{}{}{}\", format_visibility(vis), item_name, ident)\n     }\n@@ -1138,6 +1117,26 @@ impl<'a> FmtVisitor<'a> {\n     }\n }\n \n+pub fn rewrite_static(prefix: &str,\n+                      ident: ast::Ident,\n+                      ty: &ast::Ty,\n+                      mutability: ast::Mutability,\n+                      expr: &ast::Expr,\n+                      context: &RewriteContext)\n+                      -> Option<String> {\n+    let prefix = format!(\"{} {}{}: \", prefix, format_mutability(mutability), ident);\n+    // 2 = \" =\".len()\n+    let ty_str = try_opt!(ty.rewrite(context,\n+                                     context.config.max_width - context.block_indent.width() -\n+                                     prefix.len() - 2,\n+                                     context.block_indent));\n+    let lhs = format!(\"{}{} =\", prefix, ty_str);\n+\n+    // 1 = ;\n+    let remaining_width = context.config.max_width - context.block_indent.width() - 1;\n+    rewrite_assign_rhs(context, lhs, expr, remaining_width, context.block_indent).map(|s| s + \";\")\n+}\n+\n impl Rewrite for ast::FunctionRetTy {\n     fn rewrite(&self, context: &RewriteContext, width: usize, offset: Indent) -> Option<String> {\n         match *self {"}, {"sha": "fb3b25eab2224eb0efae50d09bea0507d98771eb", "filename": "src/visitor.rs", "status": "modified", "additions": 60, "deletions": 45, "changes": 105, "blob_url": "https://github.com/rust-lang/rust/blob/8a9bbd9d7cef43b0977dcce7f4f89886a7d288d7/src%2Fvisitor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8a9bbd9d7cef43b0977dcce7f4f89886a7d288d7/src%2Fvisitor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fvisitor.rs?ref=8a9bbd9d7cef43b0977dcce7f4f89886a7d288d7", "patch": "@@ -20,6 +20,7 @@ use config::Config;\n use rewrite::{Rewrite, RewriteContext};\n use comment::rewrite_comment;\n use macros::rewrite_macro;\n+use items::rewrite_static;\n \n pub struct FmtVisitor<'a> {\n     pub codemap: &'a CodeMap,\n@@ -31,22 +32,8 @@ pub struct FmtVisitor<'a> {\n }\n \n impl<'a, 'v> visit::Visitor<'v> for FmtVisitor<'a> {\n-    // FIXME: We'd rather not format expressions here, as we have little\n-    // context. How are we still reaching this?\n-    fn visit_expr(&mut self, ex: &'v ast::Expr) {\n-        debug!(\"visit_expr: {:?} {:?}\",\n-               self.codemap.lookup_char_pos(ex.span.lo),\n-               self.codemap.lookup_char_pos(ex.span.hi));\n-        self.format_missing(ex.span.lo);\n-\n-        let rewrite = ex.rewrite(&self.get_context(),\n-                                 self.config.max_width - self.block_indent.width(),\n-                                 self.block_indent);\n-\n-        if let Some(new_str) = rewrite {\n-            self.buffer.push_str(&new_str);\n-            self.last_pos = ex.span.hi;\n-        }\n+    fn visit_expr(&mut self, _: &'v ast::Expr) {\n+        unreachable!()\n     }\n \n     fn visit_stmt(&mut self, stmt: &'v ast::Stmt) {\n@@ -58,7 +45,6 @@ impl<'a, 'v> visit::Visitor<'v> for FmtVisitor<'a> {\n                 }\n             }\n             ast::Stmt_::StmtExpr(ref ex, _) | ast::Stmt_::StmtSemi(ref ex, _) => {\n-                self.format_missing_with_indent(stmt.span.lo);\n                 let suffix = if semicolon_for_stmt(stmt) {\n                     \";\"\n                 } else {\n@@ -67,13 +53,9 @@ impl<'a, 'v> visit::Visitor<'v> for FmtVisitor<'a> {\n                 let rewrite = ex.rewrite(&self.get_context(),\n                                          self.config.max_width - self.block_indent.width() -\n                                          suffix.len(),\n-                                         self.block_indent);\n-\n-                if let Some(new_str) = rewrite {\n-                    self.buffer.push_str(&new_str);\n-                    self.buffer.push_str(suffix);\n-                    self.last_pos = stmt.span.hi;\n-                }\n+                                         self.block_indent)\n+                                .map(|s| s + suffix);\n+                self.push_rewrite(stmt.span, rewrite);\n             }\n             ast::Stmt_::StmtMac(ref _mac, _macro_style) => {\n                 self.format_missing_with_indent(stmt.span.lo);\n@@ -104,16 +86,19 @@ impl<'a, 'v> visit::Visitor<'v> for FmtVisitor<'a> {\n             self.visit_stmt(&stmt)\n         }\n \n-        match b.expr {\n-            Some(ref e) => {\n-                self.format_missing_with_indent(e.span.lo);\n-                self.visit_expr(e);\n+        if let Some(ref e) = b.expr {\n+            self.format_missing_with_indent(e.span.lo);\n+            let rewrite = e.rewrite(&self.get_context(),\n+                                    self.config.max_width - self.block_indent.width(),\n+                                    self.block_indent)\n+                           .unwrap_or_else(|| self.snippet(e.span));\n \n-                if semicolon_for_expr(e) {\n-                    self.buffer.push_str(\";\");\n-                }\n+            self.buffer.push_str(&rewrite);\n+            self.last_pos = e.span.hi;\n+\n+            if semicolon_for_expr(e) {\n+                self.buffer.push_str(\";\");\n             }\n-            None => {}\n         }\n \n         self.block_indent = self.block_indent.block_unindent(self.config);\n@@ -131,7 +116,6 @@ impl<'a, 'v> visit::Visitor<'v> for FmtVisitor<'a> {\n                 b: &'v ast::Block,\n                 s: Span,\n                 _: ast::NodeId) {\n-\n         let indent = self.block_indent;\n         let rewrite = match fk {\n             visit::FnKind::ItemFn(ident, ref generics, unsafety, constness, abi, vis) => {\n@@ -190,6 +174,7 @@ impl<'a, 'v> visit::Visitor<'v> for FmtVisitor<'a> {\n             ast::Item_::ItemUse(ref vp) => {\n                 self.format_import(item.vis, vp, item.span);\n             }\n+            // FIXME(#78): format traits and impl definitions.\n             ast::Item_::ItemImpl(..) |\n             ast::Item_::ItemTrait(..) => {\n                 self.block_indent = self.block_indent.block_indent(self.config);\n@@ -203,8 +188,15 @@ impl<'a, 'v> visit::Visitor<'v> for FmtVisitor<'a> {\n                 self.last_pos = item.span.hi;\n             }\n             ast::Item_::ItemStruct(ref def, ref generics) => {\n-                self.format_missing_with_indent(item.span.lo);\n-                self.visit_struct(item.ident, item.vis, def, generics, item.span);\n+                let indent = self.block_indent;\n+                let rewrite = self.format_struct(\"struct \",\n+                                                 item.ident,\n+                                                 item.vis,\n+                                                 def,\n+                                                 Some(generics),\n+                                                 item.span,\n+                                                 indent);\n+                self.push_rewrite(item.span, rewrite);\n             }\n             ast::Item_::ItemEnum(ref def, ref generics) => {\n                 self.format_missing_with_indent(item.span.lo);\n@@ -225,7 +217,28 @@ impl<'a, 'v> visit::Visitor<'v> for FmtVisitor<'a> {\n                 self.format_missing_with_indent(item.span.lo);\n                 self.format_foreign_mod(foreign_mod, item.span);\n             }\n-            _ => {\n+            ast::Item_::ItemStatic(ref ty, mutability, ref expr) => {\n+                let rewrite = rewrite_static(\"static\",\n+                                             item.ident,\n+                                             ty,\n+                                             mutability,\n+                                             expr,\n+                                             &self.get_context());\n+                self.push_rewrite(item.span, rewrite);\n+            }\n+            ast::Item_::ItemConst(ref ty, ref expr) => {\n+                let rewrite = rewrite_static(\"const\",\n+                                             item.ident,\n+                                             ty,\n+                                             ast::Mutability::MutImmutable,\n+                                             expr,\n+                                             &self.get_context());\n+                self.push_rewrite(item.span, rewrite);\n+            }\n+            // FIXME(#486): format type aliases.\n+            ast::Item_::ItemDefaultImpl(..) |\n+            ast::Item_::ItemFn(..) |\n+            ast::Item_::ItemTy(..) => {\n                 visit::walk_item(self, item);\n             }\n         }\n@@ -237,17 +250,10 @@ impl<'a, 'v> visit::Visitor<'v> for FmtVisitor<'a> {\n         }\n \n         if let ast::TraitItem_::MethodTraitItem(ref sig, None) = ti.node {\n-            self.format_missing_with_indent(ti.span.lo);\n-\n             let indent = self.block_indent;\n-            let new_fn = self.rewrite_required_fn(indent, ti.ident, sig, ti.span);\n-\n-            if let Some(fn_str) = new_fn {\n-                self.buffer.push_str(&fn_str);\n-                self.last_pos = ti.span.hi;\n-            }\n+            let rewrite = self.rewrite_required_fn(indent, ti.ident, sig, ti.span);\n+            self.push_rewrite(ti.span, rewrite);\n         }\n-        // TODO(#78): format trait types.\n \n         visit::walk_trait_item(self, ti)\n     }\n@@ -272,6 +278,15 @@ impl<'a, 'v> visit::Visitor<'v> for FmtVisitor<'a> {\n }\n \n impl<'a> FmtVisitor<'a> {\n+    fn push_rewrite(&mut self, span: Span, rewrite: Option<String>) {\n+        self.format_missing_with_indent(span.lo);\n+\n+        if let Some(res) = rewrite {\n+            self.buffer.push_str(&res);\n+            self.last_pos = span.hi;\n+        }\n+    }\n+\n     pub fn from_codemap(codemap: &'a CodeMap, config: &'a Config) -> FmtVisitor<'a> {\n         FmtVisitor {\n             codemap: codemap,"}, {"sha": "00688732fe7e057c58716fb01a4189a51150b6a4", "filename": "tests/source/static.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/8a9bbd9d7cef43b0977dcce7f4f89886a7d288d7/tests%2Fsource%2Fstatic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8a9bbd9d7cef43b0977dcce7f4f89886a7d288d7/tests%2Fsource%2Fstatic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fstatic.rs?ref=8a9bbd9d7cef43b0977dcce7f4f89886a7d288d7", "patch": "@@ -0,0 +1,10 @@\n+pub const FILE_GENERIC_READ: DWORD =\n+                STANDARD_RIGHTS_READ | FILE_READ_DATA |\n+                FILE_READ_ATTRIBUTES | FILE_READ_EA | SYNCHRONIZE;\n+\n+pub static boolnames: &'static[&'static str] = &[\"bw\", \"am\", \"xsb\", \"xhp\", \"xenl\", \"eo\",\n+    \"gn\", \"hc\", \"km\", \"hs\", \"in\", \"db\", \"da\", \"mir\", \"msgr\", \"os\", \"eslok\", \"xt\", \"hz\", \"ul\", \"xon\",\n+    \"nxon\", \"mc5i\", \"chts\", \"nrrmc\", \"npc\", \"ndscr\", \"ccc\", \"bce\", \"hls\", \"xhpa\", \"crxm\", \"daisy\",\n+    \"xvpa\", \"sam\", \"cpix\", \"lpix\", \"OTbs\", \"OTns\", \"OTnc\", \"OTMT\", \"OTNL\", \"OTpt\", \"OTxr\"];\n+\n+static mut name: SomeType = aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa;"}, {"sha": "02223f59ca7964043e54c0a9e4e8ea17dcff6860", "filename": "tests/target/static.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/8a9bbd9d7cef43b0977dcce7f4f89886a7d288d7/tests%2Ftarget%2Fstatic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8a9bbd9d7cef43b0977dcce7f4f89886a7d288d7/tests%2Ftarget%2Fstatic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fstatic.rs?ref=8a9bbd9d7cef43b0977dcce7f4f89886a7d288d7", "patch": "@@ -0,0 +1,13 @@\n+const FILE_GENERIC_READ: DWORD = STANDARD_RIGHTS_READ | FILE_READ_DATA | FILE_READ_ATTRIBUTES |\n+                                 FILE_READ_EA | SYNCHRONIZE;\n+\n+static boolnames: &'static [&'static str] = &[\"bw\", \"am\", \"xsb\", \"xhp\", \"xenl\", \"eo\", \"gn\", \"hc\",\n+                                              \"km\", \"hs\", \"in\", \"db\", \"da\", \"mir\", \"msgr\", \"os\",\n+                                              \"eslok\", \"xt\", \"hz\", \"ul\", \"xon\", \"nxon\", \"mc5i\",\n+                                              \"chts\", \"nrrmc\", \"npc\", \"ndscr\", \"ccc\", \"bce\",\n+                                              \"hls\", \"xhpa\", \"crxm\", \"daisy\", \"xvpa\", \"sam\",\n+                                              \"cpix\", \"lpix\", \"OTbs\", \"OTns\", \"OTnc\", \"OTMT\",\n+                                              \"OTNL\", \"OTpt\", \"OTxr\"];\n+\n+static mut name: SomeType =\n+    aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa;"}]}