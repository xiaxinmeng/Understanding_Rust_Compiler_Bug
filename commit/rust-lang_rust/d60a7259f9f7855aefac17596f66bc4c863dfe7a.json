{"sha": "d60a7259f9f7855aefac17596f66bc4c863dfe7a", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ2MGE3MjU5ZjlmNzg1NWFlZmFjMTc1OTZmNjZiYzRjODYzZGZlN2E=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-03-23T01:00:52Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2013-03-23T01:00:52Z"}, "message": "auto merge of #5503 : thestinger/rust/trie, r=pcwalton", "tree": {"sha": "eea8764eb7a7725ec41664be1d5647d7312d0ca2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/eea8764eb7a7725ec41664be1d5647d7312d0ca2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d60a7259f9f7855aefac17596f66bc4c863dfe7a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d60a7259f9f7855aefac17596f66bc4c863dfe7a", "html_url": "https://github.com/rust-lang/rust/commit/d60a7259f9f7855aefac17596f66bc4c863dfe7a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d60a7259f9f7855aefac17596f66bc4c863dfe7a/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1e41bc74450328b317602f2e60ee9f41b0f90182", "url": "https://api.github.com/repos/rust-lang/rust/commits/1e41bc74450328b317602f2e60ee9f41b0f90182", "html_url": "https://github.com/rust-lang/rust/commit/1e41bc74450328b317602f2e60ee9f41b0f90182"}, {"sha": "705c796ffa78417592b9e36d975cd432a4dc8417", "url": "https://api.github.com/repos/rust-lang/rust/commits/705c796ffa78417592b9e36d975cd432a4dc8417", "html_url": "https://github.com/rust-lang/rust/commit/705c796ffa78417592b9e36d975cd432a4dc8417"}], "stats": {"total": 227, "additions": 106, "deletions": 121}, "files": [{"sha": "653e29b62a52caeaa08dcb1b0d3ea1f059e4f927", "filename": "src/libcore/trie.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/d60a7259f9f7855aefac17596f66bc4c863dfe7a/src%2Flibcore%2Ftrie.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d60a7259f9f7855aefac17596f66bc4c863dfe7a/src%2Flibcore%2Ftrie.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Ftrie.rs?ref=d60a7259f9f7855aefac17596f66bc4c863dfe7a", "patch": "@@ -12,7 +12,6 @@\n \n use prelude::*;\n \n-// FIXME: #3469: need to manually update TrieNode when SHIFT changes\n // FIXME: #5244: need to manually update the TrieNode constructor\n const SHIFT: uint = 4;\n const SIZE: uint = 1 << SHIFT;\n@@ -162,12 +161,15 @@ pub struct TrieSet {\n \n impl BaseIter<uint> for TrieSet {\n     /// Visit all values in order\n+    #[inline(always)]\n     fn each(&self, f: &fn(&uint) -> bool) { self.map.each_key(f) }\n+    #[inline(always)]\n     fn size_hint(&self) -> Option<uint> { Some(self.len()) }\n }\n \n impl ReverseIter<uint> for TrieSet {\n     /// Visit all values in reverse order\n+    #[inline(always)]\n     fn each_reverse(&self, f: &fn(&uint) -> bool) {\n         self.map.each_key_reverse(f)\n     }\n@@ -189,7 +191,7 @@ impl Mutable for TrieSet {\n     fn clear(&mut self) { self.map.clear() }\n }\n \n-impl TrieSet {\n+pub impl TrieSet {\n     /// Create an empty TrieSet\n     #[inline(always)]\n     fn new() -> TrieSet {\n@@ -215,7 +217,7 @@ impl TrieSet {\n \n struct TrieNode<T> {\n     count: uint,\n-    children: [Child<T> * 16] // FIXME: #3469: can't use the SIZE constant yet\n+    children: [Child<T> * SIZE]\n }\n \n impl<T> TrieNode<T> {\n@@ -301,7 +303,6 @@ fn insert<T>(count: &mut uint, child: &mut Child<T>, key: uint, value: T,\n         added = insert(&mut x.count, &mut x.children[chunk(key, idx)], key,\n                        value, idx + 1);\n         Internal(x)\n-\n       }\n       Nothing => {\n         *count += 1;"}, {"sha": "ff00d26882d32f22aaff4bef7f2047f1e5235dab", "filename": "src/libstd/priority_queue.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/d60a7259f9f7855aefac17596f66bc4c863dfe7a/src%2Flibstd%2Fpriority_queue.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d60a7259f9f7855aefac17596f66bc4c863dfe7a/src%2Flibstd%2Fpriority_queue.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fpriority_queue.rs?ref=d60a7259f9f7855aefac17596f66bc4c863dfe7a", "patch": "@@ -112,7 +112,7 @@ pub impl <T:Ord> PriorityQueue<T> {\n         while end > 1 {\n             end -= 1;\n             q.data[end] <-> q.data[0];\n-            unsafe { q.siftdown_range(0, end) } // purity-checking workaround\n+            q.siftdown_range(0, end)\n         }\n         q.to_vec()\n     }\n@@ -126,7 +126,7 @@ pub impl <T:Ord> PriorityQueue<T> {\n         let mut n = q.len() / 2;\n         while n > 0 {\n             n -= 1;\n-            unsafe { q.siftdown(n) }; // purity-checking workaround\n+            q.siftdown(n)\n         }\n         q\n     }"}, {"sha": "242ffd07881dee00fb445e1dccaf01ba94916671", "filename": "src/libstd/treemap.rs", "status": "modified", "additions": 99, "deletions": 115, "changes": 214, "blob_url": "https://github.com/rust-lang/rust/blob/d60a7259f9f7855aefac17596f66bc4c863dfe7a/src%2Flibstd%2Ftreemap.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d60a7259f9f7855aefac17596f66bc4c863dfe7a/src%2Flibstd%2Ftreemap.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Ftreemap.rs?ref=d60a7259f9f7855aefac17596f66bc4c863dfe7a", "patch": "@@ -43,11 +43,9 @@ impl<K: Eq + TotalOrd, V: Eq> Eq for TreeMap<K, V> {\n             let mut x = self.iter();\n             let mut y = other.iter();\n             for self.len().times {\n-                unsafe { // unsafe as a purity workaround\n-                    if map_next(&mut x).unwrap() !=\n-                       map_next(&mut y).unwrap() {\n-                        return false\n-                    }\n+                if map_next(&mut x).unwrap() !=\n+                   map_next(&mut y).unwrap() {\n+                    return false\n                 }\n             }\n             true\n@@ -64,12 +62,10 @@ fn lt<K: Ord + TotalOrd, V>(a: &TreeMap<K, V>,\n \n     let (a_len, b_len) = (a.len(), b.len());\n     for uint::min(a_len, b_len).times {\n-        unsafe { // purity workaround\n-            let (key_a,_) = map_next(&mut x).unwrap();\n-            let (key_b,_) = map_next(&mut y).unwrap();\n-            if *key_a < *key_b { return true; }\n-            if *key_a > *key_b { return false; }\n-        }\n+        let (key_a,_) = map_next(&mut x).unwrap();\n+        let (key_b,_) = map_next(&mut y).unwrap();\n+        if *key_a < *key_b { return true; }\n+        if *key_a > *key_b { return false; }\n     };\n \n     a_len < b_len\n@@ -311,17 +307,15 @@ impl<T: TotalOrd> Set<T> for TreeSet<T> {\n     fn is_disjoint(&self, other: &TreeSet<T>) -> bool {\n         let mut x = self.iter();\n         let mut y = other.iter();\n-        unsafe { // purity workaround\n-            let mut a = set_next(&mut x);\n-            let mut b = set_next(&mut y);\n-            while a.is_some() && b.is_some() {\n-                let a1 = a.unwrap();\n-                let b1 = b.unwrap();\n-                match a1.cmp(b1) {\n-                  Less => a = set_next(&mut x),\n-                  Greater => b = set_next(&mut y),\n-                  Equal => return false\n-                }\n+        let mut a = set_next(&mut x);\n+        let mut b = set_next(&mut y);\n+        while a.is_some() && b.is_some() {\n+            let a1 = a.unwrap();\n+            let b1 = b.unwrap();\n+            match a1.cmp(b1) {\n+              Less => a = set_next(&mut x),\n+              Greater => b = set_next(&mut y),\n+              Equal => return false\n             }\n         }\n         true\n@@ -337,25 +331,23 @@ impl<T: TotalOrd> Set<T> for TreeSet<T> {\n     fn is_superset(&self, other: &TreeSet<T>) -> bool {\n         let mut x = self.iter();\n         let mut y = other.iter();\n-        unsafe { // purity workaround\n-            let mut a = set_next(&mut x);\n-            let mut b = set_next(&mut y);\n-            while b.is_some() {\n-                if a.is_none() {\n-                    return false\n-                }\n-\n-                let a1 = a.unwrap();\n-                let b1 = b.unwrap();\n+        let mut a = set_next(&mut x);\n+        let mut b = set_next(&mut y);\n+        while b.is_some() {\n+            if a.is_none() {\n+                return false\n+            }\n \n-                match a1.cmp(b1) {\n-                  Less => (),\n-                  Greater => return false,\n-                  Equal => b = set_next(&mut y),\n-                }\n+            let a1 = a.unwrap();\n+            let b1 = b.unwrap();\n \n-                a = set_next(&mut x);\n+            match a1.cmp(b1) {\n+              Less => (),\n+              Greater => return false,\n+              Equal => b = set_next(&mut y),\n             }\n+\n+            a = set_next(&mut x);\n         }\n         true\n     }\n@@ -365,29 +357,27 @@ impl<T: TotalOrd> Set<T> for TreeSet<T> {\n         let mut x = self.iter();\n         let mut y = other.iter();\n \n-        unsafe { // purity workaround\n-            let mut a = set_next(&mut x);\n-            let mut b = set_next(&mut y);\n+        let mut a = set_next(&mut x);\n+        let mut b = set_next(&mut y);\n \n-            while a.is_some() {\n-                if b.is_none() {\n-                    return do a.while_some() |a1| {\n-                        if f(a1) { set_next(&mut x) } else { None }\n-                    }\n+        while a.is_some() {\n+            if b.is_none() {\n+                return do a.while_some() |a1| {\n+                    if f(a1) { set_next(&mut x) } else { None }\n                 }\n+            }\n \n-                let a1 = a.unwrap();\n-                let b1 = b.unwrap();\n+            let a1 = a.unwrap();\n+            let b1 = b.unwrap();\n \n-                let cmp = a1.cmp(b1);\n+            let cmp = a1.cmp(b1);\n \n-                if cmp == Less {\n-                    if !f(a1) { return }\n-                    a = set_next(&mut x);\n-                } else {\n-                    if cmp == Equal { a = set_next(&mut x) }\n-                    b = set_next(&mut y);\n-                }\n+            if cmp == Less {\n+                if !f(a1) { return }\n+                a = set_next(&mut x);\n+            } else {\n+                if cmp == Equal { a = set_next(&mut x) }\n+                b = set_next(&mut y);\n             }\n         }\n     }\n@@ -398,37 +388,35 @@ impl<T: TotalOrd> Set<T> for TreeSet<T> {\n         let mut x = self.iter();\n         let mut y = other.iter();\n \n-        unsafe { // purity workaround\n-            let mut a = set_next(&mut x);\n-            let mut b = set_next(&mut y);\n+        let mut a = set_next(&mut x);\n+        let mut b = set_next(&mut y);\n \n-            while a.is_some() {\n-                if b.is_none() {\n-                    return do a.while_some() |a1| {\n-                        if f(a1) { set_next(&mut x) } else { None }\n-                    }\n+        while a.is_some() {\n+            if b.is_none() {\n+                return do a.while_some() |a1| {\n+                    if f(a1) { set_next(&mut x) } else { None }\n                 }\n+            }\n \n-                let a1 = a.unwrap();\n-                let b1 = b.unwrap();\n+            let a1 = a.unwrap();\n+            let b1 = b.unwrap();\n \n-                let cmp = a1.cmp(b1);\n+            let cmp = a1.cmp(b1);\n \n-                if cmp == Less {\n-                    if !f(a1) { return }\n-                    a = set_next(&mut x);\n+            if cmp == Less {\n+                if !f(a1) { return }\n+                a = set_next(&mut x);\n+            } else {\n+                if cmp == Greater {\n+                    if !f(b1) { return }\n                 } else {\n-                    if cmp == Greater {\n-                        if !f(b1) { return }\n-                    } else {\n-                        a = set_next(&mut x);\n-                    }\n-                    b = set_next(&mut y);\n+                    a = set_next(&mut x);\n                 }\n+                b = set_next(&mut y);\n             }\n-            do b.while_some |b1| {\n-                if f(b1) { set_next(&mut y) } else { None }\n-            }\n+        }\n+        do b.while_some |b1| {\n+            if f(b1) { set_next(&mut y) } else { None }\n         }\n     }\n \n@@ -437,24 +425,22 @@ impl<T: TotalOrd> Set<T> for TreeSet<T> {\n         let mut x = self.iter();\n         let mut y = other.iter();\n \n-        unsafe { // purity workaround\n-            let mut a = set_next(&mut x);\n-            let mut b = set_next(&mut y);\n+        let mut a = set_next(&mut x);\n+        let mut b = set_next(&mut y);\n \n-            while a.is_some() && b.is_some() {\n-                let a1 = a.unwrap();\n-                let b1 = b.unwrap();\n+        while a.is_some() && b.is_some() {\n+            let a1 = a.unwrap();\n+            let b1 = b.unwrap();\n \n-                let cmp = a1.cmp(b1);\n+            let cmp = a1.cmp(b1);\n \n-                if cmp == Less {\n-                    a = set_next(&mut x);\n-                } else {\n-                    if cmp == Equal {\n-                        if !f(a1) { return }\n-                    }\n-                    b = set_next(&mut y);\n+            if cmp == Less {\n+                a = set_next(&mut x);\n+            } else {\n+                if cmp == Equal {\n+                    if !f(a1) { return }\n                 }\n+                b = set_next(&mut y);\n             }\n         }\n     }\n@@ -464,36 +450,34 @@ impl<T: TotalOrd> Set<T> for TreeSet<T> {\n         let mut x = self.iter();\n         let mut y = other.iter();\n \n-        unsafe { // purity workaround\n-            let mut a = set_next(&mut x);\n-            let mut b = set_next(&mut y);\n+        let mut a = set_next(&mut x);\n+        let mut b = set_next(&mut y);\n \n-            while a.is_some() {\n-                if b.is_none() {\n-                    return do a.while_some() |a1| {\n-                        if f(a1) { set_next(&mut x) } else { None }\n-                    }\n+        while a.is_some() {\n+            if b.is_none() {\n+                return do a.while_some() |a1| {\n+                    if f(a1) { set_next(&mut x) } else { None }\n                 }\n+            }\n \n-                let a1 = a.unwrap();\n-                let b1 = b.unwrap();\n+            let a1 = a.unwrap();\n+            let b1 = b.unwrap();\n \n-                let cmp = a1.cmp(b1);\n+            let cmp = a1.cmp(b1);\n \n-                if cmp == Greater {\n-                    if !f(b1) { return }\n+            if cmp == Greater {\n+                if !f(b1) { return }\n+                b = set_next(&mut y);\n+            } else {\n+                if !f(a1) { return }\n+                if cmp == Equal {\n                     b = set_next(&mut y);\n-                } else {\n-                    if !f(a1) { return }\n-                    if cmp == Equal {\n-                        b = set_next(&mut y);\n-                    }\n-                    a = set_next(&mut x);\n                 }\n+                a = set_next(&mut x);\n             }\n-            do b.while_some |b1| {\n-                if f(b1) { set_next(&mut y) } else { None }\n-            }\n+        }\n+        do b.while_some |b1| {\n+            if f(b1) { set_next(&mut y) } else { None }\n         }\n     }\n }"}]}