{"sha": "2d9c14afb5a9b99721c978529fd20f3be4ac1146", "node_id": "C_kwDOAAsO6NoAKDJkOWMxNGFmYjVhOWI5OTcyMWM5Nzg1MjlmZDIwZjNiZTRhYzExNDY", "commit": {"author": {"name": "Lauren\u021biu Nicola", "email": "lnicola@dend.ro", "date": "2021-12-20T17:28:00Z"}, "committer": {"name": "Lauren\u021biu Nicola", "email": "lnicola@dend.ro", "date": "2021-12-20T18:58:09Z"}, "message": "Build and publish pre-release Code extension versions", "tree": {"sha": "7a4431f3ac0640c01139c8316065b2a71f290e30", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7a4431f3ac0640c01139c8316065b2a71f290e30"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/2d9c14afb5a9b99721c978529fd20f3be4ac1146", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/2d9c14afb5a9b99721c978529fd20f3be4ac1146", "html_url": "https://github.com/rust-lang/rust/commit/2d9c14afb5a9b99721c978529fd20f3be4ac1146", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/2d9c14afb5a9b99721c978529fd20f3be4ac1146/comments", "author": {"login": "lnicola", "id": 308347, "node_id": "MDQ6VXNlcjMwODM0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/308347?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lnicola", "html_url": "https://github.com/lnicola", "followers_url": "https://api.github.com/users/lnicola/followers", "following_url": "https://api.github.com/users/lnicola/following{/other_user}", "gists_url": "https://api.github.com/users/lnicola/gists{/gist_id}", "starred_url": "https://api.github.com/users/lnicola/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lnicola/subscriptions", "organizations_url": "https://api.github.com/users/lnicola/orgs", "repos_url": "https://api.github.com/users/lnicola/repos", "events_url": "https://api.github.com/users/lnicola/events{/privacy}", "received_events_url": "https://api.github.com/users/lnicola/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lnicola", "id": 308347, "node_id": "MDQ6VXNlcjMwODM0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/308347?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lnicola", "html_url": "https://github.com/lnicola", "followers_url": "https://api.github.com/users/lnicola/followers", "following_url": "https://api.github.com/users/lnicola/following{/other_user}", "gists_url": "https://api.github.com/users/lnicola/gists{/gist_id}", "starred_url": "https://api.github.com/users/lnicola/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lnicola/subscriptions", "organizations_url": "https://api.github.com/users/lnicola/orgs", "repos_url": "https://api.github.com/users/lnicola/repos", "events_url": "https://api.github.com/users/lnicola/events{/privacy}", "received_events_url": "https://api.github.com/users/lnicola/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0add6e95e58633fde2fff0bccaf6c7d71ebc130f", "url": "https://api.github.com/repos/rust-lang/rust/commits/0add6e95e58633fde2fff0bccaf6c7d71ebc130f", "html_url": "https://github.com/rust-lang/rust/commit/0add6e95e58633fde2fff0bccaf6c7d71ebc130f"}], "stats": {"total": 36, "additions": 31, "deletions": 5}, "files": [{"sha": "ad647d045c77ae3f5f2b45ddcbc2d12825d97b7c", "filename": ".github/workflows/release.yaml", "status": "modified", "additions": 31, "deletions": 5, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/2d9c14afb5a9b99721c978529fd20f3be4ac1146/.github%2Fworkflows%2Frelease.yaml", "raw_url": "https://github.com/rust-lang/rust/raw/2d9c14afb5a9b99721c978529fd20f3be4ac1146/.github%2Fworkflows%2Frelease.yaml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.github%2Fworkflows%2Frelease.yaml?ref=2d9c14afb5a9b99721c978529fd20f3be4ac1146", "patch": "@@ -100,14 +100,25 @@ jobs:\n       - run: npm ci\n         working-directory: editors/code\n \n-      - run: npx vsce package -o \"../../dist/rust-analyzer-${{ matrix.code-target }}.vsix\" --target ${{ matrix.code-target }}\n+      - name: Package Extension (release)\n+        if: github.ref == 'refs/heads/release'\n+        run: npx vsce package -o \"../../dist/rust-analyzer-${{ matrix.code-target }}.vsix\" --target ${{ matrix.code-target }}\n+        working-directory: editors/code\n+\n+      - name: Package Extension (nightly)\n+        if: github.ref != 'refs/heads/release'\n+        run: npx vsce package -o \"../../dist/rust-analyzer-${{ matrix.code-target }}.vsix\" --target ${{ matrix.code-target }} --pre-release\n         working-directory: editors/code\n \n       - if: matrix.target == 'x86_64-unknown-linux-gnu'\n         run: rm -rf editors/code/server\n \n-      - if: matrix.target == 'x86_64-unknown-linux-gnu'\n-        run: npx vsce package -o ../../dist/rust-analyzer.vsix\n+      - if: matrix.target == 'x86_64-unknown-linux-gnu' && github.ref == 'refs/heads/release'\n+        run: npx vsce package -o ../../dist/rust-analyzer-no-server.vsix\n+        working-directory: editors/code\n+\n+      - if: matrix.target == 'x86_64-unknown-linux-gnu' && github.ref != 'refs/heads/release'\n+        run: npx vsce package -o ../../dist/rust-analyzer-no-server.vsix --pre-release\n         working-directory: editors/code\n \n       - name: Run analysis-stats on rust-analyzer\n@@ -151,7 +162,14 @@ jobs:\n       - run: npm ci\n         working-directory: editors/code\n \n-      - run: npx vsce package -o \"../../dist/rust-analyzer-alpine-x64.vsix\" --target alpine-x64\n+      - name: Publish Extension (release)\n+        if: github.ref == 'refs/heads/release'\n+        run: npx vsce package -o \"../../dist/rust-analyzer-alpine-x64.vsix\" --target alpine-x64\n+        working-directory: editors/code\n+\n+      - name: Publish Extension (nightly)\n+        if: github.ref != 'refs/heads/release'\n+        run: npx vsce package -o \"../../dist/rust-analyzer-alpine-x64.vsix\" --target alpine-x64 --pre-release\n         working-directory: editors/code\n \n       - run: rm -rf editors/code/server\n@@ -223,11 +241,19 @@ jobs:\n           name: ${{ env.TAG }}\n           token: ${{ secrets.GITHUB_TOKEN }}\n \n+      - run: rm dist/rust-analyzer-no-server.vsix\n+\n       - run: npm ci\n         working-directory: ./editors/code\n \n-      - name: Publish Extension\n+      - name: Publish Extension (release)\n         if: github.ref == 'refs/heads/release'\n         working-directory: ./editors/code\n         # token from https://dev.azure.com/rust-analyzer/\n         run: npx vsce publish --pat ${{ secrets.MARKETPLACE_TOKEN }} --packagePath ../../dist/rust-analyzer-*.vsix\n+\n+      - name: Publish Extension (nightly)\n+        # check specifically for nightly in case someone triggers a release on a feature branch\n+        if: github.ref == 'refs/heads/nightly'\n+        working-directory: ./editors/code\n+        run: npx vsce publish --pat ${{ secrets.MARKETPLACE_TOKEN }} --packagePath ../../dist/rust-analyzer-*.vsix --pre-release"}]}