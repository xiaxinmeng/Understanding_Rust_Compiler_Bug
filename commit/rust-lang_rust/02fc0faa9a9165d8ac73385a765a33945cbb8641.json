{"sha": "02fc0faa9a9165d8ac73385a765a33945cbb8641", "node_id": "C_kwDOAAsO6NoAKDAyZmMwZmFhOWE5MTY1ZDhhYzczMzg1YTc2NWEzMzk0NWNiYjg2NDE", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-08-09T22:00:23Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-08-09T22:00:23Z"}, "message": "Rollup merge of #98775 - notriddle:notriddle/mobile-sidebar-scroll-lock, r=jsha\n\nrustdoc: improve scroll locking in the rustdoc mobile sidebars\n\nThis PR prevents the main content area from scrolling while the mobile sidebar is open on documentation pages (porting the scroll locking behavior from the source sidebar to the regular sidebar), and also fixes some bad behavior where opening a \"mobile\" sidebar, and growing the viewport so that the \"desktop\" mode without scroll locking is activated, could potentially leave the page stuck.\n\nThis does not affect the behavior on larger screens. Only small ones, where the sidebar covers up the main content.\n\nSplit out from #98772", "tree": {"sha": "ddfcc8ea77243ba24c0d1ebdb75809544e977fc4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ddfcc8ea77243ba24c0d1ebdb75809544e977fc4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/02fc0faa9a9165d8ac73385a765a33945cbb8641", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJi8tj3CRBK7hj4Ov3rIwAAENAIAFoRrWWsBDOrOfa9U1EckLnL\naGExiANFNp2w0sLUOwTfASmrYz0SsgoljioPJ5TDOLdgP2eA67FwyropaIbnF7XG\nOgzSxj2feZfvqm0Myt/Sk3X8B9AQso9udsTGUff1BD+3738VqNkY5xW93TmBJrxK\nPEzqxCOaqYf8qsifBwwS428CyvUggwSndlV2WgQyNU7GZUlvOABCdI3aV7/N8sHP\niV7klVNVvhPMg3DMi1PjaYaPJ8xJ2enw9HcEgGXUqR0Ssv13HRlqqUdqhPPxLadi\nPJIqUThuwNrHOm2hC6oyVhJwwJzyd1egiL/rVxrAX2j3UgZqGkctOBWgVLifTrg=\n=bNEQ\n-----END PGP SIGNATURE-----\n", "payload": "tree ddfcc8ea77243ba24c0d1ebdb75809544e977fc4\nparent 63e4312e6bd50ec9859c363402209809fb8155d5\nparent 6b60bc64087e130f30e3bc095a3ef9e0c1790fef\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1660082423 +0200\ncommitter GitHub <noreply@github.com> 1660082423 +0200\n\nRollup merge of #98775 - notriddle:notriddle/mobile-sidebar-scroll-lock, r=jsha\n\nrustdoc: improve scroll locking in the rustdoc mobile sidebars\n\nThis PR prevents the main content area from scrolling while the mobile sidebar is open on documentation pages (porting the scroll locking behavior from the source sidebar to the regular sidebar), and also fixes some bad behavior where opening a \"mobile\" sidebar, and growing the viewport so that the \"desktop\" mode without scroll locking is activated, could potentially leave the page stuck.\n\nThis does not affect the behavior on larger screens. Only small ones, where the sidebar covers up the main content.\n\nSplit out from #98772\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/02fc0faa9a9165d8ac73385a765a33945cbb8641", "html_url": "https://github.com/rust-lang/rust/commit/02fc0faa9a9165d8ac73385a765a33945cbb8641", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/02fc0faa9a9165d8ac73385a765a33945cbb8641/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "63e4312e6bd50ec9859c363402209809fb8155d5", "url": "https://api.github.com/repos/rust-lang/rust/commits/63e4312e6bd50ec9859c363402209809fb8155d5", "html_url": "https://github.com/rust-lang/rust/commit/63e4312e6bd50ec9859c363402209809fb8155d5"}, {"sha": "6b60bc64087e130f30e3bc095a3ef9e0c1790fef", "url": "https://api.github.com/repos/rust-lang/rust/commits/6b60bc64087e130f30e3bc095a3ef9e0c1790fef", "html_url": "https://github.com/rust-lang/rust/commit/6b60bc64087e130f30e3bc095a3ef9e0c1790fef"}], "stats": {"total": 108, "additions": 101, "deletions": 7}, "files": [{"sha": "d5f9ee5724fe38aecf2fc16d7a7ca10d9504feb3", "filename": "src/librustdoc/html/static/js/main.js", "status": "modified", "additions": 42, "deletions": 4, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/02fc0faa9a9165d8ac73385a765a33945cbb8641/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fmain.js", "raw_url": "https://github.com/rust-lang/rust/raw/02fc0faa9a9165d8ac73385a765a33945cbb8641/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fmain.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fmain.js?ref=02fc0faa9a9165d8ac73385a765a33945cbb8641", "patch": "@@ -348,8 +348,7 @@ function loadCss(cssFileName) {\n \n     function onHashChange(ev) {\n         // If we're in mobile mode, we should hide the sidebar in any case.\n-        const sidebar = document.getElementsByClassName(\"sidebar\")[0];\n-        removeClass(sidebar, \"shown\");\n+        hideSidebar();\n         handleHashes(ev);\n     }\n \n@@ -728,11 +727,50 @@ function loadCss(cssFileName) {\n         });\n     }());\n \n+    let oldSidebarScrollPosition = null;\n+\n+    function showSidebar() {\n+        if (window.innerWidth < window.RUSTDOC_MOBILE_BREAKPOINT) {\n+            // This is to keep the scroll position on mobile.\n+            oldSidebarScrollPosition = window.scrollY;\n+            document.body.style.width = `${document.body.offsetWidth}px`;\n+            document.body.style.position = \"fixed\";\n+            document.body.style.top = `-${oldSidebarScrollPosition}px`;\n+            document.querySelector(\".mobile-topbar\").style.top = `${oldSidebarScrollPosition}px`;\n+            document.querySelector(\".mobile-topbar\").style.position = \"relative\";\n+        } else {\n+            oldSidebarScrollPosition = null;\n+        }\n+        const sidebar = document.getElementsByClassName(\"sidebar\")[0];\n+        addClass(sidebar, \"shown\");\n+    }\n+\n     function hideSidebar() {\n+        if (oldSidebarScrollPosition !== null) {\n+            // This is to keep the scroll position on mobile.\n+            document.body.style.width = \"\";\n+            document.body.style.position = \"\";\n+            document.body.style.top = \"\";\n+            document.querySelector(\".mobile-topbar\").style.top = \"\";\n+            document.querySelector(\".mobile-topbar\").style.position = \"\";\n+            // The scroll position is lost when resetting the style, hence why we store it in\n+            // `oldSidebarScrollPosition`.\n+            window.scrollTo(0, oldSidebarScrollPosition);\n+            oldSidebarScrollPosition = null;\n+        }\n         const sidebar = document.getElementsByClassName(\"sidebar\")[0];\n         removeClass(sidebar, \"shown\");\n     }\n \n+    window.addEventListener(\"resize\", () => {\n+        if (window.innerWidth >= window.RUSTDOC_MOBILE_BREAKPOINT &&\n+            oldSidebarScrollPosition !== null) {\n+            // If the user opens the sidebar in \"mobile\" mode, and then grows the browser window,\n+            // we need to switch away from mobile mode and make the main content area scrollable.\n+            hideSidebar();\n+        }\n+    });\n+\n     function handleClick(id, f) {\n         const elem = document.getElementById(id);\n         if (elem) {\n@@ -775,9 +813,9 @@ function loadCss(cssFileName) {\n         sidebar_menu_toggle.addEventListener(\"click\", () => {\n             const sidebar = document.getElementsByClassName(\"sidebar\")[0];\n             if (!hasClass(sidebar, \"shown\")) {\n-                addClass(sidebar, \"shown\");\n+                showSidebar();\n             } else {\n-                removeClass(sidebar, \"shown\");\n+                hideSidebar();\n             }\n         });\n     }"}, {"sha": "06d15d9e5ffea9ad239ad69ee5f8f50fefe302df", "filename": "src/librustdoc/html/static/js/source-script.js", "status": "modified", "additions": 17, "deletions": 3, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/02fc0faa9a9165d8ac73385a765a33945cbb8641/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsource-script.js", "raw_url": "https://github.com/rust-lang/rust/raw/02fc0faa9a9165d8ac73385a765a33945cbb8641/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsource-script.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsource-script.js?ref=02fc0faa9a9165d8ac73385a765a33945cbb8641", "patch": "@@ -10,7 +10,7 @@\n (function() {\n \n const rootPath = document.getElementById(\"rustdoc-vars\").attributes[\"data-root-path\"].value;\n-let oldScrollPosition = 0;\n+let oldScrollPosition = null;\n \n const NAME_OFFSET = 0;\n const DIRS_OFFSET = 1;\n@@ -75,25 +75,39 @@ function toggleSidebar() {\n             oldScrollPosition = window.scrollY;\n             document.body.style.position = \"fixed\";\n             document.body.style.top = `-${oldScrollPosition}px`;\n+        } else {\n+            oldScrollPosition = null;\n         }\n         addClass(document.documentElement, \"source-sidebar-expanded\");\n         child.innerText = \"<\";\n         updateLocalStorage(\"source-sidebar-show\", \"true\");\n     } else {\n-        if (window.innerWidth < window.RUSTDOC_MOBILE_BREAKPOINT) {\n+        if (window.innerWidth < window.RUSTDOC_MOBILE_BREAKPOINT && oldScrollPosition !== null) {\n             // This is to keep the scroll position on mobile.\n             document.body.style.position = \"\";\n             document.body.style.top = \"\";\n             // The scroll position is lost when resetting the style, hence why we store it in\n-            // `oldScroll`.\n+            // `oldScrollPosition`.\n             window.scrollTo(0, oldScrollPosition);\n+            oldScrollPosition = null;\n         }\n         removeClass(document.documentElement, \"source-sidebar-expanded\");\n         child.innerText = \">\";\n         updateLocalStorage(\"source-sidebar-show\", \"false\");\n     }\n }\n \n+window.addEventListener(\"resize\", () => {\n+    if (window.innerWidth >= window.RUSTDOC_MOBILE_BREAKPOINT && oldScrollPosition !== null) {\n+        // If the user opens the sidebar in \"mobile\" mode, and then grows the browser window,\n+        // we need to switch away from mobile mode and make the main content area scrollable.\n+        document.body.style.position = \"\";\n+        document.body.style.top = \"\";\n+        window.scrollTo(0, oldScrollPosition);\n+        oldScrollPosition = null;\n+    }\n+});\n+\n function createSidebarToggle() {\n     const sidebarToggle = document.createElement(\"div\");\n     sidebarToggle.id = \"sidebar-toggle\";"}, {"sha": "b3bcea253388f0c00c955d9907c1d13f792aaf81", "filename": "src/test/rustdoc-gui/sidebar-mobile-scroll.goml", "status": "added", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/02fc0faa9a9165d8ac73385a765a33945cbb8641/src%2Ftest%2Frustdoc-gui%2Fsidebar-mobile-scroll.goml", "raw_url": "https://github.com/rust-lang/rust/raw/02fc0faa9a9165d8ac73385a765a33945cbb8641/src%2Ftest%2Frustdoc-gui%2Fsidebar-mobile-scroll.goml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-gui%2Fsidebar-mobile-scroll.goml?ref=02fc0faa9a9165d8ac73385a765a33945cbb8641", "patch": "@@ -0,0 +1,31 @@\n+// This test ensures that the mobile sidebar preserves scroll position.\n+goto: file://|DOC_PATH|/test_docs/struct.Foo.html\n+// Switching to \"mobile view\" by reducing the width to 600px.\n+size: (600, 600)\n+assert-css: (\".sidebar\", {\"display\": \"block\", \"left\": \"-1000px\"})\n+\n+// Scroll down.\n+scroll-to: \"//h2[@id='blanket-implementations']\"\n+assert-window-property: {\"pageYOffset\": \"702\"}\n+\n+// Open the sidebar menu.\n+click: \".sidebar-menu-toggle\"\n+wait-for-css: (\".sidebar\", {\"left\": \"0px\"})\n+\n+// We are no longer \"scrolled\". It's important that the user can't\n+// scroll the body at all, but these test scripts are run only in Chrome,\n+// and we need to use a more complicated solution to this problem because\n+// of Mobile Safari...\n+assert-window-property: {\"pageYOffset\": \"0\"}\n+\n+// Close the sidebar menu. Make sure the scroll position gets restored.\n+click: \".sidebar-menu-toggle\"\n+wait-for-css: (\".sidebar\", {\"left\": \"-1000px\"})\n+assert-window-property: {\"pageYOffset\": \"702\"}\n+\n+// Now test that scrollability returns when the browser window is just resized.\n+click: \".sidebar-menu-toggle\"\n+wait-for-css: (\".sidebar\", {\"left\": \"0px\"})\n+assert-window-property: {\"pageYOffset\": \"0\"}\n+size: (900, 900)\n+assert-window-property: {\"pageYOffset\": \"702\"}"}, {"sha": "e4662a10ed5da5c4c5c5789eda530d7cf808489a", "filename": "src/test/rustdoc-gui/sidebar-source-code-display.goml", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/02fc0faa9a9165d8ac73385a765a33945cbb8641/src%2Ftest%2Frustdoc-gui%2Fsidebar-source-code-display.goml", "raw_url": "https://github.com/rust-lang/rust/raw/02fc0faa9a9165d8ac73385a765a33945cbb8641/src%2Ftest%2Frustdoc-gui%2Fsidebar-source-code-display.goml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-gui%2Fsidebar-source-code-display.goml?ref=02fc0faa9a9165d8ac73385a765a33945cbb8641", "patch": "@@ -233,6 +233,17 @@ wait-for-css: (\".sidebar\", {\"width\": \"0px\"})\n // The \"scrollTop\" property should be the same.\n assert-window-property: {\"pageYOffset\": \"2519\"}\n \n+// We now check that the scroll position is restored if the window is resized.\n+size: (500, 700)\n+click: \"#sidebar-toggle\"\n+wait-for-css: (\"#source-sidebar\", {\"visibility\": \"visible\"})\n+assert-window-property: {\"pageYOffset\": \"0\"}\n+size: (900, 900)\n+assert-window-property: {\"pageYOffset\": \"2519\"}\n+size: (500, 700)\n+click: \"#sidebar-toggle\"\n+wait-for-css: (\"#source-sidebar\", {\"visibility\": \"hidden\"})\n+\n // We now check that opening the sidebar and clicking a link will close it.\n // The behavior here on mobile is different than the behavior on desktop,\n // but common sense dictates that if you have a list of files that fills the entire screen, and"}]}