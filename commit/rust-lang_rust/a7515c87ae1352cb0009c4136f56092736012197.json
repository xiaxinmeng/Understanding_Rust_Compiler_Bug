{"sha": "a7515c87ae1352cb0009c4136f56092736012197", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE3NTE1Yzg3YWUxMzUyY2IwMDA5YzQxMzZmNTYwOTI3MzYwMTIxOTc=", "commit": {"author": {"name": "Lindsey Kuper", "email": "lindsey@composition.al", "date": "2013-09-16T04:52:36Z"}, "committer": {"name": "Lindsey Kuper", "email": "lindsey@composition.al", "date": "2013-09-16T05:21:00Z"}, "message": "Have workcache::test put `foo.c` in the same directory it runs in.\n\nThis prevents a stray `foo.c` from being left lying around after tests\nrun, and it's more consistent with the rest of the code.", "tree": {"sha": "bcf30791a971b29eb5d0ca12e104e84b5f87a3dc", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bcf30791a971b29eb5d0ca12e104e84b5f87a3dc"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a7515c87ae1352cb0009c4136f56092736012197", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a7515c87ae1352cb0009c4136f56092736012197", "html_url": "https://github.com/rust-lang/rust/commit/a7515c87ae1352cb0009c4136f56092736012197", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a7515c87ae1352cb0009c4136f56092736012197/comments", "author": {"login": "lkuper", "id": 535218, "node_id": "MDQ6VXNlcjUzNTIxOA==", "avatar_url": "https://avatars.githubusercontent.com/u/535218?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lkuper", "html_url": "https://github.com/lkuper", "followers_url": "https://api.github.com/users/lkuper/followers", "following_url": "https://api.github.com/users/lkuper/following{/other_user}", "gists_url": "https://api.github.com/users/lkuper/gists{/gist_id}", "starred_url": "https://api.github.com/users/lkuper/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lkuper/subscriptions", "organizations_url": "https://api.github.com/users/lkuper/orgs", "repos_url": "https://api.github.com/users/lkuper/repos", "events_url": "https://api.github.com/users/lkuper/events{/privacy}", "received_events_url": "https://api.github.com/users/lkuper/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lkuper", "id": 535218, "node_id": "MDQ6VXNlcjUzNTIxOA==", "avatar_url": "https://avatars.githubusercontent.com/u/535218?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lkuper", "html_url": "https://github.com/lkuper", "followers_url": "https://api.github.com/users/lkuper/followers", "following_url": "https://api.github.com/users/lkuper/following{/other_user}", "gists_url": "https://api.github.com/users/lkuper/gists{/gist_id}", "starred_url": "https://api.github.com/users/lkuper/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lkuper/subscriptions", "organizations_url": "https://api.github.com/users/lkuper/orgs", "repos_url": "https://api.github.com/users/lkuper/repos", "events_url": "https://api.github.com/users/lkuper/events{/privacy}", "received_events_url": "https://api.github.com/users/lkuper/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2de2fb1c9130496f96941f73042d464aa4514f1c", "url": "https://api.github.com/repos/rust-lang/rust/commits/2de2fb1c9130496f96941f73042d464aa4514f1c", "html_url": "https://github.com/rust-lang/rust/commit/2de2fb1c9130496f96941f73042d464aa4514f1c"}], "stats": {"total": 23, "additions": 16, "deletions": 7}, "files": [{"sha": "2b2ecb79294c456b68782631c28b498cd4efe573", "filename": "src/libextra/workcache.rs", "status": "modified", "additions": 16, "deletions": 7, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/a7515c87ae1352cb0009c4136f56092736012197/src%2Flibextra%2Fworkcache.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a7515c87ae1352cb0009c4136f56092736012197/src%2Flibextra%2Fworkcache.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibextra%2Fworkcache.rs?ref=a7515c87ae1352cb0009c4136f56092736012197", "patch": "@@ -496,16 +496,23 @@ fn test() {\n     use std::io::WriterUtil;\n     use std::{os, run};\n \n-    let pth = Path(\"foo.c\");\n+    // Create a path to a new file 'filename' in the directory in which\n+    // this test is running.\n+    fn make_path(filename: ~str) -> Path {\n+        let pth = os::self_exe_path().expect(\"workcache::test failed\").pop().push(filename);\n+        if os::path_exists(&pth) {\n+            os::remove_file(&pth);\n+        }\n+        return pth;\n+    }\n+\n+    let pth = make_path(~\"foo.c\");\n     {\n         let r = io::file_writer(&pth, [io::Create]);\n         r.unwrap().write_str(\"int main() { return 0; }\");\n     }\n \n-    let db_path = os::self_exe_path().expect(\"workcache::test failed\").pop().push(\"db.json\");\n-    if os::path_exists(&db_path) {\n-        os::remove_file(&db_path);\n-    }\n+    let db_path = make_path(~\"db.json\");\n \n     let cx = Context::new(RWArc::new(Database::new(db_path)),\n                           RWArc::new(Logger::new()),\n@@ -514,17 +521,19 @@ fn test() {\n     let s = do cx.with_prep(\"test1\") |prep| {\n \n         let subcx = cx.clone();\n+        let pth = pth.clone();\n \n         prep.declare_input(\"file\", pth.to_str(), digest_file(&pth));\n         do prep.exec |_exe| {\n-            let out = Path(\"foo.o\");\n-            run::process_status(\"gcc\", [~\"foo.c\", ~\"-o\", out.to_str()]);\n+            let out = make_path(~\"foo.o\");\n+            run::process_status(\"gcc\", [pth.to_str(), ~\"-o\", out.to_str()]);\n \n             let _proof_of_concept = subcx.prep(\"subfn\");\n             // Could run sub-rules inside here.\n \n             out.to_str()\n         }\n     };\n+\n     io::println(s);\n }"}]}