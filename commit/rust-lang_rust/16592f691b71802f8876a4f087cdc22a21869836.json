{"sha": "16592f691b71802f8876a4f087cdc22a21869836", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE2NTkyZjY5MWI3MTgwMmY4ODc2YTRmMDg3Y2RjMjJhMjE4Njk4MzY=", "commit": {"author": {"name": "David Wood", "email": "david@davidtw.co", "date": "2019-04-10T21:26:45Z"}, "committer": {"name": "David Wood", "email": "david@davidtw.co", "date": "2019-04-10T21:52:01Z"}, "message": "Suggest removing `?` to resolve type errors.\n\nThis commit adds a suggestion to remove the `?` from expressions if\nremoving the `?` would resolve a type error.", "tree": {"sha": "0499d27fb91227a0a7e370140e5f09916e6b9e24", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0499d27fb91227a0a7e370140e5f09916e6b9e24"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/16592f691b71802f8876a4f087cdc22a21869836", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEWwgxPGhT5b/6kagXAXYLT59T8VQFAlyuZYEACgkQAXYLT59T\n8VR59w/7B4DqU8Lb0CR8bFc1K3rORh6po1ME8Lw+njoLwSrl8JEPIjEuLzlJiJB9\nn57sZ+JhSQazeJY1eMAeKy1+cJqYQduTZxSMdsuMworKGal1z62UB4nfDAnllllp\nLp27l2acMUunW2kcWR7xq7nh0QnTbmDXx0ogRMGMctnOWZhGky9mf81yzZ1DPcSp\n0fLj3ePsqNsNn/w14zr1cpxBtU/WlzBX2LCvHx5EaLnsjVa7VrzbyhOH8klQ8R+L\nuC6LfT6qMOoOv6/l+kUyzChITwfZL6Fv1OpMtAWBgm0ZMLHgzqX9TdDHGsq6d/R4\naJKJJ5XsMPgcN/vrjK1iq6kT4k5sZALdkRJXFqkn4+li68l9R1ux1innIC/4Tdwp\nENaXA9J7BhBcWcERvGiSq4Yt4Hkn9Nm3QTE21b9jAFK13ZxT6pSOMC6R/AkPVKCU\n+8Kx0TFX1tP0a3qhf/hX/CmMbhWJUOjQw2HI57rkvmO8FrYYdHYkk5w4fEd4Ob9X\n4EqMtqpPCLIaqeyy4ak3W57f+V67x3mVG4RDl2fL3jRmEagPpXoUC7lmUUrNdrkP\nXLkJByHh1UyJi3hKeH7Ny/oZ7LBV2FQsSIOchFQ2DMdMFiEkdN0yk9V1tZSA2tG+\nEJEwFxnAo6+0v+3o4tL3okp4bBUU20WkKqCK3ILpQ7CwIFWzMJk=\n=NbZn\n-----END PGP SIGNATURE-----", "payload": "tree 0499d27fb91227a0a7e370140e5f09916e6b9e24\nparent 77bdb354bfe1a26ba90b2889702e647c3d9c8d7e\nauthor David Wood <david@davidtw.co> 1554931605 +0200\ncommitter David Wood <david@davidtw.co> 1554933121 +0200\n\nSuggest removing `?` to resolve type errors.\n\nThis commit adds a suggestion to remove the `?` from expressions if\nremoving the `?` would resolve a type error.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/16592f691b71802f8876a4f087cdc22a21869836", "html_url": "https://github.com/rust-lang/rust/commit/16592f691b71802f8876a4f087cdc22a21869836", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/16592f691b71802f8876a4f087cdc22a21869836/comments", "author": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "committer": {"login": "davidtwco", "id": 1295100, "node_id": "MDQ6VXNlcjEyOTUxMDA=", "avatar_url": "https://avatars.githubusercontent.com/u/1295100?v=4", "gravatar_id": "", "url": "https://api.github.com/users/davidtwco", "html_url": "https://github.com/davidtwco", "followers_url": "https://api.github.com/users/davidtwco/followers", "following_url": "https://api.github.com/users/davidtwco/following{/other_user}", "gists_url": "https://api.github.com/users/davidtwco/gists{/gist_id}", "starred_url": "https://api.github.com/users/davidtwco/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/davidtwco/subscriptions", "organizations_url": "https://api.github.com/users/davidtwco/orgs", "repos_url": "https://api.github.com/users/davidtwco/repos", "events_url": "https://api.github.com/users/davidtwco/events{/privacy}", "received_events_url": "https://api.github.com/users/davidtwco/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "77bdb354bfe1a26ba90b2889702e647c3d9c8d7e", "url": "https://api.github.com/repos/rust-lang/rust/commits/77bdb354bfe1a26ba90b2889702e647c3d9c8d7e", "html_url": "https://github.com/rust-lang/rust/commit/77bdb354bfe1a26ba90b2889702e647c3d9c8d7e"}], "stats": {"total": 63, "additions": 59, "deletions": 4}, "files": [{"sha": "9c899fab59ef140367dc4b683ecea45820fae988", "filename": "src/librustc/infer/error_reporting/mod.rs", "status": "modified", "additions": 27, "deletions": 1, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/16592f691b71802f8876a4f087cdc22a21869836/src%2Flibrustc%2Finfer%2Ferror_reporting%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/16592f691b71802f8876a4f087cdc22a21869836/src%2Flibrustc%2Finfer%2Ferror_reporting%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Finfer%2Ferror_reporting%2Fmod.rs?ref=16592f691b71802f8876a4f087cdc22a21869836", "patch": "@@ -604,13 +604,39 @@ impl<'a, 'gcx, 'tcx> InferCtxt<'a, 'gcx, 'tcx> {\n                 source,\n                 ref prior_arms,\n                 last_ty,\n+                discrim_hir_id,\n                 ..\n             } => match source {\n                 hir::MatchSource::IfLetDesugar { .. } => {\n                     let msg = \"`if let` arms have incompatible types\";\n                     err.span_label(cause.span, msg);\n                 }\n-                hir::MatchSource::TryDesugar => {}\n+                hir::MatchSource::TryDesugar => {\n+                    if let Some(ty::error::ExpectedFound { expected, .. }) = exp_found {\n+                        let discrim_expr = self.tcx.hir().expect_expr_by_hir_id(discrim_hir_id);\n+                        let discrim_ty = if let hir::ExprKind::Call(_, args) = &discrim_expr.node {\n+                            let arg_expr = args.first().expect(\"try desugaring call w/out arg\");\n+                            self.in_progress_tables.and_then(|tables| {\n+                                tables.borrow().expr_ty_opt(arg_expr)\n+                            })\n+                        } else {\n+                            bug!(\"try desugaring w/out call expr as discriminant\");\n+                        };\n+\n+                        match discrim_ty {\n+                            Some(ty) if expected == ty => {\n+                                let source_map = self.tcx.sess.source_map();\n+                                err.span_suggestion(\n+                                    source_map.end_point(cause.span),\n+                                    \"try removing this `?`\",\n+                                    \"\".to_string(),\n+                                    Applicability::MachineApplicable,\n+                                );\n+                            },\n+                            _ => {},\n+                        }\n+                    }\n+                }\n                 _ => {\n                     let msg = \"`match` arms have incompatible types\";\n                     err.span_label(cause.span, msg);"}, {"sha": "ddca18ce76572ff944b227ed4783538a4ebf11df", "filename": "src/librustc/traits/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/16592f691b71802f8876a4f087cdc22a21869836/src%2Flibrustc%2Ftraits%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/16592f691b71802f8876a4f087cdc22a21869836/src%2Flibrustc%2Ftraits%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ftraits%2Fmod.rs?ref=16592f691b71802f8876a4f087cdc22a21869836", "patch": "@@ -227,6 +227,7 @@ pub enum ObligationCauseCode<'tcx> {\n         source: hir::MatchSource,\n         prior_arms: Vec<Span>,\n         last_ty: Ty<'tcx>,\n+        discrim_hir_id: hir::HirId,\n     },\n \n     /// Computing common supertype in the pattern guard for the arms of a match expression"}, {"sha": "0711f3539e586bac6bf8089c183a970b1c294f22", "filename": "src/librustc/traits/structural_impls.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/16592f691b71802f8876a4f087cdc22a21869836/src%2Flibrustc%2Ftraits%2Fstructural_impls.rs", "raw_url": "https://github.com/rust-lang/rust/raw/16592f691b71802f8876a4f087cdc22a21869836/src%2Flibrustc%2Ftraits%2Fstructural_impls.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Ftraits%2Fstructural_impls.rs?ref=16592f691b71802f8876a4f087cdc22a21869836", "patch": "@@ -519,13 +519,15 @@ impl<'a, 'tcx> Lift<'tcx> for traits::ObligationCauseCode<'a> {\n                 source,\n                 ref prior_arms,\n                 last_ty,\n+                discrim_hir_id,\n             } => {\n                 tcx.lift(&last_ty).map(|last_ty| {\n                     super::MatchExpressionArm {\n                         arm_span,\n                         source,\n                         prior_arms: prior_arms.clone(),\n                         last_ty,\n+                        discrim_hir_id,\n                     }\n                 })\n             }"}, {"sha": "032821e6d42f258a69bd5d395c5f1d6bd37fa5fb", "filename": "src/librustc_typeck/check/_match.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/16592f691b71802f8876a4f087cdc22a21869836/src%2Flibrustc_typeck%2Fcheck%2F_match.rs", "raw_url": "https://github.com/rust-lang/rust/raw/16592f691b71802f8876a4f087cdc22a21869836/src%2Flibrustc_typeck%2Fcheck%2F_match.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2F_match.rs?ref=16592f691b71802f8876a4f087cdc22a21869836", "patch": "@@ -732,6 +732,7 @@ https://doc.rust-lang.org/reference/types.html#trait-objects\");\n                         source: match_src,\n                         prior_arms: other_arms.clone(),\n                         last_ty: prior_arm_ty.unwrap(),\n+                        discrim_hir_id: discrim.hir_id,\n                     })\n                 };\n                 coercion.coerce(self, &cause, &arm.body, arm_ty);"}, {"sha": "7b55d0f17e690f18e7a55b272000fe20512adc7a", "filename": "src/test/ui/issue-59756.fixed", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/16592f691b71802f8876a4f087cdc22a21869836/src%2Ftest%2Fui%2Fissue-59756.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/16592f691b71802f8876a4f087cdc22a21869836/src%2Ftest%2Fui%2Fissue-59756.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissue-59756.fixed?ref=16592f691b71802f8876a4f087cdc22a21869836", "patch": "@@ -0,0 +1,17 @@\n+// run-rustfix\n+\n+#![allow(warnings)]\n+\n+struct A;\n+struct B;\n+\n+fn foo() -> Result<A, B> {\n+    Ok(A)\n+}\n+\n+fn bar() -> Result<A, B> {\n+    foo()\n+    //~^ ERROR try expression alternatives have incompatible types [E0308]\n+}\n+\n+fn main() {}"}, {"sha": "cccae396b721015a5f07a951c3acbe85389621e5", "filename": "src/test/ui/issue-59756.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/16592f691b71802f8876a4f087cdc22a21869836/src%2Ftest%2Fui%2Fissue-59756.rs", "raw_url": "https://github.com/rust-lang/rust/raw/16592f691b71802f8876a4f087cdc22a21869836/src%2Ftest%2Fui%2Fissue-59756.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissue-59756.rs?ref=16592f691b71802f8876a4f087cdc22a21869836", "patch": "@@ -1,3 +1,5 @@\n+// run-rustfix\n+\n #![allow(warnings)]\n \n struct A;"}, {"sha": "d46232874fd2a08062f4e930f5befc9263362779", "filename": "src/test/ui/issue-59756.stderr", "status": "modified", "additions": 5, "deletions": 2, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/16592f691b71802f8876a4f087cdc22a21869836/src%2Ftest%2Fui%2Fissue-59756.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/16592f691b71802f8876a4f087cdc22a21869836/src%2Ftest%2Fui%2Fissue-59756.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissue-59756.stderr?ref=16592f691b71802f8876a4f087cdc22a21869836", "patch": "@@ -1,8 +1,11 @@\n error[E0308]: try expression alternatives have incompatible types\n-  --> $DIR/issue-59756.rs:11:5\n+  --> $DIR/issue-59756.rs:13:5\n    |\n LL |     foo()?\n-   |     ^^^^^^ expected enum `std::result::Result`, found struct `A`\n+   |     ^^^^^-\n+   |     |    |\n+   |     |    help: try removing this `?`\n+   |     expected enum `std::result::Result`, found struct `A`\n    |\n    = note: expected type `std::result::Result<A, B>`\n               found type `A`"}, {"sha": "bf45357147916d0097d774e02a1546a906d6e457", "filename": "src/test/ui/issues/issue-51632-try-desugar-incompatible-types.stderr", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/16592f691b71802f8876a4f087cdc22a21869836/src%2Ftest%2Fui%2Fissues%2Fissue-51632-try-desugar-incompatible-types.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/16592f691b71802f8876a4f087cdc22a21869836/src%2Ftest%2Fui%2Fissues%2Fissue-51632-try-desugar-incompatible-types.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-51632-try-desugar-incompatible-types.stderr?ref=16592f691b71802f8876a4f087cdc22a21869836", "patch": "@@ -2,7 +2,10 @@ error[E0308]: try expression alternatives have incompatible types\n   --> $DIR/issue-51632-try-desugar-incompatible-types.rs:8:5\n    |\n LL |     missing_discourses()?\n-   |     ^^^^^^^^^^^^^^^^^^^^^ expected enum `std::result::Result`, found isize\n+   |     ^^^^^^^^^^^^^^^^^^^^-\n+   |     |                   |\n+   |     |                   help: try removing this `?`\n+   |     expected enum `std::result::Result`, found isize\n    |\n    = note: expected type `std::result::Result<isize, ()>`\n               found type `isize`"}]}