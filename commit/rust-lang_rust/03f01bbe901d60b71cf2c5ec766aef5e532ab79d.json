{"sha": "03f01bbe901d60b71cf2c5ec766aef5e532ab79d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjAzZjAxYmJlOTAxZDYwYjcxY2YyYzVlYzc2NmFlZjVlNTMyYWI3OWQ=", "commit": {"author": {"name": "bjorn3", "email": "bjorn3@users.noreply.github.com", "date": "2020-11-02T18:14:50Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-11-02T18:14:50Z"}, "message": "Merge pull request #1105 from bjorn3/test_rustc_bootstrapping\n\nTest bootstrapping of rustc using cg_clif", "tree": {"sha": "f766b683ac06d5d9cc912e1d59a4875693403e3f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f766b683ac06d5d9cc912e1d59a4875693403e3f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/03f01bbe901d60b71cf2c5ec766aef5e532ab79d", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfoEyaCRBK7hj4Ov3rIwAAdHIIADmuaCMYp+AVGGTdgIiUJRZy\njykF7FJHfbXXl/z3sDyUvQzWiXgnja0uz08Ve6QT6+w+WxOlkd+JOJdVQsRUGyxt\nGompxS1lmMfwQgGH+BwysqmzUnOoHbH74WDvsNJ1Ds+T8pbvr5BnEKb2HwERuVwU\nI7peRJE33RRNpXKyBgG9NGAihCR0/fd7HdNuMfAWCnvof9ddHeBJjjEp8ceq4lyN\nq/lKInhhfOiOmJKz7nn68pvjo8l4L6MiGlJShLPJ+NKbr6ccGuCeRyNi2h6eh6qT\ndG3ngo5g4NlRQzZLGDX3UW4s74uZYALvjYcZIMJUP+hXjjsUzy9nfwYnU27MQSY=\n=Lz3Y\n-----END PGP SIGNATURE-----\n", "payload": "tree f766b683ac06d5d9cc912e1d59a4875693403e3f\nparent 646b00ff7710fb9f8a1a6de744f38bdcb1c932d7\nparent 54b1d101efec3da791aee1f98fb26230e88b9a05\nauthor bjorn3 <bjorn3@users.noreply.github.com> 1604340890 +0100\ncommitter GitHub <noreply@github.com> 1604340890 +0100\n\nMerge pull request #1105 from bjorn3/test_rustc_bootstrapping\n\nTest bootstrapping of rustc using cg_clif"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/03f01bbe901d60b71cf2c5ec766aef5e532ab79d", "html_url": "https://github.com/rust-lang/rust/commit/03f01bbe901d60b71cf2c5ec766aef5e532ab79d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/03f01bbe901d60b71cf2c5ec766aef5e532ab79d/comments", "author": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "646b00ff7710fb9f8a1a6de744f38bdcb1c932d7", "url": "https://api.github.com/repos/rust-lang/rust/commits/646b00ff7710fb9f8a1a6de744f38bdcb1c932d7", "html_url": "https://github.com/rust-lang/rust/commit/646b00ff7710fb9f8a1a6de744f38bdcb1c932d7"}, {"sha": "54b1d101efec3da791aee1f98fb26230e88b9a05", "url": "https://api.github.com/repos/rust-lang/rust/commits/54b1d101efec3da791aee1f98fb26230e88b9a05", "html_url": "https://github.com/rust-lang/rust/commit/54b1d101efec3da791aee1f98fb26230e88b9a05"}], "stats": {"total": 121, "additions": 116, "deletions": 5}, "files": [{"sha": "8c94a0aa5e6ebe7beba14d52e5ed817053529f8e", "filename": ".github/workflows/bootstrap_rustc.yml", "status": "added", "additions": 44, "deletions": 0, "changes": 44, "blob_url": "https://github.com/rust-lang/rust/blob/03f01bbe901d60b71cf2c5ec766aef5e532ab79d/.github%2Fworkflows%2Fbootstrap_rustc.yml", "raw_url": "https://github.com/rust-lang/rust/raw/03f01bbe901d60b71cf2c5ec766aef5e532ab79d/.github%2Fworkflows%2Fbootstrap_rustc.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.github%2Fworkflows%2Fbootstrap_rustc.yml?ref=03f01bbe901d60b71cf2c5ec766aef5e532ab79d", "patch": "@@ -0,0 +1,44 @@\n+name: Bootstrap rustc using cg_clif\n+\n+on:\n+  - push\n+\n+jobs:\n+  bootstrap_rustc:\n+    runs-on: ubuntu-latest\n+\n+    steps:\n+    - uses: actions/checkout@v2\n+\n+    - name: Cache cargo installed crates\n+      uses: actions/cache@v2\n+      with:\n+        path: ~/.cargo/bin\n+        key: ${{ runner.os }}-cargo-installed-crates\n+\n+    - name: Cache cargo registry and index\n+      uses: actions/cache@v2\n+      with:\n+        path: |\n+            ~/.cargo/registry\n+            ~/.cargo/git\n+        key: ${{ runner.os }}-cargo-registry-and-index-${{ hashFiles('**/Cargo.lock') }}\n+\n+    - name: Cache cargo target dir\n+      uses: actions/cache@v2\n+      with:\n+        path: target\n+        key: ${{ runner.os }}-cargo-build-target-${{ hashFiles('rust-toolchain', '**/Cargo.lock') }}\n+\n+    - name: Prepare dependencies\n+      run: |\n+        git config --global user.email \"user@example.com\"\n+        git config --global user.name \"User\"\n+        ./prepare.sh\n+\n+    - name: Test\n+      run: |\n+        # Enable backtraces for easier debugging\n+        export RUST_BACKTRACE=1\n+\n+        ./scripts/test_bootstrap.sh"}, {"sha": "7f43f81a6cdcd4aa9f5a539d7c9b50c898f70dce", "filename": "scripts/test_bootstrap.sh", "status": "added", "additions": 65, "deletions": 0, "changes": 65, "blob_url": "https://github.com/rust-lang/rust/blob/03f01bbe901d60b71cf2c5ec766aef5e532ab79d/scripts%2Ftest_bootstrap.sh", "raw_url": "https://github.com/rust-lang/rust/raw/03f01bbe901d60b71cf2c5ec766aef5e532ab79d/scripts%2Ftest_bootstrap.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/scripts%2Ftest_bootstrap.sh?ref=03f01bbe901d60b71cf2c5ec766aef5e532ab79d", "patch": "@@ -0,0 +1,65 @@\n+#!/bin/bash\n+set -e\n+\n+cd $(dirname \"$0\")/../\n+\n+./build.sh\n+source build/config.sh\n+\n+echo \"[TEST] Bootstrap of rustc\"\n+git clone https://github.com/rust-lang/rust.git || true\n+pushd rust\n+git fetch\n+git checkout -- .\n+git checkout $(rustc -V | cut -d' ' -f3 | tr -d '(')\n+\n+git apply - <<EOF\n+diff --git a/.gitmodules b/.gitmodules\n+index 984113151de..c1e9d960d56 100644\n+--- a/.gitmodules\n++++ b/.gitmodules\n+@@ -34,10 +34,6 @@\n+ [submodule \"src/doc/edition-guide\"]\n+ \tpath = src/doc/edition-guide\n+ \turl = https://github.com/rust-lang/edition-guide.git\n+-[submodule \"src/llvm-project\"]\n+-\tpath = src/llvm-project\n+-\turl = https://github.com/rust-lang/llvm-project.git\n+-\tbranch = rustc/11.0-2020-10-12\n+ [submodule \"src/doc/embedded-book\"]\n+ \tpath = src/doc/embedded-book\n+ \turl = https://github.com/rust-embedded/book.git\n+diff --git a/compiler/rustc_data_structures/Cargo.toml b/compiler/rustc_data_structures/Cargo.toml\n+index 23e689fcae7..5f077b765b6 100644\n+--- a/compiler/rustc_data_structures/Cargo.toml\n++++ b/compiler/rustc_data_structures/Cargo.toml\n+@@ -32,7 +32,6 @@ tempfile = \"3.0.5\"\n+\n+ [dependencies.parking_lot]\n+ version = \"0.11\"\n+-features = [\"nightly\"]\n+\n+ [target.'cfg(windows)'.dependencies]\n+ winapi = { version = \"0.3\", features = [\"fileapi\", \"psapi\"] }\n+EOF\n+\n+cat > config.toml <<EOF\n+[llvm]\n+ninja = false\n+\n+[build]\n+rustc = \"$(pwd)/../build/cg_clif\"\n+cargo = \"$(rustup which cargo)\"\n+full-bootstrap = true\n+local-rebuild = true\n+\n+[rust]\n+codegen-backends = [\"cranelift\"]\n+EOF\n+\n+rm -r compiler/rustc_codegen_cranelift/{Cargo.*,src}\n+cp ../Cargo.* compiler/rustc_codegen_cranelift/\n+cp -r ../src compiler/rustc_codegen_cranelift/src\n+\n+./x.py build --stage 1 library/std\n+popd"}, {"sha": "71ef4d2267368467d97492a6e1919298a3762ae8", "filename": "src/bin/cg_clif.rs", "status": "modified", "additions": 7, "deletions": 5, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/03f01bbe901d60b71cf2c5ec766aef5e532ab79d/src%2Fbin%2Fcg_clif.rs", "raw_url": "https://github.com/rust-lang/rust/raw/03f01bbe901d60b71cf2c5ec766aef5e532ab79d/src%2Fbin%2Fcg_clif.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbin%2Fcg_clif.rs?ref=03f01bbe901d60b71cf2c5ec766aef5e532ab79d", "patch": "@@ -27,11 +27,13 @@ impl rustc_driver::Callbacks for CraneliftPassesCallbacks {\n         config.opts.cg.panic = Some(PanicStrategy::Abort);\n         config.opts.debugging_opts.panic_abort_tests = true;\n         config.opts.maybe_sysroot = Some(\n-            std::env::current_exe()\n-                .unwrap()\n-                .parent()\n-                .unwrap()\n-                .join(\"sysroot\"),\n+            config.opts.maybe_sysroot.clone().unwrap_or(\n+                std::env::current_exe()\n+                    .unwrap()\n+                    .parent()\n+                    .unwrap()\n+                    .join(\"sysroot\"),\n+            ),\n         );\n     }\n }"}]}