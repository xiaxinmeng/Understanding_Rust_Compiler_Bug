{"sha": "bc05045a017f94ba6ba3a121a1ddc293f6617693", "node_id": "C_kwDOAAsO6NoAKGJjMDUwNDVhMDE3Zjk0YmE2YmEzYTEyMWExZGRjMjkzZjY2MTc2OTM", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-08-24T16:20:07Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-08-24T16:20:07Z"}, "message": "Rollup merge of #99993 - petrochenkov:linkdated, r=bjorn3\n\nlinker: Update some outdated comments\n\nr? ``@bjorn3``", "tree": {"sha": "2328bfe5ae728559f76262cca630a7ce4eac99f5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2328bfe5ae728559f76262cca630a7ce4eac99f5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/bc05045a017f94ba6ba3a121a1ddc293f6617693", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjBk+3CRBK7hj4Ov3rIwAADhoIAC1h83tt0XjhlSGiuxuvBpdr\nl5WiGmfgeTLAIhA2D2HG62oDWgXhvbF5sBwwWcAwx3WkVXRDscgQa9Sii/v/RE70\nUumZexOrlxpo2uMn0nRJ+JqKtGxwlJ3KdNTe/EYtazfrUhQceN8uEoqBljX0CB5R\nFYFhvmqG1jjfw90JhtJKaunIaF8fCAyawv7wetQvgrM0vjzfIJjfIKQBFR6/qx8S\n7vcBuwLc5U06zMGDPpfMsbpyA4Gu6X24rZULA0o04meMRViHNunhhaWmxzZ6mBjg\n/+z96GvwHhXsBzn3zNthDAeExqBUmOY4L7vLCd/c0ca/B6Z7lr14Zh6L/cb4Xcc=\n=DKNy\n-----END PGP SIGNATURE-----\n", "payload": "tree 2328bfe5ae728559f76262cca630a7ce4eac99f5\nparent 4a24f08ba43166cfee86d868b3fe8612aec6faca\nparent 04a7fefb20629af52d00018ac7013257eb661273\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1661358007 +0200\ncommitter GitHub <noreply@github.com> 1661358007 +0200\n\nRollup merge of #99993 - petrochenkov:linkdated, r=bjorn3\n\nlinker: Update some outdated comments\n\nr? ``@bjorn3``\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/bc05045a017f94ba6ba3a121a1ddc293f6617693", "html_url": "https://github.com/rust-lang/rust/commit/bc05045a017f94ba6ba3a121a1ddc293f6617693", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/bc05045a017f94ba6ba3a121a1ddc293f6617693/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4a24f08ba43166cfee86d868b3fe8612aec6faca", "url": "https://api.github.com/repos/rust-lang/rust/commits/4a24f08ba43166cfee86d868b3fe8612aec6faca", "html_url": "https://github.com/rust-lang/rust/commit/4a24f08ba43166cfee86d868b3fe8612aec6faca"}, {"sha": "04a7fefb20629af52d00018ac7013257eb661273", "url": "https://api.github.com/repos/rust-lang/rust/commits/04a7fefb20629af52d00018ac7013257eb661273", "html_url": "https://github.com/rust-lang/rust/commit/04a7fefb20629af52d00018ac7013257eb661273"}], "stats": {"total": 36, "additions": 18, "deletions": 18}, "files": [{"sha": "d2f2c7bf7988ad84ea14ffd0563c5961fb631c7c", "filename": "compiler/rustc_codegen_ssa/src/back/link.rs", "status": "modified", "additions": 12, "deletions": 12, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/bc05045a017f94ba6ba3a121a1ddc293f6617693/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bc05045a017f94ba6ba3a121a1ddc293f6617693/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs?ref=bc05045a017f94ba6ba3a121a1ddc293f6617693", "patch": "@@ -1958,7 +1958,6 @@ fn linker_with_args<'a>(\n     // Upstream rust libraries are not supposed to depend on our local native\n     // libraries as that would violate the structure of the DAG, in that\n     // scenario they are required to link to them as well in a shared fashion.\n-    // (The current implementation still doesn't prevent it though, see the FIXME below.)\n     //\n     // Note that upstream rust libraries may contain native dependencies as\n     // well, but they also can't depend on what we just started to add to the\n@@ -1979,15 +1978,16 @@ fn linker_with_args<'a>(\n     // and move this option back to the top.\n     cmd.add_as_needed();\n \n-    // FIXME: Move this below to other native libraries\n-    // (or alternatively link all native libraries after their respective crates).\n-    // This change is somewhat breaking in practice due to local static libraries being linked\n-    // as whole-archive (#85144), so removing whole-archive may be a pre-requisite.\n+    // Local native libraries of all kinds.\n+    //\n+    // If `-Zlink-native-libraries=false` is set, then the assumption is that an\n+    // external build system already has the native dependencies defined, and it\n+    // will provide them to the linker itself.\n     if sess.opts.unstable_opts.link_native_libraries {\n         add_local_native_libraries(cmd, sess, codegen_results);\n     }\n \n-    // Upstream rust libraries and their non-bundled static libraries\n+    // Upstream rust libraries and their (possibly bundled) static native libraries.\n     add_upstream_rust_crates(\n         cmd,\n         sess,\n@@ -1997,11 +1997,11 @@ fn linker_with_args<'a>(\n         tmpdir,\n     );\n \n-    // Upstream dynamic native libraries linked with `#[link]` attributes at and `-l`\n-    // command line options.\n-    // If -Zlink-native-libraries=false is set, then the assumption is that an\n-    // external build system already has the native dependencies defined, and it\n-    // will provide them to the linker itself.\n+    // Dynamic native libraries from upstream crates.\n+    //\n+    // FIXME: Merge this to `add_upstream_rust_crates` so that all native libraries are linked\n+    // together with their respective upstream crates, and in their originally specified order.\n+    // This may be slightly breaking due to our use of `--as-needed` and needs a crater run.\n     if sess.opts.unstable_opts.link_native_libraries {\n         add_upstream_native_libraries(cmd, sess, codegen_results);\n     }\n@@ -2415,7 +2415,7 @@ fn add_upstream_rust_crates<'a>(\n                 // or is an rlib already included via some other dylib crate, the symbols from\n                 // native libs will have already been included in that dylib.\n                 //\n-                // If -Zlink-native-libraries=false is set, then the assumption is that an\n+                // If `-Zlink-native-libraries=false` is set, then the assumption is that an\n                 // external build system already has the native dependencies defined, and it\n                 // will provide them to the linker itself.\n                 if sess.opts.unstable_opts.link_native_libraries {"}, {"sha": "b92e146bee2af5a95b1461d7a7da35813be74971", "filename": "compiler/rustc_codegen_ssa/src/back/metadata.rs", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/bc05045a017f94ba6ba3a121a1ddc293f6617693/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Fmetadata.rs", "raw_url": "https://github.com/rust-lang/rust/raw/bc05045a017f94ba6ba3a121a1ddc293f6617693/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Fmetadata.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Fmetadata.rs?ref=bc05045a017f94ba6ba3a121a1ddc293f6617693", "patch": "@@ -187,12 +187,12 @@ pub enum MetadataPosition {\n     Last,\n }\n \n-// For rlibs we \"pack\" rustc metadata into a dummy object file. When rustc\n-// creates a dylib crate type it will pass `--whole-archive` (or the\n-// platform equivalent) to include all object files from an rlib into the\n-// final dylib itself. This causes linkers to iterate and try to include all\n-// files located in an archive, so if metadata is stored in an archive then\n-// it needs to be of a form that the linker will be able to process.\n+// For rlibs we \"pack\" rustc metadata into a dummy object file.\n+//\n+// Historically it was needed because rustc linked rlibs as whole-archive in some cases.\n+// In that case linkers try to include all files located in an archive, so if metadata is stored\n+// in an archive then it needs to be of a form that the linker is able to process.\n+// Now it's not clear whether metadata still needs to be wrapped into an object file or not.\n //\n // Note, though, that we don't actually want this metadata to show up in any\n // final output of the compiler. Instead this is purely for rustc's own"}]}