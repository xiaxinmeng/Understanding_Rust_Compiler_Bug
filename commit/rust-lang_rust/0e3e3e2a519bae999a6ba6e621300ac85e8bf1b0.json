{"sha": "0e3e3e2a519bae999a6ba6e621300ac85e8bf1b0", "node_id": "C_kwDOAAsO6NoAKDBlM2UzZTJhNTE5YmFlOTk5YTZiYTZlNjIxMzAwYWM4NWU4YmYxYjA", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-09-26T12:54:12Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-09-26T12:54:12Z"}, "message": "Merge #10357\n\n10357: internal: fix and force-disable block validation ;-( r=matklad a=matklad\n\nOriginally we tried to maintain the invariant that `{}` always match.\nThat is, that in the parse tree the pair of corresponding `{}` is always\nfirst and last tokens of some nodes.\n\nWe had the code to validate that, but apparently it's been broken for\n**years** since we introduced tokens/nodes split. Fixing it now makes\nsome tests fail.\n\nIt's unclear if we want to keep this invariant: there's a strong\nmotivation for breaking it in the following case:\n\n```\nuse std::{ // unclosed paren\n\nfn main() {\n\n}\n\n} // don't actually want to pair up this with the one from `use`\n```\n\nSo let's fix the code, but disable it for the time being\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>", "tree": {"sha": "1cb0a06d6cf0ffa03b9e48944c2b627d3fd99a65", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1cb0a06d6cf0ffa03b9e48944c2b627d3fd99a65"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0e3e3e2a519bae999a6ba6e621300ac85e8bf1b0", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhUG10CRBK7hj4Ov3rIwAAu60IAHeGB09XJ8gw5C8443gJBSm5\nHHLGRimKnRiJM5UDZeIPiB1JEjufun0iPPYjZqKmonecj8ainEfRJ0gy7TLwc1AP\nK2iPnrcpxP1UCKR/aODyMvGcPGzsg5zhJ1ziO4J+qFBRIIcIuVkOBWv33hZs8qdl\nQY5j1wtTp+sihy9ZzJ8tZVoqoKY2gwx7Z3NgoZX3hQzhsW0rOa94+4LAjqNXeXUI\ncwkwgpgZUed5V1DcXue5pG8eoXkc7YEmPk6LoxQh3EMUouyqape00eYZh6pg7696\nBPYPHIigq7fonsWGdd2OEM85AUr/G6PMx8W/3dGRWIHAhryToqgabXLqc0MDZO0=\n=XjaA\n-----END PGP SIGNATURE-----\n", "payload": "tree 1cb0a06d6cf0ffa03b9e48944c2b627d3fd99a65\nparent 06181008551b4f920d6e91e1f6bc270d78428bc6\nparent defe805fb763f3d4b11cbbe3dde460b825eea1ae\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1632660852 +0000\ncommitter GitHub <noreply@github.com> 1632660852 +0000\n\nMerge #10357\n\n10357: internal: fix and force-disable block validation ;-( r=matklad a=matklad\n\nOriginally we tried to maintain the invariant that `{}` always match.\nThat is, that in the parse tree the pair of corresponding `{}` is always\nfirst and last tokens of some nodes.\n\nWe had the code to validate that, but apparently it's been broken for\n**years** since we introduced tokens/nodes split. Fixing it now makes\nsome tests fail.\n\nIt's unclear if we want to keep this invariant: there's a strong\nmotivation for breaking it in the following case:\n\n```\nuse std::{ // unclosed paren\n\nfn main() {\n\n}\n\n} // don't actually want to pair up this with the one from `use`\n```\n\nSo let's fix the code, but disable it for the time being\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0e3e3e2a519bae999a6ba6e621300ac85e8bf1b0", "html_url": "https://github.com/rust-lang/rust/commit/0e3e3e2a519bae999a6ba6e621300ac85e8bf1b0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0e3e3e2a519bae999a6ba6e621300ac85e8bf1b0/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "06181008551b4f920d6e91e1f6bc270d78428bc6", "url": "https://api.github.com/repos/rust-lang/rust/commits/06181008551b4f920d6e91e1f6bc270d78428bc6", "html_url": "https://github.com/rust-lang/rust/commit/06181008551b4f920d6e91e1f6bc270d78428bc6"}, {"sha": "defe805fb763f3d4b11cbbe3dde460b825eea1ae", "url": "https://api.github.com/repos/rust-lang/rust/commits/defe805fb763f3d4b11cbbe3dde460b825eea1ae", "html_url": "https://github.com/rust-lang/rust/commit/defe805fb763f3d4b11cbbe3dde460b825eea1ae"}], "stats": {"total": 13, "additions": 5, "deletions": 8}, "files": [{"sha": "40460e18c36b59ffffd7b9c623a0d65144a38855", "filename": "crates/syntax/src/lib.rs", "status": "modified", "additions": 0, "deletions": 4, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/0e3e3e2a519bae999a6ba6e621300ac85e8bf1b0/crates%2Fsyntax%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0e3e3e2a519bae999a6ba6e621300ac85e8bf1b0/crates%2Fsyntax%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fsyntax%2Fsrc%2Flib.rs?ref=0e3e3e2a519bae999a6ba6e621300ac85e8bf1b0", "patch": "@@ -162,10 +162,6 @@ impl SourceFile {\n         let (green, mut errors) = parsing::parse_text(text);\n         let root = SyntaxNode::new_root(green.clone());\n \n-        if cfg!(debug_assertions) {\n-            validation::validate_block_structure(&root);\n-        }\n-\n         errors.extend(validation::validate(&root));\n \n         assert_eq!(root.kind(), SyntaxKind::SOURCE_FILE);"}, {"sha": "0ddfd439dceb082dab0b85c320f9f749a97c5a10", "filename": "crates/syntax/src/syntax_node.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/0e3e3e2a519bae999a6ba6e621300ac85e8bf1b0/crates%2Fsyntax%2Fsrc%2Fsyntax_node.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0e3e3e2a519bae999a6ba6e621300ac85e8bf1b0/crates%2Fsyntax%2Fsrc%2Fsyntax_node.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fsyntax%2Fsrc%2Fsyntax_node.rs?ref=0e3e3e2a519bae999a6ba6e621300ac85e8bf1b0", "patch": "@@ -47,7 +47,7 @@ impl SyntaxTreeBuilder {\n \n     pub fn finish(self) -> Parse<SyntaxNode> {\n         let (green, errors) = self.finish_raw();\n-        if cfg!(debug_assertions) {\n+        if cfg!(debug_assertions) && false {\n             let node = SyntaxNode::new_root(green.clone());\n             crate::validation::validate_block_structure(&node);\n         }"}, {"sha": "a7c469ffdf208cbd7ce3d8122f9df218846a73d7", "filename": "crates/syntax/src/validation.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/0e3e3e2a519bae999a6ba6e621300ac85e8bf1b0/crates%2Fsyntax%2Fsrc%2Fvalidation.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0e3e3e2a519bae999a6ba6e621300ac85e8bf1b0/crates%2Fsyntax%2Fsrc%2Fvalidation.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fsyntax%2Fsrc%2Fvalidation.rs?ref=0e3e3e2a519bae999a6ba6e621300ac85e8bf1b0", "patch": "@@ -170,7 +170,7 @@ fn validate_literal(literal: ast::Literal, acc: &mut Vec<SyntaxError>) {\n \n pub(crate) fn validate_block_structure(root: &SyntaxNode) {\n     let mut stack = Vec::new();\n-    for node in root.descendants() {\n+    for node in root.descendants_with_tokens() {\n         match node.kind() {\n             T!['{'] => stack.push(node),\n             T!['}'] => {\n@@ -183,11 +183,12 @@ pub(crate) fn validate_block_structure(root: &SyntaxNode) {\n                         root,\n                     );\n                     assert!(\n-                        node.next_sibling().is_none() && pair.prev_sibling().is_none(),\n+                        node.next_sibling_or_token().is_none()\n+                            && pair.prev_sibling_or_token().is_none(),\n                         \"\\nfloating curlys at {:?}\\nfile:\\n{}\\nerror:\\n{}\\n\",\n                         node,\n                         root.text(),\n-                        node.text(),\n+                        node,\n                     );\n                 }\n             }"}]}