{"sha": "3eab2805676b9be331ae7a1cfe5bb4124dc6a2d3", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNlYWIyODA1Njc2YjliZTMzMWFlN2ExY2ZlNWJiNDEyNGRjNmEyZDM=", "commit": {"author": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2021-06-06T14:48:18Z"}, "committer": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2021-06-06T14:48:18Z"}, "message": "linker: Re-apply Solaris fixes for `-z ignore`", "tree": {"sha": "3ba88e5a0c07fce18d90e8b2ad12c8e08abe016b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3ba88e5a0c07fce18d90e8b2ad12c8e08abe016b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3eab2805676b9be331ae7a1cfe5bb4124dc6a2d3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3eab2805676b9be331ae7a1cfe5bb4124dc6a2d3", "html_url": "https://github.com/rust-lang/rust/commit/3eab2805676b9be331ae7a1cfe5bb4124dc6a2d3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3eab2805676b9be331ae7a1cfe5bb4124dc6a2d3/comments", "author": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "committer": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5275bf1c1d1cc1adf68fd5165baa75005e790b28", "url": "https://api.github.com/repos/rust-lang/rust/commits/5275bf1c1d1cc1adf68fd5165baa75005e790b28", "html_url": "https://github.com/rust-lang/rust/commit/5275bf1c1d1cc1adf68fd5165baa75005e790b28"}], "stats": {"total": 15, "additions": 10, "deletions": 5}, "files": [{"sha": "f9f59be1e8b6ac518ad4033164d8df64b6246c0c", "filename": "compiler/rustc_codegen_ssa/src/back/link.rs", "status": "modified", "additions": 10, "deletions": 5, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/3eab2805676b9be331ae7a1cfe5bb4124dc6a2d3/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3eab2805676b9be331ae7a1cfe5bb4124dc6a2d3/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fback%2Flink.rs?ref=3eab2805676b9be331ae7a1cfe5bb4124dc6a2d3", "patch": "@@ -1764,11 +1764,6 @@ fn linker_with_args<'a, B: ArchiveBuilder<'a>>(\n \n     // ------------ Early order-dependent options ------------\n \n-    // Avoid linking to dynamic libraries unless they satisfy some undefined symbols\n-    // at the point at which they are specified on the command line.\n-    // Must be passed before any (dynamic) libraries to have effect on them.\n-    cmd.add_as_needed();\n-\n     // If we're building something like a dynamic library then some platforms\n     // need to make sure that all symbols are exported correctly from the\n     // dynamic library.\n@@ -1822,6 +1817,16 @@ fn linker_with_args<'a, B: ArchiveBuilder<'a>>(\n     add_local_crate_metadata_objects(cmd, crate_type, codegen_results);\n     add_local_crate_allocator_objects(cmd, codegen_results);\n \n+    // Avoid linking to dynamic libraries unless they satisfy some undefined symbols\n+    // at the point at which they are specified on the command line.\n+    // Must be passed before any (dynamic) libraries to have effect on them.\n+    // On Solaris-like systems, `-z ignore` acts as both `--as-needed` and `--gc-sections`\n+    // so it will ignore unreferenced ELF sections from relocatable objects.\n+    // For that reason, we put this flag after metadata objects as they would otherwise be removed.\n+    // FIXME: Support more fine-grained dead code removal on Solaris/illumos\n+    // and move this option back to the top.\n+    cmd.add_as_needed();\n+\n     // FIXME: Move this below to other native libraries\n     // (or alternatively link all native libraries after their respective crates).\n     // This change is somewhat breaking in practice due to local static libraries being linked"}]}