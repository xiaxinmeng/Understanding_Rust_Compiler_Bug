{"sha": "919601bc511608f1b66fe7c51d4b879e2abdec40", "node_id": "MDY6Q29tbWl0NzI0NzEyOjkxOTYwMWJjNTExNjA4ZjFiNjZmZTdjNTFkNGI4NzllMmFiZGVjNDA=", "commit": {"author": {"name": "Wilco Kusee", "email": "wilcokusee@gmail.com", "date": "2017-12-19T22:22:16Z"}, "committer": {"name": "Wilco Kusee", "email": "wilcokusee@gmail.com", "date": "2017-12-19T22:51:06Z"}, "message": "Lint for matching option as ref", "tree": {"sha": "bfe3f455863b7696013daf57c809c11b1b6bd6b9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/bfe3f455863b7696013daf57c809c11b1b6bd6b9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/919601bc511608f1b66fe7c51d4b879e2abdec40", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/919601bc511608f1b66fe7c51d4b879e2abdec40", "html_url": "https://github.com/rust-lang/rust/commit/919601bc511608f1b66fe7c51d4b879e2abdec40", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/919601bc511608f1b66fe7c51d4b879e2abdec40/comments", "author": {"login": "detrumi", "id": 5758008, "node_id": "MDQ6VXNlcjU3NTgwMDg=", "avatar_url": "https://avatars.githubusercontent.com/u/5758008?v=4", "gravatar_id": "", "url": "https://api.github.com/users/detrumi", "html_url": "https://github.com/detrumi", "followers_url": "https://api.github.com/users/detrumi/followers", "following_url": "https://api.github.com/users/detrumi/following{/other_user}", "gists_url": "https://api.github.com/users/detrumi/gists{/gist_id}", "starred_url": "https://api.github.com/users/detrumi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/detrumi/subscriptions", "organizations_url": "https://api.github.com/users/detrumi/orgs", "repos_url": "https://api.github.com/users/detrumi/repos", "events_url": "https://api.github.com/users/detrumi/events{/privacy}", "received_events_url": "https://api.github.com/users/detrumi/received_events", "type": "User", "site_admin": false}, "committer": {"login": "detrumi", "id": 5758008, "node_id": "MDQ6VXNlcjU3NTgwMDg=", "avatar_url": "https://avatars.githubusercontent.com/u/5758008?v=4", "gravatar_id": "", "url": "https://api.github.com/users/detrumi", "html_url": "https://github.com/detrumi", "followers_url": "https://api.github.com/users/detrumi/followers", "following_url": "https://api.github.com/users/detrumi/following{/other_user}", "gists_url": "https://api.github.com/users/detrumi/gists{/gist_id}", "starred_url": "https://api.github.com/users/detrumi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/detrumi/subscriptions", "organizations_url": "https://api.github.com/users/detrumi/orgs", "repos_url": "https://api.github.com/users/detrumi/repos", "events_url": "https://api.github.com/users/detrumi/events{/privacy}", "received_events_url": "https://api.github.com/users/detrumi/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cf58e1c6729b969507c0027d6107e2a6e157932f", "url": "https://api.github.com/repos/rust-lang/rust/commits/cf58e1c6729b969507c0027d6107e2a6e157932f", "html_url": "https://github.com/rust-lang/rust/commit/cf58e1c6729b969507c0027d6107e2a6e157932f"}], "stats": {"total": 113, "additions": 110, "deletions": 3}, "files": [{"sha": "9b598df4fa62dd78acfbbb4a1e15fd6f36006534", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/919601bc511608f1b66fe7c51d4b879e2abdec40/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/919601bc511608f1b66fe7c51d4b879e2abdec40/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=919601bc511608f1b66fe7c51d4b879e2abdec40", "patch": "@@ -499,6 +499,7 @@ pub fn register_plugins(reg: &mut rustc_plugin::Registry) {\n         loops::WHILE_LET_LOOP,\n         loops::WHILE_LET_ON_ITERATOR,\n         map_clone::MAP_CLONE,\n+        matches::MATCH_AS_REF,\n         matches::MATCH_BOOL,\n         matches::MATCH_OVERLAPPING_ARM,\n         matches::MATCH_REF_PATS,"}, {"sha": "326ce83a84f9ed4c6a287f07cb79b36dd0c0056c", "filename": "clippy_lints/src/matches.rs", "status": "modified", "additions": 72, "deletions": 3, "changes": 75, "blob_url": "https://github.com/rust-lang/rust/blob/919601bc511608f1b66fe7c51d4b879e2abdec40/clippy_lints%2Fsrc%2Fmatches.rs", "raw_url": "https://github.com/rust-lang/rust/raw/919601bc511608f1b66fe7c51d4b879e2abdec40/clippy_lints%2Fsrc%2Fmatches.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmatches.rs?ref=919601bc511608f1b66fe7c51d4b879e2abdec40", "patch": "@@ -11,8 +11,8 @@ use syntax::ast::LitKind;\n use syntax::ast::NodeId;\n use syntax::codemap::Span;\n use utils::paths;\n-use utils::{expr_block, in_external_macro, is_allowed, is_expn_of, match_type, remove_blocks, snippet,\n-            span_lint_and_sugg, span_lint_and_then, span_note_and_lint, walk_ptrs_ty};\n+use utils::{expr_block, in_external_macro, is_allowed, is_expn_of, match_qpath, match_type, remove_blocks,\n+            snippet, span_lint_and_sugg, span_lint_and_then, span_note_and_lint, walk_ptrs_ty};\n use utils::sugg::Sugg;\n \n /// **What it does:** Checks for matches with a single arm where an `if let`\n@@ -145,6 +145,27 @@ declare_lint! {\n     \"a match with `Err(_)` arm and take drastic actions\"\n }\n \n+/// **What it does:** Checks for match which is used to add a reference to an\n+/// `Option` value.\n+///\n+/// **Why is this bad?** Using `as_ref()` instead is shorter.\n+///\n+/// **Known problems:** None.\n+///\n+/// **Example:**\n+/// ```rust\n+/// let x: Option<()> = None;\n+/// let r: Option<&()> = match x {\n+///   None => None,\n+///   Some(ref v) => Some(v),\n+/// };\n+/// ```\n+declare_lint! {\n+    pub MATCH_AS_REF,\n+    Warn,\n+    \"a match on an Option value instead of using `as_ref()`\"\n+}\n+\n #[allow(missing_copy_implementations)]\n pub struct MatchPass;\n \n@@ -156,7 +177,8 @@ impl LintPass for MatchPass {\n             MATCH_BOOL,\n             SINGLE_MATCH_ELSE,\n             MATCH_OVERLAPPING_ARM,\n-            MATCH_WILD_ERR_ARM\n+            MATCH_WILD_ERR_ARM,\n+            MATCH_AS_REF\n         )\n     }\n }\n@@ -171,6 +193,7 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for MatchPass {\n             check_match_bool(cx, ex, arms, expr);\n             check_overlapping_arms(cx, ex, arms);\n             check_wild_err_arm(cx, ex, arms);\n+            check_match_as_ref(cx, ex, arms, expr);\n         }\n         if let ExprMatch(ref ex, ref arms, source) = expr.node {\n             check_match_ref_pats(cx, ex, arms, source, expr);\n@@ -411,6 +434,24 @@ fn check_match_ref_pats(cx: &LateContext, ex: &Expr, arms: &[Arm], source: Match\n     }\n }\n \n+fn check_match_as_ref(cx: &LateContext, ex: &Expr, arms: &[Arm], expr: &Expr) {\n+    if arms.len() == 2 &&\n+        arms[0].pats.len() == 1 && arms[0].guard.is_none() &&\n+        arms[1].pats.len() == 1 && arms[1].guard.is_none() {\n+        if (is_ref_some_arm(&arms[0]) && is_none_arm(&arms[1])) ||\n+            (is_ref_some_arm(&arms[1]) && is_none_arm(&arms[0])) {\n+            span_lint_and_sugg(\n+                cx,\n+                MATCH_AS_REF,\n+                expr.span,\n+                \"use as_ref() instead\",\n+                \"try this\",\n+                format!(\"{}.as_ref()\", snippet(cx, ex.span, \"_\"))\n+            )\n+        }\n+    }\n+}\n+\n /// Get all arms that are unbounded `PatRange`s.\n fn all_ranges<'a, 'tcx>(\n     cx: &LateContext<'a, 'tcx>,\n@@ -524,6 +565,34 @@ fn is_unit_expr(expr: &Expr) -> bool {\n     }\n }\n \n+// Checks if arm has the form `None => None`\n+fn is_none_arm(arm: &Arm) -> bool {\n+    match arm.pats[0].node {\n+        PatKind::Path(ref path) if match_qpath(path, &paths::OPTION_NONE) => true,\n+        _ => false,\n+    }\n+}\n+\n+// Checks if arm has the form `Some(ref v) => Some(v)` (checks for `ref` and `ref mut`)\n+fn is_ref_some_arm(arm: &Arm) -> bool {\n+    if_chain! {\n+        if let PatKind::TupleStruct(ref path, ref pats, _) = arm.pats[0].node;\n+        if pats.len() == 1 && match_qpath(path, &paths::OPTION_SOME);\n+        if let PatKind::Binding(rb, _, ref ident, _) = pats[0].node;\n+        if rb == BindingAnnotation::Ref || rb == BindingAnnotation::RefMut;\n+        if let ExprCall(ref e, ref args) = remove_blocks(&arm.body).node;\n+        if let ExprPath(ref some_path) = e.node;\n+        if match_qpath(some_path, &paths::OPTION_SOME) && args.len() == 1;\n+        if let ExprPath(ref qpath) = args[0].node;\n+        if let &QPath::Resolved(_, ref path2) = qpath;\n+        if path2.segments.len() == 1;\n+        then {\n+            return ident.node == path2.segments[0].name\n+        }\n+    }\n+    false\n+}\n+\n fn has_only_ref_pats(arms: &[Arm]) -> bool {\n     let mapped = arms.iter()\n         .flat_map(|a| &a.pats)"}, {"sha": "72a36338aa2fe2d2925799fbccde534afb60f57d", "filename": "tests/ui/matches.rs", "status": "modified", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/919601bc511608f1b66fe7c51d4b879e2abdec40/tests%2Fui%2Fmatches.rs", "raw_url": "https://github.com/rust-lang/rust/raw/919601bc511608f1b66fe7c51d4b879e2abdec40/tests%2Fui%2Fmatches.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmatches.rs?ref=919601bc511608f1b66fe7c51d4b879e2abdec40", "patch": "@@ -315,5 +315,20 @@ fn match_wild_err_arm() {\n     }\n }\n \n+fn match_as_ref() {\n+    let owned : Option<()> = None;\n+    let borrowed = match owned {\n+        None => None,\n+        Some(ref v) => Some(v),\n+    };\n+\n+    let mut mut_owned : Option<()> = None;\n+    let mut mut_borrowed = match mut_owned {\n+        None => None,\n+        Some(ref mut v) => Some(v),\n+    };\n+\n+}\n+\n fn main() {\n }"}, {"sha": "3d7b8f7847392953f528b815876b3f08b6b1dbf7", "filename": "tests/ui/matches.stderr", "status": "modified", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/919601bc511608f1b66fe7c51d4b879e2abdec40/tests%2Fui%2Fmatches.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/919601bc511608f1b66fe7c51d4b879e2abdec40/tests%2Fui%2Fmatches.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmatches.stderr?ref=919601bc511608f1b66fe7c51d4b879e2abdec40", "patch": "@@ -426,3 +426,25 @@ note: consider refactoring into `Ok(3) | Ok(_)`\n     |                  ^^^^^^^^^^^^^^\n     = note: this error originates in a macro outside of the current crate (in Nightly builds, run with -Z external-macro-backtrace for more info)\n \n+error: use as_ref() instead\n+   --> $DIR/matches.rs:320:20\n+    |\n+320 |       let borrowed = match owned {\n+    |  ____________________^\n+321 | |         None => None,\n+322 | |         Some(ref v) => Some(v),\n+323 | |     };\n+    | |_____^ help: try this: `owned.as_ref()`\n+    |\n+    = note: `-D match-as-ref` implied by `-D warnings`\n+\n+error: use as_ref() instead\n+   --> $DIR/matches.rs:326:28\n+    |\n+326 |       let mut mut_borrowed = match mut_owned {\n+    |  ____________________________^\n+327 | |         None => None,\n+328 | |         Some(ref mut v) => Some(v),\n+329 | |     };\n+    | |_____^ help: try this: `mut_owned.as_ref()`\n+"}]}