{"sha": "195c42c426456e0aa1fe1a8f620e25c9c295754d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjE5NWM0MmM0MjY0NTZlMGFhMWZlMWE4ZjYyMGUyNWM5YzI5NTc1NGQ=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-11-18T16:24:00Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2016-11-18T16:24:00Z"}, "message": "Auto merge of #37749 - keeperofdakeys:should-panic, r=alexcrichton\n\nImprovements to the #[should_panic] feature\n\nAdd more error checking for the `#[should_panic]` attribute, and print the expected panic string when it does not match.\n\nFixes https://github.com/rust-lang/rust/issues/29000\n\nEg:\n```running 3 tests\ntest test2 ... ok\ntest test1 ... FAILED\n: Panic did not include expected string 'foo'\ntest test3 ... FAILED\n\nfailures:\n\n---- test1 stdout ----\n\tthread 'test1' panicked at 'bar', test.rs:7\nnote: Run with `RUST_BACKTRACE=1` for a backtrace.\n\n---- test3 stdout ----\n\tthread 'test3' panicked at 'bar', test.rs:18\n\n```", "tree": {"sha": "39446b73876904a265b8a314d61364ee955ff7b9", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/39446b73876904a265b8a314d61364ee955ff7b9"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/195c42c426456e0aa1fe1a8f620e25c9c295754d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/195c42c426456e0aa1fe1a8f620e25c9c295754d", "html_url": "https://github.com/rust-lang/rust/commit/195c42c426456e0aa1fe1a8f620e25c9c295754d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/195c42c426456e0aa1fe1a8f620e25c9c295754d/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2a6d02e0925d18db33c29a058df47ed272719c65", "url": "https://api.github.com/repos/rust-lang/rust/commits/2a6d02e0925d18db33c29a058df47ed272719c65", "html_url": "https://github.com/rust-lang/rust/commit/2a6d02e0925d18db33c29a058df47ed272719c65"}, {"sha": "fb5ccf80fe83653018794562bfc105d6914384ae", "url": "https://api.github.com/repos/rust-lang/rust/commits/fb5ccf80fe83653018794562bfc105d6914384ae", "html_url": "https://github.com/rust-lang/rust/commit/fb5ccf80fe83653018794562bfc105d6914384ae"}], "stats": {"total": 171, "additions": 151, "deletions": 20}, "files": [{"sha": "59a7e75d12557039c10813c7dd1b88c67dfc76bb", "filename": "src/libsyntax/test.rs", "status": "modified", "additions": 37, "deletions": 7, "changes": 44, "blob_url": "https://github.com/rust-lang/rust/blob/195c42c426456e0aa1fe1a8f620e25c9c295754d/src%2Flibsyntax%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/195c42c426456e0aa1fe1a8f620e25c9c295754d/src%2Flibsyntax%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Ftest.rs?ref=195c42c426456e0aa1fe1a8f620e25c9c295754d", "patch": "@@ -132,7 +132,7 @@ impl<'a> fold::Folder for TestHarnessGenerator<'a> {\n                         path: self.cx.path.clone(),\n                         bench: is_bench_fn(&self.cx, &i),\n                         ignore: is_ignored(&i),\n-                        should_panic: should_panic(&i)\n+                        should_panic: should_panic(&i, &self.cx)\n                     };\n                     self.cx.testfns.push(test);\n                     self.tests.push(i.ident);\n@@ -395,14 +395,44 @@ fn is_ignored(i: &ast::Item) -> bool {\n     i.attrs.iter().any(|attr| attr.check_name(\"ignore\"))\n }\n \n-fn should_panic(i: &ast::Item) -> ShouldPanic {\n+fn should_panic(i: &ast::Item, cx: &TestCtxt) -> ShouldPanic {\n     match i.attrs.iter().find(|attr| attr.check_name(\"should_panic\")) {\n         Some(attr) => {\n-            let msg = attr.meta_item_list()\n-                .and_then(|list| list.iter().find(|mi| mi.check_name(\"expected\")))\n-                .and_then(|li| li.meta_item())\n-                .and_then(|mi| mi.value_str());\n-            ShouldPanic::Yes(msg)\n+            let sd = cx.span_diagnostic;\n+            if attr.is_value_str() {\n+                sd.struct_span_warn(\n+                    attr.span(),\n+                    \"attribute must be of the form: \\\n+                     `#[should_panic]` or \\\n+                     `#[should_panic(expected = \\\"error message\\\")]`\"\n+                ).note(\"Errors in this attribute were erroneously allowed \\\n+                        and will become a hard error in a future release.\")\n+                .emit();\n+                return ShouldPanic::Yes(None);\n+            }\n+            match attr.meta_item_list() {\n+                // Handle #[should_panic]\n+                None => ShouldPanic::Yes(None),\n+                // Handle #[should_panic(expected = \"foo\")]\n+                Some(list) => {\n+                    let msg = list.iter()\n+                        .find(|mi| mi.check_name(\"expected\"))\n+                        .and_then(|mi| mi.meta_item())\n+                        .and_then(|mi| mi.value_str());\n+                    if list.len() != 1 || msg.is_none() {\n+                        sd.struct_span_warn(\n+                            attr.span(),\n+                            \"argument must be of the form: \\\n+                             `expected = \\\"error message\\\"`\"\n+                        ).note(\"Errors in this attribute were erroneously \\\n+                                allowed and will become a hard error in a \\\n+                                future release.\").emit();\n+                        ShouldPanic::Yes(None)\n+                    } else {\n+                        ShouldPanic::Yes(msg)\n+                    }\n+                },\n+            }\n         }\n         None => ShouldPanic::No,\n     }"}, {"sha": "8749a64e5fdb466d710a98843931cbdfa6283701", "filename": "src/libtest/lib.rs", "status": "modified", "additions": 30, "deletions": 13, "changes": 43, "blob_url": "https://github.com/rust-lang/rust/blob/195c42c426456e0aa1fe1a8f620e25c9c295754d/src%2Flibtest%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/195c42c426456e0aa1fe1a8f620e25c9c295754d/src%2Flibtest%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibtest%2Flib.rs?ref=195c42c426456e0aa1fe1a8f620e25c9c295754d", "patch": "@@ -75,9 +75,9 @@ const TEST_WARN_TIMEOUT_S: u64 = 60;\n // to be used by rustc to compile tests in libtest\n pub mod test {\n     pub use {Bencher, TestName, TestResult, TestDesc, TestDescAndFn, TestOpts, TrFailed,\n-             TrIgnored, TrOk, Metric, MetricMap, StaticTestFn, StaticTestName, DynTestName,\n-             DynTestFn, run_test, test_main, test_main_static, filter_tests, parse_opts,\n-             StaticBenchFn, ShouldPanic};\n+             TrFailedMsg, TrIgnored, TrOk, Metric, MetricMap, StaticTestFn, StaticTestName,\n+             DynTestName, DynTestFn, run_test, test_main, test_main_static, filter_tests,\n+             parse_opts, StaticBenchFn, ShouldPanic};\n }\n \n pub mod stats;\n@@ -473,6 +473,7 @@ pub struct BenchSamples {\n pub enum TestResult {\n     TrOk,\n     TrFailed,\n+    TrFailedMsg(String),\n     TrIgnored,\n     TrMetrics(MetricMap),\n     TrBench(BenchSamples),\n@@ -611,7 +612,7 @@ impl<T: Write> ConsoleTestState<T> {\n     pub fn write_result(&mut self, result: &TestResult) -> io::Result<()> {\n         match *result {\n             TrOk => self.write_ok(),\n-            TrFailed => self.write_failed(),\n+            TrFailed | TrFailedMsg(_) => self.write_failed(),\n             TrIgnored => self.write_ignored(),\n             TrMetrics(ref mm) => {\n                 self.write_metric()?;\n@@ -638,6 +639,7 @@ impl<T: Write> ConsoleTestState<T> {\n                                 match *result {\n                                     TrOk => \"ok\".to_owned(),\n                                     TrFailed => \"failed\".to_owned(),\n+                                    TrFailedMsg(ref msg) => format!(\"failed: {}\", msg),\n                                     TrIgnored => \"ignored\".to_owned(),\n                                     TrMetrics(ref mm) => mm.fmt_metrics(),\n                                     TrBench(ref bs) => fmt_bench_samples(bs),\n@@ -773,6 +775,14 @@ pub fn run_tests_console(opts: &TestOpts, tests: Vec<TestDescAndFn>) -> io::Resu\n                         st.failed += 1;\n                         st.failures.push((test, stdout));\n                     }\n+                    TrFailedMsg(msg) => {\n+                        st.failed += 1;\n+                        let mut stdout = stdout;\n+                        stdout.extend_from_slice(\n+                            format!(\"note: {}\", msg).as_bytes()\n+                        );\n+                        st.failures.push((test, stdout));\n+                    }\n                 }\n                 Ok(())\n             }\n@@ -1270,12 +1280,16 @@ fn calc_result(desc: &TestDesc, task_result: Result<(), Box<Any + Send>>) -> Tes\n     match (&desc.should_panic, task_result) {\n         (&ShouldPanic::No, Ok(())) |\n         (&ShouldPanic::Yes, Err(_)) => TrOk,\n-        (&ShouldPanic::YesWithMessage(msg), Err(ref err))\n+        (&ShouldPanic::YesWithMessage(msg), Err(ref err)) =>\n             if err.downcast_ref::<String>()\n-               .map(|e| &**e)\n-               .or_else(|| err.downcast_ref::<&'static str>().map(|e| *e))\n-               .map(|e| e.contains(msg))\n-               .unwrap_or(false) => TrOk,\n+                  .map(|e| &**e)\n+                  .or_else(|| err.downcast_ref::<&'static str>().map(|e| *e))\n+                  .map(|e| e.contains(msg))\n+                  .unwrap_or(false) {\n+                TrOk\n+            } else {\n+                TrFailedMsg(format!(\"Panic did not include expected string '{}'\", msg))\n+            },\n         _ => TrFailed,\n     }\n }\n@@ -1482,8 +1496,9 @@ pub mod bench {\n \n #[cfg(test)]\n mod tests {\n-    use test::{TrFailed, TrIgnored, TrOk, filter_tests, parse_opts, TestDesc, TestDescAndFn,\n-               TestOpts, run_test, MetricMap, StaticTestName, DynTestName, DynTestFn, ShouldPanic};\n+    use test::{TrFailed, TrFailedMsg, TrIgnored, TrOk, filter_tests, parse_opts, TestDesc,\n+               TestDescAndFn, TestOpts, run_test, MetricMap, StaticTestName, DynTestName,\n+               DynTestFn, ShouldPanic};\n     use std::sync::mpsc::channel;\n \n     #[test]\n@@ -1565,18 +1580,20 @@ mod tests {\n         fn f() {\n             panic!(\"an error message\");\n         }\n+        let expected = \"foobar\";\n+        let failed_msg = \"Panic did not include expected string\";\n         let desc = TestDescAndFn {\n             desc: TestDesc {\n                 name: StaticTestName(\"whatever\"),\n                 ignore: false,\n-                should_panic: ShouldPanic::YesWithMessage(\"foobar\"),\n+                should_panic: ShouldPanic::YesWithMessage(expected),\n             },\n             testfn: DynTestFn(Box::new(move |()| f())),\n         };\n         let (tx, rx) = channel();\n         run_test(&TestOpts::new(), false, desc, tx);\n         let (_, res, _) = rx.recv().unwrap();\n-        assert!(res == TrFailed);\n+        assert!(res == TrFailedMsg(format!(\"{} '{}'\", failed_msg, expected)));\n     }\n \n     #[test]"}, {"sha": "7186672b4049e09db12bdabf11c8cc7759a4a609", "filename": "src/test/run-fail/test-should-panic-bad-message.rs", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/195c42c426456e0aa1fe1a8f620e25c9c295754d/src%2Ftest%2Frun-fail%2Ftest-should-panic-bad-message.rs", "raw_url": "https://github.com/rust-lang/rust/raw/195c42c426456e0aa1fe1a8f620e25c9c295754d/src%2Ftest%2Frun-fail%2Ftest-should-panic-bad-message.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-fail%2Ftest-should-panic-bad-message.rs?ref=195c42c426456e0aa1fe1a8f620e25c9c295754d", "patch": "@@ -0,0 +1,19 @@\n+// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// compile-flags: --test\n+\n+// error-pattern:panicked at 'bar'\n+// check-stdout\n+#[test]\n+#[should_panic(expected = \"foo\")]\n+pub fn test_bar() {\n+    panic!(\"bar\")\n+}"}, {"sha": "50dc2aed8e9d017355ebf8160a07822968b3b526", "filename": "src/test/run-fail/test-should-panic-no-message.rs", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/195c42c426456e0aa1fe1a8f620e25c9c295754d/src%2Ftest%2Frun-fail%2Ftest-should-panic-no-message.rs", "raw_url": "https://github.com/rust-lang/rust/raw/195c42c426456e0aa1fe1a8f620e25c9c295754d/src%2Ftest%2Frun-fail%2Ftest-should-panic-no-message.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-fail%2Ftest-should-panic-no-message.rs?ref=195c42c426456e0aa1fe1a8f620e25c9c295754d", "patch": "@@ -0,0 +1,19 @@\n+// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// compile-flags: --test\n+\n+// error-pattern:panicked at 'explicit panic'\n+// check-stdout\n+#[test]\n+#[should_panic(expected = \"foo\")]\n+pub fn test_explicit() {\n+    panic!()\n+}"}, {"sha": "2d068872a4d3dfbe634dd384e999dd330e0a8d27", "filename": "src/test/run-pass/test-should-panic-attr.rs", "status": "added", "additions": 46, "deletions": 0, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/195c42c426456e0aa1fe1a8f620e25c9c295754d/src%2Ftest%2Frun-pass%2Ftest-should-panic-attr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/195c42c426456e0aa1fe1a8f620e25c9c295754d/src%2Ftest%2Frun-pass%2Ftest-should-panic-attr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Ftest-should-panic-attr.rs?ref=195c42c426456e0aa1fe1a8f620e25c9c295754d", "patch": "@@ -0,0 +1,46 @@\n+// Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// compile-flags: --test\n+\n+#[test]\n+#[should_panic = \"foo\"]\n+//~^ WARN: attribute must be of the form:\n+fn test1() {\n+    panic!();\n+}\n+\n+#[test]\n+#[should_panic(expected)]\n+//~^ WARN: argument must be of the form:\n+fn test2() {\n+    panic!();\n+}\n+\n+#[test]\n+#[should_panic(expect)]\n+//~^ WARN: argument must be of the form:\n+fn test3() {\n+    panic!();\n+}\n+\n+#[test]\n+#[should_panic(expected(foo, bar))]\n+//~^ WARN: argument must be of the form:\n+fn test4() {\n+    panic!();\n+}\n+\n+#[test]\n+#[should_panic(expected = \"foo\", bar)]\n+//~^ WARN: argument must be of the form:\n+fn test5() {\n+    panic!();\n+}"}]}