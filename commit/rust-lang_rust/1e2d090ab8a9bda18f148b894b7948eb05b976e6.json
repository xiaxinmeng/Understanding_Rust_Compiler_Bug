{"sha": "1e2d090ab8a9bda18f148b894b7948eb05b976e6", "node_id": "MDY6Q29tbWl0NzI0NzEyOjFlMmQwOTBhYjhhOWJkYTE4ZjE0OGI4OTRiNzk0OGViMDViOTc2ZTY=", "commit": {"author": {"name": "Seivan Heidari", "email": "seivan.heidari@icloud.com", "date": "2019-11-20T02:56:43Z"}, "committer": {"name": "Seivan Heidari", "email": "seivan.heidari@icloud.com", "date": "2019-11-20T02:56:43Z"}, "message": "Merge branch 'master' of https://github.com/rust-analyzer/rust-analyzer into feature/themes", "tree": {"sha": "efe47fc3cbd69306e0a8ad3776474bbc85fb93dd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/efe47fc3cbd69306e0a8ad3776474bbc85fb93dd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/1e2d090ab8a9bda18f148b894b7948eb05b976e6", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/1e2d090ab8a9bda18f148b894b7948eb05b976e6", "html_url": "https://github.com/rust-lang/rust/commit/1e2d090ab8a9bda18f148b894b7948eb05b976e6", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/1e2d090ab8a9bda18f148b894b7948eb05b976e6/comments", "author": {"login": "seivan", "id": 55424, "node_id": "MDQ6VXNlcjU1NDI0", "avatar_url": "https://avatars.githubusercontent.com/u/55424?v=4", "gravatar_id": "", "url": "https://api.github.com/users/seivan", "html_url": "https://github.com/seivan", "followers_url": "https://api.github.com/users/seivan/followers", "following_url": "https://api.github.com/users/seivan/following{/other_user}", "gists_url": "https://api.github.com/users/seivan/gists{/gist_id}", "starred_url": "https://api.github.com/users/seivan/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/seivan/subscriptions", "organizations_url": "https://api.github.com/users/seivan/orgs", "repos_url": "https://api.github.com/users/seivan/repos", "events_url": "https://api.github.com/users/seivan/events{/privacy}", "received_events_url": "https://api.github.com/users/seivan/received_events", "type": "User", "site_admin": false}, "committer": {"login": "seivan", "id": 55424, "node_id": "MDQ6VXNlcjU1NDI0", "avatar_url": "https://avatars.githubusercontent.com/u/55424?v=4", "gravatar_id": "", "url": "https://api.github.com/users/seivan", "html_url": "https://github.com/seivan", "followers_url": "https://api.github.com/users/seivan/followers", "following_url": "https://api.github.com/users/seivan/following{/other_user}", "gists_url": "https://api.github.com/users/seivan/gists{/gist_id}", "starred_url": "https://api.github.com/users/seivan/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/seivan/subscriptions", "organizations_url": "https://api.github.com/users/seivan/orgs", "repos_url": "https://api.github.com/users/seivan/repos", "events_url": "https://api.github.com/users/seivan/events{/privacy}", "received_events_url": "https://api.github.com/users/seivan/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "597dd9fb2037c67b2c64f256919ae2e531fdacf3", "url": "https://api.github.com/repos/rust-lang/rust/commits/597dd9fb2037c67b2c64f256919ae2e531fdacf3", "html_url": "https://github.com/rust-lang/rust/commit/597dd9fb2037c67b2c64f256919ae2e531fdacf3"}, {"sha": "0e61ba3750df7e3e19eda21b6486bf70d6dffc72", "url": "https://api.github.com/repos/rust-lang/rust/commits/0e61ba3750df7e3e19eda21b6486bf70d6dffc72", "html_url": "https://github.com/rust-lang/rust/commit/0e61ba3750df7e3e19eda21b6486bf70d6dffc72"}], "stats": {"total": 385, "additions": 358, "deletions": 27}, "files": [{"sha": "5bc41533c4c6f99936aed3baf8226e491f0f78d0", "filename": ".github/workflows/ci.yaml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/1e2d090ab8a9bda18f148b894b7948eb05b976e6/.github%2Fworkflows%2Fci.yaml", "raw_url": "https://github.com/rust-lang/rust/raw/1e2d090ab8a9bda18f148b894b7948eb05b976e6/.github%2Fworkflows%2Fci.yaml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.github%2Fworkflows%2Fci.yaml?ref=1e2d090ab8a9bda18f148b894b7948eb05b976e6", "patch": "@@ -5,6 +5,7 @@ on:\n     branches:\n       - master\n       - staging\n+      - trying\n \n jobs:\n   rust:"}, {"sha": "ef373519726554eeb028d69614a1e5439c0fe64b", "filename": "Cargo.lock", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/1e2d090ab8a9bda18f148b894b7948eb05b976e6/Cargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/1e2d090ab8a9bda18f148b894b7948eb05b976e6/Cargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/Cargo.lock?ref=1e2d090ab8a9bda18f148b894b7948eb05b976e6", "patch": "@@ -1180,7 +1180,7 @@ dependencies = [\n  \"once_cell 1.2.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"ra_parser 0.1.0\",\n  \"ra_text_edit 0.1.0\",\n- \"rowan 0.6.3 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"rowan 0.7.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"rustc-hash 1.0.1 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"rustc_lexer 0.1.0 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"smol_str 0.1.15 (registry+https://github.com/rust-lang/crates.io-index)\",\n@@ -1445,7 +1445,7 @@ dependencies = [\n \n [[package]]\n name = \"rowan\"\n-version = \"0.6.3\"\n+version = \"0.7.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n dependencies = [\n  \"rustc-hash 1.0.1 (registry+https://github.com/rust-lang/crates.io-index)\",\n@@ -1993,7 +1993,7 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n \"checksum relative-path 1.0.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"bedde000f40f2921ce439ea165c9c53fd629bfa115140c72e22aceacb4a21954\"\n \"checksum remove_dir_all 0.5.2 (registry+https://github.com/rust-lang/crates.io-index)\" = \"4a83fa3702a688b9359eccba92d153ac33fd2e8462f9e0e3fdf155239ea7792e\"\n \"checksum ron 0.5.1 (registry+https://github.com/rust-lang/crates.io-index)\" = \"2ece421e0c4129b90e4a35b6f625e472e96c552136f5093a2f4fa2bbb75a62d5\"\n-\"checksum rowan 0.6.3 (registry+https://github.com/rust-lang/crates.io-index)\" = \"fc3a6fb2a35518af7cab43ec4e21ca82eb086a8b3bb1739e426dc3923d459607\"\n+\"checksum rowan 0.7.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"d3a241900475bf2ba302061550ff50c82b45095ca95d23d1872345793fd42407\"\n \"checksum rustc-demangle 0.1.16 (registry+https://github.com/rust-lang/crates.io-index)\" = \"4c691c0e608126e00913e33f0ccf3727d5fc84573623b8d65b2df340b5201783\"\n \"checksum rustc-hash 1.0.1 (registry+https://github.com/rust-lang/crates.io-index)\" = \"7540fc8b0c49f096ee9c961cda096467dce8084bec6bdca2fc83895fd9b28cb8\"\n \"checksum rustc_lexer 0.1.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"c86aae0c77166108c01305ee1a36a1e77289d7dc6ca0a3cd91ff4992de2d16a5\""}, {"sha": "5d3196c2a2e1d0850535f4c10e404c864f010cde", "filename": "crates/ra_hir/src/source_binder.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1e2d090ab8a9bda18f148b894b7948eb05b976e6/crates%2Fra_hir%2Fsrc%2Fsource_binder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e2d090ab8a9bda18f148b894b7948eb05b976e6/crates%2Fra_hir%2Fsrc%2Fsource_binder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fsource_binder.rs?ref=1e2d090ab8a9bda18f148b894b7948eb05b976e6", "patch": "@@ -140,7 +140,7 @@ impl Expansion {\n         exp_info.map_token_down(token)\n     }\n \n-    fn file_id(&self) -> HirFileId {\n+    pub fn file_id(&self) -> HirFileId {\n         self.macro_call_id.as_file(MacroFileKind::Items)\n     }\n }"}, {"sha": "65a35e52fa4d799a88a43ef0e4bdbfb03580c57a", "filename": "crates/ra_hir_expand/src/quote.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/1e2d090ab8a9bda18f148b894b7948eb05b976e6/crates%2Fra_hir_expand%2Fsrc%2Fquote.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e2d090ab8a9bda18f148b894b7948eb05b976e6/crates%2Fra_hir_expand%2Fsrc%2Fquote.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_expand%2Fsrc%2Fquote.rs?ref=1e2d090ab8a9bda18f148b894b7948eb05b976e6", "patch": "@@ -172,12 +172,12 @@ impl_to_to_tokentrees! {\n     u32 => self { tt::Literal{text: self.to_string().into()} };\n     usize => self { tt::Literal{text: self.to_string().into()}};\n     i32 => self { tt::Literal{text: self.to_string().into()}};\n-    &str => self { tt::Literal{text: self.to_string().into()}};\n-    String => self { tt::Literal{text: self.into()}};\n     tt::Leaf => self { self };\n     tt::Literal => self { self };\n     tt::Ident => self { self };\n-    tt::Punct => self { self }\n+    tt::Punct => self { self };\n+    &str => self { tt::Literal{text: format!(\"{:?}\", self.escape_default().to_string()).into()}};\n+    String => self { tt::Literal{text: format!(\"{:?}\", self.escape_default().to_string()).into()}}\n }\n \n #[cfg(test)]\n@@ -200,7 +200,7 @@ mod tests {\n         let a = 20;\n         assert_eq!(quote!(#a).to_string(), \"20\");\n         let s: String = \"hello\".into();\n-        assert_eq!(quote!(#s).to_string(), \"hello\");\n+        assert_eq!(quote!(#s).to_string(), \"\\\"hello\\\"\");\n     }\n \n     fn mk_ident(name: &str) -> tt::Ident {"}, {"sha": "e9eb2a7fb8eb14e58383a9b357989552cabce162", "filename": "crates/ra_ide_api/src/expand_macro.rs", "status": "added", "additions": 178, "deletions": 0, "changes": 178, "blob_url": "https://github.com/rust-lang/rust/blob/1e2d090ab8a9bda18f148b894b7948eb05b976e6/crates%2Fra_ide_api%2Fsrc%2Fexpand_macro.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e2d090ab8a9bda18f148b894b7948eb05b976e6/crates%2Fra_ide_api%2Fsrc%2Fexpand_macro.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Fexpand_macro.rs?ref=1e2d090ab8a9bda18f148b894b7948eb05b976e6", "patch": "@@ -0,0 +1,178 @@\n+//! This modules implements \"expand macro\" functionality in the IDE\n+\n+use crate::{db::RootDatabase, FilePosition};\n+use hir::db::AstDatabase;\n+use ra_db::SourceDatabase;\n+use rustc_hash::FxHashMap;\n+\n+use ra_syntax::{\n+    algo::{find_node_at_offset, replace_descendants},\n+    ast::{self},\n+    AstNode, NodeOrToken, SyntaxKind, SyntaxNode, WalkEvent, T,\n+};\n+\n+pub struct ExpandedMacro {\n+    pub name: String,\n+    pub expansion: String,\n+}\n+\n+pub(crate) fn expand_macro(db: &RootDatabase, position: FilePosition) -> Option<ExpandedMacro> {\n+    let parse = db.parse(position.file_id);\n+    let file = parse.tree();\n+    let name_ref = find_node_at_offset::<ast::NameRef>(file.syntax(), position.offset)?;\n+    let mac = name_ref.syntax().ancestors().find_map(ast::MacroCall::cast)?;\n+\n+    let source = hir::Source::new(position.file_id.into(), mac.syntax());\n+    let expanded = expand_macro_recur(db, source, &mac)?;\n+\n+    // FIXME:\n+    // macro expansion may lose all white space information\n+    // But we hope someday we can use ra_fmt for that\n+    let expansion = insert_whitespaces(expanded);\n+    Some(ExpandedMacro { name: name_ref.text().to_string(), expansion })\n+}\n+\n+fn expand_macro_recur(\n+    db: &RootDatabase,\n+    source: hir::Source<&SyntaxNode>,\n+    macro_call: &ast::MacroCall,\n+) -> Option<SyntaxNode> {\n+    let analyzer = hir::SourceAnalyzer::new(db, source, None);\n+    let expansion = analyzer.expand(db, &macro_call)?;\n+    let macro_file_id = expansion.file_id();\n+    let expanded: SyntaxNode = db.parse_or_expand(macro_file_id)?;\n+\n+    let children = expanded.descendants().filter_map(ast::MacroCall::cast);\n+    let mut replaces = FxHashMap::default();\n+\n+    for child in children.into_iter() {\n+        let source = hir::Source::new(macro_file_id, source.ast);\n+        let new_node = expand_macro_recur(db, source, &child)?;\n+\n+        replaces.insert(child.syntax().clone().into(), new_node.into());\n+    }\n+\n+    Some(replace_descendants(&expanded, &replaces))\n+}\n+\n+// FIXME: It would also be cool to share logic here and in the mbe tests,\n+// which are pretty unreadable at the moment.\n+fn insert_whitespaces(syn: SyntaxNode) -> String {\n+    use SyntaxKind::*;\n+\n+    let mut res = String::new();\n+    let mut token_iter = syn\n+        .preorder_with_tokens()\n+        .filter_map(|event| {\n+            if let WalkEvent::Enter(NodeOrToken::Token(token)) = event {\n+                Some(token)\n+            } else {\n+                None\n+            }\n+        })\n+        .peekable();\n+\n+    let mut indent = 0;\n+    let mut last: Option<SyntaxKind> = None;\n+\n+    while let Some(token) = token_iter.next() {\n+        let mut is_next = |f: fn(SyntaxKind) -> bool, default| -> bool {\n+            token_iter.peek().map(|it| f(it.kind())).unwrap_or(default)\n+        };\n+        let is_last = |f: fn(SyntaxKind) -> bool, default| -> bool {\n+            last.map(|it| f(it)).unwrap_or(default)\n+        };\n+\n+        res += &match token.kind() {\n+            k @ _\n+                if (k.is_keyword() || k.is_literal() || k == IDENT)\n+                    && is_next(|it| !it.is_punct(), true) =>\n+            {\n+                token.text().to_string() + \" \"\n+            }\n+            L_CURLY if is_next(|it| it != R_CURLY, true) => {\n+                indent += 1;\n+                format!(\" {{\\n{}\", \"  \".repeat(indent))\n+            }\n+            R_CURLY if is_last(|it| it != L_CURLY, true) => {\n+                indent = indent.checked_sub(1).unwrap_or(0);\n+                format!(\"\\n}}{}\", \"  \".repeat(indent))\n+            }\n+            R_CURLY => {\n+                indent = indent.checked_sub(1).unwrap_or(0);\n+                format!(\"}}\\n{}\", \"  \".repeat(indent))\n+            }\n+            T![;] => format!(\";\\n{}\", \"  \".repeat(indent)),\n+            T![->] => \" -> \".to_string(),\n+            T![=] => \" = \".to_string(),\n+            T![=>] => \" => \".to_string(),\n+            _ => token.text().to_string(),\n+        };\n+\n+        last = Some(token.kind());\n+    }\n+\n+    res\n+}\n+\n+#[cfg(test)]\n+mod tests {\n+    use super::*;\n+    use crate::mock_analysis::analysis_and_position;\n+    use insta::assert_snapshot;\n+\n+    fn check_expand_macro(fixture: &str) -> ExpandedMacro {\n+        let (analysis, pos) = analysis_and_position(fixture);\n+        analysis.expand_macro(pos).unwrap().unwrap()\n+    }\n+\n+    #[test]\n+    fn macro_expand_recursive_expansion() {\n+        let res = check_expand_macro(\n+            r#\"\n+        //- /lib.rs\n+        macro_rules! bar {\n+            () => { fn  b() {} }\n+        }\n+        macro_rules! foo {\n+            () => { bar!(); }\n+        }\n+        macro_rules! baz {\n+            () => { foo!(); }\n+        }        \n+        f<|>oo!();\n+        \"#,\n+        );\n+\n+        assert_eq!(res.name, \"foo\");\n+        assert_snapshot!(res.expansion, @r###\"\n+fn b(){}\n+\"###);\n+    }\n+\n+    #[test]\n+    fn macro_expand_multiple_lines() {\n+        let res = check_expand_macro(\n+            r#\"\n+        //- /lib.rs\n+        macro_rules! foo {\n+            () => { \n+                fn some_thing() -> u32 {\n+                    let a = 0;\n+                    a + 10\n+                }\n+            }\n+        }\n+        f<|>oo!();\n+        \"#,\n+        );\n+\n+        assert_eq!(res.name, \"foo\");\n+        assert_snapshot!(res.expansion, @r###\"\n+fn some_thing() -> u32 {\n+  let a = 0;\n+  a+10\n+}        \n+\"###);\n+    }\n+}"}, {"sha": "57ed9714706b5ee79b33526ed5007f9f720b711a", "filename": "crates/ra_ide_api/src/lib.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/1e2d090ab8a9bda18f148b894b7948eb05b976e6/crates%2Fra_ide_api%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e2d090ab8a9bda18f148b894b7948eb05b976e6/crates%2Fra_ide_api%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide_api%2Fsrc%2Flib.rs?ref=1e2d090ab8a9bda18f148b894b7948eb05b976e6", "patch": "@@ -42,6 +42,7 @@ mod display;\n mod inlay_hints;\n mod wasm_shims;\n mod expand;\n+mod expand_macro;\n \n #[cfg(test)]\n mod marks;\n@@ -65,6 +66,7 @@ pub use crate::{\n     completion::{CompletionItem, CompletionItemKind, InsertTextFormat},\n     diagnostics::Severity,\n     display::{file_structure, FunctionSignature, NavigationTarget, StructureNode},\n+    expand_macro::ExpandedMacro,\n     feature_flags::FeatureFlags,\n     folding_ranges::{Fold, FoldKind},\n     hover::HoverResult,\n@@ -296,6 +298,10 @@ impl Analysis {\n         self.with_db(|db| syntax_tree::syntax_tree(&db, file_id, text_range))\n     }\n \n+    pub fn expand_macro(&self, position: FilePosition) -> Cancelable<Option<ExpandedMacro>> {\n+        self.with_db(|db| expand_macro::expand_macro(db, position))\n+    }\n+\n     /// Returns an edit to remove all newlines in the range, cleaning up minor\n     /// stuff like trailing commas.\n     pub fn join_lines(&self, frange: FileRange) -> Cancelable<SourceChange> {"}, {"sha": "f828efdee5b1092f334df6035ab2ec7e5bfc8751", "filename": "crates/ra_lsp_server/src/main_loop.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/1e2d090ab8a9bda18f148b894b7948eb05b976e6/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e2d090ab8a9bda18f148b894b7948eb05b976e6/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop.rs?ref=1e2d090ab8a9bda18f148b894b7948eb05b976e6", "patch": "@@ -436,6 +436,7 @@ fn on_request(\n         })?\n         .on::<req::AnalyzerStatus>(handlers::handle_analyzer_status)?\n         .on::<req::SyntaxTree>(handlers::handle_syntax_tree)?\n+        .on::<req::ExpandMacro>(handlers::handle_expand_macro)?\n         .on::<req::OnTypeFormatting>(handlers::handle_on_type_formatting)?\n         .on::<req::DocumentSymbolRequest>(handlers::handle_document_symbol)?\n         .on::<req::WorkspaceSymbol>(handlers::handle_workspace_symbol)?"}, {"sha": "0461bf385422e31eac8ffbf702c1e080da4f818d", "filename": "crates/ra_lsp_server/src/main_loop/handlers.rs", "status": "modified", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/1e2d090ab8a9bda18f148b894b7948eb05b976e6/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop%2Fhandlers.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e2d090ab8a9bda18f148b894b7948eb05b976e6/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop%2Fhandlers.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Fsrc%2Fmain_loop%2Fhandlers.rs?ref=1e2d090ab8a9bda18f148b894b7948eb05b976e6", "patch": "@@ -47,6 +47,24 @@ pub fn handle_syntax_tree(world: WorldSnapshot, params: req::SyntaxTreeParams) -\n     Ok(res)\n }\n \n+pub fn handle_expand_macro(\n+    world: WorldSnapshot,\n+    params: req::ExpandMacroParams,\n+) -> Result<Option<req::ExpandedMacro>> {\n+    let _p = profile(\"handle_expand_macro\");\n+    let file_id = params.text_document.try_conv_with(&world)?;\n+    let line_index = world.analysis().file_line_index(file_id)?;\n+    let offset = params.position.map(|p| p.conv_with(&line_index));\n+\n+    match offset {\n+        None => Ok(None),\n+        Some(offset) => {\n+            let res = world.analysis().expand_macro(FilePosition { file_id, offset })?;\n+            Ok(res.map(|it| req::ExpandedMacro { name: it.name, expansion: it.expansion }))\n+        }\n+    }\n+}\n+\n pub fn handle_selection_range(\n     world: WorldSnapshot,\n     params: req::SelectionRangeParams,"}, {"sha": "39361b7e8fd32ed57200fd1e164f83a8b0104ca8", "filename": "crates/ra_lsp_server/src/req.rs", "status": "modified", "additions": 22, "deletions": 0, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/1e2d090ab8a9bda18f148b894b7948eb05b976e6/crates%2Fra_lsp_server%2Fsrc%2Freq.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e2d090ab8a9bda18f148b894b7948eb05b976e6/crates%2Fra_lsp_server%2Fsrc%2Freq.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_lsp_server%2Fsrc%2Freq.rs?ref=1e2d090ab8a9bda18f148b894b7948eb05b976e6", "patch": "@@ -45,6 +45,28 @@ pub struct SyntaxTreeParams {\n     pub range: Option<Range>,\n }\n \n+#[derive(Serialize, Debug)]\n+#[serde(rename_all = \"camelCase\")]\n+pub struct ExpandedMacro {\n+    pub name: String,\n+    pub expansion: String,\n+}\n+\n+pub enum ExpandMacro {}\n+\n+impl Request for ExpandMacro {\n+    type Params = ExpandMacroParams;\n+    type Result = Option<ExpandedMacro>;\n+    const METHOD: &'static str = \"rust-analyzer/expandMacro\";\n+}\n+\n+#[derive(Deserialize, Debug)]\n+#[serde(rename_all = \"camelCase\")]\n+pub struct ExpandMacroParams {\n+    pub text_document: TextDocumentIdentifier,\n+    pub position: Option<Position>,\n+}\n+\n pub enum SelectionRangeRequest {}\n \n impl Request for SelectionRangeRequest {"}, {"sha": "5db2b58c0bd672f2ab0093617697ddf59dc94325", "filename": "crates/ra_syntax/Cargo.toml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1e2d090ab8a9bda18f148b894b7948eb05b976e6/crates%2Fra_syntax%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/1e2d090ab8a9bda18f148b894b7948eb05b976e6/crates%2Fra_syntax%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_syntax%2FCargo.toml?ref=1e2d090ab8a9bda18f148b894b7948eb05b976e6", "patch": "@@ -12,7 +12,7 @@ doctest = false\n \n [dependencies]\n itertools = \"0.8.0\"\n-rowan = \"0.6.1\"\n+rowan = \"0.7.0\"\n rustc_lexer = \"0.1.0\"\n rustc-hash = \"1.0.1\"\n arrayvec = \"0.5.1\""}, {"sha": "1c075082a4ac771cb3298c38f6c3e7d344efff20", "filename": "crates/ra_syntax/src/algo.rs", "status": "modified", "additions": 16, "deletions": 17, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/1e2d090ab8a9bda18f148b894b7948eb05b976e6/crates%2Fra_syntax%2Fsrc%2Falgo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e2d090ab8a9bda18f148b894b7948eb05b976e6/crates%2Fra_syntax%2Fsrc%2Falgo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_syntax%2Fsrc%2Falgo.rs?ref=1e2d090ab8a9bda18f148b894b7948eb05b976e6", "patch": "@@ -134,23 +134,19 @@ pub fn insert_children(\n         to_green_element(element)\n     });\n \n-    let old_children = parent.green().children();\n+    let mut old_children = parent.green().children().map(|it| match it {\n+        NodeOrToken::Token(it) => NodeOrToken::Token(it.clone()),\n+        NodeOrToken::Node(it) => NodeOrToken::Node(it.clone()),\n+    });\n \n     let new_children = match &position {\n-        InsertPosition::First => {\n-            to_insert.chain(old_children.iter().cloned()).collect::<Box<[_]>>()\n-        }\n-        InsertPosition::Last => old_children.iter().cloned().chain(to_insert).collect::<Box<[_]>>(),\n+        InsertPosition::First => to_insert.chain(old_children).collect::<Box<[_]>>(),\n+        InsertPosition::Last => old_children.chain(to_insert).collect::<Box<[_]>>(),\n         InsertPosition::Before(anchor) | InsertPosition::After(anchor) => {\n             let take_anchor = if let InsertPosition::After(_) = position { 1 } else { 0 };\n             let split_at = position_of_child(parent, anchor.clone()) + take_anchor;\n-            let (before, after) = old_children.split_at(split_at);\n-            before\n-                .iter()\n-                .cloned()\n-                .chain(to_insert)\n-                .chain(after.iter().cloned())\n-                .collect::<Box<[_]>>()\n+            let before = old_children.by_ref().take(split_at).collect::<Vec<_>>();\n+            before.into_iter().chain(to_insert).chain(old_children).collect::<Box<[_]>>()\n         }\n     };\n \n@@ -168,13 +164,16 @@ pub fn replace_children(\n ) -> SyntaxNode {\n     let start = position_of_child(parent, to_delete.start().clone());\n     let end = position_of_child(parent, to_delete.end().clone());\n-    let old_children = parent.green().children();\n+    let mut old_children = parent.green().children().map(|it| match it {\n+        NodeOrToken::Token(it) => NodeOrToken::Token(it.clone()),\n+        NodeOrToken::Node(it) => NodeOrToken::Node(it.clone()),\n+    });\n \n-    let new_children = old_children[..start]\n-        .iter()\n-        .cloned()\n+    let before = old_children.by_ref().take(start).collect::<Vec<_>>();\n+    let new_children = before\n+        .into_iter()\n         .chain(to_insert.map(to_green_element))\n-        .chain(old_children[end + 1..].iter().cloned())\n+        .chain(old_children.skip(end + 1 - start))\n         .collect::<Box<[_]>>();\n     with_children(parent, new_children)\n }"}, {"sha": "4851dacb2e709629adad891e3d50fd8efad7e009", "filename": "crates/ra_syntax/src/ast/extensions.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1e2d090ab8a9bda18f148b894b7948eb05b976e6/crates%2Fra_syntax%2Fsrc%2Fast%2Fextensions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/1e2d090ab8a9bda18f148b894b7948eb05b976e6/crates%2Fra_syntax%2Fsrc%2Fast%2Fextensions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_syntax%2Fsrc%2Fast%2Fextensions.rs?ref=1e2d090ab8a9bda18f148b894b7948eb05b976e6", "patch": "@@ -32,7 +32,7 @@ impl ast::NameRef {\n }\n \n fn text_of_first_token(node: &SyntaxNode) -> &SmolStr {\n-    node.green().children().first().and_then(|it| it.as_token()).unwrap().text()\n+    node.green().children().next().and_then(|it| it.into_token()).unwrap().text()\n }\n \n impl ast::Attr {"}, {"sha": "309d2775d5d9dc54061bdb4d9f0b2940a60b4596", "filename": "docs/user/features.md", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/1e2d090ab8a9bda18f148b894b7948eb05b976e6/docs%2Fuser%2Ffeatures.md", "raw_url": "https://github.com/rust-lang/rust/raw/1e2d090ab8a9bda18f148b894b7948eb05b976e6/docs%2Fuser%2Ffeatures.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/docs%2Fuser%2Ffeatures.md?ref=1e2d090ab8a9bda18f148b894b7948eb05b976e6", "patch": "@@ -81,6 +81,10 @@ Join selected lines into one, smartly fixing up whitespace and trailing commas.\n Shows the parse tree of the current file. It exists mostly for debugging\n rust-analyzer itself.\n \n+#### Expand Macro Recursively\n+\n+Shows the full macro expansion of the macro at current cursor.\n+\n #### Status\n \n Shows internal statistic about memory usage of rust-analyzer"}, {"sha": "e21dfa1745db92839f9046fc6fcd13ca84b35d02", "filename": "editors/code/package.json", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/1e2d090ab8a9bda18f148b894b7948eb05b976e6/editors%2Fcode%2Fpackage.json", "raw_url": "https://github.com/rust-lang/rust/raw/1e2d090ab8a9bda18f148b894b7948eb05b976e6/editors%2Fcode%2Fpackage.json", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fpackage.json?ref=1e2d090ab8a9bda18f148b894b7948eb05b976e6", "patch": "@@ -91,6 +91,11 @@\n                 \"title\": \"Show Syntax Tree\",\n                 \"category\": \"Rust Analyzer\"\n             },\n+            {\n+                \"command\": \"rust-analyzer.expandMacro\",\n+                \"title\": \"Expand macro recursively\",\n+                \"category\": \"Rust Analyzer\"\n+            },\n             {\n                 \"command\": \"rust-analyzer.matchingBrace\",\n                 \"title\": \"Find matching brace\","}, {"sha": "34e0c8fb337a84cced6878c3f584bbe75bb59041", "filename": "editors/code/src/commands/expand_macro.ts", "status": "added", "additions": 83, "deletions": 0, "changes": 83, "blob_url": "https://github.com/rust-lang/rust/blob/1e2d090ab8a9bda18f148b894b7948eb05b976e6/editors%2Fcode%2Fsrc%2Fcommands%2Fexpand_macro.ts", "raw_url": "https://github.com/rust-lang/rust/raw/1e2d090ab8a9bda18f148b894b7948eb05b976e6/editors%2Fcode%2Fsrc%2Fcommands%2Fexpand_macro.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fcommands%2Fexpand_macro.ts?ref=1e2d090ab8a9bda18f148b894b7948eb05b976e6", "patch": "@@ -0,0 +1,83 @@\n+import * as vscode from 'vscode';\n+import { Position, TextDocumentIdentifier } from 'vscode-languageclient';\n+import { Server } from '../server';\n+\n+export const expandMacroUri = vscode.Uri.parse(\n+    'rust-analyzer://expandMacro/[EXPANSION].rs'\n+);\n+\n+export class ExpandMacroContentProvider\n+    implements vscode.TextDocumentContentProvider {\n+    public eventEmitter = new vscode.EventEmitter<vscode.Uri>();\n+\n+    public provideTextDocumentContent(\n+        uri: vscode.Uri\n+    ): vscode.ProviderResult<string> {\n+        async function handle() {\n+            const editor = vscode.window.activeTextEditor;\n+            if (editor == null) {\n+                return '';\n+            }\n+\n+            const position = editor.selection.active;\n+            const request: MacroExpandParams = {\n+                textDocument: { uri: editor.document.uri.toString() },\n+                position\n+            };\n+            const expanded = await Server.client.sendRequest<ExpandedMacro>(\n+                'rust-analyzer/expandMacro',\n+                request\n+            );\n+\n+            if (expanded == null) {\n+                return 'Not available';\n+            }\n+\n+            return code_format(expanded);\n+        }\n+\n+        return handle();\n+    }\n+\n+    get onDidChange(): vscode.Event<vscode.Uri> {\n+        return this.eventEmitter.event;\n+    }\n+}\n+\n+// Opens the virtual file that will show the syntax tree\n+//\n+// The contents of the file come from the `TextDocumentContentProvider`\n+export function createHandle(provider: ExpandMacroContentProvider) {\n+    return async () => {\n+        const uri = expandMacroUri;\n+\n+        const document = await vscode.workspace.openTextDocument(uri);\n+\n+        provider.eventEmitter.fire(uri);\n+\n+        return vscode.window.showTextDocument(\n+            document,\n+            vscode.ViewColumn.Two,\n+            true\n+        );\n+    };\n+}\n+\n+interface MacroExpandParams {\n+    textDocument: TextDocumentIdentifier;\n+    position: Position;\n+}\n+\n+interface ExpandedMacro {\n+    name: string;\n+    expansion: string;\n+}\n+\n+function code_format(expanded: ExpandedMacro): string {\n+    let result = `// Recursive expansion of ${expanded.name}! macro\\n`;\n+    result += '// ' + '='.repeat(result.length - 3);\n+    result += '\\n\\n';\n+    result += expanded.expansion;\n+\n+    return result;\n+}"}, {"sha": "2ade6d331a76ef6cac0c721a024dcfac041165dd", "filename": "editors/code/src/commands/index.ts", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/1e2d090ab8a9bda18f148b894b7948eb05b976e6/editors%2Fcode%2Fsrc%2Fcommands%2Findex.ts", "raw_url": "https://github.com/rust-lang/rust/raw/1e2d090ab8a9bda18f148b894b7948eb05b976e6/editors%2Fcode%2Fsrc%2Fcommands%2Findex.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fcommands%2Findex.ts?ref=1e2d090ab8a9bda18f148b894b7948eb05b976e6", "patch": "@@ -1,5 +1,6 @@\n import * as analyzerStatus from './analyzer_status';\n import * as applySourceChange from './apply_source_change';\n+import * as expandMacro from './expand_macro';\n import * as inlayHints from './inlay_hints';\n import * as joinLines from './join_lines';\n import * as matchingBrace from './matching_brace';\n@@ -11,6 +12,7 @@ import * as syntaxTree from './syntaxTree';\n export {\n     analyzerStatus,\n     applySourceChange,\n+    expandMacro,\n     joinLines,\n     matchingBrace,\n     parentModule,"}, {"sha": "683497dfd4dc9d7e3911b47b5f835c3049cd40af", "filename": "editors/code/src/extension.ts", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/1e2d090ab8a9bda18f148b894b7948eb05b976e6/editors%2Fcode%2Fsrc%2Fextension.ts", "raw_url": "https://github.com/rust-lang/rust/raw/1e2d090ab8a9bda18f148b894b7948eb05b976e6/editors%2Fcode%2Fsrc%2Fextension.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fextension.ts?ref=1e2d090ab8a9bda18f148b894b7948eb05b976e6", "patch": "@@ -3,6 +3,7 @@ import * as lc from 'vscode-languageclient';\n \n import * as commands from './commands';\n import { CargoWatchProvider } from './commands/cargo_watch';\n+import { ExpandMacroContentProvider } from './commands/expand_macro';\n import { HintsUpdater } from './commands/inlay_hints';\n import {\n     interactivelyStartCargoWatch,\n@@ -97,6 +98,7 @@ export function activate(context: vscode.ExtensionContext) {\n         ]\n     ];\n     const syntaxTreeContentProvider = new SyntaxTreeContentProvider();\n+    const expandMacroContentProvider = new ExpandMacroContentProvider();\n \n     // The events below are plain old javascript events, triggered and handled by vscode\n     vscode.window.onDidChangeActiveTextEditor(\n@@ -109,11 +111,21 @@ export function activate(context: vscode.ExtensionContext) {\n             syntaxTreeContentProvider\n         )\n     );\n+    disposeOnDeactivation(\n+        vscode.workspace.registerTextDocumentContentProvider(\n+            'rust-analyzer',\n+            expandMacroContentProvider\n+        )\n+    );\n \n     registerCommand(\n         'rust-analyzer.syntaxTree',\n         commands.syntaxTree.createHandle(syntaxTreeContentProvider)\n     );\n+    registerCommand(\n+        'rust-analyzer.expandMacro',\n+        commands.expandMacro.createHandle(expandMacroContentProvider)\n+    );\n \n     vscode.workspace.onDidChangeTextDocument(\n         events.changeTextDocument.createHandler(syntaxTreeContentProvider),"}]}