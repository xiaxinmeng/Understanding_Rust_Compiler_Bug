{"sha": "85c119cd519150133279d9f3ae8e964d42a93e6e", "node_id": "C_kwDOAAsO6NoAKDg1YzExOWNkNTE5MTUwMTMzMjc5ZDlmM2FlOGU5NjRkNDJhOTNlNmU", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-01-15T10:28:26Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-01-15T10:28:26Z"}, "message": "Rollup merge of #92873 - eholk:async-symbol-names, r=tmandry\n\nGenerate more precise generator names\n\nCurrently all generators are named with a `generator$N` suffix, regardless of where they come from. This means an `async fn` shows up as a generator in stack traces, which can be surprising to async programmers since they should not need to know that async functions are implementated using generators.\n\nThis change generators a different name depending on the generator kind, allowing us to tell whether the generator is the result of an async block, an async closure, an async fn, or a plain generator.\n\nr? `@tmandry`\ncc `@michaelwoerister` `@wesleywiser` `@dpaoliello`", "tree": {"sha": "015cc7c751beafc79b178d966c3b77f85a1c0cad", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/015cc7c751beafc79b178d966c3b77f85a1c0cad"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/85c119cd519150133279d9f3ae8e964d42a93e6e", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJh4qHLCRBK7hj4Ov3rIwAAcf0IAJoxcvJjB9verfyLzrc/5/tP\nvyq4XDwrGqQtZROxG/F7KiJoIKSfGdtQyAnu7OItDZ+N2nWFzKVapBktLkyhaAvO\nxjbUe69xBeMIAsJ0rRiOx8J18Td70kpeaMUaNugazOkKRdsSPCUYhGh+ZGQr+pXv\nM/LTecoVLsIHBQQuDKZAIaH/9uiI4qY2La8dTipKEB6cAO9WXXN83/UQiLgwyGZi\nfePfiW08BZAM9t1BxSR9dwbxzJdz5nl/+kAqeoOtlBljambQErsDjb05Yashvlx1\n3OYvgSp3/qxCfssXdfsFfbufK3V1pU3iPeCIYVt7OylacoCbk5uE6LOu7KumlqE=\n=nX3f\n-----END PGP SIGNATURE-----\n", "payload": "tree 015cc7c751beafc79b178d966c3b77f85a1c0cad\nparent cd93be0094a135c55533cb0eba342e5aa1324f00\nparent a1173cf074ad557e8c896680537969f6b6942368\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1642242506 +0100\ncommitter GitHub <noreply@github.com> 1642242506 +0100\n\nRollup merge of #92873 - eholk:async-symbol-names, r=tmandry\n\nGenerate more precise generator names\n\nCurrently all generators are named with a `generator$N` suffix, regardless of where they come from. This means an `async fn` shows up as a generator in stack traces, which can be surprising to async programmers since they should not need to know that async functions are implementated using generators.\n\nThis change generators a different name depending on the generator kind, allowing us to tell whether the generator is the result of an async block, an async closure, an async fn, or a plain generator.\n\nr? `@tmandry`\ncc `@michaelwoerister` `@wesleywiser` `@dpaoliello`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/85c119cd519150133279d9f3ae8e964d42a93e6e", "html_url": "https://github.com/rust-lang/rust/commit/85c119cd519150133279d9f3ae8e964d42a93e6e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/85c119cd519150133279d9f3ae8e964d42a93e6e/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cd93be0094a135c55533cb0eba342e5aa1324f00", "url": "https://api.github.com/repos/rust-lang/rust/commits/cd93be0094a135c55533cb0eba342e5aa1324f00", "html_url": "https://github.com/rust-lang/rust/commit/cd93be0094a135c55533cb0eba342e5aa1324f00"}, {"sha": "a1173cf074ad557e8c896680537969f6b6942368", "url": "https://api.github.com/repos/rust-lang/rust/commits/a1173cf074ad557e8c896680537969f6b6942368", "html_url": "https://github.com/rust-lang/rust/commit/a1173cf074ad557e8c896680537969f6b6942368"}], "stats": {"total": 14, "additions": 10, "deletions": 4}, "files": [{"sha": "61322a6e556ed02cd418b28793035f0dc1b649ad", "filename": "compiler/rustc_codegen_ssa/src/debuginfo/type_names.rs", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/85c119cd519150133279d9f3ae8e964d42a93e6e/compiler%2Frustc_codegen_ssa%2Fsrc%2Fdebuginfo%2Ftype_names.rs", "raw_url": "https://github.com/rust-lang/rust/raw/85c119cd519150133279d9f3ae8e964d42a93e6e/compiler%2Frustc_codegen_ssa%2Fsrc%2Fdebuginfo%2Ftype_names.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fdebuginfo%2Ftype_names.rs?ref=85c119cd519150133279d9f3ae8e964d42a93e6e", "patch": "@@ -519,12 +519,18 @@ fn push_unqualified_item_name(\n             output.push_str(tcx.crate_name(def_id.krate).as_str());\n         }\n         DefPathData::ClosureExpr if tcx.generator_kind(def_id).is_some() => {\n+            let key = match tcx.generator_kind(def_id).unwrap() {\n+                hir::GeneratorKind::Async(hir::AsyncGeneratorKind::Block) => \"async_block\",\n+                hir::GeneratorKind::Async(hir::AsyncGeneratorKind::Closure) => \"async_closure\",\n+                hir::GeneratorKind::Async(hir::AsyncGeneratorKind::Fn) => \"async_fn\",\n+                hir::GeneratorKind::Gen => \"generator\",\n+            };\n             // Generators look like closures, but we want to treat them differently\n             // in the debug info.\n             if cpp_like_debuginfo(tcx) {\n-                write!(output, \"generator${}\", disambiguated_data.disambiguator).unwrap();\n+                write!(output, \"{}${}\", key, disambiguated_data.disambiguator).unwrap();\n             } else {\n-                write!(output, \"{{generator#{}}}\", disambiguated_data.disambiguator).unwrap();\n+                write!(output, \"{{{}#{}}}\", key, disambiguated_data.disambiguator).unwrap();\n             }\n         }\n         _ => match disambiguated_data.data.name() {"}, {"sha": "bb0db9d3d8514bdfa0158316329075579ec626ef", "filename": "src/test/codegen/async-fn-debug-msvc.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/85c119cd519150133279d9f3ae8e964d42a93e6e/src%2Ftest%2Fcodegen%2Fasync-fn-debug-msvc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/85c119cd519150133279d9f3ae8e964d42a93e6e/src%2Ftest%2Fcodegen%2Fasync-fn-debug-msvc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fasync-fn-debug-msvc.rs?ref=85c119cd519150133279d9f3ae8e964d42a93e6e", "patch": "@@ -17,7 +17,7 @@ async fn async_fn_test() {\n // FIXME: No way to reliably check the filename.\n \n // CHECK-DAG:  [[ASYNC_FN:!.*]] = !DINamespace(name: \"async_fn_test\"\n-// CHECK-DAG:  [[GEN:!.*]] = !DICompositeType(tag: DW_TAG_union_type, name: \"generator$0\"\n+// CHECK-DAG:  [[GEN:!.*]] = !DICompositeType(tag: DW_TAG_union_type, name: \"async_fn$0\"\n // CHECK:      {{!.*}} = !DIDerivedType(tag: DW_TAG_member, name: \"variant0\", scope: [[GEN]],\n // For brevity, we only check the struct name and members of the last variant.\n // CHECK-SAME: file: [[FILE:![0-9]*]], line: 11,"}, {"sha": "f456f7ffc0fba7f6b6ce4e8e8790a7c9643d0d88", "filename": "src/test/codegen/async-fn-debug.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/85c119cd519150133279d9f3ae8e964d42a93e6e/src%2Ftest%2Fcodegen%2Fasync-fn-debug.rs", "raw_url": "https://github.com/rust-lang/rust/raw/85c119cd519150133279d9f3ae8e964d42a93e6e/src%2Ftest%2Fcodegen%2Fasync-fn-debug.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fasync-fn-debug.rs?ref=85c119cd519150133279d9f3ae8e964d42a93e6e", "patch": "@@ -17,7 +17,7 @@ async fn async_fn_test() {\n // FIXME: No way to reliably check the filename.\n \n // CHECK-DAG:  [[ASYNC_FN:!.*]] = !DINamespace(name: \"async_fn_test\"\n-// CHECK-DAG:  [[GEN:!.*]] = !DICompositeType(tag: DW_TAG_structure_type, name: \"{generator#0}\", scope: [[ASYNC_FN]]\n+// CHECK-DAG:  [[GEN:!.*]] = !DICompositeType(tag: DW_TAG_structure_type, name: \"{async_fn#0}\", scope: [[ASYNC_FN]]\n // CHECK:      [[VARIANT:!.*]] = !DICompositeType(tag: DW_TAG_variant_part, scope: [[ASYNC_FN]],\n // CHECK-NOT:  flags: DIFlagArtificial\n // CHECK-SAME: discriminator: [[DISC:![0-9]*]]"}]}