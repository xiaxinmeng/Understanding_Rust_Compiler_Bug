{"sha": "a9d62be557a648f254c6850e2a08917686a26976", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE5ZDYyYmU1NTdhNjQ4ZjI1NGM2ODUwZTJhMDg5MTc2ODZhMjY5NzY=", "commit": {"author": {"name": "Dan Robertson", "email": "dan@dlrobertson.com", "date": "2019-03-27T13:00:37Z"}, "committer": {"name": "Dan Robertson", "email": "dan@dlrobertson.com", "date": "2019-03-31T17:37:37Z"}, "message": "Fix LLVM IR generated for C-variadic arguments\n\nIt is possible to create malformed LLVM IR given variadic arguments that\nare aggregate types. This occurs due to improper tracking of the current\nargument in the functions list of arguments.", "tree": {"sha": "98295c7ffc52b7bcbc92dd7d2caa6f6a7f6f7401", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/98295c7ffc52b7bcbc92dd7d2caa6f6a7f6f7401"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a9d62be557a648f254c6850e2a08917686a26976", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEF5dO2RaKc5C+SCJ9RcSmUsR+QqUFAlyg+uMACgkQRcSmUsR+\nQqXACRAAiSu0byoMrcUxvCuFNKJdHT7rQF1bUPjDAYIrDtvtQFN+86uYiGTmziYK\nn3c5GvgBaTlhYhTtAl/ePAUEXH8CCRVCPAvge2jS7ptBMWPXXeJ/NWCnd6azWnXG\nuu0Fp8Ud2xiV6l4Q57QTisBzAEdd7MV1uk5JEhjHLHYBEpPol6W0+joCG/ZSFNz3\nKwrtZcbkRSegz34PGLrbjJPSg/j2twVn5Aq2WaKdn9UQD/qstfowaZEP06fy+xhE\n1SISAYzPh96qJSx4u9RdL2NXsHlWRVtg9IBGfImv9v2hND/d1eVHwlNkV0R7I2I8\nkAJA+zgI6dYvx5YM2JHf3brrSzHh2gNmMhjj5VxNVQ+TXgeqgKAzsj7TiKyJ8c5v\nNsINAyPsIRk0bw4Kns8EWSxafO4PBGwiMefSlOqvtLWwpTXTVlDaVFQrC/HSzvbN\nM/jxmOfwAXnis3GjIB8CtiCxP5rh0c/cKdez4nhBbkqvCiGSZadiWuDZNLIv7+Rn\nrUq+roOVH1lQ/agm975ktzNyhPWn3eI04gsRx5kjaPe9xfaKnaK7AXjBz3mqTYwK\nz/je+/SswEM88THODzb23ZyPMYc0Ku9BAa+spuvl2x5LYh6Y+Y0K6b0rzWTS77vi\nnl30gO6G0IY00XhsjYTszWqxURfftSCu6k16SsXmhqIg79s3kfw=\n=YZ0W\n-----END PGP SIGNATURE-----", "payload": "tree 98295c7ffc52b7bcbc92dd7d2caa6f6a7f6f7401\nparent b0fcfa7d6135ecfdfebd325683890ae6dcf5eb18\nauthor Dan Robertson <dan@dlrobertson.com> 1553691637 +0000\ncommitter Dan Robertson <dan@dlrobertson.com> 1554053857 +0000\n\nFix LLVM IR generated for C-variadic arguments\n\nIt is possible to create malformed LLVM IR given variadic arguments that\nare aggregate types. This occurs due to improper tracking of the current\nargument in the functions list of arguments.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a9d62be557a648f254c6850e2a08917686a26976", "html_url": "https://github.com/rust-lang/rust/commit/a9d62be557a648f254c6850e2a08917686a26976", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a9d62be557a648f254c6850e2a08917686a26976/comments", "author": {"login": "dlrobertson", "id": 7504153, "node_id": "MDQ6VXNlcjc1MDQxNTM=", "avatar_url": "https://avatars.githubusercontent.com/u/7504153?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dlrobertson", "html_url": "https://github.com/dlrobertson", "followers_url": "https://api.github.com/users/dlrobertson/followers", "following_url": "https://api.github.com/users/dlrobertson/following{/other_user}", "gists_url": "https://api.github.com/users/dlrobertson/gists{/gist_id}", "starred_url": "https://api.github.com/users/dlrobertson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dlrobertson/subscriptions", "organizations_url": "https://api.github.com/users/dlrobertson/orgs", "repos_url": "https://api.github.com/users/dlrobertson/repos", "events_url": "https://api.github.com/users/dlrobertson/events{/privacy}", "received_events_url": "https://api.github.com/users/dlrobertson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "dlrobertson", "id": 7504153, "node_id": "MDQ6VXNlcjc1MDQxNTM=", "avatar_url": "https://avatars.githubusercontent.com/u/7504153?v=4", "gravatar_id": "", "url": "https://api.github.com/users/dlrobertson", "html_url": "https://github.com/dlrobertson", "followers_url": "https://api.github.com/users/dlrobertson/followers", "following_url": "https://api.github.com/users/dlrobertson/following{/other_user}", "gists_url": "https://api.github.com/users/dlrobertson/gists{/gist_id}", "starred_url": "https://api.github.com/users/dlrobertson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/dlrobertson/subscriptions", "organizations_url": "https://api.github.com/users/dlrobertson/orgs", "repos_url": "https://api.github.com/users/dlrobertson/repos", "events_url": "https://api.github.com/users/dlrobertson/events{/privacy}", "received_events_url": "https://api.github.com/users/dlrobertson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b0fcfa7d6135ecfdfebd325683890ae6dcf5eb18", "url": "https://api.github.com/repos/rust-lang/rust/commits/b0fcfa7d6135ecfdfebd325683890ae6dcf5eb18", "html_url": "https://github.com/rust-lang/rust/commit/b0fcfa7d6135ecfdfebd325683890ae6dcf5eb18"}], "stats": {"total": 36, "additions": 23, "deletions": 13}, "files": [{"sha": "26442faa3215c48a39e51312757992fc36f9b224", "filename": "src/librustc_codegen_ssa/mir/block.rs", "status": "modified", "additions": 2, "deletions": 13, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/a9d62be557a648f254c6850e2a08917686a26976/src%2Flibrustc_codegen_ssa%2Fmir%2Fblock.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a9d62be557a648f254c6850e2a08917686a26976/src%2Flibrustc_codegen_ssa%2Fmir%2Fblock.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fmir%2Fblock.rs?ref=a9d62be557a648f254c6850e2a08917686a26976", "patch": "@@ -20,7 +20,7 @@ use syntax_pos::Pos;\n \n use super::{FunctionCx, LocalRef};\n use super::place::PlaceRef;\n-use super::operand::{OperandValue, OperandRef};\n+use super::operand::OperandRef;\n use super::operand::OperandValue::{Pair, Ref, Immediate};\n \n /// Used by `FunctionCx::codegen_terminator` for emitting common patterns\n@@ -695,18 +695,7 @@ impl<'a, 'tcx: 'a, Bx: BuilderMethods<'a, 'tcx>> FunctionCx<'a, 'tcx, Bx> {\n             // an \"spoofed\" `VaList`. This argument is ignored, but we need to\n             // populate it with a dummy operand so that the users real arguments\n             // are not overwritten.\n-            let i = if sig.c_variadic && last_arg_idx.map(|x| x == i).unwrap_or(false) {\n-                let layout = match self.cx.tcx().lang_items().va_list() {\n-                    Some(did) => bx.cx().layout_of(bx.tcx().type_of(did)),\n-                    None => bug!(\"`va_list` language item required for C-variadics\"),\n-                };\n-                let op = OperandRef {\n-                    val: OperandValue::Immediate(\n-                        bx.cx().const_undef(bx.cx().immediate_backend_type(layout)\n-                    )),\n-                    layout: layout,\n-                };\n-                self.codegen_argument(&mut bx, op, &mut llargs, &fn_ty.args[i]);\n+            let i = if sig.c_variadic && last_arg_idx.map(|x| i >= x).unwrap_or(false) {\n                 if i + 1 < fn_ty.args.len() {\n                     i + 1\n                 } else {"}, {"sha": "de451324f03c45e05db65128ee2e6584c860856e", "filename": "src/test/codegen/issue-58881.rs", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/a9d62be557a648f254c6850e2a08917686a26976/src%2Ftest%2Fcodegen%2Fissue-58881.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a9d62be557a648f254c6850e2a08917686a26976/src%2Ftest%2Fcodegen%2Fissue-58881.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fissue-58881.rs?ref=a9d62be557a648f254c6850e2a08917686a26976", "patch": "@@ -0,0 +1,21 @@\n+// compile-flags: -C no-prepopulate-passes\n+//\n+// only-x86_64\n+// ignore-windows\n+\n+#![crate_type = \"lib\"]\n+\n+extern \"C\" {\n+    fn variadic_fn(_: i32, ...);\n+}\n+\n+#[repr(C)]\n+struct Foo(u8);\n+#[repr(C)]\n+struct Bar(u64, u64, u64);\n+\n+// Ensure that emit arguments of the correct type.\n+pub unsafe fn test_call_variadic() {\n+    // CHECK: call void (i32, ...) @variadic_fn(i32 0, i8 {{.*}}, %Bar* {{.*}})\n+    variadic_fn(0, Foo(0), Bar(0, 0, 0))\n+}"}]}