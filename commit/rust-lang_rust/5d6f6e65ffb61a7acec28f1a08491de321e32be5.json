{"sha": "5d6f6e65ffb61a7acec28f1a08491de321e32be5", "node_id": "MDY6Q29tbWl0NzI0NzEyOjVkNmY2ZTY1ZmZiNjFhN2FjZWMyOGYxYTA4NDkxZGUzMjFlMzJiZTU=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-01-14T11:28:27Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2018-01-14T11:28:27Z"}, "message": "Auto merge of #47274 - Manishearth:rustdoc-span, r=QuietMisdreavus\n\nUse correct line offsets for doctests\n\nNot yet tested.\n\nThis doesn't handle char positions. It could if I collected a map of char offsets and lines, but this is a bit more work and requires hooking into the parser much more (unsure if it's possible).\n\nr? @QuietMisdreavus\n\n(fixes #45868)", "tree": {"sha": "d0cd97e077026036e5c8eb4121c6fbb83a0e40dd", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d0cd97e077026036e5c8eb4121c6fbb83a0e40dd"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5d6f6e65ffb61a7acec28f1a08491de321e32be5", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5d6f6e65ffb61a7acec28f1a08491de321e32be5", "html_url": "https://github.com/rust-lang/rust/commit/5d6f6e65ffb61a7acec28f1a08491de321e32be5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5d6f6e65ffb61a7acec28f1a08491de321e32be5/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "48ab4cde5460f9f7c57249e4e62ad569dc843dd8", "url": "https://api.github.com/repos/rust-lang/rust/commits/48ab4cde5460f9f7c57249e4e62ad569dc843dd8", "html_url": "https://github.com/rust-lang/rust/commit/48ab4cde5460f9f7c57249e4e62ad569dc843dd8"}, {"sha": "44b659ac2d7563198ce3ae39a4bfcecc6954fe21", "url": "https://api.github.com/repos/rust-lang/rust/commits/44b659ac2d7563198ce3ae39a4bfcecc6954fe21", "html_url": "https://github.com/rust-lang/rust/commit/44b659ac2d7563198ce3ae39a4bfcecc6954fe21"}], "stats": {"total": 95, "additions": 84, "deletions": 11}, "files": [{"sha": "1c3d4af9e1888cd19f79915a1de2d21a929e5fc7", "filename": "src/librustc_errors/emitter.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/5d6f6e65ffb61a7acec28f1a08491de321e32be5/src%2Flibrustc_errors%2Femitter.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5d6f6e65ffb61a7acec28f1a08491de321e32be5/src%2Flibrustc_errors%2Femitter.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_errors%2Femitter.rs?ref=5d6f6e65ffb61a7acec28f1a08491de321e32be5", "patch": "@@ -990,7 +990,7 @@ impl EmitterWriter {\n                     buffer.append(buffer_msg_line_offset,\n                                   &format!(\"{}:{}:{}\",\n                                            loc.file.name,\n-                                           loc.line,\n+                                           cm.doctest_offset_line(loc.line),\n                                            loc.col.0 + 1),\n                                   Style::LineAndColumn);\n                     for _ in 0..max_line_num_len {\n@@ -1000,7 +1000,7 @@ impl EmitterWriter {\n                     buffer.prepend(0,\n                                    &format!(\"{}:{}:{} - \",\n                                             loc.file.name,\n-                                            loc.line,\n+                                            cm.doctest_offset_line(loc.line),\n                                             loc.col.0 + 1),\n                                    Style::LineAndColumn);\n                 }"}, {"sha": "1fb673815eea328c1f34955e73ba5f7e27e7d5ae", "filename": "src/librustc_errors/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/5d6f6e65ffb61a7acec28f1a08491de321e32be5/src%2Flibrustc_errors%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5d6f6e65ffb61a7acec28f1a08491de321e32be5/src%2Flibrustc_errors%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_errors%2Flib.rs?ref=5d6f6e65ffb61a7acec28f1a08491de321e32be5", "patch": "@@ -103,6 +103,7 @@ pub trait CodeMapper {\n     fn merge_spans(&self, sp_lhs: Span, sp_rhs: Span) -> Option<Span>;\n     fn call_span_if_macro(&self, sp: Span) -> Span;\n     fn ensure_filemap_source_present(&self, file_map: Rc<FileMap>) -> bool;\n+    fn doctest_offset_line(&self, line: usize) -> usize;\n }\n \n impl CodeSuggestion {"}, {"sha": "e66add20376fac9d06983ffc3d6b1e50aba83ca4", "filename": "src/librustdoc/html/markdown.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/5d6f6e65ffb61a7acec28f1a08491de321e32be5/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5d6f6e65ffb61a7acec28f1a08491de321e32be5/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fmarkdown.rs?ref=5d6f6e65ffb61a7acec28f1a08491de321e32be5", "patch": "@@ -196,7 +196,7 @@ impl<'a, I: Iterator<Item = Event<'a>>> Iterator for CodeBlocks<'a, I> {\n                     .map(|l| map_line(l).for_code())\n                     .collect::<Vec<&str>>().join(\"\\n\");\n                 let krate = krate.as_ref().map(|s| &**s);\n-                let test = test::make_test(&test, krate, false,\n+                let (test, _) = test::make_test(&test, krate, false,\n                                            &Default::default());\n                 let channel = if test.contains(\"#![feature(\") {\n                     \"&amp;version=nightly\"\n@@ -607,7 +607,7 @@ pub fn render(w: &mut fmt::Formatter,\n                         .map(|l| map_line(l).for_code())\n                         .collect::<Vec<&str>>().join(\"\\n\");\n                     let krate = krate.as_ref().map(|s| &**s);\n-                    let test = test::make_test(&test, krate, false,\n+                    let (test, _) = test::make_test(&test, krate, false,\n                                                &Default::default());\n                     let channel = if test.contains(\"#![feature(\") {\n                         \"&amp;version=nightly\""}, {"sha": "5432f5cb6e1656b4c0f8891c4a1d2d007fee0873", "filename": "src/librustdoc/test.rs", "status": "modified", "additions": 15, "deletions": 6, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/5d6f6e65ffb61a7acec28f1a08491de321e32be5/src%2Flibrustdoc%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5d6f6e65ffb61a7acec28f1a08491de321e32be5/src%2Flibrustdoc%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Ftest.rs?ref=5d6f6e65ffb61a7acec28f1a08491de321e32be5", "patch": "@@ -176,15 +176,16 @@ fn scrape_test_config(krate: &::rustc::hir::Crate) -> TestOptions {\n     opts\n }\n \n-fn run_test(test: &str, cratename: &str, filename: &FileName, cfgs: Vec<String>, libs: SearchPaths,\n+fn run_test(test: &str, cratename: &str, filename: &FileName, line: usize,\n+            cfgs: Vec<String>, libs: SearchPaths,\n             externs: Externs,\n             should_panic: bool, no_run: bool, as_test_harness: bool,\n             compile_fail: bool, mut error_codes: Vec<String>, opts: &TestOptions,\n             maybe_sysroot: Option<PathBuf>,\n             linker: Option<PathBuf>) {\n     // the test harness wants its own `main` & top level functions, so\n     // never wrap the test in `fn main() { ... }`\n-    let test = make_test(test, Some(cratename), as_test_harness, opts);\n+    let (test, line_offset) = make_test(test, Some(cratename), as_test_harness, opts);\n     // FIXME(#44940): if doctests ever support path remapping, then this filename\n     // needs to be the result of CodeMap::span_to_unmapped_path\n     let input = config::Input::Str {\n@@ -234,7 +235,9 @@ fn run_test(test: &str, cratename: &str, filename: &FileName, cfgs: Vec<String>,\n         }\n     }\n     let data = Arc::new(Mutex::new(Vec::new()));\n-    let codemap = Rc::new(CodeMap::new(sessopts.file_path_mapping()));\n+    let codemap = Rc::new(CodeMap::new_doctest(\n+        sessopts.file_path_mapping(), filename.clone(), line as isize - line_offset as isize\n+    ));\n     let emitter = errors::emitter::EmitterWriter::new(box Sink(data.clone()),\n                                                       Some(codemap.clone()),\n                                                       false);\n@@ -326,13 +329,14 @@ fn run_test(test: &str, cratename: &str, filename: &FileName, cfgs: Vec<String>,\n     }\n }\n \n+/// Makes the test file. Also returns the number of lines before the code begins\n pub fn make_test(s: &str,\n                  cratename: Option<&str>,\n                  dont_insert_main: bool,\n                  opts: &TestOptions)\n-                 -> String {\n+                 -> (String, usize) {\n     let (crate_attrs, everything_else) = partition_source(s);\n-\n+    let mut line_offset = 0;\n     let mut prog = String::new();\n \n     if opts.attrs.is_empty() {\n@@ -341,11 +345,13 @@ pub fn make_test(s: &str,\n         // commonly used to make tests fail in case they trigger warnings, so having this there in\n         // that case may cause some tests to pass when they shouldn't have.\n         prog.push_str(\"#![allow(unused)]\\n\");\n+        line_offset += 1;\n     }\n \n     // Next, any attributes that came from the crate root via #![doc(test(attr(...)))].\n     for attr in &opts.attrs {\n         prog.push_str(&format!(\"#![{}]\\n\", attr));\n+        line_offset += 1;\n     }\n \n     // Now push any outer attributes from the example, assuming they\n@@ -358,6 +364,7 @@ pub fn make_test(s: &str,\n         if let Some(cratename) = cratename {\n             if s.contains(cratename) {\n                 prog.push_str(&format!(\"extern crate {};\\n\", cratename));\n+                line_offset += 1;\n             }\n         }\n     }\n@@ -379,14 +386,15 @@ pub fn make_test(s: &str,\n         prog.push_str(&everything_else);\n     } else {\n         prog.push_str(\"fn main() {\\n\");\n+        line_offset += 1;\n         prog.push_str(&everything_else);\n         prog = prog.trim().into();\n         prog.push_str(\"\\n}\");\n     }\n \n     info!(\"final test program: {}\", prog);\n \n-    prog\n+    (prog, line_offset)\n }\n \n // FIXME(aburka): use a real parser to deal with multiline attributes\n@@ -543,6 +551,7 @@ impl Collector {\n                         run_test(&test,\n                                  &cratename,\n                                  &filename,\n+                                 line,\n                                  cfgs,\n                                  libs,\n                                  externs,"}, {"sha": "a58a61c36361b4d82f0dd548a1f08464e1344d04", "filename": "src/libsyntax/codemap.rs", "status": "modified", "additions": 35, "deletions": 1, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/5d6f6e65ffb61a7acec28f1a08491de321e32be5/src%2Flibsyntax%2Fcodemap.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5d6f6e65ffb61a7acec28f1a08491de321e32be5/src%2Flibsyntax%2Fcodemap.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fcodemap.rs?ref=5d6f6e65ffb61a7acec28f1a08491de321e32be5", "patch": "@@ -131,6 +131,9 @@ pub struct CodeMap {\n     // -Zremap-path-prefix to all FileMaps allocated within this CodeMap.\n     path_mapping: FilePathMapping,\n     stable_id_to_filemap: RefCell<FxHashMap<StableFilemapId, Rc<FileMap>>>,\n+    /// In case we are in a doctest, replace all file names with the PathBuf,\n+    /// and add the given offsets to the line info\n+    doctest_offset: Option<(FileName, isize)>,\n }\n \n impl CodeMap {\n@@ -140,9 +143,19 @@ impl CodeMap {\n             file_loader: Box::new(RealFileLoader),\n             path_mapping,\n             stable_id_to_filemap: RefCell::new(FxHashMap()),\n+            doctest_offset: None,\n         }\n     }\n \n+    pub fn new_doctest(path_mapping: FilePathMapping,\n+                       file: FileName, line: isize) -> CodeMap {\n+        CodeMap {\n+            doctest_offset: Some((file, line)),\n+            ..CodeMap::new(path_mapping)\n+        }\n+\n+    }\n+\n     pub fn with_file_loader(file_loader: Box<FileLoader>,\n                             path_mapping: FilePathMapping)\n                             -> CodeMap {\n@@ -151,6 +164,7 @@ impl CodeMap {\n             file_loader,\n             path_mapping,\n             stable_id_to_filemap: RefCell::new(FxHashMap()),\n+            doctest_offset: None,\n         }\n     }\n \n@@ -164,7 +178,12 @@ impl CodeMap {\n \n     pub fn load_file(&self, path: &Path) -> io::Result<Rc<FileMap>> {\n         let src = self.file_loader.read_file(path)?;\n-        Ok(self.new_filemap(path.to_owned().into(), src))\n+        let filename = if let Some((ref name, _)) = self.doctest_offset {\n+            name.clone()\n+        } else {\n+            path.to_owned().into()\n+        };\n+        Ok(self.new_filemap(filename, src))\n     }\n \n     pub fn files(&self) -> Ref<Vec<Rc<FileMap>>> {\n@@ -303,6 +322,18 @@ impl CodeMap {\n                  pos.col.to_usize() + 1)).to_string()\n     }\n \n+    // If there is a doctest_offset, apply it to the line\n+    pub fn doctest_offset_line(&self, mut orig: usize) -> usize {\n+        if let Some((_, line)) = self.doctest_offset {\n+            if line >= 0 {\n+                orig = orig + line as usize;\n+            } else {\n+                orig = orig - (-line) as usize;\n+            }\n+        }\n+        orig\n+    }\n+\n     /// Lookup source information about a BytePos\n     pub fn lookup_char_pos(&self, pos: BytePos) -> Loc {\n         let chpos = self.bytepos_to_file_charpos(pos);\n@@ -681,6 +712,9 @@ impl CodeMapper for CodeMap {\n             }\n         )\n     }\n+    fn doctest_offset_line(&self, line: usize) -> usize {\n+        self.doctest_offset_line(line)\n+    }\n }\n \n #[derive(Clone)]"}, {"sha": "0019e5ee7943b8c3d7f1256c88bf536331a64bfd", "filename": "src/test/run-make/rustdoc-error-lines/Makefile", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/5d6f6e65ffb61a7acec28f1a08491de321e32be5/src%2Ftest%2Frun-make%2Frustdoc-error-lines%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/5d6f6e65ffb61a7acec28f1a08491de321e32be5/src%2Ftest%2Frun-make%2Frustdoc-error-lines%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Frustdoc-error-lines%2FMakefile?ref=5d6f6e65ffb61a7acec28f1a08491de321e32be5", "patch": "@@ -0,0 +1,8 @@\n+-include ../tools.mk\n+\n+# Test that hir-tree output doens't crash and includes\n+# the string constant we would expect to see.\n+\n+all:\n+\t$(RUSTDOC) --test input.rs > $(TMPDIR)/output || true\n+\t$(CGREP) 'input.rs:17:15' < $(TMPDIR)/output"}, {"sha": "6dc7060bc488990ee6e2f3cd257ac64dcb62777f", "filename": "src/test/run-make/rustdoc-error-lines/input.rs", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/5d6f6e65ffb61a7acec28f1a08491de321e32be5/src%2Ftest%2Frun-make%2Frustdoc-error-lines%2Finput.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5d6f6e65ffb61a7acec28f1a08491de321e32be5/src%2Ftest%2Frun-make%2Frustdoc-error-lines%2Finput.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Frustdoc-error-lines%2Finput.rs?ref=5d6f6e65ffb61a7acec28f1a08491de321e32be5", "patch": "@@ -0,0 +1,21 @@\n+// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// Test for #45868\n+\n+// random #![feature] to ensure that crate attrs\n+// do not offset things\n+/// ```rust\n+/// #![feature(nll)]\n+/// let x: char = 1;\n+/// ```\n+pub fn foo() {\n+\n+}"}]}