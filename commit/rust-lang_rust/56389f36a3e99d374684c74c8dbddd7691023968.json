{"sha": "56389f36a3e99d374684c74c8dbddd7691023968", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU2Mzg5ZjM2YTNlOTlkMzc0Njg0Yzc0YzhkYmRkZDc2OTEwMjM5Njg=", "commit": {"author": {"name": "Igor Matuszewski", "email": "Xanewok@gmail.com", "date": "2019-04-22T13:04:48Z"}, "committer": {"name": "Igor Matuszewski", "email": "Xanewok@gmail.com", "date": "2019-04-23T08:32:41Z"}, "message": "compiletest: Disambiguate extern crate deps shared with the compiler", "tree": {"sha": "d42e23f7cd6273a5ef96e79642338130900bc911", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d42e23f7cd6273a5ef96e79642338130900bc911"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/56389f36a3e99d374684c74c8dbddd7691023968", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/56389f36a3e99d374684c74c8dbddd7691023968", "html_url": "https://github.com/rust-lang/rust/commit/56389f36a3e99d374684c74c8dbddd7691023968", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/56389f36a3e99d374684c74c8dbddd7691023968/comments", "author": {"login": "Xanewok", "id": 3093213, "node_id": "MDQ6VXNlcjMwOTMyMTM=", "avatar_url": "https://avatars.githubusercontent.com/u/3093213?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Xanewok", "html_url": "https://github.com/Xanewok", "followers_url": "https://api.github.com/users/Xanewok/followers", "following_url": "https://api.github.com/users/Xanewok/following{/other_user}", "gists_url": "https://api.github.com/users/Xanewok/gists{/gist_id}", "starred_url": "https://api.github.com/users/Xanewok/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Xanewok/subscriptions", "organizations_url": "https://api.github.com/users/Xanewok/orgs", "repos_url": "https://api.github.com/users/Xanewok/repos", "events_url": "https://api.github.com/users/Xanewok/events{/privacy}", "received_events_url": "https://api.github.com/users/Xanewok/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Xanewok", "id": 3093213, "node_id": "MDQ6VXNlcjMwOTMyMTM=", "avatar_url": "https://avatars.githubusercontent.com/u/3093213?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Xanewok", "html_url": "https://github.com/Xanewok", "followers_url": "https://api.github.com/users/Xanewok/followers", "following_url": "https://api.github.com/users/Xanewok/following{/other_user}", "gists_url": "https://api.github.com/users/Xanewok/gists{/gist_id}", "starred_url": "https://api.github.com/users/Xanewok/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Xanewok/subscriptions", "organizations_url": "https://api.github.com/users/Xanewok/orgs", "repos_url": "https://api.github.com/users/Xanewok/repos", "events_url": "https://api.github.com/users/Xanewok/events{/privacy}", "received_events_url": "https://api.github.com/users/Xanewok/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d420589e1a8208c85368d07c1644c6725367650b", "url": "https://api.github.com/repos/rust-lang/rust/commits/d420589e1a8208c85368d07c1644c6725367650b", "html_url": "https://github.com/rust-lang/rust/commit/d420589e1a8208c85368d07c1644c6725367650b"}], "stats": {"total": 27, "additions": 25, "deletions": 2}, "files": [{"sha": "65561b7fbd76facc87edfa649d73211ed806f2b3", "filename": "tests/compile-test.rs", "status": "modified", "additions": 25, "deletions": 2, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/56389f36a3e99d374684c74c8dbddd7691023968/tests%2Fcompile-test.rs", "raw_url": "https://github.com/rust-lang/rust/raw/56389f36a3e99d374684c74c8dbddd7691023968/tests%2Fcompile-test.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-test.rs?ref=56389f36a3e99d374684c74c8dbddd7691023968", "patch": "@@ -46,9 +46,32 @@ fn config(mode: &str, dir: PathBuf) -> compiletest::Config {\n         config.run_lib_path = rustc_lib_path();\n         config.compile_lib_path = rustc_lib_path();\n     }\n+\n+    // When we'll want to use `extern crate ..` for a dependency that is used\n+    // both by the crate and the compiler itself, we can't simply pass -L flags\n+    // as we'll get a duplicate matching versions. Instead, disambiguate with\n+    // `--extern dep=path`.\n+    // See https://github.com/rust-lang/rust-clippy/issues/4015.\n+    let needs_disambiguation = [\"serde\"];\n+    // This assumes that deps are compiled (they are for Cargo integration tests).\n+    let deps = std::fs::read_dir(host_libs().join(\"deps\")).unwrap();\n+    let disambiguated = deps\n+        .filter_map(|dep| {\n+            let path = dep.ok()?.path();\n+            let name = path.file_name()?.to_string_lossy();\n+            // NOTE: This only handles a single dep\n+            // https://github.com/laumann/compiletest-rs/issues/101\n+            needs_disambiguation\n+                .iter()\n+                .find(|dep| name.starts_with(&format!(\"lib{}-\", dep)))\n+                .map(|dep| format!(\"--extern {}={}\", dep, path.display()))\n+        })\n+        .collect::<Vec<_>>();\n+\n     config.target_rustcflags = Some(format!(\n-        \"-L {0} -L {0}/deps -Dwarnings -Zui-testing\",\n-        host_libs().display()\n+        \"-L {0} -L {0}/deps -Dwarnings -Zui-testing {1}\",\n+        host_libs().display(),\n+        disambiguated.join(\" \")\n     ));\n \n     config.mode = cfg_mode;"}]}