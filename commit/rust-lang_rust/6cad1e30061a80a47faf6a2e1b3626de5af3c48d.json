{"sha": "6cad1e30061a80a47faf6a2e1b3626de5af3c48d", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZjYWQxZTMwMDYxYTgwYTQ3ZmFmNmEyZTFiMzYyNmRlNWFmM2M0OGQ=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2020-04-28T11:12:17Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-04-28T11:12:17Z"}, "message": "Rollup merge of #71634 - eddyb:revert-71372, r=petrochenkov\n\nRevert #71372 (\"Fix #! (shebang) stripping account space issue\").\n\nWhile #71372 fixed some of the problems `#!`-stripping had, it introduced others:\n* inefficient implementation (`.chars().filter(...).collect()` on the entire input file)\n  * this also means the length returned isn't always correct, leading to e.g. #71471\n* it ignores whitespace anywhere, stripping ` # ! ...` which isn't a valid shebang\n  * the definition of \"whitespace\" it uses includes newlines, which means even `\\n#\\n!\\n...` is stripped as a shebang (and anything matching the regex `\\s*#\\s*!\\s*`, and not followed by `[`, really)\n* it's backward-incompatible but didn't go through Crater\n\nNow, #71487 is already open and will solve all of these issues. But for running Crater, and just in case #71487 takes a bit longer, I decided it's safer to just revert #71372.\n\nThis will also make #71372's diff clearer, as it will start again from the original whitespace-unaware version.\n\nr? @petrochenkov", "tree": {"sha": "e3a052466fe03a2c9675a874485b567c80152e96", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e3a052466fe03a2c9675a874485b567c80152e96"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6cad1e30061a80a47faf6a2e1b3626de5af3c48d", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJeqA+RCRBK7hj4Ov3rIwAAdHIIAE2QE9W5xqGn72/7Njb4H3Jm\nsQ5GnH0z+8xFmALCm0fksOuL66WyoJ99X1ZVu0vhVHTKoNRimrccgIMUMX0dFiMM\nvDXchHFqldR6quendnn0QUoLXC1M/9Qz0ZgiMCf+pnwJNec0fZdRYAhyPvpIMt+V\nTCd5lQ8HVGinGziDf6WKh5Enfxiz8684Y7S/Ls2Nxq3v4uJSvjnRguNTFOCf8c8v\np+2sQZLr+qx4fA0K9xuNhrhCE1Ll4DjxrDVi1K4B+UWgdl02WRN76BOfGmB+wWEw\nqVXgVu27gBsE0oVar6cqu6jipHoGcMaKo6SXI91uF9Fv0lAnls9ROL5Cjii+f54=\n=9+FS\n-----END PGP SIGNATURE-----\n", "payload": "tree e3a052466fe03a2c9675a874485b567c80152e96\nparent 8e025db59234f0e29d9c331c7d21e775cbd28630\nparent 4d67c8da5563f7398dd7373b24bccd46c96ebb77\nauthor Dylan DPC <dylan.dpc@gmail.com> 1588072337 +0200\ncommitter GitHub <noreply@github.com> 1588072337 +0200\n\nRollup merge of #71634 - eddyb:revert-71372, r=petrochenkov\n\nRevert #71372 (\"Fix #! (shebang) stripping account space issue\").\n\nWhile #71372 fixed some of the problems `#!`-stripping had, it introduced others:\n* inefficient implementation (`.chars().filter(...).collect()` on the entire input file)\n  * this also means the length returned isn't always correct, leading to e.g. #71471\n* it ignores whitespace anywhere, stripping ` # ! ...` which isn't a valid shebang\n  * the definition of \"whitespace\" it uses includes newlines, which means even `\\n#\\n!\\n...` is stripped as a shebang (and anything matching the regex `\\s*#\\s*!\\s*`, and not followed by `[`, really)\n* it's backward-incompatible but didn't go through Crater\n\nNow, #71487 is already open and will solve all of these issues. But for running Crater, and just in case #71487 takes a bit longer, I decided it's safer to just revert #71372.\n\nThis will also make #71372's diff clearer, as it will start again from the original whitespace-unaware version.\n\nr? @petrochenkov\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6cad1e30061a80a47faf6a2e1b3626de5af3c48d", "html_url": "https://github.com/rust-lang/rust/commit/6cad1e30061a80a47faf6a2e1b3626de5af3c48d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6cad1e30061a80a47faf6a2e1b3626de5af3c48d/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8e025db59234f0e29d9c331c7d21e775cbd28630", "url": "https://api.github.com/repos/rust-lang/rust/commits/8e025db59234f0e29d9c331c7d21e775cbd28630", "html_url": "https://github.com/rust-lang/rust/commit/8e025db59234f0e29d9c331c7d21e775cbd28630"}, {"sha": "4d67c8da5563f7398dd7373b24bccd46c96ebb77", "url": "https://api.github.com/repos/rust-lang/rust/commits/4d67c8da5563f7398dd7373b24bccd46c96ebb77", "html_url": "https://github.com/rust-lang/rust/commit/4d67c8da5563f7398dd7373b24bccd46c96ebb77"}], "stats": {"total": 25, "additions": 1, "deletions": 24}, "files": [{"sha": "5ccfc1b276bfa0e1c71372aa4f3c99e588d0eff8", "filename": "src/librustc_lexer/src/lib.rs", "status": "modified", "additions": 1, "deletions": 6, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/6cad1e30061a80a47faf6a2e1b3626de5af3c48d/src%2Flibrustc_lexer%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6cad1e30061a80a47faf6a2e1b3626de5af3c48d/src%2Flibrustc_lexer%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_lexer%2Fsrc%2Flib.rs?ref=6cad1e30061a80a47faf6a2e1b3626de5af3c48d", "patch": "@@ -236,17 +236,12 @@ pub enum Base {\n /// (e.g. \"#![deny(missing_docs)]\").\n pub fn strip_shebang(input: &str) -> Option<usize> {\n     debug_assert!(!input.is_empty());\n-    let s: &str = &remove_whitespace(input);\n-    if !s.starts_with(\"#!\") || s.starts_with(\"#![\") {\n+    if !input.starts_with(\"#!\") || input.starts_with(\"#![\") {\n         return None;\n     }\n     Some(input.find('\\n').unwrap_or(input.len()))\n }\n \n-fn remove_whitespace(s: &str) -> String {\n-    s.chars().filter(|c| !c.is_whitespace()).collect()\n-}\n-\n /// Parses the first token from the provided input string.\n pub fn first_token(input: &str) -> Token {\n     debug_assert!(!input.is_empty());"}, {"sha": "06fc159fe2516a86f5a9e3e54efb1726a12bae4d", "filename": "src/librustc_lexer/src/tests.rs", "status": "modified", "additions": 0, "deletions": 18, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/6cad1e30061a80a47faf6a2e1b3626de5af3c48d/src%2Flibrustc_lexer%2Fsrc%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6cad1e30061a80a47faf6a2e1b3626de5af3c48d/src%2Flibrustc_lexer%2Fsrc%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_lexer%2Fsrc%2Ftests.rs?ref=6cad1e30061a80a47faf6a2e1b3626de5af3c48d", "patch": "@@ -145,22 +145,4 @@ mod tests {\n             }),\n         );\n     }\n-\n-    #[test]\n-    fn test_valid_shebang() {\n-        // https://github.com/rust-lang/rust/issues/70528\n-        let input = \"#!/usr/bin/rustrun\";\n-        let actual = strip_shebang(input);\n-        let expected: Option<usize> = Some(18);\n-        assert_eq!(expected, actual);\n-    }\n-\n-    #[test]\n-    fn test_invalid_shebang_valid_rust_syntax() {\n-        // https://github.com/rust-lang/rust/issues/70528\n-        let input = \"#!    [bad_attribute]\";\n-        let actual = strip_shebang(input);\n-        let expected: Option<usize> = None;\n-        assert_eq!(expected, actual);\n-    }\n }"}]}