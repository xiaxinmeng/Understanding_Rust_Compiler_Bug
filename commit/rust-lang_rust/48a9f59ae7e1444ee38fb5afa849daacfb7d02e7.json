{"sha": "48a9f59ae7e1444ee38fb5afa849daacfb7d02e7", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQ4YTlmNTlhZTdlMTQ0NGVlMzhmYjVhZmE4NDlkYWFjZmI3ZDAyZTc=", "commit": {"author": {"name": "Tyler Mandry", "email": "tmandry@gmail.com", "date": "2019-11-01T18:20:12Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2019-11-01T18:20:12Z"}, "message": "Rollup merge of #65857 - kinnison:kinnison/issue-55364, r=Manisheart,GuillaumeGomez\n\nrustdoc: Resolve module-level doc references more locally\n\nModule level docs should resolve intra-doc links as locally as\npossible.  As such, this commit alters the heuristic for finding\nintra-doc links such that we attempt to resolve names mentioned\nin *inner* documentation comments within the (sub-)module rather\nthat from the context of its parent.\n\nI'm hoping that this fixes #55364 though right now I'm not sure it's the right fix.\n\nr? @GuillaumeGomez", "tree": {"sha": "fa420c6b72f08f90e571cf21b1d273846c24e18d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fa420c6b72f08f90e571cf21b1d273846c24e18d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/48a9f59ae7e1444ee38fb5afa849daacfb7d02e7", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJdvHdcCRBK7hj4Ov3rIwAAdHIIAHXrhr/0OK3s0Qsdi8PMb2iw\n2jGx350CLR2pj+Ab0Kbsx0NBSUsVEHaAMzvZ4TIjvYaADcVslOWfk+dANYFXfQT1\np09OBlHjUL/WAH3NLajoLKSveX7XfZN0jaVKkYzYggi3U/AdDVgK7eATT6Z0JzmT\nJbg8kjOtyjrlJ4FyqSEgqPF2IoH4FBg8eb4pw129ENngQlAtFhlj/3Z1ybNHNleM\nSnWyApSBwTXck07T1zXX2gY3KIjN2hgSiGJJlu5y0cZmRWjb+lDD/jSjNYa1uE5R\nYrAmnUzVxUVORsqMAUCa+BKf/6z+lvA5dNDLKRI+IdwEPN9/UkqBTL3h+6WnIEo=\n=0Xx8\n-----END PGP SIGNATURE-----\n", "payload": "tree fa420c6b72f08f90e571cf21b1d273846c24e18d\nparent 19182058914b0b7fb246beaeb9469d6df8f509b8\nparent c24a099e8b033470c12b2c5750b8dd76cf357477\nauthor Tyler Mandry <tmandry@gmail.com> 1572632412 -0700\ncommitter GitHub <noreply@github.com> 1572632412 -0700\n\nRollup merge of #65857 - kinnison:kinnison/issue-55364, r=Manisheart,GuillaumeGomez\n\nrustdoc: Resolve module-level doc references more locally\n\nModule level docs should resolve intra-doc links as locally as\npossible.  As such, this commit alters the heuristic for finding\nintra-doc links such that we attempt to resolve names mentioned\nin *inner* documentation comments within the (sub-)module rather\nthat from the context of its parent.\n\nI'm hoping that this fixes #55364 though right now I'm not sure it's the right fix.\n\nr? @GuillaumeGomez\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/48a9f59ae7e1444ee38fb5afa849daacfb7d02e7", "html_url": "https://github.com/rust-lang/rust/commit/48a9f59ae7e1444ee38fb5afa849daacfb7d02e7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/48a9f59ae7e1444ee38fb5afa849daacfb7d02e7/comments", "author": {"login": "tmandry", "id": 2280544, "node_id": "MDQ6VXNlcjIyODA1NDQ=", "avatar_url": "https://avatars.githubusercontent.com/u/2280544?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmandry", "html_url": "https://github.com/tmandry", "followers_url": "https://api.github.com/users/tmandry/followers", "following_url": "https://api.github.com/users/tmandry/following{/other_user}", "gists_url": "https://api.github.com/users/tmandry/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmandry/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmandry/subscriptions", "organizations_url": "https://api.github.com/users/tmandry/orgs", "repos_url": "https://api.github.com/users/tmandry/repos", "events_url": "https://api.github.com/users/tmandry/events{/privacy}", "received_events_url": "https://api.github.com/users/tmandry/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "19182058914b0b7fb246beaeb9469d6df8f509b8", "url": "https://api.github.com/repos/rust-lang/rust/commits/19182058914b0b7fb246beaeb9469d6df8f509b8", "html_url": "https://github.com/rust-lang/rust/commit/19182058914b0b7fb246beaeb9469d6df8f509b8"}, {"sha": "c24a099e8b033470c12b2c5750b8dd76cf357477", "url": "https://api.github.com/repos/rust-lang/rust/commits/c24a099e8b033470c12b2c5750b8dd76cf357477", "html_url": "https://github.com/rust-lang/rust/commit/c24a099e8b033470c12b2c5750b8dd76cf357477"}], "stats": {"total": 113, "additions": 109, "deletions": 4}, "files": [{"sha": "ab34f8daad7197bd1d64ba1573e8a3a68c76863f", "filename": "src/librustdoc/passes/collect_intra_doc_links.rs", "status": "modified", "additions": 21, "deletions": 4, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/48a9f59ae7e1444ee38fb5afa849daacfb7d02e7/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs", "raw_url": "https://github.com/rust-lang/rust/raw/48a9f59ae7e1444ee38fb5afa849daacfb7d02e7/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fpasses%2Fcollect_intra_doc_links.rs?ref=48a9f59ae7e1444ee38fb5afa849daacfb7d02e7", "patch": "@@ -322,9 +322,26 @@ impl<'a, 'tcx> DocFolder for LinkCollector<'a, 'tcx> {\n                     continue;\n                 }\n \n+                // In order to correctly resolve intra-doc-links we need to\n+                // pick a base AST node to work from.  If the documentation for\n+                // this module came from an inner comment (//!) then we anchor\n+                // our name resolution *inside* the module.  If, on the other\n+                // hand it was an outer comment (///) then we anchor the name\n+                // resolution in the parent module on the basis that the names\n+                // used are more likely to be intended to be parent names.  For\n+                // this, we set base_node to None for inner comments since\n+                // we've already pushed this node onto the resolution stack but\n+                // for outer comments we explicitly try and resolve against the\n+                // parent_node first.\n+                let base_node = if item.is_mod() && item.attrs.inner_docs {\n+                    None\n+                } else {\n+                    parent_node\n+                };\n+\n                 match kind {\n                     Some(ns @ ValueNS) => {\n-                        if let Ok(res) = self.resolve(path_str, ns, &current_item, parent_node) {\n+                        if let Ok(res) = self.resolve(path_str, ns, &current_item, base_node) {\n                             res\n                         } else {\n                             resolution_failure(cx, &item, path_str, &dox, link_range);\n@@ -335,7 +352,7 @@ impl<'a, 'tcx> DocFolder for LinkCollector<'a, 'tcx> {\n                         }\n                     }\n                     Some(ns @ TypeNS) => {\n-                        if let Ok(res) = self.resolve(path_str, ns, &current_item, parent_node) {\n+                        if let Ok(res) = self.resolve(path_str, ns, &current_item, base_node) {\n                             res\n                         } else {\n                             resolution_failure(cx, &item, path_str, &dox, link_range);\n@@ -348,10 +365,10 @@ impl<'a, 'tcx> DocFolder for LinkCollector<'a, 'tcx> {\n                         let candidates = PerNS {\n                             macro_ns: macro_resolve(cx, path_str).map(|res| (res, None)),\n                             type_ns: self\n-                                .resolve(path_str, TypeNS, &current_item, parent_node)\n+                                .resolve(path_str, TypeNS, &current_item, base_node)\n                                 .ok(),\n                             value_ns: self\n-                                .resolve(path_str, ValueNS, &current_item, parent_node)\n+                                .resolve(path_str, ValueNS, &current_item, base_node)\n                                 .ok()\n                                 .and_then(|(res, fragment)| {\n                                     // Constructors are picked up in the type namespace."}, {"sha": "200a29fc7eea373727d6f6b1e1c3e45d224b621e", "filename": "src/test/rustdoc/issue-55364.rs", "status": "added", "additions": 88, "deletions": 0, "changes": 88, "blob_url": "https://github.com/rust-lang/rust/blob/48a9f59ae7e1444ee38fb5afa849daacfb7d02e7/src%2Ftest%2Frustdoc%2Fissue-55364.rs", "raw_url": "https://github.com/rust-lang/rust/raw/48a9f59ae7e1444ee38fb5afa849daacfb7d02e7/src%2Ftest%2Frustdoc%2Fissue-55364.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fissue-55364.rs?ref=48a9f59ae7e1444ee38fb5afa849daacfb7d02e7", "patch": "@@ -0,0 +1,88 @@\n+// ignore-tidy-linelength\n+\n+// First a module with inner documentation\n+\n+// @has issue_55364/subone/index.html\n+// These foo/bar links in the module's documentation should refer inside `subone`\n+// @has - '//section[@id=\"main\"]/div[@class=\"docblock\"]//a[@href=\"../../issue_55364/subone/fn.foo.html\"]' 'foo'\n+// @has - '//section[@id=\"main\"]/div[@class=\"docblock\"]//a[@href=\"../../issue_55364/subone/fn.bar.html\"]' 'bar'\n+pub mod subone {\n+    //! See either [foo] or [bar].\n+\n+    // This should refer to subone's `bar`\n+    // @has issue_55364/subone/fn.foo.html\n+    // @has - '//section[@id=\"main\"]/div[@class=\"docblock\"]//a[@href=\"../../issue_55364/subone/fn.bar.html\"]' 'bar'\n+    /// See [bar]\n+    pub fn foo() {}\n+    // This should refer to subone's `foo`\n+    // @has issue_55364/subone/fn.bar.html\n+    // @has - '//section[@id=\"main\"]/div[@class=\"docblock\"]//a[@href=\"../../issue_55364/subone/fn.foo.html\"]' 'foo'\n+    /// See [foo]\n+    pub fn bar() {}\n+}\n+\n+// A module with outer documentation\n+\n+// @has issue_55364/subtwo/index.html\n+// These foo/bar links in the module's documentation should not reference inside `subtwo`\n+// @!has - '//section[@id=\"main\"]/div[@class=\"docblock\"]//a[@href=\"../../issue_55364/subtwo/fn.foo.html\"]' 'foo'\n+// @!has - '//section[@id=\"main\"]/div[@class=\"docblock\"]//a[@href=\"../../issue_55364/subtwo/fn.bar.html\"]' 'bar'\n+// Instead it should be referencing the top level functions\n+// @has - '//section[@id=\"main\"]/div[@class=\"docblock\"]//a[@href=\"../../issue_55364/fn.foo.html\"]' 'foo'\n+// @has - '//section[@id=\"main\"]/div[@class=\"docblock\"]//a[@href=\"../../issue_55364/fn.bar.html\"]' 'bar'\n+// Though there should be such links later\n+// @has - '//section[@id=\"main\"]/table//tr[@class=\"module-item\"]/td/a[@class=\"fn\"][@href=\"fn.foo.html\"]' 'foo'\n+// @has - '//section[@id=\"main\"]/table//tr[@class=\"module-item\"]/td/a[@class=\"fn\"][@href=\"fn.bar.html\"]' 'bar'\n+/// See either [foo] or [bar].\n+pub mod subtwo {\n+\n+    // Despite the module's docs referring to the top level foo/bar,\n+    // this should refer to subtwo's `bar`\n+    // @has issue_55364/subtwo/fn.foo.html\n+    // @has - '//section[@id=\"main\"]/div[@class=\"docblock\"]//a[@href=\"../../issue_55364/subtwo/fn.bar.html\"]' 'bar'\n+    /// See [bar]\n+    pub fn foo() {}\n+    // Despite the module's docs referring to the top level foo/bar,\n+    // this should refer to subtwo's `foo`\n+    // @has issue_55364/subtwo/fn.bar.html\n+    // @has - '//section[@id=\"main\"]/div[@class=\"docblock\"]//a[@href=\"../../issue_55364/subtwo/fn.foo.html\"]' 'foo'\n+    /// See [foo]\n+    pub fn bar() {}\n+}\n+\n+// These are the function referred to by the module above with outer docs\n+\n+/// See [bar]\n+pub fn foo() {}\n+/// See [foo]\n+pub fn bar() {}\n+\n+// This module refers to the outer foo/bar by means of `super::`\n+\n+// @has issue_55364/subthree/index.html\n+// This module should also refer to the top level foo/bar\n+// @has - '//section[@id=\"main\"]/div[@class=\"docblock\"]//a[@href=\"../../issue_55364/fn.foo.html\"]' 'foo'\n+// @has - '//section[@id=\"main\"]/div[@class=\"docblock\"]//a[@href=\"../../issue_55364/fn.bar.html\"]' 'bar'\n+pub mod subthree {\n+    //! See either [foo][super::foo] or [bar][super::bar]\n+}\n+\n+// Next we go *deeper* - In order to ensure it's not just \"this or parent\"\n+// we test `crate::` and a `super::super::...` chain\n+// @has issue_55364/subfour/subfive/subsix/subseven/subeight/index.html\n+// @has - '//section[@id=\"main\"]/table//tr[@class=\"module-item\"]/td[@class=\"docblock-short\"]//a[@href=\"../../../../../../issue_55364/subone/fn.foo.html\"]' 'other foo'\n+// @has - '//section[@id=\"main\"]/table//tr[@class=\"module-item\"]/td[@class=\"docblock-short\"]//a[@href=\"../../../../../../issue_55364/subtwo/fn.bar.html\"]' 'other bar'\n+pub mod subfour {\n+    pub mod subfive {\n+        pub mod subsix {\n+            pub mod subseven {\n+                pub mod subeight {\n+                    /// See [other foo][crate::subone::foo]\n+                    pub fn foo() {}\n+                    /// See [other bar][super::super::super::super::super::subtwo::bar]\n+                    pub fn bar() {}\n+                }\n+            }\n+        }\n+    }\n+}"}]}