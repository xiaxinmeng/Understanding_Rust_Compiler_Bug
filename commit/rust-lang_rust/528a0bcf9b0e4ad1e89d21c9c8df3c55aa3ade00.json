{"sha": "528a0bcf9b0e4ad1e89d21c9c8df3c55aa3ade00", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUyOGEwYmNmOWIwZTRhZDFlODlkMjFjOWM4ZGYzYzU1YWEzYWRlMDA=", "commit": {"author": {"name": "Micha\u0142 Muska\u0142a", "email": "michal@muskala.eu", "date": "2021-02-17T11:38:11Z"}, "committer": {"name": "Micha\u0142 Muska\u0142a", "email": "michal@muskala.eu", "date": "2021-02-17T11:45:17Z"}, "message": "Avoid transmitting unchanged diagnostics\n\nReading through the code for diagnostics and observing debug logs, I noticed\nthat diagnostics are transmitted after every change for every opened file,\neven if they haven't changed (especially visible for files with no diagnostics).\n\nThis change avoids marking files as \"changed\" if diagnostics are the same to what\nwas already sent before. This will only work if diagnostics are always produced in\nthe same order, but from my limited testing it seems this is the case.", "tree": {"sha": "d019f37897f2902244ff726dacbf19346e23d4d5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d019f37897f2902244ff726dacbf19346e23d4d5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/528a0bcf9b0e4ad1e89d21c9c8df3c55aa3ade00", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/528a0bcf9b0e4ad1e89d21c9c8df3c55aa3ade00", "html_url": "https://github.com/rust-lang/rust/commit/528a0bcf9b0e4ad1e89d21c9c8df3c55aa3ade00", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/528a0bcf9b0e4ad1e89d21c9c8df3c55aa3ade00/comments", "author": {"login": "michalmuskala", "id": 477062, "node_id": "MDQ6VXNlcjQ3NzA2Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/477062?v=4", "gravatar_id": "", "url": "https://api.github.com/users/michalmuskala", "html_url": "https://github.com/michalmuskala", "followers_url": "https://api.github.com/users/michalmuskala/followers", "following_url": "https://api.github.com/users/michalmuskala/following{/other_user}", "gists_url": "https://api.github.com/users/michalmuskala/gists{/gist_id}", "starred_url": "https://api.github.com/users/michalmuskala/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/michalmuskala/subscriptions", "organizations_url": "https://api.github.com/users/michalmuskala/orgs", "repos_url": "https://api.github.com/users/michalmuskala/repos", "events_url": "https://api.github.com/users/michalmuskala/events{/privacy}", "received_events_url": "https://api.github.com/users/michalmuskala/received_events", "type": "User", "site_admin": false}, "committer": {"login": "michalmuskala", "id": 477062, "node_id": "MDQ6VXNlcjQ3NzA2Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/477062?v=4", "gravatar_id": "", "url": "https://api.github.com/users/michalmuskala", "html_url": "https://github.com/michalmuskala", "followers_url": "https://api.github.com/users/michalmuskala/followers", "following_url": "https://api.github.com/users/michalmuskala/following{/other_user}", "gists_url": "https://api.github.com/users/michalmuskala/gists{/gist_id}", "starred_url": "https://api.github.com/users/michalmuskala/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/michalmuskala/subscriptions", "organizations_url": "https://api.github.com/users/michalmuskala/orgs", "repos_url": "https://api.github.com/users/michalmuskala/repos", "events_url": "https://api.github.com/users/michalmuskala/events{/privacy}", "received_events_url": "https://api.github.com/users/michalmuskala/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2920e7b28b58400a9026e92f28fc0304d71c7376", "url": "https://api.github.com/repos/rust-lang/rust/commits/2920e7b28b58400a9026e92f28fc0304d71c7376", "html_url": "https://github.com/rust-lang/rust/commit/2920e7b28b58400a9026e92f28fc0304d71c7376"}], "stats": {"total": 11, "additions": 11, "deletions": 0}, "files": [{"sha": "f01548c50a8af7cc90f90f1a555992a41ff67a81", "filename": "crates/rust-analyzer/src/diagnostics.rs", "status": "modified", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/528a0bcf9b0e4ad1e89d21c9c8df3c55aa3ade00/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/528a0bcf9b0e4ad1e89d21c9c8df3c55aa3ade00/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fdiagnostics.rs?ref=528a0bcf9b0e4ad1e89d21c9c8df3c55aa3ade00", "patch": "@@ -65,6 +65,17 @@ impl DiagnosticCollection {\n         file_id: FileId,\n         diagnostics: Vec<lsp_types::Diagnostic>,\n     ) {\n+        if let Some(existing_diagnostics) = self.native.get(&file_id) {\n+            if existing_diagnostics.len() == diagnostics.len()\n+                && diagnostics\n+                    .iter()\n+                    .zip(existing_diagnostics)\n+                    .all(|(new, existing)| are_diagnostics_equal(new, existing))\n+            {\n+                return;\n+            }\n+        }\n+\n         self.native.insert(file_id, diagnostics);\n         self.changes.insert(file_id);\n     }"}]}