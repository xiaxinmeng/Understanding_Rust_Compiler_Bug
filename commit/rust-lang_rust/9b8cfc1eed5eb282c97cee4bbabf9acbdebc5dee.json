{"sha": "9b8cfc1eed5eb282c97cee4bbabf9acbdebc5dee", "node_id": "C_kwDOAAsO6NoAKDliOGNmYzFlZWQ1ZWIyODJjOTdjZWU0YmJhYmY5YWNiZGViYzVkZWU", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-08-08T07:31:12Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-08-08T07:31:12Z"}, "message": "Auto merge of #98489 - cjgillot:naked-nohir, r=davidtwco,tmiasko\n\nOnly fetch HIR for naked functions that have the attribute.", "tree": {"sha": "ec15a461bcc6f496165b91a64b5dacdd3c486023", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ec15a461bcc6f496165b91a64b5dacdd3c486023"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9b8cfc1eed5eb282c97cee4bbabf9acbdebc5dee", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9b8cfc1eed5eb282c97cee4bbabf9acbdebc5dee", "html_url": "https://github.com/rust-lang/rust/commit/9b8cfc1eed5eb282c97cee4bbabf9acbdebc5dee", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9b8cfc1eed5eb282c97cee4bbabf9acbdebc5dee/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6a11cad7e874a5c3c7fe5cc70d6c96b998437f07", "url": "https://api.github.com/repos/rust-lang/rust/commits/6a11cad7e874a5c3c7fe5cc70d6c96b998437f07", "html_url": "https://github.com/rust-lang/rust/commit/6a11cad7e874a5c3c7fe5cc70d6c96b998437f07"}, {"sha": "6eb0c89f6bbe0f81a03b9faa1dca0577a56d8def", "url": "https://api.github.com/repos/rust-lang/rust/commits/6eb0c89f6bbe0f81a03b9faa1dca0577a56d8def", "html_url": "https://github.com/rust-lang/rust/commit/6eb0c89f6bbe0f81a03b9faa1dca0577a56d8def"}], "stats": {"total": 197, "additions": 86, "deletions": 111}, "files": [{"sha": "296b6ed5d99a69b5e5153a134d578d9218f12a47", "filename": "compiler/rustc_passes/src/naked_functions.rs", "status": "modified", "additions": 41, "deletions": 53, "changes": 94, "blob_url": "https://github.com/rust-lang/rust/blob/9b8cfc1eed5eb282c97cee4bbabf9acbdebc5dee/compiler%2Frustc_passes%2Fsrc%2Fnaked_functions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b8cfc1eed5eb282c97cee4bbabf9acbdebc5dee/compiler%2Frustc_passes%2Fsrc%2Fnaked_functions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fnaked_functions.rs?ref=9b8cfc1eed5eb282c97cee4bbabf9acbdebc5dee", "patch": "@@ -1,83 +1,71 @@\n //! Checks validity of naked functions.\n \n-use rustc_ast::{Attribute, InlineAsmOptions};\n+use rustc_ast::InlineAsmOptions;\n use rustc_errors::{struct_span_err, Applicability};\n use rustc_hir as hir;\n+use rustc_hir::def::DefKind;\n use rustc_hir::def_id::LocalDefId;\n-use rustc_hir::intravisit::{FnKind, Visitor};\n-use rustc_hir::{ExprKind, HirId, InlineAsmOperand, StmtKind};\n+use rustc_hir::intravisit::Visitor;\n+use rustc_hir::{ExprKind, InlineAsmOperand, StmtKind};\n use rustc_middle::ty::query::Providers;\n use rustc_middle::ty::TyCtxt;\n use rustc_session::lint::builtin::UNDEFINED_NAKED_FUNCTION_ABI;\n use rustc_span::symbol::sym;\n use rustc_span::Span;\n use rustc_target::spec::abi::Abi;\n \n-fn check_mod_naked_functions(tcx: TyCtxt<'_>, module_def_id: LocalDefId) {\n-    tcx.hir().visit_item_likes_in_module(module_def_id, &mut CheckNakedFunctions { tcx });\n-}\n-\n pub(crate) fn provide(providers: &mut Providers) {\n     *providers = Providers { check_mod_naked_functions, ..*providers };\n }\n \n-struct CheckNakedFunctions<'tcx> {\n-    tcx: TyCtxt<'tcx>,\n-}\n-\n-impl<'tcx> Visitor<'tcx> for CheckNakedFunctions<'tcx> {\n-    fn visit_fn(\n-        &mut self,\n-        fk: FnKind<'_>,\n-        _fd: &'tcx hir::FnDecl<'tcx>,\n-        body_id: hir::BodyId,\n-        span: Span,\n-        hir_id: HirId,\n-    ) {\n-        let ident_span;\n-        let fn_header;\n-\n-        match fk {\n-            FnKind::Closure => {\n-                // Closures with a naked attribute are rejected during attribute\n-                // check. Don't validate them any further.\n-                return;\n-            }\n-            FnKind::ItemFn(ident, _, ref header, ..) => {\n-                ident_span = ident.span;\n-                fn_header = header;\n-            }\n-\n-            FnKind::Method(ident, ref sig, ..) => {\n-                ident_span = ident.span;\n-                fn_header = &sig.header;\n-            }\n+fn check_mod_naked_functions(tcx: TyCtxt<'_>, module_def_id: LocalDefId) {\n+    let items = tcx.hir_module_items(module_def_id);\n+    for def_id in items.definitions() {\n+        if !matches!(tcx.def_kind(def_id), DefKind::Fn | DefKind::AssocFn) {\n+            continue;\n         }\n \n-        let attrs = self.tcx.hir().attrs(hir_id);\n-        let naked = attrs.iter().any(|attr| attr.has_name(sym::naked));\n-        if naked {\n-            let body = self.tcx.hir().body(body_id);\n-            check_abi(self.tcx, hir_id, fn_header.abi, ident_span);\n-            check_no_patterns(self.tcx, body.params);\n-            check_no_parameters_use(self.tcx, body);\n-            check_asm(self.tcx, body, span);\n-            check_inline(self.tcx, attrs);\n+        let naked = tcx.has_attr(def_id.to_def_id(), sym::naked);\n+        if !naked {\n+            continue;\n         }\n+\n+        let (fn_header, body_id) = match tcx.hir().get_by_def_id(def_id) {\n+            hir::Node::Item(hir::Item { kind: hir::ItemKind::Fn(sig, _, body_id), .. })\n+            | hir::Node::TraitItem(hir::TraitItem {\n+                kind: hir::TraitItemKind::Fn(sig, hir::TraitFn::Provided(body_id)),\n+                ..\n+            })\n+            | hir::Node::ImplItem(hir::ImplItem {\n+                kind: hir::ImplItemKind::Fn(sig, body_id),\n+                ..\n+            }) => (sig.header, *body_id),\n+            _ => continue,\n+        };\n+\n+        let body = tcx.hir().body(body_id);\n+        check_abi(tcx, def_id, fn_header.abi);\n+        check_no_patterns(tcx, body.params);\n+        check_no_parameters_use(tcx, body);\n+        check_asm(tcx, def_id, body);\n+        check_inline(tcx, def_id);\n     }\n }\n \n /// Check that the function isn't inlined.\n-fn check_inline(tcx: TyCtxt<'_>, attrs: &[Attribute]) {\n-    for attr in attrs.iter().filter(|attr| attr.has_name(sym::inline)) {\n+fn check_inline(tcx: TyCtxt<'_>, def_id: LocalDefId) {\n+    let attrs = tcx.get_attrs(def_id.to_def_id(), sym::inline);\n+    for attr in attrs {\n         tcx.sess.struct_span_err(attr.span, \"naked functions cannot be inlined\").emit();\n     }\n }\n \n /// Checks that function uses non-Rust ABI.\n-fn check_abi(tcx: TyCtxt<'_>, hir_id: HirId, abi: Abi, fn_ident_span: Span) {\n+fn check_abi(tcx: TyCtxt<'_>, def_id: LocalDefId, abi: Abi) {\n     if abi == Abi::Rust {\n-        tcx.struct_span_lint_hir(UNDEFINED_NAKED_FUNCTION_ABI, hir_id, fn_ident_span, |lint| {\n+        let hir_id = tcx.hir().local_def_id_to_hir_id(def_id);\n+        let span = tcx.def_span(def_id);\n+        tcx.struct_span_lint_hir(UNDEFINED_NAKED_FUNCTION_ABI, hir_id, span, |lint| {\n             lint.build(\"Rust ABI is unsupported in naked functions\").emit();\n         });\n     }\n@@ -141,15 +129,15 @@ impl<'tcx> Visitor<'tcx> for CheckParameters<'tcx> {\n }\n \n /// Checks that function body contains a single inline assembly block.\n-fn check_asm<'tcx>(tcx: TyCtxt<'tcx>, body: &'tcx hir::Body<'tcx>, fn_span: Span) {\n+fn check_asm<'tcx>(tcx: TyCtxt<'tcx>, def_id: LocalDefId, body: &'tcx hir::Body<'tcx>) {\n     let mut this = CheckInlineAssembly { tcx, items: Vec::new() };\n     this.visit_body(body);\n     if let [(ItemKind::Asm | ItemKind::Err, _)] = this.items[..] {\n         // Ok.\n     } else {\n         let mut diag = struct_span_err!(\n             tcx.sess,\n-            fn_span,\n+            tcx.def_span(def_id),\n             E0787,\n             \"naked functions must contain a single asm block\"\n         );"}, {"sha": "f90967fbe6e43ae65e6776da071f80d0fca8da84", "filename": "src/test/ui/asm/naked-functions.stderr", "status": "modified", "additions": 45, "deletions": 58, "changes": 103, "blob_url": "https://github.com/rust-lang/rust/blob/9b8cfc1eed5eb282c97cee4bbabf9acbdebc5dee/src%2Ftest%2Fui%2Fasm%2Fnaked-functions.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/9b8cfc1eed5eb282c97cee4bbabf9acbdebc5dee/src%2Ftest%2Fui%2Fasm%2Fnaked-functions.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasm%2Fnaked-functions.stderr?ref=9b8cfc1eed5eb282c97cee4bbabf9acbdebc5dee", "patch": "@@ -57,13 +57,11 @@ LL |     a + 1\n error[E0787]: naked functions must contain a single asm block\n   --> $DIR/naked-functions.rs:33:1\n    |\n-LL | / pub unsafe extern \"C\" fn inc(a: u32) -> u32 {\n-LL | |\n-LL | |     a + 1\n-   | |     ----- non-asm is unsupported in naked functions\n-LL | |\n-LL | | }\n-   | |_^\n+LL | pub unsafe extern \"C\" fn inc(a: u32) -> u32 {\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+LL |\n+LL |     a + 1\n+   |     ----- non-asm is unsupported in naked functions\n \n error: referencing function parameters is not allowed in naked functions\n   --> $DIR/naked-functions.rs:42:31\n@@ -82,12 +80,11 @@ LL |     asm!(\"/* {0} */\", in(reg) a, options(noreturn));\n error[E0787]: naked functions must contain a single asm block\n   --> $DIR/naked-functions.rs:48:1\n    |\n-LL | / pub unsafe extern \"C\" fn inc_closure(a: u32) -> u32 {\n-LL | |\n-LL | |     (|| a + 1)()\n-   | |     ------------ non-asm is unsupported in naked functions\n-LL | | }\n-   | |_^\n+LL | pub unsafe extern \"C\" fn inc_closure(a: u32) -> u32 {\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+LL |\n+LL |     (|| a + 1)()\n+   |     ------------ non-asm is unsupported in naked functions\n \n error[E0787]: only `const` and `sym` operands are supported in naked functions\n   --> $DIR/naked-functions.rs:65:10\n@@ -124,30 +121,25 @@ LL |          sym G, options(noreturn),\n error[E0787]: naked functions must contain a single asm block\n   --> $DIR/naked-functions.rs:54:1\n    |\n-LL | / pub unsafe extern \"C\" fn unsupported_operands() {\n-LL | |\n-LL | |     let mut a = 0usize;\n-   | |     ------------------- non-asm is unsupported in naked functions\n-LL | |     let mut b = 0usize;\n-   | |     ------------------- non-asm is unsupported in naked functions\n-LL | |     let mut c = 0usize;\n-   | |     ------------------- non-asm is unsupported in naked functions\n-LL | |     let mut d = 0usize;\n-   | |     ------------------- non-asm is unsupported in naked functions\n-LL | |     let mut e = 0usize;\n-   | |     ------------------- non-asm is unsupported in naked functions\n-...  |\n-LL | |     );\n-LL | | }\n-   | |_^\n+LL | pub unsafe extern \"C\" fn unsupported_operands() {\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+LL |\n+LL |     let mut a = 0usize;\n+   |     ------------------- non-asm is unsupported in naked functions\n+LL |     let mut b = 0usize;\n+   |     ------------------- non-asm is unsupported in naked functions\n+LL |     let mut c = 0usize;\n+   |     ------------------- non-asm is unsupported in naked functions\n+LL |     let mut d = 0usize;\n+   |     ------------------- non-asm is unsupported in naked functions\n+LL |     let mut e = 0usize;\n+   |     ------------------- non-asm is unsupported in naked functions\n \n error[E0787]: naked functions must contain a single asm block\n   --> $DIR/naked-functions.rs:77:1\n    |\n-LL | / pub extern \"C\" fn missing_assembly() {\n-LL | |\n-LL | | }\n-   | |_^\n+LL | pub extern \"C\" fn missing_assembly() {\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n error[E0787]: asm in naked functions must use `noreturn` option\n   --> $DIR/naked-functions.rs:84:5\n@@ -185,20 +177,17 @@ LL |     asm!(\"\", options(noreturn));\n error[E0787]: naked functions must contain a single asm block\n   --> $DIR/naked-functions.rs:82:1\n    |\n-LL | / pub extern \"C\" fn too_many_asm_blocks() {\n-LL | |\n-LL | |     asm!(\"\");\n-LL | |\n-LL | |     asm!(\"\");\n-   | |     -------- multiple asm blocks are unsupported in naked functions\n-LL | |\n-LL | |     asm!(\"\");\n-   | |     -------- multiple asm blocks are unsupported in naked functions\n-LL | |\n-LL | |     asm!(\"\", options(noreturn));\n-   | |     --------------------------- multiple asm blocks are unsupported in naked functions\n-LL | | }\n-   | |_^\n+LL | pub extern \"C\" fn too_many_asm_blocks() {\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+...\n+LL |     asm!(\"\");\n+   |     -------- multiple asm blocks are unsupported in naked functions\n+LL |\n+LL |     asm!(\"\");\n+   |     -------- multiple asm blocks are unsupported in naked functions\n+LL |\n+LL |     asm!(\"\", options(noreturn));\n+   |     --------------------------- multiple asm blocks are unsupported in naked functions\n \n error: referencing function parameters is not allowed in naked functions\n   --> $DIR/naked-functions.rs:97:11\n@@ -211,13 +200,11 @@ LL |         *&y\n error[E0787]: naked functions must contain a single asm block\n   --> $DIR/naked-functions.rs:95:5\n    |\n-LL | /     pub extern \"C\" fn inner(y: usize) -> usize {\n-LL | |\n-LL | |         *&y\n-   | |         --- non-asm is unsupported in naked functions\n-LL | |\n-LL | |     }\n-   | |_____^\n+LL |     pub extern \"C\" fn inner(y: usize) -> usize {\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+LL |\n+LL |         *&y\n+   |         --- non-asm is unsupported in naked functions\n \n error[E0787]: asm options unsupported in naked functions: `nomem`, `preserves_flags`\n   --> $DIR/naked-functions.rs:105:5\n@@ -249,18 +236,18 @@ LL |     asm!(\"\", options(noreturn, may_unwind));\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n \n warning: Rust ABI is unsupported in naked functions\n-  --> $DIR/naked-functions.rs:124:15\n+  --> $DIR/naked-functions.rs:124:1\n    |\n LL | pub unsafe fn default_abi() {\n-   |               ^^^^^^^^^^^\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |\n    = note: `#[warn(undefined_naked_function_abi)]` on by default\n \n warning: Rust ABI is unsupported in naked functions\n-  --> $DIR/naked-functions.rs:130:15\n+  --> $DIR/naked-functions.rs:130:1\n    |\n LL | pub unsafe fn rust_abi() {\n-   |               ^^^^^^^^\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^\n \n error: naked functions cannot be inlined\n   --> $DIR/naked-functions.rs:170:1"}]}