{"sha": "a573adf3cb152ed530f34b003eeca2c2793868d3", "node_id": "C_kwDOAAsO6NoAKGE1NzNhZGYzY2IxNTJlZDUzMGYzNGIwMDNlZWNhMmMyNzkzODY4ZDM", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2022-07-29T06:39:57Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-07-29T06:39:57Z"}, "message": "Rollup merge of #99686 - vincenzopalazzo:macros/impl_on_ptr, r=compiler-errors\n\nadd suggestion when there is a impl of external trait on pointer with wrong coherence rules\n\nCloses https://github.com/rust-lang/rust/issues/99572\n\nThis will try to improve the node in the error message by suggesting a general solution because the solution, in this case, is application depended.\n\nI'm not super happy regarding the code quality, but I'm happy to have feedback on it.\n\n`@rustbot` r? `@compiler-errors`", "tree": {"sha": "6bf85e1f53aec83802270a87f046f387581b1ba7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6bf85e1f53aec83802270a87f046f387581b1ba7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a573adf3cb152ed530f34b003eeca2c2793868d3", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJi44C9CRBK7hj4Ov3rIwAAsdAIAIopCM+tYmdRamDimP5V+rPR\nB+icTCSQFiMgl0PP8KLGTN3JsZMalUKAG0CIo5LbyhPX5h//GN2nE+eOdHKn9nd/\nQhMb+JmQB6LBNEZBtS+CapuroGm6IJpLRyN0ll2GJb7HvamqprCW6MCnqGt1hgn4\nGuiQx4rxv3rOl4bSBdZ4BglnHnji6ZgN/QN5ZXgv2wVd8Cy79SgvZP/360D4DMAB\nZdNTpb5ZgLTizzn4eMoti6m2o8Y7CJgCrd1RwS6X1OqJel7wbyMpR733MbPv74MW\nRLyjNYP8NfmwAoF0aucQ/uWOCjR0Ky8b08hthE5uJ3CnCUEtHkwoHnCuROLcqXQ=\n=qU8g\n-----END PGP SIGNATURE-----\n", "payload": "tree 6bf85e1f53aec83802270a87f046f387581b1ba7\nparent 9de747483029ec3b0c050f7af0dc56765035ff98\nparent 1e584d2d6dee2bc72509574974bf7be11a5924f0\nauthor Yuki Okushi <jtitor@2k36.org> 1659076797 +0900\ncommitter GitHub <noreply@github.com> 1659076797 +0900\n\nRollup merge of #99686 - vincenzopalazzo:macros/impl_on_ptr, r=compiler-errors\n\nadd suggestion when there is a impl of external trait on pointer with wrong coherence rules\n\nCloses https://github.com/rust-lang/rust/issues/99572\n\nThis will try to improve the node in the error message by suggesting a general solution because the solution, in this case, is application depended.\n\nI'm not super happy regarding the code quality, but I'm happy to have feedback on it.\n\n`@rustbot` r? `@compiler-errors`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a573adf3cb152ed530f34b003eeca2c2793868d3", "html_url": "https://github.com/rust-lang/rust/commit/a573adf3cb152ed530f34b003eeca2c2793868d3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a573adf3cb152ed530f34b003eeca2c2793868d3/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9de747483029ec3b0c050f7af0dc56765035ff98", "url": "https://api.github.com/repos/rust-lang/rust/commits/9de747483029ec3b0c050f7af0dc56765035ff98", "html_url": "https://github.com/rust-lang/rust/commit/9de747483029ec3b0c050f7af0dc56765035ff98"}, {"sha": "1e584d2d6dee2bc72509574974bf7be11a5924f0", "url": "https://api.github.com/repos/rust-lang/rust/commits/1e584d2d6dee2bc72509574974bf7be11a5924f0", "html_url": "https://github.com/rust-lang/rust/commit/1e584d2d6dee2bc72509574974bf7be11a5924f0"}], "stats": {"total": 93, "additions": 92, "deletions": 1}, "files": [{"sha": "1608550aa6ae42f9e0c1cbefc41405eacaeac7e2", "filename": "compiler/rustc_typeck/src/coherence/orphan.rs", "status": "modified", "additions": 36, "deletions": 1, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/a573adf3cb152ed530f34b003eeca2c2793868d3/compiler%2Frustc_typeck%2Fsrc%2Fcoherence%2Forphan.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a573adf3cb152ed530f34b003eeca2c2793868d3/compiler%2Frustc_typeck%2Fsrc%2Fcoherence%2Forphan.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcoherence%2Forphan.rs?ref=a573adf3cb152ed530f34b003eeca2c2793868d3", "patch": "@@ -3,7 +3,7 @@\n \n use rustc_data_structures::fx::FxHashSet;\n use rustc_errors::struct_span_err;\n-use rustc_errors::ErrorGuaranteed;\n+use rustc_errors::{Diagnostic, ErrorGuaranteed};\n use rustc_hir as hir;\n use rustc_infer::infer::TyCtxtInferExt;\n use rustc_middle::ty::subst::GenericArgKind;\n@@ -107,6 +107,7 @@ fn do_orphan_check_impl<'tcx>(\n         Err(err) => emit_orphan_check_error(\n             tcx,\n             sp,\n+            item.span,\n             tr.path.span,\n             trait_ref.self_ty(),\n             impl_.self_ty.span,\n@@ -207,6 +208,7 @@ fn do_orphan_check_impl<'tcx>(\n fn emit_orphan_check_error<'tcx>(\n     tcx: TyCtxt<'tcx>,\n     sp: Span,\n+    full_impl_span: Span,\n     trait_span: Span,\n     self_ty: Ty<'tcx>,\n     self_ty_span: Span,\n@@ -247,8 +249,20 @@ fn emit_orphan_check_error<'tcx>(\n                     ty::Slice(_) => (this, \" because slices are always foreign\"),\n                     ty::Array(..) => (this, \" because arrays are always foreign\"),\n                     ty::Tuple(..) => (this, \" because tuples are always foreign\"),\n+                    ty::RawPtr(ptr_ty) => {\n+                        emit_newtype_suggestion_for_raw_ptr(\n+                            full_impl_span,\n+                            self_ty,\n+                            self_ty_span,\n+                            ptr_ty,\n+                            &mut err,\n+                        );\n+\n+                        (format!(\"`{}`\", ty), \" because raw pointers are always foreign\")\n+                    }\n                     _ => (format!(\"`{}`\", ty), \"\"),\n                 };\n+\n                 let msg = format!(\"{} is not defined in the current crate{}\", ty, postfix);\n                 if *is_target_ty {\n                     // Point at `D<A>` in `impl<A, B> for C<B> in D<A>`\n@@ -330,6 +344,27 @@ fn emit_orphan_check_error<'tcx>(\n     })\n }\n \n+fn emit_newtype_suggestion_for_raw_ptr(\n+    full_impl_span: Span,\n+    self_ty: Ty<'_>,\n+    self_ty_span: Span,\n+    ptr_ty: &ty::TypeAndMut<'_>,\n+    diag: &mut Diagnostic,\n+) {\n+    if !self_ty.needs_subst() {\n+        let mut_key = if ptr_ty.mutbl == rustc_middle::mir::Mutability::Mut { \"mut \" } else { \"\" };\n+        let msg_sugg = \"consider introducing a new wrapper type\".to_owned();\n+        let sugg = vec![\n+            (\n+                full_impl_span.shrink_to_lo(),\n+                format!(\"struct WrapperType(*{}{});\\n\\n\", mut_key, ptr_ty.ty),\n+            ),\n+            (self_ty_span, \"WrapperType\".to_owned()),\n+        ];\n+        diag.multipart_suggestion(msg_sugg, sugg, rustc_errors::Applicability::MaybeIncorrect);\n+    }\n+}\n+\n /// Lint impls of auto traits if they are likely to have\n /// unsound or surprising effects on auto impls.\n fn lint_auto_trait_impl<'tcx>("}, {"sha": "272c6bd3fb782bf1af04d343dc2d853fe062275c", "filename": "src/test/ui/errors/issue-99572-impl-trait-on-pointer.rs", "status": "added", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/a573adf3cb152ed530f34b003eeca2c2793868d3/src%2Ftest%2Fui%2Ferrors%2Fissue-99572-impl-trait-on-pointer.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a573adf3cb152ed530f34b003eeca2c2793868d3/src%2Ftest%2Fui%2Ferrors%2Fissue-99572-impl-trait-on-pointer.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ferrors%2Fissue-99572-impl-trait-on-pointer.rs?ref=a573adf3cb152ed530f34b003eeca2c2793868d3", "patch": "@@ -0,0 +1,25 @@\n+// Emit additional suggestion to correct the trait implementation\n+// on a pointer\n+use std::{fmt, marker};\n+\n+struct LocalType;\n+\n+impl fmt::Display for *mut LocalType {\n+//~^ ERROR only traits defined in the current crate can be implemented for arbitrary types\n+//~| NOTE impl doesn't use only types from inside the current crate\n+//~| NOTE `*mut LocalType` is not defined in the current crate because raw pointers are always foreign\n+//~| NOTE define and implement a trait or new type instead\n+//~| HELP consider introducing a new wrapper type\n+    fn fmt(&self, f: &mut fmt::Formatter) -> fmt::Result {\n+        write!(f, \"This not compile\")\n+    }\n+}\n+\n+impl<T> marker::Copy for *mut T {\n+//~^ ERROR only traits defined in the current crate can be implemented for arbitrary types\n+//~| NOTE impl doesn't use only types from inside the current crate\n+//~| NOTE `*mut T` is not defined in the current crate because raw pointers are always foreign\n+//~| NOTE define and implement a trait or new type instead\n+}\n+\n+fn main() {}"}, {"sha": "78d7a47deaac3be3fb9886ff8bcc0ed2edbe2c56", "filename": "src/test/ui/errors/issue-99572-impl-trait-on-pointer.stderr", "status": "added", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/a573adf3cb152ed530f34b003eeca2c2793868d3/src%2Ftest%2Fui%2Ferrors%2Fissue-99572-impl-trait-on-pointer.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a573adf3cb152ed530f34b003eeca2c2793868d3/src%2Ftest%2Fui%2Ferrors%2Fissue-99572-impl-trait-on-pointer.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ferrors%2Fissue-99572-impl-trait-on-pointer.stderr?ref=a573adf3cb152ed530f34b003eeca2c2793868d3", "patch": "@@ -0,0 +1,31 @@\n+error[E0117]: only traits defined in the current crate can be implemented for arbitrary types\n+  --> $DIR/issue-99572-impl-trait-on-pointer.rs:7:1\n+   |\n+LL | impl fmt::Display for *mut LocalType {\n+   | ^^^^^^^^^^^^^^^^^^^^^^--------------\n+   | |                     |\n+   | |                     `*mut LocalType` is not defined in the current crate because raw pointers are always foreign\n+   | impl doesn't use only types from inside the current crate\n+   |\n+   = note: define and implement a trait or new type instead\n+help: consider introducing a new wrapper type\n+   |\n+LL + struct WrapperType(*mut LocalType);\n+LL + \n+LL ~ impl fmt::Display for WrapperType {\n+   |\n+\n+error[E0117]: only traits defined in the current crate can be implemented for arbitrary types\n+  --> $DIR/issue-99572-impl-trait-on-pointer.rs:18:1\n+   |\n+LL | impl<T> marker::Copy for *mut T {\n+   | ^^^^^^^^^^^^^^^^^^^^^^^^^------\n+   | |                        |\n+   | |                        `*mut T` is not defined in the current crate because raw pointers are always foreign\n+   | impl doesn't use only types from inside the current crate\n+   |\n+   = note: define and implement a trait or new type instead\n+\n+error: aborting due to 2 previous errors\n+\n+For more information about this error, try `rustc --explain E0117`."}]}