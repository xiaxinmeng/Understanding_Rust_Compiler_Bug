{"sha": "b20b200d2edc22a97d8bf6a1621f37eacd9bc008", "node_id": "MDY6Q29tbWl0NzI0NzEyOmIyMGIyMDBkMmVkYzIyYTk3ZDhiZjZhMTYyMWYzN2VhY2Q5YmMwMDg=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2020-05-14T16:21:46Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-05-14T16:21:46Z"}, "message": "Rollup merge of #71910 - mibac138:necessary-paren, r=cuviper\n\nFix unused_parens false positive when using binary operations\n\nFixes #71290\n\nr? @cuviper who provided instructions", "tree": {"sha": "8b30733ef5c395dac00ec95ff22b30afda5e743b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8b30733ef5c395dac00ec95ff22b30afda5e743b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b20b200d2edc22a97d8bf6a1621f37eacd9bc008", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJevXAaCRBK7hj4Ov3rIwAAdHIIAKmziWKatdMb7HYpJlATCPm+\nsvfAvdHh9IeVD8QXX3RYOl1tRCwyZgT0rg3i0V44i0YogQxMiOTgJTRt8A7fVIx0\n7INATXsIKntSPJIKucV5xSH/pFaO9yoJeJFzOijwz98yjV9yhiY8Awhypz12crNJ\nVxKWQyKH8kyu4JyOB9ObCt9ISijx7PJ6fUnV1yGdCPI7Jmr0wshbMpqdLh6ReDRY\nzfNyGThP40S6HG881KjwQuwky28GhCW5XD6eWYKzKiAEur6BvDyWyx2Q3Kub9TMC\nrm0anXpVh1uANhrCSGAuH3nE9PQ7bTap3SZ2sTM/kWz6EP75VoqddJfDFkEcVmo=\n=61lm\n-----END PGP SIGNATURE-----\n", "payload": "tree 8b30733ef5c395dac00ec95ff22b30afda5e743b\nparent af6d8865fe0e1f6338c32cb3370802f2ebca0dc4\nparent 4b7a92838c98929a9f4c7a64583b5ea49ebb3a35\nauthor Dylan DPC <dylan.dpc@gmail.com> 1589473306 +0200\ncommitter GitHub <noreply@github.com> 1589473306 +0200\n\nRollup merge of #71910 - mibac138:necessary-paren, r=cuviper\n\nFix unused_parens false positive when using binary operations\n\nFixes #71290\n\nr? @cuviper who provided instructions\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b20b200d2edc22a97d8bf6a1621f37eacd9bc008", "html_url": "https://github.com/rust-lang/rust/commit/b20b200d2edc22a97d8bf6a1621f37eacd9bc008", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b20b200d2edc22a97d8bf6a1621f37eacd9bc008/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "af6d8865fe0e1f6338c32cb3370802f2ebca0dc4", "url": "https://api.github.com/repos/rust-lang/rust/commits/af6d8865fe0e1f6338c32cb3370802f2ebca0dc4", "html_url": "https://github.com/rust-lang/rust/commit/af6d8865fe0e1f6338c32cb3370802f2ebca0dc4"}, {"sha": "4b7a92838c98929a9f4c7a64583b5ea49ebb3a35", "url": "https://api.github.com/repos/rust-lang/rust/commits/4b7a92838c98929a9f4c7a64583b5ea49ebb3a35", "html_url": "https://github.com/rust-lang/rust/commit/4b7a92838c98929a9f4c7a64583b5ea49ebb3a35"}], "stats": {"total": 47, "additions": 43, "deletions": 4}, "files": [{"sha": "c24079a6e4be234c9ec5156c8181d9dcd5785236", "filename": "src/librustc_lint/unused.rs", "status": "modified", "additions": 20, "deletions": 4, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/b20b200d2edc22a97d8bf6a1621f37eacd9bc008/src%2Flibrustc_lint%2Funused.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b20b200d2edc22a97d8bf6a1621f37eacd9bc008/src%2Flibrustc_lint%2Funused.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_lint%2Funused.rs?ref=b20b200d2edc22a97d8bf6a1621f37eacd9bc008", "patch": "@@ -380,11 +380,27 @@ trait UnusedDelimLint {\n     );\n \n     fn is_expr_delims_necessary(inner: &ast::Expr, followed_by_block: bool) -> bool {\n-        followed_by_block\n-            && match inner.kind {\n-                ExprKind::Ret(_) | ExprKind::Break(..) => true,\n-                _ => parser::contains_exterior_struct_lit(&inner),\n+        // Prevent false-positives in cases like `fn x() -> u8 { ({ 0 } + 1) }`\n+        let lhs_needs_parens = {\n+            let mut innermost = inner;\n+            loop {\n+                if let ExprKind::Binary(_, lhs, _rhs) = &innermost.kind {\n+                    innermost = lhs;\n+                    if !rustc_ast::util::classify::expr_requires_semi_to_be_stmt(innermost) {\n+                        break true;\n+                    }\n+                } else {\n+                    break false;\n+                }\n             }\n+        };\n+\n+        lhs_needs_parens\n+            || (followed_by_block\n+                && match inner.kind {\n+                    ExprKind::Ret(_) | ExprKind::Break(..) => true,\n+                    _ => parser::contains_exterior_struct_lit(&inner),\n+                })\n     }\n \n     fn emit_unused_delims_expr("}, {"sha": "24d77e36d94f54e61af78713e1b83d92af53d445", "filename": "src/test/ui/lint/issue-71290-unused-paren-binop.rs", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/b20b200d2edc22a97d8bf6a1621f37eacd9bc008/src%2Ftest%2Fui%2Flint%2Fissue-71290-unused-paren-binop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b20b200d2edc22a97d8bf6a1621f37eacd9bc008/src%2Ftest%2Fui%2Flint%2Fissue-71290-unused-paren-binop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Fissue-71290-unused-paren-binop.rs?ref=b20b200d2edc22a97d8bf6a1621f37eacd9bc008", "patch": "@@ -0,0 +1,23 @@\n+// check-pass\n+// Make sure unused parens lint doesn't emit a false positive.\n+// See https://github.com/rust-lang/rust/issues/71290 for details.\n+#![deny(unused_parens)]\n+\n+fn x() -> u8 {\n+    ({ 0 }) + 1\n+}\n+\n+fn y() -> u8 {\n+    ({ 0 } + 1)\n+}\n+\n+pub fn foo(a: bool, b: bool) -> u8 {\n+    (if a { 1 } else { 0 } + if b { 1 } else { 0 })\n+}\n+\n+pub fn bar() -> u8 {\n+    // Make sure nested expressions are handled correctly as well\n+    ({ 0 } + 1 + 2 + 3 + 4 + 5 + 6 + 7 + 8 + 9)\n+}\n+\n+fn main() {}"}]}