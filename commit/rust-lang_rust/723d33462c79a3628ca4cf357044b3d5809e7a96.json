{"sha": "723d33462c79a3628ca4cf357044b3d5809e7a96", "node_id": "C_kwDOAAsO6NoAKDcyM2QzMzQ2MmM3OWEzNjI4Y2E0Y2YzNTcwNDRiM2Q1ODA5ZTdhOTY", "commit": {"author": {"name": "Josh Stone", "email": "jistone@redhat.com", "date": "2022-03-01T19:42:10Z"}, "committer": {"name": "Josh Stone", "email": "jistone@redhat.com", "date": "2022-03-01T19:42:10Z"}, "message": "Restore the local filter on mono item sorting\n\nIn `CodegenUnit::items_in_deterministic_order`, there's a comment that\nonly local HirIds should be taken into account, but #90408 removed the\n`as_local` call that sets others to None. Restoring that check fixes the\ns390x hangs seen in [RHBZ 2058803].\n\n[RHBZ 2058803]: https://bugzilla.redhat.com/show_bug.cgi?id=2058803", "tree": {"sha": "f48636a4d9d3e0cf373366b0e73ff1c5d276f351", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f48636a4d9d3e0cf373366b0e73ff1c5d276f351"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/723d33462c79a3628ca4cf357044b3d5809e7a96", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/723d33462c79a3628ca4cf357044b3d5809e7a96", "html_url": "https://github.com/rust-lang/rust/commit/723d33462c79a3628ca4cf357044b3d5809e7a96", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/723d33462c79a3628ca4cf357044b3d5809e7a96/comments", "author": {"login": "cuviper", "id": 36186, "node_id": "MDQ6VXNlcjM2MTg2", "avatar_url": "https://avatars.githubusercontent.com/u/36186?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cuviper", "html_url": "https://github.com/cuviper", "followers_url": "https://api.github.com/users/cuviper/followers", "following_url": "https://api.github.com/users/cuviper/following{/other_user}", "gists_url": "https://api.github.com/users/cuviper/gists{/gist_id}", "starred_url": "https://api.github.com/users/cuviper/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cuviper/subscriptions", "organizations_url": "https://api.github.com/users/cuviper/orgs", "repos_url": "https://api.github.com/users/cuviper/repos", "events_url": "https://api.github.com/users/cuviper/events{/privacy}", "received_events_url": "https://api.github.com/users/cuviper/received_events", "type": "User", "site_admin": false}, "committer": {"login": "cuviper", "id": 36186, "node_id": "MDQ6VXNlcjM2MTg2", "avatar_url": "https://avatars.githubusercontent.com/u/36186?v=4", "gravatar_id": "", "url": "https://api.github.com/users/cuviper", "html_url": "https://github.com/cuviper", "followers_url": "https://api.github.com/users/cuviper/followers", "following_url": "https://api.github.com/users/cuviper/following{/other_user}", "gists_url": "https://api.github.com/users/cuviper/gists{/gist_id}", "starred_url": "https://api.github.com/users/cuviper/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/cuviper/subscriptions", "organizations_url": "https://api.github.com/users/cuviper/orgs", "repos_url": "https://api.github.com/users/cuviper/repos", "events_url": "https://api.github.com/users/cuviper/events{/privacy}", "received_events_url": "https://api.github.com/users/cuviper/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f0c4da49983aa699f715caf681e3154b445fb60b", "url": "https://api.github.com/repos/rust-lang/rust/commits/f0c4da49983aa699f715caf681e3154b445fb60b", "html_url": "https://github.com/rust-lang/rust/commit/f0c4da49983aa699f715caf681e3154b445fb60b"}], "stats": {"total": 9, "additions": 4, "deletions": 5}, "files": [{"sha": "13c325a14e4023ac0ef7237421c715968875c912", "filename": "compiler/rustc_middle/src/mir/mono.rs", "status": "modified", "additions": 4, "deletions": 5, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/723d33462c79a3628ca4cf357044b3d5809e7a96/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmono.rs", "raw_url": "https://github.com/rust-lang/rust/raw/723d33462c79a3628ca4cf357044b3d5809e7a96/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmono.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmono.rs?ref=723d33462c79a3628ca4cf357044b3d5809e7a96", "patch": "@@ -7,6 +7,7 @@ use rustc_data_structures::fx::FxHashMap;\n use rustc_data_structures::stable_hasher::{HashStable, StableHasher};\n use rustc_hir::def_id::{CrateNum, DefId, LOCAL_CRATE};\n use rustc_hir::ItemId;\n+use rustc_index::vec::Idx;\n use rustc_query_system::ich::{NodeIdHashingMode, StableHashingContext};\n use rustc_session::config::OptLevel;\n use rustc_span::source_map::Span;\n@@ -380,7 +381,7 @@ impl<'tcx> CodegenUnit<'tcx> {\n                             // instances into account. The others don't matter for\n                             // the codegen tests and can even make item order\n                             // unstable.\n-                            InstanceDef::Item(def) => Some(def.did.index.as_usize()),\n+                            InstanceDef::Item(def) => def.did.as_local().map(Idx::index),\n                             InstanceDef::VtableShim(..)\n                             | InstanceDef::ReifyShim(..)\n                             | InstanceDef::Intrinsic(..)\n@@ -391,10 +392,8 @@ impl<'tcx> CodegenUnit<'tcx> {\n                             | InstanceDef::CloneShim(..) => None,\n                         }\n                     }\n-                    MonoItem::Static(def_id) => Some(def_id.index.as_usize()),\n-                    MonoItem::GlobalAsm(item_id) => {\n-                        Some(item_id.def_id.to_def_id().index.as_usize())\n-                    }\n+                    MonoItem::Static(def_id) => def_id.as_local().map(Idx::index),\n+                    MonoItem::GlobalAsm(item_id) => Some(item_id.def_id.index()),\n                 },\n                 item.symbol_name(tcx),\n             )"}]}