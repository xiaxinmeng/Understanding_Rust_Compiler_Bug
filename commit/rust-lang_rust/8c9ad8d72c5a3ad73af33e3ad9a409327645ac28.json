{"sha": "8c9ad8d72c5a3ad73af33e3ad9a409327645ac28", "node_id": "MDY6Q29tbWl0NzI0NzEyOjhjOWFkOGQ3MmM1YTNhZDczYWYzM2UzYWQ5YTQwOTMyNzY0NWFjMjg=", "commit": {"author": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2017-05-06T04:49:59Z"}, "committer": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2017-05-06T07:55:42Z"}, "message": "Group \"macro expansion\" notes per call span", "tree": {"sha": "52c51d380feab94de6d8e7300d1b02a0c67c0885", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/52c51d380feab94de6d8e7300d1b02a0c67c0885"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8c9ad8d72c5a3ad73af33e3ad9a409327645ac28", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8c9ad8d72c5a3ad73af33e3ad9a409327645ac28", "html_url": "https://github.com/rust-lang/rust/commit/8c9ad8d72c5a3ad73af33e3ad9a409327645ac28", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8c9ad8d72c5a3ad73af33e3ad9a409327645ac28/comments", "author": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "committer": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "56411443f2421e6726413c212a697a45d45ddfa1", "url": "https://api.github.com/repos/rust-lang/rust/commits/56411443f2421e6726413c212a697a45d45ddfa1", "html_url": "https://github.com/rust-lang/rust/commit/56411443f2421e6726413c212a697a45d45ddfa1"}], "stats": {"total": 52, "additions": 30, "deletions": 22}, "files": [{"sha": "db8c9ac306bba718ff4ff9c6a64050289bdda97b", "filename": "src/librustc_errors/lib.rs", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/8c9ad8d72c5a3ad73af33e3ad9a409327645ac28/src%2Flibrustc_errors%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8c9ad8d72c5a3ad73af33e3ad9a409327645ac28/src%2Flibrustc_errors%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_errors%2Flib.rs?ref=8c9ad8d72c5a3ad73af33e3ad9a409327645ac28", "patch": "@@ -388,11 +388,13 @@ impl Handler {\n     pub fn span_note_without_error<S: Into<MultiSpan>>(&self, sp: S, msg: &str) {\n         self.emit(&sp.into(), msg, Note);\n     }\n-    pub fn span_label_without_error(&self, sp: Span, msg: &str, lbl: &str) {\n+    pub fn span_note_diag<'a>(&'a self,\n+                              sp: Span,\n+                              msg: &str)\n+                              -> DiagnosticBuilder<'a> {\n         let mut db = DiagnosticBuilder::new(self, Note, msg);\n         db.set_span(sp);\n-        db.span_label(sp, &lbl);\n-        db.emit();\n+        db\n     }\n     pub fn span_unimpl<S: Into<MultiSpan>>(&self, sp: S, msg: &str) -> ! {\n         self.span_bug(sp, &format!(\"unimplemented {}\", msg));"}, {"sha": "f731c5abdd6a1f7e0ad275f45460e047e1f5779f", "filename": "src/libsyntax/ext/base.rs", "status": "modified", "additions": 11, "deletions": 2, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/8c9ad8d72c5a3ad73af33e3ad9a409327645ac28/src%2Flibsyntax%2Fext%2Fbase.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8c9ad8d72c5a3ad73af33e3ad9a409327645ac28/src%2Flibsyntax%2Fext%2Fbase.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fbase.rs?ref=8c9ad8d72c5a3ad73af33e3ad9a409327645ac28", "patch": "@@ -24,6 +24,7 @@ use ptr::P;\n use symbol::Symbol;\n use util::small_vector::SmallVector;\n \n+use std::collections::HashMap;\n use std::path::PathBuf;\n use std::rc::Rc;\n use std::default::Default;\n@@ -643,6 +644,7 @@ pub struct ExtCtxt<'a> {\n     pub resolver: &'a mut Resolver,\n     pub resolve_err_count: usize,\n     pub current_expansion: ExpansionData,\n+    pub expansions: HashMap<Span, Vec<String>>,\n }\n \n impl<'a> ExtCtxt<'a> {\n@@ -662,6 +664,7 @@ impl<'a> ExtCtxt<'a> {\n                 module: Rc::new(ModuleData { mod_path: Vec::new(), directory: PathBuf::new() }),\n                 directory_ownership: DirectoryOwnership::Owned,\n             },\n+            expansions: HashMap::new(),\n         }\n     }\n \n@@ -765,8 +768,14 @@ impl<'a> ExtCtxt<'a> {\n     pub fn span_bug(&self, sp: Span, msg: &str) -> ! {\n         self.parse_sess.span_diagnostic.span_bug(sp, msg);\n     }\n-    pub fn span_label_without_error(&self, sp: Span, msg: &str, label: &str) {\n-        self.parse_sess.span_diagnostic.span_label_without_error(sp, msg, label);\n+    pub fn trace_macros_diag(&self) {\n+        for (sp, notes) in self.expansions.iter() {\n+            let mut db = self.parse_sess.span_diagnostic.span_note_diag(*sp, &\"trace_macro\");\n+            for note in notes {\n+                db.note(&note);\n+            }\n+            db.emit();\n+        }\n     }\n     pub fn bug(&self, msg: &str) -> ! {\n         self.parse_sess.span_diagnostic.bug(msg);"}, {"sha": "31d4cc779c25ee1fb1eb6f9b3a080f5c42af0cd7", "filename": "src/libsyntax/ext/expand.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/8c9ad8d72c5a3ad73af33e3ad9a409327645ac28/src%2Flibsyntax%2Fext%2Fexpand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8c9ad8d72c5a3ad73af33e3ad9a409327645ac28/src%2Flibsyntax%2Fext%2Fexpand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fexpand.rs?ref=8c9ad8d72c5a3ad73af33e3ad9a409327645ac28", "patch": "@@ -231,7 +231,7 @@ impl<'a, 'b> MacroExpander<'a, 'b> {\n             },\n             _ => unreachable!(),\n         };\n-\n+        self.cx.trace_macros_diag();\n         krate\n     }\n "}, {"sha": "f959ccc989e2e9e9d55643966f0fe4648b8bd17b", "filename": "src/libsyntax/ext/tt/macro_rules.rs", "status": "modified", "additions": 6, "deletions": 6, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/8c9ad8d72c5a3ad73af33e3ad9a409327645ac28/src%2Flibsyntax%2Fext%2Ftt%2Fmacro_rules.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8c9ad8d72c5a3ad73af33e3ad9a409327645ac28/src%2Flibsyntax%2Fext%2Ftt%2Fmacro_rules.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Ftt%2Fmacro_rules.rs?ref=8c9ad8d72c5a3ad73af33e3ad9a409327645ac28", "patch": "@@ -27,8 +27,8 @@ use symbol::Symbol;\n use tokenstream::{TokenStream, TokenTree};\n \n use std::cell::RefCell;\n-use std::collections::{HashMap};\n-use std::collections::hash_map::{Entry};\n+use std::collections::HashMap;\n+use std::collections::hash_map::Entry;\n use std::rc::Rc;\n \n pub struct ParserAnyMacro<'a> {\n@@ -85,17 +85,17 @@ impl TTMacroExpander for MacroRulesMacroExpander {\n }\n \n /// Given `lhses` and `rhses`, this is the new macro we create\n-fn generic_extension<'cx>(cx: &'cx ExtCtxt,\n+fn generic_extension<'cx>(cx: &'cx mut ExtCtxt,\n                           sp: Span,\n                           name: ast::Ident,\n                           arg: TokenStream,\n                           lhses: &[quoted::TokenTree],\n                           rhses: &[quoted::TokenTree])\n                           -> Box<MacResult+'cx> {\n     if cx.trace_macros() {\n-        cx.span_label_without_error(sp,\n-                                    &\"trace_macro\",\n-                                    &format!(\"expands to `{}! {{ {} }}`\", name, arg));\n+        let sp = sp.macro_backtrace().last().map(|trace| trace.call_site).unwrap_or(sp);\n+        let mut values: &mut Vec<String> = cx.expansions.entry(sp).or_insert(vec![]);\n+        values.push(format!(\"expands to `{}! {{ {} }}`\", name, arg));\n     }\n \n     // Which arm's failure should we report? (the one furthest along)"}, {"sha": "34f674ae016a589b7f3eec6a00aafb11c032af0c", "filename": "src/test/ui/macros/trace-macro.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/8c9ad8d72c5a3ad73af33e3ad9a409327645ac28/src%2Ftest%2Fui%2Fmacros%2Ftrace-macro.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8c9ad8d72c5a3ad73af33e3ad9a409327645ac28/src%2Ftest%2Fui%2Fmacros%2Ftrace-macro.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacros%2Ftrace-macro.rs?ref=8c9ad8d72c5a3ad73af33e3ad9a409327645ac28", "patch": "@@ -8,6 +8,8 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n+// compile-flags: -Z trace-macros\n+\n fn main() {\n     println!(\"Hello, World!\");\n }"}, {"sha": "09117a4ca740452e0870a1adbd7c369f545e1ec0", "filename": "src/test/ui/macros/trace-macro.stderr", "status": "modified", "additions": 5, "deletions": 10, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/8c9ad8d72c5a3ad73af33e3ad9a409327645ac28/src%2Ftest%2Fui%2Fmacros%2Ftrace-macro.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/8c9ad8d72c5a3ad73af33e3ad9a409327645ac28/src%2Ftest%2Fui%2Fmacros%2Ftrace-macro.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmacros%2Ftrace-macro.stderr?ref=8c9ad8d72c5a3ad73af33e3ad9a409327645ac28", "patch": "@@ -1,14 +1,9 @@\n note: trace_macro\n-  --> $DIR/trace-macro.rs:12:5\n+  --> $DIR/trace-macro.rs:14:5\n    |\n-12 |     println!(\"Hello, World!\");\n-   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^ expands to `println! { \"Hello, World!\" }`\n-\n-note: trace_macro\n-  --> $DIR/trace-macro.rs:12:5\n-   |\n-12 |     println!(\"Hello, World!\");\n-   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^ expands to `print! { concat ! ( \"Hello, World!\" , \"\\n\" ) }`\n+14 |     println!(\"Hello, World!\");\n+   |     ^^^^^^^^^^^^^^^^^^^^^^^^^^\n    |\n-   = note: this error originates in a macro outside of the current crate\n+   = note: expands to `println! { \"Hello, World!\" }`\n+   = note: expands to `print! { concat ! ( \"Hello, World!\" , \"/n\" ) }`\n "}]}