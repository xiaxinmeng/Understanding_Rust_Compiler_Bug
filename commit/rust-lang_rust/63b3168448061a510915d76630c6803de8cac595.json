{"sha": "63b3168448061a510915d76630c6803de8cac595", "node_id": "MDY6Q29tbWl0NzI0NzEyOjYzYjMxNjg0NDgwNjFhNTEwOTE1ZDc2NjMwYzY4MDNkZThjYWM1OTU=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2018-01-24T05:59:53Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2018-01-24T15:18:02Z"}, "message": "llvm6: Don't clone LLVM modules on wasm\n\nThe comment for why cloning exists doesn't actually apply for wasm today and\napparently cloning is causing subtle bugs in LLVM, so let's just avoid it\naltogether. More specifically after we emit the assembly for the wasm target we\ndon't actually use the module again, so there's no need to keep both around.\n\nThis seemed to be causing some scary verifier assertions in LLVM which seemed to\nbe uncovered by presumably (?) buggy behavior. Let's just avoid it for now and\nmake the wasm target slightly more lean in the process.", "tree": {"sha": "0e1715798da81496a2cc582738b1eb7945e14831", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0e1715798da81496a2cc582738b1eb7945e14831"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/63b3168448061a510915d76630c6803de8cac595", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/63b3168448061a510915d76630c6803de8cac595", "html_url": "https://github.com/rust-lang/rust/commit/63b3168448061a510915d76630c6803de8cac595", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/63b3168448061a510915d76630c6803de8cac595/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "caedb36f081334451ba83e9524af025891208592", "url": "https://api.github.com/repos/rust-lang/rust/commits/caedb36f081334451ba83e9524af025891208592", "html_url": "https://github.com/rust-lang/rust/commit/caedb36f081334451ba83e9524af025891208592"}], "stats": {"total": 4, "additions": 2, "deletions": 2}, "files": [{"sha": "957b97fc8a042002843582356a47ffc7e8111dbb", "filename": "src/librustc_trans/back/write.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/63b3168448061a510915d76630c6803de8cac595/src%2Flibrustc_trans%2Fback%2Fwrite.rs", "raw_url": "https://github.com/rust-lang/rust/raw/63b3168448061a510915d76630c6803de8cac595/src%2Flibrustc_trans%2Fback%2Fwrite.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fback%2Fwrite.rs?ref=63b3168448061a510915d76630c6803de8cac595", "patch": "@@ -733,7 +733,7 @@ unsafe fn codegen(cgcx: &CodegenContext,\n             // We can't use the same module for asm and binary output, because that triggers\n             // various errors like invalid IR or broken binaries, so we might have to clone the\n             // module to produce the asm output\n-            let llmod = if config.emit_obj {\n+            let llmod = if config.emit_obj && !asm2wasm {\n                 llvm::LLVMCloneModule(llmod)\n             } else {\n                 llmod\n@@ -742,7 +742,7 @@ unsafe fn codegen(cgcx: &CodegenContext,\n                 write_output_file(diag_handler, tm, cpm, llmod, &path,\n                                   llvm::FileType::AssemblyFile)\n             })?;\n-            if config.emit_obj {\n+            if config.emit_obj && !asm2wasm {\n                 llvm::LLVMDisposeModule(llmod);\n             }\n             timeline.record(\"asm\");"}]}