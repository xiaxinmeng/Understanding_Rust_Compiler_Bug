{"sha": "fbdc5118d55c05a7dfa1017c3f3ec2c1c9370d6e", "node_id": "C_kwDOAAsO6NoAKGZiZGM1MTE4ZDU1YzA1YTdkZmExMDE3YzNmM2VjMmMxYzkzNzBkNmU", "commit": {"author": {"name": "Nicky Lim", "email": "nickylim.p@gmail.com", "date": "2023-05-25T12:31:56Z"}, "committer": {"name": "Nicky Lim", "email": "nickylim.p@gmail.com", "date": "2023-05-25T12:31:56Z"}, "message": "Add `ItemTemplate` trait", "tree": {"sha": "03473f248c1e5c355c0e0cb33b845b1f88ff33f5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/03473f248c1e5c355c0e0cb33b845b1f88ff33f5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fbdc5118d55c05a7dfa1017c3f3ec2c1c9370d6e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fbdc5118d55c05a7dfa1017c3f3ec2c1c9370d6e", "html_url": "https://github.com/rust-lang/rust/commit/fbdc5118d55c05a7dfa1017c3f3ec2c1c9370d6e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fbdc5118d55c05a7dfa1017c3f3ec2c1c9370d6e/comments", "author": {"login": "nicklimmm", "id": 65026286, "node_id": "MDQ6VXNlcjY1MDI2Mjg2", "avatar_url": "https://avatars.githubusercontent.com/u/65026286?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nicklimmm", "html_url": "https://github.com/nicklimmm", "followers_url": "https://api.github.com/users/nicklimmm/followers", "following_url": "https://api.github.com/users/nicklimmm/following{/other_user}", "gists_url": "https://api.github.com/users/nicklimmm/gists{/gist_id}", "starred_url": "https://api.github.com/users/nicklimmm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nicklimmm/subscriptions", "organizations_url": "https://api.github.com/users/nicklimmm/orgs", "repos_url": "https://api.github.com/users/nicklimmm/repos", "events_url": "https://api.github.com/users/nicklimmm/events{/privacy}", "received_events_url": "https://api.github.com/users/nicklimmm/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nicklimmm", "id": 65026286, "node_id": "MDQ6VXNlcjY1MDI2Mjg2", "avatar_url": "https://avatars.githubusercontent.com/u/65026286?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nicklimmm", "html_url": "https://github.com/nicklimmm", "followers_url": "https://api.github.com/users/nicklimmm/followers", "following_url": "https://api.github.com/users/nicklimmm/following{/other_user}", "gists_url": "https://api.github.com/users/nicklimmm/gists{/gist_id}", "starred_url": "https://api.github.com/users/nicklimmm/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nicklimmm/subscriptions", "organizations_url": "https://api.github.com/users/nicklimmm/orgs", "repos_url": "https://api.github.com/users/nicklimmm/repos", "events_url": "https://api.github.com/users/nicklimmm/events{/privacy}", "received_events_url": "https://api.github.com/users/nicklimmm/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "eb9da7bfa375ad58bcb946115f3191a2756785e5", "url": "https://api.github.com/repos/rust-lang/rust/commits/eb9da7bfa375ad58bcb946115f3191a2756785e5", "html_url": "https://github.com/rust-lang/rust/commit/eb9da7bfa375ad58bcb946115f3191a2756785e5"}], "stats": {"total": 103, "additions": 61, "deletions": 42}, "files": [{"sha": "b944dc7b260406a49bf3926fe9ce9a42f3e33078", "filename": "src/librustdoc/html/render/print_item.rs", "status": "modified", "additions": 57, "deletions": 38, "changes": 95, "blob_url": "https://github.com/rust-lang/rust/blob/fbdc5118d55c05a7dfa1017c3f3ec2c1c9370d6e/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fbdc5118d55c05a7dfa1017c3f3ec2c1c9370d6e/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fprint_item.rs?ref=fbdc5118d55c05a7dfa1017c3f3ec2c1c9370d6e", "patch": "@@ -9,6 +9,8 @@ use rustc_middle::middle::stability;\n use rustc_middle::ty::{self, TyCtxt};\n use rustc_span::hygiene::MacroKind;\n use rustc_span::symbol::{kw, sym, Symbol};\n+use std::borrow::Borrow;\n+use std::cell::{RefCell, RefMut};\n use std::cmp::Ordering;\n use std::fmt;\n use std::rc::Rc;\n@@ -216,6 +218,53 @@ fn toggle_close(mut w: impl fmt::Write) {\n     w.write_str(\"</details>\").unwrap();\n }\n \n+trait ItemTemplate<'a, 'cx: 'a>: askama::Template + fmt::Display {\n+    fn item_and_mut_cx(&self) -> (&'a clean::Item, RefMut<'_, &'a mut Context<'cx>>);\n+}\n+\n+fn item_template_document<'a: 'b, 'b, 'cx: 'a>(\n+    templ: &'b impl ItemTemplate<'a, 'cx>,\n+) -> impl fmt::Display + Captures<'a> + 'b + Captures<'cx> {\n+    display_fn(move |f| {\n+        let (item, mut cx) = templ.item_and_mut_cx();\n+        let v = document(*cx, item, None, HeadingOffset::H2);\n+        write!(f, \"{v}\")\n+    })\n+}\n+\n+fn item_template_document_type_layout<'a: 'b, 'b, 'cx: 'a>(\n+    templ: &'b impl ItemTemplate<'a, 'cx>,\n+) -> impl fmt::Display + Captures<'a> + 'b + Captures<'cx> {\n+    display_fn(move |f| {\n+        let (item, cx) = templ.item_and_mut_cx();\n+        let def_id = item.item_id.expect_def_id();\n+        let v = document_type_layout(*cx, def_id);\n+        write!(f, \"{v}\")\n+    })\n+}\n+\n+fn item_template_render_attributes_in_pre<'a: 'b, 'b, 'cx: 'a>(\n+    templ: &'b impl ItemTemplate<'a, 'cx>,\n+) -> impl fmt::Display + Captures<'a> + 'b + Captures<'cx> {\n+    display_fn(move |f| {\n+        let (item, cx) = templ.item_and_mut_cx();\n+        let tcx = cx.tcx();\n+        let v = render_attributes_in_pre(item, \"\", tcx);\n+        write!(f, \"{v}\")\n+    })\n+}\n+\n+fn item_template_render_assoc_items<'a: 'b, 'b, 'cx: 'a>(\n+    templ: &'b impl ItemTemplate<'a, 'cx>,\n+) -> impl fmt::Display + Captures<'a> + 'b + Captures<'cx> {\n+    display_fn(move |f| {\n+        let (item, mut cx) = templ.item_and_mut_cx();\n+        let def_id = item.item_id.expect_def_id();\n+        let v = render_assoc_items(*cx, item, def_id, AssocItemRender::All);\n+        write!(f, \"{v}\")\n+    })\n+}\n+\n fn item_module(w: &mut Buffer, cx: &mut Context<'_>, item: &clean::Item, items: &[clean::Item]) {\n     write!(w, \"{}\", document(cx, item, None, HeadingOffset::H2));\n \n@@ -1131,55 +1180,25 @@ fn item_union(w: &mut Buffer, cx: &mut Context<'_>, it: &clean::Item, s: &clean:\n     #[derive(Template)]\n     #[template(path = \"item_union.html\")]\n     struct ItemUnion<'a, 'cx> {\n-        cx: std::cell::RefCell<&'a mut Context<'cx>>,\n+        cx: RefCell<&'a mut Context<'cx>>,\n         it: &'a clean::Item,\n         s: &'a clean::Union,\n     }\n \n-    impl<'a, 'cx: 'a> ItemUnion<'a, 'cx> {\n-        fn render_assoc_items<'b>(\n-            &'b self,\n-        ) -> impl fmt::Display + Captures<'a> + 'b + Captures<'cx> {\n-            display_fn(move |f| {\n-                let def_id = self.it.item_id.expect_def_id();\n-                let mut cx = self.cx.borrow_mut();\n-                let v = render_assoc_items(*cx, self.it, def_id, AssocItemRender::All);\n-                write!(f, \"{v}\")\n-            })\n-        }\n-        fn document_type_layout<'b>(\n-            &'b self,\n-        ) -> impl fmt::Display + Captures<'a> + 'b + Captures<'cx> {\n-            display_fn(move |f| {\n-                let def_id = self.it.item_id.expect_def_id();\n-                let cx = self.cx.borrow_mut();\n-                let v = document_type_layout(*cx, def_id);\n-                write!(f, \"{v}\")\n-            })\n+    impl<'a, 'cx: 'a> ItemTemplate<'a, 'cx> for ItemUnion<'a, 'cx> {\n+        fn item_and_mut_cx(&self) -> (&'a clean::Item, RefMut<'_, &'a mut Context<'cx>>) {\n+            (self.it, self.cx.borrow_mut())\n         }\n+    }\n+\n+    impl<'a, 'cx: 'a> ItemUnion<'a, 'cx> {\n         fn render_union<'b>(&'b self) -> impl fmt::Display + Captures<'a> + 'b + Captures<'cx> {\n             display_fn(move |f| {\n                 let cx = self.cx.borrow_mut();\n                 let v = render_union(self.it, Some(&self.s.generics), &self.s.fields, *cx);\n                 write!(f, \"{v}\")\n             })\n         }\n-        fn render_attributes_in_pre<'b>(\n-            &'b self,\n-        ) -> impl fmt::Display + Captures<'a> + 'b + Captures<'cx> {\n-            display_fn(move |f| {\n-                let tcx = self.cx.borrow().tcx();\n-                let v = render_attributes_in_pre(self.it, \"\", tcx);\n-                write!(f, \"{v}\")\n-            })\n-        }\n-        fn document<'b>(&'b self) -> impl fmt::Display + Captures<'a> + 'b + Captures<'cx> {\n-            display_fn(move |f| {\n-                let mut cx = self.cx.borrow_mut();\n-                let v = document(*cx, self.it, None, HeadingOffset::H2);\n-                write!(f, \"{v}\")\n-            })\n-        }\n         fn document_field<'b>(\n             &'b self,\n             field: &'a clean::Item,\n@@ -1219,7 +1238,7 @@ fn item_union(w: &mut Buffer, cx: &mut Context<'_>, it: &clean::Item, s: &clean:\n         }\n     }\n \n-    ItemUnion { cx: std::cell::RefCell::new(cx), it, s }.render_into(w).unwrap();\n+    ItemUnion { cx: RefCell::new(cx), it, s }.render_into(w).unwrap();\n }\n \n fn print_tuple_struct_fields<'a, 'cx: 'a>("}, {"sha": "c2196700513326a5970f87271514b48e1c55aad6", "filename": "src/librustdoc/html/templates/item_union.html", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/fbdc5118d55c05a7dfa1017c3f3ec2c1c9370d6e/src%2Flibrustdoc%2Fhtml%2Ftemplates%2Fitem_union.html", "raw_url": "https://github.com/rust-lang/rust/raw/fbdc5118d55c05a7dfa1017c3f3ec2c1c9370d6e/src%2Flibrustdoc%2Fhtml%2Ftemplates%2Fitem_union.html", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Ftemplates%2Fitem_union.html?ref=fbdc5118d55c05a7dfa1017c3f3ec2c1c9370d6e", "patch": "@@ -1,8 +1,8 @@\n <pre class=\"rust item-decl\"><code>\n-    {{ self.render_attributes_in_pre() | safe }}\n+    {{ self::item_template_render_attributes_in_pre(self.borrow()) | safe }}\n     {{ self.render_union() | safe }}\n </code></pre>\n-{{ self.document() | safe }}\n+{{ self::item_template_document(self.borrow()) | safe }}\n {% if self.fields_iter().peek().is_some() %}\n     <h2 id=\"fields\" class=\"fields small-section-header\">\n         Fields<a href=\"#fields\" class=\"anchor\">\u00a7</a>\n@@ -19,5 +19,5 @@ <h2 id=\"fields\" class=\"fields small-section-header\">\n         {{ self.document_field(field) | safe }}\n     {% endfor %}\n {% endif %}\n-{{ self.render_assoc_items() | safe }}\n-{{ self.document_type_layout() | safe }}\n+{{ self::item_template_render_assoc_items(self.borrow()) | safe }}\n+{{ self::item_template_document_type_layout(self.borrow()) | safe }}"}]}