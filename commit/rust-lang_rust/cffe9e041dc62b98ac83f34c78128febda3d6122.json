{"sha": "cffe9e041dc62b98ac83f34c78128febda3d6122", "node_id": "MDY6Q29tbWl0NzI0NzEyOmNmZmU5ZTA0MWRjNjJiOThhYzgzZjM0Yzc4MTI4ZmViZGEzZDYxMjI=", "commit": {"author": {"name": "klutzy", "email": "klutzytheklutzy@gmail.com", "date": "2014-03-22T14:13:40Z"}, "committer": {"name": "klutzy", "email": "klutzytheklutzy@gmail.com", "date": "2014-03-22T14:57:13Z"}, "message": "std::os: Handle FormatMessage failure\n\n`FormatMessageW()` is called by `std::os::last_os_error()` to convert\nerrno into string, but the function may fail on non-english locale.\nI don't know why it fails, but anyway it's better to return errno\nthan to `fail!()` in the case.\n\nFixes #13075\nFixes #13073", "tree": {"sha": "5caec6608c10f6a499de3289108e689b262dd5d5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5caec6608c10f6a499de3289108e689b262dd5d5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cffe9e041dc62b98ac83f34c78128febda3d6122", "comment_count": 5, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cffe9e041dc62b98ac83f34c78128febda3d6122", "html_url": "https://github.com/rust-lang/rust/commit/cffe9e041dc62b98ac83f34c78128febda3d6122", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cffe9e041dc62b98ac83f34c78128febda3d6122/comments", "author": {"login": "klutzy", "id": 1589355, "node_id": "MDQ6VXNlcjE1ODkzNTU=", "avatar_url": "https://avatars.githubusercontent.com/u/1589355?v=4", "gravatar_id": "", "url": "https://api.github.com/users/klutzy", "html_url": "https://github.com/klutzy", "followers_url": "https://api.github.com/users/klutzy/followers", "following_url": "https://api.github.com/users/klutzy/following{/other_user}", "gists_url": "https://api.github.com/users/klutzy/gists{/gist_id}", "starred_url": "https://api.github.com/users/klutzy/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/klutzy/subscriptions", "organizations_url": "https://api.github.com/users/klutzy/orgs", "repos_url": "https://api.github.com/users/klutzy/repos", "events_url": "https://api.github.com/users/klutzy/events{/privacy}", "received_events_url": "https://api.github.com/users/klutzy/received_events", "type": "User", "site_admin": false}, "committer": {"login": "klutzy", "id": 1589355, "node_id": "MDQ6VXNlcjE1ODkzNTU=", "avatar_url": "https://avatars.githubusercontent.com/u/1589355?v=4", "gravatar_id": "", "url": "https://api.github.com/users/klutzy", "html_url": "https://github.com/klutzy", "followers_url": "https://api.github.com/users/klutzy/followers", "following_url": "https://api.github.com/users/klutzy/following{/other_user}", "gists_url": "https://api.github.com/users/klutzy/gists{/gist_id}", "starred_url": "https://api.github.com/users/klutzy/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/klutzy/subscriptions", "organizations_url": "https://api.github.com/users/klutzy/orgs", "repos_url": "https://api.github.com/users/klutzy/repos", "events_url": "https://api.github.com/users/klutzy/events{/privacy}", "received_events_url": "https://api.github.com/users/klutzy/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "30165e059c0a111a53020108686b6fd11fcc1d03", "url": "https://api.github.com/repos/rust-lang/rust/commits/30165e059c0a111a53020108686b6fd11fcc1d03", "html_url": "https://github.com/rust-lang/rust/commit/30165e059c0a111a53020108686b6fd11fcc1d03"}], "stats": {"total": 11, "additions": 8, "deletions": 3}, "files": [{"sha": "f270c7e7a743c13f137e98df8aadc5bfff12c45a", "filename": "src/libstd/os.rs", "status": "modified", "additions": 8, "deletions": 3, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/cffe9e041dc62b98ac83f34c78128febda3d6122/src%2Flibstd%2Fos.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cffe9e041dc62b98ac83f34c78128febda3d6122/src%2Flibstd%2Fos.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fos.rs?ref=cffe9e041dc62b98ac83f34c78128febda3d6122", "patch": "@@ -740,11 +740,16 @@ pub fn last_os_error() -> ~str {\n                                      buf.len() as DWORD,\n                                      ptr::null());\n             if res == 0 {\n-                fail!(\"[{}] FormatMessage failure\", errno());\n+                // Sometimes FormatMessageW can fail e.g. system doesn't like langId,\n+                let fm_err = errno();\n+                return format!(\"OS Error {} (FormatMessageW() returned error {})\", err, fm_err);\n             }\n \n-            str::from_utf16(str::truncate_utf16_at_nul(buf))\n-                .expect(\"FormatMessageW returned invalid UTF-16\")\n+            let msg = str::from_utf16(str::truncate_utf16_at_nul(buf));\n+            match msg {\n+                Some(msg) => format!(\"OS Error {}: {}\", err, msg),\n+                None => format!(\"OS Error {} (FormatMessageW() returned invalid UTF-16)\", err),\n+            }\n         }\n     }\n "}]}