{"sha": "c8a8a23a31e9e4831ccab4efbc085852b7a86fa5", "node_id": "MDY6Q29tbWl0NzI0NzEyOmM4YThhMjNhMzFlOWU0ODMxY2NhYjRlZmJjMDg1ODUyYjdhODZmYTU=", "commit": {"author": {"name": "Yuki Okushi", "email": "yuki.okushi@huawei.com", "date": "2021-06-16T00:44:47Z"}, "committer": {"name": "Yuki Okushi", "email": "yuki.okushi@huawei.com", "date": "2021-06-16T00:47:37Z"}, "message": "Do not emit invalid suggestions on multiple mutable borrow errors", "tree": {"sha": "074d75d29709da564dcde36f8981b9505897a9a7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/074d75d29709da564dcde36f8981b9505897a9a7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c8a8a23a31e9e4831ccab4efbc085852b7a86fa5", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEx6scKn6IIf/+FpBu2rpbBylhwYoFAmDJSjEACgkQ2rpbBylh\nwYq+lw//QR5abNT+XjOT8+dP+sV8LxsKj+enQhhXbgBcoAhrmAdH0khQMPoiZmXw\nqXOkSiT8z42i5MNtSFsCRryaj+Kurm3+UcbnbBv+vOUTI5g9zB6wNSQ8SM5B79Zg\nKFKFrAkuZHkGkpPLSRnHdGGn4VDW2yHA05jd6evdRiUWp2logca151hZbBWhOuKY\nR3H1XzfVZyfmYV165VF8JOZbe1KEYKykZ210zeJv9Bwchs0G0SydvasLz9+p3FvD\nVoRtIXLX9040IBH7ukNnhRCvss6VMqgui/4bzRf1rUvoSav5FZbvVFSjU+oBa0Zk\nAxe35oOUkGXoVfqDFLrQKy0df54QkPr2HWZzVkjm4hF9UiHBehwoc/Pu5v3BkgEl\nkx8vHiDTZtnvWaN1lzPeX8a9BT5VtAi9B8EH3DddbtFzbAUCIOtiEPvD2zbBQyQa\nMWqTxAkbw6WHQ5HU0RZreMDbsTgLZikS7TBUK+INvrcvIJjUs3M2HLDnYkJUBysl\nFGmgG6jnkRN+7TzIpi9BxSFGBCtDkTrEgR90jUP2UXHFy20Lcogp2aldpwrKCVxd\n2S1IHtt7V5//q98Fwc1UAL+nd9G3OCnLJwDNoC6zuVcqN/U+eyledZZikWXGUAwW\n6msmwezDAwDcAToay5hkofbWCIK1olW/mtyOKGKNSKZ+vqUxb2s=\n=FtF3\n-----END PGP SIGNATURE-----", "payload": "tree 074d75d29709da564dcde36f8981b9505897a9a7\nparent 607d6b00d4e0e0475b8de9d0c870b7126fdcdf6b\nauthor Yuki Okushi <yuki.okushi@huawei.com> 1623804287 +0900\ncommitter Yuki Okushi <yuki.okushi@huawei.com> 1623804457 +0900\n\nDo not emit invalid suggestions on multiple mutable borrow errors\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c8a8a23a31e9e4831ccab4efbc085852b7a86fa5", "html_url": "https://github.com/rust-lang/rust/commit/c8a8a23a31e9e4831ccab4efbc085852b7a86fa5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c8a8a23a31e9e4831ccab4efbc085852b7a86fa5/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "607d6b00d4e0e0475b8de9d0c870b7126fdcdf6b", "url": "https://api.github.com/repos/rust-lang/rust/commits/607d6b00d4e0e0475b8de9d0c870b7126fdcdf6b", "html_url": "https://github.com/rust-lang/rust/commit/607d6b00d4e0e0475b8de9d0c870b7126fdcdf6b"}], "stats": {"total": 66, "additions": 58, "deletions": 8}, "files": [{"sha": "a0c9b43d5afee1e1862084dcd20544888e9d6acb", "filename": "compiler/rustc_mir/src/borrow_check/diagnostics/conflict_errors.rs", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/c8a8a23a31e9e4831ccab4efbc085852b7a86fa5/compiler%2Frustc_mir%2Fsrc%2Fborrow_check%2Fdiagnostics%2Fconflict_errors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c8a8a23a31e9e4831ccab4efbc085852b7a86fa5/compiler%2Frustc_mir%2Fsrc%2Fborrow_check%2Fdiagnostics%2Fconflict_errors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Fborrow_check%2Fdiagnostics%2Fconflict_errors.rs?ref=c8a8a23a31e9e4831ccab4efbc085852b7a86fa5", "patch": "@@ -453,6 +453,7 @@ impl<'cx, 'tcx> MirBorrowckCtxt<'cx, 'tcx> {\n                 &mut err,\n                 \"\",\n                 Some(borrow_span),\n+                None,\n             );\n         err.buffer(&mut self.errors_buffer);\n     }\n@@ -498,6 +499,7 @@ impl<'cx, 'tcx> MirBorrowckCtxt<'cx, 'tcx> {\n                 &mut err,\n                 \"\",\n                 None,\n+                None,\n             );\n         err\n     }\n@@ -718,6 +720,7 @@ impl<'cx, 'tcx> MirBorrowckCtxt<'cx, 'tcx> {\n             &mut err,\n             first_borrow_desc,\n             None,\n+            Some((issued_span, span)),\n         );\n \n         err\n@@ -1076,6 +1079,7 @@ impl<'cx, 'tcx> MirBorrowckCtxt<'cx, 'tcx> {\n                     &mut err,\n                     \"\",\n                     None,\n+                    None,\n                 );\n             }\n         } else {\n@@ -1093,6 +1097,7 @@ impl<'cx, 'tcx> MirBorrowckCtxt<'cx, 'tcx> {\n                 &mut err,\n                 \"\",\n                 None,\n+                None,\n             );\n         }\n \n@@ -1158,6 +1163,7 @@ impl<'cx, 'tcx> MirBorrowckCtxt<'cx, 'tcx> {\n             &mut err,\n             \"\",\n             None,\n+            None,\n         );\n \n         err.buffer(&mut self.errors_buffer);\n@@ -1236,6 +1242,7 @@ impl<'cx, 'tcx> MirBorrowckCtxt<'cx, 'tcx> {\n             &mut err,\n             \"\",\n             None,\n+            None,\n         );\n \n         let within = if borrow_spans.for_generator() { \" by generator\" } else { \"\" };\n@@ -1614,6 +1621,7 @@ impl<'cx, 'tcx> MirBorrowckCtxt<'cx, 'tcx> {\n             &mut err,\n             \"\",\n             None,\n+            None,\n         );\n \n         self.explain_deref_coercion(loan, &mut err);"}, {"sha": "76de010d1393bbaa02ea48d9389e96c6d3875c59", "filename": "compiler/rustc_mir/src/borrow_check/diagnostics/explain_borrow.rs", "status": "modified", "additions": 18, "deletions": 8, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/c8a8a23a31e9e4831ccab4efbc085852b7a86fa5/compiler%2Frustc_mir%2Fsrc%2Fborrow_check%2Fdiagnostics%2Fexplain_borrow.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c8a8a23a31e9e4831ccab4efbc085852b7a86fa5/compiler%2Frustc_mir%2Fsrc%2Fborrow_check%2Fdiagnostics%2Fexplain_borrow.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Fborrow_check%2Fdiagnostics%2Fexplain_borrow.rs?ref=c8a8a23a31e9e4831ccab4efbc085852b7a86fa5", "patch": "@@ -66,6 +66,7 @@ impl BorrowExplanation {\n         err: &mut DiagnosticBuilder<'_>,\n         borrow_desc: &str,\n         borrow_span: Option<Span>,\n+        multiple_borrow_span: Option<(Span, Span)>,\n     ) {\n         match *self {\n             BorrowExplanation::UsedLater(later_use_kind, var_or_use_span, path_span) => {\n@@ -192,14 +193,23 @@ impl BorrowExplanation {\n \n                         if let Some(info) = &local_decl.is_block_tail {\n                             if info.tail_result_is_ignored {\n-                                err.span_suggestion_verbose(\n-                                    info.span.shrink_to_hi(),\n-                                    \"consider adding semicolon after the expression so its \\\n-                                     temporaries are dropped sooner, before the local variables \\\n-                                     declared by the block are dropped\",\n-                                    \";\".to_string(),\n-                                    Applicability::MaybeIncorrect,\n-                                );\n+                                // #85581: If the first mutable borrow's scope contains\n+                                // the second borrow, this suggestion isn't helpful.\n+                                if !multiple_borrow_span\n+                                    .map(|(old, new)| {\n+                                        old.to(info.span.shrink_to_hi()).contains(new)\n+                                    })\n+                                    .unwrap_or(false)\n+                                {\n+                                    err.span_suggestion_verbose(\n+                                        info.span.shrink_to_hi(),\n+                                        \"consider adding semicolon after the expression so its \\\n+                                        temporaries are dropped sooner, before the local variables \\\n+                                        declared by the block are dropped\",\n+                                        \";\".to_string(),\n+                                        Applicability::MaybeIncorrect,\n+                                    );\n+                                }\n                             } else {\n                                 err.note(\n                                     \"the temporary is part of an expression at the end of a \\"}, {"sha": "ccc120c5421f536a1a85e5af638d7119ed08a7c8", "filename": "src/test/ui/borrowck/issue-85581.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/c8a8a23a31e9e4831ccab4efbc085852b7a86fa5/src%2Ftest%2Fui%2Fborrowck%2Fissue-85581.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c8a8a23a31e9e4831ccab4efbc085852b7a86fa5/src%2Ftest%2Fui%2Fborrowck%2Fissue-85581.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fborrowck%2Fissue-85581.rs?ref=c8a8a23a31e9e4831ccab4efbc085852b7a86fa5", "patch": "@@ -0,0 +1,15 @@\n+// Regression test of #85581.\n+// Checks not to suggest to add `;` when the second mutable borrow\n+// is in the first's scope.\n+\n+use std::collections::BinaryHeap;\n+\n+fn foo(heap: &mut BinaryHeap<i32>) {\n+    match heap.peek_mut() {\n+        Some(_) => { heap.pop(); },\n+        //~^ ERROR: cannot borrow `*heap` as mutable more than once at a time\n+        None => (),\n+    }\n+}\n+\n+fn main() {}"}, {"sha": "29c0429f2a046bf7b69d0bf2752f4f633b256b61", "filename": "src/test/ui/borrowck/issue-85581.stderr", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/c8a8a23a31e9e4831ccab4efbc085852b7a86fa5/src%2Ftest%2Fui%2Fborrowck%2Fissue-85581.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c8a8a23a31e9e4831ccab4efbc085852b7a86fa5/src%2Ftest%2Fui%2Fborrowck%2Fissue-85581.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fborrowck%2Fissue-85581.stderr?ref=c8a8a23a31e9e4831ccab4efbc085852b7a86fa5", "patch": "@@ -0,0 +1,17 @@\n+error[E0499]: cannot borrow `*heap` as mutable more than once at a time\n+  --> $DIR/issue-85581.rs:9:22\n+   |\n+LL |     match heap.peek_mut() {\n+   |           ---------------\n+   |           |\n+   |           first mutable borrow occurs here\n+   |           a temporary with access to the first borrow is created here ...\n+LL |         Some(_) => { heap.pop(); },\n+   |                      ^^^^ second mutable borrow occurs here\n+...\n+LL | }\n+   | - ... and the first borrow might be used here, when that temporary is dropped and runs the destructor for type `Option<PeekMut<'_, i32>>`\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0499`."}]}