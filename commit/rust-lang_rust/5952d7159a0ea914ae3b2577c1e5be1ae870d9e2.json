{"sha": "5952d7159a0ea914ae3b2577c1e5be1ae870d9e2", "node_id": "C_kwDOAAsO6NoAKDU5NTJkNzE1OWEwZWE5MTRhZTNiMjU3N2MxZTViZTFhZTg3MGQ5ZTI", "commit": {"author": {"name": "Jakob Degen", "email": "jakob@degen.com", "date": "2022-01-29T02:24:54Z"}, "committer": {"name": "Jakob Degen", "email": "jakob.e.degen@gmail.com", "date": "2022-02-24T17:23:35Z"}, "message": "Restrict query recursion in `needs_significant_drop`\n\nOverly aggressive use of the query system to improve caching lead to query cycles and consequently\nICEs. This patch fixes this by restricting the use of the query system as a cache to those cases\nwhere it is definitely correct.", "tree": {"sha": "b89af6c328fa33655cb4fe92e28e1ed18ccdc20d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b89af6c328fa33655cb4fe92e28e1ed18ccdc20d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5952d7159a0ea914ae3b2577c1e5be1ae870d9e2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5952d7159a0ea914ae3b2577c1e5be1ae870d9e2", "html_url": "https://github.com/rust-lang/rust/commit/5952d7159a0ea914ae3b2577c1e5be1ae870d9e2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5952d7159a0ea914ae3b2577c1e5be1ae870d9e2/comments", "author": {"login": "JakobDegen", "id": 51179609, "node_id": "MDQ6VXNlcjUxMTc5NjA5", "avatar_url": "https://avatars.githubusercontent.com/u/51179609?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JakobDegen", "html_url": "https://github.com/JakobDegen", "followers_url": "https://api.github.com/users/JakobDegen/followers", "following_url": "https://api.github.com/users/JakobDegen/following{/other_user}", "gists_url": "https://api.github.com/users/JakobDegen/gists{/gist_id}", "starred_url": "https://api.github.com/users/JakobDegen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JakobDegen/subscriptions", "organizations_url": "https://api.github.com/users/JakobDegen/orgs", "repos_url": "https://api.github.com/users/JakobDegen/repos", "events_url": "https://api.github.com/users/JakobDegen/events{/privacy}", "received_events_url": "https://api.github.com/users/JakobDegen/received_events", "type": "User", "site_admin": false}, "committer": {"login": "JakobDegen", "id": 51179609, "node_id": "MDQ6VXNlcjUxMTc5NjA5", "avatar_url": "https://avatars.githubusercontent.com/u/51179609?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JakobDegen", "html_url": "https://github.com/JakobDegen", "followers_url": "https://api.github.com/users/JakobDegen/followers", "following_url": "https://api.github.com/users/JakobDegen/following{/other_user}", "gists_url": "https://api.github.com/users/JakobDegen/gists{/gist_id}", "starred_url": "https://api.github.com/users/JakobDegen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JakobDegen/subscriptions", "organizations_url": "https://api.github.com/users/JakobDegen/orgs", "repos_url": "https://api.github.com/users/JakobDegen/repos", "events_url": "https://api.github.com/users/JakobDegen/events{/privacy}", "received_events_url": "https://api.github.com/users/JakobDegen/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9ecd75b831f744b9bdfb5ec4d435fa20c65e074e", "url": "https://api.github.com/repos/rust-lang/rust/commits/9ecd75b831f744b9bdfb5ec4d435fa20c65e074e", "html_url": "https://github.com/rust-lang/rust/commit/9ecd75b831f744b9bdfb5ec4d435fa20c65e074e"}], "stats": {"total": 50, "additions": 31, "deletions": 19}, "files": [{"sha": "322511be817fb08e6642aa7bceb5375edfc43667", "filename": "compiler/rustc_ty_utils/src/needs_drop.rs", "status": "modified", "additions": 17, "deletions": 19, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/5952d7159a0ea914ae3b2577c1e5be1ae870d9e2/compiler%2Frustc_ty_utils%2Fsrc%2Fneeds_drop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5952d7159a0ea914ae3b2577c1e5be1ae870d9e2/compiler%2Frustc_ty_utils%2Fsrc%2Fneeds_drop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ty_utils%2Fsrc%2Fneeds_drop.rs?ref=5952d7159a0ea914ae3b2577c1e5be1ae870d9e2", "patch": "@@ -199,16 +199,11 @@ fn drop_tys_helper<'tcx>(\n     fn with_query_cache<'tcx>(\n         tcx: TyCtxt<'tcx>,\n         iter: impl IntoIterator<Item = Ty<'tcx>>,\n-        only_significant: bool,\n     ) -> NeedsDropResult<Vec<Ty<'tcx>>> {\n         iter.into_iter().try_fold(Vec::new(), |mut vec, subty| {\n             match subty.kind() {\n                 ty::Adt(adt_id, subst) => {\n-                    for subty in if only_significant {\n-                        tcx.adt_significant_drop_tys(adt_id.did)?\n-                    } else {\n-                        tcx.adt_drop_tys(adt_id.did)?\n-                    } {\n+                    for subty in tcx.adt_drop_tys(adt_id.did)? {\n                         vec.push(subty.subst(tcx, subst));\n                     }\n                 }\n@@ -234,25 +229,28 @@ fn drop_tys_helper<'tcx>(\n                     // Since the destructor is insignificant, we just want to make sure all of\n                     // the passed in type parameters are also insignificant.\n                     // Eg: Vec<T> dtor is insignificant when T=i32 but significant when T=Mutex.\n-                    with_query_cache(tcx, substs.types(), only_significant)\n+                    Ok(substs.types().collect())\n                 }\n             }\n         } else if adt_def.is_union() {\n             debug!(\"drop_tys_helper: `{:?}` is a union\", adt_def);\n             Ok(Vec::new())\n         } else {\n-            with_query_cache(\n-                tcx,\n-                adt_def.all_fields().map(|field| {\n-                    let r = tcx.type_of(field.did).subst(tcx, substs);\n-                    debug!(\n-                        \"drop_tys_helper: Subst into {:?} with {:?} gettng {:?}\",\n-                        field, substs, r\n-                    );\n-                    r\n-                }),\n-                only_significant,\n-            )\n+            let field_tys = adt_def.all_fields().map(|field| {\n+                let r = tcx.type_of(field.did).subst(tcx, substs);\n+                debug!(\"drop_tys_helper: Subst into {:?} with {:?} gettng {:?}\", field, substs, r);\n+                r\n+            });\n+            if only_significant {\n+                // We can't recurse through the query system here because we might induce a cycle\n+                Ok(field_tys.collect())\n+            } else {\n+                // We can use the query system if we consider all drops significant. In that case,\n+                // ADTs are `needs_drop` exactly if they `impl Drop` or if any of their \"transitive\"\n+                // fields do. There can be no cycles here, because ADTs cannot contain themselves as\n+                // fields.\n+                with_query_cache(tcx, field_tys)\n+            }\n         }\n         .map(|v| v.into_iter())\n     };"}, {"sha": "a3b17755faccc872ee0403441aeb8ae46579775c", "filename": "src/test/ui/closures/2229_closure_analysis/issue-92724-needsdrop-query-cycle.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/5952d7159a0ea914ae3b2577c1e5be1ae870d9e2/src%2Ftest%2Fui%2Fclosures%2F2229_closure_analysis%2Fissue-92724-needsdrop-query-cycle.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5952d7159a0ea914ae3b2577c1e5be1ae870d9e2/src%2Ftest%2Fui%2Fclosures%2F2229_closure_analysis%2Fissue-92724-needsdrop-query-cycle.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fclosures%2F2229_closure_analysis%2Fissue-92724-needsdrop-query-cycle.rs?ref=5952d7159a0ea914ae3b2577c1e5be1ae870d9e2", "patch": "@@ -0,0 +1,14 @@\n+// ICEs if checking if there is a significant destructor causes a query cycle\n+// check-pass\n+\n+#![warn(rust_2021_incompatible_closure_captures)]\n+pub struct Foo(Bar);\n+pub struct Bar(Baz);\n+pub struct Baz(Vec<Foo>);\n+\n+impl Foo {\n+    pub fn baz(self, v: Baz) -> Baz {\n+        (|| v)()\n+    }\n+}\n+fn main() {}"}]}