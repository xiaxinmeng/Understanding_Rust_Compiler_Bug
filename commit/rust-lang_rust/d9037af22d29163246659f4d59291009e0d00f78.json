{"sha": "d9037af22d29163246659f4d59291009e0d00f78", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ5MDM3YWYyMmQyOTE2MzI0NjY1OWY0ZDU5MjkxMDA5ZTBkMDBmNzg=", "commit": {"author": {"name": "Graydon Hoare", "email": "graydon@mozilla.com", "date": "2010-07-02T16:45:24Z"}, "committer": {"name": "Graydon Hoare", "email": "graydon@mozilla.com", "date": "2010-07-02T16:45:24Z"}, "message": "Improve drop-path logging and simplify box_rc_cell.", "tree": {"sha": "7123cd3cb7205f53295179da43edb1b55d330bc7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7123cd3cb7205f53295179da43edb1b55d330bc7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d9037af22d29163246659f4d59291009e0d00f78", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d9037af22d29163246659f4d59291009e0d00f78", "html_url": "https://github.com/rust-lang/rust/commit/d9037af22d29163246659f4d59291009e0d00f78", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d9037af22d29163246659f4d59291009e0d00f78/comments", "author": {"login": "graydon", "id": 14097, "node_id": "MDQ6VXNlcjE0MDk3", "avatar_url": "https://avatars.githubusercontent.com/u/14097?v=4", "gravatar_id": "", "url": "https://api.github.com/users/graydon", "html_url": "https://github.com/graydon", "followers_url": "https://api.github.com/users/graydon/followers", "following_url": "https://api.github.com/users/graydon/following{/other_user}", "gists_url": "https://api.github.com/users/graydon/gists{/gist_id}", "starred_url": "https://api.github.com/users/graydon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/graydon/subscriptions", "organizations_url": "https://api.github.com/users/graydon/orgs", "repos_url": "https://api.github.com/users/graydon/repos", "events_url": "https://api.github.com/users/graydon/events{/privacy}", "received_events_url": "https://api.github.com/users/graydon/received_events", "type": "User", "site_admin": false}, "committer": {"login": "graydon", "id": 14097, "node_id": "MDQ6VXNlcjE0MDk3", "avatar_url": "https://avatars.githubusercontent.com/u/14097?v=4", "gravatar_id": "", "url": "https://api.github.com/users/graydon", "html_url": "https://github.com/graydon", "followers_url": "https://api.github.com/users/graydon/followers", "following_url": "https://api.github.com/users/graydon/following{/other_user}", "gists_url": "https://api.github.com/users/graydon/gists{/gist_id}", "starred_url": "https://api.github.com/users/graydon/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/graydon/subscriptions", "organizations_url": "https://api.github.com/users/graydon/orgs", "repos_url": "https://api.github.com/users/graydon/repos", "events_url": "https://api.github.com/users/graydon/events{/privacy}", "received_events_url": "https://api.github.com/users/graydon/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b2692ef2ecf4b8d9783dfa0af12b8816184f0da5", "url": "https://api.github.com/repos/rust-lang/rust/commits/b2692ef2ecf4b8d9783dfa0af12b8816184f0da5", "html_url": "https://github.com/rust-lang/rust/commit/b2692ef2ecf4b8d9783dfa0af12b8816184f0da5"}], "stats": {"total": 19, "additions": 14, "deletions": 5}, "files": [{"sha": "742f237acd730b20e49d2dd256ebfd0c4cb14a08", "filename": "src/boot/me/trans.ml", "status": "modified", "additions": 14, "deletions": 5, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/d9037af22d29163246659f4d59291009e0d00f78/src%2Fboot%2Fme%2Ftrans.ml", "raw_url": "https://github.com/rust-lang/rust/raw/d9037af22d29163246659f4d59291009e0d00f78/src%2Fboot%2Fme%2Ftrans.ml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fboot%2Fme%2Ftrans.ml?ref=d9037af22d29163246659f4d59291009e0d00f78", "patch": "@@ -2249,9 +2249,7 @@ let trans_visitor\n              (tydesc_rty abi))\n \n   and box_rc_cell (cell:Il.cell) : Il.cell =\n-    let off = Abi.box_rc_slot_field_refcnt in\n-    let (mem, _) = need_mem_cell (deref_imm cell (word_n off)) in\n-      word_at mem\n+    get_element_ptr (deref cell) Abi.box_rc_slot_field_refcnt\n \n   and box_allocation_size\n       (ty:Ast.ty)\n@@ -2499,6 +2497,8 @@ let trans_visitor\n             | MEM_rc_opaque\n             | MEM_rc_struct ->\n \n+                note_drop_step ty \"in box-drop path of drop_ty\";\n+\n                 let _ = check_box_rty cell in\n                 let null_jmp = null_check cell in\n                 let rc = box_rc_cell cell in\n@@ -2524,6 +2524,7 @@ let trans_visitor\n                   patch null_jmp\n \n             | MEM_interior when type_is_structured ty ->\n+                note_drop_step ty \"in structured-interior path of drop_ty\";\n                 (iflog (fun _ ->\n                           annotate (\"drop interior memory \" ^\n                                       (Fmt.fmt_to_str Ast.fmt_ty ty))));\n@@ -2535,6 +2536,7 @@ let trans_visitor\n                     ty_params vr\n \n             | MEM_interior ->\n+                note_drop_step ty \"in simple-interior path of drop_ty\";\n                 (* Interior allocation of all-interior value not caught above:\n                  * nothing to do.\n                  *)\n@@ -2729,8 +2731,15 @@ let trans_visitor\n     if cx.ctxt_sess.Session.sess_trace_drop ||\n       cx.ctxt_sess.Session.sess_log_trans\n     then\n-      let slotstr = Fmt.fmt_to_str Ast.fmt_ty ty in\n-      let str = step ^ \" \" ^ slotstr in\n+      let mctrl_str =\n+        match ty_mem_ctrl ty with\n+            MEM_gc -> \"MEM_gc\"\n+          | MEM_rc_struct -> \"MEM_rc_struct\"\n+          | MEM_rc_opaque -> \"MEM_rc_opaque\"\n+          | MEM_interior -> \"MEM_interior\"\n+      in\n+      let tystr = Fmt.fmt_to_str Ast.fmt_ty ty in\n+      let str = step ^ \" \" ^ mctrl_str ^ \" \" ^ tystr in\n         begin\n           annotate str;\n           trace_str cx.ctxt_sess.Session.sess_trace_drop str"}]}