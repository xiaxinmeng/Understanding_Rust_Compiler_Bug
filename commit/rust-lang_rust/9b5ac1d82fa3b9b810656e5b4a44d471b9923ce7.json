{"sha": "9b5ac1d82fa3b9b810656e5b4a44d471b9923ce7", "node_id": "MDY6Q29tbWl0NzI0NzEyOjliNWFjMWQ4MmZhM2I5YjgxMDY1NmU1YjRhNDRkNDcxYjk5MjNjZTc=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-07-17T11:01:52Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-07-17T11:01:52Z"}, "message": "Merge #5417\n\n5417: Mismatched arg count works for lambdas r=jonas-schievink a=matklad\n\n\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>", "tree": {"sha": "ed3930e18000f7ee5ebd7a3b81de2098fc595f7f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ed3930e18000f7ee5ebd7a3b81de2098fc595f7f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/9b5ac1d82fa3b9b810656e5b4a44d471b9923ce7", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJfEYUgCRBK7hj4Ov3rIwAAdHIIAEJQPFeLK48f6ZxGE6jnAMMF\nlzvvpNMKYggDD8t82ZJFeOsIMJ4a/QpvrsiAsYHYhKmH5qPlWIVHfz6cAXxal7K4\nH3XjMKNTDShNZqHMv+7T+0fZ722B7lnB7u+mMTlN0/3OT5A/yQp67EZ+2ZkSaje2\nKdupcJft5E5LkClLBvCX6euGM9UZ7pYomib9WXCpiih/82DLhtQurho7YPl5uwS3\n8RTfYmFfklxz/hmRH+8NW7wXCWJP7hTfWFFos0GwmHPc6IM4YK9FbuOpSS/Kzp1w\nWW6g4wlqIbz3bPiXIMG3SWnWw4B2aZ69DZImLWAH8owGOXba3JbSA0fv2wQ53t8=\n=U8Bv\n-----END PGP SIGNATURE-----\n", "payload": "tree ed3930e18000f7ee5ebd7a3b81de2098fc595f7f\nparent 6ae6c1460e1e0524664af39fd0dbe3b1af3fac50\nparent 393b7119bd5341bffb166e0dadcff9124e28b888\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1594983712 +0000\ncommitter GitHub <noreply@github.com> 1594983712 +0000\n\nMerge #5417\n\n5417: Mismatched arg count works for lambdas r=jonas-schievink a=matklad\n\n\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/9b5ac1d82fa3b9b810656e5b4a44d471b9923ce7", "html_url": "https://github.com/rust-lang/rust/commit/9b5ac1d82fa3b9b810656e5b4a44d471b9923ce7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/9b5ac1d82fa3b9b810656e5b4a44d471b9923ce7/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6ae6c1460e1e0524664af39fd0dbe3b1af3fac50", "url": "https://api.github.com/repos/rust-lang/rust/commits/6ae6c1460e1e0524664af39fd0dbe3b1af3fac50", "html_url": "https://github.com/rust-lang/rust/commit/6ae6c1460e1e0524664af39fd0dbe3b1af3fac50"}, {"sha": "393b7119bd5341bffb166e0dadcff9124e28b888", "url": "https://api.github.com/repos/rust-lang/rust/commits/393b7119bd5341bffb166e0dadcff9124e28b888", "html_url": "https://github.com/rust-lang/rust/commit/393b7119bd5341bffb166e0dadcff9124e28b888"}], "stats": {"total": 121, "additions": 86, "deletions": 35}, "files": [{"sha": "859bdfb3bc1c039d2b3bfa688b2634aef016e250", "filename": "crates/ra_hir/src/code_model.rs", "status": "modified", "additions": 19, "deletions": 14, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/9b5ac1d82fa3b9b810656e5b4a44d471b9923ce7/crates%2Fra_hir%2Fsrc%2Fcode_model.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b5ac1d82fa3b9b810656e5b4a44d471b9923ce7/crates%2Fra_hir%2Fsrc%2Fcode_model.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir%2Fsrc%2Fcode_model.rs?ref=9b5ac1d82fa3b9b810656e5b4a44d471b9923ce7", "patch": "@@ -1233,9 +1233,13 @@ impl Type {\n     }\n \n     pub fn as_callable(&self, db: &dyn HirDatabase) -> Option<Callable> {\n-        let (id, substs) = self.ty.value.as_callable()?;\n-        let sig = db.callable_item_signature(id).subst(substs);\n-        Some(Callable { ty: self.clone(), sig, id, is_bound_method: false })\n+        let def = match self.ty.value {\n+            Ty::Apply(ApplicationTy { ctor: TypeCtor::FnDef(def), parameters: _ }) => Some(def),\n+            _ => None,\n+        };\n+\n+        let sig = self.ty.value.callable_sig(db)?;\n+        Some(Callable { ty: self.clone(), sig, def, is_bound_method: false })\n     }\n \n     pub fn is_closure(&self) -> bool {\n@@ -1525,27 +1529,29 @@ impl HirDisplay for Type {\n pub struct Callable {\n     ty: Type,\n     sig: FnSig,\n-    id: CallableDefId,\n+    def: Option<CallableDefId>,\n     pub(crate) is_bound_method: bool,\n }\n \n pub enum CallableKind {\n     Function(Function),\n     TupleStruct(Struct),\n     TupleEnumVariant(EnumVariant),\n+    Closure,\n }\n \n impl Callable {\n     pub fn kind(&self) -> CallableKind {\n-        match self.id {\n-            CallableDefId::FunctionId(it) => CallableKind::Function(it.into()),\n-            CallableDefId::StructId(it) => CallableKind::TupleStruct(it.into()),\n-            CallableDefId::EnumVariantId(it) => CallableKind::TupleEnumVariant(it.into()),\n+        match self.def {\n+            Some(CallableDefId::FunctionId(it)) => CallableKind::Function(it.into()),\n+            Some(CallableDefId::StructId(it)) => CallableKind::TupleStruct(it.into()),\n+            Some(CallableDefId::EnumVariantId(it)) => CallableKind::TupleEnumVariant(it.into()),\n+            None => CallableKind::Closure,\n         }\n     }\n     pub fn receiver_param(&self, db: &dyn HirDatabase) -> Option<ast::SelfParam> {\n-        let func = match self.id {\n-            CallableDefId::FunctionId(it) if self.is_bound_method => it,\n+        let func = match self.def {\n+            Some(CallableDefId::FunctionId(it)) if self.is_bound_method => it,\n             _ => return None,\n         };\n         let src = func.lookup(db.upcast()).source(db.upcast());\n@@ -1565,8 +1571,8 @@ impl Callable {\n             .iter()\n             .skip(if self.is_bound_method { 1 } else { 0 })\n             .map(|ty| self.ty.derived(ty.clone()));\n-        let patterns = match self.id {\n-            CallableDefId::FunctionId(func) => {\n+        let patterns = match self.def {\n+            Some(CallableDefId::FunctionId(func)) => {\n                 let src = func.lookup(db.upcast()).source(db.upcast());\n                 src.value.param_list().map(|param_list| {\n                     param_list\n@@ -1577,8 +1583,7 @@ impl Callable {\n                         .chain(param_list.params().map(|it| it.pat().map(Either::Right)))\n                 })\n             }\n-            CallableDefId::StructId(_) => None,\n-            CallableDefId::EnumVariantId(_) => None,\n+            _ => None,\n         };\n         patterns.into_iter().flatten().chain(iter::repeat(None)).zip(types).collect()\n     }"}, {"sha": "fd930eab1a58b250624389aadc6830a843630dda", "filename": "crates/ra_hir_ty/src/diagnostics/expr.rs", "status": "modified", "additions": 29, "deletions": 9, "changes": 38, "blob_url": "https://github.com/rust-lang/rust/blob/9b5ac1d82fa3b9b810656e5b4a44d471b9923ce7/crates%2Fra_hir_ty%2Fsrc%2Fdiagnostics%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b5ac1d82fa3b9b810656e5b4a44d471b9923ce7/crates%2Fra_hir_ty%2Fsrc%2Fdiagnostics%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_ty%2Fsrc%2Fdiagnostics%2Fexpr.rs?ref=9b5ac1d82fa3b9b810656e5b4a44d471b9923ce7", "patch": "@@ -158,28 +158,32 @@ impl<'a, 'b> ExprValidator<'a, 'b> {\n         }\n \n         let is_method_call = matches!(expr, Expr::MethodCall { .. });\n-        let (callee, args) = match expr {\n+        let (sig, args) = match expr {\n             Expr::Call { callee, args } => {\n                 let callee = &self.infer.type_of_expr[*callee];\n-                let (callable, _) = callee.as_callable()?;\n-\n-                (callable, args.clone())\n+                let sig = callee.callable_sig(db)?;\n+                (sig, args.clone())\n             }\n             Expr::MethodCall { receiver, args, .. } => {\n-                let callee = self.infer.method_resolution(call_id)?;\n                 let mut args = args.clone();\n                 args.insert(0, *receiver);\n-                (callee.into(), args)\n+\n+                // FIXME: note that we erase information about substs here. This\n+                // is not right, but, luckily, doesn't matter as we care only\n+                // about the number of params\n+                let callee = self.infer.method_resolution(call_id)?;\n+                let sig = db.callable_item_signature(callee.into()).value;\n+\n+                (sig, args)\n             }\n             _ => return None,\n         };\n \n-        let sig = db.callable_item_signature(callee);\n-        if sig.value.is_varargs {\n+        if sig.is_varargs {\n             return None;\n         }\n \n-        let params = sig.value.params();\n+        let params = sig.params();\n \n         let mut param_count = params.len();\n         let mut arg_count = args.len();\n@@ -542,4 +546,20 @@ fn f() {\n         \"#,\n         )\n     }\n+\n+    #[test]\n+    fn arg_count_lambda() {\n+        check_diagnostics(\n+            r#\"\n+fn main() {\n+    let f = |()| ();\n+    f();\n+  //^^^ Expected 1 argument, found 0\n+    f(());\n+    f((), ());\n+  //^^^^^^^^^ Expected 1 argument, found 2\n+}\n+\"#,\n+        )\n+    }\n }"}, {"sha": "7698cb0d4bb1b0ee3b505caa9809ac8194caa49b", "filename": "crates/ra_hir_ty/src/lib.rs", "status": "modified", "additions": 1, "deletions": 10, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/9b5ac1d82fa3b9b810656e5b4a44d471b9923ce7/crates%2Fra_hir_ty%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b5ac1d82fa3b9b810656e5b4a44d471b9923ce7/crates%2Fra_hir_ty%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_hir_ty%2Fsrc%2Flib.rs?ref=9b5ac1d82fa3b9b810656e5b4a44d471b9923ce7", "patch": "@@ -767,15 +767,6 @@ impl Ty {\n         }\n     }\n \n-    pub fn as_callable(&self) -> Option<(CallableDefId, &Substs)> {\n-        match self {\n-            Ty::Apply(ApplicationTy { ctor: TypeCtor::FnDef(callable_def), parameters }) => {\n-                Some((*callable_def, parameters))\n-            }\n-            _ => None,\n-        }\n-    }\n-\n     pub fn is_never(&self) -> bool {\n         matches!(self, Ty::Apply(ApplicationTy { ctor: TypeCtor::Never, .. }))\n     }\n@@ -807,7 +798,7 @@ impl Ty {\n         }\n     }\n \n-    fn callable_sig(&self, db: &dyn HirDatabase) -> Option<FnSig> {\n+    pub fn callable_sig(&self, db: &dyn HirDatabase) -> Option<FnSig> {\n         match self {\n             Ty::Apply(a_ty) => match a_ty.ctor {\n                 TypeCtor::FnPtr { is_varargs, .. } => {"}, {"sha": "14980afdd044aec637a1ccb9a7d06a0b544a928f", "filename": "crates/ra_ide/src/call_info.rs", "status": "modified", "additions": 34, "deletions": 1, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/9b5ac1d82fa3b9b810656e5b4a44d471b9923ce7/crates%2Fra_ide%2Fsrc%2Fcall_info.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b5ac1d82fa3b9b810656e5b4a44d471b9923ce7/crates%2Fra_ide%2Fsrc%2Fcall_info.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Fcall_info.rs?ref=9b5ac1d82fa3b9b810656e5b4a44d471b9923ce7", "patch": "@@ -70,6 +70,7 @@ pub(crate) fn call_info(db: &RootDatabase, position: FilePosition) -> Option<Cal\n                 variant.name(db)\n             );\n         }\n+        hir::CallableKind::Closure => (),\n     }\n \n     res.signature.push('(');\n@@ -93,7 +94,7 @@ pub(crate) fn call_info(db: &RootDatabase, position: FilePosition) -> Option<Cal\n     res.signature.push(')');\n \n     match callable.kind() {\n-        hir::CallableKind::Function(_) => {\n+        hir::CallableKind::Function(_) | hir::CallableKind::Closure => {\n             let ret_type = callable.return_type();\n             if !ret_type.is_unit() {\n                 format_to!(res.signature, \" -> {}\", ret_type.display(db));\n@@ -702,4 +703,36 @@ id! {\n             \"#]],\n         );\n     }\n+\n+    #[test]\n+    fn call_info_for_lambdas() {\n+        check(\n+            r#\"\n+struct S;\n+fn foo(s: S) -> i32 { 92 }\n+fn main() {\n+    (|s| foo(s))(<|>)\n+}\n+        \"#,\n+            expect![[r#\"\n+                (S) -> i32\n+                (<S>)\n+            \"#]],\n+        )\n+    }\n+\n+    #[test]\n+    fn call_info_for_fn_ptr() {\n+        check(\n+            r#\"\n+fn main(f: fn(i32, f64) -> char) {\n+    f(0, <|>)\n+}\n+        \"#,\n+            expect![[r#\"\n+                (i32, f64) -> char\n+                (i32, <f64>)\n+            \"#]],\n+        )\n+    }\n }"}, {"sha": "43a5e29b5d8036d2a4e9ac829e230ef2e36d3f7b", "filename": "crates/ra_ide/src/inlay_hints.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/9b5ac1d82fa3b9b810656e5b4a44d471b9923ce7/crates%2Fra_ide%2Fsrc%2Finlay_hints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/9b5ac1d82fa3b9b810656e5b4a44d471b9923ce7/crates%2Fra_ide%2Fsrc%2Finlay_hints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_ide%2Fsrc%2Finlay_hints.rs?ref=9b5ac1d82fa3b9b810656e5b4a44d471b9923ce7", "patch": "@@ -262,7 +262,9 @@ fn should_show_param_name_hint(\n     let param_name = param_name.trim_start_matches('_');\n     let fn_name = match callable.kind() {\n         hir::CallableKind::Function(it) => Some(it.name(sema.db).to_string()),\n-        hir::CallableKind::TupleStruct(_) | hir::CallableKind::TupleEnumVariant(_) => None,\n+        hir::CallableKind::TupleStruct(_)\n+        | hir::CallableKind::TupleEnumVariant(_)\n+        | hir::CallableKind::Closure => None,\n     };\n     if param_name.is_empty()\n         || Some(param_name) == fn_name.as_ref().map(|s| s.trim_start_matches('_'))"}]}