{"sha": "0b4ec3c4e8d943dfe81fe22fdee636a714a9f87c", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBiNGVjM2M0ZThkOTQzZGZlODFmZTIyZmRlZTYzNmE3MTRhOWY4N2M=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-02-20T17:35:37Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-02-20T17:35:37Z"}, "message": "Merge #7729\n\n7729: Try to detect musl distros in the Code extension r=andylizi a=lnicola\n\nFixes https://github.com/rust-analyzer/rust-analyzer/pull/7658#issuecomment-782701138\n\nCo-authored-by: Lauren\u021biu Nicola <lnicola@dend.ro>", "tree": {"sha": "19299c4527109ca4b34edb83047d7c2eb9205211", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/19299c4527109ca4b34edb83047d7c2eb9205211"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0b4ec3c4e8d943dfe81fe22fdee636a714a9f87c", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgMUhpCRBK7hj4Ov3rIwAAdHIIAGnxj8gF90ZPDehVDZVOJ5Z6\nVRlg2xsN+ySH6t8ORX2LHj/NK9SJ8jZZGnqL0XIKjIcq+54LYZApFNkL1GdaSZOV\nGLKEpWhfD7p98QG3sx4YwvfztCKzR15KdYi/xr46Yj1Hau8TcZDIzTF4T77ThhY7\nI+zSYvNdTsCFBICBbEOIRLgk8+besxCn97cRVyh2Dp4MGJMUvbmmBX4XVQYjSsx5\nDGWOwYWJWVv5DDvy5FF9FeMZ00Sx1WWD/Tmhb9EComkOjb05IT5T7IgQNJfIAq0J\nDh32UPFkDTv0ad/eE6LSehpOCwvAjyb94BsJABdPsggNFLlcjQ/IMxpGMC7v9Y4=\n=n/4r\n-----END PGP SIGNATURE-----\n", "payload": "tree 19299c4527109ca4b34edb83047d7c2eb9205211\nparent 364d572de80036d11ae13b3d8ebea9d0d5662a57\nparent 23a8fc528406417a25479c09b4131d61126b4413\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1613842537 +0000\ncommitter GitHub <noreply@github.com> 1613842537 +0000\n\nMerge #7729\n\n7729: Try to detect musl distros in the Code extension r=andylizi a=lnicola\n\nFixes https://github.com/rust-analyzer/rust-analyzer/pull/7658#issuecomment-782701138\n\nCo-authored-by: Lauren\u021biu Nicola <lnicola@dend.ro>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0b4ec3c4e8d943dfe81fe22fdee636a714a9f87c", "html_url": "https://github.com/rust-lang/rust/commit/0b4ec3c4e8d943dfe81fe22fdee636a714a9f87c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0b4ec3c4e8d943dfe81fe22fdee636a714a9f87c/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "364d572de80036d11ae13b3d8ebea9d0d5662a57", "url": "https://api.github.com/repos/rust-lang/rust/commits/364d572de80036d11ae13b3d8ebea9d0d5662a57", "html_url": "https://github.com/rust-lang/rust/commit/364d572de80036d11ae13b3d8ebea9d0d5662a57"}, {"sha": "23a8fc528406417a25479c09b4131d61126b4413", "url": "https://api.github.com/repos/rust-lang/rust/commits/23a8fc528406417a25479c09b4131d61126b4413", "html_url": "https://github.com/rust-lang/rust/commit/23a8fc528406417a25479c09b4131d61126b4413"}], "stats": {"total": 14, "additions": 12, "deletions": 2}, "files": [{"sha": "00393d6e8f2302efdbda452763dcec5d5385806f", "filename": "editors/code/src/main.ts", "status": "modified", "additions": 12, "deletions": 2, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/0b4ec3c4e8d943dfe81fe22fdee636a714a9f87c/editors%2Fcode%2Fsrc%2Fmain.ts", "raw_url": "https://github.com/rust-lang/rust/raw/0b4ec3c4e8d943dfe81fe22fdee636a714a9f87c/editors%2Fcode%2Fsrc%2Fmain.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fmain.ts?ref=0b4ec3c4e8d943dfe81fe22fdee636a714a9f87c", "patch": "@@ -12,7 +12,7 @@ import { PersistentState } from './persistent_state';\n import { fetchRelease, download } from './net';\n import { activateTaskProvider } from './tasks';\n import { setContextValue } from './util';\n-import { exec } from 'child_process';\n+import { exec, spawnSync } from 'child_process';\n \n let ctx: Ctx | undefined;\n \n@@ -297,7 +297,7 @@ async function getServer(config: Config, state: PersistentState): Promise<string\n         \"arm64 linux\": \"aarch64-unknown-linux-gnu\",\n         \"arm64 darwin\": \"aarch64-apple-darwin\",\n     };\n-    const platform = platforms[`${process.arch} ${process.platform}`];\n+    let platform = platforms[`${process.arch} ${process.platform}`];\n     if (platform === undefined) {\n         await vscode.window.showErrorMessage(\n             \"Unfortunately we don't ship binaries for your platform yet. \" +\n@@ -309,6 +309,9 @@ async function getServer(config: Config, state: PersistentState): Promise<string\n         );\n         return undefined;\n     }\n+    if (platform === \"x86_64-unknown-linux-gnu\" && isMusl()) {\n+        platform = \"x86_64-unknown-linux-musl\";\n+    }\n     const ext = platform.indexOf(\"-windows-\") !== -1 ? \".exe\" : \"\";\n     const dest = path.join(config.globalStoragePath, `rust-analyzer-${platform}${ext}`);\n     const exists = await fs.stat(dest).then(() => true, () => false);\n@@ -365,6 +368,13 @@ async function isNixOs(): Promise<boolean> {\n     }\n }\n \n+function isMusl(): boolean {\n+    // We can detect Alpine by checking `/etc/os-release` but not Void Linux musl.\n+    // Instead, we run `ldd` since it advertises the libc which it belongs to.\n+    const res = spawnSync(\"ldd\", [\"--version\"]);\n+    return res.stderr != null && res.stderr.indexOf(\"musl libc\") >= 0;\n+}\n+\n async function downloadWithRetryDialog<T>(state: PersistentState, downloadFunc: () => Promise<T>): Promise<T> {\n     while (true) {\n         try {"}]}