{"sha": "0e40f94a8607f42e1de28286bb401154ba621314", "node_id": "C_kwDOAAsO6NoAKDBlNDBmOTRhODYwN2Y0MmUxZGUyODI4NmJiNDAxMTU0YmE2MjEzMTQ", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-02-14T23:21:08Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-02-14T23:21:08Z"}, "message": "Auto merge of #10346 - samueltardieu:issue-10331, r=Manishearth\n\nDo not base map_entry lint suggestion on expanded code\n\nFixes #10331\n\nchangelog: [`map_entry`]: do not base suggestion on code expanded by the compiler", "tree": {"sha": "492648edd8bbfd60540e660f7dd3581cf8d5bacf", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/492648edd8bbfd60540e660f7dd3581cf8d5bacf"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0e40f94a8607f42e1de28286bb401154ba621314", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0e40f94a8607f42e1de28286bb401154ba621314", "html_url": "https://github.com/rust-lang/rust/commit/0e40f94a8607f42e1de28286bb401154ba621314", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0e40f94a8607f42e1de28286bb401154ba621314/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a182a67ceac678d067ea193b691c416409b67680", "url": "https://api.github.com/repos/rust-lang/rust/commits/a182a67ceac678d067ea193b691c416409b67680", "html_url": "https://github.com/rust-lang/rust/commit/a182a67ceac678d067ea193b691c416409b67680"}, {"sha": "e4e5924b99b30c693bc87aa95ef51fd2263b6280", "url": "https://api.github.com/repos/rust-lang/rust/commits/e4e5924b99b30c693bc87aa95ef51fd2263b6280", "html_url": "https://github.com/rust-lang/rust/commit/e4e5924b99b30c693bc87aa95ef51fd2263b6280"}], "stats": {"total": 32, "additions": 32, "deletions": 0}, "files": [{"sha": "ed9d94cdec3c5ba5546d5457114aa1a72b31a392", "filename": "clippy_lints/src/entry.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/0e40f94a8607f42e1de28286bb401154ba621314/clippy_lints%2Fsrc%2Fentry.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0e40f94a8607f42e1de28286bb401154ba621314/clippy_lints%2Fsrc%2Fentry.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fentry.rs?ref=0e40f94a8607f42e1de28286bb401154ba621314", "patch": "@@ -65,6 +65,10 @@ declare_lint_pass!(HashMapPass => [MAP_ENTRY]);\n impl<'tcx> LateLintPass<'tcx> for HashMapPass {\n     #[expect(clippy::too_many_lines)]\n     fn check_expr(&mut self, cx: &LateContext<'tcx>, expr: &'tcx Expr<'_>) {\n+        if expr.span.from_expansion() {\n+            return;\n+        }\n+\n         let Some(higher::If { cond: cond_expr, then: then_expr, r#else: else_expr }) = higher::If::hir(expr) else {\n             return\n         };"}, {"sha": "dbe09e0ff3c694778e9777fdfd499232e8aa05d8", "filename": "tests/ui/entry.fixed", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/0e40f94a8607f42e1de28286bb401154ba621314/tests%2Fui%2Fentry.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/0e40f94a8607f42e1de28286bb401154ba621314/tests%2Fui%2Fentry.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fentry.fixed?ref=0e40f94a8607f42e1de28286bb401154ba621314", "patch": "@@ -152,4 +152,18 @@ fn hash_map<K: Eq + Hash + Copy, V: Copy>(m: &mut HashMap<K, V>, m2: &mut HashMa\n     });\n }\n \n+// Issue 10331\n+// do not suggest a bad expansion because the compiler unrolls the first\n+// occurrence of the loop\n+pub fn issue_10331() {\n+    let mut m = HashMap::new();\n+    let mut i = 0;\n+    let mut x = 0;\n+    while !m.contains_key(&x) {\n+        m.insert(x, i);\n+        i += 1;\n+        x += 1;\n+    }\n+}\n+\n fn main() {}"}, {"sha": "30fed34fc5de22391ec6e2971e8ba08d6e5ad393", "filename": "tests/ui/entry.rs", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/0e40f94a8607f42e1de28286bb401154ba621314/tests%2Fui%2Fentry.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0e40f94a8607f42e1de28286bb401154ba621314/tests%2Fui%2Fentry.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fentry.rs?ref=0e40f94a8607f42e1de28286bb401154ba621314", "patch": "@@ -156,4 +156,18 @@ fn hash_map<K: Eq + Hash + Copy, V: Copy>(m: &mut HashMap<K, V>, m2: &mut HashMa\n     }\n }\n \n+// Issue 10331\n+// do not suggest a bad expansion because the compiler unrolls the first\n+// occurrence of the loop\n+pub fn issue_10331() {\n+    let mut m = HashMap::new();\n+    let mut i = 0;\n+    let mut x = 0;\n+    while !m.contains_key(&x) {\n+        m.insert(x, i);\n+        i += 1;\n+        x += 1;\n+    }\n+}\n+\n fn main() {}"}]}