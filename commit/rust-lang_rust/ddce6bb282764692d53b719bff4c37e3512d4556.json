{"sha": "ddce6bb282764692d53b719bff4c37e3512d4556", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRkY2U2YmIyODI3NjQ2OTJkNTNiNzE5YmZmNGMzN2UzNTEyZDQ1NTY=", "commit": {"author": {"name": "Daniel McNab", "email": "36049421+DJMcNab@users.noreply.github.com", "date": "2021-03-08T09:05:19Z"}, "committer": {"name": "Daniel McNab", "email": "36049421+DJMcNab@users.noreply.github.com", "date": "2021-03-08T09:05:19Z"}, "message": "Support disabling rustc build scripts", "tree": {"sha": "0bce7b0c1d7f4b3f870027493bf6e3a2c55efe91", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0bce7b0c1d7f4b3f870027493bf6e3a2c55efe91"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ddce6bb282764692d53b719bff4c37e3512d4556", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ddce6bb282764692d53b719bff4c37e3512d4556", "html_url": "https://github.com/rust-lang/rust/commit/ddce6bb282764692d53b719bff4c37e3512d4556", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ddce6bb282764692d53b719bff4c37e3512d4556/comments", "author": {"login": "DJMcNab", "id": 36049421, "node_id": "MDQ6VXNlcjM2MDQ5NDIx", "avatar_url": "https://avatars.githubusercontent.com/u/36049421?v=4", "gravatar_id": "", "url": "https://api.github.com/users/DJMcNab", "html_url": "https://github.com/DJMcNab", "followers_url": "https://api.github.com/users/DJMcNab/followers", "following_url": "https://api.github.com/users/DJMcNab/following{/other_user}", "gists_url": "https://api.github.com/users/DJMcNab/gists{/gist_id}", "starred_url": "https://api.github.com/users/DJMcNab/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/DJMcNab/subscriptions", "organizations_url": "https://api.github.com/users/DJMcNab/orgs", "repos_url": "https://api.github.com/users/DJMcNab/repos", "events_url": "https://api.github.com/users/DJMcNab/events{/privacy}", "received_events_url": "https://api.github.com/users/DJMcNab/received_events", "type": "User", "site_admin": false}, "committer": {"login": "DJMcNab", "id": 36049421, "node_id": "MDQ6VXNlcjM2MDQ5NDIx", "avatar_url": "https://avatars.githubusercontent.com/u/36049421?v=4", "gravatar_id": "", "url": "https://api.github.com/users/DJMcNab", "html_url": "https://github.com/DJMcNab", "followers_url": "https://api.github.com/users/DJMcNab/followers", "following_url": "https://api.github.com/users/DJMcNab/following{/other_user}", "gists_url": "https://api.github.com/users/DJMcNab/gists{/gist_id}", "starred_url": "https://api.github.com/users/DJMcNab/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/DJMcNab/subscriptions", "organizations_url": "https://api.github.com/users/DJMcNab/orgs", "repos_url": "https://api.github.com/users/DJMcNab/repos", "events_url": "https://api.github.com/users/DJMcNab/events{/privacy}", "received_events_url": "https://api.github.com/users/DJMcNab/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "877f745551ff74da987a61f1c8a059d30140fb8a", "url": "https://api.github.com/repos/rust-lang/rust/commits/877f745551ff74da987a61f1c8a059d30140fb8a", "html_url": "https://github.com/rust-lang/rust/commit/877f745551ff74da987a61f1c8a059d30140fb8a"}], "stats": {"total": 73, "additions": 61, "deletions": 12}, "files": [{"sha": "d754c8b55c84857e4931654bc2d6768b4d16a803", "filename": "crates/project_model/src/workspace.rs", "status": "modified", "additions": 11, "deletions": 3, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/ddce6bb282764692d53b719bff4c37e3512d4556/crates%2Fproject_model%2Fsrc%2Fworkspace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ddce6bb282764692d53b719bff4c37e3512d4556/crates%2Fproject_model%2Fsrc%2Fworkspace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproject_model%2Fsrc%2Fworkspace.rs?ref=ddce6bb282764692d53b719bff4c37e3512d4556", "patch": "@@ -56,6 +56,7 @@ impl fmt::Debug for ProjectWorkspace {\n         match self {\n             ProjectWorkspace::Cargo { cargo, sysroot, rustc, rustc_cfg } => f\n                 .debug_struct(\"Cargo\")\n+                .field(\"root\", &cargo.workspace_root())\n                 .field(\"n_packages\", &cargo.packages().len())\n                 .field(\"n_sysroot_crates\", &sysroot.crates().len())\n                 .field(\n@@ -273,12 +274,19 @@ impl ProjectWorkspace {\n         crate_graph\n     }\n \n-    pub fn collect_build_data_configs(&self, collector: &mut BuildDataCollector) {\n+    pub fn collect_build_data_configs(\n+        &self,\n+        collector: &mut BuildDataCollector,\n+        for_private: bool,\n+    ) {\n         match self {\n             ProjectWorkspace::Cargo { cargo, rustc, .. } => {\n                 collector.add_config(&cargo.workspace_root(), cargo.build_data_config().clone());\n-                if let Some(rustc) = rustc {\n-                    collector.add_config(rustc.workspace_root(), rustc.build_data_config().clone());\n+                if for_private {\n+                    if let Some(rustc) = rustc {\n+                        collector\n+                            .add_config(rustc.workspace_root(), rustc.build_data_config().clone());\n+                    }\n                 }\n             }\n             _ => {}"}, {"sha": "104f2e8a20ed34e3f583cf5d0fe64ce4d13098ac", "filename": "crates/rust-analyzer/src/cli/analysis_bench.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/ddce6bb282764692d53b719bff4c37e3512d4556/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fanalysis_bench.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ddce6bb282764692d53b719bff4c37e3512d4556/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fanalysis_bench.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fanalysis_bench.rs?ref=ddce6bb282764692d53b719bff4c37e3512d4556", "patch": "@@ -68,6 +68,9 @@ impl BenchCmd {\n         let load_cargo_config = LoadCargoConfig {\n             load_out_dirs_from_check: self.load_output_dirs,\n             with_proc_macro: self.with_proc_macro,\n+            // This will currently never have rustcSource set, however if in\n+            // future it does this will handle that case\n+            run_rustc_build_scripts: true,\n         };\n         let (mut host, vfs, _proc_macro) =\n             load_workspace_at(&self.path, &cargo_config, &load_cargo_config, &|_| {})?;"}, {"sha": "5a843296083594a61347ac756deb47b17a3cb283", "filename": "crates/rust-analyzer/src/cli/analysis_stats.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/ddce6bb282764692d53b719bff4c37e3512d4556/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fanalysis_stats.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ddce6bb282764692d53b719bff4c37e3512d4556/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fanalysis_stats.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fanalysis_stats.rs?ref=ddce6bb282764692d53b719bff4c37e3512d4556", "patch": "@@ -63,6 +63,9 @@ impl AnalysisStatsCmd {\n         let load_cargo_config = LoadCargoConfig {\n             load_out_dirs_from_check: self.load_output_dirs,\n             with_proc_macro: self.with_proc_macro,\n+            // This will currently never have rustcSource set, however if in\n+            // future it does this will handle that case\n+            run_rustc_build_scripts: true,\n         };\n         let (host, vfs, _proc_macro) =\n             load_workspace_at(&self.path, &cargo_config, &load_cargo_config, &|_| {})?;"}, {"sha": "e1966b5a797bc4b995514b99a930165f5728bd69", "filename": "crates/rust-analyzer/src/cli/diagnostics.rs", "status": "modified", "additions": 7, "deletions": 1, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ddce6bb282764692d53b719bff4c37e3512d4556/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ddce6bb282764692d53b719bff4c37e3512d4556/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fdiagnostics.rs?ref=ddce6bb282764692d53b719bff4c37e3512d4556", "patch": "@@ -34,7 +34,13 @@ pub fn diagnostics(\n     with_proc_macro: bool,\n ) -> Result<()> {\n     let cargo_config = Default::default();\n-    let load_cargo_config = LoadCargoConfig { load_out_dirs_from_check, with_proc_macro };\n+    let load_cargo_config = LoadCargoConfig {\n+        load_out_dirs_from_check,\n+        with_proc_macro,\n+        // This will currently never have rustcSource set, however if in\n+        // future it does this will handle that case\n+        run_rustc_build_scripts: true,\n+    };\n     let (host, _vfs, _proc_macro) =\n         load_workspace_at(path, &cargo_config, &load_cargo_config, &|_| {})?;\n     let db = host.raw_database();"}, {"sha": "3d7b5031a41333d4c9660d0563bc87a7a212281e", "filename": "crates/rust-analyzer/src/cli/load_cargo.rs", "status": "modified", "additions": 7, "deletions": 3, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/ddce6bb282764692d53b719bff4c37e3512d4556/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fload_cargo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ddce6bb282764692d53b719bff4c37e3512d4556/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fload_cargo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fload_cargo.rs?ref=ddce6bb282764692d53b719bff4c37e3512d4556", "patch": "@@ -14,6 +14,7 @@ use vfs::{loader::Handle, AbsPath, AbsPathBuf};\n use crate::reload::{ProjectFolders, SourceRootConfig};\n \n pub struct LoadCargoConfig {\n+    pub run_rustc_build_scripts: bool,\n     pub load_out_dirs_from_check: bool,\n     pub with_proc_macro: bool,\n }\n@@ -53,7 +54,7 @@ pub fn load_workspace(\n \n     let build_data = if config.load_out_dirs_from_check {\n         let mut collector = BuildDataCollector::default();\n-        ws.collect_build_data_configs(&mut collector);\n+        ws.collect_build_data_configs(&mut collector, config.run_rustc_build_scripts);\n         Some(collector.collect(progress)?)\n     } else {\n         None\n@@ -136,8 +137,11 @@ mod tests {\n     fn test_loading_rust_analyzer() -> Result<()> {\n         let path = Path::new(env!(\"CARGO_MANIFEST_DIR\")).parent().unwrap().parent().unwrap();\n         let cargo_config = Default::default();\n-        let load_cargo_config =\n-            LoadCargoConfig { load_out_dirs_from_check: false, with_proc_macro: false };\n+        let load_cargo_config = LoadCargoConfig {\n+            load_out_dirs_from_check: false,\n+            with_proc_macro: false,\n+            run_rustc_build_scripts: false,\n+        };\n         let (host, _vfs, _proc_macro) =\n             load_workspace_at(path, &cargo_config, &load_cargo_config, &|_| {})?;\n "}, {"sha": "8cc4eefc200635a04e5d79139bec701b1f65bc5b", "filename": "crates/rust-analyzer/src/cli/ssr.rs", "status": "modified", "additions": 14, "deletions": 4, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/ddce6bb282764692d53b719bff4c37e3512d4556/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fssr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ddce6bb282764692d53b719bff4c37e3512d4556/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fssr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fssr.rs?ref=ddce6bb282764692d53b719bff4c37e3512d4556", "patch": "@@ -9,8 +9,13 @@ use ide_ssr::{MatchFinder, SsrPattern, SsrRule};\n pub fn apply_ssr_rules(rules: Vec<SsrRule>) -> Result<()> {\n     use ide_db::base_db::SourceDatabaseExt;\n     let cargo_config = Default::default();\n-    let load_cargo_config =\n-        LoadCargoConfig { load_out_dirs_from_check: true, with_proc_macro: true };\n+    let load_cargo_config = LoadCargoConfig {\n+        load_out_dirs_from_check: true,\n+        with_proc_macro: true,\n+        // This will currently never have rustcSource set, however if in\n+        // future it does this will handle that case\n+        run_rustc_build_scripts: true,\n+    };\n     let (host, vfs, _proc_macro) =\n         load_workspace_at(&std::env::current_dir()?, &cargo_config, &load_cargo_config, &|_| {})?;\n     let db = host.raw_database();\n@@ -36,8 +41,13 @@ pub fn search_for_patterns(patterns: Vec<SsrPattern>, debug_snippet: Option<Stri\n     use ide_db::base_db::SourceDatabaseExt;\n     use ide_db::symbol_index::SymbolsDatabase;\n     let cargo_config = Default::default();\n-    let load_cargo_config =\n-        LoadCargoConfig { load_out_dirs_from_check: true, with_proc_macro: true };\n+    let load_cargo_config = LoadCargoConfig {\n+        load_out_dirs_from_check: true,\n+        with_proc_macro: true,\n+        // This will currently never have rustcSource set, however if in\n+        // future it does this will handle that case\n+        run_rustc_build_scripts: true,\n+    };\n     let (host, _vfs, _proc_macro) =\n         load_workspace_at(&std::env::current_dir()?, &cargo_config, &load_cargo_config, &|_| {})?;\n     let db = host.raw_database();"}, {"sha": "cbec8fce24cf179ce2ba7180fe6a523e80a0e258", "filename": "crates/rust-analyzer/src/config.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/ddce6bb282764692d53b719bff4c37e3512d4556/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ddce6bb282764692d53b719bff4c37e3512d4556/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fconfig.rs?ref=ddce6bb282764692d53b719bff4c37e3512d4556", "patch": "@@ -49,6 +49,8 @@ config_data! {\n         /// Run build scripts (`build.rs`) for more precise code analysis.\n         cargo_runBuildScripts |\n         cargo_loadOutDirsFromCheck: bool = \"false\",\n+        /// Disable running build scripts (`build.rs`) for the `rustc_private` crates in `rustcSource`.\n+        cargo_disableRustcBuildScripts: bool = \"false\",\n         /// Do not activate the `default` feature.\n         cargo_noDefaultFeatures: bool    = \"false\",\n         /// Compilation target (target triple).\n@@ -482,6 +484,9 @@ impl Config {\n     pub fn run_build_scripts(&self) -> bool {\n         self.data.cargo_runBuildScripts || self.data.procMacro_enable\n     }\n+    pub fn run_rustc_build_scripts(&self) -> bool {\n+        self.run_build_scripts() && !self.data.cargo_disableRustcBuildScripts\n+    }\n     pub fn cargo(&self) -> CargoConfig {\n         let rustc_source = self.data.rustcSource.as_ref().map(|rustc_src| {\n             if rustc_src == \"discover\" {"}, {"sha": "da02be2dec781aca2381b2c40afc920253b5dbb0", "filename": "crates/rust-analyzer/src/reload.rs", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/ddce6bb282764692d53b719bff4c37e3512d4556/crates%2Frust-analyzer%2Fsrc%2Freload.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ddce6bb282764692d53b719bff4c37e3512d4556/crates%2Frust-analyzer%2Fsrc%2Freload.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Freload.rs?ref=ddce6bb282764692d53b719bff4c37e3512d4556", "patch": "@@ -340,7 +340,10 @@ impl GlobalState {\n         if self.config.run_build_scripts() && workspace_build_data.is_none() {\n             let mut collector = BuildDataCollector::default();\n             for ws in &workspaces {\n-                ws.collect_build_data_configs(&mut collector);\n+                ws.collect_build_data_configs(\n+                    &mut collector,\n+                    self.config.run_rustc_build_scripts(),\n+                );\n             }\n             self.fetch_build_data_request(collector)\n         }"}, {"sha": "602c9432e03b0b1290884ca6a9c74e87d2d90dc7", "filename": "docs/user/generated_config.adoc", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ddce6bb282764692d53b719bff4c37e3512d4556/docs%2Fuser%2Fgenerated_config.adoc", "raw_url": "https://github.com/rust-lang/rust/raw/ddce6bb282764692d53b719bff4c37e3512d4556/docs%2Fuser%2Fgenerated_config.adoc", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/docs%2Fuser%2Fgenerated_config.adoc?ref=ddce6bb282764692d53b719bff4c37e3512d4556", "patch": "@@ -12,6 +12,8 @@\n  List of features to activate.\n [[rust-analyzer.cargo.runBuildScripts]]rust-analyzer.cargo.runBuildScripts (default: `false`)::\n  Run build scripts (`build.rs`) for more precise code analysis.\n+[[rust-analyzer.cargo.disableRustcBuildScripts]]rust-analyzer.cargo.disableRustcBuildScripts (default: `false`)::\n+ Disable running build scripts (`build.rs`) for the `rustc_private` crates in `rustcSource`.\n [[rust-analyzer.cargo.noDefaultFeatures]]rust-analyzer.cargo.noDefaultFeatures (default: `false`)::\n  Do not activate the `default` feature.\n [[rust-analyzer.cargo.target]]rust-analyzer.cargo.target (default: `null`)::"}, {"sha": "82011bb44559748ad9b81eb12326c50f70cf945d", "filename": "editors/code/package.json", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/ddce6bb282764692d53b719bff4c37e3512d4556/editors%2Fcode%2Fpackage.json", "raw_url": "https://github.com/rust-lang/rust/raw/ddce6bb282764692d53b719bff4c37e3512d4556/editors%2Fcode%2Fpackage.json", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fpackage.json?ref=ddce6bb282764692d53b719bff4c37e3512d4556", "patch": "@@ -413,6 +413,11 @@\n                     \"default\": false,\n                     \"type\": \"boolean\"\n                 },\n+                \"rust-analyzer.cargo.disableRustcBuildScripts\": {\n+                    \"markdownDescription\": \"Disable running build scripts (`build.rs`) for the `rustc_private` crates in `rustcSource`.\",\n+                    \"default\": false,\n+                    \"type\": \"boolean\"\n+                },\n                 \"rust-analyzer.cargo.noDefaultFeatures\": {\n                     \"markdownDescription\": \"Do not activate the `default` feature.\",\n                     \"default\": false,"}]}