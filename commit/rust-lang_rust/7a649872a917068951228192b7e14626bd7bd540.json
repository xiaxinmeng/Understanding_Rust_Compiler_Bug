{"sha": "7a649872a917068951228192b7e14626bd7bd540", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdhNjQ5ODcyYTkxNzA2ODk1MTIyODE5MmI3ZTE0NjI2YmQ3YmQ1NDA=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-12-02T12:42:54Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2017-12-02T12:42:54Z"}, "message": "Auto merge of #46347 - raventid:did-you-mean-increase-accuracy, r=estebank\n\nAdd case insensitive comparison, besides Levenstein for DYM\n\nCloses #46332\n\nDraft version. The idea is that Levenstein does not work for some cases when we have multiple equal weights for strings. I didn't understand the case with `if found != name => Some(found)` so it means that new code does not work correctly yet.\n\nAt least now I think that we might return all maximal weights from levenstein and think about next cases in priority order:\n\n1) There is exact match -> None\n2) There is exact match, but case insensitive -> Some(match)\n3) There is some match from levenstein -> Some(matches.take_any)\n4) There is no match -> None\n\n@estebank WDYT?", "tree": {"sha": "6289cfeb5086df6f00b48a0b0c708ad0fde7bcd7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6289cfeb5086df6f00b48a0b0c708ad0fde7bcd7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7a649872a917068951228192b7e14626bd7bd540", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7a649872a917068951228192b7e14626bd7bd540", "html_url": "https://github.com/rust-lang/rust/commit/7a649872a917068951228192b7e14626bd7bd540", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7a649872a917068951228192b7e14626bd7bd540/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e0d11f39d81496743ffe2037b0ec09a573948f40", "url": "https://api.github.com/repos/rust-lang/rust/commits/e0d11f39d81496743ffe2037b0ec09a573948f40", "html_url": "https://github.com/rust-lang/rust/commit/e0d11f39d81496743ffe2037b0ec09a573948f40"}, {"sha": "f18446e78de1e925b9849bd618e20ed471ad0e61", "url": "https://api.github.com/repos/rust-lang/rust/commits/f18446e78de1e925b9849bd618e20ed471ad0e61", "html_url": "https://github.com/rust-lang/rust/commit/f18446e78de1e925b9849bd618e20ed471ad0e61"}], "stats": {"total": 61, "additions": 56, "deletions": 5}, "files": [{"sha": "e429791f2bdd42c145b8d92860612c6f91ae71f7", "filename": "src/libsyntax/util/lev_distance.rs", "status": "modified", "additions": 27, "deletions": 5, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/7a649872a917068951228192b7e14626bd7bd540/src%2Flibsyntax%2Futil%2Flev_distance.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7a649872a917068951228192b7e14626bd7bd540/src%2Flibsyntax%2Futil%2Flev_distance.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Futil%2Flev_distance.rs?ref=7a649872a917068951228192b7e14626bd7bd540", "patch": "@@ -44,23 +44,45 @@ pub fn lev_distance(a: &str, b: &str) -> usize {\n /// To find the best match for a given string from an iterator of names\n /// As a loose rule to avoid the obviously incorrect suggestions, it takes\n /// an optional limit for the maximum allowable edit distance, which defaults\n-/// to one-third of the given word\n+/// to one-third of the given word.\n+/// Besides Levenshtein, we use case insensitive comparison to improve accuracy on an edge case with\n+/// a lower(upper)case letters mismatch.\n pub fn find_best_match_for_name<'a, T>(iter_names: T,\n                                        lookup: &str,\n                                        dist: Option<usize>) -> Option<Symbol>\n     where T: Iterator<Item = &'a Symbol> {\n     let max_dist = dist.map_or_else(|| cmp::max(lookup.len(), 3) / 3, |d| d);\n-    iter_names\n+\n+    let (case_insensitive_match, levenstein_match) = iter_names\n     .filter_map(|&name| {\n         let dist = lev_distance(lookup, &name.as_str());\n-        if dist <= max_dist {    // filter the unwanted cases\n+        if dist <= max_dist {\n             Some((name, dist))\n         } else {\n             None\n         }\n     })\n-    .min_by_key(|&(_, val)| val)    // extract the tuple containing the minimum edit distance\n-    .map(|(s, _)| s)                // and return only the string\n+    // Here we are collecting the next structure:\n+    // (case_insensitive_match, (levenstein_match, levenstein_distance))\n+    .fold((None, None), |result, (candidate, dist)| {\n+        (\n+            if candidate.as_str().to_uppercase() == lookup.to_uppercase() {\n+                Some(candidate)\n+            } else {\n+                result.0\n+            },\n+            match result.1 {\n+                None => Some((candidate, dist)),\n+                Some((c, d)) => Some(if dist < d { (candidate, dist) } else { (c, d) })\n+            }\n+        )\n+    });\n+\n+    if let Some(candidate) = case_insensitive_match {\n+        Some(candidate) // exact case insensitive match has a higher priority\n+    } else {\n+        if let Some((candidate, _)) = levenstein_match { Some(candidate) } else { None }\n+    }\n }\n \n #[test]"}, {"sha": "d094497e246d0deff28f0c35a38540b6370493a7", "filename": "src/test/ui/issue-46332.rs", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/7a649872a917068951228192b7e14626bd7bd540/src%2Ftest%2Fui%2Fissue-46332.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7a649872a917068951228192b7e14626bd7bd540/src%2Ftest%2Fui%2Fissue-46332.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissue-46332.rs?ref=7a649872a917068951228192b7e14626bd7bd540", "patch": "@@ -0,0 +1,21 @@\n+// Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// Original Levenshtein distance for both of this is 1. We improved accuracy with\n+// additional case insensitive comparison.\n+\n+struct TyUint {}\n+\n+struct TyInt {}\n+\n+fn main() {\n+    TyUInt {};\n+    //~^ ERROR cannot find struct, variant or union type `TyUInt` in this scope\n+}"}, {"sha": "6aef84568353ce8aede273fcbf920692de89eb87", "filename": "src/test/ui/issue-46332.stderr", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/7a649872a917068951228192b7e14626bd7bd540/src%2Ftest%2Fui%2Fissue-46332.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/7a649872a917068951228192b7e14626bd7bd540/src%2Ftest%2Fui%2Fissue-46332.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissue-46332.stderr?ref=7a649872a917068951228192b7e14626bd7bd540", "patch": "@@ -0,0 +1,8 @@\n+error[E0422]: cannot find struct, variant or union type `TyUInt` in this scope\n+  --> $DIR/issue-46332.rs:19:5\n+   |\n+19 |     TyUInt {};\n+   |     ^^^^^^ did you mean `TyUint`?\n+\n+error: aborting due to previous error\n+"}]}