{"sha": "a3e6c19acf12d5995407220721f4fe28452e51da", "node_id": "C_kwDOAAsO6NoAKGEzZTZjMTlhY2YxMmQ1OTk1NDA3MjIwNzIxZjRmZTI4NDUyZTUxZGE", "commit": {"author": {"name": "the8472", "email": "the8472@users.noreply.github.com", "date": "2021-09-21T20:54:08Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-09-21T20:54:08Z"}, "message": "Rollup merge of #89147 - b-naber:refs_in_check_const_value_eq, r=oli-obk\n\nadd case for checking const refs in check_const_value_eq\n\nPreviously in `check_const_value_eq` we destructured `ConstValue::ByRef` instances, this didn't account for `ty::Ref`s however, which led to an ICE.\n\nFixes https://github.com/rust-lang/rust/issues/88876\nFixes https://github.com/rust-lang/rust/issues/88384\n\nr? `@oli-obk`", "tree": {"sha": "273157418d6ab67dbd8f0835a1d6b2ba4f6ce25d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/273157418d6ab67dbd8f0835a1d6b2ba4f6ce25d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a3e6c19acf12d5995407220721f4fe28452e51da", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhSkZxCRBK7hj4Ov3rIwAAHZcIAD6lYN0lFWosYny5mzzbf5u3\nGil2ihDxQYfd702ZsNPHTxJmDmoJKElPPhlEeB2YzdZFgU0q5VZ9tOH3sAFqfP/R\nyESJMuFUq/DHcBGu88XcW06VbRkm8hUhUyHNxKqOh/w++SPtmKORVxLH65aak/Ig\nsXWdA3+rPh8Eqr/bFzkBbev8ebPNxg0C6SQ3zfIK5pCWxktExRBbRbG1q9RxV/8C\n7bHo1Y18gByvBS708nyKTiR8bJrwtMshhDGOILZelWMnMEfErW9LXkg2K+aJC42q\npMnz+deKS2glMedT/uoKbXdp+PTQCvd1swDs4coVNbHkB0+MgnxkeaGROZGqB50=\n=FMhv\n-----END PGP SIGNATURE-----\n", "payload": "tree 273157418d6ab67dbd8f0835a1d6b2ba4f6ce25d\nparent aca790b3d62784ae6399ac2337a1147ea9aab9b8\nparent 999888c086446c4c43bd5e99d8a0d2a1a7ee0404\nauthor the8472 <the8472@users.noreply.github.com> 1632257648 +0200\ncommitter GitHub <noreply@github.com> 1632257648 +0200\n\nRollup merge of #89147 - b-naber:refs_in_check_const_value_eq, r=oli-obk\n\nadd case for checking const refs in check_const_value_eq\n\nPreviously in `check_const_value_eq` we destructured `ConstValue::ByRef` instances, this didn't account for `ty::Ref`s however, which led to an ICE.\n\nFixes https://github.com/rust-lang/rust/issues/88876\nFixes https://github.com/rust-lang/rust/issues/88384\n\nr? `@oli-obk`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a3e6c19acf12d5995407220721f4fe28452e51da", "html_url": "https://github.com/rust-lang/rust/commit/a3e6c19acf12d5995407220721f4fe28452e51da", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a3e6c19acf12d5995407220721f4fe28452e51da/comments", "author": {"login": "the8472", "id": 1065730, "node_id": "MDQ6VXNlcjEwNjU3MzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1065730?v=4", "gravatar_id": "", "url": "https://api.github.com/users/the8472", "html_url": "https://github.com/the8472", "followers_url": "https://api.github.com/users/the8472/followers", "following_url": "https://api.github.com/users/the8472/following{/other_user}", "gists_url": "https://api.github.com/users/the8472/gists{/gist_id}", "starred_url": "https://api.github.com/users/the8472/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/the8472/subscriptions", "organizations_url": "https://api.github.com/users/the8472/orgs", "repos_url": "https://api.github.com/users/the8472/repos", "events_url": "https://api.github.com/users/the8472/events{/privacy}", "received_events_url": "https://api.github.com/users/the8472/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "aca790b3d62784ae6399ac2337a1147ea9aab9b8", "url": "https://api.github.com/repos/rust-lang/rust/commits/aca790b3d62784ae6399ac2337a1147ea9aab9b8", "html_url": "https://github.com/rust-lang/rust/commit/aca790b3d62784ae6399ac2337a1147ea9aab9b8"}, {"sha": "999888c086446c4c43bd5e99d8a0d2a1a7ee0404", "url": "https://api.github.com/repos/rust-lang/rust/commits/999888c086446c4c43bd5e99d8a0d2a1a7ee0404", "html_url": "https://github.com/rust-lang/rust/commit/999888c086446c4c43bd5e99d8a0d2a1a7ee0404"}], "stats": {"total": 57, "additions": 57, "deletions": 0}, "files": [{"sha": "2c786538014ff20421324e5927de8a613caaf4e0", "filename": "compiler/rustc_middle/src/ty/relate.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/a3e6c19acf12d5995407220721f4fe28452e51da/compiler%2Frustc_middle%2Fsrc%2Fty%2Frelate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a3e6c19acf12d5995407220721f4fe28452e51da/compiler%2Frustc_middle%2Fsrc%2Fty%2Frelate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Frelate.rs?ref=a3e6c19acf12d5995407220721f4fe28452e51da", "patch": "@@ -639,6 +639,15 @@ fn check_const_value_eq<R: TypeRelation<'tcx>>(\n             get_slice_bytes(&tcx, a_val) == get_slice_bytes(&tcx, b_val)\n         }\n \n+        (ConstValue::ByRef { alloc: alloc_a, .. }, ConstValue::ByRef { alloc: alloc_b, .. })\n+            if a.ty.is_ref() || b.ty.is_ref() =>\n+        {\n+            if a.ty.is_ref() && b.ty.is_ref() {\n+                alloc_a == alloc_b\n+            } else {\n+                false\n+            }\n+        }\n         (ConstValue::ByRef { .. }, ConstValue::ByRef { .. }) => {\n             let a_destructured = tcx.destructure_const(relation.param_env().and(a));\n             let b_destructured = tcx.destructure_const(relation.param_env().and(b));"}, {"sha": "204d18ea25de4482ead25c12fd49f9a1bc7b43ff", "filename": "src/test/ui/consts/refs_check_const_eq-issue-88384.rs", "status": "added", "additions": 25, "deletions": 0, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/a3e6c19acf12d5995407220721f4fe28452e51da/src%2Ftest%2Fui%2Fconsts%2Frefs_check_const_eq-issue-88384.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a3e6c19acf12d5995407220721f4fe28452e51da/src%2Ftest%2Fui%2Fconsts%2Frefs_check_const_eq-issue-88384.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Frefs_check_const_eq-issue-88384.rs?ref=a3e6c19acf12d5995407220721f4fe28452e51da", "patch": "@@ -0,0 +1,25 @@\n+// check-pass\n+\n+#![feature(fn_traits)]\n+#![feature(adt_const_params)]\n+//~^ WARNING the feature `adt_const_params` is incomplete\n+\n+#[derive(PartialEq, Eq)]\n+struct CompileTimeSettings{\n+    hooks: &'static[fn()],\n+}\n+\n+struct Foo<const T: CompileTimeSettings>;\n+\n+impl<const T: CompileTimeSettings> Foo<T> {\n+    fn call_hooks(){\n+    }\n+}\n+\n+fn main(){\n+    const SETTINGS: CompileTimeSettings = CompileTimeSettings{\n+        hooks: &[],\n+    };\n+\n+    Foo::<SETTINGS>::call_hooks();\n+}"}, {"sha": "55928b495b24caf4c401492be1718db7bb6b5574", "filename": "src/test/ui/consts/refs_check_const_eq-issue-88384.stderr", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/a3e6c19acf12d5995407220721f4fe28452e51da/src%2Ftest%2Fui%2Fconsts%2Frefs_check_const_eq-issue-88384.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/a3e6c19acf12d5995407220721f4fe28452e51da/src%2Ftest%2Fui%2Fconsts%2Frefs_check_const_eq-issue-88384.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Frefs_check_const_eq-issue-88384.stderr?ref=a3e6c19acf12d5995407220721f4fe28452e51da", "patch": "@@ -0,0 +1,11 @@\n+warning: the feature `adt_const_params` is incomplete and may not be safe to use and/or cause compiler crashes\n+  --> $DIR/refs_check_const_eq-issue-88384.rs:4:12\n+   |\n+LL | #![feature(adt_const_params)]\n+   |            ^^^^^^^^^^^^^^^^\n+   |\n+   = note: `#[warn(incomplete_features)]` on by default\n+   = note: see issue #44580 <https://github.com/rust-lang/rust/issues/44580> for more information\n+\n+warning: 1 warning emitted\n+"}, {"sha": "6ce9da436680047d2632c3274997e5eeda4666c1", "filename": "src/test/ui/consts/refs_check_const_value_eq-issue-88876.rs", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/a3e6c19acf12d5995407220721f4fe28452e51da/src%2Ftest%2Fui%2Fconsts%2Frefs_check_const_value_eq-issue-88876.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a3e6c19acf12d5995407220721f4fe28452e51da/src%2Ftest%2Fui%2Fconsts%2Frefs_check_const_value_eq-issue-88876.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fconsts%2Frefs_check_const_value_eq-issue-88876.rs?ref=a3e6c19acf12d5995407220721f4fe28452e51da", "patch": "@@ -0,0 +1,12 @@\n+// check-pass\n+\n+#![allow(incomplete_features)]\n+#![feature(adt_const_params)]\n+\n+struct FooConst<const ARRAY: &'static [&'static str]> {}\n+\n+const FOO_ARR: &[&'static str; 2] = &[\"Hello\", \"Friend\"];\n+\n+fn main() {\n+    let _ = FooConst::<FOO_ARR> {};\n+}"}]}