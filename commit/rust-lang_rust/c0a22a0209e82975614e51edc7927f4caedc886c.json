{"sha": "c0a22a0209e82975614e51edc7927f4caedc886c", "node_id": "C_kwDOAAsO6NoAKGMwYTIyYTAyMDllODI5NzU2MTRlNTFlZGM3OTI3ZjRjYWVkYzg4NmM", "commit": {"author": {"name": "Takayuki Maeda", "email": "takoyaki0316@gmail.com", "date": "2022-07-28T00:55:12Z"}, "committer": {"name": "Takayuki Maeda", "email": "takoyaki0316@gmail.com", "date": "2022-07-28T00:55:12Z"}, "message": "suggest adding/removing `ref` for binding patterns", "tree": {"sha": "a9b8fd1af45d79409c3fab74f94ee5cf176366f1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a9b8fd1af45d79409c3fab74f94ee5cf176366f1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c0a22a0209e82975614e51edc7927f4caedc886c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c0a22a0209e82975614e51edc7927f4caedc886c", "html_url": "https://github.com/rust-lang/rust/commit/c0a22a0209e82975614e51edc7927f4caedc886c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c0a22a0209e82975614e51edc7927f4caedc886c/comments", "author": {"login": "TaKO8Ki", "id": 41065217, "node_id": "MDQ6VXNlcjQxMDY1MjE3", "avatar_url": "https://avatars.githubusercontent.com/u/41065217?v=4", "gravatar_id": "", "url": "https://api.github.com/users/TaKO8Ki", "html_url": "https://github.com/TaKO8Ki", "followers_url": "https://api.github.com/users/TaKO8Ki/followers", "following_url": "https://api.github.com/users/TaKO8Ki/following{/other_user}", "gists_url": "https://api.github.com/users/TaKO8Ki/gists{/gist_id}", "starred_url": "https://api.github.com/users/TaKO8Ki/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/TaKO8Ki/subscriptions", "organizations_url": "https://api.github.com/users/TaKO8Ki/orgs", "repos_url": "https://api.github.com/users/TaKO8Ki/repos", "events_url": "https://api.github.com/users/TaKO8Ki/events{/privacy}", "received_events_url": "https://api.github.com/users/TaKO8Ki/received_events", "type": "User", "site_admin": false}, "committer": {"login": "TaKO8Ki", "id": 41065217, "node_id": "MDQ6VXNlcjQxMDY1MjE3", "avatar_url": "https://avatars.githubusercontent.com/u/41065217?v=4", "gravatar_id": "", "url": "https://api.github.com/users/TaKO8Ki", "html_url": "https://github.com/TaKO8Ki", "followers_url": "https://api.github.com/users/TaKO8Ki/followers", "following_url": "https://api.github.com/users/TaKO8Ki/following{/other_user}", "gists_url": "https://api.github.com/users/TaKO8Ki/gists{/gist_id}", "starred_url": "https://api.github.com/users/TaKO8Ki/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/TaKO8Ki/subscriptions", "organizations_url": "https://api.github.com/users/TaKO8Ki/orgs", "repos_url": "https://api.github.com/users/TaKO8Ki/repos", "events_url": "https://api.github.com/users/TaKO8Ki/events{/privacy}", "received_events_url": "https://api.github.com/users/TaKO8Ki/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3ae03e027a66744e934a7bfa7127256489bed3c2", "url": "https://api.github.com/repos/rust-lang/rust/commits/3ae03e027a66744e934a7bfa7127256489bed3c2", "html_url": "https://github.com/rust-lang/rust/commit/3ae03e027a66744e934a7bfa7127256489bed3c2"}], "stats": {"total": 166, "additions": 160, "deletions": 6}, "files": [{"sha": "373a824b0d53c9c0a8db35e5ef57d646607bccfe", "filename": "compiler/rustc_typeck/src/check/pat.rs", "status": "modified", "additions": 49, "deletions": 4, "changes": 53, "blob_url": "https://github.com/rust-lang/rust/blob/c0a22a0209e82975614e51edc7927f4caedc886c/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fpat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c0a22a0209e82975614e51edc7927f4caedc886c/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fpat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fpat.rs?ref=c0a22a0209e82975614e51edc7927f4caedc886c", "patch": "@@ -617,7 +617,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         // If there are multiple arms, make sure they all agree on\n         // what the type of the binding `x` ought to be.\n         if var_id != pat.hir_id {\n-            self.check_binding_alt_eq_ty(pat.span, var_id, local_ty, ti);\n+            self.check_binding_alt_eq_ty(ba, pat.span, var_id, local_ty, ti);\n         }\n \n         if let Some(p) = sub {\n@@ -627,7 +627,14 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         local_ty\n     }\n \n-    fn check_binding_alt_eq_ty(&self, span: Span, var_id: HirId, ty: Ty<'tcx>, ti: TopInfo<'tcx>) {\n+    fn check_binding_alt_eq_ty(\n+        &self,\n+        ba: hir::BindingAnnotation,\n+        span: Span,\n+        var_id: HirId,\n+        ty: Ty<'tcx>,\n+        ti: TopInfo<'tcx>,\n+    ) {\n         let var_ty = self.local_ty(span, var_id).decl_ty;\n         if let Some(mut err) = self.demand_eqtype_pat_diag(span, var_ty, ty, ti) {\n             let hir = self.tcx.hir();\n@@ -645,12 +652,50 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n             });\n             let pre = if in_match { \"in the same arm, \" } else { \"\" };\n             err.note(&format!(\"{}a binding must have the same type in all alternatives\", pre));\n-            // FIXME: check if `var_ty` and `ty` can be made the same type by adding or removing\n-            // `ref` or `&` to the pattern.\n+            self.suggest_adding_missing_ref_or_removing_ref(\n+                &mut err,\n+                span,\n+                var_ty,\n+                self.resolve_vars_with_obligations(ty),\n+                ba,\n+            );\n             err.emit();\n         }\n     }\n \n+    fn suggest_adding_missing_ref_or_removing_ref(\n+        &self,\n+        err: &mut Diagnostic,\n+        span: Span,\n+        expected: Ty<'tcx>,\n+        actual: Ty<'tcx>,\n+        ba: hir::BindingAnnotation,\n+    ) {\n+        match (expected.kind(), actual.kind(), ba) {\n+            (ty::Ref(_, inner_ty, _), _, hir::BindingAnnotation::Unannotated)\n+                if self.can_eq(self.param_env, *inner_ty, actual).is_ok() =>\n+            {\n+                err.span_suggestion_verbose(\n+                    span.shrink_to_lo(),\n+                    \"consider adding `ref`\",\n+                    \"ref \",\n+                    Applicability::MaybeIncorrect,\n+                );\n+            }\n+            (_, ty::Ref(_, inner_ty, _), hir::BindingAnnotation::Ref)\n+                if self.can_eq(self.param_env, expected, *inner_ty).is_ok() =>\n+            {\n+                err.span_suggestion_verbose(\n+                    span.with_hi(span.lo() + BytePos(4)),\n+                    \"consider removing `ref`\",\n+                    \"\",\n+                    Applicability::MaybeIncorrect,\n+                );\n+            }\n+            _ => (),\n+        }\n+    }\n+\n     // Precondition: pat is a Ref(_) pattern\n     fn borrow_pat_suggestion(&self, err: &mut Diagnostic, pat: &Pat<'_>) {\n         let tcx = self.tcx;"}, {"sha": "7fec6ecd72573727ba2829869da3d4f6192d44ca", "filename": "src/test/ui/mismatched_types/E0409.stderr", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/c0a22a0209e82975614e51edc7927f4caedc886c/src%2Ftest%2Fui%2Fmismatched_types%2FE0409.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c0a22a0209e82975614e51edc7927f4caedc886c/src%2Ftest%2Fui%2Fmismatched_types%2FE0409.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmismatched_types%2FE0409.stderr?ref=c0a22a0209e82975614e51edc7927f4caedc886c", "patch": "@@ -17,6 +17,10 @@ LL |         (0, ref y) | (y, 0) => {}\n    |             first introduced with type `&{integer}` here\n    |\n    = note: in the same arm, a binding must have the same type in all alternatives\n+help: consider adding `ref`\n+   |\n+LL |         (0, ref y) | (ref y, 0) => {}\n+   |                       +++\n \n error: aborting due to 2 previous errors\n "}, {"sha": "56f93cfbfdcbec4789a0b8317009370fcd49ce13", "filename": "src/test/ui/mismatched_types/suggest-adding-or-removing-ref-for-binding-pattern.fixed", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/c0a22a0209e82975614e51edc7927f4caedc886c/src%2Ftest%2Fui%2Fmismatched_types%2Fsuggest-adding-or-removing-ref-for-binding-pattern.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/c0a22a0209e82975614e51edc7927f4caedc886c/src%2Ftest%2Fui%2Fmismatched_types%2Fsuggest-adding-or-removing-ref-for-binding-pattern.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmismatched_types%2Fsuggest-adding-or-removing-ref-for-binding-pattern.fixed?ref=c0a22a0209e82975614e51edc7927f4caedc886c", "patch": "@@ -0,0 +1,21 @@\n+// run-rustfix\n+#![allow(dead_code, unused_variables)]\n+\n+fn main() {\n+    enum Blah {\n+        A(isize, isize, usize),\n+        B(isize, usize),\n+    }\n+\n+    match Blah::A(1, 1, 2) {\n+        Blah::A(_, x, ref y) | Blah::B(x, ref y) => {}\n+        //~^ ERROR mismatched types\n+        //~| ERROR variable `y` is bound inconsistently across alternatives separated by `|`\n+    }\n+\n+    match Blah::A(1, 1, 2) {\n+        Blah::A(_, x, y) | Blah::B(x, y) => {}\n+        //~^ ERROR mismatched types\n+        //~| variable `y` is bound inconsistently across alternatives separated by `|`\n+    }\n+}"}, {"sha": "0c33f99a42e8bba011e25b48090d0eb82313f8bd", "filename": "src/test/ui/mismatched_types/suggest-adding-or-removing-ref-for-binding-pattern.rs", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/c0a22a0209e82975614e51edc7927f4caedc886c/src%2Ftest%2Fui%2Fmismatched_types%2Fsuggest-adding-or-removing-ref-for-binding-pattern.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c0a22a0209e82975614e51edc7927f4caedc886c/src%2Ftest%2Fui%2Fmismatched_types%2Fsuggest-adding-or-removing-ref-for-binding-pattern.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmismatched_types%2Fsuggest-adding-or-removing-ref-for-binding-pattern.rs?ref=c0a22a0209e82975614e51edc7927f4caedc886c", "patch": "@@ -0,0 +1,21 @@\n+// run-rustfix\n+#![allow(dead_code, unused_variables)]\n+\n+fn main() {\n+    enum Blah {\n+        A(isize, isize, usize),\n+        B(isize, usize),\n+    }\n+\n+    match Blah::A(1, 1, 2) {\n+        Blah::A(_, x, ref y) | Blah::B(x, y) => {}\n+        //~^ ERROR mismatched types\n+        //~| ERROR variable `y` is bound inconsistently across alternatives separated by `|`\n+    }\n+\n+    match Blah::A(1, 1, 2) {\n+        Blah::A(_, x, y) | Blah::B(x, ref y) => {}\n+        //~^ ERROR mismatched types\n+        //~| variable `y` is bound inconsistently across alternatives separated by `|`\n+    }\n+}"}, {"sha": "e8357f9a37f8ce915bd7531eb7fa9d6bb6997a17", "filename": "src/test/ui/mismatched_types/suggest-adding-or-removing-ref-for-binding-pattern.stderr", "status": "added", "additions": 49, "deletions": 0, "changes": 49, "blob_url": "https://github.com/rust-lang/rust/blob/c0a22a0209e82975614e51edc7927f4caedc886c/src%2Ftest%2Fui%2Fmismatched_types%2Fsuggest-adding-or-removing-ref-for-binding-pattern.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c0a22a0209e82975614e51edc7927f4caedc886c/src%2Ftest%2Fui%2Fmismatched_types%2Fsuggest-adding-or-removing-ref-for-binding-pattern.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fmismatched_types%2Fsuggest-adding-or-removing-ref-for-binding-pattern.stderr?ref=c0a22a0209e82975614e51edc7927f4caedc886c", "patch": "@@ -0,0 +1,49 @@\n+error[E0409]: variable `y` is bound inconsistently across alternatives separated by `|`\n+  --> $DIR/suggest-adding-or-removing-ref-for-binding-pattern.rs:11:43\n+   |\n+LL |         Blah::A(_, x, ref y) | Blah::B(x, y) => {}\n+   |                           - first binding ^ bound in different ways\n+\n+error[E0409]: variable `y` is bound inconsistently across alternatives separated by `|`\n+  --> $DIR/suggest-adding-or-removing-ref-for-binding-pattern.rs:17:43\n+   |\n+LL |         Blah::A(_, x, y) | Blah::B(x, ref y) => {}\n+   |                       - first binding     ^ bound in different ways\n+\n+error[E0308]: mismatched types\n+  --> $DIR/suggest-adding-or-removing-ref-for-binding-pattern.rs:11:43\n+   |\n+LL |     match Blah::A(1, 1, 2) {\n+   |           ---------------- this expression has type `Blah`\n+LL |         Blah::A(_, x, ref y) | Blah::B(x, y) => {}\n+   |                       -----               ^ expected `&usize`, found `usize`\n+   |                       |\n+   |                       first introduced with type `&usize` here\n+   |\n+   = note: in the same arm, a binding must have the same type in all alternatives\n+help: consider adding `ref`\n+   |\n+LL |         Blah::A(_, x, ref y) | Blah::B(x, ref y) => {}\n+   |                                           +++\n+\n+error[E0308]: mismatched types\n+  --> $DIR/suggest-adding-or-removing-ref-for-binding-pattern.rs:17:39\n+   |\n+LL |     match Blah::A(1, 1, 2) {\n+   |           ---------------- this expression has type `Blah`\n+LL |         Blah::A(_, x, y) | Blah::B(x, ref y) => {}\n+   |                       -               ^^^^^ expected `usize`, found `&usize`\n+   |                       |\n+   |                       first introduced with type `usize` here\n+   |\n+   = note: in the same arm, a binding must have the same type in all alternatives\n+help: consider removing `ref`\n+   |\n+LL -         Blah::A(_, x, y) | Blah::B(x, ref y) => {}\n+LL +         Blah::A(_, x, y) | Blah::B(x, y) => {}\n+   |\n+\n+error: aborting due to 4 previous errors\n+\n+Some errors have detailed explanations: E0308, E0409.\n+For more information about an error, try `rustc --explain E0308`."}, {"sha": "c805c9eb125c882638b94eb3c7d7b20ee7072ff0", "filename": "src/test/ui/resolve/resolve-inconsistent-binding-mode.stderr", "status": "modified", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/c0a22a0209e82975614e51edc7927f4caedc886c/src%2Ftest%2Fui%2Fresolve%2Fresolve-inconsistent-binding-mode.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c0a22a0209e82975614e51edc7927f4caedc886c/src%2Ftest%2Fui%2Fresolve%2Fresolve-inconsistent-binding-mode.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fresolve%2Fresolve-inconsistent-binding-mode.stderr?ref=c0a22a0209e82975614e51edc7927f4caedc886c", "patch": "@@ -31,6 +31,10 @@ LL |         Opts::A(ref i) | Opts::B(i) => {}\n    |                 first introduced with type `&isize` here\n    |\n    = note: in the same arm, a binding must have the same type in all alternatives\n+help: consider adding `ref`\n+   |\n+LL |         Opts::A(ref i) | Opts::B(ref i) => {}\n+   |                                  +++\n \n error[E0308]: mismatched types\n   --> $DIR/resolve-inconsistent-binding-mode.rs:18:34\n@@ -43,6 +47,10 @@ LL |         Opts::A(ref i) | Opts::B(i) => {}\n    |                 first introduced with type `&isize` here\n    |\n    = note: in the same arm, a binding must have the same type in all alternatives\n+help: consider adding `ref`\n+   |\n+LL |         Opts::A(ref i) | Opts::B(ref i) => {}\n+   |                                  +++\n \n error[E0308]: mismatched types\n   --> $DIR/resolve-inconsistent-binding-mode.rs:27:38"}, {"sha": "9a40b20346c95e78539e07793260769e3a9f6f48", "filename": "src/test/ui/resolve/resolve-inconsistent-names.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/c0a22a0209e82975614e51edc7927f4caedc886c/src%2Ftest%2Fui%2Fresolve%2Fresolve-inconsistent-names.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c0a22a0209e82975614e51edc7927f4caedc886c/src%2Ftest%2Fui%2Fresolve%2Fresolve-inconsistent-names.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fresolve%2Fresolve-inconsistent-names.rs?ref=c0a22a0209e82975614e51edc7927f4caedc886c", "patch": "@@ -23,6 +23,7 @@ fn main() {\n         //~| ERROR mismatched types\n         //~| ERROR variable `c` is not bound in all patterns\n         //~| HELP if you meant to match on unit variant `E::A`, use the full path in the pattern\n+        //~| HELP consider removing `ref`\n     }\n \n     let z = (10, 20);"}, {"sha": "773c9f6cd1114800768a1c43b55f97210b5ff78b", "filename": "src/test/ui/resolve/resolve-inconsistent-names.stderr", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/c0a22a0209e82975614e51edc7927f4caedc886c/src%2Ftest%2Fui%2Fresolve%2Fresolve-inconsistent-names.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c0a22a0209e82975614e51edc7927f4caedc886c/src%2Ftest%2Fui%2Fresolve%2Fresolve-inconsistent-names.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fresolve%2Fresolve-inconsistent-names.stderr?ref=c0a22a0209e82975614e51edc7927f4caedc886c", "patch": "@@ -55,7 +55,7 @@ LL |         (A, B) | (ref B, c) | (c, A) => ()\n    |             first binding\n \n error[E0408]: variable `CONST1` is not bound in all patterns\n-  --> $DIR/resolve-inconsistent-names.rs:30:23\n+  --> $DIR/resolve-inconsistent-names.rs:31:23\n    |\n LL |         (CONST1, _) | (_, Const2) => ()\n    |          ------       ^^^^^^^^^^^ pattern doesn't bind `CONST1`\n@@ -69,7 +69,7 @@ LL |     const CONST1: usize = 10;\n    |     ^^^^^^^^^^^^^^^^^^^^^^^^^ not accessible\n \n error[E0408]: variable `Const2` is not bound in all patterns\n-  --> $DIR/resolve-inconsistent-names.rs:30:9\n+  --> $DIR/resolve-inconsistent-names.rs:31:9\n    |\n LL |         (CONST1, _) | (_, Const2) => ()\n    |         ^^^^^^^^^^^       ------ variable not in all patterns\n@@ -92,6 +92,11 @@ LL |         (A, B) | (ref B, c) | (c, A) => ()\n    |             first introduced with type `E` here\n    |\n    = note: in the same arm, a binding must have the same type in all alternatives\n+help: consider removing `ref`\n+   |\n+LL -         (A, B) | (ref B, c) | (c, A) => ()\n+LL +         (A, B) | (B, c) | (c, A) => ()\n+   |\n \n error: aborting due to 9 previous errors\n "}]}