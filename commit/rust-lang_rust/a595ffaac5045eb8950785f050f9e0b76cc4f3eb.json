{"sha": "a595ffaac5045eb8950785f050f9e0b76cc4f3eb", "node_id": "MDY6Q29tbWl0NzI0NzEyOmE1OTVmZmFhYzUwNDVlYjg5NTA3ODVmMDUwZjllMGI3NmNjNGYzZWI=", "commit": {"author": {"name": "Jeffrey Seyfried", "email": "jeffrey.seyfried@gmail.com", "date": "2016-06-24T03:25:37Z"}, "committer": {"name": "Jeffrey Seyfried", "email": "jeffrey.seyfried@gmail.com", "date": "2016-06-29T01:25:46Z"}, "message": "Treat `MultiDecorator`s as a special case of `MultiModifier`s", "tree": {"sha": "8a6773903bf03f503a5ea0abb66e85b3dbedf3d5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8a6773903bf03f503a5ea0abb66e85b3dbedf3d5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a595ffaac5045eb8950785f050f9e0b76cc4f3eb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a595ffaac5045eb8950785f050f9e0b76cc4f3eb", "html_url": "https://github.com/rust-lang/rust/commit/a595ffaac5045eb8950785f050f9e0b76cc4f3eb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a595ffaac5045eb8950785f050f9e0b76cc4f3eb/comments", "author": {"login": "jseyfried", "id": 8652869, "node_id": "MDQ6VXNlcjg2NTI4Njk=", "avatar_url": "https://avatars.githubusercontent.com/u/8652869?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jseyfried", "html_url": "https://github.com/jseyfried", "followers_url": "https://api.github.com/users/jseyfried/followers", "following_url": "https://api.github.com/users/jseyfried/following{/other_user}", "gists_url": "https://api.github.com/users/jseyfried/gists{/gist_id}", "starred_url": "https://api.github.com/users/jseyfried/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jseyfried/subscriptions", "organizations_url": "https://api.github.com/users/jseyfried/orgs", "repos_url": "https://api.github.com/users/jseyfried/repos", "events_url": "https://api.github.com/users/jseyfried/events{/privacy}", "received_events_url": "https://api.github.com/users/jseyfried/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jseyfried", "id": 8652869, "node_id": "MDQ6VXNlcjg2NTI4Njk=", "avatar_url": "https://avatars.githubusercontent.com/u/8652869?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jseyfried", "html_url": "https://github.com/jseyfried", "followers_url": "https://api.github.com/users/jseyfried/followers", "following_url": "https://api.github.com/users/jseyfried/following{/other_user}", "gists_url": "https://api.github.com/users/jseyfried/gists{/gist_id}", "starred_url": "https://api.github.com/users/jseyfried/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jseyfried/subscriptions", "organizations_url": "https://api.github.com/users/jseyfried/orgs", "repos_url": "https://api.github.com/users/jseyfried/repos", "events_url": "https://api.github.com/users/jseyfried/events{/privacy}", "received_events_url": "https://api.github.com/users/jseyfried/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "66ef652559ab670b4f7c3be973e019f0d55b3644", "url": "https://api.github.com/repos/rust-lang/rust/commits/66ef652559ab670b4f7c3be973e019f0d55b3644", "html_url": "https://github.com/rust-lang/rust/commit/66ef652559ab670b4f7c3be973e019f0d55b3644"}], "stats": {"total": 111, "additions": 33, "deletions": 78}, "files": [{"sha": "a10d8900140175244d4f64b108de19091a9a537d", "filename": "src/libsyntax/ext/expand.rs", "status": "modified", "additions": 33, "deletions": 78, "changes": 111, "blob_url": "https://github.com/rust-lang/rust/blob/a595ffaac5045eb8950785f050f9e0b76cc4f3eb/src%2Flibsyntax%2Fext%2Fexpand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a595ffaac5045eb8950785f050f9e0b76cc4f3eb/src%2Flibsyntax%2Fext%2Fexpand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibsyntax%2Fext%2Fexpand.rs?ref=a595ffaac5045eb8950785f050f9e0b76cc4f3eb", "patch": "@@ -691,7 +691,7 @@ impl<'a> Folder for PatIdentRenamer<'a> {\n }\n \n fn expand_multi_modified(a: Annotatable, fld: &mut MacroExpander) -> SmallVector<Annotatable> {\n-    let new_items: SmallVector<Annotatable> = match a {\n+    match a {\n         Annotatable::Item(it) => match it.node {\n             ast::ItemKind::Mac(..) => {\n                 it.and_then(|it| match it.node {\n@@ -728,63 +728,6 @@ fn expand_multi_modified(a: Annotatable, fld: &mut MacroExpander) -> SmallVector\n             expand_impl_item(ii.unwrap(), fld).into_iter().\n                 map(|ii| Annotatable::ImplItem(P(ii))).collect()\n         }\n-    };\n-\n-    new_items.into_iter().flat_map(|a| decorate(a, fld)).collect()\n-}\n-\n-fn decorate(a: Annotatable, fld: &mut MacroExpander) -> SmallVector<Annotatable> {\n-    let mut decorator_items = SmallVector::zero();\n-    let mut new_attrs = Vec::new();\n-    expand_decorators(a.clone(), fld, &mut decorator_items, &mut new_attrs);\n-\n-    let mut new_items = SmallVector::one(a.fold_attrs(new_attrs));\n-    new_items.push_all(decorator_items);\n-    new_items\n-}\n-\n-fn expand_decorators(a: Annotatable,\n-                     fld: &mut MacroExpander,\n-                     decorator_items: &mut SmallVector<Annotatable>,\n-                     new_attrs: &mut Vec<ast::Attribute>)\n-{\n-    for attr in a.attrs() {\n-        let mname = intern(&attr.name());\n-        match fld.cx.syntax_env.find(mname) {\n-            Some(rc) => match *rc {\n-                MultiDecorator(ref dec) => {\n-                    attr::mark_used(&attr);\n-\n-                    fld.cx.bt_push(ExpnInfo {\n-                        call_site: attr.span,\n-                        callee: NameAndSpan {\n-                            format: MacroAttribute(mname),\n-                            span: Some(attr.span),\n-                            // attributes can do whatever they like,\n-                            // for now.\n-                            allow_internal_unstable: true,\n-                        }\n-                    });\n-\n-                    let mut items: SmallVector<Annotatable> = SmallVector::zero();\n-                    dec.expand(fld.cx,\n-                               attr.span,\n-                               &attr.node.value,\n-                               &a,\n-                               &mut |ann| items.push(ann));\n-\n-                    for item in items {\n-                        for configured_item in item.fold_with(&mut fld.strip_unconfigured()) {\n-                            decorator_items.extend(expand_annotatable(configured_item, fld));\n-                        }\n-                    }\n-\n-                    fld.cx.bt_pop();\n-                }\n-                _ => new_attrs.push((*attr).clone()),\n-            },\n-            _ => new_attrs.push((*attr).clone()),\n-        }\n     }\n }\n \n@@ -793,9 +736,12 @@ fn expand_annotatable(mut item: Annotatable, fld: &mut MacroExpander) -> SmallVe\n     item = item.map_attrs(|mut attrs| {\n         for i in 0..attrs.len() {\n             if let Some(extension) = fld.cx.syntax_env.find(intern(&attrs[i].name())) {\n-                if let MultiModifier(..) = *extension {\n-                    multi_modifier = Some((attrs.remove(i), extension));\n-                    break;\n+                match *extension {\n+                    MultiModifier(..) | MultiDecorator(..) => {\n+                        multi_modifier = Some((attrs.remove(i), extension));\n+                        break;\n+                    }\n+                    _ => {}\n                 }\n             }\n         }\n@@ -804,23 +750,32 @@ fn expand_annotatable(mut item: Annotatable, fld: &mut MacroExpander) -> SmallVe\n \n     match multi_modifier {\n         None => expand_multi_modified(item, fld),\n-        Some((attr, extension)) => match *extension {\n-            MultiModifier(ref mac) => {\n-                attr::mark_used(&attr);\n-                fld.cx.bt_push(ExpnInfo {\n-                    call_site: attr.span,\n-                    callee: NameAndSpan {\n-                        format: MacroAttribute(intern(&attr.name())),\n-                        span: Some(attr.span),\n-                        // attributes can do whatever they like, for now\n-                        allow_internal_unstable: true,\n-                    }\n-                });\n-                let modified = mac.expand(fld.cx, attr.span, &attr.node.value, item);\n-                fld.cx.bt_pop();\n-                modified.into_iter().flat_map(|it| expand_annotatable(it, fld)).collect()\n-            }\n-            _ => unreachable!(),\n+        Some((attr, extension)) => {\n+            attr::mark_used(&attr);\n+            fld.cx.bt_push(ExpnInfo {\n+                call_site: attr.span,\n+                callee: NameAndSpan {\n+                    format: MacroAttribute(intern(&attr.name())),\n+                    span: Some(attr.span),\n+                    // attributes can do whatever they like, for now\n+                    allow_internal_unstable: true,\n+                }\n+            });\n+\n+            let modified = match *extension {\n+                MultiModifier(ref mac) => mac.expand(fld.cx, attr.span, &attr.node.value, item),\n+                MultiDecorator(ref mac) => {\n+                    let mut items = Vec::new();\n+                    mac.expand(fld.cx, attr.span, &attr.node.value, &item,\n+                               &mut |item| items.push(item));\n+                    items.push(item);\n+                    items\n+                }\n+                _ => unreachable!(),\n+            };\n+\n+            fld.cx.bt_pop();\n+            modified.into_iter().flat_map(|it| expand_annotatable(it, fld)).collect()\n         }\n     }\n }"}]}