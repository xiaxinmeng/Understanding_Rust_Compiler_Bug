{"sha": "3ddb78a34608848a60f6ca5b6ccfde8340302372", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNkZGI3OGEzNDYwODg0OGE2MGY2Y2E1YjZjY2ZkZTgzNDAzMDIzNzI=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-06-26T16:13:52Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-06-26T16:13:52Z"}, "message": "Auto merge of #86449 - Stupremee:render-self-cast-in-type-bound, r=GuillaumeGomez\n\nrustdoc: Render `<Self as X>::Y` type casts properly across crate bounds\n\nMy last PR that introduced the type casting did not work for cross-crate re-exported traits, which is fixed in this PR.\n\nFully resolves #85454", "tree": {"sha": "0a83949d4e595cd47c6e09c51f5ce8e13af51dda", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0a83949d4e595cd47c6e09c51f5ce8e13af51dda"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3ddb78a34608848a60f6ca5b6ccfde8340302372", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3ddb78a34608848a60f6ca5b6ccfde8340302372", "html_url": "https://github.com/rust-lang/rust/commit/3ddb78a34608848a60f6ca5b6ccfde8340302372", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3ddb78a34608848a60f6ca5b6ccfde8340302372/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f2571a2dd68ff1d84b5df07cb38831627df6aaff", "url": "https://api.github.com/repos/rust-lang/rust/commits/f2571a2dd68ff1d84b5df07cb38831627df6aaff", "html_url": "https://github.com/rust-lang/rust/commit/f2571a2dd68ff1d84b5df07cb38831627df6aaff"}, {"sha": "f14bdb506a89afaf634b68a4292ad9cf6014f60c", "url": "https://api.github.com/repos/rust-lang/rust/commits/f14bdb506a89afaf634b68a4292ad9cf6014f60c", "html_url": "https://github.com/rust-lang/rust/commit/f14bdb506a89afaf634b68a4292ad9cf6014f60c"}], "stats": {"total": 52, "additions": 48, "deletions": 4}, "files": [{"sha": "6abe1c7cd61a9921d46a4bf4be1650f0e34f326c", "filename": "src/librustdoc/clean/mod.rs", "status": "modified", "additions": 18, "deletions": 3, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/3ddb78a34608848a60f6ca5b6ccfde8340302372/src%2Flibrustdoc%2Fclean%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3ddb78a34608848a60f6ca5b6ccfde8340302372/src%2Flibrustdoc%2Fclean%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Fmod.rs?ref=3ddb78a34608848a60f6ca5b6ccfde8340302372", "patch": "@@ -20,7 +20,7 @@ use rustc_infer::infer::region_constraints::{Constraint, RegionConstraintData};\n use rustc_middle::middle::resolve_lifetime as rl;\n use rustc_middle::ty::fold::TypeFolder;\n use rustc_middle::ty::subst::{InternalSubsts, Subst};\n-use rustc_middle::ty::{self, AdtKind, Lift, Ty, TyCtxt};\n+use rustc_middle::ty::{self, AdtKind, DefIdTree, Lift, Ty, TyCtxt};\n use rustc_middle::{bug, span_bug};\n use rustc_mir::const_eval::{is_const_fn, is_unstable_const_fn};\n use rustc_span::hygiene::{AstPass, MacroKind};\n@@ -438,8 +438,23 @@ impl Clean<GenericParamDef> for ty::GenericParamDef {\n         let (name, kind) = match self.kind {\n             ty::GenericParamDefKind::Lifetime => (self.name, GenericParamDefKind::Lifetime),\n             ty::GenericParamDefKind::Type { has_default, synthetic, .. } => {\n-                let default =\n-                    if has_default { Some(cx.tcx.type_of(self.def_id).clean(cx)) } else { None };\n+                let default = if has_default {\n+                    let mut default = cx.tcx.type_of(self.def_id).clean(cx);\n+\n+                    // We need to reassign the `self_def_id`, if there's a parent (which is the\n+                    // `Self` type), so we can properly render `<Self as X>` casts, because the\n+                    // information about which type `Self` is, is only present here, but not in\n+                    // the cleaning process of the type itself. To resolve this and have the\n+                    // `self_def_id` set, we override it here.\n+                    // See https://github.com/rust-lang/rust/issues/85454\n+                    if let QPath { ref mut self_def_id, .. } = default {\n+                        *self_def_id = cx.tcx.parent(self.def_id);\n+                    }\n+\n+                    Some(default)\n+                } else {\n+                    None\n+                };\n                 (\n                     self.name,\n                     GenericParamDefKind::Type {"}, {"sha": "45664dfc3823da490d5625df87efdb3c2594b43e", "filename": "src/test/rustdoc/auxiliary/issue-85454.rs", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/3ddb78a34608848a60f6ca5b6ccfde8340302372/src%2Ftest%2Frustdoc%2Fauxiliary%2Fissue-85454.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3ddb78a34608848a60f6ca5b6ccfde8340302372/src%2Ftest%2Frustdoc%2Fauxiliary%2Fissue-85454.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fauxiliary%2Fissue-85454.rs?ref=3ddb78a34608848a60f6ca5b6ccfde8340302372", "patch": "@@ -0,0 +1,17 @@\n+// @has issue_85454/trait.FromResidual.html\n+// @has - '//pre[@class=\"rust trait\"]' 'pub trait FromResidual<R = <Self as Try>::Residual> { fn from_residual(residual: R) -> Self; }'\n+pub trait FromResidual<R = <Self as Try>::Residual> {\n+    fn from_residual(residual: R) -> Self;\n+}\n+\n+pub trait Try: FromResidual {\n+    type Output;\n+    type Residual;\n+    fn from_output(output: Self::Output) -> Self;\n+    fn branch(self) -> ControlFlow<Self::Residual, Self::Output>;\n+}\n+\n+pub enum ControlFlow<B, C = ()> {\n+    Continue(C),\n+    Break(B),\n+}"}, {"sha": "3351b5c8350fd7284ac0e7d2598e5c866ee7c9a7", "filename": "src/test/rustdoc/issue-85454.rs", "status": "modified", "additions": 13, "deletions": 1, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/3ddb78a34608848a60f6ca5b6ccfde8340302372/src%2Ftest%2Frustdoc%2Fissue-85454.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3ddb78a34608848a60f6ca5b6ccfde8340302372/src%2Ftest%2Frustdoc%2Fissue-85454.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fissue-85454.rs?ref=3ddb78a34608848a60f6ca5b6ccfde8340302372", "patch": "@@ -1,4 +1,10 @@\n-// @has issue_85454/trait.FromResidual.html\n+// aux-build:issue-85454.rs\n+// build-aux-docs\n+#![crate_name = \"foo\"]\n+\n+extern crate issue_85454;\n+\n+// @has foo/trait.FromResidual.html\n // @has - '//pre[@class=\"rust trait\"]' 'pub trait FromResidual<R = <Self as Try>::Residual> { fn from_residual(residual: R) -> Self; }'\n pub trait FromResidual<R = <Self as Try>::Residual> {\n     fn from_residual(residual: R) -> Self;\n@@ -15,3 +21,9 @@ pub enum ControlFlow<B, C = ()> {\n     Continue(C),\n     Break(B),\n }\n+\n+pub mod reexport {\n+    // @has foo/reexport/trait.FromResidual.html\n+    // @has - '//pre[@class=\"rust trait\"]' 'pub trait FromResidual<R = <Self as Try>::Residual> { fn from_residual(residual: R) -> Self; }'\n+    pub use issue_85454::*;\n+}"}]}