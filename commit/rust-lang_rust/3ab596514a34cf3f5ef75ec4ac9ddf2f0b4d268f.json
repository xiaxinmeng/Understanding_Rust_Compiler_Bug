{"sha": "3ab596514a34cf3f5ef75ec4ac9ddf2f0b4d268f", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNhYjU5NjUxNGEzNGNmM2Y1ZWY3NWVjNGFjOWRkZjJmMGI0ZDI2OGY=", "commit": {"author": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2020-02-22T00:00:00Z"}, "committer": {"name": "Tomasz Mi\u0105sko", "email": "tomasz.miasko@gmail.com", "date": "2020-03-03T12:11:19Z"}, "message": "Improve linking of crates with circular dependencies\n\nPreviously, the code responsible for handling the cycles between crates\nintroduces through weak lang items, would keep a set of missing language\nitems:\n\n* extending it with items missing from the current crate,\n* removing items provided by the current crate,\n* grouping the crates when the set changed from non-empty back to empty.\n\nThis could produce incorrect results, if a lang item was missing from a\ncrate that comes after the crate that provides it (in the loop iteration\norder). In that case the grouping would not take place.\n\nThe changes here address this specific failure scenario by keeping track\nof two separate sets of crates. Those that are required to link successfully,\nand those that are available for linking.\n\nVerified using test case from 69368.", "tree": {"sha": "0fda33f41303d506e29c0646fc6910b115493e84", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0fda33f41303d506e29c0646fc6910b115493e84"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3ab596514a34cf3f5ef75ec4ac9ddf2f0b4d268f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3ab596514a34cf3f5ef75ec4ac9ddf2f0b4d268f", "html_url": "https://github.com/rust-lang/rust/commit/3ab596514a34cf3f5ef75ec4ac9ddf2f0b4d268f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3ab596514a34cf3f5ef75ec4ac9ddf2f0b4d268f/comments", "author": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tmiasko", "id": 51362316, "node_id": "MDQ6VXNlcjUxMzYyMzE2", "avatar_url": "https://avatars.githubusercontent.com/u/51362316?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tmiasko", "html_url": "https://github.com/tmiasko", "followers_url": "https://api.github.com/users/tmiasko/followers", "following_url": "https://api.github.com/users/tmiasko/following{/other_user}", "gists_url": "https://api.github.com/users/tmiasko/gists{/gist_id}", "starred_url": "https://api.github.com/users/tmiasko/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tmiasko/subscriptions", "organizations_url": "https://api.github.com/users/tmiasko/orgs", "repos_url": "https://api.github.com/users/tmiasko/repos", "events_url": "https://api.github.com/users/tmiasko/events{/privacy}", "received_events_url": "https://api.github.com/users/tmiasko/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9381e8178b49636d4604e4ec0f1263960691c958", "url": "https://api.github.com/repos/rust-lang/rust/commits/9381e8178b49636d4604e4ec0f1263960691c958", "html_url": "https://github.com/rust-lang/rust/commit/9381e8178b49636d4604e4ec0f1263960691c958"}], "stats": {"total": 22, "additions": 15, "deletions": 7}, "files": [{"sha": "847b5b81d5adce4a140eb18cbfb909bc4d64fe42", "filename": "src/librustc_codegen_ssa/back/link.rs", "status": "modified", "additions": 15, "deletions": 7, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/3ab596514a34cf3f5ef75ec4ac9ddf2f0b4d268f/src%2Flibrustc_codegen_ssa%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3ab596514a34cf3f5ef75ec4ac9ddf2f0b4d268f/src%2Flibrustc_codegen_ssa%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fback%2Flink.rs?ref=3ab596514a34cf3f5ef75ec4ac9ddf2f0b4d268f", "patch": "@@ -1519,17 +1519,25 @@ fn add_upstream_rust_crates<'a, B: ArchiveBuilder<'a>>(\n     // for the current implementation of the standard library.\n     let mut group_end = None;\n     let mut group_start = None;\n-    let mut end_with = FxHashSet::default();\n+    // Crates available for linking thus far.\n+    let mut available = FxHashSet::default();\n+    // Crates required to satisfy dependencies discovered so far.\n+    let mut required = FxHashSet::default();\n+\n     let info = &codegen_results.crate_info;\n     for &(cnum, _) in deps.iter().rev() {\n         if let Some(missing) = info.missing_lang_items.get(&cnum) {\n-            end_with.extend(missing.iter().cloned());\n-            if !end_with.is_empty() && group_end.is_none() {\n-                group_end = Some(cnum);\n-            }\n+            let missing_crates = missing.iter().map(|i| info.lang_item_to_crate.get(i).copied());\n+            required.extend(missing_crates);\n+        }\n+\n+        required.insert(Some(cnum));\n+        available.insert(Some(cnum));\n+\n+        if required.len() > available.len() && group_end.is_none() {\n+            group_end = Some(cnum);\n         }\n-        end_with.retain(|item| info.lang_item_to_crate.get(item) != Some(&cnum));\n-        if end_with.is_empty() && group_end.is_some() {\n+        if required.len() == available.len() && group_end.is_some() {\n             group_start = Some(cnum);\n             break;\n         }"}]}