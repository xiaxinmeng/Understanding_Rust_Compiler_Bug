{"sha": "6f1d9ba581dbf1282825e87424021d8c4cb7ba54", "node_id": "C_kwDOAAsO6NoAKDZmMWQ5YmE1ODFkYmYxMjgyODI1ZTg3NDI0MDIxZDhjNGNiN2JhNTQ", "commit": {"author": {"name": "Joshua Nelson", "email": "github@jyn.dev", "date": "2023-01-03T03:39:41Z"}, "committer": {"name": "Joshua Nelson", "email": "github@jyn.dev", "date": "2023-01-03T03:40:58Z"}, "message": "Allow passing a specific date to `bump-stage0`\n\nThis allows regenerating `src/stage0.json` on changes to the tool,\nwithout needing to hard-code the date in the source.", "tree": {"sha": "d4962543905dc4b9fcee11a3fc3bd6c793c2edec", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d4962543905dc4b9fcee11a3fc3bd6c793c2edec"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6f1d9ba581dbf1282825e87424021d8c4cb7ba54", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6f1d9ba581dbf1282825e87424021d8c4cb7ba54", "html_url": "https://github.com/rust-lang/rust/commit/6f1d9ba581dbf1282825e87424021d8c4cb7ba54", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6f1d9ba581dbf1282825e87424021d8c4cb7ba54/comments", "author": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jyn514", "id": 23638587, "node_id": "MDQ6VXNlcjIzNjM4NTg3", "avatar_url": "https://avatars.githubusercontent.com/u/23638587?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jyn514", "html_url": "https://github.com/jyn514", "followers_url": "https://api.github.com/users/jyn514/followers", "following_url": "https://api.github.com/users/jyn514/following{/other_user}", "gists_url": "https://api.github.com/users/jyn514/gists{/gist_id}", "starred_url": "https://api.github.com/users/jyn514/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jyn514/subscriptions", "organizations_url": "https://api.github.com/users/jyn514/orgs", "repos_url": "https://api.github.com/users/jyn514/repos", "events_url": "https://api.github.com/users/jyn514/events{/privacy}", "received_events_url": "https://api.github.com/users/jyn514/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "77429957a0e9c90a26c89def061ffdd4bae5ccb9", "url": "https://api.github.com/repos/rust-lang/rust/commits/77429957a0e9c90a26c89def061ffdd4bae5ccb9", "html_url": "https://github.com/rust-lang/rust/commit/77429957a0e9c90a26c89def061ffdd4bae5ccb9"}], "stats": {"total": 28, "additions": 17, "deletions": 11}, "files": [{"sha": "e0280854541a0d95b6979a84b2157c8e1966e55f", "filename": "src/bootstrap/run.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/6f1d9ba581dbf1282825e87424021d8c4cb7ba54/src%2Fbootstrap%2Frun.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6f1d9ba581dbf1282825e87424021d8c4cb7ba54/src%2Fbootstrap%2Frun.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Frun.rs?ref=6f1d9ba581dbf1282825e87424021d8c4cb7ba54", "patch": "@@ -105,6 +105,7 @@ impl Step for BumpStage0 {\n \n     fn run(self, builder: &Builder<'_>) -> Self::Output {\n         let mut cmd = builder.tool_cmd(Tool::BumpStage0);\n+        cmd.args(builder.config.cmd.args());\n         builder.run(&mut cmd);\n     }\n }"}, {"sha": "530a80b1ed374523894a2a23c5775f2cf8b9d78d", "filename": "src/tools/bump-stage0/src/main.rs", "status": "modified", "additions": 16, "deletions": 11, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/6f1d9ba581dbf1282825e87424021d8c4cb7ba54/src%2Ftools%2Fbump-stage0%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6f1d9ba581dbf1282825e87424021d8c4cb7ba54/src%2Ftools%2Fbump-stage0%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fbump-stage0%2Fsrc%2Fmain.rs?ref=6f1d9ba581dbf1282825e87424021d8c4cb7ba54", "patch": "@@ -1,4 +1,4 @@\n-use anyhow::Error;\n+use anyhow::{Context, Error};\n use curl::easy::Easy;\n use indexmap::IndexMap;\n use std::collections::HashMap;\n@@ -13,12 +13,13 @@ struct Tool {\n     comments: Vec<String>,\n \n     channel: Channel,\n+    date: Option<String>,\n     version: [u16; 3],\n     checksums: IndexMap<String, String>,\n }\n \n impl Tool {\n-    fn new() -> Result<Self, Error> {\n+    fn new(date: Option<String>) -> Result<Self, Error> {\n         let channel = match std::fs::read_to_string(\"src/ci/channel\")?.trim() {\n             \"stable\" => Channel::Stable,\n             \"beta\" => Channel::Beta,\n@@ -40,6 +41,7 @@ impl Tool {\n         Ok(Self {\n             channel,\n             version,\n+            date,\n             config: existing.config,\n             comments: existing.comments,\n             checksums: IndexMap::new(),\n@@ -84,7 +86,7 @@ impl Tool {\n             Channel::Nightly => \"beta\".to_string(),\n         };\n \n-        let manifest = fetch_manifest(&self.config, &channel)?;\n+        let manifest = fetch_manifest(&self.config, &channel, self.date.as_deref())?;\n         self.collect_checksums(&manifest, COMPILER_COMPONENTS)?;\n         Ok(Stage0Toolchain {\n             date: manifest.date,\n@@ -110,7 +112,7 @@ impl Tool {\n             return Ok(None);\n         }\n \n-        let manifest = fetch_manifest(&self.config, \"nightly\")?;\n+        let manifest = fetch_manifest(&self.config, \"nightly\", self.date.as_deref())?;\n         self.collect_checksums(&manifest, RUSTFMT_COMPONENTS)?;\n         Ok(Some(Stage0Toolchain { date: manifest.date, version: \"nightly\".into() }))\n     }\n@@ -141,16 +143,19 @@ impl Tool {\n }\n \n fn main() -> Result<(), Error> {\n-    let tool = Tool::new()?;\n+    let tool = Tool::new(std::env::args().nth(1))?;\n     tool.update_json()?;\n     Ok(())\n }\n \n-fn fetch_manifest(config: &Config, channel: &str) -> Result<Manifest, Error> {\n-    Ok(toml::from_slice(&http_get(&format!(\n-        \"{}/dist/channel-rust-{}.toml\",\n-        config.dist_server, channel\n-    ))?)?)\n+fn fetch_manifest(config: &Config, channel: &str, date: Option<&str>) -> Result<Manifest, Error> {\n+    let url = if let Some(date) = date {\n+        format!(\"{}/dist/{}/channel-rust-{}.toml\", config.dist_server, date, channel)\n+    } else {\n+        format!(\"{}/dist/channel-rust-{}.toml\", config.dist_server, channel)\n+    };\n+\n+    Ok(toml::from_slice(&http_get(&url)?)?)\n }\n \n fn http_get(url: &str) -> Result<Vec<u8>, Error> {\n@@ -164,7 +169,7 @@ fn http_get(url: &str) -> Result<Vec<u8>, Error> {\n             data.extend_from_slice(new_data);\n             Ok(new_data.len())\n         })?;\n-        transfer.perform()?;\n+        transfer.perform().context(format!(\"failed to fetch {url}\"))?;\n     }\n     Ok(data)\n }"}]}