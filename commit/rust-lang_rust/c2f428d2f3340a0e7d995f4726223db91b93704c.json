{"sha": "c2f428d2f3340a0e7d995f4726223db91b93704c", "node_id": "C_kwDOAAsO6NoAKGMyZjQyOGQyZjMzNDBhMGU3ZDk5NWY0NzI2MjIzZGI5MWI5MzcwNGM", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-07-14T19:03:58Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-07-14T19:03:58Z"}, "message": "Auto merge of #99252 - lqd:win-dwarf5, r=eddyb\n\nfix dwarf debuginfo being used in addition to CodeView on windows\n\nTackles the debuginfo size increase regression on windows to [unblock clippy](https://github.com/rust-lang/rust/issues/99143#issuecomment-1184638573) -- introduced by the DWARF5 support in #98350 cc `@pcwalton.`\n\nr? `@eddyb`\nFixes #99143", "tree": {"sha": "7f2158ac4e1082229f37b97262ba0fa5032fabec", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/7f2158ac4e1082229f37b97262ba0fa5032fabec"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c2f428d2f3340a0e7d995f4726223db91b93704c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c2f428d2f3340a0e7d995f4726223db91b93704c", "html_url": "https://github.com/rust-lang/rust/commit/c2f428d2f3340a0e7d995f4726223db91b93704c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c2f428d2f3340a0e7d995f4726223db91b93704c/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "74621c764e737a1a430bac088b5507a8854ec460", "url": "https://api.github.com/repos/rust-lang/rust/commits/74621c764e737a1a430bac088b5507a8854ec460", "html_url": "https://github.com/rust-lang/rust/commit/74621c764e737a1a430bac088b5507a8854ec460"}, {"sha": "97510f212852d4733c4c6ffafcaa7e488c5fcb19", "url": "https://api.github.com/repos/rust-lang/rust/commits/97510f212852d4733c4c6ffafcaa7e488c5fcb19", "html_url": "https://github.com/rust-lang/rust/commit/97510f212852d4733c4c6ffafcaa7e488c5fcb19"}], "stats": {"total": 37, "additions": 20, "deletions": 17}, "files": [{"sha": "cf591295b84680b57c660219f07e891a0c09a821", "filename": "compiler/rustc_codegen_llvm/src/debuginfo/mod.rs", "status": "modified", "additions": 20, "deletions": 17, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/c2f428d2f3340a0e7d995f4726223db91b93704c/compiler%2Frustc_codegen_llvm%2Fsrc%2Fdebuginfo%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c2f428d2f3340a0e7d995f4726223db91b93704c/compiler%2Frustc_codegen_llvm%2Fsrc%2Fdebuginfo%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fdebuginfo%2Fmod.rs?ref=c2f428d2f3340a0e7d995f4726223db91b93704c", "patch": "@@ -97,23 +97,26 @@ impl<'ll, 'tcx> CodegenUnitDebugContext<'ll, 'tcx> {\n         unsafe {\n             llvm::LLVMRustDIBuilderFinalize(self.builder);\n \n-            // Debuginfo generation in LLVM by default uses a higher\n-            // version of dwarf than macOS currently understands. We can\n-            // instruct LLVM to emit an older version of dwarf, however,\n-            // for macOS to understand. For more info see #11352\n-            // This can be overridden using --llvm-opts -dwarf-version,N.\n-            // Android has the same issue (#22398)\n-            let dwarf_version =\n-                sess.opts.unstable_opts.dwarf_version.unwrap_or(sess.target.default_dwarf_version);\n-            llvm::LLVMRustAddModuleFlag(\n-                self.llmod,\n-                llvm::LLVMModFlagBehavior::Warning,\n-                \"Dwarf Version\\0\".as_ptr().cast(),\n-                dwarf_version,\n-            );\n-\n-            // Indicate that we want CodeView debug information on MSVC\n-            if sess.target.is_like_msvc {\n+            if !sess.target.is_like_msvc {\n+                // Debuginfo generation in LLVM by default uses a higher\n+                // version of dwarf than macOS currently understands. We can\n+                // instruct LLVM to emit an older version of dwarf, however,\n+                // for macOS to understand. For more info see #11352\n+                // This can be overridden using --llvm-opts -dwarf-version,N.\n+                // Android has the same issue (#22398)\n+                let dwarf_version = sess\n+                    .opts\n+                    .unstable_opts\n+                    .dwarf_version\n+                    .unwrap_or(sess.target.default_dwarf_version);\n+                llvm::LLVMRustAddModuleFlag(\n+                    self.llmod,\n+                    llvm::LLVMModFlagBehavior::Warning,\n+                    \"Dwarf Version\\0\".as_ptr().cast(),\n+                    dwarf_version,\n+                );\n+            } else {\n+                // Indicate that we want CodeView debug information on MSVC\n                 llvm::LLVMRustAddModuleFlag(\n                     self.llmod,\n                     llvm::LLVMModFlagBehavior::Warning,"}]}