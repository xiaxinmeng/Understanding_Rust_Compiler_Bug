{"sha": "e3b171dcf099fbb7e7d3bd2cb28b11f7d3fb2773", "node_id": "MDY6Q29tbWl0NzI0NzEyOmUzYjE3MWRjZjA5OWZiYjdlN2QzYmQyY2IyOGIxMWY3ZDNmYjI3NzM=", "commit": {"author": {"name": "Cameron Steffen", "email": "cam.steffen94@gmail.com", "date": "2021-09-08T15:55:08Z"}, "committer": {"name": "Cameron Steffen", "email": "cam.steffen94@gmail.com", "date": "2021-09-08T19:07:03Z"}, "message": "Use relative exe paths", "tree": {"sha": "475e6a1811e833c21909042ba7060b5f61e37b3b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/475e6a1811e833c21909042ba7060b5f61e37b3b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e3b171dcf099fbb7e7d3bd2cb28b11f7d3fb2773", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e3b171dcf099fbb7e7d3bd2cb28b11f7d3fb2773", "html_url": "https://github.com/rust-lang/rust/commit/e3b171dcf099fbb7e7d3bd2cb28b11f7d3fb2773", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e3b171dcf099fbb7e7d3bd2cb28b11f7d3fb2773/comments", "author": {"login": "camsteffen", "id": 5565418, "node_id": "MDQ6VXNlcjU1NjU0MTg=", "avatar_url": "https://avatars.githubusercontent.com/u/5565418?v=4", "gravatar_id": "", "url": "https://api.github.com/users/camsteffen", "html_url": "https://github.com/camsteffen", "followers_url": "https://api.github.com/users/camsteffen/followers", "following_url": "https://api.github.com/users/camsteffen/following{/other_user}", "gists_url": "https://api.github.com/users/camsteffen/gists{/gist_id}", "starred_url": "https://api.github.com/users/camsteffen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/camsteffen/subscriptions", "organizations_url": "https://api.github.com/users/camsteffen/orgs", "repos_url": "https://api.github.com/users/camsteffen/repos", "events_url": "https://api.github.com/users/camsteffen/events{/privacy}", "received_events_url": "https://api.github.com/users/camsteffen/received_events", "type": "User", "site_admin": false}, "committer": {"login": "camsteffen", "id": 5565418, "node_id": "MDQ6VXNlcjU1NjU0MTg=", "avatar_url": "https://avatars.githubusercontent.com/u/5565418?v=4", "gravatar_id": "", "url": "https://api.github.com/users/camsteffen", "html_url": "https://github.com/camsteffen", "followers_url": "https://api.github.com/users/camsteffen/followers", "following_url": "https://api.github.com/users/camsteffen/following{/other_user}", "gists_url": "https://api.github.com/users/camsteffen/gists{/gist_id}", "starred_url": "https://api.github.com/users/camsteffen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/camsteffen/subscriptions", "organizations_url": "https://api.github.com/users/camsteffen/orgs", "repos_url": "https://api.github.com/users/camsteffen/repos", "events_url": "https://api.github.com/users/camsteffen/events{/privacy}", "received_events_url": "https://api.github.com/users/camsteffen/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2e15c8054d7f26bf438a84a7e6a7fd34f540444f", "url": "https://api.github.com/repos/rust-lang/rust/commits/2e15c8054d7f26bf438a84a7e6a7fd34f540444f", "html_url": "https://github.com/rust-lang/rust/commit/2e15c8054d7f26bf438a84a7e6a7fd34f540444f"}], "stats": {"total": 44, "additions": 14, "deletions": 30}, "files": [{"sha": "19153aa74d0b8956dfdeb3c14fa7033cbd2ce448", "filename": "clippy_dev/src/bless.rs", "status": "modified", "additions": 2, "deletions": 11, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/e3b171dcf099fbb7e7d3bd2cb28b11f7d3fb2773/clippy_dev%2Fsrc%2Fbless.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e3b171dcf099fbb7e7d3bd2cb28b11f7d3fb2773/clippy_dev%2Fsrc%2Fbless.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_dev%2Fsrc%2Fbless.rs?ref=e3b171dcf099fbb7e7d3bd2cb28b11f7d3fb2773", "patch": "@@ -1,7 +1,6 @@\n //! `bless` updates the reference files in the repo with changed output files\n //! from the last test run.\n \n-use std::env;\n use std::ffi::OsStr;\n use std::fs;\n use std::lazy::SyncLazy;\n@@ -10,17 +9,9 @@ use walkdir::WalkDir;\n \n use crate::clippy_project_root;\n \n-// NOTE: this is duplicated with tests/cargo/mod.rs What to do?\n-pub static CARGO_TARGET_DIR: SyncLazy<PathBuf> = SyncLazy::new(|| match env::var_os(\"CARGO_TARGET_DIR\") {\n-    Some(v) => v.into(),\n-    None => env::current_dir().unwrap().join(\"target\"),\n-});\n-\n static CLIPPY_BUILD_TIME: SyncLazy<Option<std::time::SystemTime>> = SyncLazy::new(|| {\n-    let profile = env::var(\"PROFILE\").unwrap_or_else(|_| \"debug\".to_string());\n-    let mut path = PathBuf::from(&**CARGO_TARGET_DIR);\n-    path.push(profile);\n-    path.push(\"cargo-clippy\");\n+    let mut path = std::env::current_exe().unwrap();\n+    path.set_file_name(\"cargo-clippy\");\n     fs::metadata(path).ok()?.modified().ok()\n });\n "}, {"sha": "1f3ce557eb45a4440d306dcbee697f6ce6096c87", "filename": "tests/cargo/mod.rs", "status": "modified", "additions": 0, "deletions": 13, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/e3b171dcf099fbb7e7d3bd2cb28b11f7d3fb2773/tests%2Fcargo%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e3b171dcf099fbb7e7d3bd2cb28b11f7d3fb2773/tests%2Fcargo%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcargo%2Fmod.rs?ref=e3b171dcf099fbb7e7d3bd2cb28b11f7d3fb2773", "patch": "@@ -7,19 +7,6 @@ pub static CARGO_TARGET_DIR: SyncLazy<PathBuf> = SyncLazy::new(|| match env::var\n     None => env::current_dir().unwrap().join(\"target\"),\n });\n \n-pub static TARGET_LIB: SyncLazy<PathBuf> = SyncLazy::new(|| {\n-    if let Some(path) = option_env!(\"TARGET_LIBS\") {\n-        path.into()\n-    } else {\n-        let mut dir = CARGO_TARGET_DIR.clone();\n-        if let Some(target) = env::var_os(\"CARGO_BUILD_TARGET\") {\n-            dir.push(target);\n-        }\n-        dir.push(env!(\"PROFILE\"));\n-        dir\n-    }\n-});\n-\n #[must_use]\n pub fn is_rustc_test_suite() -> bool {\n     option_env!(\"RUSTC_TEST_SUITE\").is_some()"}, {"sha": "2641fb812348616ac591486cb7ad5690daaa5e27", "filename": "tests/compile-test.rs", "status": "modified", "additions": 6, "deletions": 5, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/e3b171dcf099fbb7e7d3bd2cb28b11f7d3fb2773/tests%2Fcompile-test.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e3b171dcf099fbb7e7d3bd2cb28b11f7d3fb2773/tests%2Fcompile-test.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fcompile-test.rs?ref=e3b171dcf099fbb7e7d3bd2cb28b11f7d3fb2773", "patch": "@@ -50,10 +50,6 @@ fn host_lib() -> PathBuf {\n     option_env!(\"HOST_LIBS\").map_or(cargo::CARGO_TARGET_DIR.join(env!(\"PROFILE\")), PathBuf::from)\n }\n \n-fn clippy_driver_path() -> PathBuf {\n-    option_env!(\"CLIPPY_DRIVER_PATH\").map_or(cargo::TARGET_LIB.join(\"clippy-driver\"), PathBuf::from)\n-}\n-\n /// Produces a string with an `--extern` flag for all UI test crate\n /// dependencies.\n ///\n@@ -122,6 +118,7 @@ fn default_config() -> compiletest::Config {\n     }\n     let current_exe_path = std::env::current_exe().unwrap();\n     let deps_path = current_exe_path.parent().unwrap();\n+    let profile_path = deps_path.parent().unwrap();\n \n     // Using `-L dependency={}` enforces that external dependencies are added with `--extern`.\n     // This is valuable because a) it allows us to monitor what external dependencies are used\n@@ -137,7 +134,11 @@ fn default_config() -> compiletest::Config {\n     ));\n \n     config.build_base = host_lib().join(\"test_build_base\");\n-    config.rustc_path = clippy_driver_path();\n+    config.rustc_path = profile_path.join(if cfg!(windows) {\n+        \"clippy-driver.exe\"\n+    } else {\n+        \"clippy-driver\"\n+    });\n     config\n }\n "}, {"sha": "4190dfcfe6df8ae4ee98e42b8576047f20bf8117", "filename": "tests/dogfood.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/e3b171dcf099fbb7e7d3bd2cb28b11f7d3fb2773/tests%2Fdogfood.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e3b171dcf099fbb7e7d3bd2cb28b11f7d3fb2773/tests%2Fdogfood.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fdogfood.rs?ref=e3b171dcf099fbb7e7d3bd2cb28b11f7d3fb2773", "patch": "@@ -15,7 +15,12 @@ use std::process::Command;\n \n mod cargo;\n \n-static CLIPPY_PATH: SyncLazy<PathBuf> = SyncLazy::new(|| cargo::TARGET_LIB.join(\"cargo-clippy\"));\n+static CLIPPY_PATH: SyncLazy<PathBuf> = SyncLazy::new(|| {\n+    let mut path = std::env::current_exe().unwrap();\n+    assert!(path.pop()); // deps\n+    path.set_file_name(\"cargo-clippy\");\n+    path\n+});\n \n #[test]\n fn dogfood_clippy() {"}]}