{"sha": "d6f3a4ecb48ead838638e902f2fa4e5f3059779b", "node_id": "C_kwDOAAsO6NoAKGQ2ZjNhNGVjYjQ4ZWFkODM4NjM4ZTkwMmYyZmE0ZTVmMzA1OTc3OWI", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-03-18T03:01:46Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-03-18T03:01:46Z"}, "message": "Auto merge of #88098 - Amanieu:oom_panic, r=nagisa\n\nImplement -Z oom=panic\n\nThis PR removes the `#[rustc_allocator_nounwind]` attribute on `alloc_error_handler` which allows it to unwind with a panic instead of always aborting. This is then used to implement `-Z oom=panic` as per RFC 2116 (tracking issue #43596).\n\nPerf and binary size tests show negligible impact.", "tree": {"sha": "a0ced664fbcf095dac8d3b0a498b9ce8b335cb53", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a0ced664fbcf095dac8d3b0a498b9ce8b335cb53"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d6f3a4ecb48ead838638e902f2fa4e5f3059779b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d6f3a4ecb48ead838638e902f2fa4e5f3059779b", "html_url": "https://github.com/rust-lang/rust/commit/d6f3a4ecb48ead838638e902f2fa4e5f3059779b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d6f3a4ecb48ead838638e902f2fa4e5f3059779b/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cd119057160cedea245aa2679add56723f3dc784", "url": "https://api.github.com/repos/rust-lang/rust/commits/cd119057160cedea245aa2679add56723f3dc784", "html_url": "https://github.com/rust-lang/rust/commit/cd119057160cedea245aa2679add56723f3dc784"}, {"sha": "0254e318b820d79bb448d4d22d93e345e67b25eb", "url": "https://api.github.com/repos/rust-lang/rust/commits/0254e318b820d79bb448d4d22d93e345e67b25eb", "html_url": "https://github.com/rust-lang/rust/commit/0254e318b820d79bb448d4d22d93e345e67b25eb"}], "stats": {"total": 124, "additions": 114, "deletions": 10}, "files": [{"sha": "c3b99b64263f2988585865eba773efbab4b8eb1d", "filename": "compiler/rustc_codegen_cranelift/src/allocator.rs", "status": "modified", "additions": 16, "deletions": 1, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/d6f3a4ecb48ead838638e902f2fa4e5f3059779b/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fallocator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d6f3a4ecb48ead838638e902f2fa4e5f3059779b/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fallocator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_cranelift%2Fsrc%2Fallocator.rs?ref=d6f3a4ecb48ead838638e902f2fa4e5f3059779b", "patch": "@@ -4,6 +4,7 @@\n use crate::prelude::*;\n \n use rustc_ast::expand::allocator::{AllocatorKind, AllocatorTy, ALLOCATOR_METHODS};\n+use rustc_session::config::OomStrategy;\n \n /// Returns whether an allocator shim was created\n pub(crate) fn codegen(\n@@ -18,7 +19,13 @@ pub(crate) fn codegen(\n     if any_dynamic_crate {\n         false\n     } else if let Some(kind) = tcx.allocator_kind(()) {\n-        codegen_inner(module, unwind_context, kind, tcx.lang_items().oom().is_some());\n+        codegen_inner(\n+            module,\n+            unwind_context,\n+            kind,\n+            tcx.lang_items().oom().is_some(),\n+            tcx.sess.opts.debugging_opts.oom,\n+        );\n         true\n     } else {\n         false\n@@ -30,6 +37,7 @@ fn codegen_inner(\n     unwind_context: &mut UnwindContext,\n     kind: AllocatorKind,\n     has_alloc_error_handler: bool,\n+    oom_strategy: OomStrategy,\n ) {\n     let usize_ty = module.target_config().pointer_type();\n \n@@ -129,4 +137,11 @@ fn codegen_inner(\n     }\n     module.define_function(func_id, &mut ctx).unwrap();\n     unwind_context.add_function(func_id, &ctx, module.isa());\n+\n+    let data_id = module.declare_data(OomStrategy::SYMBOL, Linkage::Export, false, false).unwrap();\n+    let mut data_ctx = DataContext::new();\n+    data_ctx.set_align(1);\n+    let val = oom_strategy.should_panic();\n+    data_ctx.define(Box::new([val]));\n+    module.define_data(data_id, &data_ctx).unwrap();\n }"}, {"sha": "c761e5aabd1071d3c4f22f58d63155e6b0e8a3c2", "filename": "compiler/rustc_codegen_gcc/src/allocator.rs", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/d6f3a4ecb48ead838638e902f2fa4e5f3059779b/compiler%2Frustc_codegen_gcc%2Fsrc%2Fallocator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d6f3a4ecb48ead838638e902f2fa4e5f3059779b/compiler%2Frustc_codegen_gcc%2Fsrc%2Fallocator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_gcc%2Fsrc%2Fallocator.rs?ref=d6f3a4ecb48ead838638e902f2fa4e5f3059779b", "patch": "@@ -1,7 +1,8 @@\n-use gccjit::{FunctionType, ToRValue};\n+use gccjit::{FunctionType, GlobalKind, ToRValue};\n use rustc_ast::expand::allocator::{AllocatorKind, AllocatorTy, ALLOCATOR_METHODS};\n use rustc_middle::bug;\n use rustc_middle::ty::TyCtxt;\n+use rustc_session::config::OomStrategy;\n use rustc_span::symbol::sym;\n \n use crate::GccContext;\n@@ -113,4 +114,10 @@ pub(crate) unsafe fn codegen(tcx: TyCtxt<'_>, mods: &mut GccContext, _module_nam\n     let _ret = context.new_call(None, callee, &args);\n     //llvm::LLVMSetTailCall(ret, True);\n     block.end_with_void_return(None);\n+\n+    let name = OomStrategy::SYMBOL.to_string();\n+    let global = context.new_global(None, GlobalKind::Exported, i8, name);\n+    let value = tcx.sess.opts.debugging_opts.oom.should_panic();\n+    let value = context.new_rvalue_from_int(i8, value as i32);\n+    global.global_set_initializer_rvalue(value);\n }"}, {"sha": "f935acb1a7ea3f84c57c302d3714de2b1f386506", "filename": "compiler/rustc_codegen_llvm/src/allocator.rs", "status": "modified", "additions": 11, "deletions": 1, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/d6f3a4ecb48ead838638e902f2fa4e5f3059779b/compiler%2Frustc_codegen_llvm%2Fsrc%2Fallocator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d6f3a4ecb48ead838638e902f2fa4e5f3059779b/compiler%2Frustc_codegen_llvm%2Fsrc%2Fallocator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_llvm%2Fsrc%2Fallocator.rs?ref=d6f3a4ecb48ead838638e902f2fa4e5f3059779b", "patch": "@@ -3,7 +3,7 @@ use libc::c_uint;\n use rustc_ast::expand::allocator::{AllocatorKind, AllocatorTy, ALLOCATOR_METHODS};\n use rustc_middle::bug;\n use rustc_middle::ty::TyCtxt;\n-use rustc_session::config::DebugInfo;\n+use rustc_session::config::{DebugInfo, OomStrategy};\n use rustc_span::symbol::sym;\n \n use crate::debuginfo;\n@@ -139,6 +139,16 @@ pub(crate) unsafe fn codegen(\n     llvm::LLVMBuildRetVoid(llbuilder);\n     llvm::LLVMDisposeBuilder(llbuilder);\n \n+    // __rust_alloc_error_handler_should_panic\n+    let name = OomStrategy::SYMBOL;\n+    let ll_g = llvm::LLVMRustGetOrInsertGlobal(llmod, name.as_ptr().cast(), name.len(), i8);\n+    if tcx.sess.target.default_hidden_visibility {\n+        llvm::LLVMRustSetVisibility(ll_g, llvm::Visibility::Hidden);\n+    }\n+    let val = tcx.sess.opts.debugging_opts.oom.should_panic();\n+    let llval = llvm::LLVMConstInt(i8, val as u64, False);\n+    llvm::LLVMSetInitializer(ll_g, llval);\n+\n     if tcx.sess.opts.debuginfo != DebugInfo::None {\n         let dbg_cx = debuginfo::CodegenUnitDebugContext::new(llmod);\n         debuginfo::metadata::build_compile_unit_di_node(tcx, module_name, &dbg_cx);"}, {"sha": "a357032076772b42796bca826ef3dfcf891097bf", "filename": "compiler/rustc_interface/src/tests.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/d6f3a4ecb48ead838638e902f2fa4e5f3059779b/compiler%2Frustc_interface%2Fsrc%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d6f3a4ecb48ead838638e902f2fa4e5f3059779b/compiler%2Frustc_interface%2Fsrc%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2Fsrc%2Ftests.rs?ref=d6f3a4ecb48ead838638e902f2fa4e5f3059779b", "patch": "@@ -9,8 +9,8 @@ use rustc_session::config::{\n     rustc_optgroups, ErrorOutputType, ExternLocation, LocationDetail, Options, Passes,\n };\n use rustc_session::config::{\n-    BranchProtection, Externs, OutputType, OutputTypes, PAuthKey, PacRet, SymbolManglingVersion,\n-    WasiExecModel,\n+    BranchProtection, Externs, OomStrategy, OutputType, OutputTypes, PAuthKey, PacRet,\n+    SymbolManglingVersion, WasiExecModel,\n };\n use rustc_session::config::{CFGuard, ExternEntry, LinkerPluginLto, LtoCli, SwitchWithOptPath};\n use rustc_session::lint::Level;\n@@ -758,6 +758,7 @@ fn test_debugging_options_tracking_hash() {\n     tracked!(no_link, true);\n     tracked!(no_unique_section_names, true);\n     tracked!(no_profiler_runtime, true);\n+    tracked!(oom, OomStrategy::Panic);\n     tracked!(osx_rpath_install_name, true);\n     tracked!(panic_abort_tests, true);\n     tracked!(panic_in_drop, PanicStrategy::Abort);"}, {"sha": "2357f5ad9031930d97cb3676f58ec560665b187d", "filename": "compiler/rustc_session/src/config.rs", "status": "modified", "additions": 25, "deletions": 3, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/d6f3a4ecb48ead838638e902f2fa4e5f3059779b/compiler%2Frustc_session%2Fsrc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d6f3a4ecb48ead838638e902f2fa4e5f3059779b/compiler%2Frustc_session%2Fsrc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Fconfig.rs?ref=d6f3a4ecb48ead838638e902f2fa4e5f3059779b", "patch": "@@ -2842,9 +2842,9 @@ impl PpMode {\n crate mod dep_tracking {\n     use super::{\n         BranchProtection, CFGuard, CFProtection, CrateType, DebugInfo, ErrorOutputType,\n-        InstrumentCoverage, LdImpl, LinkerPluginLto, LocationDetail, LtoCli, OptLevel, OutputType,\n-        OutputTypes, Passes, SourceFileHashAlgorithm, SwitchWithOptPath, SymbolManglingVersion,\n-        TrimmedDefPaths,\n+        InstrumentCoverage, LdImpl, LinkerPluginLto, LocationDetail, LtoCli, OomStrategy, OptLevel,\n+        OutputType, OutputTypes, Passes, SourceFileHashAlgorithm, SwitchWithOptPath,\n+        SymbolManglingVersion, TrimmedDefPaths,\n     };\n     use crate::lint;\n     use crate::options::WasiExecModel;\n@@ -2940,6 +2940,7 @@ crate mod dep_tracking {\n         RealFileName,\n         LocationDetail,\n         BranchProtection,\n+        OomStrategy,\n     );\n \n     impl<T1, T2> DepTrackingHash for (T1, T2)\n@@ -3029,3 +3030,24 @@ crate mod dep_tracking {\n         }\n     }\n }\n+\n+/// Default behavior to use in out-of-memory situations.\n+#[derive(Clone, Copy, PartialEq, Hash, Debug, Encodable, Decodable, HashStable_Generic)]\n+pub enum OomStrategy {\n+    /// Generate a panic that can be caught by `catch_unwind`.\n+    Panic,\n+\n+    /// Abort the process immediately.\n+    Abort,\n+}\n+\n+impl OomStrategy {\n+    pub const SYMBOL: &'static str = \"__rust_alloc_error_handler_should_panic\";\n+\n+    pub fn should_panic(self) -> u8 {\n+        match self {\n+            OomStrategy::Panic => 1,\n+            OomStrategy::Abort => 0,\n+        }\n+    }\n+}"}, {"sha": "0289b962a5a881dad193b863e26bc45d994de7ad", "filename": "compiler/rustc_session/src/options.rs", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/d6f3a4ecb48ead838638e902f2fa4e5f3059779b/compiler%2Frustc_session%2Fsrc%2Foptions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d6f3a4ecb48ead838638e902f2fa4e5f3059779b/compiler%2Frustc_session%2Fsrc%2Foptions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Foptions.rs?ref=d6f3a4ecb48ead838638e902f2fa4e5f3059779b", "patch": "@@ -375,6 +375,7 @@ mod desc {\n     pub const parse_passes: &str = \"a space-separated list of passes, or `all`\";\n     pub const parse_panic_strategy: &str = \"either `unwind` or `abort`\";\n     pub const parse_opt_panic_strategy: &str = parse_panic_strategy;\n+    pub const parse_oom_strategy: &str = \"either `panic` or `abort`\";\n     pub const parse_relro_level: &str = \"one of: `full`, `partial`, or `off`\";\n     pub const parse_sanitizers: &str = \"comma separated list of sanitizers: `address`, `cfi`, `hwaddress`, `leak`, `memory`, `memtag`, or `thread`\";\n     pub const parse_sanitizer_memory_track_origins: &str = \"0, 1, or 2\";\n@@ -620,6 +621,15 @@ mod parse {\n         true\n     }\n \n+    crate fn parse_oom_strategy(slot: &mut OomStrategy, v: Option<&str>) -> bool {\n+        match v {\n+            Some(\"panic\") => *slot = OomStrategy::Panic,\n+            Some(\"abort\") => *slot = OomStrategy::Abort,\n+            _ => return false,\n+        }\n+        true\n+    }\n+\n     crate fn parse_relro_level(slot: &mut Option<RelroLevel>, v: Option<&str>) -> bool {\n         match v {\n             Some(s) => match s.parse::<RelroLevel>() {\n@@ -1329,6 +1339,8 @@ options! {\n         \"prevent automatic injection of the profiler_builtins crate\"),\n     normalize_docs: bool = (false, parse_bool, [TRACKED],\n         \"normalize associated items in rustdoc when generating documentation\"),\n+    oom: OomStrategy = (OomStrategy::Abort, parse_oom_strategy, [TRACKED],\n+        \"panic strategy for out-of-memory handling\"),\n     osx_rpath_install_name: bool = (false, parse_bool, [TRACKED],\n         \"pass `-install_name @rpath/...` to the macOS linker (default: no)\"),\n     panic_abort_tests: bool = (false, parse_bool, [TRACKED],"}, {"sha": "ae11964cb562803191d7def19b03c23024203217", "filename": "library/std/src/alloc.rs", "status": "modified", "additions": 15, "deletions": 1, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/d6f3a4ecb48ead838638e902f2fa4e5f3059779b/library%2Fstd%2Fsrc%2Falloc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d6f3a4ecb48ead838638e902f2fa4e5f3059779b/library%2Fstd%2Fsrc%2Falloc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Falloc.rs?ref=d6f3a4ecb48ead838638e902f2fa4e5f3059779b", "patch": "@@ -315,7 +315,21 @@ pub fn take_alloc_error_hook() -> fn(Layout) {\n }\n \n fn default_alloc_error_hook(layout: Layout) {\n-    rtprintpanic!(\"memory allocation of {} bytes failed\\n\", layout.size());\n+    #[cfg(not(bootstrap))]\n+    extern \"Rust\" {\n+        // This symbol is emitted by rustc next to __rust_alloc_error_handler.\n+        // Its value depends on the -Zoom={panic,abort} compiler option.\n+        static __rust_alloc_error_handler_should_panic: u8;\n+    }\n+    #[cfg(bootstrap)]\n+    let __rust_alloc_error_handler_should_panic = 0;\n+\n+    #[allow(unused_unsafe)]\n+    if unsafe { __rust_alloc_error_handler_should_panic != 0 } {\n+        panic!(\"memory allocation of {} bytes failed\\n\", layout.size());\n+    } else {\n+        rtprintpanic!(\"memory allocation of {} bytes failed\\n\", layout.size());\n+    }\n }\n \n #[cfg(not(test))]"}, {"sha": "d036c817a0e838cdcdb9bbf79ccaeedcbb009118", "filename": "src/test/ui/oom_unwind.rs", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/d6f3a4ecb48ead838638e902f2fa4e5f3059779b/src%2Ftest%2Fui%2Foom_unwind.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d6f3a4ecb48ead838638e902f2fa4e5f3059779b/src%2Ftest%2Fui%2Foom_unwind.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Foom_unwind.rs?ref=d6f3a4ecb48ead838638e902f2fa4e5f3059779b", "patch": "@@ -0,0 +1,23 @@\n+// compile-flags: -Z oom=panic\n+// run-pass\n+// no-prefer-dynamic\n+// needs-unwind\n+// only-linux\n+\n+#![feature(bench_black_box)]\n+\n+use std::hint::black_box;\n+use std::mem::forget;\n+use std::panic::catch_unwind;\n+\n+fn main() {\n+    let panic = catch_unwind(|| {\n+        // This is guaranteed to exceed even the size of the address space\n+        for _ in 0..16 {\n+            // Truncates to a suitable value for both 32-bit and 64-bit targets.\n+            let alloc_size = 0x1000_0000_1000_0000u64 as usize;\n+            forget(black_box(vec![0u8; alloc_size]));\n+        }\n+    });\n+    assert!(panic.is_err());\n+}"}, {"sha": "7b932b867f24095e8b72fd156e7df494252c770e", "filename": "src/tools/tidy/src/ui_tests.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d6f3a4ecb48ead838638e902f2fa4e5f3059779b/src%2Ftools%2Ftidy%2Fsrc%2Fui_tests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d6f3a4ecb48ead838638e902f2fa4e5f3059779b/src%2Ftools%2Ftidy%2Fsrc%2Fui_tests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Fui_tests.rs?ref=d6f3a4ecb48ead838638e902f2fa4e5f3059779b", "patch": "@@ -7,7 +7,7 @@ use std::path::Path;\n \n const ENTRY_LIMIT: usize = 1000;\n // FIXME: The following limits should be reduced eventually.\n-const ROOT_ENTRY_LIMIT: usize = 983;\n+const ROOT_ENTRY_LIMIT: usize = 984;\n const ISSUES_ENTRY_LIMIT: usize = 2310;\n \n fn check_entries(path: &Path, bad: &mut bool) {"}]}