{"sha": "4fb145867b817ae395d3487089254f384c9be163", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRmYjE0NTg2N2I4MTdhZTM5NWQzNDg3MDg5MjU0ZjM4NGM5YmUxNjM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-06-04T08:23:02Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-06-04T08:23:02Z"}, "message": "Auto merge of #33991 - alexcrichton:rustbuild-more-clean, r=aturon\n\nrustbuild: Clean more on `make clean`\n\nBe sure to not use the old build cache for the bootstrap build system nor the\nold caches of the compiler/cargo extractions (in case something went wrong).\n\nCloses #33986", "tree": {"sha": "c1a7322c37027a1b8e651f3466a0610440222a84", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c1a7322c37027a1b8e651f3466a0610440222a84"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4fb145867b817ae395d3487089254f384c9be163", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4fb145867b817ae395d3487089254f384c9be163", "html_url": "https://github.com/rust-lang/rust/commit/4fb145867b817ae395d3487089254f384c9be163", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4fb145867b817ae395d3487089254f384c9be163/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7738479d72418ddc08febee0fa7097df334d357e", "url": "https://api.github.com/repos/rust-lang/rust/commits/7738479d72418ddc08febee0fa7097df334d357e", "html_url": "https://github.com/rust-lang/rust/commit/7738479d72418ddc08febee0fa7097df334d357e"}, {"sha": "ac19420535b41d3b2a0ba68803f9426e3a89abed", "url": "https://api.github.com/repos/rust-lang/rust/commits/ac19420535b41d3b2a0ba68803f9426e3a89abed", "html_url": "https://github.com/rust-lang/rust/commit/ac19420535b41d3b2a0ba68803f9426e3a89abed"}], "stats": {"total": 11, "additions": 8, "deletions": 3}, "files": [{"sha": "7b0a5d6b6dfc4fcbc38f2f5b46281ad914a3fce6", "filename": "src/bootstrap/bootstrap.py", "status": "modified", "additions": 8, "deletions": 3, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/4fb145867b817ae395d3487089254f384c9be163/src%2Fbootstrap%2Fbootstrap.py", "raw_url": "https://github.com/rust-lang/rust/raw/4fb145867b817ae395d3487089254f384c9be163/src%2Fbootstrap%2Fbootstrap.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbootstrap.py?ref=4fb145867b817ae395d3487089254f384c9be163", "patch": "@@ -182,13 +182,13 @@ def cargo_stamp(self):\n         return os.path.join(self.bin_root(), '.cargo-stamp')\n \n     def rustc_out_of_date(self):\n-        if not os.path.exists(self.rustc_stamp()):\n+        if not os.path.exists(self.rustc_stamp()) or self.clean:\n             return True\n         with open(self.rustc_stamp(), 'r') as f:\n             return self.stage0_rustc_date() != f.read()\n \n     def cargo_out_of_date(self):\n-        if not os.path.exists(self.cargo_stamp()):\n+        if not os.path.exists(self.cargo_stamp()) or self.clean:\n             return True\n         with open(self.cargo_stamp(), 'r') as f:\n             return self.stage0_cargo_date() != f.read()\n@@ -235,8 +235,11 @@ def exe_suffix(self):\n             return ''\n \n     def build_bootstrap(self):\n+        build_dir = os.path.join(self.build_dir, \"bootstrap\")\n+        if self.clean and os.path.exists(build_dir):\n+            shutil.rmtree(build_dir)\n         env = os.environ.copy()\n-        env[\"CARGO_TARGET_DIR\"] = os.path.join(self.build_dir, \"bootstrap\")\n+        env[\"CARGO_TARGET_DIR\"] = build_dir\n         env[\"RUSTC\"] = self.rustc()\n         env[\"LD_LIBRARY_PATH\"] = os.path.join(self.bin_root(), \"lib\")\n         env[\"DYLD_LIBRARY_PATH\"] = os.path.join(self.bin_root(), \"lib\")\n@@ -340,6 +343,7 @@ def build_triple(self):\n def main():\n     parser = argparse.ArgumentParser(description='Build rust')\n     parser.add_argument('--config')\n+    parser.add_argument('--clean', action='store_true')\n     parser.add_argument('-v', '--verbose', action='store_true')\n \n     args = [a for a in sys.argv if a != '-h']\n@@ -352,6 +356,7 @@ def main():\n     rb.rust_root = os.path.abspath(os.path.join(__file__, '../../..'))\n     rb.build_dir = os.path.join(os.getcwd(), \"build\")\n     rb.verbose = args.verbose\n+    rb.clean = args.clean\n \n     try:\n         with open(args.config or 'config.toml') as config:"}]}