{"sha": "11446779b006b25300eb2b4ad6707d6d3303da5e", "node_id": "C_kwDOAAsO6NoAKDExNDQ2Nzc5YjAwNmIyNTMwMGViMmI0YWQ2NzA3ZDZkMzMwM2RhNWU", "commit": {"author": {"name": "Oli Scherer", "email": "git-spam-no-reply9815368754983@oli-obk.de", "date": "2022-03-30T13:17:46Z"}, "committer": {"name": "Oli Scherer", "email": "git-spam-no-reply9815368754983@oli-obk.de", "date": "2022-03-30T13:17:46Z"}, "message": "Don't ICE when opaque types get their hidden type constrained again.\n\nContrary to popular belief, `codegen_fulfill_obligation` does not get used solely in codegen, so we cannot rely on `param_env` being set to RevealAll and thus revealing the hidden types instead of constraining them.", "tree": {"sha": "8454fcf31259f5ecca5a468f43b29d9269113cfe", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8454fcf31259f5ecca5a468f43b29d9269113cfe"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/11446779b006b25300eb2b4ad6707d6d3303da5e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/11446779b006b25300eb2b4ad6707d6d3303da5e", "html_url": "https://github.com/rust-lang/rust/commit/11446779b006b25300eb2b4ad6707d6d3303da5e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/11446779b006b25300eb2b4ad6707d6d3303da5e/comments", "author": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "committer": {"login": "oli-obk", "id": 332036, "node_id": "MDQ6VXNlcjMzMjAzNg==", "avatar_url": "https://avatars.githubusercontent.com/u/332036?v=4", "gravatar_id": "", "url": "https://api.github.com/users/oli-obk", "html_url": "https://github.com/oli-obk", "followers_url": "https://api.github.com/users/oli-obk/followers", "following_url": "https://api.github.com/users/oli-obk/following{/other_user}", "gists_url": "https://api.github.com/users/oli-obk/gists{/gist_id}", "starred_url": "https://api.github.com/users/oli-obk/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/oli-obk/subscriptions", "organizations_url": "https://api.github.com/users/oli-obk/orgs", "repos_url": "https://api.github.com/users/oli-obk/repos", "events_url": "https://api.github.com/users/oli-obk/events{/privacy}", "received_events_url": "https://api.github.com/users/oli-obk/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "e50ff9b4521234e56ff46f8ed0372d5cb5689654", "url": "https://api.github.com/repos/rust-lang/rust/commits/e50ff9b4521234e56ff46f8ed0372d5cb5689654", "html_url": "https://github.com/rust-lang/rust/commit/e50ff9b4521234e56ff46f8ed0372d5cb5689654"}], "stats": {"total": 43, "additions": 30, "deletions": 13}, "files": [{"sha": "866bb6109e05cce1eb9c9c67d1fa75fba0e2a6d9", "filename": "compiler/rustc_trait_selection/src/traits/codegen.rs", "status": "modified", "additions": 6, "deletions": 13, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/11446779b006b25300eb2b4ad6707d6d3303da5e/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fcodegen.rs", "raw_url": "https://github.com/rust-lang/rust/raw/11446779b006b25300eb2b4ad6707d6d3303da5e/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fcodegen.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Fcodegen.rs?ref=11446779b006b25300eb2b4ad6707d6d3303da5e", "patch": "@@ -19,6 +19,7 @@ use rustc_middle::ty::{self, TyCtxt};\n /// obligations *could be* resolved if we wanted to.\n ///\n /// This also expects that `trait_ref` is fully normalized.\n+#[instrument(level = \"debug\", skip(tcx))]\n pub fn codegen_fulfill_obligation<'tcx>(\n     tcx: TyCtxt<'tcx>,\n     (param_env, trait_ref): (ty::ParamEnv<'tcx>, ty::PolyTraitRef<'tcx>),\n@@ -27,11 +28,6 @@ pub fn codegen_fulfill_obligation<'tcx>(\n     let trait_ref = tcx.erase_regions(trait_ref);\n     // We expect the input to be fully normalized.\n     debug_assert_eq!(trait_ref, tcx.normalize_erasing_regions(param_env, trait_ref));\n-    debug!(\n-        \"codegen_fulfill_obligation(trait_ref={:?}, def_id={:?})\",\n-        (param_env, trait_ref),\n-        trait_ref.def_id()\n-    );\n \n     // Do the initial selection for the obligation. This yields the\n     // shallow result we are looking for -- that is, what specific impl.\n@@ -80,25 +76,22 @@ pub fn codegen_fulfill_obligation<'tcx>(\n             }\n         };\n \n-        debug!(\"fulfill_obligation: selection={:?}\", selection);\n+        debug!(?selection);\n \n         // Currently, we use a fulfillment context to completely resolve\n         // all nested obligations. This is because they can inform the\n         // inference of the impl's type parameters.\n         let mut fulfill_cx = FulfillmentContext::new();\n         let impl_source = selection.map(|predicate| {\n-            debug!(\"fulfill_obligation: register_predicate_obligation {:?}\", predicate);\n             fulfill_cx.register_predicate_obligation(&infcx, predicate);\n         });\n         let impl_source = drain_fulfillment_cx_or_panic(&infcx, &mut fulfill_cx, impl_source);\n \n-        // There should be no opaque types during codegen, they all get revealed.\n-        let opaque_types = infcx.inner.borrow_mut().opaque_type_storage.take_opaque_types();\n-        if !opaque_types.is_empty() {\n-            bug!(\"{:#?}\", opaque_types);\n-        }\n+        // Opaque types may have gotten their hidden types constrained, but we can ignore them safely\n+        // as they will get constrained elsewhere, too.\n+        let _opaque_types = infcx.inner.borrow_mut().opaque_type_storage.take_opaque_types();\n \n-        debug!(\"Cache miss: {:?} => {:?}\", trait_ref, impl_source);\n+        debug!(\"Cache miss: {trait_ref:?} => {impl_source:?}\");\n         Ok(&*tcx.arena.alloc(impl_source))\n     })\n }"}, {"sha": "703e3e8693e8e4d46cf35b7f26f481cb149a1d87", "filename": "src/test/ui/type-alias-impl-trait/assoc-projection-ice.rs", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/11446779b006b25300eb2b4ad6707d6d3303da5e/src%2Ftest%2Fui%2Ftype-alias-impl-trait%2Fassoc-projection-ice.rs", "raw_url": "https://github.com/rust-lang/rust/raw/11446779b006b25300eb2b4ad6707d6d3303da5e/src%2Ftest%2Fui%2Ftype-alias-impl-trait%2Fassoc-projection-ice.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftype-alias-impl-trait%2Fassoc-projection-ice.rs?ref=11446779b006b25300eb2b4ad6707d6d3303da5e", "patch": "@@ -0,0 +1,24 @@\n+#![feature(type_alias_impl_trait)]\n+\n+// build-pass\n+\n+trait T { type Item; }\n+\n+type Alias<'a> = impl T<Item = &'a ()>;\n+\n+struct S;\n+impl<'a> T for &'a S {\n+    type Item = &'a ();\n+}\n+\n+fn filter_positive<'a>() -> Alias<'a> {\n+    &S\n+}\n+\n+fn with_positive(fun: impl Fn(Alias<'_>)) {\n+    fun(filter_positive());\n+}\n+\n+fn main() {\n+    with_positive(|_| ());\n+}"}]}