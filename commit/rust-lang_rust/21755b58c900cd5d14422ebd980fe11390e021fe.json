{"sha": "21755b58c900cd5d14422ebd980fe11390e021fe", "node_id": "MDY6Q29tbWl0NzI0NzEyOjIxNzU1YjU4YzkwMGNkNWQxNDQyMmViZDk4MGZlMTEzOTBlMDIxZmU=", "commit": {"author": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2020-05-29T18:51:46Z"}, "committer": {"name": "Vadim Petrochenkov", "email": "vadim.petrochenkov@gmail.com", "date": "2020-05-29T19:55:58Z"}, "message": "rustc_lexer: Optimize shebang detection slightly", "tree": {"sha": "e8abb136697e6f4f64903cf4e80cc5b3684f5c31", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e8abb136697e6f4f64903cf4e80cc5b3684f5c31"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/21755b58c900cd5d14422ebd980fe11390e021fe", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/21755b58c900cd5d14422ebd980fe11390e021fe", "html_url": "https://github.com/rust-lang/rust/commit/21755b58c900cd5d14422ebd980fe11390e021fe", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/21755b58c900cd5d14422ebd980fe11390e021fe/comments", "author": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "committer": {"login": "petrochenkov", "id": 5751617, "node_id": "MDQ6VXNlcjU3NTE2MTc=", "avatar_url": "https://avatars.githubusercontent.com/u/5751617?v=4", "gravatar_id": "", "url": "https://api.github.com/users/petrochenkov", "html_url": "https://github.com/petrochenkov", "followers_url": "https://api.github.com/users/petrochenkov/followers", "following_url": "https://api.github.com/users/petrochenkov/following{/other_user}", "gists_url": "https://api.github.com/users/petrochenkov/gists{/gist_id}", "starred_url": "https://api.github.com/users/petrochenkov/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/petrochenkov/subscriptions", "organizations_url": "https://api.github.com/users/petrochenkov/orgs", "repos_url": "https://api.github.com/users/petrochenkov/repos", "events_url": "https://api.github.com/users/petrochenkov/events{/privacy}", "received_events_url": "https://api.github.com/users/petrochenkov/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "96dd4690c3aa70ec312448c3f2d50e6dc6fb87df", "url": "https://api.github.com/repos/rust-lang/rust/commits/96dd4690c3aa70ec312448c3f2d50e6dc6fb87df", "html_url": "https://github.com/rust-lang/rust/commit/96dd4690c3aa70ec312448c3f2d50e6dc6fb87df"}], "stats": {"total": 51, "additions": 32, "deletions": 19}, "files": [{"sha": "c2139d07f378a5640327bca97903c04b7da0b8a0", "filename": "src/librustc_lexer/src/lib.rs", "status": "modified", "additions": 18, "deletions": 19, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/21755b58c900cd5d14422ebd980fe11390e021fe/src%2Flibrustc_lexer%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/21755b58c900cd5d14422ebd980fe11390e021fe/src%2Flibrustc_lexer%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_lexer%2Fsrc%2Flib.rs?ref=21755b58c900cd5d14422ebd980fe11390e021fe", "patch": "@@ -238,26 +238,25 @@ pub enum Base {\n /// `rustc` allows files to have a shebang, e.g. \"#!/usr/bin/rustrun\",\n /// but shebang isn't a part of rust syntax.\n pub fn strip_shebang(input: &str) -> Option<usize> {\n-    let first_line = input.lines().next()?;\n-    // A shebang is intentionally loosely defined as `#! [non whitespace]` on the first line.\n-    let could_be_shebang =\n-        first_line.starts_with(\"#!\") && first_line[2..].contains(|c| !is_whitespace(c));\n-    if !could_be_shebang {\n-        return None;\n-    }\n-    let non_whitespace_tokens = tokenize(input).map(|tok| tok.kind).filter(|tok|\n-        !matches!(tok, TokenKind::LineComment | TokenKind::BlockComment { .. } | TokenKind::Whitespace)\n-    );\n-    let prefix = [TokenKind::Pound, TokenKind::Not, TokenKind::OpenBracket];\n-    let starts_with_attribute = non_whitespace_tokens.take(3).eq(prefix.iter().copied());\n-    if starts_with_attribute {\n-        // If the file starts with #![ then it's definitely not a shebang -- it couldn't be\n-        // a rust program since a Rust program can't start with `[`\n-        None\n-    } else {\n-        // It's a #!... and there isn't a `[` in sight, must be a shebang\n-        Some(first_line.len())\n+    // Shebang must start with `#!` literally, without any preceding whitespace.\n+    if input.starts_with(\"#!\") {\n+        let input_tail = &input[2..];\n+        // Shebang must have something non-whitespace after `#!` on the first line.\n+        let first_line_tail = input_tail.lines().next()?;\n+        if first_line_tail.contains(|c| !is_whitespace(c)) {\n+            // Ok, this is a shebang but if the next non-whitespace token is `[` or maybe\n+            // a doc comment (due to `TokenKind::(Line,Block)Comment` ambiguity at lexer level),\n+            // then it may be valid Rust code, so consider it Rust code.\n+            let next_non_whitespace_token = tokenize(input_tail).map(|tok| tok.kind).filter(|tok|\n+                !matches!(tok, TokenKind::Whitespace | TokenKind::LineComment | TokenKind::BlockComment { .. })\n+            ).next();\n+            if next_non_whitespace_token != Some(TokenKind::OpenBracket) {\n+                // No other choice than to consider this a shebang.\n+                return Some(2 + first_line_tail.len());\n+            }\n+        }\n     }\n+    None\n }\n \n /// Parses the first token from the provided input string."}, {"sha": "7dbb9eebc757127599eb861fdba58f14ac0f3ed0", "filename": "src/test/ui/parser/shebang/shebang-doc-comment.rs", "status": "added", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/21755b58c900cd5d14422ebd980fe11390e021fe/src%2Ftest%2Fui%2Fparser%2Fshebang%2Fshebang-doc-comment.rs", "raw_url": "https://github.com/rust-lang/rust/raw/21755b58c900cd5d14422ebd980fe11390e021fe/src%2Ftest%2Fui%2Fparser%2Fshebang%2Fshebang-doc-comment.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fshebang%2Fshebang-doc-comment.rs?ref=21755b58c900cd5d14422ebd980fe11390e021fe", "patch": "@@ -0,0 +1,6 @@\n+#!///bin/bash\n+[allow(unused_variables)]\n+//~^^ ERROR expected `[`, found doc comment\n+\n+// Doc comment is misinterpreted as a whitespace (regular comment) during shebang detection.\n+// Even if it wasn't, it would still result in an error, just a different one."}, {"sha": "f524f556837fbc1e30f412adec6dc9fb8810c2a3", "filename": "src/test/ui/parser/shebang/shebang-doc-comment.stderr", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/21755b58c900cd5d14422ebd980fe11390e021fe/src%2Ftest%2Fui%2Fparser%2Fshebang%2Fshebang-doc-comment.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/21755b58c900cd5d14422ebd980fe11390e021fe/src%2Ftest%2Fui%2Fparser%2Fshebang%2Fshebang-doc-comment.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fshebang%2Fshebang-doc-comment.stderr?ref=21755b58c900cd5d14422ebd980fe11390e021fe", "patch": "@@ -0,0 +1,8 @@\n+error: expected `[`, found doc comment `///bin/bash`\n+  --> $DIR/shebang-doc-comment.rs:1:3\n+   |\n+LL | #!///bin/bash\n+   |   ^^^^^^^^^^^ expected `[`\n+\n+error: aborting due to previous error\n+"}]}