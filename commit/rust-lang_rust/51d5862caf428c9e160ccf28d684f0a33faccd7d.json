{"sha": "51d5862caf428c9e160ccf28d684f0a33faccd7d", "node_id": "C_kwDOAAsO6NoAKDUxZDU4NjJjYWY0MjhjOWUxNjBjY2YyOGQ2ODRmMGEzM2ZhY2NkN2Q", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-04-09T08:18:12Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-04-09T08:18:12Z"}, "message": "Auto merge of #14538 - Veykril:project-link-fix, r=Veykril\n\nfix: Fix project linking popup appearing for modules that can be linked to a crate\n\nshould fix https://github.com/rust-lang/rust-analyzer/issues/14523", "tree": {"sha": "afa71e06a0f2b48e34c70f98949a436ea260cd97", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/afa71e06a0f2b48e34c70f98949a436ea260cd97"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/51d5862caf428c9e160ccf28d684f0a33faccd7d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/51d5862caf428c9e160ccf28d684f0a33faccd7d", "html_url": "https://github.com/rust-lang/rust/commit/51d5862caf428c9e160ccf28d684f0a33faccd7d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/51d5862caf428c9e160ccf28d684f0a33faccd7d/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "01120f1213ad928de7300a8acf9f41bed72d0422", "url": "https://api.github.com/repos/rust-lang/rust/commits/01120f1213ad928de7300a8acf9f41bed72d0422", "html_url": "https://github.com/rust-lang/rust/commit/01120f1213ad928de7300a8acf9f41bed72d0422"}, {"sha": "98a673c4a89726324e0ef7238181bb85e49ea3e5", "url": "https://api.github.com/repos/rust-lang/rust/commits/98a673c4a89726324e0ef7238181bb85e49ea3e5", "html_url": "https://github.com/rust-lang/rust/commit/98a673c4a89726324e0ef7238181bb85e49ea3e5"}], "stats": {"total": 30, "additions": 24, "deletions": 6}, "files": [{"sha": "b9c5384ea1eec8d0606ce7eb7f1c7a36b369ed37", "filename": "crates/ide-diagnostics/src/handlers/unlinked_file.rs", "status": "modified", "additions": 19, "deletions": 5, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/51d5862caf428c9e160ccf28d684f0a33faccd7d/crates%2Fide-diagnostics%2Fsrc%2Fhandlers%2Funlinked_file.rs", "raw_url": "https://github.com/rust-lang/rust/raw/51d5862caf428c9e160ccf28d684f0a33faccd7d/crates%2Fide-diagnostics%2Fsrc%2Fhandlers%2Funlinked_file.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide-diagnostics%2Fsrc%2Fhandlers%2Funlinked_file.rs?ref=51d5862caf428c9e160ccf28d684f0a33faccd7d", "patch": "@@ -10,7 +10,7 @@ use ide_db::{\n };\n use syntax::{\n     ast::{self, edit::IndentLevel, HasModuleItem, HasName},\n-    AstNode, TextRange, TextSize,\n+    AstNode, TextRange,\n };\n use text_edit::TextEdit;\n \n@@ -27,14 +27,28 @@ pub(crate) fn unlinked_file(\n ) {\n     // Limit diagnostic to the first few characters in the file. This matches how VS Code\n     // renders it with the full span, but on other editors, and is less invasive.\n+    let fixes = fixes(ctx, file_id);\n+    // FIXME: This is a hack for the vscode extension to notice whether there is an autofix or not before having to resolve diagnostics.\n+    // This is to prevent project linking popups from appearing when there is an autofix. https://github.com/rust-lang/rust-analyzer/issues/14523\n+    let message = if fixes.is_none() {\n+        \"file not included in crate hierarchy\"\n+    } else {\n+        \"file not included in module tree\"\n+    };\n+\n     let range = ctx.sema.db.parse(file_id).syntax_node().text_range();\n-    // FIXME: This is wrong if one of the first three characters is not ascii: `//\u042b`.\n-    let range = range.intersect(TextRange::up_to(TextSize::of(\"...\"))).unwrap_or(range);\n+    let range = FileLoader::file_text(ctx.sema.db, file_id)\n+        .char_indices()\n+        .take(3)\n+        .last()\n+        .map(|(i, _)| i)\n+        .map(|i| TextRange::up_to(i.try_into().unwrap()))\n+        .unwrap_or(range);\n \n     acc.push(\n-        Diagnostic::new(\"unlinked-file\", \"file not included in module tree\", range)\n+        Diagnostic::new(\"unlinked-file\", message, range)\n             .severity(Severity::WeakWarning)\n-            .with_fixes(fixes(ctx, file_id)),\n+            .with_fixes(fixes),\n     );\n }\n "}, {"sha": "b27d9f5494394c44a7c584ae36b6466b8ca282bd", "filename": "editors/code/src/client.ts", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/51d5862caf428c9e160ccf28d684f0a33faccd7d/editors%2Fcode%2Fsrc%2Fclient.ts", "raw_url": "https://github.com/rust-lang/rust/raw/51d5862caf428c9e160ccf28d684f0a33faccd7d/editors%2Fcode%2Fsrc%2Fclient.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fclient.ts?ref=51d5862caf428c9e160ccf28d684f0a33faccd7d", "patch": "@@ -125,7 +125,11 @@ export async function createClient(\n                         typeof diag.code === \"string\" || typeof diag.code === \"number\"\n                             ? diag.code\n                             : diag.code?.value;\n-                    if (value === \"unlinked-file\" && !unlinkedFiles.includes(uri)) {\n+                    if (\n+                        value === \"unlinked-file\" &&\n+                        !unlinkedFiles.includes(uri) &&\n+                        diag.message !== \"file not included in module tree\"\n+                    ) {\n                         const config = vscode.workspace.getConfiguration(\"rust-analyzer\");\n                         if (config.get(\"showUnlinkedFileNotification\")) {\n                             unlinkedFiles.push(uri);"}]}