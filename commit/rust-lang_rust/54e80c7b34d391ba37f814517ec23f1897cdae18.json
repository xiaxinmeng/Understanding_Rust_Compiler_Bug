{"sha": "54e80c7b34d391ba37f814517ec23f1897cdae18", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU0ZTgwYzdiMzRkMzkxYmEzN2Y4MTQ1MTdlYzIzZjE4OTdjZGFlMTg=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-04-20T18:22:53Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-04-20T18:22:53Z"}, "message": "Auto merge of #4007 - phansch:fix_allowing_toplevel_ref_arg, r=flip1995\n\nAllow allowing of toplevel_ref_arg lint\n\nI'm not sure why some lints need the `HirId` to be able to recognize the\nlint level attributes, but this commit makes the lint level attributes\nwork for `toplevel_ref_arg`.\n\nFixes #2332\n\nchangelog: Allow allowing of `toplevel_ref_arg` lint", "tree": {"sha": "01c792484c4ac92bb621d05eb6ae54d55a422a2b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/01c792484c4ac92bb621d05eb6ae54d55a422a2b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/54e80c7b34d391ba37f814517ec23f1897cdae18", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/54e80c7b34d391ba37f814517ec23f1897cdae18", "html_url": "https://github.com/rust-lang/rust/commit/54e80c7b34d391ba37f814517ec23f1897cdae18", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/54e80c7b34d391ba37f814517ec23f1897cdae18/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fc1c2f5f1aad73d58673fc64952fc144e3e50bf7", "url": "https://api.github.com/repos/rust-lang/rust/commits/fc1c2f5f1aad73d58673fc64952fc144e3e50bf7", "html_url": "https://github.com/rust-lang/rust/commit/fc1c2f5f1aad73d58673fc64952fc144e3e50bf7"}, {"sha": "158aa39a7c83164c949d5130cb114e444e8b38af", "url": "https://api.github.com/repos/rust-lang/rust/commits/158aa39a7c83164c949d5130cb114e444e8b38af", "html_url": "https://github.com/rust-lang/rust/commit/158aa39a7c83164c949d5130cb114e444e8b38af"}], "stats": {"total": 17, "additions": 11, "deletions": 6}, "files": [{"sha": "6e41249ea6488e04aff575125225fe899095746b", "filename": "clippy_lints/src/misc.rs", "status": "modified", "additions": 7, "deletions": 6, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/54e80c7b34d391ba37f814517ec23f1897cdae18/clippy_lints%2Fsrc%2Fmisc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54e80c7b34d391ba37f814517ec23f1897cdae18/clippy_lints%2Fsrc%2Fmisc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Fmisc.rs?ref=54e80c7b34d391ba37f814517ec23f1897cdae18", "patch": "@@ -13,8 +13,8 @@ use crate::consts::{constant, Constant};\n use crate::utils::sugg::Sugg;\n use crate::utils::{\n     get_item_name, get_parent_expr, implements_trait, in_constant, in_macro, is_integer_literal, iter_input_pats,\n-    last_path_segment, match_qpath, match_trait_method, paths, snippet, span_lint, span_lint_and_then, walk_ptrs_ty,\n-    SpanlessEq,\n+    last_path_segment, match_qpath, match_trait_method, paths, snippet, span_lint, span_lint_and_then,\n+    span_lint_hir_and_then, walk_ptrs_ty, SpanlessEq,\n };\n \n declare_clippy_lint! {\n@@ -282,19 +282,20 @@ impl<'a, 'tcx> LateLintPass<'a, 'tcx> for MiscLints {\n             if let Some(ref init) = l.init;\n             then {\n                 if an == BindingAnnotation::Ref || an == BindingAnnotation::RefMut {\n-                    let init = Sugg::hir(cx, init, \"..\");\n+                    let sugg_init = Sugg::hir(cx, init, \"..\");\n                     let (mutopt,initref) = if an == BindingAnnotation::RefMut {\n-                        (\"mut \", init.mut_addr())\n+                        (\"mut \", sugg_init.mut_addr())\n                     } else {\n-                        (\"\", init.addr())\n+                        (\"\", sugg_init.addr())\n                     };\n                     let tyopt = if let Some(ref ty) = l.ty {\n                         format!(\": &{mutopt}{ty}\", mutopt=mutopt, ty=snippet(cx, ty.span, \"_\"))\n                     } else {\n                         String::new()\n                     };\n-                    span_lint_and_then(cx,\n+                    span_lint_hir_and_then(cx,\n                         TOPLEVEL_REF_ARG,\n+                        init.hir_id,\n                         l.pat.span,\n                         \"`ref` on an entire `let` pattern is discouraged, take a reference with `&` instead\",\n                         |db| {"}, {"sha": "a412c387a0dd0814f32a7af1986cf49baa7185c0", "filename": "tests/ui/toplevel_ref_arg.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/54e80c7b34d391ba37f814517ec23f1897cdae18/tests%2Fui%2Ftoplevel_ref_arg.rs", "raw_url": "https://github.com/rust-lang/rust/raw/54e80c7b34d391ba37f814517ec23f1897cdae18/tests%2Fui%2Ftoplevel_ref_arg.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ftoplevel_ref_arg.rs?ref=54e80c7b34d391ba37f814517ec23f1897cdae18", "patch": "@@ -22,4 +22,8 @@ fn main() {\n \n     let (ref x, _) = (1, 2); // ok, not top level\n     println!(\"The answer is {}.\", x);\n+\n+    // Make sure that allowing the lint works\n+    #[allow(clippy::toplevel_ref_arg)]\n+    let ref mut x = 1_234_543;\n }"}]}