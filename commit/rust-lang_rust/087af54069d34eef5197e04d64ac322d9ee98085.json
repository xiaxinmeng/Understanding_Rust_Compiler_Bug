{"sha": "087af54069d34eef5197e04d64ac322d9ee98085", "node_id": "MDY6Q29tbWl0NzI0NzEyOjA4N2FmNTQwNjlkMzRlZWY1MTk3ZTA0ZDY0YWMzMjJkOWVlOTgwODU=", "commit": {"author": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-12-31T17:14:00Z"}, "committer": {"name": "Aleksey Kladov", "email": "aleksey.kladov@gmail.com", "date": "2019-12-31T17:32:17Z"}, "message": "Refactor server lifecycle", "tree": {"sha": "3a6e4b1884930c07bd800a771ffd777d7a866b11", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3a6e4b1884930c07bd800a771ffd777d7a866b11"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/087af54069d34eef5197e04d64ac322d9ee98085", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/087af54069d34eef5197e04d64ac322d9ee98085", "html_url": "https://github.com/rust-lang/rust/commit/087af54069d34eef5197e04d64ac322d9ee98085", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/087af54069d34eef5197e04d64ac322d9ee98085/comments", "author": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "committer": {"login": "matklad", "id": 1711539, "node_id": "MDQ6VXNlcjE3MTE1Mzk=", "avatar_url": "https://avatars.githubusercontent.com/u/1711539?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matklad", "html_url": "https://github.com/matklad", "followers_url": "https://api.github.com/users/matklad/followers", "following_url": "https://api.github.com/users/matklad/following{/other_user}", "gists_url": "https://api.github.com/users/matklad/gists{/gist_id}", "starred_url": "https://api.github.com/users/matklad/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matklad/subscriptions", "organizations_url": "https://api.github.com/users/matklad/orgs", "repos_url": "https://api.github.com/users/matklad/repos", "events_url": "https://api.github.com/users/matklad/events{/privacy}", "received_events_url": "https://api.github.com/users/matklad/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0849f7001cac6af93ce9e9356f8c21881bbe34c5", "url": "https://api.github.com/repos/rust-lang/rust/commits/0849f7001cac6af93ce9e9356f8c21881bbe34c5", "html_url": "https://github.com/rust-lang/rust/commit/0849f7001cac6af93ce9e9356f8c21881bbe34c5"}], "stats": {"total": 419, "additions": 218, "deletions": 201}, "files": [{"sha": "94948b10fe3fa7c84747117daf175e3079ac83c1", "filename": "editors/code/src/client.ts", "status": "added", "additions": 90, "deletions": 0, "changes": 90, "blob_url": "https://github.com/rust-lang/rust/blob/087af54069d34eef5197e04d64ac322d9ee98085/editors%2Fcode%2Fsrc%2Fclient.ts", "raw_url": "https://github.com/rust-lang/rust/raw/087af54069d34eef5197e04d64ac322d9ee98085/editors%2Fcode%2Fsrc%2Fclient.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fclient.ts?ref=087af54069d34eef5197e04d64ac322d9ee98085", "patch": "@@ -0,0 +1,90 @@\n+import { homedir } from 'os';\n+import * as lc from 'vscode-languageclient';\n+\n+import { window, workspace } from 'vscode';\n+import { Config } from './config';\n+\n+export function createClient(config: Config): lc.LanguageClient {\n+    // '.' Is the fallback if no folder is open\n+    // TODO?: Workspace folders support Uri's (eg: file://test.txt). It might be a good idea to test if the uri points to a file.\n+    let folder: string = '.';\n+    if (workspace.workspaceFolders !== undefined) {\n+        folder = workspace.workspaceFolders[0].uri.fsPath.toString();\n+    }\n+\n+    const command = expandPathResolving(config.raLspServerPath);\n+    const run: lc.Executable = {\n+        command,\n+        options: { cwd: folder },\n+    };\n+    const serverOptions: lc.ServerOptions = {\n+        run,\n+        debug: run,\n+    };\n+    const traceOutputChannel = window.createOutputChannel(\n+        'Rust Analyzer Language Server Trace',\n+    );\n+    const clientOptions: lc.LanguageClientOptions = {\n+        documentSelector: [{ scheme: 'file', language: 'rust' }],\n+        initializationOptions: {\n+            publishDecorations: true,\n+            lruCapacity: config.lruCapacity,\n+            maxInlayHintLength: config.maxInlayHintLength,\n+            cargoWatchEnable: config.cargoWatchOptions.enable,\n+            cargoWatchArgs: config.cargoWatchOptions.arguments,\n+            cargoWatchCommand: config.cargoWatchOptions.command,\n+            cargoWatchAllTargets:\n+                config.cargoWatchOptions.allTargets,\n+            excludeGlobs: config.excludeGlobs,\n+            useClientWatching: config.useClientWatching,\n+            featureFlags: config.featureFlags,\n+            withSysroot: config.withSysroot,\n+            cargoFeatures: config.cargoFeatures,\n+        },\n+        traceOutputChannel,\n+    };\n+\n+    const res = new lc.LanguageClient(\n+        'rust-analyzer',\n+        'Rust Analyzer Language Server',\n+        serverOptions,\n+        clientOptions,\n+    );\n+\n+    // HACK: This is an awful way of filtering out the decorations notifications\n+    // However, pending proper support, this is the most effecitve approach\n+    // Proper support for this would entail a change to vscode-languageclient to allow not notifying on certain messages\n+    // Or the ability to disable the serverside component of highlighting (but this means that to do tracing we need to disable hihlighting)\n+    // This also requires considering our settings strategy, which is work which needs doing\n+    // @ts-ignore The tracer is private to vscode-languageclient, but we need access to it to not log publishDecorations requests\n+    res._tracer = {\n+        log: (messageOrDataObject: string | any, data?: string) => {\n+            if (typeof messageOrDataObject === 'string') {\n+                if (\n+                    messageOrDataObject.includes(\n+                        'rust-analyzer/publishDecorations',\n+                    ) ||\n+                    messageOrDataObject.includes(\n+                        'rust-analyzer/decorationsRequest',\n+                    )\n+                ) {\n+                    // Don't log publish decorations requests\n+                } else {\n+                    // @ts-ignore This is just a utility function\n+                    res.logTrace(messageOrDataObject, data);\n+                }\n+            } else {\n+                // @ts-ignore\n+                res.logObjectTrace(messageOrDataObject);\n+            }\n+        },\n+    };\n+    res.registerProposedFeatures()\n+    return res;\n+}\n+function expandPathResolving(path: string) {\n+    if (path.startsWith('~/')) {\n+        return path.replace('~', homedir());\n+    }\n+    return path;\n+}"}, {"sha": "cf37dc6f03b31257cd78c2b62ec0513d1993a87b", "filename": "editors/code/src/commands/analyzer_status.ts", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/087af54069d34eef5197e04d64ac322d9ee98085/editors%2Fcode%2Fsrc%2Fcommands%2Fanalyzer_status.ts", "raw_url": "https://github.com/rust-lang/rust/raw/087af54069d34eef5197e04d64ac322d9ee98085/editors%2Fcode%2Fsrc%2Fcommands%2Fanalyzer_status.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fcommands%2Fanalyzer_status.ts?ref=087af54069d34eef5197e04d64ac322d9ee98085", "patch": "@@ -49,9 +49,10 @@ class TextDocumentContentProvider\n         _uri: vscode.Uri,\n     ): vscode.ProviderResult<string> {\n         const editor = vscode.window.activeTextEditor;\n-        if (editor == null) return '';\n+        const client = this.ctx.client\n+        if (!editor || !client) return '';\n \n-        return this.ctx.client.sendRequest<string>(\n+        return client.sendRequest<string>(\n             'rust-analyzer/analyzerStatus',\n             null,\n         );"}, {"sha": "472f43b8db4230bea642da430c11ea06b93753b8", "filename": "editors/code/src/commands/expand_macro.ts", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/087af54069d34eef5197e04d64ac322d9ee98085/editors%2Fcode%2Fsrc%2Fcommands%2Fexpand_macro.ts", "raw_url": "https://github.com/rust-lang/rust/raw/087af54069d34eef5197e04d64ac322d9ee98085/editors%2Fcode%2Fsrc%2Fcommands%2Fexpand_macro.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fcommands%2Fexpand_macro.ts?ref=087af54069d34eef5197e04d64ac322d9ee98085", "patch": "@@ -52,14 +52,15 @@ class TextDocumentContentProvider\n \n     async provideTextDocumentContent(_uri: vscode.Uri): Promise<string> {\n         const editor = vscode.window.activeTextEditor;\n-        if (editor == null) return '';\n+        const client = this.ctx.client\n+        if (!editor || !client) return '';\n \n         const position = editor.selection.active;\n         const request: lc.TextDocumentPositionParams = {\n             textDocument: { uri: editor.document.uri.toString() },\n             position,\n         };\n-        const expanded = await this.ctx.client.sendRequest<ExpandedMacro>(\n+        const expanded = await client.sendRequest<ExpandedMacro>(\n             'rust-analyzer/expandMacro',\n             request,\n         );"}, {"sha": "4431fdcf68f2e6c3c61e00a6c693d417d7547204", "filename": "editors/code/src/commands/index.ts", "status": "modified", "additions": 18, "deletions": 7, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/087af54069d34eef5197e04d64ac322d9ee98085/editors%2Fcode%2Fsrc%2Fcommands%2Findex.ts", "raw_url": "https://github.com/rust-lang/rust/raw/087af54069d34eef5197e04d64ac322d9ee98085/editors%2Fcode%2Fsrc%2Fcommands%2Findex.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fcommands%2Findex.ts?ref=087af54069d34eef5197e04d64ac322d9ee98085", "patch": "@@ -15,18 +15,21 @@ import { run, runSingle } from './runnables';\n \n function collectGarbage(ctx: Ctx): Cmd {\n     return async () => {\n-        ctx.client.sendRequest<null>('rust-analyzer/collectGarbage', null);\n+        ctx.client?.sendRequest<null>('rust-analyzer/collectGarbage', null);\n     };\n }\n \n function showReferences(ctx: Ctx): Cmd {\n     return (uri: string, position: lc.Position, locations: lc.Location[]) => {\n-        vscode.commands.executeCommand(\n-            'editor.action.showReferences',\n-            vscode.Uri.parse(uri),\n-            ctx.client.protocol2CodeConverter.asPosition(position),\n-            locations.map(ctx.client.protocol2CodeConverter.asLocation),\n-        );\n+        let client = ctx.client;\n+        if (client) {\n+            vscode.commands.executeCommand(\n+                'editor.action.showReferences',\n+                vscode.Uri.parse(uri),\n+                client.protocol2CodeConverter.asPosition(position),\n+                locations.map(client.protocol2CodeConverter.asLocation),\n+            );\n+        }\n     };\n }\n \n@@ -36,6 +39,13 @@ function applySourceChange(ctx: Ctx): Cmd {\n     }\n }\n \n+function reload(ctx: Ctx): Cmd {\n+    return async () => {\n+        vscode.window.showInformationMessage('Reloading rust-analyzer...');\n+        await ctx.restartServer();\n+    }\n+}\n+\n export {\n     analyzerStatus,\n     expandMacro,\n@@ -49,4 +59,5 @@ export {\n     runSingle,\n     showReferences,\n     applySourceChange,\n+    reload\n };"}, {"sha": "7b08c32550399e2978e8c5bb3505d93696d78762", "filename": "editors/code/src/commands/join_lines.ts", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/087af54069d34eef5197e04d64ac322d9ee98085/editors%2Fcode%2Fsrc%2Fcommands%2Fjoin_lines.ts", "raw_url": "https://github.com/rust-lang/rust/raw/087af54069d34eef5197e04d64ac322d9ee98085/editors%2Fcode%2Fsrc%2Fcommands%2Fjoin_lines.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fcommands%2Fjoin_lines.ts?ref=087af54069d34eef5197e04d64ac322d9ee98085", "patch": "@@ -6,13 +6,14 @@ import { applySourceChange, SourceChange } from '../source_change';\n export function joinLines(ctx: Ctx): Cmd {\n     return async () => {\n         const editor = ctx.activeRustEditor;\n-        if (!editor) return;\n+        const client = ctx.client;\n+        if (!editor || !client) return;\n \n         const request: JoinLinesParams = {\n-            range: ctx.client.code2ProtocolConverter.asRange(editor.selection),\n+            range: client.code2ProtocolConverter.asRange(editor.selection),\n             textDocument: { uri: editor.document.uri.toString() },\n         };\n-        const change = await ctx.client.sendRequest<SourceChange>(\n+        const change = await client.sendRequest<SourceChange>(\n             'rust-analyzer/joinLines',\n             request,\n         );"}, {"sha": "13988056aa789e1c0eefb4198aa7cc6a529c9e14", "filename": "editors/code/src/ctx.ts", "status": "modified", "additions": 47, "deletions": 29, "changes": 76, "blob_url": "https://github.com/rust-lang/rust/blob/087af54069d34eef5197e04d64ac322d9ee98085/editors%2Fcode%2Fsrc%2Fctx.ts", "raw_url": "https://github.com/rust-lang/rust/raw/087af54069d34eef5197e04d64ac322d9ee98085/editors%2Fcode%2Fsrc%2Fctx.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fctx.ts?ref=087af54069d34eef5197e04d64ac322d9ee98085", "patch": "@@ -1,19 +1,38 @@\n import * as vscode from 'vscode';\n import * as lc from 'vscode-languageclient';\n-import { Server } from './server';\n import { Config } from './config';\n+import { createClient } from './client'\n \n export class Ctx {\n     readonly config: Config;\n+    // Because we have \"reload server\" action, various listeners **will** face a\n+    // situation where the client is not ready yet, and should be prepared to\n+    // deal with it.\n+    //\n+    // Ideally, this should be replaced with async getter though.\n+    client: lc.LanguageClient | null = null\n     private extCtx: vscode.ExtensionContext;\n+    private onDidRestartHooks: Array<(client: lc.LanguageClient) => void> = [];\n \n     constructor(extCtx: vscode.ExtensionContext) {\n         this.config = new Config(extCtx)\n         this.extCtx = extCtx;\n     }\n \n-    get client(): lc.LanguageClient {\n-        return Server.client;\n+    async restartServer() {\n+        let old = this.client;\n+        if (old) {\n+            await old.stop()\n+        }\n+        this.client = null;\n+        const client = createClient(this.config);\n+        this.pushCleanup(client.start());\n+        await client.onReady();\n+\n+        this.client = client\n+        for (const hook of this.onDidRestartHooks) {\n+            hook(client)\n+        }\n     }\n \n     get activeRustEditor(): vscode.TextEditor | undefined {\n@@ -60,35 +79,34 @@ export class Ctx {\n         this.extCtx.subscriptions.push(d);\n     }\n \n-    async sendRequestWithRetry<R>(\n-        method: string,\n-        param: any,\n-        token?: vscode.CancellationToken,\n-    ): Promise<R> {\n-        await this.client.onReady();\n-        for (const delay of [2, 4, 6, 8, 10, null]) {\n-            try {\n-                return await (token ? this.client.sendRequest(method, param, token) : this.client.sendRequest(method, param));\n-            } catch (e) {\n-                if (\n-                    e.code === lc.ErrorCodes.ContentModified &&\n-                    delay !== null\n-                ) {\n-                    await sleep(10 * (1 << delay));\n-                    continue;\n-                }\n-                throw e;\n-            }\n-        }\n-        throw 'unreachable';\n-    }\n-\n-    onNotification(method: string, handler: lc.GenericNotificationHandler) {\n-        this.client.onReady()\n-            .then(() => this.client.onNotification(method, handler))\n+    onDidRestart(hook: (client: lc.LanguageClient) => void) {\n+        this.onDidRestartHooks.push(hook)\n     }\n }\n \n export type Cmd = (...args: any[]) => any;\n \n+export async function sendRequestWithRetry<R>(\n+    client: lc.LanguageClient,\n+    method: string,\n+    param: any,\n+    token?: vscode.CancellationToken,\n+): Promise<R> {\n+    for (const delay of [2, 4, 6, 8, 10, null]) {\n+        try {\n+            return await (token ? client.sendRequest(method, param, token) : client.sendRequest(method, param));\n+        } catch (e) {\n+            if (\n+                e.code === lc.ErrorCodes.ContentModified &&\n+                delay !== null\n+            ) {\n+                await sleep(10 * (1 << delay));\n+                continue;\n+            }\n+            throw e;\n+        }\n+    }\n+    throw 'unreachable';\n+}\n+\n const sleep = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));"}, {"sha": "f9d2e9d909cb0cbc53b7e232607cdfa17755b1ab", "filename": "editors/code/src/highlighting.ts", "status": "modified", "additions": 31, "deletions": 25, "changes": 56, "blob_url": "https://github.com/rust-lang/rust/blob/087af54069d34eef5197e04d64ac322d9ee98085/editors%2Fcode%2Fsrc%2Fhighlighting.ts", "raw_url": "https://github.com/rust-lang/rust/raw/087af54069d34eef5197e04d64ac322d9ee98085/editors%2Fcode%2Fsrc%2Fhighlighting.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fhighlighting.ts?ref=087af54069d34eef5197e04d64ac322d9ee98085", "patch": "@@ -5,31 +5,32 @@ const seedrandom = seedrandom_; // https://github.com/jvandemo/generator-angular\n \n import { ColorTheme, TextMateRuleSettings } from './color_theme';\n \n-import { Ctx } from './ctx';\n+import { Ctx, sendRequestWithRetry } from './ctx';\n \n export function activateHighlighting(ctx: Ctx) {\n     const highlighter = new Highlighter(ctx);\n-\n-    ctx.onNotification(\n-        'rust-analyzer/publishDecorations',\n-        (params: PublishDecorationsParams) => {\n-            if (!ctx.config.highlightingOn) return;\n-\n-            const targetEditor = vscode.window.visibleTextEditors.find(\n-                editor => {\n-                    const unescapedUri = unescape(\n-                        editor.document.uri.toString(),\n-                    );\n-                    // Unescaped URI looks like:\n-                    // file:///c:/Workspace/ra-test/src/main.rs\n-                    return unescapedUri === params.uri;\n-                },\n-            );\n-            if (!targetEditor) return;\n-\n-            highlighter.setHighlights(targetEditor, params.decorations);\n-        },\n-    );\n+    ctx.onDidRestart(client => {\n+        client.onNotification(\n+            'rust-analyzer/publishDecorations',\n+            (params: PublishDecorationsParams) => {\n+                if (!ctx.config.highlightingOn) return;\n+\n+                const targetEditor = vscode.window.visibleTextEditors.find(\n+                    editor => {\n+                        const unescapedUri = unescape(\n+                            editor.document.uri.toString(),\n+                        );\n+                        // Unescaped URI looks like:\n+                        // file:///c:/Workspace/ra-test/src/main.rs\n+                        return unescapedUri === params.uri;\n+                    },\n+                );\n+                if (!targetEditor) return;\n+\n+                highlighter.setHighlights(targetEditor, params.decorations);\n+            },\n+        );\n+    })\n \n     vscode.workspace.onDidChangeConfiguration(\n         _ => highlighter.removeHighlights(),\n@@ -40,11 +41,14 @@ export function activateHighlighting(ctx: Ctx) {\n         async (editor: vscode.TextEditor | undefined) => {\n             if (!editor || editor.document.languageId !== 'rust') return;\n             if (!ctx.config.highlightingOn) return;\n+            let client = ctx.client;\n+            if (!client) return;\n \n             const params: lc.TextDocumentIdentifier = {\n                 uri: editor.document.uri.toString(),\n             };\n-            const decorations = await ctx.sendRequestWithRetry<Decoration[]>(\n+            const decorations = await sendRequestWithRetry<Decoration[]>(\n+                client,\n                 'rust-analyzer/decorationsRequest',\n                 params,\n             );\n@@ -103,6 +107,8 @@ class Highlighter {\n     }\n \n     public setHighlights(editor: vscode.TextEditor, highlights: Decoration[]) {\n+        let client = this.ctx.client;\n+        if (!client) return;\n         // Initialize decorations if necessary\n         //\n         // Note: decoration objects need to be kept around so we can dispose them\n@@ -135,13 +141,13 @@ class Highlighter {\n                 colorfulIdents\n                     .get(d.bindingHash)![0]\n                     .push(\n-                        this.ctx.client.protocol2CodeConverter.asRange(d.range),\n+                        client.protocol2CodeConverter.asRange(d.range),\n                     );\n             } else {\n                 byTag\n                     .get(d.tag)!\n                     .push(\n-                        this.ctx.client.protocol2CodeConverter.asRange(d.range),\n+                        client.protocol2CodeConverter.asRange(d.range),\n                     );\n             }\n         }"}, {"sha": "e74d6996f844319643c2a392d177e45c445d3843", "filename": "editors/code/src/inlay_hints.ts", "status": "modified", "additions": 6, "deletions": 5, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/087af54069d34eef5197e04d64ac322d9ee98085/editors%2Fcode%2Fsrc%2Finlay_hints.ts", "raw_url": "https://github.com/rust-lang/rust/raw/087af54069d34eef5197e04d64ac322d9ee98085/editors%2Fcode%2Fsrc%2Finlay_hints.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Finlay_hints.ts?ref=087af54069d34eef5197e04d64ac322d9ee98085", "patch": "@@ -1,7 +1,7 @@\n import * as vscode from 'vscode';\n import * as lc from 'vscode-languageclient';\n \n-import { Ctx } from './ctx';\n+import { Ctx, sendRequestWithRetry } from './ctx';\n \n export function activateInlayHints(ctx: Ctx) {\n     const hintsUpdater = new HintsUpdater(ctx);\n@@ -19,9 +19,7 @@ export function activateInlayHints(ctx: Ctx) {\n         hintsUpdater.setEnabled(ctx.config.displayInlayHints);\n     }, ctx.subscriptions);\n \n-    // XXX: don't await here;\n-    // Who knows what happens if an exception is thrown here...\n-    hintsUpdater.refresh();\n+    ctx.onDidRestart(_ => hintsUpdater.setEnabled(ctx.config.displayInlayHints))\n }\n \n interface InlayHintsParams {\n@@ -97,6 +95,8 @@ class HintsUpdater {\n     }\n \n     private async queryHints(documentUri: string): Promise<InlayHint[] | null> {\n+        let client = this.ctx.client;\n+        if (!client) return null\n         const request: InlayHintsParams = {\n             textDocument: { uri: documentUri },\n         };\n@@ -105,7 +105,8 @@ class HintsUpdater {\n         if (prev) prev.cancel();\n         this.pending.set(documentUri, tokenSource);\n         try {\n-            return await this.ctx.sendRequestWithRetry<InlayHint[] | null>(\n+            return await sendRequestWithRetry<InlayHint[] | null>(\n+                client,\n                 'rust-analyzer/inlayHints',\n                 request,\n                 tokenSource.token,"}, {"sha": "22450060b4a0a0e3a73f109821b41137a5634761", "filename": "editors/code/src/main.ts", "status": "modified", "additions": 7, "deletions": 28, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/087af54069d34eef5197e04d64ac322d9ee98085/editors%2Fcode%2Fsrc%2Fmain.ts", "raw_url": "https://github.com/rust-lang/rust/raw/087af54069d34eef5197e04d64ac322d9ee98085/editors%2Fcode%2Fsrc%2Fmain.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fmain.ts?ref=087af54069d34eef5197e04d64ac322d9ee98085", "patch": "@@ -3,7 +3,6 @@ import * as vscode from 'vscode';\n import * as commands from './commands';\n import { activateInlayHints } from './inlay_hints';\n import { activateStatusDisplay } from './status_display';\n-import { Server } from './server';\n import { Ctx } from './ctx';\n import { activateHighlighting } from './highlighting';\n \n@@ -21,6 +20,7 @@ export async function activate(context: vscode.ExtensionContext) {\n     ctx.registerCommand('syntaxTree', commands.syntaxTree);\n     ctx.registerCommand('expandMacro', commands.expandMacro);\n     ctx.registerCommand('run', commands.run);\n+    ctx.registerCommand('reload', commands.reload);\n \n     // Internal commands which are invoked by the server.\n     ctx.registerCommand('runSingle', commands.runSingle);\n@@ -30,38 +30,17 @@ export async function activate(context: vscode.ExtensionContext) {\n     if (ctx.config.enableEnhancedTyping) {\n         ctx.overrideCommand('type', commands.onEnter);\n     }\n-\n-    const startServer = () => Server.start(ctx.config);\n-    const reloadCommand = () => reloadServer(startServer);\n-\n-    vscode.commands.registerCommand('rust-analyzer.reload', reloadCommand);\n-\n+    activateStatusDisplay(ctx);\n+    activateHighlighting(ctx);\n+    activateInlayHints(ctx);\n     // Start the language server, finally!\n     try {\n-        await startServer();\n+        await ctx.restartServer();\n     } catch (e) {\n         vscode.window.showErrorMessage(e.message);\n     }\n-\n-    activateStatusDisplay(ctx);\n-    activateHighlighting(ctx);\n-\n-    if (ctx.config.displayInlayHints) {\n-        activateInlayHints(ctx);\n-    }\n }\n \n-export function deactivate(): Thenable<void> {\n-    if (!Server.client) {\n-        return Promise.resolve();\n-    }\n-    return Server.client.stop();\n-}\n-\n-async function reloadServer(startServer: () => Promise<void>) {\n-    if (Server.client != null) {\n-        vscode.window.showInformationMessage('Reloading rust-analyzer...');\n-        await Server.client.stop();\n-        await startServer();\n-    }\n+export async function deactivate() {\n+    await ctx?.client?.stop();\n }"}, {"sha": "ab9f3bfa63e9b116cf3380ca12d435577f6870c7", "filename": "editors/code/src/server.ts", "status": "removed", "additions": 0, "deletions": 96, "changes": 96, "blob_url": "https://github.com/rust-lang/rust/blob/0849f7001cac6af93ce9e9356f8c21881bbe34c5/editors%2Fcode%2Fsrc%2Fserver.ts", "raw_url": "https://github.com/rust-lang/rust/raw/0849f7001cac6af93ce9e9356f8c21881bbe34c5/editors%2Fcode%2Fsrc%2Fserver.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fserver.ts?ref=0849f7001cac6af93ce9e9356f8c21881bbe34c5", "patch": "@@ -1,96 +0,0 @@\n-import { homedir } from 'os';\n-import * as lc from 'vscode-languageclient';\n-\n-import { window, workspace } from 'vscode';\n-import { Config } from './config';\n-\n-function expandPathResolving(path: string) {\n-    if (path.startsWith('~/')) {\n-        return path.replace('~', homedir());\n-    }\n-    return path;\n-}\n-\n-export class Server {\n-    static config: Config;\n-    public static client: lc.LanguageClient;\n-\n-    public static async start(config: Config) {\n-        // '.' Is the fallback if no folder is open\n-        // TODO?: Workspace folders support Uri's (eg: file://test.txt). It might be a good idea to test if the uri points to a file.\n-        let folder: string = '.';\n-        if (workspace.workspaceFolders !== undefined) {\n-            folder = workspace.workspaceFolders[0].uri.fsPath.toString();\n-        }\n-\n-        this.config = config;\n-        const command = expandPathResolving(this.config.raLspServerPath);\n-        const run: lc.Executable = {\n-            command,\n-            options: { cwd: folder },\n-        };\n-        const serverOptions: lc.ServerOptions = {\n-            run,\n-            debug: run,\n-        };\n-        const traceOutputChannel = window.createOutputChannel(\n-            'Rust Analyzer Language Server Trace',\n-        );\n-        const clientOptions: lc.LanguageClientOptions = {\n-            documentSelector: [{ scheme: 'file', language: 'rust' }],\n-            initializationOptions: {\n-                publishDecorations: true,\n-                lruCapacity: Server.config.lruCapacity,\n-                maxInlayHintLength: Server.config.maxInlayHintLength,\n-                cargoWatchEnable: Server.config.cargoWatchOptions.enable,\n-                cargoWatchArgs: Server.config.cargoWatchOptions.arguments,\n-                cargoWatchCommand: Server.config.cargoWatchOptions.command,\n-                cargoWatchAllTargets:\n-                    Server.config.cargoWatchOptions.allTargets,\n-                excludeGlobs: Server.config.excludeGlobs,\n-                useClientWatching: Server.config.useClientWatching,\n-                featureFlags: Server.config.featureFlags,\n-                withSysroot: Server.config.withSysroot,\n-                cargoFeatures: Server.config.cargoFeatures,\n-            },\n-            traceOutputChannel,\n-        };\n-\n-        Server.client = new lc.LanguageClient(\n-            'rust-analyzer',\n-            'Rust Analyzer Language Server',\n-            serverOptions,\n-            clientOptions,\n-        );\n-        // HACK: This is an awful way of filtering out the decorations notifications\n-        // However, pending proper support, this is the most effecitve approach\n-        // Proper support for this would entail a change to vscode-languageclient to allow not notifying on certain messages\n-        // Or the ability to disable the serverside component of highlighting (but this means that to do tracing we need to disable hihlighting)\n-        // This also requires considering our settings strategy, which is work which needs doing\n-        // @ts-ignore The tracer is private to vscode-languageclient, but we need access to it to not log publishDecorations requests\n-        Server.client._tracer = {\n-            log: (messageOrDataObject: string | any, data?: string) => {\n-                if (typeof messageOrDataObject === 'string') {\n-                    if (\n-                        messageOrDataObject.includes(\n-                            'rust-analyzer/publishDecorations',\n-                        ) ||\n-                        messageOrDataObject.includes(\n-                            'rust-analyzer/decorationsRequest',\n-                        )\n-                    ) {\n-                        // Don't log publish decorations requests\n-                    } else {\n-                        // @ts-ignore This is just a utility function\n-                        Server.client.logTrace(messageOrDataObject, data);\n-                    }\n-                } else {\n-                    // @ts-ignore\n-                    Server.client.logObjectTrace(messageOrDataObject);\n-                }\n-            },\n-        };\n-        Server.client.registerProposedFeatures();\n-        Server.client.start();\n-    }\n-}"}, {"sha": "887191d9e5335eb663e1f81a39586f8f4c1d273a", "filename": "editors/code/src/source_change.ts", "status": "modified", "additions": 6, "deletions": 3, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/087af54069d34eef5197e04d64ac322d9ee98085/editors%2Fcode%2Fsrc%2Fsource_change.ts", "raw_url": "https://github.com/rust-lang/rust/raw/087af54069d34eef5197e04d64ac322d9ee98085/editors%2Fcode%2Fsrc%2Fsource_change.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fsource_change.ts?ref=087af54069d34eef5197e04d64ac322d9ee98085", "patch": "@@ -10,7 +10,10 @@ export interface SourceChange {\n }\n \n export async function applySourceChange(ctx: Ctx, change: SourceChange) {\n-    const wsEdit = ctx.client.protocol2CodeConverter.asWorkspaceEdit(\n+    const client = ctx.client;\n+    if (!client) return\n+\n+    const wsEdit = client.protocol2CodeConverter.asWorkspaceEdit(\n         change.workspaceEdit,\n     );\n     let created;\n@@ -32,10 +35,10 @@ export async function applySourceChange(ctx: Ctx, change: SourceChange) {\n         const doc = await vscode.workspace.openTextDocument(toOpenUri);\n         await vscode.window.showTextDocument(doc);\n     } else if (toReveal) {\n-        const uri = ctx.client.protocol2CodeConverter.asUri(\n+        const uri = client.protocol2CodeConverter.asUri(\n             toReveal.textDocument.uri,\n         );\n-        const position = ctx.client.protocol2CodeConverter.asPosition(\n+        const position = client.protocol2CodeConverter.asPosition(\n             toReveal.position,\n         );\n         const editor = vscode.window.activeTextEditor;"}, {"sha": "1454bf8b00cf2824e68b6cf619cf483811ae2b01", "filename": "editors/code/src/status_display.ts", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/087af54069d34eef5197e04d64ac322d9ee98085/editors%2Fcode%2Fsrc%2Fstatus_display.ts", "raw_url": "https://github.com/rust-lang/rust/raw/087af54069d34eef5197e04d64ac322d9ee98085/editors%2Fcode%2Fsrc%2Fstatus_display.ts", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/editors%2Fcode%2Fsrc%2Fstatus_display.ts?ref=087af54069d34eef5197e04d64ac322d9ee98085", "patch": "@@ -7,7 +7,9 @@ const spinnerFrames = ['\u280b', '\u2819', '\u2839', '\u2838', '\u283c', '\u2834', '\u2826', '\u2827', '\n export function activateStatusDisplay(ctx: Ctx) {\n     const statusDisplay = new StatusDisplay(ctx.config.cargoWatchOptions.command);\n     ctx.pushCleanup(statusDisplay);\n-    ctx.onNotification('$/progress', params => statusDisplay.handleProgressNotification(params));\n+    ctx.onDidRestart(client => {\n+        client.onNotification('$/progress', params => statusDisplay.handleProgressNotification(params));\n+    })\n }\n \n class StatusDisplay implements vscode.Disposable {"}]}