{"sha": "996fb664d3b069001b9213a41898051d99228306", "node_id": "C_kwDOAAsO6NoAKDk5NmZiNjY0ZDNiMDY5MDAxYjkyMTNhNDE4OTgwNTFkOTkyMjgzMDY", "commit": {"author": {"name": "Michael Goulet", "email": "michael@errs.io", "date": "2022-12-27T20:33:34Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-12-27T20:33:34Z"}, "message": "Rollup merge of #105852 - compiler-errors:hex-float-lit, r=cjgillot\n\nSuggest rewriting a malformed hex literal if we expect a float\n\nFixes #104706", "tree": {"sha": "102ce9d1ff91184b5cabde2ea7d28857fe59969f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/102ce9d1ff91184b5cabde2ea7d28857fe59969f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/996fb664d3b069001b9213a41898051d99228306", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjq1aeCRBK7hj4Ov3rIwAA748IAEPGFL5BDhzCRx5F9H3J+FRE\nYAcGqX08xcZGJyhPdO0jhxovwRfLsvrerU3xlEHElZfVx06RrAOjs1MWPPlwiTPG\nPLu0G0xRxxJ8fIrUYCpw040sHMYs8Ht1tzZ3CNdW0O/TDBpT/WByl8gd+GGMFEqQ\n3pNnwLEZaZCPoJRf0nxOUzeULbz3Shci74nvgCAXf4BC5y7jECsAQTEDBMeW1WEK\nKklCt0gxigZMtHCqD+TyHNO0ISyeWc2ThA5K0tlu9djpG034gulOYgIENnDj9BlL\naazJj0ISe0cBJHKR4DoBjz8uYV6snlNMjcwLcNPS+UfQcgKA77dX9gR6O4BcvB8=\n=NG1w\n-----END PGP SIGNATURE-----\n", "payload": "tree 102ce9d1ff91184b5cabde2ea7d28857fe59969f\nparent a9fdeddafd8c5ce08dd8d61a86201ae9e1e71046\nparent 3cf22de90fcc23100bbecae3925896409d36aaa9\nauthor Michael Goulet <michael@errs.io> 1672173214 -0800\ncommitter GitHub <noreply@github.com> 1672173214 -0800\n\nRollup merge of #105852 - compiler-errors:hex-float-lit, r=cjgillot\n\nSuggest rewriting a malformed hex literal if we expect a float\n\nFixes #104706\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/996fb664d3b069001b9213a41898051d99228306", "html_url": "https://github.com/rust-lang/rust/commit/996fb664d3b069001b9213a41898051d99228306", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/996fb664d3b069001b9213a41898051d99228306/comments", "author": {"login": "compiler-errors", "id": 3674314, "node_id": "MDQ6VXNlcjM2NzQzMTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/3674314?v=4", "gravatar_id": "", "url": "https://api.github.com/users/compiler-errors", "html_url": "https://github.com/compiler-errors", "followers_url": "https://api.github.com/users/compiler-errors/followers", "following_url": "https://api.github.com/users/compiler-errors/following{/other_user}", "gists_url": "https://api.github.com/users/compiler-errors/gists{/gist_id}", "starred_url": "https://api.github.com/users/compiler-errors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/compiler-errors/subscriptions", "organizations_url": "https://api.github.com/users/compiler-errors/orgs", "repos_url": "https://api.github.com/users/compiler-errors/repos", "events_url": "https://api.github.com/users/compiler-errors/events{/privacy}", "received_events_url": "https://api.github.com/users/compiler-errors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a9fdeddafd8c5ce08dd8d61a86201ae9e1e71046", "url": "https://api.github.com/repos/rust-lang/rust/commits/a9fdeddafd8c5ce08dd8d61a86201ae9e1e71046", "html_url": "https://github.com/rust-lang/rust/commit/a9fdeddafd8c5ce08dd8d61a86201ae9e1e71046"}, {"sha": "3cf22de90fcc23100bbecae3925896409d36aaa9", "url": "https://api.github.com/repos/rust-lang/rust/commits/3cf22de90fcc23100bbecae3925896409d36aaa9", "html_url": "https://github.com/rust-lang/rust/commit/3cf22de90fcc23100bbecae3925896409d36aaa9"}], "stats": {"total": 87, "additions": 87, "deletions": 0}, "files": [{"sha": "e38d1bccc10657199fcc4ff2515c2136867a19d2", "filename": "compiler/rustc_hir_typeck/src/fn_ctxt/suggestions.rs", "status": "modified", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/996fb664d3b069001b9213a41898051d99228306/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2Fsuggestions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/996fb664d3b069001b9213a41898051d99228306/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2Fsuggestions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2Fsuggestions.rs?ref=996fb664d3b069001b9213a41898051d99228306", "patch": "@@ -19,6 +19,7 @@ use rustc_middle::ty::{\n     TypeVisitable,\n };\n use rustc_session::errors::ExprParenthesesNeeded;\n+use rustc_span::source_map::Spanned;\n use rustc_span::symbol::{sym, Ident};\n use rustc_span::{Span, Symbol};\n use rustc_trait_selection::infer::InferCtxtExt;\n@@ -1259,6 +1260,31 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                 );\n                 true\n             }\n+            ExprKind::Lit(Spanned {\n+                node: rustc_ast::LitKind::Int(lit, rustc_ast::LitIntType::Unsuffixed),\n+                span,\n+            }) => {\n+                let Ok(snippet) = self.tcx.sess.source_map().span_to_snippet(span) else { return false; };\n+                if !(snippet.starts_with(\"0x\") || snippet.starts_with(\"0X\")) {\n+                    return false;\n+                }\n+                if snippet.len() <= 5 || !snippet.is_char_boundary(snippet.len() - 3) {\n+                    return false;\n+                }\n+                let (_, suffix) = snippet.split_at(snippet.len() - 3);\n+                let value = match suffix {\n+                    \"f32\" => (lit - 0xf32) / (16 * 16 * 16),\n+                    \"f64\" => (lit - 0xf64) / (16 * 16 * 16),\n+                    _ => return false,\n+                };\n+                err.span_suggestions(\n+                    expr.span,\n+                    \"rewrite this as a decimal floating point literal, or use `as` to turn a hex literal into a float\",\n+                    [format!(\"0x{value:X} as {suffix}\"), format!(\"{value}_{suffix}\")],\n+                    Applicability::MaybeIncorrect,\n+                );\n+                true\n+            }\n             _ => false,\n         }\n     }"}, {"sha": "cd6fdbde96c0c2d5519485a7d1dba7f7fc35457f", "filename": "src/test/ui/suggestions/bad-hex-float-lit.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/996fb664d3b069001b9213a41898051d99228306/src%2Ftest%2Fui%2Fsuggestions%2Fbad-hex-float-lit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/996fb664d3b069001b9213a41898051d99228306/src%2Ftest%2Fui%2Fsuggestions%2Fbad-hex-float-lit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggestions%2Fbad-hex-float-lit.rs?ref=996fb664d3b069001b9213a41898051d99228306", "patch": "@@ -0,0 +1,13 @@\n+fn main() {\n+    let _f: f32 = 0xAAf32;\n+    //~^ ERROR mismatched types\n+    //~| HELP rewrite this\n+\n+    let _f: f32 = 0xAB_f32;\n+    //~^ ERROR mismatched types\n+    //~| HELP rewrite this\n+\n+    let _f: f64 = 0xFF_f64;\n+    //~^ ERROR mismatched types\n+    //~| HELP rewrite this\n+}"}, {"sha": "bc09abb1a5671732978059f89b91e7fdf2c93d03", "filename": "src/test/ui/suggestions/bad-hex-float-lit.stderr", "status": "added", "additions": 48, "deletions": 0, "changes": 48, "blob_url": "https://github.com/rust-lang/rust/blob/996fb664d3b069001b9213a41898051d99228306/src%2Ftest%2Fui%2Fsuggestions%2Fbad-hex-float-lit.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/996fb664d3b069001b9213a41898051d99228306/src%2Ftest%2Fui%2Fsuggestions%2Fbad-hex-float-lit.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fsuggestions%2Fbad-hex-float-lit.stderr?ref=996fb664d3b069001b9213a41898051d99228306", "patch": "@@ -0,0 +1,48 @@\n+error[E0308]: mismatched types\n+  --> $DIR/bad-hex-float-lit.rs:2:19\n+   |\n+LL |     let _f: f32 = 0xAAf32;\n+   |             ---   ^^^^^^^ expected `f32`, found integer\n+   |             |\n+   |             expected due to this\n+   |\n+help: rewrite this as a decimal floating point literal, or use `as` to turn a hex literal into a float\n+   |\n+LL |     let _f: f32 = 0xAA as f32;\n+   |                   ~~~~~~~~~~~\n+LL |     let _f: f32 = 170_f32;\n+   |                   ~~~~~~~\n+\n+error[E0308]: mismatched types\n+  --> $DIR/bad-hex-float-lit.rs:6:19\n+   |\n+LL |     let _f: f32 = 0xAB_f32;\n+   |             ---   ^^^^^^^^ expected `f32`, found integer\n+   |             |\n+   |             expected due to this\n+   |\n+help: rewrite this as a decimal floating point literal, or use `as` to turn a hex literal into a float\n+   |\n+LL |     let _f: f32 = 0xAB as f32;\n+   |                   ~~~~~~~~~~~\n+LL |     let _f: f32 = 171_f32;\n+   |                   ~~~~~~~\n+\n+error[E0308]: mismatched types\n+  --> $DIR/bad-hex-float-lit.rs:10:19\n+   |\n+LL |     let _f: f64 = 0xFF_f64;\n+   |             ---   ^^^^^^^^ expected `f64`, found integer\n+   |             |\n+   |             expected due to this\n+   |\n+help: rewrite this as a decimal floating point literal, or use `as` to turn a hex literal into a float\n+   |\n+LL |     let _f: f64 = 0xFF as f64;\n+   |                   ~~~~~~~~~~~\n+LL |     let _f: f64 = 255_f64;\n+   |                   ~~~~~~~\n+\n+error: aborting due to 3 previous errors\n+\n+For more information about this error, try `rustc --explain E0308`."}]}