{"sha": "ae7d6facdaf2aab55e53e6d4b44003940819a27f", "node_id": "C_kwDOAAsO6NoAKGFlN2Q2ZmFjZGFmMmFhYjU1ZTUzZTZkNGI0NDAwMzk0MDgxOWEyN2Y", "commit": {"author": {"name": "Jakob Degen", "email": "jakob.e.degen@gmail.com", "date": "2022-04-22T20:43:26Z"}, "committer": {"name": "Jakob Degen", "email": "jakob.e.degen@gmail.com", "date": "2022-04-22T20:45:15Z"}, "message": "Relax restrictions for copy operands", "tree": {"sha": "d2f6ec640dbbdeecc79da6a23e80d8ea47adf69c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d2f6ec640dbbdeecc79da6a23e80d8ea47adf69c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ae7d6facdaf2aab55e53e6d4b44003940819a27f", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ae7d6facdaf2aab55e53e6d4b44003940819a27f", "html_url": "https://github.com/rust-lang/rust/commit/ae7d6facdaf2aab55e53e6d4b44003940819a27f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ae7d6facdaf2aab55e53e6d4b44003940819a27f/comments", "author": {"login": "JakobDegen", "id": 51179609, "node_id": "MDQ6VXNlcjUxMTc5NjA5", "avatar_url": "https://avatars.githubusercontent.com/u/51179609?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JakobDegen", "html_url": "https://github.com/JakobDegen", "followers_url": "https://api.github.com/users/JakobDegen/followers", "following_url": "https://api.github.com/users/JakobDegen/following{/other_user}", "gists_url": "https://api.github.com/users/JakobDegen/gists{/gist_id}", "starred_url": "https://api.github.com/users/JakobDegen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JakobDegen/subscriptions", "organizations_url": "https://api.github.com/users/JakobDegen/orgs", "repos_url": "https://api.github.com/users/JakobDegen/repos", "events_url": "https://api.github.com/users/JakobDegen/events{/privacy}", "received_events_url": "https://api.github.com/users/JakobDegen/received_events", "type": "User", "site_admin": false}, "committer": {"login": "JakobDegen", "id": 51179609, "node_id": "MDQ6VXNlcjUxMTc5NjA5", "avatar_url": "https://avatars.githubusercontent.com/u/51179609?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JakobDegen", "html_url": "https://github.com/JakobDegen", "followers_url": "https://api.github.com/users/JakobDegen/followers", "following_url": "https://api.github.com/users/JakobDegen/following{/other_user}", "gists_url": "https://api.github.com/users/JakobDegen/gists{/gist_id}", "starred_url": "https://api.github.com/users/JakobDegen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JakobDegen/subscriptions", "organizations_url": "https://api.github.com/users/JakobDegen/orgs", "repos_url": "https://api.github.com/users/JakobDegen/repos", "events_url": "https://api.github.com/users/JakobDegen/events{/privacy}", "received_events_url": "https://api.github.com/users/JakobDegen/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5ffebc2cb3a089c27a4c7da13d09fd2365c288aa", "url": "https://api.github.com/repos/rust-lang/rust/commits/5ffebc2cb3a089c27a4c7da13d09fd2365c288aa", "html_url": "https://github.com/rust-lang/rust/commit/5ffebc2cb3a089c27a4c7da13d09fd2365c288aa"}], "stats": {"total": 11, "additions": 8, "deletions": 3}, "files": [{"sha": "f71bc586b4847e3d92b2ac6f7a35123ed0ba3ee3", "filename": "compiler/rustc_const_eval/src/transform/validate.rs", "status": "modified", "additions": 2, "deletions": 1, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/ae7d6facdaf2aab55e53e6d4b44003940819a27f/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fvalidate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ae7d6facdaf2aab55e53e6d4b44003940819a27f/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fvalidate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fvalidate.rs?ref=ae7d6facdaf2aab55e53e6d4b44003940819a27f", "patch": "@@ -214,7 +214,8 @@ impl<'a, 'tcx> Visitor<'tcx> for TypeChecker<'a, 'tcx> {\n \n     fn visit_operand(&mut self, operand: &Operand<'tcx>, location: Location) {\n         // This check is somewhat expensive, so only run it when -Zvalidate-mir is passed.\n-        if self.tcx.sess.opts.debugging_opts.validate_mir {\n+        if self.tcx.sess.opts.debugging_opts.validate_mir && self.mir_phase < MirPhase::DropsLowered\n+        {\n             // `Operand::Copy` is only supposed to be used with `Copy` types.\n             if let Operand::Copy(place) = operand {\n                 let ty = place.ty(&self.body.local_decls, self.tcx).ty;"}, {"sha": "881f59ae464c93ababca1442fe0a67e7f2909d7b", "filename": "compiler/rustc_middle/src/mir/mod.rs", "status": "modified", "additions": 6, "deletions": 2, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ae7d6facdaf2aab55e53e6d4b44003940819a27f/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ae7d6facdaf2aab55e53e6d4b44003940819a27f/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fmir%2Fmod.rs?ref=ae7d6facdaf2aab55e53e6d4b44003940819a27f", "patch": "@@ -166,7 +166,8 @@ pub enum MirPhase {\n     /// * [`StatementKind::Retag`]\n     ///\n     /// Furthermore, `Drop` now uses explicit drop flags visible in the MIR and reaching a `Drop`\n-    /// terminator means that the auto-generated drop glue will be invoked.\n+    /// terminator means that the auto-generated drop glue will be invoked. Also, `Copy` operands\n+    /// are allowed for non-`Copy` types.\n     DropsLowered = 3,\n     /// Beginning with this phase, the following variant is disallowed:\n     /// * [`Rvalue::Aggregate`] for any `AggregateKind` except `Array`\n@@ -2330,7 +2331,10 @@ pub struct SourceScopeLocalData {\n /// validator.\n #[derive(Clone, PartialEq, TyEncodable, TyDecodable, Hash, HashStable)]\n pub enum Operand<'tcx> {\n-    /// Creates a value by loading the given place. The type of the place must be `Copy`\n+    /// Creates a value by loading the given place.\n+    ///\n+    /// Before drop elaboration, the type of the place must be `Copy`. After drop elaboration there\n+    /// is no such requirement.\n     Copy(Place<'tcx>),\n \n     /// Creates a value by performing loading the place, just like the `Copy` operand."}]}