{"sha": "adbda9430355d5826afb01fcff40afb50c1e49eb", "node_id": "C_kwDOAAsO6NoAKGFkYmRhOTQzMDM1NWQ1ODI2YWZiMDFmY2ZmNDBhZmI1MGMxZTQ5ZWI", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-03-15T11:44:29Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-03-15T11:44:29Z"}, "message": "Auto merge of #14359 - Veykril:opt-out-retry, r=Veykril\n\nfix: Do not retry inlay hint requests\n\nShould close https://github.com/rust-lang/rust-analyzer/issues/13372, retrying the way its currently implemented is not ideal as we do not adjust offsets in the requests, but doing that is a major PITA, so this should at least work around one of the more annoying issues stemming from it.", "tree": {"sha": "0cd3dd2204384bf13676b738041b5f86e900e723", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0cd3dd2204384bf13676b738041b5f86e900e723"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/adbda9430355d5826afb01fcff40afb50c1e49eb", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/adbda9430355d5826afb01fcff40afb50c1e49eb", "html_url": "https://github.com/rust-lang/rust/commit/adbda9430355d5826afb01fcff40afb50c1e49eb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/adbda9430355d5826afb01fcff40afb50c1e49eb/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1787c14e725e4ac416828f986b095a23ecd11494", "url": "https://api.github.com/repos/rust-lang/rust/commits/1787c14e725e4ac416828f986b095a23ecd11494", "html_url": "https://github.com/rust-lang/rust/commit/1787c14e725e4ac416828f986b095a23ecd11494"}, {"sha": "74e08cb60d33e998d89a2a53fcceab48e574045e", "url": "https://api.github.com/repos/rust-lang/rust/commits/74e08cb60d33e998d89a2a53fcceab48e574045e", "html_url": "https://github.com/rust-lang/rust/commit/74e08cb60d33e998d89a2a53fcceab48e574045e"}], "stats": {"total": 38, "additions": 37, "deletions": 1}, "files": [{"sha": "313bb2ec8dffa8dfa3583331a2c76db8bfc60f3a", "filename": "crates/rust-analyzer/src/dispatch.rs", "status": "modified", "additions": 36, "deletions": 0, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/adbda9430355d5826afb01fcff40afb50c1e49eb/crates%2Frust-analyzer%2Fsrc%2Fdispatch.rs", "raw_url": "https://github.com/rust-lang/rust/raw/adbda9430355d5826afb01fcff40afb50c1e49eb/crates%2Frust-analyzer%2Fsrc%2Fdispatch.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fdispatch.rs?ref=adbda9430355d5826afb01fcff40afb50c1e49eb", "patch": "@@ -87,6 +87,42 @@ impl<'a> RequestDispatcher<'a> {\n         self\n     }\n \n+    /// Dispatches the request onto thread pool\n+    pub(crate) fn on_no_retry<R>(\n+        &mut self,\n+        f: fn(GlobalStateSnapshot, R::Params) -> Result<R::Result>,\n+    ) -> &mut Self\n+    where\n+        R: lsp_types::request::Request + 'static,\n+        R::Params: DeserializeOwned + panic::UnwindSafe + Send + fmt::Debug,\n+        R::Result: Serialize,\n+    {\n+        let (req, params, panic_context) = match self.parse::<R>() {\n+            Some(it) => it,\n+            None => return self,\n+        };\n+\n+        self.global_state.task_pool.handle.spawn({\n+            let world = self.global_state.snapshot();\n+            move || {\n+                let result = panic::catch_unwind(move || {\n+                    let _pctx = stdx::panic_context::enter(panic_context);\n+                    f(world, params)\n+                });\n+                match thread_result_to_response::<R>(req.id.clone(), result) {\n+                    Ok(response) => Task::Response(response),\n+                    Err(_) => Task::Response(lsp_server::Response::new_err(\n+                        req.id,\n+                        lsp_server::ErrorCode::ContentModified as i32,\n+                        \"content modified\".to_string(),\n+                    )),\n+                }\n+            }\n+        });\n+\n+        self\n+    }\n+\n     /// Dispatches the request onto thread pool\n     pub(crate) fn on<R>(\n         &mut self,"}, {"sha": "67a54cde68c6f9aa586aeb1b1ea09e7939eb4022", "filename": "crates/rust-analyzer/src/main_loop.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/adbda9430355d5826afb01fcff40afb50c1e49eb/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/adbda9430355d5826afb01fcff40afb50c1e49eb/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fmain_loop.rs?ref=adbda9430355d5826afb01fcff40afb50c1e49eb", "patch": "@@ -663,7 +663,7 @@ impl GlobalState {\n             .on::<lsp_types::request::GotoDeclaration>(handlers::handle_goto_declaration)\n             .on::<lsp_types::request::GotoImplementation>(handlers::handle_goto_implementation)\n             .on::<lsp_types::request::GotoTypeDefinition>(handlers::handle_goto_type_definition)\n-            .on::<lsp_types::request::InlayHintRequest>(handlers::handle_inlay_hints)\n+            .on_no_retry::<lsp_types::request::InlayHintRequest>(handlers::handle_inlay_hints)\n             .on::<lsp_types::request::InlayHintResolveRequest>(handlers::handle_inlay_hints_resolve)\n             .on::<lsp_types::request::Completion>(handlers::handle_completion)\n             .on::<lsp_types::request::ResolveCompletionItem>(handlers::handle_completion_resolve)"}]}