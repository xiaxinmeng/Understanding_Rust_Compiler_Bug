{"sha": "e163e3c0434041dae60c575854758dd68ddb6b16", "node_id": "MDY6Q29tbWl0NzI0NzEyOmUxNjNlM2MwNDM0MDQxZGFlNjBjNTc1ODU0NzU4ZGQ2OGRkYjZiMTY=", "commit": {"author": {"name": "Yuki Okushi", "email": "jtitor@2k36.org", "date": "2021-06-09T03:04:07Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-06-09T03:04:07Z"}, "message": "Rollup merge of #86128 - jsha:render-impl-into-mod, r=GuillaumeGomez\n\nRefactor: Extract render_summary from render_impl.\n\nThis allows for a more readable straight-through logic in render_impl without need for a closure.\n\nI think this will make #85970 a bit more of a straightforward change.\n\nThis is a pure refactoring. I've verified that the output of `x.py doc library/std` is byte-for-byte identical.\n\nr? `@GuillaumeGomez`", "tree": {"sha": "d48fdb385ef63692c43333ca40c36907c07282e0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d48fdb385ef63692c43333ca40c36907c07282e0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e163e3c0434041dae60c575854758dd68ddb6b16", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgwC+nCRBK7hj4Ov3rIwAAJbwIAKMU9PMlCflpj+4s9FkMXYNP\nnK86rJSMmwhsL98K9yXIxCDGNthFlOHshcv0///jF+85mmylseBA6+jyHuOcblOA\nZKZv//lCkoL9vFtrmwqqhAzGcDVKzqbOG1bNdp94Y6KBBqMfKWH0tbeacknhQCoJ\nr/nX6jrY1j8jbbMeGXgnhlGzUGmwCuyxVHSrsxbZkllPOxL2SAFWFgwBw0D2pxl6\n3sBcchCDL3WV6bFUE4Fb305H+W3p8+WokmvaNhrsO8P20O4Hem+4gwXfH8zc13Ph\noBANfZ/5X54PXRlGYCeRt/zaWq+b/JECzHNVXtTbAzoVnDuhfE+5HoFjb5DFUHs=\n=rDGf\n-----END PGP SIGNATURE-----\n", "payload": "tree d48fdb385ef63692c43333ca40c36907c07282e0\nparent d7186a8efe834cc1b216375cb799786de97297f5\nparent 1c0ecd41add4f7ba3b07afc3aeafcead465a8970\nauthor Yuki Okushi <jtitor@2k36.org> 1623207847 +0900\ncommitter GitHub <noreply@github.com> 1623207847 +0900\n\nRollup merge of #86128 - jsha:render-impl-into-mod, r=GuillaumeGomez\n\nRefactor: Extract render_summary from render_impl.\n\nThis allows for a more readable straight-through logic in render_impl without need for a closure.\n\nI think this will make #85970 a bit more of a straightforward change.\n\nThis is a pure refactoring. I've verified that the output of `x.py doc library/std` is byte-for-byte identical.\n\nr? `@GuillaumeGomez`\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e163e3c0434041dae60c575854758dd68ddb6b16", "html_url": "https://github.com/rust-lang/rust/commit/e163e3c0434041dae60c575854758dd68ddb6b16", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e163e3c0434041dae60c575854758dd68ddb6b16/comments", "author": {"login": "JohnTitor", "id": 25030997, "node_id": "MDQ6VXNlcjI1MDMwOTk3", "avatar_url": "https://avatars.githubusercontent.com/u/25030997?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JohnTitor", "html_url": "https://github.com/JohnTitor", "followers_url": "https://api.github.com/users/JohnTitor/followers", "following_url": "https://api.github.com/users/JohnTitor/following{/other_user}", "gists_url": "https://api.github.com/users/JohnTitor/gists{/gist_id}", "starred_url": "https://api.github.com/users/JohnTitor/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JohnTitor/subscriptions", "organizations_url": "https://api.github.com/users/JohnTitor/orgs", "repos_url": "https://api.github.com/users/JohnTitor/repos", "events_url": "https://api.github.com/users/JohnTitor/events{/privacy}", "received_events_url": "https://api.github.com/users/JohnTitor/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d7186a8efe834cc1b216375cb799786de97297f5", "url": "https://api.github.com/repos/rust-lang/rust/commits/d7186a8efe834cc1b216375cb799786de97297f5", "html_url": "https://github.com/rust-lang/rust/commit/d7186a8efe834cc1b216375cb799786de97297f5"}, {"sha": "1c0ecd41add4f7ba3b07afc3aeafcead465a8970", "url": "https://api.github.com/repos/rust-lang/rust/commits/1c0ecd41add4f7ba3b07afc3aeafcead465a8970", "html_url": "https://github.com/rust-lang/rust/commit/1c0ecd41add4f7ba3b07afc3aeafcead465a8970"}], "stats": {"total": 164, "additions": 86, "deletions": 78}, "files": [{"sha": "2e940a31c2aff0e540cb487e08c6d5c4a76115a7", "filename": "src/librustdoc/html/render/mod.rs", "status": "modified", "additions": 86, "deletions": 78, "changes": 164, "blob_url": "https://github.com/rust-lang/rust/blob/e163e3c0434041dae60c575854758dd68ddb6b16/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e163e3c0434041dae60c575854758dd68ddb6b16/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fmod.rs?ref=e163e3c0434041dae60c575854758dd68ddb6b16", "patch": "@@ -1286,7 +1286,6 @@ fn render_impl(\n     // in documentation pages for trait with automatic implementations like \"Send\" and \"Sync\".\n     aliases: &[String],\n ) {\n-    let tcx = cx.tcx();\n     let cache = cx.cache();\n     let traits = &cache.traits;\n     let trait_ = i.trait_did_full(cache).map(|did| &traits[&did]);\n@@ -1558,94 +1557,34 @@ fn render_impl(\n             );\n         }\n     }\n-    let toggled = !impl_items.is_empty() || !default_impl_items.is_empty();\n-    let open_details = |close_tags: &mut String, is_collapsed: bool| {\n+    if render_mode == RenderMode::Normal {\n+        let is_implementing_trait = i.inner_impl().trait_.is_some();\n+        let toggled = !impl_items.is_empty() || !default_impl_items.is_empty();\n         if toggled {\n             close_tags.insert_str(0, \"</details>\");\n-            if is_collapsed {\n-                \"<details class=\\\"rustdoc-toggle implementors-toggle\\\"><summary>\"\n+            if is_implementing_trait {\n+                write!(w, \"<details class=\\\"rustdoc-toggle implementors-toggle\\\">\");\n             } else {\n-                \"<details class=\\\"rustdoc-toggle implementors-toggle\\\" open><summary>\"\n+                write!(w, \"<details class=\\\"rustdoc-toggle implementors-toggle\\\" open>\");\n             }\n-        } else {\n-            \"\"\n         }\n-    };\n-    if render_mode == RenderMode::Normal {\n-        let is_implementing_trait;\n-        let id = cx.derive_id(match i.inner_impl().trait_ {\n-            Some(ref t) => {\n-                is_implementing_trait = true;\n-                if is_on_foreign_type {\n-                    get_id_for_impl_on_foreign_type(&i.inner_impl().for_, t, cx)\n-                } else {\n-                    format!(\"impl-{}\", small_url_encode(format!(\"{:#}\", t.print(cx))))\n-                }\n-            }\n-            None => {\n-                is_implementing_trait = false;\n-                \"impl\".to_string()\n-            }\n-        });\n-        let aliases = if aliases.is_empty() {\n-            String::new()\n-        } else {\n-            format!(\" data-aliases=\\\"{}\\\"\", aliases.join(\",\"))\n-        };\n-        if let Some(use_absolute) = use_absolute {\n-            write!(\n-                w,\n-                \"{}<div id=\\\"{}\\\" class=\\\"impl has-srclink\\\"{}>\\\n-                     <code class=\\\"in-band\\\">\",\n-                open_details(&mut close_tags, is_implementing_trait),\n-                id,\n-                aliases\n-            );\n-            write!(w, \"{}\", i.inner_impl().print(use_absolute, cx));\n-            if show_def_docs {\n-                for it in &i.inner_impl().items {\n-                    if let clean::TypedefItem(ref tydef, _) = *it.kind {\n-                        w.write_str(\"<span class=\\\"where fmt-newline\\\">  \");\n-                        assoc_type(\n-                            w,\n-                            it,\n-                            &[],\n-                            Some(&tydef.type_),\n-                            AssocItemLink::Anchor(None),\n-                            \"\",\n-                            cx,\n-                        );\n-                        w.write_str(\";</span>\");\n-                    }\n-                }\n-            }\n-            w.write_str(\"</code>\");\n-        } else {\n-            write!(\n-                w,\n-                \"{}<div id=\\\"{}\\\" class=\\\"impl has-srclink\\\"{}>\\\n-                     <code class=\\\"in-band\\\">{}</code>\",\n-                open_details(&mut close_tags, is_implementing_trait),\n-                id,\n-                aliases,\n-                i.inner_impl().print(false, cx)\n-            );\n+        if toggled {\n+            write!(w, \"<summary>\")\n         }\n-        write!(w, \"<a href=\\\"#{}\\\" class=\\\"anchor\\\"></a>\", id);\n-        render_stability_since_raw(\n+        render_impl_summary(\n             w,\n-            i.impl_item.stable_since(tcx).as_deref(),\n-            i.impl_item.const_stable_since(tcx).as_deref(),\n+            cx,\n+            i,\n             outer_version,\n             outer_const_version,\n+            show_def_docs,\n+            use_absolute,\n+            is_on_foreign_type,\n+            aliases,\n         );\n-        write_srclink(cx, &i.impl_item, w);\n-        if !toggled {\n-            w.write_str(\"</div>\");\n-        } else {\n-            w.write_str(\"</div></summary>\");\n+        if toggled {\n+            write!(w, \"</summary>\")\n         }\n-\n         if trait_.is_some() {\n             if let Some(portability) = portability(&i.impl_item, Some(parent)) {\n                 write!(w, \"<div class=\\\"item-info\\\">{}</div>\", portability);\n@@ -1678,6 +1617,75 @@ fn render_impl(\n     w.write_str(&close_tags);\n }\n \n+fn render_impl_summary(\n+    w: &mut Buffer,\n+    cx: &Context<'_>,\n+    i: &Impl,\n+    outer_version: Option<&str>,\n+    outer_const_version: Option<&str>,\n+    show_def_docs: bool,\n+    use_absolute: Option<bool>,\n+    is_on_foreign_type: bool,\n+    // This argument is used to reference same type with different paths to avoid duplication\n+    // in documentation pages for trait with automatic implementations like \"Send\" and \"Sync\".\n+    aliases: &[String],\n+) {\n+    let tcx = cx.tcx();\n+    let id = cx.derive_id(match i.inner_impl().trait_ {\n+        Some(ref t) => {\n+            if is_on_foreign_type {\n+                get_id_for_impl_on_foreign_type(&i.inner_impl().for_, t, cx)\n+            } else {\n+                format!(\"impl-{}\", small_url_encode(format!(\"{:#}\", t.print(cx))))\n+            }\n+        }\n+        None => \"impl\".to_string(),\n+    });\n+    let aliases = if aliases.is_empty() {\n+        String::new()\n+    } else {\n+        format!(\" data-aliases=\\\"{}\\\"\", aliases.join(\",\"))\n+    };\n+    if let Some(use_absolute) = use_absolute {\n+        write!(\n+            w,\n+            \"<div id=\\\"{}\\\" class=\\\"impl has-srclink\\\"{}>\\\n+                     <code class=\\\"in-band\\\">\",\n+            id, aliases\n+        );\n+        write!(w, \"{}\", i.inner_impl().print(use_absolute, cx));\n+        if show_def_docs {\n+            for it in &i.inner_impl().items {\n+                if let clean::TypedefItem(ref tydef, _) = *it.kind {\n+                    w.write_str(\"<span class=\\\"where fmt-newline\\\">  \");\n+                    assoc_type(w, it, &[], Some(&tydef.type_), AssocItemLink::Anchor(None), \"\", cx);\n+                    w.write_str(\";</span>\");\n+                }\n+            }\n+        }\n+        w.write_str(\"</code>\");\n+    } else {\n+        write!(\n+            w,\n+            \"<div id=\\\"{}\\\" class=\\\"impl has-srclink\\\"{}>\\\n+                     <code class=\\\"in-band\\\">{}</code>\",\n+            id,\n+            aliases,\n+            i.inner_impl().print(false, cx)\n+        );\n+    }\n+    write!(w, \"<a href=\\\"#{}\\\" class=\\\"anchor\\\"></a>\", id);\n+    render_stability_since_raw(\n+        w,\n+        i.impl_item.stable_since(tcx).as_deref(),\n+        i.impl_item.const_stable_since(tcx).as_deref(),\n+        outer_version,\n+        outer_const_version,\n+    );\n+    write_srclink(cx, &i.impl_item, w);\n+    w.write_str(\"</div>\");\n+}\n+\n fn print_sidebar(cx: &Context<'_>, it: &clean::Item, buffer: &mut Buffer) {\n     let parentlen = cx.current.len() - if it.is_mod() { 1 } else { 0 };\n "}]}