{"sha": "c118d8b79b2e10d6922423ecb6162ffe8f5d07fb", "node_id": "C_kwDOAAsO6NoAKGMxMThkOGI3OWIyZTEwZDY5MjI0MjNlY2I2MTYyZmZlOGY1ZDA3ZmI", "commit": {"author": {"name": "Manish Goregaokar", "email": "manishsmail@gmail.com", "date": "2021-09-26T01:22:19Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-09-26T01:22:19Z"}, "message": "Rollup merge of #89198 - hkmatsumoto:hide-hidden-methods, r=jyn514\n\nrustdoc: Don't show hidden trait methods\n\nFix #89186.\n\nBy skipping trait items whose attributes include `hidden`, we avoid showing such trait methods.", "tree": {"sha": "703c81eff5c7c93d240620688a91e03d6b2fab7e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/703c81eff5c7c93d240620688a91e03d6b2fab7e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c118d8b79b2e10d6922423ecb6162ffe8f5d07fb", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJhT8tMCRBK7hj4Ov3rIwAAyKoIAAIYz7uF/FQ62u9FOeyUTrTB\nyFhPW6VLFXcviBOdJwRU8CYYFfamHpaslgKeHaYxUhoevmsGYUlRSvdlU8TgYyJg\nbYPaLmXU4njjD2ovugHt56CD42TXAhneXmmGwFN16B63ySbCDRay4YOYfCHzygQF\n0vB69oLb426+zOOC1ckVxMNj05KiYv0QpDVhMsS0bui18LcMX31Wc1adZe21CUTk\nFWO8iG3iXiMw1PCvT/i25uzAvbl4QaTVxt0ybKG8SSoZDC21V35E1e9me4hgIYVg\nv/2IZvJwHErxiCxRa6CCHvSaMmMndEQkCFEVCeyti2wCR/0pipIr2C1QtZ79f2M=\n=CG4Y\n-----END PGP SIGNATURE-----\n", "payload": "tree 703c81eff5c7c93d240620688a91e03d6b2fab7e\nparent b8c3a6cfb94f352e62b8b1eecf196d5013cbbd6e\nparent 195f752109d646327c225fbeea424120048ac043\nauthor Manish Goregaokar <manishsmail@gmail.com> 1632619339 -0700\ncommitter GitHub <noreply@github.com> 1632619339 -0700\n\nRollup merge of #89198 - hkmatsumoto:hide-hidden-methods, r=jyn514\n\nrustdoc: Don't show hidden trait methods\n\nFix #89186.\n\nBy skipping trait items whose attributes include `hidden`, we avoid showing such trait methods.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c118d8b79b2e10d6922423ecb6162ffe8f5d07fb", "html_url": "https://github.com/rust-lang/rust/commit/c118d8b79b2e10d6922423ecb6162ffe8f5d07fb", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c118d8b79b2e10d6922423ecb6162ffe8f5d07fb/comments", "author": {"login": "Manishearth", "id": 1617736, "node_id": "MDQ6VXNlcjE2MTc3MzY=", "avatar_url": "https://avatars.githubusercontent.com/u/1617736?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Manishearth", "html_url": "https://github.com/Manishearth", "followers_url": "https://api.github.com/users/Manishearth/followers", "following_url": "https://api.github.com/users/Manishearth/following{/other_user}", "gists_url": "https://api.github.com/users/Manishearth/gists{/gist_id}", "starred_url": "https://api.github.com/users/Manishearth/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Manishearth/subscriptions", "organizations_url": "https://api.github.com/users/Manishearth/orgs", "repos_url": "https://api.github.com/users/Manishearth/repos", "events_url": "https://api.github.com/users/Manishearth/events{/privacy}", "received_events_url": "https://api.github.com/users/Manishearth/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b8c3a6cfb94f352e62b8b1eecf196d5013cbbd6e", "url": "https://api.github.com/repos/rust-lang/rust/commits/b8c3a6cfb94f352e62b8b1eecf196d5013cbbd6e", "html_url": "https://github.com/rust-lang/rust/commit/b8c3a6cfb94f352e62b8b1eecf196d5013cbbd6e"}, {"sha": "195f752109d646327c225fbeea424120048ac043", "url": "https://api.github.com/repos/rust-lang/rust/commits/195f752109d646327c225fbeea424120048ac043", "html_url": "https://github.com/rust-lang/rust/commit/195f752109d646327c225fbeea424120048ac043"}], "stats": {"total": 94, "additions": 93, "deletions": 1}, "files": [{"sha": "4a888b22332ee98fa18b915f27de6a52ebe0a3ec", "filename": "src/librustdoc/clean/inline.rs", "status": "modified", "additions": 33, "deletions": 1, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/c118d8b79b2e10d6922423ecb6162ffe8f5d07fb/src%2Flibrustdoc%2Fclean%2Finline.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c118d8b79b2e10d6922423ecb6162ffe8f5d07fb/src%2Flibrustdoc%2Fclean%2Finline.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fclean%2Finline.rs?ref=c118d8b79b2e10d6922423ecb6162ffe8f5d07fb", "patch": "@@ -389,13 +389,45 @@ crate fn build_impl(\n         }\n     }\n \n+    let document_hidden = cx.render_options.document_hidden;\n     let predicates = tcx.explicit_predicates_of(did);\n     let (trait_items, generics) = match impl_item {\n         Some(impl_) => (\n             impl_\n                 .items\n                 .iter()\n-                .map(|item| tcx.hir().impl_item(item.id).clean(cx))\n+                .map(|item| tcx.hir().impl_item(item.id))\n+                .filter(|item| {\n+                    // Filter out impl items whose corresponding trait item has `doc(hidden)`\n+                    // not to document such impl items.\n+                    // For inherent impls, we don't do any filtering, because that's already done in strip_hidden.rs.\n+\n+                    // When `--document-hidden-items` is passed, we don't\n+                    // do any filtering, too.\n+                    if document_hidden {\n+                        return true;\n+                    }\n+                    if let Some(associated_trait) = associated_trait {\n+                        let assoc_kind = match item.kind {\n+                            hir::ImplItemKind::Const(..) => ty::AssocKind::Const,\n+                            hir::ImplItemKind::Fn(..) => ty::AssocKind::Fn,\n+                            hir::ImplItemKind::TyAlias(..) => ty::AssocKind::Type,\n+                        };\n+                        let trait_item = tcx\n+                            .associated_items(associated_trait.def_id)\n+                            .find_by_name_and_kind(\n+                                tcx,\n+                                item.ident,\n+                                assoc_kind,\n+                                associated_trait.def_id,\n+                            )\n+                            .unwrap(); // SAFETY: For all impl items there exists trait item that has the same name.\n+                        !tcx.get_attrs(trait_item.def_id).lists(sym::doc).has_word(sym::hidden)\n+                    } else {\n+                        true\n+                    }\n+                })\n+                .map(|item| item.clean(cx))\n                 .collect::<Vec<_>>(),\n             impl_.generics.clean(cx),\n         ),"}, {"sha": "95b3e9b652303e2599421f1689847604a92e3821", "filename": "src/test/rustdoc/hidden-trait-methods-with-document-hidden-items.rs", "status": "added", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/c118d8b79b2e10d6922423ecb6162ffe8f5d07fb/src%2Ftest%2Frustdoc%2Fhidden-trait-methods-with-document-hidden-items.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c118d8b79b2e10d6922423ecb6162ffe8f5d07fb/src%2Ftest%2Frustdoc%2Fhidden-trait-methods-with-document-hidden-items.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fhidden-trait-methods-with-document-hidden-items.rs?ref=c118d8b79b2e10d6922423ecb6162ffe8f5d07fb", "patch": "@@ -0,0 +1,31 @@\n+// compile-flags: -Z unstable-options --document-hidden-items\n+\n+// test for trait methods with `doc(hidden)` with `--document-hidden-items` passed.\n+#![crate_name = \"foo\"]\n+\n+// @has foo/trait.Trait.html\n+// @has - '//*[@id=\"associatedtype.Foo\"]' 'type Foo'\n+// @has - '//*[@id=\"associatedtype.Bar\"]' 'type Bar'\n+// @has - '//*[@id=\"tymethod.f\"]' 'fn f()'\n+// @has - '//*[@id=\"tymethod.g\"]' 'fn g()'\n+pub trait Trait {\n+    #[doc(hidden)]\n+    type Foo;\n+    type Bar;\n+    #[doc(hidden)]\n+    fn f();\n+    fn g();\n+}\n+\n+// @has foo/struct.S.html\n+// @has - '//*[@id=\"associatedtype.Foo\"]' 'type Foo'\n+// @has - '//*[@id=\"associatedtype.Bar\"]' 'type Bar'\n+// @has - '//*[@id=\"method.f\"]' 'fn f()'\n+// @has - '//*[@id=\"method.g\"]' 'fn g()'\n+pub struct S;\n+impl Trait for S {\n+    type Foo = ();\n+    type Bar = ();\n+    fn f() {}\n+    fn g() {}\n+}"}, {"sha": "e924ba7d0acded047481a38786c27a0b19671bb2", "filename": "src/test/rustdoc/hidden-trait-methods.rs", "status": "added", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/c118d8b79b2e10d6922423ecb6162ffe8f5d07fb/src%2Ftest%2Frustdoc%2Fhidden-trait-methods.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c118d8b79b2e10d6922423ecb6162ffe8f5d07fb/src%2Ftest%2Frustdoc%2Fhidden-trait-methods.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc%2Fhidden-trait-methods.rs?ref=c118d8b79b2e10d6922423ecb6162ffe8f5d07fb", "patch": "@@ -0,0 +1,29 @@\n+// test for trait methods with `doc(hidden)`.\n+#![crate_name = \"foo\"]\n+\n+// @has foo/trait.Trait.html\n+// @!has - '//*[@id=\"associatedtype.Foo\"]' 'type Foo'\n+// @has - '//*[@id=\"associatedtype.Bar\"]' 'type Bar'\n+// @!has - '//*[@id=\"tymethod.f\"]' 'fn f()'\n+// @has - '//*[@id=\"tymethod.g\"]' 'fn g()'\n+pub trait Trait {\n+    #[doc(hidden)]\n+    type Foo;\n+    type Bar;\n+    #[doc(hidden)]\n+    fn f();\n+    fn g();\n+}\n+\n+// @has foo/struct.S.html\n+// @!has - '//*[@id=\"associatedtype.Foo\"]' 'type Foo'\n+// @has - '//*[@id=\"associatedtype.Bar\"]' 'type Bar'\n+// @!has - '//*[@id=\"method.f\"]' 'fn f()'\n+// @has - '//*[@id=\"method.g\"]' 'fn g()'\n+pub struct S;\n+impl Trait for S {\n+    type Foo = ();\n+    type Bar = ();\n+    fn f() {}\n+    fn g() {}\n+}"}]}