{"sha": "32d962d16fc0abcb63fd705b3cde35025da77a13", "node_id": "MDY6Q29tbWl0NzI0NzEyOjMyZDk2MmQxNmZjMGFiY2I2M2ZkNzA1YjNjZGUzNTAyNWRhNzdhMTM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-02-10T10:04:46Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2016-02-10T10:04:46Z"}, "message": "Auto merge of #31420 - bluss:deque-equality, r=Gankro\n\ncollections: Use slice parts in PartialEq for VecDeque\n\nThis improves == for VecDeque by using the slice representation.\n\nThis will also improve further if codegen for slice comparison improves.\n\nBenchmark run of 1000 u64 elements, comparing for equality (all equal).\nCpu time to compare the vecdeques is reduced to less than 50% of what it\nwas before.\n\n```\ntest test_eq_u64       ... bench:  1,885 ns/iter (+/- 163) = 4244 MB/s\ntest test_eq_new_u64   ... bench:    802 ns/iter (+/- 100) = 9975 MB/s\n```", "tree": {"sha": "83c11b86f064ec9855dc31811d8eb082b5e6f4d3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/83c11b86f064ec9855dc31811d8eb082b5e6f4d3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/32d962d16fc0abcb63fd705b3cde35025da77a13", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/32d962d16fc0abcb63fd705b3cde35025da77a13", "html_url": "https://github.com/rust-lang/rust/commit/32d962d16fc0abcb63fd705b3cde35025da77a13", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/32d962d16fc0abcb63fd705b3cde35025da77a13/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "523fa1331eda875136d3a980a5d51c7706f23f30", "url": "https://api.github.com/repos/rust-lang/rust/commits/523fa1331eda875136d3a980a5d51c7706f23f30", "html_url": "https://github.com/rust-lang/rust/commit/523fa1331eda875136d3a980a5d51c7706f23f30"}, {"sha": "aeb3aba951bca3307a1cbb7d1882437091e8070b", "url": "https://api.github.com/repos/rust-lang/rust/commits/aeb3aba951bca3307a1cbb7d1882437091e8070b", "html_url": "https://github.com/rust-lang/rust/commit/aeb3aba951bca3307a1cbb7d1882437091e8070b"}], "stats": {"total": 61, "additions": 60, "deletions": 1}, "files": [{"sha": "f34fe2da7e84b21541fab615fb79b96a25ba1d71", "filename": "src/libcollections/vec_deque.rs", "status": "modified", "additions": 33, "deletions": 1, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/32d962d16fc0abcb63fd705b3cde35025da77a13/src%2Flibcollections%2Fvec_deque.rs", "raw_url": "https://github.com/rust-lang/rust/raw/32d962d16fc0abcb63fd705b3cde35025da77a13/src%2Flibcollections%2Fvec_deque.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcollections%2Fvec_deque.rs?ref=32d962d16fc0abcb63fd705b3cde35025da77a13", "patch": "@@ -1968,7 +1968,39 @@ impl<'a, T: 'a> ExactSizeIterator for Drain<'a, T> {}\n #[stable(feature = \"rust1\", since = \"1.0.0\")]\n impl<A: PartialEq> PartialEq for VecDeque<A> {\n     fn eq(&self, other: &VecDeque<A>) -> bool {\n-        self.len() == other.len() && self.iter().zip(other).all(|(a, b)| a.eq(b))\n+        if self.len() != other.len() {\n+            return false;\n+        }\n+        let (sa, sb) = self.as_slices();\n+        let (oa, ob) = other.as_slices();\n+        if sa.len() == oa.len() {\n+            sa == oa && sb == ob\n+        } else if sa.len() < oa.len() {\n+            // Always divisible in three sections, for example:\n+            // self:  [a b c|d e f]\n+            // other: [0 1 2 3|4 5]\n+            // front = 3, mid = 1,\n+            // [a b c] == [0 1 2] && [d] == [3] && [e f] == [4 5]\n+            let front = sa.len();\n+            let mid = oa.len() - front;\n+\n+            let (oa_front, oa_mid) = oa.split_at(front);\n+            let (sb_mid, sb_back) = sb.split_at(mid);\n+            debug_assert_eq!(sa.len(), oa_front.len());\n+            debug_assert_eq!(sb_mid.len(), oa_mid.len());\n+            debug_assert_eq!(sb_back.len(), ob.len());\n+            sa == oa_front && sb_mid == oa_mid && sb_back == ob\n+        } else {\n+            let front = oa.len();\n+            let mid = sa.len() - front;\n+\n+            let (sa_front, sa_mid) = sa.split_at(front);\n+            let (ob_mid, ob_back) = ob.split_at(mid);\n+            debug_assert_eq!(sa_front.len(), oa.len());\n+            debug_assert_eq!(sa_mid.len(), ob_mid.len());\n+            debug_assert_eq!(sb.len(), ob_back.len());\n+            sa_front == oa && sa_mid == ob_mid && sb == ob_back\n+        }\n     }\n }\n "}, {"sha": "742205df8d794c3ad4d2ac3509c2c20e425e6851", "filename": "src/libcollectionstest/vec_deque.rs", "status": "modified", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/32d962d16fc0abcb63fd705b3cde35025da77a13/src%2Flibcollectionstest%2Fvec_deque.rs", "raw_url": "https://github.com/rust-lang/rust/raw/32d962d16fc0abcb63fd705b3cde35025da77a13/src%2Flibcollectionstest%2Fvec_deque.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcollectionstest%2Fvec_deque.rs?ref=32d962d16fc0abcb63fd705b3cde35025da77a13", "patch": "@@ -624,6 +624,33 @@ fn test_hash_after_rotation() {\n     }\n }\n \n+#[test]\n+fn test_eq_after_rotation() {\n+    // test that two deques are equal even if elements are laid out differently\n+    let len = 28;\n+    let mut ring: VecDeque<i32> = (0..len as i32).collect();\n+    let mut shifted = ring.clone();\n+    for _ in 0..10 {\n+        // shift values 1 step to the right by pop, sub one, push\n+        ring.pop_front();\n+        for elt in &mut ring {\n+            *elt -= 1;\n+        }\n+        ring.push_back(len - 1);\n+    }\n+\n+    // try every shift\n+    for _ in 0..shifted.capacity() {\n+        shifted.pop_front();\n+        for elt in &mut shifted {\n+            *elt -= 1;\n+        }\n+        shifted.push_back(len - 1);\n+        assert_eq!(shifted, ring);\n+        assert_eq!(ring, shifted);\n+    }\n+}\n+\n #[test]\n fn test_ord() {\n     let x = VecDeque::new();"}]}