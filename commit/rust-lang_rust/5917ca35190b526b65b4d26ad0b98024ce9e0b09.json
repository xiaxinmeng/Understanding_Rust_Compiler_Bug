{"sha": "5917ca35190b526b65b4d26ad0b98024ce9e0b09", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU5MTdjYTM1MTkwYjUyNmI2NWI0ZDI2YWQwYjk4MDI0Y2U5ZTBiMDk=", "commit": {"author": {"name": "Michael Bebenita", "email": "mbebenita@mozilla.com", "date": "2010-08-09T15:06:08Z"}, "committer": {"name": "Michael Bebenita", "email": "mbebenita@mozilla.com", "date": "2010-08-09T15:06:08Z"}, "message": "Fixed deadlock in the scheduler caused by condition variables.", "tree": {"sha": "c4076864029ecc75fd53fd4385caba4656d80080", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c4076864029ecc75fd53fd4385caba4656d80080"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5917ca35190b526b65b4d26ad0b98024ce9e0b09", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5917ca35190b526b65b4d26ad0b98024ce9e0b09", "html_url": "https://github.com/rust-lang/rust/commit/5917ca35190b526b65b4d26ad0b98024ce9e0b09", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5917ca35190b526b65b4d26ad0b98024ce9e0b09/comments", "author": {"login": "mbebenita", "id": 311082, "node_id": "MDQ6VXNlcjMxMTA4Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/311082?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mbebenita", "html_url": "https://github.com/mbebenita", "followers_url": "https://api.github.com/users/mbebenita/followers", "following_url": "https://api.github.com/users/mbebenita/following{/other_user}", "gists_url": "https://api.github.com/users/mbebenita/gists{/gist_id}", "starred_url": "https://api.github.com/users/mbebenita/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mbebenita/subscriptions", "organizations_url": "https://api.github.com/users/mbebenita/orgs", "repos_url": "https://api.github.com/users/mbebenita/repos", "events_url": "https://api.github.com/users/mbebenita/events{/privacy}", "received_events_url": "https://api.github.com/users/mbebenita/received_events", "type": "User", "site_admin": false}, "committer": {"login": "mbebenita", "id": 311082, "node_id": "MDQ6VXNlcjMxMTA4Mg==", "avatar_url": "https://avatars.githubusercontent.com/u/311082?v=4", "gravatar_id": "", "url": "https://api.github.com/users/mbebenita", "html_url": "https://github.com/mbebenita", "followers_url": "https://api.github.com/users/mbebenita/followers", "following_url": "https://api.github.com/users/mbebenita/following{/other_user}", "gists_url": "https://api.github.com/users/mbebenita/gists{/gist_id}", "starred_url": "https://api.github.com/users/mbebenita/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/mbebenita/subscriptions", "organizations_url": "https://api.github.com/users/mbebenita/orgs", "repos_url": "https://api.github.com/users/mbebenita/repos", "events_url": "https://api.github.com/users/mbebenita/events{/privacy}", "received_events_url": "https://api.github.com/users/mbebenita/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4641fcef616a7ee1eece4f00f757958757deb438", "url": "https://api.github.com/repos/rust-lang/rust/commits/4641fcef616a7ee1eece4f00f757958757deb438", "html_url": "https://github.com/rust-lang/rust/commit/4641fcef616a7ee1eece4f00f757958757deb438"}], "stats": {"total": 24, "additions": 13, "deletions": 11}, "files": [{"sha": "b66fca829fb5fc2d599af8c3e8500a38ed667389", "filename": "src/rt/rust_dom.cpp", "status": "modified", "additions": 12, "deletions": 5, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/5917ca35190b526b65b4d26ad0b98024ce9e0b09/src%2Frt%2Frust_dom.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/5917ca35190b526b65b4d26ad0b98024ce9e0b09/src%2Frt%2Frust_dom.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_dom.cpp?ref=5917ca35190b526b65b4d26ad0b98024ce9e0b09", "patch": "@@ -262,8 +262,6 @@ void rust_dom::send_message(rust_message *message) {\n                         this);\n     A(this, message->dom == this, \"Message owned by non-local domain.\");\n     _incoming_message_queue.enqueue(message);\n-    _incoming_message_pending.signal();\n-    _progress.signal();\n }\n \n /**\n@@ -398,9 +396,11 @@ rust_dom::start_main_loop()\n                 \"all tasks are blocked, waiting for progress ...\");\n             if (_log.is_tracing(rust_log::TASK))\n                 log_state();\n-            _progress.wait();\n             log(rust_log::TASK,\n-                \"progress made, resuming ...\");\n+                \"all tasks are blocked, scheduler yielding ...\");\n+            sync::yield();\n+            log(rust_log::TASK,\n+                \"scheduler resuming ...\");\n             continue;\n         }\n \n@@ -450,7 +450,14 @@ rust_dom::start_main_loop()\n         }\n \n         if (_incoming_message_queue.is_empty()) {\n-            _incoming_message_pending.wait();\n+            log(rust_log::DOM,\n+                \"waiting for %d dead tasks to become dereferenced, \"\n+                \"scheduler yielding ...\",\n+                dead_tasks.length());\n+            if (_log.is_tracing(rust_log::TASK)) {\n+                log_state();\n+            }\n+            sync::yield();\n         } else {\n             drain_incoming_message_queue();\n         }"}, {"sha": "5a3278b9cc0da12a21dfacf442ef14783df2ea8e", "filename": "src/rt/rust_dom.h", "status": "modified", "additions": 0, "deletions": 3, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/5917ca35190b526b65b4d26ad0b98024ce9e0b09/src%2Frt%2Frust_dom.h", "raw_url": "https://github.com/rust-lang/rust/raw/5917ca35190b526b65b4d26ad0b98024ce9e0b09/src%2Frt%2Frust_dom.h", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_dom.h?ref=5917ca35190b526b65b4d26ad0b98024ce9e0b09", "patch": "@@ -34,13 +34,10 @@ struct rust_dom\n     rust_task *curr_task;\n     int rval;\n \n-    condition_variable _progress;\n-\n     hash_map<rust_task *, rust_proxy<rust_task> *> _task_proxies;\n     hash_map<rust_port *, rust_proxy<rust_port> *> _port_proxies;\n \n     // Incoming messages from other domains.\n-    condition_variable _incoming_message_pending;\n     lock_free_queue _incoming_message_queue;\n \n #ifndef __WIN32__"}, {"sha": "46ea843fcc22c68e2e5f14332642c06b1fda36d6", "filename": "src/rt/rust_internal.h", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/5917ca35190b526b65b4d26ad0b98024ce9e0b09/src%2Frt%2Frust_internal.h", "raw_url": "https://github.com/rust-lang/rust/raw/5917ca35190b526b65b4d26ad0b98024ce9e0b09/src%2Frt%2Frust_internal.h", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_internal.h?ref=5917ca35190b526b65b4d26ad0b98024ce9e0b09", "patch": "@@ -38,6 +38,7 @@ extern \"C\" {\n #error \"Platform not supported.\"\n #endif\n \n+#include \"sync/sync.h\"\n #include \"sync/condition_variable.h\"\n \n #ifndef __i386__"}, {"sha": "c8831e8e05bebb808f1da93b1bab50448e2d907c", "filename": "src/rt/rust_task.cpp", "status": "modified", "additions": 0, "deletions": 3, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/5917ca35190b526b65b4d26ad0b98024ce9e0b09/src%2Frt%2Frust_task.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/5917ca35190b526b65b4d26ad0b98024ce9e0b09/src%2Frt%2Frust_task.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_task.cpp?ref=5917ca35190b526b65b4d26ad0b98024ce9e0b09", "patch": "@@ -556,9 +556,6 @@ rust_task::wakeup(rust_cond *from)\n     A(dom, cond == from, \"Cannot wake up blocked task on wrong condition.\");\n \n     transition(&dom->blocked_tasks, &dom->running_tasks);\n-    // TODO: Signaling every time the task is awaken is kind of silly,\n-    // do this a nicer way.\n-    dom->_progress.signal();\n     I(dom, cond == from);\n     cond = NULL;\n }"}]}