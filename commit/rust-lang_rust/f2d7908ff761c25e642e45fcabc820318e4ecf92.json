{"sha": "f2d7908ff761c25e642e45fcabc820318e4ecf92", "node_id": "C_kwDOAAsO6NoAKGYyZDc5MDhmZjc2MWMyNWU2NDJlNDVmY2FiYzgyMDMxOGU0ZWNmOTI", "commit": {"author": {"name": "Jakob Degen", "email": "jakob.e.degen@gmail.com", "date": "2022-03-26T00:00:33Z"}, "committer": {"name": "Jakob Degen", "email": "jakob.e.degen@gmail.com", "date": "2022-04-11T19:22:32Z"}, "message": "Adjust MIR validator to check a few more things for terminators", "tree": {"sha": "50af7afee6db5c1f74d52fed3e4be4861e29b8f8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/50af7afee6db5c1f74d52fed3e4be4861e29b8f8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f2d7908ff761c25e642e45fcabc820318e4ecf92", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f2d7908ff761c25e642e45fcabc820318e4ecf92", "html_url": "https://github.com/rust-lang/rust/commit/f2d7908ff761c25e642e45fcabc820318e4ecf92", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f2d7908ff761c25e642e45fcabc820318e4ecf92/comments", "author": {"login": "JakobDegen", "id": 51179609, "node_id": "MDQ6VXNlcjUxMTc5NjA5", "avatar_url": "https://avatars.githubusercontent.com/u/51179609?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JakobDegen", "html_url": "https://github.com/JakobDegen", "followers_url": "https://api.github.com/users/JakobDegen/followers", "following_url": "https://api.github.com/users/JakobDegen/following{/other_user}", "gists_url": "https://api.github.com/users/JakobDegen/gists{/gist_id}", "starred_url": "https://api.github.com/users/JakobDegen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JakobDegen/subscriptions", "organizations_url": "https://api.github.com/users/JakobDegen/orgs", "repos_url": "https://api.github.com/users/JakobDegen/repos", "events_url": "https://api.github.com/users/JakobDegen/events{/privacy}", "received_events_url": "https://api.github.com/users/JakobDegen/received_events", "type": "User", "site_admin": false}, "committer": {"login": "JakobDegen", "id": 51179609, "node_id": "MDQ6VXNlcjUxMTc5NjA5", "avatar_url": "https://avatars.githubusercontent.com/u/51179609?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JakobDegen", "html_url": "https://github.com/JakobDegen", "followers_url": "https://api.github.com/users/JakobDegen/followers", "following_url": "https://api.github.com/users/JakobDegen/following{/other_user}", "gists_url": "https://api.github.com/users/JakobDegen/gists{/gist_id}", "starred_url": "https://api.github.com/users/JakobDegen/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JakobDegen/subscriptions", "organizations_url": "https://api.github.com/users/JakobDegen/orgs", "repos_url": "https://api.github.com/users/JakobDegen/repos", "events_url": "https://api.github.com/users/JakobDegen/events{/privacy}", "received_events_url": "https://api.github.com/users/JakobDegen/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f1f25c0f8145c45078ff628dedae6aa4b28d962d", "url": "https://api.github.com/repos/rust-lang/rust/commits/f1f25c0f8145c45078ff628dedae6aa4b28d962d", "html_url": "https://github.com/rust-lang/rust/commit/f1f25c0f8145c45078ff628dedae6aa4b28d962d"}], "stats": {"total": 24, "additions": 19, "deletions": 5}, "files": [{"sha": "4358ec2fff72811b9100f0b5fdf308b7fc1ff1b2", "filename": "compiler/rustc_const_eval/src/transform/validate.rs", "status": "modified", "additions": 19, "deletions": 5, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/f2d7908ff761c25e642e45fcabc820318e4ecf92/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fvalidate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f2d7908ff761c25e642e45fcabc820318e4ecf92/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fvalidate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_const_eval%2Fsrc%2Ftransform%2Fvalidate.rs?ref=f2d7908ff761c25e642e45fcabc820318e4ecf92", "patch": "@@ -642,6 +642,9 @@ impl<'a, 'tcx> Visitor<'tcx> for TypeChecker<'a, 'tcx> {\n                 }\n             }\n             TerminatorKind::Yield { resume, drop, .. } => {\n+                if self.body.generator.is_none() {\n+                    self.fail(location, \"`Yield` cannot appear outside generator bodies\");\n+                }\n                 if self.mir_phase >= MirPhase::GeneratorsLowered {\n                     self.fail(location, \"`Yield` should have been replaced by generator lowering\");\n                 }\n@@ -681,18 +684,29 @@ impl<'a, 'tcx> Visitor<'tcx> for TypeChecker<'a, 'tcx> {\n                 }\n             }\n             TerminatorKind::GeneratorDrop => {\n+                if self.body.generator.is_none() {\n+                    self.fail(location, \"`GeneratorDrop` cannot appear outside generator bodies\");\n+                }\n                 if self.mir_phase >= MirPhase::GeneratorsLowered {\n                     self.fail(\n                         location,\n                         \"`GeneratorDrop` should have been replaced by generator lowering\",\n                     );\n                 }\n             }\n-            // Nothing to validate for these.\n-            TerminatorKind::Resume\n-            | TerminatorKind::Abort\n-            | TerminatorKind::Return\n-            | TerminatorKind::Unreachable => {}\n+            TerminatorKind::Resume | TerminatorKind::Abort => {\n+                let bb = location.block;\n+                if !self.body.basic_blocks()[bb].is_cleanup {\n+                    self.fail(location, \"Cannot `Resume` from non-cleanup basic block\")\n+                }\n+            }\n+            TerminatorKind::Return => {\n+                let bb = location.block;\n+                if self.body.basic_blocks()[bb].is_cleanup {\n+                    self.fail(location, \"Cannot `Return` from cleanup basic block\")\n+                }\n+            }\n+            TerminatorKind::Unreachable => {}\n         }\n \n         self.super_terminator(terminator, location);"}]}