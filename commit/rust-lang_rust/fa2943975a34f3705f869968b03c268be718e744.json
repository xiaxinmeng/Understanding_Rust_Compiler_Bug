{"sha": "fa2943975a34f3705f869968b03c268be718e744", "node_id": "MDY6Q29tbWl0NzI0NzEyOmZhMjk0Mzk3NWEzNGYzNzA1Zjg2OTk2OGIwM2MyNjhiZTcxOGU3NDQ=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2020-06-01T01:14:05Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-06-01T01:14:05Z"}, "message": "Rollup merge of #72776 - lcnr:stalled_on-smallvec, r=nnethercote\n\nfulfill: try using SmallVec or Box for stalled_on\n\nTested both `Box` and `SmallVec` for `stalled_on`, with both resulting in a perf loss.\nAdds a comment mentioning this and removes an now outdated FIXME.\n\nLogging the length of `stalled_on` resulted in the following distribution while building a part of stage 1 libs:\n```\n22627647 counts:\n(  1) 20983696 (92.7%, 92.7%): process_obligation_len: 1\n(  2)   959711 ( 4.2%, 97.0%): process_obligation_len: 2\n(  3)   682326 ( 3.0%,100.0%): process_obligation_len: 0\n(  4)     1914 ( 0.0%,100.0%): process_obligation_len: 3\n```\ncc @eddyb\nr? @nnethercote", "tree": {"sha": "504754c24fb928b10d5f510eeef901578e766ed7", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/504754c24fb928b10d5f510eeef901578e766ed7"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/fa2943975a34f3705f869968b03c268be718e744", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJe1FZdCRBK7hj4Ov3rIwAAdHIIAFP4ZJErOOd4cOv4r9Gu+LK1\nUti7f/2hjuHbAyrAaqgHf+8nOS8YOxjxbvrzMgVBO3FRu07nuYHltW057Mzr47E5\nrkonmIAd7amt1ehie5MGSvW46OQxpJ6CE5FN+HBexYZ04CsQ4ZHq7NQTAhwv0r69\nflfL+ozDri295mNJZYOqEGL8luBsBWRMkKgzDO9Ip3ViclzmKP0YlQAo7dbf76bF\nv9T0e7/0iSs5VcWhBFOSATjfc9kxTKA8T3NLAErU4ka5LlOVj88OxHgNycXBe6Sj\nBKa/oYI/pnXlZIGOk6i0g2lQaYgHq5RKkqFqRGlUEVOejLVLxinWZQB6hzIDLyk=\n=WZ3w\n-----END PGP SIGNATURE-----\n", "payload": "tree 504754c24fb928b10d5f510eeef901578e766ed7\nparent 0d93d3f4a42fd45b2a0da658d39555316a1b6793\nparent 04417636945004b91de8e3f32ee10e80585d05ec\nauthor Dylan DPC <dylan.dpc@gmail.com> 1590974045 +0200\ncommitter GitHub <noreply@github.com> 1590974045 +0200\n\nRollup merge of #72776 - lcnr:stalled_on-smallvec, r=nnethercote\n\nfulfill: try using SmallVec or Box for stalled_on\n\nTested both `Box` and `SmallVec` for `stalled_on`, with both resulting in a perf loss.\nAdds a comment mentioning this and removes an now outdated FIXME.\n\nLogging the length of `stalled_on` resulted in the following distribution while building a part of stage 1 libs:\n```\n22627647 counts:\n(  1) 20983696 (92.7%, 92.7%): process_obligation_len: 1\n(  2)   959711 ( 4.2%, 97.0%): process_obligation_len: 2\n(  3)   682326 ( 3.0%,100.0%): process_obligation_len: 0\n(  4)     1914 ( 0.0%,100.0%): process_obligation_len: 3\n```\ncc @eddyb\nr? @nnethercote\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/fa2943975a34f3705f869968b03c268be718e744", "html_url": "https://github.com/rust-lang/rust/commit/fa2943975a34f3705f869968b03c268be718e744", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/fa2943975a34f3705f869968b03c268be718e744/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "0d93d3f4a42fd45b2a0da658d39555316a1b6793", "url": "https://api.github.com/repos/rust-lang/rust/commits/0d93d3f4a42fd45b2a0da658d39555316a1b6793", "html_url": "https://github.com/rust-lang/rust/commit/0d93d3f4a42fd45b2a0da658d39555316a1b6793"}, {"sha": "04417636945004b91de8e3f32ee10e80585d05ec", "url": "https://api.github.com/repos/rust-lang/rust/commits/04417636945004b91de8e3f32ee10e80585d05ec", "html_url": "https://github.com/rust-lang/rust/commit/04417636945004b91de8e3f32ee10e80585d05ec"}], "stats": {"total": 7, "additions": 4, "deletions": 3}, "files": [{"sha": "c1d9b0a2d88e6cebf1685faa74ed96f6f93aabdd", "filename": "src/librustc_trait_selection/traits/fulfill.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/fa2943975a34f3705f869968b03c268be718e744/src%2Flibrustc_trait_selection%2Ftraits%2Ffulfill.rs", "raw_url": "https://github.com/rust-lang/rust/raw/fa2943975a34f3705f869968b03c268be718e744/src%2Flibrustc_trait_selection%2Ftraits%2Ffulfill.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trait_selection%2Ftraits%2Ffulfill.rs?ref=fa2943975a34f3705f869968b03c268be718e744", "patch": "@@ -75,9 +75,10 @@ pub struct FulfillmentContext<'tcx> {\n #[derive(Clone, Debug)]\n pub struct PendingPredicateObligation<'tcx> {\n     pub obligation: PredicateObligation<'tcx>,\n-    // FIXME(eddyb) look into whether this could be a `SmallVec`.\n-    // Judging by the comment in `process_obligation`, the 1-element case\n-    // is common so this could be a `SmallVec<[TyOrConstInferVar<'tcx>; 1]>`.\n+    // This is far more often read than modified, meaning that we\n+    // should mostly optimize for reading speed, while modifying is not as relevant.\n+    //\n+    // For whatever reason using a boxed slice is slower than using a `Vec` here.\n     pub stalled_on: Vec<TyOrConstInferVar<'tcx>>,\n }\n "}]}