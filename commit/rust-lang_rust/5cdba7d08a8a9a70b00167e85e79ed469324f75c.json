{"sha": "5cdba7d08a8a9a70b00167e85e79ed469324f75c", "node_id": "MDY6Q29tbWl0NzI0NzEyOjVjZGJhN2QwOGE4YTlhNzBiMDAxNjdlODVlNzllZDQ2OTMyNGY3NWM=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-05-28T09:22:22Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-05-28T09:22:22Z"}, "message": "Auto merge of #7287 - Jarcho:ice_7272, r=flip1995\n\nFix ICE in `too_many_lines`\n\nfixes: #7272\nfixes: #7286\n\n#7272 looks like it's caused by a bug in rust-c. The span it's giving for the closure is:\n\n```rust\n$crate:: $lower($d arg) }\n        }\n    }\n}\n```\n\nThe correct span would be `$crate:: $lower($d arg)` without all the closing braces.\n\n#7286 is definitely a clippy bug\n\nchangelog: none", "tree": {"sha": "59815e5a6f2bfa116a9336c0743091d786292dfe", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/59815e5a6f2bfa116a9336c0743091d786292dfe"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5cdba7d08a8a9a70b00167e85e79ed469324f75c", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5cdba7d08a8a9a70b00167e85e79ed469324f75c", "html_url": "https://github.com/rust-lang/rust/commit/5cdba7d08a8a9a70b00167e85e79ed469324f75c", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5cdba7d08a8a9a70b00167e85e79ed469324f75c/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "543a8a6aac8b346c75dc69cb5b7945a52f72ffe7", "url": "https://api.github.com/repos/rust-lang/rust/commits/543a8a6aac8b346c75dc69cb5b7945a52f72ffe7", "html_url": "https://github.com/rust-lang/rust/commit/543a8a6aac8b346c75dc69cb5b7945a52f72ffe7"}, {"sha": "4ba6afd1922b679eb533b8523f6e47a0da152afb", "url": "https://api.github.com/repos/rust-lang/rust/commits/4ba6afd1922b679eb533b8523f6e47a0da152afb", "html_url": "https://github.com/rust-lang/rust/commit/4ba6afd1922b679eb533b8523f6e47a0da152afb"}], "stats": {"total": 48, "additions": 42, "deletions": 6}, "files": [{"sha": "a666fee1a4ad507a7f1d74dde33fb2d708c44948", "filename": "clippy_lints/src/functions/too_many_lines.rs", "status": "modified", "additions": 16, "deletions": 6, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/5cdba7d08a8a9a70b00167e85e79ed469324f75c/clippy_lints%2Fsrc%2Ffunctions%2Ftoo_many_lines.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5cdba7d08a8a9a70b00167e85e79ed469324f75c/clippy_lints%2Fsrc%2Ffunctions%2Ftoo_many_lines.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Ffunctions%2Ftoo_many_lines.rs?ref=5cdba7d08a8a9a70b00167e85e79ed469324f75c", "patch": "@@ -4,7 +4,7 @@ use rustc_middle::lint::in_external_macro;\n use rustc_span::Span;\n \n use clippy_utils::diagnostics::span_lint;\n-use clippy_utils::source::snippet;\n+use clippy_utils::source::snippet_opt;\n \n use super::TOO_MANY_LINES;\n \n@@ -13,15 +13,25 @@ pub(super) fn check_fn(cx: &LateContext<'_>, span: Span, body: &'tcx hir::Body<'\n         return;\n     }\n \n-    let code_snippet = snippet(cx, body.value.span, \"..\");\n+    let code_snippet = match snippet_opt(cx, body.value.span) {\n+        Some(s) => s,\n+        _ => return,\n+    };\n     let mut line_count: u64 = 0;\n     let mut in_comment = false;\n     let mut code_in_line;\n \n-    // Skip the surrounding function decl.\n-    let start_brace_idx = code_snippet.find('{').map_or(0, |i| i + 1);\n-    let end_brace_idx = code_snippet.rfind('}').unwrap_or_else(|| code_snippet.len());\n-    let function_lines = code_snippet[start_brace_idx..end_brace_idx].lines();\n+    let function_lines = if matches!(body.value.kind, hir::ExprKind::Block(..))\n+        && code_snippet.as_bytes().first().copied() == Some(b'{')\n+        && code_snippet.as_bytes().last().copied() == Some(b'}')\n+    {\n+        // Removing the braces from the enclosing block\n+        &code_snippet[1..code_snippet.len() - 1]\n+    } else {\n+        &code_snippet\n+    }\n+    .trim() // Remove leading and trailing blank lines\n+    .lines();\n \n     for mut line in function_lines {\n         code_in_line = false;"}, {"sha": "780797e3c6aa42291af2d15e66e988a6a9e160e9", "filename": "tests/ui/crashes/auxiliary/ice-7272-aux.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/5cdba7d08a8a9a70b00167e85e79ed469324f75c/tests%2Fui%2Fcrashes%2Fauxiliary%2Fice-7272-aux.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5cdba7d08a8a9a70b00167e85e79ed469324f75c/tests%2Fui%2Fcrashes%2Fauxiliary%2Fice-7272-aux.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcrashes%2Fauxiliary%2Fice-7272-aux.rs?ref=5cdba7d08a8a9a70b00167e85e79ed469324f75c", "patch": "@@ -0,0 +1,14 @@\n+pub fn warn<T>(_: T) {}\n+\n+macro_rules! define_macro {\n+    ($d:tt $lower:ident $upper:ident) => {\n+        #[macro_export]\n+        macro_rules! $upper {\n+            ($arg:tt) => {\n+                $crate::$lower($arg)\n+            };\n+        }\n+    };\n+}\n+\n+define_macro! {$ warn  WARNING}"}, {"sha": "57ab6ca14f86a3608ee7f0b202e3767480b5209f", "filename": "tests/ui/crashes/ice-7272.rs", "status": "added", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/5cdba7d08a8a9a70b00167e85e79ed469324f75c/tests%2Fui%2Fcrashes%2Fice-7272.rs", "raw_url": "https://github.com/rust-lang/rust/raw/5cdba7d08a8a9a70b00167e85e79ed469324f75c/tests%2Fui%2Fcrashes%2Fice-7272.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcrashes%2Fice-7272.rs?ref=5cdba7d08a8a9a70b00167e85e79ed469324f75c", "patch": "@@ -0,0 +1,12 @@\n+// aux-build:ice-7272-aux.rs\n+\n+#![allow(clippy::no_effect)]\n+\n+extern crate ice_7272_aux;\n+\n+use ice_7272_aux::*;\n+\n+pub fn main() {\n+    || WARNING!(\"Style changed!\");\n+    || \"}{\";\n+}"}]}