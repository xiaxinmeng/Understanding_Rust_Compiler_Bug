{"sha": "ee5d8d37baaf5b5a81a98396952839c73ae41c68", "node_id": "C_kwDOAAsO6NoAKGVlNWQ4ZDM3YmFhZjViNWE4MWE5ODM5Njk1MjgzOWM3M2FlNDFjNjg", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-01-17T14:50:50Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-01-17T14:50:50Z"}, "message": "Auto merge of #90986 - camsteffen:nested-filter, r=cjgillot\n\nReplace `NestedVisitorMap` with generic `NestedFilter`\n\nThis is an attempt to make the `intravisit::Visitor` API simpler and \"more const\" with regard to nested visiting.\n\nWith this change, `intravisit::Visitor` does not visit nested things by default, unless you specify `type NestedFilter = nested_filter::OnlyBodies` (or `All`). `nested_visit_map` returns `Self::Map` instead of `NestedVisitorMap<Self::Map>`. It panics by default (unreachable if `type NestedFilter` is omitted).\n\nOne somewhat trixty thing here is that `nested_filter::{OnlyBodies, All}` live in `rustc_middle` so that they may have `type Map = map::Map` and so that `impl Visitor`s never need to specify `type Map` - it has a default of `Self::NestedFilter::Map`.", "tree": {"sha": "ebabac34dff17c1f20235e84bf69d727ac7fdb14", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ebabac34dff17c1f20235e84bf69d727ac7fdb14"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ee5d8d37baaf5b5a81a98396952839c73ae41c68", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ee5d8d37baaf5b5a81a98396952839c73ae41c68", "html_url": "https://github.com/rust-lang/rust/commit/ee5d8d37baaf5b5a81a98396952839c73ae41c68", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ee5d8d37baaf5b5a81a98396952839c73ae41c68/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a34c0797528172ede89480e3033f7a5e71ea4735", "url": "https://api.github.com/repos/rust-lang/rust/commits/a34c0797528172ede89480e3033f7a5e71ea4735", "html_url": "https://github.com/rust-lang/rust/commit/a34c0797528172ede89480e3033f7a5e71ea4735"}, {"sha": "be6d6934b635a8c2e8ff5bb68002a3744dd47e8d", "url": "https://api.github.com/repos/rust-lang/rust/commits/be6d6934b635a8c2e8ff5bb68002a3744dd47e8d", "html_url": "https://github.com/rust-lang/rust/commit/be6d6934b635a8c2e8ff5bb68002a3744dd47e8d"}], "stats": {"total": 1333, "additions": 387, "deletions": 946}, "files": [{"sha": "62935a2b1f718753aab726119dd05670ba74ee5e", "filename": "compiler/rustc_ast_lowering/src/index.rs", "status": "modified", "additions": 1, "deletions": 7, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_ast_lowering%2Fsrc%2Findex.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_ast_lowering%2Fsrc%2Findex.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast_lowering%2Fsrc%2Findex.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -3,7 +3,7 @@ use rustc_data_structures::sorted_map::SortedMap;\n use rustc_hir as hir;\n use rustc_hir::def_id::LocalDefId;\n use rustc_hir::definitions;\n-use rustc_hir::intravisit::{self, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{self, Visitor};\n use rustc_hir::*;\n use rustc_index::vec::{Idx, IndexVec};\n use rustc_session::Session;\n@@ -101,16 +101,10 @@ impl<'a, 'hir> NodeCollector<'a, 'hir> {\n }\n \n impl<'a, 'hir> Visitor<'hir> for NodeCollector<'a, 'hir> {\n-    type Map = !;\n-\n     /// Because we want to track parent items and so forth, enable\n     /// deep walking so that we walk nested items in the context of\n     /// their outer items.\n \n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        panic!(\"`visit_nested_xxx` must be manually implemented in this visitor\");\n-    }\n-\n     fn visit_nested_item(&mut self, item: ItemId) {\n         debug!(\"visit_nested_item: {:?}\", item);\n         self.insert_nested(item.def_id);"}, {"sha": "7eb08b8754a293ad214742ba5cae478f740a08fc", "filename": "compiler/rustc_ast_lowering/src/lib.rs", "status": "modified", "additions": 0, "deletions": 6, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_ast_lowering%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_ast_lowering%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_ast_lowering%2Fsrc%2Flib.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -2436,12 +2436,6 @@ fn lifetimes_from_impl_trait_bounds(\n     }\n \n     impl<'r, 'v> intravisit::Visitor<'v> for ImplTraitLifetimeCollector<'r> {\n-        type Map = intravisit::ErasedMap<'v>;\n-\n-        fn nested_visit_map(&mut self) -> intravisit::NestedVisitorMap<Self::Map> {\n-            intravisit::NestedVisitorMap::None\n-        }\n-\n         fn visit_generic_args(&mut self, span: Span, parameters: &'v hir::GenericArgs<'v>) {\n             // Don't collect elided lifetimes used inside of `Fn()` syntax.\n             if parameters.parenthesized {"}, {"sha": "6347a64fa8502256ac2b4a94b24c128ea694ae5c", "filename": "compiler/rustc_hir/src/intravisit.rs", "status": "modified", "additions": 54, "deletions": 80, "changes": 134, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_hir%2Fsrc%2Fintravisit.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_hir%2Fsrc%2Fintravisit.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir%2Fsrc%2Fintravisit.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -160,87 +160,44 @@ impl<'hir> Map<'hir> for ! {\n     }\n }\n \n-/// An erased version of `Map<'hir>`, using dynamic dispatch.\n-/// NOTE: This type is effectively only usable with `NestedVisitorMap::None`.\n-pub struct ErasedMap<'hir>(&'hir dyn Map<'hir>);\n+pub mod nested_filter {\n+    use super::Map;\n \n-impl<'hir> Map<'hir> for ErasedMap<'hir> {\n-    fn find(&self, _: HirId) -> Option<Node<'hir>> {\n-        None\n-    }\n-    fn body(&self, id: BodyId) -> &'hir Body<'hir> {\n-        self.0.body(id)\n-    }\n-    fn item(&self, id: ItemId) -> &'hir Item<'hir> {\n-        self.0.item(id)\n-    }\n-    fn trait_item(&self, id: TraitItemId) -> &'hir TraitItem<'hir> {\n-        self.0.trait_item(id)\n-    }\n-    fn impl_item(&self, id: ImplItemId) -> &'hir ImplItem<'hir> {\n-        self.0.impl_item(id)\n-    }\n-    fn foreign_item(&self, id: ForeignItemId) -> &'hir ForeignItem<'hir> {\n-        self.0.foreign_item(id)\n+    /// Specifies what nested things a visitor wants to visit. The most\n+    /// common choice is `OnlyBodies`, which will cause the visitor to\n+    /// visit fn bodies for fns that it encounters, but skip over nested\n+    /// item-like things.\n+    ///\n+    /// See the comments on `ItemLikeVisitor` for more details on the overall\n+    /// visit strategy.\n+    pub trait NestedFilter<'hir> {\n+        type Map: Map<'hir>;\n+\n+        /// Whether the visitor visits nested \"item-like\" things.\n+        /// E.g., item, impl-item.\n+        const INTER: bool;\n+        /// Whether the visitor visits \"intra item-like\" things.\n+        /// E.g., function body, closure, `AnonConst`\n+        const INTRA: bool;\n     }\n-}\n \n-/// Specifies what nested things a visitor wants to visit. The most\n-/// common choice is `OnlyBodies`, which will cause the visitor to\n-/// visit fn bodies for fns that it encounters, but skip over nested\n-/// item-like things.\n-///\n-/// See the comments on `ItemLikeVisitor` for more details on the overall\n-/// visit strategy.\n-pub enum NestedVisitorMap<M> {\n     /// Do not visit any nested things. When you add a new\n     /// \"non-nested\" thing, you will want to audit such uses to see if\n     /// they remain valid.\n     ///\n     /// Use this if you are only walking some particular kind of tree\n     /// (i.e., a type, or fn signature) and you don't want to thread a\n     /// HIR map around.\n-    None,\n-\n-    /// Do not visit nested item-like things, but visit nested things\n-    /// that are inside of an item-like.\n-    ///\n-    /// **This is the most common choice.** A very common pattern is\n-    /// to use `visit_all_item_likes()` as an outer loop,\n-    /// and to have the visitor that visits the contents of each item\n-    /// using this setting.\n-    OnlyBodies(M),\n-\n-    /// Visits all nested things, including item-likes.\n-    ///\n-    /// **This is an unusual choice.** It is used when you want to\n-    /// process everything within their lexical context. Typically you\n-    /// kick off the visit by doing `walk_krate()`.\n-    All(M),\n-}\n-\n-impl<M> NestedVisitorMap<M> {\n-    /// Returns the map to use for an \"intra item-like\" thing (if any).\n-    /// E.g., function body.\n-    fn intra(self) -> Option<M> {\n-        match self {\n-            NestedVisitorMap::None => None,\n-            NestedVisitorMap::OnlyBodies(map) => Some(map),\n-            NestedVisitorMap::All(map) => Some(map),\n-        }\n-    }\n-\n-    /// Returns the map to use for an \"item-like\" thing (if any).\n-    /// E.g., item, impl-item.\n-    fn inter(self) -> Option<M> {\n-        match self {\n-            NestedVisitorMap::None => None,\n-            NestedVisitorMap::OnlyBodies(_) => None,\n-            NestedVisitorMap::All(map) => Some(map),\n-        }\n+    pub struct None(());\n+    impl NestedFilter<'_> for None {\n+        type Map = !;\n+        const INTER: bool = false;\n+        const INTRA: bool = false;\n     }\n }\n \n+use nested_filter::NestedFilter;\n+\n /// Each method of the Visitor trait is a hook to be potentially\n /// overridden. Each method's default implementation recursively visits\n /// the substructure of the input via the corresponding `walk` method;\n@@ -258,7 +215,9 @@ impl<M> NestedVisitorMap<M> {\n /// to monitor future changes to `Visitor` in case a new method with a\n /// new default implementation gets introduced.)\n pub trait Visitor<'v>: Sized {\n-    type Map: Map<'v>;\n+    // this type should not be overridden, it exists for convenient usage as `Self::Map`\n+    type Map: Map<'v> = <Self::NestedFilter as NestedFilter<'v>>::Map;\n+    type NestedFilter: NestedFilter<'v> = nested_filter::None;\n \n     ///////////////////////////////////////////////////////////////////////////\n     // Nested items.\n@@ -279,7 +238,12 @@ pub trait Visitor<'v>: Sized {\n     /// `panic!()`. This way, if a new `visit_nested_XXX` variant is\n     /// added in the future, we will see the panic in your code and\n     /// fix it appropriately.\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map>;\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        panic!(\n+            \"nested_visit_map must be implemented or consider using \\\n+            `type NestedFilter = nested_filter::None` (the default)\"\n+        );\n+    }\n \n     /// Invoked when a nested item is encountered. By default does\n     /// nothing unless you override `nested_visit_map` to return other than\n@@ -290,41 +254,51 @@ pub trait Visitor<'v>: Sized {\n     /// reason to override this method is if you want a nested pattern\n     /// but cannot supply a `Map`; see `nested_visit_map` for advice.\n     fn visit_nested_item(&mut self, id: ItemId) {\n-        let opt_item = self.nested_visit_map().inter().map(|map| map.item(id));\n-        walk_list!(self, visit_item, opt_item);\n+        if Self::NestedFilter::INTER {\n+            let item = self.nested_visit_map().item(id);\n+            self.visit_item(item);\n+        }\n     }\n \n     /// Like `visit_nested_item()`, but for trait items. See\n     /// `visit_nested_item()` for advice on when to override this\n     /// method.\n     fn visit_nested_trait_item(&mut self, id: TraitItemId) {\n-        let opt_item = self.nested_visit_map().inter().map(|map| map.trait_item(id));\n-        walk_list!(self, visit_trait_item, opt_item);\n+        if Self::NestedFilter::INTER {\n+            let item = self.nested_visit_map().trait_item(id);\n+            self.visit_trait_item(item);\n+        }\n     }\n \n     /// Like `visit_nested_item()`, but for impl items. See\n     /// `visit_nested_item()` for advice on when to override this\n     /// method.\n     fn visit_nested_impl_item(&mut self, id: ImplItemId) {\n-        let opt_item = self.nested_visit_map().inter().map(|map| map.impl_item(id));\n-        walk_list!(self, visit_impl_item, opt_item);\n+        if Self::NestedFilter::INTER {\n+            let item = self.nested_visit_map().impl_item(id);\n+            self.visit_impl_item(item);\n+        }\n     }\n \n     /// Like `visit_nested_item()`, but for foreign items. See\n     /// `visit_nested_item()` for advice on when to override this\n     /// method.\n     fn visit_nested_foreign_item(&mut self, id: ForeignItemId) {\n-        let opt_item = self.nested_visit_map().inter().map(|map| map.foreign_item(id));\n-        walk_list!(self, visit_foreign_item, opt_item);\n+        if Self::NestedFilter::INTER {\n+            let item = self.nested_visit_map().foreign_item(id);\n+            self.visit_foreign_item(item);\n+        }\n     }\n \n     /// Invoked to visit the body of a function, method or closure. Like\n     /// visit_nested_item, does nothing by default unless you override\n     /// `nested_visit_map` to return other than `None`, in which case it will walk\n     /// the body.\n     fn visit_nested_body(&mut self, id: BodyId) {\n-        let opt_body = self.nested_visit_map().intra().map(|map| map.body(id));\n-        walk_list!(self, visit_body, opt_body);\n+        if Self::NestedFilter::INTRA {\n+            let body = self.nested_visit_map().body(id);\n+            self.visit_body(body);\n+        }\n     }\n \n     fn visit_param(&mut self, param: &'v Param<'v>) {"}, {"sha": "f1d62d03cbc98e3c8c3c072b27f6b1ec3ca9f0f3", "filename": "compiler/rustc_hir/src/lib.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_hir%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_hir%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir%2Fsrc%2Flib.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -2,6 +2,7 @@\n //!\n //! [rustc dev guide]: https://rustc-dev-guide.rust-lang.org/hir.html\n \n+#![feature(associated_type_defaults)]\n #![feature(const_btree_new)]\n #![feature(crate_visibility_modifier)]\n #![feature(once_cell)]"}, {"sha": "60b48e9bc8a0124d1b2fc793121ba42e901fb173", "filename": "compiler/rustc_incremental/src/assert_dep_graph.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_incremental%2Fsrc%2Fassert_dep_graph.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_incremental%2Fsrc%2Fassert_dep_graph.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_incremental%2Fsrc%2Fassert_dep_graph.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -39,11 +39,11 @@ use rustc_data_structures::graph::implementation::{Direction, NodeIndex, INCOMIN\n use rustc_graphviz as dot;\n use rustc_hir as hir;\n use rustc_hir::def_id::DefId;\n-use rustc_hir::intravisit::{self, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{self, Visitor};\n use rustc_middle::dep_graph::{\n     DepGraphQuery, DepKind, DepNode, DepNodeExt, DepNodeFilter, EdgeFilter,\n };\n-use rustc_middle::hir::map::Map;\n+use rustc_middle::hir::nested_filter;\n use rustc_middle::ty::TyCtxt;\n use rustc_span::symbol::{sym, Symbol};\n use rustc_span::Span;\n@@ -173,10 +173,10 @@ impl<'tcx> IfThisChanged<'tcx> {\n }\n \n impl<'tcx> Visitor<'tcx> for IfThisChanged<'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::OnlyBodies;\n \n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::OnlyBodies(self.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.tcx.hir()\n     }\n \n     fn visit_item(&mut self, item: &'tcx hir::Item<'tcx>) {"}, {"sha": "94c149dd23e6f4c7a92ae8a5a0f690867a2a01bf", "filename": "compiler/rustc_incremental/src/persist/dirty_clean.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_incremental%2Fsrc%2Fpersist%2Fdirty_clean.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_incremental%2Fsrc%2Fpersist%2Fdirty_clean.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_incremental%2Fsrc%2Fpersist%2Fdirty_clean.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -28,7 +28,7 @@ use rustc_hir::itemlikevisit::ItemLikeVisitor;\n use rustc_hir::Node as HirNode;\n use rustc_hir::{ImplItemKind, ItemKind as HirItem, TraitItemKind};\n use rustc_middle::dep_graph::{label_strs, DepNode, DepNodeExt};\n-use rustc_middle::hir::map::Map;\n+use rustc_middle::hir::nested_filter;\n use rustc_middle::ty::TyCtxt;\n use rustc_span::symbol::{sym, Symbol};\n use rustc_span::Span;\n@@ -472,10 +472,10 @@ impl<'tcx> FindAllAttrs<'tcx> {\n }\n \n impl<'tcx> intravisit::Visitor<'tcx> for FindAllAttrs<'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::All;\n \n-    fn nested_visit_map(&mut self) -> intravisit::NestedVisitorMap<Self::Map> {\n-        intravisit::NestedVisitorMap::All(self.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.tcx.hir()\n     }\n \n     fn visit_attribute(&mut self, _: hir::HirId, attr: &'tcx Attribute) {"}, {"sha": "1fc78f8f9e305eeb7879ed57d0c57a2d597b767b", "filename": "compiler/rustc_infer/src/infer/error_reporting/need_type_info.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_infer%2Fsrc%2Finfer%2Ferror_reporting%2Fneed_type_info.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_infer%2Fsrc%2Finfer%2Ferror_reporting%2Fneed_type_info.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_infer%2Fsrc%2Finfer%2Ferror_reporting%2Fneed_type_info.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -4,9 +4,9 @@ use rustc_errors::{pluralize, struct_span_err, Applicability, DiagnosticBuilder}\n use rustc_hir as hir;\n use rustc_hir::def::{DefKind, Namespace};\n use rustc_hir::def_id::DefId;\n-use rustc_hir::intravisit::{self, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{self, Visitor};\n use rustc_hir::{Body, Expr, ExprKind, FnRetTy, HirId, Local, MatchSource, Pat};\n-use rustc_middle::hir::map::Map;\n+use rustc_middle::hir::nested_filter;\n use rustc_middle::infer::unify_key::ConstVariableOriginKind;\n use rustc_middle::ty::print::Print;\n use rustc_middle::ty::subst::{GenericArg, GenericArgKind};\n@@ -83,10 +83,10 @@ impl<'a, 'tcx> FindHirNodeVisitor<'a, 'tcx> {\n }\n \n impl<'a, 'tcx> Visitor<'tcx> for FindHirNodeVisitor<'a, 'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::OnlyBodies;\n \n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::OnlyBodies(self.infcx.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.infcx.tcx.hir()\n     }\n \n     fn visit_local(&mut self, local: &'tcx Local<'tcx>) {"}, {"sha": "07bba00056630b56e571d24c0dc684c06acf9367", "filename": "compiler/rustc_infer/src/infer/error_reporting/nice_region_error/find_anon_type.rs", "status": "modified", "additions": 8, "deletions": 7, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_infer%2Fsrc%2Finfer%2Ferror_reporting%2Fnice_region_error%2Ffind_anon_type.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_infer%2Fsrc%2Finfer%2Ferror_reporting%2Fnice_region_error%2Ffind_anon_type.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_infer%2Fsrc%2Finfer%2Ferror_reporting%2Fnice_region_error%2Ffind_anon_type.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -1,7 +1,8 @@\n use rustc_hir as hir;\n-use rustc_hir::intravisit::{self, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{self, Visitor};\n use rustc_hir::Node;\n use rustc_middle::hir::map::Map;\n+use rustc_middle::hir::nested_filter;\n use rustc_middle::middle::resolve_lifetime as rl;\n use rustc_middle::ty::{self, Region, TyCtxt};\n \n@@ -84,10 +85,10 @@ struct FindNestedTypeVisitor<'tcx> {\n }\n \n impl<'tcx> Visitor<'tcx> for FindNestedTypeVisitor<'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::OnlyBodies;\n \n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::OnlyBodies(self.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.tcx.hir()\n     }\n \n     fn visit_ty(&mut self, arg: &'tcx hir::Ty<'tcx>) {\n@@ -208,10 +209,10 @@ struct TyPathVisitor<'tcx> {\n }\n \n impl<'tcx> Visitor<'tcx> for TyPathVisitor<'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::OnlyBodies;\n \n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Map<'tcx>> {\n-        NestedVisitorMap::OnlyBodies(self.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Map<'tcx> {\n+        self.tcx.hir()\n     }\n \n     fn visit_lifetime(&mut self, lifetime: &hir::Lifetime) {"}, {"sha": "412a077959d01a9104d51275eaa26c3a69cc2f5d", "filename": "compiler/rustc_infer/src/infer/error_reporting/nice_region_error/static_impl_trait.rs", "status": "modified", "additions": 1, "deletions": 7, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_infer%2Fsrc%2Finfer%2Ferror_reporting%2Fnice_region_error%2Fstatic_impl_trait.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_infer%2Fsrc%2Finfer%2Ferror_reporting%2Fnice_region_error%2Fstatic_impl_trait.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_infer%2Fsrc%2Finfer%2Ferror_reporting%2Fnice_region_error%2Fstatic_impl_trait.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -7,7 +7,7 @@ use crate::traits::{ObligationCauseCode, UnifyReceiverContext};\n use rustc_data_structures::stable_set::FxHashSet;\n use rustc_errors::{struct_span_err, Applicability, DiagnosticBuilder, ErrorReported};\n use rustc_hir::def_id::DefId;\n-use rustc_hir::intravisit::{walk_ty, ErasedMap, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{walk_ty, Visitor};\n use rustc_hir::{self as hir, GenericBound, Item, ItemKind, Lifetime, LifetimeName, Node, TyKind};\n use rustc_middle::ty::{\n     self, AssocItemContainer, RegionKind, StaticLifetimeVisitor, Ty, TyCtxt, TypeFoldable,\n@@ -575,12 +575,6 @@ impl<'tcx> TypeVisitor<'tcx> for TraitObjectVisitor {\n pub(super) struct HirTraitObjectVisitor<'a>(pub(super) &'a mut Vec<Span>, pub(super) DefId);\n \n impl<'a, 'tcx> Visitor<'tcx> for HirTraitObjectVisitor<'a> {\n-    type Map = ErasedMap<'tcx>;\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n-\n     fn visit_ty(&mut self, t: &'tcx hir::Ty<'tcx>) {\n         if let TyKind::TraitObject(\n             poly_trait_refs,"}, {"sha": "bbea450a76973a868c48b05e169bd936b50944c2", "filename": "compiler/rustc_infer/src/infer/error_reporting/nice_region_error/trait_impl_difference.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_infer%2Fsrc%2Finfer%2Ferror_reporting%2Fnice_region_error%2Ftrait_impl_difference.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_infer%2Fsrc%2Finfer%2Ferror_reporting%2Fnice_region_error%2Ftrait_impl_difference.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_infer%2Fsrc%2Finfer%2Ferror_reporting%2Fnice_region_error%2Ftrait_impl_difference.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -9,6 +9,7 @@ use rustc_hir as hir;\n use rustc_hir::def::Res;\n use rustc_hir::def_id::DefId;\n use rustc_hir::intravisit::Visitor;\n+use rustc_middle::hir::nested_filter;\n use rustc_middle::ty::print::RegionHighlightMode;\n use rustc_middle::ty::{self, Ty, TyCtxt, TypeFoldable, TypeVisitor};\n \n@@ -182,10 +183,10 @@ struct TypeParamSpanVisitor<'tcx> {\n }\n \n impl<'tcx> Visitor<'tcx> for TypeParamSpanVisitor<'tcx> {\n-    type Map = rustc_middle::hir::map::Map<'tcx>;\n+    type NestedFilter = nested_filter::OnlyBodies;\n \n-    fn nested_visit_map(&mut self) -> hir::intravisit::NestedVisitorMap<Self::Map> {\n-        hir::intravisit::NestedVisitorMap::OnlyBodies(self.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.tcx.hir()\n     }\n \n     fn visit_ty(&mut self, arg: &'tcx hir::Ty<'tcx>) {"}, {"sha": "66a89492abd84323134090d364b3bfdee2311f37", "filename": "compiler/rustc_lint/src/builtin.rs", "status": "modified", "additions": 0, "deletions": 6, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_lint%2Fsrc%2Fbuiltin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_lint%2Fsrc%2Fbuiltin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_lint%2Fsrc%2Fbuiltin.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -1479,12 +1479,6 @@ impl TypeAliasBounds {\n             err: &'a mut DiagnosticBuilder<'db>,\n         }\n         impl<'a, 'db, 'v> Visitor<'v> for WalkAssocTypes<'a, 'db> {\n-            type Map = intravisit::ErasedMap<'v>;\n-\n-            fn nested_visit_map(&mut self) -> intravisit::NestedVisitorMap<Self::Map> {\n-                intravisit::NestedVisitorMap::None\n-            }\n-\n             fn visit_qpath(&mut self, qpath: &'v hir::QPath<'v>, id: hir::HirId, span: Span) {\n                 if TypeAliasBounds::is_type_variable_assoc(qpath) {\n                     self.err.span_help("}, {"sha": "0ce760b64d9ca0e889f01d8877421d0852fc4521", "filename": "compiler/rustc_lint/src/late.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_lint%2Fsrc%2Flate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_lint%2Fsrc%2Flate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_lint%2Fsrc%2Flate.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -21,7 +21,7 @@ use rustc_hir as hir;\n use rustc_hir::def_id::LocalDefId;\n use rustc_hir::intravisit as hir_visit;\n use rustc_hir::intravisit::Visitor;\n-use rustc_middle::hir::map::Map;\n+use rustc_middle::hir::nested_filter;\n use rustc_middle::ty::{self, TyCtxt};\n use rustc_session::lint::LintPass;\n use rustc_span::symbol::Symbol;\n@@ -94,13 +94,13 @@ impl<'tcx, T: LateLintPass<'tcx>> LateContextAndPass<'tcx, T> {\n }\n \n impl<'tcx, T: LateLintPass<'tcx>> hir_visit::Visitor<'tcx> for LateContextAndPass<'tcx, T> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::All;\n \n     /// Because lints are scoped lexically, we want to walk nested\n     /// items in the context of the outer item, so enable\n     /// deep-walking.\n-    fn nested_visit_map(&mut self) -> hir_visit::NestedVisitorMap<Self::Map> {\n-        hir_visit::NestedVisitorMap::All(self.context.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.context.tcx.hir()\n     }\n \n     fn visit_nested_body(&mut self, body_id: hir::BodyId) {"}, {"sha": "6e95708b17fe4bcaf4296d66390ac7f0e954bc6f", "filename": "compiler/rustc_lint/src/levels.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_lint%2Fsrc%2Flevels.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_lint%2Fsrc%2Flevels.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_lint%2Fsrc%2Flevels.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -6,7 +6,7 @@ use rustc_data_structures::fx::FxHashMap;\n use rustc_errors::{struct_span_err, Applicability, DiagnosticBuilder};\n use rustc_hir as hir;\n use rustc_hir::{intravisit, HirId, CRATE_HIR_ID};\n-use rustc_middle::hir::map::Map;\n+use rustc_middle::hir::nested_filter;\n use rustc_middle::lint::LevelAndSource;\n use rustc_middle::lint::LintDiagnosticBuilder;\n use rustc_middle::lint::{\n@@ -599,10 +599,10 @@ impl LintLevelMapBuilder<'_, '_> {\n }\n \n impl<'tcx> intravisit::Visitor<'tcx> for LintLevelMapBuilder<'_, 'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::All;\n \n-    fn nested_visit_map(&mut self) -> intravisit::NestedVisitorMap<Self::Map> {\n-        intravisit::NestedVisitorMap::All(self.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.tcx.hir()\n     }\n \n     fn visit_param(&mut self, param: &'tcx hir::Param<'tcx>) {"}, {"sha": "ee6656ce372650c4e97fa64dce89a91da38fa951", "filename": "compiler/rustc_metadata/src/rmeta/encoder.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fencoder.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fencoder.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_metadata%2Fsrc%2Frmeta%2Fencoder.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -11,13 +11,13 @@ use rustc_hir::def_id::{\n     CrateNum, DefId, DefIndex, LocalDefId, CRATE_DEF_ID, CRATE_DEF_INDEX, LOCAL_CRATE,\n };\n use rustc_hir::definitions::DefPathData;\n-use rustc_hir::intravisit::{self, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{self, Visitor};\n use rustc_hir::itemlikevisit::ItemLikeVisitor;\n use rustc_hir::lang_items;\n use rustc_hir::{AnonConst, GenericParamKind};\n use rustc_index::bit_set::GrowableBitSet;\n use rustc_index::vec::Idx;\n-use rustc_middle::hir::map::Map;\n+use rustc_middle::hir::nested_filter;\n use rustc_middle::middle::dependency_format::Linkage;\n use rustc_middle::middle::exported_symbols::{\n     metadata_symbol_name, ExportedSymbol, SymbolExportLevel,\n@@ -1917,10 +1917,10 @@ impl<'a, 'tcx> EncodeContext<'a, 'tcx> {\n \n // FIXME(eddyb) make metadata encoding walk over all definitions, instead of HIR.\n impl<'a, 'tcx> Visitor<'tcx> for EncodeContext<'a, 'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::OnlyBodies;\n \n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::OnlyBodies(self.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.tcx.hir()\n     }\n     fn visit_expr(&mut self, ex: &'tcx hir::Expr<'tcx>) {\n         intravisit::walk_expr(self, ex);"}, {"sha": "82ea7ff6aab5445aea1e710ec85d7f9e3bd304ee", "filename": "compiler/rustc_middle/src/hir/map/mod.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_middle%2Fsrc%2Fhir%2Fmap%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_middle%2Fsrc%2Fhir%2Fmap%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fhir%2Fmap%2Fmod.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -12,6 +12,7 @@ use rustc_hir::intravisit::{self, Visitor};\n use rustc_hir::itemlikevisit::ItemLikeVisitor;\n use rustc_hir::*;\n use rustc_index::vec::Idx;\n+use rustc_middle::hir::nested_filter;\n use rustc_span::def_id::StableCrateId;\n use rustc_span::hygiene::MacroKind;\n use rustc_span::source_map::Spanned;\n@@ -1272,10 +1273,10 @@ pub(super) fn hir_module_items(tcx: TyCtxt<'_>, module_id: LocalDefId) -> Module\n     }\n \n     impl<'hir> Visitor<'hir> for ModuleCollector<'hir> {\n-        type Map = Map<'hir>;\n+        type NestedFilter = nested_filter::All;\n \n-        fn nested_visit_map(&mut self) -> intravisit::NestedVisitorMap<Self::Map> {\n-            intravisit::NestedVisitorMap::All(self.tcx.hir())\n+        fn nested_visit_map(&mut self) -> Self::Map {\n+            self.tcx.hir()\n         }\n \n         fn visit_item(&mut self, item: &'hir Item<'hir>) {"}, {"sha": "b4c7bb7eba79c82bcbdee45c4ac27a3723f5903d", "filename": "compiler/rustc_middle/src/hir/mod.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_middle%2Fsrc%2Fhir%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_middle%2Fsrc%2Fhir%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fhir%2Fmod.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -3,6 +3,7 @@\n //! [rustc dev guide]: https://rustc-dev-guide.rust-lang.org/hir.html\n \n pub mod map;\n+pub mod nested_filter;\n pub mod place;\n \n use crate::ty::query::Providers;"}, {"sha": "7cfb20745720d075df04044efc7628a113309c4b", "filename": "compiler/rustc_middle/src/hir/nested_filter.rs", "status": "added", "additions": 27, "deletions": 0, "changes": 27, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_middle%2Fsrc%2Fhir%2Fnested_filter.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_middle%2Fsrc%2Fhir%2Fnested_filter.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fhir%2Fnested_filter.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -0,0 +1,27 @@\n+use rustc_hir::intravisit::nested_filter::NestedFilter;\n+\n+/// Do not visit nested item-like things, but visit nested things\n+/// that are inside of an item-like.\n+///\n+/// **This is the most common choice.** A very common pattern is\n+/// to use `visit_all_item_likes()` as an outer loop,\n+/// and to have the visitor that visits the contents of each item\n+/// using this setting.\n+pub struct OnlyBodies(());\n+impl<'hir> NestedFilter<'hir> for OnlyBodies {\n+    type Map = crate::hir::map::Map<'hir>;\n+    const INTER: bool = false;\n+    const INTRA: bool = true;\n+}\n+\n+/// Visits all nested things, including item-likes.\n+///\n+/// **This is an unusual choice.** It is used when you want to\n+/// process everything within their lexical context. Typically you\n+/// kick off the visit by doing `walk_krate()`.\n+pub struct All(());\n+impl<'hir> NestedFilter<'hir> for All {\n+    type Map = crate::hir::map::Map<'hir>;\n+    const INTER: bool = true;\n+    const INTRA: bool = true;\n+}"}, {"sha": "a29a7d241e3f3928027ca9c9b6321b40630130d6", "filename": "compiler/rustc_middle/src/ty/diagnostics.rs", "status": "modified", "additions": 0, "deletions": 12, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_middle%2Fsrc%2Fty%2Fdiagnostics.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_middle%2Fsrc%2Fty%2Fdiagnostics.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fdiagnostics.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -448,12 +448,6 @@ pub fn suggest_constraining_type_param(\n pub struct TraitObjectVisitor<'tcx>(pub Vec<&'tcx hir::Ty<'tcx>>, pub crate::hir::map::Map<'tcx>);\n \n impl<'v> hir::intravisit::Visitor<'v> for TraitObjectVisitor<'v> {\n-    type Map = rustc_hir::intravisit::ErasedMap<'v>;\n-\n-    fn nested_visit_map(&mut self) -> hir::intravisit::NestedVisitorMap<Self::Map> {\n-        hir::intravisit::NestedVisitorMap::None\n-    }\n-\n     fn visit_ty(&mut self, ty: &'v hir::Ty<'v>) {\n         match ty.kind {\n             hir::TyKind::TraitObject(\n@@ -482,12 +476,6 @@ impl<'v> hir::intravisit::Visitor<'v> for TraitObjectVisitor<'v> {\n pub struct StaticLifetimeVisitor<'tcx>(pub Vec<Span>, pub crate::hir::map::Map<'tcx>);\n \n impl<'v> hir::intravisit::Visitor<'v> for StaticLifetimeVisitor<'v> {\n-    type Map = rustc_hir::intravisit::ErasedMap<'v>;\n-\n-    fn nested_visit_map(&mut self) -> hir::intravisit::NestedVisitorMap<Self::Map> {\n-        hir::intravisit::NestedVisitorMap::None\n-    }\n-\n     fn visit_lifetime(&mut self, lt: &'v hir::Lifetime) {\n         if let hir::LifetimeName::ImplicitObjectLifetimeDefault | hir::LifetimeName::Static =\n             lt.name"}, {"sha": "868dd195f3a63c7ce2ec67d175b7a61c158383b0", "filename": "compiler/rustc_mir_build/src/thir/pattern/check_match.rs", "status": "modified", "additions": 1, "deletions": 7, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fpattern%2Fcheck_match.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fpattern%2Fcheck_match.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_build%2Fsrc%2Fthir%2Fpattern%2Fcheck_match.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -10,7 +10,7 @@ use rustc_errors::{error_code, struct_span_err, Applicability, DiagnosticBuilder\n use rustc_hir as hir;\n use rustc_hir::def::*;\n use rustc_hir::def_id::DefId;\n-use rustc_hir::intravisit::{self, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{self, Visitor};\n use rustc_hir::{HirId, Pat};\n use rustc_middle::ty::{self, AdtDef, Ty, TyCtxt};\n use rustc_session::lint::builtin::{\n@@ -54,12 +54,6 @@ struct MatchVisitor<'a, 'p, 'tcx> {\n }\n \n impl<'tcx> Visitor<'tcx> for MatchVisitor<'_, '_, 'tcx> {\n-    type Map = intravisit::ErasedMap<'tcx>;\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n-\n     fn visit_expr(&mut self, ex: &'tcx hir::Expr<'tcx>) {\n         intravisit::walk_expr(self, ex);\n         match &ex.kind {"}, {"sha": "fd93744d400919749b66793bb8774e0a9ee07c25", "filename": "compiler/rustc_mir_transform/src/check_unsafety.rs", "status": "modified", "additions": 0, "deletions": 6, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_mir_transform%2Fsrc%2Fcheck_unsafety.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_mir_transform%2Fsrc%2Fcheck_unsafety.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Fcheck_unsafety.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -393,12 +393,6 @@ struct UnusedUnsafeVisitor<'a> {\n }\n \n impl<'tcx> intravisit::Visitor<'tcx> for UnusedUnsafeVisitor<'_> {\n-    type Map = intravisit::ErasedMap<'tcx>;\n-\n-    fn nested_visit_map(&mut self) -> intravisit::NestedVisitorMap<Self::Map> {\n-        intravisit::NestedVisitorMap::None\n-    }\n-\n     fn visit_block(&mut self, block: &'tcx hir::Block<'tcx>) {\n         intravisit::walk_block(self, block);\n "}, {"sha": "bf6f13fa67b58e10e7f9fc5db8ed090b4087679c", "filename": "compiler/rustc_mir_transform/src/lib.rs", "status": "modified", "additions": 1, "deletions": 5, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_mir_transform%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_mir_transform%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Flib.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -22,7 +22,7 @@ use rustc_data_structures::fx::FxHashSet;\n use rustc_data_structures::steal::Steal;\n use rustc_hir as hir;\n use rustc_hir::def_id::{DefId, LocalDefId};\n-use rustc_hir::intravisit::{self, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{self, Visitor};\n use rustc_index::vec::IndexVec;\n use rustc_middle::mir::visit::Visitor as _;\n use rustc_middle::mir::{traversal, Body, ConstQualifs, MirPass, MirPhase, Promoted};\n@@ -162,10 +162,6 @@ fn mir_keys(tcx: TyCtxt<'_>, (): ()) -> FxHashSet<LocalDefId> {\n             }\n             intravisit::walk_struct_def(self, v)\n         }\n-        type Map = intravisit::ErasedMap<'tcx>;\n-        fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-            NestedVisitorMap::None\n-        }\n     }\n     tcx.hir().visit_all_item_likes(&mut GatherCtors { tcx, set: &mut set }.as_deep_visitor());\n "}, {"sha": "9882d50ade16e810826200652cc6d4b3d3e9e49e", "filename": "compiler/rustc_passes/src/check_attr.rs", "status": "modified", "additions": 7, "deletions": 8, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fcheck_attr.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -4,19 +4,18 @@\n //! conflicts between multiple such attributes attached to the same\n //! item.\n \n-use rustc_middle::hir::map::Map;\n-use rustc_middle::ty::query::Providers;\n-use rustc_middle::ty::TyCtxt;\n-\n use rustc_ast::{ast, AttrStyle, Attribute, Lit, LitKind, NestedMetaItem};\n use rustc_data_structures::fx::FxHashMap;\n use rustc_errors::{pluralize, struct_span_err, Applicability};\n use rustc_feature::{AttributeDuplicates, AttributeType, BuiltinAttribute, BUILTIN_ATTRIBUTE_MAP};\n use rustc_hir as hir;\n use rustc_hir::def_id::{LocalDefId, CRATE_DEF_ID};\n-use rustc_hir::intravisit::{self, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{self, Visitor};\n use rustc_hir::{self, FnSig, ForeignItem, HirId, Item, ItemKind, TraitItem, CRATE_HIR_ID};\n use rustc_hir::{MethodKind, Target};\n+use rustc_middle::hir::nested_filter;\n+use rustc_middle::ty::query::Providers;\n+use rustc_middle::ty::TyCtxt;\n use rustc_session::lint::builtin::{\n     CONFLICTING_REPR_HINTS, INVALID_DOC_ATTRIBUTES, UNUSED_ATTRIBUTES,\n };\n@@ -1851,10 +1850,10 @@ impl CheckAttrVisitor<'_> {\n }\n \n impl<'tcx> Visitor<'tcx> for CheckAttrVisitor<'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::OnlyBodies;\n \n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::OnlyBodies(self.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.tcx.hir()\n     }\n \n     fn visit_item(&mut self, item: &'tcx Item<'tcx>) {"}, {"sha": "2b11f6b0c1d029efbf0d0a4d0812390ede307722", "filename": "compiler/rustc_passes/src/check_const.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_passes%2Fsrc%2Fcheck_const.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_passes%2Fsrc%2Fcheck_const.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fcheck_const.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -11,8 +11,8 @@ use rustc_attr as attr;\n use rustc_errors::struct_span_err;\n use rustc_hir as hir;\n use rustc_hir::def_id::LocalDefId;\n-use rustc_hir::intravisit::{self, NestedVisitorMap, Visitor};\n-use rustc_middle::hir::map::Map;\n+use rustc_hir::intravisit::{self, Visitor};\n+use rustc_middle::hir::nested_filter;\n use rustc_middle::ty;\n use rustc_middle::ty::query::Providers;\n use rustc_middle::ty::TyCtxt;\n@@ -262,10 +262,10 @@ impl<'tcx> CheckConstVisitor<'tcx> {\n }\n \n impl<'tcx> Visitor<'tcx> for CheckConstVisitor<'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::OnlyBodies;\n \n-    fn nested_visit_map(&mut self) -> intravisit::NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::OnlyBodies(self.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.tcx.hir()\n     }\n \n     fn visit_anon_const(&mut self, anon: &'tcx hir::AnonConst) {"}, {"sha": "4cca71424492cf5aa1469e3e5a5375abaf022767", "filename": "compiler/rustc_passes/src/dead.rs", "status": "modified", "additions": 5, "deletions": 11, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_passes%2Fsrc%2Fdead.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_passes%2Fsrc%2Fdead.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fdead.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -6,10 +6,10 @@ use rustc_data_structures::fx::{FxHashMap, FxHashSet};\n use rustc_hir as hir;\n use rustc_hir::def::{CtorOf, DefKind, Res};\n use rustc_hir::def_id::{DefId, LocalDefId};\n-use rustc_hir::intravisit::{self, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{self, Visitor};\n use rustc_hir::itemlikevisit::ItemLikeVisitor;\n use rustc_hir::{Node, PatKind, TyKind};\n-use rustc_middle::hir::map::Map;\n+use rustc_middle::hir::nested_filter;\n use rustc_middle::middle::codegen_fn_attrs::CodegenFnAttrFlags;\n use rustc_middle::middle::privacy;\n use rustc_middle::ty::{self, DefIdTree, TyCtxt};\n@@ -323,12 +323,6 @@ impl<'tcx> MarkSymbolVisitor<'tcx> {\n }\n \n impl<'tcx> Visitor<'tcx> for MarkSymbolVisitor<'tcx> {\n-    type Map = intravisit::ErasedMap<'tcx>;\n-\n-    fn nested_visit_map(&mut self) -> intravisit::NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n-\n     fn visit_nested_body(&mut self, body: hir::BodyId) {\n         let old_maybe_typeck_results =\n             self.maybe_typeck_results.replace(self.tcx.typeck_body(body));\n@@ -673,14 +667,14 @@ impl<'tcx> DeadVisitor<'tcx> {\n }\n \n impl<'tcx> Visitor<'tcx> for DeadVisitor<'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::All;\n \n     /// Walk nested items in place so that we don't report dead-code\n     /// on inner functions when the outer function is already getting\n     /// an error. We could do this also by checking the parents, but\n     /// this is how the code is setup and it seems harmless enough.\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::All(self.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.tcx.hir()\n     }\n \n     fn visit_item(&mut self, item: &'tcx hir::Item<'tcx>) {"}, {"sha": "56755d68686e3d27b4c70df96de00d5ef82db02d", "filename": "compiler/rustc_passes/src/hir_id_validator.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_passes%2Fsrc%2Fhir_id_validator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_passes%2Fsrc%2Fhir_id_validator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fhir_id_validator.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -6,6 +6,7 @@ use rustc_hir::intravisit;\n use rustc_hir::itemlikevisit::ItemLikeVisitor;\n use rustc_hir::{HirId, ItemLocalId};\n use rustc_middle::hir::map::Map;\n+use rustc_middle::hir::nested_filter;\n use rustc_middle::ty::TyCtxt;\n \n pub fn check_crate(tcx: TyCtxt<'_>) {\n@@ -139,10 +140,10 @@ impl<'a, 'hir> HirIdValidator<'a, 'hir> {\n }\n \n impl<'a, 'hir> intravisit::Visitor<'hir> for HirIdValidator<'a, 'hir> {\n-    type Map = Map<'hir>;\n+    type NestedFilter = nested_filter::OnlyBodies;\n \n-    fn nested_visit_map(&mut self) -> intravisit::NestedVisitorMap<Self::Map> {\n-        intravisit::NestedVisitorMap::OnlyBodies(self.hir_map)\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.hir_map\n     }\n \n     fn visit_id(&mut self, hir_id: HirId) {"}, {"sha": "5cc958ef54971f67cd7b6ef327bafa8edea88a08", "filename": "compiler/rustc_passes/src/hir_stats.rs", "status": "modified", "additions": 0, "deletions": 6, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_passes%2Fsrc%2Fhir_stats.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_passes%2Fsrc%2Fhir_stats.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fhir_stats.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -95,12 +95,6 @@ impl<'v> hir_visit::Visitor<'v> for StatCollector<'v> {\n         hir_visit::walk_param(self, param)\n     }\n \n-    type Map = Map<'v>;\n-\n-    fn nested_visit_map(&mut self) -> hir_visit::NestedVisitorMap<Self::Map> {\n-        panic!(\"visit_nested_xxx must be manually implemented in this visitor\")\n-    }\n-\n     fn visit_nested_item(&mut self, id: hir::ItemId) {\n         let nested_item = self.krate.unwrap().item(id);\n         self.visit_item(nested_item)"}, {"sha": "85c568d8623badc860a7eff0f0b0821ea38d282d", "filename": "compiler/rustc_passes/src/intrinsicck.rs", "status": "modified", "additions": 1, "deletions": 13, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_passes%2Fsrc%2Fintrinsicck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_passes%2Fsrc%2Fintrinsicck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fintrinsicck.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -3,7 +3,7 @@ use rustc_errors::struct_span_err;\n use rustc_hir as hir;\n use rustc_hir::def::{DefKind, Res};\n use rustc_hir::def_id::{DefId, LocalDefId};\n-use rustc_hir::intravisit::{self, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{self, Visitor};\n use rustc_index::vec::Idx;\n use rustc_middle::ty::layout::{LayoutError, SizeSkeleton};\n use rustc_middle::ty::query::Providers;\n@@ -488,12 +488,6 @@ impl<'tcx> ExprVisitor<'tcx> {\n }\n \n impl<'tcx> Visitor<'tcx> for ItemVisitor<'tcx> {\n-    type Map = intravisit::ErasedMap<'tcx>;\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n-\n     fn visit_nested_body(&mut self, body_id: hir::BodyId) {\n         let owner_def_id = self.tcx.hir().body_owner_def_id(body_id);\n         let body = self.tcx.hir().body(body_id);\n@@ -505,12 +499,6 @@ impl<'tcx> Visitor<'tcx> for ItemVisitor<'tcx> {\n }\n \n impl<'tcx> Visitor<'tcx> for ExprVisitor<'tcx> {\n-    type Map = intravisit::ErasedMap<'tcx>;\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n-\n     fn visit_expr(&mut self, expr: &'tcx hir::Expr<'tcx>) {\n         match expr.kind {\n             hir::ExprKind::Path(ref qpath) => {"}, {"sha": "00445690f8f02124ff6d8d5840e4f445257dca05", "filename": "compiler/rustc_passes/src/lib_features.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_passes%2Fsrc%2Flib_features.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_passes%2Fsrc%2Flib_features.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Flib_features.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -6,8 +6,8 @@\n \n use rustc_ast::{Attribute, MetaItemKind};\n use rustc_errors::struct_span_err;\n-use rustc_hir::intravisit::{NestedVisitorMap, Visitor};\n-use rustc_middle::hir::map::Map;\n+use rustc_hir::intravisit::Visitor;\n+use rustc_middle::hir::nested_filter;\n use rustc_middle::middle::lib_features::LibFeatures;\n use rustc_middle::ty::query::Providers;\n use rustc_middle::ty::TyCtxt;\n@@ -111,10 +111,10 @@ impl<'tcx> LibFeatureCollector<'tcx> {\n }\n \n impl<'tcx> Visitor<'tcx> for LibFeatureCollector<'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::All;\n \n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::All(self.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.tcx.hir()\n     }\n \n     fn visit_attribute(&mut self, _: rustc_hir::HirId, attr: &'tcx Attribute) {"}, {"sha": "69cd1b4fed589b5d772dce7fc64892c0fdb40d67", "filename": "compiler/rustc_passes/src/liveness.rs", "status": "modified", "additions": 5, "deletions": 11, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_passes%2Fsrc%2Fliveness.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_passes%2Fsrc%2Fliveness.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fliveness.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -90,10 +90,10 @@ use rustc_errors::Applicability;\n use rustc_hir as hir;\n use rustc_hir::def::*;\n use rustc_hir::def_id::LocalDefId;\n-use rustc_hir::intravisit::{self, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{self, Visitor};\n use rustc_hir::{Expr, HirId, HirIdMap, HirIdSet};\n use rustc_index::vec::IndexVec;\n-use rustc_middle::hir::map::Map;\n+use rustc_middle::hir::nested_filter;\n use rustc_middle::ty::query::Providers;\n use rustc_middle::ty::{self, DefIdTree, RootVariableMinCaptureList, Ty, TyCtxt};\n use rustc_session::lint;\n@@ -316,10 +316,10 @@ impl<'tcx> IrMaps<'tcx> {\n }\n \n impl<'tcx> Visitor<'tcx> for IrMaps<'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::OnlyBodies;\n \n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::OnlyBodies(self.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.tcx.hir()\n     }\n \n     fn visit_body(&mut self, body: &'tcx hir::Body<'tcx>) {\n@@ -1305,12 +1305,6 @@ impl<'a, 'tcx> Liveness<'a, 'tcx> {\n // Checking for error conditions\n \n impl<'a, 'tcx> Visitor<'tcx> for Liveness<'a, 'tcx> {\n-    type Map = intravisit::ErasedMap<'tcx>;\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n-\n     fn visit_local(&mut self, local: &'tcx hir::Local<'tcx>) {\n         self.check_unused_vars_in_pat(&local.pat, None, |spans, hir_id, ln, var| {\n             if local.init.is_some() {"}, {"sha": "02b09daf0a41e443b012f19621971e0e685f23a8", "filename": "compiler/rustc_passes/src/loops.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_passes%2Fsrc%2Floops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_passes%2Fsrc%2Floops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Floops.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -3,9 +3,10 @@ use Context::*;\n use rustc_errors::{struct_span_err, Applicability};\n use rustc_hir as hir;\n use rustc_hir::def_id::LocalDefId;\n-use rustc_hir::intravisit::{self, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{self, Visitor};\n use rustc_hir::{Destination, Movability, Node};\n use rustc_middle::hir::map::Map;\n+use rustc_middle::hir::nested_filter;\n use rustc_middle::ty::query::Providers;\n use rustc_middle::ty::TyCtxt;\n use rustc_session::Session;\n@@ -41,10 +42,10 @@ pub(crate) fn provide(providers: &mut Providers) {\n }\n \n impl<'a, 'hir> Visitor<'hir> for CheckLoopVisitor<'a, 'hir> {\n-    type Map = Map<'hir>;\n+    type NestedFilter = nested_filter::OnlyBodies;\n \n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::OnlyBodies(self.hir_map)\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.hir_map\n     }\n \n     fn visit_anon_const(&mut self, c: &'hir hir::AnonConst) {"}, {"sha": "0228196d1a1a1c47fd5c5b6e20aa9e2bb508e7aa", "filename": "compiler/rustc_passes/src/naked_functions.rs", "status": "modified", "additions": 1, "deletions": 19, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_passes%2Fsrc%2Fnaked_functions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_passes%2Fsrc%2Fnaked_functions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fnaked_functions.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -3,7 +3,7 @@\n use rustc_ast::{Attribute, InlineAsmOptions};\n use rustc_hir as hir;\n use rustc_hir::def_id::LocalDefId;\n-use rustc_hir::intravisit::{ErasedMap, FnKind, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{FnKind, Visitor};\n use rustc_hir::{ExprKind, HirId, InlineAsmOperand, StmtKind};\n use rustc_middle::ty::query::Providers;\n use rustc_middle::ty::TyCtxt;\n@@ -29,12 +29,6 @@ struct CheckNakedFunctions<'tcx> {\n }\n \n impl<'tcx> Visitor<'tcx> for CheckNakedFunctions<'tcx> {\n-    type Map = ErasedMap<'tcx>;\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n-\n     fn visit_fn(\n         &mut self,\n         fk: FnKind<'_>,\n@@ -129,12 +123,6 @@ struct CheckParameters<'tcx> {\n }\n \n impl<'tcx> Visitor<'tcx> for CheckParameters<'tcx> {\n-    type Map = ErasedMap<'tcx>;\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n-\n     fn visit_expr(&mut self, expr: &'tcx hir::Expr<'tcx>) {\n         if let hir::ExprKind::Path(hir::QPath::Resolved(\n             _,\n@@ -296,12 +284,6 @@ impl<'tcx> CheckInlineAssembly<'tcx> {\n }\n \n impl<'tcx> Visitor<'tcx> for CheckInlineAssembly<'tcx> {\n-    type Map = ErasedMap<'tcx>;\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n-\n     fn visit_stmt(&mut self, stmt: &'tcx hir::Stmt<'tcx>) {\n         match stmt.kind {\n             StmtKind::Item(..) => {}"}, {"sha": "6cd9dc23285a963d9bb2dfb46c6ecbbd7e406e0d", "filename": "compiler/rustc_passes/src/reachable.rs", "status": "modified", "additions": 1, "deletions": 7, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_passes%2Fsrc%2Freachable.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_passes%2Fsrc%2Freachable.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Freachable.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -9,7 +9,7 @@ use rustc_data_structures::fx::FxHashSet;\n use rustc_hir as hir;\n use rustc_hir::def::{DefKind, Res};\n use rustc_hir::def_id::{DefId, LocalDefId};\n-use rustc_hir::intravisit::{self, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{self, Visitor};\n use rustc_hir::itemlikevisit::ItemLikeVisitor;\n use rustc_hir::Node;\n use rustc_middle::middle::codegen_fn_attrs::{CodegenFnAttrFlags, CodegenFnAttrs};\n@@ -74,12 +74,6 @@ struct ReachableContext<'tcx> {\n }\n \n impl<'tcx> Visitor<'tcx> for ReachableContext<'tcx> {\n-    type Map = intravisit::ErasedMap<'tcx>;\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n-\n     fn visit_nested_body(&mut self, body: hir::BodyId) {\n         let old_maybe_typeck_results =\n             self.maybe_typeck_results.replace(self.tcx.typeck_body(body));"}, {"sha": "db699a56645c2ae641e27eca378ea50755ab7537", "filename": "compiler/rustc_passes/src/region.rs", "status": "modified", "additions": 1, "deletions": 7, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_passes%2Fsrc%2Fregion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_passes%2Fsrc%2Fregion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fregion.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -10,7 +10,7 @@ use rustc_ast::walk_list;\n use rustc_data_structures::fx::FxHashSet;\n use rustc_hir as hir;\n use rustc_hir::def_id::DefId;\n-use rustc_hir::intravisit::{self, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{self, Visitor};\n use rustc_hir::{Arm, Block, Expr, Local, Pat, PatKind, Stmt};\n use rustc_index::vec::Idx;\n use rustc_middle::middle::region::*;\n@@ -721,12 +721,6 @@ impl<'tcx> RegionResolutionVisitor<'tcx> {\n }\n \n impl<'tcx> Visitor<'tcx> for RegionResolutionVisitor<'tcx> {\n-    type Map = intravisit::ErasedMap<'tcx>;\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n-\n     fn visit_block(&mut self, b: &'tcx Block<'tcx>) {\n         resolve_block(self, b);\n     }"}, {"sha": "3521b6fc1696c7978072e63fe92636be9baf4ecb", "filename": "compiler/rustc_passes/src/stability.rs", "status": "modified", "additions": 11, "deletions": 17, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_passes%2Fsrc%2Fstability.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_passes%2Fsrc%2Fstability.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fstability.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -9,9 +9,9 @@ use rustc_hir as hir;\n use rustc_hir::def::{DefKind, Res};\n use rustc_hir::def_id::{DefId, LocalDefId, CRATE_DEF_ID, CRATE_DEF_INDEX, LOCAL_CRATE};\n use rustc_hir::hir_id::CRATE_HIR_ID;\n-use rustc_hir::intravisit::{self, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{self, Visitor};\n use rustc_hir::{FieldDef, Generics, HirId, Item, TraitRef, Ty, TyKind, Variant};\n-use rustc_middle::hir::map::Map;\n+use rustc_middle::hir::nested_filter;\n use rustc_middle::middle::privacy::AccessLevels;\n use rustc_middle::middle::stability::{DeprecationEntry, Index};\n use rustc_middle::ty::{self, query::Providers, TyCtxt};\n@@ -378,10 +378,10 @@ impl<'a, 'tcx> Visitor<'tcx> for Annotator<'a, 'tcx> {\n     /// Because stability levels are scoped lexically, we want to walk\n     /// nested items in the context of the outer item, so enable\n     /// deep-walking.\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::All;\n \n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::All(self.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.tcx.hir()\n     }\n \n     fn visit_item(&mut self, i: &'tcx Item<'tcx>) {\n@@ -593,10 +593,10 @@ impl<'tcx> MissingStabilityAnnotations<'tcx> {\n }\n \n impl<'tcx> Visitor<'tcx> for MissingStabilityAnnotations<'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::OnlyBodies;\n \n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::OnlyBodies(self.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.tcx.hir()\n     }\n \n     fn visit_item(&mut self, i: &'tcx Item<'tcx>) {\n@@ -738,13 +738,13 @@ struct Checker<'tcx> {\n }\n \n impl<'tcx> Visitor<'tcx> for Checker<'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::OnlyBodies;\n \n     /// Because stability levels are scoped lexically, we want to walk\n     /// nested items in the context of the outer item, so enable\n     /// deep-walking.\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::OnlyBodies(self.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.tcx.hir()\n     }\n \n     fn visit_item(&mut self, item: &'tcx hir::Item<'tcx>) {\n@@ -860,12 +860,6 @@ struct CheckTraitImplStable<'tcx> {\n }\n \n impl<'tcx> Visitor<'tcx> for CheckTraitImplStable<'tcx> {\n-    type Map = Map<'tcx>;\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n-\n     fn visit_path(&mut self, path: &'tcx hir::Path<'tcx>, _id: hir::HirId) {\n         if let Some(def_id) = path.res.opt_def_id() {\n             if let Some(stab) = self.tcx.lookup_stability(def_id) {"}, {"sha": "25fe8e4582535eb391855e0f5bbba24ee533a992", "filename": "compiler/rustc_passes/src/upvars.rs", "status": "modified", "additions": 1, "deletions": 13, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_passes%2Fsrc%2Fupvars.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_passes%2Fsrc%2Fupvars.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fupvars.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -3,7 +3,7 @@\n use rustc_data_structures::fx::{FxHashSet, FxIndexMap};\n use rustc_hir as hir;\n use rustc_hir::def::Res;\n-use rustc_hir::intravisit::{self, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{self, Visitor};\n use rustc_hir::{self, HirId};\n use rustc_middle::ty::query::Providers;\n use rustc_middle::ty::TyCtxt;\n@@ -43,12 +43,6 @@ struct LocalCollector {\n }\n \n impl<'tcx> Visitor<'tcx> for LocalCollector {\n-    type Map = intravisit::ErasedMap<'tcx>;\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n-\n     fn visit_pat(&mut self, pat: &'tcx hir::Pat<'tcx>) {\n         if let hir::PatKind::Binding(_, hir_id, ..) = pat.kind {\n             self.locals.insert(hir_id);\n@@ -72,12 +66,6 @@ impl CaptureCollector<'_, '_> {\n }\n \n impl<'tcx> Visitor<'tcx> for CaptureCollector<'_, 'tcx> {\n-    type Map = intravisit::ErasedMap<'tcx>;\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n-\n     fn visit_path(&mut self, path: &'tcx hir::Path<'tcx>, _: hir::HirId) {\n         if let Res::Local(var_id) = path.res {\n             self.visit_local_use(var_id, path.span);"}, {"sha": "6b73c95011940a1cc0c3883574ab46d33420d44e", "filename": "compiler/rustc_passes/src/weak_lang_items.rs", "status": "modified", "additions": 1, "deletions": 7, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_passes%2Fsrc%2Fweak_lang_items.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_passes%2Fsrc%2Fweak_lang_items.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_passes%2Fsrc%2Fweak_lang_items.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -3,7 +3,7 @@\n use rustc_data_structures::fx::FxHashSet;\n use rustc_errors::struct_span_err;\n use rustc_hir as hir;\n-use rustc_hir::intravisit::{self, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{self, Visitor};\n use rustc_hir::lang_items::{self, LangItem};\n use rustc_hir::weak_lang_items::WEAK_ITEMS_REFS;\n use rustc_middle::middle::lang_items::required;\n@@ -95,12 +95,6 @@ impl<'a, 'tcx> Context<'a, 'tcx> {\n }\n \n impl<'a, 'tcx, 'v> Visitor<'v> for Context<'a, 'tcx> {\n-    type Map = intravisit::ErasedMap<'v>;\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n-\n     fn visit_foreign_item(&mut self, i: &hir::ForeignItem<'_>) {\n         let attrs = self.tcx.hir().attrs(i.hir_id());\n         if let Some((lang_item, _)) = lang_items::extract(attrs) {"}, {"sha": "7bee2ebf2f977813c9c9eabd8e5f0fa6cf85f424", "filename": "compiler/rustc_privacy/src/lib.rs", "status": "modified", "additions": 20, "deletions": 26, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_privacy%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_privacy%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_privacy%2Fsrc%2Flib.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -12,10 +12,10 @@ use rustc_errors::struct_span_err;\n use rustc_hir as hir;\n use rustc_hir::def::{DefKind, Res};\n use rustc_hir::def_id::{DefId, LocalDefId, LocalDefIdSet, CRATE_DEF_ID};\n-use rustc_hir::intravisit::{self, DeepVisitor, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{self, DeepVisitor, Visitor};\n use rustc_hir::{AssocItemKind, HirIdSet, Node, PatKind};\n use rustc_middle::bug;\n-use rustc_middle::hir::map::Map;\n+use rustc_middle::hir::nested_filter;\n use rustc_middle::middle::privacy::{AccessLevel, AccessLevels};\n use rustc_middle::span_bug;\n use rustc_middle::thir::abstract_const::Node as ACNode;\n@@ -305,10 +305,10 @@ struct PubRestrictedVisitor<'tcx> {\n }\n \n impl<'tcx> Visitor<'tcx> for PubRestrictedVisitor<'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::All;\n \n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::All(self.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.tcx.hir()\n     }\n     fn visit_vis(&mut self, vis: &'tcx hir::Visibility<'tcx>) {\n         self.has_pub_restricted = self.has_pub_restricted || vis.node.is_pub_restricted();\n@@ -630,12 +630,12 @@ impl<'tcx> EmbargoVisitor<'tcx> {\n }\n \n impl<'tcx> Visitor<'tcx> for EmbargoVisitor<'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::All;\n \n     /// We want to visit items in the context of their containing\n     /// module and so forth, so supply a crate for doing a deep walk.\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::All(self.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.tcx.hir()\n     }\n \n     fn visit_item(&mut self, item: &'tcx hir::Item<'tcx>) {\n@@ -964,12 +964,12 @@ impl<'tcx> NamePrivacyVisitor<'tcx> {\n }\n \n impl<'tcx> Visitor<'tcx> for NamePrivacyVisitor<'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::All;\n \n     /// We want to visit items in the context of their containing\n     /// module and so forth, so supply a crate for doing a deep walk.\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::All(self.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.tcx.hir()\n     }\n \n     fn visit_mod(&mut self, _m: &'tcx hir::Mod<'tcx>, _s: Span, _n: hir::HirId) {\n@@ -1093,12 +1093,12 @@ impl<'tcx> TypePrivacyVisitor<'tcx> {\n }\n \n impl<'tcx> Visitor<'tcx> for TypePrivacyVisitor<'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::All;\n \n     /// We want to visit items in the context of their containing\n     /// module and so forth, so supply a crate for doing a deep walk.\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::All(self.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.tcx.hir()\n     }\n \n     fn visit_mod(&mut self, _m: &'tcx hir::Mod<'tcx>, _s: Span, _n: hir::HirId) {\n@@ -1395,12 +1395,6 @@ impl<'a, 'tcx> ObsoleteVisiblePrivateTypesVisitor<'a, 'tcx> {\n }\n \n impl<'a, 'b, 'tcx, 'v> Visitor<'v> for ObsoleteCheckTypeForPrivatenessVisitor<'a, 'b, 'tcx> {\n-    type Map = intravisit::ErasedMap<'v>;\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n-\n     fn visit_generic_arg(&mut self, generic_arg: &'v hir::GenericArg<'v>) {\n         match generic_arg {\n             hir::GenericArg::Type(t) => self.visit_ty(t),\n@@ -1431,12 +1425,12 @@ impl<'a, 'b, 'tcx, 'v> Visitor<'v> for ObsoleteCheckTypeForPrivatenessVisitor<'a\n }\n \n impl<'a, 'tcx> Visitor<'tcx> for ObsoleteVisiblePrivateTypesVisitor<'a, 'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::All;\n \n     /// We want to visit items in the context of their containing\n     /// module and so forth, so supply a crate for doing a deep walk.\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::All(self.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.tcx.hir()\n     }\n \n     fn visit_item(&mut self, item: &'tcx hir::Item<'tcx>) {\n@@ -1880,10 +1874,10 @@ impl<'tcx> PrivateItemsInPublicInterfacesVisitor<'tcx> {\n }\n \n impl<'tcx> Visitor<'tcx> for PrivateItemsInPublicInterfacesVisitor<'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::OnlyBodies;\n \n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::OnlyBodies(self.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.tcx.hir()\n     }\n \n     fn visit_item(&mut self, item: &'tcx hir::Item<'tcx>) {"}, {"sha": "b077a5c9144c5d0c6a9460274e7e26644e7495f7", "filename": "compiler/rustc_resolve/src/late/lifetimes.rs", "status": "modified", "additions": 5, "deletions": 40, "changes": 45, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_resolve%2Fsrc%2Flate%2Flifetimes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_resolve%2Fsrc%2Flate%2Flifetimes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_resolve%2Fsrc%2Flate%2Flifetimes.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -14,10 +14,11 @@ use rustc_hir as hir;\n use rustc_hir::def::{DefKind, Res};\n use rustc_hir::def_id::{DefIdMap, LocalDefId};\n use rustc_hir::hir_id::ItemLocalId;\n-use rustc_hir::intravisit::{self, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{self, Visitor};\n use rustc_hir::{GenericArg, GenericParam, LifetimeName, Node, ParamName, QPath};\n use rustc_hir::{GenericParamKind, HirIdMap, HirIdSet, LifetimeParamKind};\n use rustc_middle::hir::map::Map;\n+use rustc_middle::hir::nested_filter;\n use rustc_middle::middle::resolve_lifetime::*;\n use rustc_middle::ty::{self, DefIdTree, GenericParamDefKind, TyCtxt};\n use rustc_middle::{bug, span_bug};\n@@ -651,10 +652,10 @@ impl<'a, 'tcx> LifetimeContext<'a, 'tcx> {\n     }\n }\n impl<'a, 'tcx> Visitor<'tcx> for LifetimeContext<'a, 'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::All;\n \n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::All(self.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.tcx.hir()\n     }\n \n     // We want to nest trait/impl items in their parent, but nothing else.\n@@ -1613,12 +1614,6 @@ fn extract_labels(ctxt: &mut LifetimeContext<'_, '_>, body: &hir::Body<'_>) {\n     gather.visit_body(body);\n \n     impl<'v, 'a, 'tcx> Visitor<'v> for GatherLabels<'a, 'tcx> {\n-        type Map = intravisit::ErasedMap<'v>;\n-\n-        fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-            NestedVisitorMap::None\n-        }\n-\n         fn visit_expr(&mut self, ex: &hir::Expr<'_>) {\n             if let Some(label) = expression_label(ex) {\n                 for prior_label in &self.labels_in_fn[..] {\n@@ -2832,12 +2827,6 @@ impl<'a, 'tcx> LifetimeContext<'a, 'tcx> {\n             }\n \n             impl<'a> Visitor<'a> for SelfVisitor<'a> {\n-                type Map = intravisit::ErasedMap<'a>;\n-\n-                fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-                    NestedVisitorMap::None\n-                }\n-\n                 fn visit_ty(&mut self, ty: &'a hir::Ty<'a>) {\n                     if let hir::TyKind::Rptr(lifetime_ref, ref mt) = ty.kind {\n                         if let hir::TyKind::Path(hir::QPath::Resolved(None, ref path)) = mt.ty.kind\n@@ -2922,12 +2911,6 @@ impl<'a, 'tcx> LifetimeContext<'a, 'tcx> {\n         }\n \n         impl<'v, 'a> Visitor<'v> for GatherLifetimes<'a> {\n-            type Map = intravisit::ErasedMap<'v>;\n-\n-            fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-                NestedVisitorMap::None\n-            }\n-\n             fn visit_ty(&mut self, ty: &hir::Ty<'_>) {\n                 if let hir::TyKind::BareFn(_) = ty.kind {\n                     self.outer_index.shift_in(1);\n@@ -3005,12 +2988,6 @@ impl<'a, 'tcx> LifetimeContext<'a, 'tcx> {\n             anon_count: u32,\n         }\n         impl<'v> Visitor<'v> for GatherAnonLifetimes {\n-            type Map = intravisit::ErasedMap<'v>;\n-\n-            fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-                NestedVisitorMap::None\n-            }\n-\n             #[instrument(skip(self), level = \"trace\")]\n             fn visit_ty(&mut self, ty: &hir::Ty<'_>) {\n                 // If we enter a `BareFn`, then we enter a *new* binding scope\n@@ -3508,12 +3485,6 @@ fn insert_late_bound_lifetimes(\n     }\n \n     impl<'v> Visitor<'v> for ConstrainedCollector {\n-        type Map = intravisit::ErasedMap<'v>;\n-\n-        fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-            NestedVisitorMap::None\n-        }\n-\n         fn visit_ty(&mut self, ty: &'v hir::Ty<'v>) {\n             match ty.kind {\n                 hir::TyKind::Path(\n@@ -3552,12 +3523,6 @@ fn insert_late_bound_lifetimes(\n     }\n \n     impl<'v> Visitor<'v> for AllCollector {\n-        type Map = intravisit::ErasedMap<'v>;\n-\n-        fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-            NestedVisitorMap::None\n-        }\n-\n         fn visit_lifetime(&mut self, lifetime_ref: &'v hir::Lifetime) {\n             self.regions.insert(lifetime_ref.name.normalize_to_macros_2_0());\n         }"}, {"sha": "754c2b03e667125da971456e796424799630a3f5", "filename": "compiler/rustc_save_analysis/src/dump_visitor.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_save_analysis%2Fsrc%2Fdump_visitor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_save_analysis%2Fsrc%2Fdump_visitor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_save_analysis%2Fsrc%2Fdump_visitor.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -21,7 +21,7 @@ use rustc_hir::def::{DefKind as HirDefKind, Res};\n use rustc_hir::def_id::{DefId, LocalDefId, CRATE_DEF_ID};\n use rustc_hir::intravisit::{self, Visitor};\n use rustc_hir_pretty::{bounds_to_string, fn_to_string, generic_params_to_string, ty_to_string};\n-use rustc_middle::hir::map::Map;\n+use rustc_middle::hir::nested_filter;\n use rustc_middle::span_bug;\n use rustc_middle::ty::{self, DefIdTree, TyCtxt};\n use rustc_session::config::Input;\n@@ -1137,10 +1137,10 @@ impl<'tcx> DumpVisitor<'tcx> {\n }\n \n impl<'tcx> Visitor<'tcx> for DumpVisitor<'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::All;\n \n-    fn nested_visit_map(&mut self) -> intravisit::NestedVisitorMap<Self::Map> {\n-        intravisit::NestedVisitorMap::All(self.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.tcx.hir()\n     }\n \n     fn visit_item(&mut self, item: &'tcx hir::Item<'tcx>) {"}, {"sha": "21cb93cc5f48bfb3adaec849c9767fdb0d99e6d3", "filename": "compiler/rustc_save_analysis/src/lib.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_save_analysis%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_save_analysis%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_save_analysis%2Fsrc%2Flib.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -18,7 +18,7 @@ use rustc_hir::def_id::{DefId, LOCAL_CRATE};\n use rustc_hir::intravisit::{self, Visitor};\n use rustc_hir::Node;\n use rustc_hir_pretty::{enum_def_to_string, fn_to_string, ty_to_string};\n-use rustc_middle::hir::map::Map;\n+use rustc_middle::hir::nested_filter;\n use rustc_middle::middle::privacy::AccessLevels;\n use rustc_middle::ty::{self, print::with_no_trimmed_paths, DefIdTree, TyCtxt};\n use rustc_middle::{bug, span_bug};\n@@ -859,10 +859,10 @@ impl<'l> PathCollector<'l> {\n }\n \n impl<'l> Visitor<'l> for PathCollector<'l> {\n-    type Map = Map<'l>;\n+    type NestedFilter = nested_filter::All;\n \n-    fn nested_visit_map(&mut self) -> intravisit::NestedVisitorMap<Self::Map> {\n-        intravisit::NestedVisitorMap::All(self.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.tcx.hir()\n     }\n \n     fn visit_pat(&mut self, p: &'l hir::Pat<'l>) {"}, {"sha": "d1958f85521928362173b18a5cf819c949cd12c6", "filename": "compiler/rustc_trait_selection/src/traits/error_reporting/mod.rs", "status": "modified", "additions": 0, "deletions": 6, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fmod.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -2184,12 +2184,6 @@ struct FindTypeParam {\n }\n \n impl<'v> Visitor<'v> for FindTypeParam {\n-    type Map = rustc_hir::intravisit::ErasedMap<'v>;\n-\n-    fn nested_visit_map(&mut self) -> hir::intravisit::NestedVisitorMap<Self::Map> {\n-        hir::intravisit::NestedVisitorMap::None\n-    }\n-\n     fn visit_where_predicate(&mut self, _: &'v hir::WherePredicate<'v>) {\n         // Skip where-clauses, to avoid suggesting indirection for type parameters found there.\n     }"}, {"sha": "da0b691a958e199659175b93866dfc7da200f88f", "filename": "compiler/rustc_trait_selection/src/traits/error_reporting/suggestions.rs", "status": "modified", "additions": 0, "deletions": 12, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ferror_reporting%2Fsuggestions.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -2519,12 +2519,6 @@ pub struct ReturnsVisitor<'v> {\n }\n \n impl<'v> Visitor<'v> for ReturnsVisitor<'v> {\n-    type Map = hir::intravisit::ErasedMap<'v>;\n-\n-    fn nested_visit_map(&mut self) -> hir::intravisit::NestedVisitorMap<Self::Map> {\n-        hir::intravisit::NestedVisitorMap::None\n-    }\n-\n     fn visit_expr(&mut self, ex: &'v hir::Expr<'v>) {\n         // Visit every expression to detect `return` paths, either through the function's tail\n         // expression or `return` statements. We walk all nodes to find `return` statements, but\n@@ -2581,12 +2575,6 @@ struct AwaitsVisitor {\n }\n \n impl<'v> Visitor<'v> for AwaitsVisitor {\n-    type Map = hir::intravisit::ErasedMap<'v>;\n-\n-    fn nested_visit_map(&mut self) -> hir::intravisit::NestedVisitorMap<Self::Map> {\n-        hir::intravisit::NestedVisitorMap::None\n-    }\n-\n     fn visit_expr(&mut self, ex: &'v hir::Expr<'v>) {\n         if let hir::ExprKind::Yield(_, hir::YieldSource::Await { expr: Some(id) }) = ex.kind {\n             self.awaits.push(id)"}, {"sha": "7a3d5990329b9af1b1d10b6edb6dd9849419c1cf", "filename": "compiler/rustc_typeck/src/check/check.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcheck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcheck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcheck.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -12,6 +12,7 @@ use rustc_hir::lang_items::LangItem;\n use rustc_hir::{def::Res, ItemKind, Node, PathSegment};\n use rustc_infer::infer::type_variable::{TypeVariableOrigin, TypeVariableOriginKind};\n use rustc_infer::infer::{RegionVariableOrigin, TyCtxtInferExt};\n+use rustc_middle::hir::nested_filter;\n use rustc_middle::ty::fold::TypeFoldable;\n use rustc_middle::ty::layout::MAX_SIMD_LANES;\n use rustc_middle::ty::subst::GenericArgKind;\n@@ -512,10 +513,10 @@ pub(super) fn check_opaque_for_inheriting_lifetimes<'tcx>(\n     }\n \n     impl<'tcx> Visitor<'tcx> for ProhibitOpaqueVisitor<'tcx> {\n-        type Map = rustc_middle::hir::map::Map<'tcx>;\n+        type NestedFilter = nested_filter::OnlyBodies;\n \n-        fn nested_visit_map(&mut self) -> hir::intravisit::NestedVisitorMap<Self::Map> {\n-            hir::intravisit::NestedVisitorMap::OnlyBodies(self.tcx.hir())\n+        fn nested_visit_map(&mut self) -> Self::Map {\n+            self.tcx.hir()\n         }\n \n         fn visit_ty(&mut self, arg: &'tcx hir::Ty<'tcx>) {"}, {"sha": "3984d8b74257f4b94e4a021e2775d7b3d4a08398", "filename": "compiler/rustc_typeck/src/check/compare_method.rs", "status": "modified", "additions": 0, "deletions": 7, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcompare_method.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcompare_method.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fcompare_method.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -881,13 +881,6 @@ fn compare_synthetic_generics<'tcx>(\n                                     }\n                                 }\n                             }\n-                            type Map = intravisit::ErasedMap<'v>;\n-                            fn nested_visit_map(\n-                                &mut self,\n-                            ) -> intravisit::NestedVisitorMap<Self::Map>\n-                            {\n-                                intravisit::NestedVisitorMap::None\n-                            }\n                         }\n                         let mut visitor = Visitor(None, impl_def_id);\n                         for ty in input_tys {"}, {"sha": "e30871e4347c14f99ecacc2f3b11bd9ded5878df", "filename": "compiler/rustc_typeck/src/check/gather_locals.rs", "status": "modified", "additions": 1, "deletions": 7, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fgather_locals.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fgather_locals.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fgather_locals.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -1,6 +1,6 @@\n use crate::check::{FnCtxt, LocalTy, UserType};\n use rustc_hir as hir;\n-use rustc_hir::intravisit::{self, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{self, Visitor};\n use rustc_hir::PatKind;\n use rustc_infer::infer::type_variable::{TypeVariableOrigin, TypeVariableOriginKind};\n use rustc_middle::ty::Ty;\n@@ -98,12 +98,6 @@ impl<'a, 'tcx> GatherLocalsVisitor<'a, 'tcx> {\n }\n \n impl<'a, 'tcx> Visitor<'tcx> for GatherLocalsVisitor<'a, 'tcx> {\n-    type Map = intravisit::ErasedMap<'tcx>;\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n-\n     // Add explicitly-declared locals.\n     fn visit_local(&mut self, local: &'tcx hir::Local<'tcx>) {\n         self.declare(local.into());"}, {"sha": "fb6e11dbfb738499e5175276faabe7f2b6894c87", "filename": "compiler/rustc_typeck/src/check/generator_interior.rs", "status": "modified", "additions": 1, "deletions": 13, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fgenerator_interior.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fgenerator_interior.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fgenerator_interior.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -10,7 +10,7 @@ use rustc_hir as hir;\n use rustc_hir::def::{CtorKind, DefKind, Res};\n use rustc_hir::def_id::DefId;\n use rustc_hir::hir_id::HirIdSet;\n-use rustc_hir::intravisit::{self, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{self, Visitor};\n use rustc_hir::{Arm, Expr, ExprKind, Guard, HirId, Pat, PatKind};\n use rustc_middle::middle::region::{self, YieldData};\n use rustc_middle::ty::{self, Ty, TyCtxt};\n@@ -266,12 +266,6 @@ pub fn resolve_interior<'a, 'tcx>(\n // librustc_middle/middle/region.rs since `expr_count` is compared against the results\n // there.\n impl<'a, 'tcx> Visitor<'tcx> for InteriorVisitor<'a, 'tcx> {\n-    type Map = intravisit::ErasedMap<'tcx>;\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n-\n     fn visit_arm(&mut self, arm: &'tcx Arm<'tcx>) {\n         let Arm { guard, pat, body, .. } = arm;\n         self.visit_pat(pat);\n@@ -439,12 +433,6 @@ struct ArmPatCollector<'a> {\n }\n \n impl<'a, 'tcx> Visitor<'tcx> for ArmPatCollector<'a> {\n-    type Map = intravisit::ErasedMap<'tcx>;\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n-\n     fn visit_pat(&mut self, pat: &'tcx Pat<'tcx>) {\n         intravisit::walk_pat(self, pat);\n         if let PatKind::Binding(_, id, ..) = pat.kind {"}, {"sha": "4e50fbf56b2d27bbddfd3e7d7a7bc18f80eec61c", "filename": "compiler/rustc_typeck/src/check/regionck.rs", "status": "modified", "additions": 1, "deletions": 7, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fregionck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fregionck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fregionck.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -80,7 +80,7 @@ use crate::outlives::outlives_bounds::InferCtxtExt as _;\n use rustc_data_structures::stable_set::FxHashSet;\n use rustc_hir as hir;\n use rustc_hir::def_id::LocalDefId;\n-use rustc_hir::intravisit::{self, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{self, Visitor};\n use rustc_hir::PatKind;\n use rustc_infer::infer::outlives::env::OutlivesEnvironment;\n use rustc_infer::infer::{self, InferCtxt, RegionObligation, RegionckMode};\n@@ -406,12 +406,6 @@ impl<'a, 'tcx> Visitor<'tcx> for RegionCtxt<'a, 'tcx> {\n     // hierarchy, and in particular the relationships between free\n     // regions, until regionck, as described in #3238.\n \n-    type Map = intravisit::ErasedMap<'tcx>;\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n-\n     fn visit_fn(\n         &mut self,\n         fk: intravisit::FnKind<'tcx>,"}, {"sha": "becae6c9dc920ad7ee67dcdcf406cebc18326b36", "filename": "compiler/rustc_typeck/src/check/upvar.rs", "status": "modified", "additions": 1, "deletions": 7, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fupvar.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fupvar.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fupvar.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -37,7 +37,7 @@ use rustc_errors::Applicability;\n use rustc_hir as hir;\n use rustc_hir::def_id::DefId;\n use rustc_hir::def_id::LocalDefId;\n-use rustc_hir::intravisit::{self, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{self, Visitor};\n use rustc_infer::infer::UpvarRegion;\n use rustc_middle::hir::place::{Place, PlaceBase, PlaceWithHirId, Projection, ProjectionKind};\n use rustc_middle::mir::FakeReadCause;\n@@ -140,12 +140,6 @@ struct InferBorrowKindVisitor<'a, 'tcx> {\n }\n \n impl<'a, 'tcx> Visitor<'tcx> for InferBorrowKindVisitor<'a, 'tcx> {\n-    type Map = intravisit::ErasedMap<'tcx>;\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n-\n     fn visit_expr(&mut self, expr: &'tcx hir::Expr<'tcx>) {\n         match expr.kind {\n             hir::ExprKind::Closure(cc, _, body_id, _, _) => {"}, {"sha": "606a2d6a24e59fa891f000672feba5abdeb42695", "filename": "compiler/rustc_typeck/src/check/wfcheck.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fwfcheck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fwfcheck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fwfcheck.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -17,7 +17,7 @@ use rustc_infer::infer::outlives::obligations::TypeOutlives;\n use rustc_infer::infer::region_constraints::GenericKind;\n use rustc_infer::infer::{self, RegionckMode};\n use rustc_infer::infer::{InferCtxt, TyCtxtInferExt};\n-use rustc_middle::hir::map as hir_map;\n+use rustc_middle::hir::nested_filter;\n use rustc_middle::ty::subst::{GenericArgKind, InternalSubsts, Subst};\n use rustc_middle::ty::trait_def::TraitSpecializationKind;\n use rustc_middle::ty::{\n@@ -1747,10 +1747,10 @@ impl<'tcx> ParItemLikeVisitor<'tcx> for CheckTypeWellFormedVisitor<'tcx> {\n }\n \n impl<'tcx> Visitor<'tcx> for CheckTypeWellFormedVisitor<'tcx> {\n-    type Map = hir_map::Map<'tcx>;\n+    type NestedFilter = nested_filter::OnlyBodies;\n \n-    fn nested_visit_map(&mut self) -> hir_visit::NestedVisitorMap<Self::Map> {\n-        hir_visit::NestedVisitorMap::OnlyBodies(self.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.tcx.hir()\n     }\n \n     #[instrument(skip(self, i), level = \"debug\")]"}, {"sha": "f50f3c39c8882d8b0af418b8e8ac53c9aceda419", "filename": "compiler/rustc_typeck/src/check/writeback.rs", "status": "modified", "additions": 1, "deletions": 7, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fwriteback.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fwriteback.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fwriteback.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -8,7 +8,7 @@ use rustc_data_structures::stable_map::FxHashMap;\n use rustc_errors::ErrorReported;\n use rustc_hir as hir;\n use rustc_hir::def_id::DefId;\n-use rustc_hir::intravisit::{self, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{self, Visitor};\n use rustc_infer::infer::error_reporting::TypeAnnotationNeeded::E0282;\n use rustc_infer::infer::InferCtxt;\n use rustc_middle::hir::place::Place as HirPlace;\n@@ -253,12 +253,6 @@ impl<'cx, 'tcx> WritebackCx<'cx, 'tcx> {\n // traffic in node-ids or update typeck results in the type context etc.\n \n impl<'cx, 'tcx> Visitor<'tcx> for WritebackCx<'cx, 'tcx> {\n-    type Map = intravisit::ErasedMap<'tcx>;\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n-\n     fn visit_expr(&mut self, e: &'tcx hir::Expr<'tcx>) {\n         self.fix_scalar_builtin_expr(e);\n         self.fix_index_builtin_expr(e);"}, {"sha": "2ed98e20f1d06a667129f51f838243f5a928ab86", "filename": "compiler/rustc_typeck/src/collect.rs", "status": "modified", "additions": 5, "deletions": 28, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_typeck%2Fsrc%2Fcollect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_typeck%2Fsrc%2Fcollect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcollect.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -29,10 +29,10 @@ use rustc_errors::{struct_span_err, Applicability};\n use rustc_hir as hir;\n use rustc_hir::def::{CtorKind, DefKind};\n use rustc_hir::def_id::{DefId, LocalDefId, CRATE_DEF_ID, LOCAL_CRATE};\n-use rustc_hir::intravisit::{self, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{self, Visitor};\n use rustc_hir::weak_lang_items;\n use rustc_hir::{GenericParamKind, HirId, Node};\n-use rustc_middle::hir::map::Map;\n+use rustc_middle::hir::nested_filter;\n use rustc_middle::middle::codegen_fn_attrs::{CodegenFnAttrFlags, CodegenFnAttrs};\n use rustc_middle::mir::mono::Linkage;\n use rustc_middle::ty::query::Providers;\n@@ -115,11 +115,6 @@ pub struct ItemCtxt<'tcx> {\n crate struct PlaceholderHirTyCollector(crate Vec<Span>);\n \n impl<'v> Visitor<'v> for PlaceholderHirTyCollector {\n-    type Map = intravisit::ErasedMap<'v>;\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n     fn visit_ty(&mut self, t: &'v hir::Ty<'v>) {\n         if let hir::TyKind::Infer = t.kind {\n             self.0.push(t.span);\n@@ -253,10 +248,10 @@ fn reject_placeholder_type_signatures_in_item<'tcx>(\n }\n \n impl<'tcx> Visitor<'tcx> for CollectItemTypesVisitor<'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::OnlyBodies;\n \n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::OnlyBodies(self.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.tcx.hir()\n     }\n \n     fn visit_item(&mut self, item: &'tcx hir::Item<'tcx>) {\n@@ -1244,12 +1239,6 @@ fn has_late_bound_regions<'tcx>(tcx: TyCtxt<'tcx>, node: Node<'tcx>) -> Option<S\n     }\n \n     impl<'tcx> Visitor<'tcx> for LateBoundRegionsDetector<'tcx> {\n-        type Map = intravisit::ErasedMap<'tcx>;\n-\n-        fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-            NestedVisitorMap::None\n-        }\n-\n         fn visit_ty(&mut self, ty: &'tcx hir::Ty<'tcx>) {\n             if self.has_late_bound_regions.is_some() {\n                 return;\n@@ -1357,12 +1346,6 @@ struct AnonConstInParamTyDetector {\n }\n \n impl<'v> Visitor<'v> for AnonConstInParamTyDetector {\n-    type Map = intravisit::ErasedMap<'v>;\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n-\n     fn visit_generic_param(&mut self, p: &'v hir::GenericParam<'v>) {\n         if let GenericParamKind::Const { ty, default: _ } = p.kind {\n             let prev = self.in_param_ty;\n@@ -2298,12 +2281,6 @@ fn const_evaluatable_predicates_of<'tcx>(\n     }\n \n     impl<'tcx> intravisit::Visitor<'tcx> for ConstCollector<'tcx> {\n-        type Map = Map<'tcx>;\n-\n-        fn nested_visit_map(&mut self) -> intravisit::NestedVisitorMap<Self::Map> {\n-            intravisit::NestedVisitorMap::None\n-        }\n-\n         fn visit_anon_const(&mut self, c: &'tcx hir::AnonConst) {\n             let def_id = self.tcx.hir().local_def_id(c.hir_id);\n             let ct = ty::Const::from_anon_const(self.tcx, def_id);"}, {"sha": "bc7507bcc500f97793231795c37862b9ef54afb5", "filename": "compiler/rustc_typeck/src/collect/type_of.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_typeck%2Fsrc%2Fcollect%2Ftype_of.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_typeck%2Fsrc%2Fcollect%2Ftype_of.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcollect%2Ftype_of.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -5,7 +5,7 @@ use rustc_hir::def_id::{DefId, LocalDefId};\n use rustc_hir::intravisit;\n use rustc_hir::intravisit::Visitor;\n use rustc_hir::{HirId, Node};\n-use rustc_middle::hir::map::Map;\n+use rustc_middle::hir::nested_filter;\n use rustc_middle::ty::subst::InternalSubsts;\n use rustc_middle::ty::util::IntTypeExt;\n use rustc_middle::ty::{self, DefIdTree, Ty, TyCtxt, TypeFoldable, TypeFolder};\n@@ -599,10 +599,10 @@ fn find_opaque_ty_constraints(tcx: TyCtxt<'_>, def_id: LocalDefId) -> Ty<'_> {\n     }\n \n     impl<'tcx> intravisit::Visitor<'tcx> for ConstraintLocator<'tcx> {\n-        type Map = Map<'tcx>;\n+        type NestedFilter = nested_filter::All;\n \n-        fn nested_visit_map(&mut self) -> intravisit::NestedVisitorMap<Self::Map> {\n-            intravisit::NestedVisitorMap::All(self.tcx.hir())\n+        fn nested_visit_map(&mut self) -> Self::Map {\n+            self.tcx.hir()\n         }\n         fn visit_expr(&mut self, ex: &'tcx Expr<'tcx>) {\n             if let hir::ExprKind::Closure(..) = ex.kind {"}, {"sha": "7d1aedc86008b7b60bfe90703b02a9f75afc3180", "filename": "compiler/rustc_typeck/src/hir_wf_check.rs", "status": "modified", "additions": 1, "deletions": 5, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_typeck%2Fsrc%2Fhir_wf_check.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/compiler%2Frustc_typeck%2Fsrc%2Fhir_wf_check.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fhir_wf_check.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -1,6 +1,6 @@\n use crate::collect::ItemCtxt;\n use rustc_hir as hir;\n-use rustc_hir::intravisit::{self, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{self, Visitor};\n use rustc_hir::HirId;\n use rustc_infer::infer::TyCtxtInferExt;\n use rustc_infer::traits::TraitEngine;\n@@ -64,10 +64,6 @@ fn diagnostic_hir_wf_check<'tcx>(\n     }\n \n     impl<'tcx> Visitor<'tcx> for HirWfCheck<'tcx> {\n-        type Map = intravisit::ErasedMap<'tcx>;\n-        fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-            NestedVisitorMap::None\n-        }\n         fn visit_ty(&mut self, ty: &'tcx hir::Ty<'tcx>) {\n             self.tcx.infer_ctxt().enter(|infcx| {\n                 let mut fulfill = traits::FulfillmentContext::new();"}, {"sha": "c7c049f9914455837758960337cab9381c72a78e", "filename": "src/librustdoc/core.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Flibrustdoc%2Fcore.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Flibrustdoc%2Fcore.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fcore.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -5,10 +5,10 @@ use rustc_errors::json::JsonEmitter;\n use rustc_feature::UnstableFeatures;\n use rustc_hir::def::Res;\n use rustc_hir::def_id::{DefId, LocalDefId};\n-use rustc_hir::intravisit::{self, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{self, Visitor};\n use rustc_hir::{HirId, Path};\n use rustc_interface::interface;\n-use rustc_middle::hir::map::Map;\n+use rustc_middle::hir::nested_filter;\n use rustc_middle::middle::privacy::AccessLevels;\n use rustc_middle::ty::{ParamEnv, Ty, TyCtxt};\n use rustc_resolve as resolve;\n@@ -474,12 +474,12 @@ impl<'tcx> EmitIgnoredResolutionErrors<'tcx> {\n }\n \n impl<'tcx> Visitor<'tcx> for EmitIgnoredResolutionErrors<'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::OnlyBodies;\n \n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n+    fn nested_visit_map(&mut self) -> Self::Map {\n         // We need to recurse into nested closures,\n         // since those will fallback to the parent for type checking.\n-        NestedVisitorMap::OnlyBodies(self.tcx.hir())\n+        self.tcx.hir()\n     }\n \n     fn visit_path(&mut self, path: &'tcx Path<'_>, _id: HirId) {"}, {"sha": "024fe6345d295a694b3f2e8b91ac378c4b41795d", "filename": "src/librustdoc/doctest.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Flibrustdoc%2Fdoctest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Flibrustdoc%2Fdoctest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fdoctest.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -8,6 +8,7 @@ use rustc_hir::intravisit;\n use rustc_hir::{HirId, CRATE_HIR_ID};\n use rustc_interface::interface;\n use rustc_middle::hir::map::Map;\n+use rustc_middle::hir::nested_filter;\n use rustc_middle::ty::TyCtxt;\n use rustc_session::config::{self, CrateType, ErrorOutputType};\n use rustc_session::{lint, DiagnosticOutput, Session};\n@@ -1154,10 +1155,10 @@ impl<'a, 'hir, 'tcx> HirCollector<'a, 'hir, 'tcx> {\n }\n \n impl<'a, 'hir, 'tcx> intravisit::Visitor<'hir> for HirCollector<'a, 'hir, 'tcx> {\n-    type Map = Map<'hir>;\n+    type NestedFilter = nested_filter::All;\n \n-    fn nested_visit_map(&mut self) -> intravisit::NestedVisitorMap<Self::Map> {\n-        intravisit::NestedVisitorMap::All(self.map)\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.map\n     }\n \n     fn visit_item(&mut self, item: &'hir hir::Item<'_>) {"}, {"sha": "221e0113d3a43c448b822ed8c277ca603a42988f", "filename": "src/librustdoc/html/render/span_map.rs", "status": "modified", "additions": 5, "deletions": 4, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Flibrustdoc%2Fhtml%2Frender%2Fspan_map.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Flibrustdoc%2Fhtml%2Frender%2Fspan_map.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fspan_map.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -4,8 +4,9 @@ use crate::html::sources;\n use rustc_data_structures::fx::FxHashMap;\n use rustc_hir::def::{DefKind, Res};\n use rustc_hir::def_id::DefId;\n-use rustc_hir::intravisit::{self, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{self, Visitor};\n use rustc_hir::{ExprKind, GenericParam, GenericParamKind, HirId, Mod, Node};\n+use rustc_middle::hir::nested_filter;\n use rustc_middle::ty::TyCtxt;\n use rustc_span::Span;\n \n@@ -93,10 +94,10 @@ impl<'tcx> SpanMapVisitor<'tcx> {\n }\n \n impl<'tcx> Visitor<'tcx> for SpanMapVisitor<'tcx> {\n-    type Map = rustc_middle::hir::map::Map<'tcx>;\n+    type NestedFilter = nested_filter::All;\n \n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::All(self.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.tcx.hir()\n     }\n \n     fn visit_generic_param(&mut self, p: &'tcx GenericParam<'tcx>) {"}, {"sha": "c509d3f882c78b692a32f2809ec1a3bab96c5e97", "filename": "src/librustdoc/scrape_examples.rs", "status": "modified", "additions": 4, "deletions": 3, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Flibrustdoc%2Fscrape_examples.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Flibrustdoc%2Fscrape_examples.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fscrape_examples.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -14,6 +14,7 @@ use rustc_hir::{\n use rustc_interface::interface;\n use rustc_macros::{Decodable, Encodable};\n use rustc_middle::hir::map::Map;\n+use rustc_middle::hir::nested_filter;\n use rustc_middle::ty::{self, TyCtxt};\n use rustc_serialize::{\n     opaque::{Decoder, FileEncoder},\n@@ -117,10 +118,10 @@ impl<'a, 'tcx> Visitor<'tcx> for FindCalls<'a, 'tcx>\n where\n     'tcx: 'a,\n {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::OnlyBodies;\n \n-    fn nested_visit_map(&mut self) -> intravisit::NestedVisitorMap<Self::Map> {\n-        intravisit::NestedVisitorMap::OnlyBodies(self.map)\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.map\n     }\n \n     fn visit_expr(&mut self, ex: &'tcx hir::Expr<'tcx>) {"}, {"sha": "12c1bddf79d5d23e21913616a6dbefed03611682", "filename": "src/tools/clippy/clippy_lints/src/assign_ops.rs", "status": "modified", "additions": 1, "deletions": 7, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fassign_ops.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fassign_ops.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fassign_ops.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -6,9 +6,8 @@ use clippy_utils::{eq_expr_value, trait_ref_of_method};\n use if_chain::if_chain;\n use rustc_errors::Applicability;\n use rustc_hir as hir;\n-use rustc_hir::intravisit::{walk_expr, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{walk_expr, Visitor};\n use rustc_lint::{LateContext, LateLintPass};\n-use rustc_middle::hir::map::Map;\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n \n declare_clippy_lint! {\n@@ -220,16 +219,11 @@ struct ExprVisitor<'a, 'tcx> {\n }\n \n impl<'a, 'tcx> Visitor<'tcx> for ExprVisitor<'a, 'tcx> {\n-    type Map = Map<'tcx>;\n-\n     fn visit_expr(&mut self, expr: &'tcx hir::Expr<'_>) {\n         if eq_expr_value(self.cx, self.assignee, expr) {\n             self.counter += 1;\n         }\n \n         walk_expr(self, expr);\n     }\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n }"}, {"sha": "b3f9c1b297679f8a8774ba2c54d34cece15f0c87", "filename": "src/tools/clippy/clippy_lints/src/blocks_in_if_conditions.rs", "status": "modified", "additions": 1, "deletions": 7, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fblocks_in_if_conditions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fblocks_in_if_conditions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fblocks_in_if_conditions.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -5,10 +5,9 @@ use clippy_utils::ty::implements_trait;\n use clippy_utils::{differing_macro_contexts, get_parent_expr};\n use if_chain::if_chain;\n use rustc_errors::Applicability;\n-use rustc_hir::intravisit::{walk_expr, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{walk_expr, Visitor};\n use rustc_hir::{BlockCheckMode, Expr, ExprKind};\n use rustc_lint::{LateContext, LateLintPass, LintContext};\n-use rustc_middle::hir::map::Map;\n use rustc_middle::lint::in_external_macro;\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n use rustc_span::sym;\n@@ -55,8 +54,6 @@ struct ExVisitor<'a, 'tcx> {\n }\n \n impl<'a, 'tcx> Visitor<'tcx> for ExVisitor<'a, 'tcx> {\n-    type Map = Map<'tcx>;\n-\n     fn visit_expr(&mut self, expr: &'tcx Expr<'tcx>) {\n         if let ExprKind::Closure(_, _, eid, _, _) = expr.kind {\n             // do not lint if the closure is called using an iterator (see #1141)\n@@ -82,9 +79,6 @@ impl<'a, 'tcx> Visitor<'tcx> for ExVisitor<'a, 'tcx> {\n         }\n         walk_expr(self, expr);\n     }\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n }\n \n const BRACED_EXPR_MESSAGE: &str = \"omit braces around single expression condition\";"}, {"sha": "7ffc8ecd31e5d37348b107bbd7572d7f583a9ced", "filename": "src/tools/clippy/clippy_lints/src/booleans.rs", "status": "modified", "additions": 1, "deletions": 12, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fbooleans.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fbooleans.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fbooleans.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -5,10 +5,9 @@ use clippy_utils::{eq_expr_value, get_trait_def_id, paths};\n use if_chain::if_chain;\n use rustc_ast::ast::LitKind;\n use rustc_errors::Applicability;\n-use rustc_hir::intravisit::{walk_expr, FnKind, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{walk_expr, FnKind, Visitor};\n use rustc_hir::{BinOpKind, Body, Expr, ExprKind, FnDecl, HirId, UnOp};\n use rustc_lint::{LateContext, LateLintPass};\n-use rustc_middle::hir::map::Map;\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n use rustc_span::source_map::Span;\n use rustc_span::sym;\n@@ -452,8 +451,6 @@ impl<'a, 'tcx> NonminimalBoolVisitor<'a, 'tcx> {\n }\n \n impl<'a, 'tcx> Visitor<'tcx> for NonminimalBoolVisitor<'a, 'tcx> {\n-    type Map = Map<'tcx>;\n-\n     fn visit_expr(&mut self, e: &'tcx Expr<'_>) {\n         if !e.span.from_expansion() {\n             match &e.kind {\n@@ -470,9 +467,6 @@ impl<'a, 'tcx> Visitor<'tcx> for NonminimalBoolVisitor<'a, 'tcx> {\n         }\n         walk_expr(self, e);\n     }\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n }\n \n fn implements_ord<'tcx>(cx: &LateContext<'tcx>, expr: &Expr<'_>) -> bool {\n@@ -485,8 +479,6 @@ struct NotSimplificationVisitor<'a, 'tcx> {\n }\n \n impl<'a, 'tcx> Visitor<'tcx> for NotSimplificationVisitor<'a, 'tcx> {\n-    type Map = Map<'tcx>;\n-\n     fn visit_expr(&mut self, expr: &'tcx Expr<'_>) {\n         if let ExprKind::Unary(UnOp::Not, inner) = &expr.kind {\n             if let Some(suggestion) = simplify_not(self.cx, inner) {\n@@ -504,7 +496,4 @@ impl<'a, 'tcx> Visitor<'tcx> for NotSimplificationVisitor<'a, 'tcx> {\n \n         walk_expr(self, expr);\n     }\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n }"}, {"sha": "85f952375491f213556d9f3fa606e8ad17edf044", "filename": "src/tools/clippy/clippy_lints/src/cognitive_complexity.rs", "status": "modified", "additions": 1, "deletions": 7, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fcognitive_complexity.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fcognitive_complexity.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fcognitive_complexity.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -5,10 +5,9 @@ use clippy_utils::source::snippet_opt;\n use clippy_utils::ty::is_type_diagnostic_item;\n use clippy_utils::LimitStack;\n use rustc_ast::ast::Attribute;\n-use rustc_hir::intravisit::{walk_expr, FnKind, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{walk_expr, FnKind, Visitor};\n use rustc_hir::{Body, Expr, ExprKind, FnDecl, HirId};\n use rustc_lint::{LateContext, LateLintPass, LintContext};\n-use rustc_middle::hir::map::Map;\n use rustc_session::{declare_tool_lint, impl_lint_pass};\n use rustc_span::source_map::Span;\n use rustc_span::{sym, BytePos};\n@@ -149,8 +148,6 @@ struct CcHelper {\n }\n \n impl<'tcx> Visitor<'tcx> for CcHelper {\n-    type Map = Map<'tcx>;\n-\n     fn visit_expr(&mut self, e: &'tcx Expr<'_>) {\n         walk_expr(self, e);\n         match e.kind {\n@@ -167,7 +164,4 @@ impl<'tcx> Visitor<'tcx> for CcHelper {\n             _ => {},\n         }\n     }\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n }"}, {"sha": "39456e25ff4eb4353c1408f8df29524659f08f8c", "filename": "src/tools/clippy/clippy_lints/src/copies.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fcopies.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fcopies.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fcopies.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -7,10 +7,10 @@ use clippy_utils::{\n use if_chain::if_chain;\n use rustc_data_structures::fx::FxHashSet;\n use rustc_errors::{Applicability, DiagnosticBuilder};\n-use rustc_hir::intravisit::{self, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{self, Visitor};\n use rustc_hir::{Block, Expr, ExprKind, HirId};\n use rustc_lint::{LateContext, LateLintPass, LintContext};\n-use rustc_middle::hir::map::Map;\n+use rustc_middle::hir::nested_filter;\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n use rustc_span::{source_map::Span, symbol::Symbol, BytePos};\n use std::borrow::Cow;\n@@ -561,10 +561,10 @@ impl<'a, 'tcx> UsedValueFinderVisitor<'a, 'tcx> {\n }\n \n impl<'a, 'tcx> Visitor<'tcx> for UsedValueFinderVisitor<'a, 'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::All;\n \n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::All(self.cx.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.cx.tcx.hir()\n     }\n \n     fn visit_local(&mut self, l: &'tcx rustc_hir::Local<'tcx>) {"}, {"sha": "78acdb5dfd580bd7906c298a28ca05f3bf51e76d", "filename": "src/tools/clippy/clippy_lints/src/default_numeric_fallback.rs", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fdefault_numeric_fallback.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fdefault_numeric_fallback.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fdefault_numeric_fallback.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -5,12 +5,11 @@ use if_chain::if_chain;\n use rustc_ast::ast::{LitFloatType, LitIntType, LitKind};\n use rustc_errors::Applicability;\n use rustc_hir::{\n-    intravisit::{walk_expr, walk_stmt, NestedVisitorMap, Visitor},\n+    intravisit::{walk_expr, walk_stmt, Visitor},\n     Body, Expr, ExprKind, HirId, Lit, Stmt, StmtKind,\n };\n use rustc_lint::{LateContext, LateLintPass, LintContext};\n use rustc_middle::{\n-    hir::map::Map,\n     lint::in_external_macro,\n     ty::{self, FloatTy, IntTy, PolyFnSig, Ty},\n };\n@@ -117,8 +116,6 @@ impl<'a, 'tcx> NumericFallbackVisitor<'a, 'tcx> {\n }\n \n impl<'a, 'tcx> Visitor<'tcx> for NumericFallbackVisitor<'a, 'tcx> {\n-    type Map = Map<'tcx>;\n-\n     #[allow(clippy::too_many_lines)]\n     fn visit_expr(&mut self, expr: &'tcx Expr<'_>) {\n         match &expr.kind {\n@@ -209,10 +206,6 @@ impl<'a, 'tcx> Visitor<'tcx> for NumericFallbackVisitor<'a, 'tcx> {\n         walk_stmt(self, stmt);\n         self.ty_bounds.pop();\n     }\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n }\n \n fn fn_sig_opt<'tcx>(cx: &LateContext<'tcx>, hir_id: HirId) -> Option<PolyFnSig<'tcx>> {"}, {"sha": "6d3df260ca25592a59a43e5d75751200c20f7591", "filename": "src/tools/clippy/clippy_lints/src/derive.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fderive.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fderive.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fderive.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -3,12 +3,12 @@ use clippy_utils::paths;\n use clippy_utils::ty::{implements_trait, is_copy};\n use clippy_utils::{get_trait_def_id, is_automatically_derived, is_lint_allowed, match_def_path};\n use if_chain::if_chain;\n-use rustc_hir::intravisit::{walk_expr, walk_fn, walk_item, FnKind, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{walk_expr, walk_fn, walk_item, FnKind, Visitor};\n use rustc_hir::{\n     BlockCheckMode, BodyId, Expr, ExprKind, FnDecl, HirId, Impl, Item, ItemKind, TraitRef, UnsafeSource, Unsafety,\n };\n use rustc_lint::{LateContext, LateLintPass};\n-use rustc_middle::hir::map::Map;\n+use rustc_middle::hir::nested_filter;\n use rustc_middle::ty::{self, Ty};\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n use rustc_span::source_map::Span;\n@@ -382,7 +382,7 @@ struct UnsafeVisitor<'a, 'tcx> {\n }\n \n impl<'tcx> Visitor<'tcx> for UnsafeVisitor<'_, 'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::All;\n \n     fn visit_fn(&mut self, kind: FnKind<'tcx>, decl: &'tcx FnDecl<'_>, body_id: BodyId, span: Span, id: HirId) {\n         if self.has_unsafe {\n@@ -414,7 +414,7 @@ impl<'tcx> Visitor<'tcx> for UnsafeVisitor<'_, 'tcx> {\n         walk_expr(self, expr);\n     }\n \n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::All(self.cx.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.cx.tcx.hir()\n     }\n }"}, {"sha": "a00361e6062ad4ab1faee890838dd36a9f54328a", "filename": "src/tools/clippy/clippy_lints/src/doc.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fdoc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fdoc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fdoc.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -13,10 +13,10 @@ use rustc_data_structures::sync::Lrc;\n use rustc_errors::emitter::EmitterWriter;\n use rustc_errors::{Applicability, Handler, SuggestionStyle};\n use rustc_hir as hir;\n-use rustc_hir::intravisit::{self, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{self, Visitor};\n use rustc_hir::{AnonConst, Expr};\n use rustc_lint::{LateContext, LateLintPass};\n-use rustc_middle::hir::map::Map;\n+use rustc_middle::hir::nested_filter;\n use rustc_middle::lint::in_external_macro;\n use rustc_middle::ty;\n use rustc_parse::maybe_new_parser_from_source_str;\n@@ -799,7 +799,7 @@ struct FindPanicUnwrap<'a, 'tcx> {\n }\n \n impl<'a, 'tcx> Visitor<'tcx> for FindPanicUnwrap<'a, 'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::OnlyBodies;\n \n     fn visit_expr(&mut self, expr: &'tcx Expr<'_>) {\n         if self.panic_span.is_some() {\n@@ -834,7 +834,7 @@ impl<'a, 'tcx> Visitor<'tcx> for FindPanicUnwrap<'a, 'tcx> {\n     // Panics in const blocks will cause compilation to fail.\n     fn visit_anon_const(&mut self, _: &'tcx AnonConst) {}\n \n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::OnlyBodies(self.cx.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.cx.tcx.hir()\n     }\n }"}, {"sha": "9c0a966b0beef16b68bf8e8ab80d7f566cce5a39", "filename": "src/tools/clippy/clippy_lints/src/entry.rs", "status": "modified", "additions": 1, "deletions": 6, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fentry.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fentry.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fentry.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -10,7 +10,7 @@ use core::fmt::Write;\n use rustc_errors::Applicability;\n use rustc_hir::{\n     hir_id::HirIdSet,\n-    intravisit::{walk_expr, ErasedMap, NestedVisitorMap, Visitor},\n+    intravisit::{walk_expr, Visitor},\n     Block, Expr, ExprKind, Guard, HirId, Pat, Stmt, StmtKind, UnOp,\n };\n use rustc_lint::{LateContext, LateLintPass};\n@@ -370,11 +370,6 @@ impl<'tcx> InsertSearcher<'_, 'tcx> {\n     }\n }\n impl<'tcx> Visitor<'tcx> for InsertSearcher<'_, 'tcx> {\n-    type Map = ErasedMap<'tcx>;\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n-\n     fn visit_stmt(&mut self, stmt: &'tcx Stmt<'_>) {\n         match stmt.kind {\n             StmtKind::Semi(e) => {"}, {"sha": "65599a0587d449ab2150abdb280442d808e6a48c", "filename": "src/tools/clippy/clippy_lints/src/eval_order_dependence.rs", "status": "modified", "additions": 1, "deletions": 12, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Feval_order_dependence.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Feval_order_dependence.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Feval_order_dependence.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -1,10 +1,9 @@\n use clippy_utils::diagnostics::{span_lint, span_lint_and_note};\n use clippy_utils::{get_parent_expr, path_to_local, path_to_local_id};\n use if_chain::if_chain;\n-use rustc_hir::intravisit::{walk_expr, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{walk_expr, Visitor};\n use rustc_hir::{BinOpKind, Block, Expr, ExprKind, Guard, HirId, Local, Node, Stmt, StmtKind};\n use rustc_lint::{LateContext, LateLintPass};\n-use rustc_middle::hir::map::Map;\n use rustc_middle::ty;\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n \n@@ -133,8 +132,6 @@ impl<'a, 'tcx> DivergenceVisitor<'a, 'tcx> {\n }\n \n impl<'a, 'tcx> Visitor<'tcx> for DivergenceVisitor<'a, 'tcx> {\n-    type Map = Map<'tcx>;\n-\n     fn visit_expr(&mut self, e: &'tcx Expr<'_>) {\n         match e.kind {\n             ExprKind::Continue(_) | ExprKind::Break(_, _) | ExprKind::Ret(_) => self.report_diverging_sub_expr(e),\n@@ -167,9 +164,6 @@ impl<'a, 'tcx> Visitor<'tcx> for DivergenceVisitor<'a, 'tcx> {\n     fn visit_block(&mut self, _: &'tcx Block<'_>) {\n         // don't continue over blocks, LateLintPass already does that\n     }\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n }\n \n /// Walks up the AST from the given write expression (`vis.write_expr`) looking\n@@ -299,8 +293,6 @@ struct ReadVisitor<'a, 'tcx> {\n }\n \n impl<'a, 'tcx> Visitor<'tcx> for ReadVisitor<'a, 'tcx> {\n-    type Map = Map<'tcx>;\n-\n     fn visit_expr(&mut self, expr: &'tcx Expr<'_>) {\n         if expr.hir_id == self.last_expr.hir_id {\n             return;\n@@ -343,9 +335,6 @@ impl<'a, 'tcx> Visitor<'tcx> for ReadVisitor<'a, 'tcx> {\n \n         walk_expr(self, expr);\n     }\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n }\n \n /// Returns `true` if `expr` is the LHS of an assignment, like `expr = ...`."}, {"sha": "574678b5542111d4c3132b825139c56356254e25", "filename": "src/tools/clippy/clippy_lints/src/fallible_impl_from.rs", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Ffallible_impl_from.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Ffallible_impl_from.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Ffallible_impl_from.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -5,7 +5,6 @@ use clippy_utils::ty::is_type_diagnostic_item;\n use if_chain::if_chain;\n use rustc_hir as hir;\n use rustc_lint::{LateContext, LateLintPass};\n-use rustc_middle::hir::map::Map;\n use rustc_middle::ty;\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n use rustc_span::{sym, Span};\n@@ -68,7 +67,7 @@ impl<'tcx> LateLintPass<'tcx> for FallibleImplFrom {\n }\n \n fn lint_impl_body<'tcx>(cx: &LateContext<'tcx>, impl_span: Span, impl_items: &[hir::ImplItemRef]) {\n-    use rustc_hir::intravisit::{self, NestedVisitorMap, Visitor};\n+    use rustc_hir::intravisit::{self, Visitor};\n     use rustc_hir::{Expr, ImplItemKind};\n \n     struct FindPanicUnwrap<'a, 'tcx> {\n@@ -78,8 +77,6 @@ fn lint_impl_body<'tcx>(cx: &LateContext<'tcx>, impl_span: Span, impl_items: &[h\n     }\n \n     impl<'a, 'tcx> Visitor<'tcx> for FindPanicUnwrap<'a, 'tcx> {\n-        type Map = Map<'tcx>;\n-\n         fn visit_expr(&mut self, expr: &'tcx Expr<'_>) {\n             if let Some(macro_call) = root_macro_call_first_node(self.lcx, expr) {\n                 if is_panic(self.lcx, macro_call.def_id) {\n@@ -100,10 +97,6 @@ fn lint_impl_body<'tcx>(cx: &LateContext<'tcx>, impl_span: Span, impl_items: &[h\n             // and check sub-expressions\n             intravisit::walk_expr(self, expr);\n         }\n-\n-        fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-            NestedVisitorMap::None\n-        }\n     }\n \n     for impl_item in impl_items {"}, {"sha": "2610f0ff384eb25575cc75e52ec6f729fb2018f1", "filename": "src/tools/clippy/clippy_lints/src/functions/must_use.rs", "status": "modified", "additions": 0, "deletions": 7, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Ffunctions%2Fmust_use.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Ffunctions%2Fmust_use.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Ffunctions%2Fmust_use.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -4,7 +4,6 @@ use rustc_hir::def_id::{DefIdSet, LocalDefId};\n use rustc_hir::{self as hir, def::Res, intravisit, QPath};\n use rustc_lint::{LateContext, LintContext};\n use rustc_middle::{\n-    hir::map::Map,\n     lint::in_external_macro,\n     ty::{self, Ty},\n };\n@@ -211,8 +210,6 @@ struct StaticMutVisitor<'a, 'tcx> {\n }\n \n impl<'a, 'tcx> intravisit::Visitor<'tcx> for StaticMutVisitor<'a, 'tcx> {\n-    type Map = Map<'tcx>;\n-\n     fn visit_expr(&mut self, expr: &'tcx hir::Expr<'_>) {\n         use hir::ExprKind::{AddrOf, Assign, AssignOp, Call, MethodCall};\n \n@@ -244,10 +241,6 @@ impl<'a, 'tcx> intravisit::Visitor<'tcx> for StaticMutVisitor<'a, 'tcx> {\n             _ => {},\n         }\n     }\n-\n-    fn nested_visit_map(&mut self) -> intravisit::NestedVisitorMap<Self::Map> {\n-        intravisit::NestedVisitorMap::None\n-    }\n }\n \n fn is_mutated_static(e: &hir::Expr<'_>) -> bool {"}, {"sha": "8902ee14572f5b67a1888c09ef828f2c3679054f", "filename": "src/tools/clippy/clippy_lints/src/functions/not_unsafe_ptr_arg_deref.rs", "status": "modified", "additions": 1, "deletions": 7, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Ffunctions%2Fnot_unsafe_ptr_arg_deref.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Ffunctions%2Fnot_unsafe_ptr_arg_deref.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Ffunctions%2Fnot_unsafe_ptr_arg_deref.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -1,6 +1,6 @@\n use rustc_hir::{self as hir, intravisit, HirIdSet};\n use rustc_lint::LateContext;\n-use rustc_middle::{hir::map::Map, ty};\n+use rustc_middle::ty;\n use rustc_span::def_id::LocalDefId;\n \n use clippy_utils::diagnostics::span_lint;\n@@ -74,8 +74,6 @@ struct DerefVisitor<'a, 'tcx> {\n }\n \n impl<'a, 'tcx> intravisit::Visitor<'tcx> for DerefVisitor<'a, 'tcx> {\n-    type Map = Map<'tcx>;\n-\n     fn visit_expr(&mut self, expr: &'tcx hir::Expr<'_>) {\n         match expr.kind {\n             hir::ExprKind::Call(f, args) => {\n@@ -103,10 +101,6 @@ impl<'a, 'tcx> intravisit::Visitor<'tcx> for DerefVisitor<'a, 'tcx> {\n \n         intravisit::walk_expr(self, expr);\n     }\n-\n-    fn nested_visit_map(&mut self) -> intravisit::NestedVisitorMap<Self::Map> {\n-        intravisit::NestedVisitorMap::None\n-    }\n }\n \n impl<'a, 'tcx> DerefVisitor<'a, 'tcx> {"}, {"sha": "0cc697d8425517495e2aac59b7e0cb7f28a59759", "filename": "src/tools/clippy/clippy_lints/src/if_let_mutex.rs", "status": "modified", "additions": 1, "deletions": 14, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fif_let_mutex.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fif_let_mutex.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fif_let_mutex.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -3,10 +3,9 @@ use clippy_utils::higher;\n use clippy_utils::ty::is_type_diagnostic_item;\n use clippy_utils::SpanlessEq;\n use if_chain::if_chain;\n-use rustc_hir::intravisit::{self as visit, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{self as visit, Visitor};\n use rustc_hir::{Expr, ExprKind};\n use rustc_lint::{LateContext, LateLintPass};\n-use rustc_middle::hir::map::Map;\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n use rustc_span::sym;\n \n@@ -91,8 +90,6 @@ pub struct OppVisitor<'a, 'tcx> {\n }\n \n impl<'tcx> Visitor<'tcx> for OppVisitor<'_, 'tcx> {\n-    type Map = Map<'tcx>;\n-\n     fn visit_expr(&mut self, expr: &'tcx Expr<'_>) {\n         if let Some(mutex) = is_mutex_lock_call(self.cx, expr) {\n             self.found_mutex = Some(mutex);\n@@ -101,10 +98,6 @@ impl<'tcx> Visitor<'tcx> for OppVisitor<'_, 'tcx> {\n         }\n         visit::walk_expr(self, expr);\n     }\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n }\n \n /// Checks if `Mutex::lock` is called in any of the branches.\n@@ -115,8 +108,6 @@ pub struct ArmVisitor<'a, 'tcx> {\n }\n \n impl<'tcx> Visitor<'tcx> for ArmVisitor<'_, 'tcx> {\n-    type Map = Map<'tcx>;\n-\n     fn visit_expr(&mut self, expr: &'tcx Expr<'tcx>) {\n         if let Some(mutex) = is_mutex_lock_call(self.cx, expr) {\n             self.found_mutex = Some(mutex);\n@@ -125,10 +116,6 @@ impl<'tcx> Visitor<'tcx> for ArmVisitor<'_, 'tcx> {\n         }\n         visit::walk_expr(self, expr);\n     }\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n }\n \n impl<'tcx, 'l> ArmVisitor<'tcx, 'l> {"}, {"sha": "104de0ff62f8a2e0d0101a601d34fc458c72de1c", "filename": "src/tools/clippy/clippy_lints/src/implicit_hasher.rs", "status": "modified", "additions": 5, "deletions": 11, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fimplicit_hasher.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fimplicit_hasher.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fimplicit_hasher.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -3,10 +3,10 @@ use std::collections::BTreeMap;\n \n use rustc_errors::DiagnosticBuilder;\n use rustc_hir as hir;\n-use rustc_hir::intravisit::{walk_body, walk_expr, walk_inf, walk_ty, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{walk_body, walk_expr, walk_inf, walk_ty, Visitor};\n use rustc_hir::{Body, Expr, ExprKind, GenericArg, Item, ItemKind, QPath, TyKind};\n use rustc_lint::{LateContext, LateLintPass, LintContext};\n-use rustc_middle::hir::map::Map;\n+use rustc_middle::hir::nested_filter;\n use rustc_middle::lint::in_external_macro;\n use rustc_middle::ty::{Ty, TyS, TypeckResults};\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n@@ -294,8 +294,6 @@ impl<'a, 'tcx> ImplicitHasherTypeVisitor<'a, 'tcx> {\n }\n \n impl<'a, 'tcx> Visitor<'tcx> for ImplicitHasherTypeVisitor<'a, 'tcx> {\n-    type Map = Map<'tcx>;\n-\n     fn visit_ty(&mut self, t: &'tcx hir::Ty<'_>) {\n         if let Some(target) = ImplicitHasherType::new(self.cx, t) {\n             self.found.push(target);\n@@ -311,10 +309,6 @@ impl<'a, 'tcx> Visitor<'tcx> for ImplicitHasherTypeVisitor<'a, 'tcx> {\n \n         walk_inf(self, inf);\n     }\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n }\n \n /// Looks for default-hasher-dependent constructors like `HashMap::new`.\n@@ -337,7 +331,7 @@ impl<'a, 'b, 'tcx> ImplicitHasherConstructorVisitor<'a, 'b, 'tcx> {\n }\n \n impl<'a, 'b, 'tcx> Visitor<'tcx> for ImplicitHasherConstructorVisitor<'a, 'b, 'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::OnlyBodies;\n \n     fn visit_body(&mut self, body: &'tcx Body<'_>) {\n         let old_maybe_typeck_results = self.maybe_typeck_results.replace(self.cx.tcx.typeck_body(body.id()));\n@@ -389,7 +383,7 @@ impl<'a, 'b, 'tcx> Visitor<'tcx> for ImplicitHasherConstructorVisitor<'a, 'b, 't\n         walk_expr(self, e);\n     }\n \n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::OnlyBodies(self.cx.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.cx.tcx.hir()\n     }\n }"}, {"sha": "4615122bbf9e51cef7b6c3087b2e9a1eefabc945", "filename": "src/tools/clippy/clippy_lints/src/index_refutable_slice.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Findex_refutable_slice.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Findex_refutable_slice.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Findex_refutable_slice.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -7,9 +7,9 @@ use if_chain::if_chain;\n use rustc_data_structures::fx::{FxHashMap, FxHashSet};\n use rustc_errors::Applicability;\n use rustc_hir as hir;\n-use rustc_hir::intravisit::{self, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{self, Visitor};\n use rustc_lint::{LateContext, LateLintPass, LintContext};\n-use rustc_middle::hir::map::Map;\n+use rustc_middle::hir::nested_filter;\n use rustc_middle::ty;\n use rustc_semver::RustcVersion;\n use rustc_session::{declare_tool_lint, impl_lint_pass};\n@@ -230,10 +230,10 @@ struct SliceIndexLintingVisitor<'a, 'tcx> {\n }\n \n impl<'a, 'tcx> Visitor<'tcx> for SliceIndexLintingVisitor<'a, 'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::OnlyBodies;\n \n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::OnlyBodies(self.cx.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.cx.tcx.hir()\n     }\n \n     fn visit_expr(&mut self, expr: &'tcx hir::Expr<'tcx>) {"}, {"sha": "565057140454d4af4e3de567c216092365b45408", "filename": "src/tools/clippy/clippy_lints/src/lifetimes.rs", "status": "modified", "additions": 1, "deletions": 19, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Flifetimes.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Flifetimes.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Flifetimes.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -2,8 +2,7 @@ use clippy_utils::diagnostics::span_lint;\n use clippy_utils::trait_ref_of_method;\n use rustc_data_structures::fx::{FxHashMap, FxHashSet};\n use rustc_hir::intravisit::{\n-    walk_fn_decl, walk_generic_param, walk_generics, walk_item, walk_param_bound, walk_poly_trait_ref, walk_ty,\n-    NestedVisitorMap, Visitor,\n+    walk_fn_decl, walk_generic_param, walk_generics, walk_item, walk_param_bound, walk_poly_trait_ref, walk_ty, Visitor,\n };\n use rustc_hir::FnRetTy::Return;\n use rustc_hir::{\n@@ -12,7 +11,6 @@ use rustc_hir::{\n     TraitFn, TraitItem, TraitItemKind, Ty, TyKind, WhereClause, WherePredicate,\n };\n use rustc_lint::{LateContext, LateLintPass};\n-use rustc_middle::hir::map::Map;\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n use rustc_span::source_map::Span;\n use rustc_span::symbol::{kw, Symbol};\n@@ -354,8 +352,6 @@ impl<'a, 'tcx> RefVisitor<'a, 'tcx> {\n }\n \n impl<'a, 'tcx> Visitor<'tcx> for RefVisitor<'a, 'tcx> {\n-    type Map = Map<'tcx>;\n-\n     // for lifetimes as parameters of generics\n     fn visit_lifetime(&mut self, lifetime: &'tcx Lifetime) {\n         self.record(&Some(*lifetime));\n@@ -409,9 +405,6 @@ impl<'a, 'tcx> Visitor<'tcx> for RefVisitor<'a, 'tcx> {\n         }\n         walk_ty(self, ty);\n     }\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n }\n \n /// Are any lifetimes mentioned in the `where` clause? If so, we don't try to\n@@ -457,8 +450,6 @@ struct LifetimeChecker {\n }\n \n impl<'tcx> Visitor<'tcx> for LifetimeChecker {\n-    type Map = Map<'tcx>;\n-\n     // for lifetimes as parameters of generics\n     fn visit_lifetime(&mut self, lifetime: &'tcx Lifetime) {\n         self.map.remove(&lifetime.name.ident().name);\n@@ -474,9 +465,6 @@ impl<'tcx> Visitor<'tcx> for LifetimeChecker {\n             walk_generic_param(self, param);\n         }\n     }\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n }\n \n fn report_extra_lifetimes<'tcx>(cx: &LateContext<'tcx>, func: &'tcx FnDecl<'_>, generics: &'tcx Generics<'_>) {\n@@ -508,16 +496,10 @@ struct BodyLifetimeChecker {\n }\n \n impl<'tcx> Visitor<'tcx> for BodyLifetimeChecker {\n-    type Map = Map<'tcx>;\n-\n     // for lifetimes as parameters of generics\n     fn visit_lifetime(&mut self, lifetime: &'tcx Lifetime) {\n         if lifetime.name.ident().name != kw::Empty && lifetime.name.ident().name != kw::StaticLifetime {\n             self.lifetimes_used_in_body = true;\n         }\n     }\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n }"}, {"sha": "9d8679d77c6d02590737d25a19de817cb6e6f679", "filename": "src/tools/clippy/clippy_lints/src/loops/mut_range_bound.rs", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Floops%2Fmut_range_bound.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Floops%2Fmut_range_bound.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Floops%2Fmut_range_bound.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -2,11 +2,10 @@ use super::MUT_RANGE_BOUND;\n use clippy_utils::diagnostics::span_lint_and_note;\n use clippy_utils::{get_enclosing_block, higher, path_to_local};\n use if_chain::if_chain;\n-use rustc_hir::intravisit::{self, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{self, Visitor};\n use rustc_hir::{BindingAnnotation, Expr, ExprKind, HirId, Node, PatKind};\n use rustc_infer::infer::TyCtxtInferExt;\n use rustc_lint::LateContext;\n-use rustc_middle::hir::map::Map;\n use rustc_middle::{mir::FakeReadCause, ty};\n use rustc_span::source_map::Span;\n use rustc_typeck::expr_use_visitor::{Delegate, ExprUseVisitor, PlaceBase, PlaceWithHirId};\n@@ -148,12 +147,6 @@ impl BreakAfterExprVisitor {\n }\n \n impl<'tcx> intravisit::Visitor<'tcx> for BreakAfterExprVisitor {\n-    type Map = Map<'tcx>;\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n-\n     fn visit_expr(&mut self, expr: &'tcx Expr<'tcx>) {\n         if self.past_candidate {\n             return;"}, {"sha": "f7d3227af01745a0ae532005ef8cf771cf98a960", "filename": "src/tools/clippy/clippy_lints/src/loops/needless_collect.rs", "status": "modified", "additions": 5, "deletions": 10, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Floops%2Fneedless_collect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Floops%2Fneedless_collect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Floops%2Fneedless_collect.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -7,10 +7,10 @@ use clippy_utils::{can_move_expr_to_closure, is_trait_method, path_to_local, pat\n use if_chain::if_chain;\n use rustc_data_structures::fx::FxHashMap;\n use rustc_errors::Applicability;\n-use rustc_hir::intravisit::{walk_block, walk_expr, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{walk_block, walk_expr, Visitor};\n use rustc_hir::{Block, Expr, ExprKind, HirId, HirIdSet, Local, Mutability, Node, PatKind, Stmt, StmtKind};\n use rustc_lint::LateContext;\n-use rustc_middle::hir::map::Map;\n+use rustc_middle::hir::nested_filter;\n use rustc_middle::ty::subst::GenericArgKind;\n use rustc_middle::ty::{self, TyS};\n use rustc_span::sym;\n@@ -262,11 +262,6 @@ impl<'tcx> Visitor<'tcx> for IterFunctionVisitor<'_, 'tcx> {\n             walk_expr(self, expr);\n         }\n     }\n-\n-    type Map = Map<'tcx>;\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n }\n \n impl<'tcx> IterFunctionVisitor<'_, 'tcx> {\n@@ -298,7 +293,7 @@ struct UsedCountVisitor<'a, 'tcx> {\n }\n \n impl<'a, 'tcx> Visitor<'tcx> for UsedCountVisitor<'a, 'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::OnlyBodies;\n \n     fn visit_expr(&mut self, expr: &'tcx Expr<'_>) {\n         if path_to_local_id(expr, self.id) {\n@@ -308,8 +303,8 @@ impl<'a, 'tcx> Visitor<'tcx> for UsedCountVisitor<'a, 'tcx> {\n         }\n     }\n \n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::OnlyBodies(self.cx.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.cx.tcx.hir()\n     }\n }\n "}, {"sha": "22da21bc6bc40597f815c86f6f29822052bb39db", "filename": "src/tools/clippy/clippy_lints/src/loops/needless_range_loop.rs", "status": "modified", "additions": 1, "deletions": 7, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Floops%2Fneedless_range_loop.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Floops%2Fneedless_range_loop.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Floops%2Fneedless_range_loop.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -8,10 +8,9 @@ use if_chain::if_chain;\n use rustc_ast::ast;\n use rustc_data_structures::fx::{FxHashMap, FxHashSet};\n use rustc_hir::def::{DefKind, Res};\n-use rustc_hir::intravisit::{walk_expr, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{walk_expr, Visitor};\n use rustc_hir::{BinOpKind, BorrowKind, Expr, ExprKind, HirId, Mutability, Pat, PatKind, QPath};\n use rustc_lint::LateContext;\n-use rustc_middle::hir::map::Map;\n use rustc_middle::middle::region;\n use rustc_middle::ty::{self, Ty};\n use rustc_span::symbol::{sym, Symbol};\n@@ -294,8 +293,6 @@ impl<'a, 'tcx> VarVisitor<'a, 'tcx> {\n }\n \n impl<'a, 'tcx> Visitor<'tcx> for VarVisitor<'a, 'tcx> {\n-    type Map = Map<'tcx>;\n-\n     fn visit_expr(&mut self, expr: &'tcx Expr<'_>) {\n         if_chain! {\n             // a range index op\n@@ -374,7 +371,4 @@ impl<'a, 'tcx> Visitor<'tcx> for VarVisitor<'a, 'tcx> {\n         }\n         self.prefer_mutable = old;\n     }\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n }"}, {"sha": "c61b411708c2a932be82b960d21c0146d0d88c37", "filename": "src/tools/clippy/clippy_lints/src/loops/same_item_push.rs", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Floops%2Fsame_item_push.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Floops%2Fsame_item_push.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Floops%2Fsame_item_push.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -6,10 +6,9 @@ use clippy_utils::ty::{implements_trait, is_type_diagnostic_item};\n use if_chain::if_chain;\n use rustc_data_structures::fx::FxHashSet;\n use rustc_hir::def::{DefKind, Res};\n-use rustc_hir::intravisit::{walk_expr, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{walk_expr, Visitor};\n use rustc_hir::{BindingAnnotation, Block, Expr, ExprKind, HirId, Node, Pat, PatKind, Stmt, StmtKind};\n use rustc_lint::LateContext;\n-use rustc_middle::hir::map::Map;\n use rustc_span::symbol::sym;\n use std::iter::Iterator;\n \n@@ -134,8 +133,6 @@ impl<'a, 'tcx> SameItemPushVisitor<'a, 'tcx> {\n }\n \n impl<'a, 'tcx> Visitor<'tcx> for SameItemPushVisitor<'a, 'tcx> {\n-    type Map = Map<'tcx>;\n-\n     fn visit_expr(&mut self, expr: &'tcx Expr<'_>) {\n         match &expr.kind {\n             // Non-determinism may occur ... don't give a lint\n@@ -175,10 +172,6 @@ impl<'a, 'tcx> Visitor<'tcx> for SameItemPushVisitor<'a, 'tcx> {\n             }\n         }\n     }\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n }\n \n // Given some statement, determine if that statement is a push on a Vec. If it is, return"}, {"sha": "eac0f03b142a821c56ade84d17f2ea5fe8264f04", "filename": "src/tools/clippy/clippy_lints/src/loops/utils.rs", "status": "modified", "additions": 5, "deletions": 16, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Floops%2Futils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Floops%2Futils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Floops%2Futils.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -3,10 +3,10 @@ use clippy_utils::{get_parent_expr, is_integer_const, path_to_local, path_to_loc\n use if_chain::if_chain;\n use rustc_ast::ast::{LitIntType, LitKind};\n use rustc_errors::Applicability;\n-use rustc_hir::intravisit::{walk_expr, walk_local, walk_pat, walk_stmt, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{walk_expr, walk_local, walk_pat, walk_stmt, Visitor};\n use rustc_hir::{BinOpKind, BorrowKind, Expr, ExprKind, HirId, HirIdMap, Local, Mutability, Pat, PatKind, Stmt};\n use rustc_lint::LateContext;\n-use rustc_middle::hir::map::Map;\n+use rustc_middle::hir::nested_filter;\n use rustc_middle::ty::Ty;\n use rustc_span::source_map::Spanned;\n use rustc_span::symbol::{sym, Symbol};\n@@ -50,8 +50,6 @@ impl<'a, 'tcx> IncrementVisitor<'a, 'tcx> {\n }\n \n impl<'a, 'tcx> Visitor<'tcx> for IncrementVisitor<'a, 'tcx> {\n-    type Map = Map<'tcx>;\n-\n     fn visit_expr(&mut self, expr: &'tcx Expr<'_>) {\n         if self.done {\n             return;\n@@ -102,9 +100,6 @@ impl<'a, 'tcx> Visitor<'tcx> for IncrementVisitor<'a, 'tcx> {\n             walk_expr(self, expr);\n         }\n     }\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n }\n \n enum InitializeVisitorState<'hir> {\n@@ -151,7 +146,7 @@ impl<'a, 'tcx> InitializeVisitor<'a, 'tcx> {\n }\n \n impl<'a, 'tcx> Visitor<'tcx> for InitializeVisitor<'a, 'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::OnlyBodies;\n \n     fn visit_local(&mut self, l: &'tcx Local<'_>) {\n         // Look for declarations of the variable\n@@ -254,8 +249,8 @@ impl<'a, 'tcx> Visitor<'tcx> for InitializeVisitor<'a, 'tcx> {\n         }\n     }\n \n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::OnlyBodies(self.cx.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.cx.tcx.hir()\n     }\n }\n \n@@ -283,8 +278,6 @@ pub(super) struct LoopNestVisitor {\n }\n \n impl<'tcx> Visitor<'tcx> for LoopNestVisitor {\n-    type Map = Map<'tcx>;\n-\n     fn visit_stmt(&mut self, stmt: &'tcx Stmt<'_>) {\n         if stmt.hir_id == self.hir_id {\n             self.nesting = LookFurther;\n@@ -323,10 +316,6 @@ impl<'tcx> Visitor<'tcx> for LoopNestVisitor {\n         }\n         walk_pat(self, pat);\n     }\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n }\n \n /// If `arg` was the argument to a `for` loop, return the \"cleanest\" way of writing the"}, {"sha": "5dcfed65c78ac7829e004564ce8b1957c81d4866", "filename": "src/tools/clippy/clippy_lints/src/loops/while_immutable_condition.rs", "status": "modified", "additions": 1, "deletions": 14, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Floops%2Fwhile_immutable_condition.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Floops%2Fwhile_immutable_condition.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Floops%2Fwhile_immutable_condition.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -5,11 +5,10 @@ use clippy_utils::usage::mutated_variables;\n use if_chain::if_chain;\n use rustc_hir::def::{DefKind, Res};\n use rustc_hir::def_id::DefIdMap;\n-use rustc_hir::intravisit::{walk_expr, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{walk_expr, Visitor};\n use rustc_hir::HirIdSet;\n use rustc_hir::{Expr, ExprKind, QPath};\n use rustc_lint::LateContext;\n-use rustc_middle::hir::map::Map;\n \n pub(super) fn check<'tcx>(cx: &LateContext<'tcx>, cond: &'tcx Expr<'_>, expr: &'tcx Expr<'_>) {\n     if constant(cx, cx.typeck_results(), cond).is_some() {\n@@ -67,8 +66,6 @@ struct HasBreakOrReturnVisitor {\n }\n \n impl<'tcx> Visitor<'tcx> for HasBreakOrReturnVisitor {\n-    type Map = Map<'tcx>;\n-\n     fn visit_expr(&mut self, expr: &'tcx Expr<'_>) {\n         if self.has_break_or_return {\n             return;\n@@ -84,10 +81,6 @@ impl<'tcx> Visitor<'tcx> for HasBreakOrReturnVisitor {\n \n         walk_expr(self, expr);\n     }\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n }\n \n /// Collects the set of variables in an expression\n@@ -123,8 +116,6 @@ impl<'a, 'tcx> VarCollectorVisitor<'a, 'tcx> {\n }\n \n impl<'a, 'tcx> Visitor<'tcx> for VarCollectorVisitor<'a, 'tcx> {\n-    type Map = Map<'tcx>;\n-\n     fn visit_expr(&mut self, ex: &'tcx Expr<'_>) {\n         match ex.kind {\n             ExprKind::Path(_) => self.insert_def_id(ex),\n@@ -134,8 +125,4 @@ impl<'a, 'tcx> Visitor<'tcx> for VarCollectorVisitor<'a, 'tcx> {\n             _ => walk_expr(self, ex),\n         }\n     }\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n }"}, {"sha": "e0b235c355980e444ee8367a422cc32adb497791", "filename": "src/tools/clippy/clippy_lints/src/loops/while_let_on_iterator.rs", "status": "modified", "additions": 1, "deletions": 17, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Floops%2Fwhile_let_on_iterator.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Floops%2Fwhile_let_on_iterator.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Floops%2Fwhile_let_on_iterator.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -7,7 +7,7 @@ use clippy_utils::{\n };\n use if_chain::if_chain;\n use rustc_errors::Applicability;\n-use rustc_hir::intravisit::{walk_expr, ErasedMap, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{walk_expr, Visitor};\n use rustc_hir::{def::Res, Expr, ExprKind, HirId, Local, Mutability, PatKind, QPath, UnOp};\n use rustc_lint::LateContext;\n use rustc_middle::ty::adjustment::Adjust;\n@@ -211,11 +211,6 @@ fn uses_iter<'tcx>(cx: &LateContext<'tcx>, iter_expr: &IterExpr, container: &'tc\n         uses_iter: bool,\n     }\n     impl<'tcx> Visitor<'tcx> for V<'_, '_, 'tcx> {\n-        type Map = ErasedMap<'tcx>;\n-        fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-            NestedVisitorMap::None\n-        }\n-\n         fn visit_expr(&mut self, e: &'tcx Expr<'_>) {\n             if self.uses_iter {\n                 // return\n@@ -254,11 +249,6 @@ fn needs_mutable_borrow(cx: &LateContext<'_>, iter_expr: &IterExpr, loop_expr: &\n         used_iter: bool,\n     }\n     impl<'tcx> Visitor<'tcx> for AfterLoopVisitor<'_, '_, 'tcx> {\n-        type Map = ErasedMap<'tcx>;\n-        fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-            NestedVisitorMap::None\n-        }\n-\n         fn visit_expr(&mut self, e: &'tcx Expr<'_>) {\n             if self.used_iter {\n                 return;\n@@ -293,12 +283,6 @@ fn needs_mutable_borrow(cx: &LateContext<'_>, iter_expr: &IterExpr, loop_expr: &\n         used_after: bool,\n     }\n     impl<'a, 'b, 'tcx> Visitor<'tcx> for NestedLoopVisitor<'a, 'b, 'tcx> {\n-        type Map = ErasedMap<'tcx>;\n-\n-        fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-            NestedVisitorMap::None\n-        }\n-\n         fn visit_local(&mut self, l: &'tcx Local<'_>) {\n             if !self.after_loop {\n                 l.pat.each_binding_or_first(&mut |_, id, _, _| {"}, {"sha": "039cb3aafdb780eca45eaeadd8c71626e6f84ac8", "filename": "src/tools/clippy/clippy_lints/src/manual_strip.rs", "status": "modified", "additions": 1, "deletions": 7, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmanual_strip.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmanual_strip.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmanual_strip.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -6,11 +6,10 @@ use clippy_utils::{eq_expr_value, higher, match_def_path, meets_msrv, msrvs, pat\n use if_chain::if_chain;\n use rustc_ast::ast::LitKind;\n use rustc_hir::def::Res;\n-use rustc_hir::intravisit::{walk_expr, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{walk_expr, Visitor};\n use rustc_hir::BinOpKind;\n use rustc_hir::{BorrowKind, Expr, ExprKind};\n use rustc_lint::{LateContext, LateLintPass, LintContext};\n-use rustc_middle::hir::map::Map;\n use rustc_middle::ty;\n use rustc_semver::RustcVersion;\n use rustc_session::{declare_tool_lint, impl_lint_pass};\n@@ -203,11 +202,6 @@ fn find_stripping<'tcx>(\n     }\n \n     impl<'a, 'tcx> Visitor<'tcx> for StrippingFinder<'a, 'tcx> {\n-        type Map = Map<'tcx>;\n-        fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-            NestedVisitorMap::None\n-        }\n-\n         fn visit_expr(&mut self, ex: &'tcx Expr<'_>) {\n             if_chain! {\n                 if is_ref_str(self.cx, ex);"}, {"sha": "b0eebf35e274df6694fef2524b96aaafcf0f90a1", "filename": "src/tools/clippy/clippy_lints/src/match_str_case_mismatch.rs", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmatch_str_case_mismatch.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmatch_str_case_mismatch.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmatch_str_case_mismatch.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -2,10 +2,9 @@ use clippy_utils::diagnostics::span_lint_and_sugg;\n use clippy_utils::ty::is_type_diagnostic_item;\n use rustc_ast::ast::LitKind;\n use rustc_errors::Applicability;\n-use rustc_hir::intravisit::{walk_expr, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{walk_expr, Visitor};\n use rustc_hir::{Arm, Expr, ExprKind, MatchSource, PatKind};\n use rustc_lint::{LateContext, LateLintPass};\n-use rustc_middle::hir::map::Map;\n use rustc_middle::lint::in_external_macro;\n use rustc_middle::ty;\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n@@ -86,12 +85,6 @@ struct MatchExprVisitor<'a, 'tcx> {\n }\n \n impl<'a, 'tcx> Visitor<'tcx> for MatchExprVisitor<'a, 'tcx> {\n-    type Map = Map<'tcx>;\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n-\n     fn visit_expr(&mut self, ex: &'tcx Expr<'_>) {\n         match ex.kind {\n             ExprKind::MethodCall(segment, _, [receiver], _) if self.case_altered(segment.ident.as_str(), receiver) => {"}, {"sha": "33d022c73a5e7c007aa286918e8a78e6db392321", "filename": "src/tools/clippy/clippy_lints/src/matches.rs", "status": "modified", "additions": 1, "deletions": 6, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmatches.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmatches.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmatches.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -1776,7 +1776,7 @@ mod redundant_pattern_match {\n     use rustc_errors::Applicability;\n     use rustc_hir::LangItem::{OptionNone, OptionSome, PollPending, PollReady, ResultErr, ResultOk};\n     use rustc_hir::{\n-        intravisit::{walk_expr, ErasedMap, NestedVisitorMap, Visitor},\n+        intravisit::{walk_expr, Visitor},\n         Arm, Block, Expr, ExprKind, LangItem, MatchSource, Node, Pat, PatKind, QPath, UnOp,\n     };\n     use rustc_lint::LateContext;\n@@ -1880,11 +1880,6 @@ mod redundant_pattern_match {\n             res: bool,\n         }\n         impl<'a, 'tcx> Visitor<'tcx> for V<'a, 'tcx> {\n-            type Map = ErasedMap<'tcx>;\n-            fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-                NestedVisitorMap::None\n-            }\n-\n             fn visit_expr(&mut self, expr: &'tcx Expr<'tcx>) {\n                 match expr.kind {\n                     // Taking the reference of a value leaves a temporary"}, {"sha": "9c6f421103185c7f02437bc63372256642fa3111", "filename": "src/tools/clippy/clippy_lints/src/methods/option_map_unwrap_or.rs", "status": "modified", "additions": 8, "deletions": 8, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Foption_map_unwrap_or.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Foption_map_unwrap_or.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Foption_map_unwrap_or.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -5,10 +5,10 @@ use clippy_utils::ty::is_copy;\n use clippy_utils::ty::is_type_diagnostic_item;\n use rustc_data_structures::fx::FxHashSet;\n use rustc_errors::Applicability;\n-use rustc_hir::intravisit::{walk_path, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{walk_path, Visitor};\n use rustc_hir::{self, HirId, Path};\n use rustc_lint::LateContext;\n-use rustc_middle::hir::map::Map;\n+use rustc_middle::hir::nested_filter;\n use rustc_span::source_map::Span;\n use rustc_span::{sym, Symbol};\n \n@@ -97,15 +97,15 @@ struct UnwrapVisitor<'a, 'tcx> {\n }\n \n impl<'a, 'tcx> Visitor<'tcx> for UnwrapVisitor<'a, 'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::All;\n \n     fn visit_path(&mut self, path: &'tcx Path<'_>, _id: HirId) {\n         self.identifiers.insert(ident(path));\n         walk_path(self, path);\n     }\n \n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::All(self.cx.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.cx.tcx.hir()\n     }\n }\n \n@@ -116,7 +116,7 @@ struct MapExprVisitor<'a, 'tcx> {\n }\n \n impl<'a, 'tcx> Visitor<'tcx> for MapExprVisitor<'a, 'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::All;\n \n     fn visit_path(&mut self, path: &'tcx Path<'_>, _id: HirId) {\n         if self.identifiers.contains(&ident(path)) {\n@@ -126,8 +126,8 @@ impl<'a, 'tcx> Visitor<'tcx> for MapExprVisitor<'a, 'tcx> {\n         walk_path(self, path);\n     }\n \n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::All(self.cx.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.cx.tcx.hir()\n     }\n }\n "}, {"sha": "784014f0d87433de6b4b373052c7ffe4eb0e1fb3", "filename": "src/tools/clippy/clippy_lints/src/methods/unnecessary_filter_map.rs", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Funnecessary_filter_map.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Funnecessary_filter_map.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Funnecessary_filter_map.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -2,10 +2,9 @@ use clippy_utils::diagnostics::span_lint;\n use clippy_utils::usage::mutated_variables;\n use clippy_utils::{is_lang_ctor, is_trait_method, path_to_local_id};\n use rustc_hir as hir;\n-use rustc_hir::intravisit::{walk_expr, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{walk_expr, Visitor};\n use rustc_hir::LangItem::{OptionNone, OptionSome};\n use rustc_lint::LateContext;\n-use rustc_middle::hir::map::Map;\n use rustc_middle::ty::{self, TyS};\n use rustc_span::sym;\n \n@@ -113,8 +112,6 @@ impl<'a, 'tcx> ReturnVisitor<'a, 'tcx> {\n }\n \n impl<'a, 'tcx> Visitor<'tcx> for ReturnVisitor<'a, 'tcx> {\n-    type Map = Map<'tcx>;\n-\n     fn visit_expr(&mut self, expr: &'tcx hir::Expr<'_>) {\n         if let hir::ExprKind::Ret(Some(expr)) = &expr.kind {\n             let (found_mapping, found_filtering) = check_expression(self.cx, self.arg_id, expr);\n@@ -124,8 +121,4 @@ impl<'a, 'tcx> Visitor<'tcx> for ReturnVisitor<'a, 'tcx> {\n             walk_expr(self, expr);\n         }\n     }\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n }"}, {"sha": "5fee18c5129a90d9cc4ae690aa47c7c33bea30cc", "filename": "src/tools/clippy/clippy_lints/src/methods/unnecessary_iter_cloned.rs", "status": "modified", "additions": 6, "deletions": 5, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Funnecessary_iter_cloned.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Funnecessary_iter_cloned.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmethods%2Funnecessary_iter_cloned.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -4,10 +4,11 @@ use clippy_utils::source::snippet_opt;\n use clippy_utils::ty::{get_associated_type, get_iterator_item_ty, implements_trait};\n use clippy_utils::{fn_def_id, get_parent_expr, path_to_local_id, usage};\n use rustc_errors::Applicability;\n-use rustc_hir::intravisit::{walk_expr, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{walk_expr, Visitor};\n use rustc_hir::{def_id::DefId, BorrowKind, Expr, ExprKind, HirId, LangItem, Mutability, Pat};\n use rustc_lint::LateContext;\n-use rustc_middle::{hir::map::Map, ty};\n+use rustc_middle::hir::nested_filter;\n+use rustc_middle::ty;\n use rustc_span::{sym, Symbol};\n \n use super::UNNECESSARY_TO_OWNED;\n@@ -139,10 +140,10 @@ struct CloneOrCopyVisitor<'cx, 'tcx> {\n }\n \n impl<'cx, 'tcx> Visitor<'tcx> for CloneOrCopyVisitor<'cx, 'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::OnlyBodies;\n \n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::OnlyBodies(self.cx.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.cx.tcx.hir()\n     }\n \n     fn visit_expr(&mut self, expr: &'tcx Expr<'tcx>) {"}, {"sha": "cb16f00047a394b06b147151fd0244f9bde86274", "filename": "src/tools/clippy/clippy_lints/src/mut_mut.rs", "status": "modified", "additions": 0, "deletions": 6, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmut_mut.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmut_mut.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmut_mut.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -3,7 +3,6 @@ use clippy_utils::higher;\n use rustc_hir as hir;\n use rustc_hir::intravisit;\n use rustc_lint::{LateContext, LateLintPass, LintContext};\n-use rustc_middle::hir::map::Map;\n use rustc_middle::lint::in_external_macro;\n use rustc_middle::ty;\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n@@ -47,8 +46,6 @@ pub struct MutVisitor<'a, 'tcx> {\n }\n \n impl<'a, 'tcx> intravisit::Visitor<'tcx> for MutVisitor<'a, 'tcx> {\n-    type Map = Map<'tcx>;\n-\n     fn visit_expr(&mut self, expr: &'tcx hir::Expr<'_>) {\n         if in_external_macro(self.cx.sess(), expr.span) {\n             return;\n@@ -114,7 +111,4 @@ impl<'a, 'tcx> intravisit::Visitor<'tcx> for MutVisitor<'a, 'tcx> {\n \n         intravisit::walk_ty(self, ty);\n     }\n-    fn nested_visit_map(&mut self) -> intravisit::NestedVisitorMap<Self::Map> {\n-        intravisit::NestedVisitorMap::None\n-    }\n }"}, {"sha": "cd1bc20237028dbce9fef4a3c0fa711c7750dd54", "filename": "src/tools/clippy/clippy_lints/src/mutable_debug_assertion.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmutable_debug_assertion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmutable_debug_assertion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fmutable_debug_assertion.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -1,9 +1,9 @@\n use clippy_utils::diagnostics::span_lint;\n use clippy_utils::macros::{find_assert_eq_args, root_macro_call_first_node};\n-use rustc_hir::intravisit::{walk_expr, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{walk_expr, Visitor};\n use rustc_hir::{BorrowKind, Expr, ExprKind, MatchSource, Mutability};\n use rustc_lint::{LateContext, LateLintPass};\n-use rustc_middle::hir::map::Map;\n+use rustc_middle::hir::nested_filter;\n use rustc_middle::ty;\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n use rustc_span::Span;\n@@ -84,7 +84,7 @@ impl<'a, 'tcx> MutArgVisitor<'a, 'tcx> {\n }\n \n impl<'a, 'tcx> Visitor<'tcx> for MutArgVisitor<'a, 'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::OnlyBodies;\n \n     fn visit_expr(&mut self, expr: &'tcx Expr<'_>) {\n         match expr.kind {\n@@ -115,7 +115,7 @@ impl<'a, 'tcx> Visitor<'tcx> for MutArgVisitor<'a, 'tcx> {\n         walk_expr(self, expr);\n     }\n \n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::OnlyBodies(self.cx.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.cx.tcx.hir()\n     }\n }"}, {"sha": "44c4b70524d9371353f42858188077cc4ac9cbad", "filename": "src/tools/clippy/clippy_lints/src/needless_for_each.rs", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fneedless_for_each.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fneedless_for_each.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fneedless_for_each.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -1,10 +1,9 @@\n use rustc_errors::Applicability;\n use rustc_hir::{\n-    intravisit::{walk_expr, NestedVisitorMap, Visitor},\n+    intravisit::{walk_expr, Visitor},\n     Expr, ExprKind, Stmt, StmtKind,\n };\n use rustc_lint::{LateContext, LateLintPass};\n-use rustc_middle::hir::map::Map;\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n use rustc_span::{source_map::Span, sym, Symbol};\n \n@@ -136,8 +135,6 @@ struct RetCollector {\n }\n \n impl<'tcx> Visitor<'tcx> for RetCollector {\n-    type Map = Map<'tcx>;\n-\n     fn visit_expr(&mut self, expr: &Expr<'_>) {\n         match expr.kind {\n             ExprKind::Ret(..) => {\n@@ -160,8 +157,4 @@ impl<'tcx> Visitor<'tcx> for RetCollector {\n \n         walk_expr(self, expr);\n     }\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n }"}, {"sha": "21ac6548b0179cafa486608e4f7153d04e137080", "filename": "src/tools/clippy/clippy_lints/src/non_copy_const.rs", "status": "modified", "additions": 1, "deletions": 4, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fnon_copy_const.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fnon_copy_const.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fnon_copy_const.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -188,10 +188,7 @@ fn is_value_unfrozen_expr<'tcx>(cx: &LateContext<'tcx>, hir_id: HirId, def_id: D\n \n     let result = cx.tcx.const_eval_resolve(\n         cx.param_env,\n-        ty::Unevaluated::new(\n-            ty::WithOptConstParam::unknown(def_id),\n-            substs,\n-        ),\n+        ty::Unevaluated::new(ty::WithOptConstParam::unknown(def_id), substs),\n         None,\n     );\n     is_value_unfrozen_raw(cx, result, ty)"}, {"sha": "3e0e32857f1dad1e0c02b49426f0e485e397982b", "filename": "src/tools/clippy/clippy_lints/src/redundant_clone.rs", "status": "modified", "additions": 1, "deletions": 4, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fredundant_clone.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fredundant_clone.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fredundant_clone.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -624,10 +624,7 @@ impl<'a, 'tcx> mir::visit::Visitor<'tcx> for PossibleBorrowerVisitor<'a, 'tcx> {\n                 .flat_map(HybridBitSet::iter)\n                 .collect();\n \n-            if ContainsRegion\n-                .visit_ty(self.body.local_decls[*dest].ty)\n-                .is_break()\n-            {\n+            if ContainsRegion.visit_ty(self.body.local_decls[*dest].ty).is_break() {\n                 mutable_variables.push(*dest);\n             }\n "}, {"sha": "0c77cf5e77dd28232f97e0e80c5adcb8209eaeb5", "filename": "src/tools/clippy/clippy_lints/src/redundant_closure_call.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fredundant_closure_call.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fredundant_closure_call.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fredundant_closure_call.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -9,7 +9,7 @@ use rustc_hir as hir;\n use rustc_hir::intravisit as hir_visit;\n use rustc_hir::intravisit::Visitor as HirVisitor;\n use rustc_lint::{EarlyContext, EarlyLintPass, LateContext, LateLintPass};\n-use rustc_middle::hir::map::Map;\n+use rustc_middle::hir::nested_filter;\n use rustc_middle::lint::in_external_macro;\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n \n@@ -106,7 +106,7 @@ impl<'tcx> LateLintPass<'tcx> for RedundantClosureCall {\n                 count: usize,\n             }\n             impl<'a, 'tcx> hir_visit::Visitor<'tcx> for ClosureUsageCount<'a, 'tcx> {\n-                type Map = Map<'tcx>;\n+                type NestedFilter = nested_filter::OnlyBodies;\n \n                 fn visit_expr(&mut self, expr: &'tcx hir::Expr<'tcx>) {\n                     if_chain! {\n@@ -121,8 +121,8 @@ impl<'tcx> LateLintPass<'tcx> for RedundantClosureCall {\n                     hir_visit::walk_expr(self, expr);\n                 }\n \n-                fn nested_visit_map(&mut self) -> hir_visit::NestedVisitorMap<Self::Map> {\n-                    hir_visit::NestedVisitorMap::OnlyBodies(self.cx.tcx.hir())\n+                fn nested_visit_map(&mut self) -> Self::Map {\n+                    self.cx.tcx.hir()\n                 }\n             }\n             let mut closure_usage_count = ClosureUsageCount { cx, path, count: 0 };"}, {"sha": "8068fa22d9ccf8eea0fb4801d0d9b3f92193184a", "filename": "src/tools/clippy/clippy_lints/src/returns.rs", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Freturns.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Freturns.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Freturns.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -4,10 +4,9 @@ use clippy_utils::{fn_def_id, path_to_local_id};\n use if_chain::if_chain;\n use rustc_ast::ast::Attribute;\n use rustc_errors::Applicability;\n-use rustc_hir::intravisit::{walk_expr, FnKind, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{walk_expr, FnKind, Visitor};\n use rustc_hir::{Block, Body, Expr, ExprKind, FnDecl, HirId, MatchSource, PatKind, StmtKind};\n use rustc_lint::{LateContext, LateLintPass, LintContext};\n-use rustc_middle::hir::map::Map;\n use rustc_middle::lint::in_external_macro;\n use rustc_middle::ty::subst::GenericArgKind;\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n@@ -287,8 +286,6 @@ struct BorrowVisitor<'a, 'tcx> {\n }\n \n impl<'tcx> Visitor<'tcx> for BorrowVisitor<'_, 'tcx> {\n-    type Map = Map<'tcx>;\n-\n     fn visit_expr(&mut self, expr: &'tcx Expr<'_>) {\n         if self.borrows {\n             return;\n@@ -307,8 +304,4 @@ impl<'tcx> Visitor<'tcx> for BorrowVisitor<'_, 'tcx> {\n \n         walk_expr(self, expr);\n     }\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n }"}, {"sha": "607fa847dae5f61959f8dd69c5f902f88bc376bf", "filename": "src/tools/clippy/clippy_lints/src/slow_vector_initialization.rs", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fslow_vector_initialization.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fslow_vector_initialization.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fslow_vector_initialization.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -5,10 +5,9 @@ use clippy_utils::{get_enclosing_block, is_expr_path_def_path, path_to_local, pa\n use if_chain::if_chain;\n use rustc_ast::ast::LitKind;\n use rustc_errors::Applicability;\n-use rustc_hir::intravisit::{walk_block, walk_expr, walk_stmt, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{walk_block, walk_expr, walk_stmt, Visitor};\n use rustc_hir::{BindingAnnotation, Block, Expr, ExprKind, HirId, PatKind, QPath, Stmt, StmtKind};\n use rustc_lint::{LateContext, LateLintPass};\n-use rustc_middle::hir::map::Map;\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n use rustc_span::symbol::sym;\n \n@@ -270,8 +269,6 @@ impl<'a, 'tcx> VectorInitializationVisitor<'a, 'tcx> {\n }\n \n impl<'a, 'tcx> Visitor<'tcx> for VectorInitializationVisitor<'a, 'tcx> {\n-    type Map = Map<'tcx>;\n-\n     fn visit_stmt(&mut self, stmt: &'tcx Stmt<'_>) {\n         if self.initialization_found {\n             match stmt.kind {\n@@ -308,8 +305,4 @@ impl<'a, 'tcx> Visitor<'tcx> for VectorInitializationVisitor<'a, 'tcx> {\n \n         walk_expr(self, expr);\n     }\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n }"}, {"sha": "4294464dbf61a5fffbda1a1d728a9c3a71608f9d", "filename": "src/tools/clippy/clippy_lints/src/suspicious_trait_impl.rs", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fsuspicious_trait_impl.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fsuspicious_trait_impl.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fsuspicious_trait_impl.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -2,9 +2,8 @@ use clippy_utils::diagnostics::span_lint;\n use clippy_utils::{binop_traits, trait_ref_of_method, BINOP_TRAITS, OP_ASSIGN_TRAITS};\n use if_chain::if_chain;\n use rustc_hir as hir;\n-use rustc_hir::intravisit::{walk_expr, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{walk_expr, Visitor};\n use rustc_lint::{LateContext, LateLintPass};\n-use rustc_middle::hir::map::Map;\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n \n declare_clippy_lint! {\n@@ -104,8 +103,6 @@ struct BinaryExprVisitor {\n }\n \n impl<'tcx> Visitor<'tcx> for BinaryExprVisitor {\n-    type Map = Map<'tcx>;\n-\n     fn visit_expr(&mut self, expr: &'tcx hir::Expr<'_>) {\n         match expr.kind {\n             hir::ExprKind::Binary(..)\n@@ -116,8 +113,4 @@ impl<'tcx> Visitor<'tcx> for BinaryExprVisitor {\n \n         walk_expr(self, expr);\n     }\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n }"}, {"sha": "5ca4023aa5c199b3d8d2296525b2f2eb5640057b", "filename": "src/tools/clippy/clippy_lints/src/types/type_complexity.rs", "status": "modified", "additions": 1, "deletions": 7, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Ftypes%2Ftype_complexity.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Ftypes%2Ftype_complexity.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Ftypes%2Ftype_complexity.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -1,9 +1,8 @@\n use clippy_utils::diagnostics::span_lint;\n use rustc_hir as hir;\n-use rustc_hir::intravisit::{walk_inf, walk_ty, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{walk_inf, walk_ty, Visitor};\n use rustc_hir::{GenericParamKind, TyKind};\n use rustc_lint::LateContext;\n-use rustc_middle::hir::map::Map;\n use rustc_target::spec::abi::Abi;\n \n use super::TYPE_COMPLEXITY;\n@@ -37,8 +36,6 @@ struct TypeComplexityVisitor {\n }\n \n impl<'tcx> Visitor<'tcx> for TypeComplexityVisitor {\n-    type Map = Map<'tcx>;\n-\n     fn visit_infer(&mut self, inf: &'tcx hir::InferArg) {\n         self.score += 1;\n         walk_inf(self, inf);\n@@ -78,7 +75,4 @@ impl<'tcx> Visitor<'tcx> for TypeComplexityVisitor {\n         walk_ty(self, ty);\n         self.nest -= sub_nest;\n     }\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n }"}, {"sha": "e42c6c63ede0ba2e419de335318e2bcf841d4a89", "filename": "src/tools/clippy/clippy_lints/src/undocumented_unsafe_blocks.rs", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fundocumented_unsafe_blocks.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fundocumented_unsafe_blocks.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fundocumented_unsafe_blocks.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -2,11 +2,10 @@ use clippy_utils::diagnostics::{span_lint_and_help, span_lint_and_sugg};\n use clippy_utils::is_lint_allowed;\n use clippy_utils::source::{indent_of, reindent_multiline, snippet};\n use rustc_errors::Applicability;\n-use rustc_hir::intravisit::{walk_expr, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{walk_expr, Visitor};\n use rustc_hir::{Block, BlockCheckMode, Expr, ExprKind, HirId, Local, UnsafeSource};\n use rustc_lexer::TokenKind;\n use rustc_lint::{LateContext, LateLintPass};\n-use rustc_middle::hir::map::Map;\n use rustc_middle::lint::in_external_macro;\n use rustc_middle::ty::TyCtxt;\n use rustc_session::{declare_tool_lint, impl_lint_pass};\n@@ -114,12 +113,6 @@ impl LateLintPass<'_> for UndocumentedUnsafeBlocks {\n }\n \n impl<'v> Visitor<'v> for UndocumentedUnsafeBlocks {\n-    type Map = Map<'v>;\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n-\n     fn visit_expr(&mut self, ex: &'v Expr<'v>) {\n         match ex.kind {\n             ExprKind::Block(_, _) => self.local_level = self.local_level.saturating_add(1),"}, {"sha": "7d75ff36e971ab3dc01230c6c533d1dcb861be1e", "filename": "src/tools/clippy/clippy_lints/src/unnecessary_sort_by.rs", "status": "modified", "additions": 1, "deletions": 4, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Funnecessary_sort_by.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Funnecessary_sort_by.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Funnecessary_sort_by.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -224,10 +224,7 @@ fn detect_lint(cx: &LateContext<'_>, expr: &Expr<'_>) -> Option<LintTrigger> {\n \n fn expr_borrows(cx: &LateContext<'_>, expr: &Expr<'_>) -> bool {\n     let ty = cx.typeck_results().expr_ty(expr);\n-    matches!(ty.kind(), ty::Ref(..))\n-        || ty\n-            .walk()\n-            .any(|arg| matches!(arg.unpack(), GenericArgKind::Lifetime(_)))\n+    matches!(ty.kind(), ty::Ref(..)) || ty.walk().any(|arg| matches!(arg.unpack(), GenericArgKind::Lifetime(_)))\n }\n \n impl LateLintPass<'_> for UnnecessarySortBy {"}, {"sha": "2b89398ecd6ad1ea3ed6be1359814d43aa0be47c", "filename": "src/tools/clippy/clippy_lints/src/unused_async.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Funused_async.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Funused_async.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Funused_async.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -1,8 +1,8 @@\n use clippy_utils::diagnostics::span_lint_and_help;\n-use rustc_hir::intravisit::{walk_expr, walk_fn, FnKind, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{walk_expr, walk_fn, FnKind, Visitor};\n use rustc_hir::{Body, Expr, ExprKind, FnDecl, FnHeader, HirId, IsAsync, YieldSource};\n use rustc_lint::{LateContext, LateLintPass};\n-use rustc_middle::hir::map::Map;\n+use rustc_middle::hir::nested_filter;\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n use rustc_span::Span;\n \n@@ -43,7 +43,7 @@ struct AsyncFnVisitor<'a, 'tcx> {\n }\n \n impl<'a, 'tcx> Visitor<'tcx> for AsyncFnVisitor<'a, 'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::OnlyBodies;\n \n     fn visit_expr(&mut self, ex: &'tcx Expr<'tcx>) {\n         if let ExprKind::Yield(_, YieldSource::Await { .. }) = ex.kind {\n@@ -52,8 +52,8 @@ impl<'a, 'tcx> Visitor<'tcx> for AsyncFnVisitor<'a, 'tcx> {\n         walk_expr(self, ex);\n     }\n \n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::OnlyBodies(self.cx.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.cx.tcx.hir()\n     }\n }\n "}, {"sha": "0a728d7700b3073ee6b00435fdec36d8f77f10ee", "filename": "src/tools/clippy/clippy_lints/src/unwrap.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Funwrap.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Funwrap.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Funwrap.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -4,10 +4,10 @@ use clippy_utils::ty::is_type_diagnostic_item;\n use clippy_utils::{differing_macro_contexts, path_to_local, usage::is_potentially_mutated};\n use if_chain::if_chain;\n use rustc_errors::Applicability;\n-use rustc_hir::intravisit::{walk_expr, walk_fn, FnKind, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{walk_expr, walk_fn, FnKind, Visitor};\n use rustc_hir::{BinOpKind, Body, Expr, ExprKind, FnDecl, HirId, PathSegment, UnOp};\n use rustc_lint::{LateContext, LateLintPass};\n-use rustc_middle::hir::map::Map;\n+use rustc_middle::hir::nested_filter;\n use rustc_middle::lint::in_external_macro;\n use rustc_middle::ty::Ty;\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n@@ -215,7 +215,7 @@ impl<'a, 'tcx> UnwrappableVariablesVisitor<'a, 'tcx> {\n }\n \n impl<'a, 'tcx> Visitor<'tcx> for UnwrappableVariablesVisitor<'a, 'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::OnlyBodies;\n \n     fn visit_expr(&mut self, expr: &'tcx Expr<'_>) {\n         // Shouldn't lint when `expr` is in macro.\n@@ -297,8 +297,8 @@ impl<'a, 'tcx> Visitor<'tcx> for UnwrappableVariablesVisitor<'a, 'tcx> {\n         }\n     }\n \n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::OnlyBodies(self.cx.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.cx.tcx.hir()\n     }\n }\n "}, {"sha": "2c13f1049b59955a2e81ebb7b42dc1f5317c1fe3", "filename": "src/tools/clippy/clippy_lints/src/unwrap_in_result.rs", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Funwrap_in_result.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Funwrap_in_result.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Funwrap_in_result.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -3,10 +3,9 @@ use clippy_utils::ty::is_type_diagnostic_item;\n use clippy_utils::{method_chain_args, return_ty};\n use if_chain::if_chain;\n use rustc_hir as hir;\n-use rustc_hir::intravisit::{self, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{self, Visitor};\n use rustc_hir::{Expr, ImplItemKind};\n use rustc_lint::{LateContext, LateLintPass};\n-use rustc_middle::hir::map::Map;\n use rustc_middle::ty;\n use rustc_session::{declare_lint_pass, declare_tool_lint};\n use rustc_span::{sym, Span};\n@@ -81,8 +80,6 @@ struct FindExpectUnwrap<'a, 'tcx> {\n }\n \n impl<'a, 'tcx> Visitor<'tcx> for FindExpectUnwrap<'a, 'tcx> {\n-    type Map = Map<'tcx>;\n-\n     fn visit_expr(&mut self, expr: &'tcx Expr<'_>) {\n         // check for `expect`\n         if let Some(arglists) = method_chain_args(expr, &[\"expect\"]) {\n@@ -107,10 +104,6 @@ impl<'a, 'tcx> Visitor<'tcx> for FindExpectUnwrap<'a, 'tcx> {\n         // and check sub-expressions\n         intravisit::walk_expr(self, expr);\n     }\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n }\n \n fn lint_impl_body<'tcx>(cx: &LateContext<'tcx>, impl_span: Span, impl_item: &'tcx hir::ImplItem<'_>) {"}, {"sha": "6c5a5fe1434f8885ed8686eefee5378d1e78c66e", "filename": "src/tools/clippy/clippy_lints/src/use_self.rs", "status": "modified", "additions": 1, "deletions": 8, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fuse_self.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fuse_self.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Fuse_self.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -8,11 +8,10 @@ use rustc_hir::{\n     self as hir,\n     def::{CtorOf, DefKind, Res},\n     def_id::LocalDefId,\n-    intravisit::{walk_inf, walk_ty, NestedVisitorMap, Visitor},\n+    intravisit::{walk_inf, walk_ty, Visitor},\n     Expr, ExprKind, FnRetTy, FnSig, GenericArg, HirId, Impl, ImplItemKind, Item, ItemKind, Path, QPath, TyKind,\n };\n use rustc_lint::{LateContext, LateLintPass, LintContext};\n-use rustc_middle::hir::map::Map;\n use rustc_semver::RustcVersion;\n use rustc_session::{declare_tool_lint, impl_lint_pass};\n use rustc_span::Span;\n@@ -262,8 +261,6 @@ struct SkipTyCollector {\n }\n \n impl<'tcx> Visitor<'tcx> for SkipTyCollector {\n-    type Map = Map<'tcx>;\n-\n     fn visit_infer(&mut self, inf: &hir::InferArg) {\n         self.types_to_skip.push(inf.hir_id);\n \n@@ -274,10 +271,6 @@ impl<'tcx> Visitor<'tcx> for SkipTyCollector {\n \n         walk_ty(self, hir_ty);\n     }\n-\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n }\n \n fn span_lint(cx: &LateContext<'_>, span: Span) {"}, {"sha": "02fa866db5235586530d45b04d4b7cb61696d03b", "filename": "src/tools/clippy/clippy_lints/src/utils/internal_lints.rs", "status": "modified", "additions": 4, "deletions": 5, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Futils%2Finternal_lints.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Futils%2Finternal_lints.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Futils%2Finternal_lints.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -17,13 +17,12 @@ use rustc_hir as hir;\n use rustc_hir::def::{DefKind, Res};\n use rustc_hir::def_id::DefId;\n use rustc_hir::hir_id::CRATE_HIR_ID;\n-use rustc_hir::intravisit::{NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::Visitor;\n use rustc_hir::{\n     BinOpKind, Block, Expr, ExprKind, HirId, Item, Local, MutTy, Mutability, Node, Path, Stmt, StmtKind, Ty, TyKind,\n     UnOp,\n };\n use rustc_lint::{EarlyContext, EarlyLintPass, LateContext, LateLintPass, LintContext};\n-use rustc_middle::hir::map::Map;\n use rustc_middle::mir::interpret::ConstValue;\n use rustc_middle::ty;\n use rustc_semver::RustcVersion;\n@@ -544,16 +543,16 @@ struct LintCollector<'a, 'tcx> {\n }\n \n impl<'a, 'tcx> Visitor<'tcx> for LintCollector<'a, 'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::All;\n \n     fn visit_path(&mut self, path: &'tcx Path<'_>, _: HirId) {\n         if path.segments.len() == 1 {\n             self.output.insert(path.segments[0].ident.name);\n         }\n     }\n \n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::All(self.cx.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.cx.tcx.hir()\n     }\n }\n "}, {"sha": "8485c14bfe72a5ea338a2af8003b3201fe13fddb", "filename": "src/tools/clippy/clippy_lints/src/utils/internal_lints/metadata_collector.rs", "status": "modified", "additions": 9, "deletions": 10, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Futils%2Finternal_lints%2Fmetadata_collector.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Futils%2Finternal_lints%2Fmetadata_collector.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_lints%2Fsrc%2Futils%2Finternal_lints%2Fmetadata_collector.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -19,7 +19,6 @@ use rustc_hir::{\n     self as hir, def::DefKind, intravisit, intravisit::Visitor, ExprKind, Item, ItemKind, Mutability, QPath,\n };\n use rustc_lint::{CheckLintNameResult, LateContext, LateLintPass, LintContext, LintId};\n-use rustc_middle::hir::map::Map;\n use rustc_session::{declare_tool_lint, impl_lint_pass};\n use rustc_span::{sym, Loc, Span, Symbol};\n use serde::{ser::SerializeStruct, Serialize, Serializer};\n@@ -738,10 +737,10 @@ impl<'a, 'hir> LintResolver<'a, 'hir> {\n }\n \n impl<'a, 'hir> intravisit::Visitor<'hir> for LintResolver<'a, 'hir> {\n-    type Map = Map<'hir>;\n+    type NestedFilter = nested_filter::All;\n \n-    fn nested_visit_map(&mut self) -> intravisit::NestedVisitorMap<Self::Map> {\n-        intravisit::NestedVisitorMap::All(self.cx.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.cx.tcx.hir()\n     }\n \n     fn visit_expr(&mut self, expr: &'hir hir::Expr<'hir>) {\n@@ -792,10 +791,10 @@ impl<'a, 'hir> ApplicabilityResolver<'a, 'hir> {\n }\n \n impl<'a, 'hir> intravisit::Visitor<'hir> for ApplicabilityResolver<'a, 'hir> {\n-    type Map = Map<'hir>;\n+    type NestedFilter = nested_filter::All;\n \n-    fn nested_visit_map(&mut self) -> intravisit::NestedVisitorMap<Self::Map> {\n-        intravisit::NestedVisitorMap::All(self.cx.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.cx.tcx.hir()\n     }\n \n     fn visit_path(&mut self, path: &'hir hir::Path<'hir>, _id: hir::HirId) {\n@@ -875,10 +874,10 @@ impl<'a, 'hir> IsMultiSpanScanner<'a, 'hir> {\n }\n \n impl<'a, 'hir> intravisit::Visitor<'hir> for IsMultiSpanScanner<'a, 'hir> {\n-    type Map = Map<'hir>;\n+    type NestedFilter = nested_filter::All;\n \n-    fn nested_visit_map(&mut self) -> intravisit::NestedVisitorMap<Self::Map> {\n-        intravisit::NestedVisitorMap::All(self.cx.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.cx.tcx.hir()\n     }\n \n     fn visit_expr(&mut self, expr: &'hir hir::Expr<'hir>) {"}, {"sha": "34c5af848a6dbe1bfaa92ec1efbfae3e4b4624bf", "filename": "src/tools/clippy/clippy_utils/src/consts.rs", "status": "modified", "additions": 1, "deletions": 4, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Fconsts.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Fconsts.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Fconsts.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -413,10 +413,7 @@ impl<'a, 'tcx> ConstEvalLateContext<'a, 'tcx> {\n                     .tcx\n                     .const_eval_resolve(\n                         self.param_env,\n-                        ty::Unevaluated::new(\n-                            ty::WithOptConstParam::unknown(def_id),\n-                            substs,\n-                        ),\n+                        ty::Unevaluated::new(ty::WithOptConstParam::unknown(def_id), substs),\n                         None,\n                     )\n                     .ok()"}, {"sha": "8bdc59a7175b2eb987499e9aa7ad6ba58eb80562", "filename": "src/tools/clippy/clippy_utils/src/eager_or_lazy.rs", "status": "modified", "additions": 1, "deletions": 6, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Feager_or_lazy.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Feager_or_lazy.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Feager_or_lazy.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -12,7 +12,7 @@\n use crate::ty::{all_predicates_of, is_copy};\n use crate::visitors::is_const_evaluatable;\n use rustc_hir::def::{DefKind, Res};\n-use rustc_hir::intravisit::{walk_expr, ErasedMap, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{walk_expr, Visitor};\n use rustc_hir::{def_id::DefId, Block, Expr, ExprKind, QPath, UnOp};\n use rustc_lint::LateContext;\n use rustc_middle::ty::{self, PredicateKind};\n@@ -104,11 +104,6 @@ fn expr_eagerness<'tcx>(cx: &LateContext<'tcx>, e: &'tcx Expr<'_>) -> EagernessS\n     }\n \n     impl<'cx, 'tcx> Visitor<'tcx> for V<'cx, 'tcx> {\n-        type Map = ErasedMap<'tcx>;\n-        fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-            NestedVisitorMap::None\n-        }\n-\n         fn visit_expr(&mut self, e: &'tcx Expr<'_>) {\n             use EagernessSuggestion::{ForceNoChange, Lazy, NoChange};\n             if self.eagerness == ForceNoChange {"}, {"sha": "5c0800d2f038f8f5c0a55968c7358d764ec48015", "filename": "src/tools/clippy/clippy_utils/src/lib.rs", "status": "modified", "additions": 1, "deletions": 12, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Flib.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -72,7 +72,7 @@ use rustc_hir as hir;\n use rustc_hir::def::{DefKind, Res};\n use rustc_hir::def_id::{CrateNum, DefId, LocalDefId, CRATE_DEF_ID};\n use rustc_hir::hir_id::{HirIdMap, HirIdSet};\n-use rustc_hir::intravisit::{walk_expr, ErasedMap, FnKind, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{walk_expr, FnKind, Visitor};\n use rustc_hir::itemlikevisit::ItemLikeVisitor;\n use rustc_hir::LangItem::{OptionNone, ResultErr, ResultOk};\n use rustc_hir::{\n@@ -82,7 +82,6 @@ use rustc_hir::{\n     Target, TraitItem, TraitItemKind, TraitRef, TyKind, UnOp,\n };\n use rustc_lint::{LateContext, Level, Lint, LintContext};\n-use rustc_middle::hir::map::Map;\n use rustc_middle::hir::place::PlaceBase;\n use rustc_middle::ty as rustc_ty;\n use rustc_middle::ty::adjustment::{Adjust, Adjustment, AutoBorrow};\n@@ -981,11 +980,6 @@ pub fn can_move_expr_to_closure<'tcx>(cx: &LateContext<'tcx>, expr: &'tcx Expr<'\n         captures: HirIdMap<CaptureKind>,\n     }\n     impl<'tcx> Visitor<'tcx> for V<'_, 'tcx> {\n-        type Map = ErasedMap<'tcx>;\n-        fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-            NestedVisitorMap::None\n-        }\n-\n         fn visit_expr(&mut self, e: &'tcx Expr<'_>) {\n             if !self.allow_closure {\n                 return;\n@@ -1143,16 +1137,11 @@ pub struct ContainsName {\n }\n \n impl<'tcx> Visitor<'tcx> for ContainsName {\n-    type Map = Map<'tcx>;\n-\n     fn visit_name(&mut self, _: Span, name: Symbol) {\n         if self.name == name {\n             self.result = true;\n         }\n     }\n-    fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-        NestedVisitorMap::None\n-    }\n }\n \n /// Checks if an `Expr` contains a certain name."}, {"sha": "405e306359bc9b2dfe46278b43c4d5e3c6307a90", "filename": "src/tools/clippy/clippy_utils/src/usage.rs", "status": "modified", "additions": 4, "deletions": 10, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Fusage.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Fusage.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Fusage.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -6,7 +6,7 @@ use rustc_hir::HirIdSet;\n use rustc_hir::{Expr, ExprKind, HirId};\n use rustc_infer::infer::TyCtxtInferExt;\n use rustc_lint::LateContext;\n-use rustc_middle::hir::map::Map;\n+use rustc_middle::hir::nested_filter;\n use rustc_middle::mir::FakeReadCause;\n use rustc_middle::ty;\n use rustc_typeck::expr_use_visitor::{Delegate, ExprUseVisitor, PlaceBase, PlaceWithHirId};\n@@ -96,18 +96,12 @@ impl<'tcx> ParamBindingIdCollector {\n     }\n }\n impl<'tcx> intravisit::Visitor<'tcx> for ParamBindingIdCollector {\n-    type Map = Map<'tcx>;\n-\n     fn visit_pat(&mut self, pat: &'tcx hir::Pat<'tcx>) {\n         if let hir::PatKind::Binding(_, hir_id, ..) = pat.kind {\n             self.binding_hir_ids.push(hir_id);\n         }\n         intravisit::walk_pat(self, pat);\n     }\n-\n-    fn nested_visit_map(&mut self) -> intravisit::NestedVisitorMap<Self::Map> {\n-        intravisit::NestedVisitorMap::None\n-    }\n }\n \n pub struct BindingUsageFinder<'a, 'tcx> {\n@@ -127,7 +121,7 @@ impl<'a, 'tcx> BindingUsageFinder<'a, 'tcx> {\n     }\n }\n impl<'a, 'tcx> intravisit::Visitor<'tcx> for BindingUsageFinder<'a, 'tcx> {\n-    type Map = Map<'tcx>;\n+    type NestedFilter = nested_filter::OnlyBodies;\n \n     fn visit_expr(&mut self, expr: &'tcx hir::Expr<'tcx>) {\n         if !self.usage_found {\n@@ -143,8 +137,8 @@ impl<'a, 'tcx> intravisit::Visitor<'tcx> for BindingUsageFinder<'a, 'tcx> {\n         }\n     }\n \n-    fn nested_visit_map(&mut self) -> intravisit::NestedVisitorMap<Self::Map> {\n-        intravisit::NestedVisitorMap::OnlyBodies(self.cx.tcx.hir())\n+    fn nested_visit_map(&mut self) -> Self::Map {\n+        self.cx.tcx.hir()\n     }\n }\n "}, {"sha": "40451b17a9c63ce30693fbf2ab7147b2a020f284", "filename": "src/tools/clippy/clippy_utils/src/visitors.rs", "status": "modified", "additions": 11, "deletions": 21, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Fvisitors.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ee5d8d37baaf5b5a81a98396952839c73ae41c68/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Fvisitors.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fclippy%2Fclippy_utils%2Fsrc%2Fvisitors.rs?ref=ee5d8d37baaf5b5a81a98396952839c73ae41c68", "patch": "@@ -1,12 +1,13 @@\n use crate::path_to_local_id;\n use rustc_hir as hir;\n use rustc_hir::def::{DefKind, Res};\n-use rustc_hir::intravisit::{self, walk_block, walk_expr, NestedVisitorMap, Visitor};\n+use rustc_hir::intravisit::{self, walk_block, walk_expr, Visitor};\n use rustc_hir::{\n     Arm, Block, BlockCheckMode, Body, BodyId, Expr, ExprKind, HirId, ItemId, ItemKind, Stmt, UnOp, Unsafety,\n };\n use rustc_lint::LateContext;\n use rustc_middle::hir::map::Map;\n+use rustc_middle::hir::nested_filter;\n use rustc_middle::ty;\n \n /// Convenience method for creating a `Visitor` with just `visit_expr` overridden and nested\n@@ -19,9 +20,9 @@ pub fn expr_visitor<'tcx>(cx: &LateContext<'tcx>, f: impl FnMut(&'tcx Expr<'tcx>\n         f: F,\n     }\n     impl<'tcx, F: FnMut(&'tcx Expr<'tcx>) -> bool> Visitor<'tcx> for V<'tcx, F> {\n-        type Map = Map<'tcx>;\n-        fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-            NestedVisitorMap::OnlyBodies(self.hir)\n+        type NestedFilter = nested_filter::OnlyBodies;\n+        fn nested_visit_map(&mut self) -> Self::Map {\n+            self.hir\n         }\n \n         fn visit_expr(&mut self, expr: &'tcx Expr<'tcx>) {\n@@ -40,11 +41,6 @@ pub fn expr_visitor<'tcx>(cx: &LateContext<'tcx>, f: impl FnMut(&'tcx Expr<'tcx>\n pub fn expr_visitor_no_bodies<'tcx>(f: impl FnMut(&'tcx Expr<'tcx>) -> bool) -> impl Visitor<'tcx> {\n     struct V<F>(F);\n     impl<'tcx, F: FnMut(&'tcx Expr<'tcx>) -> bool> Visitor<'tcx> for V<F> {\n-        type Map = intravisit::ErasedMap<'tcx>;\n-        fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-            NestedVisitorMap::None\n-        }\n-\n         fn visit_expr(&mut self, e: &'tcx Expr<'_>) {\n             if (self.0)(e) {\n                 walk_expr(self, e);\n@@ -113,12 +109,6 @@ where\n     }\n \n     impl<'hir, F: FnMut(&'hir hir::Expr<'hir>) -> bool> intravisit::Visitor<'hir> for RetFinder<F> {\n-        type Map = Map<'hir>;\n-\n-        fn nested_visit_map(&mut self) -> intravisit::NestedVisitorMap<Self::Map> {\n-            intravisit::NestedVisitorMap::None\n-        }\n-\n         fn visit_stmt(&mut self, stmt: &'hir hir::Stmt<'_>) {\n             intravisit::walk_stmt(&mut *self.inside_stmt(true), stmt);\n         }\n@@ -237,9 +227,9 @@ pub fn is_const_evaluatable<'tcx>(cx: &LateContext<'tcx>, e: &'tcx Expr<'_>) ->\n         is_const: bool,\n     }\n     impl<'tcx> Visitor<'tcx> for V<'_, 'tcx> {\n-        type Map = Map<'tcx>;\n-        fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-            NestedVisitorMap::OnlyBodies(self.cx.tcx.hir())\n+        type NestedFilter = nested_filter::OnlyBodies;\n+        fn nested_visit_map(&mut self) -> Self::Map {\n+            self.cx.tcx.hir()\n         }\n \n         fn visit_expr(&mut self, e: &'tcx Expr<'_>) {\n@@ -327,9 +317,9 @@ pub fn is_expr_unsafe<'tcx>(cx: &LateContext<'tcx>, e: &'tcx Expr<'_>) -> bool {\n         is_unsafe: bool,\n     }\n     impl<'tcx> Visitor<'tcx> for V<'_, 'tcx> {\n-        type Map = Map<'tcx>;\n-        fn nested_visit_map(&mut self) -> NestedVisitorMap<Self::Map> {\n-            NestedVisitorMap::OnlyBodies(self.cx.tcx.hir())\n+        type NestedFilter = nested_filter::OnlyBodies;\n+        fn nested_visit_map(&mut self) -> Self::Map {\n+            self.cx.tcx.hir()\n         }\n         fn visit_expr(&mut self, e: &'tcx Expr<'_>) {\n             if self.is_unsafe {"}]}