{"sha": "600026ac9473e75729e67b38036e7deaffbe2a20", "node_id": "C_kwDOAAsO6NoAKDYwMDAyNmFjOTQ3M2U3NTcyOWU2N2IzODAzNmU3ZGVhZmZiZTJhMjA", "commit": {"author": {"name": "topjohnwu", "email": "topjohnwu@google.com", "date": "2022-07-04T06:52:01Z"}, "committer": {"name": "topjohnwu", "email": "topjohnwu@google.com", "date": "2022-07-04T06:52:01Z"}, "message": "Set CLANG_TABLEGEN when cross compiling clang\n\nWhen cross compiling rustc with `llvm.clang = true`, CLANG_TABLEGEN\nhas to be set to the host clang-tblgen executable to build clang.", "tree": {"sha": "774e22b84935a6ac742bbf6c07f2e9e25aaa438b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/774e22b84935a6ac742bbf6c07f2e9e25aaa438b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/600026ac9473e75729e67b38036e7deaffbe2a20", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/600026ac9473e75729e67b38036e7deaffbe2a20", "html_url": "https://github.com/rust-lang/rust/commit/600026ac9473e75729e67b38036e7deaffbe2a20", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/600026ac9473e75729e67b38036e7deaffbe2a20/comments", "author": {"login": "topjohnwu", "id": 7337301, "node_id": "MDQ6VXNlcjczMzczMDE=", "avatar_url": "https://avatars.githubusercontent.com/u/7337301?v=4", "gravatar_id": "", "url": "https://api.github.com/users/topjohnwu", "html_url": "https://github.com/topjohnwu", "followers_url": "https://api.github.com/users/topjohnwu/followers", "following_url": "https://api.github.com/users/topjohnwu/following{/other_user}", "gists_url": "https://api.github.com/users/topjohnwu/gists{/gist_id}", "starred_url": "https://api.github.com/users/topjohnwu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/topjohnwu/subscriptions", "organizations_url": "https://api.github.com/users/topjohnwu/orgs", "repos_url": "https://api.github.com/users/topjohnwu/repos", "events_url": "https://api.github.com/users/topjohnwu/events{/privacy}", "received_events_url": "https://api.github.com/users/topjohnwu/received_events", "type": "User", "site_admin": false}, "committer": {"login": "topjohnwu", "id": 7337301, "node_id": "MDQ6VXNlcjczMzczMDE=", "avatar_url": "https://avatars.githubusercontent.com/u/7337301?v=4", "gravatar_id": "", "url": "https://api.github.com/users/topjohnwu", "html_url": "https://github.com/topjohnwu", "followers_url": "https://api.github.com/users/topjohnwu/followers", "following_url": "https://api.github.com/users/topjohnwu/following{/other_user}", "gists_url": "https://api.github.com/users/topjohnwu/gists{/gist_id}", "starred_url": "https://api.github.com/users/topjohnwu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/topjohnwu/subscriptions", "organizations_url": "https://api.github.com/users/topjohnwu/orgs", "repos_url": "https://api.github.com/users/topjohnwu/repos", "events_url": "https://api.github.com/users/topjohnwu/events{/privacy}", "received_events_url": "https://api.github.com/users/topjohnwu/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ce9e71949cb3b788830b119d8fcfae9e20b62fbd", "url": "https://api.github.com/repos/rust-lang/rust/commits/ce9e71949cb3b788830b119d8fcfae9e20b62fbd", "html_url": "https://github.com/rust-lang/rust/commit/ce9e71949cb3b788830b119d8fcfae9e20b62fbd"}], "stats": {"total": 9, "additions": 9, "deletions": 0}, "files": [{"sha": "37f692c0189e34a5e69234dc099f57ef764db48c", "filename": "src/bootstrap/native.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/600026ac9473e75729e67b38036e7deaffbe2a20/src%2Fbootstrap%2Fnative.rs", "raw_url": "https://github.com/rust-lang/rust/raw/600026ac9473e75729e67b38036e7deaffbe2a20/src%2Fbootstrap%2Fnative.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fnative.rs?ref=600026ac9473e75729e67b38036e7deaffbe2a20", "patch": "@@ -430,11 +430,20 @@ impl Step for Llvm {\n             //        actually exists most of the time in normal installs of LLVM.\n             let host_bin = builder.llvm_out(builder.config.build).join(\"bin\");\n             cfg.define(\"LLVM_TABLEGEN\", host_bin.join(\"llvm-tblgen\").with_extension(EXE_EXTENSION));\n+            // LLVM_NM is required for cross compiling using MSVC\n             cfg.define(\"LLVM_NM\", host_bin.join(\"llvm-nm\").with_extension(EXE_EXTENSION));\n             cfg.define(\n                 \"LLVM_CONFIG_PATH\",\n                 host_bin.join(\"llvm-config\").with_extension(EXE_EXTENSION),\n             );\n+            if builder.config.llvm_clang {\n+                let build_bin = builder.llvm_out(builder.config.build).join(\"build\").join(\"bin\");\n+                let clang_tblgen = build_bin.join(\"clang-tblgen\").with_extension(EXE_EXTENSION);\n+                if !builder.config.dry_run && !clang_tblgen.exists() {\n+                    panic!(\"unable to find {}\", clang_tblgen.display());\n+                }\n+                cfg.define(\"CLANG_TABLEGEN\", clang_tblgen);\n+            }\n         }\n \n         let llvm_version_suffix = if let Some(ref suffix) = builder.config.llvm_version_suffix {"}]}