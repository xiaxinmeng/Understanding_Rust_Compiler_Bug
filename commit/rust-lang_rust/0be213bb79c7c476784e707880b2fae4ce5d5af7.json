{"sha": "0be213bb79c7c476784e707880b2fae4ce5d5af7", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBiZTIxM2JiNzljN2M0NzY3ODRlNzA3ODgwYjJmYWU0Y2U1ZDVhZjc=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-11-06T15:50:42Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-11-06T15:50:42Z"}, "message": "Auto merge of #4772 - HMPerson1:tastier_ice_cream, r=flip1995\n\nUse correct TypeckTables when hashing bodies\n\nFixes #4760\n\nchangelog: Fix ICE while hashing block expressions #4760\n\nr? @phansch", "tree": {"sha": "827335e8031c4be9300a705ebb4c111accd7537b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/827335e8031c4be9300a705ebb4c111accd7537b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0be213bb79c7c476784e707880b2fae4ce5d5af7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0be213bb79c7c476784e707880b2fae4ce5d5af7", "html_url": "https://github.com/rust-lang/rust/commit/0be213bb79c7c476784e707880b2fae4ce5d5af7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0be213bb79c7c476784e707880b2fae4ce5d5af7/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "865f5c7c46a9822c10b5e77340be81872128d6fd", "url": "https://api.github.com/repos/rust-lang/rust/commits/865f5c7c46a9822c10b5e77340be81872128d6fd", "html_url": "https://github.com/rust-lang/rust/commit/865f5c7c46a9822c10b5e77340be81872128d6fd"}, {"sha": "e3d6069e1845827a1f507882b407122db4418aa4", "url": "https://api.github.com/repos/rust-lang/rust/commits/e3d6069e1845827a1f507882b407122db4418aa4", "html_url": "https://github.com/rust-lang/rust/commit/e3d6069e1845827a1f507882b407122db4418aa4"}], "stats": {"total": 32, "additions": 23, "deletions": 9}, "files": [{"sha": "5602e76322d7a90867310352b8beb3e26a9d7dfc", "filename": "clippy_lints/src/utils/hir_utils.rs", "status": "modified", "additions": 13, "deletions": 9, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/0be213bb79c7c476784e707880b2fae4ce5d5af7/clippy_lints%2Fsrc%2Futils%2Fhir_utils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0be213bb79c7c476784e707880b2fae4ce5d5af7/clippy_lints%2Fsrc%2Futils%2Fhir_utils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Futils%2Fhir_utils.rs?ref=0be213bb79c7c476784e707880b2fae4ce5d5af7", "patch": "@@ -451,6 +451,7 @@ impl<'a, 'tcx> SpanlessHash<'a, 'tcx> {\n                     CaptureClause::CaptureByRef => 1,\n                 }\n                 .hash(&mut self.s);\n+                // closures inherit TypeckTables\n                 self.hash_expr(&self.cx.tcx.hir().body(eid).value);\n             },\n             ExprKind::Field(ref e, ref f) => {\n@@ -490,10 +491,7 @@ impl<'a, 'tcx> SpanlessHash<'a, 'tcx> {\n             },\n             ExprKind::Repeat(ref e, ref l_id) => {\n                 self.hash_expr(e);\n-                let full_table = self.tables;\n-                self.tables = self.cx.tcx.body_tables(l_id.body);\n-                self.hash_expr(&self.cx.tcx.hir().body(l_id.body).value);\n-                self.tables = full_table;\n+                self.hash_body(l_id.body);\n             },\n             ExprKind::Ret(ref e) => {\n                 if let Some(ref e) = *e {\n@@ -609,7 +607,7 @@ impl<'a, 'tcx> SpanlessHash<'a, 'tcx> {\n             },\n             TyKind::Array(ty, anon_const) => {\n                 self.hash_ty(ty);\n-                self.hash_expr(&self.cx.tcx.hir().body(anon_const.body).value);\n+                self.hash_body(anon_const.body);\n             },\n             TyKind::Ptr(mut_ty) => {\n                 self.hash_ty(&mut_ty.ty);\n@@ -660,19 +658,25 @@ impl<'a, 'tcx> SpanlessHash<'a, 'tcx> {\n                     match arg {\n                         GenericArg::Lifetime(ref l) => self.hash_lifetime(l),\n                         GenericArg::Type(ref ty) => self.hash_ty(&ty),\n-                        GenericArg::Const(ref ca) => {\n-                            self.hash_expr(&self.cx.tcx.hir().body(ca.value.body).value);\n-                        },\n+                        GenericArg::Const(ref ca) => self.hash_body(ca.value.body),\n                     }\n                 }\n             },\n             TyKind::TraitObject(_, lifetime) => {\n                 self.hash_lifetime(lifetime);\n             },\n             TyKind::Typeof(anon_const) => {\n-                self.hash_expr(&self.cx.tcx.hir().body(anon_const.body).value);\n+                self.hash_body(anon_const.body);\n             },\n             TyKind::Err | TyKind::Infer | TyKind::Never => {},\n         }\n     }\n+\n+    pub fn hash_body(&mut self, body_id: BodyId) {\n+        // swap out TypeckTables when hashing a body\n+        let old_tables = self.tables;\n+        self.tables = self.cx.tcx.body_tables(body_id);\n+        self.hash_expr(&self.cx.tcx.hir().body(body_id).value);\n+        self.tables = old_tables;\n+    }\n }"}, {"sha": "ead67d5ed1b1eaee50f973aab9eddc6c9a6e1771", "filename": "tests/ui/crashes/ice-4760.rs", "status": "added", "additions": 10, "deletions": 0, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/0be213bb79c7c476784e707880b2fae4ce5d5af7/tests%2Fui%2Fcrashes%2Fice-4760.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0be213bb79c7c476784e707880b2fae4ce5d5af7/tests%2Fui%2Fcrashes%2Fice-4760.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fcrashes%2Fice-4760.rs?ref=0be213bb79c7c476784e707880b2fae4ce5d5af7", "patch": "@@ -0,0 +1,10 @@\n+// run-pass\n+const COUNT: usize = 2;\n+struct Thing;\n+trait Dummy {}\n+\n+const _: () = {\n+    impl Dummy for Thing where [i32; COUNT]: Sized {}\n+};\n+\n+fn main() {}"}]}