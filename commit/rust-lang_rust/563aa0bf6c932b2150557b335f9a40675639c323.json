{"sha": "563aa0bf6c932b2150557b335f9a40675639c323", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU2M2FhMGJmNmM5MzJiMjE1MDU1N2IzMzVmOWE0MDY3NTYzOWMzMjM=", "commit": {"author": {"name": "Tim Chevalier", "email": "chevalier@alum.wellesley.edu", "date": "2012-11-03T20:38:16Z"}, "committer": {"name": "Tim Chevalier", "email": "chevalier@alum.wellesley.edu", "date": "2012-11-03T21:11:30Z"}, "message": "Remove the last use of rustrt::rust_compare_and_swap_ptr\n\nCloses #3527\n\nr=brson", "tree": {"sha": "4c9d4a76001a0c5eeec001fa6d3a5b01c8c6b580", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4c9d4a76001a0c5eeec001fa6d3a5b01c8c6b580"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/563aa0bf6c932b2150557b335f9a40675639c323", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/563aa0bf6c932b2150557b335f9a40675639c323", "html_url": "https://github.com/rust-lang/rust/commit/563aa0bf6c932b2150557b335f9a40675639c323", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/563aa0bf6c932b2150557b335f9a40675639c323/comments", "author": {"login": "catamorphism", "id": 427212, "node_id": "MDQ6VXNlcjQyNzIxMg==", "avatar_url": "https://avatars.githubusercontent.com/u/427212?v=4", "gravatar_id": "", "url": "https://api.github.com/users/catamorphism", "html_url": "https://github.com/catamorphism", "followers_url": "https://api.github.com/users/catamorphism/followers", "following_url": "https://api.github.com/users/catamorphism/following{/other_user}", "gists_url": "https://api.github.com/users/catamorphism/gists{/gist_id}", "starred_url": "https://api.github.com/users/catamorphism/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/catamorphism/subscriptions", "organizations_url": "https://api.github.com/users/catamorphism/orgs", "repos_url": "https://api.github.com/users/catamorphism/repos", "events_url": "https://api.github.com/users/catamorphism/events{/privacy}", "received_events_url": "https://api.github.com/users/catamorphism/received_events", "type": "User", "site_admin": false}, "committer": {"login": "catamorphism", "id": 427212, "node_id": "MDQ6VXNlcjQyNzIxMg==", "avatar_url": "https://avatars.githubusercontent.com/u/427212?v=4", "gravatar_id": "", "url": "https://api.github.com/users/catamorphism", "html_url": "https://github.com/catamorphism", "followers_url": "https://api.github.com/users/catamorphism/followers", "following_url": "https://api.github.com/users/catamorphism/following{/other_user}", "gists_url": "https://api.github.com/users/catamorphism/gists{/gist_id}", "starred_url": "https://api.github.com/users/catamorphism/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/catamorphism/subscriptions", "organizations_url": "https://api.github.com/users/catamorphism/orgs", "repos_url": "https://api.github.com/users/catamorphism/repos", "events_url": "https://api.github.com/users/catamorphism/events{/privacy}", "received_events_url": "https://api.github.com/users/catamorphism/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a0066082764456d642e25ae9ae780e1952cf1b94", "url": "https://api.github.com/repos/rust-lang/rust/commits/a0066082764456d642e25ae9ae780e1952cf1b94", "html_url": "https://github.com/rust-lang/rust/commit/a0066082764456d642e25ae9ae780e1952cf1b94"}], "stats": {"total": 13, "additions": 4, "deletions": 9}, "files": [{"sha": "98fcad94c1e0b3ceec047cc76b5f103c949e0222", "filename": "src/libcore/private.rs", "status": "modified", "additions": 4, "deletions": 9, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/563aa0bf6c932b2150557b335f9a40675639c323/src%2Flibcore%2Fprivate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/563aa0bf6c932b2150557b335f9a40675639c323/src%2Flibcore%2Fprivate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibcore%2Fprivate.rs?ref=563aa0bf6c932b2150557b335f9a40675639c323", "patch": "@@ -13,11 +13,6 @@ extern mod rustrt {\n     fn rust_task_weaken(ch: rust_port_id);\n     fn rust_task_unweaken(ch: rust_port_id);\n \n-    #[rust_stack]\n-    fn rust_compare_and_swap_ptr(address: &mut libc::uintptr_t,\n-                                 oldval: libc::uintptr_t,\n-                                 newval: libc::uintptr_t) -> bool;\n-\n     fn rust_create_little_lock() -> rust_little_lock;\n     fn rust_destroy_little_lock(lock: rust_little_lock);\n     fn rust_lock_little_lock(lock: rust_little_lock);\n@@ -291,11 +286,11 @@ pub fn test_weaken_task_fail() {\n // An unwrapper uses this protocol to communicate with the \"other\" task that\n // drops the last refcount on an arc. Unfortunately this can't be a proper\n // pipe protocol because the unwrapper has to access both stages at once.\n-type UnwrapProto = ~mut Option<(pipes::ChanOne<()>, pipes::PortOne<bool>)>;\n+type UnwrapProto = ~mut Option<(pipes::ChanOne<()>,  pipes::PortOne<bool>)>;\n \n struct ArcData<T> {\n     mut count:     libc::intptr_t,\n-    mut unwrapper: libc::uintptr_t, // either a UnwrapProto or 0\n+    mut unwrapper: int, // either a UnwrapProto or 0\n     // FIXME(#3224) should be able to make this non-option to save memory, and\n     // in unwrap() use \"let ~ArcData { data: result, _ } = thing\" to unwrap it\n     mut data:      Option<T>,\n@@ -371,9 +366,9 @@ pub unsafe fn unwrap_shared_mutable_state<T: Send>(rc: SharedMutableState<T>)\n         let (c1,p1) = pipes::oneshot(); // ()\n         let (c2,p2) = pipes::oneshot(); // bool\n         let server: UnwrapProto = ~mut Some((move c1,move p2));\n-        let serverp: libc::uintptr_t = cast::transmute(move server);\n+        let serverp: int = cast::transmute(move server);\n         // Try to put our server end in the unwrapper slot.\n-        if rustrt::rust_compare_and_swap_ptr(&mut ptr.unwrapper, 0, serverp) {\n+        if compare_and_swap(&mut ptr.unwrapper, 0, serverp) {\n             // Got in. Step 0: Tell destructor not to run. We are now it.\n             rc.data = ptr::null();\n             // Step 1 - drop our own reference."}]}