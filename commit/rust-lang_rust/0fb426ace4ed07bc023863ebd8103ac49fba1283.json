{"sha": "0fb426ace4ed07bc023863ebd8103ac49fba1283", "node_id": "C_kwDOAAsO6NoAKDBmYjQyNmFjZTRlZDA3YmMwMjM4NjNlYmQ4MTAzYWM0OWZiYTEyODM", "commit": {"author": {"name": "Chris Wailes", "email": "chriswailes@google.com", "date": "2022-09-26T22:50:56Z"}, "committer": {"name": "Chris Wailes", "email": "chriswailes@google.com", "date": "2022-12-14T19:33:08Z"}, "message": "Update CI to use Android NDK r25b\n\nThis commit updates the CI definitions to use the most recent Android\nLTS NDK release: r25b.  Changes since the last NDK used by Rust negate\nthe need to generate \"standalone toolchains\" and newer NDKs can be used\nin-place.\n\nSee https://developer.android.com/ndk/guides/other_build_systems#overview", "tree": {"sha": "897e47f5edbc59bcaa56896fe1cb7fa01a839e98", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/897e47f5edbc59bcaa56896fe1cb7fa01a839e98"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0fb426ace4ed07bc023863ebd8103ac49fba1283", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0fb426ace4ed07bc023863ebd8103ac49fba1283", "html_url": "https://github.com/rust-lang/rust/commit/0fb426ace4ed07bc023863ebd8103ac49fba1283", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0fb426ace4ed07bc023863ebd8103ac49fba1283/comments", "author": {"login": "chriswailes", "id": 530751, "node_id": "MDQ6VXNlcjUzMDc1MQ==", "avatar_url": "https://avatars.githubusercontent.com/u/530751?v=4", "gravatar_id": "", "url": "https://api.github.com/users/chriswailes", "html_url": "https://github.com/chriswailes", "followers_url": "https://api.github.com/users/chriswailes/followers", "following_url": "https://api.github.com/users/chriswailes/following{/other_user}", "gists_url": "https://api.github.com/users/chriswailes/gists{/gist_id}", "starred_url": "https://api.github.com/users/chriswailes/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/chriswailes/subscriptions", "organizations_url": "https://api.github.com/users/chriswailes/orgs", "repos_url": "https://api.github.com/users/chriswailes/repos", "events_url": "https://api.github.com/users/chriswailes/events{/privacy}", "received_events_url": "https://api.github.com/users/chriswailes/received_events", "type": "User", "site_admin": false}, "committer": {"login": "chriswailes", "id": 530751, "node_id": "MDQ6VXNlcjUzMDc1MQ==", "avatar_url": "https://avatars.githubusercontent.com/u/530751?v=4", "gravatar_id": "", "url": "https://api.github.com/users/chriswailes", "html_url": "https://github.com/chriswailes", "followers_url": "https://api.github.com/users/chriswailes/followers", "following_url": "https://api.github.com/users/chriswailes/following{/other_user}", "gists_url": "https://api.github.com/users/chriswailes/gists{/gist_id}", "starred_url": "https://api.github.com/users/chriswailes/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/chriswailes/subscriptions", "organizations_url": "https://api.github.com/users/chriswailes/orgs", "repos_url": "https://api.github.com/users/chriswailes/repos", "events_url": "https://api.github.com/users/chriswailes/events{/privacy}", "received_events_url": "https://api.github.com/users/chriswailes/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ba64ba8b0dfd57f7d6d7399d0df7ded37d2af18d", "url": "https://api.github.com/repos/rust-lang/rust/commits/ba64ba8b0dfd57f7d6d7399d0df7ded37d2af18d", "html_url": "https://github.com/rust-lang/rust/commit/ba64ba8b0dfd57f7d6d7399d0df7ded37d2af18d"}], "stats": {"total": 75, "additions": 31, "deletions": 44}, "files": [{"sha": "65c882fb801e5b736e8958cc7b5fcf381a67a0b5", "filename": "src/bootstrap/cc_detect.rs", "status": "modified", "additions": 18, "deletions": 6, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/0fb426ace4ed07bc023863ebd8103ac49fba1283/src%2Fbootstrap%2Fcc_detect.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0fb426ace4ed07bc023863ebd8103ac49fba1283/src%2Fbootstrap%2Fcc_detect.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fcc_detect.rs?ref=0fb426ace4ed07bc023863ebd8103ac49fba1283", "patch": "@@ -47,6 +47,8 @@ fn cc2ar(cc: &Path, target: TargetSelection) -> Option<PathBuf> {\n         Some(PathBuf::from(\"ar\"))\n     } else if target.contains(\"vxworks\") {\n         Some(PathBuf::from(\"wr-ar\"))\n+    } else if target.contains(\"android\") {\n+        Some(cc.parent().unwrap().join(PathBuf::from(\"llvm-ar\")))\n     } else {\n         let parent = cc.parent().unwrap();\n         let file = cc.file_name().unwrap().to_str().unwrap();\n@@ -219,12 +221,22 @@ fn set_compiler(\n }\n \n pub(crate) fn ndk_compiler(compiler: Language, triple: &str, ndk: &Path) -> PathBuf {\n-    let triple_translated = triple\n-        .replace(\"armv7neon\", \"arm\")\n-        .replace(\"armv7\", \"arm\")\n-        .replace(\"thumbv7neon\", \"arm\")\n-        .replace(\"thumbv7\", \"arm\");\n-    let compiler = format!(\"{}-{}\", triple_translated, compiler.clang());\n+    let mut triple_iter = triple.split(\"-\");\n+    let triple_translated = if let Some(arch) = triple_iter.next() {\n+        let arch_new = match arch {\n+            \"arm\" | \"armv7\" | \"armv7neon\" | \"thumbv7\" | \"thumbv7neon\" => \"armv7a\",\n+            other => other,\n+        };\n+        std::iter::once(arch_new).chain(triple_iter).collect::<Vec<&str>>().join(\"-\")\n+    } else {\n+        triple.to_string()\n+    };\n+\n+    // API 19 is the earliest API level supported by NDK r25b but AArch64 and x86_64 support\n+    // begins at API level 21.\n+    let api_level =\n+        if triple.contains(\"aarch64\") || triple.contains(\"x86_64\") { \"21\" } else { \"19\" };\n+    let compiler = format!(\"{}{}-{}\", triple_translated, api_level, compiler.clang());\n     ndk.join(\"bin\").join(compiler)\n }\n "}, {"sha": "b6b4fdc67a94905a2d6e28f2b56d01c44ceeb6dc", "filename": "src/ci/docker/host-x86_64/arm-android/Dockerfile", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/0fb426ace4ed07bc023863ebd8103ac49fba1283/src%2Fci%2Fdocker%2Fhost-x86_64%2Farm-android%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/0fb426ace4ed07bc023863ebd8103ac49fba1283/src%2Fci%2Fdocker%2Fhost-x86_64%2Farm-android%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Farm-android%2FDockerfile?ref=0fb426ace4ed07bc023863ebd8103ac49fba1283", "patch": "@@ -1,12 +1,12 @@\n-FROM ubuntu:22.04\n+FROM ubuntu:22.10\n \n ARG DEBIAN_FRONTEND=noninteractive\n COPY scripts/android-base-apt-get.sh /scripts/\n RUN sh /scripts/android-base-apt-get.sh\n \n COPY scripts/android-ndk.sh /scripts/\n RUN . /scripts/android-ndk.sh && \\\n-    download_and_make_toolchain android-ndk-r15c-linux-x86_64.zip arm 14\n+    download_ndk android-ndk-r25b-linux.zip\n \n RUN dpkg --add-architecture i386 && \\\n     apt-get update && \\\n@@ -30,7 +30,7 @@ ENV PATH=$PATH:/android/sdk/platform-tools\n \n ENV TARGETS=arm-linux-androideabi\n \n-ENV RUST_CONFIGURE_ARGS --arm-linux-androideabi-ndk=/android/ndk/arm-14\n+ENV RUST_CONFIGURE_ARGS --arm-linux-androideabi-ndk=/android/ndk/toolchains/llvm/prebuilt/linux-x86_64/\n \n ENV SCRIPT python3 ../x.py --stage 2 test --host='' --target $TARGETS\n "}, {"sha": "9c6f648896b5127559decfa7d37c229650ca7173", "filename": "src/ci/docker/host-x86_64/dist-android/Dockerfile", "status": "modified", "additions": 8, "deletions": 15, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/0fb426ace4ed07bc023863ebd8103ac49fba1283/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-android%2FDockerfile", "raw_url": "https://github.com/rust-lang/rust/raw/0fb426ace4ed07bc023863ebd8103ac49fba1283/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-android%2FDockerfile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fhost-x86_64%2Fdist-android%2FDockerfile?ref=0fb426ace4ed07bc023863ebd8103ac49fba1283", "patch": "@@ -1,19 +1,12 @@\n-FROM ubuntu:22.04\n+FROM ubuntu:22.10\n \n COPY scripts/android-base-apt-get.sh /scripts/\n RUN sh /scripts/android-base-apt-get.sh\n \n # ndk\n COPY scripts/android-ndk.sh /scripts/\n RUN . /scripts/android-ndk.sh && \\\n-    download_ndk android-ndk-r15c-linux-x86_64.zip && \\\n-    make_standalone_toolchain arm 14 && \\\n-    make_standalone_toolchain x86 14 && \\\n-    make_standalone_toolchain arm 21 && \\\n-    make_standalone_toolchain x86 21 && \\\n-    make_standalone_toolchain arm64 21 && \\\n-    make_standalone_toolchain x86_64 21 && \\\n-    remove_ndk\n+    download_ndk android-ndk-r25b-linux.zip\n \n # env\n ENV TARGETS=arm-linux-androideabi\n@@ -26,12 +19,12 @@ ENV TARGETS=$TARGETS,x86_64-linux-android\n ENV RUST_CONFIGURE_ARGS \\\n       --enable-extended \\\n       --enable-profiler \\\n-      --arm-linux-androideabi-ndk=/android/ndk/arm-14 \\\n-      --armv7-linux-androideabi-ndk=/android/ndk/arm-14 \\\n-      --thumbv7neon-linux-androideabi-ndk=/android/ndk/arm-14 \\\n-      --i686-linux-android-ndk=/android/ndk/x86-14 \\\n-      --aarch64-linux-android-ndk=/android/ndk/arm64-21 \\\n-      --x86_64-linux-android-ndk=/android/ndk/x86_64-21 \\\n+      --arm-linux-androideabi-ndk=/android/ndk/toolchains/llvm/prebuilt/linux-x86_64/ \\\n+      --armv7-linux-androideabi-ndk=/android/ndk/toolchains/llvm/prebuilt/linux-x86_64/ \\\n+      --thumbv7neon-linux-androideabi-ndk=/android/ndk/toolchains/llvm/prebuilt/linux-x86_64/ \\\n+      --i686-linux-android-ndk=/android/ndk/toolchains/llvm/prebuilt/linux-x86_64/ \\\n+      --aarch64-linux-android-ndk=/android/ndk/toolchains/llvm/prebuilt/linux-x86_64/ \\\n+      --x86_64-linux-android-ndk=/android/ndk/toolchains/llvm/prebuilt/linux-x86_64/ \\\n       --disable-docs\n \n ENV SCRIPT python3 ../x.py dist --host='' --target $TARGETS"}, {"sha": "4dd6ac274fd5b96dfa24873a8c4e0aea6c262cbc", "filename": "src/ci/docker/scripts/android-ndk.sh", "status": "modified", "additions": 2, "deletions": 20, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/0fb426ace4ed07bc023863ebd8103ac49fba1283/src%2Fci%2Fdocker%2Fscripts%2Fandroid-ndk.sh", "raw_url": "https://github.com/rust-lang/rust/raw/0fb426ace4ed07bc023863ebd8103ac49fba1283/src%2Fci%2Fdocker%2Fscripts%2Fandroid-ndk.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fci%2Fdocker%2Fscripts%2Fandroid-ndk.sh?ref=0fb426ace4ed07bc023863ebd8103ac49fba1283", "patch": "@@ -4,28 +4,10 @@ set -ex\n URL=https://dl.google.com/android/repository\n \n download_ndk() {\n-    mkdir -p /android/ndk\n-    cd /android/ndk\n+    mkdir /android/\n+    cd /android\n     curl -fO $URL/$1\n     unzip -q $1\n     rm $1\n     mv android-ndk-* ndk\n }\n-\n-make_standalone_toolchain() {\n-    # See https://developer.android.com/ndk/guides/standalone_toolchain.htm\n-    python3 /android/ndk/ndk/build/tools/make_standalone_toolchain.py \\\n-        --install-dir /android/ndk/$1-$2 \\\n-        --arch $1 \\\n-        --api $2\n-}\n-\n-remove_ndk() {\n-    rm -rf /android/ndk/ndk\n-}\n-\n-download_and_make_toolchain() {\n-    download_ndk $1 && \\\n-    make_standalone_toolchain $2 $3 && \\\n-    remove_ndk\n-}"}]}