{"sha": "b4536943e391cf175c149ffb72af3a8cce14e803", "node_id": "C_kwDOAAsO6NoAKGI0NTM2OTQzZTM5MWNmMTc1YzE0OWZmYjcyYWYzYThjY2UxNGU4MDM", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2022-10-22T10:58:09Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-10-22T10:58:09Z"}, "message": "Rollup merge of #103360 - ChrisDenton:isterm-filetype, r=thomcc\n\nReduce false positives in msys2 detection\n\nCurrently msys2 will be detected by getting the file path and looking to see if it contains the substrings \"msys-\" and \"-ptr\" (or \"cygwin-\" and \"-pty\"). This risks false positives, especially with filesystem files and if `GetFileInformationByHandleEx` returns a [full path](https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/ntifs/nf-ntifs-ntqueryinformationfile#remarks).\n\nThis PR adds a check to see if the handle is a pipe before doing the substring search. Additionally, for \"msys2-\" or \"cygwin-\" it only checks if the file name starts with the substring rather than looking at the whole path.", "tree": {"sha": "16056d36753d8ccb18d62ffa6dfdd29f4b0660a4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/16056d36753d8ccb18d62ffa6dfdd29f4b0660a4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b4536943e391cf175c149ffb72af3a8cce14e803", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjU8zBCRBK7hj4Ov3rIwAA7+kIAJs0j95BHtwZrlr8dM+q4hyA\nSLb0ErrDwqJNzZLUmrfp6bqaA+VaNfU48qHuBnJZXT0febtBemvZv8O27829lVKn\nUmVvsDtD0XTmQ2/cUISsCI/jqr6MNIasDMok/9SA3hp4wvCWRARtE2L7zhrIopB1\nZ8pNn6FJW3fpjDNJXcK3UJMRIrAg1RTsViAFSJUMKQCfDuKBHilxmrlHP8lT4ih6\nWH3MLrC1aCNTHJU63ul4zjFsycZLn/Zq+q6rURn1bBNpixwBwITvKgXr6ayIxJaK\nC+qYjnKWx8a44c6yYz03JMmO+2h7wgLOpoKAYiK/698GQ7s0xAbbsFOku/xAJqE=\n=IuZF\n-----END PGP SIGNATURE-----\n", "payload": "tree 16056d36753d8ccb18d62ffa6dfdd29f4b0660a4\nparent b22559f547f963df83987dfcf2aeb070a84d42bf\nparent d7b0bcb20f2f7d5f3ea3489d56ece630147e98f5\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1666436289 +0530\ncommitter GitHub <noreply@github.com> 1666436289 +0530\n\nRollup merge of #103360 - ChrisDenton:isterm-filetype, r=thomcc\n\nReduce false positives in msys2 detection\n\nCurrently msys2 will be detected by getting the file path and looking to see if it contains the substrings \"msys-\" and \"-ptr\" (or \"cygwin-\" and \"-pty\"). This risks false positives, especially with filesystem files and if `GetFileInformationByHandleEx` returns a [full path](https://learn.microsoft.com/en-us/windows-hardware/drivers/ddi/ntifs/nf-ntifs-ntqueryinformationfile#remarks).\n\nThis PR adds a check to see if the handle is a pipe before doing the substring search. Additionally, for \"msys2-\" or \"cygwin-\" it only checks if the file name starts with the substring rather than looking at the whole path.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b4536943e391cf175c149ffb72af3a8cce14e803", "html_url": "https://github.com/rust-lang/rust/commit/b4536943e391cf175c149ffb72af3a8cce14e803", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b4536943e391cf175c149ffb72af3a8cce14e803/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b22559f547f963df83987dfcf2aeb070a84d42bf", "url": "https://api.github.com/repos/rust-lang/rust/commits/b22559f547f963df83987dfcf2aeb070a84d42bf", "html_url": "https://github.com/rust-lang/rust/commit/b22559f547f963df83987dfcf2aeb070a84d42bf"}, {"sha": "d7b0bcb20f2f7d5f3ea3489d56ece630147e98f5", "url": "https://api.github.com/repos/rust-lang/rust/commits/d7b0bcb20f2f7d5f3ea3489d56ece630147e98f5", "html_url": "https://github.com/rust-lang/rust/commit/d7b0bcb20f2f7d5f3ea3489d56ece630147e98f5"}], "stats": {"total": 14, "additions": 12, "deletions": 2}, "files": [{"sha": "be6fc2ebb7a27f73ee3a076b9f19d5de0c58faab", "filename": "library/std/src/sys/windows/c.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/b4536943e391cf175c149ffb72af3a8cce14e803/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b4536943e391cf175c149ffb72af3a8cce14e803/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fc.rs?ref=b4536943e391cf175c149ffb72af3a8cce14e803", "patch": "@@ -129,6 +129,8 @@ pub const FIONBIO: c_ulong = 0x8004667e;\n \n pub const MAX_PATH: usize = 260;\n \n+pub const FILE_TYPE_PIPE: u32 = 3;\n+\n #[repr(C)]\n #[derive(Copy)]\n pub struct WIN32_FIND_DATAW {\n@@ -1114,6 +1116,7 @@ extern \"system\" {\n         lpFileInformation: LPVOID,\n         dwBufferSize: DWORD,\n     ) -> BOOL;\n+    pub fn GetFileType(hfile: HANDLE) -> DWORD;\n     pub fn SleepConditionVariableSRW(\n         ConditionVariable: PCONDITION_VARIABLE,\n         SRWLock: PSRWLOCK,"}, {"sha": "2cc34c986b990e59002d37791593e1cc6ea65aef", "filename": "library/std/src/sys/windows/io.rs", "status": "modified", "additions": 9, "deletions": 2, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/b4536943e391cf175c149ffb72af3a8cce14e803/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fio.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b4536943e391cf175c149ffb72af3a8cce14e803/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fio.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fio.rs?ref=b4536943e391cf175c149ffb72af3a8cce14e803", "patch": "@@ -120,6 +120,11 @@ unsafe fn handle_is_console(handle: BorrowedHandle<'_>) -> bool {\n }\n \n unsafe fn msys_tty_on(handle: c::HANDLE) -> bool {\n+    // Early return if the handle is not a pipe.\n+    if c::GetFileType(handle) != c::FILE_TYPE_PIPE {\n+        return false;\n+    }\n+\n     const SIZE: usize = size_of::<c::FILE_NAME_INFO>() + c::MAX_PATH * size_of::<c::WCHAR>();\n     let mut name_info_bytes = Align8([0u8; SIZE]);\n     let res = c::GetFileInformationByHandleEx(\n@@ -137,11 +142,13 @@ unsafe fn msys_tty_on(handle: c::HANDLE) -> bool {\n     let name_ptr = name_info_bytes.0.as_ptr().offset(size_of::<c::DWORD>() as isize).cast::<u16>();\n     let s = core::slice::from_raw_parts(name_ptr, name_len);\n     let name = String::from_utf16_lossy(s);\n+    // Get the file name only.\n+    let name = name.rsplit('\\\\').next().unwrap_or(&name);\n     // This checks whether 'pty' exists in the file name, which indicates that\n     // a pseudo-terminal is attached. To mitigate against false positives\n     // (e.g., an actual file name that contains 'pty'), we also require that\n-    // either the strings 'msys-' or 'cygwin-' are in the file name as well.)\n-    let is_msys = name.contains(\"msys-\") || name.contains(\"cygwin-\");\n+    // the file name begins with either the strings 'msys-' or 'cygwin-'.)\n+    let is_msys = name.starts_with(\"msys-\") || name.starts_with(\"cygwin-\");\n     let is_pty = name.contains(\"-pty\");\n     is_msys && is_pty\n }"}]}