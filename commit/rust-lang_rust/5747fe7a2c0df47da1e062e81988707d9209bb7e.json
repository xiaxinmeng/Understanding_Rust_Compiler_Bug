{"sha": "5747fe7a2c0df47da1e062e81988707d9209bb7e", "node_id": "MDY6Q29tbWl0NzI0NzEyOjU3NDdmZTdhMmMwZGY0N2RhMWUwNjJlODE5ODg3MDdkOTIwOWJiN2U=", "commit": {"author": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2012-03-26T21:39:39Z"}, "committer": {"name": "Brian Anderson", "email": "banderson@mozilla.com", "date": "2012-03-29T23:43:18Z"}, "message": "rt: For now, only run the box annihilator after task failure", "tree": {"sha": "75ee9582fa90872280f46a14ce1f323831509c53", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/75ee9582fa90872280f46a14ce1f323831509c53"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/5747fe7a2c0df47da1e062e81988707d9209bb7e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/5747fe7a2c0df47da1e062e81988707d9209bb7e", "html_url": "https://github.com/rust-lang/rust/commit/5747fe7a2c0df47da1e062e81988707d9209bb7e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/5747fe7a2c0df47da1e062e81988707d9209bb7e/comments", "author": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "committer": {"login": "brson", "id": 147214, "node_id": "MDQ6VXNlcjE0NzIxNA==", "avatar_url": "https://avatars.githubusercontent.com/u/147214?v=4", "gravatar_id": "", "url": "https://api.github.com/users/brson", "html_url": "https://github.com/brson", "followers_url": "https://api.github.com/users/brson/followers", "following_url": "https://api.github.com/users/brson/following{/other_user}", "gists_url": "https://api.github.com/users/brson/gists{/gist_id}", "starred_url": "https://api.github.com/users/brson/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/brson/subscriptions", "organizations_url": "https://api.github.com/users/brson/orgs", "repos_url": "https://api.github.com/users/brson/repos", "events_url": "https://api.github.com/users/brson/events{/privacy}", "received_events_url": "https://api.github.com/users/brson/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7f9ed39040404c59131ba3818e1ca947fb23d282", "url": "https://api.github.com/repos/rust-lang/rust/commits/7f9ed39040404c59131ba3818e1ca947fb23d282", "html_url": "https://github.com/rust-lang/rust/commit/7f9ed39040404c59131ba3818e1ca947fb23d282"}], "stats": {"total": 20, "additions": 14, "deletions": 6}, "files": [{"sha": "d77c7cf733e16a62c4bd4e167e0bbc03d9ab0bc7", "filename": "src/rt/rust_task.cpp", "status": "modified", "additions": 14, "deletions": 6, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/5747fe7a2c0df47da1e062e81988707d9209bb7e/src%2Frt%2Frust_task.cpp", "raw_url": "https://github.com/rust-lang/rust/raw/5747fe7a2c0df47da1e062e81988707d9209bb7e/src%2Frt%2Frust_task.cpp", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Frt%2Frust_task.cpp?ref=5747fe7a2c0df47da1e062e81988707d9209bb7e", "patch": "@@ -96,12 +96,6 @@ cleanup_task(cleanup_args *args) {\n     bool threw_exception = args->threw_exception;\n     rust_task *task = a->task;\n \n-    cc::do_cc(task);\n-    annihilate_boxes(task);\n-    cc::do_final_cc(task);\n-\n-    task->die();\n-\n     {\n         scoped_lock with(task->kill_lock);\n         if (task->killed && !threw_exception) {\n@@ -110,6 +104,20 @@ cleanup_task(cleanup_args *args) {\n         }\n     }\n \n+    // FIXME: For performance we should do the annihilator instead\n+    // of the cycle collector even under normal termination, but\n+    // since that would hide memory management errors (like not derefing\n+    // boxes), it needs to be disableable in debug builds.\n+    if (threw_exception) {\n+        // FIXME: When the annihilator is more powerful and successfully\n+        // runs resource destructors, etc. we can get rid of this cc\n+        cc::do_cc(task);\n+        annihilate_boxes(task);\n+    }\n+    cc::do_final_cc(task);\n+\n+    task->die();\n+\n     task->notify(!threw_exception);\n \n     if (threw_exception) {"}]}