{"sha": "3f58ab6e24af34265229f701d48eb240cc06d751", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNmNThhYjZlMjRhZjM0MjY1MjI5ZjcwMWQ0OGViMjQwY2MwNmQ3NTE=", "commit": {"author": {"name": "Oliver Middleton", "email": "olliemail27@gmail.com", "date": "2020-03-13T23:24:12Z"}, "committer": {"name": "Oliver Middleton", "email": "olliemail27@gmail.com", "date": "2020-03-13T23:24:12Z"}, "message": "Allow `rustdoc-js` and `rustdoc-js-std` to use none default build dir location", "tree": {"sha": "6a226e2f9929cc870eef5d4b31213047b269d730", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6a226e2f9929cc870eef5d4b31213047b269d730"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3f58ab6e24af34265229f701d48eb240cc06d751", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3f58ab6e24af34265229f701d48eb240cc06d751", "html_url": "https://github.com/rust-lang/rust/commit/3f58ab6e24af34265229f701d48eb240cc06d751", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3f58ab6e24af34265229f701d48eb240cc06d751/comments", "author": {"login": "ollie27", "id": 7189418, "node_id": "MDQ6VXNlcjcxODk0MTg=", "avatar_url": "https://avatars.githubusercontent.com/u/7189418?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ollie27", "html_url": "https://github.com/ollie27", "followers_url": "https://api.github.com/users/ollie27/followers", "following_url": "https://api.github.com/users/ollie27/following{/other_user}", "gists_url": "https://api.github.com/users/ollie27/gists{/gist_id}", "starred_url": "https://api.github.com/users/ollie27/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ollie27/subscriptions", "organizations_url": "https://api.github.com/users/ollie27/orgs", "repos_url": "https://api.github.com/users/ollie27/repos", "events_url": "https://api.github.com/users/ollie27/events{/privacy}", "received_events_url": "https://api.github.com/users/ollie27/received_events", "type": "User", "site_admin": false}, "committer": {"login": "ollie27", "id": 7189418, "node_id": "MDQ6VXNlcjcxODk0MTg=", "avatar_url": "https://avatars.githubusercontent.com/u/7189418?v=4", "gravatar_id": "", "url": "https://api.github.com/users/ollie27", "html_url": "https://github.com/ollie27", "followers_url": "https://api.github.com/users/ollie27/followers", "following_url": "https://api.github.com/users/ollie27/following{/other_user}", "gists_url": "https://api.github.com/users/ollie27/gists{/gist_id}", "starred_url": "https://api.github.com/users/ollie27/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/ollie27/subscriptions", "organizations_url": "https://api.github.com/users/ollie27/orgs", "repos_url": "https://api.github.com/users/ollie27/repos", "events_url": "https://api.github.com/users/ollie27/events{/privacy}", "received_events_url": "https://api.github.com/users/ollie27/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "965888adc20f46799f382065142dbb0e27905d9c", "url": "https://api.github.com/repos/rust-lang/rust/commits/965888adc20f46799f382065142dbb0e27905d9c", "html_url": "https://github.com/rust-lang/rust/commit/965888adc20f46799f382065142dbb0e27905d9c"}], "stats": {"total": 42, "additions": 21, "deletions": 21}, "files": [{"sha": "66fd2985cb4593ae3b35a33c51c1e93023467a89", "filename": "src/bootstrap/test.rs", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/3f58ab6e24af34265229f701d48eb240cc06d751/src%2Fbootstrap%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3f58ab6e24af34265229f701d48eb240cc06d751/src%2Fbootstrap%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Ftest.rs?ref=3f58ab6e24af34265229f701d48eb240cc06d751", "patch": "@@ -607,7 +607,6 @@ impl Step for RustdocTheme {\n \n #[derive(Debug, Copy, Clone, Hash, PartialEq, Eq)]\n pub struct RustdocJSStd {\n-    pub host: Interned<String>,\n     pub target: Interned<String>,\n }\n \n@@ -621,13 +620,16 @@ impl Step for RustdocJSStd {\n     }\n \n     fn make_run(run: RunConfig<'_>) {\n-        run.builder.ensure(RustdocJSStd { host: run.host, target: run.target });\n+        run.builder.ensure(RustdocJSStd { target: run.target });\n     }\n \n     fn run(self, builder: &Builder<'_>) {\n         if let Some(ref nodejs) = builder.config.nodejs {\n             let mut command = Command::new(nodejs);\n-            command.args(&[\"src/tools/rustdoc-js-std/tester.js\", &*self.host]);\n+            command\n+                .arg(builder.src.join(\"src/tools/rustdoc-js-std/tester.js\"))\n+                .arg(builder.doc_out(self.target))\n+                .arg(builder.src.join(\"src/test/rustdoc-js-std\"));\n             builder.ensure(crate::doc::Std { target: self.target, stage: builder.top_stage });\n             builder.run(&mut command);\n         } else {"}, {"sha": "b72963addc49342c77add4950f9d00ed58ef2d0f", "filename": "src/tools/compiletest/src/runtest.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/3f58ab6e24af34265229f701d48eb240cc06d751/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3f58ab6e24af34265229f701d48eb240cc06d751/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Fcompiletest%2Fsrc%2Fruntest.rs?ref=3f58ab6e24af34265229f701d48eb240cc06d751", "patch": "@@ -2779,7 +2779,7 @@ impl<'test> TestCx<'test> {\n                 Command::new(&nodejs)\n                     .arg(root.join(\"src/tools/rustdoc-js/tester.js\"))\n                     .arg(out_dir.parent().expect(\"no parent\"))\n-                    .arg(&self.testpaths.file.file_stem().expect(\"couldn't get file stem\")),\n+                    .arg(self.testpaths.file.with_extension(\"js\")),\n             );\n             if !res.status.success() {\n                 self.fatal_proc_rec(\"rustdoc-js test failed!\", &res);"}, {"sha": "19cf0483b762470d02a9e5537e2884329e05a74e", "filename": "src/tools/rustdoc-js-std/tester.js", "status": "modified", "additions": 10, "deletions": 12, "changes": 22, "blob_url": "https://github.com/rust-lang/rust/blob/3f58ab6e24af34265229f701d48eb240cc06d751/src%2Ftools%2Frustdoc-js-std%2Ftester.js", "raw_url": "https://github.com/rust-lang/rust/raw/3f58ab6e24af34265229f701d48eb240cc06d751/src%2Ftools%2Frustdoc-js-std%2Ftester.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Frustdoc-js-std%2Ftester.js?ref=3f58ab6e24af34265229f701d48eb240cc06d751", "patch": "@@ -1,6 +1,5 @@\n const fs = require('fs');\n-\n-const TEST_FOLDER = 'src/test/rustdoc-js-std/';\n+const path = require('path');\n \n function getNextStep(content, pos, stop) {\n     while (pos < content.length && content[pos] !== stop &&\n@@ -246,17 +245,16 @@ function readFileMatching(dir, name, extension) {\n }\n \n function main(argv) {\n-    if (argv.length !== 3) {\n-        console.error(\"Expected toolchain to check as argument (for example \\\n-                       'x86_64-apple-darwin')\");\n+    if (argv.length !== 4) {\n+        console.error(\"USAGE: node tester.js STD_DOCS TEST_FOLDER\");\n         return 1;\n     }\n-    var toolchain = argv[2];\n+    var std_docs = argv[2];\n+    var test_folder = argv[3];\n \n-    var mainJs = readFileMatching(\"build/\" + toolchain + \"/doc/\", \"main\", \".js\");\n-    var ALIASES = readFileMatching(\"build/\" + toolchain + \"/doc/\", \"aliases\", \".js\");\n-    var searchIndex = readFileMatching(\"build/\" + toolchain + \"/doc/\",\n-                                       \"search-index\", \".js\").split(\"\\n\");\n+    var mainJs = readFileMatching(std_docs, \"main\", \".js\");\n+    var ALIASES = readFileMatching(std_docs, \"aliases\", \".js\");\n+    var searchIndex = readFileMatching(std_docs, \"search-index\", \".js\").split(\"\\n\");\n     if (searchIndex[searchIndex.length - 1].length === 0) {\n         searchIndex.pop();\n     }\n@@ -287,8 +285,8 @@ function main(argv) {\n \n     var errors = 0;\n \n-    fs.readdirSync(TEST_FOLDER).forEach(function(file) {\n-        var loadedFile = loadContent(readFile(TEST_FOLDER + file) +\n+    fs.readdirSync(test_folder).forEach(function(file) {\n+        var loadedFile = loadContent(readFile(path.join(test_folder, file)) +\n                                'exports.QUERY = QUERY;exports.EXPECTED = EXPECTED;');\n         const expected = loadedFile.EXPECTED;\n         const query = loadedFile.QUERY;"}, {"sha": "7174474be1c2ba936b20a8d2d5d0694446079c4d", "filename": "src/tools/rustdoc-js/tester.js", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/3f58ab6e24af34265229f701d48eb240cc06d751/src%2Ftools%2Frustdoc-js%2Ftester.js", "raw_url": "https://github.com/rust-lang/rust/raw/3f58ab6e24af34265229f701d48eb240cc06d751/src%2Ftools%2Frustdoc-js%2Ftester.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Frustdoc-js%2Ftester.js?ref=3f58ab6e24af34265229f701d48eb240cc06d751", "patch": "@@ -1,8 +1,7 @@\n const fs = require('fs');\n+const path = require('path');\n const { spawnSync } = require('child_process');\n \n-const TEST_FOLDER = 'src/test/rustdoc-js/';\n-\n function getNextStep(content, pos, stop) {\n     while (pos < content.length && content[pos] !== stop &&\n            (content[pos] === ' ' || content[pos] === '\\t' || content[pos] === '\\n')) {\n@@ -266,10 +265,11 @@ function main(argv) {\n     var errors = 0;\n \n     for (var j = 3; j < argv.length; ++j) {\n-        const test_name = argv[j];\n+        const test_file = argv[j];\n+        const test_name = path.basename(test_file, \".js\");\n \n         process.stdout.write('Checking \"' + test_name + '\" ... ');\n-        if (!fs.existsSync(TEST_FOLDER + test_name + \".js\")) {\n+        if (!fs.existsSync(test_file)) {\n             errors += 1;\n             console.error(\"FAILED\");\n             console.error(\"==> Missing '\" + test_name + \".js' file...\");\n@@ -279,7 +279,7 @@ function main(argv) {\n         const test_out_folder = out_folder + test_name;\n \n         var [loaded, index] = load_files(test_out_folder, test_name);\n-        var loadedFile = loadContent(readFile(TEST_FOLDER + test_name + \".js\") +\n+        var loadedFile = loadContent(readFile(test_file) +\n                                'exports.QUERY = QUERY;exports.EXPECTED = EXPECTED;');\n         const expected = loadedFile.EXPECTED;\n         const query = loadedFile.QUERY;"}]}