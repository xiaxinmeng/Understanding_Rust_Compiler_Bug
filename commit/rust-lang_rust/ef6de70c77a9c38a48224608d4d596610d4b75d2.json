{"sha": "ef6de70c77a9c38a48224608d4d596610d4b75d2", "node_id": "C_kwDOAAsO6NoAKGVmNmRlNzBjNzdhOWMzOGE0ODIyNDYwOGQ0ZDU5NjYxMGQ0Yjc1ZDI", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2023-02-15T06:54:56Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-02-15T06:54:56Z"}, "message": "Rollup merge of #108060 - ChrisDenton:rtlgenrandom, r=thomcc\n\nRevert to using `RtlGenRandom` as a fallback\n\nThis is required due to `BCryptGenRandom` failing to load a dll it depends on.\n\nFixes #108059", "tree": {"sha": "4a731fc16cc7bd074c47f670e1d79696c576c9ce", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4a731fc16cc7bd074c47f670e1d79696c576c9ce"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ef6de70c77a9c38a48224608d4d596610d4b75d2", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJj7IHACRBK7hj4Ov3rIwAA3dwIAKJr9FdaqMYQdL6kCYD2DFBk\nurE/rNsL7RQj9W7twfy6oE6XEFF0GmUyPGhWhZH5Yv7Sgex9LbmNZRso5DGtVETf\nX3YWlJjRx52gHD3eGUR5sifrFRBJQGcJCf9SlO83wfwXVG/483yD5A/Wiyv8KnBq\nxA+Jl4vz1HUlRweiv6pZm4VTO3ycGttSxtWJrMkF4G4Agvp8SrNVpK6ifagcsSsZ\nuytvQ6BczDk3mYFzw2PVMOHgygI1+DNpuRD8US34oDpBIHU9TvSgIpti45PYip+a\nSJaxAkfYRER/C/dvnZPMRTt6AI7ix4oLIxD71vGrVmSCf85Ue3fHMoq4QA5otz4=\n=BakX\n-----END PGP SIGNATURE-----\n", "payload": "tree 4a731fc16cc7bd074c47f670e1d79696c576c9ce\nparent 504225c0a705900f2f1c7b44f8a79ea32198981d\nparent dfd0afb991d4bfbd6fdf86adb631e428c185ac89\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1676444096 +0530\ncommitter GitHub <noreply@github.com> 1676444096 +0530\n\nRollup merge of #108060 - ChrisDenton:rtlgenrandom, r=thomcc\n\nRevert to using `RtlGenRandom` as a fallback\n\nThis is required due to `BCryptGenRandom` failing to load a dll it depends on.\n\nFixes #108059\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ef6de70c77a9c38a48224608d4d596610d4b75d2", "html_url": "https://github.com/rust-lang/rust/commit/ef6de70c77a9c38a48224608d4d596610d4b75d2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ef6de70c77a9c38a48224608d4d596610d4b75d2/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "504225c0a705900f2f1c7b44f8a79ea32198981d", "url": "https://api.github.com/repos/rust-lang/rust/commits/504225c0a705900f2f1c7b44f8a79ea32198981d", "html_url": "https://github.com/rust-lang/rust/commit/504225c0a705900f2f1c7b44f8a79ea32198981d"}, {"sha": "dfd0afb991d4bfbd6fdf86adb631e428c185ac89", "url": "https://api.github.com/repos/rust-lang/rust/commits/dfd0afb991d4bfbd6fdf86adb631e428c185ac89", "html_url": "https://github.com/rust-lang/rust/commit/dfd0afb991d4bfbd6fdf86adb631e428c185ac89"}], "stats": {"total": 134, "additions": 31, "deletions": 103}, "files": [{"sha": "f58dcf1287bef02b2c4e9bb19d90782b7c1d04eb", "filename": "library/std/src/sys/windows/c.rs", "status": "modified", "additions": 4, "deletions": 9, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/ef6de70c77a9c38a48224608d4d596610d4b75d2/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ef6de70c77a9c38a48224608d4d596610d4b75d2/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Fc.rs?ref=ef6de70c77a9c38a48224608d4d596610d4b75d2", "patch": "@@ -295,8 +295,6 @@ pub fn nt_success(status: NTSTATUS) -> bool {\n     status >= 0\n }\n \n-// \"RNG\\0\"\n-pub const BCRYPT_RNG_ALGORITHM: &[u16] = &[b'R' as u16, b'N' as u16, b'G' as u16, 0];\n pub const BCRYPT_USE_SYSTEM_PREFERRED_RNG: DWORD = 0x00000002;\n \n #[repr(C)]\n@@ -834,6 +832,10 @@ if #[cfg(not(target_vendor = \"uwp\"))] {\n \n     #[link(name = \"advapi32\")]\n     extern \"system\" {\n+        // Forbidden when targeting UWP\n+        #[link_name = \"SystemFunction036\"]\n+        pub fn RtlGenRandom(RandomBuffer: *mut u8, RandomBufferLength: ULONG) -> BOOLEAN;\n+\n         // Allowed but unused by UWP\n         pub fn OpenProcessToken(\n             ProcessHandle: HANDLE,\n@@ -1258,13 +1260,6 @@ extern \"system\" {\n         cbBuffer: ULONG,\n         dwFlags: ULONG,\n     ) -> NTSTATUS;\n-    pub fn BCryptOpenAlgorithmProvider(\n-        phalgorithm: *mut BCRYPT_ALG_HANDLE,\n-        pszAlgId: LPCWSTR,\n-        pszimplementation: LPCWSTR,\n-        dwflags: ULONG,\n-    ) -> NTSTATUS;\n-    pub fn BCryptCloseAlgorithmProvider(hAlgorithm: BCRYPT_ALG_HANDLE, dwFlags: ULONG) -> NTSTATUS;\n }\n \n // Functions that aren't available on every version of Windows that we support,"}, {"sha": "cdf37cfe9117bfaffbaa29a3d38092b6eafd3ce1", "filename": "library/std/src/sys/windows/rand.rs", "status": "modified", "additions": 27, "deletions": 94, "changes": 121, "blob_url": "https://github.com/rust-lang/rust/blob/ef6de70c77a9c38a48224608d4d596610d4b75d2/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Frand.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ef6de70c77a9c38a48224608d4d596610d4b75d2/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Frand.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Fwindows%2Frand.rs?ref=ef6de70c77a9c38a48224608d4d596610d4b75d2", "patch": "@@ -1,106 +1,39 @@\n-//! # Random key generation\n-//!\n-//! This module wraps the RNG provided by the OS. There are a few different\n-//! ways to interface with the OS RNG so it's worth exploring each of the options.\n-//! Note that at the time of writing these all go through the (undocumented)\n-//! `bcryptPrimitives.dll` but they use different route to get there.\n-//!\n-//! Originally we were using [`RtlGenRandom`], however that function is\n-//! deprecated and warns it \"may be altered or unavailable in subsequent versions\".\n-//!\n-//! So we switched to [`BCryptGenRandom`] with the `BCRYPT_USE_SYSTEM_PREFERRED_RNG`\n-//! flag to query and find the system configured RNG. However, this change caused a small\n-//! but significant number of users to experience panics caused by a failure of\n-//! this function. See [#94098].\n-//!\n-//! The current version falls back to using `BCryptOpenAlgorithmProvider` if\n-//! `BCRYPT_USE_SYSTEM_PREFERRED_RNG` fails for any reason.\n-//!\n-//! [#94098]: https://github.com/rust-lang/rust/issues/94098\n-//! [`RtlGenRandom`]: https://docs.microsoft.com/en-us/windows/win32/api/ntsecapi/nf-ntsecapi-rtlgenrandom\n-//! [`BCryptGenRandom`]: https://docs.microsoft.com/en-us/windows/win32/api/bcrypt/nf-bcrypt-bcryptgenrandom\n+use crate::io;\n use crate::mem;\n use crate::ptr;\n use crate::sys::c;\n \n-/// Generates high quality secure random keys for use by [`HashMap`].\n-///\n-/// This is used to seed the default [`RandomState`].\n-///\n-/// [`HashMap`]: crate::collections::HashMap\n-/// [`RandomState`]: crate::collections::hash_map::RandomState\n pub fn hashmap_random_keys() -> (u64, u64) {\n-    Rng::SYSTEM.gen_random_keys().unwrap_or_else(fallback_rng)\n+    let mut v = (0, 0);\n+    let ret = unsafe {\n+        c::BCryptGenRandom(\n+            ptr::null_mut(),\n+            &mut v as *mut _ as *mut u8,\n+            mem::size_of_val(&v) as c::ULONG,\n+            c::BCRYPT_USE_SYSTEM_PREFERRED_RNG,\n+        )\n+    };\n+    if c::nt_success(ret) { v } else { fallback_rng() }\n }\n \n-struct Rng {\n-    algorithm: c::BCRYPT_ALG_HANDLE,\n-    flags: u32,\n-}\n-impl Rng {\n-    const SYSTEM: Self = unsafe { Self::new(ptr::null_mut(), c::BCRYPT_USE_SYSTEM_PREFERRED_RNG) };\n-\n-    /// Create the RNG from an existing algorithm handle.\n-    ///\n-    /// # Safety\n-    ///\n-    /// The handle must either be null or a valid algorithm handle.\n-    const unsafe fn new(algorithm: c::BCRYPT_ALG_HANDLE, flags: u32) -> Self {\n-        Self { algorithm, flags }\n-    }\n-\n-    /// Open a handle to the RNG algorithm.\n-    fn open() -> Result<Self, c::NTSTATUS> {\n-        use crate::sync::atomic::AtomicPtr;\n-        use crate::sync::atomic::Ordering::{Acquire, Release};\n-\n-        // An atomic is used so we don't need to reopen the handle every time.\n-        static HANDLE: AtomicPtr<crate::ffi::c_void> = AtomicPtr::new(ptr::null_mut());\n-\n-        let mut handle = HANDLE.load(Acquire);\n-        if handle.is_null() {\n-            let status = unsafe {\n-                c::BCryptOpenAlgorithmProvider(\n-                    &mut handle,\n-                    c::BCRYPT_RNG_ALGORITHM.as_ptr(),\n-                    ptr::null(),\n-                    0,\n-                )\n-            };\n-            if c::nt_success(status) {\n-                // If another thread opens a handle first then use that handle instead.\n-                let result = HANDLE.compare_exchange(ptr::null_mut(), handle, Release, Acquire);\n-                if let Err(previous_handle) = result {\n-                    // Close our handle and return the previous one.\n-                    unsafe { c::BCryptCloseAlgorithmProvider(handle, 0) };\n-                    handle = previous_handle;\n-                }\n-                Ok(unsafe { Self::new(handle, 0) })\n-            } else {\n-                Err(status)\n-            }\n-        } else {\n-            Ok(unsafe { Self::new(handle, 0) })\n-        }\n-    }\n+/// Generate random numbers using the fallback RNG function (RtlGenRandom)\n+///\n+/// This is necessary because of a failure to load the SysWOW64 variant of the\n+/// bcryptprimitives.dll library from code that lives in bcrypt.dll\n+/// See <https://bugzilla.mozilla.org/show_bug.cgi?id=1788004#c9>\n+#[cfg(not(target_vendor = \"uwp\"))]\n+#[inline(never)]\n+fn fallback_rng() -> (u64, u64) {\n+    let mut v = (0, 0);\n+    let ret =\n+        unsafe { c::RtlGenRandom(&mut v as *mut _ as *mut u8, mem::size_of_val(&v) as c::ULONG) };\n \n-    fn gen_random_keys(self) -> Result<(u64, u64), c::NTSTATUS> {\n-        let mut v = (0, 0);\n-        let status = unsafe {\n-            let size = mem::size_of_val(&v).try_into().unwrap();\n-            c::BCryptGenRandom(self.algorithm, ptr::addr_of_mut!(v).cast(), size, self.flags)\n-        };\n-        if c::nt_success(status) { Ok(v) } else { Err(status) }\n-    }\n+    if ret != 0 { v } else { panic!(\"fallback RNG broken: {}\", io::Error::last_os_error()) }\n }\n \n-/// Generate random numbers using the fallback RNG function\n+/// We can't use RtlGenRandom with UWP, so there is no fallback\n+#[cfg(target_vendor = \"uwp\")]\n #[inline(never)]\n-fn fallback_rng(rng_status: c::NTSTATUS) -> (u64, u64) {\n-    match Rng::open().and_then(|rng| rng.gen_random_keys()) {\n-        Ok(keys) => keys,\n-        Err(status) => {\n-            panic!(\"RNG broken: {rng_status:#x}, fallback RNG broken: {status:#x}\")\n-        }\n-    }\n+fn fallback_rng() -> (u64, u64) {\n+    panic!(\"fallback RNG broken: RtlGenRandom() not supported on UWP\");\n }"}]}