{"sha": "12df6384b9bf0164396385187da5f7e7a60897a7", "node_id": "MDY6Q29tbWl0NzI0NzEyOjEyZGY2Mzg0YjliZjAxNjQzOTYzODUxODdkYTVmN2U3YTYwODk3YTc=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-07-14T09:13:58Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-07-14T09:13:58Z"}, "message": "Auto merge of #5773 - giraffate:repeat_once, r=flip1995\n\nAdd a lint for `.repeat(1)`\n\nchangelog: New lint `repeat_once`\n\nfix #3028.", "tree": {"sha": "fbe8bc20765d1e6a6fa21a795c48b362bc7c59ce", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/fbe8bc20765d1e6a6fa21a795c48b362bc7c59ce"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/12df6384b9bf0164396385187da5f7e7a60897a7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/12df6384b9bf0164396385187da5f7e7a60897a7", "html_url": "https://github.com/rust-lang/rust/commit/12df6384b9bf0164396385187da5f7e7a60897a7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/12df6384b9bf0164396385187da5f7e7a60897a7/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "4b8700879c59d1673dc36ea16aff3020af23dcc5", "url": "https://api.github.com/repos/rust-lang/rust/commits/4b8700879c59d1673dc36ea16aff3020af23dcc5", "html_url": "https://github.com/rust-lang/rust/commit/4b8700879c59d1673dc36ea16aff3020af23dcc5"}, {"sha": "b4091032abbadf586ea8c77bc547ec2ac403ef0a", "url": "https://api.github.com/repos/rust-lang/rust/commits/b4091032abbadf586ea8c77bc547ec2ac403ef0a", "html_url": "https://github.com/rust-lang/rust/commit/b4091032abbadf586ea8c77bc547ec2ac403ef0a"}], "stats": {"total": 167, "additions": 167, "deletions": 0}, "files": [{"sha": "5d08b44ba404f9294f0b45973e017e571c208058", "filename": "CHANGELOG.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/12df6384b9bf0164396385187da5f7e7a60897a7/CHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/12df6384b9bf0164396385187da5f7e7a60897a7/CHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/CHANGELOG.md?ref=12df6384b9bf0164396385187da5f7e7a60897a7", "patch": "@@ -1617,6 +1617,7 @@ Released 2018-09-13\n [`redundant_static_lifetimes`]: https://rust-lang.github.io/rust-clippy/master/index.html#redundant_static_lifetimes\n [`ref_in_deref`]: https://rust-lang.github.io/rust-clippy/master/index.html#ref_in_deref\n [`regex_macro`]: https://rust-lang.github.io/rust-clippy/master/index.html#regex_macro\n+[`repeat_once`]: https://rust-lang.github.io/rust-clippy/master/index.html#repeat_once\n [`replace_consts`]: https://rust-lang.github.io/rust-clippy/master/index.html#replace_consts\n [`rest_pat_in_fully_bound_structs`]: https://rust-lang.github.io/rust-clippy/master/index.html#rest_pat_in_fully_bound_structs\n [`result_map_or_into_option`]: https://rust-lang.github.io/rust-clippy/master/index.html#result_map_or_into_option"}, {"sha": "32e79317f82254119bf9b3075ef15f3b827f3ea7", "filename": "clippy_lints/src/lib.rs", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/12df6384b9bf0164396385187da5f7e7a60897a7/clippy_lints%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/12df6384b9bf0164396385187da5f7e7a60897a7/clippy_lints%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Flib.rs?ref=12df6384b9bf0164396385187da5f7e7a60897a7", "patch": "@@ -281,6 +281,7 @@ mod redundant_pub_crate;\n mod redundant_static_lifetimes;\n mod reference;\n mod regex;\n+mod repeat_once;\n mod returns;\n mod serde_api;\n mod shadow;\n@@ -764,6 +765,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n         &reference::REF_IN_DEREF,\n         &regex::INVALID_REGEX,\n         &regex::TRIVIAL_REGEX,\n+        &repeat_once::REPEAT_ONCE,\n         &returns::NEEDLESS_RETURN,\n         &returns::UNUSED_UNIT,\n         &serde_api::SERDE_API_MISUSE,\n@@ -1070,6 +1072,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n     store.register_late_pass(|| box macro_use::MacroUseImports::default());\n     store.register_late_pass(|| box map_identity::MapIdentity);\n     store.register_late_pass(|| box pattern_type_mismatch::PatternTypeMismatch);\n+    store.register_late_pass(|| box repeat_once::RepeatOnce);\n \n     store.register_group(true, \"clippy::restriction\", Some(\"clippy_restriction\"), vec![\n         LintId::of(&arithmetic::FLOAT_ARITHMETIC),\n@@ -1393,6 +1396,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n         LintId::of(&reference::REF_IN_DEREF),\n         LintId::of(&regex::INVALID_REGEX),\n         LintId::of(&regex::TRIVIAL_REGEX),\n+        LintId::of(&repeat_once::REPEAT_ONCE),\n         LintId::of(&returns::NEEDLESS_RETURN),\n         LintId::of(&returns::UNUSED_UNIT),\n         LintId::of(&serde_api::SERDE_API_MISUSE),\n@@ -1602,6 +1606,7 @@ pub fn register_plugins(store: &mut rustc_lint::LintStore, sess: &Session, conf:\n         LintId::of(&ranges::RANGE_ZIP_WITH_LEN),\n         LintId::of(&reference::DEREF_ADDROF),\n         LintId::of(&reference::REF_IN_DEREF),\n+        LintId::of(&repeat_once::REPEAT_ONCE),\n         LintId::of(&swap::MANUAL_SWAP),\n         LintId::of(&temporary_assignment::TEMPORARY_ASSIGNMENT),\n         LintId::of(&transmute::CROSSPOINTER_TRANSMUTE),"}, {"sha": "a3af369e41e5a1d72429f77735fb7dac41ac500c", "filename": "clippy_lints/src/repeat_once.rs", "status": "added", "additions": 82, "deletions": 0, "changes": 82, "blob_url": "https://github.com/rust-lang/rust/blob/12df6384b9bf0164396385187da5f7e7a60897a7/clippy_lints%2Fsrc%2Frepeat_once.rs", "raw_url": "https://github.com/rust-lang/rust/raw/12df6384b9bf0164396385187da5f7e7a60897a7/clippy_lints%2Fsrc%2Frepeat_once.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_lints%2Fsrc%2Frepeat_once.rs?ref=12df6384b9bf0164396385187da5f7e7a60897a7", "patch": "@@ -0,0 +1,82 @@\n+use crate::consts::{constant_context, Constant};\n+use crate::utils::{in_macro, is_type_diagnostic_item, snippet, span_lint_and_sugg, walk_ptrs_ty};\n+use if_chain::if_chain;\n+use rustc_errors::Applicability;\n+use rustc_hir::{Expr, ExprKind};\n+use rustc_lint::{LateContext, LateLintPass};\n+use rustc_session::{declare_lint_pass, declare_tool_lint};\n+\n+declare_clippy_lint! {\n+    /// **What it does:** Checks for usage of `.repeat(1)` and suggest the following method for each types.\n+    /// - `.to_string()` for `str`\n+    /// - `.clone()` for `String`\n+    /// - `.to_vec()` for `slice`\n+    ///\n+    /// **Why is this bad?** For example, `String.repeat(1)` is equivalent to `.clone()`. If cloning the string is the intention behind this, `clone()` should be used.\n+    ///\n+    /// **Known problems:** None.\n+    ///\n+    /// **Example:**\n+    ///\n+    /// ```rust\n+    /// fn main() {\n+    ///     let x = String::from(\"hello world\").repeat(1);\n+    /// }\n+    /// ```\n+    /// Use instead:\n+    /// ```rust\n+    /// fn main() {\n+    ///     let x = String::from(\"hello world\").clone();\n+    /// }\n+    /// ```\n+    pub REPEAT_ONCE,\n+    complexity,\n+    \"using `.repeat(1)` instead of `String.clone()`, `str.to_string()` or `slice.to_vec()` \"\n+}\n+\n+declare_lint_pass!(RepeatOnce => [REPEAT_ONCE]);\n+\n+impl<'tcx> LateLintPass<'tcx> for RepeatOnce {\n+    fn check_expr(&mut self, cx: &LateContext<'_>, expr: &'tcx Expr<'_>) {\n+        if_chain! {\n+            if let ExprKind::MethodCall(ref path, _, ref args, _) = expr.kind;\n+            if path.ident.name == sym!(repeat);\n+            if let Some(Constant::Int(1)) = constant_context(cx, cx.tables()).expr(&args[1]);\n+            if !in_macro(args[0].span);\n+            then {\n+                let ty = walk_ptrs_ty(cx.tables().expr_ty(&args[0]));\n+                if ty.is_str() {\n+                    span_lint_and_sugg(\n+                        cx,\n+                        REPEAT_ONCE,\n+                        expr.span,\n+                        \"calling `repeat(1)` on str\",\n+                        \"consider using `.to_string()` instead\",\n+                        format!(\"{}.to_string()\", snippet(cx, args[0].span, r#\"\"...\"\"#)),\n+                        Applicability::MachineApplicable,\n+                    );\n+                } else if ty.builtin_index().is_some() {\n+                    span_lint_and_sugg(\n+                        cx,\n+                        REPEAT_ONCE,\n+                        expr.span,\n+                        \"calling `repeat(1)` on slice\",\n+                        \"consider using `.to_vec()` instead\",\n+                        format!(\"{}.to_vec()\", snippet(cx, args[0].span, r#\"\"...\"\"#)),\n+                        Applicability::MachineApplicable,\n+                    );\n+                } else if is_type_diagnostic_item(cx, ty, sym!(string_type)) {\n+                    span_lint_and_sugg(\n+                        cx,\n+                        REPEAT_ONCE,\n+                        expr.span,\n+                        \"calling `repeat(1)` on a string literal\",\n+                        \"consider using `.clone()` instead\",\n+                        format!(\"{}.clone()\", snippet(cx, args[0].span, r#\"\"...\"\"#)),\n+                        Applicability::MachineApplicable,\n+                    );\n+                }\n+            }\n+        }\n+    }\n+}"}, {"sha": "b89a87128626bc927db31c27665d220c452c52fd", "filename": "src/lintlist/mod.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/12df6384b9bf0164396385187da5f7e7a60897a7/src%2Flintlist%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/12df6384b9bf0164396385187da5f7e7a60897a7/src%2Flintlist%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flintlist%2Fmod.rs?ref=12df6384b9bf0164396385187da5f7e7a60897a7", "patch": "@@ -1886,6 +1886,13 @@ pub static ref ALL_LINTS: Vec<Lint> = vec![\n         deprecation: None,\n         module: \"reference\",\n     },\n+    Lint {\n+        name: \"repeat_once\",\n+        group: \"complexity\",\n+        desc: \"using `.repeat(1)` instead of `String.clone()`, `str.to_string()` or `slice.to_vec()` \",\n+        deprecation: None,\n+        module: \"repeat_once\",\n+    },\n     Lint {\n         name: \"rest_pat_in_fully_bound_structs\",\n         group: \"restriction\","}, {"sha": "a637c22fbcd266211e9247df2ac21c2b14b3dd56", "filename": "tests/ui/repeat_once.fixed", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/12df6384b9bf0164396385187da5f7e7a60897a7/tests%2Fui%2Frepeat_once.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/12df6384b9bf0164396385187da5f7e7a60897a7/tests%2Fui%2Frepeat_once.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Frepeat_once.fixed?ref=12df6384b9bf0164396385187da5f7e7a60897a7", "patch": "@@ -0,0 +1,16 @@\n+// run-rustfix\n+#![warn(clippy::repeat_once)]\n+#[allow(unused, clippy::many_single_char_names, clippy::redundant_clone)]\n+fn main() {\n+    const N: usize = 1;\n+    let s = \"str\";\n+    let string = \"String\".to_string();\n+    let slice = [1; 5];\n+\n+    let a = [1; 5].to_vec();\n+    let b = slice.to_vec();\n+    let c = \"hello\".to_string();\n+    let d = \"hi\".to_string();\n+    let e = s.to_string();\n+    let f = string.clone();\n+}"}, {"sha": "d99ca1b5b55d4200df4831fa22074cc3f2ce39cb", "filename": "tests/ui/repeat_once.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/12df6384b9bf0164396385187da5f7e7a60897a7/tests%2Fui%2Frepeat_once.rs", "raw_url": "https://github.com/rust-lang/rust/raw/12df6384b9bf0164396385187da5f7e7a60897a7/tests%2Fui%2Frepeat_once.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Frepeat_once.rs?ref=12df6384b9bf0164396385187da5f7e7a60897a7", "patch": "@@ -0,0 +1,16 @@\n+// run-rustfix\n+#![warn(clippy::repeat_once)]\n+#[allow(unused, clippy::many_single_char_names, clippy::redundant_clone)]\n+fn main() {\n+    const N: usize = 1;\n+    let s = \"str\";\n+    let string = \"String\".to_string();\n+    let slice = [1; 5];\n+\n+    let a = [1; 5].repeat(1);\n+    let b = slice.repeat(1);\n+    let c = \"hello\".repeat(N);\n+    let d = \"hi\".repeat(1);\n+    let e = s.repeat(1);\n+    let f = string.repeat(1);\n+}"}, {"sha": "915eea3bfc6b8fbec2a4c74c55b4126602aaccab", "filename": "tests/ui/repeat_once.stderr", "status": "added", "additions": 40, "deletions": 0, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/12df6384b9bf0164396385187da5f7e7a60897a7/tests%2Fui%2Frepeat_once.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/12df6384b9bf0164396385187da5f7e7a60897a7/tests%2Fui%2Frepeat_once.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Frepeat_once.stderr?ref=12df6384b9bf0164396385187da5f7e7a60897a7", "patch": "@@ -0,0 +1,40 @@\n+error: calling `repeat(1)` on slice\n+  --> $DIR/repeat_once.rs:10:13\n+   |\n+LL |     let a = [1; 5].repeat(1);\n+   |             ^^^^^^^^^^^^^^^^ help: consider using `.to_vec()` instead: `[1; 5].to_vec()`\n+   |\n+   = note: `-D clippy::repeat-once` implied by `-D warnings`\n+\n+error: calling `repeat(1)` on slice\n+  --> $DIR/repeat_once.rs:11:13\n+   |\n+LL |     let b = slice.repeat(1);\n+   |             ^^^^^^^^^^^^^^^ help: consider using `.to_vec()` instead: `slice.to_vec()`\n+\n+error: calling `repeat(1)` on str\n+  --> $DIR/repeat_once.rs:12:13\n+   |\n+LL |     let c = \"hello\".repeat(N);\n+   |             ^^^^^^^^^^^^^^^^^ help: consider using `.to_string()` instead: `\"hello\".to_string()`\n+\n+error: calling `repeat(1)` on str\n+  --> $DIR/repeat_once.rs:13:13\n+   |\n+LL |     let d = \"hi\".repeat(1);\n+   |             ^^^^^^^^^^^^^^ help: consider using `.to_string()` instead: `\"hi\".to_string()`\n+\n+error: calling `repeat(1)` on str\n+  --> $DIR/repeat_once.rs:14:13\n+   |\n+LL |     let e = s.repeat(1);\n+   |             ^^^^^^^^^^^ help: consider using `.to_string()` instead: `s.to_string()`\n+\n+error: calling `repeat(1)` on a string literal\n+  --> $DIR/repeat_once.rs:15:13\n+   |\n+LL |     let f = string.repeat(1);\n+   |             ^^^^^^^^^^^^^^^^ help: consider using `.clone()` instead: `string.clone()`\n+\n+error: aborting due to 6 previous errors\n+"}]}