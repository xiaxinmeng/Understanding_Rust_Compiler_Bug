{"sha": "7c14a54bc81d8e259b43ac8077f2e851c7769753", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdjMTRhNTRiYzgxZDhlMjU5YjQzYWM4MDc3ZjJlODUxYzc3Njk3NTM=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2018-05-23T02:40:02Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2018-05-30T12:58:23Z"}, "message": "Replace libbacktrace with a submodule\n\nWhile we're at it update the `backtrace` crate from crates.io. It turns out that\nthe submodule's configure script has gotten a lot more finnicky as of late so\nalso switch over to using the `cc` crate manually which allows to avoid some\nhacks around the configure script as well", "tree": {"sha": "b2fcc538cd809201463f1ac15c92708bbc0511a2", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b2fcc538cd809201463f1ac15c92708bbc0511a2"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7c14a54bc81d8e259b43ac8077f2e851c7769753", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7c14a54bc81d8e259b43ac8077f2e851c7769753", "html_url": "https://github.com/rust-lang/rust/commit/7c14a54bc81d8e259b43ac8077f2e851c7769753", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7c14a54bc81d8e259b43ac8077f2e851c7769753/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "1402a106bd66b88750f3cd255eb77451c3f432e6", "url": "https://api.github.com/repos/rust-lang/rust/commits/1402a106bd66b88750f3cd255eb77451c3f432e6", "html_url": "https://github.com/rust-lang/rust/commit/1402a106bd66b88750f3cd255eb77451c3f432e6"}], "stats": {"total": 89, "additions": 63, "deletions": 26}, "files": [{"sha": "f3eb902709ca7167699e2c46eb6092a506774e10", "filename": ".gitmodules", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/7c14a54bc81d8e259b43ac8077f2e851c7769753/.gitmodules", "raw_url": "https://github.com/rust-lang/rust/raw/7c14a54bc81d8e259b43ac8077f2e851c7769753/.gitmodules", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/.gitmodules?ref=7c14a54bc81d8e259b43ac8077f2e851c7769753", "patch": "@@ -53,3 +53,6 @@\n [submodule \"src/tools/lld\"]\n \tpath = src/tools/lld\n \turl = https://github.com/rust-lang/lld.git\n+[submodule \"src/libbacktrace\"]\n+\tpath = src/libbacktrace\n+\turl = https://github.com/rust-lang-nursery/libbacktrace"}, {"sha": "3a27107f825d6346bf275a5307446146a8cbec15", "filename": "src/Cargo.lock", "status": "modified", "additions": 5, "deletions": 3, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/7c14a54bc81d8e259b43ac8077f2e851c7769753/src%2FCargo.lock", "raw_url": "https://github.com/rust-lang/rust/raw/7c14a54bc81d8e259b43ac8077f2e851c7769753/src%2FCargo.lock", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2FCargo.lock?ref=7c14a54bc81d8e259b43ac8077f2e851c7769753", "patch": "@@ -105,7 +105,7 @@ name = \"backtrace\"\n version = \"0.3.6\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n dependencies = [\n- \"backtrace-sys 0.1.16 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"backtrace-sys 0.1.22 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"cfg-if 0.1.2 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"libc 0.2.40 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"rustc-demangle 0.1.7 (registry+https://github.com/rust-lang/crates.io-index)\",\n@@ -114,11 +114,12 @@ dependencies = [\n \n [[package]]\n name = \"backtrace-sys\"\n-version = \"0.1.16\"\n+version = \"0.1.22\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n dependencies = [\n  \"cc 1.0.15 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"libc 0.2.40 (registry+https://github.com/rust-lang/crates.io-index)\",\n+ \"pkg-config 0.3.9 (registry+https://github.com/rust-lang/crates.io-index)\",\n ]\n \n [[package]]\n@@ -2513,6 +2514,7 @@ dependencies = [\n  \"alloc_jemalloc 0.0.0\",\n  \"alloc_system 0.0.0\",\n  \"build_helper 0.1.0\",\n+ \"cc 1.0.15 (registry+https://github.com/rust-lang/crates.io-index)\",\n  \"compiler_builtins 0.0.0\",\n  \"core 0.0.0\",\n  \"libc 0.0.0\",\n@@ -3051,7 +3053,7 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n \"checksum assert_cli 0.6.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"5da59dbd8df54562665b925b427221ceda9b771408cb8a6cbd2125d3b001330b\"\n \"checksum atty 0.2.8 (registry+https://github.com/rust-lang/crates.io-index)\" = \"af80143d6f7608d746df1520709e5d141c96f240b0e62b0aa41bdfb53374d9d4\"\n \"checksum backtrace 0.3.6 (registry+https://github.com/rust-lang/crates.io-index)\" = \"ebbe525f66f42d207968308ee86bc2dd60aa5fab535b22e616323a173d097d8e\"\n-\"checksum backtrace-sys 0.1.16 (registry+https://github.com/rust-lang/crates.io-index)\" = \"44585761d6161b0f57afc49482ab6bd067e4edef48c12a152c237eb0203f7661\"\n+\"checksum backtrace-sys 0.1.22 (registry+https://github.com/rust-lang/crates.io-index)\" = \"5fd343a2466c4603f76f38de264bc0526cffc7fa38ba52fb9f13237eccc1ced2\"\n \"checksum bitflags 0.7.0 (registry+https://github.com/rust-lang/crates.io-index)\" = \"aad18937a628ec6abcd26d1489012cc0e18c21798210f491af69ded9b881106d\"\n \"checksum bitflags 0.9.1 (registry+https://github.com/rust-lang/crates.io-index)\" = \"4efd02e230a02e18f92fc2735f44597385ed02ad8f831e7c1c1156ee5e1ab3a5\"\n \"checksum bitflags 1.0.1 (registry+https://github.com/rust-lang/crates.io-index)\" = \"b3c30d3802dfb7281680d6285f2ccdaa8c2d8fee41f93805dba5c4cf50dc23cf\""}, {"sha": "f4d02bbdbf8a2c5a31f0801dfef597a86caad9e3", "filename": "src/libbacktrace", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": null, "raw_url": null, "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibbacktrace?ref=7c14a54bc81d8e259b43ac8077f2e851c7769753", "patch": "@@ -0,0 +1 @@\n+Subproject commit f4d02bbdbf8a2c5a31f0801dfef597a86caad9e3"}, {"sha": "5a2dce5930a4b959eac9b7b0aee6141604b175da", "filename": "src/libstd/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7c14a54bc81d8e259b43ac8077f2e851c7769753/src%2Flibstd%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/7c14a54bc81d8e259b43ac8077f2e851c7769753/src%2Flibstd%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2FCargo.toml?ref=7c14a54bc81d8e259b43ac8077f2e851c7769753", "patch": "@@ -39,6 +39,7 @@ rustc_msan = { path = \"../librustc_msan\" }\n rustc_tsan = { path = \"../librustc_tsan\" }\n \n [build-dependencies]\n+cc = \"1.0\"\n build_helper = { path = \"../build_helper\" }\n \n [features]"}, {"sha": "c34877d369c9369c27ac93ce6959225e1365778d", "filename": "src/libstd/build.rs", "status": "modified", "additions": 52, "deletions": 23, "changes": 75, "blob_url": "https://github.com/rust-lang/rust/blob/7c14a54bc81d8e259b43ac8077f2e851c7769753/src%2Flibstd%2Fbuild.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7c14a54bc81d8e259b43ac8077f2e851c7769753/src%2Flibstd%2Fbuild.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibstd%2Fbuild.rs?ref=7c14a54bc81d8e259b43ac8077f2e851c7769753", "patch": "@@ -11,22 +11,22 @@\n #![deny(warnings)]\n \n extern crate build_helper;\n+extern crate cc;\n \n+use build_helper::native_lib_boilerplate;\n use std::env;\n-use std::process::Command;\n-use build_helper::{run, native_lib_boilerplate};\n+use std::fs::File;\n \n fn main() {\n     let target = env::var(\"TARGET\").expect(\"TARGET was not set\");\n-    let host = env::var(\"HOST\").expect(\"HOST was not set\");\n     if cfg!(feature = \"backtrace\") &&\n         !target.contains(\"cloudabi\") &&\n         !target.contains(\"emscripten\") &&\n         !target.contains(\"fuchsia\") &&\n         !target.contains(\"msvc\") &&\n         !target.contains(\"wasm32\")\n     {\n-        let _ = build_libbacktrace(&host, &target);\n+        let _ = build_libbacktrace(&target);\n     }\n \n     if target.contains(\"linux\") {\n@@ -84,26 +84,55 @@ fn main() {\n     }\n }\n \n-fn build_libbacktrace(host: &str, target: &str) -> Result<(), ()> {\n-    let native = native_lib_boilerplate(\"libbacktrace\", \"libbacktrace\", \"backtrace\", \".libs\")?;\n-    let cflags = env::var(\"CFLAGS\").unwrap_or_default() + \" -fvisibility=hidden -O2\";\n+fn build_libbacktrace(target: &str) -> Result<(), ()> {\n+    let native = native_lib_boilerplate(\"libbacktrace\", \"libbacktrace\", \"backtrace\", \"\")?;\n \n-    run(Command::new(\"sh\")\n-                .current_dir(&native.out_dir)\n-                .arg(native.src_dir.join(\"configure\").to_str().unwrap()\n-                                   .replace(\"C:\\\\\", \"/c/\")\n-                                   .replace(\"\\\\\", \"/\"))\n-                .arg(\"--with-pic\")\n-                .arg(\"--disable-multilib\")\n-                .arg(\"--disable-shared\")\n-                .arg(\"--disable-host-shared\")\n-                .arg(format!(\"--host={}\", build_helper::gnu_target(target)))\n-                .arg(format!(\"--build={}\", build_helper::gnu_target(host)))\n-                .env(\"CFLAGS\", cflags));\n+    let mut build = cc::Build::new();\n+    build\n+        .flag(\"-fvisibility=hidden\")\n+        .include(\"../libbacktrace\")\n+        .include(&native.out_dir)\n+        .out_dir(&native.out_dir)\n+        .warnings(false)\n+        .file(\"../libbacktrace/alloc.c\")\n+        .file(\"../libbacktrace/backtrace.c\")\n+        .file(\"../libbacktrace/dwarf.c\")\n+        .file(\"../libbacktrace/fileline.c\")\n+        .file(\"../libbacktrace/posix.c\")\n+        .file(\"../libbacktrace/read.c\")\n+        .file(\"../libbacktrace/sort.c\")\n+        .file(\"../libbacktrace/state.c\");\n \n-    run(Command::new(build_helper::make(host))\n-                .current_dir(&native.out_dir)\n-                .arg(format!(\"INCDIR={}\", native.src_dir.display()))\n-                .arg(\"-j\").arg(env::var(\"NUM_JOBS\").expect(\"NUM_JOBS was not set\")));\n+    if target.contains(\"darwin\") {\n+        build.file(\"../libbacktrace/macho.c\");\n+    } else if target.contains(\"windows\") {\n+        build.file(\"../libbacktrace/pecoff.c\");\n+    } else {\n+        build.file(\"../libbacktrace/elf.c\");\n+\n+        if target.contains(\"64\") {\n+            build.define(\"BACKTRACE_ELF_SIZE\", \"64\");\n+        } else {\n+            build.define(\"BACKTRACE_ELF_SIZE\", \"32\");\n+        }\n+    }\n+\n+    File::create(native.out_dir.join(\"backtrace-supported.h\")).unwrap();\n+    build.define(\"BACKTRACE_SUPPORTED\", \"1\");\n+    build.define(\"BACKTRACE_USES_MALLOC\", \"1\");\n+    build.define(\"BACKTRACE_SUPPORTS_THREADS\", \"0\");\n+    build.define(\"BACKTRACE_SUPPORTS_DATA\", \"0\");\n+\n+    File::create(native.out_dir.join(\"config.h\")).unwrap();\n+    if !target.contains(\"apple-ios\") &&\n+       !target.contains(\"solaris\") &&\n+       !target.contains(\"redox\") &&\n+       !target.contains(\"android\") {\n+        build.define(\"HAVE_DL_ITERATE_PHDR\", \"1\");\n+    }\n+    build.define(\"_GNU_SOURCE\", \"1\");\n+    build.define(\"_LARGE_FILES\", \"1\");\n+\n+    build.compile(\"backtrace\");\n     Ok(())\n }"}, {"sha": "cef548b0d94da6db7df5b568f2c87a7da262cf4f", "filename": "src/tools/tidy/src/deps.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/7c14a54bc81d8e259b43ac8077f2e851c7769753/src%2Ftools%2Ftidy%2Fsrc%2Fdeps.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7c14a54bc81d8e259b43ac8077f2e851c7769753/src%2Ftools%2Ftidy%2Fsrc%2Fdeps.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftools%2Ftidy%2Fsrc%2Fdeps.rs?ref=7c14a54bc81d8e259b43ac8077f2e851c7769753", "patch": "@@ -98,6 +98,7 @@ static WHITELIST: &'static [Crate] = &[\n     Crate(\"parking_lot\"),\n     Crate(\"parking_lot_core\"),\n     Crate(\"polonius-engine\"),\n+    Crate(\"pkg-config\"),\n     Crate(\"quick-error\"),\n     Crate(\"rand\"),\n     Crate(\"redox_syscall\"),"}]}