{"sha": "8723fe0b6b6f8563c2ca0f15c83adf309e780d2a", "node_id": "C_kwDOAAsO6NoAKDg3MjNmZTBiNmI2Zjg1NjNjMmNhMGYxNWM4M2FkZjMwOWU3ODBkMmE", "commit": {"author": {"name": "Nicholas Nethercote", "email": "n.nethercote@gmail.com", "date": "2022-03-04T02:46:56Z"}, "committer": {"name": "Nicholas Nethercote", "email": "n.nethercote@gmail.com", "date": "2022-03-07T02:41:47Z"}, "message": "Clarify `Layout` interning.\n\n`Layout` is another type that is sometimes interned, sometimes not, and\nwe always use references to refer to it so we can't take any advantage\nof the uniqueness properties for hashing or equality checks.\n\nThis commit renames `Layout` as `LayoutS`, and then introduces a new\n`Layout` that is a newtype around an `Interned<LayoutS>`. It also\ninterns more layouts than before. Previously layouts within layouts\n(via the `variants` field) were never interned, but now they are. Hence\nthe lifetime on the new `Layout` type.\n\nUnlike other interned types, these ones are in `rustc_target` instead of\n`rustc_middle`. This reflects the existing structure of the code, which\ndoes layout-specific stuff in `rustc_target` while `TyAndLayout` is\ngeneric over the `Ty`, allowing the type-specific stuff to occur in\n`rustc_middle`.\n\nThe commit also adds a `HashStable` impl for `Interned`, which was\nneeded. It hashes the contents, unlike the `Hash` impl which hashes the\npointer.", "tree": {"sha": "2db7b0f12a26595bbb42558e0cebe1b28314f8de", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2db7b0f12a26595bbb42558e0cebe1b28314f8de"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/8723fe0b6b6f8563c2ca0f15c83adf309e780d2a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/8723fe0b6b6f8563c2ca0f15c83adf309e780d2a", "html_url": "https://github.com/rust-lang/rust/commit/8723fe0b6b6f8563c2ca0f15c83adf309e780d2a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/8723fe0b6b6f8563c2ca0f15c83adf309e780d2a/comments", "author": {"login": "nnethercote", "id": 1940286, "node_id": "MDQ6VXNlcjE5NDAyODY=", "avatar_url": "https://avatars.githubusercontent.com/u/1940286?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nnethercote", "html_url": "https://github.com/nnethercote", "followers_url": "https://api.github.com/users/nnethercote/followers", "following_url": "https://api.github.com/users/nnethercote/following{/other_user}", "gists_url": "https://api.github.com/users/nnethercote/gists{/gist_id}", "starred_url": "https://api.github.com/users/nnethercote/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nnethercote/subscriptions", "organizations_url": "https://api.github.com/users/nnethercote/orgs", "repos_url": "https://api.github.com/users/nnethercote/repos", "events_url": "https://api.github.com/users/nnethercote/events{/privacy}", "received_events_url": "https://api.github.com/users/nnethercote/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nnethercote", "id": 1940286, "node_id": "MDQ6VXNlcjE5NDAyODY=", "avatar_url": "https://avatars.githubusercontent.com/u/1940286?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nnethercote", "html_url": "https://github.com/nnethercote", "followers_url": "https://api.github.com/users/nnethercote/followers", "following_url": "https://api.github.com/users/nnethercote/following{/other_user}", "gists_url": "https://api.github.com/users/nnethercote/gists{/gist_id}", "starred_url": "https://api.github.com/users/nnethercote/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nnethercote/subscriptions", "organizations_url": "https://api.github.com/users/nnethercote/orgs", "repos_url": "https://api.github.com/users/nnethercote/repos", "events_url": "https://api.github.com/users/nnethercote/events{/privacy}", "received_events_url": "https://api.github.com/users/nnethercote/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7c1a318c7b801e7020918b238428f484f0f13aa7", "url": "https://api.github.com/repos/rust-lang/rust/commits/7c1a318c7b801e7020918b238428f484f0f13aa7", "html_url": "https://github.com/rust-lang/rust/commit/7c1a318c7b801e7020918b238428f484f0f13aa7"}], "stats": {"total": 12, "additions": 9, "deletions": 3}, "files": [{"sha": "37d2679c10d70af2f21316bf404ecbd29eecf4a8", "filename": "src/abi/comments.rs", "status": "modified", "additions": 8, "deletions": 2, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/8723fe0b6b6f8563c2ca0f15c83adf309e780d2a/src%2Fabi%2Fcomments.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8723fe0b6b6f8563c2ca0f15c83adf309e780d2a/src%2Fabi%2Fcomments.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fabi%2Fcomments.rs?ref=8723fe0b6b6f8563c2ca0f15c83adf309e780d2a", "patch": "@@ -82,8 +82,14 @@ pub(super) fn add_local_place_comments<'tcx>(\n         return;\n     }\n     let TyAndLayout { ty, layout } = place.layout();\n-    let rustc_target::abi::Layout { size, align, abi: _, variants: _, fields: _, largest_niche: _ } =\n-        layout;\n+    let rustc_target::abi::LayoutS {\n+        size,\n+        align,\n+        abi: _,\n+        variants: _,\n+        fields: _,\n+        largest_niche: _,\n+    } = layout.0.0;\n \n     let (kind, extra) = match *place.inner() {\n         CPlaceInner::Var(place_local, var) => {"}, {"sha": "6489b96be4b2d037e212ba7b650c7adfab7bd02f", "filename": "src/intrinsics/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/8723fe0b6b6f8563c2ca0f15c83adf309e780d2a/src%2Fintrinsics%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/8723fe0b6b6f8563c2ca0f15c83adf309e780d2a/src%2Fintrinsics%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fintrinsics%2Fmod.rs?ref=8723fe0b6b6f8563c2ca0f15c83adf309e780d2a", "patch": "@@ -1070,7 +1070,7 @@ fn codegen_regular_intrinsic_call<'tcx>(\n         };\n \n         raw_eq, (v lhs_ref, v rhs_ref) {\n-            let size = fx.layout_of(substs.type_at(0)).layout.size;\n+            let size = fx.layout_of(substs.type_at(0)).layout.size();\n             // FIXME add and use emit_small_memcmp\n             let is_eq_value =\n                 if size == Size::ZERO {"}]}