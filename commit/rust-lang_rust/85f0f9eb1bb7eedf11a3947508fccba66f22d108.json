{"sha": "85f0f9eb1bb7eedf11a3947508fccba66f22d108", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg1ZjBmOWViMWJiN2VlZGYxMWEzOTQ3NTA4ZmNjYmE2NmYyMmQxMDg=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-07-07T22:13:35Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-07-07T22:13:35Z"}, "message": "Merge #9526\n\n9526: fix: coerce array elements to a common type r=flodiebold a=jonas-schievink\n\n\n\nCo-authored-by: Jonas Schievink <jonasschievink@gmail.com>", "tree": {"sha": "067d310542788222e5c023ebbdce0df4bf88ddc8", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/067d310542788222e5c023ebbdce0df4bf88ddc8"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/85f0f9eb1bb7eedf11a3947508fccba66f22d108", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJg5icPCRBK7hj4Ov3rIwAAH0gIAKoVja7J+L5HH648pKMCen3D\nZvLdLdFJN5NPwkrLezGGJaTEoYjCZAdX3zmxBDJ8YFpOts3Z9wp0utoMK3TESiGh\n9bMDmJUHC84pB/ZTQk/Fazyk6NQFvBYcDQwFvDokS67IiyVKO1AzrEXYY15XplBA\ntOh4lRcGYM9RwC5jLFfDTmCx+w+bznBPEbwoRA9/mYkn97GtfMvCXAsoVw8pc4ti\n3MO9JLsE25jPSIeYGJhnLms/SeBcKEN7je2+lIYBnq4PjNallPFuUlPCIqpC4a88\nRW/szq4xxdtDYgaAAwEHrBd880pxncGlyPsE389OaNmBC+YmIsDtOxIAc3uiuBk=\n=O6bH\n-----END PGP SIGNATURE-----\n", "payload": "tree 067d310542788222e5c023ebbdce0df4bf88ddc8\nparent 9f24cc7126f6508dcc9e429a33bd12975873d3e4\nparent cb63b021ff97ca1ba699866a16278a3189d9902a\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1625696015 +0000\ncommitter GitHub <noreply@github.com> 1625696015 +0000\n\nMerge #9526\n\n9526: fix: coerce array elements to a common type r=flodiebold a=jonas-schievink\n\n\n\nCo-authored-by: Jonas Schievink <jonasschievink@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/85f0f9eb1bb7eedf11a3947508fccba66f22d108", "html_url": "https://github.com/rust-lang/rust/commit/85f0f9eb1bb7eedf11a3947508fccba66f22d108", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/85f0f9eb1bb7eedf11a3947508fccba66f22d108/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9f24cc7126f6508dcc9e429a33bd12975873d3e4", "url": "https://api.github.com/repos/rust-lang/rust/commits/9f24cc7126f6508dcc9e429a33bd12975873d3e4", "html_url": "https://github.com/rust-lang/rust/commit/9f24cc7126f6508dcc9e429a33bd12975873d3e4"}, {"sha": "cb63b021ff97ca1ba699866a16278a3189d9902a", "url": "https://api.github.com/repos/rust-lang/rust/commits/cb63b021ff97ca1ba699866a16278a3189d9902a", "html_url": "https://github.com/rust-lang/rust/commit/cb63b021ff97ca1ba699866a16278a3189d9902a"}], "stats": {"total": 36, "additions": 25, "deletions": 11}, "files": [{"sha": "12e0b04131614e4bc40e3411feaa7f9770488450", "filename": "crates/hir_ty/src/infer/expr.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/85f0f9eb1bb7eedf11a3947508fccba66f22d108/crates%2Fhir_ty%2Fsrc%2Finfer%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/85f0f9eb1bb7eedf11a3947508fccba66f22d108/crates%2Fhir_ty%2Fsrc%2Finfer%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Finfer%2Fexpr.rs?ref=85f0f9eb1bb7eedf11a3947508fccba66f22d108", "patch": "@@ -729,7 +729,7 @@ impl<'a> InferenceContext<'a> {\n                 TyKind::Tuple(tys.len(), Substitution::from_iter(&Interner, tys)).intern(&Interner)\n             }\n             Expr::Array(array) => {\n-                let elem_ty =\n+                let mut elem_ty =\n                     match expected.to_option(&mut self.table).as_ref().map(|t| t.kind(&Interner)) {\n                         Some(TyKind::Array(st, _) | TyKind::Slice(st)) => st.clone(),\n                         _ => self.table.new_type_var(),\n@@ -738,8 +738,8 @@ impl<'a> InferenceContext<'a> {\n                 let len = match array {\n                     Array::ElementList(items) => {\n                         for expr in items.iter() {\n-                            // FIXME: use CoerceMany (coerce_merge_branch)\n-                            self.infer_expr_coerce(*expr, &Expectation::has_type(elem_ty.clone()));\n+                            let cur_elem_ty = self.infer_expr_inner(*expr, expected);\n+                            elem_ty = self.coerce_merge_branch(Some(*expr), &elem_ty, &cur_elem_ty);\n                         }\n                         Some(items.len() as u64)\n                     }"}, {"sha": "6c57bf697d81de3d77140b2535e5dd419fae5b11", "filename": "crates/hir_ty/src/tests/coercion.rs", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/85f0f9eb1bb7eedf11a3947508fccba66f22d108/crates%2Fhir_ty%2Fsrc%2Ftests%2Fcoercion.rs", "raw_url": "https://github.com/rust-lang/rust/raw/85f0f9eb1bb7eedf11a3947508fccba66f22d108/crates%2Fhir_ty%2Fsrc%2Ftests%2Fcoercion.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Ftests%2Fcoercion.rs?ref=85f0f9eb1bb7eedf11a3947508fccba66f22d108", "patch": "@@ -507,3 +507,17 @@ fn main() {\n         \"#,\n     );\n }\n+\n+#[test]\n+fn coerce_array_elems_lub() {\n+    check_no_mismatches(\n+        r#\"\n+fn f() {}\n+fn g() {}\n+\n+fn test() {\n+    [f, g];\n+}\n+        \"#,\n+    );\n+}"}, {"sha": "d80375f02fd7335655afcab9928741217c722d2b", "filename": "crates/hir_ty/src/tests/regression.rs", "status": "modified", "additions": 8, "deletions": 8, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/85f0f9eb1bb7eedf11a3947508fccba66f22d108/crates%2Fhir_ty%2Fsrc%2Ftests%2Fregression.rs", "raw_url": "https://github.com/rust-lang/rust/raw/85f0f9eb1bb7eedf11a3947508fccba66f22d108/crates%2Fhir_ty%2Fsrc%2Ftests%2Fregression.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_ty%2Fsrc%2Ftests%2Fregression.rs?ref=85f0f9eb1bb7eedf11a3947508fccba66f22d108", "patch": "@@ -117,19 +117,19 @@ fn recursive_vars_2() {\n         \"#,\n         expect![[r#\"\n             10..79 '{     ...x)]; }': ()\n-            20..21 'x': &{unknown}\n-            24..31 'unknown': &{unknown}\n+            20..21 'x': {unknown}\n+            24..31 'unknown': {unknown}\n             41..42 'y': {unknown}\n             45..52 'unknown': {unknown}\n-            58..76 '[(x, y..., &x)]': [(&{unknown}, {unknown}); 2]\n-            59..65 '(x, y)': (&{unknown}, {unknown})\n-            60..61 'x': &{unknown}\n+            58..76 '[(x, y..., &x)]': [({unknown}, {unknown}); 2]\n+            59..65 '(x, y)': ({unknown}, {unknown})\n+            60..61 'x': {unknown}\n             63..64 'y': {unknown}\n-            67..75 '(&y, &x)': (&{unknown}, {unknown})\n+            67..75 '(&y, &x)': (&{unknown}, &{unknown})\n             68..70 '&y': &{unknown}\n             69..70 'y': {unknown}\n-            72..74 '&x': &&{unknown}\n-            73..74 'x': &{unknown}\n+            72..74 '&x': &{unknown}\n+            73..74 'x': {unknown}\n         \"#]],\n     );\n }"}]}