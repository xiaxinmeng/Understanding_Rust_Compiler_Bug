{"sha": "c2a0859b3e589ec551b4d581fc0900e458bf6b6b", "node_id": "MDY6Q29tbWl0NzI0NzEyOmMyYTA4NTliM2U1ODllYzU1MWI0ZDU4MWZjMDkwMGU0NThiZjZiNmI=", "commit": {"author": {"name": "Ariel Ben-Yehuda", "email": "ariel.byd@gmail.com", "date": "2016-10-03T22:13:36Z"}, "committer": {"name": "Ariel Ben-Yehuda", "email": "ariel.byd@gmail.com", "date": "2016-10-03T22:13:36Z"}, "message": "stop having identity casts be lexprs\n\nthat made no sense (see test), and was incompatible with borrowck.\n\nFixes #36936.", "tree": {"sha": "8c1af0b6d53f76016cdb8efaa6f66f28d9f1cfe4", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/8c1af0b6d53f76016cdb8efaa6f66f28d9f1cfe4"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c2a0859b3e589ec551b4d581fc0900e458bf6b6b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c2a0859b3e589ec551b4d581fc0900e458bf6b6b", "html_url": "https://github.com/rust-lang/rust/commit/c2a0859b3e589ec551b4d581fc0900e458bf6b6b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c2a0859b3e589ec551b4d581fc0900e458bf6b6b/comments", "author": {"login": "arielb1", "id": 1830974, "node_id": "MDQ6VXNlcjE4MzA5NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1830974?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arielb1", "html_url": "https://github.com/arielb1", "followers_url": "https://api.github.com/users/arielb1/followers", "following_url": "https://api.github.com/users/arielb1/following{/other_user}", "gists_url": "https://api.github.com/users/arielb1/gists{/gist_id}", "starred_url": "https://api.github.com/users/arielb1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arielb1/subscriptions", "organizations_url": "https://api.github.com/users/arielb1/orgs", "repos_url": "https://api.github.com/users/arielb1/repos", "events_url": "https://api.github.com/users/arielb1/events{/privacy}", "received_events_url": "https://api.github.com/users/arielb1/received_events", "type": "User", "site_admin": false}, "committer": {"login": "arielb1", "id": 1830974, "node_id": "MDQ6VXNlcjE4MzA5NzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1830974?v=4", "gravatar_id": "", "url": "https://api.github.com/users/arielb1", "html_url": "https://github.com/arielb1", "followers_url": "https://api.github.com/users/arielb1/followers", "following_url": "https://api.github.com/users/arielb1/following{/other_user}", "gists_url": "https://api.github.com/users/arielb1/gists{/gist_id}", "starred_url": "https://api.github.com/users/arielb1/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/arielb1/subscriptions", "organizations_url": "https://api.github.com/users/arielb1/orgs", "repos_url": "https://api.github.com/users/arielb1/repos", "events_url": "https://api.github.com/users/arielb1/events{/privacy}", "received_events_url": "https://api.github.com/users/arielb1/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f3745653e10e366e7e119a12c178a59ab6394007", "url": "https://api.github.com/repos/rust-lang/rust/commits/f3745653e10e366e7e119a12c178a59ab6394007", "html_url": "https://github.com/rust-lang/rust/commit/f3745653e10e366e7e119a12c178a59ab6394007"}], "stats": {"total": 49, "additions": 47, "deletions": 2}, "files": [{"sha": "118b23cf987e5b813b7f25e154ba0ae57da91052", "filename": "src/librustc_mir/build/expr/as_lvalue.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/c2a0859b3e589ec551b4d581fc0900e458bf6b6b/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Fas_lvalue.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c2a0859b3e589ec551b4d581fc0900e458bf6b6b/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Fas_lvalue.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Fas_lvalue.rs?ref=c2a0859b3e589ec551b4d581fc0900e458bf6b6b", "patch": "@@ -96,6 +96,7 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n             ExprKind::LogicalOp { .. } |\n             ExprKind::Box { .. } |\n             ExprKind::Cast { .. } |\n+            ExprKind::Use { .. } |\n             ExprKind::NeverToAny { .. } |\n             ExprKind::ReifyFnPointer { .. } |\n             ExprKind::UnsafeFnPointer { .. } |"}, {"sha": "9b7f3468c19e5f9e7eaaae6cbf291f7188404ab1", "filename": "src/librustc_mir/build/expr/as_rvalue.rs", "status": "modified", "additions": 4, "deletions": 0, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/c2a0859b3e589ec551b4d581fc0900e458bf6b6b/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Fas_rvalue.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c2a0859b3e589ec551b4d581fc0900e458bf6b6b/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Fas_rvalue.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Fas_rvalue.rs?ref=c2a0859b3e589ec551b4d581fc0900e458bf6b6b", "patch": "@@ -115,6 +115,10 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n                 let source = unpack!(block = this.as_operand(block, source));\n                 block.and(Rvalue::Cast(CastKind::Misc, source, expr.ty))\n             }\n+            ExprKind::Use { source } => {\n+                let source = unpack!(block = this.as_operand(block, source));\n+                block.and(Rvalue::Use(source))\n+            }\n             ExprKind::ReifyFnPointer { source } => {\n                 let source = unpack!(block = this.as_operand(block, source));\n                 block.and(Rvalue::Cast(CastKind::ReifyFnPointer, source, expr.ty))"}, {"sha": "9671f80f48ba737e9ab888d16e8dd9242b44029e", "filename": "src/librustc_mir/build/expr/category.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/c2a0859b3e589ec551b4d581fc0900e458bf6b6b/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Fcategory.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c2a0859b3e589ec551b4d581fc0900e458bf6b6b/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Fcategory.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Fcategory.rs?ref=c2a0859b3e589ec551b4d581fc0900e458bf6b6b", "patch": "@@ -68,6 +68,7 @@ impl Category {\n             ExprKind::Binary { .. } |\n             ExprKind::Box { .. } |\n             ExprKind::Cast { .. } |\n+            ExprKind::Use { .. } |\n             ExprKind::ReifyFnPointer { .. } |\n             ExprKind::UnsafeFnPointer { .. } |\n             ExprKind::Unsize { .. } |"}, {"sha": "58265b5b0d36ba09c793fe9992e2365a0ec684d6", "filename": "src/librustc_mir/build/expr/into.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/c2a0859b3e589ec551b4d581fc0900e458bf6b6b/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Finto.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c2a0859b3e589ec551b4d581fc0900e458bf6b6b/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Finto.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fbuild%2Fexpr%2Finto.rs?ref=c2a0859b3e589ec551b4d581fc0900e458bf6b6b", "patch": "@@ -249,6 +249,7 @@ impl<'a, 'gcx, 'tcx> Builder<'a, 'gcx, 'tcx> {\n             ExprKind::Binary { .. } |\n             ExprKind::Box { .. } |\n             ExprKind::Cast { .. } |\n+            ExprKind::Use { .. } |\n             ExprKind::ReifyFnPointer { .. } |\n             ExprKind::UnsafeFnPointer { .. } |\n             ExprKind::Unsize { .. } |"}, {"sha": "00aab94ccdd871d5653012b29d9188f96a21baa6", "filename": "src/librustc_mir/hair/cx/expr.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/c2a0859b3e589ec551b4d581fc0900e458bf6b6b/src%2Flibrustc_mir%2Fhair%2Fcx%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c2a0859b3e589ec551b4d581fc0900e458bf6b6b/src%2Flibrustc_mir%2Fhair%2Fcx%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fhair%2Fcx%2Fexpr.rs?ref=c2a0859b3e589ec551b4d581fc0900e458bf6b6b", "patch": "@@ -600,8 +600,8 @@ fn make_mirror_unadjusted<'a, 'gcx, 'tcx>(cx: &mut Cx<'a, 'gcx, 'tcx>,\n             // Check to see if this cast is a \"coercion cast\", where the cast is actually done\n             // using a coercion (or is a no-op).\n             if let Some(&TyCastKind::CoercionCast) = cx.tcx.cast_kinds.borrow().get(&source.id) {\n-                // Skip the actual cast itexpr, as it's now a no-op.\n-                return source.make_mirror(cx);\n+                // Convert the lexpr to a vexpr.\n+                ExprKind::Use { source: source.to_ref() }\n             } else {\n                 ExprKind::Cast { source: source.to_ref() }\n             }"}, {"sha": "59137e2bcd78fd2d9d55b7c408f71859c58c84e2", "filename": "src/librustc_mir/hair/mod.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/c2a0859b3e589ec551b4d581fc0900e458bf6b6b/src%2Flibrustc_mir%2Fhair%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c2a0859b3e589ec551b4d581fc0900e458bf6b6b/src%2Flibrustc_mir%2Fhair%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Fhair%2Fmod.rs?ref=c2a0859b3e589ec551b4d581fc0900e458bf6b6b", "patch": "@@ -139,6 +139,9 @@ pub enum ExprKind<'tcx> {\n     Cast {\n         source: ExprRef<'tcx>,\n     },\n+    Use {\n+        source: ExprRef<'tcx>,\n+    }, // Use a lexpr to get a vexpr.\n     NeverToAny {\n         source: ExprRef<'tcx>,\n     },"}, {"sha": "34a9c2916683f07dbea655dd7f4700114b0892ef", "filename": "src/test/run-pass/issue-36936.rs", "status": "added", "additions": 35, "deletions": 0, "changes": 35, "blob_url": "https://github.com/rust-lang/rust/blob/c2a0859b3e589ec551b4d581fc0900e458bf6b6b/src%2Ftest%2Frun-pass%2Fissue-36936.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c2a0859b3e589ec551b4d581fc0900e458bf6b6b/src%2Ftest%2Frun-pass%2Fissue-36936.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass%2Fissue-36936.rs?ref=c2a0859b3e589ec551b4d581fc0900e458bf6b6b", "patch": "@@ -0,0 +1,35 @@\n+// Copyright 2016 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// check that casts are not being treated as lexprs.\n+\n+fn main() {\n+    let mut a = 0i32;\n+    let b = &(a as i32);\n+    a = 1;\n+    assert_ne!(&a as *const i32, b as *const i32);\n+    assert_eq!(*b, 0);\n+\n+    assert_eq!(issue_36936(), 1);\n+}\n+\n+\n+struct A(u32);\n+\n+impl Drop for A {\n+    fn drop(&mut self) {\n+        self.0 = 0;\n+    }\n+}\n+\n+fn issue_36936() -> u32 {\n+    let a = &(A(1) as A);\n+    a.0\n+}"}]}