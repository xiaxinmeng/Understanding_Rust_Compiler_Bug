{"sha": "da92f46cc8b5fc7e45cd35117ca4cb0cff80405e", "node_id": "MDY6Q29tbWl0NzI0NzEyOmRhOTJmNDZjYzhiNWZjN2U0NWNkMzUxMTdjYTRjYjBjZmY4MDQwNWU=", "commit": {"author": {"name": "Edwin Cheng", "email": "edwin0cheng@gmail.com", "date": "2020-12-27T10:00:59Z"}, "committer": {"name": "Edwin Cheng", "email": "edwin0cheng@gmail.com", "date": "2020-12-27T10:00:59Z"}, "message": "Add force_show_panics flag", "tree": {"sha": "3ad0b0efd6ea63ff420a3af8f1700899f55dd952", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3ad0b0efd6ea63ff420a3af8f1700899f55dd952"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/da92f46cc8b5fc7e45cd35117ca4cb0cff80405e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/da92f46cc8b5fc7e45cd35117ca4cb0cff80405e", "html_url": "https://github.com/rust-lang/rust/commit/da92f46cc8b5fc7e45cd35117ca4cb0cff80405e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/da92f46cc8b5fc7e45cd35117ca4cb0cff80405e/comments", "author": {"login": "edwin0cheng", "id": 11014119, "node_id": "MDQ6VXNlcjExMDE0MTE5", "avatar_url": "https://avatars.githubusercontent.com/u/11014119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/edwin0cheng", "html_url": "https://github.com/edwin0cheng", "followers_url": "https://api.github.com/users/edwin0cheng/followers", "following_url": "https://api.github.com/users/edwin0cheng/following{/other_user}", "gists_url": "https://api.github.com/users/edwin0cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/edwin0cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/edwin0cheng/subscriptions", "organizations_url": "https://api.github.com/users/edwin0cheng/orgs", "repos_url": "https://api.github.com/users/edwin0cheng/repos", "events_url": "https://api.github.com/users/edwin0cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/edwin0cheng/received_events", "type": "User", "site_admin": false}, "committer": {"login": "edwin0cheng", "id": 11014119, "node_id": "MDQ6VXNlcjExMDE0MTE5", "avatar_url": "https://avatars.githubusercontent.com/u/11014119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/edwin0cheng", "html_url": "https://github.com/edwin0cheng", "followers_url": "https://api.github.com/users/edwin0cheng/followers", "following_url": "https://api.github.com/users/edwin0cheng/following{/other_user}", "gists_url": "https://api.github.com/users/edwin0cheng/gists{/gist_id}", "starred_url": "https://api.github.com/users/edwin0cheng/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/edwin0cheng/subscriptions", "organizations_url": "https://api.github.com/users/edwin0cheng/orgs", "repos_url": "https://api.github.com/users/edwin0cheng/repos", "events_url": "https://api.github.com/users/edwin0cheng/events{/privacy}", "received_events_url": "https://api.github.com/users/edwin0cheng/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "f3125555a8de6fad4529408436800a6b1243a442", "url": "https://api.github.com/repos/rust-lang/rust/commits/f3125555a8de6fad4529408436800a6b1243a442", "html_url": "https://github.com/rust-lang/rust/commit/f3125555a8de6fad4529408436800a6b1243a442"}], "stats": {"total": 52, "additions": 44, "deletions": 8}, "files": [{"sha": "4e719f3aa0f14a881241bc4d23b91c815feff842", "filename": "crates/proc_macro_srv/src/dylib.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/da92f46cc8b5fc7e45cd35117ca4cb0cff80405e/crates%2Fproc_macro_srv%2Fsrc%2Fdylib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/da92f46cc8b5fc7e45cd35117ca4cb0cff80405e/crates%2Fproc_macro_srv%2Fsrc%2Fdylib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproc_macro_srv%2Fsrc%2Fdylib.rs?ref=da92f46cc8b5fc7e45cd35117ca4cb0cff80405e", "patch": "@@ -136,6 +136,7 @@ impl Expander {\n                         &crate::proc_macro::bridge::server::SameThread,\n                         crate::rustc_server::Rustc::default(),\n                         parsed_body,\n+                        false,\n                     );\n                     return res.map(|it| it.subtree);\n                 }\n@@ -144,6 +145,7 @@ impl Expander {\n                         &crate::proc_macro::bridge::server::SameThread,\n                         crate::rustc_server::Rustc::default(),\n                         parsed_body,\n+                        false,\n                     );\n                     return res.map(|it| it.subtree);\n                 }\n@@ -153,6 +155,7 @@ impl Expander {\n                         crate::rustc_server::Rustc::default(),\n                         parsed_attributes,\n                         parsed_body,\n+                        false,\n                     );\n                     return res.map(|it| it.subtree);\n                 }"}, {"sha": "ca6749b9bc72b745a1fe850def63545df3447933", "filename": "crates/proc_macro_srv/src/proc_macro/bridge/client.rs", "status": "modified", "additions": 8, "deletions": 4, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/da92f46cc8b5fc7e45cd35117ca4cb0cff80405e/crates%2Fproc_macro_srv%2Fsrc%2Fproc_macro%2Fbridge%2Fclient.rs", "raw_url": "https://github.com/rust-lang/rust/raw/da92f46cc8b5fc7e45cd35117ca4cb0cff80405e/crates%2Fproc_macro_srv%2Fsrc%2Fproc_macro%2Fbridge%2Fclient.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproc_macro_srv%2Fsrc%2Fproc_macro%2Fbridge%2Fclient.rs?ref=da92f46cc8b5fc7e45cd35117ca4cb0cff80405e", "patch": "@@ -303,17 +303,21 @@ impl BridgeState<'_> {\n \n impl Bridge<'_> {\n     fn enter<R>(self, f: impl FnOnce() -> R) -> R {\n+        let force_show_panics = self.force_show_panics;\n+\n         // Hide the default panic output within `proc_macro` expansions.\n         // NB. the server can't do this because it may use a different libstd.\n         static HIDE_PANICS_DURING_EXPANSION: Once = Once::new();\n         HIDE_PANICS_DURING_EXPANSION.call_once(|| {\n             let prev = panic::take_hook();\n             panic::set_hook(Box::new(move |info| {\n-                let hide = BridgeState::with(|state| match state {\n-                    BridgeState::NotConnected => false,\n-                    BridgeState::Connected(_) | BridgeState::InUse => true,\n+                let show = BridgeState::with(|state| match state {\n+                    BridgeState::NotConnected => true,\n+                    // Something weird is going on, so don't suppress any backtraces\n+                    BridgeState::InUse => true,\n+                    BridgeState::Connected(bridge) => force_show_panics,\n                 });\n-                if !hide {\n+                if show {\n                     prev(info)\n                 }\n             }));"}, {"sha": "e4006a5ab0c12b63749eae2734a3971b9aac1239", "filename": "crates/proc_macro_srv/src/proc_macro/bridge/mod.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/da92f46cc8b5fc7e45cd35117ca4cb0cff80405e/crates%2Fproc_macro_srv%2Fsrc%2Fproc_macro%2Fbridge%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/da92f46cc8b5fc7e45cd35117ca4cb0cff80405e/crates%2Fproc_macro_srv%2Fsrc%2Fproc_macro%2Fbridge%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproc_macro_srv%2Fsrc%2Fproc_macro%2Fbridge%2Fmod.rs?ref=da92f46cc8b5fc7e45cd35117ca4cb0cff80405e", "patch": "@@ -225,6 +225,9 @@ pub struct Bridge<'a> {\n \n     /// Server-side function that the client uses to make requests.\n     dispatch: closure::Closure<'a, Buffer<u8>, Buffer<u8>>,\n+\n+    /// If 'true', always invoke the default panic hook\n+    force_show_panics: bool,\n }\n \n // impl<'a> !Sync for Bridge<'a> {}"}, {"sha": "88fbdc078cba26c232bc30ee24fba34b33c17fd6", "filename": "crates/proc_macro_srv/src/proc_macro/bridge/server.rs", "status": "modified", "additions": 30, "deletions": 4, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/da92f46cc8b5fc7e45cd35117ca4cb0cff80405e/crates%2Fproc_macro_srv%2Fsrc%2Fproc_macro%2Fbridge%2Fserver.rs", "raw_url": "https://github.com/rust-lang/rust/raw/da92f46cc8b5fc7e45cd35117ca4cb0cff80405e/crates%2Fproc_macro_srv%2Fsrc%2Fproc_macro%2Fbridge%2Fserver.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fproc_macro_srv%2Fsrc%2Fproc_macro%2Fbridge%2Fserver.rs?ref=da92f46cc8b5fc7e45cd35117ca4cb0cff80405e", "patch": "@@ -138,6 +138,7 @@ pub trait ExecutionStrategy {\n         input: Buffer<u8>,\n         run_client: extern \"C\" fn(Bridge<'_>, D) -> Buffer<u8>,\n         client_data: D,\n+        force_show_panics: bool,\n     ) -> Buffer<u8>;\n }\n \n@@ -150,10 +151,14 @@ impl ExecutionStrategy for SameThread {\n         input: Buffer<u8>,\n         run_client: extern \"C\" fn(Bridge<'_>, D) -> Buffer<u8>,\n         client_data: D,\n+        force_show_panics: bool,\n     ) -> Buffer<u8> {\n         let mut dispatch = |b| dispatcher.dispatch(b);\n \n-        run_client(Bridge { cached_buffer: input, dispatch: (&mut dispatch).into() }, client_data)\n+        run_client(\n+            Bridge { cached_buffer: input, dispatch: (&mut dispatch).into(), force_show_panics },\n+            client_data,\n+        )\n     }\n }\n \n@@ -169,6 +174,7 @@ impl ExecutionStrategy for CrossThread1 {\n         input: Buffer<u8>,\n         run_client: extern \"C\" fn(Bridge<'_>, D) -> Buffer<u8>,\n         client_data: D,\n+        force_show_panics: bool,\n     ) -> Buffer<u8> {\n         use std::sync::mpsc::channel;\n \n@@ -182,7 +188,11 @@ impl ExecutionStrategy for CrossThread1 {\n             };\n \n             run_client(\n-                Bridge { cached_buffer: input, dispatch: (&mut dispatch).into() },\n+                Bridge {\n+                    cached_buffer: input,\n+                    dispatch: (&mut dispatch).into(),\n+                    force_show_panics,\n+                },\n                 client_data,\n             )\n         });\n@@ -204,6 +214,7 @@ impl ExecutionStrategy for CrossThread2 {\n         input: Buffer<u8>,\n         run_client: extern \"C\" fn(Bridge<'_>, D) -> Buffer<u8>,\n         client_data: D,\n+        force_show_panics: bool,\n     ) -> Buffer<u8> {\n         use std::sync::{Arc, Mutex};\n \n@@ -229,7 +240,11 @@ impl ExecutionStrategy for CrossThread2 {\n             };\n \n             let r = run_client(\n-                Bridge { cached_buffer: input, dispatch: (&mut dispatch).into() },\n+                Bridge {\n+                    cached_buffer: input,\n+                    dispatch: (&mut dispatch).into(),\n+                    force_show_panics,\n+                },\n                 client_data,\n             );\n \n@@ -268,14 +283,21 @@ fn run_server<\n     input: I,\n     run_client: extern \"C\" fn(Bridge<'_>, D) -> Buffer<u8>,\n     client_data: D,\n+    force_show_panics: bool,\n ) -> Result<O, PanicMessage> {\n     let mut dispatcher =\n         Dispatcher { handle_store: HandleStore::new(handle_counters), server: MarkedTypes(server) };\n \n     let mut b = Buffer::new();\n     input.encode(&mut b, &mut dispatcher.handle_store);\n \n-    b = strategy.run_bridge_and_client(&mut dispatcher, b, run_client, client_data);\n+    b = strategy.run_bridge_and_client(\n+        &mut dispatcher,\n+        b,\n+        run_client,\n+        client_data,\n+        force_show_panics,\n+    );\n \n     Result::decode(&mut &b[..], &mut dispatcher.handle_store)\n }\n@@ -286,6 +308,7 @@ impl client::Client<fn(crate::TokenStream) -> crate::TokenStream> {\n         strategy: &impl ExecutionStrategy,\n         server: S,\n         input: S::TokenStream,\n+        force_show_panics: bool,\n     ) -> Result<S::TokenStream, PanicMessage> {\n         let client::Client { get_handle_counters, run, f } = *self;\n         run_server(\n@@ -295,6 +318,7 @@ impl client::Client<fn(crate::TokenStream) -> crate::TokenStream> {\n             <MarkedTypes<S> as Types>::TokenStream::mark(input),\n             run,\n             f,\n+            force_show_panics,\n         )\n         .map(<MarkedTypes<S> as Types>::TokenStream::unmark)\n     }\n@@ -307,6 +331,7 @@ impl client::Client<fn(crate::TokenStream, crate::TokenStream) -> crate::TokenSt\n         server: S,\n         input: S::TokenStream,\n         input2: S::TokenStream,\n+        force_show_panics: bool,\n     ) -> Result<S::TokenStream, PanicMessage> {\n         let client::Client { get_handle_counters, run, f } = *self;\n         run_server(\n@@ -319,6 +344,7 @@ impl client::Client<fn(crate::TokenStream, crate::TokenStream) -> crate::TokenSt\n             ),\n             run,\n             f,\n+            force_show_panics,\n         )\n         .map(<MarkedTypes<S> as Types>::TokenStream::unmark)\n     }"}]}