{"sha": "e1886935b78e62a6c23a243e48f81815ae7fd141", "node_id": "MDY6Q29tbWl0NzI0NzEyOmUxODg2OTM1Yjc4ZTYyYTZjMjNhMjQzZTQ4ZjgxODE1YWU3ZmQxNDE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-04-27T07:29:26Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-04-27T07:29:26Z"}, "message": "Auto merge of #84532 - richkadel:issue-83792, r=tmandry\n\nFix coverage ICE because fn_sig can have a span that crosses file bou\u2026\n\nFixes: #83792\n\nMIR `InstrumentCoverage` assumed the `FnSig` span was contained within a\nsingle file, but this is not always the case. Some macro constructions\ncan result in a span that starts in one `SourceFile` and ends in a\ndifferent one.\n\nThe `FnSig` span is included in coverage results as long as that span is\nin the same `SourceFile` and the same macro context, but by assuming the\n`FnSig` span's `hi()` and `lo()` were in the same file, I took this for\ngranted, and checked only that the `FnSig` `hi()` was in the same\n`SourceFile` as the `body_span`.\n\nI actually drop the `hi()` though, and extend the `FnSig` span to the\n`body_span.lo()`, so I really should have simply checked that the\n`FnSig` span's `lo()` was in the `SourceFile` of the `body_span`.\n\nr? `@tmandry`\ncc: `@wesleywiser`", "tree": {"sha": "e599b6d445384821dac81e6da3bf11d939ea9d51", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e599b6d445384821dac81e6da3bf11d939ea9d51"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e1886935b78e62a6c23a243e48f81815ae7fd141", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e1886935b78e62a6c23a243e48f81815ae7fd141", "html_url": "https://github.com/rust-lang/rust/commit/e1886935b78e62a6c23a243e48f81815ae7fd141", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e1886935b78e62a6c23a243e48f81815ae7fd141/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "22b686ad9995266b695344fcfb8e14f710b9ea6b", "url": "https://api.github.com/repos/rust-lang/rust/commits/22b686ad9995266b695344fcfb8e14f710b9ea6b", "html_url": "https://github.com/rust-lang/rust/commit/22b686ad9995266b695344fcfb8e14f710b9ea6b"}, {"sha": "31cba57ea56e7444c75d62b3a1bebad8f5f74432", "url": "https://api.github.com/repos/rust-lang/rust/commits/31cba57ea56e7444c75d62b3a1bebad8f5f74432", "html_url": "https://github.com/rust-lang/rust/commit/31cba57ea56e7444c75d62b3a1bebad8f5f74432"}], "stats": {"total": 2, "additions": 1, "deletions": 1}, "files": [{"sha": "3ef03ec21addd5393bab898371c14f2f24fcb88d", "filename": "compiler/rustc_mir/src/transform/coverage/mod.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/e1886935b78e62a6c23a243e48f81815ae7fd141/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcoverage%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e1886935b78e62a6c23a243e48f81815ae7fd141/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcoverage%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir%2Fsrc%2Ftransform%2Fcoverage%2Fmod.rs?ref=e1886935b78e62a6c23a243e48f81815ae7fd141", "patch": "@@ -112,7 +112,7 @@ impl<'a, 'tcx> Instrumentor<'a, 'tcx> {\n         let source_file = source_map.lookup_source_file(body_span.lo());\n         let fn_sig_span = match some_fn_sig.filter(|fn_sig| {\n             fn_sig.span.ctxt() == body_span.ctxt()\n-                && Lrc::ptr_eq(&source_file, &source_map.lookup_source_file(fn_sig.span.hi()))\n+                && Lrc::ptr_eq(&source_file, &source_map.lookup_source_file(fn_sig.span.lo()))\n         }) {\n             Some(fn_sig) => fn_sig.span.with_hi(body_span.lo()),\n             None => body_span.shrink_to_lo(),"}]}