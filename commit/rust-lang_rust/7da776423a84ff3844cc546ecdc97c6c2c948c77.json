{"sha": "7da776423a84ff3844cc546ecdc97c6c2c948c77", "node_id": "MDY6Q29tbWl0NzI0NzEyOjdkYTc3NjQyM2E4NGZmMzg0NGNjNTQ2ZWNkYzk3YzZjMmM5NDhjNzc=", "commit": {"author": {"name": "Nick Cameron", "email": "nrc@ncameron.org", "date": "2017-08-09T08:45:49Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2017-08-09T08:45:49Z"}, "message": "Merge pull request #1864 from topecongiro/reorder-extern-crates\n\nReorder extern crates", "tree": {"sha": "0fab0626e5d146282a3c8244c9e8bd70589effcb", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/0fab0626e5d146282a3c8244c9e8bd70589effcb"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7da776423a84ff3844cc546ecdc97c6c2c948c77", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7da776423a84ff3844cc546ecdc97c6c2c948c77", "html_url": "https://github.com/rust-lang/rust/commit/7da776423a84ff3844cc546ecdc97c6c2c948c77", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7da776423a84ff3844cc546ecdc97c6c2c948c77/comments", "author": {"login": "nrc", "id": 762626, "node_id": "MDQ6VXNlcjc2MjYyNg==", "avatar_url": "https://avatars.githubusercontent.com/u/762626?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nrc", "html_url": "https://github.com/nrc", "followers_url": "https://api.github.com/users/nrc/followers", "following_url": "https://api.github.com/users/nrc/following{/other_user}", "gists_url": "https://api.github.com/users/nrc/gists{/gist_id}", "starred_url": "https://api.github.com/users/nrc/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nrc/subscriptions", "organizations_url": "https://api.github.com/users/nrc/orgs", "repos_url": "https://api.github.com/users/nrc/repos", "events_url": "https://api.github.com/users/nrc/events{/privacy}", "received_events_url": "https://api.github.com/users/nrc/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2c293bd01bcf832ba5e190789322935329d6ccd4", "url": "https://api.github.com/repos/rust-lang/rust/commits/2c293bd01bcf832ba5e190789322935329d6ccd4", "html_url": "https://github.com/rust-lang/rust/commit/2c293bd01bcf832ba5e190789322935329d6ccd4"}, {"sha": "c28df858c79521dde6571a6fe153ba8af92f79d4", "url": "https://api.github.com/repos/rust-lang/rust/commits/c28df858c79521dde6571a6fe153ba8af92f79d4", "html_url": "https://github.com/rust-lang/rust/commit/c28df858c79521dde6571a6fe153ba8af92f79d4"}], "stats": {"total": 137, "additions": 93, "deletions": 44}, "files": [{"sha": "d1f7a83187b3d495fe11a759162ed6c152fc62a0", "filename": "src/bin/rustfmt.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/7da776423a84ff3844cc546ecdc97c6c2c948c77/src%2Fbin%2Frustfmt.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7da776423a84ff3844cc546ecdc97c6c2c948c77/src%2Fbin%2Frustfmt.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbin%2Frustfmt.rs?ref=7da776423a84ff3844cc546ecdc97c6c2c948c77", "patch": "@@ -11,11 +11,11 @@\n #![cfg(not(test))]\n \n \n+extern crate env_logger;\n+extern crate getopts;\n extern crate log;\n extern crate rustfmt_nightly as rustfmt;\n extern crate toml;\n-extern crate env_logger;\n-extern crate getopts;\n \n use std::{env, error};\n use std::fs::File;"}, {"sha": "7b2fb9f629db4fb6682b00e8ac77019bc4ce83ad", "filename": "src/config.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/7da776423a84ff3844cc546ecdc97c6c2c948c77/src%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7da776423a84ff3844cc546ecdc97c6c2c948c77/src%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fconfig.rs?ref=7da776423a84ff3844cc546ecdc97c6c2c948c77", "patch": "@@ -558,6 +558,8 @@ create_config! {\n                                             exceeds `chain_one_line_max`\";\n     imports_indent: IndentStyle, IndentStyle::Visual, \"Indent of imports\";\n     imports_layout: ListTactic, ListTactic::Mixed, \"Item layout inside a import block\";\n+    reorder_extern_crates: bool, true, \"Reorder extern crate statements alphabetically\";\n+    reorder_extern_crates_in_group: bool, true, \"Reorder extern crate statements in group\";\n     reorder_imports: bool, false, \"Reorder import statements alphabetically\";\n     reorder_imports_in_group: bool, false, \"Reorder import statements in group\";\n     reorder_imported_names: bool, true,"}, {"sha": "b73c85ddb5642ce055f5258d37e108ea454c525a", "filename": "src/imports.rs", "status": "modified", "additions": 7, "deletions": 2, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/7da776423a84ff3844cc546ecdc97c6c2c948c77/src%2Fimports.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7da776423a84ff3844cc546ecdc97c6c2c948c77/src%2Fimports.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fimports.rs?ref=7da776423a84ff3844cc546ecdc97c6c2c948c77", "patch": "@@ -113,11 +113,14 @@ fn compare_view_paths(a: &ast::ViewPath_, b: &ast::ViewPath_) -> Ordering {\n     }\n }\n \n-fn compare_use_items(a: &ast::Item, b: &ast::Item) -> Option<Ordering> {\n+fn compare_use_items(context: &RewriteContext, a: &ast::Item, b: &ast::Item) -> Option<Ordering> {\n     match (&a.node, &b.node) {\n         (&ast::ItemKind::Use(ref a_vp), &ast::ItemKind::Use(ref b_vp)) => {\n             Some(compare_view_paths(&a_vp.node, &b_vp.node))\n         }\n+        (&ast::ItemKind::ExternCrate(..), &ast::ItemKind::ExternCrate(..)) => {\n+            Some(context.snippet(a.span).cmp(&context.snippet(b.span)))\n+        }\n         _ => None,\n     }\n }\n@@ -214,7 +217,9 @@ impl<'a> FmtVisitor<'a> {\n             .collect::<Vec<_>>();\n         let pos_after_last_use_item = last_pos_of_prev_use_item;\n         // Order the imports by view-path & other import path properties\n-        ordered_use_items.sort_by(|a, b| compare_use_items(a.0, b.0).unwrap());\n+        ordered_use_items.sort_by(|a, b| {\n+            compare_use_items(&self.get_context(), a.0, b.0).unwrap()\n+        });\n         // First, output the span before the first import\n         let prev_span_str = self.snippet(utils::mk_sp(self.last_pos, pos_before_first_use_item));\n         // Look for purely trailing space at the start of the prefix snippet before a linefeed, or"}, {"sha": "eaac371aa5b6b9f892756c8394633159cb4adb64", "filename": "src/lib.rs", "status": "modified", "additions": 5, "deletions": 9, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/7da776423a84ff3844cc546ecdc97c6c2c948c77/src%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7da776423a84ff3844cc546ecdc97c6c2c948c77/src%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flib.rs?ref=7da776423a84ff3844cc546ecdc97c6c2c948c77", "patch": "@@ -10,23 +10,19 @@\n \n #![feature(rustc_private)]\n \n+extern crate diff;\n #[macro_use]\n extern crate log;\n-\n+extern crate regex;\n+extern crate rustc_errors as errors;\n extern crate serde;\n #[macro_use]\n extern crate serde_derive;\n extern crate serde_json;\n-\n-extern crate syntax;\n-extern crate rustc_errors as errors;\n-\n extern crate strings;\n-\n-extern crate unicode_segmentation;\n-extern crate regex;\n-extern crate diff;\n+extern crate syntax;\n extern crate term;\n+extern crate unicode_segmentation;\n \n use std::collections::HashMap;\n use std::fmt;"}, {"sha": "3427867274a560959374a03f4b9e9baee0efbd62", "filename": "src/visitor.rs", "status": "modified", "additions": 59, "deletions": 27, "changes": 86, "blob_url": "https://github.com/rust-lang/rust/blob/7da776423a84ff3844cc546ecdc97c6c2c948c77/src%2Fvisitor.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7da776423a84ff3844cc546ecdc97c6c2c948c77/src%2Fvisitor.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fvisitor.rs?ref=7da776423a84ff3844cc546ecdc97c6c2c948c77", "patch": "@@ -36,6 +36,13 @@ fn is_use_item(item: &ast::Item) -> bool {\n     }\n }\n \n+fn is_extern_crate(item: &ast::Item) -> bool {\n+    match item.node {\n+        ast::ItemKind::ExternCrate(..) => true,\n+        _ => false,\n+    }\n+}\n+\n pub struct FmtVisitor<'a> {\n     pub parse_session: &'a ParseSess,\n     pub codemap: &'a CodeMap,\n@@ -627,40 +634,65 @@ impl<'a> FmtVisitor<'a> {\n         false\n     }\n \n+    fn reorder_items<F>(\n+        &mut self,\n+        items_left: &[ptr::P<ast::Item>],\n+        is_item: &F,\n+        in_group: bool,\n+    ) -> usize\n+    where\n+        F: Fn(&ast::Item) -> bool,\n+    {\n+        let mut last = self.codemap.lookup_line_range(items_left[0].span());\n+        let item_length = items_left\n+            .iter()\n+            .take_while(|ppi| {\n+                is_item(&***ppi) && (!in_group || {\n+                    let current = self.codemap.lookup_line_range(ppi.span());\n+                    let in_same_group = current.lo < last.hi + 2;\n+                    last = current;\n+                    in_same_group\n+                })\n+            })\n+            .count();\n+        let items = &items_left[..item_length];\n+\n+        let at_least_one_in_file_lines = items\n+            .iter()\n+            .any(|item| !out_of_file_lines_range!(self, item.span));\n+\n+        if at_least_one_in_file_lines {\n+            self.format_imports(items);\n+        } else {\n+            for item in items {\n+                self.push_rewrite(item.span, None);\n+            }\n+        }\n+\n+        item_length\n+    }\n+\n     fn walk_mod_items(&mut self, m: &ast::Mod) {\n         let mut items_left: &[ptr::P<ast::Item>] = &m.items;\n         while !items_left.is_empty() {\n             // If the next item is a `use` declaration, then extract it and any subsequent `use`s\n             // to be potentially reordered within `format_imports`. Otherwise, just format the\n             // next item for output.\n             if self.config.reorder_imports() && is_use_item(&*items_left[0]) {\n-                let reorder_imports_in_group = self.config.reorder_imports_in_group();\n-                let mut last = self.codemap.lookup_line_range(items_left[0].span());\n-                let use_item_length = items_left\n-                    .iter()\n-                    .take_while(|ppi| {\n-                        is_use_item(&***ppi) && (!reorder_imports_in_group || {\n-                            let current = self.codemap.lookup_line_range(ppi.span());\n-                            let in_same_group = current.lo < last.hi + 2;\n-                            last = current;\n-                            in_same_group\n-                        })\n-                    })\n-                    .count();\n-                let (use_items, rest) = items_left.split_at(use_item_length);\n-\n-                let at_least_one_in_file_lines = use_items\n-                    .iter()\n-                    .any(|item| !out_of_file_lines_range!(self, item.span));\n-\n-                if at_least_one_in_file_lines {\n-                    self.format_imports(use_items);\n-                } else {\n-                    for item in use_items {\n-                        self.push_rewrite(item.span, None);\n-                    }\n-                }\n-\n+                let used_items_len = self.reorder_items(\n+                    &items_left,\n+                    &is_use_item,\n+                    self.config.reorder_imports_in_group(),\n+                );\n+                let (_, rest) = items_left.split_at(used_items_len);\n+                items_left = rest;\n+            } else if self.config.reorder_extern_crates() && is_extern_crate(&*items_left[0]) {\n+                let used_items_len = self.reorder_items(\n+                    &items_left,\n+                    &is_extern_crate,\n+                    self.config.reorder_extern_crates_in_group(),\n+                );\n+                let (_, rest) = items_left.split_at(used_items_len);\n                 items_left = rest;\n             } else {\n                 // `unwrap()` is safe here because we know `items_left`"}, {"sha": "5546b2172266777eab4d8945c806d4e072d55512", "filename": "tests/source/extern.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/7da776423a84ff3844cc546ecdc97c6c2c948c77/tests%2Fsource%2Fextern.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7da776423a84ff3844cc546ecdc97c6c2c948c77/tests%2Fsource%2Fextern.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fextern.rs?ref=7da776423a84ff3844cc546ecdc97c6c2c948c77", "patch": "@@ -3,6 +3,13 @@\n  extern crate       foo    ;   \n     extern crate       foo       as bar    ;   \n \n+extern crate futures;\n+extern crate dotenv;\n+extern crate chrono;\n+\n+extern crate foo;\n+extern crate bar;\n+\n  extern  \"C\" {\n   fn c_func(x: *mut *mut libc::c_void);\n "}, {"sha": "6e148147a48885e9226a04790b8e3ea143a9c714", "filename": "tests/system.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/7da776423a84ff3844cc546ecdc97c6c2c948c77/tests%2Fsystem.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7da776423a84ff3844cc546ecdc97c6c2c948c77/tests%2Fsystem.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsystem.rs?ref=7da776423a84ff3844cc546ecdc97c6c2c948c77", "patch": "@@ -8,9 +8,9 @@\n // option. This file may not be copied, modified, or distributed\n // except according to those terms.\n \n-extern crate rustfmt_nightly as rustfmt;\n extern crate diff;\n extern crate regex;\n+extern crate rustfmt_nightly as rustfmt;\n extern crate term;\n \n use std::collections::HashMap;"}, {"sha": "ed64a0aeb0710110b5819d5b629dbf00bf2abc4c", "filename": "tests/target/attrib-extern-crate.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/7da776423a84ff3844cc546ecdc97c6c2c948c77/tests%2Ftarget%2Fattrib-extern-crate.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7da776423a84ff3844cc546ecdc97c6c2c948c77/tests%2Ftarget%2Fattrib-extern-crate.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fattrib-extern-crate.rs?ref=7da776423a84ff3844cc546ecdc97c6c2c948c77", "patch": "@@ -1,17 +1,17 @@\n // Attributes on extern crate.\n \n-extern crate Foo;\n #[Attr1]\n extern crate Bar;\n #[Attr2]\n #[Attr2]\n extern crate Baz;\n+extern crate Foo;\n \n fn foo() {\n-    extern crate Foo;\n     #[Attr1]\n     extern crate Bar;\n     #[Attr2]\n     #[Attr2]\n     extern crate Baz;\n+    extern crate Foo;\n }"}, {"sha": "c0601a4d0e1c3e01a862f2f5e1a8f39e1f3420a3", "filename": "tests/target/extern.rs", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/7da776423a84ff3844cc546ecdc97c6c2c948c77/tests%2Ftarget%2Fextern.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7da776423a84ff3844cc546ecdc97c6c2c948c77/tests%2Ftarget%2Fextern.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fextern.rs?ref=7da776423a84ff3844cc546ecdc97c6c2c948c77", "patch": "@@ -1,7 +1,14 @@\n // rustfmt-normalize_comments: true\n \n-extern crate foo;\n extern crate foo as bar;\n+extern crate foo;\n+\n+extern crate chrono;\n+extern crate dotenv;\n+extern crate futures;\n+\n+extern crate bar;\n+extern crate foo;\n \n extern \"C\" {\n     fn c_func(x: *mut *mut libc::c_void);"}]}