{"sha": "adbfd0da6860a29d6c7a2adb315e79c91202f7ef", "node_id": "C_kwDOAAsO6NoAKGFkYmZkMGRhNjg2MGEyOWQ2YzdhMmFkYjMxNWU3OWM5MTIwMmY3ZWY", "commit": {"author": {"name": "\u8bb8\u6770\u53cb Jieyou Xu (Joe)", "email": "jieyouxu@outlook.com", "date": "2023-06-07T16:52:53Z"}, "committer": {"name": "\u8bb8\u6770\u53cb Jieyou Xu (Joe)", "email": "jieyouxu@outlook.com", "date": "2023-06-07T18:38:12Z"}, "message": "Fix ICE for while loop with assignment condition with LHS place expr", "tree": {"sha": "49c6ecd5d9487c3d3cd22959f9e80e8669ff81f0", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/49c6ecd5d9487c3d3cd22959f9e80e8669ff81f0"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/adbfd0da6860a29d6c7a2adb315e79c91202f7ef", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEze4qXcfh0ileWqZTxf1dMgFP20cFAmSAzpUACgkQxf1dMgFP\n20cDKhAAhQhs8Hf5JMAgUpmGAND8pRpJ5Fg5wMTI8KGrNg9Orm4gl9YsZASZQ098\nEvpXu/rIkJiU5XkqV1KdJKJxSVZ1V5FMHRCioqOKHcUuOueVQQNOLoY4rIYFLZ7x\nmvCJdSQFsVEOgv8oqSsspJszB+WRuu9Zr+09eN5Xbh+TtPf2r/sPx0HpNYUhYOr8\nGl3IvFvGwi19bnRaohxh6aVS76Re8pkldicGWwVWgGNUC+J3pnoaAuHYKT99QzVd\nSP6BjJ0Vts2PqwhBu+3QfFgERybbx5Wr5tt3cl9YxiobO7aPhY0dXGzIA/sKOPF+\nVXT90mJGL4n5pregoIMi15Tb/ifDId1eQ7775/StWto/X9PeiBTDMfAV9hjSoAWv\nvBaVR9Pt2XQHAOq1ops7WJ6Lq2a1nfjlaIGrb3+c8UcCQmpKvyeHNOxbwyFbTstD\n2len7U3dfsuqXbtscZqSpmYTr1I+2AJlXp1t67ta7J4XaZ3xQYd1NoOY108enaE1\nN/Wub2mJt8zU5OmmwmgEjFlbMFSZr9+u9/VQyGiXTU3AhV/xhOBDXVUs5a70hqjU\nZoRCYn6ZDqw07AEK1oUxhGMl1M7giTS0NardSjPU44k/CefRFXDKXVJ+MIuWjC3N\nQ1q8XOPBHej7CsipORDldhpF+mHpzlzTKnM4KIA/2q+rNqI/wcs=\n=2SSA\n-----END PGP SIGNATURE-----", "payload": "tree 49c6ecd5d9487c3d3cd22959f9e80e8669ff81f0\nparent afab3662eb066f05fcdb43c421b72dd19472e752\nauthor \u8bb8\u6770\u53cb Jieyou Xu (Joe) <jieyouxu@outlook.com> 1686156773 +0800\ncommitter \u8bb8\u6770\u53cb Jieyou Xu (Joe) <jieyouxu@outlook.com> 1686163092 +0800\n\nFix ICE for while loop with assignment condition with LHS place expr\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/adbfd0da6860a29d6c7a2adb315e79c91202f7ef", "html_url": "https://github.com/rust-lang/rust/commit/adbfd0da6860a29d6c7a2adb315e79c91202f7ef", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/adbfd0da6860a29d6c7a2adb315e79c91202f7ef/comments", "author": {"login": "jieyouxu", "id": 39484203, "node_id": "MDQ6VXNlcjM5NDg0MjAz", "avatar_url": "https://avatars.githubusercontent.com/u/39484203?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jieyouxu", "html_url": "https://github.com/jieyouxu", "followers_url": "https://api.github.com/users/jieyouxu/followers", "following_url": "https://api.github.com/users/jieyouxu/following{/other_user}", "gists_url": "https://api.github.com/users/jieyouxu/gists{/gist_id}", "starred_url": "https://api.github.com/users/jieyouxu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jieyouxu/subscriptions", "organizations_url": "https://api.github.com/users/jieyouxu/orgs", "repos_url": "https://api.github.com/users/jieyouxu/repos", "events_url": "https://api.github.com/users/jieyouxu/events{/privacy}", "received_events_url": "https://api.github.com/users/jieyouxu/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jieyouxu", "id": 39484203, "node_id": "MDQ6VXNlcjM5NDg0MjAz", "avatar_url": "https://avatars.githubusercontent.com/u/39484203?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jieyouxu", "html_url": "https://github.com/jieyouxu", "followers_url": "https://api.github.com/users/jieyouxu/followers", "following_url": "https://api.github.com/users/jieyouxu/following{/other_user}", "gists_url": "https://api.github.com/users/jieyouxu/gists{/gist_id}", "starred_url": "https://api.github.com/users/jieyouxu/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jieyouxu/subscriptions", "organizations_url": "https://api.github.com/users/jieyouxu/orgs", "repos_url": "https://api.github.com/users/jieyouxu/repos", "events_url": "https://api.github.com/users/jieyouxu/events{/privacy}", "received_events_url": "https://api.github.com/users/jieyouxu/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "afab3662eb066f05fcdb43c421b72dd19472e752", "url": "https://api.github.com/repos/rust-lang/rust/commits/afab3662eb066f05fcdb43c421b72dd19472e752", "html_url": "https://github.com/rust-lang/rust/commit/afab3662eb066f05fcdb43c421b72dd19472e752"}], "stats": {"total": 51, "additions": 47, "deletions": 4}, "files": [{"sha": "30a543aab508fbd1d51a1999e936508c05855a5c", "filename": "compiler/rustc_hir_typeck/src/fn_ctxt/checks.rs", "status": "modified", "additions": 11, "deletions": 2, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/adbfd0da6860a29d6c7a2adb315e79c91202f7ef/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2Fchecks.rs", "raw_url": "https://github.com/rust-lang/rust/raw/adbfd0da6860a29d6c7a2adb315e79c91202f7ef/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2Fchecks.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_hir_typeck%2Fsrc%2Ffn_ctxt%2Fchecks.rs?ref=adbfd0da6860a29d6c7a2adb315e79c91202f7ef", "patch": "@@ -1640,7 +1640,7 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                                                 hir::Stmt {\n                                                     kind:\n                                                         hir::StmtKind::Expr(hir::Expr {\n-                                                            kind: hir::ExprKind::Assign(..),\n+                                                            kind: hir::ExprKind::Assign(lhs, ..),\n                                                             ..\n                                                         }),\n                                                     ..\n@@ -1650,7 +1650,16 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n                                     } = blk\n                                     {\n                                         self.comes_from_while_condition(blk.hir_id, |_| {\n-                                            err.downgrade_to_delayed_bug();\n+                                            // We cannot suppress the error if the LHS of assignment\n+                                            // is a syntactic place expression because E0070 would\n+                                            // not be emitted by `check_lhs_assignable`.\n+                                            let res = self.typeck_results.borrow().expr_ty_opt(lhs);\n+\n+                                            if !lhs.is_syntactic_place_expr()\n+                                                || res.references_error()\n+                                            {\n+                                                err.downgrade_to_delayed_bug();\n+                                            }\n                                         })\n                                     }\n                                 }"}, {"sha": "21b254054bbc043609ec58fa09bede1cd54cf979", "filename": "tests/ui/suggestions/while-let-typo.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/adbfd0da6860a29d6c7a2adb315e79c91202f7ef/tests%2Fui%2Fsuggestions%2Fwhile-let-typo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/adbfd0da6860a29d6c7a2adb315e79c91202f7ef/tests%2Fui%2Fsuggestions%2Fwhile-let-typo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fsuggestions%2Fwhile-let-typo.rs?ref=adbfd0da6860a29d6c7a2adb315e79c91202f7ef", "patch": "@@ -2,7 +2,7 @@ fn main() {\n     let foo = Some(0);\n     let bar = None;\n     while Some(x) = foo {} //~ ERROR cannot find value `x` in this scope\n-    while Some(foo) = bar {}\n+    while Some(foo) = bar {} //~ ERROR mismatched types\n     while 3 = foo {} //~ ERROR mismatched types\n     while Some(3) = foo {} //~ ERROR invalid left-hand side of assignment\n     while x = 5 {} //~ ERROR cannot find value `x` in this scope"}, {"sha": "69a7e5761d42111837735519a5b81e892499570d", "filename": "tests/ui/suggestions/while-let-typo.stderr", "status": "modified", "additions": 12, "deletions": 1, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/adbfd0da6860a29d6c7a2adb315e79c91202f7ef/tests%2Fui%2Fsuggestions%2Fwhile-let-typo.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/adbfd0da6860a29d6c7a2adb315e79c91202f7ef/tests%2Fui%2Fsuggestions%2Fwhile-let-typo.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fsuggestions%2Fwhile-let-typo.stderr?ref=adbfd0da6860a29d6c7a2adb315e79c91202f7ef", "patch": "@@ -20,6 +20,17 @@ help: you might have meant to use pattern matching\n LL |     while let x = 5 {}\n    |           +++\n \n+error[E0308]: mismatched types\n+  --> $DIR/while-let-typo.rs:5:11\n+   |\n+LL |     while Some(foo) = bar {}\n+   |           ^^^^^^^^^^^^^^^ expected `bool`, found `()`\n+   |\n+help: consider adding `let`\n+   |\n+LL |     while let Some(foo) = bar {}\n+   |           +++\n+\n error[E0308]: mismatched types\n   --> $DIR/while-let-typo.rs:6:11\n    |\n@@ -39,7 +50,7 @@ help: you might have meant to use pattern destructuring\n LL |     while let Some(3) = foo {}\n    |           +++\n \n-error: aborting due to 4 previous errors\n+error: aborting due to 5 previous errors\n \n Some errors have detailed explanations: E0070, E0308, E0425.\n For more information about an error, try `rustc --explain E0070`."}, {"sha": "3cb011dc06fcd1574a2d32b955e83d81e3b74955", "filename": "tests/ui/typeck/issue-112385-while-assign-lhs-place-expr-ice.rs", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/adbfd0da6860a29d6c7a2adb315e79c91202f7ef/tests%2Fui%2Ftypeck%2Fissue-112385-while-assign-lhs-place-expr-ice.rs", "raw_url": "https://github.com/rust-lang/rust/raw/adbfd0da6860a29d6c7a2adb315e79c91202f7ef/tests%2Fui%2Ftypeck%2Fissue-112385-while-assign-lhs-place-expr-ice.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ftypeck%2Fissue-112385-while-assign-lhs-place-expr-ice.rs?ref=adbfd0da6860a29d6c7a2adb315e79c91202f7ef", "patch": "@@ -0,0 +1,9 @@\n+// Previously, the while loop with an assignment statement (mistakenly) as the condition\n+// which has a place expr as the LHS would trigger an ICE in typeck.\n+// Reduced from https://github.com/rust-lang/rust/issues/112385.\n+\n+fn main() {\n+    let foo = Some(());\n+    while Some(foo) = None {}\n+    //~^ ERROR mismatched types\n+}"}, {"sha": "cf2648d084079c627c4dc9568aeaaedf7688dca4", "filename": "tests/ui/typeck/issue-112385-while-assign-lhs-place-expr-ice.stderr", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/adbfd0da6860a29d6c7a2adb315e79c91202f7ef/tests%2Fui%2Ftypeck%2Fissue-112385-while-assign-lhs-place-expr-ice.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/adbfd0da6860a29d6c7a2adb315e79c91202f7ef/tests%2Fui%2Ftypeck%2Fissue-112385-while-assign-lhs-place-expr-ice.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Ftypeck%2Fissue-112385-while-assign-lhs-place-expr-ice.stderr?ref=adbfd0da6860a29d6c7a2adb315e79c91202f7ef", "patch": "@@ -0,0 +1,14 @@\n+error[E0308]: mismatched types\n+  --> $DIR/issue-112385-while-assign-lhs-place-expr-ice.rs:7:11\n+   |\n+LL |     while Some(foo) = None {}\n+   |           ^^^^^^^^^^^^^^^^ expected `bool`, found `()`\n+   |\n+help: consider adding `let`\n+   |\n+LL |     while let Some(foo) = None {}\n+   |           +++\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0308`."}]}