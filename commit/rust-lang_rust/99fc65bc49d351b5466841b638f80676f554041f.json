{"sha": "99fc65bc49d351b5466841b638f80676f554041f", "node_id": "C_kwDOAAsO6NoAKDk5ZmM2NWJjNDlkMzUxYjU0NjY4NDFiNjM4ZjgwNjc2ZjU1NDA0MWY", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2022-07-12T11:36:33Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-07-12T11:36:33Z"}, "message": "Rollup merge of #98972 - TaKO8Ki:suggest-adding-missing-zero-to-floating-point-number, r=compiler-errors\n\nSuggest adding a missing zero to a floating point number\n\nfixes #98836", "tree": {"sha": "a45aa763e0e42e7922e29ecd12ddcde7a4f41b2b", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a45aa763e0e42e7922e29ecd12ddcde7a4f41b2b"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/99fc65bc49d351b5466841b638f80676f554041f", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJizVzCCRBK7hj4Ov3rIwAAM9YIAEVspHEVg+jdKfVAyncLM+Ak\n8WASt95dOek9crs6KQ6rR1D1fGxlot6E1dr+1dB+wS0Y7Wh3zPBO6zLth3dIZn6P\ntPtjL0XlQO8B5zVn0amWD+MdFfFug+R+8kUIS/rzbgB2+eLZOX+o9bggF032LT+7\nbZEo15OQKvpurjivk0I5dGGig3YK9poOu2mzTUlXprYKC1VI+tsdAN7gBLVq1iKj\nwA/OuIX5ebpN7kYB7toWQ9WPuyENA9oPmBrl/DRiREdj89wklyQAGqUrcgmJd9Dj\nQSD2pypBlta9XEOOCh5PQbUCJP0niDy7RJJMbmgoHBrgPviIR0xtGeIqLWORsE0=\n=H+xH\n-----END PGP SIGNATURE-----\n", "payload": "tree a45aa763e0e42e7922e29ecd12ddcde7a4f41b2b\nparent 9997c51496f3f56409f0ebad1cfe9b08b4815de0\nparent e03cb7fb9a10bffbec3ccc0a0ca68c6c97112ea8\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1657625793 +0530\ncommitter GitHub <noreply@github.com> 1657625793 +0530\n\nRollup merge of #98972 - TaKO8Ki:suggest-adding-missing-zero-to-floating-point-number, r=compiler-errors\n\nSuggest adding a missing zero to a floating point number\n\nfixes #98836\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/99fc65bc49d351b5466841b638f80676f554041f", "html_url": "https://github.com/rust-lang/rust/commit/99fc65bc49d351b5466841b638f80676f554041f", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/99fc65bc49d351b5466841b638f80676f554041f/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9997c51496f3f56409f0ebad1cfe9b08b4815de0", "url": "https://api.github.com/repos/rust-lang/rust/commits/9997c51496f3f56409f0ebad1cfe9b08b4815de0", "html_url": "https://github.com/rust-lang/rust/commit/9997c51496f3f56409f0ebad1cfe9b08b4815de0"}, {"sha": "e03cb7fb9a10bffbec3ccc0a0ca68c6c97112ea8", "url": "https://api.github.com/repos/rust-lang/rust/commits/e03cb7fb9a10bffbec3ccc0a0ca68c6c97112ea8", "html_url": "https://github.com/rust-lang/rust/commit/e03cb7fb9a10bffbec3ccc0a0ca68c6c97112ea8"}], "stats": {"total": 223, "additions": 219, "deletions": 4}, "files": [{"sha": "1d3608048f2847460c72677343536df31b4e5d3d", "filename": "compiler/rustc_typeck/src/check/expr.rs", "status": "modified", "additions": 45, "deletions": 4, "changes": 49, "blob_url": "https://github.com/rust-lang/rust/blob/99fc65bc49d351b5466841b638f80676f554041f/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fexpr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/99fc65bc49d351b5466841b638f80676f554041f/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fexpr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fexpr.rs?ref=99fc65bc49d351b5466841b638f80676f554041f", "patch": "@@ -48,7 +48,7 @@ use rustc_middle::ty::{self, AdtKind, DefIdTree, Ty, TypeVisitable};\n use rustc_session::parse::feature_err;\n use rustc_span::hygiene::DesugaringKind;\n use rustc_span::lev_distance::find_best_match_for_name;\n-use rustc_span::source_map::Span;\n+use rustc_span::source_map::{Span, Spanned};\n use rustc_span::symbol::{kw, sym, Ident, Symbol};\n use rustc_span::{BytePos, Pos};\n use rustc_target::spec::abi::Abi::RustIntrinsic;\n@@ -2162,14 +2162,55 @@ impl<'a, 'tcx> FnCtxt<'a, 'tcx> {\n         } else if !expr_t.is_primitive_ty() {\n             self.ban_nonexisting_field(field, base, expr, expr_t);\n         } else {\n-            type_error_struct!(\n+            let field_name = field.to_string();\n+            let mut err = type_error_struct!(\n                 self.tcx().sess,\n                 field.span,\n                 expr_t,\n                 E0610,\n                 \"`{expr_t}` is a primitive type and therefore doesn't have fields\",\n-            )\n-            .emit();\n+            );\n+            let is_valid_suffix = |field: String| {\n+                if field == \"f32\" || field == \"f64\" {\n+                    return true;\n+                }\n+                let mut chars = field.chars().peekable();\n+                match chars.peek() {\n+                    Some('e') | Some('E') => {\n+                        chars.next();\n+                        if let Some(c) = chars.peek()\n+                            && !c.is_numeric() && *c != '-' && *c != '+'\n+                        {\n+                            return false;\n+                        }\n+                        while let Some(c) = chars.peek() {\n+                            if !c.is_numeric() {\n+                                break;\n+                            }\n+                            chars.next();\n+                        }\n+                    }\n+                    _ => (),\n+                }\n+                let suffix = chars.collect::<String>();\n+                suffix.is_empty() || suffix == \"f32\" || suffix == \"f64\"\n+            };\n+            if let ty::Infer(ty::IntVar(_)) = expr_t.kind()\n+                && let ExprKind::Lit(Spanned {\n+                    node: ast::LitKind::Int(_, ast::LitIntType::Unsuffixed),\n+                    ..\n+                }) = base.kind\n+                && !base.span.from_expansion()\n+                && is_valid_suffix(field_name)\n+            {\n+                err.span_suggestion_verbose(\n+                    field.span.shrink_to_lo(),\n+                    \"If the number is meant to be a floating point number, consider adding a `0` after the period\",\n+                    '0',\n+                    Applicability::MaybeIncorrect,\n+                );\n+            }\n+            err.emit();\n         }\n \n         self.tcx().ty_error()"}, {"sha": "501f4b6ef9ebc42ac3f9826c49533ee43142ee65", "filename": "src/test/ui/typeck/do-not-suggest-adding-missing-zero-to-floating-point-number.rs", "status": "added", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/99fc65bc49d351b5466841b638f80676f554041f/src%2Ftest%2Fui%2Ftypeck%2Fdo-not-suggest-adding-missing-zero-to-floating-point-number.rs", "raw_url": "https://github.com/rust-lang/rust/raw/99fc65bc49d351b5466841b638f80676f554041f/src%2Ftest%2Fui%2Ftypeck%2Fdo-not-suggest-adding-missing-zero-to-floating-point-number.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Fdo-not-suggest-adding-missing-zero-to-floating-point-number.rs?ref=99fc65bc49d351b5466841b638f80676f554041f", "patch": "@@ -0,0 +1,21 @@\n+macro_rules! num { () => { 1 } }\n+\n+fn main() {\n+    let x = 1i32;\n+    x.e10; //~ERROR `i32` is a primitive type and therefore doesn't have fields\n+\n+    let y = 1;\n+    y.e10; //~ERROR `{integer}` is a primitive type and therefore doesn't have fields\n+\n+    2u32.e10; //~ERROR `u32` is a primitive type and therefore doesn't have fields\n+\n+    num!().e10; //~ERROR `{integer}` is a primitive type and therefore doesn't have fields\n+\n+    2.e10foo; //~ERROR `{integer}` is a primitive type and therefore doesn't have fields\n+\n+    42._;\n+    //~^ERROR expected identifier, found reserved identifier `_`\n+    //~|ERROR `{integer}` is a primitive type and therefore doesn't have fields\n+\n+    42.a; //~ERROR `{integer}` is a primitive type and therefore doesn't have fields\n+}"}, {"sha": "1ef1d4c28e47991519421807aeae5459391857a8", "filename": "src/test/ui/typeck/do-not-suggest-adding-missing-zero-to-floating-point-number.stderr", "status": "added", "additions": 51, "deletions": 0, "changes": 51, "blob_url": "https://github.com/rust-lang/rust/blob/99fc65bc49d351b5466841b638f80676f554041f/src%2Ftest%2Fui%2Ftypeck%2Fdo-not-suggest-adding-missing-zero-to-floating-point-number.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/99fc65bc49d351b5466841b638f80676f554041f/src%2Ftest%2Fui%2Ftypeck%2Fdo-not-suggest-adding-missing-zero-to-floating-point-number.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Fdo-not-suggest-adding-missing-zero-to-floating-point-number.stderr?ref=99fc65bc49d351b5466841b638f80676f554041f", "patch": "@@ -0,0 +1,51 @@\n+error: expected identifier, found reserved identifier `_`\n+  --> $DIR/do-not-suggest-adding-missing-zero-to-floating-point-number.rs:16:8\n+   |\n+LL |     42._;\n+   |        ^ expected identifier, found reserved identifier\n+\n+error[E0610]: `i32` is a primitive type and therefore doesn't have fields\n+  --> $DIR/do-not-suggest-adding-missing-zero-to-floating-point-number.rs:5:7\n+   |\n+LL |     x.e10;\n+   |       ^^^\n+\n+error[E0610]: `{integer}` is a primitive type and therefore doesn't have fields\n+  --> $DIR/do-not-suggest-adding-missing-zero-to-floating-point-number.rs:8:7\n+   |\n+LL |     y.e10;\n+   |       ^^^\n+\n+error[E0610]: `u32` is a primitive type and therefore doesn't have fields\n+  --> $DIR/do-not-suggest-adding-missing-zero-to-floating-point-number.rs:10:10\n+   |\n+LL |     2u32.e10;\n+   |          ^^^\n+\n+error[E0610]: `{integer}` is a primitive type and therefore doesn't have fields\n+  --> $DIR/do-not-suggest-adding-missing-zero-to-floating-point-number.rs:12:12\n+   |\n+LL |     num!().e10;\n+   |            ^^^\n+\n+error[E0610]: `{integer}` is a primitive type and therefore doesn't have fields\n+  --> $DIR/do-not-suggest-adding-missing-zero-to-floating-point-number.rs:14:7\n+   |\n+LL |     2.e10foo;\n+   |       ^^^^^^\n+\n+error[E0610]: `{integer}` is a primitive type and therefore doesn't have fields\n+  --> $DIR/do-not-suggest-adding-missing-zero-to-floating-point-number.rs:16:8\n+   |\n+LL |     42._;\n+   |        ^\n+\n+error[E0610]: `{integer}` is a primitive type and therefore doesn't have fields\n+  --> $DIR/do-not-suggest-adding-missing-zero-to-floating-point-number.rs:20:8\n+   |\n+LL |     42.a;\n+   |        ^\n+\n+error: aborting due to 8 previous errors\n+\n+For more information about this error, try `rustc --explain E0610`."}, {"sha": "ba83e79005b33feea10a38698932daf020688978", "filename": "src/test/ui/typeck/suggest-adding-missing-zero-to-floating-point-number.fixed", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/99fc65bc49d351b5466841b638f80676f554041f/src%2Ftest%2Fui%2Ftypeck%2Fsuggest-adding-missing-zero-to-floating-point-number.fixed", "raw_url": "https://github.com/rust-lang/rust/raw/99fc65bc49d351b5466841b638f80676f554041f/src%2Ftest%2Fui%2Ftypeck%2Fsuggest-adding-missing-zero-to-floating-point-number.fixed", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Fsuggest-adding-missing-zero-to-floating-point-number.fixed?ref=99fc65bc49d351b5466841b638f80676f554041f", "patch": "@@ -0,0 +1,11 @@\n+// run-rustfix\n+\n+fn main() {\n+    2.0e1; //~ERROR `{integer}` is a primitive type and therefore doesn't have fields\n+    2.0E1; //~ERROR `{integer}` is a primitive type and therefore doesn't have fields\n+    2.0f32; //~ERROR `{integer}` is a primitive type and therefore doesn't have fields\n+    2.0f64; //~ERROR `{integer}` is a primitive type and therefore doesn't have fields\n+    2.0e+12; //~ERROR `{integer}` is a primitive type and therefore doesn't have fields\n+    2.0e-12; //~ERROR `{integer}` is a primitive type and therefore doesn't have fields\n+    2.0e1f32; //~ERROR `{integer}` is a primitive type and therefore doesn't have fields\n+}"}, {"sha": "c102447f6028849e5b32b719a55f110a693ef5ba", "filename": "src/test/ui/typeck/suggest-adding-missing-zero-to-floating-point-number.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/99fc65bc49d351b5466841b638f80676f554041f/src%2Ftest%2Fui%2Ftypeck%2Fsuggest-adding-missing-zero-to-floating-point-number.rs", "raw_url": "https://github.com/rust-lang/rust/raw/99fc65bc49d351b5466841b638f80676f554041f/src%2Ftest%2Fui%2Ftypeck%2Fsuggest-adding-missing-zero-to-floating-point-number.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Fsuggest-adding-missing-zero-to-floating-point-number.rs?ref=99fc65bc49d351b5466841b638f80676f554041f", "patch": "@@ -0,0 +1,11 @@\n+// run-rustfix\n+\n+fn main() {\n+    2.e1; //~ERROR `{integer}` is a primitive type and therefore doesn't have fields\n+    2.E1; //~ERROR `{integer}` is a primitive type and therefore doesn't have fields\n+    2.f32; //~ERROR `{integer}` is a primitive type and therefore doesn't have fields\n+    2.f64; //~ERROR `{integer}` is a primitive type and therefore doesn't have fields\n+    2.e+12; //~ERROR `{integer}` is a primitive type and therefore doesn't have fields\n+    2.e-12; //~ERROR `{integer}` is a primitive type and therefore doesn't have fields\n+    2.e1f32; //~ERROR `{integer}` is a primitive type and therefore doesn't have fields\n+}"}, {"sha": "e8e069708a864169516559a9ad01d9d0a4fe875f", "filename": "src/test/ui/typeck/suggest-adding-missing-zero-to-floating-point-number.stderr", "status": "added", "additions": 80, "deletions": 0, "changes": 80, "blob_url": "https://github.com/rust-lang/rust/blob/99fc65bc49d351b5466841b638f80676f554041f/src%2Ftest%2Fui%2Ftypeck%2Fsuggest-adding-missing-zero-to-floating-point-number.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/99fc65bc49d351b5466841b638f80676f554041f/src%2Ftest%2Fui%2Ftypeck%2Fsuggest-adding-missing-zero-to-floating-point-number.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Ftypeck%2Fsuggest-adding-missing-zero-to-floating-point-number.stderr?ref=99fc65bc49d351b5466841b638f80676f554041f", "patch": "@@ -0,0 +1,80 @@\n+error[E0610]: `{integer}` is a primitive type and therefore doesn't have fields\n+  --> $DIR/suggest-adding-missing-zero-to-floating-point-number.rs:4:7\n+   |\n+LL |     2.e1;\n+   |       ^^\n+   |\n+help: If the number is meant to be a floating point number, consider adding a `0` after the period\n+   |\n+LL |     2.0e1;\n+   |       +\n+\n+error[E0610]: `{integer}` is a primitive type and therefore doesn't have fields\n+  --> $DIR/suggest-adding-missing-zero-to-floating-point-number.rs:5:7\n+   |\n+LL |     2.E1;\n+   |       ^^\n+   |\n+help: If the number is meant to be a floating point number, consider adding a `0` after the period\n+   |\n+LL |     2.0E1;\n+   |       +\n+\n+error[E0610]: `{integer}` is a primitive type and therefore doesn't have fields\n+  --> $DIR/suggest-adding-missing-zero-to-floating-point-number.rs:6:7\n+   |\n+LL |     2.f32;\n+   |       ^^^\n+   |\n+help: If the number is meant to be a floating point number, consider adding a `0` after the period\n+   |\n+LL |     2.0f32;\n+   |       +\n+\n+error[E0610]: `{integer}` is a primitive type and therefore doesn't have fields\n+  --> $DIR/suggest-adding-missing-zero-to-floating-point-number.rs:7:7\n+   |\n+LL |     2.f64;\n+   |       ^^^\n+   |\n+help: If the number is meant to be a floating point number, consider adding a `0` after the period\n+   |\n+LL |     2.0f64;\n+   |       +\n+\n+error[E0610]: `{integer}` is a primitive type and therefore doesn't have fields\n+  --> $DIR/suggest-adding-missing-zero-to-floating-point-number.rs:8:7\n+   |\n+LL |     2.e+12;\n+   |       ^\n+   |\n+help: If the number is meant to be a floating point number, consider adding a `0` after the period\n+   |\n+LL |     2.0e+12;\n+   |       +\n+\n+error[E0610]: `{integer}` is a primitive type and therefore doesn't have fields\n+  --> $DIR/suggest-adding-missing-zero-to-floating-point-number.rs:9:7\n+   |\n+LL |     2.e-12;\n+   |       ^\n+   |\n+help: If the number is meant to be a floating point number, consider adding a `0` after the period\n+   |\n+LL |     2.0e-12;\n+   |       +\n+\n+error[E0610]: `{integer}` is a primitive type and therefore doesn't have fields\n+  --> $DIR/suggest-adding-missing-zero-to-floating-point-number.rs:10:7\n+   |\n+LL |     2.e1f32;\n+   |       ^^^^^\n+   |\n+help: If the number is meant to be a floating point number, consider adding a `0` after the period\n+   |\n+LL |     2.0e1f32;\n+   |       +\n+\n+error: aborting due to 7 previous errors\n+\n+For more information about this error, try `rustc --explain E0610`."}]}