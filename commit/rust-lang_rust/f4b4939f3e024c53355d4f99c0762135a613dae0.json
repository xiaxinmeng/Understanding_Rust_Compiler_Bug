{"sha": "f4b4939f3e024c53355d4f99c0762135a613dae0", "node_id": "MDY6Q29tbWl0NzI0NzEyOmY0YjQ5MzlmM2UwMjRjNTMzNTVkNGY5OWMwNzYyMTM1YTYxM2RhZTA=", "commit": {"author": {"name": "Tom Tromey", "email": "tom@tromey.com", "date": "2018-09-25T15:13:02Z"}, "committer": {"name": "Tom Tromey", "email": "tom@tromey.com", "date": "2018-09-25T15:13:02Z"}, "message": "Improvements to finding LLVM's FileCheck\n\nThis patch adds a few improvements to how the build system finds\nLLVM's FileCheck program.\n\n* On Fedora, the system LLVM installs FileCheck in the \"llvm\"\n  subdirectory of the LLVM libdir.  This patch teaches the build\n  system to look there.\n\n* This adds a configure option to specify which llvm-config executable\n  to use.  This is handy on systems that can parallel install multiple\n  versions of LLVM; for example I can now:\n\n    ./configure --llvm-config=/bin/llvm-config-5.0-64\n\n  ... to build against LLVM 5, rather than whatever the default\n  llvm-config might be.\n\n* Finally, this adds a configure- and config.toml- option to set the\n  path to FileCheck.  This is handy when building against an LLVM\n  where FileCheck was not installed.  This happens on compatibility\n  installs of LLVM on Fedora.", "tree": {"sha": "d11ca02d7988e525f0dbf85f4676c87ff04859d6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d11ca02d7988e525f0dbf85f4676c87ff04859d6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f4b4939f3e024c53355d4f99c0762135a613dae0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f4b4939f3e024c53355d4f99c0762135a613dae0", "html_url": "https://github.com/rust-lang/rust/commit/f4b4939f3e024c53355d4f99c0762135a613dae0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f4b4939f3e024c53355d4f99c0762135a613dae0/comments", "author": {"login": "tromey", "id": 1557670, "node_id": "MDQ6VXNlcjE1NTc2NzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tromey", "html_url": "https://github.com/tromey", "followers_url": "https://api.github.com/users/tromey/followers", "following_url": "https://api.github.com/users/tromey/following{/other_user}", "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}", "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tromey/subscriptions", "organizations_url": "https://api.github.com/users/tromey/orgs", "repos_url": "https://api.github.com/users/tromey/repos", "events_url": "https://api.github.com/users/tromey/events{/privacy}", "received_events_url": "https://api.github.com/users/tromey/received_events", "type": "User", "site_admin": false}, "committer": {"login": "tromey", "id": 1557670, "node_id": "MDQ6VXNlcjE1NTc2NzA=", "avatar_url": "https://avatars.githubusercontent.com/u/1557670?v=4", "gravatar_id": "", "url": "https://api.github.com/users/tromey", "html_url": "https://github.com/tromey", "followers_url": "https://api.github.com/users/tromey/followers", "following_url": "https://api.github.com/users/tromey/following{/other_user}", "gists_url": "https://api.github.com/users/tromey/gists{/gist_id}", "starred_url": "https://api.github.com/users/tromey/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/tromey/subscriptions", "organizations_url": "https://api.github.com/users/tromey/orgs", "repos_url": "https://api.github.com/users/tromey/repos", "events_url": "https://api.github.com/users/tromey/events{/privacy}", "received_events_url": "https://api.github.com/users/tromey/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ae366637fedf6f34185e54fc7b2d725b1a458ff6", "url": "https://api.github.com/repos/rust-lang/rust/commits/ae366637fedf6f34185e54fc7b2d725b1a458ff6", "html_url": "https://github.com/rust-lang/rust/commit/ae366637fedf6f34185e54fc7b2d725b1a458ff6"}], "stats": {"total": 40, "additions": 38, "deletions": 2}, "files": [{"sha": "66eaab236f7c0fcb6b1c94c347cb84e8bdbf357a", "filename": "config.toml.example", "status": "modified", "additions": 5, "deletions": 0, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/f4b4939f3e024c53355d4f99c0762135a613dae0/config.toml.example", "raw_url": "https://github.com/rust-lang/rust/raw/f4b4939f3e024c53355d4f99c0762135a613dae0/config.toml.example", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/config.toml.example?ref=f4b4939f3e024c53355d4f99c0762135a613dae0", "patch": "@@ -322,6 +322,7 @@\n \n # Flag indicating whether codegen tests will be run or not. If you get an error\n # saying that the FileCheck executable is missing, you may want to disable this.\n+# Also see the target's llvm-filecheck option.\n #codegen-tests = true\n \n # Flag indicating whether git info will be retrieved from .git automatically.\n@@ -416,6 +417,10 @@\n # target.\n #llvm-config = \"../path/to/llvm/root/bin/llvm-config\"\n \n+# Normally the build system can find LLVM's FileCheck utility, but if\n+# not, you can specify an explicit file name for it.\n+#llvm-filecheck = \"/path/to/FileCheck\"\n+\n # Path to the custom jemalloc static library to link into the standard library\n # by default. This is only used if jemalloc is still enabled above\n #jemalloc = \"/path/to/jemalloc/libjemalloc_pic.a\""}, {"sha": "3a4bc526d03bf3cec35b30bf5f2332f39195aeb7", "filename": "src/bootstrap/config.rs", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/f4b4939f3e024c53355d4f99c0762135a613dae0/src%2Fbootstrap%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f4b4939f3e024c53355d4f99c0762135a613dae0/src%2Fbootstrap%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fconfig.rs?ref=f4b4939f3e024c53355d4f99c0762135a613dae0", "patch": "@@ -162,6 +162,8 @@ pub struct Config {\n pub struct Target {\n     /// Some(path to llvm-config) if using an external LLVM.\n     pub llvm_config: Option<PathBuf>,\n+    /// Some(path to FileCheck) if one was specified.\n+    pub llvm_filecheck: Option<PathBuf>,\n     pub jemalloc: Option<PathBuf>,\n     pub cc: Option<PathBuf>,\n     pub cxx: Option<PathBuf>,\n@@ -330,6 +332,7 @@ struct Rust {\n #[serde(deny_unknown_fields, rename_all = \"kebab-case\")]\n struct TomlTarget {\n     llvm_config: Option<String>,\n+    llvm_filecheck: Option<String>,\n     jemalloc: Option<String>,\n     cc: Option<String>,\n     cxx: Option<String>,\n@@ -583,6 +586,9 @@ impl Config {\n                 if let Some(ref s) = cfg.llvm_config {\n                     target.llvm_config = Some(config.src.join(s));\n                 }\n+                if let Some(ref s) = cfg.llvm_filecheck {\n+                    target.llvm_filecheck = Some(config.src.join(s));\n+                }\n                 if let Some(ref s) = cfg.jemalloc {\n                     target.jemalloc = Some(config.src.join(s));\n                 }"}, {"sha": "75831dbe262aea95feede7674be3c85e5b227a00", "filename": "src/bootstrap/configure.py", "status": "modified", "additions": 6, "deletions": 0, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/f4b4939f3e024c53355d4f99c0762135a613dae0/src%2Fbootstrap%2Fconfigure.py", "raw_url": "https://github.com/rust-lang/rust/raw/f4b4939f3e024c53355d4f99c0762135a613dae0/src%2Fbootstrap%2Fconfigure.py", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fconfigure.py?ref=f4b4939f3e024c53355d4f99c0762135a613dae0", "patch": "@@ -95,6 +95,8 @@ def v(*args):\n v(\"bindir\", \"install.bindir\", \"install binaries\")\n \n v(\"llvm-root\", None, \"set LLVM root\")\n+v(\"llvm-config\", None, \"set path to llvm-config\")\n+v(\"llvm-filecheck\", None, \"set path to LLVM's FileCheck utility\")\n v(\"python\", \"build.python\", \"set path to python\")\n v(\"jemalloc-root\", None, \"set directory where libjemalloc_pic.a is located\")\n v(\"android-cross-path\", \"target.arm-linux-androideabi.android-ndk\",\n@@ -323,6 +325,10 @@ def set(key, value):\n         set('build.cargo', value + '/bin/cargo')\n     elif option.name == 'llvm-root':\n         set('target.{}.llvm-config'.format(build()), value + '/bin/llvm-config')\n+    elif option.name == 'llvm-config':\n+        set('target.{}.llvm-config'.format(build()), value)\n+    elif option.name == 'llvm-filecheck':\n+        set('target.{}.llvm-filecheck'.format(build()), value)\n     elif option.name == 'jemalloc-root':\n         set('target.{}.jemalloc'.format(build()), value + '/libjemalloc_pic.a')\n     elif option.name == 'tools':"}, {"sha": "75c18cd2dd41c81ac8041ce97a29524a4a5b36f5", "filename": "src/bootstrap/lib.rs", "status": "modified", "additions": 21, "deletions": 2, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/f4b4939f3e024c53355d4f99c0762135a613dae0/src%2Fbootstrap%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f4b4939f3e024c53355d4f99c0762135a613dae0/src%2Fbootstrap%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Flib.rs?ref=f4b4939f3e024c53355d4f99c0762135a613dae0", "patch": "@@ -641,9 +641,28 @@ impl Build {\n     /// Returns the path to `FileCheck` binary for the specified target\n     fn llvm_filecheck(&self, target: Interned<String>) -> PathBuf {\n         let target_config = self.config.target_config.get(&target);\n-        if let Some(s) = target_config.and_then(|c| c.llvm_config.as_ref()) {\n+        if let Some(s) = target_config.and_then(|c| c.llvm_filecheck.as_ref()) {\n+            s.to_path_buf()\n+        } else if let Some(s) = target_config.and_then(|c| c.llvm_config.as_ref()) {\n             let llvm_bindir = output(Command::new(s).arg(\"--bindir\"));\n-            Path::new(llvm_bindir.trim()).join(exe(\"FileCheck\", &*target))\n+            let filecheck = Path::new(llvm_bindir.trim()).join(exe(\"FileCheck\", &*target));\n+            if filecheck.exists() {\n+                filecheck\n+            } else {\n+                // On Fedora the system LLVM installs FileCheck in the\n+                // llvm subdirectory of the libdir.\n+                let llvm_libdir = output(Command::new(s).arg(\"--libdir\"));\n+                let lib_filecheck = Path::new(llvm_libdir.trim())\n+                    .join(\"llvm\").join(exe(\"FileCheck\", &*target));\n+                if lib_filecheck.exists() {\n+                    lib_filecheck\n+                } else {\n+                    // Return the most normal file name, even though\n+                    // it doesn't exist, so that any error message\n+                    // refers to that.\n+                    filecheck\n+                }\n+            }\n         } else {\n             let base = self.llvm_out(self.config.build).join(\"build\");\n             let base = if !self.config.ninja && self.config.build.contains(\"msvc\") {"}]}