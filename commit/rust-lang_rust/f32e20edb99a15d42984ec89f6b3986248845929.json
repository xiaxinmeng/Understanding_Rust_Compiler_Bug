{"sha": "f32e20edb99a15d42984ec89f6b3986248845929", "node_id": "C_kwDOAAsO6NoAKGYzMmUyMGVkYjk5YTE1ZDQyOTg0ZWM4OWY2YjM5ODYyNDg4NDU5Mjk", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-01-09T16:04:04Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2023-01-09T16:04:04Z"}, "message": "Auto merge of #13915 - Veykril:lsp-server-msg, r=Veykril\n\nMake it clearer when the server expects an initialized notification", "tree": {"sha": "a54de66907687966746d02ffcd33cf2d13d96467", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a54de66907687966746d02ffcd33cf2d13d96467"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f32e20edb99a15d42984ec89f6b3986248845929", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f32e20edb99a15d42984ec89f6b3986248845929", "html_url": "https://github.com/rust-lang/rust/commit/f32e20edb99a15d42984ec89f6b3986248845929", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f32e20edb99a15d42984ec89f6b3986248845929/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fd300eebc9bd0c2a98591609cb88b1739459eb20", "url": "https://api.github.com/repos/rust-lang/rust/commits/fd300eebc9bd0c2a98591609cb88b1739459eb20", "html_url": "https://github.com/rust-lang/rust/commit/fd300eebc9bd0c2a98591609cb88b1739459eb20"}, {"sha": "9eb50d3cde97690f8149f560b70f56f6dafa4da3", "url": "https://api.github.com/repos/rust-lang/rust/commits/9eb50d3cde97690f8149f560b70f56f6dafa4da3", "html_url": "https://github.com/rust-lang/rust/commit/9eb50d3cde97690f8149f560b70f56f6dafa4da3"}], "stats": {"total": 24, "additions": 8, "deletions": 16}, "files": [{"sha": "beccde40a89789bd9ebc6253edf512f2f649f8e0", "filename": "lib/lsp-server/src/lib.rs", "status": "modified", "additions": 8, "deletions": 16, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/f32e20edb99a15d42984ec89f6b3986248845929/lib%2Flsp-server%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f32e20edb99a15d42984ec89f6b3986248845929/lib%2Flsp-server%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/lib%2Flsp-server%2Fsrc%2Flib.rs?ref=f32e20edb99a15d42984ec89f6b3986248845929", "patch": "@@ -114,10 +114,8 @@ impl Connection {\n     /// ```\n     pub fn initialize_start(&self) -> Result<(RequestId, serde_json::Value), ProtocolError> {\n         loop {\n-            match self.receiver.recv() {\n-                Ok(Message::Request(req)) if req.is_initialize() => {\n-                    return Ok((req.id, req.params))\n-                }\n+            break match self.receiver.recv() {\n+                Ok(Message::Request(req)) if req.is_initialize() => Ok((req.id, req.params)),\n                 // Respond to non-initialize requests with ServerNotInitialized\n                 Ok(Message::Request(req)) => {\n                     let resp = Response::new_err(\n@@ -126,14 +124,11 @@ impl Connection {\n                         format!(\"expected initialize request, got {req:?}\"),\n                     );\n                     self.sender.send(resp.into()).unwrap();\n+                    continue;\n                 }\n-                Ok(msg) => {\n-                    return Err(ProtocolError(format!(\"expected initialize request, got {msg:?}\")))\n-                }\n+                Ok(msg) => Err(ProtocolError(format!(\"expected initialize request, got {msg:?}\"))),\n                 Err(e) => {\n-                    return Err(ProtocolError(format!(\n-                        \"expected initialize request, got error: {e}\"\n-                    )))\n+                    Err(ProtocolError(format!(\"expected initialize request, got error: {e}\")))\n                 }\n             };\n         }\n@@ -148,17 +143,14 @@ impl Connection {\n         let resp = Response::new_ok(initialize_id, initialize_result);\n         self.sender.send(resp.into()).unwrap();\n         match &self.receiver.recv() {\n-            Ok(Message::Notification(n)) if n.is_initialized() => (),\n+            Ok(Message::Notification(n)) if n.is_initialized() => Ok(()),\n             Ok(msg) => {\n-                return Err(ProtocolError(format!(\"expected Message::Notification, got: {msg:?}\",)))\n+                Err(ProtocolError(format!(r#\"expected initialized notification, got: {msg:?}\"#)))\n             }\n             Err(e) => {\n-                return Err(ProtocolError(format!(\n-                    \"expected initialized notification, got error: {e}\",\n-                )))\n+                Err(ProtocolError(format!(\"expected initialized notification, got error: {e}\",)))\n             }\n         }\n-        Ok(())\n     }\n \n     /// Initialize the connection. Sends the server capabilities"}]}