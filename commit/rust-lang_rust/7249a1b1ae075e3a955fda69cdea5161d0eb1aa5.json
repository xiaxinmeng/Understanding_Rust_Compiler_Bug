{"sha": "7249a1b1ae075e3a955fda69cdea5161d0eb1aa5", "node_id": "MDY6Q29tbWl0NzI0NzEyOjcyNDlhMWIxYWUwNzVlM2E5NTVmZGE2OWNkZWE1MTYxZDBlYjFhYTU=", "commit": {"author": {"name": "Philipp Hansch", "email": "dev@phansch.net", "date": "2018-09-13T06:42:19Z"}, "committer": {"name": "Philipp Hansch", "email": "dev@phansch.net", "date": "2018-09-13T19:26:45Z"}, "message": "Suggest valid crate type if invalid\n\nThis adds a suggestion to the `invalid_crate_types` lint.\n\nThe suggestion is based on the Levenshtein distance to existing crate\ntypes. If no suggestion is found it will show the lint without any\nsuggestions.", "tree": {"sha": "f02a6cb97c40d94a899d94b7835b6b6cb7cf129d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f02a6cb97c40d94a899d94b7835b6b6cb7cf129d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7249a1b1ae075e3a955fda69cdea5161d0eb1aa5", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIcBAABCAAGBQJbmrn2AAoJELb6Bqbg4mZbTncP/jlPF2q3VwnTnFRVPqaatNPl\nnJeTk6wBreqC8UlkZ+V5y85n+xtT5SqxlacWGT9KCJhZIAMa8aMv9uxVzSkojU3j\nvuAiAK6KbYLO5JEw0wa4j79hR1Ha+LElsS0nyYFBCzJqpshADrfMuhAK8d76mIQ2\nKe6v6oCOIA887kM7XDGbh7tHTZiO7eO1t+DN/oIrL+0k/t4903zJbno815jeFtWx\nQWTqR+WAZwEZh+OqjnThLNtl0tsrFcUmZKrf7DR6GabTIcMhXXgGzn7xtkl930gm\nalAUNEb8561+p/AplqBqiEnK41su7PyLRPnN8gCV3ztpmRS0WUGzmGjCrzb8PEKo\n7TbzihfKzZ/981ssC6BrDimyGqNa78H/qNpgFbSoH8+d80aAo8KCvP8KXOvO3VNS\nz4knAGNAcHrLAfy8pERDy0NH67a61ZgCVK0OJ+13kdkty7Ih1zkhox0mJHBUiPRF\nd4WUxkwpFkcHxqRotOFXwMET4Z1EoBp0n4WJmsbiQsRSzDzp5mk3aFHAeJsosm4t\n4u6+XdnJWHBqYOJ1+IUxYMCVovhzTUquHAX26VPdCBqVsEwarBYIWOiA9RXMdRy3\na5/41MuFpZy3OgmVzIN6z0ExqQN5d5TGUCNpbz8GvOS5MSX7n1JMZYXOFTL9dyLf\nA+A85Uuc9Qp/Xw6c08Ar\n=yLAa\n-----END PGP SIGNATURE-----", "payload": "tree f02a6cb97c40d94a899d94b7835b6b6cb7cf129d\nparent d8af8b66d948ff394db1b3a50e2e4fbe02512239\nauthor Philipp Hansch <dev@phansch.net> 1536820939 +0200\ncommitter Philipp Hansch <dev@phansch.net> 1536866805 +0200\n\nSuggest valid crate type if invalid\n\nThis adds a suggestion to the `invalid_crate_types` lint.\n\nThe suggestion is based on the Levenshtein distance to existing crate\ntypes. If no suggestion is found it will show the lint without any\nsuggestions.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7249a1b1ae075e3a955fda69cdea5161d0eb1aa5", "html_url": "https://github.com/rust-lang/rust/commit/7249a1b1ae075e3a955fda69cdea5161d0eb1aa5", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7249a1b1ae075e3a955fda69cdea5161d0eb1aa5/comments", "author": {"login": "phansch", "id": 2042399, "node_id": "MDQ6VXNlcjIwNDIzOTk=", "avatar_url": "https://avatars.githubusercontent.com/u/2042399?v=4", "gravatar_id": "", "url": "https://api.github.com/users/phansch", "html_url": "https://github.com/phansch", "followers_url": "https://api.github.com/users/phansch/followers", "following_url": "https://api.github.com/users/phansch/following{/other_user}", "gists_url": "https://api.github.com/users/phansch/gists{/gist_id}", "starred_url": "https://api.github.com/users/phansch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/phansch/subscriptions", "organizations_url": "https://api.github.com/users/phansch/orgs", "repos_url": "https://api.github.com/users/phansch/repos", "events_url": "https://api.github.com/users/phansch/events{/privacy}", "received_events_url": "https://api.github.com/users/phansch/received_events", "type": "User", "site_admin": false}, "committer": {"login": "phansch", "id": 2042399, "node_id": "MDQ6VXNlcjIwNDIzOTk=", "avatar_url": "https://avatars.githubusercontent.com/u/2042399?v=4", "gravatar_id": "", "url": "https://api.github.com/users/phansch", "html_url": "https://github.com/phansch", "followers_url": "https://api.github.com/users/phansch/followers", "following_url": "https://api.github.com/users/phansch/following{/other_user}", "gists_url": "https://api.github.com/users/phansch/gists{/gist_id}", "starred_url": "https://api.github.com/users/phansch/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/phansch/subscriptions", "organizations_url": "https://api.github.com/users/phansch/orgs", "repos_url": "https://api.github.com/users/phansch/repos", "events_url": "https://api.github.com/users/phansch/events{/privacy}", "received_events_url": "https://api.github.com/users/phansch/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "d8af8b66d948ff394db1b3a50e2e4fbe02512239", "url": "https://api.github.com/repos/rust-lang/rust/commits/d8af8b66d948ff394db1b3a50e2e4fbe02512239", "html_url": "https://github.com/rust-lang/rust/commit/d8af8b66d948ff394db1b3a50e2e4fbe02512239"}], "stats": {"total": 153, "additions": 143, "deletions": 10}, "files": [{"sha": "e6452ad09278e45a7282490e0582a40d4c9efba2", "filename": "src/librustc/lint/builtin.rs", "status": "modified", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/7249a1b1ae075e3a955fda69cdea5161d0eb1aa5/src%2Flibrustc%2Flint%2Fbuiltin.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7249a1b1ae075e3a955fda69cdea5161d0eb1aa5/src%2Flibrustc%2Flint%2Fbuiltin.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Flint%2Fbuiltin.rs?ref=7249a1b1ae075e3a955fda69cdea5161d0eb1aa5", "patch": "@@ -422,6 +422,7 @@ pub enum BuiltinLintDiagnostics {\n     ProcMacroDeriveResolutionFallback(Span),\n     MacroExpandedMacroExportsAccessedByAbsolutePaths(Span),\n     ElidedLifetimesInPaths(usize, Span, bool, Span, String),\n+    UnknownCrateTypes(Span, String, String),\n }\n \n impl BuiltinLintDiagnostics {\n@@ -500,6 +501,14 @@ impl BuiltinLintDiagnostics {\n                     Applicability::MachineApplicable\n                 );\n             }\n+            BuiltinLintDiagnostics::UnknownCrateTypes(span, note, sugg) => {\n+                db.span_suggestion_with_applicability(\n+                    span,\n+                    &note,\n+                    sugg,\n+                    Applicability::MaybeIncorrect\n+                );\n+            }\n         }\n     }\n }"}, {"sha": "7fb66ea97f26ba05a92e3f60a0140f0cbdc07777", "filename": "src/librustc_driver/driver.rs", "status": "modified", "additions": 41, "deletions": 7, "changes": 48, "blob_url": "https://github.com/rust-lang/rust/blob/7249a1b1ae075e3a955fda69cdea5161d0eb1aa5/src%2Flibrustc_driver%2Fdriver.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7249a1b1ae075e3a955fda69cdea5161d0eb1aa5/src%2Flibrustc_driver%2Fdriver.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_driver%2Fdriver.rs?ref=7249a1b1ae075e3a955fda69cdea5161d0eb1aa5", "patch": "@@ -57,6 +57,8 @@ use syntax::ext::base::ExtCtxt;\n use syntax::fold::Folder;\n use syntax::parse::{self, PResult};\n use syntax::util::node_count::NodeCounter;\n+use syntax::util::lev_distance::find_best_match_for_name;\n+use syntax::symbol::Symbol;\n use syntax_pos::{FileName, hygiene};\n use syntax_ext;\n \n@@ -1508,13 +1510,45 @@ pub fn collect_crate_types(session: &Session, attrs: &[ast::Attribute]) -> Vec<c\n                     Some(ref n) if *n == \"staticlib\" => Some(config::CrateType::Staticlib),\n                     Some(ref n) if *n == \"proc-macro\" => Some(config::CrateType::ProcMacro),\n                     Some(ref n) if *n == \"bin\" => Some(config::CrateType::Executable),\n-                    Some(_) => {\n-                        session.buffer_lint(\n-                            lint::builtin::UNKNOWN_CRATE_TYPES,\n-                            ast::CRATE_NODE_ID,\n-                            a.span,\n-                            \"invalid `crate_type` value\",\n-                        );\n+                    Some(ref n) => {\n+                        let crate_types = vec![\n+                            Symbol::intern(\"rlib\"),\n+                            Symbol::intern(\"dylib\"),\n+                            Symbol::intern(\"cdylib\"),\n+                            Symbol::intern(\"lib\"),\n+                            Symbol::intern(\"staticlib\"),\n+                            Symbol::intern(\"proc-macro\"),\n+                            Symbol::intern(\"bin\")\n+                        ];\n+                        if let ast::MetaItemKind::NameValue(spanned) = a.meta().unwrap().node {\n+                            let span = spanned.span;\n+                            let lev_candidate = find_best_match_for_name(\n+                                crate_types.iter(),\n+                                &n.as_str(),\n+                                None\n+                            );\n+                            if let Some(candidate) = lev_candidate {\n+                                session.buffer_lint_with_diagnostic(\n+                                    lint::builtin::UNKNOWN_CRATE_TYPES,\n+                                    ast::CRATE_NODE_ID,\n+                                    span,\n+                                    \"invalid `crate_type` value\",\n+                                    lint::builtin::BuiltinLintDiagnostics::\n+                                        UnknownCrateTypes(\n+                                            span,\n+                                            \"did you mean\".to_string(),\n+                                            format!(\"\\\"{}\\\"\", candidate)\n+                                        )\n+                                );\n+                            } else {\n+                                session.buffer_lint(\n+                                    lint::builtin::UNKNOWN_CRATE_TYPES,\n+                                    ast::CRATE_NODE_ID,\n+                                    span,\n+                                    \"invalid `crate_type` value\"\n+                                );\n+                            }\n+                        }\n                         None\n                     }\n                     _ => {"}, {"sha": "e7f4e32dc7c41b17a757858e2e9b1ea6aa51ef7d", "filename": "src/test/ui/invalid/invalid-crate-type.rs", "status": "modified", "additions": 42, "deletions": 0, "changes": 42, "blob_url": "https://github.com/rust-lang/rust/blob/7249a1b1ae075e3a955fda69cdea5161d0eb1aa5/src%2Ftest%2Fui%2Finvalid%2Finvalid-crate-type.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7249a1b1ae075e3a955fda69cdea5161d0eb1aa5/src%2Ftest%2Fui%2Finvalid%2Finvalid-crate-type.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Finvalid%2Finvalid-crate-type.rs?ref=7249a1b1ae075e3a955fda69cdea5161d0eb1aa5", "patch": "@@ -11,6 +11,48 @@\n // regression test for issue 11256\n #![crate_type=\"foo\"]    //~ ERROR invalid `crate_type` value\n \n+// Tests for suggestions (#53958)\n+\n+#![crate_type=\"statoclib\"]\n+//~^ ERROR invalid `crate_type` value\n+//~| HELP did you mean\n+//~| SUGGESTION staticlib\n+\n+#![crate_type=\"procmacro\"]\n+//~^ ERROR invalid `crate_type` value\n+//~| HELP did you mean\n+//~| SUGGESTION proc-macro\n+\n+#![crate_type=\"static-lib\"]\n+//~^ ERROR invalid `crate_type` value\n+//~| HELP did you mean\n+//~| SUGGESTION staticlib\n+\n+#![crate_type=\"drylib\"]\n+//~^ ERROR invalid `crate_type` value\n+//~| HELP did you mean\n+//~| SUGGESTION dylib\n+\n+#![crate_type=\"dlib\"]\n+//~^ ERROR invalid `crate_type` value\n+//~| HELP did you mean\n+//~| SUGGESTION rlib\n+\n+#![crate_type=\"lob\"]\n+//~^ ERROR invalid `crate_type` value\n+//~| HELP did you mean\n+//~| SUGGESTION lib\n+\n+#![crate_type=\"bon\"]\n+//~^ ERROR invalid `crate_type` value\n+//~| HELP did you mean\n+//~| SUGGESTION bin\n+\n+#![crate_type=\"cdalib\"]\n+//~^ ERROR invalid `crate_type` value\n+//~| HELP did you mean\n+//~| SUGGESTION cdylib\n+\n fn main() {\n     return\n }"}, {"sha": "c82da865f33531b135ae8b628638220a0f378175", "filename": "src/test/ui/invalid/invalid-crate-type.stderr", "status": "modified", "additions": 51, "deletions": 3, "changes": 54, "blob_url": "https://github.com/rust-lang/rust/blob/7249a1b1ae075e3a955fda69cdea5161d0eb1aa5/src%2Ftest%2Fui%2Finvalid%2Finvalid-crate-type.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/7249a1b1ae075e3a955fda69cdea5161d0eb1aa5/src%2Ftest%2Fui%2Finvalid%2Finvalid-crate-type.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Finvalid%2Finvalid-crate-type.stderr?ref=7249a1b1ae075e3a955fda69cdea5161d0eb1aa5", "patch": "@@ -1,10 +1,58 @@\n error: invalid `crate_type` value\n-  --> $DIR/invalid-crate-type.rs:12:1\n+  --> $DIR/invalid-crate-type.rs:12:15\n    |\n LL | #![crate_type=\"foo\"]    //~ ERROR invalid `crate_type` value\n-   | ^^^^^^^^^^^^^^^^^^^^\n+   |               ^^^^^\n    |\n    = note: #[deny(unknown_crate_types)] on by default\n \n-error: aborting due to previous error\n+error: invalid `crate_type` value\n+  --> $DIR/invalid-crate-type.rs:16:15\n+   |\n+LL | #![crate_type=\"statoclib\"]\n+   |               ^^^^^^^^^^^ help: did you mean: `\"staticlib\"`\n+\n+error: invalid `crate_type` value\n+  --> $DIR/invalid-crate-type.rs:21:15\n+   |\n+LL | #![crate_type=\"procmacro\"]\n+   |               ^^^^^^^^^^^ help: did you mean: `\"proc-macro\"`\n+\n+error: invalid `crate_type` value\n+  --> $DIR/invalid-crate-type.rs:26:15\n+   |\n+LL | #![crate_type=\"static-lib\"]\n+   |               ^^^^^^^^^^^^ help: did you mean: `\"staticlib\"`\n+\n+error: invalid `crate_type` value\n+  --> $DIR/invalid-crate-type.rs:31:15\n+   |\n+LL | #![crate_type=\"drylib\"]\n+   |               ^^^^^^^^ help: did you mean: `\"dylib\"`\n+\n+error: invalid `crate_type` value\n+  --> $DIR/invalid-crate-type.rs:36:15\n+   |\n+LL | #![crate_type=\"dlib\"]\n+   |               ^^^^^^ help: did you mean: `\"rlib\"`\n+\n+error: invalid `crate_type` value\n+  --> $DIR/invalid-crate-type.rs:41:15\n+   |\n+LL | #![crate_type=\"lob\"]\n+   |               ^^^^^ help: did you mean: `\"lib\"`\n+\n+error: invalid `crate_type` value\n+  --> $DIR/invalid-crate-type.rs:46:15\n+   |\n+LL | #![crate_type=\"bon\"]\n+   |               ^^^^^ help: did you mean: `\"bin\"`\n+\n+error: invalid `crate_type` value\n+  --> $DIR/invalid-crate-type.rs:51:15\n+   |\n+LL | #![crate_type=\"cdalib\"]\n+   |               ^^^^^^^^ help: did you mean: `\"cdylib\"`\n+\n+error: aborting due to 9 previous errors\n "}]}