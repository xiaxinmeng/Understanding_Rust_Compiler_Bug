{"sha": "cc04cfc982b0321b55d54937709c01ca242eb5ff", "node_id": "C_kwDOAAsO6NoAKGNjMDRjZmM5ODJiMDMyMWI1NWQ1NDkzNzcwOWMwMWNhMjQyZWI1ZmY", "commit": {"author": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2022-01-30T21:18:32Z"}, "committer": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2022-01-30T21:18:32Z"}, "message": "Reduce allocations in attribute collection", "tree": {"sha": "831e7b77c731bbdee0b87f5b312479519e9eafc6", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/831e7b77c731bbdee0b87f5b312479519e9eafc6"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/cc04cfc982b0321b55d54937709c01ca242eb5ff", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/cc04cfc982b0321b55d54937709c01ca242eb5ff", "html_url": "https://github.com/rust-lang/rust/commit/cc04cfc982b0321b55d54937709c01ca242eb5ff", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/cc04cfc982b0321b55d54937709c01ca242eb5ff/comments", "author": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "c08df0f1f5e188e2e1e8f1715ff3a6d583cfb9f3", "url": "https://api.github.com/repos/rust-lang/rust/commits/c08df0f1f5e188e2e1e8f1715ff3a6d583cfb9f3", "html_url": "https://github.com/rust-lang/rust/commit/c08df0f1f5e188e2e1e8f1715ff3a6d583cfb9f3"}], "stats": {"total": 131, "additions": 61, "deletions": 70}, "files": [{"sha": "fe518c8642924c3df8c33d422f88cafa06d2572d", "filename": "crates/hir/src/lib.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cc04cfc982b0321b55d54937709c01ca242eb5ff/crates%2Fhir%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cc04cfc982b0321b55d54937709c01ca242eb5ff/crates%2Fhir%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Flib.rs?ref=cc04cfc982b0321b55d54937709c01ca242eb5ff", "patch": "@@ -664,7 +664,7 @@ fn emit_def_diagnostic(db: &dyn HirDatabase, acc: &mut Vec<AnyDiagnostic>, diag:\n                     let attr = node\n                         .doc_comments_and_attrs()\n                         .nth((*invoc_attr_index) as usize)\n-                        .and_then(Either::right)\n+                        .and_then(Either::left)\n                         .unwrap_or_else(|| panic!(\"cannot find attribute #{}\", invoc_attr_index));\n                     (\n                         ast_id.with_value(SyntaxNodePtr::from(AstPtr::new(&attr))),"}, {"sha": "f4d8d0d3bdb3c30cbe9c67e47b4a33c417b47ecf", "filename": "crates/hir_def/src/attr.rs", "status": "modified", "additions": 34, "deletions": 44, "changes": 78, "blob_url": "https://github.com/rust-lang/rust/blob/cc04cfc982b0321b55d54937709c01ca242eb5ff/crates%2Fhir_def%2Fsrc%2Fattr.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cc04cfc982b0321b55d54937709c01ca242eb5ff/crates%2Fhir_def%2Fsrc%2Fattr.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fattr.rs?ref=cc04cfc982b0321b55d54937709c01ca242eb5ff", "patch": "@@ -525,38 +525,36 @@ impl AttrsWithOwner {\n \n fn inner_attributes(\n     syntax: &SyntaxNode,\n-) -> Option<(impl Iterator<Item = ast::Attr>, impl Iterator<Item = ast::Comment>)> {\n-    let (attrs, docs) = match_ast! {\n+) -> Option<impl Iterator<Item = Either<ast::Attr, ast::Comment>>> {\n+    let node = match_ast! {\n         match syntax {\n-            ast::SourceFile(it) => (it.attrs(), ast::DocCommentIter::from_syntax_node(it.syntax())),\n-            ast::ExternBlock(it) => {\n-                let extern_item_list = it.extern_item_list()?;\n-                (extern_item_list.attrs(), ast::DocCommentIter::from_syntax_node(extern_item_list.syntax()))\n-            },\n-            ast::Fn(it) => {\n-                let body = it.body()?;\n-                let stmt_list = body.stmt_list()?;\n-                (stmt_list.attrs(), ast::DocCommentIter::from_syntax_node(body.syntax()))\n-            },\n-            ast::Impl(it) => {\n-                let assoc_item_list = it.assoc_item_list()?;\n-                (assoc_item_list.attrs(), ast::DocCommentIter::from_syntax_node(assoc_item_list.syntax()))\n-            },\n-            ast::Module(it) => {\n-                let item_list = it.item_list()?;\n-                (item_list.attrs(), ast::DocCommentIter::from_syntax_node(item_list.syntax()))\n+            ast::SourceFile(_) => syntax.clone(),\n+            ast::ExternBlock(it) => it.extern_item_list()?.syntax().clone(),\n+            ast::Fn(it) => it.body()?.stmt_list()?.syntax().clone(),\n+            ast::Impl(it) => it.assoc_item_list()?.syntax().clone(),\n+            ast::Module(it) => it.item_list()?.syntax().clone(),\n+            ast::BlockExpr(it) => {\n+                use syntax::SyntaxKind::{BLOCK_EXPR , EXPR_STMT};\n+                // Block expressions accept outer and inner attributes, but only when they are the outer\n+                // expression of an expression statement or the final expression of another block expression.\n+                let may_carry_attributes = matches!(\n+                    it.syntax().parent().map(|it| it.kind()),\n+                     Some(BLOCK_EXPR | EXPR_STMT)\n+                );\n+                if !may_carry_attributes {\n+                    return None\n+                }\n+                syntax.clone()\n             },\n-            // FIXME: BlockExpr's only accept inner attributes in specific cases\n-            // Excerpt from the reference:\n-            // Block expressions accept outer and inner attributes, but only when they are the outer\n-            // expression of an expression statement or the final expression of another block expression.\n-            ast::BlockExpr(_it) => return None,\n             _ => return None,\n         }\n     };\n-    let attrs = attrs.filter(|attr| attr.kind().is_inner());\n-    let docs = docs.filter(|doc| doc.is_inner());\n-    Some((attrs, docs))\n+\n+    let attrs = ast::AttrDocCommentIter::from_syntax_node(&node).filter(|el| match el {\n+        Either::Left(attr) => attr.kind().is_inner(),\n+        Either::Right(comment) => comment.is_inner(),\n+    });\n+    Some(attrs)\n }\n \n #[derive(Debug)]\n@@ -833,24 +831,16 @@ fn attrs_from_item_tree<N: ItemTreeNode>(id: ItemTreeId<N>, db: &dyn DefDatabase\n fn collect_attrs(\n     owner: &dyn ast::HasAttrs,\n ) -> impl Iterator<Item = (AttrId, Either<ast::Attr, ast::Comment>)> {\n-    let (inner_attrs, inner_docs) = inner_attributes(owner.syntax())\n-        .map_or((None, None), |(attrs, docs)| (Some(attrs), Some(docs)));\n-\n-    let outer_attrs = owner.attrs().filter(|attr| attr.kind().is_outer());\n-    let attrs = outer_attrs\n-        .chain(inner_attrs.into_iter().flatten())\n-        .map(|attr| (attr.syntax().text_range().start(), Either::Left(attr)));\n-\n-    let outer_docs =\n-        ast::DocCommentIter::from_syntax_node(owner.syntax()).filter(ast::Comment::is_outer);\n-    let docs = outer_docs\n-        .chain(inner_docs.into_iter().flatten())\n-        .map(|docs_text| (docs_text.syntax().text_range().start(), Either::Right(docs_text)));\n-    // sort here by syntax node offset because the source can have doc attributes and doc strings be interleaved\n-    docs.chain(attrs)\n-        .sorted_by_key(|&(offset, _)| offset)\n+    let inner_attrs = inner_attributes(owner.syntax()).into_iter().flatten();\n+    let outer_attrs =\n+        ast::AttrDocCommentIter::from_syntax_node(owner.syntax()).filter(|el| match el {\n+            Either::Left(attr) => attr.kind().is_outer(),\n+            Either::Right(comment) => comment.is_outer(),\n+        });\n+    outer_attrs\n+        .chain(inner_attrs)\n         .enumerate()\n-        .map(|(id, (_, attr))| (AttrId { ast_index: id as u32 }, attr))\n+        .map(|(id, attr)| (AttrId { ast_index: id as u32 }, attr))\n }\n \n pub(crate) fn variants_attrs_source_map("}, {"sha": "5c32a31e443d5f3092f8758111a09764bfaabb0c", "filename": "crates/hir_def/src/child_by_source.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cc04cfc982b0321b55d54937709c01ca242eb5ff/crates%2Fhir_def%2Fsrc%2Fchild_by_source.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cc04cfc982b0321b55d54937709c01ca242eb5ff/crates%2Fhir_def%2Fsrc%2Fchild_by_source.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fchild_by_source.rs?ref=cc04cfc982b0321b55d54937709c01ca242eb5ff", "patch": "@@ -117,7 +117,7 @@ impl ChildBySource for ItemScope {\n             |(ast_id, calls)| {\n                 let adt = ast_id.to_node(db.upcast());\n                 calls.for_each(|(attr_id, calls)| {\n-                    if let Some(Either::Right(attr)) =\n+                    if let Some(Either::Left(attr)) =\n                         adt.doc_comments_and_attrs().nth(attr_id.ast_index as usize)\n                     {\n                         res[keys::DERIVE_MACRO_CALL].insert(attr, (attr_id, calls.into()));"}, {"sha": "b46f3fc95546cf76f48936bfaaa087d569bc8d0a", "filename": "crates/hir_expand/src/db.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/cc04cfc982b0321b55d54937709c01ca242eb5ff/crates%2Fhir_expand%2Fsrc%2Fdb.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cc04cfc982b0321b55d54937709c01ca242eb5ff/crates%2Fhir_expand%2Fsrc%2Fdb.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_expand%2Fsrc%2Fdb.rs?ref=cc04cfc982b0321b55d54937709c01ca242eb5ff", "patch": "@@ -157,7 +157,7 @@ pub fn expand_speculative(\n             let attr = item\n                 .doc_comments_and_attrs()\n                 .nth(invoc_attr_index as usize)\n-                .and_then(Either::right)?;\n+                .and_then(Either::left)?;\n             match attr.token_tree() {\n                 Some(token_tree) => {\n                     let (mut tree, map) = syntax_node_to_token_tree(attr.token_tree()?.syntax());\n@@ -323,7 +323,7 @@ fn censor_for_macro_input(loc: &MacroCallLoc, node: &SyntaxNode) -> FxHashSet<Sy\n                 ast::Item::cast(node.clone())?\n                     .doc_comments_and_attrs()\n                     .nth(invoc_attr_index as usize)\n-                    .and_then(Either::right)\n+                    .and_then(Either::left)\n                     .map(|attr| attr.syntax().clone())\n                     .into_iter()\n                     .collect()"}, {"sha": "d2b719bf570b9697eb79c3206d9b9e0116256986", "filename": "crates/hir_expand/src/hygiene.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/cc04cfc982b0321b55d54937709c01ca242eb5ff/crates%2Fhir_expand%2Fsrc%2Fhygiene.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cc04cfc982b0321b55d54937709c01ca242eb5ff/crates%2Fhir_expand%2Fsrc%2Fhygiene.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_expand%2Fsrc%2Fhygiene.rs?ref=cc04cfc982b0321b55d54937709c01ca242eb5ff", "patch": "@@ -191,7 +191,7 @@ fn make_hygiene_info(\n                 .to_node(db)\n                 .doc_comments_and_attrs()\n                 .nth(invoc_attr_index as usize)\n-                .and_then(Either::right)?\n+                .and_then(Either::left)?\n                 .token_tree()?;\n             Some(InFile::new(ast_id.file_id, tt))\n         }"}, {"sha": "51899ca2f65b0ab612b3c32bdfec694dfe9afef4", "filename": "crates/hir_expand/src/lib.rs", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/cc04cfc982b0321b55d54937709c01ca242eb5ff/crates%2Fhir_expand%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cc04cfc982b0321b55d54937709c01ca242eb5ff/crates%2Fhir_expand%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_expand%2Fsrc%2Flib.rs?ref=cc04cfc982b0321b55d54937709c01ca242eb5ff", "patch": "@@ -205,7 +205,7 @@ impl HirFileId {\n                             .to_node(db)\n                             .doc_comments_and_attrs()\n                             .nth(invoc_attr_index as usize)\n-                            .and_then(Either::right)?\n+                            .and_then(Either::left)?\n                             .token_tree()?;\n                         Some(InFile::new(ast_id.file_id, tt))\n                     }\n@@ -382,7 +382,7 @@ impl MacroCallKind {\n                     .doc_comments_and_attrs()\n                     .nth(derive_attr_index as usize)\n                     .expect(\"missing derive\")\n-                    .expect_right(\"derive is a doc comment?\")\n+                    .expect_left(\"derive is a doc comment?\")\n                     .syntax()\n                     .text_range()\n             }\n@@ -391,7 +391,7 @@ impl MacroCallKind {\n                 .doc_comments_and_attrs()\n                 .nth(invoc_attr_index as usize)\n                 .expect(\"missing attribute\")\n-                .expect_right(\"attribute macro is a doc comment?\")\n+                .expect_left(\"attribute macro is a doc comment?\")\n                 .syntax()\n                 .text_range(),\n         };\n@@ -483,7 +483,7 @@ impl ExpansionInfo {\n                     let attr = item\n                         .doc_comments_and_attrs()\n                         .nth(*invoc_attr_index as usize)\n-                        .and_then(Either::right)?;\n+                        .and_then(Either::left)?;\n                     match attr.token_tree() {\n                         Some(token_tree)\n                             if token_tree.syntax().text_range().contains_range(token_range) =>"}, {"sha": "91b46cf8e9d8a5ae771b85a92719821c0fb0ceaa", "filename": "crates/syntax/src/ast.rs", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/cc04cfc982b0321b55d54937709c01ca242eb5ff/crates%2Fsyntax%2Fsrc%2Fast.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cc04cfc982b0321b55d54937709c01ca242eb5ff/crates%2Fsyntax%2Fsrc%2Fast.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fsyntax%2Fsrc%2Fast.rs?ref=cc04cfc982b0321b55d54937709c01ca242eb5ff", "patch": "@@ -27,8 +27,8 @@ pub use self::{\n     operators::{ArithOp, BinaryOp, CmpOp, LogicOp, Ordering, RangeOp, UnaryOp},\n     token_ext::{CommentKind, CommentPlacement, CommentShape, IsString, QuoteOffsets, Radix},\n     traits::{\n-        DocCommentIter, HasArgList, HasAttrs, HasDocComments, HasGenericParams, HasLoopBody,\n-        HasModuleItem, HasName, HasTypeBounds, HasVisibility,\n+        AttrDocCommentIter, DocCommentIter, HasArgList, HasAttrs, HasDocComments, HasGenericParams,\n+        HasLoopBody, HasModuleItem, HasName, HasTypeBounds, HasVisibility,\n     },\n };\n "}, {"sha": "7211c77e880b36c3ab3f96212aa857076f036f88", "filename": "crates/syntax/src/ast/node_ext.rs", "status": "modified", "additions": 3, "deletions": 8, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/cc04cfc982b0321b55d54937709c01ca242eb5ff/crates%2Fsyntax%2Fsrc%2Fast%2Fnode_ext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cc04cfc982b0321b55d54937709c01ca242eb5ff/crates%2Fsyntax%2Fsrc%2Fast%2Fnode_ext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fsyntax%2Fsrc%2Fast%2Fnode_ext.rs?ref=cc04cfc982b0321b55d54937709c01ca242eb5ff", "patch": "@@ -160,14 +160,9 @@ impl ast::Attr {\n     }\n \n     pub fn kind(&self) -> AttrKind {\n-        let first_token = self.syntax().first_token();\n-        let first_token_kind = first_token.as_ref().map(SyntaxToken::kind);\n-        let second_token_kind =\n-            first_token.and_then(|token| token.next_token()).as_ref().map(SyntaxToken::kind);\n-\n-        match (first_token_kind, second_token_kind) {\n-            (Some(T![#]), Some(T![!])) => AttrKind::Inner,\n-            _ => AttrKind::Outer,\n+        match self.excl_token() {\n+            Some(_) => AttrKind::Inner,\n+            None => AttrKind::Outer,\n         }\n     }\n "}, {"sha": "aa2b7ed5c8b28e78bba8532613cbb0bb04d5a4e1", "filename": "crates/syntax/src/ast/traits.rs", "status": "modified", "additions": 13, "deletions": 7, "changes": 20, "blob_url": "https://github.com/rust-lang/rust/blob/cc04cfc982b0321b55d54937709c01ca242eb5ff/crates%2Fsyntax%2Fsrc%2Fast%2Ftraits.rs", "raw_url": "https://github.com/rust-lang/rust/raw/cc04cfc982b0321b55d54937709c01ca242eb5ff/crates%2Fsyntax%2Fsrc%2Fast%2Ftraits.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fsyntax%2Fsrc%2Fast%2Ftraits.rs?ref=cc04cfc982b0321b55d54937709c01ca242eb5ff", "patch": "@@ -76,8 +76,8 @@ pub trait HasDocComments: HasAttrs {\n     fn doc_comments(&self) -> DocCommentIter {\n         DocCommentIter { iter: self.syntax().children_with_tokens() }\n     }\n-    fn doc_comments_and_attrs(&self) -> AttrCommentIter {\n-        AttrCommentIter { iter: self.syntax().children_with_tokens() }\n+    fn doc_comments_and_attrs(&self) -> AttrDocCommentIter {\n+        AttrDocCommentIter { iter: self.syntax().children_with_tokens() }\n     }\n }\n \n@@ -113,17 +113,23 @@ impl Iterator for DocCommentIter {\n     }\n }\n \n-pub struct AttrCommentIter {\n+pub struct AttrDocCommentIter {\n     iter: SyntaxElementChildren,\n }\n \n-impl Iterator for AttrCommentIter {\n-    type Item = Either<ast::Comment, ast::Attr>;\n+impl AttrDocCommentIter {\n+    pub fn from_syntax_node(syntax_node: &ast::SyntaxNode) -> AttrDocCommentIter {\n+        AttrDocCommentIter { iter: syntax_node.children_with_tokens() }\n+    }\n+}\n+\n+impl Iterator for AttrDocCommentIter {\n+    type Item = Either<ast::Attr, ast::Comment>;\n     fn next(&mut self) -> Option<Self::Item> {\n         self.iter.by_ref().find_map(|el| match el {\n-            SyntaxElement::Node(node) => ast::Attr::cast(node).map(Either::Right),\n+            SyntaxElement::Node(node) => ast::Attr::cast(node).map(Either::Left),\n             SyntaxElement::Token(tok) => {\n-                ast::Comment::cast(tok).filter(ast::Comment::is_doc).map(Either::Left)\n+                ast::Comment::cast(tok).filter(ast::Comment::is_doc).map(Either::Right)\n             }\n         })\n     }"}]}