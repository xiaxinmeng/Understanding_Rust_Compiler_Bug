{"sha": "3267e054daaa32f350b71e85809e4660bf2845c9", "node_id": "MDY6Q29tbWl0NzI0NzEyOjMyNjdlMDU0ZGFhYTMyZjM1MGI3MWU4NTgwOWU0NjYwYmYyODQ1Yzk=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-07-13T09:26:16Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2019-07-13T09:26:16Z"}, "message": "Auto merge of #4232 - mikerite:dev-fmt-4, r=flip1995\n\nAdd dev fmt subcommand\n\nchangelog: none", "tree": {"sha": "83aed6c236bf10dc4e70eb22a36b0f9aa0b76542", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/83aed6c236bf10dc4e70eb22a36b0f9aa0b76542"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3267e054daaa32f350b71e85809e4660bf2845c9", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3267e054daaa32f350b71e85809e4660bf2845c9", "html_url": "https://github.com/rust-lang/rust/commit/3267e054daaa32f350b71e85809e4660bf2845c9", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3267e054daaa32f350b71e85809e4660bf2845c9/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "10b915fa7e5e7454fceda269f0c4cee10fd90197", "url": "https://api.github.com/repos/rust-lang/rust/commits/10b915fa7e5e7454fceda269f0c4cee10fd90197", "html_url": "https://github.com/rust-lang/rust/commit/10b915fa7e5e7454fceda269f0c4cee10fd90197"}, {"sha": "76d66e641383c2949a5bbb1b7f46f22deb0703c5", "url": "https://api.github.com/repos/rust-lang/rust/commits/76d66e641383c2949a5bbb1b7f46f22deb0703c5", "html_url": "https://github.com/rust-lang/rust/commit/76d66e641383c2949a5bbb1b7f46f22deb0703c5"}], "stats": {"total": 297, "additions": 244, "deletions": 53}, "files": [{"sha": "9f6cc45af81e0768cc3d9c7e57a2dd9b5109899b", "filename": "appveyor.yml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/3267e054daaa32f350b71e85809e4660bf2845c9/appveyor.yml", "raw_url": "https://github.com/rust-lang/rust/raw/3267e054daaa32f350b71e85809e4660bf2845c9/appveyor.yml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/appveyor.yml?ref=3267e054daaa32f350b71e85809e4660bf2845c9", "patch": "@@ -22,6 +22,7 @@ install:\n     - del rust-toolchain\n     - cargo install rustup-toolchain-install-master --debug || echo \"rustup-toolchain-install-master already installed\"\n     - rustup-toolchain-install-master %RUSTC_HASH% -f -n master\n+    - rustup component add rustfmt --toolchain nightly\n     - rustup default master\n     - set PATH=%PATH%;C:\\Users\\appveyor\\.rustup\\toolchains\\master\\bin\n     - rustc -V"}, {"sha": "c5d3eb3c902d9742111757723cce9955fb1eef32", "filename": "ci/base-tests.sh", "status": "modified", "additions": 0, "deletions": 30, "changes": 30, "blob_url": "https://github.com/rust-lang/rust/blob/3267e054daaa32f350b71e85809e4660bf2845c9/ci%2Fbase-tests.sh", "raw_url": "https://github.com/rust-lang/rust/raw/3267e054daaa32f350b71e85809e4660bf2845c9/ci%2Fbase-tests.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/ci%2Fbase-tests.sh?ref=3267e054daaa32f350b71e85809e4660bf2845c9", "patch": "@@ -24,7 +24,6 @@ export CARGO_TARGET_DIR=`pwd`/target/\n # Perform various checks for lint registration\n ./util/dev update_lints --check\n ./util/dev --limit-stderr-length\n-cargo +nightly fmt --all -- --check\n \n # Check running clippy-driver without cargo\n (\n@@ -50,32 +49,3 @@ cargo +nightly fmt --all -- --check\n \n   # TODO: CLIPPY_CONF_DIR / CARGO_MANIFEST_DIR\n )\n-\n-# make sure tests are formatted\n-\n-# some lints are sensitive to formatting, exclude some files\n-tests_need_reformatting=\"false\"\n-# switch to nightly\n-rustup override set nightly\n-# avoid loop spam and allow cmds with exit status != 0\n-set +ex\n-\n-# Excluding `ice-3891.rs` because the code triggers a rustc parse error which\n-# makes rustfmt fail.\n-for file in `find tests -not -path \"tests/ui/crashes/ice-3891.rs\" | grep \"\\.rs$\"` ; do\n-  rustfmt ${file} --check\n-  if [ $? -ne 0 ]; then\n-    echo \"${file} needs reformatting!\"\n-    tests_need_reformatting=\"true\"\n-  fi\n-done\n-\n-set -ex # reset\n-\n-if [ \"${tests_need_reformatting}\" == \"true\" ] ; then\n-    echo \"Tests need reformatting!\"\n-    exit 2\n-fi\n-\n-# switch back to master\n-rustup override set master"}, {"sha": "e2e946d06f27c28f4c2732eac3c3b526f8676c0d", "filename": "clippy_dev/Cargo.toml", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/3267e054daaa32f350b71e85809e4660bf2845c9/clippy_dev%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/3267e054daaa32f350b71e85809e4660bf2845c9/clippy_dev%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_dev%2FCargo.toml?ref=3267e054daaa32f350b71e85809e4660bf2845c9", "patch": "@@ -9,4 +9,5 @@ clap = \"2.33\"\n itertools = \"0.8\"\n regex = \"1\"\n lazy_static = \"1.0\"\n+shell-escape = \"0.1\"\n walkdir = \"2\""}, {"sha": "5ccdbec14288c78bd79a6853d02bfb89512e6ae5", "filename": "clippy_dev/src/fmt.rs", "status": "added", "additions": 171, "deletions": 0, "changes": 171, "blob_url": "https://github.com/rust-lang/rust/blob/3267e054daaa32f350b71e85809e4660bf2845c9/clippy_dev%2Fsrc%2Ffmt.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3267e054daaa32f350b71e85809e4660bf2845c9/clippy_dev%2Fsrc%2Ffmt.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_dev%2Fsrc%2Ffmt.rs?ref=3267e054daaa32f350b71e85809e4660bf2845c9", "patch": "@@ -0,0 +1,171 @@\n+use shell_escape::escape;\n+use std::ffi::OsStr;\n+use std::io;\n+use std::path::{Path, PathBuf};\n+use std::process::{self, Command};\n+use walkdir::WalkDir;\n+\n+#[derive(Debug)]\n+pub enum CliError {\n+    CommandFailed(String),\n+    IoError(io::Error),\n+    ProjectRootNotFound,\n+    WalkDirError(walkdir::Error),\n+}\n+\n+impl From<io::Error> for CliError {\n+    fn from(error: io::Error) -> Self {\n+        CliError::IoError(error)\n+    }\n+}\n+\n+impl From<walkdir::Error> for CliError {\n+    fn from(error: walkdir::Error) -> Self {\n+        CliError::WalkDirError(error)\n+    }\n+}\n+\n+struct FmtContext {\n+    check: bool,\n+    verbose: bool,\n+}\n+\n+pub fn run(check: bool, verbose: bool) {\n+    fn try_run(context: &FmtContext) -> Result<bool, CliError> {\n+        let mut success = true;\n+\n+        let project_root = project_root()?;\n+\n+        success &= cargo_fmt(context, project_root.as_path())?;\n+        success &= cargo_fmt(context, &project_root.join(\"clippy_dev\"))?;\n+        success &= cargo_fmt(context, &project_root.join(\"rustc_tools_util\"))?;\n+\n+        for entry in WalkDir::new(project_root.join(\"tests\")) {\n+            let entry = entry?;\n+            let path = entry.path();\n+\n+            if path.extension() != Some(\"rs\".as_ref())\n+                || entry.file_name() == \"ice-3891.rs\"\n+                // Avoid rustfmt bug rust-lang/rustfmt#1873\n+                || cfg!(windows) && entry.file_name() == \"implicit_hasher.rs\"\n+            {\n+                continue;\n+            }\n+\n+            success &= rustfmt(context, &path)?;\n+        }\n+\n+        Ok(success)\n+    }\n+\n+    fn output_err(err: CliError) {\n+        match err {\n+            CliError::CommandFailed(command) => {\n+                eprintln!(\"error: A command failed! `{}`\", command);\n+            },\n+            CliError::IoError(err) => {\n+                eprintln!(\"error: {}\", err);\n+            },\n+            CliError::ProjectRootNotFound => {\n+                eprintln!(\"error: Can't determine root of project. Please run inside a Clippy working dir.\");\n+            },\n+            CliError::WalkDirError(err) => {\n+                eprintln!(\"error: {}\", err);\n+            },\n+        }\n+    }\n+\n+    let context = FmtContext { check, verbose };\n+    let result = try_run(&context);\n+    let code = match result {\n+        Ok(true) => 0,\n+        Ok(false) => {\n+            eprintln!();\n+            eprintln!(\"Formatting check failed.\");\n+            eprintln!(\"Run `./util/dev fmt` to update formatting.\");\n+            1\n+        },\n+        Err(err) => {\n+            output_err(err);\n+            1\n+        },\n+    };\n+    process::exit(code);\n+}\n+\n+fn format_command(program: impl AsRef<OsStr>, dir: impl AsRef<Path>, args: &[impl AsRef<OsStr>]) -> String {\n+    let arg_display: Vec<_> = args\n+        .iter()\n+        .map(|a| escape(a.as_ref().to_string_lossy()).to_owned())\n+        .collect();\n+\n+    format!(\n+        \"cd {} && {} {}\",\n+        escape(dir.as_ref().to_string_lossy()),\n+        escape(program.as_ref().to_string_lossy()),\n+        arg_display.join(\" \")\n+    )\n+}\n+\n+fn exec(\n+    context: &FmtContext,\n+    program: impl AsRef<OsStr>,\n+    dir: impl AsRef<Path>,\n+    args: &[impl AsRef<OsStr>],\n+) -> Result<bool, CliError> {\n+    if context.verbose {\n+        println!(\"{}\", format_command(&program, &dir, args));\n+    }\n+\n+    let mut child = Command::new(&program).current_dir(&dir).args(args.iter()).spawn()?;\n+    let code = child.wait()?;\n+    let success = code.success();\n+\n+    if !context.check && !success {\n+        return Err(CliError::CommandFailed(format_command(&program, &dir, args)));\n+    }\n+\n+    Ok(success)\n+}\n+\n+fn cargo_fmt(context: &FmtContext, path: &Path) -> Result<bool, CliError> {\n+    let mut args = vec![\"+nightly\", \"fmt\", \"--all\"];\n+    if context.check {\n+        args.push(\"--\");\n+        args.push(\"--check\");\n+    }\n+    let success = exec(context, \"cargo\", path, &args)?;\n+\n+    Ok(success)\n+}\n+\n+fn rustfmt(context: &FmtContext, path: &Path) -> Result<bool, CliError> {\n+    let mut args = vec![\"+nightly\".as_ref(), path.as_os_str()];\n+    if context.check {\n+        args.push(\"--check\".as_ref());\n+    }\n+    let success = exec(context, \"rustfmt\", std::env::current_dir()?, &args)?;\n+    if !success {\n+        eprintln!(\"rustfmt failed on {}\", path.display());\n+    }\n+    Ok(success)\n+}\n+\n+fn project_root() -> Result<PathBuf, CliError> {\n+    let current_dir = std::env::current_dir()?;\n+    for path in current_dir.ancestors() {\n+        let result = std::fs::read_to_string(path.join(\"Cargo.toml\"));\n+        if let Err(err) = &result {\n+            if err.kind() == io::ErrorKind::NotFound {\n+                continue;\n+            }\n+        }\n+\n+        let content = result?;\n+        if content.contains(\"[package]\\nname = \\\"clippy\\\"\") {\n+            return Ok(path.to_path_buf());\n+        }\n+    }\n+\n+    Err(CliError::ProjectRootNotFound)\n+}"}, {"sha": "5fa7a87a5dea463bccd555919b9292781a19745b", "filename": "clippy_dev/src/main.rs", "status": "modified", "additions": 32, "deletions": 8, "changes": 40, "blob_url": "https://github.com/rust-lang/rust/blob/3267e054daaa32f350b71e85809e4660bf2845c9/clippy_dev%2Fsrc%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3267e054daaa32f350b71e85809e4660bf2845c9/clippy_dev%2Fsrc%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_dev%2Fsrc%2Fmain.rs?ref=3267e054daaa32f350b71e85809e4660bf2845c9", "patch": "@@ -4,6 +4,8 @@ extern crate regex;\n \n use clap::{App, Arg, SubCommand};\n use clippy_dev::*;\n+\n+mod fmt;\n mod stderr_length_check;\n \n #[derive(PartialEq)]\n@@ -14,6 +16,21 @@ enum UpdateMode {\n \n fn main() {\n     let matches = App::new(\"Clippy developer tooling\")\n+        .subcommand(\n+            SubCommand::with_name(\"fmt\")\n+                .about(\"Run rustfmt on all projects and tests\")\n+                .arg(\n+                    Arg::with_name(\"check\")\n+                        .long(\"check\")\n+                        .help(\"Use the rustfmt --check option\"),\n+                )\n+                .arg(\n+                    Arg::with_name(\"verbose\")\n+                        .short(\"v\")\n+                        .long(\"verbose\")\n+                        .help(\"Echo commands run\"),\n+                ),\n+        )\n         .subcommand(\n             SubCommand::with_name(\"update_lints\")\n                 .about(\"Updates lint registration and information from the source code\")\n@@ -46,14 +63,21 @@ fn main() {\n     if matches.is_present(\"limit-stderr-length\") {\n         stderr_length_check::check();\n     }\n-    if let Some(matches) = matches.subcommand_matches(\"update_lints\") {\n-        if matches.is_present(\"print-only\") {\n-            print_lints();\n-        } else if matches.is_present(\"check\") {\n-            update_lints(&UpdateMode::Check);\n-        } else {\n-            update_lints(&UpdateMode::Change);\n-        }\n+\n+    match matches.subcommand() {\n+        (\"fmt\", Some(matches)) => {\n+            fmt::run(matches.is_present(\"check\"), matches.is_present(\"verbose\"));\n+        },\n+        (\"update_lints\", Some(matches)) => {\n+            if matches.is_present(\"print-only\") {\n+                print_lints();\n+            } else if matches.is_present(\"check\") {\n+                update_lints(&UpdateMode::Check);\n+            } else {\n+                update_lints(&UpdateMode::Change);\n+            }\n+        },\n+        _ => {},\n     }\n }\n "}, {"sha": "ba8e5f83ef4e2a764a861552a39c0704125060b8", "filename": "clippy_dev/src/stderr_length_check.rs", "status": "modified", "additions": 9, "deletions": 10, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/3267e054daaa32f350b71e85809e4660bf2845c9/clippy_dev%2Fsrc%2Fstderr_length_check.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3267e054daaa32f350b71e85809e4660bf2845c9/clippy_dev%2Fsrc%2Fstderr_length_check.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/clippy_dev%2Fsrc%2Fstderr_length_check.rs?ref=3267e054daaa32f350b71e85809e4660bf2845c9", "patch": "@@ -23,16 +23,15 @@ pub fn check() {\n }\n \n fn exceeding_stderr_files(files: impl Iterator<Item = walkdir::DirEntry>) -> impl Iterator<Item = String> {\n-    files\n-        .filter_map(|file| {\n-            let path = file.path().to_str().expect(\"Could not convert path to str\").to_string();\n-            let linecount = count_linenumbers(&path);\n-            if linecount > LIMIT {\n-                Some(path)\n-            } else {\n-                None\n-            }\n-        })\n+    files.filter_map(|file| {\n+        let path = file.path().to_str().expect(\"Could not convert path to str\").to_string();\n+        let linecount = count_linenumbers(&path);\n+        if linecount > LIMIT {\n+            Some(path)\n+        } else {\n+            None\n+        }\n+    })\n }\n \n fn stderr_files() -> impl Iterator<Item = walkdir::DirEntry> {"}, {"sha": "0e73bdba1086e5eec958b91207001ffce2a34c9a", "filename": "doc/adding_lints.md", "status": "modified", "additions": 7, "deletions": 5, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/3267e054daaa32f350b71e85809e4660bf2845c9/doc%2Fadding_lints.md", "raw_url": "https://github.com/rust-lang/rust/raw/3267e054daaa32f350b71e85809e4660bf2845c9/doc%2Fadding_lints.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/doc%2Fadding_lints.md?ref=3267e054daaa32f350b71e85809e4660bf2845c9", "patch": "@@ -345,16 +345,18 @@ list][lint_list].\n \n ### Running rustfmt\n \n-[Rustfmt](https://github.com/rust-lang/rustfmt) is a tool for formatting Rust code according\n-to style guidelines. Your code has to be formatted by `rustfmt` before a PR can be merged.\n+[Rustfmt](https://github.com/rust-lang/rustfmt) is a tool for formatting Rust\n+code according to style guidelines. Your code has to be formatted by `rustfmt`\n+before a PR can be merged. Clippy uses nightly `rustfmt` in the CI.\n \n It can be installed via `rustup`:\n \n ```bash\n-rustup component add rustfmt\n+rustup component add rustfmt --toolchain=nightly\n ```\n \n-Use `cargo fmt --all` to format the whole codebase.\n+Use `./util/dev fmt` to format the whole codebase. Make sure that `rustfmt` is\n+installed for the nightly toolchain.\n \n ### Debugging\n \n@@ -371,7 +373,7 @@ Before submitting your PR make sure you followed all of the basic requirements:\n - [ ] `cargo test` passes locally\n - [ ] Executed `util/dev update_lints`\n - [ ] Added lint documentation\n-- [ ] Run `cargo fmt`\n+- [ ] Run `./util/dev fmt`\n \n ### Cheatsheet\n "}, {"sha": "2500132d7ad3e9876b1eab11cf726213d6dc242d", "filename": "tests/fmt.rs", "status": "added", "additions": 23, "deletions": 0, "changes": 23, "blob_url": "https://github.com/rust-lang/rust/blob/3267e054daaa32f350b71e85809e4660bf2845c9/tests%2Ffmt.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3267e054daaa32f350b71e85809e4660bf2845c9/tests%2Ffmt.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ffmt.rs?ref=3267e054daaa32f350b71e85809e4660bf2845c9", "patch": "@@ -0,0 +1,23 @@\n+#[test]\n+fn fmt() {\n+    if option_env!(\"RUSTC_TEST_SUITE\").is_some() {\n+        return;\n+    }\n+\n+    let root_dir = std::path::PathBuf::from(env!(\"CARGO_MANIFEST_DIR\"));\n+    let dev_dir = root_dir.join(\"clippy_dev\");\n+    let output = std::process::Command::new(\"cargo\")\n+        .current_dir(dev_dir)\n+        .args(&[\"+nightly\", \"run\", \"--\", \"fmt\", \"--check\"])\n+        .output()\n+        .unwrap();\n+\n+    println!(\"status: {}\", output.status);\n+    println!(\"stdout: {}\", String::from_utf8_lossy(&output.stdout));\n+    println!(\"stderr: {}\", String::from_utf8_lossy(&output.stderr));\n+\n+    assert!(\n+        output.status.success(),\n+        \"Formatting check failed. Run `./util/dev fmt` to update formatting.\"\n+    );\n+}"}]}