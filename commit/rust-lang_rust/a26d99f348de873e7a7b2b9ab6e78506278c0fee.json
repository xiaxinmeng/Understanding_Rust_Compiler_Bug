{"sha": "a26d99f348de873e7a7b2b9ab6e78506278c0fee", "node_id": "MDY6Q29tbWl0NzI0NzEyOmEyNmQ5OWYzNDhkZTg3M2U3YTdiMmI5YWI2ZTc4NTA2Mjc4YzBmZWU=", "commit": {"author": {"name": "Jeremy Fitzhardinge", "email": "jeremy@goop.org", "date": "2021-06-05T22:43:12Z"}, "committer": {"name": "Jeremy Fitzhardinge", "email": "jsgf@fb.com", "date": "2021-06-22T00:22:35Z"}, "message": "In --emit KIND=PATH options, only hash KIND\n\nThe PATH has no material effect on the emitted artifact, and setting\nthe patch via `-o` or `--out-dir` does not affect the hash.\n\nCloses https://github.com/rust-lang/rust/issues/86044", "tree": {"sha": "c50432ea04c7ffddfc2974f3ea8ccec972310507", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c50432ea04c7ffddfc2974f3ea8ccec972310507"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a26d99f348de873e7a7b2b9ab6e78506278c0fee", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a26d99f348de873e7a7b2b9ab6e78506278c0fee", "html_url": "https://github.com/rust-lang/rust/commit/a26d99f348de873e7a7b2b9ab6e78506278c0fee", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a26d99f348de873e7a7b2b9ab6e78506278c0fee/comments", "author": {"login": "jsgf", "id": 147966, "node_id": "MDQ6VXNlcjE0Nzk2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/147966?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jsgf", "html_url": "https://github.com/jsgf", "followers_url": "https://api.github.com/users/jsgf/followers", "following_url": "https://api.github.com/users/jsgf/following{/other_user}", "gists_url": "https://api.github.com/users/jsgf/gists{/gist_id}", "starred_url": "https://api.github.com/users/jsgf/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jsgf/subscriptions", "organizations_url": "https://api.github.com/users/jsgf/orgs", "repos_url": "https://api.github.com/users/jsgf/repos", "events_url": "https://api.github.com/users/jsgf/events{/privacy}", "received_events_url": "https://api.github.com/users/jsgf/received_events", "type": "User", "site_admin": false}, "committer": {"login": "jsgf", "id": 147966, "node_id": "MDQ6VXNlcjE0Nzk2Ng==", "avatar_url": "https://avatars.githubusercontent.com/u/147966?v=4", "gravatar_id": "", "url": "https://api.github.com/users/jsgf", "html_url": "https://github.com/jsgf", "followers_url": "https://api.github.com/users/jsgf/followers", "following_url": "https://api.github.com/users/jsgf/following{/other_user}", "gists_url": "https://api.github.com/users/jsgf/gists{/gist_id}", "starred_url": "https://api.github.com/users/jsgf/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/jsgf/subscriptions", "organizations_url": "https://api.github.com/users/jsgf/orgs", "repos_url": "https://api.github.com/users/jsgf/repos", "events_url": "https://api.github.com/users/jsgf/events{/privacy}", "received_events_url": "https://api.github.com/users/jsgf/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "cef3ab75b12155e0582dd8b7710b7b901215fdd6", "url": "https://api.github.com/repos/rust-lang/rust/commits/cef3ab75b12155e0582dd8b7710b7b901215fdd6", "html_url": "https://github.com/rust-lang/rust/commit/cef3ab75b12155e0582dd8b7710b7b901215fdd6"}], "stats": {"total": 47, "additions": 42, "deletions": 5}, "files": [{"sha": "865c281be9c8140850206ec78b3e7a56756a3742", "filename": "compiler/rustc_interface/src/tests.rs", "status": "modified", "additions": 3, "deletions": 3, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/a26d99f348de873e7a7b2b9ab6e78506278c0fee/compiler%2Frustc_interface%2Fsrc%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a26d99f348de873e7a7b2b9ab6e78506278c0fee/compiler%2Frustc_interface%2Fsrc%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_interface%2Fsrc%2Ftests.rs?ref=a26d99f348de873e7a7b2b9ab6e78506278c0fee", "patch": "@@ -152,9 +152,9 @@ fn test_output_types_tracking_hash_different_paths() {\n     v2.output_types = OutputTypes::new(&[(OutputType::Exe, Some(PathBuf::from(\"/some/thing\")))]);\n     v3.output_types = OutputTypes::new(&[(OutputType::Exe, None)]);\n \n-    assert_different_hash(&v1, &v2);\n-    assert_different_hash(&v1, &v3);\n-    assert_different_hash(&v2, &v3);\n+    assert_same_hash(&v1, &v2);\n+    assert_same_hash(&v1, &v3);\n+    assert_same_hash(&v2, &v3);\n }\n \n #[test]"}, {"sha": "331817ad2d0a751515ff4a43eb92d37db33677c3", "filename": "compiler/rustc_session/src/config.rs", "status": "modified", "additions": 12, "deletions": 2, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/a26d99f348de873e7a7b2b9ab6e78506278c0fee/compiler%2Frustc_session%2Fsrc%2Fconfig.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a26d99f348de873e7a7b2b9ab6e78506278c0fee/compiler%2Frustc_session%2Fsrc%2Fconfig.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_session%2Fsrc%2Fconfig.rs?ref=a26d99f348de873e7a7b2b9ab6e78506278c0fee", "patch": "@@ -31,6 +31,7 @@ use std::collections::btree_map::{\n };\n use std::collections::{BTreeMap, BTreeSet};\n use std::fmt;\n+use std::hash::{Hash, Hasher};\n use std::iter::{self, FromIterator};\n use std::path::{Path, PathBuf};\n use std::str::{self, FromStr};\n@@ -325,10 +326,19 @@ impl Default for TrimmedDefPaths {\n \n /// Use tree-based collections to cheaply get a deterministic `Hash` implementation.\n /// *Do not* switch `BTreeMap` out for an unsorted container type! That would break\n-/// dependency tracking for command-line arguments.\n-#[derive(Clone, Hash, Debug)]\n+/// dependency tracking for command-line arguments. Also only hash keys, since tracking\n+/// should only depend on the output types, not the paths they're written to.\n+#[derive(Clone, Debug)]\n pub struct OutputTypes(BTreeMap<OutputType, Option<PathBuf>>);\n \n+impl Hash for OutputTypes {\n+    fn hash<H: Hasher>(&self, hasher: &mut H) {\n+        for k in self.keys() {\n+            k.hash(hasher);\n+        }\n+    }\n+}\n+\n impl_stable_hash_via_hash!(OutputTypes);\n \n impl OutputTypes {"}, {"sha": "bd04b3aa423a272cf222ed1dee80f048d8d15005", "filename": "src/test/run-make/emit-path-unhashed/Makefile", "status": "added", "additions": 26, "deletions": 0, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/a26d99f348de873e7a7b2b9ab6e78506278c0fee/src%2Ftest%2Frun-make%2Femit-path-unhashed%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/a26d99f348de873e7a7b2b9ab6e78506278c0fee/src%2Ftest%2Frun-make%2Femit-path-unhashed%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Femit-path-unhashed%2FMakefile?ref=a26d99f348de873e7a7b2b9ab6e78506278c0fee", "patch": "@@ -0,0 +1,26 @@\n+-include ../../run-make-fulldeps/tools.mk\n+\n+OUT=$(TMPDIR)/emit\n+\n+# --emit KIND=PATH should not affect crate hash vs --emit KIND\n+all: $(OUT)/a/libfoo.rlib $(OUT)/b/libfoo.rlib $(TMPDIR)/libfoo.rlib\n+\t$(RUSTC) -Zls $(TMPDIR)/libfoo.rlib > $(TMPDIR)/base.txt\n+\t$(RUSTC) -Zls $(OUT)/a/libfoo.rlib > $(TMPDIR)/a.txt\n+\t$(RUSTC) -Zls $(OUT)/b/libfoo.rlib > $(TMPDIR)/b.txt\n+\n+\tdiff $(TMPDIR)/base.txt $(TMPDIR)/a.txt\n+\tdiff $(TMPDIR)/base.txt $(TMPDIR)/b.txt\n+\n+# Default output name\n+$(TMPDIR)/libfoo.rlib: foo.rs\n+\t$(RUSTC) --emit link foo.rs\n+\n+# Output named with -o\n+$(OUT)/a/libfoo.rlib: foo.rs\n+\tmkdir -p $(OUT)/a\n+\t$(RUSTC) --emit link -o $@ foo.rs\n+\n+# Output named with KIND=PATH\n+$(OUT)/b/libfoo.rlib: foo.rs\n+\tmkdir -p $(OUT)/b\n+\t$(RUSTC) --emit link=$@ foo.rs"}, {"sha": "c1bfaa6cab5d9be9e67e4cfacc8eb4e6110f6358", "filename": "src/test/run-make/emit-path-unhashed/foo.rs", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/a26d99f348de873e7a7b2b9ab6e78506278c0fee/src%2Ftest%2Frun-make%2Femit-path-unhashed%2Ffoo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a26d99f348de873e7a7b2b9ab6e78506278c0fee/src%2Ftest%2Frun-make%2Femit-path-unhashed%2Ffoo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Femit-path-unhashed%2Ffoo.rs?ref=a26d99f348de873e7a7b2b9ab6e78506278c0fee", "patch": "@@ -0,0 +1 @@\n+#![crate_type = \"rlib\"]"}]}