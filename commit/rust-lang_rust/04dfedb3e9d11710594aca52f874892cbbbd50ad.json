{"sha": "04dfedb3e9d11710594aca52f874892cbbbd50ad", "node_id": "C_kwDOAAsO6NoAKDA0ZGZlZGIzZTlkMTE3MTA1OTRhY2E1MmY4NzQ4OTJjYmJiZDUwYWQ", "commit": {"author": {"name": "Petr Sumbera", "email": "petr.sumbera@oracle.com", "date": "2023-03-13T16:43:04Z"}, "committer": {"name": "Petr Sumbera", "email": "petr.sumbera@oracle.com", "date": "2023-03-13T16:43:04Z"}, "message": "Don't use fd-lock on Solaris in bootstrap\n\n...as Solaris is missing flock()\n\nfixes #103630", "tree": {"sha": "555e8e5942c83a625a25f0e725e117056b6dd8c3", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/555e8e5942c83a625a25f0e725e117056b6dd8c3"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/04dfedb3e9d11710594aca52f874892cbbbd50ad", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/04dfedb3e9d11710594aca52f874892cbbbd50ad", "html_url": "https://github.com/rust-lang/rust/commit/04dfedb3e9d11710594aca52f874892cbbbd50ad", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/04dfedb3e9d11710594aca52f874892cbbbd50ad/comments", "author": {"login": "psumbera", "id": 4249116, "node_id": "MDQ6VXNlcjQyNDkxMTY=", "avatar_url": "https://avatars.githubusercontent.com/u/4249116?v=4", "gravatar_id": "", "url": "https://api.github.com/users/psumbera", "html_url": "https://github.com/psumbera", "followers_url": "https://api.github.com/users/psumbera/followers", "following_url": "https://api.github.com/users/psumbera/following{/other_user}", "gists_url": "https://api.github.com/users/psumbera/gists{/gist_id}", "starred_url": "https://api.github.com/users/psumbera/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/psumbera/subscriptions", "organizations_url": "https://api.github.com/users/psumbera/orgs", "repos_url": "https://api.github.com/users/psumbera/repos", "events_url": "https://api.github.com/users/psumbera/events{/privacy}", "received_events_url": "https://api.github.com/users/psumbera/received_events", "type": "User", "site_admin": false}, "committer": {"login": "psumbera", "id": 4249116, "node_id": "MDQ6VXNlcjQyNDkxMTY=", "avatar_url": "https://avatars.githubusercontent.com/u/4249116?v=4", "gravatar_id": "", "url": "https://api.github.com/users/psumbera", "html_url": "https://github.com/psumbera", "followers_url": "https://api.github.com/users/psumbera/followers", "following_url": "https://api.github.com/users/psumbera/following{/other_user}", "gists_url": "https://api.github.com/users/psumbera/gists{/gist_id}", "starred_url": "https://api.github.com/users/psumbera/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/psumbera/subscriptions", "organizations_url": "https://api.github.com/users/psumbera/orgs", "repos_url": "https://api.github.com/users/psumbera/repos", "events_url": "https://api.github.com/users/psumbera/events{/privacy}", "received_events_url": "https://api.github.com/users/psumbera/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "64165aac68af780182ff89a6eb3982e3c262266e", "url": "https://api.github.com/repos/rust-lang/rust/commits/64165aac68af780182ff89a6eb3982e3c262266e", "html_url": "https://github.com/rust-lang/rust/commit/64165aac68af780182ff89a6eb3982e3c262266e"}], "stats": {"total": 23, "additions": 15, "deletions": 8}, "files": [{"sha": "4381e51ca22cdb0ae76512311665e010bc4428ef", "filename": "src/bootstrap/CHANGELOG.md", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/04dfedb3e9d11710594aca52f874892cbbbd50ad/src%2Fbootstrap%2FCHANGELOG.md", "raw_url": "https://github.com/rust-lang/rust/raw/04dfedb3e9d11710594aca52f874892cbbbd50ad/src%2Fbootstrap%2FCHANGELOG.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2FCHANGELOG.md?ref=04dfedb3e9d11710594aca52f874892cbbbd50ad", "patch": "@@ -46,6 +46,7 @@ The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/).\n - Add `--keep-stage-std`, which behaves like `keep-stage` but allows the stage\n   0 compiler artifacts (i.e., stage1/bin/rustc) to be rebuilt if changed\n   [#77120](https://github.com/rust-lang/rust/pull/77120).\n+- File locking is now used to avoid collisions between multiple running instances of `x.py` (e.g. when using `rust-analyzer` and `x.py` at the same time). Note that Solaris and possibly other non Unix and non Windows systems don't support it [#108607](https://github.com/rust-lang/rust/pull/108607). This might possibly lead to build data corruption.\n \n \n ## [Version 1] - 2020-09-11"}, {"sha": "afe3fc1741b30e91d7b36a3f82b80aa157e53fef", "filename": "src/bootstrap/Cargo.toml", "status": "modified", "additions": 4, "deletions": 1, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/04dfedb3e9d11710594aca52f874892cbbbd50ad/src%2Fbootstrap%2FCargo.toml", "raw_url": "https://github.com/rust-lang/rust/raw/04dfedb3e9d11710594aca52f874892cbbbd50ad/src%2Fbootstrap%2FCargo.toml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2FCargo.toml?ref=04dfedb3e9d11710594aca52f874892cbbbd50ad", "patch": "@@ -32,7 +32,6 @@ test = false\n [dependencies]\n build_helper = { path = \"../tools/build_helper\" }\n cmake = \"0.1.38\"\n-fd-lock = \"3.0.8\"\n filetime = \"0.2\"\n getopts = \"0.2.19\"\n cc = \"1.0.69\"\n@@ -56,6 +55,10 @@ walkdir = \"2\"\n # Dependencies needed by the build-metrics feature\n sysinfo = { version = \"0.26.0\", optional = true }\n \n+# Solaris doesn't support flock() and thus fd-lock is not option now\n+[target.'cfg(not(target_os = \"solaris\"))'.dependencies]\n+fd-lock = \"3.0.8\"\n+\n [target.'cfg(windows)'.dependencies.winapi]\n version = \"0.3\"\n features = ["}, {"sha": "018f862fae37c5620c7a169f460659ee3d575d47", "filename": "src/bootstrap/bin/main.rs", "status": "modified", "additions": 10, "deletions": 7, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/04dfedb3e9d11710594aca52f874892cbbbd50ad/src%2Fbootstrap%2Fbin%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/04dfedb3e9d11710594aca52f874892cbbbd50ad/src%2Fbootstrap%2Fbin%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fbin%2Fmain.rs?ref=04dfedb3e9d11710594aca52f874892cbbbd50ad", "patch": "@@ -7,15 +7,18 @@\n \n use std::env;\n \n-use bootstrap::{t, Build, Config, Subcommand, VERSION};\n+#[cfg(all(any(unix, windows), not(target_os = \"solaris\")))]\n+use bootstrap::t;\n+use bootstrap::{Build, Config, Subcommand, VERSION};\n \n fn main() {\n     let args = env::args().skip(1).collect::<Vec<_>>();\n     let config = Config::parse(&args);\n \n-    let mut build_lock;\n-    let _build_lock_guard;\n-    if cfg!(any(unix, windows)) {\n+    #[cfg(all(any(unix, windows), not(target_os = \"solaris\")))]\n+    {\n+        let mut build_lock;\n+        let _build_lock_guard;\n         let path = config.out.join(\"lock\");\n         build_lock = fd_lock::RwLock::new(t!(std::fs::File::create(&path)));\n         _build_lock_guard = match build_lock.try_write() {\n@@ -30,9 +33,9 @@ fn main() {\n                 t!(build_lock.write())\n             }\n         };\n-    } else {\n-        println!(\"warning: file locking not supported for target, not locking build directory\");\n     }\n+    #[cfg(any(not(any(unix, windows)), target_os = \"solaris\"))]\n+    println!(\"warning: file locking not supported for target, not locking build directory\");\n \n     // check_version warnings are not printed during setup\n     let changelog_suggestion =\n@@ -125,7 +128,7 @@ fn get_lock_owner(f: &std::path::Path) -> Option<u64> {\n     })\n }\n \n-#[cfg(not(target_os = \"linux\"))]\n+#[cfg(not(any(target_os = \"linux\", target_os = \"solaris\")))]\n fn get_lock_owner(_: &std::path::Path) -> Option<u64> {\n     // FIXME: Implement on other OS's\n     None"}]}