{"sha": "d20d09712550c820c2d67a9b3ed2a3f9debb9393", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQyMGQwOTcxMjU1MGM4MjBjMmQ2N2E5YjNlZDJhM2Y5ZGViYjkzOTM=", "commit": {"author": {"name": "Mara Bos", "email": "m-ou.se@m-ou.se", "date": "2021-02-04T20:10:31Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-02-04T20:10:31Z"}, "message": "Rollup merge of #74304 - yoshuawuyts:stabilize-wake, r=KodrAus\n\nStabilize the Wake trait\n\nThis PR proposes stabilizing the `wake_trait` feature, tracking issue https://github.com/rust-lang/rust/issues/69912.\n\n## Motivation\n\nThe surface area this trait introduces is small, and it has been on nightly for 4 months without any reported issues. Given the surface area of this trait is small and only serves to provide a safe interface around the already stable [`std::task::RawWakerVTable`](https://doc.rust-lang.org/std/task/struct.RawWaker.html) it seems unlikely this trait will require any further changes. So I'm proposing we stabilize this.\n\nPersonally I would love to have this available on stable, since it would enable cleaning up some runtime internals by removing the tedious pointer required to construct a [`RawWakerVTable`](https://doc.rust-lang.org/std/task/struct.RawWakerVTable.html). I believe the intent was always to introduce a `Wake` counterpart to `RawWaker` in order to safely construct `Waker` instances. And the `Wake` trait feels like it does that job as intended.\n\n## Implementation notes\n\nThis PR itself fixes a link in the docs, and introduces an example of how to use the trait: a minimal `block_on` example that runs a future to completion on the current thread. It doesn't include fancier features such as support for nesting, but is intended to serve as a teaching device for both `task::Wake` and futures alike.", "tree": {"sha": "f4c3ecc3ca708198a103fee5bcc6e631ee73e91c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/f4c3ecc3ca708198a103fee5bcc6e631ee73e91c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d20d09712550c820c2d67a9b3ed2a3f9debb9393", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJgHFS3CRBK7hj4Ov3rIwAAdHIIAD4KFYnoI/yTcbLk8xH+ug/w\nO5k+kcXT19T58ho+7LJas/NKnpbCiGLZ47fYxTb77+rljZAqM8lDSP9X7bzeb+G+\nq8tYvsocOWlp3JdmeMsrILenGRGDRYX9wcN5GNx6+ihRVqZHXtqCswg5P70St7rJ\nrPvWAJTxDn6xELy7o9ml2Y58bKOYLOK719EZ+2DGNxv4DswBj633Hb2ykTN4kdJs\nkz7ppL30sFfIJsnQPvw3LSHxHo08apjdDmoVvwJCmZVCIpYoI8VmHDrEma+qFYxa\nVvoj4+JB+Gcz8iYYdulCMg5py9txh0STCRwdQxGH1RcWANkcOt0CmH0GkAUTuPE=\n=CbKG\n-----END PGP SIGNATURE-----\n", "payload": "tree f4c3ecc3ca708198a103fee5bcc6e631ee73e91c\nparent 822ebfd2c43fbe466da8ae34ffe3ce6cba2e8336\nparent 2c8bf1db549d1e70af53b7ff8b8afb80187827e2\nauthor Mara Bos <m-ou.se@m-ou.se> 1612469431 +0100\ncommitter GitHub <noreply@github.com> 1612469431 +0100\n\nRollup merge of #74304 - yoshuawuyts:stabilize-wake, r=KodrAus\n\nStabilize the Wake trait\n\nThis PR proposes stabilizing the `wake_trait` feature, tracking issue https://github.com/rust-lang/rust/issues/69912.\n\n## Motivation\n\nThe surface area this trait introduces is small, and it has been on nightly for 4 months without any reported issues. Given the surface area of this trait is small and only serves to provide a safe interface around the already stable [`std::task::RawWakerVTable`](https://doc.rust-lang.org/std/task/struct.RawWaker.html) it seems unlikely this trait will require any further changes. So I'm proposing we stabilize this.\n\nPersonally I would love to have this available on stable, since it would enable cleaning up some runtime internals by removing the tedious pointer required to construct a [`RawWakerVTable`](https://doc.rust-lang.org/std/task/struct.RawWakerVTable.html). I believe the intent was always to introduce a `Wake` counterpart to `RawWaker` in order to safely construct `Waker` instances. And the `Wake` trait feels like it does that job as intended.\n\n## Implementation notes\n\nThis PR itself fixes a link in the docs, and introduces an example of how to use the trait: a minimal `block_on` example that runs a future to completion on the current thread. It doesn't include fancier features such as support for nesting, but is intended to serve as a teaching device for both `task::Wake` and futures alike.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d20d09712550c820c2d67a9b3ed2a3f9debb9393", "html_url": "https://github.com/rust-lang/rust/commit/d20d09712550c820c2d67a9b3ed2a3f9debb9393", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d20d09712550c820c2d67a9b3ed2a3f9debb9393/comments", "author": {"login": "m-ou-se", "id": 783247, "node_id": "MDQ6VXNlcjc4MzI0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/783247?v=4", "gravatar_id": "", "url": "https://api.github.com/users/m-ou-se", "html_url": "https://github.com/m-ou-se", "followers_url": "https://api.github.com/users/m-ou-se/followers", "following_url": "https://api.github.com/users/m-ou-se/following{/other_user}", "gists_url": "https://api.github.com/users/m-ou-se/gists{/gist_id}", "starred_url": "https://api.github.com/users/m-ou-se/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/m-ou-se/subscriptions", "organizations_url": "https://api.github.com/users/m-ou-se/orgs", "repos_url": "https://api.github.com/users/m-ou-se/repos", "events_url": "https://api.github.com/users/m-ou-se/events{/privacy}", "received_events_url": "https://api.github.com/users/m-ou-se/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "822ebfd2c43fbe466da8ae34ffe3ce6cba2e8336", "url": "https://api.github.com/repos/rust-lang/rust/commits/822ebfd2c43fbe466da8ae34ffe3ce6cba2e8336", "html_url": "https://github.com/rust-lang/rust/commit/822ebfd2c43fbe466da8ae34ffe3ce6cba2e8336"}, {"sha": "2c8bf1db549d1e70af53b7ff8b8afb80187827e2", "url": "https://api.github.com/repos/rust-lang/rust/commits/2c8bf1db549d1e70af53b7ff8b8afb80187827e2", "html_url": "https://github.com/rust-lang/rust/commit/2c8bf1db549d1e70af53b7ff8b8afb80187827e2"}], "stats": {"total": 70, "additions": 60, "deletions": 10}, "files": [{"sha": "ab7611ae071e7bdb91926ba4b5dd892a333518fe", "filename": "library/alloc/src/task.rs", "status": "modified", "additions": 59, "deletions": 7, "changes": 66, "blob_url": "https://github.com/rust-lang/rust/blob/d20d09712550c820c2d67a9b3ed2a3f9debb9393/library%2Falloc%2Fsrc%2Ftask.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d20d09712550c820c2d67a9b3ed2a3f9debb9393/library%2Falloc%2Fsrc%2Ftask.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Falloc%2Fsrc%2Ftask.rs?ref=d20d09712550c820c2d67a9b3ed2a3f9debb9393", "patch": "@@ -1,4 +1,4 @@\n-#![unstable(feature = \"wake_trait\", issue = \"69912\")]\n+#![stable(feature = \"wake_trait\", since = \"1.51.0\")]\n //! Types and Traits for working with asynchronous tasks.\n use core::mem::ManuallyDrop;\n use core::task::{RawWaker, RawWakerVTable, Waker};\n@@ -16,26 +16,78 @@ use crate::sync::Arc;\n /// to wake up a task is stored in an [`Arc`]. Some executors (especially\n /// those for embedded systems) cannot use this API, which is why [`RawWaker`]\n /// exists as an alternative for those systems.\n-#[unstable(feature = \"wake_trait\", issue = \"69912\")]\n+///\n+/// [arc]: ../../std/sync/struct.Arc.html\n+///\n+/// # Examples\n+///\n+/// A basic `block_on` function that takes a future and runs it to completion on\n+/// the current thread.\n+///\n+/// **Note:** This example trades correctness for simplicity. In order to prevent\n+/// deadlocks, production-grade implementations will also need to handle\n+/// intermediate calls to `thread::unpark` as well as nested invocations.\n+///\n+/// ```rust\n+/// use std::future::Future;\n+/// use std::sync::Arc;\n+/// use std::task::{Context, Poll, Wake};\n+/// use std::thread::{self, Thread};\n+///\n+/// /// A waker that wakes up the current thread when called.\n+/// struct ThreadWaker(Thread);\n+///\n+/// impl Wake for ThreadWaker {\n+///     fn wake(self: Arc<Self>) {\n+///         self.0.unpark();\n+///     }\n+/// }\n+///\n+/// /// Run a future to completion on the current thread.\n+/// fn block_on<T>(fut: impl Future<Output = T>) -> T {\n+///     // Pin the future so it can be polled.\n+///     let mut fut = Box::pin(fut);\n+///\n+///     // Create a new context to be passed to the future.\n+///     let t = thread::current();\n+///     let waker = Arc::new(ThreadWaker(t)).into();\n+///     let mut cx = Context::from_waker(&waker);\n+///\n+///     // Run the future to completion.\n+///     loop {\n+///         match fut.as_mut().poll(&mut cx) {\n+///             Poll::Ready(res) => return res,\n+///             Poll::Pending => thread::park(),\n+///         }\n+///     }\n+/// }\n+///\n+/// block_on(async {\n+///     println!(\"Hi from inside a future!\");\n+/// });\n+/// ```\n+#[stable(feature = \"wake_trait\", since = \"1.51.0\")]\n pub trait Wake {\n     /// Wake this task.\n-    #[unstable(feature = \"wake_trait\", issue = \"69912\")]\n+    #[stable(feature = \"wake_trait\", since = \"1.51.0\")]\n     fn wake(self: Arc<Self>);\n \n     /// Wake this task without consuming the waker.\n     ///\n     /// If an executor supports a cheaper way to wake without consuming the\n     /// waker, it should override this method. By default, it clones the\n-    /// [`Arc`] and calls `wake` on the clone.\n-    #[unstable(feature = \"wake_trait\", issue = \"69912\")]\n+    /// [`Arc`] and calls [`wake`] on the clone.\n+    ///\n+    /// [`wake`]: Wake::wake\n+    #[stable(feature = \"wake_trait\", since = \"1.51.0\")]\n     fn wake_by_ref(self: &Arc<Self>) {\n         self.clone().wake();\n     }\n }\n \n #[cfg_attr(bootstrap, allow(rustc::ineffective_unstable_trait_impl))]\n #[cfg_attr(not(bootstrap), allow(ineffective_unstable_trait_impl))]\n-#[unstable(feature = \"wake_trait\", issue = \"69912\")]\n+#[stable(feature = \"wake_trait\", since = \"1.51.0\")]\n impl<W: Wake + Send + Sync + 'static> From<Arc<W>> for Waker {\n     fn from(waker: Arc<W>) -> Waker {\n         // SAFETY: This is safe because raw_waker safely constructs\n@@ -46,7 +98,7 @@ impl<W: Wake + Send + Sync + 'static> From<Arc<W>> for Waker {\n \n #[cfg_attr(bootstrap, allow(rustc::ineffective_unstable_trait_impl))]\n #[cfg_attr(not(bootstrap), allow(ineffective_unstable_trait_impl))]\n-#[unstable(feature = \"wake_trait\", issue = \"69912\")]\n+#[stable(feature = \"wake_trait\", since = \"1.51.0\")]\n impl<W: Wake + Send + Sync + 'static> From<Arc<W>> for RawWaker {\n     fn from(waker: Arc<W>) -> RawWaker {\n         raw_waker(waker)"}, {"sha": "961cff661e3ba803b807a42cd2b8cc2194241219", "filename": "library/std/src/lib.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/d20d09712550c820c2d67a9b3ed2a3f9debb9393/library%2Fstd%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d20d09712550c820c2d67a9b3ed2a3f9debb9393/library%2Fstd%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Flib.rs?ref=d20d09712550c820c2d67a9b3ed2a3f9debb9393", "patch": "@@ -329,7 +329,6 @@\n #![feature(unwind_attributes)]\n #![feature(vec_into_raw_parts)]\n #![feature(vec_spare_capacity)]\n-#![feature(wake_trait)]\n // NB: the above list is sorted to minimize merge conflicts.\n #![default_lib_allocator]\n \n@@ -508,7 +507,7 @@ pub mod task {\n     pub use core::task::*;\n \n     #[doc(inline)]\n-    #[unstable(feature = \"wake_trait\", issue = \"69912\")]\n+    #[stable(feature = \"wake_trait\", since = \"1.51.0\")]\n     pub use alloc::task::*;\n }\n "}, {"sha": "c43ce2cadba046672c01a7e664572adae43c80a0", "filename": "src/test/ui/async-await/issue-73137.rs", "status": "modified", "additions": 0, "deletions": 1, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/d20d09712550c820c2d67a9b3ed2a3f9debb9393/src%2Ftest%2Fui%2Fasync-await%2Fissue-73137.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d20d09712550c820c2d67a9b3ed2a3f9debb9393/src%2Ftest%2Fui%2Fasync-await%2Fissue-73137.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fasync-await%2Fissue-73137.rs?ref=d20d09712550c820c2d67a9b3ed2a3f9debb9393", "patch": "@@ -4,7 +4,6 @@\n // edition:2018\n \n #![allow(dead_code)]\n-#![feature(wake_trait)]\n use std::future::Future;\n use std::task::{Waker, Wake, Context};\n use std::sync::Arc;"}]}