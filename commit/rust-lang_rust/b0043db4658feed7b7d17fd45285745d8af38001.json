{"sha": "b0043db4658feed7b7d17fd45285745d8af38001", "node_id": "MDY6Q29tbWl0NzI0NzEyOmIwMDQzZGI0NjU4ZmVlZDdiN2QxN2ZkNDUyODU3NDVkOGFmMzgwMDE=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-04-26T05:32:16Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2015-04-26T05:32:16Z"}, "message": "Auto merge of #24367 - ebfull:fix_ice_cat_expr, r=pnkfelix\n\nAn actual typeck error is the cause of many failed compilations but an\r\nunrelated bug is being reported instead. It is triggered because a typeck\r\nerror is presumably not yet identified during compiler execution, which\r\nwould normally bypass an invariant in the presence of other errors. In\r\nthis particular situation, we delay the reporting of the bug until\r\nabort_if_errors().\r\n\r\nCloses #23827, closes #24356, closes #23041, closes #22897, closes #23966,\r\ncloses #24013, and closes #23729\r\n\r\n**There is at least one situation where this bug may still be genuinely\r\ntriggered (#23437).**", "tree": {"sha": "b1fffbcdad6ca7396b1f3404c4fd3388b4220752", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/b1fffbcdad6ca7396b1f3404c4fd3388b4220752"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b0043db4658feed7b7d17fd45285745d8af38001", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b0043db4658feed7b7d17fd45285745d8af38001", "html_url": "https://github.com/rust-lang/rust/commit/b0043db4658feed7b7d17fd45285745d8af38001", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b0043db4658feed7b7d17fd45285745d8af38001/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "61a5e4672662d16e659d30017eece3aee5b32d82", "url": "https://api.github.com/repos/rust-lang/rust/commits/61a5e4672662d16e659d30017eece3aee5b32d82", "html_url": "https://github.com/rust-lang/rust/commit/61a5e4672662d16e659d30017eece3aee5b32d82"}, {"sha": "be1117113f60b8afedf90039b0dcb87148666567", "url": "https://api.github.com/repos/rust-lang/rust/commits/be1117113f60b8afedf90039b0dcb87148666567", "html_url": "https://github.com/rust-lang/rust/commit/be1117113f60b8afedf90039b0dcb87148666567"}], "stats": {"total": 98, "additions": 87, "deletions": 11}, "files": [{"sha": "14bc19dffd5d0b6f307856c23ccdf8814b74fdf9", "filename": "src/librustc/session/mod.rs", "status": "modified", "additions": 17, "deletions": 1, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/b0043db4658feed7b7d17fd45285745d8af38001/src%2Flibrustc%2Fsession%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b0043db4658feed7b7d17fd45285745d8af38001/src%2Flibrustc%2Fsession%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fsession%2Fmod.rs?ref=b0043db4658feed7b7d17fd45285745d8af38001", "patch": "@@ -57,6 +57,8 @@ pub struct Session {\n     pub crate_metadata: RefCell<Vec<String>>,\n     pub features: RefCell<feature_gate::Features>,\n \n+    pub delayed_span_bug: RefCell<Option<(codemap::Span, String)>>,\n+\n     /// The maximum recursion limit for potentially infinitely recursive\n     /// operations such as auto-dereference and monomorphization.\n     pub recursion_limit: Cell<usize>,\n@@ -114,7 +116,15 @@ impl Session {\n         self.diagnostic().handler().has_errors()\n     }\n     pub fn abort_if_errors(&self) {\n-        self.diagnostic().handler().abort_if_errors()\n+        self.diagnostic().handler().abort_if_errors();\n+\n+        let delayed_bug = self.delayed_span_bug.borrow();\n+        match *delayed_bug {\n+            Some((span, ref errmsg)) => {\n+                self.diagnostic().span_bug(span, errmsg);\n+            },\n+            _ => {}\n+        }\n     }\n     pub fn span_warn(&self, sp: Span, msg: &str) {\n         if self.can_print_warnings {\n@@ -171,6 +181,11 @@ impl Session {\n             None => self.bug(msg),\n         }\n     }\n+    /// Delay a span_bug() call until abort_if_errors()\n+    pub fn delay_span_bug(&self, sp: Span, msg: &str) {\n+        let mut delayed = self.delayed_span_bug.borrow_mut();\n+        *delayed = Some((sp, msg.to_string()));\n+    }\n     pub fn span_bug(&self, sp: Span, msg: &str) -> ! {\n         self.diagnostic().span_bug(sp, msg)\n     }\n@@ -402,6 +417,7 @@ pub fn build_session_(sopts: config::Options,\n         plugin_llvm_passes: RefCell::new(Vec::new()),\n         crate_types: RefCell::new(Vec::new()),\n         crate_metadata: RefCell::new(Vec::new()),\n+        delayed_span_bug: RefCell::new(None),\n         features: RefCell::new(feature_gate::Features::new()),\n         recursion_limit: Cell::new(64),\n         can_print_warnings: can_print_warnings"}, {"sha": "19cb570c82d13463a8f34a75fa57b4ab16788d6e", "filename": "src/librustc_typeck/check/regionck.rs", "status": "modified", "additions": 2, "deletions": 10, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/b0043db4658feed7b7d17fd45285745d8af38001/src%2Flibrustc_typeck%2Fcheck%2Fregionck.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b0043db4658feed7b7d17fd45285745d8af38001/src%2Flibrustc_typeck%2Fcheck%2Fregionck.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_typeck%2Fcheck%2Fregionck.rs?ref=b0043db4658feed7b7d17fd45285745d8af38001", "patch": "@@ -562,11 +562,7 @@ fn visit_expr(rcx: &mut Rcx, expr: &ast::Expr) {\n             }\n             Err(..) => {\n                 let tcx = rcx.fcx.tcx();\n-                if tcx.sess.has_errors() {\n-                    // cannot run dropck; okay b/c in error state anyway.\n-                } else {\n-                    tcx.sess.span_bug(expr.span, \"cat_expr_unadjusted Errd\");\n-                }\n+                tcx.sess.delay_span_bug(expr.span, \"cat_expr_unadjusted Errd\");\n             }\n         }\n     }\n@@ -583,11 +579,7 @@ fn visit_expr(rcx: &mut Rcx, expr: &ast::Expr) {\n         }\n         Err(..) => {\n             let tcx = rcx.fcx.tcx();\n-            if tcx.sess.has_errors() {\n-                // cannot run dropck; okay b/c in error state anyway.\n-            } else {\n-                tcx.sess.span_bug(expr.span, \"cat_expr Errd\");\n-            }\n+            tcx.sess.delay_span_bug(expr.span, \"cat_expr Errd\");\n         }\n     }\n "}, {"sha": "c6bbf2d4abcc07645493900bdc369db04290d818", "filename": "src/test/compile-fail/issue-22897.rs", "status": "added", "additions": 19, "deletions": 0, "changes": 19, "blob_url": "https://github.com/rust-lang/rust/blob/b0043db4658feed7b7d17fd45285745d8af38001/src%2Ftest%2Fcompile-fail%2Fissue-22897.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b0043db4658feed7b7d17fd45285745d8af38001/src%2Ftest%2Fcompile-fail%2Fissue-22897.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fissue-22897.rs?ref=b0043db4658feed7b7d17fd45285745d8af38001", "patch": "@@ -0,0 +1,19 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+fn main() { }\n+\n+// Before these errors would ICE as \"cat_expr Errd\" because the errors\n+// were unknown when the bug was triggered.\n+\n+fn unconstrained_type() {\n+    [];\n+    //~^ ERROR cannot determine a type for this expression: unconstrained type\n+}"}, {"sha": "68895759c5c2ad5b0b389fbe21361b529d3108ff", "filename": "src/test/compile-fail/issue-23041.rs", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/b0043db4658feed7b7d17fd45285745d8af38001/src%2Ftest%2Fcompile-fail%2Fissue-23041.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b0043db4658feed7b7d17fd45285745d8af38001/src%2Ftest%2Fcompile-fail%2Fissue-23041.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fissue-23041.rs?ref=b0043db4658feed7b7d17fd45285745d8af38001", "patch": "@@ -0,0 +1,18 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+use std::any::Any;\n+fn main()\n+{\n+    fn bar(x:i32) ->i32 { 3*x };\n+    let b:Box<Any> = Box::new(bar as fn(_)->_);\n+    b.downcast_ref::<fn(_)->_>();\n+    //~^ ERROR cannot determine a type for this expression: unconstrained type\n+}"}, {"sha": "18b513686652190620384a11b6924c019c7eb0e1", "filename": "src/test/compile-fail/issue-23966.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/b0043db4658feed7b7d17fd45285745d8af38001/src%2Ftest%2Fcompile-fail%2Fissue-23966.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b0043db4658feed7b7d17fd45285745d8af38001/src%2Ftest%2Fcompile-fail%2Fissue-23966.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fissue-23966.rs?ref=b0043db4658feed7b7d17fd45285745d8af38001", "patch": "@@ -0,0 +1,14 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+fn main() {\n+    \"\".chars().fold(|_, _| (), ());\n+    //~^ ERROR cannot determine a type for this expression: unconstrained type\n+}"}, {"sha": "0adad8a88cbc9a9a245617059418d559c58e8a2a", "filename": "src/test/compile-fail/issue-24013.rs", "status": "added", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/b0043db4658feed7b7d17fd45285745d8af38001/src%2Ftest%2Fcompile-fail%2Fissue-24013.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b0043db4658feed7b7d17fd45285745d8af38001/src%2Ftest%2Fcompile-fail%2Fissue-24013.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcompile-fail%2Fissue-24013.rs?ref=b0043db4658feed7b7d17fd45285745d8af38001", "patch": "@@ -0,0 +1,17 @@\n+// Copyright 2015 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+fn main() {\n+    use std::mem::{transmute, swap};\n+    let a = 1;\n+    let b = 2;\n+    unsafe {swap::<&mut _>(transmute(&a), transmute(&b))};\n+    //~^ ERROR cannot determine a type for this expression: unconstrained type\n+}"}]}