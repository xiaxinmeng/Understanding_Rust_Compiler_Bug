{"sha": "80b9e36709019f98f6bdc33e632641861e470128", "node_id": "MDY6Q29tbWl0NzI0NzEyOjgwYjllMzY3MDkwMTlmOThmNmJkYzMzZTYzMjY0MTg2MWU0NzAxMjg=", "commit": {"author": {"name": "bjorn3", "email": "bjorn3@users.noreply.github.com", "date": "2021-07-17T14:32:55Z"}, "committer": {"name": "bjorn3", "email": "bjorn3@users.noreply.github.com", "date": "2021-07-17T14:32:55Z"}, "message": "Put all cg_clif specific options behind -Zunstable-features", "tree": {"sha": "edd315b6c78fbd499203c5e04c34aedabb4216ef", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/edd315b6c78fbd499203c5e04c34aedabb4216ef"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/80b9e36709019f98f6bdc33e632641861e470128", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/80b9e36709019f98f6bdc33e632641861e470128", "html_url": "https://github.com/rust-lang/rust/commit/80b9e36709019f98f6bdc33e632641861e470128", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/80b9e36709019f98f6bdc33e632641861e470128/comments", "author": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bjorn3", "id": 17426603, "node_id": "MDQ6VXNlcjE3NDI2NjAz", "avatar_url": "https://avatars.githubusercontent.com/u/17426603?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bjorn3", "html_url": "https://github.com/bjorn3", "followers_url": "https://api.github.com/users/bjorn3/followers", "following_url": "https://api.github.com/users/bjorn3/following{/other_user}", "gists_url": "https://api.github.com/users/bjorn3/gists{/gist_id}", "starred_url": "https://api.github.com/users/bjorn3/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bjorn3/subscriptions", "organizations_url": "https://api.github.com/users/bjorn3/orgs", "repos_url": "https://api.github.com/users/bjorn3/repos", "events_url": "https://api.github.com/users/bjorn3/events{/privacy}", "received_events_url": "https://api.github.com/users/bjorn3/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "60340d44d84dedd7112d2773bf949b606b40cb4a", "url": "https://api.github.com/repos/rust-lang/rust/commits/60340d44d84dedd7112d2773bf949b606b40cb4a", "html_url": "https://github.com/rust-lang/rust/commit/60340d44d84dedd7112d2773bf949b606b40cb4a"}], "stats": {"total": 29, "additions": 20, "deletions": 9}, "files": [{"sha": "87eec0e818bb2407695c4fa6b82ff49eada037a1", "filename": "docs/usage.md", "status": "modified", "additions": 2, "deletions": 2, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/80b9e36709019f98f6bdc33e632641861e470128/docs%2Fusage.md", "raw_url": "https://github.com/rust-lang/rust/raw/80b9e36709019f98f6bdc33e632641861e470128/docs%2Fusage.md", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/docs%2Fusage.md?ref=80b9e36709019f98f6bdc33e632641861e470128", "patch": "@@ -36,7 +36,7 @@ $ $cg_clif_dir/build/cargo jit\n or\n \n ```bash\n-$ $cg_clif_dir/build/bin/cg_clif -Cllvm-args=mode=jit -Cprefer-dynamic my_crate.rs\n+$ $cg_clif_dir/build/bin/cg_clif -Zunstable-features -Cllvm-args=mode=jit -Cprefer-dynamic my_crate.rs\n ```\n \n There is also an experimental lazy jit mode. In this mode functions are only compiled once they are\n@@ -52,7 +52,7 @@ These are a few functions that allow you to easily run rust code from the shell\n \n ```bash\n function jit_naked() {\n-    echo \"$@\" | $cg_clif_dir/build/bin/cg_clif - -Cllvm-args=mode=jit -Cprefer-dynamic\n+    echo \"$@\" | $cg_clif_dir/build/bin/cg_clif - -Zunstable-features -Cllvm-args=mode=jit -Cprefer-dynamic\n }\n \n function jit() {"}, {"sha": "89ec8da77d3ec5f6a1ade1ba67fe7aeb7500bac6", "filename": "scripts/cargo.rs", "status": "modified", "additions": 10, "deletions": 2, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/80b9e36709019f98f6bdc33e632641861e470128/scripts%2Fcargo.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80b9e36709019f98f6bdc33e632641861e470128/scripts%2Fcargo.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/scripts%2Fcargo.rs?ref=80b9e36709019f98f6bdc33e632641861e470128", "patch": "@@ -44,7 +44,11 @@ fn main() {\n             );\n             std::array::IntoIter::new([\"rustc\".to_string()])\n                 .chain(env::args().skip(2))\n-                .chain([\"--\".to_string(), \"-Cllvm-args=mode=jit\".to_string()])\n+                .chain([\n+                    \"--\".to_string(),\n+                    \"-Zunstable-features\".to_string(),\n+                    \"-Cllvm-args=mode=jit\".to_string(),\n+                ])\n                 .collect()\n         }\n         Some(\"lazy-jit\") => {\n@@ -54,7 +58,11 @@ fn main() {\n             );\n             std::array::IntoIter::new([\"rustc\".to_string()])\n                 .chain(env::args().skip(2))\n-                .chain([\"--\".to_string(), \"-Cllvm-args=mode=jit-lazy\".to_string()])\n+                .chain([\n+                    \"--\".to_string(),\n+                    \"-Zunstable-features\".to_string(),\n+                    \"-Cllvm-args=mode=jit-lazy\".to_string(),\n+                ])\n                 .collect()\n         }\n         _ => env::args().skip(1).collect(),"}, {"sha": "c4801a0a87b886feef8df77275caf0113f7c8f72", "filename": "scripts/filter_profile.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/80b9e36709019f98f6bdc33e632641861e470128/scripts%2Ffilter_profile.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80b9e36709019f98f6bdc33e632641861e470128/scripts%2Ffilter_profile.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/scripts%2Ffilter_profile.rs?ref=80b9e36709019f98f6bdc33e632641861e470128", "patch": "@@ -5,7 +5,7 @@ pushd $(dirname \"$0\")/../\n source scripts/config.sh\n RUSTC=\"$(pwd)/build/bin/cg_clif\"\n popd\n-PROFILE=$1 OUTPUT=$2 exec $RUSTC -Cllvm-args=mode=jit -Cprefer-dynamic $0\n+PROFILE=$1 OUTPUT=$2 exec $RUSTC -Zunstable-options -Cllvm-args=mode=jit -Cprefer-dynamic $0\n #*/\n \n //! This program filters away uninteresting samples and trims uninteresting frames for stackcollapse"}, {"sha": "08c07dfad428e34d032ca8510f13753c6d839df5", "filename": "scripts/tests.sh", "status": "modified", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/80b9e36709019f98f6bdc33e632641861e470128/scripts%2Ftests.sh", "raw_url": "https://github.com/rust-lang/rust/raw/80b9e36709019f98f6bdc33e632641861e470128/scripts%2Ftests.sh", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/scripts%2Ftests.sh?ref=80b9e36709019f98f6bdc33e632641861e470128", "patch": "@@ -16,10 +16,10 @@ function no_sysroot_tests() {\n \n     if [[ \"$JIT_SUPPORTED\" = \"1\" ]]; then\n         echo \"[JIT] mini_core_hello_world\"\n-        CG_CLIF_JIT_ARGS=\"abc bcd\" $MY_RUSTC -Cllvm-args=mode=jit -Cprefer-dynamic example/mini_core_hello_world.rs --cfg jit --target \"$HOST_TRIPLE\"\n+        CG_CLIF_JIT_ARGS=\"abc bcd\" $MY_RUSTC -Zunstable-options -Cllvm-args=mode=jit -Cprefer-dynamic example/mini_core_hello_world.rs --cfg jit --target \"$HOST_TRIPLE\"\n \n         echo \"[JIT-lazy] mini_core_hello_world\"\n-        CG_CLIF_JIT_ARGS=\"abc bcd\" $MY_RUSTC -Cllvm-args=mode=jit-lazy -Cprefer-dynamic example/mini_core_hello_world.rs --cfg jit --target \"$HOST_TRIPLE\"\n+        CG_CLIF_JIT_ARGS=\"abc bcd\" $MY_RUSTC -Zunstable-options -Cllvm-args=mode=jit-lazy -Cprefer-dynamic example/mini_core_hello_world.rs --cfg jit --target \"$HOST_TRIPLE\"\n     else\n         echo \"[JIT] mini_core_hello_world (skipped)\"\n     fi\n@@ -44,10 +44,10 @@ function base_sysroot_tests() {\n \n     if [[ \"$JIT_SUPPORTED\" = \"1\" ]]; then\n         echo \"[JIT] std_example\"\n-        $MY_RUSTC -Cllvm-args=mode=jit -Cprefer-dynamic example/std_example.rs --target \"$HOST_TRIPLE\"\n+        $MY_RUSTC -Zunstable-options -Cllvm-args=mode=jit -Cprefer-dynamic example/std_example.rs --target \"$HOST_TRIPLE\"\n \n         echo \"[JIT-lazy] std_example\"\n-        $MY_RUSTC -Cllvm-args=mode=jit-lazy -Cprefer-dynamic example/std_example.rs --target \"$HOST_TRIPLE\"\n+        $MY_RUSTC -Zunstable-options -Cllvm-args=mode=jit-lazy -Cprefer-dynamic example/std_example.rs --target \"$HOST_TRIPLE\"\n     else\n         echo \"[JIT] std_example (skipped)\"\n     fi"}, {"sha": "366b9a7e24c5aaeab8c087ca76866a71182e499d", "filename": "src/lib.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/80b9e36709019f98f6bdc33e632641861e470128/src%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/80b9e36709019f98f6bdc33e632641861e470128/src%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flib.rs?ref=80b9e36709019f98f6bdc33e632641861e470128", "patch": "@@ -184,6 +184,9 @@ impl CodegenBackend for CraneliftCodegenBackend {\n         let config = if let Some(config) = self.config.clone() {\n             config\n         } else {\n+            if !tcx.sess.unstable_options() && !tcx.sess.opts.cg.llvm_args.is_empty() {\n+                tcx.sess.fatal(\"`-Z unstable-options` must be passed to allow configuring cg_clif\");\n+            }\n             BackendConfig::from_opts(&tcx.sess.opts.cg.llvm_args)\n                 .unwrap_or_else(|err| tcx.sess.fatal(&err))\n         };"}]}