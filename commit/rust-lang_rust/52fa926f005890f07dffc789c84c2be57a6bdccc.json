{"sha": "52fa926f005890f07dffc789c84c2be57a6bdccc", "node_id": "MDY6Q29tbWl0NzI0NzEyOjUyZmE5MjZmMDA1ODkwZjA3ZGZmYzc4OWM4NGMyYmU1N2E2YmRjY2M=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2021-01-11T19:18:34Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2021-01-11T19:18:34Z"}, "message": "Merge #7250\n\n7250: Improve analysis stats legibility r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>", "tree": {"sha": "30832184556c14f7032dd99798ecbccce3166a88", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/30832184556c14f7032dd99798ecbccce3166a88"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/52fa926f005890f07dffc789c84c2be57a6bdccc", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJf/KSKCRBK7hj4Ov3rIwAAdHIIAGxQySyELWMcaJp3XNmFBthW\nJ7E3p/mmwClBWye+N931oQtQBnKGOWitwBS8y6COcfKS9OHFAwCrghZREljpkdAn\nw8AgEA0mSefO+SeInHewhpgqtQ2Usi1KYoguEmA56LmBZMT9uUGjp3dmuWm2ca8h\nWyCZ7vGRzsxySPxF0f67E5Os6HS9U5XajHiSZN0GY6q2dfCmujeiMiXCz9rp02Y6\n25Bsv6QNm7o7hFT/aHibepjpoYNL+WT1e30PplBTF5jK7wz21yRRta6Obe4O8fAd\nTemMjjMf32I7Ni5D49wiN03tnqeUs2PbvgiJXop/vmZCyIFS255j1FA+D/lPncw=\n=V9uy\n-----END PGP SIGNATURE-----\n", "payload": "tree 30832184556c14f7032dd99798ecbccce3166a88\nparent 5a0b8a27148a078c07c15b98c73d809669051b6c\nparent 9fd4e5c66ce3710dafde84405dc29686d0e49bf8\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1610392714 +0000\ncommitter GitHub <noreply@github.com> 1610392714 +0000\n\nMerge #7250\n\n7250: Improve analysis stats legibility r=matklad a=matklad\n\nbors r+\n\ud83e\udd16\n\nCo-authored-by: Aleksey Kladov <aleksey.kladov@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/52fa926f005890f07dffc789c84c2be57a6bdccc", "html_url": "https://github.com/rust-lang/rust/commit/52fa926f005890f07dffc789c84c2be57a6bdccc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/52fa926f005890f07dffc789c84c2be57a6bdccc/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "5a0b8a27148a078c07c15b98c73d809669051b6c", "url": "https://api.github.com/repos/rust-lang/rust/commits/5a0b8a27148a078c07c15b98c73d809669051b6c", "html_url": "https://github.com/rust-lang/rust/commit/5a0b8a27148a078c07c15b98c73d809669051b6c"}, {"sha": "9fd4e5c66ce3710dafde84405dc29686d0e49bf8", "url": "https://api.github.com/repos/rust-lang/rust/commits/9fd4e5c66ce3710dafde84405dc29686d0e49bf8", "html_url": "https://github.com/rust-lang/rust/commit/9fd4e5c66ce3710dafde84405dc29686d0e49bf8"}], "stats": {"total": 37, "additions": 17, "deletions": 20}, "files": [{"sha": "fd1407e6071af41a304b804884ba82c8be49b43a", "filename": "crates/rust-analyzer/src/cli/analysis_stats.rs", "status": "modified", "additions": 17, "deletions": 20, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/52fa926f005890f07dffc789c84c2be57a6bdccc/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fanalysis_stats.rs", "raw_url": "https://github.com/rust-lang/rust/raw/52fa926f005890f07dffc789c84c2be57a6bdccc/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fanalysis_stats.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fcli%2Fanalysis_stats.rs?ref=52fa926f005890f07dffc789c84c2be57a6bdccc", "patch": "@@ -58,7 +58,7 @@ impl AnalysisStatsCmd {\n         let mut db_load_sw = self.stop_watch();\n         let (host, vfs) = load_cargo(&self.path, self.load_output_dirs, self.with_proc_macro)?;\n         let db = host.raw_database();\n-        eprintln!(\"Database loaded {}\", db_load_sw.elapsed());\n+        eprintln!(\"{:<20} {}\", \"Database loaded:\", db_load_sw.elapsed());\n \n         let mut analysis_sw = self.stop_watch();\n         let mut num_crates = 0;\n@@ -85,7 +85,7 @@ impl AnalysisStatsCmd {\n             shuffle(&mut rng, &mut visit_queue);\n         }\n \n-        eprintln!(\"Crates in this dir: {}\", num_crates);\n+        eprint!(\"  crates: {}\", num_crates);\n         let mut num_decls = 0;\n         let mut funcs = Vec::new();\n         while let Some(module) = visit_queue.pop() {\n@@ -109,10 +109,8 @@ impl AnalysisStatsCmd {\n                 }\n             }\n         }\n-        eprintln!(\"Total modules found: {}\", visited_modules.len());\n-        eprintln!(\"Total declarations: {}\", num_decls);\n-        eprintln!(\"Total functions: {}\", funcs.len());\n-        eprintln!(\"Item Collection: {}\", analysis_sw.elapsed());\n+        eprintln!(\", mods: {}, decls: {}, fns: {}\", visited_modules.len(), num_decls, funcs.len());\n+        eprintln!(\"{:<20} {}\", \"Item Collection:\", analysis_sw.elapsed());\n \n         if self.randomize {\n             shuffle(&mut rng, &mut funcs);\n@@ -135,7 +133,7 @@ impl AnalysisStatsCmd {\n                     snap.0.infer(f_id.into());\n                 })\n                 .count();\n-            eprintln!(\"Parallel Inference: {}\", inference_sw.elapsed());\n+            eprintln!(\"{:<20} {}\", \"Parallel Inference:\", inference_sw.elapsed());\n         }\n \n         let mut inference_sw = self.stop_watch();\n@@ -273,27 +271,22 @@ impl AnalysisStatsCmd {\n             bar.inc(1);\n         }\n         bar.finish_and_clear();\n-        eprintln!(\"Total expressions: {}\", num_exprs);\n         eprintln!(\n-            \"Expressions of unknown type: {} ({}%)\",\n+            \"  exprs: {}, ??ty: {} ({}%), ?ty: {} ({}%), !ty: {}\",\n+            num_exprs,\n             num_exprs_unknown,\n-            if num_exprs > 0 { num_exprs_unknown * 100 / num_exprs } else { 100 }\n-        );\n-        report_metric(\"unknown type\", num_exprs_unknown, \"#\");\n-\n-        eprintln!(\n-            \"Expressions of partially unknown type: {} ({}%)\",\n+            percentage(num_exprs_unknown, num_exprs),\n             num_exprs_partially_unknown,\n-            if num_exprs > 0 { num_exprs_partially_unknown * 100 / num_exprs } else { 100 }\n+            percentage(num_exprs_partially_unknown, num_exprs),\n+            num_type_mismatches\n         );\n-\n-        eprintln!(\"Type mismatches: {}\", num_type_mismatches);\n+        report_metric(\"unknown type\", num_exprs_unknown, \"#\");\n         report_metric(\"type mismatches\", num_type_mismatches, \"#\");\n \n-        eprintln!(\"Inference: {}\", inference_sw.elapsed());\n+        eprintln!(\"{:<20} {}\", \"Inference:\", inference_sw.elapsed());\n \n         let total_span = analysis_sw.elapsed();\n-        eprintln!(\"Total: {}\", total_span);\n+        eprintln!(\"{:<20} {}\", \"Total:\", total_span);\n         report_metric(\"total time\", total_span.time.as_millis() as u64, \"ms\");\n         if let Some(instructions) = total_span.instructions {\n             report_metric(\"total instructions\", instructions, \"#instr\");\n@@ -325,3 +318,7 @@ fn shuffle<T>(rng: &mut Rand32, slice: &mut [T]) {\n         slice.swap(0, idx);\n     }\n }\n+\n+fn percentage(n: u64, total: u64) -> u64 {\n+    (n * 100).checked_div(total).unwrap_or(100)\n+}"}]}