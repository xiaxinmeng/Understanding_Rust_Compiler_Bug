{"sha": "81f435dd37c5ec828b621d37ec15bf41a33ff89a", "node_id": "MDY6Q29tbWl0NzI0NzEyOjgxZjQzNWRkMzdjNWVjODI4YjYyMWQzN2VjMTViZjQxYTMzZmY4OWE=", "commit": {"author": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2020-03-03T23:07:33Z"}, "committer": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2020-03-04T19:05:17Z"}, "message": "On mismatched delimiters, only point at empty blocks that are in the same line", "tree": {"sha": "2b42f7275d2ea81c085ba3015bc64a5c340ffb52", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2b42f7275d2ea81c085ba3015bc64a5c340ffb52"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/81f435dd37c5ec828b621d37ec15bf41a33ff89a", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/81f435dd37c5ec828b621d37ec15bf41a33ff89a", "html_url": "https://github.com/rust-lang/rust/commit/81f435dd37c5ec828b621d37ec15bf41a33ff89a", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/81f435dd37c5ec828b621d37ec15bf41a33ff89a/comments", "author": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "committer": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "360e42de82152c4e1a6e70d2f228dd3748c50c8d", "url": "https://api.github.com/repos/rust-lang/rust/commits/360e42de82152c4e1a6e70d2f228dd3748c50c8d", "html_url": "https://github.com/rust-lang/rust/commit/360e42de82152c4e1a6e70d2f228dd3748c50c8d"}], "stats": {"total": 17, "additions": 8, "deletions": 9}, "files": [{"sha": "b65b894172844ccbdccb8f1ad221079138365472", "filename": "src/librustc_parse/lexer/tokentrees.rs", "status": "modified", "additions": 6, "deletions": 1, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/81f435dd37c5ec828b621d37ec15bf41a33ff89a/src%2Flibrustc_parse%2Flexer%2Ftokentrees.rs", "raw_url": "https://github.com/rust-lang/rust/raw/81f435dd37c5ec828b621d37ec15bf41a33ff89a/src%2Flibrustc_parse%2Flexer%2Ftokentrees.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_parse%2Flexer%2Ftokentrees.rs?ref=81f435dd37c5ec828b621d37ec15bf41a33ff89a", "patch": "@@ -40,6 +40,7 @@ struct TokenTreesReader<'a> {\n     /// Used only for error recovery when arriving to EOF with mismatched braces.\n     matching_delim_spans: Vec<(token::DelimToken, Span, Span)>,\n     last_unclosed_found_span: Option<Span>,\n+    /// Collect empty block spans that might have been auto-inserted by editors.\n     last_delim_empty_block_spans: FxHashMap<token::DelimToken, Span>,\n }\n \n@@ -138,7 +139,11 @@ impl<'a> TokenTreesReader<'a> {\n \n                         if tts.is_empty() {\n                             let empty_block_span = open_brace_span.to(close_brace_span);\n-                            self.last_delim_empty_block_spans.insert(delim, empty_block_span);\n+                            if !sm.is_multiline(empty_block_span) {\n+                                // Only track if the block is in the form of `{}`, otherwise it is\n+                                // likely that it was written on purpose.\n+                                self.last_delim_empty_block_spans.insert(delim, empty_block_span);\n+                            }\n                         }\n \n                         if self.open_braces.is_empty() {"}, {"sha": "f1be5dc5ba7fad55b4e5c2a814e65c02ad984cb8", "filename": "src/test/ui/parser/mismatched-delim-brace-empty-block.stderr", "status": "modified", "additions": 2, "deletions": 8, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/81f435dd37c5ec828b621d37ec15bf41a33ff89a/src%2Ftest%2Fui%2Fparser%2Fmismatched-delim-brace-empty-block.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/81f435dd37c5ec828b621d37ec15bf41a33ff89a/src%2Ftest%2Fui%2Fparser%2Fmismatched-delim-brace-empty-block.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fparser%2Fmismatched-delim-brace-empty-block.stderr?ref=81f435dd37c5ec828b621d37ec15bf41a33ff89a", "patch": "@@ -1,14 +1,8 @@\n error: unexpected closing delimiter: `}`\n   --> $DIR/mismatched-delim-brace-empty-block.rs:5:1\n    |\n-LL |   fn main() {\n-   |  ___________-\n-LL | |\n-LL | | }\n-   | |_- this block is empty, you might have not meant to close it\n-LL |       let _ = ();\n-LL |   }\n-   |   ^ unexpected closing delimiter\n+LL | }\n+   | ^ unexpected closing delimiter\n \n error: aborting due to previous error\n "}]}