{"sha": "b76238a3ee5ebffbad8a3aefd36012f3bceb7069", "node_id": "MDY6Q29tbWl0NzI0NzEyOmI3NjIzOGEzZWU1ZWJmZmJhZDhhM2FlZmQzNjAxMmYzYmNlYjcwNjk=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-03-28T08:16:47Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2020-03-28T08:16:47Z"}, "message": "Auto merge of #70095 - jsgf:link-native, r=nagisa\n\nImplement -Zlink-native-libraries\n\nThis implements a flag `-Zlink-native-libraries=yes/no`. If set to true/yes, or unspecified, then\nnative libraries referenced via `#[link]` attributes will be put on the linker line (ie, unchanged\nbehaviour).\n\nIf `-Zlink-native-libraries=no` is specified then rustc will not add the native libraries to the link\nline. The assumption is that the outer build system driving the build already knows about the native\nlibraries and will specify them to the linker directly (for example via `-Clink-arg=`).\n\nAddresses issue #70093", "tree": {"sha": "4a89d67bf0865579c6f29aea7342dac3b1fe1650", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4a89d67bf0865579c6f29aea7342dac3b1fe1650"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/b76238a3ee5ebffbad8a3aefd36012f3bceb7069", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/b76238a3ee5ebffbad8a3aefd36012f3bceb7069", "html_url": "https://github.com/rust-lang/rust/commit/b76238a3ee5ebffbad8a3aefd36012f3bceb7069", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/b76238a3ee5ebffbad8a3aefd36012f3bceb7069/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "2acf32d9adff836a3111c039e4e10a48ee5c79b5", "url": "https://api.github.com/repos/rust-lang/rust/commits/2acf32d9adff836a3111c039e4e10a48ee5c79b5", "html_url": "https://github.com/rust-lang/rust/commit/2acf32d9adff836a3111c039e4e10a48ee5c79b5"}, {"sha": "53c4e0c19ac220085638e856999639fe26cb2a00", "url": "https://api.github.com/repos/rust-lang/rust/commits/53c4e0c19ac220085638e856999639fe26cb2a00", "html_url": "https://github.com/rust-lang/rust/commit/53c4e0c19ac220085638e856999639fe26cb2a00"}], "stats": {"total": 23, "additions": 20, "deletions": 3}, "files": [{"sha": "7169b79c3bc36bcbc02b850589fbf82daf70e45d", "filename": "src/librustc_codegen_ssa/back/link.rs", "status": "modified", "additions": 10, "deletions": 3, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/b76238a3ee5ebffbad8a3aefd36012f3bceb7069/src%2Flibrustc_codegen_ssa%2Fback%2Flink.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b76238a3ee5ebffbad8a3aefd36012f3bceb7069/src%2Flibrustc_codegen_ssa%2Fback%2Flink.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_ssa%2Fback%2Flink.rs?ref=b76238a3ee5ebffbad8a3aefd36012f3bceb7069", "patch": "@@ -1391,10 +1391,17 @@ fn link_args<'a, B: ArchiveBuilder<'a>>(\n     // link line. And finally upstream native libraries can't depend on anything\n     // in this DAG so far because they're only dylibs and dylibs can only depend\n     // on other dylibs (e.g., other native deps).\n-    add_local_native_libraries(cmd, sess, codegen_results);\n+    //\n+    // If -Zlink-native-libraries=false is set, then the assumption is that an\n+    // external build system already has the native dependencies defined, and it\n+    // will provide them to the linker itself.\n+    if sess.opts.debugging_opts.link_native_libraries.unwrap_or(true) {\n+        add_local_native_libraries(cmd, sess, codegen_results);\n+    }\n     add_upstream_rust_crates::<B>(cmd, sess, codegen_results, crate_type, tmpdir);\n-    add_upstream_native_libraries(cmd, sess, codegen_results, crate_type);\n-\n+    if sess.opts.debugging_opts.link_native_libraries.unwrap_or(true) {\n+        add_upstream_native_libraries(cmd, sess, codegen_results, crate_type);\n+    }\n     // Tell the linker what we're doing.\n     if crate_type != config::CrateType::Executable {\n         cmd.build_dylib(out_filename);"}, {"sha": "e43908a79143b5f63464676a2ac34a409d5a6205", "filename": "src/librustc_session/options.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/b76238a3ee5ebffbad8a3aefd36012f3bceb7069/src%2Flibrustc_session%2Foptions.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b76238a3ee5ebffbad8a3aefd36012f3bceb7069/src%2Flibrustc_session%2Foptions.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_session%2Foptions.rs?ref=b76238a3ee5ebffbad8a3aefd36012f3bceb7069", "patch": "@@ -957,4 +957,6 @@ options! {DebuggingOptions, DebuggingSetter, basic_debugging_options,\n         \"link the `.rlink` file generated by `-Z no-link`\"),\n     new_llvm_pass_manager: Option<bool> = (None, parse_opt_bool, [TRACKED],\n         \"use new LLVM pass manager\"),\n+    link_native_libraries: Option<bool> = (None, parse_opt_bool, [UNTRACKED],\n+        \"Link native libraries in the linker invocation.\"),\n }"}, {"sha": "95ab86ebcb1f46f9ff66b3e17b06b76e4b6ff8bf", "filename": "src/test/ui/issues/issue-70093.rs", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/b76238a3ee5ebffbad8a3aefd36012f3bceb7069/src%2Ftest%2Fui%2Fissues%2Fissue-70093.rs", "raw_url": "https://github.com/rust-lang/rust/raw/b76238a3ee5ebffbad8a3aefd36012f3bceb7069/src%2Ftest%2Fui%2Fissues%2Fissue-70093.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissues%2Fissue-70093.rs?ref=b76238a3ee5ebffbad8a3aefd36012f3bceb7069", "patch": "@@ -0,0 +1,8 @@\n+// run-pass\n+// compile-flags: -Zlink-native-libraries=no -Cdefault-linker-libraries=yes\n+// ignore-windows - this will probably only work on unixish systems\n+\n+#[link(name = \"some-random-non-existent-library\", kind = \"static\")]\n+extern \"C\" {}\n+\n+fn main() {}"}]}