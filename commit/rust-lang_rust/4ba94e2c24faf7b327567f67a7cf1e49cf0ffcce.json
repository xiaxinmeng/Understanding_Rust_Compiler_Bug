{"sha": "4ba94e2c24faf7b327567f67a7cf1e49cf0ffcce", "node_id": "MDY6Q29tbWl0NzI0NzEyOjRiYTk0ZTJjMjRmYWY3YjMyNzU2N2Y2N2E3Y2YxZTQ5Y2YwZmZjY2U=", "commit": {"author": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2014-04-16T18:42:22Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2014-04-16T18:42:22Z"}, "message": "rustc: Don't allocate a cnum to syntax crates\n\nSyntax-only crates are no longer registered with the cstore, so there's no need\nto allocate crate numbers to them. This ends up leaving gaps in the crate\nnumbering scheme which is not expected in the rest of the compiler.\n\nCloses #13560", "tree": {"sha": "e2e67a09075f06350018fd7f66b095976e2afd8d", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e2e67a09075f06350018fd7f66b095976e2afd8d"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4ba94e2c24faf7b327567f67a7cf1e49cf0ffcce", "comment_count": 9, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4ba94e2c24faf7b327567f67a7cf1e49cf0ffcce", "html_url": "https://github.com/rust-lang/rust/commit/4ba94e2c24faf7b327567f67a7cf1e49cf0ffcce", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4ba94e2c24faf7b327567f67a7cf1e49cf0ffcce/comments", "author": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "12391df5b78a7a904112c0056aa28773abecb65d", "url": "https://api.github.com/repos/rust-lang/rust/commits/12391df5b78a7a904112c0056aa28773abecb65d", "html_url": "https://github.com/rust-lang/rust/commit/12391df5b78a7a904112c0056aa28773abecb65d"}], "stats": {"total": 83, "additions": 79, "deletions": 4}, "files": [{"sha": "799da4150c5d33606e2851a43513de5bd70f2f84", "filename": "src/librustc/metadata/creader.rs", "status": "modified", "additions": 11, "deletions": 4, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/4ba94e2c24faf7b327567f67a7cf1e49cf0ffcce/src%2Flibrustc%2Fmetadata%2Fcreader.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4ba94e2c24faf7b327567f67a7cf1e49cf0ffcce/src%2Flibrustc%2Fmetadata%2Fcreader.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmetadata%2Fcreader.rs?ref=4ba94e2c24faf7b327567f67a7cf1e49cf0ffcce", "patch": "@@ -300,10 +300,6 @@ fn resolve_crate<'a>(e: &mut Env,\n                 dylib, rlib, metadata\n             } = load_ctxt.load_library_crate(root);\n \n-            // Claim this crate number and cache it\n-            let cnum = e.next_crate_num;\n-            e.next_crate_num += 1;\n-\n             // Stash paths for top-most crate locally if necessary.\n             let crate_paths = if root.is_none() {\n                 Some(CratePaths {\n@@ -324,6 +320,17 @@ fn resolve_crate<'a>(e: &mut Env,\n                 @RefCell::new(HashMap::new())\n             };\n \n+            // Claim this crate number and cache it if we're linking to the\n+            // crate, otherwise it's a syntax-only crate and we don't need to\n+            // reserve a number\n+            let cnum = if should_link {\n+                let n = e.next_crate_num;\n+                e.next_crate_num += 1;\n+                n\n+            } else {\n+                -1\n+            };\n+\n             let cmeta = @cstore::crate_metadata {\n                 name: load_ctxt.crate_id.name.to_owned(),\n                 data: metadata,"}, {"sha": "858d7269cd87400a8d68a46414136fff22323b6f", "filename": "src/test/auxiliary/issue-13560-1.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/4ba94e2c24faf7b327567f67a7cf1e49cf0ffcce/src%2Ftest%2Fauxiliary%2Fissue-13560-1.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4ba94e2c24faf7b327567f67a7cf1e49cf0ffcce/src%2Ftest%2Fauxiliary%2Fissue-13560-1.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fauxiliary%2Fissue-13560-1.rs?ref=4ba94e2c24faf7b327567f67a7cf1e49cf0ffcce", "patch": "@@ -0,0 +1,13 @@\n+// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// no-prefer-dynamic\n+\n+#![crate_type = \"dylib\"]"}, {"sha": "8e46acca1244fbfeea75bb9b612b415ec60ce3e3", "filename": "src/test/auxiliary/issue-13560-2.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/4ba94e2c24faf7b327567f67a7cf1e49cf0ffcce/src%2Ftest%2Fauxiliary%2Fissue-13560-2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4ba94e2c24faf7b327567f67a7cf1e49cf0ffcce/src%2Ftest%2Fauxiliary%2Fissue-13560-2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fauxiliary%2Fissue-13560-2.rs?ref=4ba94e2c24faf7b327567f67a7cf1e49cf0ffcce", "patch": "@@ -0,0 +1,13 @@\n+// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// no-prefer-dynamic\n+\n+#![crate_type = \"rlib\"]"}, {"sha": "3b77b244ce879be5262fff90b7ba3393e7bf6d01", "filename": "src/test/auxiliary/issue-13560-3.rs", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/4ba94e2c24faf7b327567f67a7cf1e49cf0ffcce/src%2Ftest%2Fauxiliary%2Fissue-13560-3.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4ba94e2c24faf7b327567f67a7cf1e49cf0ffcce/src%2Ftest%2Fauxiliary%2Fissue-13560-3.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fauxiliary%2Fissue-13560-3.rs?ref=4ba94e2c24faf7b327567f67a7cf1e49cf0ffcce", "patch": "@@ -0,0 +1,18 @@\n+// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// no-prefer-dynamic\n+\n+#![crate_type = \"rlib\"]\n+#![feature(phase)]\n+\n+#[phase(syntax)] extern crate t1 = \"issue-13560-1\";\n+#[phase(syntax, link)] extern crate t2 = \"issue-13560-2\";\n+"}, {"sha": "24010c7c8b18cec8e241f4ba63904159a2f91d0f", "filename": "src/test/run-pass-fulldeps/issue-13560.rs", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/4ba94e2c24faf7b327567f67a7cf1e49cf0ffcce/src%2Ftest%2Frun-pass-fulldeps%2Fissue-13560.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4ba94e2c24faf7b327567f67a7cf1e49cf0ffcce/src%2Ftest%2Frun-pass-fulldeps%2Fissue-13560.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-pass-fulldeps%2Fissue-13560.rs?ref=4ba94e2c24faf7b327567f67a7cf1e49cf0ffcce", "patch": "@@ -0,0 +1,24 @@\n+// Copyright 2014 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+// aux-build:issue-13560-1.rs\n+// aux-build:issue-13560-2.rs\n+// aux-build:issue-13560-3.rs\n+// ignore-stage1\n+// ignore-android\n+// ignore-cross-compile #12102\n+\n+// Regression test for issue #13560, the test itself is all in the dependent\n+// libraries. The fail which previously failed to compile is the one numbered 3.\n+\n+extern crate t2 = \"issue-13560-2\";\n+extern crate t3 = \"issue-13560-3\";\n+\n+fn main() {}"}]}