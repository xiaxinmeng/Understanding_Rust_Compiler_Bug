{"sha": "a99e97af97f5f86e1892ec2bf633105384ed8bee", "node_id": "C_kwDOAAsO6NoAKGE5OWU5N2FmOTdmNWY4NmUxODkyZWMyYmY2MzMxMDUzODRlZDhiZWU", "commit": {"author": {"name": "Erik Desjardins", "email": "erikdesjardins@users.noreply.github.com", "date": "2022-12-08T06:30:07Z"}, "committer": {"name": "Erik Desjardins", "email": "erikdesjardins@users.noreply.github.com", "date": "2022-12-08T06:30:07Z"}, "message": "Add 0..=isize::MAX range metadata to size loads from vtables", "tree": {"sha": "ffb715af29fe49ab4ce6e92c3c0f0e2c97f72238", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ffb715af29fe49ab4ce6e92c3c0f0e2c97f72238"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/a99e97af97f5f86e1892ec2bf633105384ed8bee", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/a99e97af97f5f86e1892ec2bf633105384ed8bee", "html_url": "https://github.com/rust-lang/rust/commit/a99e97af97f5f86e1892ec2bf633105384ed8bee", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/a99e97af97f5f86e1892ec2bf633105384ed8bee/comments", "author": {"login": "erikdesjardins", "id": 7673145, "node_id": "MDQ6VXNlcjc2NzMxNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/7673145?v=4", "gravatar_id": "", "url": "https://api.github.com/users/erikdesjardins", "html_url": "https://github.com/erikdesjardins", "followers_url": "https://api.github.com/users/erikdesjardins/followers", "following_url": "https://api.github.com/users/erikdesjardins/following{/other_user}", "gists_url": "https://api.github.com/users/erikdesjardins/gists{/gist_id}", "starred_url": "https://api.github.com/users/erikdesjardins/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/erikdesjardins/subscriptions", "organizations_url": "https://api.github.com/users/erikdesjardins/orgs", "repos_url": "https://api.github.com/users/erikdesjardins/repos", "events_url": "https://api.github.com/users/erikdesjardins/events{/privacy}", "received_events_url": "https://api.github.com/users/erikdesjardins/received_events", "type": "User", "site_admin": false}, "committer": {"login": "erikdesjardins", "id": 7673145, "node_id": "MDQ6VXNlcjc2NzMxNDU=", "avatar_url": "https://avatars.githubusercontent.com/u/7673145?v=4", "gravatar_id": "", "url": "https://api.github.com/users/erikdesjardins", "html_url": "https://github.com/erikdesjardins", "followers_url": "https://api.github.com/users/erikdesjardins/followers", "following_url": "https://api.github.com/users/erikdesjardins/following{/other_user}", "gists_url": "https://api.github.com/users/erikdesjardins/gists{/gist_id}", "starred_url": "https://api.github.com/users/erikdesjardins/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/erikdesjardins/subscriptions", "organizations_url": "https://api.github.com/users/erikdesjardins/orgs", "repos_url": "https://api.github.com/users/erikdesjardins/repos", "events_url": "https://api.github.com/users/erikdesjardins/events{/privacy}", "received_events_url": "https://api.github.com/users/erikdesjardins/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "023b5136b597053f76941b54eeae668219e6e18d", "url": "https://api.github.com/repos/rust-lang/rust/commits/023b5136b597053f76941b54eeae668219e6e18d", "html_url": "https://github.com/rust-lang/rust/commit/023b5136b597053f76941b54eeae668219e6e18d"}], "stats": {"total": 82, "additions": 79, "deletions": 3}, "files": [{"sha": "27b8377a9e007b3f548dc424a45f700961aaff4f", "filename": "compiler/rustc_abi/src/lib.rs", "status": "modified", "additions": 12, "deletions": 0, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/a99e97af97f5f86e1892ec2bf633105384ed8bee/compiler%2Frustc_abi%2Fsrc%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a99e97af97f5f86e1892ec2bf633105384ed8bee/compiler%2Frustc_abi%2Fsrc%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_abi%2Fsrc%2Flib.rs?ref=a99e97af97f5f86e1892ec2bf633105384ed8bee", "patch": "@@ -775,6 +775,18 @@ impl Integer {\n         }\n     }\n \n+    /// Returns the largest signed value that can be represented by this Integer.\n+    #[inline]\n+    pub fn signed_max(self) -> i128 {\n+        match self {\n+            I8 => i8::MAX as i128,\n+            I16 => i16::MAX as i128,\n+            I32 => i32::MAX as i128,\n+            I64 => i64::MAX as i128,\n+            I128 => i128::MAX,\n+        }\n+    }\n+\n     /// Finds the smallest Integer type which can represent the signed value.\n     #[inline]\n     pub fn fit_signed(x: i128) -> Integer {"}, {"sha": "0f6e6032f9bffb68a2a7098886643f284cb40ea0", "filename": "compiler/rustc_codegen_ssa/src/glue.rs", "status": "modified", "additions": 3, "deletions": 0, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/a99e97af97f5f86e1892ec2bf633105384ed8bee/compiler%2Frustc_codegen_ssa%2Fsrc%2Fglue.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a99e97af97f5f86e1892ec2bf633105384ed8bee/compiler%2Frustc_codegen_ssa%2Fsrc%2Fglue.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fglue.rs?ref=a99e97af97f5f86e1892ec2bf633105384ed8bee", "patch": "@@ -29,6 +29,9 @@ pub fn size_and_align_of_dst<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>>(\n             let align = meth::VirtualIndex::from_index(ty::COMMON_VTABLE_ENTRIES_ALIGN)\n                 .get_usize(bx, vtable);\n \n+            // Size is always <= isize::MAX.\n+            let size_bound = bx.data_layout().ptr_sized_integer().signed_max() as u128;\n+            bx.range_metadata(size, WrappingRange { start: 0, end: size_bound });\n             // Alignment is always nonzero.\n             bx.range_metadata(align, WrappingRange { start: 1, end: !0 });\n "}, {"sha": "a75609260eda49f874c909be5583d6693d98c148", "filename": "compiler/rustc_codegen_ssa/src/mir/intrinsic.rs", "status": "modified", "additions": 9, "deletions": 3, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/a99e97af97f5f86e1892ec2bf633105384ed8bee/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Fintrinsic.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a99e97af97f5f86e1892ec2bf633105384ed8bee/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Fintrinsic.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_codegen_ssa%2Fsrc%2Fmir%2Fintrinsic.rs?ref=a99e97af97f5f86e1892ec2bf633105384ed8bee", "patch": "@@ -110,10 +110,16 @@ impl<'a, 'tcx, Bx: BuilderMethods<'a, 'tcx>> FunctionCx<'a, 'tcx, Bx> {\n                     _ => bug!(),\n                 };\n                 let value = meth::VirtualIndex::from_index(idx).get_usize(bx, vtable);\n-                if name == sym::vtable_align {\n+                match name {\n+                    // Size is always <= isize::MAX.\n+                    sym::vtable_size => {\n+                        let size_bound = bx.data_layout().ptr_sized_integer().signed_max() as u128;\n+                        bx.range_metadata(value, WrappingRange { start: 0, end: size_bound });\n+                    },\n                     // Alignment is always nonzero.\n-                    bx.range_metadata(value, WrappingRange { start: 1, end: !0 });\n-                };\n+                    sym::vtable_align => bx.range_metadata(value, WrappingRange { start: 1, end: !0 }),\n+                    _ => {}\n+                }\n                 value\n             }\n             sym::pref_align_of"}, {"sha": "7ebb4173d5632ddb30539082b60fc7491c0e87b1", "filename": "src/test/codegen/dst-vtable-align-nonzero.rs", "status": "modified", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/a99e97af97f5f86e1892ec2bf633105384ed8bee/src%2Ftest%2Fcodegen%2Fdst-vtable-align-nonzero.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a99e97af97f5f86e1892ec2bf633105384ed8bee/src%2Ftest%2Fcodegen%2Fdst-vtable-align-nonzero.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fdst-vtable-align-nonzero.rs?ref=a99e97af97f5f86e1892ec2bf633105384ed8bee", "patch": "@@ -1,6 +1,7 @@\n // compile-flags: -O\n \n #![crate_type = \"lib\"]\n+#![feature(core_intrinsics)]\n \n // This test checks that we annotate alignment loads from vtables with nonzero range metadata,\n // and that this allows LLVM to eliminate redundant `align >= 1` checks.\n@@ -42,4 +43,21 @@ pub fn does_not_eliminate_runtime_check_when_align_2(\n     &x.dst\n }\n \n+// CHECK-LABEL: @align_load_from_align_of_val\n+#[no_mangle]\n+pub fn align_load_from_align_of_val(x: &dyn Trait) -> usize {\n+    // CHECK: {{%[0-9]+}} = load [[USIZE]], {{.+}} !range [[RANGE_META]]\n+    core::mem::align_of_val(x)\n+}\n+\n+// CHECK-LABEL: @align_load_from_vtable_align_intrinsic\n+#[no_mangle]\n+pub unsafe fn align_load_from_vtable_align_intrinsic(x: &dyn Trait) -> usize {\n+    let (data, vtable): (*const (), *const ()) = core::mem::transmute(x);\n+    // CHECK: {{%[0-9]+}} = load [[USIZE]], {{.+}} !range [[RANGE_META]]\n+    let align = core::intrinsics::vtable_align(vtable);\n+    // make this function unique so it doesn't get merged with the previous\n+    align + 1\n+}\n+\n // CHECK: [[RANGE_META]] = !{[[USIZE]] 1, [[USIZE]] 0}"}, {"sha": "cec5876b3483e3a52888190d55a1603fd24e2f69", "filename": "src/test/codegen/dst-vtable-size-range.rs", "status": "added", "additions": 37, "deletions": 0, "changes": 37, "blob_url": "https://github.com/rust-lang/rust/blob/a99e97af97f5f86e1892ec2bf633105384ed8bee/src%2Ftest%2Fcodegen%2Fdst-vtable-size-range.rs", "raw_url": "https://github.com/rust-lang/rust/raw/a99e97af97f5f86e1892ec2bf633105384ed8bee/src%2Ftest%2Fcodegen%2Fdst-vtable-size-range.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fdst-vtable-size-range.rs?ref=a99e97af97f5f86e1892ec2bf633105384ed8bee", "patch": "@@ -0,0 +1,37 @@\n+// compile-flags: -O\n+\n+#![crate_type = \"lib\"]\n+#![feature(core_intrinsics)]\n+\n+// Check that we annotate size loads from vtables with 0..(isize::MAX + 1) range metadata.\n+\n+pub trait Trait {\n+    fn f(&self);\n+}\n+\n+// Note that rustc uses inclusive bounds, but LLVM uses exclusive bounds for range metadata.\n+// CHECK-LABEL: @generate_exclusive_bound\n+#[no_mangle]\n+pub fn generate_exclusive_bound() -> usize {\n+    // CHECK: ret [[USIZE:i[0-9]+]] [[EXCLUSIVE_BOUND:[-0-9]+]]\n+    isize::MAX as usize + 1\n+}\n+\n+// CHECK-LABEL: @size_load_from_size_of_val\n+#[no_mangle]\n+pub fn size_load_from_size_of_val(x: &dyn Trait) -> usize {\n+    // CHECK: {{%[0-9]+}} = load [[USIZE]], {{.+}} !range [[RANGE_META:![0-9]+]]\n+    core::mem::size_of_val(x)\n+}\n+\n+// CHECK-LABEL: @size_load_from_vtable_size_intrinsic\n+#[no_mangle]\n+pub unsafe fn size_load_from_vtable_size_intrinsic(x: &dyn Trait) -> usize {\n+    let (data, vtable): (*const (), *const ()) = core::mem::transmute(x);\n+    // CHECK: {{%[0-9]+}} = load [[USIZE]], {{.+}} !range [[RANGE_META]]\n+    let size = core::intrinsics::vtable_size(vtable);\n+    // make this function unique so it doesn't get merged with the previous\n+    size + 1\n+}\n+\n+// CHECK: [[RANGE_META]] = !{[[USIZE]] 0, [[USIZE]] [[EXCLUSIVE_BOUND]]}"}]}