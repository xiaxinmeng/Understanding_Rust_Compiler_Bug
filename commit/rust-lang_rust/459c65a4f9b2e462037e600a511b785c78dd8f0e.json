{"sha": "459c65a4f9b2e462037e600a511b785c78dd8f0e", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQ1OWM2NWE0ZjliMmU0NjIwMzdlNjAwYTUxMWI3ODVjNzhkZDhmMGU=", "commit": {"author": {"name": "Christian Poveda", "email": "christianpoveda@protonmail.com", "date": "2019-10-07T13:38:54Z"}, "committer": {"name": "Christian Poveda", "email": "christianpoveda@protonmail.com", "date": "2019-10-08T13:18:51Z"}, "message": "Add method to consume io::Error", "tree": {"sha": "1b570c40160765215d8490ac80a5c3c034ee5075", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/1b570c40160765215d8490ac80a5c3c034ee5075"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/459c65a4f9b2e462037e600a511b785c78dd8f0e", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/459c65a4f9b2e462037e600a511b785c78dd8f0e", "html_url": "https://github.com/rust-lang/rust/commit/459c65a4f9b2e462037e600a511b785c78dd8f0e", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/459c65a4f9b2e462037e600a511b785c78dd8f0e/comments", "author": {"login": "pvdrz", "id": 31802960, "node_id": "MDQ6VXNlcjMxODAyOTYw", "avatar_url": "https://avatars.githubusercontent.com/u/31802960?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pvdrz", "html_url": "https://github.com/pvdrz", "followers_url": "https://api.github.com/users/pvdrz/followers", "following_url": "https://api.github.com/users/pvdrz/following{/other_user}", "gists_url": "https://api.github.com/users/pvdrz/gists{/gist_id}", "starred_url": "https://api.github.com/users/pvdrz/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pvdrz/subscriptions", "organizations_url": "https://api.github.com/users/pvdrz/orgs", "repos_url": "https://api.github.com/users/pvdrz/repos", "events_url": "https://api.github.com/users/pvdrz/events{/privacy}", "received_events_url": "https://api.github.com/users/pvdrz/received_events", "type": "User", "site_admin": false}, "committer": {"login": "pvdrz", "id": 31802960, "node_id": "MDQ6VXNlcjMxODAyOTYw", "avatar_url": "https://avatars.githubusercontent.com/u/31802960?v=4", "gravatar_id": "", "url": "https://api.github.com/users/pvdrz", "html_url": "https://github.com/pvdrz", "followers_url": "https://api.github.com/users/pvdrz/followers", "following_url": "https://api.github.com/users/pvdrz/following{/other_user}", "gists_url": "https://api.github.com/users/pvdrz/gists{/gist_id}", "starred_url": "https://api.github.com/users/pvdrz/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/pvdrz/subscriptions", "organizations_url": "https://api.github.com/users/pvdrz/orgs", "repos_url": "https://api.github.com/users/pvdrz/repos", "events_url": "https://api.github.com/users/pvdrz/events{/privacy}", "received_events_url": "https://api.github.com/users/pvdrz/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "887d7481148101615fc1966864a14276350dbf65", "url": "https://api.github.com/repos/rust-lang/rust/commits/887d7481148101615fc1966864a14276350dbf65", "html_url": "https://github.com/rust-lang/rust/commit/887d7481148101615fc1966864a14276350dbf65"}], "stats": {"total": 26, "additions": 12, "deletions": 14}, "files": [{"sha": "f4b6a7c4dbac74427bbeffcd72c84b468e825e61", "filename": "src/shims/env.rs", "status": "modified", "additions": 3, "deletions": 9, "changes": 12, "blob_url": "https://github.com/rust-lang/rust/blob/459c65a4f9b2e462037e600a511b785c78dd8f0e/src%2Fshims%2Fenv.rs", "raw_url": "https://github.com/rust-lang/rust/raw/459c65a4f9b2e462037e600a511b785c78dd8f0e/src%2Fshims%2Fenv.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fshims%2Fenv.rs?ref=459c65a4f9b2e462037e600a511b785c78dd8f0e", "patch": "@@ -137,7 +137,7 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n                 if (bytes.len() as u64) < size {\n                     // We add a `/0` terminator\n                     bytes.push(0);\n-                    // This is ok because the buffer is larger than the path with terminatorhe null terminator.\n+                    // This is ok because the buffer is larger than the path with the null terminator.\n                     this.memory_mut()\n                         .get_mut(buf.alloc_id)?\n                         .write_bytes(tcx, buf, &bytes)?;\n@@ -146,10 +146,7 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n                 let erange = this.eval_libc(\"ERANGE\")?;\n                 this.set_last_error(erange)?;\n             }\n-            Err(e) => this.set_last_error(Scalar::from_int(\n-                e.raw_os_error().unwrap(),\n-                Size::from_bits(32),\n-            ))?,\n+            Err(e) => this.consume_io_error(e)?,\n         }\n         Ok(Scalar::ptr_null(&*this.tcx))\n     }\n@@ -173,10 +170,7 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n         match env::set_current_dir(path) {\n             Ok(()) => Ok(0),\n             Err(e) => {\n-                this.set_last_error(Scalar::from_int(\n-                    e.raw_os_error().unwrap(),\n-                    Size::from_bits(32),\n-                ))?;\n+                this.consume_io_error(e)?;\n                 Ok(-1)\n             }\n         }"}, {"sha": "3298eef85353c78c1abbf58bbfb71c94d43f2b00", "filename": "src/shims/foreign_items.rs", "status": "modified", "additions": 8, "deletions": 1, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/459c65a4f9b2e462037e600a511b785c78dd8f0e/src%2Fshims%2Fforeign_items.rs", "raw_url": "https://github.com/rust-lang/rust/raw/459c65a4f9b2e462037e600a511b785c78dd8f0e/src%2Fshims%2Fforeign_items.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fshims%2Fforeign_items.rs?ref=459c65a4f9b2e462037e600a511b785c78dd8f0e", "patch": "@@ -987,7 +987,7 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n         self.eval_libc(name).and_then(|scalar| scalar.to_i32())\n     }\n \n-    fn set_last_error(&mut self, scalar: Scalar<Tag>) -> InterpResult<'tcx, ()> {\n+    fn set_last_error(&mut self, scalar: Scalar<Tag>) -> InterpResult<'tcx> {\n         let this = self.eval_context_mut();\n         let tcx = &{ this.tcx.tcx };\n         let errno_ptr = this.machine.last_error.unwrap();\n@@ -1008,6 +1008,13 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n             .read_scalar(tcx, errno_ptr, Size::from_bits(32))?\n             .not_undef()\n     }\n+\n+    fn consume_io_error(&mut self, e: std::io::Error) -> InterpResult<'tcx> {\n+        self.eval_context_mut().set_last_error(Scalar::from_int(\n+            e.raw_os_error().unwrap(),\n+            Size::from_bits(32),\n+        ))\n+    }\n }\n \n // Shims the linux 'getrandom()' syscall."}, {"sha": "ca3f500f5a47ff54c1b79ea3d4417710e2edcaa2", "filename": "src/shims/io.rs", "status": "modified", "additions": 1, "deletions": 4, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/459c65a4f9b2e462037e600a511b785c78dd8f0e/src%2Fshims%2Fio.rs", "raw_url": "https://github.com/rust-lang/rust/raw/459c65a4f9b2e462037e600a511b785c78dd8f0e/src%2Fshims%2Fio.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fshims%2Fio.rs?ref=459c65a4f9b2e462037e600a511b785c78dd8f0e", "patch": "@@ -264,10 +264,7 @@ pub trait EvalContextExt<'mir, 'tcx: 'mir>: crate::MiriEvalContextExt<'mir, 'tcx\n         match result {\n             Ok(ok) => Ok(ok),\n             Err(e) => {\n-                self.eval_context_mut().set_last_error(Scalar::from_int(\n-                    e.raw_os_error().unwrap(),\n-                    Size::from_bits(32),\n-                ))?;\n+                self.eval_context_mut().consume_io_error(e)?;\n                 Ok((-1).into())\n             }\n         }"}]}