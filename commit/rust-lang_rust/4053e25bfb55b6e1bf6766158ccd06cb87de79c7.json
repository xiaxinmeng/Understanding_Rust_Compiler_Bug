{"sha": "4053e25bfb55b6e1bf6766158ccd06cb87de79c7", "node_id": "MDY6Q29tbWl0NzI0NzEyOjQwNTNlMjViZmI1NWI2ZTFiZjY3NjYxNThjY2QwNmNiODdkZTc5Yzc=", "commit": {"author": {"name": "Emilio Cobos \u00c1lvarez", "email": "emilio@crisal.io", "date": "2018-03-13T11:40:57Z"}, "committer": {"name": "Emilio Cobos \u00c1lvarez", "email": "emilio@crisal.io", "date": "2018-03-25T01:30:06Z"}, "message": "librustc_trans: Mark some profiler symbols as exported to avoid LTO removing them.", "tree": {"sha": "218b59d4fef7ed864002469a42395adc5e5a21db", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/218b59d4fef7ed864002469a42395adc5e5a21db"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/4053e25bfb55b6e1bf6766158ccd06cb87de79c7", "comment_count": 0, "verification": {"verified": false, "reason": "unknown_key", "signature": "-----BEGIN PGP SIGNATURE-----\n\niQEzBAABCAAdFiEE+uMrE+H37zcdV8pyBWtye7nBAnwFAlq2+54ACgkQBWtye7nB\nAnydZAf+JSh2dwkGIGxPn+sxACuc6oImrxRP1Y86BAmuM04XuFaLPjOEy10xNd7i\nWNW37G5baob8uUeKDjYf47YcIo1z5vJImgsax92ydTLOo+es+H6MtI8wcHiQqV3x\nvKgFZ3gP5ATM7xx/QOMCfiEYh5A5P9dlgRLribwm8vnj++XOL5oZT4ApfwU4JBS4\nKf3EMBCtQwCMtihLJ8/0xfaEx6vZv2xFVf8Ge5BfsiufMvaYGysimMIcrCBKyBEf\nMxvMD09tBS82cw0PajWgzaQJ2E+qLyKXwF76DjVa5//GDML4zVecVyYwEsmBceMd\n1226FRwcEwopWwd6FZdEzgBBcS08EQ==\n=qdBR\n-----END PGP SIGNATURE-----", "payload": "tree 218b59d4fef7ed864002469a42395adc5e5a21db\nparent 8a4cebd16f4fa3ba2234c6d4453051b568c6d904\nauthor Emilio Cobos \u00c1lvarez <emilio@crisal.io> 1520941257 +0100\ncommitter Emilio Cobos \u00c1lvarez <emilio@crisal.io> 1521941406 +0200\n\nlibrustc_trans: Mark some profiler symbols as exported to avoid LTO removing them.\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/4053e25bfb55b6e1bf6766158ccd06cb87de79c7", "html_url": "https://github.com/rust-lang/rust/commit/4053e25bfb55b6e1bf6766158ccd06cb87de79c7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/4053e25bfb55b6e1bf6766158ccd06cb87de79c7/comments", "author": {"login": "emilio", "id": 1323194, "node_id": "MDQ6VXNlcjEzMjMxOTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1323194?v=4", "gravatar_id": "", "url": "https://api.github.com/users/emilio", "html_url": "https://github.com/emilio", "followers_url": "https://api.github.com/users/emilio/followers", "following_url": "https://api.github.com/users/emilio/following{/other_user}", "gists_url": "https://api.github.com/users/emilio/gists{/gist_id}", "starred_url": "https://api.github.com/users/emilio/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/emilio/subscriptions", "organizations_url": "https://api.github.com/users/emilio/orgs", "repos_url": "https://api.github.com/users/emilio/repos", "events_url": "https://api.github.com/users/emilio/events{/privacy}", "received_events_url": "https://api.github.com/users/emilio/received_events", "type": "User", "site_admin": false}, "committer": {"login": "emilio", "id": 1323194, "node_id": "MDQ6VXNlcjEzMjMxOTQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1323194?v=4", "gravatar_id": "", "url": "https://api.github.com/users/emilio", "html_url": "https://github.com/emilio", "followers_url": "https://api.github.com/users/emilio/followers", "following_url": "https://api.github.com/users/emilio/following{/other_user}", "gists_url": "https://api.github.com/users/emilio/gists{/gist_id}", "starred_url": "https://api.github.com/users/emilio/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/emilio/subscriptions", "organizations_url": "https://api.github.com/users/emilio/orgs", "repos_url": "https://api.github.com/users/emilio/repos", "events_url": "https://api.github.com/users/emilio/events{/privacy}", "received_events_url": "https://api.github.com/users/emilio/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8a4cebd16f4fa3ba2234c6d4453051b568c6d904", "url": "https://api.github.com/repos/rust-lang/rust/commits/8a4cebd16f4fa3ba2234c6d4453051b568c6d904", "html_url": "https://github.com/rust-lang/rust/commit/8a4cebd16f4fa3ba2234c6d4453051b568c6d904"}], "stats": {"total": 33, "additions": 33, "deletions": 0}, "files": [{"sha": "d205e6ca4eda6ed5b78e5afd8cfeeab40af71b07", "filename": "src/librustc_trans/back/symbol_export.rs", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/4053e25bfb55b6e1bf6766158ccd06cb87de79c7/src%2Flibrustc_trans%2Fback%2Fsymbol_export.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4053e25bfb55b6e1bf6766158ccd06cb87de79c7/src%2Flibrustc_trans%2Fback%2Fsymbol_export.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_trans%2Fback%2Fsymbol_export.rs?ref=4053e25bfb55b6e1bf6766158ccd06cb87de79c7", "patch": "@@ -223,6 +223,20 @@ fn exported_symbols_provider_local<'a, 'tcx>(tcx: TyCtxt<'a, 'tcx, 'tcx>,\n         }\n     }\n \n+    if tcx.sess.opts.debugging_opts.pgo_gen.is_some() {\n+        // These are weak symbols that point to the profile version and the\n+        // profile name, which need to be treated as exported so LTO doesn't nix\n+        // them.\n+        const PROFILER_WEAK_SYMBOLS: [&'static str; 2] = [\n+            \"__llvm_profile_raw_version\",\n+            \"__llvm_profile_filename\",\n+        ];\n+        for sym in &PROFILER_WEAK_SYMBOLS {\n+            let exported_symbol = ExportedSymbol::NoDefId(SymbolName::new(sym));\n+            symbols.push((exported_symbol, SymbolExportLevel::C));\n+        }\n+    }\n+\n     if tcx.sess.crate_types.borrow().contains(&config::CrateTypeDylib) {\n         let symbol_name = metadata_symbol_name(tcx);\n         let exported_symbol = ExportedSymbol::NoDefId(SymbolName::new(&symbol_name));"}, {"sha": "5de2c707f3579b7a09f0c454c9d7f2fa8c9f5820", "filename": "src/test/run-make/pgo-gen-lto/Makefile", "status": "added", "additions": 8, "deletions": 0, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/4053e25bfb55b6e1bf6766158ccd06cb87de79c7/src%2Ftest%2Frun-make%2Fpgo-gen-lto%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/4053e25bfb55b6e1bf6766158ccd06cb87de79c7/src%2Ftest%2Frun-make%2Fpgo-gen-lto%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fpgo-gen-lto%2FMakefile?ref=4053e25bfb55b6e1bf6766158ccd06cb87de79c7", "patch": "@@ -0,0 +1,8 @@\n+-include ../tools.mk\n+\n+all:\n+ifeq ($(PROFILER_SUPPORT),1)\n+\t$(RUSTC) -Copt-level=3 -Clto=fat -Z pgo-gen=test.profraw test.rs\n+\t$(call RUN,test) || exit 1\n+\t[ -e \"$(TMPDIR)/test.profraw\" ] || (echo \"No .profraw file\"; exit 1)\n+endif"}, {"sha": "3f07b46791d22753d7a5492210b1d50c99c07cc7", "filename": "src/test/run-make/pgo-gen-lto/test.rs", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/4053e25bfb55b6e1bf6766158ccd06cb87de79c7/src%2Ftest%2Frun-make%2Fpgo-gen-lto%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/4053e25bfb55b6e1bf6766158ccd06cb87de79c7/src%2Ftest%2Frun-make%2Fpgo-gen-lto%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fpgo-gen-lto%2Ftest.rs?ref=4053e25bfb55b6e1bf6766158ccd06cb87de79c7", "patch": "@@ -0,0 +1,11 @@\n+// Copyright 2018 The Rust Project Developers. See the COPYRIGHT\n+// file at the top-level directory of this distribution and at\n+// http://rust-lang.org/COPYRIGHT.\n+//\n+// Licensed under the Apache License, Version 2.0 <LICENSE-APACHE or\n+// http://www.apache.org/licenses/LICENSE-2.0> or the MIT license\n+// <LICENSE-MIT or http://opensource.org/licenses/MIT>, at your\n+// option. This file may not be copied, modified, or distributed\n+// except according to those terms.\n+\n+fn main() {}"}]}