{"sha": "90b296d770d98cc5311fa2642b66d5e9a8503aff", "node_id": "C_kwDOAAsO6NoAKDkwYjI5NmQ3NzBkOThjYzUzMTFmYTI2NDJiNjZkNWU5YTg1MDNhZmY", "commit": {"author": {"name": "Dylan DPC", "email": "99973273+Dylan-DPC@users.noreply.github.com", "date": "2022-07-01T14:49:18Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-07-01T14:49:18Z"}, "message": "Rollup merge of #98644 - matthiaskrgr:drp_loc_span_err__2021_inc_clos_cap, r=lcnr\n\nfix ICE with -Wrust-2021-incompatible-closure-captures\n\nFixes #93117\nFixes #96258", "tree": {"sha": "517338628eb0e439cd3243c9d04275aa29ae9c14", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/517338628eb0e439cd3243c9d04275aa29ae9c14"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/90b296d770d98cc5311fa2642b66d5e9a8503aff", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJivwlvCRBK7hj4Ov3rIwAAw+gIAFMlJrpELrrgW8tSwt0CYBhv\nYNe4gd+h4ifdiZgIaZcA60K3U3LpKTz74ll23YED1OXYk/+ZxtSD3fn8p6F4k/BY\nhbSoNWvgHeiSskgptgepUJ8DWeEKY/ZmL1I5m57lIlSATAka1MJzz152iIZUTYVJ\nHr7l/3ZTeQYxUcdvSqzHJrcgtuanUxbusjf+oJqlCcKeRTy4kClgCoeCO/RO6OjR\nmNvf4jEjbzwpRwgRdbt7P/lQuJZBscrAiu9VPoqQ9UrA/4lQ+yPAURPYQrYDx8wO\n3mcuQwrehRsgyTtCricjDToh4TuKvWjAc7a0e5YbbKB60w2yYgQ774jDdt1CHbY=\n=0pXA\n-----END PGP SIGNATURE-----\n", "payload": "tree 517338628eb0e439cd3243c9d04275aa29ae9c14\nparent 9dd328855736e1c69f3df696e6084bbb6749d0cf\nparent 7dc04899651140002926d41116091e61509554d1\nauthor Dylan DPC <99973273+Dylan-DPC@users.noreply.github.com> 1656686958 +0530\ncommitter GitHub <noreply@github.com> 1656686958 +0530\n\nRollup merge of #98644 - matthiaskrgr:drp_loc_span_err__2021_inc_clos_cap, r=lcnr\n\nfix ICE with -Wrust-2021-incompatible-closure-captures\n\nFixes #93117\nFixes #96258\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/90b296d770d98cc5311fa2642b66d5e9a8503aff", "html_url": "https://github.com/rust-lang/rust/commit/90b296d770d98cc5311fa2642b66d5e9a8503aff", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/90b296d770d98cc5311fa2642b66d5e9a8503aff/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "9dd328855736e1c69f3df696e6084bbb6749d0cf", "url": "https://api.github.com/repos/rust-lang/rust/commits/9dd328855736e1c69f3df696e6084bbb6749d0cf", "html_url": "https://github.com/rust-lang/rust/commit/9dd328855736e1c69f3df696e6084bbb6749d0cf"}, {"sha": "7dc04899651140002926d41116091e61509554d1", "url": "https://api.github.com/repos/rust-lang/rust/commits/7dc04899651140002926d41116091e61509554d1", "html_url": "https://github.com/rust-lang/rust/commit/7dc04899651140002926d41116091e61509554d1"}], "stats": {"total": 156, "additions": 154, "deletions": 2}, "files": [{"sha": "87f85a9842f341909b32e35cef3e7306a5b1d9b8", "filename": "compiler/rustc_typeck/src/check/upvar.rs", "status": "modified", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/90b296d770d98cc5311fa2642b66d5e9a8503aff/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fupvar.rs", "raw_url": "https://github.com/rust-lang/rust/raw/90b296d770d98cc5311fa2642b66d5e9a8503aff/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fupvar.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_typeck%2Fsrc%2Fcheck%2Fupvar.rs?ref=90b296d770d98cc5311fa2642b66d5e9a8503aff", "patch": "@@ -1707,12 +1707,14 @@ fn drop_location_span<'tcx>(tcx: TyCtxt<'tcx>, hir_id: hir::HirId) -> Span {\n         hir::Node::Item(item) => match item.kind {\n             hir::ItemKind::Fn(_, _, owner_id) => tcx.hir().span(owner_id.hir_id),\n             _ => {\n-                bug!(\"Drop location span error: need to handle more ItemKind {:?}\", item.kind);\n+                bug!(\"Drop location span error: need to handle more ItemKind '{:?}'\", item.kind);\n             }\n         },\n         hir::Node::Block(block) => tcx.hir().span(block.hir_id),\n+        hir::Node::TraitItem(item) => tcx.hir().span(item.hir_id()),\n+        hir::Node::ImplItem(item) => tcx.hir().span(item.hir_id()),\n         _ => {\n-            bug!(\"Drop location span error: need to handle more Node {:?}\", owner_node);\n+            bug!(\"Drop location span error: need to handle more Node '{:?}'\", owner_node);\n         }\n     };\n     tcx.sess.source_map().end_point(owner_span)"}, {"sha": "b280c8ab6e2b270e61fc77ec2204d56975ce4a32", "filename": "src/test/ui/span/drop-location-span-error-rust-2021-incompatible-closure-captures-93117.rs", "status": "added", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/90b296d770d98cc5311fa2642b66d5e9a8503aff/src%2Ftest%2Fui%2Fspan%2Fdrop-location-span-error-rust-2021-incompatible-closure-captures-93117.rs", "raw_url": "https://github.com/rust-lang/rust/raw/90b296d770d98cc5311fa2642b66d5e9a8503aff/src%2Ftest%2Fui%2Fspan%2Fdrop-location-span-error-rust-2021-incompatible-closure-captures-93117.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fspan%2Fdrop-location-span-error-rust-2021-incompatible-closure-captures-93117.rs?ref=90b296d770d98cc5311fa2642b66d5e9a8503aff", "patch": "@@ -0,0 +1,18 @@\n+// compile-flags: -Wrust-2021-incompatible-closure-captures\n+\n+pub struct A {}\n+\n+impl A {\n+    async fn create(path: impl AsRef<std::path::Path>)  { //~ ERROR  `async fn` is not permitted in Rust 2015\n+    //~^ WARN changes to closure capture in Rust 2021 will affect drop order [rust_2021_incompatible_closure_captures]\n+    ;\n+    crate(move || {} ).await //~ ERROR expected function, found module `crate`\n+    }\n+}\n+\n+trait C{async fn new(val: T) {} //~ ERROR  `async fn` is not permitted in Rust 2015\n+//~^ ERROR functions in traits cannot be declared `async`\n+//~^^ ERROR cannot find type `T` in this scope\n+//~^^^ WARN changes to closure capture in Rust 2021 will affect drop order [rust_2021_incompatible_closure_captures]\n+\n+//~ ERROR  this file contains an unclosed delimiter"}, {"sha": "50de2322907edb3a3e2ca20133d2cd7426112174", "filename": "src/test/ui/span/drop-location-span-error-rust-2021-incompatible-closure-captures-93117.stderr", "status": "added", "additions": 93, "deletions": 0, "changes": 93, "blob_url": "https://github.com/rust-lang/rust/blob/90b296d770d98cc5311fa2642b66d5e9a8503aff/src%2Ftest%2Fui%2Fspan%2Fdrop-location-span-error-rust-2021-incompatible-closure-captures-93117.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/90b296d770d98cc5311fa2642b66d5e9a8503aff/src%2Ftest%2Fui%2Fspan%2Fdrop-location-span-error-rust-2021-incompatible-closure-captures-93117.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fspan%2Fdrop-location-span-error-rust-2021-incompatible-closure-captures-93117.stderr?ref=90b296d770d98cc5311fa2642b66d5e9a8503aff", "patch": "@@ -0,0 +1,93 @@\n+error: this file contains an unclosed delimiter\n+  --> $DIR/drop-location-span-error-rust-2021-incompatible-closure-captures-93117.rs:18:53\n+   |\n+LL | trait C{async fn new(val: T) {}\n+   |        - unclosed delimiter\n+...\n+LL |\n+   |                                                     ^\n+\n+error[E0670]: `async fn` is not permitted in Rust 2015\n+  --> $DIR/drop-location-span-error-rust-2021-incompatible-closure-captures-93117.rs:6:5\n+   |\n+LL |     async fn create(path: impl AsRef<std::path::Path>)  {\n+   |     ^^^^^ to use `async fn`, switch to Rust 2018 or later\n+   |\n+   = help: pass `--edition 2021` to `rustc`\n+   = note: for more on editions, read https://doc.rust-lang.org/edition-guide\n+\n+error[E0670]: `async fn` is not permitted in Rust 2015\n+  --> $DIR/drop-location-span-error-rust-2021-incompatible-closure-captures-93117.rs:13:9\n+   |\n+LL | trait C{async fn new(val: T) {}\n+   |         ^^^^^ to use `async fn`, switch to Rust 2018 or later\n+   |\n+   = help: pass `--edition 2021` to `rustc`\n+   = note: for more on editions, read https://doc.rust-lang.org/edition-guide\n+\n+error[E0706]: functions in traits cannot be declared `async`\n+  --> $DIR/drop-location-span-error-rust-2021-incompatible-closure-captures-93117.rs:13:9\n+   |\n+LL | trait C{async fn new(val: T) {}\n+   |         -----^^^^^^^^^^^^^^^^^^\n+   |         |\n+   |         `async` because of this\n+   |\n+   = note: `async` trait functions are not currently supported\n+   = note: consider using the `async-trait` crate: https://crates.io/crates/async-trait\n+\n+error[E0423]: expected function, found module `crate`\n+  --> $DIR/drop-location-span-error-rust-2021-incompatible-closure-captures-93117.rs:9:5\n+   |\n+LL |     crate(move || {} ).await\n+   |     ^^^^^ not a function\n+\n+error[E0412]: cannot find type `T` in this scope\n+  --> $DIR/drop-location-span-error-rust-2021-incompatible-closure-captures-93117.rs:13:27\n+   |\n+LL | pub struct A {}\n+   | ------------ similarly named struct `A` defined here\n+...\n+LL | trait C{async fn new(val: T) {}\n+   |                           ^ help: a struct with a similar name exists: `A`\n+\n+warning: changes to closure capture in Rust 2021 will affect drop order\n+  --> $DIR/drop-location-span-error-rust-2021-incompatible-closure-captures-93117.rs:6:57\n+   |\n+LL |       async fn create(path: impl AsRef<std::path::Path>)  {\n+   |  _____________________----_____________________________-__^\n+   | |                     |                                |\n+   | |                     |                                in Rust 2018, `path` is dropped here along with the closure, but in Rust 2021 `path` is not part of the closure\n+   | |                     in Rust 2018, this causes the closure to capture `path`, but in Rust 2021, it has no effect\n+LL | |\n+LL | |     ;\n+LL | |     crate(move || {} ).await\n+LL | |     }\n+   | |_____^\n+   |\n+   = note: requested on the command line with `-W rust-2021-incompatible-closure-captures`\n+   = note: for more information, see <https://doc.rust-lang.org/nightly/edition-guide/rust-2021/disjoint-capture-in-closures.html>\n+help: add a dummy let to cause `path` to be fully captured\n+   |\n+LL |     async fn create(path: impl AsRef<std::path::Path>)  { let _ = &path;\n+   |                                                           ++++++++++++++\n+\n+warning: changes to closure capture in Rust 2021 will affect drop order\n+  --> $DIR/drop-location-span-error-rust-2021-incompatible-closure-captures-93117.rs:13:30\n+   |\n+LL | trait C{async fn new(val: T) {}\n+   |                      ---   - ^^\n+   |                      |     |\n+   |                      |     in Rust 2018, `val` is dropped here along with the closure, but in Rust 2021 `val` is not part of the closure\n+   |                      in Rust 2018, this causes the closure to capture `val`, but in Rust 2021, it has no effect\n+   |\n+   = note: for more information, see <https://doc.rust-lang.org/nightly/edition-guide/rust-2021/disjoint-capture-in-closures.html>\n+help: add a dummy let to cause `val` to be fully captured\n+   |\n+LL | trait C{async fn new(val: T) { let _ = &val;}\n+   |                                +++++++++++++\n+\n+error: aborting due to 6 previous errors; 2 warnings emitted\n+\n+Some errors have detailed explanations: E0412, E0423, E0670, E0706.\n+For more information about an error, try `rustc --explain E0412`."}, {"sha": "a776e5089075c889e024259d832588ae270280c5", "filename": "src/test/ui/span/drop-location-span-error-rust-2021-incompatible-closure-captures-96258.rs", "status": "added", "additions": 15, "deletions": 0, "changes": 15, "blob_url": "https://github.com/rust-lang/rust/blob/90b296d770d98cc5311fa2642b66d5e9a8503aff/src%2Ftest%2Fui%2Fspan%2Fdrop-location-span-error-rust-2021-incompatible-closure-captures-96258.rs", "raw_url": "https://github.com/rust-lang/rust/raw/90b296d770d98cc5311fa2642b66d5e9a8503aff/src%2Ftest%2Fui%2Fspan%2Fdrop-location-span-error-rust-2021-incompatible-closure-captures-96258.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fspan%2Fdrop-location-span-error-rust-2021-incompatible-closure-captures-96258.rs?ref=90b296d770d98cc5311fa2642b66d5e9a8503aff", "patch": "@@ -0,0 +1,15 @@\n+// compile-flags -Wrust-2021-incompatible-closure-captures\n+\n+fn main() {}\n+\n+pub(crate) struct Numberer {}\n+\n+impl Numberer {\n+    pub(crate) async fn new(\n+    //~^ ERROR `async fn` is not permitted in Rust 2015\n+        interval: Duration,\n+        //~^ ERROR cannot find type `Duration` in this scope\n+    ) -> Numberer {\n+        Numberer {}\n+    }\n+}"}, {"sha": "37b2f4138603dba0e47f6aab91ef3da0e5b6269c", "filename": "src/test/ui/span/drop-location-span-error-rust-2021-incompatible-closure-captures-96258.stderr", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/90b296d770d98cc5311fa2642b66d5e9a8503aff/src%2Ftest%2Fui%2Fspan%2Fdrop-location-span-error-rust-2021-incompatible-closure-captures-96258.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/90b296d770d98cc5311fa2642b66d5e9a8503aff/src%2Ftest%2Fui%2Fspan%2Fdrop-location-span-error-rust-2021-incompatible-closure-captures-96258.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fspan%2Fdrop-location-span-error-rust-2021-incompatible-closure-captures-96258.stderr?ref=90b296d770d98cc5311fa2642b66d5e9a8503aff", "patch": "@@ -0,0 +1,24 @@\n+error[E0670]: `async fn` is not permitted in Rust 2015\n+  --> $DIR/drop-location-span-error-rust-2021-incompatible-closure-captures-96258.rs:8:16\n+   |\n+LL |     pub(crate) async fn new(\n+   |                ^^^^^ to use `async fn`, switch to Rust 2018 or later\n+   |\n+   = help: pass `--edition 2021` to `rustc`\n+   = note: for more on editions, read https://doc.rust-lang.org/edition-guide\n+\n+error[E0412]: cannot find type `Duration` in this scope\n+  --> $DIR/drop-location-span-error-rust-2021-incompatible-closure-captures-96258.rs:10:19\n+   |\n+LL |         interval: Duration,\n+   |                   ^^^^^^^^ not found in this scope\n+   |\n+help: consider importing this struct\n+   |\n+LL | use std::time::Duration;\n+   |\n+\n+error: aborting due to 2 previous errors\n+\n+Some errors have detailed explanations: E0412, E0670.\n+For more information about an error, try `rustc --explain E0412`."}]}