{"sha": "7125df06c3b420c1774bf83006529562ebba7a7b", "node_id": "C_kwDOAAsO6NoAKDcxMjVkZjA2YzNiNDIwYzE3NzRiZjgzMDA2NTI5NTYyZWJiYTdhN2I", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2023-03-05T19:57:22Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2023-03-05T19:57:22Z"}, "message": "Rollup merge of #108773 - jyn514:faster-tidy-fmt, r=albertlarsan68\n\nx fmt: Only check modified files locally\n\nPreviously, `x fmt` would only format modified files, while `x fmt .` and `x fmt --check` would still look at all files. After this change, `x fmt --check` only looks at modified files locally.\n\nI feel pretty confident in this change - other than https://github.com/rust-lang/rust/issues/106261, no one has reported bugs in `get_modified_rs_files` since it was added in https://github.com/rust-lang/rust/pull/105702.\n\nCombined with the changes in https://github.com/rust-lang/rust/pull/108772, this brings the time for me to run `x t tidy` with a hot FS cache down from 5 to 2 seconds (and moves the majority of the time spent back to `tidy check`, which means it can be sped up more in the future).", "tree": {"sha": "61abb46eadcab63052243038c4fbd62cbb46cf58", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/61abb46eadcab63052243038c4fbd62cbb46cf58"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7125df06c3b420c1774bf83006529562ebba7a7b", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJkBPQiCRBK7hj4Ov3rIwAAWGUIAE0rEh9hqmbmR5fdGYQ/l4Dn\nuSZ9dw4NuKMNu0V2H7WyoOH6qOm9DqnLWaJ4lGaE83wcYagcLbu0jkUdTBNgcFJi\noD6oNDX7XqKiVF31Qv8p3dRkYUXhyCIzzixEx7e846GToPDKOofKhXG/hauYPip+\nOTATCF3gV0O1Jxbm7HvbdDOPOz89OqMWkzefLr8sPwr7H9sAx62AIpXOdZRoOBsw\nEfUjeXqHTQ2gWCEfa6uSa8GCj1q05Qr2t85R2JC3vqXVsD+jNZnTEUy4aVcvwncS\nGHLnngc99tTe9p67/Sqc4SVNOWxXteIhacETfDGCklrXr3SKGTeFqDQApB+x5Ik=\n=xcO4\n-----END PGP SIGNATURE-----\n", "payload": "tree 61abb46eadcab63052243038c4fbd62cbb46cf58\nparent 970f263156dc5b080e895899977171500bb982ae\nparent 620efed932766b4cd516a26205fe47f51f54f911\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1678046242 +0100\ncommitter GitHub <noreply@github.com> 1678046242 +0100\n\nRollup merge of #108773 - jyn514:faster-tidy-fmt, r=albertlarsan68\n\nx fmt: Only check modified files locally\n\nPreviously, `x fmt` would only format modified files, while `x fmt .` and `x fmt --check` would still look at all files. After this change, `x fmt --check` only looks at modified files locally.\n\nI feel pretty confident in this change - other than https://github.com/rust-lang/rust/issues/106261, no one has reported bugs in `get_modified_rs_files` since it was added in https://github.com/rust-lang/rust/pull/105702.\n\nCombined with the changes in https://github.com/rust-lang/rust/pull/108772, this brings the time for me to run `x t tidy` with a hot FS cache down from 5 to 2 seconds (and moves the majority of the time spent back to `tidy check`, which means it can be sped up more in the future).\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7125df06c3b420c1774bf83006529562ebba7a7b", "html_url": "https://github.com/rust-lang/rust/commit/7125df06c3b420c1774bf83006529562ebba7a7b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7125df06c3b420c1774bf83006529562ebba7a7b/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "970f263156dc5b080e895899977171500bb982ae", "url": "https://api.github.com/repos/rust-lang/rust/commits/970f263156dc5b080e895899977171500bb982ae", "html_url": "https://github.com/rust-lang/rust/commit/970f263156dc5b080e895899977171500bb982ae"}, {"sha": "620efed932766b4cd516a26205fe47f51f54f911", "url": "https://api.github.com/repos/rust-lang/rust/commits/620efed932766b4cd516a26205fe47f51f54f911", "html_url": "https://github.com/rust-lang/rust/commit/620efed932766b4cd516a26205fe47f51f54f911"}], "stats": {"total": 6, "additions": 5, "deletions": 1}, "files": [{"sha": "3637251256283439e95afc70de16303f895427e9", "filename": "src/bootstrap/format.rs", "status": "modified", "additions": 5, "deletions": 1, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/7125df06c3b420c1774bf83006529562ebba7a7b/src%2Fbootstrap%2Fformat.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7125df06c3b420c1774bf83006529562ebba7a7b/src%2Fbootstrap%2Fformat.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fbootstrap%2Fformat.rs?ref=7125df06c3b420c1774bf83006529562ebba7a7b", "patch": "@@ -2,6 +2,7 @@\n \n use crate::builder::Builder;\n use crate::util::{output, program_out_of_date, t};\n+use build_helper::ci::CiEnv;\n use build_helper::git::get_git_modified_files;\n use ignore::WalkBuilder;\n use std::collections::VecDeque;\n@@ -156,7 +157,10 @@ pub fn format(build: &Builder<'_>, check: bool, paths: &[PathBuf]) {\n                 // preventing the latter from being formatted.\n                 ignore_fmt.add(&format!(\"!/{}\", untracked_path)).expect(&untracked_path);\n             }\n-            if !check && paths.is_empty() {\n+            // Only check modified files locally to speed up runtime.\n+            // We still check all files in CI to avoid bugs in `get_modified_rs_files` letting regressions slip through;\n+            // we also care about CI time less since this is still very fast compared to building the compiler.\n+            if !CiEnv::is_ci() && paths.is_empty() {\n                 match get_modified_rs_files(build) {\n                     Ok(Some(files)) => {\n                         for file in files {"}]}