{"sha": "c927743b7b7bd382836dcce2d1140a7e829dc3d0", "node_id": "C_kwDOAAsO6NoAKGM5Mjc3NDNiN2I3YmQzODI4MzZkY2NlMmQxMTQwYTdlODI5ZGMzZDA", "commit": {"author": {"name": "bohan", "email": "bohan-zhang@foxmail.com", "date": "2023-06-06T15:11:08Z"}, "committer": {"name": "bohan", "email": "bohan-zhang@foxmail.com", "date": "2023-06-06T15:11:08Z"}, "message": "fix(expand): prevent infinity loop in macro containing only \"///\"", "tree": {"sha": "c23fed95e63c567f62b5a5551aba4102e0647e41", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/c23fed95e63c567f62b5a5551aba4102e0647e41"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/c927743b7b7bd382836dcce2d1140a7e829dc3d0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/c927743b7b7bd382836dcce2d1140a7e829dc3d0", "html_url": "https://github.com/rust-lang/rust/commit/c927743b7b7bd382836dcce2d1140a7e829dc3d0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/c927743b7b7bd382836dcce2d1140a7e829dc3d0/comments", "author": {"login": "bvanjoi", "id": 30187863, "node_id": "MDQ6VXNlcjMwMTg3ODYz", "avatar_url": "https://avatars.githubusercontent.com/u/30187863?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bvanjoi", "html_url": "https://github.com/bvanjoi", "followers_url": "https://api.github.com/users/bvanjoi/followers", "following_url": "https://api.github.com/users/bvanjoi/following{/other_user}", "gists_url": "https://api.github.com/users/bvanjoi/gists{/gist_id}", "starred_url": "https://api.github.com/users/bvanjoi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bvanjoi/subscriptions", "organizations_url": "https://api.github.com/users/bvanjoi/orgs", "repos_url": "https://api.github.com/users/bvanjoi/repos", "events_url": "https://api.github.com/users/bvanjoi/events{/privacy}", "received_events_url": "https://api.github.com/users/bvanjoi/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bvanjoi", "id": 30187863, "node_id": "MDQ6VXNlcjMwMTg3ODYz", "avatar_url": "https://avatars.githubusercontent.com/u/30187863?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bvanjoi", "html_url": "https://github.com/bvanjoi", "followers_url": "https://api.github.com/users/bvanjoi/followers", "following_url": "https://api.github.com/users/bvanjoi/following{/other_user}", "gists_url": "https://api.github.com/users/bvanjoi/gists{/gist_id}", "starred_url": "https://api.github.com/users/bvanjoi/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bvanjoi/subscriptions", "organizations_url": "https://api.github.com/users/bvanjoi/orgs", "repos_url": "https://api.github.com/users/bvanjoi/repos", "events_url": "https://api.github.com/users/bvanjoi/events{/privacy}", "received_events_url": "https://api.github.com/users/bvanjoi/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "fd9bf594366e73efb1a26a023e0b4de8eff82b94", "url": "https://api.github.com/repos/rust-lang/rust/commits/fd9bf594366e73efb1a26a023e0b4de8eff82b94", "html_url": "https://github.com/rust-lang/rust/commit/fd9bf594366e73efb1a26a023e0b4de8eff82b94"}], "stats": {"total": 95, "additions": 95, "deletions": 0}, "files": [{"sha": "f0e67cfd50e0818199127fc6c688860bc1214a4b", "filename": "compiler/rustc_expand/src/mbe/macro_parser.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/c927743b7b7bd382836dcce2d1140a7e829dc3d0/compiler%2Frustc_expand%2Fsrc%2Fmbe%2Fmacro_parser.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c927743b7b7bd382836dcce2d1140a7e829dc3d0/compiler%2Frustc_expand%2Fsrc%2Fmbe%2Fmacro_parser.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_expand%2Fsrc%2Fmbe%2Fmacro_parser.rs?ref=c927743b7b7bd382836dcce2d1140a7e829dc3d0", "patch": "@@ -249,6 +249,7 @@ pub(super) fn compute_locs(matcher: &[TokenTree]) -> Vec<MatcherLoc> {\n }\n \n /// A single matcher position, representing the state of matching.\n+#[derive(Debug)]\n struct MatcherPos {\n     /// The index into `TtParser::locs`, which represents the \"dot\".\n     idx: usize,"}, {"sha": "576d636d489c20c826b70413f4ba789c2407c2fa", "filename": "compiler/rustc_expand/src/mbe/macro_rules.rs", "status": "modified", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/c927743b7b7bd382836dcce2d1140a7e829dc3d0/compiler%2Frustc_expand%2Fsrc%2Fmbe%2Fmacro_rules.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c927743b7b7bd382836dcce2d1140a7e829dc3d0/compiler%2Frustc_expand%2Fsrc%2Fmbe%2Fmacro_rules.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_expand%2Fsrc%2Fmbe%2Fmacro_rules.rs?ref=c927743b7b7bd382836dcce2d1140a7e829dc3d0", "patch": "@@ -647,6 +647,7 @@ fn check_lhs_no_empty_seq(sess: &ParseSess, tts: &[mbe::TokenTree]) -> bool {\n                 if seq.separator.is_none()\n                     && seq.tts.iter().all(|seq_tt| match seq_tt {\n                         TokenTree::MetaVarDecl(_, _, Some(NonterminalKind::Vis)) => true,\n+                        TokenTree::Token(t) => matches!(t, Token { kind: DocComment(..), .. }),\n                         TokenTree::Sequence(_, sub_seq) => {\n                             sub_seq.kleene.op == mbe::KleeneOp::ZeroOrMore\n                                 || sub_seq.kleene.op == mbe::KleeneOp::ZeroOrOne"}, {"sha": "14fe9bbd97a24f6b5568a54383a2c6d100432f60", "filename": "tests/ui/macros/issue-112342-1.rs", "status": "added", "additions": 36, "deletions": 0, "changes": 36, "blob_url": "https://github.com/rust-lang/rust/blob/c927743b7b7bd382836dcce2d1140a7e829dc3d0/tests%2Fui%2Fmacros%2Fissue-112342-1.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c927743b7b7bd382836dcce2d1140a7e829dc3d0/tests%2Fui%2Fmacros%2Fissue-112342-1.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmacros%2Fissue-112342-1.rs?ref=c927743b7b7bd382836dcce2d1140a7e829dc3d0", "patch": "@@ -0,0 +1,36 @@\n+// same as #95267, ignore doc comment although it's a bug.\n+\n+macro_rules! m1 {\n+    (\n+        $(\n+            ///\n+        )*\n+        //~^^^ERROR repetition matches empty token tree\n+    ) => {};\n+}\n+\n+m1! {}\n+\n+macro_rules! m2 {\n+    (\n+        $(\n+            ///\n+        )+\n+        //~^^^ERROR repetition matches empty token tree\n+    ) => {};\n+}\n+\n+m2! {}\n+\n+macro_rules! m3 {\n+    (\n+        $(\n+            ///\n+        )?\n+        //~^^^ERROR repetition matches empty token tree\n+    ) => {};\n+}\n+\n+m3! {}\n+\n+fn main() {}"}, {"sha": "1ba7c0ffd3bd109dbfdadc2220944585353e7b6a", "filename": "tests/ui/macros/issue-112342-1.stderr", "status": "added", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/c927743b7b7bd382836dcce2d1140a7e829dc3d0/tests%2Fui%2Fmacros%2Fissue-112342-1.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/c927743b7b7bd382836dcce2d1140a7e829dc3d0/tests%2Fui%2Fmacros%2Fissue-112342-1.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmacros%2Fissue-112342-1.stderr?ref=c927743b7b7bd382836dcce2d1140a7e829dc3d0", "patch": "@@ -0,0 +1,29 @@\n+error: repetition matches empty token tree\n+  --> $DIR/issue-112342-1.rs:5:10\n+   |\n+LL |           $(\n+   |  __________^\n+LL | |             ///\n+LL | |         )*\n+   | |_________^\n+\n+error: repetition matches empty token tree\n+  --> $DIR/issue-112342-1.rs:16:10\n+   |\n+LL |           $(\n+   |  __________^\n+LL | |             ///\n+LL | |         )+\n+   | |_________^\n+\n+error: repetition matches empty token tree\n+  --> $DIR/issue-112342-1.rs:27:10\n+   |\n+LL |           $(\n+   |  __________^\n+LL | |             ///\n+LL | |         )?\n+   | |_________^\n+\n+error: aborting due to 3 previous errors\n+"}, {"sha": "1e1d953fa5269775d32b1000128b9bfa6af9c92e", "filename": "tests/ui/macros/issue-112342-2.rs", "status": "added", "additions": 28, "deletions": 0, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/c927743b7b7bd382836dcce2d1140a7e829dc3d0/tests%2Fui%2Fmacros%2Fissue-112342-2.rs", "raw_url": "https://github.com/rust-lang/rust/raw/c927743b7b7bd382836dcce2d1140a7e829dc3d0/tests%2Fui%2Fmacros%2Fissue-112342-2.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fui%2Fmacros%2Fissue-112342-2.rs?ref=c927743b7b7bd382836dcce2d1140a7e829dc3d0", "patch": "@@ -0,0 +1,28 @@\n+// check-pass\n+\n+// same as #95267, ignore doc comment although it's a bug.\n+\n+macro_rules! m1 {\n+    (\n+        $(\n+            ///\n+            $expr: expr,\n+        )*\n+    ) => {};\n+}\n+\n+m1! {}\n+\n+macro_rules! m2 {\n+    (\n+        $(\n+            ///\n+            $expr: expr,\n+            ///\n+        )*\n+    ) => {};\n+}\n+\n+m2! {}\n+\n+fn main() {}"}]}