{"sha": "6746ba58398cb17f45c8bfdc403f78d8bdaad5fc", "node_id": "C_kwDOAAsO6NoAKDY3NDZiYTU4Mzk4Y2IxN2Y0NWM4YmZkYzQwM2Y3OGQ4YmRhYWQ1ZmM", "commit": {"author": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2022-01-08T09:45:12Z"}, "committer": {"name": "Lukas Wirth", "email": "lukastw97@gmail.com", "date": "2022-01-08T09:45:12Z"}, "message": "Record attribute calls on assoc items in TraitData and ImplData", "tree": {"sha": "e01c2fa19b33773784948edeb19b750e3341d20e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e01c2fa19b33773784948edeb19b750e3341d20e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6746ba58398cb17f45c8bfdc403f78d8bdaad5fc", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6746ba58398cb17f45c8bfdc403f78d8bdaad5fc", "html_url": "https://github.com/rust-lang/rust/commit/6746ba58398cb17f45c8bfdc403f78d8bdaad5fc", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6746ba58398cb17f45c8bfdc403f78d8bdaad5fc/comments", "author": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "committer": {"login": "Veykril", "id": 3757771, "node_id": "MDQ6VXNlcjM3NTc3NzE=", "avatar_url": "https://avatars.githubusercontent.com/u/3757771?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Veykril", "html_url": "https://github.com/Veykril", "followers_url": "https://api.github.com/users/Veykril/followers", "following_url": "https://api.github.com/users/Veykril/following{/other_user}", "gists_url": "https://api.github.com/users/Veykril/gists{/gist_id}", "starred_url": "https://api.github.com/users/Veykril/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Veykril/subscriptions", "organizations_url": "https://api.github.com/users/Veykril/orgs", "repos_url": "https://api.github.com/users/Veykril/repos", "events_url": "https://api.github.com/users/Veykril/events{/privacy}", "received_events_url": "https://api.github.com/users/Veykril/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "6cf0cadfaad0eb1dfdaebb4d3676438fbb644c1b", "url": "https://api.github.com/repos/rust-lang/rust/commits/6cf0cadfaad0eb1dfdaebb4d3676438fbb644c1b", "html_url": "https://github.com/rust-lang/rust/commit/6cf0cadfaad0eb1dfdaebb4d3676438fbb644c1b"}], "stats": {"total": 106, "additions": 79, "deletions": 27}, "files": [{"sha": "c0e8d0e082a31b743a8de5ae2cd58c6f72e0e236", "filename": "crates/hir/src/semantics/source_to_def.rs", "status": "modified", "additions": 1, "deletions": 2, "changes": 3, "blob_url": "https://github.com/rust-lang/rust/blob/6746ba58398cb17f45c8bfdc403f78d8bdaad5fc/crates%2Fhir%2Fsrc%2Fsemantics%2Fsource_to_def.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6746ba58398cb17f45c8bfdc403f78d8bdaad5fc/crates%2Fhir%2Fsrc%2Fsemantics%2Fsource_to_def.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir%2Fsrc%2Fsemantics%2Fsource_to_def.rs?ref=6746ba58398cb17f45c8bfdc403f78d8bdaad5fc", "patch": "@@ -316,8 +316,7 @@ impl SourceToDefCtx<'_, '_> {\n     }\n \n     pub(super) fn macro_to_def(&mut self, src: InFile<ast::Macro>) -> Option<MacroDefId> {\n-        let makro =\n-            self.dyn_map(src.as_ref()).and_then(|it| it[keys::MACRO_CALL].get(&src).copied());\n+        let makro = self.dyn_map(src.as_ref()).and_then(|it| it[keys::MACRO].get(&src).copied());\n         if let res @ Some(_) = makro {\n             return res;\n         }"}, {"sha": "545ae41edf5ddd19dbe0db4e889073e9f2a3d615", "filename": "crates/hir_def/src/child_by_source.rs", "status": "modified", "additions": 18, "deletions": 7, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/6746ba58398cb17f45c8bfdc403f78d8bdaad5fc/crates%2Fhir_def%2Fsrc%2Fchild_by_source.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6746ba58398cb17f45c8bfdc403f78d8bdaad5fc/crates%2Fhir_def%2Fsrc%2Fchild_by_source.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fchild_by_source.rs?ref=6746ba58398cb17f45c8bfdc403f78d8bdaad5fc", "patch": "@@ -30,20 +30,31 @@ pub trait ChildBySource {\n impl ChildBySource for TraitId {\n     fn child_by_source_to(&self, db: &dyn DefDatabase, res: &mut DynMap, file_id: HirFileId) {\n         let data = db.trait_data(*self);\n-        // FIXME attribute macros\n-        for &(_, item) in data.items.iter() {\n+\n+        data.attribute_calls().filter(|(ast_id, _)| ast_id.file_id == file_id).for_each(\n+            |(ast_id, call_id)| {\n+                let item = ast_id.with_value(ast_id.to_node(db.upcast()));\n+                res[keys::ATTR_MACRO_CALL].insert(item, call_id);\n+            },\n+        );\n+        data.items.iter().for_each(|&(_, item)| {\n             child_by_source_assoc_items(db, res, file_id, item);\n-        }\n+        });\n     }\n }\n \n impl ChildBySource for ImplId {\n     fn child_by_source_to(&self, db: &dyn DefDatabase, res: &mut DynMap, file_id: HirFileId) {\n         let data = db.impl_data(*self);\n-        // FIXME attribute macros\n-        for &item in data.items.iter() {\n+        data.attribute_calls().filter(|(ast_id, _)| ast_id.file_id == file_id).for_each(\n+            |(ast_id, call_id)| {\n+                let item = ast_id.with_value(ast_id.to_node(db.upcast()));\n+                res[keys::ATTR_MACRO_CALL].insert(item, call_id);\n+            },\n+        );\n+        data.items.iter().for_each(|&item| {\n             child_by_source_assoc_items(db, res, file_id, item);\n-        }\n+        });\n     }\n }\n \n@@ -97,7 +108,7 @@ impl ChildBySource for ItemScope {\n                     // FIXME: Do we need to add proc-macros into a PROCMACRO dynmap here?\n                     Either::Right(_fn) => return,\n                 };\n-                res[keys::MACRO_CALL].insert(src, makro);\n+                res[keys::MACRO].insert(src, makro);\n             }\n         });\n         self.unnamed_consts().for_each(|konst| {"}, {"sha": "f08be39128a31874d1ada3bd11da5108b99a7857", "filename": "crates/hir_def/src/data.rs", "status": "modified", "additions": 38, "deletions": 17, "changes": 55, "blob_url": "https://github.com/rust-lang/rust/blob/6746ba58398cb17f45c8bfdc403f78d8bdaad5fc/crates%2Fhir_def%2Fsrc%2Fdata.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6746ba58398cb17f45c8bfdc403f78d8bdaad5fc/crates%2Fhir_def%2Fsrc%2Fdata.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fdata.rs?ref=6746ba58398cb17f45c8bfdc403f78d8bdaad5fc", "patch": "@@ -2,7 +2,7 @@\n \n use std::sync::Arc;\n \n-use hir_expand::{name::Name, AstId, ExpandResult, InFile};\n+use hir_expand::{name::Name, AstId, ExpandResult, InFile, MacroCallId};\n use syntax::ast;\n \n use crate::{\n@@ -184,6 +184,7 @@ pub struct TraitData {\n     /// method calls to this trait's methods when the receiver is an array and the crate edition is\n     /// 2015 or 2018.\n     pub skip_array_during_method_dispatch: bool,\n+    pub attribute_calls: Option<Box<Vec<(AstId<ast::Item>, MacroCallId)>>>,\n }\n \n impl TraitData {\n@@ -207,7 +208,7 @@ impl TraitData {\n             .by_key(\"rustc_skip_array_during_method_dispatch\")\n             .exists();\n \n-        let items = collect_items(\n+        let (attribute_calls, items) = collect_items(\n             db,\n             module_id,\n             &mut expander,\n@@ -216,6 +217,8 @@ impl TraitData {\n             container,\n             100,\n         );\n+        let attribute_calls =\n+            if attribute_calls.is_empty() { None } else { Some(Box::new(attribute_calls)) };\n \n         Arc::new(TraitData {\n             name,\n@@ -224,6 +227,7 @@ impl TraitData {\n             is_unsafe,\n             visibility,\n             skip_array_during_method_dispatch,\n+            attribute_calls,\n         })\n     }\n \n@@ -247,6 +251,10 @@ impl TraitData {\n             _ => None,\n         })\n     }\n+\n+    pub fn attribute_calls(&self) -> impl Iterator<Item = (AstId<ast::Item>, MacroCallId)> + '_ {\n+        self.attribute_calls.iter().flat_map(|it| it.iter()).copied()\n+    }\n }\n \n #[derive(Debug, Clone, PartialEq, Eq)]\n@@ -255,6 +263,7 @@ pub struct ImplData {\n     pub self_ty: Interned<TypeRef>,\n     pub items: Vec<AssocItemId>,\n     pub is_negative: bool,\n+    pub attribute_calls: Option<Box<Vec<(AstId<ast::Item>, MacroCallId)>>>,\n }\n \n impl ImplData {\n@@ -271,7 +280,7 @@ impl ImplData {\n         let container = ItemContainerId::ImplId(id);\n         let mut expander = Expander::new(db, impl_loc.id.file_id(), module_id);\n \n-        let items = collect_items(\n+        let (attribute_calls, items) = collect_items(\n             db,\n             module_id,\n             &mut expander,\n@@ -281,8 +290,14 @@ impl ImplData {\n             100,\n         );\n         let items = items.into_iter().map(|(_, item)| item).collect();\n+        let attribute_calls =\n+            if attribute_calls.is_empty() { None } else { Some(Box::new(attribute_calls)) };\n+\n+        Arc::new(ImplData { target_trait, self_ty, items, is_negative, attribute_calls })\n+    }\n \n-        Arc::new(ImplData { target_trait, self_ty, items, is_negative })\n+    pub fn attribute_calls(&self) -> impl Iterator<Item = (AstId<ast::Item>, MacroCallId)> + '_ {\n+        self.attribute_calls.iter().flat_map(|it| it.iter()).copied()\n     }\n }\n \n@@ -341,9 +356,9 @@ fn collect_items(\n     tree_id: item_tree::TreeId,\n     container: ItemContainerId,\n     limit: usize,\n-) -> Vec<(Name, AssocItemId)> {\n+) -> (Vec<(AstId<ast::Item>, MacroCallId)>, Vec<(Name, AssocItemId)>) {\n     if limit == 0 {\n-        return Vec::new();\n+        return Default::default();\n     }\n \n     let item_tree = tree_id.item_tree(db);\n@@ -352,22 +367,25 @@ fn collect_items(\n     let def_map = module.def_map(db);\n \n     let mut items = Vec::new();\n+    let mut attribute_calls = Vec::new();\n+\n     'items: for item in assoc_items {\n         let attrs = item_tree.attrs(db, module.krate, ModItem::from(item).into());\n         if !attrs.is_cfg_enabled(cfg_options) {\n             continue;\n         }\n-\n         for attr in &*attrs {\n-            let ast_id = AstIdWithPath {\n-                path: (*attr.path).clone(),\n-                ast_id: AstId::new(expander.current_file_id(), item.ast_id(&item_tree).upcast()),\n-            };\n+            let ast_id = AstId::new(expander.current_file_id(), item.ast_id(&item_tree).upcast());\n+            let ast_id_with_path = AstIdWithPath { path: (*attr.path).clone(), ast_id };\n             if let Ok(ResolvedAttr::Macro(call_id)) =\n-                def_map.resolve_attr_macro(db, module.local_id, ast_id, attr)\n+                def_map.resolve_attr_macro(db, module.local_id, ast_id_with_path, attr)\n             {\n+                attribute_calls.push((ast_id, call_id));\n                 let res = expander.enter_expand_id(db, call_id);\n-                items.extend(collect_macro_items(db, module, expander, container, limit, res));\n+                let (mac_attrs, mac_items) =\n+                    collect_macro_items(db, module, expander, container, limit, res);\n+                items.extend(mac_items);\n+                attribute_calls.extend(mac_attrs);\n                 continue 'items;\n             }\n         }\n@@ -401,13 +419,16 @@ fn collect_items(\n                 let res = expander.enter_expand(db, call);\n \n                 if let Ok(res) = res {\n-                    items.extend(collect_macro_items(db, module, expander, container, limit, res));\n+                    let (mac_attrs, mac_items) =\n+                        collect_macro_items(db, module, expander, container, limit, res);\n+                    items.extend(mac_items);\n+                    attribute_calls.extend(mac_attrs);\n                 }\n             }\n         }\n     }\n \n-    items\n+    (attribute_calls, items)\n }\n \n fn collect_macro_items(\n@@ -417,7 +438,7 @@ fn collect_macro_items(\n     container: ItemContainerId,\n     limit: usize,\n     res: ExpandResult<Option<(Mark, ast::MacroItems)>>,\n-) -> Vec<(Name, AssocItemId)> {\n+) -> (Vec<(AstId<ast::Item>, MacroCallId)>, Vec<(Name, AssocItemId)>) {\n     if let Some((mark, mac)) = res.value {\n         let src: InFile<ast::MacroItems> = expander.to_source(mac);\n         let tree_id = item_tree::TreeId::new(src.file_id, None);\n@@ -430,5 +451,5 @@ fn collect_macro_items(\n         return items;\n     }\n \n-    Vec::new()\n+    Default::default()\n }"}, {"sha": "eaa08a365a111d8d4b922a67c1054f64432e610a", "filename": "crates/hir_def/src/keys.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/6746ba58398cb17f45c8bfdc403f78d8bdaad5fc/crates%2Fhir_def%2Fsrc%2Fkeys.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6746ba58398cb17f45c8bfdc403f78d8bdaad5fc/crates%2Fhir_def%2Fsrc%2Fkeys.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fhir_def%2Fsrc%2Fkeys.rs?ref=6746ba58398cb17f45c8bfdc403f78d8bdaad5fc", "patch": "@@ -32,7 +32,7 @@ pub const TYPE_PARAM: Key<ast::TypeParam, TypeParamId> = Key::new();\n pub const LIFETIME_PARAM: Key<ast::LifetimeParam, LifetimeParamId> = Key::new();\n pub const CONST_PARAM: Key<ast::ConstParam, ConstParamId> = Key::new();\n \n-pub const MACRO_CALL: Key<ast::Macro, MacroDefId> = Key::new();\n+pub const MACRO: Key<ast::Macro, MacroDefId> = Key::new();\n pub const ATTR_MACRO_CALL: Key<ast::Item, MacroCallId> = Key::new();\n pub const DERIVE_MACRO_CALL: Key<ast::Attr, (AttrId, Box<[Option<MacroCallId>]>)> = Key::new();\n "}, {"sha": "5e6f0ef6a57d54517855c43714d9b6981ff851e0", "filename": "crates/ide/src/references.rs", "status": "modified", "additions": 21, "deletions": 0, "changes": 21, "blob_url": "https://github.com/rust-lang/rust/blob/6746ba58398cb17f45c8bfdc403f78d8bdaad5fc/crates%2Fide%2Fsrc%2Freferences.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6746ba58398cb17f45c8bfdc403f78d8bdaad5fc/crates%2Fide%2Fsrc%2Freferences.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fide%2Fsrc%2Freferences.rs?ref=6746ba58398cb17f45c8bfdc403f78d8bdaad5fc", "patch": "@@ -1514,4 +1514,25 @@ fn func$0() {\n             \"#]],\n         )\n     }\n+\n+    #[test]\n+    fn attr_assoc_item() {\n+        check(\n+            r#\"\n+//- proc_macros: identity\n+\n+trait Trait {\n+    #[proc_macros::identity]\n+    fn func() {\n+        Self::func$0();\n+    }\n+}\n+\"#,\n+            expect![[r#\"\n+                func Function FileId(0) 48..87 51..55\n+\n+                FileId(0) 74..78\n+            \"#]],\n+        )\n+    }\n }"}]}