{"sha": "d63bb8565e129f51fadf6a036683b1eedefb78dd", "node_id": "MDY6Q29tbWl0NzI0NzEyOmQ2M2JiODU2NWUxMjlmNTFmYWRmNmEwMzY2ODNiMWVlZGVmYjc4ZGQ=", "commit": {"author": {"name": "bors[bot]", "email": "26634292+bors[bot]@users.noreply.github.com", "date": "2020-03-31T12:45:39Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-03-31T12:45:39Z"}, "message": "Merge #3781\n\n3781: Add crate versions when running cargo -p commands. r=matklad a=o0Ignition0o\n\nIf someone (unfortunately) creates a project that happens to have the same name as one of its (future) dependencies, there is [a way for them to change the dependency's alias in the Cargo.toml file](https://doc.rust-lang.org/cargo/reference/specifying-dependencies.html#renaming-dependencies-in-cargotoml), to mitigate the name conflict. Unfortunately cargo -p commands don't seem to pick it up, which seems to put rust-analyzer run commands in a tough situation: \r\n\r\n```\r\n> Executing task: cargo test --package config --example default -- tests --nocapture <\r\n\r\nerror: There are multiple `config` packages in your project, and the specification `config` is ambiguous.\r\nPlease re-run this command with `-p <spec>` where `<spec>` is one of the following:\r\n  config:0.1.0\r\n  config:0.9.3\r\nThe terminal process terminated with exit code: 101\r\n```\r\n\r\ncargo suggests us to be more specific and refer to a package by its name and version, which this PR achieves.\r\n\r\nI passed the version as a String because I don't really understand how the ra_db types work, but I would love to switch it to [a fully fledged Version type](https://steveklabnik.github.io/semver/semver/index.html) if you guide me towards that :)\r\n\r\n\n\nCo-authored-by: o0Ignition0o <jeremy.lempereur@gmail.com>", "tree": {"sha": "85194d956ce16ef5113c7b08e1d09ec6795ddee1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/85194d956ce16ef5113c7b08e1d09ec6795ddee1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/d63bb8565e129f51fadf6a036683b1eedefb78dd", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJegztzCRBK7hj4Ov3rIwAAdHIIACrJpZaHtS/fa4ERVyPeOK2p\nMsnx+2F+fdgIaeUQNfFYC10jDg72q4i4l98JP4wSsAIWiy1FOjcb9yw+krkAqV9n\n/4oHHNM2sfFSaAIOwxTTfgoyKBfSiSaIVVlDt4ot6UwXQtgoG5rcYiuKuAqK0mCJ\n5UApsXvsVnozcsoxgWKl3EUl8qpcx7RgmYGyc/we9Tt51l/f9vF+x6/oyNOZbtlD\nxqmUDd5hiivUK44e+hRiDReCnREcEfJJ9KOKZLXBPgdqyxfzCWuw5SL3EmJWQFzE\n/RVf7zy16uo8qXTpr5ZOz94f9PNBdybLr7z687lxskgxQA+SNpBiDHIp/zofGUM=\n=fE7N\n-----END PGP SIGNATURE-----\n", "payload": "tree 85194d956ce16ef5113c7b08e1d09ec6795ddee1\nparent a932ccd53da3d2179e5e36ae4fbcbf82f3e0bd25\nparent 331d1db3174853a435991c9341367c235e89eca4\nauthor bors[bot] <26634292+bors[bot]@users.noreply.github.com> 1585658739 +0000\ncommitter GitHub <noreply@github.com> 1585658739 +0000\n\nMerge #3781\n\n3781: Add crate versions when running cargo -p commands. r=matklad a=o0Ignition0o\n\nIf someone (unfortunately) creates a project that happens to have the same name as one of its (future) dependencies, there is [a way for them to change the dependency's alias in the Cargo.toml file](https://doc.rust-lang.org/cargo/reference/specifying-dependencies.html#renaming-dependencies-in-cargotoml), to mitigate the name conflict. Unfortunately cargo -p commands don't seem to pick it up, which seems to put rust-analyzer run commands in a tough situation: \r\n\r\n```\r\n> Executing task: cargo test --package config --example default -- tests --nocapture <\r\n\r\nerror: There are multiple `config` packages in your project, and the specification `config` is ambiguous.\r\nPlease re-run this command with `-p <spec>` where `<spec>` is one of the following:\r\n  config:0.1.0\r\n  config:0.9.3\r\nThe terminal process terminated with exit code: 101\r\n```\r\n\r\ncargo suggests us to be more specific and refer to a package by its name and version, which this PR achieves.\r\n\r\nI passed the version as a String because I don't really understand how the ra_db types work, but I would love to switch it to [a fully fledged Version type](https://steveklabnik.github.io/semver/semver/index.html) if you guide me towards that :)\r\n\r\n\n\nCo-authored-by: o0Ignition0o <jeremy.lempereur@gmail.com>\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/d63bb8565e129f51fadf6a036683b1eedefb78dd", "html_url": "https://github.com/rust-lang/rust/commit/d63bb8565e129f51fadf6a036683b1eedefb78dd", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/d63bb8565e129f51fadf6a036683b1eedefb78dd/comments", "author": {"login": "bors[bot]", "id": 26634292, "node_id": "MDM6Qm90MjY2MzQyOTI=", "avatar_url": "https://avatars.githubusercontent.com/in/1847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors%5Bbot%5D", "html_url": "https://github.com/apps/bors", "followers_url": "https://api.github.com/users/bors%5Bbot%5D/followers", "following_url": "https://api.github.com/users/bors%5Bbot%5D/following{/other_user}", "gists_url": "https://api.github.com/users/bors%5Bbot%5D/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors%5Bbot%5D/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors%5Bbot%5D/subscriptions", "organizations_url": "https://api.github.com/users/bors%5Bbot%5D/orgs", "repos_url": "https://api.github.com/users/bors%5Bbot%5D/repos", "events_url": "https://api.github.com/users/bors%5Bbot%5D/events{/privacy}", "received_events_url": "https://api.github.com/users/bors%5Bbot%5D/received_events", "type": "Bot", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "a932ccd53da3d2179e5e36ae4fbcbf82f3e0bd25", "url": "https://api.github.com/repos/rust-lang/rust/commits/a932ccd53da3d2179e5e36ae4fbcbf82f3e0bd25", "html_url": "https://github.com/rust-lang/rust/commit/a932ccd53da3d2179e5e36ae4fbcbf82f3e0bd25"}, {"sha": "331d1db3174853a435991c9341367c235e89eca4", "url": "https://api.github.com/repos/rust-lang/rust/commits/331d1db3174853a435991c9341367c235e89eca4", "html_url": "https://github.com/rust-lang/rust/commit/331d1db3174853a435991c9341367c235e89eca4"}], "stats": {"total": 16, "additions": 15, "deletions": 1}, "files": [{"sha": "738fd6f610cb6a1831511dee520241e81591fb8a", "filename": "crates/ra_project_model/src/cargo_workspace.rs", "status": "modified", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/d63bb8565e129f51fadf6a036683b1eedefb78dd/crates%2Fra_project_model%2Fsrc%2Fcargo_workspace.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d63bb8565e129f51fadf6a036683b1eedefb78dd/crates%2Fra_project_model%2Fsrc%2Fcargo_workspace.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_project_model%2Fsrc%2Fcargo_workspace.rs?ref=d63bb8565e129f51fadf6a036683b1eedefb78dd", "patch": "@@ -75,6 +75,7 @@ pub type Target = Idx<TargetData>;\n \n #[derive(Debug, Clone)]\n pub struct PackageData {\n+    pub id: String,\n     pub name: String,\n     pub manifest: PathBuf,\n     pub targets: Vec<Target>,\n@@ -180,6 +181,7 @@ impl CargoWorkspace {\n                 .with_context(|| format!(\"Failed to parse edition {}\", edition))?;\n             let pkg = packages.alloc(PackageData {\n                 name,\n+                id: id.to_string(),\n                 manifest: manifest_path,\n                 targets: Vec::new(),\n                 is_member,\n@@ -249,6 +251,18 @@ impl CargoWorkspace {\n     pub fn workspace_root(&self) -> &Path {\n         &self.workspace_root\n     }\n+\n+    pub fn package_flag(&self, package: &PackageData) -> String {\n+        if self.is_unique(&*package.name) {\n+            package.name.clone()\n+        } else {\n+            package.id.clone()\n+        }\n+    }\n+\n+    fn is_unique(&self, name: &str) -> bool {\n+        self.packages.iter().filter(|(_, v)| v.name == name).count() == 1\n+    }\n }\n \n #[derive(Debug, Clone, Default)]"}, {"sha": "942c303287cff1221e3beed7a0ad7eae1065a091", "filename": "crates/rust-analyzer/src/cargo_target_spec.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/d63bb8565e129f51fadf6a036683b1eedefb78dd/crates%2Frust-analyzer%2Fsrc%2Fcargo_target_spec.rs", "raw_url": "https://github.com/rust-lang/rust/raw/d63bb8565e129f51fadf6a036683b1eedefb78dd/crates%2Frust-analyzer%2Fsrc%2Fcargo_target_spec.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Frust-analyzer%2Fsrc%2Fcargo_target_spec.rs?ref=d63bb8565e129f51fadf6a036683b1eedefb78dd", "patch": "@@ -77,7 +77,7 @@ impl CargoTargetSpec {\n             ProjectWorkspace::Cargo { cargo, .. } => {\n                 let tgt = cargo.target_by_root(&path)?;\n                 Some(CargoTargetSpec {\n-                    package: cargo[cargo[tgt].package].name.clone(),\n+                    package: cargo.package_flag(&cargo[cargo[tgt].package]),\n                     target: cargo[tgt].name.clone(),\n                     target_kind: cargo[tgt].kind,\n                 })"}]}