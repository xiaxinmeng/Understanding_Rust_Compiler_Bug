{"sha": "42d69e279330e0aacf5aa6981f20f9c1ae323a37", "node_id": "C_kwDOAAsO6NoAKDQyZDY5ZTI3OTMzMGUwYWFjZjVhYTY5ODFmMjBmOWMxYWUzMjNhMzc", "commit": {"author": {"name": "Daniel Henry-Mantilla", "email": "daniel.henry.mantilla@gmail.com", "date": "2022-01-24T00:41:37Z"}, "committer": {"name": "Daniel Henry-Mantilla", "email": "daniel.henry.mantilla@gmail.com", "date": "2022-02-14T15:56:37Z"}, "message": "Write {ui,} tests for `pin_macro` and `pin!`", "tree": {"sha": "3b5ede97818f4c3dddb290e3ec069e415a80a47c", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3b5ede97818f4c3dddb290e3ec069e415a80a47c"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/42d69e279330e0aacf5aa6981f20f9c1ae323a37", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/42d69e279330e0aacf5aa6981f20f9c1ae323a37", "html_url": "https://github.com/rust-lang/rust/commit/42d69e279330e0aacf5aa6981f20f9c1ae323a37", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/42d69e279330e0aacf5aa6981f20f9c1ae323a37/comments", "author": {"login": "danielhenrymantilla", "id": 9920355, "node_id": "MDQ6VXNlcjk5MjAzNTU=", "avatar_url": "https://avatars.githubusercontent.com/u/9920355?v=4", "gravatar_id": "", "url": "https://api.github.com/users/danielhenrymantilla", "html_url": "https://github.com/danielhenrymantilla", "followers_url": "https://api.github.com/users/danielhenrymantilla/followers", "following_url": "https://api.github.com/users/danielhenrymantilla/following{/other_user}", "gists_url": "https://api.github.com/users/danielhenrymantilla/gists{/gist_id}", "starred_url": "https://api.github.com/users/danielhenrymantilla/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/danielhenrymantilla/subscriptions", "organizations_url": "https://api.github.com/users/danielhenrymantilla/orgs", "repos_url": "https://api.github.com/users/danielhenrymantilla/repos", "events_url": "https://api.github.com/users/danielhenrymantilla/events{/privacy}", "received_events_url": "https://api.github.com/users/danielhenrymantilla/received_events", "type": "User", "site_admin": false}, "committer": {"login": "danielhenrymantilla", "id": 9920355, "node_id": "MDQ6VXNlcjk5MjAzNTU=", "avatar_url": "https://avatars.githubusercontent.com/u/9920355?v=4", "gravatar_id": "", "url": "https://api.github.com/users/danielhenrymantilla", "html_url": "https://github.com/danielhenrymantilla", "followers_url": "https://api.github.com/users/danielhenrymantilla/followers", "following_url": "https://api.github.com/users/danielhenrymantilla/following{/other_user}", "gists_url": "https://api.github.com/users/danielhenrymantilla/gists{/gist_id}", "starred_url": "https://api.github.com/users/danielhenrymantilla/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/danielhenrymantilla/subscriptions", "organizations_url": "https://api.github.com/users/danielhenrymantilla/orgs", "repos_url": "https://api.github.com/users/danielhenrymantilla/repos", "events_url": "https://api.github.com/users/danielhenrymantilla/events{/privacy}", "received_events_url": "https://api.github.com/users/danielhenrymantilla/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ee9cd7bb6ac4ffd03d00549bff8285ed7ca0ea5b", "url": "https://api.github.com/repos/rust-lang/rust/commits/ee9cd7bb6ac4ffd03d00549bff8285ed7ca0ea5b", "html_url": "https://github.com/rust-lang/rust/commit/ee9cd7bb6ac4ffd03d00549bff8285ed7ca0ea5b"}], "stats": {"total": 119, "additions": 119, "deletions": 0}, "files": [{"sha": "65be0c320c26f307290bc11b222357a1446a81ca", "filename": "library/core/tests/lib.rs", "status": "modified", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/42d69e279330e0aacf5aa6981f20f9c1ae323a37/library%2Fcore%2Ftests%2Flib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/42d69e279330e0aacf5aa6981f20f9c1ae323a37/library%2Fcore%2Ftests%2Flib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Ftests%2Flib.rs?ref=42d69e279330e0aacf5aa6981f20f9c1ae323a37", "patch": "@@ -45,6 +45,7 @@\n #![feature(inline_const)]\n #![feature(is_sorted)]\n #![feature(pattern)]\n+#![feature(pin_macro)]\n #![feature(sort_internals)]\n #![feature(slice_take)]\n #![feature(maybe_uninit_uninit_array)]\n@@ -122,6 +123,7 @@ mod ops;\n mod option;\n mod pattern;\n mod pin;\n+mod pin_macro;\n mod ptr;\n mod result;\n mod simd;"}, {"sha": "79c8c166c58d9d8381ffb7cbbce5a1edeea987c5", "filename": "library/core/tests/pin_macro.rs", "status": "added", "additions": 33, "deletions": 0, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/42d69e279330e0aacf5aa6981f20f9c1ae323a37/library%2Fcore%2Ftests%2Fpin_macro.rs", "raw_url": "https://github.com/rust-lang/rust/raw/42d69e279330e0aacf5aa6981f20f9c1ae323a37/library%2Fcore%2Ftests%2Fpin_macro.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Ftests%2Fpin_macro.rs?ref=42d69e279330e0aacf5aa6981f20f9c1ae323a37", "patch": "@@ -0,0 +1,33 @@\n+// edition:2021\n+use core::{\n+    marker::PhantomPinned,\n+    mem::{drop as stuff, transmute},\n+    pin::{pin, Pin},\n+};\n+\n+#[test]\n+fn basic() {\n+    let it: Pin<&mut PhantomPinned> = pin!(PhantomPinned);\n+    stuff(it);\n+}\n+\n+#[test]\n+fn extension_works_through_block() {\n+    let it: Pin<&mut PhantomPinned> = { pin!(PhantomPinned) };\n+    stuff(it);\n+}\n+\n+#[test]\n+fn extension_works_through_unsafe_block() {\n+    // \"retro-type-inference\" works as well.\n+    let it: Pin<&mut PhantomPinned> = unsafe { pin!(transmute(())) };\n+    stuff(it);\n+}\n+\n+#[test]\n+fn unsize_coercion() {\n+    let slice: Pin<&mut [PhantomPinned]> = pin!([PhantomPinned; 2]);\n+    stuff(slice);\n+    let dyn_obj: Pin<&mut dyn Send> = pin!([PhantomPinned; 2]);\n+    stuff(dyn_obj);\n+}"}, {"sha": "120d08894f8f7b89a1b9ae8d371efeae12b26c63", "filename": "src/test/ui/pin-macro/cant_access_internals.rs", "status": "added", "additions": 13, "deletions": 0, "changes": 13, "blob_url": "https://github.com/rust-lang/rust/blob/42d69e279330e0aacf5aa6981f20f9c1ae323a37/src%2Ftest%2Fui%2Fpin-macro%2Fcant_access_internals.rs", "raw_url": "https://github.com/rust-lang/rust/raw/42d69e279330e0aacf5aa6981f20f9c1ae323a37/src%2Ftest%2Fui%2Fpin-macro%2Fcant_access_internals.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fpin-macro%2Fcant_access_internals.rs?ref=42d69e279330e0aacf5aa6981f20f9c1ae323a37", "patch": "@@ -0,0 +1,13 @@\n+// edition:2018\n+#![feature(pin_macro)]\n+\n+use core::{\n+    marker::PhantomPinned,\n+    mem,\n+    pin::{pin, Pin},\n+};\n+\n+fn main() {\n+    let mut phantom_pinned = pin!(PhantomPinned);\n+    mem::take(phantom_pinned.pointer); //~ ERROR use of unstable library feature 'unsafe_pin_internals'\n+}"}, {"sha": "060c9c48c21c8640aa657325d3d7e90786674c90", "filename": "src/test/ui/pin-macro/cant_access_internals.stderr", "status": "added", "additions": 11, "deletions": 0, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/42d69e279330e0aacf5aa6981f20f9c1ae323a37/src%2Ftest%2Fui%2Fpin-macro%2Fcant_access_internals.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/42d69e279330e0aacf5aa6981f20f9c1ae323a37/src%2Ftest%2Fui%2Fpin-macro%2Fcant_access_internals.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fpin-macro%2Fcant_access_internals.stderr?ref=42d69e279330e0aacf5aa6981f20f9c1ae323a37", "patch": "@@ -0,0 +1,11 @@\n+error[E0658]: use of unstable library feature 'unsafe_pin_internals'\n+  --> $DIR/cant_access_internals.rs:12:15\n+   |\n+LL |     mem::take(phantom_pinned.pointer);\n+   |               ^^^^^^^^^^^^^^^^^^^^^^\n+   |\n+   = help: add `#![feature(unsafe_pin_internals)]` to the crate attributes to enable\n+\n+error: aborting due to previous error\n+\n+For more information about this error, try `rustc --explain E0658`."}, {"sha": "ca2b6cf759376af6e9a0e82113773b01066947c4", "filename": "src/test/ui/pin-macro/lifetime_errors_on_promotion_misusage.rs", "status": "added", "additions": 29, "deletions": 0, "changes": 29, "blob_url": "https://github.com/rust-lang/rust/blob/42d69e279330e0aacf5aa6981f20f9c1ae323a37/src%2Ftest%2Fui%2Fpin-macro%2Flifetime_errors_on_promotion_misusage.rs", "raw_url": "https://github.com/rust-lang/rust/raw/42d69e279330e0aacf5aa6981f20f9c1ae323a37/src%2Ftest%2Fui%2Fpin-macro%2Flifetime_errors_on_promotion_misusage.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fpin-macro%2Flifetime_errors_on_promotion_misusage.rs?ref=42d69e279330e0aacf5aa6981f20f9c1ae323a37", "patch": "@@ -0,0 +1,29 @@\n+// edition:2018\n+#![feature(pin_macro)]\n+\n+use core::{\n+    convert::identity,\n+    marker::PhantomPinned,\n+    mem::drop as stuff,\n+    pin::pin,\n+};\n+\n+fn function_call_stops_borrow_extension() {\n+    let phantom_pinned = identity(pin!(PhantomPinned));\n+    //~^ ERROR temporary value dropped while borrowed\n+    stuff(phantom_pinned)\n+}\n+\n+fn promotion_only_works_for_the_innermost_block() {\n+    let phantom_pinned = {\n+        let phantom_pinned = pin!(PhantomPinned);\n+        //~^ ERROR temporary value dropped while borrowed\n+        phantom_pinned\n+    };\n+    stuff(phantom_pinned)\n+}\n+\n+fn main() {\n+    function_call_stops_borrow_extension();\n+    promotion_only_works_for_the_innermost_block();\n+}"}, {"sha": "4971263af08ad1864f36a5dbf81bfecedd319411", "filename": "src/test/ui/pin-macro/lifetime_errors_on_promotion_misusage.stderr", "status": "added", "additions": 31, "deletions": 0, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/42d69e279330e0aacf5aa6981f20f9c1ae323a37/src%2Ftest%2Fui%2Fpin-macro%2Flifetime_errors_on_promotion_misusage.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/42d69e279330e0aacf5aa6981f20f9c1ae323a37/src%2Ftest%2Fui%2Fpin-macro%2Flifetime_errors_on_promotion_misusage.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fpin-macro%2Flifetime_errors_on_promotion_misusage.stderr?ref=42d69e279330e0aacf5aa6981f20f9c1ae323a37", "patch": "@@ -0,0 +1,31 @@\n+error[E0716]: temporary value dropped while borrowed\n+  --> $DIR/lifetime_errors_on_promotion_misusage.rs:12:35\n+   |\n+LL |     let phantom_pinned = identity(pin!(PhantomPinned));\n+   |                                   ^^^^^^^^^^^^^^^^^^^ - temporary value is freed at the end of this statement\n+   |                                   |\n+   |                                   creates a temporary which is freed while still in use\n+LL |\n+LL |     stuff(phantom_pinned)\n+   |           -------------- borrow later used here\n+   |\n+   = note: consider using a `let` binding to create a longer lived value\n+   = note: this error originates in the macro `pin` (in Nightly builds, run with -Z macro-backtrace for more info)\n+\n+error[E0716]: temporary value dropped while borrowed\n+  --> $DIR/lifetime_errors_on_promotion_misusage.rs:19:30\n+   |\n+LL |     let phantom_pinned = {\n+   |         -------------- borrow later stored here\n+LL |         let phantom_pinned = pin!(PhantomPinned);\n+   |                              ^^^^^^^^^^^^^^^^^^^ creates a temporary which is freed while still in use\n+...\n+LL |     };\n+   |     - temporary value is freed at the end of this statement\n+   |\n+   = note: consider using a `let` binding to create a longer lived value\n+   = note: this error originates in the macro `pin` (in Nightly builds, run with -Z macro-backtrace for more info)\n+\n+error: aborting due to 2 previous errors\n+\n+For more information about this error, try `rustc --explain E0716`."}]}