{"sha": "6f319812d602fb1d6558b583b80a9326f1cc14b3", "node_id": "MDY6Q29tbWl0NzI0NzEyOjZmMzE5ODEyZDYwMmZiMWQ2NTU4YjU4M2I4MGE5MzI2ZjFjYzE0YjM=", "commit": {"author": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2013-08-11T17:39:05Z"}, "committer": {"name": "Niko Matsakis", "email": "niko@alum.mit.edu", "date": "2013-08-11T18:01:19Z"}, "message": "ty: Add (but do not yet use) AutoBorrowObject option to adjustments\n\nNote: some portions of this commit written by @Sodel-the-Vociferous\n(Daniel Ralston)", "tree": {"sha": "3ef4db61eeaab07b3283c4cf8b71a9787c4ce615", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3ef4db61eeaab07b3283c4cf8b71a9787c4ce615"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/6f319812d602fb1d6558b583b80a9326f1cc14b3", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/6f319812d602fb1d6558b583b80a9326f1cc14b3", "html_url": "https://github.com/rust-lang/rust/commit/6f319812d602fb1d6558b583b80a9326f1cc14b3", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/6f319812d602fb1d6558b583b80a9326f1cc14b3/comments", "author": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "committer": {"login": "nikomatsakis", "id": 155238, "node_id": "MDQ6VXNlcjE1NTIzOA==", "avatar_url": "https://avatars.githubusercontent.com/u/155238?v=4", "gravatar_id": "", "url": "https://api.github.com/users/nikomatsakis", "html_url": "https://github.com/nikomatsakis", "followers_url": "https://api.github.com/users/nikomatsakis/followers", "following_url": "https://api.github.com/users/nikomatsakis/following{/other_user}", "gists_url": "https://api.github.com/users/nikomatsakis/gists{/gist_id}", "starred_url": "https://api.github.com/users/nikomatsakis/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/nikomatsakis/subscriptions", "organizations_url": "https://api.github.com/users/nikomatsakis/orgs", "repos_url": "https://api.github.com/users/nikomatsakis/repos", "events_url": "https://api.github.com/users/nikomatsakis/events{/privacy}", "received_events_url": "https://api.github.com/users/nikomatsakis/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "38357ebef48aba5ac134dbc32adb445a08db1e20", "url": "https://api.github.com/repos/rust-lang/rust/commits/38357ebef48aba5ac134dbc32adb445a08db1e20", "html_url": "https://github.com/rust-lang/rust/commit/38357ebef48aba5ac134dbc32adb445a08db1e20"}], "stats": {"total": 34, "additions": 32, "deletions": 2}, "files": [{"sha": "720c6ab96b6551d95b679334748b7544d9cbbe12", "filename": "src/librustc/middle/ty.rs", "status": "modified", "additions": 32, "deletions": 2, "changes": 34, "blob_url": "https://github.com/rust-lang/rust/blob/6f319812d602fb1d6558b583b80a9326f1cc14b3/src%2Flibrustc%2Fmiddle%2Fty.rs", "raw_url": "https://github.com/rust-lang/rust/raw/6f319812d602fb1d6558b583b80a9326f1cc14b3/src%2Flibrustc%2Fmiddle%2Fty.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Fty.rs?ref=6f319812d602fb1d6558b583b80a9326f1cc14b3", "patch": "@@ -226,7 +226,10 @@ pub enum AutoRef {\n     AutoBorrowFn(Region),\n \n     /// Convert from T to *T\n-    AutoUnsafe(ast::mutability)\n+    AutoUnsafe(ast::mutability),\n+\n+    /// Convert from @Trait/~Trait/&Trait to &Trait\n+    AutoBorrowObj(Region, ast::mutability),\n }\n \n pub type ctxt = @ctxt_;\n@@ -1004,7 +1007,13 @@ fn mk_t(cx: ctxt, st: sty) -> t {\n       &ty_self(_) => flags |= has_self as uint,\n       &ty_enum(_, ref substs) | &ty_struct(_, ref substs) |\n       &ty_trait(_, ref substs, _, _, _) => {\n-        flags |= sflags(substs);\n+          flags |= sflags(substs);\n+          match st {\n+              ty_trait(_, _, RegionTraitStore(r), _, _) => {\n+                    flags |= rflags(r);\n+                }\n+              _ => {}\n+          }\n       }\n       &ty_box(ref m) | &ty_uniq(ref m) | &ty_evec(ref m, _) |\n       &ty_ptr(ref m) | &ty_unboxed_vec(ref m) => {\n@@ -3009,6 +3018,10 @@ pub fn adjust_ty(cx: ctxt,\n                         AutoUnsafe(m) => {\n                             mk_ptr(cx, mt {ty: adjusted_ty, mutbl: m})\n                         }\n+\n+                        AutoBorrowObj(r, m) => {\n+                            borrow_obj(cx, span, r, m, adjusted_ty)\n+                        }\n                     }\n                 }\n             }\n@@ -3054,6 +3067,22 @@ pub fn adjust_ty(cx: ctxt,\n             }\n         }\n     }\n+\n+    fn borrow_obj(cx: ctxt, span: span, r: Region,\n+                  m: ast::mutability, ty: ty::t) -> ty::t {\n+        match get(ty).sty {\n+            ty_trait(trt_did, ref trt_substs, _, _, b) => {\n+                ty::mk_trait(cx, trt_did, trt_substs.clone(),\n+                             RegionTraitStore(r), m, b)\n+            }\n+            ref s => {\n+                cx.sess.span_bug(\n+                    span,\n+                    fmt!(\"borrow-trait-obj associated with bad sty: %?\",\n+                         s));\n+            }\n+        }\n+    }\n }\n \n impl AutoRef {\n@@ -3064,6 +3093,7 @@ impl AutoRef {\n             ty::AutoBorrowVecRef(r, m) => ty::AutoBorrowVecRef(f(r), m),\n             ty::AutoBorrowFn(r) => ty::AutoBorrowFn(f(r)),\n             ty::AutoUnsafe(m) => ty::AutoUnsafe(m),\n+            ty::AutoBorrowObj(r, m) => ty::AutoBorrowObj(f(r), m),\n         }\n     }\n }"}]}