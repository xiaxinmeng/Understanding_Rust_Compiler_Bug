{"sha": "ca16a8d76c9e17f1a8ac1c0280cf87338e0ca20d", "node_id": "C_kwDOAAsO6NoAKGNhMTZhOGQ3NmM5ZTE3ZjFhOGFjMWMwMjgwY2Y4NzMzOGUwY2EyMGQ", "commit": {"author": {"name": "est31", "email": "MTest31@outlook.com", "date": "2022-08-10T09:31:31Z"}, "committer": {"name": "est31", "email": "MTest31@outlook.com", "date": "2022-08-12T20:26:08Z"}, "message": "Change fluent_messages macro to expect _ slugs instead of - slugs\n\nFor the most part, the macro actually worked with _ slugs, but the prefix_something -> prefix::something\nconversion was not implemented.\n\nWe don't want to accept - slugs for consistency reasons.\nWe thus error if a name is found with - inside.\nThis ensures a consistent style.", "tree": {"sha": "ce8d524d25568d62ac1b1c335b1d1b97406e92ac", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/ce8d524d25568d62ac1b1c335b1d1b97406e92ac"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ca16a8d76c9e17f1a8ac1c0280cf87338e0ca20d", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ca16a8d76c9e17f1a8ac1c0280cf87338e0ca20d", "html_url": "https://github.com/rust-lang/rust/commit/ca16a8d76c9e17f1a8ac1c0280cf87338e0ca20d", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ca16a8d76c9e17f1a8ac1c0280cf87338e0ca20d/comments", "author": {"login": "est31", "id": 8872119, "node_id": "MDQ6VXNlcjg4NzIxMTk=", "avatar_url": "https://avatars.githubusercontent.com/u/8872119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/est31", "html_url": "https://github.com/est31", "followers_url": "https://api.github.com/users/est31/followers", "following_url": "https://api.github.com/users/est31/following{/other_user}", "gists_url": "https://api.github.com/users/est31/gists{/gist_id}", "starred_url": "https://api.github.com/users/est31/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/est31/subscriptions", "organizations_url": "https://api.github.com/users/est31/orgs", "repos_url": "https://api.github.com/users/est31/repos", "events_url": "https://api.github.com/users/est31/events{/privacy}", "received_events_url": "https://api.github.com/users/est31/received_events", "type": "User", "site_admin": false}, "committer": {"login": "est31", "id": 8872119, "node_id": "MDQ6VXNlcjg4NzIxMTk=", "avatar_url": "https://avatars.githubusercontent.com/u/8872119?v=4", "gravatar_id": "", "url": "https://api.github.com/users/est31", "html_url": "https://github.com/est31", "followers_url": "https://api.github.com/users/est31/followers", "following_url": "https://api.github.com/users/est31/following{/other_user}", "gists_url": "https://api.github.com/users/est31/gists{/gist_id}", "starred_url": "https://api.github.com/users/est31/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/est31/subscriptions", "organizations_url": "https://api.github.com/users/est31/orgs", "repos_url": "https://api.github.com/users/est31/repos", "events_url": "https://api.github.com/users/est31/events{/privacy}", "received_events_url": "https://api.github.com/users/est31/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "75d78b9362d0f1900d828ccdc9ed4bc2c8000234", "url": "https://api.github.com/repos/rust-lang/rust/commits/75d78b9362d0f1900d828ccdc9ed4bc2c8000234", "html_url": "https://github.com/rust-lang/rust/commit/75d78b9362d0f1900d828ccdc9ed4bc2c8000234"}], "stats": {"total": 71, "additions": 65, "deletions": 6}, "files": [{"sha": "2e7652ad333ffcdeafdeb5b87c7e8ddc17fee5a7", "filename": "compiler/rustc_macros/src/diagnostics/fluent.rs", "status": "modified", "additions": 27, "deletions": 5, "changes": 32, "blob_url": "https://github.com/rust-lang/rust/blob/ca16a8d76c9e17f1a8ac1c0280cf87338e0ca20d/compiler%2Frustc_macros%2Fsrc%2Fdiagnostics%2Ffluent.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ca16a8d76c9e17f1a8ac1c0280cf87338e0ca20d/compiler%2Frustc_macros%2Fsrc%2Fdiagnostics%2Ffluent.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_macros%2Fsrc%2Fdiagnostics%2Ffluent.rs?ref=ca16a8d76c9e17f1a8ac1c0280cf87338e0ca20d", "patch": "@@ -189,13 +189,25 @@ pub(crate) fn fluent_messages(input: proc_macro::TokenStream) -> proc_macro::Tok\n             if let Entry::Message(Message { id: Identifier { name }, attributes, .. }) = entry {\n                 let _ = previous_defns.entry(name.to_string()).or_insert(ident_span);\n \n-                // `typeck-foo-bar` => `foo_bar` (in `typeck.ftl`)\n-                // `const-eval-baz` => `baz` (in `const_eval.ftl`)\n+                if name.contains('-') {\n+                    Diagnostic::spanned(\n+                        ident_span,\n+                        Level::Error,\n+                        format!(\"name `{name}` contains a '-' character\"),\n+                    )\n+                    .help(\"replace any '-'s with '_'s\")\n+                    .emit();\n+                }\n+\n+                // `typeck_foo_bar` => `foo_bar` (in `typeck.ftl`)\n+                // `const_eval_baz` => `baz` (in `const_eval.ftl`)\n+                // `const-eval-hyphen-having` => `hyphen_having` (in `const_eval.ftl`)\n+                // The last case we error about above, but we want to fall back gracefully\n+                // so that only the error is being emitted and not also one about the macro\n+                // failing.\n                 let snake_name = Ident::new(\n                     // FIXME: should probably trim prefix, not replace all occurrences\n-                    &name\n-                        .replace(&format!(\"{}-\", res.ident).replace('_', \"-\"), \"\")\n-                        .replace('-', \"_\"),\n+                    &name.replace('-', \"_\").replace(&format!(\"{}_\", res.ident), \"\"),\n                     span,\n                 );\n                 constants.extend(quote! {\n@@ -212,6 +224,16 @@ pub(crate) fn fluent_messages(input: proc_macro::TokenStream) -> proc_macro::Tok\n                         continue;\n                     }\n \n+                    if attr_name.contains('-') {\n+                        Diagnostic::spanned(\n+                            ident_span,\n+                            Level::Error,\n+                            format!(\"attribute `{attr_name}` contains a '-' character\"),\n+                        )\n+                        .help(\"replace any '-'s with '_'s\")\n+                        .emit();\n+                    }\n+\n                     constants.extend(quote! {\n                         pub const #snake_name: crate::SubdiagnosticMessage =\n                             crate::SubdiagnosticMessage::FluentAttr("}, {"sha": "84b6c3e6c005581f5a9be0476884e9f8fa18086b", "filename": "src/test/ui-fulldeps/fluent-messages/label-with-hyphens.ftl", "status": "added", "additions": 2, "deletions": 0, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ca16a8d76c9e17f1a8ac1c0280cf87338e0ca20d/src%2Ftest%2Fui-fulldeps%2Ffluent-messages%2Flabel-with-hyphens.ftl", "raw_url": "https://github.com/rust-lang/rust/raw/ca16a8d76c9e17f1a8ac1c0280cf87338e0ca20d/src%2Ftest%2Fui-fulldeps%2Ffluent-messages%2Flabel-with-hyphens.ftl", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui-fulldeps%2Ffluent-messages%2Flabel-with-hyphens.ftl?ref=ca16a8d76c9e17f1a8ac1c0280cf87338e0ca20d", "patch": "@@ -0,0 +1,2 @@\n+some_slug = hi\n+    .label-has-hyphens = test"}, {"sha": "07517c9a2434f3611ae027877327a05d233cf0d6", "filename": "src/test/ui-fulldeps/fluent-messages/slug-with-hyphens.ftl", "status": "added", "additions": 1, "deletions": 0, "changes": 1, "blob_url": "https://github.com/rust-lang/rust/blob/ca16a8d76c9e17f1a8ac1c0280cf87338e0ca20d/src%2Ftest%2Fui-fulldeps%2Ffluent-messages%2Fslug-with-hyphens.ftl", "raw_url": "https://github.com/rust-lang/rust/raw/ca16a8d76c9e17f1a8ac1c0280cf87338e0ca20d/src%2Ftest%2Fui-fulldeps%2Ffluent-messages%2Fslug-with-hyphens.ftl", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui-fulldeps%2Ffluent-messages%2Fslug-with-hyphens.ftl?ref=ca16a8d76c9e17f1a8ac1c0280cf87338e0ca20d", "patch": "@@ -0,0 +1 @@\n+this-slug-has-hyphens = hi"}, {"sha": "f0f35780666bbdd07a98ed3ae15488ea6c721f65", "filename": "src/test/ui-fulldeps/fluent-messages/test.rs", "status": "modified", "additions": 18, "deletions": 0, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/ca16a8d76c9e17f1a8ac1c0280cf87338e0ca20d/src%2Ftest%2Fui-fulldeps%2Ffluent-messages%2Ftest.rs", "raw_url": "https://github.com/rust-lang/rust/raw/ca16a8d76c9e17f1a8ac1c0280cf87338e0ca20d/src%2Ftest%2Fui-fulldeps%2Ffluent-messages%2Ftest.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui-fulldeps%2Ffluent-messages%2Ftest.rs?ref=ca16a8d76c9e17f1a8ac1c0280cf87338e0ca20d", "patch": "@@ -55,6 +55,24 @@ mod duplicate {\n     }\n }\n \n+mod slug_with_hyphens {\n+    use super::fluent_messages;\n+\n+    fluent_messages! {\n+        slug_with_hyphens => \"./slug-with-hyphens.ftl\",\n+//~^ ERROR name `this-slug-has-hyphens` contains a '-' character\n+    }\n+}\n+\n+mod label_with_hyphens {\n+    use super::fluent_messages;\n+\n+    fluent_messages! {\n+        label_with_hyphens => \"./label-with-hyphens.ftl\",\n+//~^ ERROR attribute `label-has-hyphens` contains a '-' character\n+    }\n+}\n+\n mod valid {\n     use super::fluent_messages;\n "}, {"sha": "856642c4818da2058a55b5d9b1443fa0593c02a9", "filename": "src/test/ui-fulldeps/fluent-messages/test.stderr", "status": "modified", "additions": 17, "deletions": 1, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/ca16a8d76c9e17f1a8ac1c0280cf87338e0ca20d/src%2Ftest%2Fui-fulldeps%2Ffluent-messages%2Ftest.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/ca16a8d76c9e17f1a8ac1c0280cf87338e0ca20d/src%2Ftest%2Fui-fulldeps%2Ffluent-messages%2Ftest.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui-fulldeps%2Ffluent-messages%2Ftest.stderr?ref=ca16a8d76c9e17f1a8ac1c0280cf87338e0ca20d", "patch": "@@ -41,5 +41,21 @@ help: previously defined in this resource\n LL |         a => \"./duplicate-a.ftl\",\n    |         ^\n \n-error: aborting due to 4 previous errors\n+error: name `this-slug-has-hyphens` contains a '-' character\n+  --> $DIR/test.rs:62:9\n+   |\n+LL |         slug_with_hyphens => \"./slug-with-hyphens.ftl\",\n+   |         ^^^^^^^^^^^^^^^^^\n+   |\n+   = help: replace any '-'s with '_'s\n+\n+error: attribute `label-has-hyphens` contains a '-' character\n+  --> $DIR/test.rs:71:9\n+   |\n+LL |         label_with_hyphens => \"./label-with-hyphens.ftl\",\n+   |         ^^^^^^^^^^^^^^^^^^\n+   |\n+   = help: replace any '-'s with '_'s\n+\n+error: aborting due to 6 previous errors\n "}]}