{"sha": "7a42ca942cda0d197a63373127e7e373305957a0", "node_id": "C_kwDOAAsO6NoAKDdhNDJjYTk0MmNkYTBkMTk3YTYzMzczMTI3ZTdlMzczMzA1OTU3YTA", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-08-29T07:54:06Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2022-08-29T07:54:06Z"}, "message": "Auto merge of #100786 - sunshowers:macos-posix-chdir, r=sunshowers\n\nUse posix_spawn for absolute paths on macOS\n\nCurrently, on macOS, Rust never uses the fast posix_spawn path if a\ndirectory change is requested, due to a bug in Apple's libc. However, the\nbug is only triggered if the program is a relative path.\n\nThis PR makes it so that the fast path continues to work if the program\nis an absolute path or a lone filename.\n\nThis was an alternative proposed in https://github.com/rust-lang/rust/pull/80537#issue-776674009, and it makes a measurable performance difference in some of my code that spawns thousands of processes.", "tree": {"sha": "d3ff0487c13616d512fae7745f3aefdbdc53ccd5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/d3ff0487c13616d512fae7745f3aefdbdc53ccd5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7a42ca942cda0d197a63373127e7e373305957a0", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7a42ca942cda0d197a63373127e7e373305957a0", "html_url": "https://github.com/rust-lang/rust/commit/7a42ca942cda0d197a63373127e7e373305957a0", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7a42ca942cda0d197a63373127e7e373305957a0/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "94b2b15e63c5d2b2a6a0910e3dae554ce9415bf9", "url": "https://api.github.com/repos/rust-lang/rust/commits/94b2b15e63c5d2b2a6a0910e3dae554ce9415bf9", "html_url": "https://github.com/rust-lang/rust/commit/94b2b15e63c5d2b2a6a0910e3dae554ce9415bf9"}, {"sha": "bd8b4b9c1588f0c681162ead34cc91b3f9a52bfc", "url": "https://api.github.com/repos/rust-lang/rust/commits/bd8b4b9c1588f0c681162ead34cc91b3f9a52bfc", "html_url": "https://github.com/rust-lang/rust/commit/bd8b4b9c1588f0c681162ead34cc91b3f9a52bfc"}], "stats": {"total": 61, "additions": 60, "deletions": 1}, "files": [{"sha": "2834ee0ace8352dc78f801728358944e50bb26a0", "filename": "library/std/src/sys/unix/process/process_common.rs", "status": "modified", "additions": 33, "deletions": 0, "changes": 33, "blob_url": "https://github.com/rust-lang/rust/blob/7a42ca942cda0d197a63373127e7e373305957a0/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fprocess%2Fprocess_common.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7a42ca942cda0d197a63373127e7e373305957a0/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fprocess%2Fprocess_common.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fprocess%2Fprocess_common.rs?ref=7a42ca942cda0d197a63373127e7e373305957a0", "patch": "@@ -92,6 +92,7 @@ pub struct Command {\n     argv: Argv,\n     env: CommandEnv,\n \n+    program_kind: ProgramKind,\n     cwd: Option<CString>,\n     uid: Option<uid_t>,\n     gid: Option<gid_t>,\n@@ -148,15 +149,40 @@ pub enum Stdio {\n     Fd(FileDesc),\n }\n \n+#[derive(Copy, Clone, Debug, Eq, PartialEq)]\n+pub enum ProgramKind {\n+    /// A program that would be looked up on the PATH (e.g. `ls`)\n+    PathLookup,\n+    /// A relative path (e.g. `my-dir/foo`, `../foo`, `./foo`)\n+    Relative,\n+    /// An absolute path.\n+    Absolute,\n+}\n+\n+impl ProgramKind {\n+    fn new(program: &OsStr) -> Self {\n+        if program.bytes().starts_with(b\"/\") {\n+            Self::Absolute\n+        } else if program.bytes().contains(&b'/') {\n+            // If the program has more than one component in it, it is a relative path.\n+            Self::Relative\n+        } else {\n+            Self::PathLookup\n+        }\n+    }\n+}\n+\n impl Command {\n     #[cfg(not(target_os = \"linux\"))]\n     pub fn new(program: &OsStr) -> Command {\n         let mut saw_nul = false;\n+        let program_kind = ProgramKind::new(program.as_ref());\n         let program = os2c(program, &mut saw_nul);\n         Command {\n             argv: Argv(vec![program.as_ptr(), ptr::null()]),\n             args: vec![program.clone()],\n             program,\n+            program_kind,\n             env: Default::default(),\n             cwd: None,\n             uid: None,\n@@ -174,11 +200,13 @@ impl Command {\n     #[cfg(target_os = \"linux\")]\n     pub fn new(program: &OsStr) -> Command {\n         let mut saw_nul = false;\n+        let program_kind = ProgramKind::new(program.as_ref());\n         let program = os2c(program, &mut saw_nul);\n         Command {\n             argv: Argv(vec![program.as_ptr(), ptr::null()]),\n             args: vec![program.clone()],\n             program,\n+            program_kind,\n             env: Default::default(),\n             cwd: None,\n             uid: None,\n@@ -254,6 +282,11 @@ impl Command {\n         OsStr::from_bytes(self.program.as_bytes())\n     }\n \n+    #[allow(dead_code)]\n+    pub fn get_program_kind(&self) -> ProgramKind {\n+        self.program_kind\n+    }\n+\n     pub fn get_args(&self) -> CommandArgs<'_> {\n         let mut iter = self.args.iter();\n         iter.next();"}, {"sha": "d176b3401c03c0d65afb2d07a37e11765fff0c54", "filename": "library/std/src/sys/unix/process/process_common/tests.rs", "status": "modified", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/7a42ca942cda0d197a63373127e7e373305957a0/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fprocess%2Fprocess_common%2Ftests.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7a42ca942cda0d197a63373127e7e373305957a0/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fprocess%2Fprocess_common%2Ftests.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fprocess%2Fprocess_common%2Ftests.rs?ref=7a42ca942cda0d197a63373127e7e373305957a0", "patch": "@@ -122,3 +122,27 @@ fn test_process_group_no_posix_spawn() {\n         t!(cat.wait());\n     }\n }\n+\n+#[test]\n+fn test_program_kind() {\n+    let vectors = &[\n+        (\"foo\", ProgramKind::PathLookup),\n+        (\"foo.out\", ProgramKind::PathLookup),\n+        (\"./foo\", ProgramKind::Relative),\n+        (\"../foo\", ProgramKind::Relative),\n+        (\"dir/foo\", ProgramKind::Relative),\n+        // Note that paths on Unix can't contain / in them, so this is actually the directory \"fo\\\\\"\n+        // followed by the file \"o\".\n+        (\"fo\\\\/o\", ProgramKind::Relative),\n+        (\"/foo\", ProgramKind::Absolute),\n+        (\"/dir/../foo\", ProgramKind::Absolute),\n+    ];\n+\n+    for (program, expected_kind) in vectors {\n+        assert_eq!(\n+            ProgramKind::new(program.as_ref()),\n+            *expected_kind,\n+            \"actual != expected program kind for input {program}\",\n+        );\n+    }\n+}"}, {"sha": "26ae62817713e3f213afa7ccc99cfee5110344d3", "filename": "library/std/src/sys/unix/process/process_unix.rs", "status": "modified", "additions": 3, "deletions": 1, "changes": 4, "blob_url": "https://github.com/rust-lang/rust/blob/7a42ca942cda0d197a63373127e7e373305957a0/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fprocess%2Fprocess_unix.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7a42ca942cda0d197a63373127e7e373305957a0/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fprocess%2Fprocess_unix.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fstd%2Fsrc%2Fsys%2Funix%2Fprocess%2Fprocess_unix.rs?ref=7a42ca942cda0d197a63373127e7e373305957a0", "patch": "@@ -453,7 +453,9 @@ impl Command {\n                     // successfully launch the program, but erroneously return\n                     // ENOENT when used with posix_spawn_file_actions_addchdir_np\n                     // which was introduced in macOS 10.15.\n-                    return Ok(None);\n+                    if self.get_program_kind() == ProgramKind::Relative {\n+                        return Ok(None);\n+                    }\n                 }\n                 match posix_spawn_file_actions_addchdir_np.get() {\n                     Some(f) => Some((f, cwd)),"}]}