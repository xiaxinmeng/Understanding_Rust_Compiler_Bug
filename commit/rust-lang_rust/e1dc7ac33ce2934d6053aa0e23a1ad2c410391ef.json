{"sha": "e1dc7ac33ce2934d6053aa0e23a1ad2c410391ef", "node_id": "MDY6Q29tbWl0NzI0NzEyOmUxZGM3YWMzM2NlMjkzNGQ2MDUzYWEwZTIzYTFhZDJjNDEwMzkxZWY=", "commit": {"author": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2017-12-18T07:48:59Z"}, "committer": {"name": "Esteban K\u00fcber", "email": "esteban@kuber.com.ar", "date": "2017-12-18T19:11:35Z"}, "message": "Tweak \"unecessary unsafe block\" error spans", "tree": {"sha": "25dab7c07ba14ab91a83f0fff00c9b213b2ca3fa", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/25dab7c07ba14ab91a83f0fff00c9b213b2ca3fa"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/e1dc7ac33ce2934d6053aa0e23a1ad2c410391ef", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/e1dc7ac33ce2934d6053aa0e23a1ad2c410391ef", "html_url": "https://github.com/rust-lang/rust/commit/e1dc7ac33ce2934d6053aa0e23a1ad2c410391ef", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/e1dc7ac33ce2934d6053aa0e23a1ad2c410391ef/comments", "author": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "committer": {"login": "estebank", "id": 1606434, "node_id": "MDQ6VXNlcjE2MDY0MzQ=", "avatar_url": "https://avatars.githubusercontent.com/u/1606434?v=4", "gravatar_id": "", "url": "https://api.github.com/users/estebank", "html_url": "https://github.com/estebank", "followers_url": "https://api.github.com/users/estebank/followers", "following_url": "https://api.github.com/users/estebank/following{/other_user}", "gists_url": "https://api.github.com/users/estebank/gists{/gist_id}", "starred_url": "https://api.github.com/users/estebank/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/estebank/subscriptions", "organizations_url": "https://api.github.com/users/estebank/orgs", "repos_url": "https://api.github.com/users/estebank/repos", "events_url": "https://api.github.com/users/estebank/events{/privacy}", "received_events_url": "https://api.github.com/users/estebank/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3cc68bac7c89a81ec83cbd8f0aff9db001425c50", "url": "https://api.github.com/repos/rust-lang/rust/commits/3cc68bac7c89a81ec83cbd8f0aff9db001425c50", "html_url": "https://github.com/rust-lang/rust/commit/3cc68bac7c89a81ec83cbd8f0aff9db001425c50"}], "stats": {"total": 165, "additions": 43, "deletions": 122}, "files": [{"sha": "524fa5cd433c0c44e44caf230b3f273d461f341a", "filename": "src/librustc_mir/transform/check_unsafety.rs", "status": "modified", "additions": 6, "deletions": 5, "changes": 11, "blob_url": "https://github.com/rust-lang/rust/blob/e1dc7ac33ce2934d6053aa0e23a1ad2c410391ef/src%2Flibrustc_mir%2Ftransform%2Fcheck_unsafety.rs", "raw_url": "https://github.com/rust-lang/rust/raw/e1dc7ac33ce2934d6053aa0e23a1ad2c410391ef/src%2Flibrustc_mir%2Ftransform%2Fcheck_unsafety.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_mir%2Ftransform%2Fcheck_unsafety.rs?ref=e1dc7ac33ce2934d6053aa0e23a1ad2c410391ef", "patch": "@@ -388,12 +388,13 @@ fn is_enclosed(tcx: TyCtxt,\n }\n \n fn report_unused_unsafe(tcx: TyCtxt, used_unsafe: &FxHashSet<ast::NodeId>, id: ast::NodeId) {\n-    let span = tcx.hir.span(id);\n-    let mut db = tcx.struct_span_lint_node(UNUSED_UNSAFE, id, span, \"unnecessary `unsafe` block\");\n-    db.span_label(span, \"unnecessary `unsafe` block\");\n+    let span = tcx.sess.codemap().def_span(tcx.hir.span(id));\n+    let msg = \"unnecessary `unsafe` block\";\n+    let mut db = tcx.struct_span_lint_node(UNUSED_UNSAFE, id, span, msg);\n+    db.span_label(span, msg);\n     if let Some((kind, id)) = is_enclosed(tcx, used_unsafe, id) {\n-        db.span_note(tcx.hir.span(id),\n-                     &format!(\"because it's nested under this `unsafe` {}\", kind));\n+        db.span_label(tcx.sess.codemap().def_span(tcx.hir.span(id)),\n+                      format!(\"because it's nested under this `unsafe` {}\", kind));\n     }\n     db.emit();\n }"}, {"sha": "8c34cc4b73cfb63f023dc2081be628fd6bea9680", "filename": "src/test/ui/issue-45107-unnecessary-unsafe-in-closure.stderr", "status": "modified", "additions": 15, "deletions": 52, "changes": 67, "blob_url": "https://github.com/rust-lang/rust/blob/e1dc7ac33ce2934d6053aa0e23a1ad2c410391ef/src%2Ftest%2Fui%2Fissue-45107-unnecessary-unsafe-in-closure.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e1dc7ac33ce2934d6053aa0e23a1ad2c410391ef/src%2Ftest%2Fui%2Fissue-45107-unnecessary-unsafe-in-closure.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fissue-45107-unnecessary-unsafe-in-closure.stderr?ref=e1dc7ac33ce2934d6053aa0e23a1ad2c410391ef", "patch": "@@ -1,72 +1,35 @@\n error: unnecessary `unsafe` block\n   --> $DIR/issue-45107-unnecessary-unsafe-in-closure.rs:17:13\n    |\n-17 | /             unsafe { //~ ERROR unnecessary `unsafe`\n-18 | |                 v.set_len(24);\n-19 | |                 |w: &mut Vec<u32>| { unsafe { //~ ERROR unnecessary `unsafe`\n-20 | |                     w.set_len(32);\n-21 | |                 } };\n-22 | |             }\n-   | |_____________^ unnecessary `unsafe` block\n+15 |     unsafe {\n+   |     ------ because it's nested under this `unsafe` block\n+16 |         let f = |v: &mut Vec<_>| {\n+17 |             unsafe { //~ ERROR unnecessary `unsafe`\n+   |             ^^^^^^ unnecessary `unsafe` block\n    |\n note: lint level defined here\n   --> $DIR/issue-45107-unnecessary-unsafe-in-closure.rs:11:8\n    |\n 11 | #[deny(unused_unsafe)]\n    |        ^^^^^^^^^^^^^\n-note: because it's nested under this `unsafe` block\n-  --> $DIR/issue-45107-unnecessary-unsafe-in-closure.rs:15:5\n-   |\n-15 | /     unsafe {\n-16 | |         let f = |v: &mut Vec<_>| {\n-17 | |             unsafe { //~ ERROR unnecessary `unsafe`\n-18 | |                 v.set_len(24);\n-...  |\n-29 | |         f(&mut v);\n-30 | |     }\n-   | |_____^\n \n error: unnecessary `unsafe` block\n   --> $DIR/issue-45107-unnecessary-unsafe-in-closure.rs:19:38\n    |\n-19 |                   |w: &mut Vec<u32>| { unsafe { //~ ERROR unnecessary `unsafe`\n-   |  ______________________________________^\n-20 | |                     w.set_len(32);\n-21 | |                 } };\n-   | |_________________^ unnecessary `unsafe` block\n-   |\n-note: because it's nested under this `unsafe` block\n-  --> $DIR/issue-45107-unnecessary-unsafe-in-closure.rs:15:5\n-   |\n-15 | /     unsafe {\n-16 | |         let f = |v: &mut Vec<_>| {\n-17 | |             unsafe { //~ ERROR unnecessary `unsafe`\n-18 | |                 v.set_len(24);\n-...  |\n-29 | |         f(&mut v);\n-30 | |     }\n-   | |_____^\n+15 |     unsafe {\n+   |     ------ because it's nested under this `unsafe` block\n+...\n+19 |                 |w: &mut Vec<u32>| { unsafe { //~ ERROR unnecessary `unsafe`\n+   |                                      ^^^^^^ unnecessary `unsafe` block\n \n error: unnecessary `unsafe` block\n   --> $DIR/issue-45107-unnecessary-unsafe-in-closure.rs:23:34\n    |\n-23 |               |x: &mut Vec<u32>| { unsafe { //~ ERROR unnecessary `unsafe`\n-   |  __________________________________^\n-24 | |                 x.set_len(40);\n-25 | |             } };\n-   | |_____________^ unnecessary `unsafe` block\n-   |\n-note: because it's nested under this `unsafe` block\n-  --> $DIR/issue-45107-unnecessary-unsafe-in-closure.rs:15:5\n-   |\n-15 | /     unsafe {\n-16 | |         let f = |v: &mut Vec<_>| {\n-17 | |             unsafe { //~ ERROR unnecessary `unsafe`\n-18 | |                 v.set_len(24);\n-...  |\n-29 | |         f(&mut v);\n-30 | |     }\n-   | |_____^\n+15 |     unsafe {\n+   |     ------ because it's nested under this `unsafe` block\n+...\n+23 |             |x: &mut Vec<u32>| { unsafe { //~ ERROR unnecessary `unsafe`\n+   |                                  ^^^^^^ unnecessary `unsafe` block\n \n error: aborting due to 3 previous errors\n "}, {"sha": "8a8b104098e404adbc909761962d8100421a5a75", "filename": "src/test/ui/span/lint-unused-unsafe.stderr", "status": "modified", "additions": 22, "deletions": 65, "changes": 87, "blob_url": "https://github.com/rust-lang/rust/blob/e1dc7ac33ce2934d6053aa0e23a1ad2c410391ef/src%2Ftest%2Fui%2Fspan%2Flint-unused-unsafe.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/e1dc7ac33ce2934d6053aa0e23a1ad2c410391ef/src%2Ftest%2Fui%2Fspan%2Flint-unused-unsafe.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Fspan%2Flint-unused-unsafe.stderr?ref=e1dc7ac33ce2934d6053aa0e23a1ad2c410391ef", "patch": "@@ -2,7 +2,7 @@ error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:26:13\n    |\n 26 | fn bad1() { unsafe {} }                  //~ ERROR: unnecessary `unsafe` block\n-   |             ^^^^^^^^^ unnecessary `unsafe` block\n+   |             ^^^^^^ unnecessary `unsafe` block\n    |\n note: lint level defined here\n   --> $DIR/lint-unused-unsafe.rs:14:9\n@@ -14,97 +14,54 @@ error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:27:13\n    |\n 27 | fn bad2() { unsafe { bad1() } }          //~ ERROR: unnecessary `unsafe` block\n-   |             ^^^^^^^^^^^^^^^^^ unnecessary `unsafe` block\n+   |             ^^^^^^ unnecessary `unsafe` block\n \n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:28:20\n    |\n 28 | unsafe fn bad3() { unsafe {} }           //~ ERROR: unnecessary `unsafe` block\n-   |                    ^^^^^^^^^ unnecessary `unsafe` block\n-   |\n-note: because it's nested under this `unsafe` fn\n-  --> $DIR/lint-unused-unsafe.rs:28:1\n-   |\n-28 | unsafe fn bad3() { unsafe {} }           //~ ERROR: unnecessary `unsafe` block\n-   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   | ----------------   ^^^^^^ unnecessary `unsafe` block\n+   | |\n+   | because it's nested under this `unsafe` fn\n \n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:29:13\n    |\n 29 | fn bad4() { unsafe { callback(||{}) } }  //~ ERROR: unnecessary `unsafe` block\n-   |             ^^^^^^^^^^^^^^^^^^^^^^^^^ unnecessary `unsafe` block\n+   |             ^^^^^^ unnecessary `unsafe` block\n \n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:30:20\n    |\n 30 | unsafe fn bad5() { unsafe { unsf() } }   //~ ERROR: unnecessary `unsafe` block\n-   |                    ^^^^^^^^^^^^^^^^^ unnecessary `unsafe` block\n-   |\n-note: because it's nested under this `unsafe` fn\n-  --> $DIR/lint-unused-unsafe.rs:30:1\n-   |\n-30 | unsafe fn bad5() { unsafe { unsf() } }   //~ ERROR: unnecessary `unsafe` block\n-   | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+   | ----------------   ^^^^^^ unnecessary `unsafe` block\n+   | |\n+   | because it's nested under this `unsafe` fn\n \n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:33:9\n    |\n-33 | /         unsafe {                         //~ ERROR: unnecessary `unsafe` block\n-34 | |             unsf()\n-35 | |         }\n-   | |_________^ unnecessary `unsafe` block\n-   |\n-note: because it's nested under this `unsafe` block\n-  --> $DIR/lint-unused-unsafe.rs:32:5\n-   |\n-32 | /     unsafe {                             // don't put the warning here\n-33 | |         unsafe {                         //~ ERROR: unnecessary `unsafe` block\n-34 | |             unsf()\n-35 | |         }\n-36 | |     }\n-   | |_____^\n+32 |     unsafe {                             // don't put the warning here\n+   |     ------ because it's nested under this `unsafe` block\n+33 |         unsafe {                         //~ ERROR: unnecessary `unsafe` block\n+   |         ^^^^^^ unnecessary `unsafe` block\n \n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:39:5\n    |\n-39 | /     unsafe {                             //~ ERROR: unnecessary `unsafe` block\n-40 | |         unsafe {                         //~ ERROR: unnecessary `unsafe` block\n-41 | |             unsf()\n-42 | |         }\n-43 | |     }\n-   | |_____^ unnecessary `unsafe` block\n-   |\n-note: because it's nested under this `unsafe` fn\n-  --> $DIR/lint-unused-unsafe.rs:38:1\n-   |\n-38 | / unsafe fn bad7() {\n-39 | |     unsafe {                             //~ ERROR: unnecessary `unsafe` block\n-40 | |         unsafe {                         //~ ERROR: unnecessary `unsafe` block\n-41 | |             unsf()\n-42 | |         }\n-43 | |     }\n-44 | | }\n-   | |_^\n+38 | unsafe fn bad7() {\n+   | ---------------- because it's nested under this `unsafe` fn\n+39 |     unsafe {                             //~ ERROR: unnecessary `unsafe` block\n+   |     ^^^^^^ unnecessary `unsafe` block\n \n error: unnecessary `unsafe` block\n   --> $DIR/lint-unused-unsafe.rs:40:9\n    |\n-40 | /         unsafe {                         //~ ERROR: unnecessary `unsafe` block\n-41 | |             unsf()\n-42 | |         }\n-   | |_________^ unnecessary `unsafe` block\n-   |\n-note: because it's nested under this `unsafe` fn\n-  --> $DIR/lint-unused-unsafe.rs:38:1\n-   |\n-38 | / unsafe fn bad7() {\n-39 | |     unsafe {                             //~ ERROR: unnecessary `unsafe` block\n-40 | |         unsafe {                         //~ ERROR: unnecessary `unsafe` block\n-41 | |             unsf()\n-42 | |         }\n-43 | |     }\n-44 | | }\n-   | |_^\n+38 | unsafe fn bad7() {\n+   | ---------------- because it's nested under this `unsafe` fn\n+39 |     unsafe {                             //~ ERROR: unnecessary `unsafe` block\n+40 |         unsafe {                         //~ ERROR: unnecessary `unsafe` block\n+   |         ^^^^^^ unnecessary `unsafe` block\n \n error: aborting due to 8 previous errors\n "}]}