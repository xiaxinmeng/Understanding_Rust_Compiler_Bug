{"sha": "0fd174d5f1e51a03b6454617c780f2ea6cd4cb6b", "node_id": "MDY6Q29tbWl0NzI0NzEyOjBmZDE3NGQ1ZjFlNTFhMDNiNjQ1NDYxN2M3ODBmMmVhNmNkNGNiNmI=", "commit": {"author": {"name": "Seiichi Uchida", "email": "seuchida@gmail.com", "date": "2018-03-18T04:12:16Z"}, "committer": {"name": "topecongiro", "email": "seuchida@gmail.com", "date": "2018-03-18T23:23:53Z"}, "message": "Handle binary operators and lifetimes", "tree": {"sha": "3c08b9c3bf9273a4a8d039cccb4f6a32e14689c5", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/3c08b9c3bf9273a4a8d039cccb4f6a32e14689c5"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/0fd174d5f1e51a03b6454617c780f2ea6cd4cb6b", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/0fd174d5f1e51a03b6454617c780f2ea6cd4cb6b", "html_url": "https://github.com/rust-lang/rust/commit/0fd174d5f1e51a03b6454617c780f2ea6cd4cb6b", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/0fd174d5f1e51a03b6454617c780f2ea6cd4cb6b/comments", "author": {"login": "topecongiro", "id": 21980157, "node_id": "MDQ6VXNlcjIxOTgwMTU3", "avatar_url": "https://avatars.githubusercontent.com/u/21980157?v=4", "gravatar_id": "", "url": "https://api.github.com/users/topecongiro", "html_url": "https://github.com/topecongiro", "followers_url": "https://api.github.com/users/topecongiro/followers", "following_url": "https://api.github.com/users/topecongiro/following{/other_user}", "gists_url": "https://api.github.com/users/topecongiro/gists{/gist_id}", "starred_url": "https://api.github.com/users/topecongiro/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/topecongiro/subscriptions", "organizations_url": "https://api.github.com/users/topecongiro/orgs", "repos_url": "https://api.github.com/users/topecongiro/repos", "events_url": "https://api.github.com/users/topecongiro/events{/privacy}", "received_events_url": "https://api.github.com/users/topecongiro/received_events", "type": "User", "site_admin": false}, "committer": {"login": "topecongiro", "id": 21980157, "node_id": "MDQ6VXNlcjIxOTgwMTU3", "avatar_url": "https://avatars.githubusercontent.com/u/21980157?v=4", "gravatar_id": "", "url": "https://api.github.com/users/topecongiro", "html_url": "https://github.com/topecongiro", "followers_url": "https://api.github.com/users/topecongiro/followers", "following_url": "https://api.github.com/users/topecongiro/following{/other_user}", "gists_url": "https://api.github.com/users/topecongiro/gists{/gist_id}", "starred_url": "https://api.github.com/users/topecongiro/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/topecongiro/subscriptions", "organizations_url": "https://api.github.com/users/topecongiro/orgs", "repos_url": "https://api.github.com/users/topecongiro/repos", "events_url": "https://api.github.com/users/topecongiro/events{/privacy}", "received_events_url": "https://api.github.com/users/topecongiro/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "3f7b59ca2b3f3eaa5659743dfa28dce9f7302a74", "url": "https://api.github.com/repos/rust-lang/rust/commits/3f7b59ca2b3f3eaa5659743dfa28dce9f7302a74", "html_url": "https://github.com/rust-lang/rust/commit/3f7b59ca2b3f3eaa5659743dfa28dce9f7302a74"}], "stats": {"total": 32, "additions": 27, "deletions": 5}, "files": [{"sha": "9b5fda2c1ec76b5dec7394be38d2ccf2858c5542", "filename": "src/macros.rs", "status": "modified", "additions": 13, "deletions": 5, "changes": 18, "blob_url": "https://github.com/rust-lang/rust/blob/0fd174d5f1e51a03b6454617c780f2ea6cd4cb6b/src%2Fmacros.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0fd174d5f1e51a03b6454617c780f2ea6cd4cb6b/src%2Fmacros.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Fmacros.rs?ref=0fd174d5f1e51a03b6454617c780f2ea6cd4cb6b", "patch": "@@ -669,8 +669,16 @@ impl MacroArgParser {\n         if self.buf.is_empty() {\n             self.lo = lo;\n             self.start_tok = t.clone();\n-        } else if force_space_before(t) {\n-            self.buf.push(' ');\n+        } else {\n+            let needs_space = match next_space(&self.last_tok) {\n+                SpaceState::Ident => ident_like(t),\n+                SpaceState::Punctuation => !ident_like(t),\n+                SpaceState::Always => true,\n+                SpaceState::Never => false,\n+            };\n+            if force_space_before(t) || needs_space {\n+                self.buf.push(' ');\n+            }\n         }\n \n         self.buf.push_str(&pprust::token_to_string(t));\n@@ -888,9 +896,9 @@ fn force_space_before(tok: &Token) -> bool {\n         | Token::RArrow\n         | Token::LArrow\n         | Token::FatArrow\n+        | Token::BinOp(_)\n         | Token::Pound\n         | Token::Dollar => true,\n-        Token::BinOp(bot) => bot != BinOpToken::Star,\n         _ => false,\n     }\n }\n@@ -907,6 +915,7 @@ fn next_space(tok: &Token) -> SpaceState {\n \n     match *tok {\n         Token::Not\n+        | Token::BinOp(BinOpToken::And)\n         | Token::Tilde\n         | Token::At\n         | Token::Comma\n@@ -916,8 +925,7 @@ fn next_space(tok: &Token) -> SpaceState {\n         | Token::DotDotEq\n         | Token::DotEq\n         | Token::Question\n-        | Token::Underscore\n-        | Token::BinOp(_) => SpaceState::Punctuation,\n+        | Token::Underscore => SpaceState::Punctuation,\n \n         Token::ModSep\n         | Token::Pound"}, {"sha": "1a4d81316002d107ddbb703d1b4d8a4e44ef4e4c", "filename": "tests/source/macro_rules.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/0fd174d5f1e51a03b6454617c780f2ea6cd4cb6b/tests%2Fsource%2Fmacro_rules.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0fd174d5f1e51a03b6454617c780f2ea6cd4cb6b/tests%2Fsource%2Fmacro_rules.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Fsource%2Fmacro_rules.rs?ref=0fd174d5f1e51a03b6454617c780f2ea6cd4cb6b", "patch": "@@ -10,6 +10,13 @@ macro_rules! m {\n     ( $( $ i : ident : $ ty : ty , $def : expr , $stb : expr , $ ( $ dstring : tt ) , + ) ; + $ ( ; ) *\n       $( $ i : ident : $ ty : ty , $def : expr , $stb : expr , $ ( $ dstring : tt ) , + ) ; + $ ( ; ) *\n     ) => {};\n+    ( $foo: tt foo [$ attr : meta] $name: ident ) => {};\n+    ( $foo: tt [$ attr: meta] $name: ident ) => {};\n+    ( $foo: tt &'a [$attr : meta] $name: ident ) => {};\n+    ( $foo: tt foo # [ $attr : meta] $name: ident ) => {};\n+    ( $foo: tt # [ $attr : meta] $name: ident) => {};\n+    ( $foo: tt &'a # [ $attr : meta] $name: ident ) => {};\n+    ( $ x : tt foo bar foo bar foo bar $ y : tt => x*y*z $ z : tt , $ ( $a: tt ) , * ) => {};\n }\n \n macro_rules! m {"}, {"sha": "ece1639918486d0cf9977cc0c3caa0bef742e87f", "filename": "tests/target/macro_rules.rs", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/0fd174d5f1e51a03b6454617c780f2ea6cd4cb6b/tests%2Ftarget%2Fmacro_rules.rs", "raw_url": "https://github.com/rust-lang/rust/raw/0fd174d5f1e51a03b6454617c780f2ea6cd4cb6b/tests%2Ftarget%2Fmacro_rules.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/tests%2Ftarget%2Fmacro_rules.rs?ref=0fd174d5f1e51a03b6454617c780f2ea6cd4cb6b", "patch": "@@ -18,6 +18,13 @@ macro_rules! m {\n         $($i: ident: $ty: ty, $def: expr, $stb: expr, $($dstring: tt),+);+ $(;)*\n         $($i: ident: $ty: ty, $def: expr, $stb: expr, $($dstring: tt),+);+ $(;)*\n     ) => {};\n+    ($foo: tt foo[$attr: meta] $name: ident) => {};\n+    ($foo: tt[$attr: meta] $name: ident) => {};\n+    ($foo: tt &'a[$attr: meta] $name: ident) => {};\n+    ($foo: tt foo #[$attr: meta] $name: ident) => {};\n+    ($foo: tt #[$attr: meta] $name: ident) => {};\n+    ($foo: tt &'a #[$attr: meta] $name: ident) => {};\n+    ($x: tt foo bar foo bar foo bar $y: tt => x * y * z $z: tt, $($a: tt),*) => {};\n }\n \n macro_rules! m {"}]}