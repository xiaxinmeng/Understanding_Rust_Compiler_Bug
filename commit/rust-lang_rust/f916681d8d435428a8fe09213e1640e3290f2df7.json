{"sha": "f916681d8d435428a8fe09213e1640e3290f2df7", "node_id": "C_kwDOAAsO6NoAKGY5MTY2ODFkOGQ0MzU0MjhhOGZlMDkyMTNlMTY0MGUzMjkwZjJkZjc", "commit": {"author": {"name": "Michael Howell", "email": "michael@notriddle.com", "date": "2023-01-15T18:34:58Z"}, "committer": {"name": "Michael Howell", "email": "michael@notriddle.com", "date": "2023-03-08T19:49:34Z"}, "message": "Only load one CSS theme by default\n\nTo avoid generating a FOUC at startup, this commit uses `document.write` to\nload the stylesheet initially.\n\nCo-Authored-By: Guillaume Gomez <guillaume1.gomez@gmail.com>", "tree": {"sha": "e65e73370c02d26644d652c347e801f84af98601", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/e65e73370c02d26644d652c347e801f84af98601"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/f916681d8d435428a8fe09213e1640e3290f2df7", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/f916681d8d435428a8fe09213e1640e3290f2df7", "html_url": "https://github.com/rust-lang/rust/commit/f916681d8d435428a8fe09213e1640e3290f2df7", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/f916681d8d435428a8fe09213e1640e3290f2df7/comments", "author": {"login": "notriddle", "id": 1593513, "node_id": "MDQ6VXNlcjE1OTM1MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1593513?v=4", "gravatar_id": "", "url": "https://api.github.com/users/notriddle", "html_url": "https://github.com/notriddle", "followers_url": "https://api.github.com/users/notriddle/followers", "following_url": "https://api.github.com/users/notriddle/following{/other_user}", "gists_url": "https://api.github.com/users/notriddle/gists{/gist_id}", "starred_url": "https://api.github.com/users/notriddle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/notriddle/subscriptions", "organizations_url": "https://api.github.com/users/notriddle/orgs", "repos_url": "https://api.github.com/users/notriddle/repos", "events_url": "https://api.github.com/users/notriddle/events{/privacy}", "received_events_url": "https://api.github.com/users/notriddle/received_events", "type": "User", "site_admin": false}, "committer": {"login": "notriddle", "id": 1593513, "node_id": "MDQ6VXNlcjE1OTM1MTM=", "avatar_url": "https://avatars.githubusercontent.com/u/1593513?v=4", "gravatar_id": "", "url": "https://api.github.com/users/notriddle", "html_url": "https://github.com/notriddle", "followers_url": "https://api.github.com/users/notriddle/followers", "following_url": "https://api.github.com/users/notriddle/following{/other_user}", "gists_url": "https://api.github.com/users/notriddle/gists{/gist_id}", "starred_url": "https://api.github.com/users/notriddle/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/notriddle/subscriptions", "organizations_url": "https://api.github.com/users/notriddle/orgs", "repos_url": "https://api.github.com/users/notriddle/repos", "events_url": "https://api.github.com/users/notriddle/events{/privacy}", "received_events_url": "https://api.github.com/users/notriddle/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7c306f6dcd600b1fcc74439c780e8ebef338d84c", "url": "https://api.github.com/repos/rust-lang/rust/commits/7c306f6dcd600b1fcc74439c780e8ebef338d84c", "html_url": "https://github.com/rust-lang/rust/commit/7c306f6dcd600b1fcc74439c780e8ebef338d84c"}], "stats": {"total": 152, "additions": 99, "deletions": 53}, "files": [{"sha": "ea5a4590f337f17318925798e9383ce14a7f625a", "filename": "src/librustdoc/html/render/context.rs", "status": "modified", "additions": 26, "deletions": 2, "changes": 28, "blob_url": "https://github.com/rust-lang/rust/blob/f916681d8d435428a8fe09213e1640e3290f2df7/src%2Flibrustdoc%2Fhtml%2Frender%2Fcontext.rs", "raw_url": "https://github.com/rust-lang/rust/raw/f916681d8d435428a8fe09213e1640e3290f2df7/src%2Flibrustdoc%2Fhtml%2Frender%2Fcontext.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Frender%2Fcontext.rs?ref=f916681d8d435428a8fe09213e1640e3290f2df7", "patch": "@@ -649,11 +649,35 @@ impl<'tcx> FormatRenderer<'tcx> for Context<'tcx> {\n                      </noscript>\\\n                      <link rel=\\\"stylesheet\\\" \\\n                          href=\\\"{static_root_path}{settings_css}\\\">\\\n-                     <script defer src=\\\"{static_root_path}{settings_js}\\\"></script>\",\n+                     <script defer src=\\\"{static_root_path}{settings_js}\\\"></script>\\\n+                     <link rel=\\\"preload\\\" href=\\\"{static_root_path}{theme_light_css}\\\" \\\n+                         as=\\\"style\\\">\\\n+                     <link rel=\\\"preload\\\" href=\\\"{static_root_path}{theme_dark_css}\\\" \\\n+                         as=\\\"style\\\">\\\n+                     <link rel=\\\"preload\\\" href=\\\"{static_root_path}{theme_ayu_css}\\\" \\\n+                         as=\\\"style\\\">\",\n                     static_root_path = page.get_static_root_path(),\n                     settings_css = static_files::STATIC_FILES.settings_css,\n                     settings_js = static_files::STATIC_FILES.settings_js,\n-                )\n+                    theme_light_css = static_files::STATIC_FILES.theme_light_css,\n+                    theme_dark_css = static_files::STATIC_FILES.theme_dark_css,\n+                    theme_ayu_css = static_files::STATIC_FILES.theme_ayu_css,\n+                );\n+                // Pre-load all theme CSS files, so that switching feels seamless.\n+                //\n+                // When loading settings.html as a popover, the equivalent HTML is\n+                // generated in main.js.\n+                for file in &shared.style_files {\n+                    if let Ok(theme) = file.basename() {\n+                        write!(\n+                            buf,\n+                            \"<link rel=\\\"preload\\\" href=\\\"{root_path}{theme}{suffix}.css\\\" \\\n+                                as=\\\"style\\\">\",\n+                            root_path = page.static_root_path.unwrap_or(\"\"),\n+                            suffix = page.resource_suffix,\n+                        );\n+                    }\n+                }\n             },\n             &shared.style_files,\n         );"}, {"sha": "403b5004d6558a46f522bc442ad149701efc524c", "filename": "src/librustdoc/html/static/js/main.js", "status": "modified", "additions": 27, "deletions": 12, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/f916681d8d435428a8fe09213e1640e3290f2df7/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fmain.js", "raw_url": "https://github.com/rust-lang/rust/raw/f916681d8d435428a8fe09213e1640e3290f2df7/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fmain.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fmain.js?ref=f916681d8d435428a8fe09213e1640e3290f2df7", "patch": "@@ -1,20 +1,9 @@\n // Local js definitions:\n /* global addClass, getSettingValue, hasClass, searchState */\n-/* global onEach, onEachLazy, removeClass */\n+/* global onEach, onEachLazy, removeClass, getVar */\n \n \"use strict\";\n \n-// Get a value from the rustdoc-vars div, which is used to convey data from\n-// Rust to the JS. If there is no such element, return null.\n-function getVar(name) {\n-    const el = document.getElementById(\"rustdoc-vars\");\n-    if (el) {\n-        return el.attributes[\"data-\" + name].value;\n-    } else {\n-        return null;\n-    }\n-}\n-\n // Given a basename (e.g. \"storage\") and an extension (e.g. \".js\"), return a URL\n // for a resource under the root-path, with the resource-suffix.\n function resourcePath(basename, extension) {\n@@ -187,6 +176,15 @@ function loadCss(cssUrl) {\n     document.getElementsByTagName(\"head\")[0].appendChild(link);\n }\n \n+function preLoadCss(cssUrl) {\n+    // https://developer.mozilla.org/en-US/docs/Web/HTML/Link_types/preload\n+    const link = document.createElement(\"link\");\n+    link.href = cssUrl;\n+    link.rel = \"preload\";\n+    link.as = \"style\";\n+    document.getElementsByTagName(\"head\")[0].appendChild(link);\n+}\n+\n (function() {\n     const isHelpPage = window.location.pathname.endsWith(\"/help.html\");\n \n@@ -207,6 +205,23 @@ function loadCss(cssUrl) {\n         // hopefully be loaded when the JS will generate the settings content.\n         loadCss(getVar(\"static-root-path\") + getVar(\"settings-css\"));\n         loadScript(getVar(\"static-root-path\") + getVar(\"settings-js\"));\n+        preLoadCss(getVar(\"static-root-path\") + getVar(\"theme-light-css\"));\n+        preLoadCss(getVar(\"static-root-path\") + getVar(\"theme-dark-css\"));\n+        preLoadCss(getVar(\"static-root-path\") + getVar(\"theme-ayu-css\"));\n+        // Pre-load all theme CSS files, so that switching feels seamless.\n+        //\n+        // When loading settings.html as a standalone page, the equivalent HTML is\n+        // generated in context.rs.\n+        setTimeout(() => {\n+            const themes = getVar(\"themes\").split(\",\");\n+            for (const theme of themes) {\n+                // if there are no themes, do nothing\n+                // \"\".split(\",\") == [\"\"]\n+                if (theme !== \"\") {\n+                    preLoadCss(getVar(\"root-path\") + theme + \".css\");\n+                }\n+            }\n+        }, 0);\n     };\n \n     window.searchState = {"}, {"sha": "1e16f34a3eb5ff1d7ee2b070dc328fe02747d69b", "filename": "src/librustdoc/html/static/js/storage.js", "status": "modified", "additions": 25, "deletions": 21, "changes": 46, "blob_url": "https://github.com/rust-lang/rust/blob/f916681d8d435428a8fe09213e1640e3290f2df7/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fstorage.js", "raw_url": "https://github.com/rust-lang/rust/raw/f916681d8d435428a8fe09213e1640e3290f2df7/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fstorage.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fstorage.js?ref=f916681d8d435428a8fe09213e1640e3290f2df7", "patch": "@@ -7,7 +7,6 @@\n \n const darkThemes = [\"dark\", \"ayu\"];\n window.currentTheme = document.getElementById(\"themeStyle\");\n-window.mainTheme = document.getElementById(\"mainThemeStyle\");\n \n // WARNING: RUSTDOC_MOBILE_BREAKPOINT MEDIA QUERY\n // If you update this line, then you also need to update the media query with the same\n@@ -44,8 +43,6 @@ function getSettingValue(settingName) {\n \n const localStoredTheme = getSettingValue(\"theme\");\n \n-const savedHref = [];\n-\n // eslint-disable-next-line no-unused-vars\n function hasClass(elem, className) {\n     return elem && elem.classList && elem.classList.contains(className);\n@@ -125,30 +122,37 @@ function getCurrentValue(name) {\n     }\n }\n \n-function switchTheme(styleElem, mainStyleElem, newThemeName, saveTheme) {\n+// Get a value from the rustdoc-vars div, which is used to convey data from\n+// Rust to the JS. If there is no such element, return null.\n+const getVar = (function getVar(name) {\n+    const el = document.getElementById(\"rustdoc-vars\");\n+    if (el) {\n+        return el.attributes[\"data-\" + name].value;\n+    } else {\n+        return null;\n+    }\n+});\n+\n+function switchTheme(newThemeName, saveTheme) {\n     // If this new value comes from a system setting or from the previously\n     // saved theme, no need to save it.\n     if (saveTheme) {\n         updateLocalStorage(\"theme\", newThemeName);\n     }\n \n-    if (savedHref.length === 0) {\n-        onEachLazy(document.getElementsByTagName(\"link\"), el => {\n-            savedHref.push(el.href);\n-        });\n+    let newHref;\n+\n+    if (newThemeName === \"light\" || newThemeName === \"dark\" || newThemeName === \"ayu\") {\n+        newHref = getVar(\"static-root-path\") + getVar(\"theme-\" + newThemeName + \"-css\");\n+    } else {\n+        newHref = getVar(\"root-path\") + newThemeName + getVar(\"resource-suffix\") + \".css\";\n     }\n-    const newHref = savedHref.find(url => {\n-        const m = url.match(/static\\.files\\/(.*)-[a-f0-9]{16}\\.css$/);\n-        if (m && m[1] === newThemeName) {\n-            return true;\n-        }\n-        const m2 = url.match(/\\/([^/]*)\\.css$/);\n-        if (m2 && m2[1].startsWith(newThemeName)) {\n-            return true;\n-        }\n-    });\n-    if (newHref && newHref !== styleElem.href) {\n-        styleElem.href = newHref;\n+\n+    if (!window.currentTheme) {\n+        document.write(\"<link rel=\\\"stylesheet\\\" id=\\\"themeStyle\\\" href=\\\"\" + newHref + \"\\\">\");\n+        window.currentTheme = document.getElementById(\"themeStyle\");\n+    } else if (newHref !== window.currentTheme.href) {\n+        window.currentTheme.href = newHref;\n     }\n }\n \n@@ -164,7 +168,7 @@ const updateTheme = (function() {\n      */\n     function updateTheme() {\n         const use = (theme, saveTheme) => {\n-            switchTheme(window.currentTheme, window.mainTheme, theme, saveTheme);\n+            switchTheme(theme, saveTheme);\n         };\n \n         // maybe the user has disabled the setting in the meantime!"}, {"sha": "532660e3d33c73bf200b6a4b4af0cd060ab07466", "filename": "src/librustdoc/html/templates/page.html", "status": "modified", "additions": 21, "deletions": 18, "changes": 39, "blob_url": "https://github.com/rust-lang/rust/blob/f916681d8d435428a8fe09213e1640e3290f2df7/src%2Flibrustdoc%2Fhtml%2Ftemplates%2Fpage.html", "raw_url": "https://github.com/rust-lang/rust/raw/f916681d8d435428a8fe09213e1640e3290f2df7/src%2Flibrustdoc%2Fhtml%2Ftemplates%2Fpage.html", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Ftemplates%2Fpage.html?ref=f916681d8d435428a8fe09213e1640e3290f2df7", "patch": "@@ -17,19 +17,28 @@\n     <link rel=\"stylesheet\" {#+ #}\n           href=\"{{static_root_path|safe}}{{files.rustdoc_css}}\" {#+ #}\n           id=\"mainThemeStyle\"> {# #}\n-    <link rel=\"stylesheet\" id=\"themeStyle\" href=\"{{static_root_path|safe}}{{files.theme_light_css}}\"> {# #}\n-    <link rel=\"stylesheet\" disabled href=\"{{static_root_path|safe}}{{files.theme_dark_css}}\"> {# #}\n-    <link rel=\"stylesheet\" disabled href=\"{{static_root_path|safe}}{{files.theme_ayu_css}}\"> {# #}\n-    {% for theme in themes %}\n-        <link rel=\"stylesheet\" disabled href=\"{{page.root_path|safe}}{{theme}}{{page.resource_suffix}}.css\"> {# #}\n-    {% endfor %}\n     {% if !layout.default_settings.is_empty() %}\n     <script id=\"default-settings\" {#+ #}\n       {%~ for (k, v) in layout.default_settings ~%}\n         data-{{k}}=\"{{v}}\"\n       {% endfor %}\n     ></script> {# #}\n     {% endif %}\n+    <div id=\"rustdoc-vars\" {#+ #}\n+         data-root-path=\"{{page.root_path|safe}}\" {#+ #}\n+         data-static-root-path=\"{{static_root_path|safe}}\" {#+ #}\n+         data-current-crate=\"{{layout.krate}}\" {#+ #}\n+         data-themes=\"{{themes|join(\",\") }}\" {#+ #}\n+         data-resource-suffix=\"{{page.resource_suffix}}\" {#+ #}\n+         data-rustdoc-version=\"{{rustdoc_version}}\" {#+ #}\n+         data-search-js=\"{{files.search_js}}\" {#+ #}\n+         data-settings-js=\"{{files.settings_js}}\" {#+ #}\n+         data-settings-css=\"{{files.settings_css}}\" {#+ #}\n+         data-theme-light-css=\"{{files.theme_light_css}}\" {#+ #}\n+         data-theme-dark-css=\"{{files.theme_dark_css}}\" {#+ #}\n+         data-theme-ayu-css=\"{{files.theme_ayu_css}}\" {#+ #}\n+    > {# #}\n+    </div> {# #}\n     <script src=\"{{static_root_path|safe}}{{files.storage_js}}\"></script> {# #}\n     {% if page.css_class.contains(\"crate\") %}\n     <script defer src=\"{{page.root_path|safe}}crates{{page.resource_suffix}}.js\"></script> {# #}\n@@ -44,6 +53,12 @@\n     <script defer src=\"{{static_root_path|safe}}{{files.scrape_examples_js}}\"></script> {# #}\n     {% endif %}\n     <noscript> {# #}\n+        <link rel=\"stylesheet\" {#+ #}\n+           media=\"(prefers-color-scheme:light)\" {#+ #}\n+           href=\"{{static_root_path|safe}}{{files.theme_light_css}}\"> {# #}\n+        <link rel=\"stylesheet\" {#+ #}\n+           media=\"(prefers-color-scheme:dark)\" {#+ #}\n+           href=\"{{static_root_path|safe}}{{files.theme_dark_css}}\"> {# #}\n         <link rel=\"stylesheet\" {#+ #}\n            href=\"{{static_root_path|safe}}{{files.noscript_css}}\"> {# #}\n     </noscript> {# #}\n@@ -132,17 +147,5 @@ <h2></h2> {# #}\n         {% if page.css_class != \"source\" %}</div>{% endif %}\n     </main> {# #}\n     {{ layout.external_html.after_content|safe }}\n-    <div id=\"rustdoc-vars\" {#+ #}\n-         data-root-path=\"{{page.root_path|safe}}\" {#+ #}\n-         data-static-root-path=\"{{static_root_path|safe}}\" {#+ #}\n-         data-current-crate=\"{{layout.krate}}\" {#+ #}\n-         data-themes=\"{{themes|join(\",\") }}\" {#+ #}\n-         data-resource-suffix=\"{{page.resource_suffix}}\" {#+ #}\n-         data-rustdoc-version=\"{{rustdoc_version}}\" {#+ #}\n-         data-search-js=\"{{files.search_js}}\" {#+ #}\n-         data-settings-js=\"{{files.settings_js}}\" {#+ #}\n-         data-settings-css=\"{{files.settings_css}}\" {#+ #}\n-    > {# #}\n-    </div> {# #}\n </body> {# #}\n </html> {# #}"}]}