{"sha": "899f27d272a42dd1fb8ee7fe3db0fbb35b2fb3fa", "node_id": "MDY6Q29tbWl0NzI0NzEyOjg5OWYyN2QyNzJhNDJkZDFmYjhlZTdmZTNkYjBmYmIzNWIyZmIzZmE=", "commit": {"author": {"name": "kadmin", "email": "julianknodt@gmail.com", "date": "2020-12-28T20:17:35Z"}, "committer": {"name": "kadmin", "email": "julianknodt@gmail.com", "date": "2021-02-23T07:16:42Z"}, "message": "Small optimizations to obligation forest", "tree": {"sha": "64b6960e9281e23a6d2a48e87dce61ec0fdc7590", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/64b6960e9281e23a6d2a48e87dce61ec0fdc7590"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/899f27d272a42dd1fb8ee7fe3db0fbb35b2fb3fa", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/899f27d272a42dd1fb8ee7fe3db0fbb35b2fb3fa", "html_url": "https://github.com/rust-lang/rust/commit/899f27d272a42dd1fb8ee7fe3db0fbb35b2fb3fa", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/899f27d272a42dd1fb8ee7fe3db0fbb35b2fb3fa/comments", "author": {"login": "JulianKnodt", "id": 7675847, "node_id": "MDQ6VXNlcjc2NzU4NDc=", "avatar_url": "https://avatars.githubusercontent.com/u/7675847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JulianKnodt", "html_url": "https://github.com/JulianKnodt", "followers_url": "https://api.github.com/users/JulianKnodt/followers", "following_url": "https://api.github.com/users/JulianKnodt/following{/other_user}", "gists_url": "https://api.github.com/users/JulianKnodt/gists{/gist_id}", "starred_url": "https://api.github.com/users/JulianKnodt/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JulianKnodt/subscriptions", "organizations_url": "https://api.github.com/users/JulianKnodt/orgs", "repos_url": "https://api.github.com/users/JulianKnodt/repos", "events_url": "https://api.github.com/users/JulianKnodt/events{/privacy}", "received_events_url": "https://api.github.com/users/JulianKnodt/received_events", "type": "User", "site_admin": false}, "committer": {"login": "JulianKnodt", "id": 7675847, "node_id": "MDQ6VXNlcjc2NzU4NDc=", "avatar_url": "https://avatars.githubusercontent.com/u/7675847?v=4", "gravatar_id": "", "url": "https://api.github.com/users/JulianKnodt", "html_url": "https://github.com/JulianKnodt", "followers_url": "https://api.github.com/users/JulianKnodt/followers", "following_url": "https://api.github.com/users/JulianKnodt/following{/other_user}", "gists_url": "https://api.github.com/users/JulianKnodt/gists{/gist_id}", "starred_url": "https://api.github.com/users/JulianKnodt/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/JulianKnodt/subscriptions", "organizations_url": "https://api.github.com/users/JulianKnodt/orgs", "repos_url": "https://api.github.com/users/JulianKnodt/repos", "events_url": "https://api.github.com/users/JulianKnodt/events{/privacy}", "received_events_url": "https://api.github.com/users/JulianKnodt/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b02a6193b370ff7c3cb46d713afd990f134e547e", "url": "https://api.github.com/repos/rust-lang/rust/commits/b02a6193b370ff7c3cb46d713afd990f134e547e", "html_url": "https://github.com/rust-lang/rust/commit/b02a6193b370ff7c3cb46d713afd990f134e547e"}], "stats": {"total": 45, "additions": 25, "deletions": 20}, "files": [{"sha": "bb7fc661d2d8a193411b0c5e0609b35aea721c83", "filename": "compiler/rustc_middle/src/ty/walk.rs", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/899f27d272a42dd1fb8ee7fe3db0fbb35b2fb3fa/compiler%2Frustc_middle%2Fsrc%2Fty%2Fwalk.rs", "raw_url": "https://github.com/rust-lang/rust/raw/899f27d272a42dd1fb8ee7fe3db0fbb35b2fb3fa/compiler%2Frustc_middle%2Fsrc%2Fty%2Fwalk.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_middle%2Fsrc%2Fty%2Fwalk.rs?ref=899f27d272a42dd1fb8ee7fe3db0fbb35b2fb3fa", "patch": "@@ -13,7 +13,7 @@ type TypeWalkerStack<'tcx> = SmallVec<[GenericArg<'tcx>; 8]>;\n pub struct TypeWalker<'tcx> {\n     stack: TypeWalkerStack<'tcx>,\n     last_subtree: usize,\n-    visited: SsoHashSet<GenericArg<'tcx>>,\n+    pub visited: SsoHashSet<GenericArg<'tcx>>,\n }\n \n /// An iterator for walking the type tree."}, {"sha": "3c447a7d1f9bbb6fe49b54343e6c2fcadbeb5c20", "filename": "compiler/rustc_trait_selection/src/traits/fulfill.rs", "status": "modified", "additions": 24, "deletions": 19, "changes": 43, "blob_url": "https://github.com/rust-lang/rust/blob/899f27d272a42dd1fb8ee7fe3db0fbb35b2fb3fa/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ffulfill.rs", "raw_url": "https://github.com/rust-lang/rust/raw/899f27d272a42dd1fb8ee7fe3db0fbb35b2fb3fa/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ffulfill.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_trait_selection%2Fsrc%2Ftraits%2Ffulfill.rs?ref=899f27d272a42dd1fb8ee7fe3db0fbb35b2fb3fa", "patch": "@@ -499,10 +499,10 @@ impl<'a, 'b, 'tcx> FulfillProcessor<'a, 'b, 'tcx> {\n                     ) {\n                         Ok(()) => ProcessResult::Changed(vec![]),\n                         Err(ErrorHandled::TooGeneric) => {\n-                            pending_obligation.stalled_on = substs\n-                                .iter()\n-                                .filter_map(TyOrConstInferVar::maybe_from_generic_arg)\n-                                .collect();\n+                            pending_obligation.stalled_on.clear();\n+                            pending_obligation.stalled_on.extend(\n+                                substs.iter().filter_map(TyOrConstInferVar::maybe_from_generic_arg),\n+                            );\n                             ProcessResult::Unchanged\n                         }\n                         Err(e) => ProcessResult::Error(CodeSelectionError(ConstEvalFailure(e))),\n@@ -544,13 +544,10 @@ impl<'a, 'b, 'tcx> FulfillProcessor<'a, 'b, 'tcx> {\n                             ) {\n                                 Ok(val) => Ok(Const::from_value(self.selcx.tcx(), val, c.ty)),\n                                 Err(ErrorHandled::TooGeneric) => {\n-                                    stalled_on.append(\n-                                        &mut substs\n+                                    stalled_on.extend(\n+                                        substs\n                                             .iter()\n-                                            .filter_map(|arg| {\n-                                                TyOrConstInferVar::maybe_from_generic_arg(arg)\n-                                            })\n-                                            .collect(),\n+                                            .filter_map(TyOrConstInferVar::maybe_from_generic_arg),\n                                     );\n                                     Err(ErrorHandled::TooGeneric)\n                                 }\n@@ -634,10 +631,11 @@ impl<'a, 'b, 'tcx> FulfillProcessor<'a, 'b, 'tcx> {\n                 // only reason we can fail to make progress on\n                 // trait selection is because we don't have enough\n                 // information about the types in the trait.\n-                *stalled_on = substs_infer_vars(\n+                stalled_on.clear();\n+                stalled_on.extend(substs_infer_vars(\n                     self.selcx,\n                     trait_obligation.predicate.map_bound(|pred| pred.trait_ref.substs),\n-                );\n+                ));\n \n                 debug!(\n                     \"process_predicate: pending obligation {:?} now stalled on {:?}\",\n@@ -664,10 +662,11 @@ impl<'a, 'b, 'tcx> FulfillProcessor<'a, 'b, 'tcx> {\n         match project::poly_project_and_unify_type(self.selcx, &project_obligation) {\n             Ok(Ok(Some(os))) => ProcessResult::Changed(mk_pending(os)),\n             Ok(Ok(None)) => {\n-                *stalled_on = substs_infer_vars(\n+                stalled_on.clear();\n+                stalled_on.extend(substs_infer_vars(\n                     self.selcx,\n                     project_obligation.predicate.map_bound(|pred| pred.projection_ty.substs),\n-                );\n+                ));\n                 ProcessResult::Unchanged\n             }\n             // Let the caller handle the recursion\n@@ -683,18 +682,24 @@ impl<'a, 'b, 'tcx> FulfillProcessor<'a, 'b, 'tcx> {\n fn substs_infer_vars<'a, 'tcx>(\n     selcx: &mut SelectionContext<'a, 'tcx>,\n     substs: ty::Binder<SubstsRef<'tcx>>,\n-) -> Vec<TyOrConstInferVar<'tcx>> {\n+) -> impl Iterator<Item = TyOrConstInferVar<'tcx>> {\n     selcx\n         .infcx()\n         .resolve_vars_if_possible(substs)\n         .skip_binder() // ok because this check doesn't care about regions\n         .iter()\n-        // FIXME(eddyb) try using `skip_current_subtree` to skip everything that\n-        // doesn't contain inference variables, not just the outermost level.\n         .filter(|arg| arg.has_infer_types_or_consts())\n-        .flat_map(|arg| arg.walk())\n+        .flat_map(|arg| {\n+            let mut walker = arg.walk();\n+            while let Some(c) = walker.next() {\n+                if !c.has_infer_types_or_consts() {\n+                    walker.visited.remove(&c);\n+                    walker.skip_current_subtree();\n+                }\n+            }\n+            walker.visited.into_iter()\n+        })\n         .filter_map(TyOrConstInferVar::maybe_from_generic_arg)\n-        .collect()\n }\n \n fn to_fulfillment_error<'tcx>("}]}