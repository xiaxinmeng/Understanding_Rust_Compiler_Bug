{"sha": "7a2490eba3f161c81ad243c7d957b337dd70a2af", "node_id": "C_kwDOAAsO6NoAKDdhMjQ5MGViYTNmMTYxYzgxYWQyNDNjN2Q5NTdiMzM3ZGQ3MGEyYWY", "commit": {"author": {"name": "Ben Kimock", "email": "kimockb@gmail.com", "date": "2023-06-13T22:25:15Z"}, "committer": {"name": "Ben Kimock", "email": "kimockb@gmail.com", "date": "2023-06-16T13:20:33Z"}, "message": "Launch a non-unwinding panic for misaligned pointer deref", "tree": {"sha": "a6a98955d8285cecb16912a6166637f0d3610321", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/a6a98955d8285cecb16912a6166637f0d3610321"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/7a2490eba3f161c81ad243c7d957b337dd70a2af", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/7a2490eba3f161c81ad243c7d957b337dd70a2af", "html_url": "https://github.com/rust-lang/rust/commit/7a2490eba3f161c81ad243c7d957b337dd70a2af", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/7a2490eba3f161c81ad243c7d957b337dd70a2af/comments", "author": {"login": "saethlin", "id": 12105168, "node_id": "MDQ6VXNlcjEyMTA1MTY4", "avatar_url": "https://avatars.githubusercontent.com/u/12105168?v=4", "gravatar_id": "", "url": "https://api.github.com/users/saethlin", "html_url": "https://github.com/saethlin", "followers_url": "https://api.github.com/users/saethlin/followers", "following_url": "https://api.github.com/users/saethlin/following{/other_user}", "gists_url": "https://api.github.com/users/saethlin/gists{/gist_id}", "starred_url": "https://api.github.com/users/saethlin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/saethlin/subscriptions", "organizations_url": "https://api.github.com/users/saethlin/orgs", "repos_url": "https://api.github.com/users/saethlin/repos", "events_url": "https://api.github.com/users/saethlin/events{/privacy}", "received_events_url": "https://api.github.com/users/saethlin/received_events", "type": "User", "site_admin": false}, "committer": {"login": "saethlin", "id": 12105168, "node_id": "MDQ6VXNlcjEyMTA1MTY4", "avatar_url": "https://avatars.githubusercontent.com/u/12105168?v=4", "gravatar_id": "", "url": "https://api.github.com/users/saethlin", "html_url": "https://github.com/saethlin", "followers_url": "https://api.github.com/users/saethlin/followers", "following_url": "https://api.github.com/users/saethlin/following{/other_user}", "gists_url": "https://api.github.com/users/saethlin/gists{/gist_id}", "starred_url": "https://api.github.com/users/saethlin/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/saethlin/subscriptions", "organizations_url": "https://api.github.com/users/saethlin/orgs", "repos_url": "https://api.github.com/users/saethlin/repos", "events_url": "https://api.github.com/users/saethlin/events{/privacy}", "received_events_url": "https://api.github.com/users/saethlin/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "99b334696fffe8c08d2e6a978862849d5a89f875", "url": "https://api.github.com/repos/rust-lang/rust/commits/99b334696fffe8c08d2e6a978862849d5a89f875", "html_url": "https://github.com/rust-lang/rust/commit/99b334696fffe8c08d2e6a978862849d5a89f875"}], "stats": {"total": 15, "additions": 7, "deletions": 8}, "files": [{"sha": "2787092566f262687e39887b0e7841c477407d67", "filename": "compiler/rustc_mir_transform/src/check_alignment.rs", "status": "modified", "additions": 4, "deletions": 6, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/7a2490eba3f161c81ad243c7d957b337dd70a2af/compiler%2Frustc_mir_transform%2Fsrc%2Fcheck_alignment.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7a2490eba3f161c81ad243c7d957b337dd70a2af/compiler%2Frustc_mir_transform%2Fsrc%2Fcheck_alignment.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/compiler%2Frustc_mir_transform%2Fsrc%2Fcheck_alignment.rs?ref=7a2490eba3f161c81ad243c7d957b337dd70a2af", "patch": "@@ -9,7 +9,6 @@ use rustc_middle::mir::{\n };\n use rustc_middle::ty::{Ty, TyCtxt, TypeAndMut};\n use rustc_session::Session;\n-use rustc_target::spec::PanicStrategy;\n \n pub struct CheckAlignment;\n \n@@ -237,11 +236,10 @@ fn insert_alignment_check<'tcx>(\n                 required: Operand::Copy(alignment),\n                 found: Operand::Copy(addr),\n             }),\n-            unwind: if tcx.sess.panic_strategy() == PanicStrategy::Unwind {\n-                UnwindAction::Terminate\n-            } else {\n-                UnwindAction::Unreachable\n-            },\n+            // The panic symbol that this calls is #[rustc_nounwind]. We never want to insert an\n+            // unwind into unsafe code, because unwinding could make a failing UB check turn into\n+            // much worse UB when we start unwinding.\n+            unwind: UnwindAction::Unreachable,\n         },\n     });\n }"}, {"sha": "f0fcdab00ada166d4187c66bc827b6d89e728aa3", "filename": "library/core/src/panicking.rs", "status": "modified", "additions": 3, "deletions": 2, "changes": 5, "blob_url": "https://github.com/rust-lang/rust/blob/7a2490eba3f161c81ad243c7d957b337dd70a2af/library%2Fcore%2Fsrc%2Fpanicking.rs", "raw_url": "https://github.com/rust-lang/rust/raw/7a2490eba3f161c81ad243c7d957b337dd70a2af/library%2Fcore%2Fsrc%2Fpanicking.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/library%2Fcore%2Fsrc%2Fpanicking.rs?ref=7a2490eba3f161c81ad243c7d957b337dd70a2af", "patch": "@@ -166,14 +166,15 @@ fn panic_bounds_check(index: usize, len: usize) -> ! {\n #[cfg_attr(not(feature = \"panic_immediate_abort\"), inline(never))]\n #[track_caller]\n #[lang = \"panic_misaligned_pointer_dereference\"] // needed by codegen for panic on misaligned pointer deref\n+#[rustc_nounwind] // `CheckAlignment` MIR pass requires this function to never unwind\n fn panic_misaligned_pointer_dereference(required: usize, found: usize) -> ! {\n     if cfg!(feature = \"panic_immediate_abort\") {\n         super::intrinsics::abort()\n     }\n \n-    panic!(\n+    panic_nounwind_fmt(format_args!(\n         \"misaligned pointer dereference: address must be a multiple of {required:#x} but is {found:#x}\"\n-    )\n+    ))\n }\n \n /// Panic because we cannot unwind out of a function."}]}