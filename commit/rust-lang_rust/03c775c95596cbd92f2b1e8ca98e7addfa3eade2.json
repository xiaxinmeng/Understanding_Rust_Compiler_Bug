{"sha": "03c775c95596cbd92f2b1e8ca98e7addfa3eade2", "node_id": "MDY6Q29tbWl0NzI0NzEyOjAzYzc3NWM5NTU5NmNiZDkyZjJiMWU4Y2E5OGU3YWRkZmEzZWFkZTI=", "commit": {"author": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-09-03T23:12:35Z"}, "committer": {"name": "bors", "email": "bors@rust-lang.org", "date": "2021-09-03T23:12:35Z"}, "message": "Auto merge of #88482 - athei:add-import-test, r=the8472\n\nAdd regression test for a spurious import\n\nThis PR adds a test that verifies that the bug described in the linked issue does not creep back into the code. In essence it checks that compiling some specific code (that uses 128 bit multiplication) with a specific set of compiler options does not lead to a spurious import of a panic function.\n\nI noticed that other wasm tests use `# only-wasm32-bare` in their `Makefile`. This will skip the test for me. I did not find out how to run this test locally. Maybe someone can help.\n\ncloses #78744\nr? `@jyn514`", "tree": {"sha": "64ceafb873d48c1f1ac3e4b2508f2fa9f1487d43", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/64ceafb873d48c1f1ac3e4b2508f2fa9f1487d43"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/03c775c95596cbd92f2b1e8ca98e7addfa3eade2", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/03c775c95596cbd92f2b1e8ca98e7addfa3eade2", "html_url": "https://github.com/rust-lang/rust/commit/03c775c95596cbd92f2b1e8ca98e7addfa3eade2", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/03c775c95596cbd92f2b1e8ca98e7addfa3eade2/comments", "author": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "committer": {"login": "bors", "id": 3372342, "node_id": "MDQ6VXNlcjMzNzIzNDI=", "avatar_url": "https://avatars.githubusercontent.com/u/3372342?v=4", "gravatar_id": "", "url": "https://api.github.com/users/bors", "html_url": "https://github.com/bors", "followers_url": "https://api.github.com/users/bors/followers", "following_url": "https://api.github.com/users/bors/following{/other_user}", "gists_url": "https://api.github.com/users/bors/gists{/gist_id}", "starred_url": "https://api.github.com/users/bors/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/bors/subscriptions", "organizations_url": "https://api.github.com/users/bors/orgs", "repos_url": "https://api.github.com/users/bors/repos", "events_url": "https://api.github.com/users/bors/events{/privacy}", "received_events_url": "https://api.github.com/users/bors/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "b7404c898a1a6933b71c72428a6dce551bcc1be7", "url": "https://api.github.com/repos/rust-lang/rust/commits/b7404c898a1a6933b71c72428a6dce551bcc1be7", "html_url": "https://github.com/rust-lang/rust/commit/b7404c898a1a6933b71c72428a6dce551bcc1be7"}, {"sha": "14cbb4b78d532532f611d5653f169319bdf50b75", "url": "https://api.github.com/repos/rust-lang/rust/commits/14cbb4b78d532532f611d5653f169319bdf50b75", "html_url": "https://github.com/rust-lang/rust/commit/14cbb4b78d532532f611d5653f169319bdf50b75"}], "stats": {"total": 30, "additions": 30, "deletions": 0}, "files": [{"sha": "1bb59dc1bfa4113027dc11b87475da55bb6f1a3c", "filename": "src/test/run-make/wasm-spurious-import/Makefile", "status": "added", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/03c775c95596cbd92f2b1e8ca98e7addfa3eade2/src%2Ftest%2Frun-make%2Fwasm-spurious-import%2FMakefile", "raw_url": "https://github.com/rust-lang/rust/raw/03c775c95596cbd92f2b1e8ca98e7addfa3eade2/src%2Ftest%2Frun-make%2Fwasm-spurious-import%2FMakefile", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fwasm-spurious-import%2FMakefile?ref=03c775c95596cbd92f2b1e8ca98e7addfa3eade2", "patch": "@@ -0,0 +1,7 @@\n+-include ../../run-make-fulldeps/tools.mk\n+\n+# only-wasm32-bare\n+\n+all:\n+\t$(RUSTC) main.rs -C overflow-checks=yes -C panic=abort -C lto -C opt-level=z --target wasm32-unknown-unknown\n+\t$(NODE) verify.js $(TMPDIR)/main.wasm"}, {"sha": "fcbead5e28bd2113b5d23c79409b4340ae7b2cf3", "filename": "src/test/run-make/wasm-spurious-import/main.rs", "status": "added", "additions": 14, "deletions": 0, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/03c775c95596cbd92f2b1e8ca98e7addfa3eade2/src%2Ftest%2Frun-make%2Fwasm-spurious-import%2Fmain.rs", "raw_url": "https://github.com/rust-lang/rust/raw/03c775c95596cbd92f2b1e8ca98e7addfa3eade2/src%2Ftest%2Frun-make%2Fwasm-spurious-import%2Fmain.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fwasm-spurious-import%2Fmain.rs?ref=03c775c95596cbd92f2b1e8ca98e7addfa3eade2", "patch": "@@ -0,0 +1,14 @@\n+#![crate_type = \"cdylib\"]\n+#![no_std]\n+\n+#[panic_handler]\n+fn my_panic(_info: &core::panic::PanicInfo) -> ! {\n+    loop {}\n+}\n+\n+#[no_mangle]\n+pub fn multer(a: i128, b: i128) -> i128 {\n+    // Trigger usage of the __multi3 compiler intrinsic which then leads to an imported\n+    // panic function in case of a bug. We verify that no imports exist in our verifier.\n+    a * b\n+}"}, {"sha": "d3b2101b6623c96e9281402e41cd7ba31f018088", "filename": "src/test/run-make/wasm-spurious-import/verify.js", "status": "added", "additions": 9, "deletions": 0, "changes": 9, "blob_url": "https://github.com/rust-lang/rust/blob/03c775c95596cbd92f2b1e8ca98e7addfa3eade2/src%2Ftest%2Frun-make%2Fwasm-spurious-import%2Fverify.js", "raw_url": "https://github.com/rust-lang/rust/raw/03c775c95596cbd92f2b1e8ca98e7addfa3eade2/src%2Ftest%2Frun-make%2Fwasm-spurious-import%2Fverify.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frun-make%2Fwasm-spurious-import%2Fverify.js?ref=03c775c95596cbd92f2b1e8ca98e7addfa3eade2", "patch": "@@ -0,0 +1,9 @@\n+const fs = require('fs');\n+const process = require('process');\n+const assert = require('assert');\n+const buffer = fs.readFileSync(process.argv[2]);\n+\n+let m = new WebAssembly.Module(buffer);\n+let imports = WebAssembly.Module.imports(m);\n+console.log('imports', imports);\n+assert.strictEqual(imports.length, 0);"}]}