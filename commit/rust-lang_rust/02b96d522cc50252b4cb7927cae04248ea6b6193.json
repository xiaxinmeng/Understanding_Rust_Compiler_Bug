{"sha": "02b96d522cc50252b4cb7927cae04248ea6b6193", "node_id": "MDY6Q29tbWl0NzI0NzEyOjAyYjk2ZDUyMmNjNTAyNTJiNGNiNzkyN2NhZTA0MjQ4ZWE2YjYxOTM=", "commit": {"author": {"name": "Lauren\u021biu Nicola", "email": "lnicola@dend.ro", "date": "2020-04-17T08:12:05Z"}, "committer": {"name": "Lauren\u021biu Nicola", "email": "lnicola@dend.ro", "date": "2020-04-17T08:12:05Z"}, "message": "Reduce allocations when looking up proc macro decl", "tree": {"sha": "5688c83e7d8a9ddd72b5114b4b5fd1cb523d2251", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/5688c83e7d8a9ddd72b5114b4b5fd1cb523d2251"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/02b96d522cc50252b4cb7927cae04248ea6b6193", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/02b96d522cc50252b4cb7927cae04248ea6b6193", "html_url": "https://github.com/rust-lang/rust/commit/02b96d522cc50252b4cb7927cae04248ea6b6193", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/02b96d522cc50252b4cb7927cae04248ea6b6193/comments", "author": {"login": "lnicola", "id": 308347, "node_id": "MDQ6VXNlcjMwODM0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/308347?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lnicola", "html_url": "https://github.com/lnicola", "followers_url": "https://api.github.com/users/lnicola/followers", "following_url": "https://api.github.com/users/lnicola/following{/other_user}", "gists_url": "https://api.github.com/users/lnicola/gists{/gist_id}", "starred_url": "https://api.github.com/users/lnicola/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lnicola/subscriptions", "organizations_url": "https://api.github.com/users/lnicola/orgs", "repos_url": "https://api.github.com/users/lnicola/repos", "events_url": "https://api.github.com/users/lnicola/events{/privacy}", "received_events_url": "https://api.github.com/users/lnicola/received_events", "type": "User", "site_admin": false}, "committer": {"login": "lnicola", "id": 308347, "node_id": "MDQ6VXNlcjMwODM0Nw==", "avatar_url": "https://avatars.githubusercontent.com/u/308347?v=4", "gravatar_id": "", "url": "https://api.github.com/users/lnicola", "html_url": "https://github.com/lnicola", "followers_url": "https://api.github.com/users/lnicola/followers", "following_url": "https://api.github.com/users/lnicola/following{/other_user}", "gists_url": "https://api.github.com/users/lnicola/gists{/gist_id}", "starred_url": "https://api.github.com/users/lnicola/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/lnicola/subscriptions", "organizations_url": "https://api.github.com/users/lnicola/orgs", "repos_url": "https://api.github.com/users/lnicola/repos", "events_url": "https://api.github.com/users/lnicola/events{/privacy}", "received_events_url": "https://api.github.com/users/lnicola/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "8d296be1090b21b60e509c831864ae85feec2490", "url": "https://api.github.com/repos/rust-lang/rust/commits/8d296be1090b21b60e509c831864ae85feec2490", "html_url": "https://github.com/rust-lang/rust/commit/8d296be1090b21b60e509c831864ae85feec2490"}], "stats": {"total": 72, "additions": 35, "deletions": 37}, "files": [{"sha": "7d6e5d3239daa2357b152124df6d12a24bab7432", "filename": "crates/ra_proc_macro_srv/src/dylib.rs", "status": "modified", "additions": 35, "deletions": 37, "changes": 72, "blob_url": "https://github.com/rust-lang/rust/blob/02b96d522cc50252b4cb7927cae04248ea6b6193/crates%2Fra_proc_macro_srv%2Fsrc%2Fdylib.rs", "raw_url": "https://github.com/rust-lang/rust/raw/02b96d522cc50252b4cb7927cae04248ea6b6193/crates%2Fra_proc_macro_srv%2Fsrc%2Fdylib.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/crates%2Fra_proc_macro_srv%2Fsrc%2Fdylib.rs?ref=02b96d522cc50252b4cb7927cae04248ea6b6193", "patch": "@@ -16,55 +16,53 @@ fn invalid_data_err(e: impl Into<Box<dyn std::error::Error + Send + Sync>>) -> I\n     IoError::new(IoErrorKind::InvalidData, e)\n }\n \n-fn get_symbols_from_lib(file: &Path) -> Result<Vec<String>, IoError> {\n+fn is_derive_registrar_symbol(symbol: &str) -> bool {\n+    symbol.contains(NEW_REGISTRAR_SYMBOL)\n+}\n+\n+fn find_registrar_symbol(file: &Path) -> Result<Option<String>, IoError> {\n     let buffer = std::fs::read(file)?;\n     let object = Object::parse(&buffer).map_err(invalid_data_err)?;\n \n     match object {\n         Object::Elf(elf) => {\n             let symbols = elf.dynstrtab.to_vec().map_err(invalid_data_err)?;\n-            let names = symbols.iter().map(|s| s.to_string()).collect();\n-            Ok(names)\n+            let name =\n+                symbols.iter().find(|s| is_derive_registrar_symbol(s)).map(|s| s.to_string());\n+            Ok(name)\n         }\n         Object::PE(pe) => {\n-            let symbol_names =\n-                pe.exports.iter().flat_map(|s| s.name).map(|n| n.to_string()).collect();\n-            Ok(symbol_names)\n+            let name = pe\n+                .exports\n+                .iter()\n+                .flat_map(|s| s.name)\n+                .find(|s| is_derive_registrar_symbol(s))\n+                .map(|s| s.to_string());\n+            Ok(name)\n         }\n-        Object::Mach(mach) => match mach {\n-            Mach::Binary(binary) => {\n-                let exports = binary.exports().map_err(invalid_data_err)?;\n-                let names = exports\n-                    .into_iter()\n-                    .map(|s| {\n-                        // In macos doc:\n-                        // https://developer.apple.com/library/archive/documentation/System/Conceptual/ManPages_iPhoneOS/man3/dlsym.3.html\n-                        // Unlike other dyld API's, the symbol name passed to dlsym() must NOT be\n-                        // prepended with an underscore.\n-                        if s.name.starts_with(\"_\") {\n-                            s.name[1..].to_string()\n-                        } else {\n-                            s.name\n-                        }\n-                    })\n-                    .collect();\n-                Ok(names)\n-            }\n-            Mach::Fat(_) => Ok(vec![]),\n-        },\n-        Object::Archive(_) | Object::Unknown(_) => Ok(vec![]),\n+        Object::Mach(Mach::Binary(binary)) => {\n+            let exports = binary.exports().map_err(invalid_data_err)?;\n+            let name = exports\n+                .iter()\n+                .map(|s| {\n+                    // In macos doc:\n+                    // https://developer.apple.com/library/archive/documentation/System/Conceptual/ManPages_iPhoneOS/man3/dlsym.3.html\n+                    // Unlike other dyld API's, the symbol name passed to dlsym() must NOT be\n+                    // prepended with an underscore.\n+                    if s.name.starts_with(\"_\") {\n+                        &s.name[1..]\n+                    } else {\n+                        &s.name\n+                    }\n+                })\n+                .find(|s| is_derive_registrar_symbol(&s))\n+                .map(|s| s.to_string());\n+            Ok(name)\n+        }\n+        _ => Ok(None),\n     }\n }\n \n-fn is_derive_registrar_symbol(symbol: &str) -> bool {\n-    symbol.contains(NEW_REGISTRAR_SYMBOL)\n-}\n-\n-fn find_registrar_symbol(file: &Path) -> Result<Option<String>, IoError> {\n-    let symbols = get_symbols_from_lib(file)?;\n-    Ok(symbols.into_iter().find(|s| is_derive_registrar_symbol(s)))\n-}\n-\n /// Loads dynamic library in platform dependent manner.\n ///\n /// For unix, you have to use RTLD_DEEPBIND flag to escape problems described"}]}