{"sha": "ecbc00fa9e08cdb70bdcde6befcc21e6fab28bff", "node_id": "C_kwDOAAsO6NoAKGVjYmMwMGZhOWUwOGNkYjcwYmRjZGU2YmVmY2MyMWU2ZmFiMjhiZmY", "commit": {"author": {"name": "Matthias Kr\u00fcger", "email": "matthias.krueger@famsik.de", "date": "2022-09-22T19:34:50Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2022-09-22T19:34:50Z"}, "message": "Rollup merge of #102118 - notriddle:notriddle/line-numbers, r=GuillaumeGomez\n\nrustdoc: clean up line numbers on code examples\n\n* First commit switches from `display: inline-flex; width: 100%` to `display: flex`.\n\n  `display: inline-flex` was used as part of https://github.com/rust-lang/rust/commit/e961d397cab900c55f8d8c104648852e2b63664e, the original commit that added these line numbers. Does anyone know why it was done this way?\n\n* Second commit makes it so that toggling this checkbox will update the page in real time, just like changing themes does.\n\nPreview: https://notriddle.com/notriddle-rustdoc-test/line-numbers/std/vec/struct.Vec.html", "tree": {"sha": "47fcb72a543c1177675536be7e245a1d8af9454f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/47fcb72a543c1177675536be7e245a1d8af9454f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/ecbc00fa9e08cdb70bdcde6befcc21e6fab28bff", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJjLLjaCRBK7hj4Ov3rIwAAFgcIAK3Om2zZgMzAZJhOGVhkHD5j\nNxTNqmX4DRI4HOpVzjn7uDFVsjG0oE3gGR0zojfyOIUtyPXfEqeo2mafK5pK/U4D\nIKvwDHrIo4OMBAhlUjg5prThlUV0Yix6Bs8eUWwjEJgq5UXYo4ChHTfr7FhSd/Lb\n1Lu5QjDmapEDlJZ9987MBGxlsI5wLKGq0M+n9SD2IB9VF5fAzLYkNwOfRa1O5g/9\nRQ5YCjQ4WtQcKD8hjzQoBMcvT9Yn1pUiLfEFzWH7TTXca2E5A+EaKzGTezmnxk3J\n+7KAaTljiU7d2bO3RuAURsY33oTxppGsHWoA4ewERTYR5U5+ZgcaETWvsa2YUBo=\n=PGWj\n-----END PGP SIGNATURE-----\n", "payload": "tree 47fcb72a543c1177675536be7e245a1d8af9454f\nparent 41ad7261108de094b5626148148fc017a923166f\nparent 8b4c0d90dc403cb9727e80d73c27d4f3de574d60\nauthor Matthias Kr\u00fcger <matthias.krueger@famsik.de> 1663875290 +0200\ncommitter GitHub <noreply@github.com> 1663875290 +0200\n\nRollup merge of #102118 - notriddle:notriddle/line-numbers, r=GuillaumeGomez\n\nrustdoc: clean up line numbers on code examples\n\n* First commit switches from `display: inline-flex; width: 100%` to `display: flex`.\n\n  `display: inline-flex` was used as part of https://github.com/rust-lang/rust/commit/e961d397cab900c55f8d8c104648852e2b63664e, the original commit that added these line numbers. Does anyone know why it was done this way?\n\n* Second commit makes it so that toggling this checkbox will update the page in real time, just like changing themes does.\n\nPreview: https://notriddle.com/notriddle-rustdoc-test/line-numbers/std/vec/struct.Vec.html\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/ecbc00fa9e08cdb70bdcde6befcc21e6fab28bff", "html_url": "https://github.com/rust-lang/rust/commit/ecbc00fa9e08cdb70bdcde6befcc21e6fab28bff", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/ecbc00fa9e08cdb70bdcde6befcc21e6fab28bff/comments", "author": {"login": "matthiaskrgr", "id": 476013, "node_id": "MDQ6VXNlcjQ3NjAxMw==", "avatar_url": "https://avatars.githubusercontent.com/u/476013?v=4", "gravatar_id": "", "url": "https://api.github.com/users/matthiaskrgr", "html_url": "https://github.com/matthiaskrgr", "followers_url": "https://api.github.com/users/matthiaskrgr/followers", "following_url": "https://api.github.com/users/matthiaskrgr/following{/other_user}", "gists_url": "https://api.github.com/users/matthiaskrgr/gists{/gist_id}", "starred_url": "https://api.github.com/users/matthiaskrgr/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/matthiaskrgr/subscriptions", "organizations_url": "https://api.github.com/users/matthiaskrgr/orgs", "repos_url": "https://api.github.com/users/matthiaskrgr/repos", "events_url": "https://api.github.com/users/matthiaskrgr/events{/privacy}", "received_events_url": "https://api.github.com/users/matthiaskrgr/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "41ad7261108de094b5626148148fc017a923166f", "url": "https://api.github.com/repos/rust-lang/rust/commits/41ad7261108de094b5626148148fc017a923166f", "html_url": "https://github.com/rust-lang/rust/commit/41ad7261108de094b5626148148fc017a923166f"}, {"sha": "8b4c0d90dc403cb9727e80d73c27d4f3de574d60", "url": "https://api.github.com/repos/rust-lang/rust/commits/8b4c0d90dc403cb9727e80d73c27d4f3de574d60", "html_url": "https://github.com/rust-lang/rust/commit/8b4c0d90dc403cb9727e80d73c27d4f3de574d60"}], "stats": {"total": 73, "additions": 56, "deletions": 17}, "files": [{"sha": "c91f48f87b5e711c54e9f5877a73a35322ab3f9b", "filename": "src/librustdoc/html/static/css/rustdoc.css", "status": "modified", "additions": 1, "deletions": 5, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/ecbc00fa9e08cdb70bdcde6befcc21e6fab28bff/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Frustdoc.css", "raw_url": "https://github.com/rust-lang/rust/raw/ecbc00fa9e08cdb70bdcde6befcc21e6fab28bff/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Frustdoc.css", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fcss%2Frustdoc.css?ref=ecbc00fa9e08cdb70bdcde6befcc21e6fab28bff", "patch": "@@ -577,13 +577,9 @@ h2.location a {\n }\n \n .rustdoc .example-wrap {\n-\tdisplay: inline-flex;\n+\tdisplay: flex;\n \tmargin-bottom: 10px;\n-}\n-\n-.example-wrap {\n \tposition: relative;\n-\twidth: 100%;\n }\n \n .example-wrap > pre.line-number {"}, {"sha": "5fbe540c320453d47601ba6de7aea86359671048", "filename": "src/librustdoc/html/static/js/main.js", "status": "modified", "additions": 30, "deletions": 11, "changes": 41, "blob_url": "https://github.com/rust-lang/rust/blob/ecbc00fa9e08cdb70bdcde6befcc21e6fab28bff/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fmain.js", "raw_url": "https://github.com/rust-lang/rust/raw/ecbc00fa9e08cdb70bdcde6befcc21e6fab28bff/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fmain.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fmain.js?ref=ecbc00fa9e08cdb70bdcde6befcc21e6fab28bff", "patch": "@@ -697,20 +697,39 @@ function loadCss(cssFileName) {\n         }\n     }());\n \n+    window.rustdoc_add_line_numbers_to_examples = () => {\n+        onEachLazy(document.getElementsByClassName(\"rust-example-rendered\"), x => {\n+            const parent = x.parentNode;\n+            const line_numbers = parent.querySelectorAll(\".line-number\");\n+            if (line_numbers.length > 0) {\n+                return;\n+            }\n+            const count = x.textContent.split(\"\\n\").length;\n+            const elems = [];\n+            for (let i = 0; i < count; ++i) {\n+                elems.push(i + 1);\n+            }\n+            const node = document.createElement(\"pre\");\n+            addClass(node, \"line-number\");\n+            node.innerHTML = elems.join(\"\\n\");\n+            parent.insertBefore(node, x);\n+        });\n+    };\n+\n+    window.rustdoc_remove_line_numbers_from_examples = () => {\n+        onEachLazy(document.getElementsByClassName(\"rust-example-rendered\"), x => {\n+            const parent = x.parentNode;\n+            const line_numbers = parent.querySelectorAll(\".line-number\");\n+            for (const node of line_numbers) {\n+                parent.removeChild(node);\n+            }\n+        });\n+    };\n+\n     (function() {\n         // To avoid checking on \"rustdoc-line-numbers\" value on every loop...\n         if (getSettingValue(\"line-numbers\") === \"true\") {\n-            onEachLazy(document.getElementsByClassName(\"rust-example-rendered\"), x => {\n-                const count = x.textContent.split(\"\\n\").length;\n-                const elems = [];\n-                for (let i = 0; i < count; ++i) {\n-                    elems.push(i + 1);\n-                }\n-                const node = document.createElement(\"pre\");\n-                addClass(node, \"line-number\");\n-                node.innerHTML = elems.join(\"\\n\");\n-                x.parentNode.insertBefore(node, x);\n-            });\n+            window.rustdoc_add_line_numbers_to_examples();\n         }\n     }());\n "}, {"sha": "1c5d33e212754671efa1a0bc6afff4e226b90b9c", "filename": "src/librustdoc/html/static/js/settings.js", "status": "modified", "additions": 7, "deletions": 0, "changes": 7, "blob_url": "https://github.com/rust-lang/rust/blob/ecbc00fa9e08cdb70bdcde6befcc21e6fab28bff/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsettings.js", "raw_url": "https://github.com/rust-lang/rust/raw/ecbc00fa9e08cdb70bdcde6befcc21e6fab28bff/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsettings.js", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustdoc%2Fhtml%2Fstatic%2Fjs%2Fsettings.js?ref=ecbc00fa9e08cdb70bdcde6befcc21e6fab28bff", "patch": "@@ -19,6 +19,13 @@\n                 updateSystemTheme();\n                 updateLightAndDark();\n                 break;\n+            case \"line-numbers\":\n+                if (value === true) {\n+                    window.rustdoc_add_line_numbers_to_examples();\n+                } else {\n+                    window.rustdoc_remove_line_numbers_from_examples();\n+                }\n+                break;\n         }\n     }\n "}, {"sha": "ebfffbce71561ffe3f739c60ec05dbc5f96ce7ff", "filename": "src/test/rustdoc-gui/docblock-code-block-line-number.goml", "status": "modified", "additions": 17, "deletions": 0, "changes": 17, "blob_url": "https://github.com/rust-lang/rust/blob/ecbc00fa9e08cdb70bdcde6befcc21e6fab28bff/src%2Ftest%2Frustdoc-gui%2Fdocblock-code-block-line-number.goml", "raw_url": "https://github.com/rust-lang/rust/raw/ecbc00fa9e08cdb70bdcde6befcc21e6fab28bff/src%2Ftest%2Frustdoc-gui%2Fdocblock-code-block-line-number.goml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-gui%2Fdocblock-code-block-line-number.goml?ref=ecbc00fa9e08cdb70bdcde6befcc21e6fab28bff", "patch": "@@ -20,3 +20,20 @@ assert-css: (\"pre.line-number\", {\n })\n // The first code block has two lines so let's check its `<pre>` elements lists both of them.\n assert-text: (\"pre.line-number\", \"1\\n2\")\n+\n+// Now, try changing the setting dynamically. We'll turn it off, using the settings menu,\n+// and make sure it goes away.\n+\n+// First, open the settings menu.\n+click: \"#settings-menu\"\n+wait-for: \"#settings\"\n+assert-css: (\"#settings\", {\"display\": \"block\"})\n+\n+// Then, click the toggle button.\n+click: \"input#line-numbers + .slider\"\n+wait-for: 100 // wait-for-false does not exist\n+assert-false: \"pre.line-number\"\n+\n+// Finally, turn it on again.\n+click: \"input#line-numbers + .slider\"\n+wait-for: \"pre.line-number\""}, {"sha": "47e40aa8e3b1c2a1e8f32c938d34e001a56edc03", "filename": "src/test/rustdoc-gui/source-anchor-scroll.goml", "status": "modified", "additions": 1, "deletions": 1, "changes": 2, "blob_url": "https://github.com/rust-lang/rust/blob/ecbc00fa9e08cdb70bdcde6befcc21e6fab28bff/src%2Ftest%2Frustdoc-gui%2Fsource-anchor-scroll.goml", "raw_url": "https://github.com/rust-lang/rust/raw/ecbc00fa9e08cdb70bdcde6befcc21e6fab28bff/src%2Ftest%2Frustdoc-gui%2Fsource-anchor-scroll.goml", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Frustdoc-gui%2Fsource-anchor-scroll.goml?ref=ecbc00fa9e08cdb70bdcde6befcc21e6fab28bff", "patch": "@@ -10,7 +10,7 @@ assert-property: (\"html\", {\"scrollTop\": \"0\"})\n click: '//a[text() = \"barbar\"]'\n assert-property: (\"html\", {\"scrollTop\": \"125\"})\n click: '//a[text() = \"bar\"]'\n-assert-property: (\"html\", {\"scrollTop\": \"166\"})\n+assert-property: (\"html\", {\"scrollTop\": \"156\"})\n click: '//a[text() = \"sub_fn\"]'\n assert-property: (\"html\", {\"scrollTop\": \"53\"})\n "}]}