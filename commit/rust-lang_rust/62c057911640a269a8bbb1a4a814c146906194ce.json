{"sha": "62c057911640a269a8bbb1a4a814c146906194ce", "node_id": "MDY6Q29tbWl0NzI0NzEyOjYyYzA1NzkxMTY0MGEyNjlhOGJiYjFhNGE4MTRjMTQ2OTA2MTk0Y2U=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2020-03-15T01:44:13Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-03-15T01:44:13Z"}, "message": "Rollup merge of #69357 - tmiasko:debuginfo-column, r=michaelwoerister\n\nEmit 1-based column numbers in debuginfo\n\n* Use byte offsets instead of char position offsets. Resolves #67360.\n* Use 1-based offsets instead of 0-based ones. Resolves #65437.\n* Consistently omit column information for msvc targets, matching clang behaviour (previously columns have been omitted from `DILocation`, but not from `DILexicalBlock`).", "tree": {"sha": "4e52416f35add2203e59f1a6752f16f8bdcd63a1", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/4e52416f35add2203e59f1a6752f16f8bdcd63a1"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/62c057911640a269a8bbb1a4a814c146906194ce", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJebYhtCRBK7hj4Ov3rIwAAdHIIAJ7heabiwl+CfX8di6DI5w18\nqbc7GvjTCcyhYI55Asdqb/g7gcFKYnq9bVHWEUFzWmoH+pJGmWodAN1LOQXIwG3S\npogEgHQG9pPETo8FcHO0ONnPZxdOJnHVBem1LF4GBsP5sph/PTnjR6yl1W8wPNjr\n06tqOdt44BGPPrKPOLDMFgQq03EtJ5WkAP0C+XEJv8XvDIjhz96JQP7yDhNRNmwf\nhqtN8udVgI0o7/rh1R71+6R4hq+hiZ94N/VJwRa+cj7vaTpjWbCAW/1nMr0zAE79\nygzC3LuOQBCVxq6aua62DN6YhoGii+pPa9Q2/19aKAZQj9gtzy4n10lxqui/stE=\n=jKui\n-----END PGP SIGNATURE-----\n", "payload": "tree 4e52416f35add2203e59f1a6752f16f8bdcd63a1\nparent 7cdbc87a49b0b705a41a004a6d486b0952521ae7\nparent 8e93a01824a2239f1c588c7c0b884c8a2662e929\nauthor Dylan DPC <dylan.dpc@gmail.com> 1584236653 +0100\ncommitter GitHub <noreply@github.com> 1584236653 +0100\n\nRollup merge of #69357 - tmiasko:debuginfo-column, r=michaelwoerister\n\nEmit 1-based column numbers in debuginfo\n\n* Use byte offsets instead of char position offsets. Resolves #67360.\n* Use 1-based offsets instead of 0-based ones. Resolves #65437.\n* Consistently omit column information for msvc targets, matching clang behaviour (previously columns have been omitted from `DILocation`, but not from `DILexicalBlock`).\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/62c057911640a269a8bbb1a4a814c146906194ce", "html_url": "https://github.com/rust-lang/rust/commit/62c057911640a269a8bbb1a4a814c146906194ce", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/62c057911640a269a8bbb1a4a814c146906194ce/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "7cdbc87a49b0b705a41a004a6d486b0952521ae7", "url": "https://api.github.com/repos/rust-lang/rust/commits/7cdbc87a49b0b705a41a004a6d486b0952521ae7", "html_url": "https://github.com/rust-lang/rust/commit/7cdbc87a49b0b705a41a004a6d486b0952521ae7"}, {"sha": "8e93a01824a2239f1c588c7c0b884c8a2662e929", "url": "https://api.github.com/repos/rust-lang/rust/commits/8e93a01824a2239f1c588c7c0b884c8a2662e929", "html_url": "https://github.com/rust-lang/rust/commit/8e93a01824a2239f1c588c7c0b884c8a2662e929"}], "stats": {"total": 140, "additions": 97, "deletions": 43}, "files": [{"sha": "09422f4ec3768824e92cd9e50f0298b372aa2cb5", "filename": "src/librustc_codegen_llvm/debuginfo/create_scope_map.rs", "status": "modified", "additions": 6, "deletions": 10, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/62c057911640a269a8bbb1a4a814c146906194ce/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fcreate_scope_map.rs", "raw_url": "https://github.com/rust-lang/rust/raw/62c057911640a269a8bbb1a4a814c146906194ce/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fcreate_scope_map.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fcreate_scope_map.rs?ref=62c057911640a269a8bbb1a4a814c146906194ce", "patch": "@@ -1,16 +1,12 @@\n-use super::metadata::file_metadata;\n-use super::utils::{span_start, DIB};\n+use super::metadata::{file_metadata, UNKNOWN_COLUMN_NUMBER, UNKNOWN_LINE_NUMBER};\n+use super::utils::DIB;\n use rustc_codegen_ssa::mir::debuginfo::{DebugScope, FunctionDebugContext};\n \n use crate::common::CodegenCx;\n use crate::llvm;\n use crate::llvm::debuginfo::{DIScope, DISubprogram};\n use rustc::mir::{Body, SourceScope};\n \n-use libc::c_uint;\n-\n-use rustc_span::Pos;\n-\n use rustc_index::bit_set::BitSet;\n use rustc_index::vec::Idx;\n \n@@ -54,7 +50,7 @@ fn make_mir_scope(\n         debug_context.scopes[parent]\n     } else {\n         // The root is the function itself.\n-        let loc = span_start(cx, mir.span);\n+        let loc = cx.lookup_debug_loc(mir.span.lo());\n         debug_context.scopes[scope] = DebugScope {\n             scope_metadata: Some(fn_metadata),\n             file_start_pos: loc.file.start_pos,\n@@ -70,16 +66,16 @@ fn make_mir_scope(\n         return;\n     }\n \n-    let loc = span_start(cx, scope_data.span);\n+    let loc = cx.lookup_debug_loc(scope_data.span.lo());\n     let file_metadata = file_metadata(cx, &loc.file.name, debug_context.defining_crate);\n \n     let scope_metadata = unsafe {\n         Some(llvm::LLVMRustDIBuilderCreateLexicalBlock(\n             DIB(cx),\n             parent_scope.scope_metadata.unwrap(),\n             file_metadata,\n-            loc.line as c_uint,\n-            loc.col.to_usize() as c_uint,\n+            loc.line.unwrap_or(UNKNOWN_LINE_NUMBER),\n+            loc.col.unwrap_or(UNKNOWN_COLUMN_NUMBER),\n         ))\n     };\n     debug_context.scopes[scope] = DebugScope {"}, {"sha": "55eee13d028ca93bc32cab9be7cc1f4d99c1faff", "filename": "src/librustc_codegen_llvm/debuginfo/metadata.rs", "status": "modified", "additions": 5, "deletions": 5, "changes": 10, "blob_url": "https://github.com/rust-lang/rust/blob/62c057911640a269a8bbb1a4a814c146906194ce/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fmetadata.rs", "raw_url": "https://github.com/rust-lang/rust/raw/62c057911640a269a8bbb1a4a814c146906194ce/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fmetadata.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fmetadata.rs?ref=62c057911640a269a8bbb1a4a814c146906194ce", "patch": "@@ -5,7 +5,7 @@ use self::RecursiveTypeDescription::*;\n use super::namespace::mangled_name_of_instance;\n use super::type_names::compute_debuginfo_type_name;\n use super::utils::{\n-    create_DIArray, debug_context, get_namespace_for_item, is_node_local_to_unit, span_start, DIB,\n+    create_DIArray, debug_context, get_namespace_for_item, is_node_local_to_unit, DIB,\n };\n use super::CrateDebugContext;\n \n@@ -2309,10 +2309,10 @@ pub fn create_global_var_metadata(cx: &CodegenCx<'ll, '_>, def_id: DefId, global\n     let span = tcx.def_span(def_id);\n \n     let (file_metadata, line_number) = if !span.is_dummy() {\n-        let loc = span_start(cx, span);\n-        (file_metadata(cx, &loc.file.name, LOCAL_CRATE), loc.line as c_uint)\n+        let loc = cx.lookup_debug_loc(span.lo());\n+        (file_metadata(cx, &loc.file.name, LOCAL_CRATE), loc.line)\n     } else {\n-        (unknown_file_metadata(cx), UNKNOWN_LINE_NUMBER)\n+        (unknown_file_metadata(cx), None)\n     };\n \n     let is_local_to_unit = is_node_local_to_unit(cx, def_id);\n@@ -2339,7 +2339,7 @@ pub fn create_global_var_metadata(cx: &CodegenCx<'ll, '_>, def_id: DefId, global\n             linkage_name.as_ptr().cast(),\n             linkage_name.len(),\n             file_metadata,\n-            line_number,\n+            line_number.unwrap_or(UNKNOWN_LINE_NUMBER),\n             type_metadata,\n             is_local_to_unit,\n             global,"}, {"sha": "bbde541c58f1e0dec322e83462be98b007de0021", "filename": "src/librustc_codegen_llvm/debuginfo/mod.rs", "status": "modified", "additions": 7, "deletions": 7, "changes": 14, "blob_url": "https://github.com/rust-lang/rust/blob/62c057911640a269a8bbb1a4a814c146906194ce/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fmod.rs", "raw_url": "https://github.com/rust-lang/rust/raw/62c057911640a269a8bbb1a4a814c146906194ce/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fmod.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fmod.rs?ref=62c057911640a269a8bbb1a4a814c146906194ce", "patch": "@@ -3,10 +3,10 @@ mod doc;\n \n use rustc_codegen_ssa::mir::debuginfo::VariableKind::*;\n \n-use self::metadata::{file_metadata, type_metadata, TypeMap};\n+use self::metadata::{file_metadata, type_metadata, TypeMap, UNKNOWN_LINE_NUMBER};\n use self::namespace::mangled_name_of_instance;\n use self::type_names::compute_debuginfo_type_name;\n-use self::utils::{create_DIArray, is_node_local_to_unit, span_start, DIB};\n+use self::utils::{create_DIArray, is_node_local_to_unit, DIB};\n \n use crate::llvm;\n use crate::llvm::debuginfo::{\n@@ -248,7 +248,7 @@ impl DebugInfoMethods<'tcx> for CodegenCx<'ll, 'tcx> {\n \n         let def_id = instance.def_id();\n         let containing_scope = get_containing_scope(self, instance);\n-        let loc = span_start(self, span);\n+        let loc = self.lookup_debug_loc(span.lo());\n         let file_metadata = file_metadata(self, &loc.file.name, def_id.krate);\n \n         let function_type_metadata = unsafe {\n@@ -304,9 +304,9 @@ impl DebugInfoMethods<'tcx> for CodegenCx<'ll, 'tcx> {\n                 linkage_name.as_ptr().cast(),\n                 linkage_name.len(),\n                 file_metadata,\n-                loc.line as c_uint,\n+                loc.line.unwrap_or(UNKNOWN_LINE_NUMBER),\n                 function_type_metadata,\n-                scope_line as c_uint,\n+                scope_line.unwrap_or(UNKNOWN_LINE_NUMBER),\n                 flags,\n                 spflags,\n                 llfn,\n@@ -530,7 +530,7 @@ impl DebugInfoMethods<'tcx> for CodegenCx<'ll, 'tcx> {\n         variable_kind: VariableKind,\n         span: Span,\n     ) -> &'ll DIVariable {\n-        let loc = span_start(self, span);\n+        let loc = self.lookup_debug_loc(span.lo());\n         let file_metadata = file_metadata(self, &loc.file.name, dbg_context.defining_crate);\n \n         let type_metadata = type_metadata(self, variable_type, span);\n@@ -550,7 +550,7 @@ impl DebugInfoMethods<'tcx> for CodegenCx<'ll, 'tcx> {\n                 name.as_ptr().cast(),\n                 name.len(),\n                 file_metadata,\n-                loc.line as c_uint,\n+                loc.line.unwrap_or(UNKNOWN_LINE_NUMBER),\n                 type_metadata,\n                 true,\n                 DIFlags::FlagZero,"}, {"sha": "66ae9d72c3e5195fb1d10b462fd1cdfe6f965154", "filename": "src/librustc_codegen_llvm/debuginfo/source_loc.rs", "status": "modified", "additions": 39, "deletions": 13, "changes": 52, "blob_url": "https://github.com/rust-lang/rust/blob/62c057911640a269a8bbb1a4a814c146906194ce/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fsource_loc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/62c057911640a269a8bbb1a4a814c146906194ce/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fsource_loc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Fsource_loc.rs?ref=62c057911640a269a8bbb1a4a814c146906194ce", "patch": "@@ -1,32 +1,58 @@\n-use super::metadata::UNKNOWN_COLUMN_NUMBER;\n-use super::utils::{debug_context, span_start};\n+use super::metadata::{UNKNOWN_COLUMN_NUMBER, UNKNOWN_LINE_NUMBER};\n+use super::utils::debug_context;\n \n use crate::common::CodegenCx;\n use crate::llvm::debuginfo::DIScope;\n use crate::llvm::{self, Value};\n use rustc_codegen_ssa::traits::*;\n \n-use libc::c_uint;\n-use rustc_span::{Pos, Span};\n+use rustc_data_structures::sync::Lrc;\n+use rustc_span::{BytePos, Pos, SourceFile, SourceFileAndLine, Span};\n+\n+/// A source code location used to generate debug information.\n+pub struct DebugLoc {\n+    /// Information about the original source file.\n+    pub file: Lrc<SourceFile>,\n+    /// The (1-based) line number.\n+    pub line: Option<u32>,\n+    /// The (1-based) column number.\n+    pub col: Option<u32>,\n+}\n \n impl CodegenCx<'ll, '_> {\n-    pub fn create_debug_loc(&self, scope: &'ll DIScope, span: Span) -> &'ll Value {\n-        let loc = span_start(self, span);\n+    /// Looks up debug source information about a `BytePos`.\n+    pub fn lookup_debug_loc(&self, pos: BytePos) -> DebugLoc {\n+        let (file, line, col) = match self.sess().source_map().lookup_line(pos) {\n+            Ok(SourceFileAndLine { sf: file, line }) => {\n+                let line_pos = file.line_begin_pos(pos);\n+\n+                // Use 1-based indexing.\n+                let line = (line + 1) as u32;\n+                let col = (pos - line_pos).to_u32() + 1;\n+\n+                (file, Some(line), Some(col))\n+            }\n+            Err(file) => (file, None, None),\n+        };\n \n-        // For MSVC, set the column number to zero.\n+        // For MSVC, omit the column number.\n         // Otherwise, emit it. This mimics clang behaviour.\n         // See discussion in https://github.com/rust-lang/rust/issues/42921\n-        let col_used = if self.sess().target.target.options.is_like_msvc {\n-            UNKNOWN_COLUMN_NUMBER\n+        if self.sess().target.target.options.is_like_msvc {\n+            DebugLoc { file, line, col: None }\n         } else {\n-            loc.col.to_usize() as c_uint\n-        };\n+            DebugLoc { file, line, col }\n+        }\n+    }\n+\n+    pub fn create_debug_loc(&self, scope: &'ll DIScope, span: Span) -> &'ll Value {\n+        let DebugLoc { line, col, .. } = self.lookup_debug_loc(span.lo());\n \n         unsafe {\n             llvm::LLVMRustDIBuilderCreateDebugLocation(\n                 debug_context(self).llcontext,\n-                loc.line as c_uint,\n-                col_used,\n+                line.unwrap_or(UNKNOWN_LINE_NUMBER),\n+                col.unwrap_or(UNKNOWN_COLUMN_NUMBER),\n                 scope,\n                 None,\n             )"}, {"sha": "bef40decdf3ab0912258c127cfe2d74d06fffdbf", "filename": "src/librustc_codegen_llvm/debuginfo/utils.rs", "status": "modified", "additions": 0, "deletions": 8, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/62c057911640a269a8bbb1a4a814c146906194ce/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Futils.rs", "raw_url": "https://github.com/rust-lang/rust/raw/62c057911640a269a8bbb1a4a814c146906194ce/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Futils.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_codegen_llvm%2Fdebuginfo%2Futils.rs?ref=62c057911640a269a8bbb1a4a814c146906194ce", "patch": "@@ -9,9 +9,6 @@ use rustc_hir::def_id::DefId;\n use crate::common::CodegenCx;\n use crate::llvm;\n use crate::llvm::debuginfo::{DIArray, DIBuilder, DIDescriptor, DIScope};\n-use rustc_codegen_ssa::traits::*;\n-\n-use rustc_span::Span;\n \n pub fn is_node_local_to_unit(cx: &CodegenCx<'_, '_>, def_id: DefId) -> bool {\n     // The is_local_to_unit flag indicates whether a function is local to the\n@@ -32,11 +29,6 @@ pub fn create_DIArray(builder: &DIBuilder<'ll>, arr: &[Option<&'ll DIDescriptor>\n     };\n }\n \n-/// Returns rustc_span::Loc corresponding to the beginning of the span\n-pub fn span_start(cx: &CodegenCx<'_, '_>, span: Span) -> rustc_span::Loc {\n-    cx.sess().source_map().lookup_char_pos(span.lo())\n-}\n-\n #[inline]\n pub fn debug_context(cx: &'a CodegenCx<'ll, 'tcx>) -> &'a CrateDebugContext<'ll, 'tcx> {\n     cx.dbg_cx.as_ref().unwrap()"}, {"sha": "aad8b372a8a928d1b6327e8e0b6ff1677f0a87df", "filename": "src/test/codegen/debug-column-msvc.rs", "status": "added", "additions": 16, "deletions": 0, "changes": 16, "blob_url": "https://github.com/rust-lang/rust/blob/62c057911640a269a8bbb1a4a814c146906194ce/src%2Ftest%2Fcodegen%2Fdebug-column-msvc.rs", "raw_url": "https://github.com/rust-lang/rust/raw/62c057911640a269a8bbb1a4a814c146906194ce/src%2Ftest%2Fcodegen%2Fdebug-column-msvc.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fdebug-column-msvc.rs?ref=62c057911640a269a8bbb1a4a814c146906194ce", "patch": "@@ -0,0 +1,16 @@\n+// Verify that no column information is emitted for MSVC targets\n+//\n+// only-msvc\n+// compile-flags: -C debuginfo=2\n+\n+// CHECK-NOT: !DILexicalBlock({{.*}}column: {{.*}})\n+// CHECK-NOT: !DILocation({{.*}}column: {{.*}})\n+\n+pub fn add(a: u32, b: u32) -> u32 {\n+    a + b\n+}\n+\n+fn main() {\n+    let c = add(1, 2);\n+    println!(\"{}\", c);\n+}"}, {"sha": "f348c48566d51ac394da449401ed27d3667cdd55", "filename": "src/test/codegen/debug-column.rs", "status": "added", "additions": 24, "deletions": 0, "changes": 24, "blob_url": "https://github.com/rust-lang/rust/blob/62c057911640a269a8bbb1a4a814c146906194ce/src%2Ftest%2Fcodegen%2Fdebug-column.rs", "raw_url": "https://github.com/rust-lang/rust/raw/62c057911640a269a8bbb1a4a814c146906194ce/src%2Ftest%2Fcodegen%2Fdebug-column.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fcodegen%2Fdebug-column.rs?ref=62c057911640a269a8bbb1a4a814c146906194ce", "patch": "@@ -0,0 +1,24 @@\n+// Verify that debuginfo column nubmers are 1-based byte offsets.\n+//\n+// ignore-windows\n+// compile-flags: -C debuginfo=2\n+\n+fn main() {\n+    unsafe {\n+        // Column numbers are 1-based. Regression test for #65437.\n+        // CHECK: call void @giraffe(), !dbg [[A:!.*]]\n+        giraffe();\n+\n+        // Column numbers use byte offests. Regression test for #67360\n+        // CHECK: call void @turtle(), !dbg [[B:!.*]]\n+/* \u017c */ turtle();\n+\n+        // CHECK: [[A]] = !DILocation(line: 10, column: 9,\n+        // CHECK: [[B]] = !DILocation(line: 14, column: 10,\n+    }\n+}\n+\n+extern {\n+    fn giraffe();\n+    fn turtle();\n+}"}]}