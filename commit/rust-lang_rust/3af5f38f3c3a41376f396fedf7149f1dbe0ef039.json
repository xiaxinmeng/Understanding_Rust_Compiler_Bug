{"sha": "3af5f38f3c3a41376f396fedf7149f1dbe0ef039", "node_id": "MDY6Q29tbWl0NzI0NzEyOjNhZjVmMzhmM2MzYTQxMzc2ZjM5NmZlZGY3MTQ5ZjFkYmUwZWYwMzk=", "commit": {"author": {"name": "Eduard Burtescu", "email": "edy.burt@gmail.com", "date": "2014-02-13T19:52:53Z"}, "committer": {"name": "Alex Crichton", "email": "alex@alexcrichton.com", "date": "2014-02-14T15:46:41Z"}, "message": "Don't copy &Trait and &mut Trait to temporaries for every call.", "tree": {"sha": "6c8cfdf5e58ffc3d62f4de7213f1132ca352017f", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/6c8cfdf5e58ffc3d62f4de7213f1132ca352017f"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/3af5f38f3c3a41376f396fedf7149f1dbe0ef039", "comment_count": 0, "verification": {"verified": false, "reason": "unsigned", "signature": null, "payload": null}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/3af5f38f3c3a41376f396fedf7149f1dbe0ef039", "html_url": "https://github.com/rust-lang/rust/commit/3af5f38f3c3a41376f396fedf7149f1dbe0ef039", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/3af5f38f3c3a41376f396fedf7149f1dbe0ef039/comments", "author": {"login": "eddyb", "id": 77424, "node_id": "MDQ6VXNlcjc3NDI0", "avatar_url": "https://avatars.githubusercontent.com/u/77424?v=4", "gravatar_id": "", "url": "https://api.github.com/users/eddyb", "html_url": "https://github.com/eddyb", "followers_url": "https://api.github.com/users/eddyb/followers", "following_url": "https://api.github.com/users/eddyb/following{/other_user}", "gists_url": "https://api.github.com/users/eddyb/gists{/gist_id}", "starred_url": "https://api.github.com/users/eddyb/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/eddyb/subscriptions", "organizations_url": "https://api.github.com/users/eddyb/orgs", "repos_url": "https://api.github.com/users/eddyb/repos", "events_url": "https://api.github.com/users/eddyb/events{/privacy}", "received_events_url": "https://api.github.com/users/eddyb/received_events", "type": "User", "site_admin": false}, "committer": {"login": "alexcrichton", "id": 64996, "node_id": "MDQ6VXNlcjY0OTk2", "avatar_url": "https://avatars.githubusercontent.com/u/64996?v=4", "gravatar_id": "", "url": "https://api.github.com/users/alexcrichton", "html_url": "https://github.com/alexcrichton", "followers_url": "https://api.github.com/users/alexcrichton/followers", "following_url": "https://api.github.com/users/alexcrichton/following{/other_user}", "gists_url": "https://api.github.com/users/alexcrichton/gists{/gist_id}", "starred_url": "https://api.github.com/users/alexcrichton/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/alexcrichton/subscriptions", "organizations_url": "https://api.github.com/users/alexcrichton/orgs", "repos_url": "https://api.github.com/users/alexcrichton/repos", "events_url": "https://api.github.com/users/alexcrichton/events{/privacy}", "received_events_url": "https://api.github.com/users/alexcrichton/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "ee2a888860ea496b5a972ed35fb742b4ae008233", "url": "https://api.github.com/repos/rust-lang/rust/commits/ee2a888860ea496b5a972ed35fb742b4ae008233", "html_url": "https://github.com/rust-lang/rust/commit/ee2a888860ea496b5a972ed35fb742b4ae008233"}], "stats": {"total": 25, "additions": 16, "deletions": 9}, "files": [{"sha": "27fb9bdb0bb84687ac44edfbb957340b4e12e720", "filename": "src/librustc/middle/trans/meth.rs", "status": "modified", "additions": 16, "deletions": 9, "changes": 25, "blob_url": "https://github.com/rust-lang/rust/blob/3af5f38f3c3a41376f396fedf7149f1dbe0ef039/src%2Flibrustc%2Fmiddle%2Ftrans%2Fmeth.rs", "raw_url": "https://github.com/rust-lang/rust/raw/3af5f38f3c3a41376f396fedf7149f1dbe0ef039/src%2Flibrustc%2Fmiddle%2Ftrans%2Fmeth.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc%2Fmiddle%2Ftrans%2Fmeth.rs?ref=3af5f38f3c3a41376f396fedf7149f1dbe0ef039", "patch": "@@ -353,17 +353,24 @@ fn trans_trait_callee<'a>(bcx: &'a Block<'a>,\n     // converting to an rvalue.\n     let self_datum = unpack_datum!(\n         bcx, expr::trans(bcx, self_expr));\n-    let self_datum = unpack_datum!(\n-        bcx, self_datum.to_rvalue_datum(bcx, \"trait_callee\"));\n \n-    // Convert to by-ref since `trans_trait_callee_from_llval` wants it\n-    // that way.\n-    let self_datum = unpack_datum!(\n-        bcx, self_datum.to_ref_datum(bcx));\n+    let llval = if ty::type_needs_drop(bcx.tcx(), self_datum.ty) {\n+        let self_datum = unpack_datum!(\n+            bcx, self_datum.to_rvalue_datum(bcx, \"trait_callee\"));\n+\n+        // Convert to by-ref since `trans_trait_callee_from_llval` wants it\n+        // that way.\n+        let self_datum = unpack_datum!(\n+            bcx, self_datum.to_ref_datum(bcx));\n \n-    // Arrange cleanup in case something should go wrong before the\n-    // actual call occurs.\n-    let llval = self_datum.add_clean(bcx.fcx, arg_cleanup_scope);\n+        // Arrange cleanup in case something should go wrong before the\n+        // actual call occurs.\n+        self_datum.add_clean(bcx.fcx, arg_cleanup_scope)\n+    } else {\n+        // We don't have to do anything about cleanups for &Trait and &mut Trait.\n+        assert!(self_datum.kind.is_by_ref());\n+        self_datum.val\n+    };\n \n     let callee_ty = node_id_type(bcx, callee_id);\n     trans_trait_callee_from_llval(bcx, callee_ty, n_method, llval)"}]}