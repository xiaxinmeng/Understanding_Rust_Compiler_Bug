{"sha": "956e50bce166663da04601bd01888d879d6f80e8", "node_id": "MDY6Q29tbWl0NzI0NzEyOjk1NmU1MGJjZTE2NjY2M2RhMDQ2MDFiZDAxODg4ZDg3OWQ2ZjgwZTg=", "commit": {"author": {"name": "Dylan DPC", "email": "dylan.dpc@gmail.com", "date": "2020-04-08T16:37:16Z"}, "committer": {"name": "GitHub", "email": "noreply@github.com", "date": "2020-04-08T16:37:16Z"}, "message": "Rollup merge of #70789 - lcnr:macros, r=varkor\n\nremove false positives of unused_braces\n\nfixes #70717\n\nWe could potentially be more aggressive when linting let bindings by checking if there are any explicit `ref`s.\nI have been unable to create a snippet which compiles when using braces but has a borrowck error\nwithout them. The closes I've gotten is [the following (playground)](https://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=4a1552ebe9648cb13fcb8dd969189a6c).\n\nr? @eddyb", "tree": {"sha": "2e0335c0e636a1eea8ebe2367ae9509bba111a3e", "url": "https://api.github.com/repos/rust-lang/rust/git/trees/2e0335c0e636a1eea8ebe2367ae9509bba111a3e"}, "url": "https://api.github.com/repos/rust-lang/rust/git/commits/956e50bce166663da04601bd01888d879d6f80e8", "comment_count": 0, "verification": {"verified": true, "reason": "valid", "signature": "-----BEGIN PGP SIGNATURE-----\n\nwsBcBAABCAAQBQJejf29CRBK7hj4Ov3rIwAAdHIIAJ+aCjJffSTipJ7gm9xIgbDi\nkhwHgCUIhvA98D+uP+hk+DCF3EGsY9IsMIvPdtuG+LyeM8CNDtfVsSe+xgvP+v17\nVJs0Y/MD+5IfpNl3R3A8GAYYnQl2sL6aqP/7oHnRk94ewPEgSao4MmFFWeKjjNMR\nfz3tO5cCinXHyvx71gjKSO6GVuxG6RuCmRzZNUKD51pZrrU/YVxZu7mnOt9iWfqA\nkxyc/JzwEwxKEwbF2SBq8FR/k2Br3PIWeTb4qS1r+D5DTUEIS9CyRIOZtlW84VB/\nSqfK5f10l/snEqJjyydZ1VY8Mc1MUqn2h302apfix+Fc2XckReJRIY/fvkmU3fY=\n=cq+o\n-----END PGP SIGNATURE-----\n", "payload": "tree 2e0335c0e636a1eea8ebe2367ae9509bba111a3e\nparent 42abbd8878d3b67238f3611b0587c704ba94f39c\nparent 817f05986ae77538e5721223a55b14cd780dbd73\nauthor Dylan DPC <dylan.dpc@gmail.com> 1586363836 +0200\ncommitter GitHub <noreply@github.com> 1586363836 +0200\n\nRollup merge of #70789 - lcnr:macros, r=varkor\n\nremove false positives of unused_braces\n\nfixes #70717\n\nWe could potentially be more aggressive when linting let bindings by checking if there are any explicit `ref`s.\nI have been unable to create a snippet which compiles when using braces but has a borrowck error\nwithout them. The closes I've gotten is [the following (playground)](https://play.rust-lang.org/?version=stable&mode=debug&edition=2018&gist=4a1552ebe9648cb13fcb8dd969189a6c).\n\nr? @eddyb\n"}}, "url": "https://api.github.com/repos/rust-lang/rust/commits/956e50bce166663da04601bd01888d879d6f80e8", "html_url": "https://github.com/rust-lang/rust/commit/956e50bce166663da04601bd01888d879d6f80e8", "comments_url": "https://api.github.com/repos/rust-lang/rust/commits/956e50bce166663da04601bd01888d879d6f80e8/comments", "author": {"login": "Dylan-DPC", "id": 99973273, "node_id": "U_kgDOBfV4mQ", "avatar_url": "https://avatars.githubusercontent.com/u/99973273?v=4", "gravatar_id": "", "url": "https://api.github.com/users/Dylan-DPC", "html_url": "https://github.com/Dylan-DPC", "followers_url": "https://api.github.com/users/Dylan-DPC/followers", "following_url": "https://api.github.com/users/Dylan-DPC/following{/other_user}", "gists_url": "https://api.github.com/users/Dylan-DPC/gists{/gist_id}", "starred_url": "https://api.github.com/users/Dylan-DPC/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/Dylan-DPC/subscriptions", "organizations_url": "https://api.github.com/users/Dylan-DPC/orgs", "repos_url": "https://api.github.com/users/Dylan-DPC/repos", "events_url": "https://api.github.com/users/Dylan-DPC/events{/privacy}", "received_events_url": "https://api.github.com/users/Dylan-DPC/received_events", "type": "User", "site_admin": false}, "committer": {"login": "web-flow", "id": 19864447, "node_id": "MDQ6VXNlcjE5ODY0NDQ3", "avatar_url": "https://avatars.githubusercontent.com/u/19864447?v=4", "gravatar_id": "", "url": "https://api.github.com/users/web-flow", "html_url": "https://github.com/web-flow", "followers_url": "https://api.github.com/users/web-flow/followers", "following_url": "https://api.github.com/users/web-flow/following{/other_user}", "gists_url": "https://api.github.com/users/web-flow/gists{/gist_id}", "starred_url": "https://api.github.com/users/web-flow/starred{/owner}{/repo}", "subscriptions_url": "https://api.github.com/users/web-flow/subscriptions", "organizations_url": "https://api.github.com/users/web-flow/orgs", "repos_url": "https://api.github.com/users/web-flow/repos", "events_url": "https://api.github.com/users/web-flow/events{/privacy}", "received_events_url": "https://api.github.com/users/web-flow/received_events", "type": "User", "site_admin": false}, "parents": [{"sha": "42abbd8878d3b67238f3611b0587c704ba94f39c", "url": "https://api.github.com/repos/rust-lang/rust/commits/42abbd8878d3b67238f3611b0587c704ba94f39c", "html_url": "https://github.com/rust-lang/rust/commit/42abbd8878d3b67238f3611b0587c704ba94f39c"}, {"sha": "817f05986ae77538e5721223a55b14cd780dbd73", "url": "https://api.github.com/repos/rust-lang/rust/commits/817f05986ae77538e5721223a55b14cd780dbd73", "html_url": "https://github.com/rust-lang/rust/commit/817f05986ae77538e5721223a55b14cd780dbd73"}], "stats": {"total": 97, "additions": 72, "deletions": 25}, "files": [{"sha": "aa7c87e9f7bd2a12c49fe59cbc158e32c6fc128f", "filename": "src/librustc_lint/unused.rs", "status": "modified", "additions": 23, "deletions": 3, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/956e50bce166663da04601bd01888d879d6f80e8/src%2Flibrustc_lint%2Funused.rs", "raw_url": "https://github.com/rust-lang/rust/raw/956e50bce166663da04601bd01888d879d6f80e8/src%2Flibrustc_lint%2Funused.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Flibrustc_lint%2Funused.rs?ref=956e50bce166663da04601bd01888d879d6f80e8", "patch": "@@ -355,6 +355,19 @@ impl From<UnusedDelimsCtx> for &'static str {\n trait UnusedDelimLint {\n     const DELIM_STR: &'static str;\n \n+    /// Due to `ref` pattern, there can be a difference between using\n+    /// `{ expr }` and `expr` in pattern-matching contexts. This means\n+    /// that we should only lint `unused_parens` and not `unused_braces`\n+    /// in this case.\n+    ///\n+    /// ```rust\n+    /// let mut a = 7;\n+    /// let ref b = { a }; // We actually borrow a copy of `a` here.\n+    /// a += 1; // By mutating `a` we invalidate any borrows of `a`.\n+    /// assert_eq!(b + 1, a); // `b` does not borrow `a`, so we can still use it here.\n+    /// ```\n+    const LINT_EXPR_IN_PATTERN_MATCHING_CTX: bool;\n+\n     // this cannot be a constant is it refers to a static.\n     fn lint(&self) -> &'static Lint;\n \n@@ -454,7 +467,10 @@ trait UnusedDelimLint {\n     fn check_expr(&mut self, cx: &EarlyContext<'_>, e: &ast::Expr) {\n         use rustc_ast::ast::ExprKind::*;\n         let (value, ctx, followed_by_block, left_pos, right_pos) = match e.kind {\n-            If(ref cond, ref block, ..) => {\n+            // Do not lint `unused_braces` in `if let` expressions.\n+            If(ref cond, ref block, ..)\n+                if !matches!(cond.kind, Let(_, _)) || Self::LINT_EXPR_IN_PATTERN_MATCHING_CTX =>\n+            {\n                 let left = e.span.lo() + rustc_span::BytePos(2);\n                 let right = block.span.lo();\n                 (cond, UnusedDelimsCtx::IfCond, true, Some(left), Some(right))\n@@ -470,7 +486,7 @@ trait UnusedDelimLint {\n                 (cond, UnusedDelimsCtx::ForIterExpr, true, None, Some(block.span.lo()))\n             }\n \n-            Match(ref head, _) => {\n+            Match(ref head, _) if Self::LINT_EXPR_IN_PATTERN_MATCHING_CTX => {\n                 let left = e.span.lo() + rustc_span::BytePos(5);\n                 (head, UnusedDelimsCtx::MatchScrutineeExpr, true, Some(left), None)\n             }\n@@ -512,7 +528,7 @@ trait UnusedDelimLint {\n \n     fn check_stmt(&mut self, cx: &EarlyContext<'_>, s: &ast::Stmt) {\n         match s.kind {\n-            StmtKind::Local(ref local) => {\n+            StmtKind::Local(ref local) if Self::LINT_EXPR_IN_PATTERN_MATCHING_CTX => {\n                 if let Some(ref value) = local.init {\n                     self.check_unused_delims_expr(\n                         cx,\n@@ -565,6 +581,8 @@ declare_lint_pass!(UnusedParens => [UNUSED_PARENS]);\n impl UnusedDelimLint for UnusedParens {\n     const DELIM_STR: &'static str = \"parentheses\";\n \n+    const LINT_EXPR_IN_PATTERN_MATCHING_CTX: bool = true;\n+\n     fn lint(&self) -> &'static Lint {\n         UNUSED_PARENS\n     }\n@@ -736,6 +754,8 @@ declare_lint_pass!(UnusedBraces => [UNUSED_BRACES]);\n impl UnusedDelimLint for UnusedBraces {\n     const DELIM_STR: &'static str = \"braces\";\n \n+    const LINT_EXPR_IN_PATTERN_MATCHING_CTX: bool = false;\n+\n     fn lint(&self) -> &'static Lint {\n         UNUSED_BRACES\n     }"}, {"sha": "952398ef0685bd8f0345eb2ac6aa4fe9e7e5b21b", "filename": "src/test/ui/lint/unused_braces.rs", "status": "modified", "additions": 25, "deletions": 6, "changes": 31, "blob_url": "https://github.com/rust-lang/rust/blob/956e50bce166663da04601bd01888d879d6f80e8/src%2Ftest%2Fui%2Flint%2Funused_braces.rs", "raw_url": "https://github.com/rust-lang/rust/raw/956e50bce166663da04601bd01888d879d6f80e8/src%2Ftest%2Fui%2Flint%2Funused_braces.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Funused_braces.rs?ref=956e50bce166663da04601bd01888d879d6f80e8", "patch": "@@ -1,29 +1,48 @@\n // check-pass\n #![warn(unused_braces, unused_parens)]\n \n+fn consume<T>(_: T) {}\n+\n fn main() {\n     let _ = (7);\n     //~^WARN unnecessary parentheses\n \n-    let _ = { 7 };\n-    //~^ WARN unnecessary braces\n+    // Do not emit a lint in these cases,\n+    // as we have to be careful with\n+    // `ref` patterns.\n+    {\n+        let _ = { 7 };\n+\n+        if let 7 = { 7 } { }\n+\n+        match { 7 } {\n+            _ => (),\n+        }\n+    }\n \n-    if let 7 = { 7 } {\n+    if { true } {\n+        //~^ WARN unnecessary braces\n+    }\n+\n+    while { false } {\n         //~^ WARN unnecessary braces\n     }\n \n     let _: [u8; { 3 }];\n     //~^ WARN unnecessary braces\n \n-    // do not emit error for multiline blocks.\n+    consume({ 7 });\n+    //~^ WARN unnecessary braces\n+\n+    // Do not emit lint for multiline blocks.\n     let _ = {\n         7\n     };\n \n-    // do not emit error for unsafe blocks.\n+    // Do not emit lint for unsafe blocks.\n     let _ = unsafe { 7 };\n \n-    // do not emit error, as the `{` would then\n+    // Do not emit lint, as the `{` would then\n     // be parsed as part of the `return`.\n     if { return } {\n "}, {"sha": "f195c00241836b375e09a4dc55166b9af42c36e7", "filename": "src/test/ui/lint/unused_braces.stderr", "status": "modified", "additions": 16, "deletions": 10, "changes": 26, "blob_url": "https://github.com/rust-lang/rust/blob/956e50bce166663da04601bd01888d879d6f80e8/src%2Ftest%2Fui%2Flint%2Funused_braces.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/956e50bce166663da04601bd01888d879d6f80e8/src%2Ftest%2Fui%2Flint%2Funused_braces.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Funused_braces.stderr?ref=956e50bce166663da04601bd01888d879d6f80e8", "patch": "@@ -1,5 +1,5 @@\n warning: unnecessary parentheses around assigned value\n-  --> $DIR/unused_braces.rs:5:13\n+  --> $DIR/unused_braces.rs:7:13\n    |\n LL |     let _ = (7);\n    |             ^^^ help: remove these parentheses\n@@ -10,27 +10,33 @@ note: the lint level is defined here\n LL | #![warn(unused_braces, unused_parens)]\n    |                        ^^^^^^^^^^^^^\n \n-warning: unnecessary braces around assigned value\n-  --> $DIR/unused_braces.rs:8:13\n+warning: unnecessary braces around `if` condition\n+  --> $DIR/unused_braces.rs:23:8\n    |\n-LL |     let _ = { 7 };\n-   |             ^^^^^ help: remove these braces\n+LL |     if { true } {\n+   |        ^^^^^^^^ help: remove these braces\n    |\n note: the lint level is defined here\n   --> $DIR/unused_braces.rs:2:9\n    |\n LL | #![warn(unused_braces, unused_parens)]\n    |         ^^^^^^^^^^^^^\n \n-warning: unnecessary braces around `let` scrutinee expression\n-  --> $DIR/unused_braces.rs:11:16\n+warning: unnecessary braces around `while` condition\n+  --> $DIR/unused_braces.rs:27:11\n    |\n-LL |     if let 7 = { 7 } {\n-   |                ^^^^^ help: remove these braces\n+LL |     while { false } {\n+   |           ^^^^^^^^^ help: remove these braces\n \n warning: unnecessary braces around const expression\n-  --> $DIR/unused_braces.rs:15:17\n+  --> $DIR/unused_braces.rs:31:17\n    |\n LL |     let _: [u8; { 3 }];\n    |                 ^^^^^ help: remove these braces\n \n+warning: unnecessary braces around function argument\n+  --> $DIR/unused_braces.rs:34:13\n+   |\n+LL |     consume({ 7 });\n+   |             ^^^^^ help: remove these braces\n+"}, {"sha": "d0b059744e1fd94e00ba6dd8e2989691c619f227", "filename": "src/test/ui/lint/unused_braces_borrow.rs", "status": "renamed", "additions": 4, "deletions": 2, "changes": 6, "blob_url": "https://github.com/rust-lang/rust/blob/956e50bce166663da04601bd01888d879d6f80e8/src%2Ftest%2Fui%2Flint%2Funused_braces_borrow.rs", "raw_url": "https://github.com/rust-lang/rust/raw/956e50bce166663da04601bd01888d879d6f80e8/src%2Ftest%2Fui%2Flint%2Funused_braces_borrow.rs", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Funused_braces_borrow.rs?ref=956e50bce166663da04601bd01888d879d6f80e8", "patch": "@@ -10,13 +10,15 @@ struct A {\n     b: u32,\n }\n \n+fn consume<T>(_: T) {}\n+\n fn main() {\n     let a = A {\n         a: 42,\n         b: 1729,\n     };\n \n-    let _ = &{ a.b };\n-    let _ = { a.b };\n+    consume(&{ a.b });\n+    consume({ a.b });\n     //~^ WARN unnecessary braces\n }", "previous_filename": "src/test/ui/lint/unused_parens_borrow.rs"}, {"sha": "82fb4375611c9e4e6ef40b5932c7c7a0fec8c812", "filename": "src/test/ui/lint/unused_braces_borrow.stderr", "status": "renamed", "additions": 4, "deletions": 4, "changes": 8, "blob_url": "https://github.com/rust-lang/rust/blob/956e50bce166663da04601bd01888d879d6f80e8/src%2Ftest%2Fui%2Flint%2Funused_braces_borrow.stderr", "raw_url": "https://github.com/rust-lang/rust/raw/956e50bce166663da04601bd01888d879d6f80e8/src%2Ftest%2Fui%2Flint%2Funused_braces_borrow.stderr", "contents_url": "https://api.github.com/repos/rust-lang/rust/contents/src%2Ftest%2Fui%2Flint%2Funused_braces_borrow.stderr?ref=956e50bce166663da04601bd01888d879d6f80e8", "patch": "@@ -1,11 +1,11 @@\n-warning: unnecessary braces around assigned value\n-  --> $DIR/unused_parens_borrow.rs:20:13\n+warning: unnecessary braces around function argument\n+  --> $DIR/unused_braces_borrow.rs:22:13\n    |\n-LL |     let _ = { a.b };\n+LL |     consume({ a.b });\n    |             ^^^^^^^ help: remove these braces\n    |\n note: the lint level is defined here\n-  --> $DIR/unused_parens_borrow.rs:2:9\n+  --> $DIR/unused_braces_borrow.rs:2:9\n    |\n LL | #![warn(unused_braces)]\n    |         ^^^^^^^^^^^^^", "previous_filename": "src/test/ui/lint/unused_parens_borrow.stderr"}]}